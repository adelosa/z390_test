         MACRO                                                          00001000
         SGPFIX                                                         00002000
         ACTR  200                                             @D14BDRP 00003000
         TITLE 'DOS SUPERVISOR        SGPFIX     PAGE MANAGEMENT (PFIX-*00004000
               ROUTINE)'                                       @D14ZDRP 00005000
.*************************************************************          00006004
*                                                            *          00007004
.*       IBM DISK OPERATING SYSTEM                           *          00008004
*        SUPERVISOR - SGPFIX - 5686-066-06                   *          00009004
*                                                            *          00011004
*        LICENSED MATERIALS - PROPERTY OF IBM                *          00012004
*        "RESTRICTED MATERIALS OF IBM"                       *          00013004
*        5686-066                                            *          00014004
*        (C) COPYRIGHT IBM CORP. 1977, 2002                  *          00014106
*                                                            *          00016004
**************************************************************          00017004
         SPACE 2                                                        00018000
* /* START OF SPECIFICATIONS ****************************************** 00019000
*                                                                       00020000
*01* MODULE NAME = SGPFIX                                               00021000
*                                                                       00022000
*01* MODULE TYPE = SUPERVISOR GENERATION MACRO                          00023000
*                                                                       00024000
*01* DESCRIPTIVE NAME = FIX SUPPORT OF PAGE MANAGEMENT SERVICES         00025000
*                                                                       00026000
*01* CHANGE ACTIVITY = AS FOLLOWS                                       00027000
*    CHANGE DESCRIPTIONS                                                00028000
*            NEW MACRO -- FIRST RELEASE 35                              00029000
*       E - SUPPORT                                            @D35EDRP 00030010
*       S/370 - SUPPORT                                        @D35CDKH 00031010
*       SYSTEM PCB USED FOR BTM PFREE FROM PTA $$ABERP9        @DA23160 00032000
*       PFIX IN SVA FOR /370-MODE                              @D14BDRP 00033000
*       16 MB REAL STORAGE FOR /370                            @D14ADVB 00034000
*       VAE - SUPPORT  (MULTIPLE VIRTUAL MEMORIES)             @D14NDFG 00035000
*       4 K PAGESIZE IN 370 MODE                               @DA33314 00036000
*       PHO INTERFACE CHANGE                                   @DA35398 00037000
*       WAITFF5 DUE TO REG4 HAVING SCB INSTEAD OF CCW PTR      @DA35908 00038000
*       MSG 1QC51 OR HARDWAIT FF1 AND OTHER UNPREDICTABLE      @DA35176 00039000
*       RESULTS                                                @DA35176 00040000
*       REMOVE ENTRY FROM PAGE-OUT QUEUE WHEN FREED VIA FREEPDS@DA36227 00041000
*       PROVIDE DATAAREA ADDR IF ENTERED AT PFREE2ND, SVAPFIX  @D21ZDMZ 00042000
*       SPE DY37265                                            @D21ZDMZ 00043000
*       ALLOW PFIX IN ICCF IAP FOR XPCC/APPC/VM SUPPORT        @D31BDUL 00044000
*       NEW SYSTEM LAYOUT                                      @D51GDRP 00045000
*       31-BIT REAL AND XA I/O SUPPORT                         @D51GDTP 00046000
*       31-BIT VIRTUAL                                         @D52VDVB 00047000
*       DATA SPACE SUPPORT                                     @D52GDWL 00048000
*       PFIX RETURN CODE RC=16                                 @KX40442 00049000
*       UNPRED. RESULTS IF PARAMETERLIST DESTROYED DURING      @KX40685 00050000
*       PROCESSING                                 @D35EDRP    @KX40685 00051000
*       DON'T CANCEL REQUESTOR OF PFIX, IF MAX(PFIXC) REACHED  @KX40934 00052000
*       AND FUNCTION CALLED AS SUBROUTINE, SET RC=28 INSTEAD   @KX40934 00053000
*       RETURN FROM PFIXWT3                                    @KD40069 00054000
*       DON'T INCREASE NPSQE  IF PFIXCNT=0 AND FRAME IS AREA1/3@KD40070 00055000
*       PFTE OF FIXED PAGE IN PSQ                              @KD40097 00056000
*       PFTE WITH NFRP ON AND FIXC=0 ERRONEOUSLY USED FOR EXCH.@KD40410 00057000
*       RETURN INSTEAD OF WAIT FOR TFREE, IF REQUESTED BY PFIX @DY43013 00058000
*       MULTI-PROCESSOR SUPPORT                                @D61RDRP 00059000
*       IN FIXEXCHG RTN, THE FRAME POINTED TO BY RC, MAY       @KXA0560 00060000
*       CONTAIN A V-POOL PAGE (DUE TO NOPDS SUPPORT)           @KXA0560 00061000
*       PUBLIC STORAGE KEY SUPPORT AF 6.4                      @D64XDMZ 00062000
*       PCBATAB IS ACCESSED IN PFREE2ND WITH DAT=OFF           @DY44241 00063000
*       REMOVE FAST-CCW-TRANSLATION SUPPORT                    @D64YDOW 00064000
*       MORE THAN 255 TASKS                                    @D66ODOW 00064105
*       HARDWAIT FF1 DUE TO INCORRECT PFIX EXCHANGE RTN (VIO)  @DY45878 00064209
*                                                                       00065000
* A000000-999999                                               @D35EDRP 00066000
**** END OF SPECIFICATIONS *******************************************/ 00067000
         SPACE 2                                                        00068000
PMFIXADR DS    0D                                              @D14ZDVB 00069000
         DC    CL8'SGPFIX'                                              00070000
         DC    CL10'@DY45878  '   LAST APAR / DEVELOPMENT CHANGE        00071410
         SPACE 2                                                        00072000
*---------------------------------------------------------------------* 00073000
*        ROUTINE PROLOGUE                                      @D149DVB 00074000
*        ROUTINE NAME: PFIX                                    @D149DVB 00075000
*        MACRO:        SGPFIX                                  @D149DVB 00076000
*        FUNCTION: HANDLES A PFIX-REQUEST. ENSURES THAT THE PAGES       00077000
*                  SPECIFIED BY THE PARAMETER-LIST ARE ADDRESSABLE AND  00078000
*                  REMAIN IN STORAGE AS LONG AS THEY ARE NOT FREED BY   00079000
*                  A PFREE-REQUEST.                            @D149DVB 00080000
*        CALLED BY:    SVC_67 (PFIX) WITH AMODE(24),DATON      @D52VDRP 00081000
*                                                              @D529DRP 00082000
*        CALLED ROUTINES:                                      @D149DVB 00083000
*              RWAIT WITH AMODE(24),DATON                      @D529DRP 00084000
*              PFIXPGE, PFREEPFX WITH AMODE(31),DATOFF         @D52VDRP 00085000
*              GETPADR/GETNPADR WITH AMODE(REQUESTOR),DATOFF   @D529DRP 00086000
*        ENTRY POINTS:                                         @D149DVB 00087000
*                  PFIX     CALLED BY SVC 67                   @D149DVB 00088000
*                  PFIX2ND  CALLED BY IJBSXPC FOR XPCC/APPC/VM @D31BDUL 00089000
*                           AND BY PGSER                       @D529DVB 00090000
*                  PFIXSVA  CALLED BY SVAFX2ND                          00091000
*        INPUT:                                                @D149DVB 00092000
*                  R1 - ADDR (LIST (PARM))                     @D149DVB 00093000
*                       PARM = (ADDR PTR(31),LEN(AREA)-1 BIN FIXED(31)) 00094000
*              IN ADDITION IF ENTERED VIA PFIX2ND              @D149DVB 00095000
*                  RF - FUNCTION CODE, OPTION BYTES            @D529DVB 00096000
*                   BYTE 0: REQUEST BYTE                       @D52VDVB 00097000
*                           BIT 0 : 1 - OLD FORMAT             @D52VDVB 00098000
*                                   0 - NEW FORMAT             @D52VDVB 00099000
*                           BIT 6   1 - SVA PFIX WITH RETURN   @D52VDVB 00100000
*                           BIT 7   1 - SVA PFIX WITH GATE HAND@D52VDVB 00101000
*                   BYTE 1: OPTION BYTE                        @D52VDVB 00102000
*                           04: REAL ALLOC IN 24 BIT AREA      @D52VDVB 00103000
*                           02: REAL ALLOC IN ALLOCR AREA      @D52VDVB 00104000
*                           01: REAL ALLOC IN 31 BIT AREA      @D52VDVB 00105000
*                   BYTE 2: RESERVED                           @D52VDVB 00106000
*                   BYTE 3: FUNCTION CODE                      @D52VDVB 00107000
*                           01: PFIX                           @D52VDVB 00108000
*                           02: PFREE                          @D52VDVB 00109000
*                  RE - RETURN ADDR                            @D149DVB 00110000
*              IN ADDITION IF ENTERED VIA PFIXSVA              @D149DVB 00111000
*                  R8 - ADDR OF PAGEMANAGEMENT DATA AREA       @D149DVB 00112000
*                  RD - ADDR OF SYSTEM-PCB                     @D149DVB 00113000
*                  RF - PIK OF OWNER OF REQUESTED AREA         @D51IDRP 00114000
*        OUTPUT:                                               @D149DVB 00115000
*         PAGES SPECIFIED BY THE PARAMETER-LIST ARE PFIXED     @D149DVB 00116000
*        EXIT :                                                @D149DVB 00117000
*             NORMAL:IF ENTERED VIA PFIX, RETURN TO DISPATCHER @D149DVB 00118000
*                    IF ENTERED VIA PFIX2ND, RETURN TO CALLER  @D149DVB 00119000
*             CONDITIONS: FUNCTION ACCOMPLISHED                @D149DVB 00120000
*             ERROR: RETURN AS UNDER EXIT NORMAL OR CANCEL IF  @D149DVB 00121000
*                    PFIX-COUNTER OF PAGE EXCEEDS MAX. VALUE   @D149DVB 00122000
*             CONDITIONS: FUNCTION NOT DONE. RC PROVIDED.      @D149DVB 00123000
*             RESVC: IF PFIX_GATE FOR PARTITION CLOSED         @D149DVB 00124000
*             CONDITIONS: RESVC                                @D149DVB 00125000
*        RETURN CODE:                                          @D149DVB 00126000
*                    0   -   FUNCTION DONE                     @D149DVB 00127000
*                    4   -   MAX NUMBER OF ALLOWED PFIXED PAGES@D149DVB 00128000
*                            FOR THE PARTITION IS  EXCEEDED    @D149DVB 00129000
*                            BY THIS REQUEST ALONE.            @D149DVB 00130000
*                    8   -   MAX NUMBER OF ALLOWED PFIXED PAGES@D149DVB 00131000
*                            FOR THE PARTITION IS EXCEEDED     @D149DVB 00132000
*                            TO PREVIOUS PFIX-REQUESTS.        @D149DVB 00133000
*                   12   -   NEGATIVE LENGTH OF AREA OR INV ADR@D149DVB 00134000
*                   16   -   PFIXED PAGE ABOVE 16 MB FOUND     @D529DVB 00135000
*                            BUT CURRENT PFIX WITH RLOC=ANY    @D529DVB 00136000
*                   20   -   INVALID FUNCTION CODE / OPTION    @D529DVB 00137000
*                   24   -   DO NOT WAIT ON TFREE              @D529DVB 00138000
*                   28   -   PFIXC OVERFLOW, ONLY IF CALLED AS @KX40934 00139000
*                            SUBROUTINE                        @KX40934 00140000
*        EXTERNAL REFERENCES:                                  @D149DVB 00141000
*               PCB(READ) PARTITION CONTROL BLOCK              @D149DVB 00142000
*                SMAXPFIX(READ) PFIX-LIMIT OF PARTITION        @D149DVB 00143000
*                                                              @D149DVB 00144000
*        OPERATION:                                            @D149DVB 00145000
*                                                              @D149DVB 00146000
*        PFIX:                            /*  E N T R Y  P T */@D149DVB 00147000
*        IF TASK IN 'REAL' MODE THEN  RETURN (RC=0)            @D149DVB 00148000
*        IF PCB.PCBRQPFX = ¬ FREE THEN EXIT (RWAIT)            @D149DVB 00149002
*        RC := 0                                               @D149DVB 00150000
*        IF 31_BIT_PFIX_REQUEST                                @D529DVB 00151000
*        THEN                                                  @D529DVB 00152000
*        DO FOREVER                                            @D529DVB 00153000
*        CALL GETPADR/GETNADR             /*GET 1ST/NXT ENTRY*/@D529DVB 00154000
*        CASE                                                  @D529DVB 00155000
*           WHEN EOL                      /*END OF LIST      */@D529DVB 00156000
*               RC := 0                                        @D529DVB 00157000
*               EXIT PFIXRET              /* GOTO END        */@D52VDVB 00158000
*           WHEN INVALID                  /*INV.ADDR / LENGTH*/@D529DVB 00159000
*               CALL PFREEPFX             /*FREE PFIXED FRAME*/@D529DVB 00160000
*               RC := 12                                       @D529DVB 00161000
*               EXIT PFIXRET              /* GOTO END        */@D52VDVB 00162000
*           WHEN MORE_TO_DO               /* CONTINUE PROCESS*/@D529DVB 00163000
*               CALL PFIXPGE (ADDR(PAGE),LEN(AREA)-1,31BIT);   @D529DVB 00164000
*                CASE                                          @D529DVB 00165000
*                   WHEN PFTE.PFIXC = FF  /*MAX VAL FOR FRAME*/@D529DVB 00166000
*                      CALL PFREEPFX      /*FREE PFIXED FRAME*/@D529DVB 00167000
*                      EXIT ERR2F(DISPATCHER) /* CANCEL TASK */@D529DVB 00168000
*                   WHEN PCB.SMPFIX ¬< SMAXPFIX                @D529DVB 00169000
*                      EXIT DO_FOREVER    /*PFIX IN OTHER ARE*/@D529DVB 00170000
*                   OTHERWISE             /* ITERATE DO LOOP */@D529DVB 00171000
*                ENDCASE                                       @D529DVB 00172000
*        ENDCASE                                               @D529DVB 00173000
*        END DO_FOREVER                                        @D529DVB 00174000
*        ELSE                             /* NOOP            */@D529DVB 00175000
*        FCT := (24BIT|ALLOCR AREA)                            @D52VDVB 00176000
*        DO FOREVER                                            @D529DVB 00177000
*        CALL GETPADR/GETNADR             /*GET 1ST/NXT ENTRY*/@D149DVB 00178000
*        CASE                                                  @D149DVB 00179000
*           WHEN EOL                      /*END OF LIST      */@D529DVB 00180000
*               RC := 0                                        @D529DVB 00181000
*               EXIT PFIXRET              /* GOTO END        */@D52VDVB 00182000
*           WHEN INVALID                  /*INV.ADDR / LENGTH*/@D529DVB 00183000
*               CALL PFREEPFX             /*FREE PFIXED FRAME*/@D529DVB 00184000
*               RC := 12                                       @D529DVB 00185000
*               EXIT PFIXRET              /* GOTO END        */@D52VDVB 00186000
*           WHEN MORE_TO_DO               /* CONTINUE PROCESS*/@D529DVB 00187000
*               CALL PFIXPGE (ADDR(PAGE),LEN(AREA)-1,FCT);     @D529DVB 00188000
*                CASE                                          @D149DVB 00189000
*                   WHEN PFTE.PFIXC = FF  /*MAX VAL FOR FRAME*/@D149DVB 00190000
*                      CALL PFREEPFX      /*FREE PFIXED FRAME*/@D149DVB 00191000
*                      EXIT ERR2F(DISPATCHER) /* CANCEL TASK */@D149DVB 00192000
*                   WHEN PCB.SMPFIX ¬< SMAXPFIX                @D149DVB 00193000
*                      CALL PFREEPFX      /*FREE PFIXED FRAME*/@D149DVB 00194000
*                      IF LEN(AREA)/2*K**11 < SMAXPFIX         @D149DVB 00195000
*                         THEN RC := 4                         @D149DVB 00196000
*                         ELSE RC := 8    /*MAX VALUE REACHED*/@D149DVB 00197000
*                      EXIT PFIXRET;      /*BY THIS REQUEST  */@D529DVB 00198000
*                   OTHERWISE             /* ITERATE LOOP    */@D529DVB 00199000
*                ENDCASE                                       @D149DVB 00200000
*        ENDCASE                                               @D149DVB 00201000
*        END DO_FOREVER                                        @D149DVB 00202000
*        PFIXRET:                                              @D149DVB 00203000
*        IF CALLED AS SUBR                /* CALLED AS SUBR  */@D149DVB 00204000
*                                         /*   <RE> ¬= 0     */@D149DVB 00205000
*           THEN RETURN (ADDR = RE,RC)                         @D149DVB 00206000
*           ELSE RETURN (ADDR = DISP,RC)                       @D149DVB 00207000
*        END  (PFIX) ;                                         @D149DVB 00208000
*---------------------------------------------------------------------* 00209000
         SPACE 1                                                        00210000
PFIX     DS    0H                                              @D52VDVB 00211000
         LA    RF,PCBPXFIX(,0)    OLD INTERFACE X'00000001'    @D52VDVB 00212000
         SLR   RE,RE              INDICATE CALLED FROM SVC     @D52VDVB 00213000
PFIX2ND  L     R8,APMGMDAT        GET BASE ADDR OF DATA AREA            00214000
         USING PMGMDATA,R8        SET BASE FOR DATA AREA                00215000
         L     R9,APMFIXAD        GET BASE FOR CODE AREA                00216000
         USING PMFIXADR,R9        SET BASE FOR CODE AREA                00217000
         L     RD,PIBPTR2         GET ADDR OF PIB2             @D51IDRP 00218000
         USING PIB2ADR,RD                                      @D51IDRP 00219000
         L     RD,PIBPCB          GET ADDR OF PCB              @D51IDRP 00220000
         USING PCBADR,RD          SET BASE FOR PCB             @D51IDRP 00221000
         LTR   RE,RE              CALLED AS SUBROUTINE         @D51IDRP 00222000
         BNZ   PFIXCNT1           YES, SKIP TEST               @D51IDRP 00223000
         L     R5,PCEPIB          PIB OF CURRENT PARTITION     @D51IDRP 00224000
         USING PIBADR,R5          SET BASE FOR PIB                      00225000
         TM    PIBDATFL,PIBTRAM   TASK IN REAL MODE            @D51IDRP 00226000
         DROP  R5                 FORGET BASE FOR PIB                   00227000
         BZ    PFIXRT0            YES, RETURN                  @D51IDRP 00228000
         SPACE 1                                               @D35CDKH 00229000
*--------------------------------------------------------------@D35CDKH 00230000
*     TEST IF PFIX-GATE FOR PARTITION IS OPEN. IF NOT          @D35CDKH 00231000
*     GO TO  RESVC                                             @D35CDKH 00232000
*--------------------------------------------------------------@D35CDKH 00233000
         SPACE 1                                               @D35CDKH 00234000
PFIXCNT1 LA    R5,SRQPFX          GET ADDR OF PFIX WAIT QUEUE  @D52VDVB 00235000
PFIXM000 TM    PCBRQPFX,FREEBIT   PFIX IN USE WITHIN PART.?    @D66ODOW 00236005
         USING DISP,R6                                         @D36IDRP 00237000
         BO    PFIXCNT2           NO, CONTINUE                 @D66ODOW 00238005
         BAL   RC,RWAIT           SAVE STATUS AND WAIT         @D52VDRP 00239000
*SGLINK  RWAIT,INPUT=(R5,RC)                                   @D52VDRP 00240000
         B     PFIXM000           CHECK GATE AGAIN             @D52VDRP 00241000
         DROP  R6                                              @D14BDRP 00242000
PFIXCNT2 DS    0H                                              @D52VDRP 00243000
         ST    RF,PCBPGSER        SAVE FUNCTION AND OPTIONS    @D52VDVB 00244000
         LH    RF,PIK             GET PIK OF REQUESTING PART.  @D52VDVB 00245000
         USING RQADR,R5                                        @D36IDRP 00246000
         MVC   RID+D1(L1),RQID    IDENTIFY USED RESOURCE       @D36IDRP 00247000
         DROP  R5                 FORGET BASE FOR RQADR        @D36IDRP 00248000
         SPACE 1                                               @D35CDKH 00249000
PFIXSVA  ST    R1,PCBPXLST        SAVE PARAMETERLIST ADDR      @D52VDVB 00250000
*        AMODESW SET,AMODE=31,WR=(RA)  31-BIT MODE             @D52VDRP 00251000
         AMODESW SET,AMODE=31,WR=(RA)                          @D52VDRP 00252000
*        AMODESW SET,DAT=OFF      ENTER REAL MODE              @D52VDRP 00253000
         AMODESW SET,DAT=OFF                                   @D52VDRP 00254000
*        GENSERV LRADBG,RREG=(RD),VADD=(RD),ERR=NADDR          @D52VDRP 00255000
*                             GET REAL ADDRESS OF PCB          @D52VDRP 00256000
         GENSERV LRADBG,RREG=(RD),VADD=(RD),ERR=NADDR          @D52VDRP 00257000
         SPACE 1                                               @D52VDVB 00258000
         L     R0,PCBPGSER        GET ADDR. MODE OF REQUESTOR  @D52VDRP 00259000
*        AMODESW CALL,AMODE=(R0),ADDRESS=GETPADR,REGS=(RA,RA)          *00260000
                                  GET 1ST PAGE TO BE HANDLED   @D52VDVB 00261000
         AMODESW CALL,AMODE=(R0),ADDRESS=GETPADR,REGS=(RA,RA)  @D52VDVB 00262000
         B     PFIXRT0            BRANCH, END OF LIST REACHED           00263000
         B     PFIXRT12           RETURN WITH RETURN CODE 12            00264000
* ---->  B     PFIXM005           PROCESS FIRST ENTRY          @D52VDVB 00265000
PFIXM005 TM    PCBPXOPT,PCBPXAR3  PFIX FOR 31 BIT AREA         @D52VDVB 00266000
         BZ    PFIXM020           NO ---------->               @D52VDVB 00267000
*              ->PCBPXOPT.PCBPXABO = ON VIA MACRO GENERATION   @D52VDVB 00268000
         SPACE 1                                               @D52VDVB 00269000
*--------------------------------------------------------------@D52VDVB 00270000
*    TRY TO PFIX IN 31 BIT PFIX AREA                           @D52VDVB 00271000
*--------------------------------------------------------------@D52VDVB 00272000
         SPACE 1                                               @D52VDVB 00273000
         SGCOV SGPFIX,MC=0        PFIX IN 31-BIT AREA          @D52VDRP 00274000
PFIXM010 BAL   R7,PFIXPGE         PFIX THE PAGE                @D52VDVB 00275000
         B     PFIXRT28           MAX VALUE OF PFIXC REACHED   @D52VDVB 00276000
         B     PFIXM015           MAX VALUE OF SMPFIX REACHED  @D52VDVB 00277000
         B     PFIXRT16           PFIX ABOVE 16 MB             @D52VDVB 00278000
         B     PFIXRT20           INVALID FUNCTION CODE/OPTION @D52VDVB 00279000
         B     PFIXRT24           WAIT FOR TFREE               @D52VDVB 00280000
         L     R0,PCBPGSER        GET ADDR. MODE OF REQUESTOR  @D52VDVB 00281000
*        AMODESW CALL,AMODE=(R0),ADDRESS=GETNPADR,REGS=(RA,RA)         *00282000
                                  GET 1ST PAGE TO BE HANDLED   @D52VDVB 00283000
         AMODESW CALL,AMODE=(R0),ADDRESS=GETNPADR,REGS=(RA,RA) @D52VDVB 00284000
         B     PFIXRT0            EOL, RETURN                  @D52VDVB 00285000
         B     PFIXRT12           ERROR IN PARAMETER LIST      @D52VDVB 00286000
         B     PFIXM010           PROCESS NEXT ENTRY           @D52VDVB 00287000
         SPACE 1                                               @D52VDVB 00288000
PFIXM015 NI    PCBPXOPT,XFF-PCBPXAR3  RESET 31 BIT PFIX AREA...        *00289000
                                  REQUEST                      @D52VDVB 00290000
PFIXM020 OI    PCBPXOPT,PCBPXAR1  INDICATE 24 BIT PFIX AREA AND ...    *00291000
                                  LEAVE 31 BIT PFIX AREA       @D52VDVB 00292000
*      GENSERV TEST,FIELD=SMRPBEG,REG=(R0),BC=BZ,LAB=PFIXM030  @D52VDVB 00293000
       GENSERV TEST,FIELD=SMRPBEG,REG=(R0),BC=BZ,LAB=PFIXM030  @D52VDVB 00294000
         XI    PCBPXOPT,PCBPXAR1+PCBPXAR2 INDICATE ALLOCR AREA AND     *00295000
                      RESET INDICATION FOR 24 BIT PFIX AREA    @D52VDVB 00296000
         SPACE 1                                               @D52VDVB 00297000
*--------------------------------------------------------------@D52VDVB 00298000
*    TRY TO PFIX IN ALLOCR AREA / 24 BIT PFIX AREA             @D52VDVB 00299000
*--------------------------------------------------------------@D52VDVB 00300000
         SPACE 1                                               @D52VDVB 00301000
PFIXM030 BAL   R7,PFIXPGE         PFIX THE PAGE                         00302000
         B     PFIXRT28           MAX VALUE OF PFIXC REACHED, CANCEL    00303000
         B     PFIXRT             MAX VALUE OF SMPFIX REACHED           00304000
         B     PFIXRT16           PFIX ABOVE 16 MB             @D52VDVB 00305000
         B     PFIXRT20           INVALID FUNCTION CODE/OPTION @D52VDVB 00306000
         B     PFIXRT24           WAIT FOR TFREE               @D52VDVB 00307000
         L     R0,PCBPGSER        GET ADDR. MODE OF REQUESTOR  @D52VDVB 00308000
*        AMODESW CALL,AMODE=(R0),ADDRESS=GETNPADR,REGS=(RA,RA)         *00309000
                                  GET 1ST PAGE TO BE HANDLED   @D52VDVB 00310000
         AMODESW CALL,AMODE=(R0),ADDRESS=GETNPADR,REGS=(RA,RA) @D52VDVB 00311000
         B     PFIXRT0            EOL , RETURN                          00312000
         B     PFIXRT12           ERROR IN PARAMETER LIST               00313000
         B     PFIXM030           PROCESS NEXT ENTRY                    00314000
         SPACE 2                                                        00315000
PFIXRT12 BAL   R7,PFREEPFX        FREE PAGES ALREADY FIXED              00316000
         LA    RF,D12(,0)         SET RC=12                             00317000
         B     PFIXRET            EXIT                                  00318000
PFIXRT16 BAL   R7,PFREEPFX        FREE PAGES ALREADY FIXED     @D52VDVB 00319000
         LA    RF,D16(,0)         SET RC=16 - PAGE ALREADY FIXED       *00320000
                                  ...  ABOVE 16 MB             @D52VDVB 00321000
         B     PFIXRET            EXIT                         @D52VDVB 00322000
PFIXRT20 BAL   R7,PFREEPFX        FREE PAGES ALREADY FIXED     @D52VDVB 00323000
         LA    RF,D20(,0)         SET RC=20 - INVALID FUNCTION CODE    *00324000
                                  ...         OR OPTION BYTE   @D52VDVB 00325000
         B     PFIXRET            EXIT                         @D52VDVB 00326000
PFIXRT24 BAL   R7,PFREEPFX        FREE PAGES ALREADY FIXED     @D51GDRP 00327000
         LA    RF,D24(,0)         SET RC=24 - NO WAIT ON TFREE @D51GDRP 00328000
         B     PFIXRET            EXIT                         @D51GDRP 00329000
PFIXRT28 BAL   R7,PFREEPFX        FREEPAGES ALREADY FIXED               00330000
         LA    RF,D28(,0)         SET RC=28 - PFIXC> MAX VALUE @KX40934 00331000
         B     PFIXRET            EXIT                         @KX40934 00332000
         SPACE 1                                                        00333000
PFIXRT   BAL   R7,PFREEPFX        FREE PAGES ALREADY FIXED              00334000
*     COUNT NUMBER OF REQUESTED PAGES                                   00335000
         L     R1,PCBPXLST        SAVE PARAMETERLIST ADDR      @D52VDVB 00336000
         SR    RB,RB              SET COUNT REGISTER TO ZERO            00337000
         L     R0,PCBPGSER        GET ADDR. MODE OF REQUESTOR  @D52VDVB 00338000
*        AMODESW CALL,AMODE=(R0),ADDRESS=GETPADR,REGS=(RA,RA)          *00339000
                                  GET 1ST PAGE TO BE HANDLED   @D52VDVB 00340000
         AMODESW CALL,AMODE=(R0),ADDRESS=GETPADR,REGS=(RA,RA)  @D52VDVB 00341000
         B     PFIXCT5            END OF LIST REACHED                   00342000
         B     PFIXRT12           INVALID ADDRESS DETECTED              00343000
* ---->  B     PFIXCT0                                         @D52VDVB 00344000
PFIXCT0  DS    0H                                              @D52VDVB 00345000
         L     R5,PCBPXLST        GET  PARAMETERLIST ADDR      @D52VDVB 00346000
*        AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @D52VDRP 00347000
         AMODESW SET,DAT=ON                                    @D52VDRP 00348000
PFIXCT1  CR    R5,R1              ACTUAL ENTRY REACHED                  00349000
         BNL   PFIXCT3            YES, INCREASE COUNTER                 00350000
         USING PFIXLSTE,R5        SET BASE FOR PARAM-LIST ENTRY         00351000
         L     RA,PFIXBEG         GET BEGIN ADDR OF AREA                00352000
         N     RA,PADDRMSK        SET IT ON PAGE BOUNDARY               00353000
         CR    R2,RA              CURRENT PAGE IN THIS AREA             00354000
         BL    PFIXCT2            NO, BRANCH                            00355000
         L     RA,PFIXBEG         GET BEGIN ADDR OF AREA                00356000
         A     RA,PFIXLNG         GET END ADDR OF AREA                  00357000
         CR    R2,RA              CURRENT PAGE IN THIS AREA             00358000
         BNH   PFIXCT4            YES, BRANCH                           00359000
PFIXCT2  LA    R5,L'PFIXENT(,R5)  POINT TO NEXT LIST ENTRY              00360000
         B     PFIXCT1            CONTINUE SEARCH                       00361000
         DROP  R5                 FORGET BASE FOR PARAM-LIST            00362000
*    CURRENT PAGE NOT IN PARAMETERLIST UP TO NOW                        00363000
PFIXCT3  LA    RB,D1(,RB)         INCREASE NUMBER OF DIFFERENT PAGES    00364000
PFIXCT4  DS    0H                                              @D52VDVB 00365000
*        AMODESW SET,DAT=OFF      ENTER REAL MODE              @D52VDRP 00366000
         AMODESW SET,DAT=OFF                                   @D52VDRP 00367000
         L     R0,PCBPGSER        GET ADDR. MODE OF REQUESTOR  @D52VDVB 00368000
*        AMODESW CALL,AMODE=(R0),ADDRESS=GETNPADR,REGS=(RA,RA)         *00369000
                                  GET 1ST PAGE TO BE HANDLED   @D52VDVB 00370000
         AMODESW CALL,AMODE=(R0),ADDRESS=GETNPADR,REGS=(RA,RA) @D52VDVB 00371000
         B     PFIXCT5            END OF LIST REACHED                   00372000
         B     PFIXRT12           INVALID ADDRESS DETECTED              00373000
         B     PFIXCT0            CHECK THIS PAGE                       00374000
PFIXCT5  LA    RF,D8(,0)          SET RC=8                              00375000
         SLR   R0,R0                                           @D52VDVB 00376000
         TM    PCBPXOPT,PCBPXABO  31 BIT PFIX REQUESTED        @D52VDVB 00377000
         BZ    PFIXCT7            NO  ---------->              @D52VDVB 00378000
         AL    R0,SMAXPFX3        MAX VALUE IN 31 BIT PFIX AREA@D52VDVB 00379000
PFIXCT7  AL    R0,SMAXPFIX        MAX VALUE IN ALLOCR / 24 BIT PFIX    *00380000
                                                   AREA        @D52VDVB 00381000
         CLR   RB,R0              MAX PAGES FIXED BY THIS REQ. @D52VDVB 00382000
         BNH   PFIXRET            NO, RETURN                            00383000
         LA    RF,D4(,0)          SET RC=4                              00384000
         B     PFIXRET            RETURN                                00385000
         SPACE 1                                               @D14ZDVB 00386000
PFIXRT0  SR    RF,RF              SET RC=0                              00387000
PFIXRET  L     R6,DISPAD          GET ADDR OF DISPATCHER       @KX40934 00388000
         USING DISP,R6            SET BASE FOR DISPATCHER      @KX40934 00389000
         LTR   RE,RE              CALLED AS SUBROUTINE         @D52VDVB 00390000
         BNZ   PFIXRETF           YES, ---------->             @D52VDRP 00391000
         LA    RE,RETCODE         GET RETURN ADDRESS           @D52VDRP 00392000
         LA    R7,D28(,0)         PFIXC > MAX ...              @KX40934 00393000
         CR    RF,R7              ...                          @KX40934 00394000
         BNE   PFIXEXIT           NO, RETURN TO USER           @KX40934 00395000
         LA    RE,ERR2F           YES, CANCEL USER             @KX40934 00396000
         MVI   FIXTYPE,ZERO       RESET FIXTYPE INDICATION     @D51GDRP 00397000
PFIXEXIT LA    R1,SVER0F-SVEARA   GET DISPLACEM. IN SAVEAREA            00398000
PFIXRETF DS    0H                                              @D52VDRP 00399000
*        AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @D52VDRP 00400000
         AMODESW SET,DAT=ON                                    @D52VDRP 00401000
*        AMODESW RETURN,REG=(RE)                               @D52VDRP 00402000
         AMODESW RETURN,REG=(RE)                               @D52VDRP 00403000
*                                 =========> EXIT IN 24-BIT TO @D52VDRP 00404000
*                                 - CALLER OR                  @D52VDRP 00405000
*                                 - RETCODE OR                 @D52VDRP 00406000
*                                 - ERR2F                      @D52VDRP 00407000
         DROP  R6                 DROP BASE FOR DISP                    00408000
         DROP  RD                 DROP BASE FOR PCB (REAL)     @D52VDRP 00409000
         EJECT                                                          00410000
*-------------------------------------------------------------*@D149DVB 00411000
*        ROUTINE PROLOGUE                                               00412000
*        ROUTINE NAME= PFIXPGE                                          00413000
*        MACRO=        SGPFIX                                           00414000
*        FUNCTION= PFIXES ONE PAGE SPECIFIED BY THE PARAMETER-REGISTER  00415000
*        CALLED BY: PFIX AND PFIXREST WITH AMODE(31),DATOFF             00416000
*        CALLS:                                                @D529DRP 00417000
*        GENPGQE, POSTPFQ, PFIXWAIT, PMRREMOV, PGIOWAIT,       @D529DRP 00418000
*        FIXEXCHG WITH AMODE(31),DATOFF                        @D529DRP 00419000
*        DEFIXCON, DEFIXALL WITH AMODE(24),DATON               @D529DRP 00420000
*        OPERATION                                                      00421000
*        1. IF PAGE NOT ADDRESSABLE, CALL GENPGQE TO GENERATE A PGQUI   00422000
*           ENTRY TO BRING PAGE IN STORAGE, AND CONTINUE WHITH 1 AFTER  00423000
*           POSTING.                                                    00424000
*        PAGE IS NOW ADDRESSABLE.                                       00425000
*        2. IF PAGE ALREADY PFIXED, CONTINUE WITH 6.                    00426000
*        3. IF SMPFIX EQUAL TO MAX. VALUE ALLOWED, RETURN TO CALLER     00427000
*           WITH OFFSET 4, ELSE INCREASE SMPFIX BY 1.                   00428000
*        4. IF PAGE IN PSQ AND MIN. NUMBER OF PSQ-ENTRIES REACHED,      00429000
*           THEN IF PAGES KEPT BY FAST-TRANSL.,  CALL DEFIXCON TO       00430000
*             FREE PAGES KEPT BY FAST-TRANSL. AND CONTINUE WITH 4       00431000
*             ELSE DECREASE SMPFIX BY 1, CALL RWAIT TO SET TASK IN WAIT 00432000
*             FOR FREE PAGE-FRAMES AND CONTINUE WITH 1 AFTER POSTING.   00433000
*        5. IF PAGE IN PSQ AND MIN. NUMBER OF PSQ-ENTRIES NOT REACHED,  00434000
*           REMOVE PAGE FROM PSQ AND DECREASE NUMBER OF PSQ-ENTRIES     00435000
*           BY 1.                                                       00436000
*        6. IF PFIXC EQUAL TO MAX. VALUE ALLOWED, RETURN TO CALLER WITH 00437000
*           OFFSET 0, ELSE INCREASE PFIXC BY 1 AND RETURN TO CALLER     00438000
*           WITH OFFSET 20.                                             00439000
*                                                                       00440000
*        INPUT:                                                         00441000
*         R2 CONTAINS ADDR OF PAGE TO BE PFIXED                         00442000
*         RD - REAL ADDR OF PCB                                @D529DRP 00443000
*         RF - PIK OF OWNER OF REQUESTED AREA,                 @D529DRP 00444000
*              NOT USED IF CALLED FROM PFIX-RESTART            @D529DRP 00445000
*        OUTPUT:                                                        00446000
*         RC - ADDR OF PFTE, BELONGING TO PFIXED PAGE          @D529DRP 00447000
*         PFIXC OF INDICATED PAGE IS INCREASED BY ONE                   00448000
*        EXIT NORMAL= RETURN TO CALLER WITH OFFSET 20          @D52VDVB 00449000
*         CONDITION= PAGE PFIXED                                        00450000
*         OUTPUT= AS DESCRIBED ABOVE                                    00451000
*         RETURN CODE= NONE                                             00452000
*        EXIT ERROR= RETURN TO CALLER WITH OFFSET 0, 4, 8, 12, 16       00453000
*         CONDITIONS= IF MAX. VALUE OF PFIXC EXCEEDED: OFFS  0          00454000
*                     IF MAX. VALUE OF SMPFIX EXCEEDED:OFFS  4          00455000
*                     IF SVA PFIX REQUESTS RETURN:     OFFS  8 @D52VDVB 00456000
*                     IF INVALID FUNCTION CODE/OPTION: OFFS 12 @D52VDVB 00457000
*                     IF PFIX PAGE ABOVE 16MB:         OFFS 16 @D52VDVB 00458000
*         OUTPUT= NONE                                                  00459000
*         RETURN CODE= NONE                                             00460000
*        EXTERNAL REFERENCES                                            00461000
*         ROUTINES= RWAIT  TO WAIT FOR FREE PAGE FRAMES                 00462000
*                   DEFIXCON  TO FREE PAGES KEPT BY FAST-TRANSL.        00463000
*                   GENPGQE  TO GENERATE PGQUI-ENTRY                    00464000
*         DATA= PAGE-STATE(READ,WRITE)                                  00465000
*               PSQ(READ,WRITE) PAGE SELECTION QUEUE                    00466000
*               PFIXC(READ,WRITE)  # TIMES PAGE IS PFIXED               00467000
*               NPSQE(READ,WRITE)   # OF PSQ-ENTRIES + FFCC             00468000
*        CONTROL BLOCKS=                                                00469000
*              PCB(READ,WRITE)  PARTITION CONTROL BLOCK                 00470000
*               SMAXPFIX(READ)   PFIX-LIMIT OF PARTITION                00471000
*               SMPFIX(READ,WRITE) # OF PAGES PFIXED FOR THE PART.      00472000
*               PCBPGSER(READ,WRITE)  FUNCTION CODE / OPTION   @D52VDVB 00473000
*-------------------------------------------------------------*@D149DVB 00474000
         SPACE 1                                               @D14ZDVB 00475000
         USING PCBADR,RD                                       @D52VDRP 00476000
PFIXPGE  DS    0H                                              @D14NDVB 00477000
         L     R5,IJBSMCOM        COMMON STORAGE MGMT CB       @D52VDVB 00478000
         USING SMCOM,R5                                        @D52VDVB 00479000
         TM    PCBPXOPT,PCBPXAR3  31 BIT PFIX REQUESTED        @D52VDVB 00480000
         BZ    PFIXPA10           NO  ---------->              @D52VDVB 00481000
         MVC   PCBRPCBG(L'PCBRPCBG),SMCRBG3 CURRENT START      @D52VDVB 00482000
         MVC   PCBRPCED(L'PCBRPCED),SMCRND3 CURRENT END        @D52VDVB 00483000
         B     PFIXPG2D           ---------->                  @D52VDVB 00484000
PFIXPA10 DS    0H                                              @D52VDRP 00485000
         TM    PCBPXOPT,PCBPXAR1  24 BIT PFIX REQUESTED        @D52VDVB 00486000
         BZ    PFIXPA20           NO  ---------->              @D52VDVB 00487000
         MVC   PCBRPCBG(L'PCBRPCBG),SMCRBG1 CURRENT START      @D52VDVB 00488000
         MVC   PCBRPCED(L'PCBRPCED),SMCRND1 CURRENT END        @D52VDVB 00489000
         B     PFIXPG2D           ---------->                  @D52VDVB 00490000
PFIXPA20 TM    PCBPXOPT,PCBPXAR2  ALLOCR PFIX REQUESTED        @D52VDVB 00491000
         BZ    D12(,R7)           NO  ==========>  ERROR       @D52VDVB 00492000
         MVC   PCBRPCBG(L'PCBRPCBG),SMRPBEG CURRENT START      @D52VDVB 00493000
         L     R0,SMRPEND         CURRENT END (NEXT BYTE)      @D52VDVB 00494000
         BCTR  R0,0               - 1                          @D52VDVB 00495000
         ST    R0,PCBRPCED        CURRENT END                  @D52VDVB 00496000
         SPACE 1                                               @D52VDVB 00497000
PFIXPG2D DS    0H                                              @D52VDVB 00498000
         LRA   RC,0(R2)           IS PAGE ADDRESSABLE ?        @D35CDKH 00499000
         BC    8,PFIXPG00         YES, BRANCH                  @D35CDKH 00500000
         ST    R2,TRADDR          STORE PAGE ADDRESS           @DA35398 00501000
         L     RC,AGENPGQE        GET RTN ADDRESS              @D52VDRP 00502000
         BALR  RC,RC              GENERATE PGQUI ENTRY         @D52VDRP 00503000
.*  RETURNS WITH DAT ON                                        @D52VDRP 00504000
*        AMODESW SET,DAT=OFF      ENTER REAL MODE              @D52VDRP 00505000
         AMODESW SET,DAT=OFF      ENTER REAL MODE AGAIN        @D52VDRP 00506000
         B     PFIXPG2D           TRY IT ONCE MORE             @D14NDVB 00507000
         SPACE 1                                               @D35CDKH 00508000
PFIXPG00 L     R5,IJBSMCOM        COMMON STORAGE MGMT CB       @D52VDVB 00509000
         USING SMCOM,R5                                        @D52VDVB 00510000
         LR    R4,RC              SAVE CURRENT FRAME ADDRESS   @D52VDVB 00511000
         SRL   RC,PFSHIFT         GET CORRESPONDING            @D35CDKH 00512000
         A     RC,APFT            PFTE-ADDRESS AND             @D35CDKH 00513000
         USING PFTE,RC            SET BASE FOR IT              @D35CDKH 00514000
*     CHECK IF FRAME ALREADY PFIXED, BRANCH IF NOT             @D52VDVB 00515000
*     GENSERV  TEST,FIELD=PFIXC,REG=(R0),BC=BZ,LAB=PFIXPG05    @D52VDVB 00516000
      GENSERV  TEST,FIELD=PFIXC,REG=(R0),BC=BZ,LAB=PFIXPG05    @D52VDVB 00517000
         CL    R0,PMRPFXMX        IS MAXIMAL PFIX COUNT REACHED@D52VDVB 00518000
         BNLR  R7                 YES ============> ERROR: MAX VALUE   *00519000
                                      OF PFIX COUNTER REACHED  @D35CDKH 00520000
         SPACE 1                                               @D52VDVB 00521000
*-------------------------------------------------------------*@D52VDVB 00522000
*    CHECK WHETHER PFIXED PAGE ABOVE 16 MB BOUNDARY            @D52VDVB 00523000
*-------------------------------------------------------------*@D52VDVB 00524000
         SPACE 1                                               @D52VDVB 00525000
         TM    PCBPXOPT,PCBPXABO  31 BIT PFIX ACCEPTED         @D52VDVB 00526000
         BO    PFIXPG95           YES --------->               @D52VDVB 00527000
         CL    R4,SMCRBG3         FRAME IN 31 BIT AREA         @D52VDVB 00528000
         BL    PFIXPG95           NO  --------->               @D52VDVB 00529000
         B     D8(,R7)            YES ==========> ERROR: PFIXED PAGE...*00530000
                                  ... FOUND ABOVE  16 MB       @KX40442 00531000
         DROP  R5                                              @D52VDVB 00532000
         SPACE 1                                               @D35CDKH 00533000
*------------------------------------------------------------- @D35CDKH 00534000
*    CHECK WHETHER PFIX POSSIBLE AT ALL                        @D529DRP 00535000
*--------------------------------------------------------------@D35CDKH 00536000
         SPACE 1                                               @D35CDKH 00537000
PFIXPG05 DS    0H                                              @D52VDVB 00538000
         TM    PCBPXOPT,PCBPXAR3  31 BIT PFIX REQUESTED        @D52VDVB 00539000
         BZ    PFIXPG06           NO  ---------->              @D52VDVB 00540000
         L     R0,SMAXPFX3        31 BIT PFIX MAX VALUE        @D52VDVB 00541000
         L     R4,SMPFIX3         ...         PFIX VALUE       @D52VDVB 00542000
         CLR   R4,R0              MAXIMUM ALREADY PFIXED       @D52VDVB 00543000
         BNL   D4(,R7)            ============> YES, RETURN WITH       *00544000
                                                   OFFSET 4    @D35CDKH 00545000
         B     PFIXPG07           SKIP 24-BIT CODE             @D52VDRP 00546000
PFIXPG06 L     R0,SMAXPFIX        24 BIT / ALLOCR MAX VALUE    @D52VDVB 00547000
         L     R4,SMPFIX          24 BIT / ALLOCR PFIX VALUE   @D52VDVB 00548000
         CLR   R4,R0              MAXIMUM ALREADY PFIXED       @D52VDVB 00549000
         BNL   D4(,R7)            ============> YES, RETURN WITH       *00550000
                                                   OFFSET 4    @D35CDKH 00551000
PFIXPG07 DS    0H                                              @D52VDRP 00552000
         SPACE 1                                               @D35CDKH 00553000
*------------------------------------------------------------- @D35CDKH 00554000
*    SET TIBPTR IN FIXTIB OF PCB AND CLEAR RESERVED            @D369DRP 00555000
*    PFTE-ADDR FIELD, IF REQU. FROM RESTRT, DONT TOUCH PCB     @D369DRP 00556000
*--------------------------------------------------------------@D35CDKH 00557000
         SPACE 1                                               @D35CDKH 00558000
         TM    FIXTYPE,RSTRTBIT   REQUEST FROM RESTART         @D35CDKH 00559000
         BZ    PFIXPG15           NO, BR                       @D35CDKH 00560000
PFIXPG10 DS    0H                                              @D52VDVB 00561000
*    CHECK IF PAGE IN RESERVED FRAME                           @D52VDVB 00562000
*        GENSERV COMP,FIELD=PFTERSVD,REG=(R5),                 @D52VDVB 00563000
*              BC=BE,LAB=PFIXPG25,COMPF=(RC)                   @D52VDVB 00564000
         GENSERV COMP,FIELD=PFTERSVD,REG=(R5),                         *00565000
               BC=BE,LAB=PFIXPG25,COMPF=(RC)                   @D52VDVB 00566000
         B     PFIXPG35           NO                           @D35CDKH 00567000
         SPACE 1                                               @D14ZDVB 00568000
PFIXPG15 MVC   FIXTIB,TIBPTR      SAVE TIB OF REQUESTOR        @D36IDFG 00569000
         SR    R5,R5              INITIALIZE FIELD IN PCB ...  @D149DVB 00570000
         ST    R5,PFTERSVD        ... RESERVED PFTE-ADDR       @D149DVB 00571000
         STH   RF,PFTEPIK         SET PIK IN PFTE              @D52VDRP 00572000
         SPACE 2                                                        00573000
*------------------------------------------------------------- @D35CDKH 00574000
*     TEST WHETHER PAGE IS IN REAL PARTITION                   @D35CDKH 00575000
*------------------------------------------------------------- @D35CDKH 00576000
         SPACE 1                                                        00577000
PFIXPG20 DS    0H                                              @D52VDRP 00578000
*        GENSERV LRADBG,RREG=(R4),VADD=(R2),ERR=NADDR          @D52VDRP 00579000
*                             GET PAGE FRAME ADDRESS           @D52VDRP 00580000
         GENSERV LRADBG,RREG=(R4),VADD=(R2),ERR=NADDR          @D52VDRP 00581000
         C     R4,PCBRPCBG        ADDR < BEGIN OF REAL PART.   @D52VDVB 00582000
         BL    PFIXPG32           Y,BRANCH(PG NOT IN REAL PART)@D35CDKH 00583000
         C     R4,PCBRPCED        ADD > END OF REAL PART       @D52VDVB 00584000
         BNL   PFIXPG32           Y,BRANCH(PG NOT IN REAL PART)@D35CDKH 00585000
         TM    S370FLG,PFTERES+NFRP  PAGE IN RESERVED FRAME    @KD40097 00586000
         BZ    PFIXPG21           NO, PAGE CAN BE PFIXED       @KX41291 00587000
         SGCOV SGPFIXS,MC=0                                    @KX41291 00588000
         B     PFIXPG32           YES, HANDLE IT AS IF NOT IN          *00589000
                                  CORRECT AREA                 @KX41291 00590000
PFIXPG21 DS    0H                                              @KX41291 00591000
         SPACE 1                                               @D35CDKH 00592000
*------------------------------------------------------------- @D35CDKH 00593000
*     TO BE PFIXED PAGE IS IN REAL PARTITION, AND NOT IN A     @KX41291 00594000
*      RESERVED FRAME (PFTERES IS OFF)                         @KX41291 00595000
*     TEST WHETHER PF HAS ALREADY BEEN RESERVED FOR EXCHANGE   @D35CDKH 00596000
*------------------------------------------------------------- @D35CDKH 00597000
         SPACE 1                                               @D35CDKH 00598000
*    GENSERV TEST,FIELD=PFTERSVD,REG=(R5),BC=BZ,LAB=PFIXPG30   @D52VDVB 00599000
     GENSERV TEST,FIELD=PFTERSVD,REG=(R5),BC=BZ,LAB=PFIXPG30   @D52VDVB 00600000
         SPACE 1                                               @D35CDKH 00601000
PFIXPG25 DS    0H                 TURN OFF NFRP-BIT IN RESERVED@D52VDVB 00602000
         NI    S370FLG-PFTE(R5),XFF-NFRP  PFTE, SINCE IT IS NO MORE    *00603000
                                  NEEDED                       @D35CDKH 00604000
*        GENSERV INCOMP,FIELD=NPSQE,REG=(R5),                  @D52VDVB 00605000
*              BC=BNH,LAB=PFIXPG30,COMPF=MINPSQE               @D52VDVB 00606000
         GENSERV INCOMP,FIELD=NPSQE,REG=(R5),                          *00607000
               BC=BNH,LAB=PFIXPG30,COMPF=MINPSQE               @D52VDVB 00608000
         BAL   RA,POSTPFQ         POST TASKS WAITING FOR PF'S  @D36IDFG 00609000
         SPACE 1                                               @D35CDKH 00610000
PFIXPG30 DS    0H                                              @D52VDVB 00611000
*        GENSERV TEST,FIELD=TFIXC,REG=(R4),BC=BNZ,LAB=PFIXPG85 @D52VDVB 00612000
         GENSERV TEST,FIELD=TFIXC,REG=(R4),BC=BNZ,LAB=PFIXPG85 @D52VDVB 00613000
         TM    S370FLG,NFVP       IS PF IN PSQ                 @D35CDKH 00614000
         BO    PFIXPG85           NO,  BRANCH                  @D35CDKH 00615000
         B     PFIXPG38           TRY TO REMOVE PF FROM PSQ    @D35CDKH 00616000
         SPACE 1                                               @D35CDKH 00617000
*------------------------------------------------------------- @D35CDKH 00618000
*     TO BE PFIXED PAGE IS NOT IN REAL PARTITION OR IN         @KX41291 00619000
*      RESERVED FRAME (PFTERES IS ON)                          @KX41291 00620000
*------------------------------------------------------------- @D35CDKH 00621000
         SPACE 1                                                        00622000
PFIXPG32 DS    0H                                              @D52VDVB 00623000
*        GENSERV TEST,FIELD=TFIXC,REG=(R4),BC=BNZ,LAB=PFIXWT2  @D52VDVB 00624000
         GENSERV TEST,FIELD=TFIXC,REG=(R4),BC=BNZ,LAB=PFIXWT2  @D52VDVB 00625000
         SPACE 1                                                        00626000
*------------------------------------------------------------- @D35CDKH 00627000
*     TO BE PFIXED PAGE IS NOT IN REAL PARTITION & NOT TFIXED  @D35CDKH 00628000
*------------------------------------------------------------- @D35CDKH 00629000
         SPACE 1                                                        00630000
PFIXPG35 TM    S370FLG,NFVP       IS PF IN PSQ                 @D52VDVB 00631000
         BO    PFIXPG45           NO,  BRANCH                  @D35CDKH 00632000
         SPACE 1                                                        00633000
*--------------------------------------------------------------@D35CDKH 00634000
*      REMOVE PFTE FROM PSQ,NPSQE:=NPSQE-1                     @D35CDKH 00635000
*      PAGE MAY OR MAY NOT BE IN REAL PARTITION                @D35CDKH 00636000
*--------------------------------------------------------------@D35CDKH 00637000
         SPACE 1                                                        00638000
PFIXPG38 CLC   NPSQE,MINPSQE      CAN PFTE BE REMOVED FROM PSQ @D52VDVB 00639000
         BNH   PFIXWT1            NO   ---------->             @D52VDVB 00640000
         BAL   RA,PMRREMOV        REMOVE PFTE FROM PSQ         @D35CDKH 00641000
*        GENSERV DEC,FIELD=NPSQE,REG=(R5)                      @D52VDVB 00642000
         GENSERV DEC,FIELD=NPSQE,REG=(R5)                      @D52VDVB 00643000
         OI    S370FLG,NFVP       INDICATE PG REQUESTED BY PFIX@D35CDKH 00644000
         TM    FIXTYPE,RSTRTBIT   REQUEST FROM RESTART         @D35CDKH 00645000
         BZ    PFIXPG40           NO, BR                       @D35CDKH 00646000
         C     RC,PFTERSVD        PAGE IN RESERVED PF          @D35CDKH 00647000
         BE    PFIXPG85           YES, BR                      @D35CDKH 00648000
         B     PFIXPG45           NO                           @D35CDKH 00649000
         SPACE 1                                               @D35CDKH 00650000
*--------------------------------------------------------------@D35CDKH 00651000
*     IS PAGE TO BE FIXED IN REAL PARTITION                    @D35CDKH 00652000
*--------------------------------------------------------------@D35CDKH 00653000
         SPACE 1                                               @D35CDKH 00654000
PFIXPG40 DS    0H                                              @D51GDTP 00655000
         TM    S370FLG,PFTERES+NFRP  PAGE IN RESERVED FRAME    @KD40097 00656000
         BNZ   PFIXPG45           YES, HANDLE IT AS IF NOT IN          *00657000
                                  CORRECT AREA                 @KX41291 00658000
*        GENSERV LRADBG,RREG=(R4),VADD=(R2),ERR=NADDR          @D52VDRP 00659000
*                             GET REAL ADDRESS OF PAGE         @D52VDRP 00660000
         GENSERV LRADBG,RREG=(R4),VADD=(R2),ERR=NADDR          @D52VDRP 00661000
         C     R4,PCBRPCBG                                     @D52VDVB 00662000
         BL    PFIXPG45           PAGE NOT IN REAL PARTITION   @D35CDKH 00663000
         C     R4,PCBRPCED                                     @D52VDVB 00664000
         BL    PFIXPG85           PAGE IN REAL PARTITION       @D14ZDVB 00665000
         SPACE 1                                               @D35CDKH 00666000
*--------------------------------------------------------------@D35CDKH 00667000
*     PAGE TO BE PFIXED NOT IN REAL PARTITION, OR IN RESERVED  @KX41291 00668000
*      FRAME (PFTERES IS ON)                                   @KX41291 00669000
*--------------------------------------------------------------@D35CDKH 00670000
         SPACE 1                                               @D35CDKH 00671000
PFIXPG45 TM    PFTEFLG,POABIT     PAGE OUT ACTIVE              @D52VDVB 00672000
         BO    PFIXWT6            YES ---------->                      *00673000
                                  WAIT UNTIL  I/O COMPLETE     @D52VDVB 00674000
*    GENSERV TEST,FIELD=PFTERSVD,REG=(R5),BC=BNZ,LAB=PFIXPG75  @D52VDVB 00675000
     GENSERV TEST,FIELD=PFTERSVD,REG=(R5),BC=BNZ,LAB=PFIXPG75  @D52VDVB 00676000
         DROP  RC                 FORGET PFTE OF TO BE PFXED PG@D35CDKH 00677000
         SPACE 1                                               @D35CDKH 00678000
*------------------------------------------------------------- @D35CDKH 00679000
*     PG TO BE PFIXED ¬IN REAL PART, OR PFTERES ON             @KX41291 00680000
*     SEARCH FOR UNFIXED PF IN REAL PART & DRAP=OFF            @D35CDKH 00681000
*------------------------------------------------------------- @D35CDKH 00682000
         SPACE 1                                                        00683000
PFIXPG50 L     R4,PCBRPCBG        GET BEGIN AND                @D52VDVB 00684000
         L     R5,PCBRPCED        END OF REAL PARTITION        @D52VDVB 00685000
         N     R5,PMPAGMSK        ... ON PAGE BOUNDARY         @D52VDVB 00686000
         SRL   R4,PFSHIFT         CALCULATE OFFSET             @D35CDKH 00687000
         SRL   R5,PFSHIFT         IN PFT                       @D35CDKH 00688000
         A     R4,APFT            POINT TO                     @D35CDKH 00689000
         A     R5,APFT            PFT-ENTRIES                  @D35CDKH 00690000
         LR    R3,R4              SAVE 1ST PFTE OF PARTITION   @D14BDRP 00691000
         NI    SWBYTE,XFF-PGIOSW  PAGE-I/O SWITCH OFF          @D35CDKH 00692000
         B     PFIXPG65                                        @D14BDRP 00693000
         SPACE 1                                               @D35CDKH 00694000
*------------------------------------------------------------- @D149DVB 00695000
*     PFTE SEARCH LOOP                                         @D149DVB 00696000
*------------------------------------------------------------- @D149DVB 00697000
         SPACE 1                                               @D149DVB 00698000
PFIXPG60 DS    0H                                              @D52VDVB 00699000
         LA    R4,LPFTE(,R4)      TAKE NEXT PFTE               @D52VDVB 00700000
PFIXPG65 CR    R4,R5              END OF REAL PARTITION REACHED@D52VDVB 00701000
         BH    PFIXPG70           YES, BRANCH                  @D52VDRP 00702000
         USING PFTE,R4            BASE PFTE'S OF PART          @D35CDKH 00703000
         TM    S370FLG,DRAP+PFTERES+NFRP FAILING STORAGE OR RESERVED   *00704000
                          FOR EXCHANGE OR RESERVED BY GETPT    @KD40097 00705000
         BNZ   PFIXPG60           YES,BR & TRY NEXT PF         @D52VDRP 00706000
         TM    S370FLG,PNRINV     PF UNUSED                    @D35CDKH 00707000
         BO    PFIXPFND           YES, BR & TAKE THIS ONE      @D35CDKH 00708000
         CLC   FIXC,F0            PAGE PFIXED/TFIXED           @D35CDKH 00709000
         BNE   PFIXPG60           YES, BR & TRY NEXT PF        @D35CDKH 00710000
         TM    PFTEFLG,POABIT+PCBIT PAGE-OUT ACTIVE OR         @D35CDKH 00711000
*                                 FRAME  CONNECTED             @D149DRP 00712000
         BZ    PFIXPFND           NO, BRANCH                   @D35CDKH 00713000
         SPACE 1                                               @D35CDKH 00714000
*------------------------------------------------------------- @D35CDKH 00715000
*     PF FOUND FOR EXCHANGE, BUT PAGE I/O RUNNING ON PF        @D35CDKH 00716000
*------------------------------------------------------------- @D35CDKH 00717000
         SPACE 1                                               @D35CDKH 00718000
         ST    R4,PFTERSVD        SAVE PFTE-ADDR IN PCB        @D52VDRP 00719000
         OI    SWBYTE,PGIOSW      IND PG-I/O FOR PAGE FRAME    @D35CDKH 00720000
         B     PFIXPG60                                        @D52VDVB 00721000
**********************************END OF SCAN THROUGH REAL PART@D35CDKH 00722000
         SPACE 1                                               @D149DVB 00723000
*------------------------------------------------------------- @D35CDKH 00724000
*     PAGE FRAME FOUND IN REAL PARTITION FOR EXCHANGE          @D35CDKH 00725000
*------------------------------------------------------------- @D35CDKH 00726000
         SPACE 1                                               @D35CDKH 00727000
PFIXPFND ST    R4,PFTERSVD        SAVE PFTE-ADDR IN PCB        @D369DRP 00728000
         B     PFIXPG80           GO TO EXCHANGE PAGES         @D35CDKH 00729000
         SPACE 1                                               @D35CDKH 00730000
         DROP  R4                 RESTORE BASE FOR PFTE OF     @D35CDKH 00731000
         USING PFTE,RC            TO BE PFIXED PAGE            @D35CDKH 00732000
         SPACE 1                                               @D149DVB 00733000
*------------------------------------------------------------- @D35CDKH 00734000
*     NO PAGE FRAME FOR EXCHANGE OR PAGE I/O ACTIVE ON FRAME   @D35CDKH 00735000
*------------------------------------------------------------- @D35CDKH 00736000
         SPACE 1                                               @D149DVB 00737000
PFIXPG70 TM    SWBYTE,PGIOSW      PG-I/O RUNNING ON PF         @D35CDKH 00738000
         BZ    PFIXWT3            NO  ---------->              @D52VDVB 00739000
         SPACE 1                                               @D35CDKH 00740000
*--------------------------------------------------------------@D35CDKH 00741000
*   ONLY PAGE FRAME AVAILABLE FOR EXCHANGE, WITH PG-I/O ACTIVE @D52VDRP 00742000
*--------------------------------------------------------------@D35CDKH 00743000
         SPACE 1                                               @D35CDKH 00744000
PFIXPG71 CLC   NPSQE,MINPSQE      CAN NPSQE BE DECREASED       @D35CDKH 00745000
         BNH   PFIXWT4            NO  ---------->              @D52VDVB 00746000
*        GENSERV DEC,FIELD=NPSQE,REG=(R5)                      @D52VDVB 00747000
         GENSERV DEC,FIELD=NPSQE,REG=(R5)                      @D52VDVB 00748000
         DROP  RC                                              @D35CDKH 00749000
         USING PFTE,R5            BASE FOR RESERVED PFTE ADDR  @D35CDKH 00750000
         L     R5,PFTERSVD        TURN ON NFRP-BIT IN          @D35CDKH 00751000
         OI    S370FLG,NFRP       RESERVED PFTE                @D35CDKH 00752000
         SPACE 1                                               @D35CDKH 00753000
*--------------------------------------------------------------@D35CDKH 00754000
*     TEST WHETHER PAGE I/O RUNNING ON RESERVED PF             @D35CDKH 00755000
*--------------------------------------------------------------@D35CDKH 00756000
         SPACE 1                                               @D35CDKH 00757000
PFIXPG75 TM    PFTEFLG,POABIT+PCBIT PAGE-OUT ACTIVE OR PF CONN.@D52VDVB 00758000
         BNZ   PFIXWT5            YES --------->                       *00759000
                                  WAIT UNTIL I/O COMPLETE      @D52VDVB 00760000
         DROP  R5                 FORGET BASE FOR RESERVED PFTE@D36IDFG 00761000
         USING PFTE,RC                                         @D52VDVB 00762000
         SPACE 1                                               @D35CDKH 00763000
*--------------------------------------------------------------@D35CDKH 00764000
*     NO PAGE I/O RUNNING ON RESERVED PF                       @D35CDKH 00765000
*--------------------------------------------------------------@D35CDKH 00766000
         SPACE 1                                               @D35CDKH 00767000
*        GENSERV INCOMP,FIELD=NPSQE,REG=(R5),                  @D52VDVB 00768000
*              BC=BNH,LAB=PFIXPG80,COMPF=MINPSQE               @D52VDVB 00769000
         GENSERV INCOMP,FIELD=NPSQE,REG=(R5),                          _00770000
               BC=BNH,LAB=PFIXPG80,COMPF=MINPSQE               @D52VDVB 00771000
         BAL   RA,POSTPFQ         POST TASKS WAITING FOR PF'S  @D36IDFG 00772000
         SPACE 1                                               @D35CDKH 00773000
*--------------------------------------------------------------@D35CDKH 00774000
*     EXCHANGE PAGES                                           @D35CDKH 00775000
*--------------------------------------------------------------@D35CDKH 00776000
         SPACE 1                                               @D35CDKH 00777000
PFIXPG80 LR    R5,RE              SAVE RET. REG OF PFIX        @D52VDVB 00778000
         L     RE,PFTERSVD        GET RESERVED PFTE            @D35CDKH 00779000
         L     RA,AFIXEXCH        GET ADDR OF FIXEXCHG RTN     @D52VDRP 00780000
         SGCOV SGPFIX,MC=1        EXCHANGE FROM PFIX           @D52VDRP 00781000
         BALR  RA,RA                                           @D52VDRP 00782000
*SGLINK  FIXEXCHG,INPUT=(R8:APMGMDAT,RA:LINK,RC:PFTE,RE:PFTE),         *00783000
               NOMODR=(R0-RF),OUTPUT=(),AMODE=31 DATOFF                 00784000
         NI    S370FLG-PFTE(RE),XFF-NFRP                       @D35CDKH*00785000
                                  NFRP:=OFF IN RESERVED PFTE   @D35CDKH 00786000
         LR    RC,RE              POINT TO NEW PFTE            @D35CDKH 00787000
         LR    RE,R5              RESTORE RET. REG OF PFIX     @D35CDKH 00788000
         SPACE 1                                               @D35CDKH 00789000
PFIXPG85 NI    S370FLG,XFF-NFVP   NFVP:=OFF IN PFIXED PFTE     @D52VDVB 00790000
         TM    PCBPXOPT,PCBPXAR3  31 BIT PFIX REQUESTED        @D52VDVB 00791000
         BZ    PFIXPG90           NO  ---------->              @D52VDVB 00792000
*        GENSERV INC,FIELD=SMPFIX3,REG=(R5)                    @D52VDVB 00793000
         GENSERV INC,FIELD=SMPFIX3,REG=(R5)                    @D52VDVB 00794000
         B     PFIXPG95           ---------->                  @D52VDVB 00795000
*        GENSERV INC,FIELD=SMPFIX,REG=(R5)                     @D52VDVB 00796000
PFIXPG90 GENSERV INC,FIELD=SMPFIX,REG=(R5)                     @D52VDVB 00797000
         SPACE 1                                               @D35CDKH 00798000
PFIXPG95 DS    0H                                              @D52VDVB 00799000
*        GENSERV INC,FIELD=PFIXC,REG=(R5)                      @D52VDVB 00800000
         GENSERV INC,FIELD=PFIXC,REG=(R5)                      @D52VDVB 00801000
         B     20(,R7)            ===========> RETURN: DONE    @D52VDVB 00802000
         SPACE 2                                               @D35CDKH 00803000
         DROP  RC                 FORGET PFTE                  @D35CDKH 00804000
         EJECT                                                 @D52VDVB 00805000
*-------------------------------------------------------------*@D52VDVB 00806000
*     WAIT CONDITIONS                                         *@D52VDVB 00807000
*-------------------------------------------------------------*@D52VDVB 00808000
         SPACE 2                                               @D35CDKH 00809000
*--------------------------------------------------------------@D35CDKH 00810000
*     PAGE TO BE FIXED CANT BE REMOVED FROM PSQ SINCE          @D35CDKH 00811000
*     NPSQE<=MINPSQE. TASK IS SET TO WAIT (PFGBND)             @D35CDKH 00812000
*--------------------------------------------------------------@D35CDKH 00813000
         SPACE 1                                               @D35CDKH 00814000
PFIXWT1  DS    0H                                              @D52VDVB 00815000
         AGO   .PFCCW10                                        @D64YDOW 00816000
*      GENSERV TEST,FIELD=LOWFXPTR,REG=(R4),BC=BZ,LAB=PFIXWT1A @D52VDVB 00817000
       GENSERV TEST,FIELD=LOWFXPTR,REG=(R4),BC=BZ,LAB=PFIXWT1A @D52VDVB 00818000
         L     R9,ACCWT           GET BASE ADDR OF CCW-FX-FUNCT@D35CDKH 00819000
         DROP  R9                                              @D35CDKH 00820000
         USING CCWTADR,R9         SET BASE                     @D35CDKH 00821000
*        AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @D52VDRP 00822000
         AMODESW SET,DAT=ON                                    @D52VDRP 00823000
*        AMODESW CALL,AMODE=24,ADDRESS=DEFIXCON,REGS=(RA,RA)   @D52VDRP 00824000
         AMODESW CALL,AMODE=24,ADDRESS=DEFIXCON,REGS=(RA,RA)   @D52VDRP 00825000
*                                 FREE PGS KEPT BY FST-CCW-FIX @D35CDKH 00826000
*SGLINK  DEFIXCON,INPUT=(R9,RA)                                @D369DRP 00827000
*        AMODESW SET,DAT=OFF      ENTER REAL MODE (DAT=OFF)    @D52VDRP 00828000
         AMODESW SET,DAT=OFF                                   @D52VDRP 00829000
         L     R9,APMFIXAD        GET BACK BASE FOR CODE AREA  @D35CDKH 00830000
         DROP  R9                                              @D35CDKH 00831000
         USING PMFIXADR,R9        RESET BASE FOR CODE AREA     @D35CDKH 00832000
         SGCOV SGPFIXS,MC=1                                    @D52VDRP 00833000
         B     PFIXPG38           TRY IT ONCE MORE             @D52VDVB 00834000
         SPACE 1                                               @D35CDKH 00835000
PFIXWT1A DS    0H                                              @D52VDVB 00836000
.PFCCW10 ANOP                                                  @D64YDOW 00837000
         L     R5,ASRQTAB         SRQ TABLE ADDRESS            @D61RDRP 00838000
         LA    R5,SRQPFG-SRQTAB(,R5) PT TO WAIT QUEUE          @D61RDRP 00839000
         BAL   RA,PFIXWAIT        SET TASK TO WAIT             @D35CDKH 00840000
         B     PFIXPG2D           TRY PFIX AGAIN FOR SAME PAGE @D14NDVB 00841000
         SPACE 1                                               @D35CDKH 00842000
*--------------------------------------------------------------@D35CDKH 00843000
*     PG TO BE PFIXED IS OUTSIDE REAL PART. & TFIXED           @D35CDKH 00844000
*     WAIT UNTIL PFTE IS FREED (TFIXCNT = 0)                   @D52VDVB 00845000
*--------------------------------------------------------------@D35CDKH 00846000
         SPACE 1                                               @D35CDKH 00847000
PFIXWT2  DS    0H                                              @D52VDVB 00848000
         AGO   .PFCCW20                                        @D64YDOW 00849000
*      GENSERV TEST,FIELD=LOWFXPTR,REG=(R4),BC=BZ,LAB=PFIXWT2A @D52VDVB 00850000
       GENSERV TEST,FIELD=LOWFXPTR,REG=(R4),BC=BZ,LAB=PFIXWT2A @D52VDVB 00851000
         L     R9,ACCWT           LOAD BASE FOR FIXING FUNCTION@D35CDKH 00852000
         DROP  R9                                              @D35CDKH 00853000
         USING CCWTADR,R9                                      @D35CDKH 00854000
*        AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @D52VDRP 00855000
         AMODESW SET,DAT=ON                                    @D52VDRP 00856000
*        AMODESW CALL,AMODE=24,ADDRESS=DEFIXALL,REGS=(RA,RA)   @D52VDRP 00857000
         AMODESW CALL,AMODE=24,ADDRESS=DEFIXALL,REGS=(RA,RA)   @D52VDRP 00858000
*                                 FREE ALL FIXED PAGES         @D35CDKH 00859000
*SGLINK  DEFIXALL,INPUT=(R9,RA)                                @D369DRP 00860000
*        AMODESW SET,DAT=OFF      ENTER REAL MODE              @D52VDRP 00861000
         AMODESW SET,DAT=OFF                                   @D52VDRP 00862000
         L     R9,APMFIXAD        RESTORE BASE FOR CODE        @D35CDKH 00863000
         DROP  R9                                              @D35CDKH 00864000
         USING PMFIXADR,R9                                     @D35CDKH 00865000
         B     PFIXPG32                                        @D35CDKH 00866000
         SPACE 1                                               @D52VDVB 00867000
PFIXWT2A DS    0H                                              @D52VDVB 00868000
.PFCCW20 ANOP                                                  @D64YDOW 00869000
         USING PFTE,RC            ADDRESS PFTE                 @D14BDRP 00870000
         TM    PCBPXREQ,PCBPXRET  RETURN REQUIRED?             @DY43013 00871000
         BO    PFIXWT3X           YES, =====> RETURN OFFSET 16 @DY43013 00872000
         OI    S370FLG,NFVP       INDICATE PAGE NOT FIXABLE    @D35CDKH 00873000
         L     R5,ASRQTAB                                      @D61RDRP 00874000
         LA    R5,SRQPGFX-SRQTAB(,R5) ADDR OF RESOURCE DESCR.  @D61RDRP 00875000
         BAL   RA,PFIXWAIT        SET TASK TO WAIT             @D35CDKH 00876000
         B     PFIXPG20                                        @D35CDKH 00877000
         DROP  RC                 DROP ADDRESSABILITY TO PFTE  @D14BDRP 00878000
         SPACE 2                                               @D35CDKH 00879000
*--------------------------------------------------------------@D35CDKH 00880000
*     NO FREE FRAME IN PFIX AREA FOR EXCHANGE                  @D52VDVB 00881000
*     TURN ON NFRP-BIT IN ALL PFTE'S OF THE ALLOCR AREA        @D35CDKH 00882000
*     OR SET INDICATION FOR PF REQUEST IN COMMON PFIX AREAS    @D52VDVB 00883000
*     AND WAIT FOR AN UNFIXED PF                               @D35CDKH 00884000
*--------------------------------------------------------------@D35CDKH 00885000
         SPACE 1                                               @D35CDKH 00886000
PFIXWT3  DS    0H                                              @D52VDVB 00887000
         AGO   .PFCCW30                                        @D64YDOW 00888000
*      GENSERV TEST,FIELD=LOWFXPTR,REG=(RA),BC=BZ,LAB=PFIXWT3A @D52VDVB 00889000
       GENSERV TEST,FIELD=LOWFXPTR,REG=(RA),BC=BZ,LAB=PFIXWT3A @D52VDVB 00890000
         L     R9,ACCWT           LOAD BASE FOR CCW FIXING     @D35CDKH 00891000
         DROP  R9                                              @D35CDKH 00892000
         USING CCWTADR,R9         FUNCTION                     @D35CDKH 00893000
*        AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @D52VDRP 00894000
         AMODESW SET,DAT=ON                                    @D52VDRP 00895000
*        AMODESW CALL,AMODE=24,ADDRESS=DEFIXALL,REGS=(RA,RA)   @D52VDRP 00896000
         AMODESW CALL,AMODE=24,ADDRESS=DEFIXALL,REGS=(RA,RA)   @D52VDRP 00897000
*                                 FREE ALL FIXED PAGES         @D35CDKH 00898000
*SGLINK  DEFIXALL,INPUT=(R9,RA)                                @D369DRP 00899000
*        AMODESW SET,DAT=OFF      ENTER REAL MODE              @D52VDRP 00900000
         AMODESW SET,DAT=OFF                                   @D52VDRP 00901000
         L     R9,APMFIXAD        RESTORE BASE FOR CODE        @D35CDKH 00902000
         DROP  R9                                              @D35CDKH 00903000
         USING PMFIXADR,R9                                     @D35CDKH 00904000
         SGCOV SGPFIXS,MC=5                                    @D52VDRP 00905000
         B     PFIXPG50           GO TO TRY AGAIN              @D35CDKH 00906000
         SPACE 1                                               @D14ZDVB 00907000
PFIXWT3A DS    0H                                              @D52VDVB 00908000
.PFCCW30 ANOP                                                  @D64YDOW 00909000
         TM    PCBPXREQ,PCBPXRET  RETURN REQUIRED?             @D52VDVB 00910000
         BZ    PFIXWT3B           NO, ----------->             @KD40069 00911000
PFIXWT3X DS    0H                 ENTERED HERE FROM PFIXWT2    @DY43013 00912000
         USING PFTE,RC            ADDRESS PFTE                 @KD40069 00913000
         TM    S370FLG,NFVP       IS PF IN PSQ                 @KD40069 00914000
         BZ    D16(,R7)           YES, =========> RETURN OFFS16@KD40069 00915000
         NI    S370FLG,XFF-NFVP   RESET NFVP FLAG              @KD40069 00916000
*        GENSERV INC,FIELD=NPSQE,REG=(5)  INCREASE NPSQE       @KD40069 00917000
         GENSERV INC,FIELD=NPSQE,REG=(5)                       @KD40069 00918000
         L     RB,PSQPTR          ADDRESS OF PSQ               @KD40069 00919000
*                                 PMRINSBT                              00920000
*SGLINK  PMRINSBT,INPUT=(R8,RA,RB,RC),WORK=(R4,R5),AMODE=31 DATOFF      00921000
         BAL   RA,PMRINSBT        INSERT PAGE AT BOTTOM OF PSQ @KD40069 00922000
         B     D16(,R7)           ===============> RETURN WITH         *00923000
                                                   OFFSET 16   @KD40069 00924000
         DROP  RC                 RESET BASE OF PFTE           @KD40069 00925000
PFIXWT3B DS    0H                                              @D35CDKH 00926000
         USING PFTE,R3            ADDRESS 1ST PFTE OF PARTITION@D14BDRP 00927000
         TM    PCBPXOPT,PCBPXAR2  ALLOCR PFIX                  @D52VDVB 00928000
         BZ    PFIXWT3E           NO  ---------->              @D52VDVB 00929000
PFIXWT3C OI    S370FLG,NFRP       TURN ON NFRP-BIT             @D35CDKH 00930000
         LA    R3,LPFTE(R3)       GET NEXT PFTE OF PARTITION   @D14BDRP 00931000
         CR    R3,R5              END OF PART REACHED          @D14BDRP 00932000
         BNH   PFIXWT3C           NO , DO MORE ---------->     @KD40070 00933000
         DROP  R3                 RESET BASE OF PFTE           @D14BDRP 00934000
         SPACE 1                                               @D35CDKH 00935000
PFIXWT3D DS    0H                                              @D35CDKH 00936000
         SGCOV SGPFIXS,MC=6                                    @D52VDRP 00937000
         L     R5,ASRQTAB                                      @D61RDRP 00938000
         LA    R5,SRQPGFX-SRQTAB(,R5) ADDR OF RESOURCE DESCR.  @D61RDRP 00939000
         BAL   RA,PFIXWAIT        SET TASK TO WAIT             @D35CDKH 00940000
*    GENSERV TEST,FIELD=PFTERSVD,REG=(R5),BC=BNZ,LAB=PFIXPG20  @D52VDVB 00941000
     GENSERV TEST,FIELD=PFTERSVD,REG=(R5),BC=BNZ,LAB=PFIXPG20  @D52VDVB 00942000
         B     PFIXWT3D           NO, WAIT AGAIN               @D52VDVB 00943000
         SPACE 1                                               @D52VDVB 00944000
PFIXWT3E DS    0H                                              @D52VDVB 00945000
         TM    PCBPXOPT,PCBPXAR1  24 BIT PFIX                  @D52VDVB 00946000
         BZ    PFIXWT3G           NO  ---------->              @D52VDVB 00947000
PFIXWT3F OI    PMRPXFLG,PMRPXLOB  INDICATE 24 BIT PFIX PFTES           *00948000
                                  ... ARE REQUESTED VIA TFREE  @D52VDVB 00949000
         SGCOV SGPFIXS,MC=7                                    @D52VDRP 00950000
         L     R5,ASRQTAB                                      @D61RDRP 00951000
         LA    R5,SRQPXLO-SRQTAB(,R5) RSRC DESCR 24 BIT PFIX   @D61RDRP 00952000
         BAL   RA,PFIXWAIT        WAIT                         @D52VDVB 00953000
         L     R5,PMRPXLOP                                     @D52VDVB 00954000
         ST    R5,PFTERSVD        GET RESERVED PFTE OR ZERO    @D52VDVB 00955000
         XC    PMRPXLOP,PMRPXLOP  CLEAR RESERVED FOR OTHERS    @D52VDRP 00956000
         B     PFIXPG20           HANDLE, -------->            @KD40069 00957000
         SPACE 1                                               @D52VDVB 00958000
PFIXWT3G DS    0H                                              @D52VDVB 00959000
         OI    PMRPXFLG,PMRPXHIB INDICATE 31 BIT PFIX PFTES            *00960000
                                  ... ARE REQUESTED VIA TFREE  @D52VDVB 00961000
         SGCOV SGPFIXS,MC=8                                    @D52VDRP 00962000
         L     R5,ASRQTAB                                      @D61RDRP 00963000
         LA    R5,SRQPXHI-SRQTAB(,R5) RSRC DESCR 31 BIT PFIX   @D61RDRP 00964000
         BAL   RA,PFIXWAIT        WAIT                         @D52VDVB 00965000
         L     R5,PMRPXHIP                                     @D52VDVB 00966000
         ST    R5,PFTERSVD        GET RESERVED PFTE OR ZERO    @D52VDVB 00967000
         XC    PMRPXHIP,PMRPXHIP  CLEAR RESERVED FOR OTHERS    @D52VDVB 00968000
         B     PFIXPG20           HANDLE, -------->            @KD40069 00969000
         SPACE 1                                                        00970000
*--------------------------------------------------------------@D35CDKH 00971000
*     PAGE TO BE PFIXED IS OUTSIDE REAL PARTITION              @D35CDKH 00972000
*     A PF IN REAL PART IS RESERVED FOR EXCHANGE, BUT NPSQE<=MINPSQE    00973000
*--------------------------------------------------------------@D35CDKH 00974000
         SPACE 1                                               @D35CDKH 00975000
PFIXWT4  DS    0H                                              @52VDVBH 00976000
         AGO   .PFCCW40                                        @D64YDOW 00977000
*      GENSERV TEST,FIELD=LOWFXPTR,REG=(R4),BC=BZ,LAB=PFIXWT4A @D52VDVB 00978000
       GENSERV TEST,FIELD=LOWFXPTR,REG=(R4),BC=BZ,LAB=PFIXWT4A @D52VDVB 00979000
         L     R9,ACCWT                                        @D35CDKH 00980000
         DROP  R9                                              @D35CDKH 00981000
         USING CCWTADR,R9                                      @D35CDKH 00982000
*        AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @D52VDRP 00983000
         AMODESW SET,DAT=ON                                    @D52VDRP 00984000
*        AMODESW CALL,AMODE=24,ADDRESS=DEFIXCON,REGS=(RA,RA)   @D52VDRP 00985000
         AMODESW CALL,AMODE=24,ADDRESS=DEFIXCON,REGS=(RA,RA)   @D52VDRP 00986000
*                                 FREE ALL FIXED PAGES         @D35CDKH 00987000
*SGLINK  DEFIXCON,INPUT=(R9,RA)                                @D369DRP 00988000
*        AMODESW SET,DAT=OFF      ENTER REAL MODE (DAT=OFF)    @D52VDRP 00989000
         AMODESW SET,DAT=OFF                                   @D52VDRP 00990000
         L     R9,APMFIXAD                                     @D35CDKH 00991000
         DROP  R9                                              @D35CDKH 00992000
         USING PMFIXADR,R9                                     @D35CDKH 00993000
         B     PFIXPG71           TRY IT AGAIN ---------->     @D52VDVB 00994000
         SPACE 1                                               @D52VDVB 00995000
PFIXWT4A DS    0H                                              @D52VDVB 00996000
.PFCCW40 ANOP                                                  @D64YDOW 00997000
         SR    R5,R5              CLEAR ADDR OF RESERVED PFTE  @D35CDKH 00998000
         ST    R5,PFTERSVD        IN PCB                       @D369DRP 00999000
         L     R5,ASRQTAB            POINT                     @D61RDRP 01000000
         LA    R5,SRQPFG-SRQTAB(,R5) *  TO PFG WAIT QUEUE      @D61RDRP 01001000
         BAL   RA,PFIXWAIT        SET TASK TO WAIT             @D35CDKH 01002000
*        GENSERV LRADBG,RREG=(RC),VADD=(R2),ERR=NADDR          @D52VDRP 01003000
*                             GET REAL ADDRESS OF PAGE         @D52VDRP 01004000
         GENSERV LRADBG,RREG=(RC),VADD=(R2),ERR=NADDR          @D52VDRP 01005000
         SRL   RC,PFSHIFT         POINT TO CORRESPONDING       @D52VDRP 01006000
         A     RC,APFT            PFT-ENTRY                    @D52VDRP 01007000
         B     PFIXPG20                                        @D35CDKH 01008000
         SPACE 1                                               @D14ZDVB 01009000
*--------------------------------------------------------------@D35CDKH 01010000
*     WAIT FOR PAGE I/O COMPLETE FOR RESERVED PAGE FRAME       @D35CDKH 01011000
*--------------------------------------------------------------@D35CDKH 01012000
         SPACE 1                                               @D35CDKH 01013000
PFIXWT5  DS    0H                                              @D52VDVB 01014000
         SGCOV SGPFIXS,MC=10                                   @D52VDRP 01015000
         LR    R3,R1              SAVE R1                      @D14BDRP 01016000
         LR    R1,R5              GET PFTE POINTER             @D36IDFG 01017000
         L     R5,ASRQTAB             POINT                    @D61RDRP 01018000
         LA    R5,SRQPGIO-SRQTAB(,R5) * TO PAGE I/O WAIT QUEUE @D61RDRP 01019000
         BAL   RA,PGIOWAIT        WAIT FOR END OF PAGE I/O     @D36IDRP 01020000
         LR    R1,R3              RESTORE R1                   @D14BDRP 01021000
         TM    FIXTYPE,RSTRTBIT                                @D35CDKH 01022000
         BO    PFIXPG10                                        @D35CDKH 01023000
         B     PFIXPG20                                        @D35CDKH 01024000
         DROP  RD                 DROP PCB BASE (REAL)         @D52VDRP 01025000
         SPACE 2                                               @D52VDVB 01026000
*--------------------------------------------------------------@D52ADVB 01027000
*     WAIT UNTIL I/O COMPLETED                                 @D52ADVB 01028000
*--------------------------------------------------------------@D52ADVB 01029000
         SPACE 1                                               @D52VDVB 01030000
PFIXWT6  DS    0H                                              @D52VDVB 01031000
         SGCOV SGPFIXS,MC=11                                   @D52VDRP 01032000
         LR    R3,R1              SAVE R1                      @D14BDRP 01033000
         LR    R1,RC              GET ADDRESS OF PFTE          @D36IDFG 01034000
         L     R5,ASRQTAB             POINT                    @D61RDRP 01035000
         LA    R5,SRQPGIO-SRQTAB(,R5) * TO PAGE I/O WAIT QUEUE @D61RDRP 01036000
         BAL   RA,PGIOWAIT        AND WAIT FOR END OF PAGE OUT @D36IDRP 01037000
         LR    R1,R3              RESTORE R1                   @D14BDRP 01038000
         B     PFIXPG20           TRY AGAIN                    @D35CDKH 01039000
         EJECT                                                 @D14ZDVB 01040000
*-------------------------------------------------------------*@D149DVB 01041000
*                                                              @D149DVB 01042000
*        ROUTINE PROLOGUE                                      @D149DVB 01043000
*        ROUTINE NAME: GETPADR                                 @D149DVB 01044000
*        MACRO:        SGPFIX                                  @D149DVB 01045000
*        FUNCTION: PROVIDES NEXT ENTRY IN PFIX PARAMETER LIST. @D149DVB 01046000
*        CALLED BY:    PFIX, PFREE WITH AMODE OF SERVICE       @D149DVB 01047000
*                            REQUESTOR, DATOFF                 @D149DVB 01048000
*        CALLED ROUTINES: VALWRITE WITH AMODE OF GETPADR, DATON@D149DVB 01049000
*        ENTRY POINTS:                                         @D149DVB 01050000
*              GETPADR  (1ST INVOCATION FOR A LIST ENTRY)      @D149DVB 01051000
*              GETNPADR (FOLLOWING INVOCATIONS)                @D149DVB 01052000
*        INPUT:                                                @D149DVB 01053000
*              R1 - ADDR (LIST (PARM))                         @D149DVB 01054000
*                   PARM = (ADDR PTR(31),LEN(AREA)-1 BIN FIXED(31))     01055000
*                          FIRST BYTE OF ADDR ¬= 0 MEANS EOL   @D149DVB 01056000
*              RA - RETURN ADDR                                @D149DVB 01057000
*              RF - PIK OF OWNER OF REQUESTED AREA             @D51IDRP 01058000
*          IN ADDITION IF CALLED VIA GETNPADR                  @D149DVB 01059000
*              R2 - ADDR OF PAGE TO BE HANDLED                 @D149DVB 01060000
*              R6 - END ADDR OF CURRENT AREA                   @D149DVB 01061000
*        OUTPUT:                                               @D149DVB 01062000
*              R2 - ADDR NEXT PAGE TO BE HANDLED               @D149DVB 01063000
*        EXIT : CALLER VIA OFFSET                              @D149DVB 01064000
*                    0 - END OF PARAMETER LIST                 @D149DVB 01065000
*                    4 - INVALID KEY OR PROTECTION             @D149DVB 01066000
*                    8 - NEXT PAGE PROVIDED                    @D149DVB 01067000
*                                                              @D149DVB 01068000
*        INTERNAL REGISTER USAGE                               @D149DVB 01069000
*              R5 - WORK REGISTER                              @D149DVB 01070000
*                                                              @D149DVB 01071000
*        OPERATION:                                            @D149DVB 01072000
*                                                              @D149DVB 01073000
*        GETNPADR:                        /*  E N T R Y  P T */@D149DVB 01074000
*        INCREASE PAGADDR                 /*GET ADDR NEXT PAG*/@D149DVB 01075000
*        IF PAGADDR < END_ADDR(AREA) THEN RETURN (COND=OK)     @D149DVB 01076000
*        ELSE DO                                               @D149DVB 01077000
*        GETPADR:                         /*  E N T R Y  P T */@D149DVB 01078000
*        IF EOL(PARM) THEN RETURN (COND=EOL(PARM)              @D149DVB 01079000
*                                         /* END OF PARAMETER*/@D149DVB 01080000
*        IF PARM.LENGTH < 0 THEN RETURN (COND=INVALID LENGTH)  @D149DVB 01081000
*        BEG_ADDR(AREA) := PARM.ADDR      /* START ADDR AREA */@D149DVB 01082000
*        END_ADDR(AREA) := BEG_ADDR + PARM.LENGTH              @D149DVB 01083000
*                                         /* END ADDR AREA   */@D149DVB 01084000
*        CALL VALWRITE(BEG_ADDR,END_ADDR)    /* VALIDATE AREA*/@D149DVB 01085000
*        IF VALIDATION OK                                      @D149DVB 01086000
*           THEN RETURN (COND = OK )                           @D149DVB 01087000
*           ELSE RETURN (COND = INVALID ADDR)                  @D149DVB 01088000
*        END  (GETPADR)                                        @D149DVB 01089000
*-------------------------------------------------------------*@D149DVB 01090000
         SPACE 2                                                        01091000
         USING PFIXLSTE,R1        SET BASE FOR PARAM-LIST ENTRY         01092000
GETNPADR DS    0H                                              @D14NDVB 01093000
         AL    R2,PAGESIZE        GET ADDR NEXT PAGE           @D14NDVB 01094000
         CLR   R2,R6              PAGE STILL IN AREA           @D52VDRP 01095000
         BNH   GETPRET8           YES, ----------> HANDLE PAGE @D52VDRP 01096000
         LA    R1,L'PFIXENT(,R1)  POINT TO NEXT PARAMETER LIST ENTRY    01097000
         B     GETPADR            NO, TAKE NEXT PARMLIST ENTRY @D52VDRP 01098000
GETPRETX DS    0H                                              @D64XDMZ 01099000
         LM    R1,R2,PMRSAVE2     RESTORE REGISTERS            @D64XDMZ 01100000
         L     R6,PMRSAV21        RESTORE R6                   @D64XDMZ 01101000
GETPRET8 AL    RA,F4              INCREASE RETURN ADDRESS BY 4 @D52VDRP 01102000
GETPRET4 AL    RA,F4              INCREASE RETURN ADDRESS BY 4 @D52VDRP 01103000
GETPRET0 DS    0H                                              @D52VDRP 01104000
*        AMODESW SET,DAT=OFF      ENTER REAL MODE (DAT=OFF)    @D52VDRP 01105000
         AMODESW SET,DAT=OFF                                   @D52VDRP 01106000
*        AMODESW RETURN,REG=(RA)  ===========>  RETURN         @D52VDVB 01107000
         AMODESW RETURN,REG=(RA)  RETURN IN APPROPRIATE MODE   @D52VDVB 01108000
*                                                              @D52VDRP 01109000
GETPADR  DS    0H                                              @D52VDRP 01110000
*        AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @D52VDRP 01111000
         AMODESW SET,DAT=ON                                    @D52VDRP 01112000
         CLC   PFIXBEG(L'PFIXENT),PFIXBEG CHECK FOR VALID ENTRY@KX40685 01113000
PCKSVC67 EQU   *       PROGRAM CHECK ADDRESS IF INVALID PARML  @D52VDVB 01114000
.*   THIS EQU STMT MUST FOLLOW THE CLC- STMT IMMEDIATLY        @D52VDVB 01115000
         L     R2,PFIXBEG         GET BEGIN ADDR OF AREA       @D52VDVB 01116000
         LA    R2,0(,R2)          CHECK WHETHER                @D52VDVB 01117000
         CL    R2,PFIXBEG         ...  END OF LIST IS REACHED  @D52VDVB 01118000
         BNE   GETPRET0           YES, RETURN WITH OFFSET 0    @D52VDRP 01119000
GETPADR1 L     R5,PFIXLNG         GET LENGTH OF AREA                    01120000
         LTR   R5,R5                                                    01121000
         BM    GETPRET4           RETURN VIA OFFS 4 IF NEGATIV @D52VDRP 01122000
         LR    R6,R2              GET END ADDR                          01123000
         ALR   R6,R5              OF AREA                               01124000
         CL    R6,AVPBEG          END ADDR. IN VPOOL           @D14BDRP 01125000
         BL    GETPADR2           NO, BRANCH                   @D51GDRP 01126000
         CL    R6,AVPEND          REALY IN VPOOL               @D51GDRP 01127000
         BNH   GETPRET4           YES, ---> RETURN WITH OFF. 4 @D52VDRP 01128000
GETPADR2 LA    R5,0(,R6)          IS END ADDR VALID IN ...     @D52VDRP 01129000
         CR    R6,R5              .... USER'S MODE             @D52VDRP 01130000
         BNE   GETPRET4           NO, ----> RETURN WITH OFF. 4 @D52VDRP 01131000
         N     R2,PADDRMSK        SET BEGIN ADDR ON PAGE BOUNDARY       01132000
         DROP  R1                 RELEASE PFIXLSTE             @D64XDMZ 01133000
VALPADDR STM   R1,R2,PMRSAVE2     SAVE REGISTERS               @D14BDRP 01134000
         ST    R6,PMRSAV21        SAVE R6                      @D14BDRP 01135000
         LR    R1,R2              GET BEGIN ADDR IN R1         @D14BDRP 01136000
         LR    R2,R6              GET END ADDR IN R2           @D14BDRP 01137000
         LR    R5,RF              GET PIK IN R5                @D14BDRP 01138000
.* RF = 0 IN CASE OF SPFIX                                     @D14BDRP 01139000
.* RF = PIK OF PARTITION OTHERWISE                             @D14BDRP 01140000
         L     R6,DISPAD          GET ADDR OF DISPATCHER       @D14BDRP 01141000
         USING DISP,R6                                         @D14BDRP 01142000
*SGLINK  VALWRITE,INPUT=(R1,R2,R5,R6,R8),WORK=(R2),OUTPUT=(R5) @D14BDRP 01143000
         BAL   R8,VALWRITE        VALIDATE AREA                @D52VDRP 01144000
         DROP  R6                                              @D14BDRP 01145000
         B     VALPADR1                                        @D14BDRP 01146000
         B     VALPADR1                                        @D14BDRP 01147000
VALPADR0 DS    0H                                              @D52VDRP 01148000
         L     R8,APMGMDAT        RESTORE DATA BASE            @D14BDRP 01149000
.* A PROBLEM MIGHT OCCUR, IF PFIX IS DONE IN A VTAM APPENDAGE. @D64XDMZ 01150000
.* REASON: AREA, THAT IS VALIDATED IS WITHIN VTAM PARTITION AND         01151000
.* HAS 'VTAM KEY'. THE PCB IS THE PCB OF THE APPENDAGE                  01152000
.* REQUESTOR, E.B. CICS, SO THE KEYS DO NOT MATCH                       01153000
* IN CASE KEY 0 IS REFLECTED IN THE PKM, THE VALIDATION WITH PCEKEY     01154000
* CAN BE REMOVED. CURRENTLY IT IS NEEDED TO VALIDATE A KEY ZERO AREA    01155000
*        GENSERV GETPCB,PIK=(RF),PCB=(R6) GET PCB ADDR IN R6   @D52VDRP 01156000
         GENSERV GETPCB,PIK=(RF),PCB=(R6) GET PCB ADDR IN R6   @D52VDRP 01157000
         USING PCBADR,R6                                       @D52VDRP 01158000
         CLM   R5,1,PCEKEY        HAS AREA CORRECT KEY         @D14BDRP 01159000
         BE    GETPRETX           YES, --------> RETURN OFFS 8 @D64XDMZ 01160000
         LR    R1,R5             GET KEY OF FRAME              @D64XDMZ 01161000
         SRL   R1,4              MOVE TO LAST HALFBYTE         @D64XDMZ 01162000
         L     R2,BIT0OMSK       CALCULATE PKM THAT ..         @D64XDMZ 01163000
         SRL   R2,0(R1)          .. CORRESPONDS TO KEY         @D64XDMZ 01164000
         L     R6,TIBPTR          LOAD TIB POINTER             @D31BDUL 01165000
         USING TIBADR,R6          ASSUMES TIBPOINTER IN R6     @D31BDUL 01166000
         LH    R6,TIBRTID         LOAD TIB POINTER             @D31BDUL 01167000
         SLL   R6,2                 OF                         @D66ODOW 01168005
         AL    R6,ATIBATAB          SERVICED                   @D66ODOW 01168105
         L     R6,0(,R6)            TASK                       @D66ODOW 01169005
         L     R1,TIBTCB                                       @D64XDMZ 01170000
         USING TCBADR,R1                                       @D64XDMZ 01171000
         L     R1,TCBATCBE       GET TCB EXTENSION             @D64XDMZ 01172000
         USING TCBXADR,R1                                      @D64XDMZ 01173000
         LH    R1,TCBX1CR3       GET PKM OF TASK               @D64XDMZ 01174000
         DROP  R1                RELEASE TCB EXT.              @D64XDMZ 01175000
         SLL   R1,16             MOVE PKM TO FIRST HALFBYTE    @D64XDMZ 01176000
         NR    R1,R2             IS THERE A MATCHING KEY       @D64XDMZ 01177000
         BNZ   GETPRETX          YES, --------> RETURN OFFS 8  @D64XDMZ 01178000
*-------------------------------------------------------------*@D31BDUL 01179000
*        PFIX SVC IS ILLEGAL FROM AN ICCF INTERACTIVE          @D31BDUL 01180000
*        PARTITION. HOWEVER, FOR XPCC/APPC/VM BUFFER AREAS     @D31BDUL 01181000
*        HAVE TO BE INTERNALLY PFIXED. THE PFIX ROUTINE IS     @D31BDUL 01182000
*        CALLED BY IJBSXPC (BAL R ,PFIX2ND). TO SUPPORT        @D31BDUL 01183000
*        XPCC/APPC/VM FOR ICCF IAPS THE FOLLOWING CODE HAS     @D31BDUL 01184000
*        BEEN ADDED.                                           @D31BDUL 01185000
*        FOR ICCF INTERACTIVE PARTITIONS VALWRITE RETURNS      @D31BDUL 01186000
*        THE INTERACTIVE PARTITION KEY IN R5 (DIFFERENT FROM   @D31BDUL 01187000
*        MAIN PARTITION KEY!). THEREFORE R5 IS COMPARED        @D31BDUL 01188000
*        TO A FIELD IN THE ICCF IAP SAVE AREA WHERE ICCF CP    @D31BDUL 01189000
*        KEEPS THE IAP'S STORAGE KEY.                          @D31ADUL 01190000
*-------------------------------------------------------------*@D31BDUL 01191000
         TM    TIBFLAG2,ICCFPP    INTERACTIVE PARTITION ?      @D31BDUL 01192000
         BZ    VALPAICF           NO, TAKE ERROR EXIT          @D31BDUL 01193000
         L     R6,TIBTCB          GET CURRENT TASK CONTR. BL.  @D31BDUL 01194000
         USING TCBADR,R6          ASSUMES TCBPOINTER IN R6     @D31BDUL 01195000
         L     R6,TCBSAVE         GET TASK'S SAVE AREA ADDR.   @D31BDUL 01196000
         USING SVEARA,R6                                       @D31BDUL 01197000
         CLM   R5,M1,SVPPKEY      HAS AREA CORRECT IAP KEY ?   @D31BDUL 01198000
         BE    GETPRETX           CORRECT KEY, RETURN OFFSET 8 @D31BDUL 01199000
         DROP  R6                                              @D31BDUL 01200000
VALPAICF L     R6,PMRSAV21        RESTORE R6                   @D31BDUL 01201000
         LM    R1,R2,PMRSAVE2     RESTORE REGISTERS            @D64XDMZ 01202000
*-------------------------------------------------------------*@D31BDUL 01203000
         B     GETPRET4           NO, RETURN OFFSET 4          @D14BDRP 01204000
VALPADR1 SLR   R5,R5                                           @D14BDRP 01205000
         BCTR  R5,0               SET INVALID KEY IN R5        @D14BDRP 01206000
         B     VALPADR0           CONTINUE PROCESSING          @D14BDRP 01207000
         SPACE 1                                                        01208000
         EJECT                                                          01209000
*-------------------------------------------------------------*@D149DVB 01210000
*        PFIXWAIT - ROUTINE                                    @D35CDKH 01211000
*              SETS THE TASK HANDLING PFIX IN WAIT STATE       @D35CDKH 01212000
*              IF ENTERED VIA PGIOWAIT DEFIXCNT IS NOT         @D369DRP 01213000
*              MAINTAINED (R5 = ADDR OF SRQPGIO, IN THIS CASE) @D369DRP 01214000
*        CALLED BY:                                            @D529DRP 01215000
*              PFIXPGE           AT PFIXWAIT AMODE(31),DATOFF  @D529DRP 01216000
*              PFIXPGE           AT PGIOWAIT AMODE(31),DATOFF  @D529DRP 01217000
*        CALLS: RWAIT WITH AMODE(31),DATON                     @D529DRP 01218000
*        INPUT :                                               @D35CDKH 01219000
*              R1 - BOUND INFORM. (OPTIONAL), PASSED TO RWAIT  @D369DFG 01220000
*              R5 - WAIT QUEUE POINTER, PASSED TO RWAIT        @D369DFG 01221000
*              RA - RETURN ADDRESS                             @D35CDKH 01222000
*         INTERNAL REGISTER USAGE                              @D35CDKH 01223000
*              R4 - WORK REGISTER                              @D369DRP 01224000
*              RC - NEEDED TO CALL RWAIT                       @D35CDKH 01225000
*                                                              @D35CDKH 01226000
*-------------------------------------------------------------*@D149DVB 01227000
         SPACE 1                                               @D14ZDVB 01228000
PFIXWAIT DS    0H                                              @D14ZDVB 01229000
         AGO   .PFCCW50                                        @D64YDOW 01230000
*        GENSERV INC,FIELD=DEFIXCNT,REG=(R4)                   @D52VDVB 01231000
         GENSERV INC,FIELD=DEFIXCNT,REG=(R4)                   @D52VDVB 01232000
.PFCCW50 ANOP                                                  @D64YDOW 01233000
PGIOWAIT DS    0H                                              @D52VDRP 01234000
*        AMODESW SET,DAT=ON       ENTER VIRTUAL MODE (DAT=ON)  @D52VDRP 01235000
         AMODESW SET,DAT=ON                                    @D52VDRP 01236000
         BAL   RC,RWAIT           CALL RWAIT                   @D35CDKH 01237000
*SGLINK  RWAIT,INPUT=(R1,R5,RC)                                @D369DRP 01238000
* RWAIT RETURNS WITH DAT ON                                    @D52VDRP 01239000
*        AMODESW SET,DAT=OFF      ENTER REAL MODE AGAIN        @D52VDRP 01240000
         AMODESW SET,DAT=OFF      ENTER REAL MODE AGAIN        @D52VDRP 01241000
         L     R4,ASRQTAB                                      @D61RDRP 01242000
         LA    R4,SRQPFG-SRQTAB(,R4)  TASK WAITING FOR ...     @D61RDRP 01243000
         CR    R4,R5              .... ENOUGH PAGE FRAMES      @D52VDRP 01244000
         BE    PFIXWAI1           YES, DON'T SET PFTE ADDRESS  @D52VDRP 01245000
*        GENSERV LRADBG,RREG=(RC),VADD=(R2),ERR=NADDR          @D52VDRP 01246000
*                             GET REAL ADDRESS OF PAGE         @D52VDRP 01247000
         GENSERV LRADBG,RREG=(RC),VADD=(R2),ERR=NADDR          @D52VDRP 01248000
         SRL   RC,PFSHIFT         POINT TO CORRESPONDING       @D35CDKH 01249000
         A     RC,APFT            PFT-ENTRY                    @D35CDKH 01250000
         AGO   .PFCCW60                                        @D64YDOW 01251000
         L     R4,ASRQTAB                                      @D61RDRP 01252000
         LA    R4,SRQPGIO-SRQTAB(,R4)                          @D61RDRP 01253000
         CR    R4,R5              WAS TASK WAITING FOR PAGE I/O@D36IDRP 01254000
         BER   RA                 YES, ==========>             @D149DRP 01255000
.PFCCW60 ANOP                                                  @D64YDOW 01256000
PFIXWAI1 DS    0H                                              @D52VDRP 01257000
         AGO   .PFCCW70                                        @D64YDOW 01258000
*        GENSERV DEC,FIELD=DEFIXCNT,REG=(R4)                   @D52VDVB 01259000
         GENSERV DEC,FIELD=DEFIXCNT,REG=(R4)                   @D52VDVB 01260000
.PFCCW70 ANOP                                                  @D64YDOW 01261000
         BR    RA                 ==========>                  @D14ZDVB 01262000
         SPACE 4                                                        01263000
*-------------------------------------------------------------*@D369DFG 01264000
*        POSTPFQ - ROUTINE                                     @D369DFG 01265000
*              POSTS TASKS WAITING FOR PAGE FRAMES             @D369DFG 01266000
*        CALLED BY:                                            @D529DRP 01267000
*              PFIXPGQ, PFREE, TFREE WITH AMODE(31),DATOFF     @D529DRP 01268000
*        CALLS: RPOST WITH AMODE(31),DATON                     @D529DRP 01269000
*        LINKREG. RA                                           @D369DFG 01270000
*        WORKREG. R5                                           @D369DFG 01271000
*                 R6,RE,RF SAVED/RESTORE                       @D369DRP 01272000
*--------------------------------------------------------------@D369DFG 01273000
         SPACE 1                                               @D14ADVB 01274000
POSTPFQ  L     R5,ASRQTAB         SRQ TABLE ADDRESS            @D61RDRP 01275000
         TM    RBPFG-SRQTAB(R5),FREEBIT  ARE ANY TASKS WAITING @D66ODOW 01276005
         BNO   POSTPFQG           YES, BRANCH                  @D66ODOW 01277005
         TM    RBPFR-SRQTAB(R5),FREEBIT  ARE ANY TASKS WAITING @D66ODOW 01278005
         BOR   RA                 ==========>  NO, RETURN      @D66ODOW 01279005
POSTPFQG EQU   *                                               @D36IDRP 01280000
         ST    RE,PMRSAVE2        SAVE .....                   @D14BDVB 01281000
         ST    RF,PMRSAVE2+4      .....                        @D14BDVB 01282000
         ST    R6,PMRSAV21        ..... REGISTERS              @D14BDRP 01283000
         L     R6,DISPAD          MAKE DISPATCHER ADDRESSABLE  @D36IDFG 01284000
         USING DISP,R6                                         @D36IDFG 01285000
*        AMODESW SET,DAT=ON       ENTER VIRTUAL MODE (DAT=ON)  @D52VDRP 01286000
         AMODESW SET,DAT=ON                                    @D52VDRP 01287000
         L     R5,ASRQTAB                                      @D61RDRP 01288000
         LA    R5,SRQPFG-SRQTAB(,R5) PT TO PFG WAIT QUEUE      @D61RDRP 01289000
         BAL   RF,RPOST           POST ALL WAITING TASKS       @D36IDFG 01290000
*SGLINK  RPOST,INPUT=(R5,R6,RF),WORK=(R5,RE)                   @D369DRP 01291000
         L     R5,ASRQTAB                                      @D61RDRP 01292000
         LA    R5,SRQPFR-SRQTAB(,R5) PT TO PFR WAIT QUEUE      @D61RDRP 01293000
         BAL   RF,RPOST           POST ALL WAITING TASKS       @D36IDFG 01294000
*SGLINK  RPOST,INPUT=(R5,R6,RF),WORK=(R5,RE)                   @D369DRP 01295000
*        AMODESW SET,DAT=OFF      ENTER REAL MODE (DAT=OFF)    @D52VDRP 01296000
         AMODESW SET,DAT=OFF                                   @D52VDRP 01297000
         DROP  R6                                              @D36IDFG 01298000
         L     RE,PMRSAVE2        RESTORE ....                 @D14BDVB 01299000
         L     RF,PMRSAVE2+4      .....                        @D14BDVB 01300000
         L     R6,PMRSAV21                                     @D14BDRP 01301000
         BR    RA                 ==========>   RETURN         @D36IDFG 01302000
         DROP  R8,R9              FORGET BASE FOR DATA, CODE   @D36ZDRP 01303000
         TITLE 'DOS SUPERVISOR        SGPFIX     PAGE MANAGEMENT (PFREE*01304000
               -ROUTINE)'                                      @D14ZDRP 01305000
*-------------------------------------------------------------*@D149DVB 01306000
*        ROUTINE PROLOGUE                                      @D149DVB 01307000
*        ROUTINE NAME:  PFREE                                  @D149DVB 01308000
*                       NON INTERRUPTIBLE / DISABLED           @D149DVB 01309000
*        MACRO:         SGPFIX                                 @D149DVB 01310000
*        FUNCTION: PFREES THE PAGES SPECIFIED BY THE AREAS     @D149DVB 01311000
*                  SPECIFIED BY THE PARAMETER LIST.            @D149DVB 01312000
*        CALLED BY: SVC 68, PFIX,                              @D149DVB 01313000
*                   BTAM APPENDAGE, STORAGE MANAGEMENT         @D149DVB 01314000
*        CALLED ROUTINES:                                      @D149DVB 01315000
*                   PMRINSBT, POSTPFQ, FREEFRAM WITH           @D149DVB 01316000
*                                             AMODE(31),DATOFF @D529DRP 01317000
*                   GETPADR/GETNPADR IN AMODE(REQUESTOR),DATOFF@D529DRP 01318000
*        ENTRY POINTS:                                         @D149DVB 01319000
*                   PFREE    - SVC 68 AMODE(24),DATON          @D149DVB 01320000
*                   PFREEPFX - PFIX   AMODE(31),DATOFF         @D149DVB 01321000
*                   PFREE2ND - BTAM-APPENDAGE, IJBSXPL         @D149DVB 01322000
*                                     AMODE(24),DATON          @D529DRP 01323000
*                            - PGSER AMODE(24), DATON          @D149DVB 01324000
*                   PFREESVA - SVAFX2ND AMODE(24),DATON        @D149DVB 01325000
*       INPUT:                                                 @D149DVB 01326000
*        IF ENTERED VIA PFREE                                  @D149DVB 01327000
*                   R1 - ADDR (LIST(PARM))                     @D149DVB 01328000
*                   PARM = (ADDR PTR(31),LEN(AREA)-1 BIN FIXED(31))     01329000
*         IN ADDITION IF ENTERED VIA PFREE2ND                  @D529DVB 01330000
*                   RF - FUNCTION CODE                         @D529DVB 01331000
*         IN ADDITION IF ENTERED VIA PFREESVA                  @D149DVB 01332000
*                   R8 - ADDR PAGEMANAGEMENT DATA AREA         @D149DVB 01333000
*                   R9 - ADDR CODE AREA                        @D149DVB 01334000
*                   RD - ADDR ACTUAL PCB                       @D149DVB 01335000
*        IF ENTERED VIA PFREEPFX                               @D149DVB 01336000
*                   R0 - ADDR (LIST(PARM))                     @D149DVB 01337000
*                   R1 - ADDR LAST ENTRY TO BE HANDLED         @D149DVB 01338000
*                   R2 - ADDR FIRST PAGE WITHIN ENTRY THAT HAS @D149DVB 01339000
*                             NO MORE TO BE HANDLED            @D149DVB 01340000
*                   RD - ADDR ACTUAL PCB                       @D149DVB 01341000
*                                                              @D149DVB 01342000
*       OUTPUT:                                                @D149DVB 01343000
*                   PFTE.PFIXC FOR ALL PAGES OUT OF PARM_LIST  @D149DVB 01344000
*                   ARE DECREASED.                             @D149DVB 01345000
*                   RETURN CODE IN REG 15:                     @D529DVB 01346000
*                    0   -   FUNCTION DONE                     @D529DVB 01347000
*       EXIT:       RETURN TO CALLER                           @D149DVB 01348000
*        CONDITION: FUNCTION ACCOMPLISHED                      @D149DVB 01349000
*        OUTPUT: AS DESCRIBED ABOVE                            @D149DVB 01350000
*        RETURN CODE: IF ENTERED BY PFREE, RETURNCODE 0 IS GIVEN IN R15 01351000
*                     IF ENTERED BY PFREEPFX, NONE             @D149DVB 01352000
*       EXIT ERROR: RETURN TO CALLER. (NOT POSSIBLE FOR PFREEPFX)       01353000
*        OUTPUT:    RETURN CODE IN REG 15                      @D529DVB 01354000
*                    0   -   FUNCTION DONE                     @D529DVB 01355000
*                   12   -   NEGATIVE LENGTH OR AREA OR INV ADR@D529DVB 01356000
*                   16   -   PFIXED PAGE ABOVE 16 MB FOUND     @D529DVB 01357000
*                   20   -   INVALID FUNCTION CODE / OPTION    @D529DVB 01358000
*                                                              @D149DVB 01359000
*       EXTERNAL REFERENCES                                    @D149DVB 01360000
*        DATA: PSQ(READ,WRITE)  PAGE SELECTION QUEUE           @D149DVB 01361000
*              PAGE-STATE(READ,WRITE)                          @D149DVB 01362000
*              PFIXC(READ,WRITE)  # TIMES PAGE IS PFIXED       @D149DVB 01363000
*              TFIXC(READ,WRITE)  # TIMES PAGE IS TFIXED       @D149DVB 01364000
*              NPSQE(READ,WRITE) # OF PSQ-ENTRIES + FFCC       @D149DVB 01365000
*              MINPSQE(READ)      MIN. VALUE OF NPSQE          @D149DVB 01366000
*        CONTROL BLOCKS:                                       @D149DVB 01367000
*              PCB(READ,WRITE) PARTITION CONTROL BLOCK         @D149DVB 01368000
*               SMPFIX(READ,WRITE) # OF PAGES PFIXED FOR THE PART.      01369000
*                                                              @D149DVB 01370000
*        OPERATION                                             @D149DVB 01371000
*                                                              @D149DVB 01372000
*        PFREE:                           /* E N T R Y  P T  */@D149DVB 01373000
*        SET SVC_CALL                     /*INDICATE SVC CALL*/@D149DVB 01374000
*        IF TASK IN 'REAL' MODE THEN RETURN(RC=0)              @D149DVB 01375000
*        PFREE2ND:                        /* E N T R Y  P T  */@D149DVB 01376000
*        GET PIK                                               @D149DVB 01377000
*        ADDR_PCB(PIK)                    /* PROVIDE PCB ADDR*/@D149DVB 01378000
*        PFREESVA:                        /* E N T R Y  P T  */@D149DVB 01379000
*        PFIX_REQ := OFF                  /*INDICATE NO PFIX */@D149DVB 01380000
*        PFREEPX1:                                             @D149DVB 01381000
*        DO WHILE ¬EOL(PARM) & RC = 0                          @D149DVB 01382000
*        CALL GETPADR                     /*GET 1ST/NXT ENTRY*/@D149DVB 01383000
*        CASE                                                  @D149DVB 01384000
*           WHEN INVALID THEN RC := 12    /* INVALID ADDR    */@D149DVB 01385000
*           WHEN OK THEN DO                                    @D149DVB 01386000
*            IF PAGE_STAT = ADDRESSABLE   /* CHECK VIA  L R A*/@D149DVB 01387000
*              THEN DO                                         @D149DVB 01388000
*                ADDR_PFTE(PAGE_FRAME)    /* GET ACTUAL PFTE */@D149DVB 01389000
*                IF PFTE.PFIXC > 0                             @D149DVB 01390000
*                  THEN DO                                     @D149DVB 01391000
*                    DECREASE PFTE.PFIXC  /*REDUCE PFIXCVALUE*/@D149DVB 01392000
*                    IF PFTE.PFIXC > )0   /*PAGE STILL PFIXED*/@D149DVB 01393000
*                      THEN DO                                 @D149DVB 01394000
*                        DECREASE PCB.SMPFIX                   @D149DVB 01395000
*                        IF PFTE.TFIXC=0  /* PAGE NOT TFIXED */@D149DVB 01396000
*                           THEN DO                            @D149DVB 01397000
*                             CALL PMRINSBT(PFTE) /* IN P S Q*/@D149DVB 01398000
*                             RESET R_BIT(PAGE_FRAME)          @D149DVB 01399000
*                             IF PFTE.NFRP = ON  /*ANY TASK..*/@D149DVB 01400000
*                                         /*..WAITING ON PFR */@D149DVB 01401000
*                                THEN CALL FREEFRAM            @D149DVB 01402000
*                                ELSE INCREASE NPSQE           @D149DVB 01403000
*            END (...WHEN OK)                                  @D149DVB 01404000
*           WHEN EOL CONTINUE                                  @D149DVB 01405000
*        ENDCASE                                               @D149DVB 01406000
*        END (DO WHILE)                                        @D149DVB 01407000
*        IF NPSQE > MINPSQE             /*LOWER LIMIT REACHED*/@D149DVB 01408000
*           THEN CALL POSTPFQ           /* POST WAITING TASKS*/@D149DVB 01409000
*        IF PCB = SYSPCB                /* PFREE FOR SVA     */@D149DVB 01410000
*           THEN DO                                            @D149DVB 01411000
*             DO WHILE PFTE.PFIXC = 0& ¬EOA(AREA)              @D149DVB 01412000
*           ENDDO                                              @D149DVB 01413000
*        RETURN (ADDR=RETURN ADDRESS,RC)                       @D149DVB 01414000
*                                                              @D149DVB 01415000
*        PFREEPFX:                        /* E N T R Y  P T  */@D149DVB 01416000
*        SAVE PARM PTRS                                        @D149DVB 01417000
*        ADDR_PSQ                         /* ADDR PSQ HEADER */@D149DVB 01418000
*        GOTO PFREPXFX1                                        @D149DVB 01419000
*                                                              @D149DVB 01420000
*        END (PFREE) ;                                         @D149DVB 01421000
*                                                              @D149DVB 01422000
*-------------------------------------------------------------*@D149DVB 01423000
*                                                              @D149DVB 01424000
*      INTERNAL REGISTER USAGE                                 @D149DVB 01425000
*        R1 - ADDR OF CURRENT PARAM-LIST ENTRY                 @D149DVB 01426000
*        R2 - ADDR OF PAGE TO BE HANDLED                       @D149DVB 01427000
*        R4 - WORKREGISTER                                     @D149DVB 01428000
*        R5 - WORKREGISTER                                     @D149DVB 01429000
*        R6 - END ADDR OF AREA GIVEN BY CURRENT LIST ENTRY     @D149DVB 01430000
*        R7 - RETURN ADDR IF CALLED AS SUBROUTINE, ELSE ZERO   @D149DVB 01431000
*        RA - LINK REGISTER TO NEXT LEVEL                      @D149DVB 01432000
*        RB - ADDR OF PSQ-HEADER                               @D149DVB 01433000
*        RC - ADDR OF PFTE CORRESP. TO R2                      @D149DVB 01434000
*        RD - ADDR OF PCB OF REQUESTING AREA                   @D149DVB 01435000
*        RE - NOT USED HAS TO BE UNCHANGED IF CALLED FROM PFIX @D149DVB 01436000
*        RF - REQ. STORAGE KEY OF AREA                         @D149DVB 01437000
*      IN ADDITION IF CALLED VIA PFREEPFX                      @D149DVB 01438000
*        R3 - ADDR OF 1ST PAGE IN LAST ENTRY WHICH HAS NO MORE @D149DVB 01439000
*                 TO BE HANDLED                                @D149DVB 01440000
*        R4 - ADDR OF LAST PARAMETER LIST ENTRY                @D149DVB 01441000
*-------------------------------------------------------------*@D149DVB 01442000
         SPACE 1                                                        01443000
PFREE    DS    0H                                              @D52VDVB 01444000
         LA    RF,PCBPXFRE(,0)    OLD INTERFACE X'00000002'    @D52VDVB 01445000
         SLR   R7,R7              INDICATE CALLED VIA SVC      @D52VDVB 01446000
PFREE2ND L     R8,APMGMDAT        GET BASE ADDR OF DATA AREA            01447000
         USING PMGMDATA,R8        SET BASE FOR DATA AREA                01448000
         L     R9,APMFIXAD        GET BASE FOR CODE AREA                01449000
         USING PMFIXADR,R9        SET BASE FOR CODE AREA                01450000
         L     RA,PIBPTR2         GET ADDR OF PIB2             @D51GDRP 01451000
         USING PIB2ADR,RA         SET BASE FOR PIB2            @D51IDRP 01452000
         L     RD,PIBPCB          GET PCB OF SERVICED PART.    @D51IDRP 01453000
         DROP  RA                 FORGET BASE FOR PIB2         @D51IDRP 01454000
         USING PCBADR,RD          SET BASE FOR PCB             @D52VDRP 01455000
         ST    RF,PMRPGSER        SAVE FUNCTION  AND OPTIONS   @D52VDVB 01456000
         LTR   R7,R7              CALLED AS SUBROUTINE         @D52VDRP 01457000
         BNZ   PFREEM10           YES, SKIP CHECK              @D52VDRP 01458000
         L     RA,PCEPIB          PIB OF SERVICED PARTITION    @D52VDRP 01459000
         USING PIBADR,RA          SET BASE FOR PIB                      01460000
         TM    PIBDATFL,PIBTRAM   TASK IN REAL MODE            @D51IDRP 01461000
         DROP  RA                 FORGET BASE FOR PIB                   01462000
         BZ    PFREER00           YES, RETURN                           01463000
PFREEM10 DS    0H                                              @D52VDRP 01464000
         LH    RF,PIK             GET PIK OF REQUESTING PART.  @D52VDVB 01465000
         SPACE 1                                               @D52VDVB 01466000
PFREESVA DS    0H                                              @D52VDRP 01467000
*        GENSERV LRADBG,RREG=(RD),VADD=(RD),ERR=NADDR          @D52VDRP 01468000
*                             GET REAL ADDRESS OF PCB IN RD    @D52VDRP 01469000
         GENSERV LRADBG,RREG=(RD),VADD=(RD),ERR=NADDR          @D52VDRP 01470000
*        AMODESW SET,DAT=OFF      ENTER REAL MODE (DAT=OFF)    @D52VDRP 01471000
         AMODESW SET,DAT=OFF      ENTER REAL MODE              @D52VDRP 01472000
*        AMODESW SET,AMODE=31,WR=(RB)  ENTER 31 BIT MODE       @D52VDRP 01473000
         AMODESW SET,AMODE=31,WR=(RB)                          @D52VDRP 01474000
         L     RB,PSQPTR          GET ADDR OF PSQ-HEADER                01475000
PFREPFX1 EQU   *                                                        01476000
         L     R0,PMRPGSER        GET FUNCTION AND OPTIONS     @D52VDVB 01477000
*        AMODESW CALL,AMODE=(R0),ADDRESS=GETPADR,REGS=(RA,RA)          *01478000
                                  GET 1ST PAGE TO BE HANDLED   @D52VDVB 01479000
         AMODESW CALL,AMODE=(R0),ADDRESS=GETPADR,REGS=(RA,RA)  @D52VDVB 01480000
         B     PFREEEOL           END OF LIST RETURN           @D52VDVB 01481000
         B     PFREER12           INVALID ADDR RETURN                   01482000
PFREEM30 ST    R0,PMRPGSER        RESTORE FUNCTION AND OPTIONS, A PAGE *01483000
               FAULT MIGHT BE INTERRUPTED PROCESSING           @D52VDVB 01484000
         TM    PMRPXREQ,PCBPXDOF  CALLED BY PFIX               @D52VDVB 01485000
         BZ    PFREEM40           NO, DON'T CHECK FOR END OF LIST       01486000
         CR    R1,R4              END OF LIST                           01487000
         BNE   PFREEM40           NO,  ---------->                      01488000
         CR    R2,R3                                                    01489000
         BE    PFREXIT            YES, RETURN TO PFIX          @D14BDRP 01490000
PFREEM40 LRA   RC,0(R2)           GET PF-ADDRESS               @D52VDVB 01491000
         BNZ   PFREEM80           BRANCH IF PAGE NOT ADDRESSABL@D35CDKH 01492000
         LR    R5,RC                                           @D52VDVB 01493000
         SRL   RC,PFSHIFT         GET OFFSET IN PFT            @D35CDKH 01494000
         A     RC,APFT            PFTE                                  01495000
         USING PFTE,RC                                                  01496000
*      GENSERV TESTDEC,FIELD=PFIXC,REG=(R0),BC=BZ,LAB=PFREEM80 @D52VDVB 01497000
       GENSERV TESTDEC,FIELD=PFIXC,REG=(R0),BC=BZ,LAB=PFREEM80 @D52VDVB 01498000
         LTR   R0,R0              PAGE STILL PFIXED            @D52VDVB 01499000
         BNZ   PFREEM80           YES, ---------->                      01500000
         L     RA,IJBSMCOM                                     @D52VDVB 01501000
         USING SMCOM,RA                                        @D52VDVB 01502000
*    GENSERV COMP,FIELD=SMCRBG3,BC=BNH,LAB=PFREEM50,COMPF=(R5) @D52VDVB 01503000
     GENSERV COMP,FIELD=SMCRBG3,BC=BNH,LAB=PFREEM50,COMPF=(R5) @D52VDVB 01504000
         DROP   RA                                             @D52VDVB 01505000
*        GENSERV DEC,FIELD=SMPFIX,REG=(R0)                     @D52VDVB 01506000
         GENSERV DEC,FIELD=SMPFIX,REG=(R0)                     @D52VDVB 01507000
         B     PFREEM60           ----------->                 @D52VDVB 01508000
PFREEM50 DS    0H                                              @D52VDVB 01509000
*        GENSERV DEC,FIELD=SMPFIX3,REG=(R0)                    @D52VDVB 01510000
         GENSERV DEC,FIELD=SMPFIX3,REG=(R0)                    @D52VDVB 01511000
PFREEM60 DS    0H                                              @D52VDVB 01512000
*        GENSERV TEST,FIELD=TFIXC,BC=BNZ,LAB=PFREEM70,REG=(R0) @D52VDVB 01513000
         GENSERV TEST,FIELD=TFIXC,BC=BNZ,LAB=PFREEM70,REG=(R0) @D52VDVB 01514000
         STM   R4,R5,PMRSAVE2     SAVE REGISTER DESTROYED BY   @D52VDVB 01515000
*                                 PMRINSBT                              01516000
*SGLINK  PMRINSBT,INPUT=(R8,RA,RB,RC),WORK=(R4,R5),AMODE=31 DATOFF      01517000
         BAL   RA,PMRINSBT        INSERT PAGE AT BOTTOM OF PSQ          01518000
         LM    R4,R5,PMRSAVE2     RESTORE R4 AND PF-ADDRESS    @D52VDVB 01519000
         RRBE  0,R5               RESET R_BIT                  @D51GDTP 01520000
         TM    S370FLG,NFRP       ANY TASK WAITING FOR FREE PF @D35CDKH 01521000
         BZ    PFREEM70           NO, BRANCH                   @D35CDKH 01522000
         LH    R5,PCEPIK          GET VIRTUAL PCB ADDR IN ...  @D52VDRP 01523000
         L     R9,APMFIXA2        GET BASE FOR SUBRTN          @D52VDRP 01524000
         USING PMFIXAD2,R9        SET BASE                     @D52VDRP 01525000
* FREEFRAM REQUIRES VIRTUAL PCB ADDR IN R5                     @D52VDRP 01526000
         BAL   RA,FREEFRAM        FREE FRAME                   @D35CDKH 01527000
         L     R9,APMFIXAD        RESET BASE                   @D52VDRP 01528000
         USING PMFIXADR,R9        RESET BASE                   @D52VDRP 01529000
         B     PFREEM80                                        @D35CDKH 01530000
PFREEM70 DS    0H                                              @D14BDFR 01531000
*        GENSERV INC,FIELD=NPSQE,REG=(R5)                      @D52VDVB 01532000
         GENSERV INC,FIELD=NPSQE,REG=(R5)                      @D52VDVB 01533000
PFREEM80 DS    0H                                              @D14BDFR 01534000
         L     R0,PMRPGSER        GET FUNCTION AND OPTIONS     @D52VDVB 01535000
*        AMODESW CALL,AMODE=(R0),ADDRESS=GETNPADR,REGS=(RA,RA)         *01536000
                                  GET 1ST PAGE TO BE HANDLED   @D52VDVB 01537000
         AMODESW CALL,AMODE=(R0),ADDRESS=GETNPADR,REGS=(RA,RA) @D52VDVB 01538000
         B     PFREEEOL           END OF LIST REACHED RC=0              01539000
         B     PFREER12           INVALID ADDR DETECTED RC=12           01540000
         B     PFREEM30           CONTINUE WITH THIS PAGE               01541000
PFREEEOL ST    R0,PMRPGSER        RESTORE FUNCTION AND OPTIONS @D52VDVB 01542000
*              PMRPGSER MIGHT BE CHANGED BY PAGE FAULT HANDL.  @D52VDVB 01543000
         DROP  RC                 FORGET BASE FOR PFTE                  01544000
PFREER00 SR    RF,RF              SET RC=0                              01545000
PFREXIT  CLC   NPSQE,MINPSQE      NPSQE > MINPSQE              @D36IDRP 01546000
         BNH   PFREXIT1           NO, BRANCH                   @D36IDRP 01547000
         BAL   RA,POSTPFQ         POST TASKS WAITING FOR PF'S  @D36IDRP 01548000
PFREXIT1 TM    PMRPXREQ,PCBPXDOF  CALLED WITH DAT OFF          @D52VDRP 01549000
         BO    PFREXIT2           YES, REMAIN IN REAL MODE     @D52VDRP 01550000
*        AMODESW SET,DAT=ON       ENTER VIRTUAL MODE (DAT=ON)  @D52VDRP 01551000
         AMODESW SET,DAT=ON                                    @D52VDRP 01552000
PFREXIT2 LTR   R7,R7              CALLED AS SUBROUTINE         @D36IDRP 01553000
         BNZ   PFREXIT3           YES, ---------->             @D52VDRP 01554000
         L     R6,DISPAD          GET ADDR OF DISPATCHER       @D52VDRP 01555000
         LA    R1,SVER0F-SVEARA   GET DISPLACEM. IN SAVEAREA            01556000
         LA    R7,RETCODE         GET RETURN ADDRESS           @D52VDRP 01557000
PFREXIT3 DS    0H                                              @D52VDRP 01558000
*        AMODESW RETURN,REG=(R7)  RETURN TO CALLER OR RETCODE  @D52VDRP 01559000
         AMODESW RETURN,REG=(R7)                               @D52VDRP 01560000
*                    ============> RETURN TO CALLER OR RETCODE @D52VDRP 01561000
         SPACE 1                                               @D52VDVB 01562000
PFREER16 LA    RF,D16(,0)         SET RC=16 - PFIXED PAGE ABOVE        *01563000
                                              16 MB BOUNDARY   @D52VDVB 01564000
         B     PFREXIT            ---------->                  @D52VDVB 01565000
         SPACE 1                                                        01566000
PFREER12 ST    R0,PMRPGSER        RESTORE FUNCTION AND OPTIONS @D52VDRP 01567000
         LA    RF,D12(,0)         SET RC=12                             01568000
         B     PFREXIT            ---------->                  @D52VDVB 01569000
         DROP  RD                 FORGET BASE FOR PCB (REAL)   @D369DRP 01570000
         SPACE 2                                                        01571000
*---------------------------------------------------------------------* 01572000
*        ENTRY POINT FOR THE PFREE RTN FROM BTAM APPEND.                01573000
*                                                                       01574000
*        INPUT                                                          01575000
*              R3 - RETURN ADDR                                         01576000
*              RE - ADDR OF PAGEMANAGEMENT DATA AREA                    01577000
*              RF - FUNCTION AND OPTION INFO                   @D52VDVB 01578000
*---------------------------------------------------------------------* 01579000
         SPACE 1                                                        01580000
SVPFREE  DS    0H                                                       01581000
         DROP  R8                                                       01582000
         USING PMGMDATA,RE                                              01583000
         STM   R0,RD,PMRSAVE      SAVE REGISTERS PASSED BY BTAM         01584000
         DROP  RE                                                       01585000
         L     R8,APMGMDAT        GET BASE ADDR FOR DATA AREA           01586000
         USING PMGMDATA,R8        SET STANDARD BASE FOR DATA AREA       01587000
         L     R9,APMFIXAD        GET BASE FOR THIS FUNCTION            01588000
         LA    RF,PCBPXFIX(,0)    OLD INTERFACE X'00000001'    @D52VDVB 01589000
         LA    R7,PFREE2ND        GET ENTRY POINT ADDR         @D52VDVB 01590000
*        AMODESW CALL,REGS=(R7,R7) PERFORM PFREE FUNCTION      @D52VDVB 01591000
         AMODESW CALL,REGS=(R7,R7) PERFORM PFREE FUNCTION      @D52VDVB 01592000
         LM    R0,RD,PMRSAVE      RESTORE REGISTERS                     01593000
         BR    R3                 RETURN TO BTAM APPENDAGE              01594000
         SPACE 2                                                        01595000
*---------------------------------------------------------------------* 01596000
*                                                                       01597000
*        ENTRY POINT FOR THE PFREE RTN FROM PFIX                        01598000
*                                                                       01599000
*---------------------------------------------------------------------* 01600000
         SPACE 1                                                        01601000
PFREEPFX LR    R4,R1              SAVE LAST ENTRY ADDR TO BE HANDLED    01602000
         SGCOV SGPFIX,MC=2        PFREE CALLED FROM PFIX       @D52VDRP 01603000
         LR    R3,R2              SAVE 1ST PAGE IN THIS ENTRY WHICH     01604000
*                                 HAS NO MORE TO BE HANDLED             01605000
         L     RB,PSQPTR          GET ADDR OF PSQ-HEADER                01606000
         USING PCBADR,RD          SET BASE FOR PCB (REAL       @D52VDRP 01607000
         MVC   PMRPGSER(L'PMRPGSER),PCBPGSER                   @D52VDVB 01608000
         L     R1,PCBPXLST        GET BEGIN OF PARAMETER LIST  @D52VDVB 01609000
         OI    PMRPXREQ,PCBPXDOF  INDICATE CALLED WITH DAT OFF @D52VDRP 01610000
         DROP  RD                 DROP BASE FOR PCB (REAL)     @D52VDRP 01611000
         B     PFREPFX1           HANDLE THE LIST                       01612000
         DROP  R8,R9              FORGET BASE REGISTERS                 01613000
         TITLE 'DOS SUPERVISOR        SGPFIX     PAGE MANAGEMENT (SVC 7*01614000
               4 PFIX FOR CHECKPOINT/RESTART)'                 @D14ZDRP 01615000
*-------------------------------------------------------------*@D149DVB 01616000
*        ROUTINE PROLOGUE                                      @D149DVB 01617000
*        ROUTINE NAME: PFIXREST ( S V C  7 4 )                 @D149DVB 01618000
*        MACRO:        SGPFIX                                  @D149DVB 01619000
*        FUNCTION: PFIXES THE PAGES SPECFIED BY PARAMETER_LIST @D149DVB 01620000
*                  AND SETS CORRECT PFIXC AND SMPFIX VALUES.   @D149DVB 01621000
*        ENTRY POINTS:                                         @D149DVB 01622000
*              PFIXREST, MODE=(24,DATON)                       @D149DVB 01623000
*        CALLED ROUTINES:                                      @D149DVB 01624000
*              DEFIXALL (SGCCWT), DEFIXCON (SGCCWT),           @D149DVB 01625000
*              PFIXWAIT, PFIXPGE, VIRTAD (SGNUC)               @D149DVB 01626000
*        INPUT:                                                @D149DVB 01627000
*           R0 : INDICATOR                                     @D149DVB 01628000
*           R0 = 0  --- PFIX FUNCTION REQUESTED (RESTART)      @D149DVB 01629000
*              R1 : ADDR (LIST(PARM))                          @D149DVB 01630000
*                   PARM  = ADDR(PFIXED PAGE) BIN FIXED (31),  @D149DVB 01631000
*                           ADDR(PFTE) BIN FIXED (31)  (/370), @D149DVB 01632000
*                           PFIXC VALUE BIN FIXED (15)         @D149DVB 01633000
*                   EOL   =  X'FF'                             @D149DVB 01634000
*           R0 > 0  --- BUILD PFIX_PARMLIST FOR RESTART        @D149DVB 01635000
*                 : LENGTH OF PARM_LIST                        @D149DVB 01636000
*              R1 : ADDR (LIST(PARM)                           @D149DVB 01637000
*                                                              @D149DVB 01638000
*        OUTPUT:                                               @D149DVB 01639000
*           R0 = 0  --- PFIX FUNCTION REQUESTED (RESTART)      @D149DVB 01640000
*              R1 : ADDR (END(LIST(PARM)                       @D149DVB 01641000
*              PFIXED PAGES AS REQUESTED                       @D149DVB 01642000
*           R0 > 0  --- BUILD PFIX_PARMLIST FOR RESTART        @D149DVB 01643000
*              R1 : ADDR (END(LIST(PARM)                       @D149DVB 01644000
*                   PARM  = ADDR(PFIXED PAGE) BIN FIXED (31),  @D149DVB 01645000
*                           ADDR(PFTE) BIN FIXED (31)  (/370), @D149DVB 01646000
*                           PFIXC VALUE BIN FIXED (15)         @D149DVB 01647000
*                   EOL   =  X'FF'                             @D149DVB 01648000
*        RETURN CODE:                                          @D149DVB 01649000
*           R0 = 0  --- PFIX FUNCTION REQUESTED (RESTART)      @D149DVB 01650000
*              NONE                                            @D149DVB 01651000
*           R0 > 0  --- BUILD PFIX_PARMLIST FOR RESTART        @D149DVB 01652000
*              RF = 0   ALL PFIXED PAGES OF PARTITION ARE      @D149DVB 01653000
*                       PROVIDED IN PARM_LIST                  @D149DVB 01654000
*              RF = 4   NEXT PARMETER LIST MUST BE             @D149DVB 01655000
*                       PROVIDED                               @D149DVB 01656000
*        EXIT NORMAL:                                          @D149DVB 01657000
*              RETURN TO CALLER                                @D149DVB 01658000
*        EXIT ERROR:                                           @D149DVB 01659000
*              ERR21  ILLEGAL SVC                              @D149DVB 01660000
*        EXTERNAL REFERENCES:                                  @D149DVB 01661000
*         DATA: NPSQE(READ,WRITE) # OF PSQ-ENTRIES + FFCC      @D149DVB 01662000
*               PFTE.NVRP (READ,WRITE)                         @D149DVB 01663000
*               PFTE.PFIXC(READ,WRITE)                         @D149DVB 01664000
*               PTE.PTESTAT(READ,WRITE)                        @D149DVB 01665000
*               MINPSQE(READ)  MINIMUM VALUE OF NPSQE          @D149DVB 01666000
*                              NOT FETCH                       @D149DVB 01667000
*               PCB.SMRPBEG(READ)   BEG ADDR REAL PARTITION    @D149DVB 01668000
*               PCB.SMRPFIX(READ)   # PFIXED PAGES             @D149DVB 01669000
*               PCB.CHPTPAGE(READ,UPDATE) 1ST PAGE ¬ HANDLED   @D149DVB 01670000
*               PCB.CHPTCNT (READ,UPDATE) # REMAINING PAGES    @D149DVB 01671000
*               PCB.PFTERSVD(READ,UPDATE) PFTE ADDR            @D149DVB 01672000
*                                                              @D149DVB 01673000
*        NOTE: THE REAL BOUNDARIES HAVE BEEN CHECKED AHEAD OF  @D51ZDRP 01674000
*              INVOCATION OF PFIX FOR RESTART                  @D51ZDRP 01675000
*                                                              @D149DVB 01676000
*        OPERATION:                                            @D149DVB 01677000
*                                                              @D149DVB 01678000
*        PFIXREST:                        /* E N T R Y  P T  */@D149DVB 01679000
*        IF SVCOLDPSW.KEY ¬= 0OR  R0 < 0                       @D149DVB 01680000
*           THEN EXIT ( COND = ERR21 )    /*   ILLEGAL SVC   */@D149DVB 01681000
*        ADDR_PCB                         /*PROVIDE PCB ADDR.*/@D149DVB 01682000
*        IF R0 = 0                                             @D149DVB 01683000
*                      /*  R1 POINTS TO FIRST PARM_ENTRY     */@D149DVB 01684000
*           THEN DO                       /* PFIX FUNCTION   */@D149DVB 01685000
*           UNTIL EOL (PARM_LIST)                              @D149DVB 01686000
*             PCB.FIXTYPE := RSTRTBIT     /*  RESTART IND.   */@D149DVB 01687000
*             ADDR_PFTE (PARM_LIST.PFTE)                       @D149DVB 01688000
*        PFRST00:                         /*                 */@D149DVB 01689000
*             IF PFTE.TFIXC > 0           /* FRAME TFIXED    */@D149DVB 01690000
*                THEN DO                                       @D149DVB 01691000
*                IF PF KEPT BY CCWX       /* PFS KEPT BY CCWX*/@D149DVB 01692000
*                   THEN DO                                    @D149DVB 01693000
*                   CALL DEFIXALL         /* FREE FRAMES     */@D149DVB 01694000
*                   GOTO PFRST00                               @D149DVB 01695000
*                   END                                        @D149DVB 01696000
*                   ELSE DO                                    @D149DVB 01697000
*                   PFTE.NFRP := ON       /*NO MORE TFIXABLE */@D149DVB 01698000
*                   CALL PFIXWAIT (SRQPGFX)                    @D149DVB 01699000
*                   END                   /*  PFTE ADDR      */@D149DVB 01700000
*                ELSE DO                                       @D149DVB 01701000
*                IF NPSQE ¬> MINPSQE      /* FRAMES AVAILABLE*/@D149DVB 01702000
*                   THEN DO                                    @D149DVB 01703000
*                   IF PF KEPT BY CCWX    /* PFS KEPT BY CCWX*/@D149DVB 01704000
*                     THEN CALL DEFIXCON  /* FREE FRAMES     */@D149DVB 01705000
*                     ELSE  CALL PFIXWAIT (SRQPGFX)            @D149DVB 01706000
*                   GOTO PFRST00                               @D149DVB 01707000
*                   END                   /*                 */@D149DVB 01708000
*                   ELSE DO                                    @D149DVB 01709000
*                   DECREASE NPSQE        /*REDUCE AVAIBL CNT*/@D149DVB 01710000
*                   PFTE.NFRP = ON                             @D149DVB 01711000
*                   PCB.PFTERSVD := ADDR_PFTE                  @D149DVB 01712000
*                   END                                        @D149DVB 01713000
*             CALL PFIXPGE                /*  PFIX PAGE      */@D149DVB 01714000
*             CASE                                             @D149DVB 01715000
*                 WHEN PFTE.PFIXC = FF THEN CONTINUE           @D149DVB 01716000
*                 WHEN SMPFIX = SMAXPFIX THEN EXIT (COND= ERR21)        01717000
*                 WHEN OK THEN CONTINUE                        @D149DVB 01718000
*             ENDCASE                                          @D149DVB 01719000
*             NEXT (PARM_LIST) /*                              @D149DVB 01720000
*           END (DO UNTIL)                                     @D149DVB 01721000
*           RETURN   (DISPATCHER)         /*  =====> RETURN  */@D149DVB 01722000
*           END                                                @D149DVB 01723000
*           ELSE DO                       /*GEN RESTART LIST */@D149DVB 01724000
*           LPCNT := PCB.CHPTPAGE                              @D149DVB 01725000
*           IF LPCNT = 0                  /* FIRST GEN REQ   */@D149DVB 01726000
*           THEN DO                                            @D149DVB 01727000
*              IF PCB.SMPFIX = 0 THEN EXIT (COND=ERR21)        @D149DVB 01728000
*              LPCNT := SMRPBEG           /* INITIALIZE LPCNT*/@D149DVB 01729000
*           END                                                @D149DVB 01730000
*           RC := 0                       /* RETURN CODE  0  */@D149DVB 01731000
*           DO WHILE ¬EOL (PARM_LIST)                          @D149DVB 01732000
*              IF PFTE.PFIXC > 0          /* PAGE PFIXED   # */@D149DVB 01733000
*              THEN DO                    /* POST WAITNG TASK*/@D149DVB 01734000
*                 IF X'FF' ENTRY IN PARM_LIST                  @D149DVB 01735000
*                    THEN DO                                   @D149DVB 01736000
*                    RC := 4              /* RETURN CODE  4  */@D149DVB 01737000
*                    CHPTPAGE := ADDR_PAGE                     @D149DVB 01738000
*                    LEAVE (DO WHILE)                          @D149DVB 01739000
*                    END                                       @D149DVB 01740000
*                 PARM_LIST_EN(1) := LPCNT                     @D149DVB 01741000
*                 IF ¬ E_MODE                                  @D149DVB 01742000
*                    THEN PARM_LIST_EN(2) := ADDR_PFTE         @D149DVB 01743000
*                 PARM_LIST_EN(3) := PFTE.PFIXC                @D149DVB 01744000
*              NEXT (PARM_LIST)           /* NEXT PARM LIST E*/@D149DVB 01745000
*              END                                             @D149DVB 01746000
*              NEXT_PAGE (LPCNT)          /*ADDRESS NEXT PAGE*/@D149DVB 01747000
*           END (DO WHILE)                                     @D149DVB 01748000
*           RETURN   (DISPATCHER)         /* =====>  RETURN  */@D149DVB 01749000
*        END (PFIXREST);                                       @D149DVB 01750000
*-------------------------------------------------------------*@D149DVB 01751000
         SPACE 1                                               @D14ZDVB 01752000
         USING DISP,R6                                                  01753000
PFIXREST TM    SVOLDKEY,KEY0      PSWKEY OF REQUESTOR ZERO              01754000
         BNZ   ERR21              ==========> ILLEGAL SVC      @D149DVB 01755000
         L     R8,APMGMDAT        GET ADDR OF DATA AREA                 01756000
         USING PMGMDATA,R8        SET BASE FOR DATA AREA                01757000
         L     R9,APMFIXAD        GET BASE FOR THIS ROUTINE             01758000
         USING PMFIXADR,R9        SET BASE FOR THIS ROUTINE             01759000
         L     RD,PCBPTR                                       @D365DRP 01760000
         USING PCBADR,RD          SET BASE FOR PCB             @D365DRP 01761000
         LA    R1,0(,R1)          CLEAR HIGH ORDER BYTE        @KD40188 01762000
*        AMODESW SET,AMODE=31,WR=(R4) ENTER 31 BIT MODE        @D52VDRP 01763000
         AMODESW SET,AMODE=31,WR=(R4)                          @D52VDRP 01764000
         LTR   R0,R0              PFIX DURING RESTART                   01765000
         BM    ERR21              NEG LENGTH ==========>       @D14ZDVB 01766000
         BNZ   PFIXCHPT           PFIX FOR CHECKPOINT -------->@D14ZDVB 01767000
         DROP  R6                 DROP BASE FOR DISP                    01768000
         SPACE 2                                               @D14ZDVB 01769000
*-------------------------------------------------------------*@D52VDVB 01770000
*    RESTART  ---- RESTORE PFIXED PAGES IN ALLOCR AREA         @D52VDVB 01771000
*-------------------------------------------------------------*@D52VDVB 01772000
         SPACE 1                                               @D52VDVB 01773000
         USING RESTLSTE,R1        SET BASE FOR PARAMETER LIST           01774000
         MVC   PCBPGSER(L'PCBPGSER),PMRFXAR2 FUNCTION / OPTION @D52VDVB 01775000
         MVC   FIXTIB,TIBPTR      SAVE TIB OF REQUESTOR        @KD40188 01776000
         OI    FIXTYPE,RSTRTBIT   INDICATE RESTART REQUEST     @KD40188 01777000
PFXR0000 DS    0H                                              @D52VDVB 01778000
*      GENSERV TEST,FIELD=RESTPAGE,BC=BM,LAB=PFXREXIT,REG=(R2) @D52VDVB 01779000
       GENSERV TEST,FIELD=RESTPAGE,BC=BM,LAB=PFXREXIT,REG=(R2) @D52VDVB 01780000
PFXR0100 L     RC,RESTPF          GET PF ADDR                  @D35CDKH 01781000
         CL    RC,SMRPBEG         FRAME INSIDE ALLOCR AREA     @KD40188 01782000
         BL    PFXRER2A           NO,  ---------->   ERROR     @KD40188 01783000
         CL    RC,SMRPEND         FRAME INSIDE ALLOCR AREA     @KD40188 01784000
         BNL   PFXRER2A           NO,  ---------->   ERROR     @KD40188 01785000
         SRL   RC,PFSHIFT                                      @D35CDKH 01786000
         A     RC,APFT                                         @D35CDKH 01787000
         DROP  RD                 DROP PCBADR (VIRTUAL)        @KD40188 01788000
*        AMODESW SET,DAT=OFF      ENTER REAL MODE              @KD40188 01789000
         AMODESW SET,DAT=OFF      ENTER REAL MODE              @KD40188 01790000
         USING PFTE,RC            SET BASE FOR PFTE            @D35CDKH 01791000
PFXR0200 DS    0H                                              @D35CDKH 01792000
*        GENSERV TEST,FIELD=TFIXC,BC=BNZ,LAB=PFXRWT1,REG=(R4)  @D52VDVB 01793000
         GENSERV TEST,FIELD=TFIXC,BC=BNZ,LAB=PFXRWT1,REG=(R4)  @D52VDVB 01794000
         SPACE 1                                               @D52VDCB 01795000
PFXR0300 CLC   NPSQE,MINPSQE      FRAME AVAILABLE FOR FIXING   @D52VDCB 01796000
         BNH   PFXRWT2            NO ---------->               @D52VDCB 01797000
         SPACE 1                                               @D35CDKH 01798000
*               DECREASE NUMBER OF PSQ ENTRIES                 @D35CDKH 01799000
*        GENSERV DEC,FIELD=NPSQE,REG=(R5)                      @D52VDVB 01800000
         GENSERV DEC,FIELD=NPSQE,REG=(R5)                      @D52VDVB 01801000
*        GENSERV LRADBG,RREG=(RD),VADD=(RD),ERR=NADDR          @KD40188 01802000
*                             GET REAL ADDRESS OF PCB IN RD    @KD40188 01803000
         GENSERV LRADBG,RREG=(RD),VADD=(RD),ERR=NADDR          @KD40188 01804000
         USING PCBADR,RD          SET BASE FOR PCB (REAL)      @KD40188 01805000
         OI    S370FLG,NFRP       TURN ON NOT FIXABLE BIT      @D35CDKH 01806000
         ST    RC,PFTERSVD        SAVE PFTE-ADDR IN PCB        @D369DRP 01807000
PFXR0500 BAL   R7,PFIXPGE         PFIX PAGE                    @D35CDKH 01808000
         B     PFXRER21           MAX VALUE OF PFIXC NOT POSS. @KD40188 01809000
         B     PFXRER21           ILLEGAL SVC, IF SMPFIX = SMAXPFIX     01810000
         B     PFXRER21           PFIX ABOVE 16 MB             @D52VDVB 01811000
         B     PFXRER21           INVALID FUNCTION CODE/OPTION @D52VDVB 01812000
         B     PFXRER21           RETURN INSTEAD OF WAIT FOR TFREE     *01813000
                                      NOT POSSIBLE             @D51GDRP 01814000
         DROP  RD                 DROP PCBADR (REAL)           @KD40188 01815000
*        AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @KD40188 01816000
         AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @KD40188 01817000
         LH    R5,RESTCNT         GET VALUE OF PFIXC AT CHECKP. TIME    01818000
*        AMODESW SET,DAT=OFF      ENTER REAL MODE              @KD40188 01819000
         AMODESW SET,DAT=OFF      ENTER REAL MODE              @KD40188 01820000
*      GENSERV PUTF,FIELD=PFIXC,REG=(R5) PROVIDE PFIXC         @D52VDVB 01821000
       GENSERV PUTF,FIELD=PFIXC,REG=(R5)                       @D52VDVB 01822000
*        AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @KD40188 01823000
         AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @KD40188 01824000
         LA    R1,L'RESTENT(,R1)  GET NEXT LIST ENTRY          @D14ZDVB 01825000
         L     RD,PCBPTR          RESTORE PCB ADDR (VIRTUAL)   @KD40188 01826000
         B     PFXR0000           HANDLE IT                             01827000
         SPACE 1                                               @D35CDKH 01828000
PFXRWT1  DS    0H                                              @D52VDVB 01829000
         AGO   .PFCCW80                                        @D64YDOW 01830000
*      GENSERV TEST,FIELD=LOWFXPTR,BC=BZ,LAB=PFXRWT1A,REG=(R4) @D52VDVB 01831000
       GENSERV TEST,FIELD=LOWFXPTR,BC=BZ,LAB=PFXRWT1A,REG=(R4) @D52VDVB 01832000
         L     R9,ACCWT           GET BASE ADDR OF CCW-FX-FUNCT@D35CDKH 01833000
         DROP  R9                                              @D35CDKH 01834000
         USING CCWTADR,R9         SET BASE                     @D35CDKH 01835000
*        AMODESW SET,DAT=ON       ENTER VIRTUAL MODE (DAT=ON)  @D52VDRP 01836000
         AMODESW SET,DAT=ON                                    @D52VDRP 01837000
*        AMODESW CALL,AMODE=24,ADDRESS=DEFIXALL,REGS=(RA,RA)   @D52VDRP 01838000
         AMODESW CALL,AMODE=24,ADDRESS=DEFIXALL,REGS=(RA,RA)   @D52VDRP 01839000
*                           FREE ALL PAGES KEPT BY FST-CCW-FIX @D32VDVB 01840000
*SGLINK  DEFIXALL,INPUT=(R9,RA)                                @D369DRP 01841000
*        AMODESW SET,DAT=OFF      ENTER REAL MODE (DAT=OFF)    @D52VDRP 01842000
         AMODESW SET,DAT=OFF                                   @D52VDRP 01843000
         L     R9,APMFIXAD        GET BACK BASE FOR CODE AREA  @D35CDKH 01844000
         DROP  R9                                              @D35CDKH 01845000
         USING PMFIXADR,R9        RESET BASE FOR CODE AREA     @D35CDKH 01846000
         B     PFXR0200           TRY IT ONCE MORE             @D35CDKH 01847000
         SPACE 1                                               @D14ZDVB 01848000
PFXRWT1A DS    0H                                              @KD40188 01849000
.PFCCW80 ANOP                                                  @D64YDOW 01850000
         OI    S370FLG,NFRP                                    @D14ZDVB 01851000
         L     R5,ASRQTAB         GET SRQ TABLE ADDRESS        @D61RDRP 01852000
         LA    R5,SRQPGFX-SRQTAB(,R5) ADDR OF RESOURCE DESCR.  @D61RDRP 01853000
         BAL   RA,RESTWAIT        SET TASK TO WAIT             @D35CDKH 01854000
         B     PFXR0500           TRY PFIX AGAIN FOR SAME PAGE @D35CDKH 01855000
         SPACE 1                                               @D35CDKH 01856000
PFXRWT2  DS    0H                                              @D52VDVB 01857000
         AGO   .PFCCW90                                        @D64YDOW 01858000
*      GENSERV TEST,FIELD=LOWFXPTR,BC=BZ,LAB=PFXRWT2A,REG=(R4) @D52VDVB 01859000
       GENSERV TEST,FIELD=LOWFXPTR,BC=BZ,LAB=PFXRWT2A,REG=(R4) @D52VDVB 01860000
         L     R9,ACCWT           GET BASE ADDR OF CCW-FX-FUNCT@D35CDKH 01861000
         DROP  R9                                              @D35CDKH 01862000
         USING CCWTADR,R9         SET BASE                     @D35CDKH 01863000
*        AMODESW SET,DAT=ON       ENTER VIRTUAL MODE (DAT=ON)  @D52VDRP 01864000
         AMODESW SET,DAT=ON                                    @D52VDRP 01865000
*        AMODESW CALL,AMODE=24,ADDRESS=DEFIXCON,REGS=(RA,RA)   @D52VDRP 01866000
         AMODESW CALL,AMODE=24,ADDRESS=DEFIXCON,REGS=(RA,RA)   @D52VDRP 01867000
*                          FREE ALL PAGES KEPT BY FST-CCW-FIX  @D52BDVB 01868000
*SGLINK  DEFIXCON,INPUT=(R9,RA)                                @D369DRP 01869000
*        AMODESW SET,DAT=OFF      ENTER REAL MODE              @D52VDRP 01870000
         AMODESW SET,DAT=OFF      ENTER REAL MODE              @D52VDRP 01871000
         L     R9,APMFIXAD        GET BACK BASE FOR CODE AREA  @D35CDKH 01872000
         DROP  R9                                              @D35CDKH 01873000
         USING PMFIXADR,R9        RESET BASE FOR CODE AREA     @D35CDKH 01874000
         B     PFXR0300           TRY IT ONCE MORE             @D35CDKH 01875000
PFXRWT2A DS    0H                                              @D52VDVB 01876000
.PFCCW90 ANOP                                                  @D64YDOW 01877000
         L     R5,ASRQTAB         GET SRQ TABLE ADDRESS        @D61RDRP 01878000
         LA    R5,SRQPFG-SRQTAB(,R5) PT TO PFG WAIT QUEUE      @D61RDRP 01879000
         BAL   RA,RESTWAIT        SET TASK TO WAIT             @D35CDKH 01880000
*        AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @KD40188 01881000
         AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @KD40188 01882000
         B     PFXR0100                                        @D35CDKH 01883000
         DROP  RC                 DROP BASE FOR PFTE           @KD40188 01884000
         SPACE 1                                               @D14ZDVB 01885000
PFXRER21 DS    0H                                                       01886000
*        AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @KD40188 01887000
         AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @KD40188 01888000
         L     RC,RESTPF          GET PF ADDR                  @D35CDKH 01889000
         SRL   RC,PFSHIFT                                      @D35CDKH 01890000
         A     RC,APFT                                         @D35CDKH 01891000
*        AMODESW SET,DAT=OFF      ENTER REAL MODE              @KD40188 01892000
         AMODESW SET,DAT=OFF      ENTER REAL MODE              @KD40188 01893000
         USING PFTE,RC                                         @KD40188 01894000
         NI    S370FLG,XFF-NFRP   RESET NOT-FIXABLE-BIT        @D52VDVB 01895000
         DROP  RC                 DROP BASE FOR PFTE           @KD40188 01896000
*        AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @KD40188 01897000
         AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @KD40188 01898000
         L     RD,PCBPTR          GET PCB ADDR (VIRTUAL)       @KD40188 01899000
         USING PCBADR,RD                                       @KD40188 01900000
PFXRER2A MVI   FIXTYPE,ZERO                                    @D35CDKH 01901000
CHPTR21A L     R6,DISPAD          GET ADDR OF DISPATCHER       @D14ZDVB 01902000
         USING DISP,R6                                                  01903000
*        AMODESW BRANCH,AMODE=24,ADDRESS=ERR21,REG=(R1)        @D52VDRP 01904000
         AMODESW BRANCH,AMODE=24,ADDRESS=ERR21,REG=(R1)        @D52VDRP 01905000
*                                 ==========>  ILLEGAL SVC     @D149DVB 01906000
         DROP  R6                 DROP BASE FOR DISP                    01907000
         SPACE 1                                               @D35CDKH 01908000
PFXREXIT MVI   FIXTYPE,ZERO       RESET FIX INDICATION         @D51GDRP 01909000
         L     R6,DISPAD          GET ADDR OF DISPATCHER       @D14ZDVB 01910000
*        AMODESW RETURN,REG=(R6)  ========> RETURN DISPATCHER  @D52VDRP 01911000
         AMODESW RETURN,REG=(R6)  ========> RETURN DISPATCHER  @D52VDRP 01912000
         DROP  R1                 DROP BASE FOR RESTLSTE                01913000
         DROP  RD                 DROP PCBADR (VIRTUAL)        @KD40188 01914000
         SPACE 2                                                        01915000
*-------------------------------------------------------------*         01916000
*        RESTWAIT - ROUTINE                                   *         01917000
*              SETS THE TASK HANDLING RESTART IN WAIT STATE   *         01918000
*        CALLED BY:                                           *         01919000
*              PFIXREST          AT RESTWAIT AMODE(31),DATOFF *         01920000
*        CALLS: RWAIT WITH AMODE(31),DATON                    *         01921000
*        INPUT :                                              *         01922000
*              R5 - WAIT QUEUE POINTER, PASSED TO RWAIT       *         01923000
*              RA - RETURN ADDRESS                            *         01924000
*         INTERNAL REGISTER USAGE                             *         01925000
*              RC - NEEDED TO CALL RWAIT                      *         01926000
*                                                             *         01927000
*-------------------------------------------------------------*         01928000
         SPACE 1                                               @KD40188 01929000
RESTWAIT DS    0H                                              @KD40188 01930000
         AGO   .PFCCWA0                                        @D64YDOW 01931000
*        GENSERV INC,FIELD=DEFIXCNT,REG=(R4)                   @KD40188 01932000
         GENSERV INC,FIELD=DEFIXCNT,REG=(R4)                   @KD40188 01933000
.PFCCWA0 ANOP                                                  @D64YDOW 01934000
*        AMODESW SET,DAT=ON       ENTER VIRTUAL MODE (DAT=ON)  @KD40188 01935000
         AMODESW SET,DAT=ON                                    @KD40188 01936000
         BAL   RC,RWAIT           CALL RWAIT                   @KD40188 01937000
*SGLINK  RWAIT,INPUT=(R5,RC)                                   @KD40188 01938000
* RWAIT RETURNS WITH DAT ON                                    @KD40188 01939000
*        AMODESW SET,DAT=OFF      ENTER REAL MODE AGAIN        @KD40188 01940000
         AMODESW SET,DAT=OFF      ENTER REAL MODE AGAIN        @KD40188 01941000
         AGO   .PFCCWB0                                        @D64YDOW 01942000
*        GENSERV DEC,FIELD=DEFIXCNT,REG=(R4)                   @KD40188 01943000
         GENSERV DEC,FIELD=DEFIXCNT,REG=(R4)                   @KD40188 01944000
.PFCCWB0 ANOP                                                  @D64YDOW 01945000
         BR    RA                 ==========>                  @KD40188 01946000
         SPACE 2                                                        01947000
*-------------------------------------------------------------*@D52VDVB 01948000
*    CHECKPOINT  ------  PREPARE RESTART LIST                  @D52VDVB 01949000
*-------------------------------------------------------------*@D52VDVB 01950000
         SPACE 1                                               @D14ZDVB 01951000
PFIXCHPT DS    0H                 EP FOR PFIX CHECKPOINT       @D52VDVB 01952000
         USING PCBADR,RD                                       @KD40188 01953000
*    CHECK WHETHER PAGES PFIXED IN AREA 3, ERROR IF YES        @KD40188 01954000
*      GENSERV TEST,FIELD=SMPFIX3,BC=BNZ,LAB=CHPTR21A,REG=(R2) @D52VDVB 01955000
       GENSERV TEST,FIELD=SMPFIX3,BC=BNZ,LAB=CHPTR21A,REG=(R2) @D52VDVB 01956000
*    CHECK WHETHER PAGES PFIXED IN AREA 2, ERROR IF NOT        @KD40188 01957000
*      GENSERV TEST,FIELD=SMRPBEG,BC=BZ,LAB=CHPTR21A,REG=(RC)  @D52VDVB 01958000
       GENSERV TEST,FIELD=SMRPBEG,BC=BZ,LAB=CHPTR21A,REG=(RC)  @D52VDVB 01959000
         LH    RB,CHPTCNT         GET # OF PFIXED PAGES NOT ...        *01960000
                                  ... YET HANDLED              @D14ZDVB 01961000
*    1ST CALL FOR THIS CHECKPOINT, BRANCH IF NOT               @KD40188 01962000
*     GENSERV TEST,FIELD=CHPTPAGE,BC=BNZ,LAB=PFIXCHLP,REG=(R2) @D52VDVB 01963000
      GENSERV TEST,FIELD=CHPTPAGE,BC=BNZ,LAB=PFIXCHLP,REG=(R2) @D52VDVB 01964000
         LR    R2,RC              GET BEG OF REAL PART         @D52VDVB 01965000
*    ANY PAGES PFIXED AT ALL, ERROR IF NOT                     @KD40188 01966000
*        GENSERV TEST,FIELD=SMPFIX,BC=BZ,LAB=CHPTR21A,REG=(RB) @D52VDVB 01967000
         GENSERV TEST,FIELD=SMPFIX,BC=BZ,LAB=CHPTR21A,REG=(RB) @D52VDVB 01968000
         SPACE 1                                                        01969000
*        SEARCH FOR A PFIXED PAGE IN THE PARTITION                      01970000
         SPACE 1                                                        01971000
PFIXCHLP LR    RC,R2              GET                          @D35CDKH 01972000
         SRL   RC,PFSHIFT         ADDR. OF                     @D35CDKH 01973000
         A     RC,APFT            PFTE                                  01974000
*        AMODESW SET,DAT=OFF      ENTER REAL MODE              @D52VDRP 01975000
         AMODESW SET,DAT=OFF      ENTER REAL MODE              @D52VDRP 01976000
         USING PFTE,RC                                                  01977000
*     GENSERV TEST,FIELD=PFIXC,BC=BP,LAB=PFIXCH10,REG=(R6)     @D52VDVB 01978000
      GENSERV TEST,FIELD=PFIXC,BC=BP,LAB=PFIXCH10,REG=(R6)     @KD40188 01979000
PFIXCH02 AL    R2,PAGESIZE        GET NEXT PAGE ADDR           @D14NDVB 01980000
         LA    RC,LPFTE(,RC)      POINT TO NEXT PFTE           @D14ZDVB 01981000
         B     PFIXCHLP           HANDLE IT                             01982000
         DROP  RC                 DROP BASE FOR PFTE (REAL),   @KD40188 01983000
*                                    RC STILL REQUIRED         @KD40188 01984000
         SPACE 1                                                        01985000
*        PFIXED PAGE FOUND                                              01986000
         SPACE 1                                                        01987000
PFIXCH10 DS    0H                                              @KD40188 01988000
*        AMODESW SET,DAT=ON       ENTER VIRTUAL MODE (DAT=ON)  @D52VDRP 01989000
         AMODESW SET,DAT=ON                                    @D52VDRP 01990000
         C     R0,LASTLNG         ENOUGH PLACE IN USER AREA             01991000
         BL    PFIXCH20           NO, BRANCH                            01992000
         USING RESTLSTE,R1                                              01993000
         ST    R2,RESTPF          STORE PF ADDRESS             @D35CDKH 01994000
         STH   R6,RESTCNT         SET PFIXC IN USER AREA       @KD40188 01995000
         LR    R9,R2              REAL ADDRESS FOR VIRTAD      @D14NDFG 01996000
         DROP  R9                                              @D52VDVB 01997000
*        AMODESW CALL,AMODE=24,ADDRESS=VIRTAD,REGS=(R6,R6)     @D52VDVB 01998000
         AMODESW CALL,AMODE=24,ADDRESS=VIRTAD,REGS=(R6,R6)     @D52VDVB 01999000
*SGLINK  VIRTAD,INPUT=(R6,R9),OUTPUT=(RF),WORK=(R9)            @D14NDFG 02000000
         L     R9,APMFIXAD        RESTORE BASE ADDRESS         @D14NDFG 02001000
         USING PMFIXADR,R9                                     @D52VDVB 02002000
         ST    RF,RESTPAGE        STORE VIRTUAL PAGE ADDRESS   @D14NDFG 02003000
         LA    R1,L'RESTENT(,R1)  POINT TO NEXT FREE ENTRY     @D14ZDVB 02004000
         S     R0,RESTLNG         GET REMAINING LENGTH                  02005000
         BCT   RB,PFIXCH02        BRANCH IF MORE PFIXED PAGES           02006000
         SR    RF,RF              INDICATE LAST PFIX-RECORD             02007000
         XC    CHPTENT,CHPTENT    CLEAR ENTRY FOR NEXT TIME             02008000
         B     PFIXCH30           SKIP NOT ENOUGH SPACE CASE            02009000
         SPACE 1                                                        02010000
*        NOT ENOUGH SPACE IN USER-AREA                                  02011000
         SPACE 1                                                        02012000
PFIXCH20 LA    RF,4(,0)           INDICATE NEXT AREA NEEDED             02013000
         ST    R2,CHPTPAGE        SAVE 1ST PAGE NOT HANDLED             02014000
         STH   RB,CHPTCNT         SAVE # OF REMAINING PAGES             02015000
         SPACE 1                                                        02016000
*        END OF PRESENT USER AREA                                       02017000
         SPACE 1                                                        02018000
PFIXCH30 MVI   RESTENT,XFF        INDICATE END OF LIST                  02019000
         L     R6,DISPAD          GET ADDR OF DISPATCHER                02020000
         LA    R1,SVER02-SVEARA   GET DISPLACEM. IN SAVEAREA            02021000
         LA    RE,RETCODE         EXIT ADDRESS                 @D52VDVB 02022000
*        AMODESW RETURN,REG=(RE)  ==========>   24 BIT MODE    @D52VDVB 02023000
         AMODESW RETURN,REG=(RE)                               @D52VDVB 02024000
         DROP  R1,R8,R9,RD                                     @D365DRP 02025000
         TITLE 'DOS SUPERVISOR        SGPFIX     PAGE MANAGEMENT (PFIX/*02026000
               PFREE IN SVA)'                                  @D14ZDRP 02027000
*-------------------------------------------------------------*@D149DVB 02028000
*        ROUTINE PROLOGUE                                      @D149DVB 02029000
*        ROUTINE NAME:  SVAFX2ND                               @D149DVB 02030000
*        MACRO:         SGPFIX                                 @D149DVB 02031000
*        FUNCTION: PFIXES/ PFREE'ES AREA IN THE SYSTEM GETVIS  @D149DVB 02032000
*                  AREA FIXED BY THE PARAMETER LIST.           @D149DVB 02033000
*                  AMODE(31),DATON                             @D529DRP 02034000
*        CALLED BY: SPFIX, SPFREE (SUBROUTINE LINKAGE)         @D149DVB 02035000
*                    (SGAMSUBR, SGBFCH, SGDFCH, SGPPMT)        @D52VDRP 02036000
*        CALLED ROUTINES:                                      @D149DVB 02037000
*                   PFIXSVA  - PFIX AREA                       @D149DVB 02038000
*                   PFREESVA - PFREE AREA                      @D149DVB 02039000
*                   RWAIT                                      @D149DVB 02040000
*        ENTRY POINT:                                          @D149DVB 02041000
*                   SVAFX2ND   CALLED BY GETVIS                @D219DRP 02042000
*       INPUT:                                                 @D149DVB 02043000
*                PSWKEY(REQUESTOR) = 0 & SUPERVISOR STATE      @D149DVB 02044000
*                R1 - ADDR (LIST(PARM))                        @D149DVB 02045000
*                   PARM = (ADDR PTR(31),LEN(AREA)-1 BIN FIXED(31))     02046000
*                RF - FUNCTION CODE / OPTION BYTE              @D52VDVB 02047000
*                       BYTE 0 :  BIT 0   ALWAYS ZERO          @D52VDVB 02048000
*                                 BIT 1-5 RESERVED             @D52VDVB 02049000
*                                 BIT 6   SVA PFIX WITH RETURN @D52VDVB 02050000
*                                 BIT 7   SVA PFIX WITHOUT GATE@D52VDVB 02051000
*                       BYTE 1 :  OPTION BYTE                  @D52VDVB 02052000
*                                 04: PFIX IN 24 BIT AREA      @D52VDVB 02053000
*                                 02: PFIX IN ALLOCR AREA      @D52VDVB 02054000
*                                 01: PFIX IN 31 BIT AREA      @D52VDVB 02055000
*                       BYTE 2 :  RESERVED                     @D52VDVB 02056000
*                       BYTE 3 :  FUNCTION CODE                @D52VDVB 02057000
*                                 01: PFIX                     @D52VDVB 02058000
*                                 02: PFREE                    @D52VDVB 02059000
*                R7 - RETURN ADDRESS                           @D219DRP 02060000
*       OUTPUT:                                                @D149DVB 02061000
*                PFTE.PFIXC FOR ALL PAGES OUT OF PARM_LIST     @D149DVB 02062000
*                ARE DECREASED.                                @D149DVB 02063000
*       EXIT:    RETURN TO DISPATCHER                          @D149DVB 02064000
*        CONDITION: FUNCTION ACCOMPLISHED                      @D149DVB 02065000
*       EXIT ERROR: RETURN TO DISPACHER                        @D149DVB 02066000
*                ERR21 (ILLEGAL SVC)                           @D149DVB 02067000
*        CONDITIONS: INVALID OPERATION ID, PSWKEY ¬= 0,        @D149DVB 02068000
*                    ¬SUPERVISOR STATE                         @D149DVB 02069000
*        OUTPUT: NONE                                          @D149DVB 02070000
*       RETURN CODES: -                                        @D149DVB 02071000
*                                                              @D149DVB 02072000
*       EXTERNAL REFERENCES                                    @D149DVB 02073000
*        DATA: RESOURCE_Q                                      @D149DVB 02074000
*        CONTROL BLOCKS:                                       @D149DVB 02075000
*              PCB(READ,WRITE) PARTITION CONTROL BLOCK         @D149DVB 02076000
*               SMPFIX(READ,WRITE) # OF PAGES PFIXED FOR THE PART.      02077000
*                                                              @D149DVB 02078000
*       OPERATION:                                             @D149DVB 02079000
*                                                              @D149DVB 02080000
*        SVAFIX:                          /* E N T R Y  P T  */@D149DVB 02081000
*        IF SVOLDKEY ¬= 0 OR SVOLDP =¬ SUPSTATE                @D149DVB 02082000
*           OR OPERATION_ID = INVALID THEN EXIT(ERR21)         @D149DVB 02083000
*        INDICATE(SVC_CALL)                                    @D149DVB 02084000
*        SVAFX2ND:                        /* E N T R Y  P T  */@D149DVB 02085000
*        ADDR_SYSPCB                      /* PROVIDE SYSPCB  */@D149DVB 02086000
*        ADDR_PGMDATA                     /* PROVIDE PGM DATA*/@D149DVB 02087000
*        IF GATE NOT HANDLED OUTSIDE THEN                      @D519DRP 02088000
*          DO WHILE RBSPFIX = NOTFREE     /* SYSTEM PFIX FREE*/@D149DVB 02089000
*             CALL RWAIT (SRQSPFIX)       /* NO --> RWAIT    */@D149DVB 02090000
*          ENDDO                                               @D149DVB 02091000
*        RBSPFIX := NOTFREE               /* GATE RESOURCE   */@D149DVB 02092000
*        IF PFIX REQUEST                                       @D149DVB 02093000
*           THEN CALL PFIXSVA             /* PFIX AREA       */@D149DVB 02094000
*           ELSE CALL PFREESVA            /* PFREE AREA      */@D149DVB 02095000
*        ENDIF                                                 @D149DVB 02096000
*        CALL RPOST(SRQSPFIX              /* FREE RESOURCE ..*/@D149DVB 02097000
*                                         /*..POST WAITERS   */@D149DVB 02098000
*        IF SCV_CALL                      /* CALLED BY SVC100*/@D149DVB 02099000
*           THEN RETURN (ADDR=DISPATCHER) /* EXIT DISPATCHER */@D149DVB 02100000
*           ELSE RETURN (ADDR=CALLER)     /* EXIT TO CALLER  */@D149DVB 02101000
*        END (SVAFIX) ;                                        @D149DVB 02102000
*                                                              @D149DVB 02103000
*-------------------------------------------------------------*@D149DVB 02104000
         SPACE 1                                                        02105000
SVAFX2ND L     R8,APMGMDAT        GET ADDR OF DATA AREA        @D21ZDMZ 02106000
         USING PMGMDATA,R8        SET BASE FOR DATA AREA       @D21ZDMZ 02107000
         L     R9,APMFIXAD        GET BASE FOR THIS ROUTINE             02108000
         USING PMFIXADR,R9        SET BASE FOR THIS ROUTINE             02109000
         L     RD,ASYSPCB         GET ADDR OF SYSTEM PCB       @D365DRP 02110000
         USING PCBADR,RD                                       @D51GDRP 02111000
         LR    R0,RF              CHECK FUNCTION/OPTION        @D52VDVB 02112000
         X     R0,PMRPXSVA        ... DETECT INVALID           @D52VDVB 02113000
         NR    R0,RF              ... COMBINATIONS             @D52VDVB 02114000
         BNZ   SVAFIXER           YES  ------------> ILLEGAL   @D52VDVB 02115000
         ST    RF,PMRPGSER        PROVIDE FUNCTION/OPTION      @D52VDVB 02116000
         TM    PMRPXREQ,PCBPXNOG  GATE HANDLING ...                    *02117000
                                  ... ALREADY DONE             @D52VDVB 02118000
         BO    SVAFIX20           YES, SKIP HANDLING --------->@D51GDRP 02119000
         SPACE 1                                                        02120000
*     TEST IF PFIX-GATE FOR SYSTEM IS OPEN. IF NOT             @D149DRP 02121000
*     GO TO  RWAIT                                             @D149DRP 02122000
         SPACE 1                                                        02123000
SVAFIX00 L     R5,ASRQTAB         POINT                        @D61RDRP 02124000
         LA    R5,SRQSPFIX-SRQTAB(,R5)  TO SYSTEM PFIX QUEUE   @D61RDRP 02125000
         TM    RBSPFIX-SRQSPFIX(R5),FREEBIT        GATE OPEN ? @D66ODOW 02126005
         BO    SVAFIX10           YES, BRANCH                  @D66ODOW 02127005
         BAL   RC,RWAIT           SAVE STATUS AND WAIT         @D14BDRP 02128000
*SGLINK  RWAIT,INPUT=(R5,RC)                                   @D149DRP 02129000
         B     SVAFIX00           --------------->             @D14BDRP 02130000
         SPACE 1                                               @D14NDVB 02131000
SVAFIX10 MVC   RBSPFIX-SRQSPFIX(2,R5),TID CLOSE GATE, SET OWNER@D66ODOW 02132005
         SPACE 1                                               @D14NDVB 02136000
SVAFIX20 ST    R7,PFIXSAV1        SAVE RETURN REGISTER         @D14BDRP 02137000
         ST    R2,PFIXSAV2        ... AND ADDRESS OF SAVEAREA  @D52VDVB 02138000
         O     RF,BIT0OMSK        SET 31-BIT ADDRESSES         @D52VDVB 02139000
         ST    RF,PMRPGSER        PROVIDE FUNCTION/OPTION      @D52VDVB 02140000
         TM    PMRPXFCT,PCBPXFIX  PFIX                         @D52VDVB 02141000
         BO    SVAFIX30           YES, ---------->             @D52VDVB 02142000
         SLR   RF,RF              SET PIK TO ZERO              @D52VDVB 02143000
         BAL   R7,PFREESVA-PMFIXADR(,R9)                       @D52VDVB 02144000
         B     SVAFIX40           --------------->             @D52VDVB 02145000
         SPACE 1                                               @D14BDVB 02146000
SVAFIX30 ST    RF,PCBPGSER        PROVIDE FUNCTION/OPTION      @D52VDVB 02147000
         SLR   RF,RF              SET PIK TO ZERO TO ALLOW  PFIX       *02148000
                                  IN SYSTEM GETVIS-AREA        @D14BDRP 02149000
         BAL   RE,PFIXSVA-PMFIXADR(,R9)                        @D52VDVB 02150000
         SPACE 1                                               @D14BDVB 02151000
SVAFIX40 L     R7,PFIXSAV1        RESTORE RETURN ADDR          @D14BDRP 02152000
         L     R2,PFIXSAV2        ... AND ADDRESS OF SAVEAREA  @D52VDVB 02153000
SVAFIX50 TM    PCBPXREQ,PCBPXNOG  GATE HANDLED OUTSIDE         @D52VDRP 02154000
         BZ    SVAFIX60           NO, HANDLE GATE              @D52GDRP 02155000
*        AMODESW RETURN,REG=(R7)  =============> EXIT CALLER   @D52VDVB 02156000
         AMODESW RETURN,REG=(R7)  =============> EXIT CALLER   @D52VDVB 02157000
         SPACE 1                                               @D52VDVB 02158000
SVAFIX60 DS    0H                                              @D51GDRP 02159000
         L     R6,DISPAD          GET ADDR OF DISPATCHER       @D14BDRP 02160000
         USING DISP,R6                                         @D14BDRP 02161000
         L     R5,ASRQTAB         GET SRQ TABLE ADDRESS        @D61RDRP 02162000
         LA    R5,SRQSPFIX-SRQTAB(,R5) PTR TO RSRCE DESCRIPTOR @D61RDRP 02163000
         LR    R4,RF              SAVE RC FROM PFIX/PFREE      @D14BDRP 02164000
         BAL   RF,RPOST           POST ALL WAITERS             @D14BDRP 02165000
*SGLINK  RPOST,INPUT=(R5,R6,RF),WORK=(R5,RE)                   @D14BDRP 02166000
         LR    RF,R4              RESTORE RC FROM PFIX/PFREE   @D14BDRP 02167000
*        AMODESW RETURN,REG=(R7)  =============> EXIT CALLER   @D52VDVB 02168000
         AMODESW RETURN,REG=(R7)  =============> EXIT CALLER   @D52VDVB 02169000
         SPACE 1                                               @D52VDVB 02170000
SVAFIXER DS    0H                                              @D51GDRP 02171000
         LA    RF,D20(,0)         RC 20: INVALID FUNCTION/OPT. @D52VDVB 02172000
         B     SVAFIX50           ---------->                  @D52VDVB 02173000
         DROP  RD                 DROP PCB BASE                @D51GDRP 02174000
         DROP  R8,R9,R6                                                 02175000
         TITLE 'DOS SUPERVISOR        SGPFIX     PAGE MANAGEMENT (FREEP*02176000
               DS ROUTINE)'                                    @D14ZDRP 02177000
*-------------------------------------------------------------*@D149DVB 02178000
*                                                                       02179000
*        ROUTINE PROLOGUE                                               02180000
*        ROUTINE NAME= FREEPDS                                          02181000
*        MACRO=        SGPFIX                                           02182000
*        FUNCTION= GIVES THE COPIES ON PAGE-DATA-SET FREE AND SETS THE  02183000
*                  CHANGE-BIT OFF FOR THE PAGES SPECIFIED BY THE AREA.  02184000
*                  IN ADDITION IF CALLED WITH BIT 0 ON IN R8,  @D52VDRP 02185000
*                  THE PAGES IN STORAGE ARE CLEARED.           @D52VDRP 02186000
*        CALLED BY: FETCH, FREEVIS                             @D149DVB 02187000
*                   INORDER TO AVOID UNNECESSARY PAGE I/O      @D149DVB 02188000
*                                 WITH AMODE(31),DATON         @D529DRP 02189000
*        CALLING SEQUENCE:                                     @D149DVB 02190000
*              L       R8,APMGMDAT                             @D149DVB 02191000
*              L       R7,AFREEPDS                             @D149DVB 02192000
*              SET BIT 0 ON IN R8 IF CLEARING REQUIRED         @D52VDRP 02193000
*              AMODESW CALL,REGS=(R7,R7)                       @D52VDRP 02194000
*        CALLS: SCNPGQO WITH AMODE(31),DATOFF                  @D529DRP 02195000
*                                                                       02196000
*        INPUT:                                                         02197000
*         R0 ADDR IN 1ST PAGE TO BE HANDLED                             02198000
*         R1 ADDR IN LAST PAGE TO BE HANDLED                            02199000
*         R7 RETURN ADDR                                                02200000
*         R8 ADDR OF PAGE-MANAGEMENT DATA AREA                          02201000
*         BIT 0 IN R8 ON  - CLEAR PAGES IN STORAGE             @D52VDRP 02202000
*         BIT 0 IN R8 OFF - DON'T CLEAR PAGES IN STORAGE       @D52VDRP 02203000
*                                                                       02204000
*        OUTPUT:                                                        02205000
*         RF - RETURN CODE (FOR CLEAR REQUEST ONLY)            @KD40295 02206000
*              0  ALL CLEARED                                  @KD40295 02207000
*              4  NOT ALL CLEARED DUE TO ONGOING PAGE I/O      @KD40295 02208000
*         ALL PAGES SPECIFIED HAVE NO VALID COPY ON PDS AND CHANGE-BIT  02209000
*             OFF.                                                      02210000
*         ALL REGISTERS ARE UNCHANGED AFTER RETURN FROM FREEPDS,        02211000
*             EXCEPT RF FOR CLEAR REQUEST                      @KD40295 02212000
*                                                                       02213000
*        EXIT NORMAL= RETURN TO CALLER WITH AMODE(CALLER),DATON         02214000
*         CONDITION= FUNCTION COMPLETED                                 02215000
*         OUTPUT=  AS DESCRIBED ABOVE                                   02216000
*         RETURN CODE= NONE                                             02217000
*        EXIT ERROR= NONE                                               02218000
*         ROUTINES= NONE                                                02219000
*         DATA= PAGE-STATE(WRITE)                                       02220000
*                                                              @D149DVB 02221000
*        NOTE: THE CALLER IS REPONSIBLE FOR THE ADDRESS        @D149DVB 02222000
*         SPACE VALIDATION                                     @D149DVB 02223000
*-------------------------------------------------------------*@D149DVB 02224000
         SPACE 2                                                        02225000
         USING PMGMDATA,R8        SET BASE FOR DATA AREA                02226000
FREEPDS  STM   R4,RF,PMRSAVE      SAVE CALLERS REGISTER        @KD40295 02227000
         L     RA,FREPDSBG        INDICATE BEGIN OF FREEPDS    @KD40295 02228000
         DEBUG ALLREGS,XXDBGMC    * CREATE DEBUG ENTRY         @KD40295 02229000
         L     R9,APMFIXAD        GET BASE FOR THIS ROUTINE             02230000
         USING PMFIXADR,R9        SET BASE FOR THIS ROUTINE             02231000
         SLR   RF,RF              SET RETURN CODE TO ZERO      @KD40295 02232000
         LR    RB,R0              GET BEGIN ADDR                        02233000
         N     RB,PADDRMSK        SET BEGINADDR ON PAGE BOUNDARY        02234000
*        AMODESW SET,DAT=OFF      ENTER REAL MODE (DAT=OFF)    @D52VDRP 02235000
         AMODESW SET,DAT=OFF                                   @D52VDRP 02236000
*                                 ENTER REAL MODE (DAT=OFF)    @D52VDRP 02237000
FREPDSLP DS    0H                 GET REAL ADDR OR PTE ADDR    @D51GDTP 02238000
         LRA   RC,0(RB)           GET REAL ADDR. OR PTE ADDR.  @D14NDFG 02239000
         BC    2,FREPDSNA         SKIP IF NOT ADDRESSABLE      @D14NDFG 02240000
         LTR   R8,R8              HAS PAGE TO BE CLEARED       @D52VDRP 02241000
         BNM   FREPDNPO           NO, BRANCH                   @D52VDRP 02242000
         L     R5,PAGESIZE        GET LENGTH OF PAGE           @D52VDRP 02243000
         LR    R4,RC              GET SOURCE ADDR FOR MVCL     @D52VDRP 02244000
         LR    R6,RC              GET TARGET ADDR FOR MVCL     @D52VDRP 02245000
         SLR   R7,R7              SET PAD AND LENGTH TO ZERO   @D52VDRP 02246000
         MVCL  R4,R6              CLEAR PAGE FRAME             @D52VDRP 02247000
FREPDNPO EQU   *                                               @D52VDRP 02248000
         ISKE  RA,RC              GET KEY                      @D51GDTP 02249000
         N     RA,CBITMSK         CHANGE                       @D35CDKH 02250000
         SSKE  RA,RC              STORE KEY BACK               @D51GDTP 02251000
         SRL   RC,PFSHIFT         PFTE OFFSET                  @D14NDFG 02252000
         AL    RC,APFT            PFTE ADDRESS                 @DA33314 02253000
         USING PFTE,RC                                         @D14NDFG 02254000
         L     RA,ASCNPGQO        GET ENTRY ADDR FOR SCNPGQO RT@DA36227 02255000
         BALR  RA,RA              REMOVE ENTRY FROM PGQOU      @DA36227 02256000
*SGLINK  SCDELPGO,INPUT=(RA,RC),NOMODR=(R0-RF),AMODE=31 DATOFF          02257000
*        GENSERV RPTE,PFTE=(RC),RPTE=(RC),WORKR=(R3,R4,R5)     @D52VDRP 02258000
*                                 GET REAL PTE ADDR IN RC      @D52VDRP 02259000
         GENSERV RPTE,PFTE=(RC),RPTE=(RC),WORKR=(R3,R4,R5)     @D52VDRP 02260000
         USING PTE,RC                                          @D52VDRP 02261000
FREPDSNA NI    PTESTAT2,XFF-PTEPDS INDICATE NO COPY ON PDS     @D14ADVB 02262000
         LTR   R8,R8              REQUEST FOR CLEARING         @KD40295 02263000
         BNM   FREPDSNB           NO, ALL DONE                 @KD40295 02264000
         TM    PTESTAT,PTEPGCO+PTEIBIT PAGE CONNECTED          @KD40295 02265000
         BNO   FREPDSNB           NO, ALL DONE                 @KD40295 02266000
         O     RF,F4              YES, INDICATE NOT ALL CLEARED@KD40295 02267000
         DROP  RC                 FORGET PTE                   @D52VDRP 02268000
FREPDSNB AL    RB,PAGESIZE        GET ADDR NEXT PAGE           @D14NDVB 02269000
         CLR   RB,R1              ALL PAGES HANDLED            @D52VDRP 02270000
         BNH   FREPDSLP           NO, BRANCH                            02271000
         LTR   R8,R8              REQUEST FOR CLEARING         @KD40295 02272000
         BNM   FREPDSEX           NO, SKIP SETTING OF RET. CODE@KD40295 02273000
         ST    RF,PMRSAVE+(RF-R4)*4 YES, SET RETURN CODE       @KD40295 02274000
FREPDSEX DS    0H                                              @KD40295 02275000
*        AMODESW SET,DAT=ON       ENTER VIRTUAL MODE (DAT=ON)  @D52VDRP 02276000
         AMODESW SET,DAT=ON                                    @D52VDRP 02277000
         LM    R4,RF,PMRSAVE      RESTORE CALLERS REGISTER     @DA36227 02278000
         L     RA,FREPDSND        INDICATE END OF FREEPDS      @KD40295 02279000
         DEBUG ALLREGS,XXDBGMC    * DO DEBUG ENTRY             @KD40295 02280000
         L     RA,PMRSAVE+(RA-R4)*4 RESTORE REGISTER           @KD40295 02281000
*        AMODESW RETURN,REG=(R7)  RETURN                       @D52VDRP 02282000
         AMODESW RETURN,REG=(R7)  ==========>  RETURN          @D52VDRP 02283000
         DROP  R8,R9              FORGET BASE REGISTERS                 02284000
         TITLE 'DOS SUPERVISOR        SGPFIX     PAGE MANAGEMENT (TFIX-*02285000
               ROUTINE)'                                       @D14ZDRP 02286000
*-------------------------------------------------------------*@D149DVB 02287000
*        ROUTINE PROLOGUE                                      @D149DVB 02288000
*        ROUTINE NAME: TFIX                                    @D149DVB 02289000
*        MACRO:        SGPFIX                                  @D149DVB 02290000
*        FUNCTION: FIXES TEMPORARILY THE PAGES SPECIFIED       @D149DVB 02291000
*                  BY THE PARAMETER LIST                       @D149DVB 02292000
*        ENTRY POINTS:                                         @D149DVB 02293000
*              TFIX -    CALLED BY                             @D149DVB 02294000
*                       FETCH , SVC44 WITH AMODE(31),DATON     @D529DRP 02295000
*              TFIXCCW   CALLED BY CCW_TRANSLATION             @D149DVB 02296000
*                            WITH AMODE(31),DATON              @D529DRP 02297000
*                                                                       02298000
*        CALLING SEQUENCE:                                     @D149DVB 02299000
*              L       R8,APMGMDAT                             @D149DVB 02300000
*              L       R7,ATFIX/ATFIXCCW                       @D149DVB 02301000
*              AMODESW CALL,REGS=(R7,R7)                       @D52VDRP 02302000
*              B       AAAA        NOT ALL PAGES TFIXED        @D149DVB 02303000
*              B       BBBB        NO PAGE FIXED AT ALL        @D149DVB 02304000
*              B       CCCC        FUNCTION DONE AS EXPECTED   @D149DVB 02305000
*        CALLED ROUTINES:                                      @D149DVB 02306000
*              GENPGQE, GETENT/GETPAGE, PMRREMOV, FIXEXCHG,    @D529DRP 02307000
*              TFREE WITH AMODE(31),DATOFF                     @D149DVB 02308000
*              SETUPSA, UNPOST WITH AMODE(31),DATON            @D149DVB 02309000
*              DEFIXCON        WITH AMODE(24),DATON            @D149DVB 02310000
*        INPUT:                                                @D149DVB 02311000
*           IF ENTERED IN TFIX                                 @D149DVB 02312000
*              R1 : ADDR (LIST(PARM)                           @D149DVB 02313000
*                   PARM  = (ADDRESS(1ST PAGE),                @D52VDVB 02314000
*                            ADDRESS(LAST PAGE)                @D52VDVB 02315000
*                            TO BE TFIXED)                     @D51ZDRP 02316000
*                   PARM  = (A(0),NIL) IS END OF LIST          @D52VDRP 02317000
*              R7 : RETURN ADDRESS                             @D149DVB 02318000
*              R8 : ADDRESS OF THE PAGE-MANAGEMENT DATA AREA   @D149DVB 02319000
*              IF CALLED FROM FETCH EACH ENTRY OF THE PARM_LIST@D149DVB 02320000
*              SPECIFIES ONLY ONE PAGE.                        @D149DVB 02321000
*           IF ENTERED IN TFIXCCW                              @D149DVB 02322000
*              R1 : VIRTUAL ADDRESS OF PAGE TO BE TFIXED       @D149DVB 02323000
*              R7 : RETURN ADDRESS                             @D149DVB 02324000
*              R8 : ADDRESS OF THE PAGE-MANAGEMENT DATA AREA   @D149DVB 02325000
*                                                              @D149DVB 02326000
*        OUTPUT:                                               @D149DVB 02327000
*              ALL PAGES SPECIFIED ARE TFIXED                  @D149DVB 02328000
*              REGS R1,R8,R9,RE AND RF ARE UNCHANGED, ALL OTHER@D149DVB 02329000
*              REGISTERS ARE DESTROYED                         @D149DVB 02330000
*              IF ENTERED VIA TFIXCCW ONLY THE CONTENT         @D149DVB 02331000
*              OF R0,R1 AND RE IS DESTROYED                    @D149DVB 02332000
*                                                              @D149DVB 02333000
*        EXIT NORMAL: AMODE(CALLER),DATON                      @D149DVB 02334000
*          RETURN TO CALLER WITH OFFSET 8.                     @D149DVB 02335000
*          CONDITION: FUNCTION COMPLETED                       @D149DVB 02336000
*          OUTPUT:  AS DESCRIBED ABOVE                         @D149DVB 02337000
*          RETURN CODE: NONE                                   @D149DVB 02338000
*        EXIT ERROR:AMODE(CALLER),DATON\                       @D149DVB 02339000
*        1.RETURN TO CALLER WITH OFFSET 0                      @D149DVB 02340000
*          CONDITION: MIN. NUMBER OF PSQ-ENTRIES REACHED,      @D149DVB 02341000
*                     NO FURTHER TFIX POSSIBLE.                @D149DVB 02342000
*          OUTPUT: IF REQUESTOR IS NOT FETCH,                  @D149DVB 02343000
*                  NOTHING IS FIXED.                           @D149DVB 02344000
*                  IF REQUESTOR IS FETCH, R1 = ADDR OF 1ST LIST@D149DVB 02345000
*                  ENTRY WHICH IS NOT YET HANDLED BY TFIX.     @D149DVB 02346000
*                  IF ENTERED VIA TFIXCCW ONLY R1 AND RE ARE   @D149DVB 02347000
*                  DESTROYED                                   @D149DVB 02348000
*          RETURN CODE: NONE                                   @D149DVB 02349000
*        2.RETURN TO CALLER WITH OFFSET 4                      @D149DVB 02350000
*          CONDITION: MAX. VALUE OF TFIXC REACHED FOR ONE PAGE @D149DVB 02351000
*                     NO TFIX POSSIBLE FOR THE PAGE            @D149DVB 02352000
*          OUTPUT: NOTHING IS FIXED FOR THIS REQUEST           @D149DVB 02353000
*                  REGISTER R1,R8,R9,RE AND RF ARE UNCHANGED, ALL       02354000
*                  OTHER REGISTERS ARE DESTROYED.              @D149DVB 02355000
*                  IF ENTERED VIA TFIXCCW ONLY THE             @D149DVB 02356000
*                  CONTENT OF R0,R1 AND RE IS DESTROYED.       @D149DVB 02357000
*          RETURN CODE: NONE                                   @D149DVB 02358000
*                                                              @D149DVB 02359000
*        EXTERNAL REFERENCES:                                  @D149DVB 02360000
*         ROUTINES: DEFIXCON TO FREE PAGES KEPT BY FAST_CCWX   @D149DVB 02361000
*                   TFREE  TO TFREE PAGES ALREADY TFIXED       @D149DVB 02362000
*         DATA: NPSQE(READ,WRITE) # OF PSQ-ENTRIES + FFCC      @D149DVB 02363000
*               PSQ(READ,WRITE)  PAGE SELECTION QUEUE          @D149DVB 02364000
*               PFTE.TFIXC(READ,WRITE)                         @D149DVB 02365000
*               PTE.PTESTAT(READ,WRITE)                        @D149DVB 02366000
*               MINPSQE(READ)  MINIMUM VALUE OF NPSQE          @D149DVB 02367000
*                              NOT FETCH                       @D149DVB 02368000
*               MINPSQEF(READ) MINIMUM VALUE OF NPSQE          @D149DVB 02369000
*                              FOR FETCH                       @D149DVB 02370000
*                                                              @D149DVB 02371000
*        NOTE: 1. THE PARM_LIST MUST BE IN FIXED STORAGE-AREA. @D149DVB 02372000
*              2. EACH REQUESTOR OF TFIX HAS TO INCREASE THE   @D149DVB 02373000
*                 HALFWORD TFIXIDEN BY ONE                     @D149DVB 02374000
*                 (IT HAS TO BE DECREASED BY ONE AFTER ALL     @D149DVB 02375000
*                 PAGES OF THIS REQUEST ARE TFREED).           @D149DVB 02376000
*                                                              @D149DVB 02377000
*        OPERATION                                             @D149DVB 02378000
*                                                              @D149DVB 02379000
*        TFIXCCW:                         /* E N T R Y  P T  */@D149DVB 02380000
*        R0 := 0                          /* INDICATE TFIXCCW*/@D149DVB 02381000
*        DO WHILE PAGE  ¬ ADDRESSABLE                          @D149DVB 02382000
*           ADDR_PTE(LRA(PAGE))           /*   GET PTE       */@D149DVB 02383000
*           TRADDR := EPA (PTE)           /* EXT. PAGE ADDR..*/@D149DVB 02384000
*                                         /*.. AS PAGE_FAULT */@D149DVB 02385000
*           CALL GENPGQE (TRADDR)         /*BUILD PGQUI ENTRY*/@D149DVB 02386000
*        ENDDO                            /*                 */@D149DVB 02387000
*        GOTO TFIXLP01                                         @D149DVB 02388000
*                                                              @D149DVB 02389000
*        TFIX:                            /* E N T R Y  P T  */@D149DVB 02390000
*        CALL GETENT (PARM)               /* ADDR 1ST PAGE   */@D149DVB 02391000
*                                         /* IF EOL =====>   */@D149DVB 02392000
*        DO WHILE ¬EOL (PARM)                                  @D149DVB 02393000
*           WINDOW FOR I/O & EXT INTERRUPTS                    @D149DVB 02394000
*        TFIXLP0X:                                             @D149DVB 02395000
*           DO WHILE PAGE  ¬ ADDRESSABLE                       @D149DVB 02396000
*              ADDR_PTE(LRA(PAGE))        /*   GET PTE       */@D149DVB 02397000
*              TRADDR := EPA (PTE)        /* EXT. PAGE ADDR..*/@D149DVB 02398000
*                                         /*.. AS PAGE_FAULT */@D149DVB 02399000
*              CALL GENPGQE (TRADDR)      /*BUILD PGQUI ENTRY*/@D149DVB 02400000
*           ENDDO                                              @D149DVB 02401000
*        TFIXLP01:                                             @D149DVB 02402000
*           ADDR_PFTE(PAGE)                                    @D149DVB 02403000
*           IF PFTE.TFIXC = TFIXMAX THEN GOTO TFIXRET4         @D149DVB 02404000
*           IF PFTE.FIXC = 0              /* PAGE ¬ P/T FIXED*/@D149DVB 02405000
*        TFIXNO:                                               @D149DVB 02406000
*              THEN DO                                         @D149DVB 02407000
*              IF PFTE.NFRP = ON          /* FRAME RESERVED  */@D149DVB 02408000
*                 THEN CALL TFIXIOWT(PFTE)                     @D149DVB 02409000
*              IF PFTE.NFVP = OFF         /* FRAME REQ PFIX  */@D149DVB 02410000
*                 THEN DO                                      @D149DVB 02411000
*                 CALL TFIXTEST (PFTE,PAGE)                    @D149DVB 02412000
*                 CASE                                         @D149DVB 02413000
*                    WHEN TFIXNO THEN GOTO TFIXNO              @D149DVB 02414000
*                    WHEN OFFS_0 THEN RETURN (OFFS = 0)        @D149DVB 02415000
*                    WHEN TFIXRET0 THEN GOTO TFIXRET0          @D149DVB 02416000
*                    WHEN CONTINUE THEN GOTO TFIXBRRP          @D149DVB 02417000
*                 ENDCASE                                      @D149DVB 02418000
*        TFIXBRRP:                                             @D149DVB 02419000
*              IF PFTE.NFRP = ON          /*FRAME RESERVED   */@D149DVB 02420000
*                 THEN CALL TFIXFNDF      /* FIND OTHER FRAME*/@D149DVB 02421000
*           END                                                @D149DVB 02422000
*           INCREASE PFTE.TFIXC           /* +1 FOR TFIXC    */@D149DVB 02423000
*           IF TFIXCCW_FUNCTION          /*CALLED VIA TFIXCCW*/@D149DVB 02424000
*              THEN RETURN (CON = OFFS_8)                      @D149DVB 02425000
*           CALL GETPAGE (PARM_LIST)                           @D149DVB 02426000
*        END (DO WHILE)                                        @D149DVB 02427000
*        RETURN (OFFS = 8)                /*  =====> E X I T */@D149DVB 02428000
*                                                              @D149DVB 02429000
*        TFIXRET4:                                             @D149DVB 02430000
*        ERROFF := OFFS_4                                      @D149DVB 02431000
*        GOTO TFIXRET                                          @D149DVB 02432000
*        TFIXRET0:                                             @D149DVB 02433000
*        ERROFF := OFFS_0                                      @D149DVB 02434000
*        TFIXRET:                                              @D149DVB 02435000
*        IF ¬ TFIXCCW_FUNCTION            /*  CALLED AS TFIX */@D149DVB 02436000
*           THEN DO                                            @D149DVB 02437000
*           PARM_TFREE:= PARM (TFIXED)    /* PARM L FOR TFREE*/@D149DVB 02438000
*           CALL TFREE(PARM_TFREE)        /* TFREE PAGES     */@D149DVB 02439000
*           END                                                @D149DVB 02440000
*        RETURN (COND = ERROFF)           /* =====>  E X I T */@D149DVB 02441000
*        END (TFIX) ;                                          @D149DVB 02442000
*-------------------------------------------------------------*@D149DVB 02443000
*       TFIXIOWT:                         /* E N T R Y  P T  */@D149DVB 02444000
*       IF PFTE.POABIT = OFF              /* PAGEOUT INACTIVE*/@D149DVB 02445000
*          THEN RETURN                                         @D149DVB 02446000
*          ELSE DO                                             @D149DVB 02447000
*       TFIXPOA:                          /* E N T R Y  P T  */@D149DVB 02448000
*          IF TFIXCCW_FUNCTION            /*CALLED AS TFIXCCW*/@D149DVB 02449000
*             THEN  RESTART_ADDR = TFIXLP0X                    @D149DVB 02450000
*             ELSE  RESTART_ADDR = TFIXCNT1                    @D149DVB 02451000
*          CALL SETUPSA (RESTART_ADDR)    /*PROVIDE RESTART  */@D149DVB 02452000
*          CALL UNPOST(SRQPGIO,PFTE)                           @D149DVB 02453000
*          EXIT (DISP)                    /* =====> E X I T  */@D149DVB 02454000
*          END                                                 @D149DVB 02455000
*       END (TFIXIOWT) ;                                       @D149DVB 02456000
*-------------------------------------------------------------*@D149DVB 02457000
*       TFIXTEST:                         /* E N T R Y  P T  */@D149DVB 02458000
*       IF NPSQE <= MINPSQE           /*MIN# PSQ ENTR REACHED*/@D149DVB 02459000
*          THEN DO                                             @D149DVB 02460000
*          IF FRAMES KEPT BY F_CCWX                            @D149DVB 02461000
*             THEN DO                                          @D149DVB 02462000
*             CALL DEFIXCON               /* FREE PAGE FRAMES*/@D149DVB 02463000
*             RETURN (COND=TFIXNO)                             @D149DVB 02464000
*             END                                              @D149DVB 02465000
*             ELSE DO                                          @D149DVB 02466000
*             IF REQ = (FETCH TASKS)      /* REQUESTOR ONE OF*/@D149DVB 02467000
*                THEN DO                  /* FETCH TASKS ....*/@D149DVB 02468000
*                IF NPSQE ¬> MINPSQEF                          @D149DVB 02469000
*                   THEN RETURN (COND =OFFS_0)                 @D149DVB 02470000
*                   ELSE RETURN (COND = TFIXRET0)              @D149DVB 02471000
*                END                                           @D149DVB 02472000
*             END                                              @D149DVB 02473000
*          END                                                 @D149DVB 02474000
*       CALL PMRREMOV (PFTE)              /* REMOVE FROM PSQ */@D149DVB 02475000
*       DECREASE NPSQE                                         @D149DVB 02476000
*       RETURN (COND = CONTINUE)                               @D149DVB 02477000
*       END (TFIXCHCK) ;                                       @D149DVB 02478000
*-------------------------------------------------------------*@D149DVB 02479000
*       TFIXFNDF:                         /* E N T R Y  P T  */@D149DVB 02480000
*       IF IPFQ ¬= (0)                    /* IPFQ NOT EMPTY  */@D149DVB 02481000
*          THEN DO UNTIL EOQ(IPFQ)                             @D149DVB 02482000
*          NXT(PFTE) IN IPFQ              /* NEXT IPFQ.PFTE  */@D149DVB 02483000
*          IF IPTE.PFTE.NFRP = OFF        /* NOT RESERVED FR */@D149DVB 02484000
*             THEN DO                                          @D149DVB 02485000
*             CALL FIXEXCHG(PFTE,IPFQ.PFTE) /*EXCHANGE PFTES */@D149DVB 02486000
*             RETURN                                           @D149DVB 02487000
*             END                                              @D149DVB 02488000
*          END (DO UNTIL)                                      @D149DVB 02489000
*       DO UNTIL EOQ (PSQ)                                     @D149DVB 02490000
*          NEXT (PFTE) IN PSQ             /* NEXT PSQ.PFTE   */@D149DVB 02491000
*          IF PSQ.PFTE.NFRP = OFF                              @D149DVB 02492000
*             & PSQ.PFTE.POABIT+PCBIT = ¬ ON                   @D149DVB 02493000
*          THEN DO                                             @D149DVB 02494000
*          CALL FIXEXCHG(PFTE,PSQ.PFTE)   /* EXCHANGE PFTES  */@D149DVB 02495000
*          RETURN                                              @D149DVB 02496000
*          END                                                 @D149DVB 02497000
*       END (DO UNTIL)                                         @D149DVB 02498000
*       EXIT (TFIXPOA)                                         @D149DVB 02499000
*       END (TFIXFNDF) ;                                       @D149DVB 02500000
*-------------------------------------------------------------*@D149DVB 02501000
*       NOTE : R0 - R7 UNCHANGED                               @D149DVB 02502000
*       FIXEXCHG:                         /* E N T R Y  P T  */@D149DVB 02503000
*       ADDR_PF(PFTE)                     /*ORIGINAL PAGE-FR */@D149DVB 02504000
*       ADDR_PF(X_PFTE)                   /*PAGE FRAME USED..*/@D149DVB 02505000
*                                         /*... FOR EXCHANGE */@D149DVB 02506000
*       DAT := OFF                        /*RESET DAT FEATURE*/@D149DVB 02507000
*       EXCHANGE CONTENT (PF,X_PF)/* EXCHANGE FRAMES */        @D149DVB 02508000
*       /*    EXCHANGE CORRESPONDING   P T E  S              */@D149DVB 02509000
*       IF X_PFTE.PNRINV = OFF            /* USED FRAME      */@D149DVB 02510000
*          THEN DO                        /*    YES          */@D149DVB 02511000
*          IF X_PFTE.PFTEBLK = ON         /* ONLY BLOCK CONN.*/@D149DVB 02512000
*             THEN DO                                          @D149DVB 02513000
*             BLKTBE := ADDR(PF)*2**3 & BLKTBE.BLKPDS & BLKFRCO@D149DVB 02514000
*                                         /*UPDATE BLOCKENTRY*/@D149DVB 02515000
*             GOTO EXCHPTE2                                    @D149DVB 02516000
*             END                                              @D149DVB 02517000
*          IF X_PFTE.PFTEPNR*2**11 > VIOVPEPA    /* VIO POOL */@D149DVB 02518000
*             THEN DO                                          @D149DVB 02519000
*             ADDR_VTABE(X_PFTE.PFTEPNR*2**11)                 @D149DVB 02520000
*             IF VTABE.VTFRAM ¬= ADDR_PF(X.PFTE)               @D149DVB 02521000
*                THEN EXIT(HW = X'FF1')   /*  =====> HARDWAIT*/@D149DVB 02522000
*             VTABE.VTFRAM := ADDR(PF)*2**3                    @D149DVB 02523000
*             IF PTE.PTESTAT=PGCONNECT+PTEIBIT                 @D149DVB 02524000
*                 THEN GOTO EXCHPTE2                           @D149DVB 02525000
*             END                                              @D149DVB 02526000
*          PTEN:= X_PTE - X_PTE.PDSBIT + PTE.PDSBIT            @D149DVB 02527000
*          X_PTE := PTE - PTE.PDSBIT + X_PTE.PDSBIT            @D149DVB 02528000
*          PTE := PTEN                   /* EXCHANGE PAGEFR */ @D149DVB 02529000
*          END                                                 @D149DVB 02530000
*          ELSE DO                                             @D149DVB 02531000
*       EXCHPTE2:                                              @D149DVB 02532000
*          PTE := ADDR(X_PF)*2**3 & PTE.PDSBIT /* PF# * 2**3 */@D149DVB 02533000
*                                         /* PDSBIT UNCHANGED*/@D149DVB 02534000
*          END                                                 @D149DVB 02535000
*       DAT := ON                         /* SET DAT FEATURE */@D149DVB 02536000
*       /*    EXCHANGE STORAGE KEYS IN PAGE FRAMES           */@D149DVB 02537000
*       EXCHANGE STKEYS (PF,X_PF)                              @D149DVB 02538000
*       /*    EXCHANGE   P F T E  S                          */@D149DVB 02539000
*       IF X_PFTE.PNRINV=ON OR (X_PFTE.PNRINV+NFVP=OFF)        @D149DVB 02540000
*          THEN DEQUEUE PFTE FROM PSQ                          @D149DVB 02541000
*       PFTEN := X_PFTE - X_PFTE.NFRP + PFTE.NFRP              @D149DVB 02542000
*       X_PFTE := PFTE - PFTE.NFRP + X_PFTE.NFRP               @D149DVB 02543000
*       PFTE  := PFTEN                                         @D149DVB 02544000
*       RETURN                                                 @D149DVB 02545000
*       END (FIXEXCHG) ;                                       @D149DVB 02546000
*-------------------------------------------------------------*@D149DVB 02547000
*    INTERNAL REGISTER USAGE                                   @D149DVB 02548000
*         R1 - ADDR OF PAGE TO BE FIXED                        @D149DVB 02549000
*         R2 - END ADDR OF CURRENT AREA                        @D149DVB 02550000
*         R3 - ADDR OF CURRENT PARAMETER LIST ENTRY            @D149DVB 02551000
*         R4 - WORKREGISTER                                    @D149DVB 02552000
*         R5 - WORKREGISTER AND LINKREGISTER                   @D149DVB 02553000
*         R7 - RETURN ADDR                                     @D149DVB 02554000
*         RA - LINKREGISTER TO 2ND LEVEL                       @D149DVB 02555000
*         RB - SAVE AREA FOR CALLERS RG.1 (IF ENTERED VIA TFIX)@D149DVB 02556000
*         RC - ADDR OF PFTE CORRESP. TO R1                     @D149DVB 02557000
*         RD - SAVE AREA FOR CALLERS RG.9 (IF ENTERED VIA TFIX)@D149DVB 02558000
*         RE - NOT USED, IS COMMITTED AS UNCHANGED AFTER RETURN@D149DVB 02559000
*         RF - NOT USED, IS COMMITTED AS UNCHANGED AFTER RETURN@D149DVB 02560000
*-------------------------------------------------------------*@D149DVB 02561000
         SPACE 1                                               @D14ZDVB 02562000
         USING PMGMDATA,R8        SET BASE FOR DATA-AREA                02563000
PMFIXAD2 DS    0H                                              @D52VDRP 02564000
         SPACE 2                                               @D35CDKH 02565000
TFIXCCW  DS    0H                 ENTRY POINT FOR CCW TRANSL   @D14ZDVB 02566000
         SLR   R0,R0                                           @D14ZDVB 02567000
         LR    RE,R9              SAVE CALLERS REG 9           @D35CDKH 02568000
         L     R9,APMFIXA2        GET BASE FOR CODE            @D35CDKH 02569000
         USING PMFIXAD2,R9        SET BASE FOR CODE            @D35CDKH 02570000
         STM   R2,RF,STFIXCCW     SAVE CALLERS REG'S           @D35CDKH 02571000
         N     R1,PADDRMSK        ADDR TO PAGE BOUNDARY        @D35CDKH 02572000
TFIXLP00 DS    0H                                                       02573000
*        AMODESW SET,DAT=OFF      ENTER REAL MODE (DAT=OFF)    @D52VDRP 02574000
         AMODESW SET,DAT=OFF                                   @D52VDRP 02575000
*                                 ENTER REAL MODE (DAT=OFF)    @D52VDRP 02576000
         LRA   RC,0(R1)           PAGE IN STORAGE              @D35CDKH 02577000
         BC    8,TFIXLP01         YES, BR                      @D35CDKH 02578000
         BC    2,TFIX00           PAGE IS NOT ADDRESSABLE      @D52VDRP 02579000
TFIXER1  BAL   R5,PMRHWERR        SEGMENT IS INVALID, ERROR    @D52VDRP 02580000
TFIX00   DS    0H                                              @D52VDRP 02581000
         USING PTE,RC                                          @D52VDRP 02582000
         TM    PTESTAT,PTEINVAD   IS IS INVALIDE PAGE          @D52VDRP 02583000
         BO    TFIXER1            YES, ERROR ENTER HARD-WAIT   @D52VDRP 02584000
         ST    R1,TRADDR          STORE PAGE ADDRESS           @DA35398 02585000
         LM    R2,RF,STFIXCCW     RESTORE CALLERS REG'S        @D35CDKH 02586000
         L     RC,AGENPGQE        GET RTN ADDRESS              @D52VDRP 02587000
         BALR  RC,RC              GENERATE PGQUI-ENTRY         @D35CDKH 02588000
.*  RETURNS WITH DAT ON                                        @D52VDRP 02589000
TFIXCNT1 STM   R2,RF,STFIXCCW     SAVE CALLERS REG'S           @D35CDKH 02590000
         B     TFIXLP00           GO TO TFIX PAGE              @D35CDKH 02591000
         DROP  R9                                              @D35CDKH 02592000
*                                                              @D35CDKH 02593000
         SPACE 1                                               @D35CDKH 02594000
TFIX     LA    R0,1               INDICATE TFIX REQUEST        @D52VDRP 02595000
         LR    RB,R1              SAVE CALLERS REGISTER R1     @D14BDRP 02596000
         LR    RD,R9              SAVE CALLERS REGISTER R9     @D14BDRP 02597000
         L     R9,APMFIXA2        GET BASE FOR CODE-AREA                02598000
         USING PMFIXAD2,R9        SET BASE FOR CODE-AREA                02599000
         BAL   R5,GETENT          GET 1ST PAGE TO BE HANDLED            02600000
         B     TFIXRET8           RETURN TO CALLER IF NO ENTRY IN LIST  02601000
*--->    B     TFIXLOOP           PROCESS NEXT ENTRY           @D149DVB 02602000
TFIXLOOP EQU   *                                                        02603000
         STOSM PSWMASK,ENABLE     ENABLE FOR I/O AND EXT. INTERR.       02604000
         STNSM PSWMASK,DISABLE    DISABLE AGAIN                         02605000
TFIXLP0X DS    0H                                              @D14BDRP 02606000
*        AMODESW SET,DAT=OFF      ENTER REAL MODE (DAT=OFF)    @D52VDRP 02607000
         AMODESW SET,DAT=OFF                                   @D52VDRP 02608000
         LRA   RC,0(R1)           PAGE IN STORAGE              @D35CDKH 02609000
         BC    8,TFIXLP01         YES, BRANCH                           02610000
         BC    2,TFIX01           PAGE IS NOT ADDRESSABLE      @D52VDRP 02611000
TFIXER2  BAL   R5,PMRHWERR        SEGMENT IS INVALID, ERROR    @D52VDRP 02612000
TFIX01   DS    0H                                              @D52VDRP 02613000
         USING PTE,RC                                          @D52VDRP 02614000
         TM    PTESTAT,PTEINVAD   IS IS INVALIDE PAGE          @D52VDRP 02615000
         BO    TFIXER2            YES, ERROR ENTER HARD-WAIT   @D52VDRP 02616000
         ST    R1,TRADDR          STORE PAGE ADDR              @DA35398 02617000
         L     RC,AGENPGQE        GET RTN ADDRESS              @D52VDRP 02618000
         BALR  RC,RC              GENERATE PGQUI-ENTRY         @D52VDRP 02619000
.*  RETURNS WITH DAT ON                                        @D52VDRP 02620000
         B     TFIXLP0X           TRY IT ONCE MORE                      02621000
         SPACE 1                                               @D14NDVB 02622000
TFIXLP01 SRL   RC,PFSHIFT         GET ADDR                     @D35CDKH 02623000
         A     RC,APFT            OF PFTE                               02624000
         USING PFTE,RC            SET BASE FOR PFTE                     02625000
         CLC   FIXC,F0            PAGE FIXED                            02626000
         BE    TFIXNO             NO, BRANCH                            02627000
         CLC   TFIXC,TFIXMAX      TFIX COUNTER OVERFLOW                 02628000
         BL    TFIXINCR           NO, INCREASE TFIXC                    02629000
         B     TFIXRET4           YES, BRANCH                           02630000
TFIXNO   EQU   *                                                        02631000
         TM    S370FLG,NFRP       PF RESERVED                  @D35CDKH 02632000
         BO    TFIXIOWT           YES  ----->                  @D14ZDVB 02633000
TFIXPOFF TM    S370FLG,NFVP       PG REQUESTED BY PFIX         @D35CDKH 02634000
         BO    TFIXBRRP           YES, ----->                  @D14ZDVB 02635000
         CLC   NPSQE,MINPSQE      MIN # OF PSQ-ENTRIES REACHED          02636000
         BNH   TFIXTEST           YES, DO FURTHER CHECKING     @D14BDRP 02637000
TFIXCNT  BAL   RA,PMRREMOV        REMOVE PFTE FROM PSQ                  02638000
*        GENSERV DEC,FIELD=NPSQE,REG=(R5)                      @D52VDVB 02639000
         GENSERV DEC,FIELD=NPSQE,REG=(R5)                      @D52VDVB 02640000
TFIXBRRP TM    S370FLG,NFRP       PG FRAME RESERVED            @D14ZDVB 02641000
         BO    TFIXFNDF           YES, -----> EXCHANGE PAGES   @D14ZDVB 02642000
TFIXINCR DS    0H                                                       02643000
*        GENSERV INC,FIELD=TFIXC,REG=(R5)                      @D52VDVB 02644000
         GENSERV INC,FIELD=TFIXC,REG=(R5)                      @D52VDVB 02645000
         LTR   R0,R0              REQUEST FROM CCW TRANSL      @D35CDKH 02646000
         BNZ   NTFXCCW1           NO ,BRANCH                   @D35CDKH 02647000
         AL    R7,F8              RETURN WITH OFFSET 8         @D52VDRP 02648000
         B     TFIXCCWR           RETURN TO CCWTRANSLATION     @D52VDRP 02649000
NTFXCCW1 EQU   *                                               @D35CDKH 02650000
*        AMODESW SET,DAT=ON       ENTER VIRTUAL MODE (DAT=ON)  @D52VDRP 02651000
         AMODESW SET,DAT=ON                                    @D52VDRP 02652000
         BAL   R5,GETPAGE         GET NEXT PAGE TO BE TFIXED            02653000
         B     TFIXRET8           RETURN TO CALLER IF END OF LIST       02654000
         B     TFIXLOOP           HANDLE RETURNED PAGE                  02655000
         SPACE 1                                                        02656000
TFIXTEST DS    0H                                              @D14BDRP 02657000
         AGO   .PFCCWC0                                        @D64YDOW 02658000
*    GENSERV TEST,FIELD=LOWFXPTR,REG=(R5),BC=BZ,LAB=TFIX10     @D52VDVB 02659000
     GENSERV TEST,FIELD=LOWFXPTR,REG=(R5),BC=BZ,LAB=TFIX10     @D52VDVB 02660000
         L     R9,ACCWT           GET BASE ADDR OF CCW-FIXING-FUNCT.    02661000
         USING CCWTADR,R9         SET BASE                              02662000
*        AMODESW SET,DAT=ON       ENTER VIRTUAL MODE (DAT=ON)  @D52VDRP 02663000
         AMODESW SET,DAT=ON                                    @D52VDRP 02664000
*        AMODESW CALL,AMODE=24,ADDRESS=DEFIXCON,REGS=(RA,RA)   @D52VDRP 02665000
         AMODESW CALL,AMODE=24,ADDRESS=DEFIXCON,REGS=(RA,RA)   @D52VDRP 02666000
*                                 FREE PAGES KEPT BY FAST-CCW-FIX       02667000
*SGLINK  DEFIXCON,INPUT=(R9,RA)                                @D369DRP 02668000
*        AMODESW SET,DAT=OFF      ENTER REAL MODE (DAT=OFF)    @D52VDRP 02669000
         AMODESW SET,DAT=OFF                                   @D52VDRP 02670000
         L     R9,APMFIXA2        GET BACK BASE FOR CODE AREA           02671000
         USING PMFIXAD2,R9        RESET BASE FOR CODE AREA              02672000
         B     TFIXNO             ----->  TRY IT ONCE MORE     @D14ZDVB 02673000
         SPACE 1                                               @D14NDVB 02674000
TFIX10   DS    0H                                              @D14ZDVB 02675000
.PFCCWC0 ANOP                                                  @D64YDOW 02676000
         CLC   TID,SUPTIDH        REQUEST FROM FETCH ?         @D66ODOW 02677005
         BNE   TFIXRET0           NO, FREE PAGES ALREADY FIXED @D52VDVB 02678000
         SGCOV SGPFIXS,MC=14      TFIX FOR FETCH BELOW MINPSQE @D52VDRP 02679000
         L     R5,MINPSQE                                      @D52VDVB 02680000
         BCTR  R5,0               MINPSQE - 2 ...              @D52VDVB 02681000
         BCTR  R5,0               ... IS LOWER LIMIT           @D52VDVB 02682000
         CL    R5,NPSQE           ... FOR PROGRAM FETCH        @D52VDVB 02683000
         BL    TFIXCNT            ... LOWER        ------> FIX @D52VDVB 02684000
         LR    R1,R3              R1 POINTS TO 1ST ENTRY NOT HANDLED    02685000
         B     TFIXRETF           ==========> RETURN TO FETCH  @D14BDVB 02686000
         SPACE 1                                               @D14BDVB 02687000
TFIXRET8 AL    R7,F8              RETURN WITH OFFSET 8         @D14BDVB 02688000
         B     TFIXRET            GOTO RESTORE CALLERS REGISTERS        02689000
TFIXRET4 AL    R7,F4              RETURN ADDR WITH OFFSET 4    @D14ZDVB 02690000
TFIXRET0 EQU   *                                                        02691000
         LTR   R0,R0              REQUEST FROM CCW TRANSL      @D35CDKH 02692000
         BNZ   TFXCCW3            NO , BRANCH                  @D35CDKH 02693000
         SPACE 1                                                        02694000
*  RETURN TO CCW-TRANSLATION                                   @D52VDRP 02695000
TFIXCCWR DS    0H                                              @D52VDRP 02696000
*        AMODESW SET,DAT=ON       ENTER VIRTUAL MODE (DAT=ON)  @D52VDRP 02697000
         AMODESW SET,DAT=ON                                    @D52VDRP 02698000
         ST    R7,STFIXCCW+(7-2)*4 SET RETURN ADDRESS IN SAVEA @D52VDRP 02699000
         LM    R2,RF,STFIXCCW     RESTORE CALLERS REG'S        @D35CDKH 02700000
         LR    R9,RE              RESTORE CALLERS REG 9        @D35CDKH 02701000
*        AMODESW RETURN,REG=(R7)  RETURN                       @D52VDRP 02702000
         AMODESW RETURN,REG=(R7)  ==========> RETURN           @D52VDRP 02703000
*                                 ==========> RETURN           @D14ZDVB 02704000
         SPACE 1                                               @D14ZDVB 02705000
TFXCCW3  DS    0H                                              @D52VDRP 02706000
         USING TFIXLSTE,R3        SET BASE FOR LIST ENTRY               02707000
*        AMODESW SET,DAT=ON       ENTER VIRTUAL MODE (DAT=ON)  @D52VDRP 02708000
         AMODESW SET,DAT=ON                                    @D52VDRP 02709000
         MVC   FIXSAV1(L'TFIXENT+L'TFIXNENT),TFIXENT ENTRY AND FIRST   *02710000
               OF NEXT ENTRY TO BE MODIFIED ARE SAVED          @D52VDVB 02711000
         S     R1,PAGESIZE                                     @D14NDVB 02712000
         ST    R1,TFIXEND         CORRECT LAST ENTRY FOR TFREE @D52VDVB 02713000
         SLR   R1,R1                                           @D14ZDVB 02714000
         ST    R1,TFIXNENT        IND. END OF LIST FOR TFREE   @D14ZDVB 02715000
         LR    R1,RB              GET ADDR OF 1ST BLOCK        @D14BDRP 02716000
         ST    R7,FIXSAV2         SAVE RETURN ADDR                      02717000
         SGCOV SGPFIXS,MC=15      TFREE FROM TFIX              @D52VDRP 02718000
         BAL   R7,TFREE           FREE PAGES ALREADY FIXED              02719000
* RETURN FROM TFREE IS IN 31-BIT VIRTUAL                       @D52VDRP 02720000
         MVC   TFIXENT(L'TFIXENT+L'TFIXNENT),FIXSAV1           @D52VDVB 02721000
         L     R7,FIXSAV2         RESTORE RETURN ADDR                   02722000
TFIXRET  LR    R1,RB              RESTORE CALLERS REGISTER 1   @D14BDRP 02723000
TFIXRETF LR    R9,RD              RESTORE CALLERS REGISTER 9   @D14BDRP 02724000
*        AMODESW SET,DAT=ON       ENTER VIRTUAL MODE (DAT=ON)  @D52VDRP 02725000
         AMODESW SET,DAT=ON                                    @D52VDRP 02726000
*                                 ENTER VIRTUAL MODE (DAT=ON)  @D52VDRP 02727000
*        AMODESW RETURN,REG=(R7)  RETURN                       @D52VDRP 02728000
         AMODESW RETURN,REG=(R7)  ==========>                  @D52VDRP 02729000
*                                 ==========> RETURN VIA 0,4,8 @D14ZDVB 02730000
         DROP  R3                 FORGET BASE FOR PARAM-LIST ENTRY      02731000
         SPACE 2                                               @D14ZDVB 02732000
*     WAIT UNTIL PAGE OUT IS COMPLETED.                       *@D149DVB 02733000
*     DIPATCHER RETURNS TO ADDRESS GIVEN IN REGISTER RC       *@D149DVB 02734000
         SPACE 1                                                        02735000
TFIXIOWT TM    PFTEFLG,POABIT     PAGE OUT ACTIVE              @D14ZDVB 02736000
         BZ    TFIXPOFF           NO  --->                     @D14ZDVB 02737000
TFIXPOA0 ST    RC,FIXSAV3         SAVE PFTE ADDR               @D36IDRP 02738000
         LTR   R0,R0              REQUEST FROM CCW TRANSL      @D35CDKH 02739000
         BZ    TFIXPOA1           YES, BRANCH                  @D36IDRP 02740000
         STM   R9,RD,ERA          SAVE REGISTERS FOR SETUPSA   @D36IDRP 02741000
         LA    RC,TFIXLP0X        GET ADDR FOR CONTINUATON     @D14ZDRP 02742000
         B     TFIXPOA2           BRANCH                       @D36IDRP 02743000
TFIXPOA1 LM    R2,RF,STFIXCCW     SAVE CALLERS REGISTER        @D36IDRP 02744000
         STM   R9,RD,ERA          SAVE REGISTERS FOR SETUPSA   @D36IDRP 02745000
         LA    RC,TFIXCNT1        GET ADDR FOR CONTINUATION    @D36IDRP 02746000
TFIXPOA2 L     RD,AFLIH           GET BASE FOR SETUPSA         @D36IDRP 02747000
         SGCOV SGPFIXS,MC=16                                   @D52VDRP 02748000
         USING FLIH,RD                                         @D36IDRP 02749000
*        AMODESW SET,DAT=ON       ENTER VIRTUAL MODE (DAT=ON)  @D52VDRP 02750000
         AMODESW SET,DAT=ON                                    @D52VDRP 02751000
         BAL   R9,SETUPSA         SAVE STATUS                  @D36IDRP 02752000
*SGLINK  SETUPSA,INPUT=(R9,RC,RD),WORK=(RB,RC),OUTPUT=(R6,RA)  @D369DRP 02753000
         DROP  RD                                              @D36IDRP 02754000
         L     R5,ASRQTAB                                      @D61RDRP 02755000
         LA    R5,SRQPGIO-SRQTAB(,R5) WAIT QUEUE               @D61RDRP 02756000
         L     R1,FIXSAV3         GET BOUND INFORMATION        @D36IDRP 02757000
*              ON RETURN FROM SETUPSA                          @D369DRP 02758000
*                   R6 - BASE ADDR OF DISPATCHER               @D369DRP 02759000
*                   RA - ADDR OF TCB                           @D369DRP 02760000
         USING DISP,R6                                         @D36IDRP 02761000
         BAL   RF,UNPOST          SET TASK IN WAIT             @D36IDRP 02762000
*SGLINK  UNPOST,INPUT=(R1,R5,R6,RF),WORK=(R5,RE)               @D369DRP 02763000
*        AMODESW RETURN,REG=(R6)  ==========> EXIT DISPATCHER  @D52VDRP 02764000
         AMODESW RETURN,REG=(R6)  ==========> EXIT DISPATCHER  @D52VDRP 02765000
         DROP  R6                                              @D36IDRP 02766000
         SPACE 2                                               @D35CDKH 02767000
*    FIND A PAGE FRAME IN PSQ WITH NFRP,PFTERES=OFF & NO                02768000
*    PAGE-I/O RUNNING ON PF, EXCHANGE PAGES                             02769000
         SPACE 1                                               @D35CDKH 02770000
         DROP  RC                 FORGET PFTE                  @D35CDKH 02771000
         USING PFTE,RA                                         @D14BDRP 02772000
TFIXFNDF L     RA,IPFQPTR         GET ADDR OF IPFQ-HEADER      @D14BDRP 02773000
         C     RA,PFTEFPTR        IPFQ EMPTY                   @D14BDRP 02774000
         BE    SRCHPSQ            YES, BRANCH                  @D35CDRP 02775000
         L     R4,PFTEFPTR        GET 1ST ENTRY                @D35CDKH 02776000
         DROP  RA                 FORGET PFTE                  @D14BDRP 02777000
         USING PFTE,R4                                         @D35CDKH 02778000
NEXTPF00 TM    S370FLG,NFRP+PFTERES RES. FOR GETREAL/PFIX/GETPT@KX41291 02779000
         BZ    TFIXEXCH           NO, TAKE THIS PFTE           @D35CDKH 02780000
*  GENSERV COMP,FIELD=PFTEFPTR,BC=BNE,LAB=NEXTPF00,REG=(R4),COMPF=(RA)  02781000
   GENSERV COMP,FIELD=PFTEFPTR,BC=BNE,LAB=NEXTPF00,REG=(R4),COMPF=(RA)  02782000
         SPACE 1                                               @D14ZDVB 02783000
SRCHPSQ  L     RA,PSQPTR          GET ADDR OF PSQ HEADER       @D14BDRP 02784000
         LR    R4,RA                                           @D14BDRP 02785000
NEXTPF01 DS    0H                                              @D35CDKH 02786000
*  GENSERV COMP,FIELD=PFTEFPTR,BC=BNE,LAB=GOON01,REG=(R4),COMPF=(RA)    02787000
   GENSERV COMP,FIELD=PFTEFPTR,BC=BNE,LAB=GOON01,REG=(R4),COMPF=(RA)    02788000
         LR    RC,R5              GET PFTE WITH PAGE-I/O PEND. @D365DRP 02789000
         B     TFIXPOA0           WAIT TILL COMPL. OF I/O      @D365DRP 02790000
*                                                              @D35CDKH 02791000
GOON01   TM    S370FLG,NFRP+PFTERES RES. FOR PFIX/GETREAL/GETPT@KX41291 02792000
         BNZ   NEXTPF01           YES,BR & TRY NEXT PF         @KD40410 02793000
*                                                              @D35CDKH 02794000
         LR    R5,R4              SAVE PFTE                    @D365DRP 02795000
         TM    PFTEFLG,POABIT+PCBIT PG-OUT ACTIVE OR PF CONNECT@D35CDKH 02796000
         BNZ   NEXTPF01           YES, BR & TRY NEXT ONE       @D35CDKH 02797000
         DROP  R4                                              @D35CDKH 02798000
*                                                              @D35CDKH 02799000
TFIXEXCH LR    R5,RE              SAVE REG 14 FOR SUBROUTINE   @D35CDKH 02800000
         LR    RE,R4              LOAD SUBROUTINE REG          @D35CDKH 02801000
         L     RA,AFIXEXCH        GET ADDR OF FIXEXCHG RTN     @D52VDRP 02802000
         SGCOV SGPFIX,MC=3        EXCHANGE FROM TFIX           @D52VDRP 02803000
         BALR  RA,RA                                           @D52VDRP 02804000
*SGLINK  FIXEXCHG,INPUT=(R8:APMGMDAT,RA:LINK,RC:PFTE,RE:PFTE),         *02805000
               NOMODR=(R0-RF),OUTPUT=(),AMODE=31 DATOFF                 02806000
         LR    RC,RE              POINT TO CORRECT PFTE        @D35CDKH 02807000
         LR    RE,R5              RESTORE REG 14               @D35CDKH 02808000
         B     TFIXINCR                                        @D35CDKH 02809000
         TITLE 'DOS SUPERVISOR        SGPFIX     PAGE MANAGEMENT (PAGE *02810000
               EXCHANGE ROUTINE)'                              @D14ZDRP 02811000
*-------------------------------------------------------------*@D35CDKH 02812000
*        ROUTINE TO EXCHANGE TWO PAGES                         @D35CDKH 02813000
*        CALLED BY: PFIXPGE,TFIX,GETREAL WITH AMODE(31),DATOFF @D529DRP 02814000
*                                                              @D35CDKH 02815000
*        INPUT:                                                @D149DVB 02816000
*              RC : PTR TO PFTE OF PF THAT CONTAINS THE TO     @D35CDKH 02817000
*                   BE PFIXED PAGE(PFTE IS NOT IN PSQ)         @D35CDKH 02818000
*              RE : PTR TO PFTE OF PF USED FOR EXCHANGE        @D35CDKH 02819000
*                   (PFTE IS IN PSQ IF NFVP OFF                @D35CDKH 02820000
*                    PFTE IS NOT IN PSQ IF NFVP ON )           @D35CDKH 02821000
*              RA : RETURN REGISTER                            @D35CDKH 02822000
*                                                              @D35CDKH 02823000
*        R0-RB ARE SAVED AND RESTORED                          @D529DRP 02824000
*        RC-RF REMAIN UNCHANGED                                @D529DRP 02825000
*-------------------------------------------------------------*@D35CDKH 02826000
         SPACE 1                                               @D35CDKH 02827000
*SGLINK  FIXEXCHG,S,INPUT=(R8:APMGMDAT,RA:LINK,RC:PFTE,RE:PFTE),       *02828000
               NOMODR=(R0-RF),OUTPUT=(),AMODE=31 DATOFF                 02829000
         SPACE 1                                               @D35CDKH 02830000
FIXEXCHG DS    0H                                              @D14ZDVB 02831000
         STM   R0,RB,PMRSAVE2     SAVE REGISTERS USED IN SUBROU@D52VDRP 02832000
         L     R9,APMFIXA2        GET BASE ADDR OF ROUTINE     @D52VDRP 02833000
         LR    R0,RE              GET PFTE'S OF                @D35CDKH 02834000
         LR    R1,RC              BOTH PF'S                    @D35CDKH 02835000
         S     R0,APFT            GET BOTH                     @D35CDKH 02836000
         S     R1,APFT            PF-NUMBERS                   @D35CDKH 02837000
         SLL   R0,PFSHIFT         GET PF-ADDR OF RESERVED PF   @D35CDKH 02838000
         SLL   R1,PFSHIFT         GET PF-ADDR CONTAINING PFX PG@D35CDKH 02839000
         SPACE 1                                                        02840000
         LR    R4,R0              GET PTE CONTENT FOR PTE(RC)  @KXA0560 02841000
         LR    R6,R1              GET PTE CONTENT FOR PTE(RE)  @KXA0560 02842000
         SPACE 1                                                        02843000
**************************************************************          02844000
*     SET NEW CONTENT OF PTE'S, BLKTBE AND VTABE IF REQUIRED   @D149DRP 02845000
**************************************************************          02846000
*   HANDLING OF RESERVED FRAME (BELONGING TO RE):              @D149DRP 02847000
*     IF THE FRAME IS INVALID HANDLE ONLY ORIGINAL FRAME       @D149DRP 02848000
*      (BELONGING TO RC)                                       @D149DRP 02849000
*     IF THE FRAME CONTAINS ONLY A VIO-BLOCK, THE CORRESP.     @D149DRP 02850000
*      BLKTBE IS CHANGED AND THE ORIGINAL FRAME IS HANDLED.    @D149DRP 02851000
*     IF THE  FRAME CONTAINS A V-POOL PAGE, THE CORRESP.       @D149DRP 02852000
*      VTABE IS CHANGED.                                       @D149DRP 02853000
*         IF THE V-POOL PAGE IS ONLY CONNECTED, THE ORIGINAL   @D149DRP 02854000
*          FRAME IS HANDELED.                                  @D149DRP 02855000
*         IF THE V-POOL PAGE IS ADDRESSABLE, THE PTE OF THE    @D149DRP 02856000
*           THE RESERVED FRAME IS CHANGED AND THE ORIGINAL     @D149DRP 02857000
*           FRAME IS HANDLED.                                  @D149DRP 02858000
*     IF THE FRAME CONTAINS A PAGE NOT BELONGING TO V-POOL,    @D149DRP 02859000
*      THE PTE BELONGING TO THE FRAME IS CHANGED AND THE       @D149DRP 02860000
*      ORIGINAL FRAME IS HANDLED.                                       02861000
*                                                                       02862000
*   HANDLING OF ORIGINAL FRAME (BELONGING TO RC):              @D149DRP 02863000
*     IF THE FRAME CONTAINS ONLY A VIO-BLOCK, THE CORRESP.     @D149DRP 02864000
*      BLKTBE IS CHANGED.                                      @D149DRP 02865000
*     IF THE FRAME CONTAINS A V-POOL PAGE, THE CORRESP.        @D149DRP 02866000
*      VTABE IS CHANGED.                                       @D149DRP 02867000
*         IF THE V-POOL PAGE IS ONLY CONNECTED, --             @D149DRP 02868000
*         IF THE V-POOL PAGE IS ADDRESSABLE, THE PTE OF THE    @D149DRP 02869000
*           THE ORIGINAL FRAME IS CHANGED.                     @D149DRP 02870000
*     IF THE FRAME CONTAINS A PAGE NOT BELONGING TO V-POOL,    @D149DRP 02871000
*      THE PTE BELONGING TO THE FRAME.                         @D149DRP 02872000
**************************************************************          02873000
         SPACE 1                                               @D35CDKH 02874000
*  HANDLE RESERVED FRAME                                                02875000
         OI    SWBYTE,SPTERES+SPTEORI INITIALIZE TO NO UPDATE  @DY45878 02875114
***                               OF RESERVED AND ORIGINAL PTE          02875214
         TM    S370FLG-PFTE(RE),PNRINV PG-# INVAL IN RESVED PF @D14BDRP 02876000
         BO    EXCHPTE2           YES,---> HANDLE OTHER PFTE   @D14BDRP 02877000
         TM    S370FLG-PFTE(RE),PFTEBLK ONLY BLOCK CONN. TO FR.@D14BDRP 02878000
         BNO   EXCHPTE0           NO, BRANCH                   @D14BDRP 02879000
         SPACE 1                                                        02880000
*    SET NEW VALUE FOR BLKPAG FOR RESERVED FRAME               @D14BDRP 02881000
         SPACE 1                                               @D14ZDVB 02882000
         L     R2,PFTEPNR-PFTE(,RE) GET ...                    @D14NDVB 02883000
         N     R2,PAGNMASK        ...BLOCK#                    @D14NDFG 02884000
         SLL   R2,PNRPTOSH                                     @D51GDRP 02885000
         A     R2,VIOBLKTB        GET ADDR OF BLOCK-TABLE ENTRY@D14BDRP 02886000
         USING BLKTBE,R2                                       @D14BDRP 02887000
         TM    BLKSTAT,BLKFRCO    REALY FRAME CONNECTED TO BLK @D14BDRP 02888000
         BO    PFXDBG10           YES, BRANCH                  @D14BDRP 02889000
         BAL   R5,PMRHWERR        NO, ENTER HARD WAIT          @D14BDRP 02890000
PFXDBG10 DS    0H                                              @D14BDRP 02891000
         LR    R3,R1              BUILD  ....                  @KXA0560 02892000
         SRL   R3,8               ...  BLK -                   @KXA0560 02893000
         LA    R3,BLKFRCO(,R3)    ...  TABLE ENTRY             @KXA0560 02894000
         STCM  R3,7,BLKTBE        SET NEW BLKTBE (LEAVE PDSBIT @KXA0560 02895000
         B     EXCHPTE2           ----->  HANDLE OTHER PFTE    @D14BDRP 02896000
         DROP  R2                 FORGET BLKTBE                @D14BDRP 02897000
         SPACE 1                                                        02898000
EXCHPTE0 DS    0H                                              @D52VDRP 02899000
*        GENSERV RPTE,PFTE=(RE),RPTE=(R2),WORKR=(R3,R4,R5)     @D52VDRP 02900000
*                                 GET REAL PTE ADDR IN R2      @D52VDRP 02901000
         GENSERV RPTE,PFTE=(RE),RPTE=(R2),WORKR=(R3,R4,R5)     @D52VDRP 02902000
         L     R5,PFTESCB-PFTE(,RE) SET                        @D52VDRP 02903000
         ST    R5,PMRSCB          ..... SCB ADDR FOR CHKVPOL1  @D52VDRP 02904000
         L     R5,PFTEPNR-PFTE(,RE) GET ...                    @D52VDRP 02905000
         N     R5,PAGNMASK        ...EPA#                      @D52VDRP 02906000
         SLL   R5,PNSHIFT         EXTENDED PAGE ADDRESS        @D52VDRP 02907000
         BAL   RA,CHKVPOL1        CHECK FOR PAGE IN VPOOL      @D52VDRP 02908000
*SGLINK  CHKVPOL1,INPUT=(R5,R8,RA),OUTPUT=(R5),AMODE=31 ANY    @D52VDRP 02909000
         B     EXCHPTE1           BRANCH, PAGE NOT IN VPOOL    @D52VDRP 02910000
         SPACE 1                                               @D14NDVB 02911000
*     SET NEW VALUE FOR VTFRAM IN VTABE                        @D14BDRP 02912000
         SPACE 1                                               @D14BDVB 02913000
         USING VTABE,R5                                        @D52VDRP 02914000
         SRL   R0,PNSHIFT         GET FRAME #                  @D51GDRP 02915000
         CLM   R0,M7,VTFRAM       OLD VALUE CORRECT            @D14BDRP 02916000
         SLL   R0,PNSHIFT         GET FRAME ADDR BACK          @D51GDRP 02917000
         BE    PFXDBG11           YES, BRANCH                  @D14BDRP 02918000
         LR    RA,R5              NO, SAVE VTABE ADDRESS...    @KXA0560 02919000
         BAL   R5,PMRHWERR        ... ENTER HARD WAIT          @D14BDRP 02920000
PFXDBG11 DS    0H                                              @D14BDRP 02921000
         LR    R3,R1              COPY REGISTER                @D51GDTP 02922000
         SRL   R3,PNSHIFT         GET FRAME #                  @D51GDTP 02923000
         STCM  R3,M7,VTFRAM       SET NEW VALUE FOR VTFRAM     @D51GDTP 02924000
         DROP  R5                 DROP BASE FOR VTABE          @D52VDRP 02925000
         TM    PTESTAT-PTE(R2),PTEPGCO+PTEIBIT PAGE CONNECTED  @D14ADVB 02926000
         BO    EXCHPTE2           YES, HANDLE OTHER FRAME      @D14BDRP 02927011
EXCHPTE1 DS    0H                                              @KXA0560 02927112
         NI    SWBYTE,XFF-SPTERES HANDLE RESERVED PTE          @DY45878 02927211
         L     R4,0(,R2)          GET NEW PTE VALUE FOR ORIG.  @D51GDTP 02930000
         SPACE 1                                                        02931000
*    HANDLE ORIGINAL FRAME                                     @KXA0560 02932000
EXCHPTE2 DS    0H                                              @KXA0560 02933000
         TM    S370FLG-PFTE(RC),PNRINV PG-# INVAL IN ORIG. PF  @KXA0560 02934000
         BZ    PFXDBG12           NO, O.K.                     @KXA0560 02935000
         BAL   R5,PMRHWERR        YES, ENTER HARD WAIT         @KXA0560 02936000
PFXDBG12 DS    0H                                              @KXA0560 02937000
         TM    S370FLG-PFTE(RC),PFTEBLK ONLY BLOCK CONN. TO FR.@KXA0560 02938000
         BNO   EXCHPT20           NO, BRANCH                   @KXA0560 02939000
         SPACE 1                                                        02940000
*    SET NEW VALUE FOR BLKPAG                                  @KXA0560 02941000
         SPACE 1                                               @D14ZDVB 02942000
         L     R3,PFTEPNR-PFTE(,RC) GET ...                    @KXA0560 02943000
         N     R3,PAGNMASK        ...BLOCK#                    @KXA0560 02944000
         SLL   R3,PNRPTOSH                                     @KXA0560 02945000
         A     R3,VIOBLKTB        GET ADDR OF BLOCK-TABLE ENTRY@KXA0560 02946000
         USING BLKTBE,R3                                       @KXA0560 02947000
         TM    BLKSTAT,BLKFRCO    REALY FRAME CONNECTED TO BLK @KXA0560 02948000
         BO    PFXDBG13           YES, BRANCH                  @KXA0560 02949000
         BAL   R5,PMRHWERR        NO, ENTER HARD WAIT          @KXA0560 02950000
PFXDBG13 DS    0H                                              @KXA0560 02951000
         LR    R5,R0              BUILD  ....                  @KXA0560 02952000
         SRL   R5,8               ...  BLK -                   @KXA0560 02953000
         LA    R5,BLKFRCO(,R5)    ...  TABLE ENTRY             @KXA0560 02954000
         STCM  R5,7,BLKTBE        SET NEW BLKTBE (LEAVE PDSBIT @KXA0560 02955000
         B     EXCHPTEE           ----->  DO FINAL ACTION      @KXA0560 02956000
         DROP  R3                 FORGET BLKTBE                @KXA0560 02957000
         SPACE 1                                                        02958000
EXCHPT20 DS    0H                                              @KXA0560 02959000
*        GENSERV RPTE,PFTE=(RC),RPTE=(R3),WORKR=(R2,R4,R5)     @KXA0560 02960000
*                                 GET REAL PTE ADDR IN R3      @KXA0560 02961000
         GENSERV RPTE,PFTE=(RC),RPTE=(R3),WORKR=(R2,R4,R5)     @KXA0560 02962000
         L     R5,PFTESCB-PFTE(,RC) SET                        @KXA0560 02963000
         ST    R5,PMRSCB          ..... SCB ADDR FOR CHKVPOL1  @KXA0560 02964000
         L     R5,PFTEPNR-PFTE(,RC) GET ...                    @KXA0560 02965000
         N     R5,PAGNMASK        ...EPA#                      @KXA0560 02966000
         SLL   R5,PNSHIFT         EXTENDED PAGE ADDRESS        @KXA0560 02967000
         BAL   RA,CHKVPOL1        CHECK FOR PAGE IN VPOOL      @KXA0560 02968000
*SGLINK  CHKVPOL1,INPUT=(R5,R8,RA),OUTPUT=(R5),AMODE=31 ANY    @KXA0560 02969000
         B     EXCHPT21           BRANCH, PAGE NOT IN VPOOL    @KXA0560 02970000
         SPACE 1                                               @KXA0560 02971000
*     SET NEW VALUE FOR VTFRAM IN VTABE                        @KXA0560 02972000
         SPACE 1                                                        02973000
         USING VTABE,R5                                        @KXA0560 02974000
         SRL   R1,PNSHIFT         GET FRAME #                  @KXA0560 02975000
         CLM   R1,M7,VTFRAM       OLD VALUE CORRECT            @KXA0560 02976000
         SLL   R1,PNSHIFT         GET FRAME ADDR BACK          @KXA0560 02977000
         BE    PFXDBG14           YES, BRANCH                  @KXA0560 02978000
         LR    RA,R5              NO, SAVE VTABE ADDRESS ...   @KXA0560 02979000
         BAL   R5,PMRHWERR        ... ENTER HARD WAIT          @KXA0560 02980000
PFXDBG14 DS    0H                                              @KXA0560 02981000
         LR    RA,R0              COPY REGISTER                @KXA0560 02982000
         SRL   RA,PNSHIFT         GET FRAME #                  @KXA0560 02983000
         STCM  RA,M7,VTFRAM       SET NEW VALUE FOR VTFRAM     @KXA0560 02984000
         DROP  R5                 DROP BASE FOR VTABE          @KXA0560 02985000
         TM    PTESTAT-PTE(R3),PTEPGCO+PTEIBIT PAGE CONNECTED  @KXA0560 02986000
         BO    EXCHPTEE           YES, ---------->             @DY45878 02989013
EXCHPT21 DS    0H                                              @KXA0560 02990000
         NI    SWBYTE,XFF-SPTEORI UPDATE ORIGINAL PTE          @DY45878 02990113
         L     R6,0(,R3)          GET NEW PTE VALUE FOR RESERV.@KXA0560 02991000
         LR    R5,RC              GET ADDR OF PFTE             @D61RDRP 02992000
         BAL   RA,EXCHIPTE        DO IPTE                      @D61RDRP 02993000
*SGLINK EXCHIPTE,INPUT=(R5:PFTE,RA:LINK),WORK=(R5,R7)          @D61RDRP 02994000
EXCHPTEE TM    SWBYTE,SPTERES     RESERVED PTE TO BE CHANGED   @KXA0560 02996000
         BO    ENDEXCH            NO, ALL DONE WITH PTE'S      @DY45878 02997009
         LR    R5,RE              GET ADDR OF PFTE             @D61RDRP 02999000
         BAL   RA,EXCHIPTE        DO IPTE                      @D61RDRP 03000000
*SGLINK EXCHIPTE,INPUT=(R5:PFTE,RA:LINK),WORK=(R5,R7)          @D61RDRP 03001000
         SPACE 1                                               @KXA1851 03003000
ENDEXCH  DS    0H                                              @KXA1851 03004000
         STM   R2,R3,PMRSAVE2+12*4                             @KXA1851 03005000
         BAL   RA,FIXEXDBG        * CREATE DEBUG ENTRY         @KXA1851 03006000
         SPACE 1                                               @KXA1851 03007000
*     EXCHANGE THE CONTENTS OF THE TWO PAGE FRAMES             @KXA1851 03008000
.*    REMOVED FROM THE BEGIN OF THE ROUTINE AFTER IPTE-S       @KXA1851 03009000
.*    TO PROTECT THE STORAGE AGAINST ACCESS FROM OTHER         @KXA1851 03010000
.*    CPU-S                                                    @KXA1851 03011000
         SPACE 1                                               @KXA1851 03012000
         LR    R2,R0              SAVE BOTH                    @D35CDKH 03013000
         LR    R3,R1              PF-ADDRESSES                 @D35CDKH 03014000
         L     R5,PAGESIZE        PAGESIZE                     @KXA1851 03015000
         SRL   R5,8               PAGESIZE : 256               @KXA1851 03016000
EXCHPGS  XC    0(256,R2),0(R3)    EXCHANGE THE CONTENTS OF     @D14ZDVB 03017000
         XC    0(256,R3),0(R2)    THE TWO PAGES IN PIECES      @D35CDKH 03018000
         XC    0(256,R2),0(R3)    OF 256 BYTES                 @D35CDKH 03019000
         AH    R2,H256            INCREASE THE POINTERS        @D51GDTP 03020000
         AH    R3,H256             BY 256                      @D51GDTP 03021000
         BCT   R5,EXCHPGS         BR IF END NOT REACHED        @KXA1851 03022000
         SPACE 1                                               @D35CDKH 03023000
*     EXCHANGE THE CONTENTS OF THE KEY STORAGE                 @D35CDKH 03024000
         SPACE 1                                               @D35CDKH 03025000
         ISKE  R2,R0             GET KEY OF FIRST PAGE         @D51GDTP 03026000
         ISKE  R3,R1             GET KEY OF SECOND PAGE        @D51GDTP 03027000
         SSKE  R2,R1             SET KEY OF SECOND PAGE        @D51GDTP 03028000
         SSKE  R3,R0             SET KEY OF FIRST PAGE         @D51GDTP 03029000
         SPACE 1                                               @D35CDKH 03030000
*     EXCHANGE PTE-S                                           @KXA1851 03031000
         SPACE 1                                                        03032000
         LM    R2,R3,PMRSAVE2+12*4                             @KXA1851 03033000
         TM    SWBYTE,SPTEORI     ORIGINAL PTE TO BE CHANGED   @DY45878 03033109
         BO    EXCHMP20           NO, --->                     @DY45878 03033209
         STCM  R4,14,0(R3)        SET NEW VALUE FOR ORIG. PTE  @D51GDTP 03036000
EXCHMP20 DS    0H                                              @KXA0560 03037000
         TM    SWBYTE,SPTERES     RESERVED PTE TO BE CHANGED   @KXA0560 03038000
         BO    EXCHMP40           NO, ALL DONE WITH PTE'S      @DY45878 03039009
         STCM  R6,14,0(R2)        SET NEW VALUE FOR RES. PTE   @KXA1851 03041000
EXCHMP40 DS    0H                                              @KXA0560 03042000
         NI    SWBYTE,XFF-SPTERES-SPTEORI RESET INDICATION     @DY45878 03042109
         SPACE 1                                               @D35CDKH 03043000
*    NEW CONDITIONS ARE REFLECTED IN THE TWO PFTE'S            @D35CDKH 03044000
         SPACE 1                                               @D35CDKH 03045000
         XC    0(LPFTE,RE),0(RC)  EXCHANGE CONTENTS ...        @D51GDRP 03046000
         XC    0(LPFTE,RC),0(RE)  ...OF THE TWO                @D51GDRP 03047000
         XC    0(LPFTE,RE),0(RC)  ...PFTE'S                    @D51GDRP 03048000
         USING PFTE,RC            SET BASE FOR EXCHANGED PFTE  @D14ADVB 03049000
         TM    S370FLG,PNRINV     PF UNUSED                    @D35CDKH 03050000
         BO    EXCHPTRS           YES, BR AND EXCH. QUEUE PTRS.@D35CDKH 03051000
         TM    S370FLG,NFVP       PFTE NOT IN PSQ              @D35CDKH 03052000
         BO    EXCHNF             YES, DONT EXCH. QUEUE PTRS.  @D35CDKH 03053000
EXCHPTRS DS    0H                                              @D14ADVB 03054000
         TM    PFTEFLG,PFTEQBIT   PFTE IN PSQ                  @D52VDVB 03055000
         BO    EXCHPTOK           YES, ----> O.K.              @D61NDRP 03056000
         BAL   R5,PMRHWERR                                     @D61NDRP 03057000
EXCHPTOK DS    0H                                              @D61NDRP 03058000
         L     R2,PFTEBPTR        PRECEEDING PFTE IN PSQ       @D14ADVB 03059000
         ST    RC,PFTEFPTR-PFTE(,R2) CORRECT FPTR              @D14ADVB 03060000
         L     R2,PFTEFPTR        SUCCEEDING PFTE IN PSQ       @D14ADVB 03061000
         ST    RC,PFTEBPTR-PFTE(,R2) CORRECT BPTR              @D14ADVB 03062000
         SPACE 1                                                        03063000
*  NFRP,PFTERES-BITS IN S370FLG MUST NOT BE EXCHANGED, RESTORE @KX41291 03064000
         SPACE 1                                                        03065000
EXCHNF   IC    R2,S370FLG         GET FLAG OF 1ST PFTE         @D51GDRP 03066000
         IC    R3,S370FLG-PFTE(,RE) GET FLAG OF 2ND PFTE       @D51GDRP 03067000
         LA    R4,NFRP+PFTERES    GET MASK ...                 @KX41291 03068000
         LR    R5,R4              ...  FOR NFRP,PFTERES FLAGS  @KX41291 03069000
         NR    R4,R2              COPY NFRP,PFTERES FLAGS ...  @D14ADVB 03070000
         NR    R5,R3              ... IF ON                    @D14ADVB 03071000
         XR    R2,R4              FLAG WITHOUT ...             @D14ADVB 03072000
         XR    R3,R5              ... NFRP, PFTERES BITS       @D14ADVB 03073000
         OR    R2,R5              PROVIDE NFRP, PFTERES ...    @D14ADVB 03074000
         OR    R3,R4              ... IN ORIGINAL S370FLG      @D14ADVB 03075000
         STC   R2,S370FLG         RESTORE S370FLG              @D51GDRP 03076000
         STC   R3,S370FLG-PFTE(,RE) ... WITH ORIGINAL BITS     @D51GDRP 03077000
         SPACE 1                                                        03078000
         TM    PFTEFLG,POEBIT     ENTRY IN PAGE-OUT QUEUE      @D52VDRP 03079000
         BZ    EXCH001            NO, O.K.                     @D52VDRP 03080000
EXCH000  BAL   R5,PMRHWERR        YES, SYSTEM ERROR            @D52VDRP 03081000
         DROP  RC                 DROP BASE FOR PFTE           @D52VDRP 03082000
EXCH001  TM    PFTEFLG-PFTE(RE),POEBIT ENTRY IN PAGE-OUT QUEUE @D52VDRP 03083000
         BO    EXCH000            YES, SYSTEM ERROR            @D52VDRP 03084000
.* PGQUO HANDLING DELETED, SINCE IF POEBIT=ON, THE PFTE IS CONNECTED    03085000
.* OR PAGE OUT IS ACTIVE ON THE FRAME, THEREFORE THE PFTE CAN'T@D52VDRP 03086000
.* BE USED FOR EXCHANGE.                                       @D52VDRP 03087000
         LM    R0,RB,PMRSAVE2     RESTORE SAVED REGISTER CONT  @D52VDRP 03088000
         BR    RA                 ==========>   RETURN CALLER  @D14ZDVB 03089000
         SPACE 2                                                        03090000
*   EXCHIPTE SUBROUTINE                                        @D61RDRP 03091000
*    INPUT:                                                    @D61RDRP 03092000
*      R5 - PFTE ADDRESS BELONGING TO PAGE                     @D61RDRP 03093000
*      RA - RETURN REGISTER                                    @D61RDRP 03094000
*SGLINK EXCHIPTE,S,INPUT=(R5:PFTE,RA:LINK),WORK=(R5,R7)        @D61RDRP 03095000
         SPACE 1                                                        03096000
EXCHIPTE DS    0H                                              @D61RDRP 03097000
         L     R7,PFTESCB-PFTE(R5) GET REAL ADDR OF ...        @D61RDRP 03098000
*        GENSERV LRADBG,RREG=(R7),VADD=(R7),ERR=NADDR  ... SCB BEL. TO *03099000
                                   EPA                         @D61RDRP 03100000
         GENSERV LRADBG,RREG=(R7),VADD=(R7),ERR=NADDR          @D61RDRP 03101000
         ICM   R5,7,PFTEEPA#-PFTE(R5) GET EPA                  @D61RDRP 03102000
         SLL   R5,PNSHIFT             * OUT OF PFTE            @D61RDRP 03103000
*        GENSERV IPTE,EPA=(R5),SCB=(R7),WORKR=(R3,R4) DO IPTE  @D61RDRP 03104000
         GENSERV IPTE,EPA=(R5),SCB=(R7),WORKR=(R3,R4) DO IPTE  @D61RDRP 03105000
         BR    RA                ------> RETURN                @D61RDRP 03106000
         SPACE 2                                               @KXA1851 03107000
*-------------------------------------------------------------*@KXA1851 03108000
         DS    0F                                              @KXA1851 03109000
FIXXABEG DC    A(FIXXBEG)                                      @KXA1851 03110000
FIXXACUR DC    A(FIXXBEG)                                      @KXA1851 03111000
FIXXAEND DC    A(FIXXEND)                                      @KXA1851 03112000
         DC    A(0)                                            @KXA1851 03113000
FIXXLDBG EQU   *-FIXXABEG                                      @KXA1851 03114000
FIXXBEG  DS    0F                                              @KXA1851 03115000
         DC    100XL16'0'                                      @KXA1851 03116000
FIXXEND  DS    0H                                              @KXA1851 03117000
         SPACE 2                                               @KXA1851 03118000
FIXEXDBG DS    0H                                              @KXA1851 03119000
         L     R5,FIXXACUR                                     @KXA1851 03120000
         ST    RC,0(,R5)                                       @KXA1851 03121000
         ST    RE,4(,R5)                                       @KXA1851 03122000
         ST    R4,8(,R5)                                       @KXA1851 03123000
         ST    R6,12(,R5)                                      @KXA1851 03124000
         LA    R5,FIXXLDBG(,R5)                                @KXA1851 03125000
         ST    R5,FIXXACUR                                     @KXA1851 03126000
         CL    R5,FIXXAEND                                     @KXA1851 03127000
         BLR   RA                                              @KXA1851 03128000
         MVC   FIXXACUR,FIXXABEG                               @KXA1851 03129000
         BR    RA                                              @KXA1851 03130000
         TITLE 'DOS SUPERVISOR        SGPFIX     PAGE MANAGEMENT (TFIX/*03131000
               TFREE SUBROUTINE)'                              @D14ZDRP 03132000
         SPACE 1                                                        03133000
*-------------------------------------------------------------*         03134000
*        ROUTINE TO HANDLE PARAM-LIST ENTRIES FOR TFIX/TFREE  *         03135000
*                                                             *         03136000
*        CALLED BY:                                            @D529DRP 03137000
*              TFIX, TFREE WITH AMODE(31),DATON                @D529DRP 03138000
*        ON ENTRY VIA GETENT: (ENTRY FOR 1ST TIME INVOCATION) *         03139000
*              R1 - ADDR OF PARAMETER-LIST                    *         03140000
*              R5 - RETURN ADDR                               *         03141000
*                                                             *         03142000
*        ON ENTRY VIA GETPAGE:                                *         03143000
*              R1 - ADDR OF PAGE HANDLED                      *         03144000
*              R2 - END ADDR OF CURRENT AREA                  *         03145000
*              R3 - ADDR OF CURRENT PARAM-LIST ENTRY          *         03146000
*              R5 - RETURN ADDR                               *         03147000
*                                                             *         03148000
*        ON EXIT:                                             *         03149000
*              R1 - ADDR OF PAGE TO BE HANDLED                *         03150000
*              R2 - END ADDR OF CURRENT AREA                  *         03151000
*              R3 - ADDR OF CURRENT PARAM-LIST ENTRY          *         03152000
*              R5 - RETURN ADDR                               *         03153000
*-------------------------------------------------------------*         03154000
         SPACE 1                                                        03155000
GETENT   LR    R3,R1              ADDR OF PARAMETER LIST                03156000
GETENT0  DS    0H                                              @D14BDRP 03157000
         USING TFIXLSTE,R3        SET BASE FOR LIST ENTRY               03158000
         L     R1,TFIXBEG         GET BEGIN ADDR OF AREA       @D52VDVB 03159000
         N     R1,PADDRMSK        SET ADDR TO PG BOUND         @D35CDKH 03160000
         BZR   R5                 EOL  ==========>  RETURN     @D149DVB 03161000
         L     R2,TFIXEND         GET END ADDR OF AREA         @D52VDVB 03162000
         CLR   R1,R2              BEGADR>ENDADR                         03163000
         BNH   4(,R5)             NO   ==========>  RETURN     @D14ZDVB 03164000
         B     GETENT1            YES, IGNORE THIS ENTRY                03165000
         SPACE 1                                               @D14ADVB 03166000
GETPAGE  CLR   R1,R2              LAST PAGE OF AREA HANDLED             03167000
         BE    GETENT1            YES, GET NEXT ENTRY                   03168000
         AL    R1,PAGESIZE        GET ADDR NEXT PAGE           @D14NDVB 03169000
         CLR   R1,R2              LAST PAGE OF AREA HANDLED    @D51GDTP 03170000
         BNH   4(,R5)             ==========> NO,   RETURN     @D51GDTP 03171000
GETENT1  LA    R3,L'TFIXENT(R3)   POINT TO NEXT ENTRY                   03172000
         B     GETENT0            HANDLE NEXT ENTRY            @D52VDRP 03173000
         DROP  R3                 FORGET BASE FOR PARAM-LIST ENTRY      03174000
         DROP  R8,R9              FORGET BASE FOR DATA AND CODE@D36ZDRP 03175000
         TITLE 'DOS SUPERVISOR        SGPFIX     PAGE MANAGEMENT (TFREE*03176000
                ROUTINE)'                                      @D14ZDRP 03177000
*-------------------------------------------------------------*@D149DVB 03178000
*        ROUTINE PROLOGUE                                      @D149DVB 03179000
*        ROUTINE NAME: TFREE                                   @D149DVB 03180000
*        MACRO:        SGPFIX                                  @D149DVB 03181000
*        FUNCTION: FREES THE TEMPORARILY FIXED PAGES, SPECIFIED@D149DVB 03182000
*                  BY THE PARAMETER LIST.                      @D149DVB 03183000
*        ENTRY POINTS:                                         @D149DVB 03184000
*              TFREE       CALLED BY SGERP,SVC44,TFIX                   03185000
*                                 WITH AMODE(31),DATON         @D529DRP 03186000
*              TFREEPHS    CALLED BY FETCH, DIRECTORY-TASK     @D149DVB 03187000
*                                 WITH AMODE(31),DATON         @D529DRP 03188000
*              TFREECCW    CALLED BY CCWTRANSLATION            @D149DVB 03189000
*                                 WITH AMODE(31),DATON         @D529DRP 03190000
*                                                              @D149DVB 03191000
*        CALLING SEQUENCE:                                     @D149DVB 03192000
*              L       R8,APMGDAT                              @D529DRP 03193000
*              L       R7,ATFREE/ATFREEPH/ATFRECCW             @D529DRP 03194000
*              AMODESW CALL,REGS=(R7,R7)                       @D529DRP 03195000
*        CALLED ROUTINES                                       @D149DVB 03196000
*              PMRINSBT, POSTPFQ, FREEFRAM, GETENT/GETPAGE,    @D149DVB 03197000
*              TFNFVPON, TFNFRPON  WITH AMODE(31),DATOFF       @D149DVB 03198000
*        INPUT:                                                @D149DVB 03199000
*           IF ENTERED IN TFREE OR TFREEPHS                    @D149DVB 03200000
*              R1 : ADDR (LIST(PARM)                           @D149DVB 03201000
*                   PARM  = (ADDRESS(1ST PAGE),                @D52VDVB 03202000
*                            ADDRESS(LST PAGE)                 @D52VDVB 03203000
*                            TO BE TFIXED)                     @D51ZDRP 03204000
*                   PARM  = (A(0),NIL) INDICATES END OF LIST   @D52VDRP 03205000
*              R7 : RETURN ADDRESS                             @D149DVB 03206000
*              R8 : ADDRESS OF THE PAGE-MANAGEMENT DATA AREA   @D149DVB 03207000
*              IF CALLED FROM FETCH EACH ENTRY OF THE PARM_LIST@D149DVB 03208000
*              SPECIFIES ONLY ONE PAGE.                        @D149DVB 03209000
*           IF ENTERED IN TFREECCW                             @D149DVB 03210000
*              R1 : PAGE FRAME # TO BE TFREED                  @D149DVB 03211000
*              R7 : RETURN ADDRESS                             @D149DVB 03212000
*              R8 : ADDRESS OF THE PAGE-MANAGEMENT DATA AREA   @D149DVB 03213000
*                                                              @D149DVB 03214000
*        OUTPUT:                                               @D149DVB 03215000
*              ALL PAGES SPECIFIED ARE TFREED                  @D149DVB 03216000
*              ALL REGISTERS ARE UNCHANGED, EXCEPT R0          @D149DVB 03217000
*                                                              @D149DVB 03218000
*        EXIT NORMAL:                                          @D149DVB 03219000
*          RETURN TO CALLER AMODE(CALLER),DATON                @D149DVB 03220000
*          CONDITION: FUNCTION COMPLETED                       @D149DVB 03221000
*          OUTPUT:  AS DESCRIBED ABOVE                         @D149DVB 03222000
*          RETURN CODE: NONE                                   @D149DVB 03223000
*        EXIT ERROR:  NONE                                     @D149DVB 03224000
*                                                              @D149DVB 03225000
*        EXTERNAL REFERENCES:                                  @D149DVB 03226000
*               NPSQE(READ,WRITE) # OF PSQ-ENTRIES + FFCC      @D149DVB 03227000
*               PSQ(READ,WRITE)  PAGE SELECTION QUEUE          @D149DVB 03228000
*               PFTE.TFIXC(READ,WRITE)                         @D149DVB 03229000
*               PFTE.TFIXP(READ)                               @D149DVB 03230000
*               PTE.PTESTAT(READ,WRITE)                        @D149DVB 03231000
*               MINPSQE(READ)  MINIMUM VALUE OF NPSQE          @D149DVB 03232000
*                                                              @D149DVB 03233000
*        NOTE: 1. THE PARM_LIST MUST BE IN FIXED STORAGE-AREA. @D149DVB 03234000
*              2. EACH REQUESTOR OF TFIX HAS TO DECREASE THE   @D149DVB 03235000
*                 HALFWORD TFIXIDEN BY ONE                     @D149DVB 03236000
*        ATTRIBUTES:                                           @D149DVB 03237000
*               DISABLED AND NOT REENTERABLE                   @D149DVB 03238000
*                                                              @D149DVB 03239000
*        OPERATION:                                            @D149DVB 03240000
*                                                              @D149DVB 03241000
*        TFREECCW:                        /* E N T R Y  P T  */@D149DVB 03242000
*        ADDR_PF(PF#)                     /*GET FRAME ADDRESS*/@D149DVB 03243000
*        ADDR_PSQ_HEADER                  /* ADDR(PSQ HEADER)*/@D149DVB 03244000
*        GOTO TFREE005                                         @D149DVB 03245000
*                                                              @D149DVB 03246000
*        TFREEPHS:                        /* E N T R Y  P T  */@D149DVB 03247000
*        SUPVFLAG := TFREEPH              /* CALLED BY FETCH */@D149DVB 03248000
*        ADDR_PSQ      /* FIND PFTE WHERE TO INSERT TFREED   */@D149DVB 03249000
*                      /* PFTE(S)  .... F(PGQUO = 0 OR NOT)  */@D149DVB 03250000
*        GOTO TFREECNT                                         @D149DVB 03251000
*                                                              @D149DVB 03252000
*        TFREE:                           /* E N T R Y  P T  */@D149DVB 03253000
*        ADDR_PSQ_HEADER                  /* ADDR(PSQ HEADER)*/@D149DVB 03254000
*        TFREECNT:                                             @D149DVB 03255000
*        CALL GETENT(PARM)                /* PAGE TO BE FREED*/@D149DVB 03256000
*        DO WHILE ¬EOL(PARM)              /*                 */@D149DVB 03257000
*           ADDR_PF(PAGE)                 /*REAL ADDR (L R A)*/@D149DVB 03258000
*        TFREE005:                                             @D149DVB 03259000
*           ADDR-PFTE(PF)                 /*  PFTE ADDR      */@D149DVB 03260000
*           DECREASE PFTE.TFIXC           /*DECREASE TFIX CNT*/@D149DVB 03261000
*           IF PFTE.TFIXC < 0                                  @D149DVB 03262000
*              THEN EXIT (HW = X'FF5')    /* ====> HARDWAIT  */@D149DVB 03263000
*           IF PFTE.TFIXC = 0                                  @D149DVB 03264000
*              THEN DO                                         @D149DVB 03265000
*              IF PFTE.NFRP = ON          /*TASKS WAITG ON PF*/@D149DVB 03266000
*                 THEN CALL TFNFRPON (PFTE)                    @D149DVB 03267000
*              IF PFTE.NFVP = ON          /*TASKS WAITG ON PG*/@D149DVB 03268000
*                 THEN DO                                      @D149DVB 03269000
*                 CALL TFNFVPON (PFTE)                         @D149DVB 03270000
*                 LEAVE (THEN DO)         /* LEAVE THEN DO CD*/@D149DVB 03271000
*                 END                                          @D149DVB 03272000
*              IF PFTE.NFRP = OFF                              @D149DVB 03273000
*                 THEN INCREASE NPSQUE                         @D149DVB 03274000
*              IF SUPVFLAG = TFEEPH       /* CALLED BY FETCH */@D149DVB 03275000
*                 THEN RESET_REF_BIT      /* RESET REF. BIT  */@D149DVB 03276000
*              CALL PMRINSBT              /*INSERT PFTE ->PSQ*/@D149DVB 03277000
*              END                                             @D149DVB 03278000
*           IF TFREECCW_FUNCTION        /*CALLED VIA TFREECCW*/@D149DVB 03279000
*              THEN LEAVE (DO_WHILE)      /* EXIT DO WIHLE LP*/@D149DVB 03280000
*           CALL GETPAGE (PARM_LIST)      /* ADDR NEXT PAGE  */@D149DVB 03281000
*        END (DO WHILE)                                        @D149DVB 03282000
*        TFREXIT:                                              @D149DVB 03283000
*        IF NPSQE > MINPSQE                                    @D149DVB 03284000
*           THEN CALL POSTPFQ             /* POST WAITNG TASK*/@D149DVB 03285000
*        RETURN                           /* =====>  RETURN  */@D149DVB 03286000
*        END (TFREE) ;                                         @D149DVB 03287000
*-------------------------------------------------------------*@D149DVB 03288000
*        TFNFRPON:                        /* E N T R Y  P T  */@D149DVB 03289000
*        ADDR_SYSPCB                      /* ADDR SYSTEM PCB */@D149DVB 03290000
*        IF ADDR_PG > SMCSSEND            /* PAGE FOR SDAIDS */@D149DVB 03291000
*           THEN DO                                            @D149DVB 03292000
*           UNTIL ADDR_PG > PCB.SMRPEND                        @D149DVB 03293000
*              NEXT_PCB                   /*   NEXT   PCB    */@D149DVB 03294000
*           END                                                @D149DVB 03295000
*        CALL FREEFRAM(PFTE,PCB)                               @D149DVB 03296000
*        RETURN                           /* =====>  RETURN  */@D149DVB 03297000
*        END (TFNFRPON) ;                                      @D149DVB 03298000
*-------------------------------------------------------------*@D149DVB 03299000
*        TFNFVPON:                        /* E N T R Y  P T  */@D149DVB 03300000
*        ADDR_PCB (PIB(PFTE.PFTEWID))     /*     ADDR PCB    */@D149DVB 03301000
*        ADDR_TIB := PCB.FIXTIB           /*TIB OF WAITNG TSK*/@D149DVB 03302000
*        IF TIB.TIBRQID = PGFXBND         /*TASK STILL WAITNG*/@D149DVB 03303000
*           THEN CALL POST(TIB)           /* POST WAITNG TASK*/@D149DVB 03304000
*        RETURN                           /* =====>  RETURN  */@D149DVB 03305000
*        END (TFNFVPON) ;                                      @D149DVB 03306000
*-------------------------------------------------------------*@D149DVB 03307000
*        INTERNAL USAGE OF REGISTERS                           @D149DVB 03308000
*              R1 - ADDR(PAGE) TO BE TFREED IF ENTRY FROM TFREE@D149DVB 03309000
*                 - PF# IF ENTRY FROM TFREECCW                 @D149DVB 03310000
*              R2 - END ADDR OF CURRENT AREA                   @D149DVB 03311000
*              R3 - ADDR OF CURRENT PARAM-LIST ENTRY           @D149DVB 03312000
*              R4 - WORK REGISTER                              @D149DVB 03313000
*              R5 - WORKREGISTER AND LINKREGISTER              @D149DVB 03314000
*              R7 - RETURN ADDR                                @D149DVB 03315000
*              RA - LINK REGISTER TO NEXT LEVEL                @D149DVB 03316000
*              RB - ADDR OF PFTE AHEAD OF WHICH THE PFTE       @D149DVB 03317000
*                   HAS TO BE INSERTED                         @D149DVB 03318000
*              RC - ADDR OF PFTE CORRESP. TO R1                @D149DVB 03319000
*              RD - PF - ADDRESS                               @D149DVB 03320000
*              RE,RF - WORK REGISTER USED BY POST RTN          @D149DVB 03321000
*                                                              @D149DVB 03322000
*-------------------------------------------------------------*@D149DVB 03323000
         SPACE 1                                                        03324000
         USING PMGMDATA,R8        SET BASE FOR DATA-AREA                03325000
TFREECCW DS    0H                 ENTRY FROM CCW TRANSL        @D35CDKH 03326000
         SLR   R0,R0                                           @D14ZDVB 03327000
         STM   R1,RF,PMRSAVE      SAVE CALLERS REG'S           @D35CDKH 03328000
         L     R9,APMFIXA2        GET BASE FOR CODE            @D35CDKH 03329000
         USING PMFIXAD2,R9        SET BASE FOR CODE            @D35CDKH 03330000
         LR    RC,R1              MOVE IT TO CORRECT REG       @D35CDKH 03331000
         SLL   RC,PNPFTESH        GET PF ADDRESS               @D35CDKH 03332000
         LR    RD,R1                                           @D35CDKH 03333000
         SLL   RD,PNSHIFT                                      @D35CDKH 03334000
*        AMODESW SET,DAT=OFF      ENTER REAL MODE (DAT=OFF)    @D52VDRP 03335000
         AMODESW SET,DAT=OFF                                   @D52VDRP 03336000
         L     RB,PSQPTR          LOAD PSQ HEADER              @D35CDKH 03337000
         B     TFREE005                                        @D35CDKH 03338000
         DROP  R9                                              @D35CDKH 03339000
         SPACE 1                                               @D35CDKH 03340000
TFREEPHS STM   R1,RF,PMRSAVE      SAVE CALLERS REGS            @D35CDKH 03341000
         L     R9,APMFIXA2        GET BASE FOR CODE-AREA                03342000
         USING PMFIXAD2,R9        SET BASE FOR CODE-AREA                03343000
         OI    SUPVFLAG,TFREEPH   INDICATE REQUEST FROM FETCH  @D14BDRP 03344000
*                                 TO FREE USER AREA            @D365DRP 03345000
*        AMODESW SET,DAT=OFF      ENTER REAL MODE (DAT=OFF)    @D52VDRP 03346000
         AMODESW SET,DAT=OFF                                   @D52VDRP 03347000
         L     RB,PSQPTR          GET ADDR OF PSQ-HEADER                03348000
         USING PFTE,RB                                         @D365DRP 03349000
         L     R5,SCANCUR                                      @D52VDVB 03350000
         CLI   PGQOCNT+1,PGQOMAX  PAGE-OUT-QUEUE EMPTY         @D14BDRP 03351000
         BE    TFREE00X           YES, BRANCH                  @D14BDRP 03352000
         L     R5,SCANMAX         GET LARGER VALUE             @D52VDVB 03353000
*  GET PFTE AHEAD OF WHICH THE FREED PFTE'S HAVE TO BE INSERTED@D369DRP 03354000
TFREE00X L     RB,PFTEFPTR        GET NEXT ENTRY               @D365DRP 03355000
         BCT   R5,TFREE00X                                     @D365DRP 03356000
*        AMODESW SET,DAT=ON       ENTER VIRTUAL MODE (DAT=ON)  @D52VDRP 03357000
         AMODESW SET,DAT=ON                                    @D52VDRP 03358000
         B     TFREECNT                                        @D365DRP 03359000
         DROP  R9,RB                                           @D365DRP 03360000
         SPACE 1                                               @D35CDKH 03361000
TFREE    STM   R1,RF,PMRSAVE      SAVE CALLERS REGS            @D35CDKH 03362000
         LA    R0,1               INDICATE TFREE REQUEST       @D52VDRP 03363000
         L     R9,APMFIXA2        GET BASE FOR CODE-AREA                03364000
         USING PMFIXAD2,R9        SET BASE FOR CODE-AREA                03365000
         L     RB,PSQPTR          GET ADDR OF PSQ-HEADER                03366000
TFREECNT BAL   R5,GETENT          GET 1ST PAGE TO BE TFREED    @D14BDVB 03367000
         B     TFREXIT            END OF LIST REACHED, RETURN           03368000
         B     TFREE00                                                  03369000
TFREELP  EQU   *                                               @D35CDKH 03370000
         LTR   R0,R0              REQUEST FOM CCW TRANSL       @D35CDKH 03371000
         BZ    TFREXIT            YES, BRANCH                  @D35CDKH 03372000
*        AMODESW SET,DAT=ON       ENTER VIRTUAL MODE (DAT=ON)  @D52VDRP 03373000
         AMODESW SET,DAT=ON                                    @D52VDRP 03374000
         BAL   R5,GETPAGE         GET NEXT PAGE TO BE FREED    @D35CDKH 03375000
         B     TFREXIT            END OF LIST REACHED, RETURN           03376000
TFREE00  EQU   *                                                        03377000
*        AMODESW SET,DAT=OFF      ENTER REAL MODE (DAT=OFF)    @D52VDRP 03378000
         AMODESW SET,DAT=OFF                                   @D52VDRP 03379000
*        GENSERV LRADBG,RREG=(RC),VADD=(R1),ERR=NADDR          @D52VDRP 03380000
*                             GET PAGE FRAME ADDRESS IN RC     @D52VDRP 03381000
         GENSERV LRADBG,RREG=(RC),VADD=(R1),ERR=NADDR          @D52VDRP 03382000
         LR    RD,RC              SAVE PF-ADDRESS              @D35CDKH 03383000
         SRL   RC,PFSHIFT                                      @D35CDKH 03384000
TFREE005 EQU   *                                               @D35CDKH 03385000
         A     RC,APFT            PFTE                                  03386000
         USING PFTE,RC                                                  03387000
*     CHECK WHETHER PAGEFRAME IS TFIXED                        @D52VDVB 03388000
*        GENSERV DECTEST,FIELD=TFIXC,REG=(5),BC=BP,LAB=TFREELP @D52VDVB 03389000
         GENSERV DECTEST,FIELD=TFIXC,REG=(5),BC=BP,LAB=TFREELP @D52VDVB 03390000
         BZ    TFREE020           PAGE TFIXED                  @D52VDVB 03391000
         BALR  R5,0                                            @D52VDVB 03392000
         B     TFREWTF5           NOT TFIXED, ==========> HW   @D52VBVB 03393000
TFREE020 DS    0H                                              @D52VDVB 03394000
*     IF FRAME STILL PFIXED, HANDLE NEXT ENTRY                 @D52VDVB 03395000
*        GENSERV TEST,FIELD=PFIXC,REG=(R5),BC=BP,LAB=TFREELP   @D52VDVB 03396000
         GENSERV TEST,FIELD=PFIXC,REG=(R5),BC=BP,LAB=TFREELP   @D52VDVB 03397000
         TM    S370FLG,NFRP+NFVP  ANY TASKS WAITG FOR PG OR FR @KXA0560 03398000
         BNZ   TFREE050           YES ---->                    @D14NDVB 03399000
         SPACE 1                                               @D52VDVB 03400000
         TM    S370FLG,PFTERES    FRAME RESERVED BY GETPT      @KX41291 03401000
         BO    TFREE070           YES, DON'T USE FOR OTHER     @KX41291 03402000
         L     R5,IJBSMCOM                                     @D52VDVB 03403000
         USING SMCOM,R5                                        @D52VDVB 03404000
         CL    RD,SMCRBG1         FRAME IN 24/31 BIT PFIX AREA @D52VDVB 03405000
         BL    TFREE070           NO ---------->               @D52VDVB 03406000
         CL    RD,SMCRND1         FRAME IN 24 BIT PFIX AREA    @D52VDVB 03407000
         BH    TFREE040           NO ---------->               @D52VDVB 03408000
         DROP  R5                                              @D52VDVB 03409000
         TM    PMRPXFLG,PMRPXLOB WAITING TASK FOR FRAME IN             *03410000
                                  24 BIT PFIX AREA             @D52VDVB 03411000
         BZ    TFREE070           NO ---------->               @D52VDVB 03412000
         OI    S370FLG,NFRP                                    @D52VDVB 03413000
         NI    PMRPXFLG,XFF-PMRPXLOB RESET INDICATION          @D52VDVB 03414000
         ST    RC,PMRPXLOP        SAVE PFTE                    @D52VDVB 03415000
         L     R5,ASRQTAB                                      @D61RDRP 03416000
         LA    R5,SRQPXLO-SRQTAB(,R5) RSRC 24 BIT PFIX AREA    @D61RDRP 03417000
         BAL   RA,POSTPXFR        POST WAITING TASK            @D52VDVB 03418000
         B     TFREE080           ---------->                  @KD40070 03419000
         SPACE 1                                               @D52VDVB 03420000
TFREE040 DS    0H                                              @D52VDVB 03421000
         USING SMCOM,R5                                        @D52VDVB 03422000
         CL    RD,SMCRBG3         FRAME IN 31 BIT PFIX AREA    @D52VDVB 03423000
         BL    TFREE070           NO ---------->               @D52VDVB 03424000
         CL    RD,SMCRND3         FRAME IN 31 BIT PFIX AREA    @D52VDVB 03425000
         BH    TFREE070           NO ---------->               @D52VDVB 03426000
         DROP  R5                                              @D52VDVB 03427000
         TM    PMRPXFLG,PMRPXHIB WAITING TASK   FOR FRAME IN           *03428000
                                  31 BIT PFIX AREA             @D52VDVB 03429000
         BZ    TFREE070           NO ---------->               @D52VDVB 03430000
         OI    S370FLG,NFRP                                    @D52VDVB 03431000
         NI    PMRPXFLG,XFF-PMRPXHIB RESET INDICATION          @D52VDVB 03432000
         ST    RC,PMRPXHIP        SAVE PFTE                    @D52VDVB 03433000
         L     R5,ASRQTAB                                      @D61RDRP 03434000
         LA    R5,SRQPXHI-SRQTAB(,R5) RSRC 31 BIT PFIX AREA    @D61RDRP 03435000
         BAL   RA,POSTPXFR        POST WAITING TASK            @D52VDVB 03436000
         B     TFREE080           ---------->                  @KD40070 03437000
         SPACE 1                                               @D14NDVB 03438000
TFREE050 TM    S370FLG,NFVP       ANY TASKS WAITG FOR FREE PG  @D14NDVB 03439000
         BZ    TFREE060           NO ----->                    @D14NDVB 03440000
         BAL   RA,TFNFVPON        POST TASKS                   @D14NDVB 03441000
         TM    S370FLG,NFRP       ANY TSK WAITING FOR FREE PF  @D35CDKH 03442000
         BZ    TFREELP            NO ----->                    @D14NDVB 03443000
TFREE060 BAL   RE,TFNFRPON        FREE FRAMES AND POST TASKS   @D14NDVB 03444000
         TM    S370FLG,NFVP       PAGE IN PF REQUESTED BY PFIX @D35CDKH 03445000
         BO    TFREELP            YES BR (LEAVE PF OUT OF PSQ) @D14NDVB 03446000
*                                 NO, INSERT PF IN PSQ , DON'T         *03447000
                                  INCREASE NPSQE               @K14NDVB 03448000
         B     TFREE080                                        @KD40070 03449000
         SPACE 1                                                        03450000
TFREE070 DS    0H                                              @KD40070 03451000
*        GENSERV INC,FIELD=NPSQE,REG=(5)  INCREASE NPSQE       @KD40070 03452000
         GENSERV INC,FIELD=NPSQE,REG=(5)                       @KD40070 03453000
TFREE080 TM    SUPVFLAG,TFREEPH   USER AREA TO BE FREED BY FTCH@D52VDVB 03454000
         BNO   TFREE100           NO, BRANCH                   @D365DRP 03455000
         RRBE  0,RD               RESET REFERENCE BIT          @D51GDTP 03456000
         BC    5,TFREE100         BRANCH IF C-BIT ON           @KD40295 03457000
         STM   R0,RF,PMRSVDBG     SAVE ALL REGISTERS           @KD40295 03458000
         LM    R0,R7,PFTEPNR      GET PFTE IN REGISTERS 0-7    @KD40295 03459000
         L     RF,PMRDCBOF        INDICATE CHANGE BIT OFF      @KD40295 03460000
         DEBUG ALLREGS,XXDBGMC    * CREATE DEBUG ENTRY         @KD40295 03461000
         LM    R0,RF,PMRSVDBG     RESTORE REGISTERS            @KD40295 03462000
TFREE100 BAL   RA,PMRINSBT        INSERT PFTE ON BOTTOM OF PSQ          03463000
*SGLINK  PMRINSBT,INPUT=(R8,RA,RB,RC),WORK=(R4,R5),AMODE=31 DATOFF      03464000
         B     TFREELP            HANDLE NEXT PAGE                      03465000
         SPACE 1                                                        03466000
TFREXIT  CLC   NPSQE,MINPSQE      NPSQE > MINPSQE                       03467000
         BNH   TFREXIT1           NO, DON'T POST TASKS                  03468000
         L     R9,APMFIXAD        GET BASE FOR SUBRTN          @D52VDRP 03469000
         USING PMFIXADR,R9        SET BASE                     @D52VDRP 03470000
         BAL   RA,POSTPFQ         POST TASKS WAITING FOR PF'S  @D36IDFG 03471000
         DROP  R9                 DROP BASE FOR CODE           @D52VDRP 03472000
TFREXIT1 DS    0H                                              @D52VDRP 03473000
*        AMODESW SET,DAT=ON       ENTER VIRTUAL MODE (DAT=ON)  @D52VDRP 03474000
         AMODESW SET,DAT=ON                                    @D52VDRP 03475000
*                                 ENTER VIRTUAL MODE (DAT=ON)  @D52VDRP 03476000
         LM    R1,RF,PMRSAVE      RESTORE CALLERS REG. /370-MOD@D35CDKH 03477000
         NI    SUPVFLAG,XFF-TFREEPH  RESET INDICATION          @D14BDRP 03478000
*        AMODESW RETURN,REG=(R7)  RETURN                       @D52VDRP 03479000
         AMODESW RETURN,REG=(R7)  ==========> RETURN           @D52VDRP 03480000
*                                 RETURN ==========>           @D149DVB 03481000
         EJECT                                                 @D14NDVB 03482000
         USING PMFIXAD2,R9        SET BASE FOR CODE AREA       @D52VDRP 03483000
         SPACE 1                                               @D52VDVB 03484000
POSTPXFR DS    0H                                              @D52VDVB 03485000
*        AMODESW SET,DAT=ON       ENTER VIRTUAL MODE (DAT=ON)  @D52VDRP 03486000
         AMODESW SET,DAT=ON                                    @D52VDRP 03487000
         LR    R4,R6              SAVE REGISTER                @D52VDVB 03488000
         L     R6,DISPAD          MAKE DISPATCHER ADDRESSABLE  @D52VDVB 03489000
         USING DISP,R6                                         @D52VDVB 03490000
         BAL   RF,RPOST           POST WAITING TASK            @D52VDVB 03491000
*SGLINK  POST,INPUT=(R5,R6,RF),WORK=(R5,RE)                    @D52VDVB 03492000
         DROP  R6                                              @D52VDVB 03493000
         LR    R6,R4              RESTORE REGISTER             @D52VDVB 03494000
*        AMODESW SET,DAT=OFF      ENTER REAL MODE (DAT=OFF)    @D52VDVB 03495000
         AMODESW SET,DAT=OFF                                   @D52VDVB 03496000
         BR    RA                 ==========>  RETURN          @D52NDVB 03497000
         EJECT                                                 @D52VDVB 03498000
TFNFVPON DS    0H                                              @D51GDRP 03499000
         LH    R4,PFTEPIK         GET PIK OF WAITING TASK PART.@D35CDKH 03500000
         DROP  RC                 DROP BASE FOR PFTE (REAL), RC HAS    *03501000
                                  STILL TO CONTAIN REAL ADDR.  @D52VDRP 03502000
*        AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @D52VDRP 03503000
         AMODESW SET,DAT=ON                                    @D52VDRP 03504000
*        GENSERV GETPCB,PIK=(R4),PCB=(R4) GET PCB ADDR IN R4   @D52VDRP 03505000
         GENSERV GETPCB,PIK=(R4),PCB=(R4) GET PCB ADDR IN R4   @D52VDRP 03506000
         USING PCBADR,R4          BASE FOR PCB                 @D36IDRP 03507000
         L     R8,FIXTIB          GET TIB OF WAITING TASK      @D36IDFG 03508000
         DROP  R4                 FORGET PCB                   @D35CDKH 03509000
         DROP  R8                                              @D14BDVB 03510000
         USING TIBADR,R8          TASK STILL...                @D14BDVB 03511000
         CLI   TIBRQID,PGFXBND    ... WAITING FOR TFREED PFTE  @D14BDVB 03512000
         BNE   NFVP100            NO -->  ALREADY POSTED BUT NOT YET.. *03513000
                                  ... ACTIVATED AND PFTE TFIXED@D14BDVB 03514000
*                                 ... ONCE MORE IN BETWEEN     @D14BDVB 03515000
         DROP  R8                                              @D14BDVB 03516000
         LR    R4,R6              SAVE REGISTER                @D14BDRP 03517000
         L     R6,DISPAD          MAKE DISPATCHER ADDRESSABLE  @D36IDFG 03518000
         USING DISP,R6                                         @D36IDFG 03519000
         BAL   RF,POST            POST WAITING TASK            @D36IDFG 03520000
*SGLINK  POST,INPUT=(R6,R8,RF),WORK=(RE)                       @D369DRP 03521000
         DROP  R6                                              @D36IDFG 03522000
         LR    R6,R4              RESTORE REGISTER             @D14BDRP 03523000
NFVP100  L     R8,APMGMDAT        RESTORE BASE OF PMR DATA     @D14BDVB 03524000
         USING PMGMDATA,R8                                     @D14BDVB 03525000
*        AMODESW SET,DAT=OFF      ENTER REAL MODE (DAT=OFF)    @D52VDRP 03526000
         AMODESW SET,DAT=OFF                                   @D52VDRP 03527000
         BR    RA                 ==========>  RETURN          @D14NDVB 03528000
         EJECT                                                 @D14NDVB 03529000
*    RC HAS TO CONTAIN REAL ADDRESS OF PFTE                    @D52VDRP 03530000
*    RD HAS TO CONTAIN ADDR OF CORRESPONDING FRAME             @D52VDRP 03531000
TFNFRPON L     R5,ASYSPCB         POINT TO SYSTEM PCB          @D14NDVB 03532000
*        AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @D52VDRP 03533000
         AMODESW SET,DAT=ON                                    @D52VDRP 03534000
         L     R4,IJBSMCOM        STOR. MANAGMNT COMM. AREA    @D51GDRP 03535000
         C     RD,SMCSSEND-SMCOM(R4) WITHIN SDAID OR SYST. AREA@D51GDRP 03536000
         BNH   NFRPON20           YES                          @D51GDRP 03537000
         L     R4,ASCBATAB        POINT TO SCB ADDRESS TABLE   @D14NDFG 03538000
         L     R4,ASCBR-SCBATAB(,R4) POINT TO SCBR             @D14NDFG 03539000
         LA    R4,SCBPSTR-SCBADR(,R4) POINT TO PARTITION STRING@D14NDFG 03540000
NFRPON10 LH    R5,0(,R4)          GET NEXT PIK                 @D14NDFG 03541000
*        GENSERV GETPCB,PIK=(R5),PCB=(R5) GET PCB ADDR IN R5   @D52VDRP 03542000
         GENSERV GETPCB,PIK=(R5),PCB=(R5) GET PCB ADDR IN R5   @D52VDRP 03543000
         USING PCBADR,R5                                       @D14NDFG 03544000
         C     RD,SMRPBEG         WITHIN REAL PARTITION        @KX41291 03545000
         BL    NFRPON15           NO, CHECK NEXT ONE           @KX41291 03546000
         C     RD,SMRPEND         WITHIN REAL PARTITION        @D14NDFG 03547000
         BL    NFRPON20           YES, POST TASKS              @D14NDFG 03548000
         C     R5,ASYSPCB         SYSTEM AREA CHECKED          @KX41291 03549000
         BE    NFRPON20           YES, POST TASK REQUESTING FRAMES     *03550000
                                       FOR PMR-TABLES (GETPT)  @KX41291 03551000
NFRPON15 LA    R4,2(,R4)          POINT TO NEXT PIK            @D14NDFG 03552000
         B     NFRPON10           CHECK NEXT PARTITION         @D14NDFG 03553000
NFRPON20 DS    0H                                              @D52VDRP 03554000
         LH    R5,PCEPIK          GET RELATED PIK              @DY44241 03555000
         DROP  R5                                              @DY44241 03556000
*        AMODESW SET,DAT=OFF      ENTER REAL MODE (DAT=OFF)    @D52VDRP 03557000
         AMODESW SET,DAT=OFF                                   @D52VDRP 03558000
         BAL   RA,FREEFRAM        POST TASK WAITING F FREE FRM @D14NDFG 03559000
         BR    RE                 ==========>                  @D14NDVB 03560000
         EJECT                                                 @D35CDKH 03561000
*-------------------------------------------------------------*@D35CDKH 03562000
*        FREEFRAM - ROUTINE                                    @D35CDKH 03563000
*                   POSTS TASK WAITING FOR THE FREED FRAME     @D35CDKH 03564000
*                   AND RESETS NFRP-BITS IN THE REAL PARTI-    @D35CDKH 03565000
*                   TION IF NECESSARY                          @D35CDKH 03566000
*        CALLED BY PFREE, TFNFRPON WITH AMODE(31),DATOFF       @D35CDKH 03567000
*        CALLS: POST WITH AMODE(31),DATON                      @D529DRP 03568000
*                                                              @D35CDKH 03569000
*        INPUT : RC - ADDR TO PFTE OF FREED PAGE FRAME         @D35CDKH 03570000
*                R5 - PIK OF TASK TO BE POSTED                 @DY44241 03571000
*                RA - RETURN ADDRESS                           @D35CDKH 03572000
*                                                              @D149DVB 03573000
*        FREEFRAM:                        /* E N T R Y  P T  */@D149DVB 03574000
*        ADD_TIB := PCB.FIXTIB            /*TIB OF WAITNG TSK*/@D149DVB 03575000
*        IF TIB.TIBRQID = PGFXBND         /*TASK STILL WAITNG*/@D149DVB 03576000
*           THEN CALL POST(TIB)           /* POST WAITNG TASK*/@D149DVB 03577000
*        PCB.PFTERSVD := ADDR_PFTE        /* SAVE PFTE ADDR  */@D149DVB 03578000
*        IF PCB.FIXTYPE ¬= GTRBIT &       /*REQ ¬ BY GETREAL */@D149DVB 03579000
*            PCB.FIXTYPE ¬= RSTRTBIT      /*   OR RESTART    */@D149DVB 03580000
*           THEN DO                                            @D149DVB 03581000
*           FOR ALL X_PFTES IN (PCB.SMRPBEG,PCB,SMRPEND)       @D149DVB 03582000
*              IF ADDR_X_PFTE ¬= PFTE                          @D149DVB 03583000
*                 THEN X.PFTE.NFRP = OFF  /*RESET NFRP IN ALL*/@D149DVB 03584000
*                                         /*PFTES EXCEPT THAT*/@D149DVB 03585000
*                                         /*ONE JUST TFREED  */@D149DVB 03586000
*           END                                              @D149DVB   03587000
*        RETURN                           /* =====>  RETURN  */@D149DVB 03588000
*        END (FREEFRAM) ;                                      @D149DVB 03589000
*-------------------------------------------------------------*@D149DVB 03590000
*        INTERNAL REGISTER USAGE                               @D35CDKH 03591000
*                R4 - WORK REGISTER                            @D35CDKH 03592000
*                R5 - WORK REGISTER                            @D35CDKH 03593000
*                R6 - WORK REGISTER (RESTORED)                 @D369DRP 03594000
*                R8 - WORK REGISTER (RESTORED)                 @D369DFG 03595000
*                RE,RF - USED BY POST (SAVED/RESTORED)         @D369DRP 03596000
*                                                              @D35CDKH 03597000
*--------------------------------------------------------------@D35CDKH 03598000
         SPACE 1                                               @D14BDVB 03599000
FREEFRAM LR    R4,R8                                           @D14BDVB 03600000
*        AMODESW SET,DAT=ON       ENTER VIRTUAL MODE (DAT=ON)  @D52VDRP 03601000
         AMODESW SET,DAT=ON                                    @D52VDRP 03602000
*        GENSERV GETPCB,PIK=(R5),PCB=(R5) GET PCB FOR SPECIFIED PIK     03603000
         GENSERV GETPCB,PIK=(R5),PCB=(R5)                      @DY44241 03604000
         USING PCBADR,R5          SET BASE FOR PCB             @D36IDRP 03605000
         L     R8,FIXTIB          GET TIB POINTER OF REQUESTOR @D14BDVB 03606000
         USING TIBADR,R8                                       @D14BDVB 03607000
         CLI   TIBRQID,PGFXBND    ... WAITING FOR TFREED PFTE  @D14BDVB 03608000
         BNE   FREEFR10           NO -->  ALREADY POSTED BUT NOT YET.. *03609000
                                  ... ACTIVATED AND PFTE TIXED @D14BDVB 03610000
*                                 ... ONCE MORE IN BETWEEN     @D14BDVB 03611000
         ST    RE,PMRSAVE2-PMGMDATA(,R4)                       @D14BDVB 03612000
         ST    RF,PMRSAVE2-PMGMDATA+4(,R4)                     @D14BDVB 03613000
         ST    R6,PMRSAV21-PMGMDATA(,R4)                       @D14BDVB 03614000
         L     R6,DISPAD          MAKE DISPATCHER ADDRESSABLE  @D36IDFG 03615000
         USING DISP,R6                                         @D36IDFG 03616000
         BAL   RF,POST            POST THE TASK                @D36IDFG 03617000
*SGLINK  POST,INPUT=(R6,R8,RF),WORK=(RE)                       @D369DRP 03618000
         DROP  R6,R8                                           @D14BDVB 03619000
         L     RE,PMRSAVE2-PMGMDATA(,R4)                       @D14BDVB 03620000
         L     RF,PMRSAVE2-PMGMDATA+4(,R4)                     @D14BDVB 03621000
         L     R6,PMRSAV21-PMGMDATA(,R4)                       @D14BDVB 03622000
FREEFR10 LR    R8,R4              RESTORE BASE OF PMR DATA     @D14BDVB 03623000
         USING PMGMDATA,R8                                     @D14BDVB 03624000
         ST    RC,PFTERSVD        SET PFTE-ADDR IN PCB         @D369DRP 03625000
         TM    FIXTYPE,GTRBIT+RSTRTBIT WAITING TASK HANDLING   @D35CDKH 03626000
*                                 GETREAL/RESTART REQUEST      @D35CDKH 03627000
         BM    FREEFRND           ---------->  YES, RETURN     @D149DVB 03628000
         SPACE 1                                               @D14NDVB 03629000
         L     R4,SMRPEND         GET END OF REAL PART         @D35CDKH 03630000
*       GENSERV TEST,FIELD=SMRPBEG,REG=(R5),BC=BZ,LAB=FREEFRHW @D52VDVB 03631000
        GENSERV TEST,FIELD=SMRPBEG,REG=(R5),BC=BZ,LAB=FREEFRHW @D52VDVB 03632000
         DROP  R5                 FORGET PCB                   @D369DRP 03633000
         SRL   R5,PFSHIFT         GET ADDR OF PFTE'S           @D35CDKH 03634000
         SRL   R4,PFSHIFT         OF BEGIN AND                 @D35CDKH 03635000
         A     R5,APFT            END OF REAL                  @D35CDKH 03636000
         A     R4,APFT            PARTITION                    @D35CDKH 03637000
*        AMODESW SET,DAT=OFF      ENTER REAL MODE (DAT=OFF)    @D52VDRP 03638000
         AMODESW SET,DAT=OFF                                   @D52VDRP 03639000
         USING PFTE,R5            BASE FOR PARTITION'S PFTE'S  @D35CDKH 03640000
FREEFR20 CR    R5,RC              IS IT FREED PFTE             @D35CDKH 03641000
         BE    FREEFR30           YES, BRANCH                  @D35CDKH 03642000
         NI    S370FLG,XFF-NFRP   TURN OFF NFRP                @D35CDKH 03643000
         DROP  R5                                              @D35CDKH 03644000
FREEFR30 LA    R5,LPFTE(R5)       GET NXT PFTE OF PARTITION    @D35CDKH 03645000
         CR    R5,R4              END OF PARTITION REACHED     @D35CDKH 03646000
         BL    FREEFR20           NO, BRANCH                   @D35CDKH 03647000
         SPACE 1                                               @D52VDVB 03648000
FREEFRND DS 0H                                                 @D52VDVB 03649000
*        AMODESW SET,DAT=OFF      ENTER REAL MODE (DAT=OFF)    @D52VDRP 03650000
         AMODESW SET,DAT=OFF                                   @D52VDRP 03651000
         BR    RA                 ==========>  RETURN TO CALLER@D149DVB 03652000
         SPACE 1                                               @D52VDVB 03653000
FREEFRHW DS    0H                 HARD WAIT                    @D52VDVB 03654000
         BALR  R5,0                                            @D52VDVB 03655000
         B     TFREWTF5           NOT TFIXED, ==========> HW   @D52VBVB 03656000
         DROP  R9                 DROP BASE FOR CODE           @D52VDRP 03657000
         TITLE 'DOS SUPERVISOR        SGPFIX     PAGE MANAGEMENT (GENPG*03658000
               QE ROUTINE)'                                    @D14ZDRP 03659000
*-------------------------------------------------------------*         03660000
*   GENPGQE - ROUTINE                                                   03661000
*      GENERATES AN ENTRY IN PGQUI WITHOUT CAUSING A PAGE FAULT         03662000
*      THE CURRENT STATUS OF THE TASK IS SAVED IN THE CORRECT           03663000
*      SAVE-AREA                                                        03664000
*   ENTRY POINTS:                                                       03665000
*     GENPGQE - CALLED FROM PFIXPGE, TFIX WITH AMODE(31),DATOFF         03666000
*     GENPGQE - CALLED FROM PGIN          WITH AMODE(31),DATON          03667000
*     GENPGQX - CALLED FROM XMOVE, XPPC   WITH AMODE(24),DATON          03668000
*   CALLS: SETUPSA IN AMODE OF CALLER AND DATON                @D529DRP 03669000
*   EXIT TO ENQUIX WITH AMODE(31),DATON                        @D529DRP 03670000
*   CALLER GETS CONTROL BACK ON ADDRESS POINTED TO BY REG. 12  @D529DRP 03671000
*    WITH AMODE OF CALLER AND DATON                            @D529DRP 03672000
*   CALLING SEQUENCE:                                                   03673000
*        L     R8,APMGMDATA                                             03674000
*        USING PMGMDATA,R8                                              03675000
*        L     RX,AGENPGQE/AGENPGQX                                     03676000
*        BALR  RX,RX                                                    03677000
*   INPUT:                                                              03678000
*      RC - ADDR TO BE STORED IN SAVED PSW                              03679000
*      TRADDR - CONTAINS ALREADY ADDR OF PAGE TO BE PAGED IN            03680000
*    IF ENTERED VIA GENPGQX                                             03681000
*      GENPADR - CONTAINS ADDR OF SCB, THE PAGE BELONGS TO              03682000
*   NOTE:                                                               03683000
*      THIS CODE EXECUTES WITHOUT BASE REGISTER                         03684000
*-------------------------------------------------------------*         03685000
         SPACE 1                                                        03686000
GENPGQE  DS    0H                                              @DY44889 03687101
         L     R4,SCBPTR          CURRENT SCB ADDRESS          @DY44889 03687301
*DEL QE  MVC   GENPGADR(4),SCBPTR PROVIDE CURRENT SCB ADDRESS  @DA35908 03687501
GENPGQX  STM   R9,RD,ERA          SAVE R9,RD OF CALLER         @DA35398 03688000
         L     RD,AFLIH           GET BASE FOR SETUPSA         @D36IDRP 03689000
         USING FLIH,RD                                         @D36IDRP 03690000
*        AMODESW SET,DAT=ON       ENTER VIRTUAL MODE (DAT=ON)  @D52VDRP 03691000
         AMODESW SET,DAT=ON                                    @D52VDRP 03692000
         BAL   R9,SETUPSA         SAVE STATUS OF TASK IN SAVE AREA      03693000
*SGLINK  SETUPSA,INPUT=(R9,RC,RD),WORK=(RB,RC),OUTPUT=(R6,RA)  @D369DRP 03694000
*              ON RETURN FROM SETUPSA                          @D369DRP 03695000
*                   R6 - BASE ADDR OF DISPATCHER               @D369DRP 03696000
*                   RA - ADDR OF TCB                           @D369DRP 03697000
         BALR  R9,0               GET BASE REGISTER            @D52VDRP 03698000
         USING *,R9               SET BASE                     @D52VDRP 03699000
         SGSETUP UPDTIME,NEXTPCB=ASYSPCB,OPTION=OWNER,                 *03700000
               WR1=RB,WR2=RC,WR3=RX *** WR3 NOT USED ANYMORE **@DY44889 03701401
         DROP  RD                                              @D36IDRP 03702000
*DEL     L     R4,GENPGADR        CURRENT SCB ADDRESS          @DY44889 03703401
         L     R9,AENQUIX         GET ENTRY ADDR OF ENQUI RTN  @DA35398 03704000
*SGLINK  ENQUIX,INPUT=(R4:SCB,R8:APMGMDAT),AMODE=31            @D61NDRP 03705000
*        AMODESW RETURN,REG=(R9)  CALL ENQUIX                  @D52VDVB 03706000
         AMODESW RETURN,REG=(R9)                               @D52VDRP 03707000
*                                 BRANCH TO ENQUI RTN, ENQU REQUEST IN  03708000
*                                 PAGE REQUEST QUEUE                    03709000
         DROP  R8                 DROP BASE FOR DATA AREA      @D52VDRP 03710000
         TITLE 'DOS SUPERVISOR     SGPFIX     PAGE MANAGEMENT SERVICES *03711000
               INTERFACE, SVC 121'                             @D52VDRP 03712000
*---------------------------------------------------------------------* 03713000
*        ROUTINE PROLOGUE                                      @D52VDVB 03714000
*        ROUTINE NAME: PGSER                                   @D52VDVB 03715000
*        MACRO:        SGPFIX                                  @D52VDVB 03716000
*        FUNCTION: HANDLES NEW PAGEMANAGEMENT SERVICES         @D52VDVB 03717000
*                  (SVC 121) INTERFACE                         @D52VDVB 03718000
*                  TRANSFERS CONTROL TO CORRESPONDING PROCEDURE@D52VDVB 03719000
*        INPUT:                                                @D52VDVB 03720000
*                  R0 - ADDR (ECB) /  ADDRESS (ENTRY)          @D52VDVB 03721000
*                  R1 - ADDR (LIST (PARM))                     @D52VDVB 03722000
*                       PARM = (ADDR PTR(31),LEN(AREA)-1 BIN FIXED(31)) 03723000
*                  R6 - ADDR OF DISPATCHER                     @D52VDVB 03724000
*                  RA - ADDR OF TCB                            @D52VDVB 03725000
*                  RF - FUNCTION CODE / OPTION BYTE            @D52VDVB 03726000
*                       BYTE 0 :   BIT 0 - MUST BE ZRO         @D52VDVB 03727000
*                                  BIT 1-7 - RESERVED          @D52VDVB 03728000
*                       BYTE 1 :   OPTION BYTE                 @D52VDVB 03729000
*                                  00: REAL ALLOC IN 24 BIT AR.@D52VDVB 03730000
*                                  81: REAL ALLOC IN 31 BIT AR.@D52VDVB 03731000
*                       BYTE 2 :   RESERVED                    @D52VDVB 03732000
*                       BYTE 3 :   FUNCTION CODE               @D52VDVB 03733000
*                                  01: PFIX                    @D52VDVB 03734000
*                                  02: PFREE                   @D52VDVB 03735000
*                                  03: RELPAGE                 @D52VDVB 03736000
*                                  04: FCEPGOUT                @D52VDVB 03737000
*                                  05: PAGEIN                  @D52VDVB 03738000
*                                  06: PAGESTAT                @D52GDWL 03739000
*                                  07: SETPFA                  @D52GDWL 03740000
*        DON'T DESTROY R0                                      @D52GDWL 03741000
*        ENTRY POINTS:                                         @D52VDVB 03742000
*                  PGSER:   MACRO PGSER AMODE(24), DATON       @D52VDVB 03743000
*        EXIT :                                                @D52VDVB 03744000
*             NORMAL:   TRANSFER CONTROL TO FUNCTIONAL         @D52VDVB 03745000
*                       ROUTINE                                @D52VDVB 03746000
*             ERROR:    RETURN TO RETCODE(DISP)                @D52VDVB 03747000
*        RETURN CODE:                                          @D52VDVB 03748000
*                  SEE FUNCTIONAL ROUTINES                     @D52VDVB 03749000
*                  20    -   INVALID FUNCTION CODE             @D52VDVB 03750000
*---------------------------------------------------------------------* 03751000
         SPACE 1                                               @D52VDVB 03752000
PMPGSER  DS    0D                                              @D52VDVB 03753000
         USING TCBADR,RA                                       @D52VDVB 03754000
         USING DISP,R6                                         @D52VDRP 03755000
PGSER    L     R8,APMGMDAT        GET BASE ADDR OF DATA AREA   @D52VDVB 03756000
         USING PMGMDATA,R8        SET BASE FOR DATA AREA       @D52VDVB 03757000
         L     R9,APMPGSER        GET BASE FOR CODE AREA       @D52VDVB 03758000
         USING PMPGSER,R9         SET BASE FOR CODE AREA       @D52ADVB 03759000
         N     RF,BIT0OFF         INDICATE 24-BIT MODE         @D52VDVB 03760000
         LR    R5,RF                                           @D52VDVB 03761000
         N     R5,PGSERMSK        GET FUNCTION CODE            @D52VDVB 03762000
         CL    R5,PGSERLOW        VALID RANGE                  @D52VDVB 03763000
         BL    ERR21              NO, ----------> ILLEGAL SVC  @D52VDVB 03764000
         CL    R5,PGSERHIG                                     @D52VDVB 03765000
         BH    ERR21              NO, ----------> ILLEGAL SVC  @D52VDVB 03766000
         TM    TCBEXFLG,TCBEXAM   RUNNING IN 31-BIT MODE       @D52VDVB 03767000
         BZ    PGSERM00           NO,  --------->              @D52VDVB 03768000
         O     RF,BIT0OMSK        INDICATE 31-BIT MODE         @D52VDVB 03769000
         SGCOV SGPFIX,MC=4                                     @D52VDRP 03770000
PGSERM00 DS    0H                                              @D52VDVB 03771000
         SLL   R5,PGSERLOG        FUNCTION CODE * TABLE ENTRY L@D52VDVB 03772000
         LA    R5,PGSERFCT(R5)    ADDRESS OF TABLE ENTRY       @D52VDVB 03773000
         LR    RE,RF                                           @D52VDVB 03774000
         X     RE,PGSERFUC(,R5)   CHECK FOR CONSISTANCY        @D52VDVB 03775000
         NR    RE,RF              ... FUNCTION / OPTION CODE   @D52VDVB 03776000
         BNZ   PGSERM30           INCONSISTANT ------->        @D52VDVB 03777000
PGSERM10 DS    0H                                              @D52VDVB 03778000
         L     RE,PIBPTR2         GET ADDR OF PIB2             @D52VDRP 03779000
         USING PIB2ADR,RE                                      @D52VDRP 03780000
         L     RE,PIBPCB          GET ADDR OF PCB              @D52VDRP 03781000
         USING PCBADR,RE          SET BASE FOR PCB             @D52VDRP 03782000
         L     RE,PCEPIB          PIB OF CURRENT PARTITION     @D52VDRP 03783000
         USING PIBADR,RE          SET BASE FOR PIB             @D52VDRP 03784000
         TM    PIBDATFL,PIBTRAM   TASK IN VIRTUAL MODE         @D52VDRP 03785000
         BO    PGSERM20           YES,  ---------->            @D52VDVB 03786000
         DROP  RE                 FORGET BASE FOR PIB          @D52VDRP 03787000
         TM    PGSERSPR(R5),PGDOREAL EXEC REAL ALLOWED         @D52VDVB 03788000
         BZ    PGSERND0           NO, ---------->  NOP         @D52VDVB 03789000
PGSERM20 DS    0H                                              @D52VDVB 03790000
         L     RE,PGSERSPR(,R5)   EP OF PREPARATION ROUTINE    @D52VDVB 03791000
         BR    RE                 ==========>                  @D52VDVB 03792000
PGSERM30 DS    0H                                              @D52VDVB 03793000
         L     RE,PGSERERR(,R5)   EP OF ERROR ROUTINE          @D52VDVB 03794000
         BR    RE                 ==========>                  @D52VDVB 03795000
         SPACE 2                                               @D52VDVB 03796000
PGSERS01 DS    0H                 PREPARATION FOR PFIX FCT     @D52VDVB 03797000
         L     RE,PGSEREPT(,R5)   ENTRY POINT OF PFIX ROUTINE  @D52VDVB 03798000
*        AMODESW CALL,REGS=(RE,RE) PERFORM PFIX FUNCTION       @D52VDVB 03799000
         AMODESW CALL,REGS=(RE,RE) PERFORM PFIX FUNCTION       @D52VDVB 03800000
         L     R9,APMPGSER        RESET BASE                   @D52VDVB 03801000
         LA    RE,D28(,0)         IS IT MAX(PFIXC) ....        @KX40934 03802000
         CR    RF,RE              ... RETURN CODE              @KX40934 03803000
         BNE   PGSEREND           NO, ------>                  @D52VDVB 03804000
*        AMODESW BRANCH,AMODE=24,ADDRESS=ERR2F,REG=(RE)        @KX40934 03805000
*                                 ===========> CANCEL USER     @KX40934 03806000
         AMODESW BRANCH,AMODE=24,ADDRESS=ERR2F,REG=(RE)        @KX40934 03807000
         SPACE 1                                                        03808000
PGSERS02 DS    0H                 PREPARTION FOR SETPFA FCT    @D52VDVB 03809000
         TM    TCBEXFLG,TCBEXAM+TCBEXRM AMODE(31) OR RMODE(31) @D52VDRP 03810000
         BNZ   ERR45              YES, ==========> CANCEL USER @D52VDRP 03811000
         L     R7,PGSEREPT(,R5)   ENTRY POINT OF SETPFA RTN    @D52VDVB 03812000
*        AMODESW CALL,REGS=(R7,R7) PERFORM PFREE FUNCTION      @D52VDVB 03813000
         AMODESW CALL,REGS=(R7,R7) PERFORM PFREE FUNCTION      @D52VDVB 03814000
         DROP  R6                 DROP BASE FOR DISP           @D52VDRP 03815000
         L     R9,APMPGSER        RESET BASE                   @D52VDVB 03816000
         B     PGSEREND           ---------->                  @D52VDVB 03817000
         SPACE 1                                               @D52VDVB 03818000
PGSERS03 DS    0H                 PREPARTION FOR PMR SERVICES  @D52VDVB 03819000
         L     R7,PGSEREPT(,R5)   ENTRY POINT OF FCT           @D52VDVB 03820000
*        AMODESW CALL,REGS=(R7,R7) PERFORM PMR SERVICE         @D52VDVB 03821000
         AMODESW CALL,REGS=(R7,R7) PERFORM PMR SERVICE         @D52VDVB 03822000
         L     R9,APMPGSER        RESET BASE                   @D52VDVB 03823000
         SPACE 2                                               @D52VDVB 03824000
PGSEREND L     R6,DISPAD          GET ADDR OF DISPATCHER       @D52VDRP 03825000
         LA    R1,SVER0F-SVEARA   GET DISPLACEM. IN SAVEAREA   @D52VDRP 03826000
         LA    RE,RETCODE         GET RETURN ADDRESS           @D52VDRP 03827000
*        AMODESW RETURN,REG=(RE)  =========> EXIT IN 24-BIT    @D52VDRP 03828000
         AMODESW RETURN,REG=(RE)  =========> EXIT IN 24-BIT    @D52VDRP 03829000
*                                 =========> EXIT IN 24-BIT    @D52VDRP 03830000
         SPACE 2                                               @D52VDVB 03831000
PGSERND0 SLR   RF,RF              INDICATE O.K.                @D52VDRP 03832000
         B     PGSEREND           ---------->                  @D52VDVB 03833000
PGSERT20 LA    RF,D20(,0)         SET RC=20  INVALID FUNCTION  @D52VDVB 03834000
         B     PGSEREND           ---------->                  @D52VDVB 03835000
PGSERT30 DS    0H                 SET RC=20  FOR PAGEIN        @D52GDVB 03836000
         SGCOV SGPFIXS,MC=17                                   @D52GDVB 03837000
         O     RF,PGSERC20        SET RC=20  FOR PAGEIN        @D52GDVB 03838000
         B     PGSERM10           DO FURTHER PROCESSING TO POST@D52GDVB 03839000
*                                 ... ECB IN PAGEIN ROUTINE    @D52GDVB 03840000
*                                 ... ATTENTION: ADDRESS VALID.@D52GDVB 03841000
         DROP  R8,R9              DROP BASE FOR DATA AND CODE  @D61NDRP 03842000
         DROP  RA                 DROP BASE FOR TCB            @D52VDVB 03843000
         SPACE 1                                               @D52VDVB 03844000
*-------------------------------------------------------------*@D52VDVB 03845000
         SPACE 1                                               @D52VDVB 03846000
PGSERFCT DS    0F                                              @D52VDVB 03847000
PGSERHD  EQU   PGSERFCT                                        @D52VDVB 03848000
PGSERLOW DC    A((PGSER1ST-PGSERFCT)/PGSERELN) LOWEST FCT CODE @D52VDVB 03849000
PGSERHIG DC    A((PGSERLST-PGSERFCT)/PGSERELN) HIGHES FCT CODE @D52VDVB 03850000
         DC    A(0)                                            @D52VDVB 03851000
PGSERPGN DC    A(PMRPAGIN)        FUNCTION CODE FOR PAGEIN     @D52VDRP 03852000
PGSERHDE EQU   *-PGSERHD                                       @D52VDVB 03853000
PGDOREAL EQU   X'80'                                           @D52VDVB 03854000
*-------------------------------------------------------------*@D52VDVB 03855000
PGSER1ST DS    0F                                              @D52VDVB 03856000
PGSERSPR EQU   *-PGSER1ST                                      @D52VDVB 03857000
         DC    AL1(0),AL3(PGSERS01) NOT REAL, PREPARATION ENTRY@D52VDVB 03858000
PGSEREPT EQU   *-PGSER1ST                                      @D52VDVB 03859000
         DC    A(PFIX2ND)         PFIX FUNCTION  FC=1          @D52VDVB 03860000
PGSERFUC EQU   *-PGSER1ST                                      @D52VDVB 03861000
         DC    AL1(128+PCBPXRET)                               @DY43013 03862000
         DC    AL1(PCBPXABO+PCBPXAR1+PCBPXAR2+PCBPXAR3)        @D52VDVB 03863000
         DC    AL1(0),AL1(PCBPXFIX)                            @D52VDVB 03864000
PGSERERR EQU   *-PGSER1ST                                      @D52VDVB 03865000
         DC    A(PGSERT20)        ERROR ADDRESS                @D52VDVB 03866000
*-------------------------------------------------------------*@D52VDVB 03867000
PGSERELN EQU   *-PGSER1ST         LENGTH OF ENTRY              @D52VDVB 03868000
PGSERLOG EQU   4                  LENGTH OF ENTRY (N**2)       @D52VDVB 03869000
*-------------------------------------------------------------*@D52VDVB 03870000
         DC    AL1(0),AL3(PGSERS03) NOT REAL, PREPARATION ENTRY@D52VDVB 03871000
         DC    A(PFREE2ND)        PFREE FUNCTION  FC=2         @D52VDVB 03872000
         DC    AL1(128),AL1(PCBPXABO+PCBPXAR1+PCBPXAR2+PCBPXAR3)        03873000
         DC    AL1(0),AL1(PCBPXFRE)                            @D52VDVB 03874000
         DC    A(PGSERT20)        ERROR ADDRESS                @D52VDVB 03875000
*-------------------------------------------------------------*@D52GDVB 03876000
         DC    AL1(0),AL3(PGSERS03) NOT REAL, PREPARATION ENTRY@D52GDVB 03877000
         DC    A(RELPG2ND)        RELPAGE FUNCTION  FC=3       @D52GDVB 03878000
         DC    AL1(128),AL1(0),AL1(0)                          @D52GDVB 03879000
         DC    AL1(PMRRELPG)                                   @D52GDVB 03880000
         DC    A(PGSERT20)        ERROR ADDRESS                @D52GDVB 03881000
*-------------------------------------------------------------*@D52GDVB 03882000
         DC    AL1(0),AL3(PGSERS03) NOT REAL, PREPARATION ENTRY@D52GDVB 03883000
         DC    A(FCPGO2ND)        FCEPAGEOUT FUNCTION  FC=4    @D52GDVB 03884000
         DC    AL1(128),AL1(0),AL1(0)                          @D52GDVB 03885000
         DC    AL1(PMRFCEPT)                                   @D52GDVB 03886000
         DC    A(PGSERT20)        ERROR ADDRESS                @D52GDVB 03887000
*-------------------------------------------------------------*@D52GDVB 03888000
         DC    AL1(PGDOREAL),AL3(PGSERS03) REAL, PREPARATION   @D52GDVB 03889000
         DC    A(PAGIN2ND)        PAGEIN FUNCTION    FC=5      @D52GDVB 03890000
         DC    AL1(128),AL1(0),AL1(0)                          @D52GDVB 03891000
         DC    AL1(PMRPAGIN)                                   @D52GDVB 03892000
         DC    A(PGSERT30)        ERROR ADDRESS                @D52GDVB 03893000
*-------------------------------------------------------------*@D52GDVB 03894000
         DC    AL1(PGDOREAL),AL3(PGSERS03) REAL, PREPARATION   @D52GDVB 03895000
         DC    A(PAGSTATX)        PAGESTAT FUNCTION  FC=6      @D52GDWL 03896000
         DC    AL1(128),AL1(0),AL1(0)                          @D52GDVB 03897000
         DC    AL1(PMRPSTAT)                                   @D52GDVB 03898000
         DC    A(PGSERT20)        ERROR ADDRESS                @D52GDVB 03899000
*-------------------------------------------------------------*@D52GDWL 03900000
PGSERLST DS    0F                                              @D52GDVB 03901000
         DC    AL1(PGDOREAL),AL3(PGSERS02) REAL, PREPARATION   @D52GDVB 03902000
         DC    A(SETPFAX)         SETPFA   FUNCTION  FC=7      @D52GDWL 03903000
         DC    AL1(128),AL1(0),AL1(0)                          @D52GDVB 03904000
         DC    AL1(PMRSETPF)                                   @D52GDVB 03905000
         DC    A(PGSERT20)        ERROR ADDRESS                @D52VDVB 03906000
*-------------------------------------------------------------*@D52GDWL 03907000
         MEND                                                           03908000
