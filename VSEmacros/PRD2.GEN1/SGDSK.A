         MACRO                                                          00010000
&NAME    SGDSK &SUBJ,&CODE=,&OUTPUT=,&I=,&O=,&W=,&E0=,&E4=,&NR=         00020000
.*                                                             @DERPDGL 00030016
         GBLB  &BGDEBUG         DEBUG OPTION                   @D35DDDK 00040000
         GBLB  &SGDSK           PRINT CONTROL SWITCH           @D37ADDK 00050000
         GBLB  &VSE260          RELEASE CONTROLSWITCH          @D66CDAP 00060000
         GBLC  &SYSERR          GLOBAL SETC FOR SYSERROR EXIT  @D37ADDK 00070016
.*                                                             @D61SDJK 00080000
         LCLC  &STRING,&TEST                                   @DERPDGL 00090016
         LCLC  &STRING1,&STRING2,&STRING3  FOR HANDLING OF     @DERPDGL 00100016
         LCLA  &COUNT1,&ROF,&X,&Y          INTERNAL CALLS.     @DERPDGL 00110016
         LCLC  &RX,&D,&LABEL,&LABSUF                           @DERPDGL 00120016
         LCLB  &DSKMSG                                         @DERPDGL 00130016
.*                                                             @DERPDGL 00140016
         ACTR  4000                                            @D51CDBH 00150016
.**************************************************************#SECURGL 00160016
    AIF  (T'&SUBJ EQ 'O').G000000       IF EXPANSION FOR TEST *#SECURGL 00170016
    AIF  ('&SUBJ'(1,1) NE '''').ERP0100 OF REGISTER CONVENTION*@D66ADAP 00180016
&TEST    SETC   '&SUBJ'(2,K'&SUBJ-2)    TAKE FIRST SUBJECT AND*#SECURGL 00190016
    AGO  .LUCCB                         GOTO FIRST TEST       *#SECURGL 00200016
.G000000 ANOP *************************************************#SECURGL 00210016
         AIF   (NOT &SGDSK).ERP0100                            @DA37123 00220016
         PRINT GEN                                             @D37ADDK 00230000
.ERP0100 ANOP                                                           00240016
         TITLE 'DOS SUPERVISOR    SGDSK    DISK ERROR RECOVERY ROUTINE' 00250000
.*                                                                      00260000
.*/**********************************************************           00270000
.*                                                          *  @D31TDRH 00280000
.*      IBM VIRTUAL STORAGE EXTENDED  (VSE)                 *  @D31TDRH 00290000
.*      COMPONENT: 5686-066-06                              *  @D61ADJK 00300016
.* @@CPY                                                    *  @D31TDRH 00310016
.*      LICENSED MATERIALS - PROPERTY OF IBM                *  @D31TDRH 00320016
.*      THIS MACRO IS "RESTRICTED MATERIALS OF IBM"         *  @D52VDGL 00330016
.*      5686-066 (C) COPYRIGHT IBM CORP. 1979, 2001         *  @D66CDAP 00340000
.*      SEE COPYRIGHT INSTRUCTIONS                          *  @D31TDRH 00350016
.*                                                          *  @D31TDRH 00360000
.************************************************************/          00370000
.*                                                                      00380000
.*                                                                      00390016
.* /* START OF SPECIFICATIONS ***************************************** 00400000
.*                                                                      00410000
.*01* MODULE TYPE = SYSTEM GENERATION MACRO                             00420000
.*                                                                      00430000
.*01* DESCRIPTIVE NAME = RESIDENT DISK ERP                              00440000
.*                                                                      00450016
.*01* NOTES                                                             00460000
.*                                                                      00470016
.* THE SGDSK MACRO IS DESIGNED TO BE INVOKED BY THE SUPERVISOR @D51TDPM 00480016
.* GENERATION CODE, I.E. AS PART OF THE REGULAR VSE SUPERVISOR.@D51TDPM 00490016
.* IT IS ALSO INVOKED BY THE STANDALONE SUPERVISOR CODE.       @D51TDPM 00500016
.* EXCEPT FOR SOME CLEARLY MARKED AREAS IN SGDSK, NO DESIGN    @D51TDPM 00510016
.* CONSIDERATION IS MADE BY SGDSK FOR THE STANDALONE SUPERVISOR@D51TDPM 00520016
.* INVOCATION.  TO MAKE USE OF SGDSK, THE STANDALONE SUPERVISOR@D51TDPM 00530016
.* MUST ADEQUATELY SIMULATE THE REGULAR SUPERVISOR.  FUTURE    @D51TDPM 00540016
.* CHANGES TO SGDSK MAY MAKE CHANGES TO THE STANDALONE         @D51TDPM 00550016
.* SUPERVISOR NECESSARY.                                       @D51TDPM 00560016
.*                                                                      00570016
.*                                                                      00580016
.*02* CHANGE ACTIVITY:                                                  00590000
.*    MSG0P18I SEEK ADDR INCORRECT, WITH CMD REJ ON SEEK CMD   @DA32611 00600000
.*    ASYNCHRONOUS ERROR LOGGING FOR SYSTEM TASK ERRORS        @D14CTJF 00610000
.*    SOFT WAIT AFTER SYSTEM TASK DETECTED I/O ERROR           @DMJ0062 00620000
.*    INCORRECT HANDLING OF CCW COUNT AND RESIDUAL COUNT       @DMJ0131 00630000
.*    SOFT WAIT AFTER SYSTEM TASK INTERVENTION REQUIRED        @DMN0306 00640000
.*    SYSTEM LOOP WHEN RUNNING IN REDISPLAY MODE (KKJ0201)     @DA33591 00650000
.*    LOST DATA/ERROR ON RECOVERY ON FBA                       @DA33561 00660000
.*    WAITFFF WHEN RETRY OF FAILING CHANNEL PROGRAM DO TO      @DA33722 00670000
.*          R9 BEING CLOBBERED IN DERID010                     @DA33722 00680000
.*    NEW DEVICE SUPPORT                                       @D21BTJF 00690000
.*    SEEK HEAD ON ALTERNATE TRACK OF D/T3340 NRF. CONDITION   @DA34417 00700000
.*    RUNNING IN 370 MODE, INCORROUT WHEN DATA CHECK ON D/T3370@DA34768 00710000
.*    WAITFFF AFTER CORRECTABLE DATA CHK WITH EXCP-REAL REQUEST@DA35162 00720000
.*    PERMANENT ERROR ON CKD AFTER CORRECTABLE DATA CK ON FBA  @DA35175 00730000
.*    WAITFFF BECAUSE OF DERIDAL TOO SHORT                     @DA35245 00740000
.*    TEMPORARY ERRORS RECORDED AS PERMANENT ON SYSREC         @DA35642 00750000
.*    MSG0P17I FILE PROTECT WHEN SWITCHING FROM ALTERNATE      @DA34685 00760000
.*      TRACK BACK TO PRIMARY ON D/T3344                       @DA34685 00770000
.*    INSURE ADDRESSABILITY FOR USER CCB FOR MODE=370          @DA35675 00780000
.*    PREVENT LOGGING NORMAL INTV. REQ. ON D/T 3340            @DA35679 00790000
.*    NEW DEVICE SUPPORT                                       @D21KTJF 00800000
.*    MSG0P20I WAS ISSUED BUT  ENVIROMENTAL DATA PRESENT       @DA36348 00810000
.*    MSGK205I RC=24 AFTER CORRECTABLE DATA CHECK ON D/T3370   @DA36364 00820000
.*    NEW DEVICE SUPPORT                                       @D21OTJF 00830000
.*    SOFTWAIT ERP FETCHBND AND DIR WAITBND                    @DA37065 00840000
.*    DASD ERP NOT COMPLETED                                   @DA37004 00850000
.*    INCORRECT SEEK ADDR IN MSG, WITH CMD REJ ON SEEK CMD     @DA37123 00860000
.*    ASYNCHRONEOUS LOGGING OF HCF ERRORS                      @DA37115 00870000
.*    NEW DEVICE SUPPORT    (SPE DA37156)                      @D21LTBH 00880000
.*    PASS ERROR SENSE TO SVT TASK ON DISASTER ERROR           @DA37368 00890000
.*    ISSUE MSG0P19I UNDET ERR FOR A UC WITH UNEXPECTED SENSE  @DA37572 00900000
.*    DO NOT LOG RESET NOTIFICATION (FORMAT 0 MSG 8)           @DA37503 00910000
.*    SHOULD BE NO MSG NO LOG IF DATACHECK WITH MULTIPLE READ  @DA39632 00920016
.*    06/01/89    RELEASE 4.1.0                                @D31TDRH 00930000
.*    07/15/90    RELEASE 4.1.2                                @D31HMRH 00940016
.*    12/15/90    RELEASE 5.1.0                                @D51CDBH 00950016
.*    09/15/91    RELEASE 5.1.1                                @D51TDPM 00960016
.*    HARDWAIT FF9 AFTER A CORRECTABLE DATA CHECK ON PAGEIN I/O@DA40798 00970016
.*    HARDWAIT FFF DUE TO A WRONG REGISTER SPECIFICATION       @DA40705 00980016
.*    DERNXTCW IS SET WITH REAL ADDRESS INSTEAD OF VIRTUAL     @DA40861 00990016
.*    WRONG CCW CHAIN IS ISSUED AFTER A CORRECTABLE DATA CHECK @DA40880 01000016
.*    IN DERD7IO IF THERE IS A TIC BETWEEN A READ COMMAND THAT @DA41136 01010016
.*      HAD A CORRECTABLE DATA CHECK AND THE NEXT COMMAND THAT @DA41136 01020016
.*      IS A READ COUNT, THEN ANOTHER READ COUNT IS INSERTED,  @DA41136 01030016
.*      RESULTING IN THE LOSS OF ONE RECORD                    @DA41136 01040016
.*    END OF CYLINDER NOT POSTED TO USER, IF IT OCCURED IN     @DA41155 01050016
.*      A RETRY OPERATION FOR A RECOVERABLE ERROR CONDITION    @DA41155 01060016
.*      ONLY THE HIGHEST PRIORITY ERROR CONDITION IS POSTED    @DA41155 01070016
.*      AND NOT THE LAST ONE, WHICH CAME WITH A SUCCESSFUL     @DA41155 01080016
.*      RETRY OPERATION.                                       @DA41155 01090016
.*    DERGFCCW SCANS TO OBTAIN A FAILING COMMAND CCW FOR THE   @DA41099 01100016
.*      FAILING CCW IN THE CSW. BUT WITH ALL CONTROL UNITS THE @DA41099 01110016
.*      CCW ADDRESS IN THE CCW IS THAT OF THE FAILING COMMAND  @DA41099 01120016
.*      CCW.                                                   @DA41099 01130016
.*    DERECF DOES A CORRECTIVE ACTION FOR SOME DATA CHECKS     @DA41381 01140016
.*      AND HAS TO DIFFERENTIATE BETWEEN NORMAL AND PAGE       @DA41381 01150016
.*      MANAGER I/O ERRORS. IN THESE IT ASSUMES, THAT THE      @DA41381 01160016
.*      IDAL BIT IS ALWAYS SET, WHICH IS NOT TRUE FOR 370      @DA41381 01170016
.*      SUPERVISORS.                                           @DA41381 01180016
.*    DERWKCSW IS SETUP FOR LOW CORE, USING JUST THE FIRST     @DA41424 01190016
.*      BYTE OF THE CCBCNT, AND NOT 2 BYTES AS IT SHOULD       @DA41424 01200016
.*    DERECF AND DERDC67 DO SOME WRONG CALCULATION OF THE      @DA41424 01210016
.*      RESIDUAL COUNT OF A CORRECTABLE DATA CHECK. THE        @DA41424 01220016
.*      VALUE AND THE CORRESPONDING CCW ADDRESS MUST BE STORED @DA41424 01230016
.*      TO THE CCBCNT AND CCBCSWW SINCE THE CHANNEL DID        @DA41424 01240016
.*      CHANNEL COMMAND RETRY.                                 @DA41424 01250016
.*    DERECKD DID NOT PURGE THE REGISTER R5 IN CASE THE        @DA42496 01260016
.*      SIMPLE PROGRAM ACTION CODE WAS NOT KNOWN. HENCE        @DA42496 01270016
.*      THE DERCRRA3 (CCB POSTING INFORMATION) WAS SET TO      @DA42496 01280016
.*      THE VALUE OF THIS SIMPLE PROGRAM ACTION CODE.          @DA42496 01290016
.*      ALTHOUGH THE IO WAS FINALLY RECOVERED WE POSTED        @DA42496 01300016
.*      AN INVALID TRACK FORMAT WRITE AND VSAM FINISHED        @DA42496 01310016
.*      A USER IO WITH AN ERROR INDICATION.                    @DA42496 01320016
.*    DERBUMP RESTORED A DESTROYED OLD CCW ADDRESS FROM        @DA42600 01330016
.*      REGISTER R5 WHEN NEW AND OLD CCW ADDRESS ARE NOT ON    @DA42600 01340016
.*      THE SAME PAGE IN STORAGE. THE OLD CCW ADDRESS IS NOW   @DA42600 01350016
.*      SAVED IN REGISTER R7 AND CAN BE RESTORED FROM THERE    @DA42600 01360016
.*      WHEN NEEDED.                                           @DA42600 01370016
.*    DERFNM00 FINAL MESSAGING ROUTINE SETS ON THE RECONLY     @DA42666 01380016
.*      BIT FOR A MESSAGE DEVICE ERROR ENTRY THAT IS PASSED    @DA42666 01390016
.*      TO SGERP DSKEXIT. WHEN DSK LEAVES TO DSKEXIT WITH      @DA42666 01400016
.*      IGNORE THE QEDERR BIT IN THE PUB IS NOT RESET SINCE    @DA42666 01410016
.*      SGERP SEES THE DEVICE ERROR ENTRY FROM PBXERBLK STILL  @DA42666 01420016
.*      IN USE. LATER WHEN THE ERP TASK IS BACK FROM WORK THE  @DA42666 01430016
.*      BIT IS STILL NOT RESET BECAUSE OF THE RECONLY BIT.     @DA42666 01440016
.*      SYSTEM ENDS UP IN A SOFTWAIT CONDITION.                @DA42666 01450016
.*      IN ADDITION DERFAST DID NOT AVOID FAST PATH FOR SOME   @DA42666 01460016
.*      STATE CHANGE PENDING CONDITION SINCE IT ASKED FOR THE  @DA42666 01470016
.*      1D IN BYTE 22 AND NOT 25 AS IT SHOULD.                 @DA42666 01480016
.*      MOREOVER THE NO RECORD FOUND FOR AN ECKD DEVICE WAS    @DA42666 01490016
.*      NOT LEAD TO THE FAST PATH SINCE HERE THE BYTE 25 WAS   @DA42666 01500016
.*      INSPECTED FOR 06 AND NOT BYTE 22                       @DA42666 01510016
.*    DERSCAN LOOKS AT THE DATA CHAINING INDICATION IN A       @DA42922 01520016
.*      TIC, THAT BELONGS TO THE LINKAGE BETWEEN COPY BLOCKS   @DA42922 01530016
.*      (XA8 TIC) IF THIS TIC IS REACHED BY SKIPPING THE TIC   @DA42922 01540016
.*      BEHIND A STATUS MODIFIER COMMAND. THE EFFECT WAS       @DA42922 01550016
.*      DETECTED IN PROCESSING A CORRECTABLE DATA CHECK,       @DA42922 01560016
.*      WHICH SHOWED A RECOVERY ERROR MESSAGE CAUSED BY THE    @DA42922 01570016
.*      FACT THAT DERDC67 ASSUMED THE FAILING CCW TO BE        @DA42922 01580016
.*      DIFFERENT FROM THE FAILING COMMAND CCW. THE MESSAGE    @DA42922 01590016
.*      SHOWED A CCSW= OF A8.... AS COMMAND CODE.              @DA42922 01600016
.*    IN ADDITION DERSCAN COULD BE CALLED FOR SCANNING OF      @DA42922 01610016
.*      A NON-EXISTANT CCW CHAIN IN CASE OF AN UNSOLICITED     @DA42922 01620016
.*      INTERRUPT FROM AN FBA DEVICE. THE INVALID ADDRESS      @DA42922 01630016
.*      IS NOT NOTICED BY VIRTAD AND IT FAILS WITH HARDWAIT..  @DA42922 01640016
.*      THIS IS ALSO FIXED IN VIRTAD CODE.                     @DA42922 01650016
.*    SINCE DERSIPMT IS RECORDED WITH DERRA1OR EREP GIVES      @DA42922 01660016
.*      ERROR MESSAGES ABOUT UNIDENTIFIED SENSE DATA.          @DA42922 01670016
.*    FIX AN EREP BUG WHICH INDICATES UNKNOWN TYPE OF DEVICE   @DA42853 01680016
.*      FOR SENSE DATA WHERE RECORDING IS NOT RECOMMENDED IN   @DA42853 01690016
.*      HARDWARE MANUALS.                                      @DA42853 01700016
.*    IN CASE OF A CORRECTABLE DATA CHECK THE CSW IS PRESENTED @DA42853 01710016
.*      WITH A MERE UNIT CHECK BIT AND NOTHING ELSE IN THE     @DA42853 01720016
.*      STATUS. IF NOW THE UNIT CHECK BIT IS SET OFF AFTER     @DA42853 01730016
.*      A SUCCESSFUL DATA CORRECTION OPERATION AND THE DATA    @DA42853 01740016
.*      ARE COMPLETE (THE CHAIN DOES NOT HAVE TO BE CONTINUED) @DA42853 01750016
.*      THE STATUS THAT IS POSTED BACK TO THE USER IS A SIMPLE @DA42853 01760016
.*      ZERO. THERE IS A PRODUCT FROM CA CALLED DATACOMM/DB    @DA42853 01770016
.*      WHICH LOOKS FOR CHANNEL END DEVICE END AND CONSIDERS   @DA42853 01780016
.*      EVERYTHING ELSE AN ERROR. THEY COULD NOT LIVE WITH     @DA42853 01790016
.*      THIS. SO WE NOW INSERT A CHANNEL END DEVICE END        @DA42853 01800016
.*      IF THE RESULT IS ZERO AFTER SETTING OFF UNIT CHECK.    @DA42853 01810016
.*    FOR A 3880 MODEL 23 AND 3380 MODEL K DISK THE ERROR      @DA42840 01820016
.*      CORRECTION OF A CORRECTABLE DATA CHECK IS NORMALLY DONE@DA42840 01830016
.*      IN THE CONTROL UNIT ITSELF. WHEN THE RECORD HAS BEEN   @DA42840 01840016
.*      READ INTO THE CONTROL UNIT INTERNAL STORAGE, IT LOOKS  @DA42840 01850016
.*      AT THE ECC BYTES AT THE END AND FIXES THE DATA.        @DA42840 01860016
.*      IT THEN SIGNALS CHANNEL COMMAND RETRY TO THE CHANNEL   @DA42840 01870016
.*      AND DELIVERS THE CORRECTED DATA. ONLY FOR PCI FETCH    @DA42840 01880016
.*      MODE IT WOULD RAISE A CORRECTABLE DATA CHECK SINCE THE @DA42840 01890016
.*      CHANNEL MAY HAVE LEFT THE DATA TO A USER PROGRAM       @DA42840 01900016
.*      ALREADY. NOW WITH 5E READ MULTIPLE COUNT KEY DATA      @DA42840 01910016
.*      THIS INTERNAL CORRECTION DOES NOT WORK. HENCE SENSE    @DA42840 01920016
.*      DATA ARE PRESENTED TO THE HOST THAT SHOW A PLAIN       @DA42840 01930016
.*      DATA CHECK (DERECD11) WITH BYTE 7 X53, MEANING         @DA42840 01940016
.*      CORRECTION INFORMATION WOULD HAVE BEEN THERE. THERE IS @DA42840 01950016
.*      A RECOVERY ACTION FOR THIS WHICH IS NOT DESCRIBED IN   @DA42840 01960016
.*      THE STORAGE CONTROLLER MANUAL: SPLIT UP THE 5E         @DA42840 01970016
.*      COMMAND INTO A SEQUENCE OF 1E COMMANDS. FOR THESE      @DA42840 01980016
.*      THE INTERNAL CORRECTION IS DONE AND THE SEQUENCE ENDS  @DA42840 01990016
.*      WITHOUT A UNIT CHECK. WE HAVE NOT IMPLEMENTED THIS     @DA42840 02000016
.*      KIND OF RECOVERY, BUT FCOPY HAS. THIS APAR JUST        @DA42840 02010016
.*      SUPPRESSES THE MESSAGE ABOUT THE UNSUCCESSFUL RECOVERY @DA42840 02020016
.*      IN CASE THE CALLER HAD ACCUNRIO ON. THIS SUPPRESSION   @DA42840 02030016
.*      WAS ASKED FOR BY A NUMBER OF US CE'S AND SE'S SINCE    @DA42840 02040016
.*      THE MESSAGE WOULD OCCUR ALMOST EVERY TIME A FCOPY      @DA42840 02050016
.*      RUN WAS DONE TO THIS KIND OF HARDWARE. ALTHOUGH THE    @DA42840 02060016
.*      MESSAGE WAS OF TYPE INFORMATION POSTED, IT LEAD TO     @DA42840 02070016
.*      AN UNREASONABLE NUMBER OF NIGHTLY PHONECALLS WITH      @DA42840 02080016
.*      CUSTOMERS.                                             @DA42840 02090016
.*    HARDWAIT IN DERFAST AT LABEL DERFI40 COULD OCCUR SINCE   @DA42840 02100016
.*      THE DSK TASK WAS RUNNING FOR ITSELF AND STILL ACCESSED @DA42840 02110016
.*      THE (RECONLY-) USERS CCB. SINCE THE USER SPACE WAS NOT @DA42840 02120016
.*      SET UP, AND SOMEONE ELSE BUT THE USER HAD BEEN         @DA42840 02130016
.*      DISPATCHED IN BETWEEN WE GRAB INTO THE WRONG SPACE.    @DA42840 02140016
.*      RESULT IS HARDWAIT FFF                                 @DA42840 02150016
.*    AVOID POSSIBLE HARDWAIT FOR FBA DEVICES WITH UNSOLICITED @DA42992 02160016
.*      INTERRUPT AND UNIT CHECK AND WITH A SPACE SWITCH       @DA42992 02170016
.*      BETWEEN THE OCCURRENCE OF THIS UNIT CHECK AND THE      @DA42992 02180016
.*      HANDLING OF IT IN SGDSK. DER17000 MUST NOT SCAN FOR    @DA42992 02190016
.*      LAST USED LOCATE BLOCK IF THERE IS NO USER CCB.        @DA42992 02200016
.*    WHEN AN ERROR CONDITION COULD BE RECOVERED BY RETRIES    @DA42963 02210016
.*      AFTER PATH SWITCHING, THE PATH ON WHICH THE ERROR      @DA42963 02220016
.*      OCCURRED IS NOT TAKEN DOWN ANYMORE.                    @DA42963 02230016
.*    IF USER CCB HAS SET DASDRRDC, NO MESSAGING IS DONE IN    @DA42963 02240000
.*      CASE OF UNSUCCESSFUL RECOVERY OF A FORMAT 5 DATA       @DA42963 02250016
.*      CHECK. THIS IS AN ENHANCEMENT OF DY42840, THAT MADE    @DA42963 02260016
.*      MESSAGING DEPENDENT ON THE ACCUNRIO BIT AND ON THE     @DA42963 02270016
.*      DEVICE AND CONTROL UNIT TYPE. A FCOPY APAR WILL ENSURE @DA42963 02280016
.*      THAT FCOPY SETS ON DASDRRDC FOR ALL ITS I/O REQUESTS.  @DA42963 02290000
.*    IF WE SET UP A RECOVERY CCW CHAIN WE MUST NOT ONLY CHECK @DA43137 02300016
.*      FOR SEEK, BUT SEEK CYLINDER COMMANDS TOO               @DA43137 02310016
.*    IN CASE OF ERROR CONDITION DERECFLY, ONLY ONE TIME       @DA43137 02320016
.*      MESSAGING IS DONE AFTER UNSUCCESSFUL RECOVERY INSTEAD  @DA43137 02330016
.*      OF IMMEDIATE MESSAGING.                                @DA43137 02340016
.*    IN CASE OF A ICKDSF RECONLY REQUEST, SGDSK IS LEFT TO    @DA43182 02350016
.*      THE DISPATCHER EXIT W/O RECORDING. THERE WAS A CUSTOMER@DA43182 02360016
.*      RUNNING ICKDSF ANALYZE EVERY WEEK AND IT KEPT RECORDING@DA43182 02370016
.*      THINGS IN THE RECORDER FILE FOR TRACKS HE NEVER USED.  @DA43182 02380016
.*      ICKDSF SAID IT WOULD ANALYZE ITS ERRORS ITSELF AND     @DA43182 02390016
.*      GIVE APPROPRIATE HINTS. HENCE IT WOULD NOT BE REQUIRED @DA43182 02400016
.*      TO FLOOD THE USERS RECORDER FILE FOR THESE RUNS.       @DA43182 02410016
.*    11/05/93    RELEASE 6.1.0                                @D61ADJK 02420016
.*      NEW DEVICE SUPPORT FOR 3990-6/7 AND 3390-9.            @D61ADJK 02430016
.*      3350 SUPPORT IS DROPPED.                               @D61ADJK 02440016
.*      ERP TASK WILL WRITE SUBSYSTEM MESSAGE IN CASE OF       @D61ADJK 02450016
.*      SUCCESSFUL SUSPENSION OF A DUPLEX PAIR.                @D61ADJK 02460016
.*      IF USER CCB HAS SET THE CHNBIT, THE CHANNEL PROGRAM    @D61ADJK 02470016
.*      CAN'T BE SCANNED AND NO SEEK ARGUMENT IS RETRIEVED.    @D61ADJK 02480016
.*      VM INTERCEPT ERROR CONDITIONS IN ECKD AND 24+8 SENSE   @D61ADJK 02490016
.*      DATA FORMAT ARE NOW RECOGNIZED AND HANDLED PROPERLY.   @D61ADJK 02500016
.*      ERROR CONDITION PINNED DATA - INFORMATIONAL (DERECPDI) @D61ADJK 02510016
.*      IS NOW RECORDED AND THE USER'S CHANNEL PROGRAM IS      @D61ADJK 02520016
.*      SCANNED FOR THE LAST USED SEEK ADDRESS.                @D61ADJK 02530016
.*      INTRODUCE ERROR CLASSIFICATION CODE DERECFWI (DASD     @D61ADJK 02540016
.*      FAST WRITE INHIBITED) FOR 24+8 SENSE DATA FORMAT.      @D61ADJK 02550016
.*      ERROR CONDITION DERECIDF (INVALID TRACK FORMAT DURING  @D61ADJK 02560016
.*      STAGING OR DESTAGING) IS NOW RECOGNIZED AND HANDLED    @D61ADJK 02570016
.*      PROPERLY.                                              @D61ADJK 02580016
.*    THE RETRY LIMIT FOR MACHINE STATE EXCEPTIONS IS          @DA43510 02590000
.*      INCREASED FROM 10 TO 255. RAMAC DASDS NEED SOME MORE   @DA43510 02600000
.*      TIME FOR DESTAGING A TRACK AND AFTER 10 RETRIES THIS   @DA43510 02610000
.*      PROCESS MIGHT NOT BE COMPLETED YET.                    @DA43510 02620000
.*    DERFAST MISINTERPRETS BYTE 12, BIT 2 IN IORB. IN CASE    @DA43585 02630000
.*      OF AN IRRECOVERABLE I/O ERROR, PROGRAMS USING AN IORB  @DA43585 02640000
.*      WITH THIS BIT SET WON'T BE CANCELLED.                  @DA43585 02650000
.*    ISSUE A SIM MESSAGE, IF MESSAGING IS REQUESTED IN SIM    @DA43984 02660000
.*      SENSE DATA BUT THE RECONLY BIT IS SET IN THE ORIGINAL  @DA43984 02670000
.*      ERROR ENTRY.                                           @DA43984 02680000
.*      ALLOW SGDSK I/O REQUESTS ONLY ON PATHES CONTAINED IN   @D61SDJK 02690000
.*      USER CCB PATH MASK.                                    @D61SDJK 02700000
.*      DON'T SET PUBCSFLG.OPINTV IN SUBROUTINES DERIRQ/DERDWI.@D61SDJK 02710000
.*      MAINTAIN SAVED LOCK MANAGER LOGICAL PATH MASK IN PUBX. @D61SDJK 02720000
.*    USER CCB BYTE 12, BIT 3 IS INTRODUCED AS 'RETURN INVALID @D61SDJK 02730000
.*      TRACK FORMAT WRITE' INDICATION. IF SET, AN INVALID     @D61SDJK 02740000
.*      TRACK FORMAT ERROR CONDITION WILL BE PASSED BACK TO    @D61SDJK 02750000
.*      THE USER AND NO ERROR MESSAGE WILL BE WRITTEN.         @D61SDJK 02760000
.*    MORE TASKS SUPPORT                                       @D66CDAP 02770016
.*    LCK-DEVICE RESET NOTIFICATION NOT PROPERLY RECOGNIZED    @DY46XXX 02771029
.*                                                                      02780016
.* ** END OF SPECIFICATIONS **************************************** */ 02790016
.*                                                                      02800016
.*                                                                      02810016
.*                                                                      02820016
*********************************************************************** 02830016
*                                                                     * 02840016
*                  RESIDENT ERROR RECOVERY PROCEDURE                  * 02850016
*                                                                     * 02860016
* FUNCTION                                                            * 02870016
*                                                                     * 02880016
*   THE FUNCTION OF THE RESIDENT DISK ERP IS TO RECOVER FROM          * 02890016
*   I/O ERRORS OCCURRING ON DIRECT ACCESS STORAGE DEVICES.            * 02900016
*                                                                     * 02910016
*   ALL DETAILS OF THE FUNCTION PROVIDED ARE DOCUMENTED IN            * 02920016
*   THE FOLLOWING:  FUNCTIONAL SPECIFICATION VSE/AF 5.1.1             * 02930016
*   DISK/TAPE ERP BY BRYAN HENDERSON.                                 * 02940016
*                                                                     * 02950000
* ENTRY POINTS                                                        * 02960000
*                                                                     * 02970000
*        DER0000                                                      * 02980000
*                                                                     * 02990000
* EXTERNAL REFERENCES                                                 * 03000000
*                                                                     * 03010000
*   THE FOLLOWING SUPERVISOR ROUTINES, NOT GENERATED BY SGDSK,        * 03020016
*   ARE USED TO ASSIST IN PROVIDING DASD ERP.  A BRIEF DESCRIPTION    * 03030016
*   OF WHAT FUNCTION EACH ROUTINE PROVIDES ACCOMPANIES ITS NAME.      * 03040016
*                                                                     * 03050000
*      INTEQPST    - USED TO QUEUE AN ERROR BLOCK FOR ASYNCHRONOUS    * 03060016
*                    PROCCESSING BY THE ERP TASK.                     * 03070016
*      GETDADR     - USED TO GET THE ADDRESS OF A BYTE OF DATA        * 03080016
*                    ASSOCIATED WITH A CCW.                           * 03090016
*      AVRFVCTE    - USED TO GET THE BLOCK SIZE OF AN FBA DEVICE.     * 03100016
*      VIRTAD      - USED TO VALIDATE AND/OR VIRTUALIZE A GIVEN       * 03110016
*                    ADDRESS.                                         * 03120016
*                                                                     * 03130000
*   THE FOLLOWING SUPERVISOR SERVICES, NOT GENERATED BY SGDSK,        * 03140016
*   ARE USED TO ASSIST IN PROVIDING DASD ERP.  A BRIEF DESCRIPTION    * 03150016
*   OF WHAT EACH SERVICE IS USED FOR ACCOMPANIES THE NAME.            * 03160016
*                                                                     * 03170000
*      REALAD      - USED TO CONVERT A VIRTUAL ADDRESS TO A REAL      * 03180016
*                    ADDRESS.  THIS SERVICE IS ACCESSED THROUGH       * 03190016
*                    THE REALAD MACRO.                                * 03200016
*                                                                     * 03210000
*                                                                     * 03220000
* PROCESSING                                                          * 03230016
*                                                                     * 03240016
*    SGDSK IS PROCESSING ON A CHAIN OF DEVICE ERROR ENTRIES.          * 03250016
*    TESE DEVICE ERROR ENTRIES (MAPPED BY ERBLKADR DSECT)             * 03260016
*    MAY EITHER BELONG TO A PUBX (PBXERBLK) OR TO A TCB OF            * 03270016
*    A SYSTEM TASK.                                                   * 03280016
*    THE  CHAIN IS CHAINED FROM THE ERROR BLOCK AND CONTAINS          * 03290016
*    ONE OR MORE ENTRIES FOR ONE OR MORE DEVICES.                     * 03300016
*    SGDSK ALWAYS TAKES AN ERROR BLOCK OUT OF THE CHAIN AND           * 03310016
*    STARTS PROCESSING ON IT. FOR THIS PURPOSE IT COPIES THE          * 03320016
*    ERROR BLOCK INTO A PART OF ITS GLOBAL WORK AREA, CALLED          * 03330016
*    DERINWRK. HOWEVER THIS IS ONLY FOR CONVENIENCE AND THE           * 03340016
*    ACTIVE BIT ON THE ORIGINAL ERROR ENTRY IS NOT RESET.             * 03350016
*    AT THE END OF PROCESSING, THE ENTRY IS FILLED AGAIN              * 03360016
*    WITH THE DERINWRK INFORMATION AND WE WILL LEAVE WITH THIS        * 03370016
*    ORIGINAL ERROR ENTRY.                                            * 03380016
*    PROCESSING OF THE DEVICE ERROR ENTRY IS DONE IN A BIG            * 03390016
*    LOOP WHICH IN ALL CONTAINS THE FOLLOWING LOGIC:                  * 03400016
*                                                                     * 03410016
*          1.) IDENTIFY THE ERROR YOU HAD AND                         * 03420016
*              DECIDE WHAT RECOVERY AND RECORDING WILL BE DONE.       * 03430016
*          2.) DECIDE IF ITS A NEW ERROR WE ARE SEEING, IN ORDER      * 03440016
*              TO REINITIALIZE SOME VALUES. THE OLD ERROR IS          * 03450016
*              CONSIDERED OVERCOME, IF THE ERROR SYMPTOMS CHANGE      * 03460016
*              THE NEW GAME THEN IS WITH FRESH RETRY COUNTS AND       * 03470016
*              A NEW SET OF CHPIDS (CHANNEL PATHS TO THE DEVICE)      * 03480016
*              ALLOWED.                                               * 03490016
*          3.) DO THE RECOVERY.                                       * 03500016
*              IF THIS RECOVERY IS SUCCESSFUL LEAVE LOOP              * 03510016
*          4.) DO THE MESSAGING AND RECORDING FOR THE PRE-RECOVERY    * 03520016
*              ATTEMPT ERROR WHICH WE HAVE.                           * 03530016
*          5.) OBTAIN THE SENSE DATA (WE HAD USER WANTS SENSE ON)     * 03540016
*              GOTO 1.)                                               * 03550016
*                                                                     * 03560016
*    EVENTUALLY THE RECOVERY WILL BE COMPLETE AND SGDSK LEAVES        * 03570016
*    THE LOOP. NOW A NUMBER OF STEPS IS STILL TAKEN TO DO             * 03580016
*    SOME FINAL MESSAGING AND RECORDING. FURTHERMORE THE EXIT         * 03590016
*    IS DETERMINED AND SGDSK IS LEFT.                                 * 03600016
*    FOR EXITS SEE HEADING EXIT.                                      * 03610016
*                                                                     * 03620016
* GATING OF THE PUB                                                   * 03630016
*                                                                     * 03640016
*    NORMALLY THE PUB IS GATED AS QUEUED IN ERROR EVERY TIME AN       * 03650016
*    ERROR OCCURED ON THE DEVICE. THIS GATING IS ONLY RESET IF        * 03660016
*    DSKEXIT IS ENTERED BY DSK OR ERP TASK AND THE DEVICE             * 03670016
*    ERROR ENTRY THAT IS CHAINED FROM THE PUBX INDICATES, THAT        * 03680016
*    THERE IS NO ERROR KNOWN ON THIS DEVICE ANY MORE.                 * 03690016
*    IF A PUB IS GATED AS QUEUED IN ERROR, ONLY SYSTEM TASK           * 03700016
*    IO WILL BE ALLOWED ON IT. NO USER TASK IS STARTED ANY MORE.      * 03710016
*                                                                     * 03720016
*    USUALLY THERE IS ONE USER TASK QUEUED TO THE PUB WITH            * 03730016
*    THE QUEUED IN ERROR INDICATION SET IN THE CHQFLG1.               * 03740016
*    IT IS THE ONE THAT OCCUPIES THE PUBX DEVICE ERROR ENTRY.         * 03750016
*    NOW IO IS DONE BY THE DSK TASK AND THE ERP TASK. THIS IO         * 03760016
*    CAN FAIL AND TCB DEVICE ERROR ENTRIES ARE FILLED. THE PUBX       * 03770016
*    DEVICE ERROR ENTRY IS THE ONE THAT WILL CONTROL THE GATING.      * 03780016
*    ONLY IF IT IS COMPLETELY PROCESSED, WILL THE GATING BE RESET.    * 03790016
*    NUMEROUS APARS HAVE BEEN CAUSED BY A HUNG QEDERR BIT IN   @DA42666 03800016
*    PUBCSFLG.                                                 @DA42666 03810016
*                                                                     * 03820016
* MESSAGING AS A WHOLE.                                               * 03830016
*                                                                     * 03840016
*    THERE IS FOUR  DIFFERENT KINDS OF MESSAGING AND RECORDING        * 03850016
*    NECESSITIES. THEY ARE MODELLED AFTER THE PRESCRIBED LOGGING      * 03860016
*    AND MESSAGING ACTIONS AS GIVEN IN BYTE 24 OF ECKD SENSE DATA.    * 03870016
*    EITHER MESSAGING HAS TO BE DONE                                  * 03880016
*    - NEVER (NO MESSAGING REQUIRED FOR THIS ERROR )                  * 03890016
*    - UNCONDITIONAL (THERE SHOULD ALWAYS BE A MESSAGE)               * 03900016
*    - ONCE (REGARDLESS OF RECOVERY SUCCESS OR NOT, BUT ONCE FOR      * 03910016
*            EVERY PATH THAT IS TRIED FOR RECOVERY)                   * 03920016
*    - ONLY IF RECOVERY IS NOT SUCCESSFUL                             * 03930016
*                                                                     * 03940016
*    THE SAME KIND OF DIFFERENTIATION APPLIES FOR RECORDING.          * 03950016
*    IN SGDSK WE HAVE TWO PLACES, WHERE RECORDING AND MESSAGING       * 03960016
*    IS BEING HANDLED. ONE IS AFTER THE RECOVERY ATTEMPT. IF IT       * 03970016
*    FAILS, THE RECORD./MSG. FOR THE FAILING PREVIOUS IO IS DONE      * 03980016
*    BEFORE WE SET UP THE DERINWRK WITH THE NEW SENSE DATA FOR        * 03990016
*    THE NEW FAILURE.                                                 * 04000016
*    THE SECOND PLACE IS AFTER WE LEFT THE RECOVERY LOOP. HERE        * 04010016
*    A RECORDING IS DONE WITH ANOTHER WORK ERROR BLOCK, AND           * 04020016
*    WE PREPARE FOR FINAL MESSAGING WITH THE DERINWRK. THE BITS       * 04030016
*    WE SET IN THIS CASE WILL LATER BE COPIED INTO THE ERROR          * 04040016
*    BLOCK WE DECHAINED FROM THE DSK CHAIN OF DEVICE ERROR ENTRIES,   * 04050016
*    SINCE WE WANT TO LEAVE SGDSK WITH THIS ORIGINAL ERROR ENTRY.     * 04060016
*                                                                     * 04070016
* IMMEDIATE MESSAGING AND RECORDING.                                  * 04080016
*                                                                     * 04090016
*    THE IMMEDIATE MESSAGING AND RECORDING IS DONE WITH THE           * 04100016
*    RECONLY FLAG ON. IT IS REQUIRED IF FOR EXAMPLE A DEVICE          * 04110016
*    GIVES A NUMBER OF SYSTEM INFORMATION MESSAGES. ALL OF            * 04120016
*    THESE MESSAGES SHOULD BE LOGGED.                                 * 04130016
*    IN THIS PROCESS THE RECONLY BIT WILL ENSURE, THAT THE            * 04140016
*    EXIT FROM THE TRANSIENT ERP DOES NOT POST OR IGNORE OR           * 04150016
*    HAVE ANY OTHER INFLUENCE ON THE PROCESSING OF THE                * 04160016
*    REQUEST THAT FAILED ORIGINALLY. FOR THE MEANING OF THE           * 04170016
*    RECONLY BIT IN GENERAL SEE THE HEADING 'RECONLY BIT:'            * 04180016
*                                                                     * 04190016
* FINAL PATH DOWN MESSAGES, SIM MESSAGES FOR RECONLY REQUESTS  @DA43984 04200000
* AND FINAL RECORDING:                                         @DA43984 04210000
*                                                                     * 04220016
*    AT THE END OF THE RECOVERY PROCESS SGDSK DETERMINES IF           * 04230016
*    A PATH WAS SET DOWN IN THIS PROCESS. IF SO, A MESSAGE IS         * 04240016
*    GIVEN TO THE OPERATOR. LIKEWISE MESSAGING FOR SIM RECONLY @DA43984 04250000
*    REQUESTS AND FINAL RECORDING IS DONE.                     @DA43984 04260000
*    THE ERROR BLOCKS HANDED OVER TO ERP FOR THIS PURPOSE ARE         * 04270016
*    NOT THE ORIGINAL ERROR BLOCK WE RECEIVED FROM THE DSK            * 04280016
*    CHAIN. HENCE THEY DO NOT RESET THE GATING OF THE PUB.            * 04290016
*                                                                     * 04300016
* DUPLEX PAIR SUSPENSION MESSAGE:                                     * 04310016
*                                                                     * 04320016
*    FOR SOME REASON, SGDSK MIGHT PUT A DUPLEX PAIR INTO       @D61ADJK 04330016
*    SUSPENDED DUPLEX STATE. IF THE SUSPENSION COMPLETES       @D61ADJK 04340016
*    SUCCESSFULLY, A MESSAGE IS GIVEN TO THE OPERATOR BY       @D61ADJK 04350016
*    THE ERP TASK. THE DUPLEX PAIR SUSPENSION MESSAGE IS       @D61ADJK 04360016
*    INDICATED IN A WORK ERROR ENTRY THAT IS PASSED TO ERP.    @D61ADJK 04370016
*    WHEN THE MESSAGE REQUEST IS RECOGNIZED, ERP TASK IS       @D61ADJK 04380016
*    CALLING SUBROUTINE DERMSG AND THE MESSAGE IS WRITTEN.     @D61ADJK 04390016
*                                                                     * 04400016
* FINAL MESSAGING:                                                    * 04410016
*                                                                     * 04420016
*    ONCE AN ERROR HAS BEEN RECOVERED (OR RECOVERY WAS                * 04430016
*    EXHAUSTED FOR IT) SGDSK IS LEFT TO DSKEXIT (WHICH IS             * 04440016
*    A LABEL IN SGERP OF THE SUPERVISOR). THERE IS THE                * 04450016
*    FOLLOWING REGISTER CONVENTION GIVEN FOR THIS EXIT:               * 04460016
*    RF CONTAINS A RETURN CODE (OR RATHER AN ADDRESS),                * 04470016
*    WHICH IS DESCRIBED UNDER HEADING 'RETURN CODES:'                 * 04480016
*    R3 POINTS TO THE PUB OF THE DEVICE WE ARE WORKING WITH.          * 04490016
*    R2 CONTAINS THE POINTER TO THE ERROR BLOCK THAT HAD              * 04500016
*    BEEN TAKEN FROM THE DSK ERROR CHAIN FOR THE ORIGINAL             * 04510016
*    ERROR.                                                           * 04520016
*    IF WE WANT TO HAVE SOME MESSAGING DONE,                          * 04530016
*    WE SET NEEDERP ON IN THE ERROR ENTRY AND SGERP WILL              * 04540016
*    QUEUE IT TO THE ERP CHAIN OF DEVICE ERROR ENTRIES.               * 04550016
*    THIS WILL KEEP THE PUBX ERROR ENTRY OCCUPIED AND HENCE           * 04560016
*    AVOID RESETTING OF THE GATING OF THE PUB. IT COULD               * 04570016
*    OTHERWISE BE, THAT WITH THE SCHEDULING OF NEW IO ON THIS         * 04580016
*    DEVICE WE WOULD RESCHEDULE THE REQUEST THAT LEAD TO THE          * 04590016
*    ORIGINAL ERROR AND CAUSE A LOOP IN DOING SO.                     * 04600016
*                                                                     * 04610016
*    IF MESSAGING IS FOR A TCB DEVICE ERROR ENTRY,                    * 04620016
*    THE RECONLY BIT MUST BE SET ON. THE SYSTEM TASK SHALL            * 04630016
*    CONTINUE PROCESSING AND NOT WAIT UNTIL THE ERP HAS FINISHED      * 04640016
*    ITS PROCESSING. HOWEVER THE RECONLY BIT WOULD NOT HAVE AN        * 04650016
*    INFLUENCE ON THE GATING OF THE PUB. EVEN IF IT WERE OFF,         * 04660016
*    THE PUB WOULD REMAIN GATED (OR NOT GATED) AS INDICATED BY        * 04670016
*    THE PUBX-ERROR ENTRY.                                            * 04680016
*    IF WE CHOOSE TO WRITE A SYNCHRONOUS FINAL MESSAGE, WE            * 04690016
*    WILL LEAVE WITH THE DISPATCHER ADDRESS IN REGISTER RF,           * 04700016
*    SINCE EVENTUALLY THE ERP TASK WILL DO THE IGNORE, RETRY          * 04710016
*    OR CANCEL OPERATION WE WANTED.                                   * 04720016
*    IF WE WRITE A MESSAGE WITH RECONLY ON WE MAY NOT GO TO           * 04730016
*    THE DISPATCHER SINCE OTHERWISE WE WOULD LEAVE TO IT,             * 04740016
*    THE ERP WOULD LEAVE TO IT, AND THE REQUEST WOULD NEVER           * 04750016
*    BE DEQUEUED. IT IS POSTED, BUT IT IS NOT YET DEQUEUED.           * 04760016
*    IF WE LEAVE TO THE DISPATCHER IT JUST STAYS..                    * 04770016
*                                                                     * 04780016
* UNPOSTING OF DSK TASK OR LEAVE IN CASE OF STAND ALONE SUPERVISOR    * 04790016
*                                                                     * 04800016
*    WHEN THE DSK TASK HAS NO MORE ERRORS TO PROCESS ITS EXIT         * 04810016
*    DEPENDS UPON WHETHER THE CODE GERNERATED IS FOR THE STANDALONE   * 04820016
*    OR REGULAR VSE SUPERVISOR.  FOR THE REGULAR VSE SUPERVISOR       * 04830016
*    THE EXIT IS UNPOST.  OTHERWISE THE EXIT IS DSKEXIT WITH THE      * 04840016
*    IGNORE RETURN CODE, ERPXAD4.                                     * 04850016
*                                                                     * 04860016
* THE ANALYSIS OF SENSE DATA BY SUBROUTINE DERFAST:                   * 04870016
*                                                                     * 04880016
*    DERFAST IS WRITTEN AS A SUBROUTINE THAT CAN ALSO BE CALLED       * 04890016
*    FROM THE SENSE TASK. IT SERVES TWO PURPOSES. ONE IS THAT THE     * 04900016
*    SENSE DATA MAY INDICATE, THAT A PATH GROUP ID HAS TO BE          * 04910016
*    SET AGAIN BY VSE. THIS CAN ONLY BE DONE BY THE SENSE TASK,       * 04920016
*    SINCE OTHERWISE SOMEONE MAY BE USING PATHS, THAT ARE NOT         * 04930016
*    VERIFIED TO LEAD TO THE CORRECT DEVICE AND SYSTEM MAY EVEN       * 04940016
*    BE IN A HANG CONDITION BECAUSE OF DIFFERENT MULTIPATHING         * 04950016
*    INFORMATION IN THE SUBCHANNEL AND THE DEVICE.                    * 04960016
*    FURTHERMORE THE SUBROUTINE CAN BE USED TO SHORTCUT THE           * 04970016
*    POSTING OF THE MOST FREQUENT ERROR CONDITIONS WITHOUT            * 04980016
*    INVOKING SGDSK.                                                  * 04990016
*                                                                     * 05000016
* THE RECONLY BIT:                                                    * 05010016
*                                                                     * 05020016
*    THE MEANING OF THE RECONLY BIT NORMALLY IS:                      * 05030016
*    " THE USER HAS BEEN POSTED ALREADY"                              * 05040016
*    THIS IMPLIES, THAT HIS DATA CAN NOT BE ACCESSED ANY MORE.        * 05050016
*    THE BIT MAY NEVER BE SET OFF BY SGDSK, SINCE THIS CON-           * 05060016
*    DITION CAN NOT BE REVERSED BY ANY MEANS. STILL IT MAY            * 05070016
*    BE, THAT A SYSTEM TASK SHOULD NOT WAIT FOR THE COMPLETION        * 05080016
*    OF A MESSAGING REQUEST. THIS MEANS, THAT SGDSK WOULD SET         * 05090016
*    RECONLY ON IN AN ERROR ENTRY GIVEN TO DSKEXIT FOR FINAL          * 05100016
*    MESSAGING AND RECORDING. ERP ALWAYS LEAVES TO THE DISPATCHER,    * 05110016
*    IF THE RECONLY BIT IS SET IN THE ERROR ENTRY THAT IT PROCESSES.  * 05120016
*                                                                     * 05130016
*    IF RECONLY IS ON, WHEN SGDSK IS ENTERED, WE CAN DO SOME          * 05140016
*    RECORDING IF APPROPRIATE BUT MAY NEVER TOUCH THE USER            * 05150016
*    DATA LIKE CCB OR CCW ANY MORE (SO CALLED MINIMAL ERP)            * 05160016
*    SINCE THE USER WAS POSTED ALREADY, WE SHOULD RETURN TO           * 05170016
*    THE DISPATCHER (ERPXAD1) AND THE ERROR ENTRY WE TAKE             * 05180016
*    WITH US TO DSKEXIT SHOULD INDICATE RECONLY FOR THE               * 05190016
*    RECORDING AND MESSAGING TOO.                                     * 05200016
*                                                                     * 05210016
*    IF HOWEVER RECONLY WAS SET ON BY SGDSK (IN THE DEVICE ERROR      * 05220016
*    ENTRY THAT WE TAKE WITH US TO DSKEXIT), IN ORDER TO NOT          * 05230016
*    LET A SYSTEM TASK WAIT FOR THE ERP MESSAGING BEING               * 05240016
*    FINISHED, WE >>MUST NOT<< LEAVE TO THE DISPATCHER,               * 05250016
*    SINCE OTHERWISE THE TASK WOULD >>NEVER<< BE POSTED.              * 05260016
*    (SYSTEM HANGS !!!)                                               * 05270016
*                                                                     * 05280016
*    IN GENERAL THE RECONLY BIT IS SET ON FOR ALL THOSE REQUESTS,     * 05290016
*    THAT WE WANT TO SEE PROCESSED ASYNCHRONOUSLY. THIS IS THE        * 05300016
*    IMMEDIATE MESSAGING AND RECORDING, THE PATH DOWN MESSAGE,        * 05310000
*    MESSAGING FOR A SIM RECONLY REQUEST AND FINAL RECORDING.  @DA43984 05320000
*    HOWEVER, IF THE BIT IS SET ON FOR THE FINAL MESSAGE OF    @DA42666 05330016
*    AN UNSOLICITED ERROR THE BIT QEDERR IN PUBCSFLG IS NOT    @DA42666 05340016
*    RESET BY DSKEXIT AND THIS LEADS TO A SOFTWAIT CONDITION.  @DA42666 05350016
*    ONE SHOULD NOT WARN THE SYSTEM TO TOUCH A CONTROL BLOCK   @DA42666 05360016
*    OF A TASK, IF THAT TASK NEVER EXISTED (LIKE WITH AN       @DA42666 05370016
*    UNSOLICITED ERROR).                                       @DA42666 05380016
*                                                                     * 05390016
* RETURN CODES (RATHER ADDRESSES) IN REGISTER RF ON EXIT:             * 05400016
*                                                                     * 05410016
*    THE RETURN CODE DEPENDS UPON THE RESULTS OF ERROR RECOVERY.      * 05420016
*                                                                     * 05430016
*    WHEN THE ERROR IS NOT SUCCESSFULLY OVERCOME BY THE ERP           * 05440016
*    PROCESSING, SO THAT THE USER COULD CONTINUE AS IF NOTHING        * 05450016
*    SPECIAL HAD HAPPENED, AND THE USER DID NOT SPECIFY, THAT         * 05460016
*    HE IS PREPARED FOR THIS CASE,                                    * 05470016
*    THE CANCEL RETURN CODE, ERPXAD5, IS GIVEN.                       * 05480016
*                                                                     * 05490016
*    WHEN THE ORIGINAL ERROR CONDITION IS SUCCESSFULLY RECOVERED      * 05500016
*    THE IGNORE RETURN CODE, ERPXAD4, IS GIVEN.                       * 05510016
*                                                                     * 05520016
*    IF SGDSK PLACES THE DEVICE IN THE INTERVENTION REQUIRED          * 05530016
*    STATE AND THE TASK IS A SYSTEM TASK OR A TASK THAT HAD           * 05540016
*    HEAD QUEUEING ON IN THE CHANNEL QUEUE FLAGS                      * 05550016
*    THE RETURN CODE IS ERPXMWRT ("EMERGENCY MESSAGE IS               * 05560016
*    REQUIRED").                                                      * 05570016
*                                                                     * 05580016
*    WHEN RECOVERY FOR THE ORIGINAL ERROR CONDITION ENCOUNTERS A      * 05590016
*    STATE CHANGE/EMERGENCY DESTAGE ERROR ERPXRDLY IS GIVEN AS        * 05600016
*    THE RETURN CODE.                                                 * 05610016
*                                                                     * 05620016
*    IN SOME CASES SENSE DATA INDICATE, THAT A PATH GROUP ID          * 05630016
*    MAY HAVE BEEN LOST. THIS IS NOW ALSO DETECTED BY THE SNS         * 05640016
*    TASK, WHICH IS DOING THE IO AND IT IS CORRECTED BEFORE SGDSK     * 05650016
*    IS ENTERED. SO WE CAN KEEP ON PROCESSING NORMAL                  * 05660016
*    AND DO RETRIES OR OTHER RECOVERY ACTIONS.                        * 05670016
*                                                                     * 05680016
*  THE CSW SETTING                                                    * 05690016
*                                                                     * 05700016
*    SGDSK IS HAVING A NUMBER OF DIFFERENT PLACES FOR CSWS.           * 05710016
*    THERE IS A WORK CSW IN DERWKCSW, WHICH IS ASSEMBLED              * 05720016
*    AFTER THE RECOVERY LOOP WAS RUN THRU AND THEN COPIED             * 05730016
*    INTO LOW CORE CSW                                                * 05740016
*    SECOND THERE IS THE FIELDS IN THE CCB, WHICH ALTOGETHER          * 05750016
*    MAKE UP A COMPLETE CSW TOO. IT IS THE WORKING CSW, WHICH         * 05760016
*    CHANGES EVERY TIME A RECOVERY ACTION IS DONE.                    * 05770016
*                                                                     * 05780016
*    THIRD THERE IS THE ERQCSW, WHICH IS PROVIDED BY THE SUPERVISOR.  * 05790016
*    IN THE DEVICE ERROR ENTRY. IT ALWAYS REPRESENTS THE CURRENT      * 05800016
*    ERROR STATUS, WHICH IS TO BE INCLUDED IN MESSAGES TO THE         * 05810016
*    CONSOLE FOR EXAMPLE. IT IS NOT AN ACCUMULATED STATUS ORIGINALLY. * 05820016
*    EVERY TIME SGDSK ENCOUNTERS A NEW ERROR, THE ERRQCSW IS SET TO   * 05830016
*    THIS NEW ERROR STATUS AGAIN.                                     * 05840016
*                                                                     * 05850016
*    THE LAST CSW IS THE CHANNEL QUEUE CSW OF THE CHANNEL QUEUE       * 05860016
*    ENTRY FOR THE ORIGINAL ERROR. THIS ONE CONTAINS AN ACCUMULATED   * 05870016
*    STATUS.                                                          * 05880016
*                                                                     * 05890016
*    WHEN WE LEAVE TO DSKEXIT, THE STATUS WE PUT INTO LOW CORE        * 05900016
*    CSW WILL BE MOVED INTO THE CHANNEL QUEUE CSW OF THE USER         * 05910016
*    ENTRY. THE SUPERVISOR REALLY WORKS WITH THE CSW IN LOW CORE      * 05920016
*    ALL DECISIONS WHAT TO DO IN THE INTERRUPT HANDLER ARE BASED      * 05930016
*    ON THE CSW IN LOW CORE. ONLY THE INFORMATION FOR POSTING THE     * 05940016
*    USERS CCB EVENTUALLY IS TAKEN FROM THE ACCUMULATED STATUS        * 05950016
*    IN THE CHANNEL QUEUE ENTRY.                                      * 05960016
*                                                                     * 05970016
*    THE FOLLOWING THINGS SHOULD BE AVOIDED: IF THERE WAS             * 05980016
*    A SECONDARY STATUS PRESENTED TO SGDSK (DEVICE END UNIT CHECK,    * 05990016
*    NO CCW ADDRESS), AND WE PUT THIS RIGHT INTO LOW CORE AND         * 06000016
*    HENCE INTO THE CHANNEL QUEUE CSW, THE USER WILL NOT HAVE HIS     * 06010016
*    PRIMARY STATUS (WHICH CONTAINS THE CCW ADDRESS NORMALLY) ANY     * 06020016
*    MORE.                                                            * 06030016
*    IF WE RECEIVE PURE PRIMARY (CHANNEL END, NO DEVICE END, UNIT     * 06040016
*    CHECK, ADDRESS) AND RETURN A PRIMARY+SECONDARY, WITHOUT          * 06050016
*    DOING IO, THEN THE INCOMING SECONDARY STATUS FROM THE DEVICE     * 06060016
*    MAY LEAD TO SOME CONFUSION.                                      * 06070016
*    IT MAY BE, THAT WE RECEIVE PRIMARY OR PRIMARY+SECONDARY          * 06080016
*    AND THE USER WAS POSTED AT PRIMARY ALREADY AND WE RETURN         * 06090016
*    THE SAME KIND OF STATUS. THIS IS NOT HARMFUL, SINCE THE          * 06100016
*    SUPERVISOR WOULD KNOW FROM THE CCB ADDRESS IF THE TASK           * 06110016
*    WAS POSTED ALREADY.                                              * 06120016
*                                                                     * 06130016
*                                                                     * 06140016
*    THE CURRENT LOGIC IS DOING THE FOLLOWING:                        * 06150016
*    THE CSW RELEVANT VALUES OF THE CCB ARE SET UP WITH THE           * 06160016
*    CHANNEL QUEUE ENTRY ENDING ADDRESS. THIS THIS IS AN ACCUMULATED  * 06170016
*    CSW, IT WOULD ALWAYS CONTAIN AN ENDING ADDRESS, EITHER FROM      * 06180016
*    PRIMARY OR SECONDARY STATUS (IF THERE WAS ONE OF COURSE).        * 06190016
*    THE STATUS BYTES FOR DEVICE AND CHANNEL STATUS ARE TAKEN         * 06200016
*    FROM THE ERRQCSW. (THIS IS ONLY IMPORTANT IF WE HAD A SUCCESSFUL * 06210016
*    RECOVERY WITHOUT DOING IO, FOR EXAMPLE IN A CORRECTABLE DATA     * 06220016
*    CHECK, WHICH DID NOT HAVE TO BE RESUMED. IN THIS CASE WE         * 06230016
*    MUST ENFORCE AN ENDING STATUS, IF IT NOT ALREADY IS ONE).        * 06240016
*                                                                     * 06250016
*    THE WE DO THE RECOVERY ACTIONS. THE RECOVERY ACTIONS WILL        * 06260016
*    NORMALLY DO IO AND HENCE REPLACE THE STATUS IN THE CCB.          * 06270016
*    THIS STATUS ALWAYS IS AN ACCUMULATED STATUS, SINCE WE            * 06280016
*    ISSUE THE SYSIO WITH POST AT DEVICE END ON.                      * 06290016
*                                                                     * 06300016
*    WHEN WE LEAVE THE MAIN RECOVERY LOOP, THERE ARE THREE CASES      * 06310016
*    POSSIBLE. FIRST: WE JUST GAVE UP. IN THIS CASE WE WILL LEAVE     * 06320016
*    THE ACCUMULATED STATUS IN THE CHANNEL QUEUE CSW AS IT IS AND     * 06330016
*    THE ONLY WAY TO DO THAT IS TO MOVE IT DOWN INTO LOW CORE CSW     * 06340016
*    (VIA DERWKCSW).                                                  * 06350016
*    SECOND: WE JUST GAVE UP, BUT WE HAD NO CHANNEL QUEUE ENTRY.      * 06360016
*    NOW THERE STILL IS A NEED TO PUT SOMETHING DOWN INTO LOW         * 06370016
*    CORE, WHICH WILL BE THE ERRQCSW WE RECEIVED..                    * 06380016
*    THIRD: WE DID SOME KIND OF RECOVERY ACTION. WE THEN TAKE         * 06390016
*    THE VALUES ACCUMULATED IN THE CCB TO SET UP LOW CORE.            * 06400016
*                                                                     * 06410016
*                                                                     * 06420016
.* DETAILS OF PROCESSING: ERROR RECOGNITION AND ACTION DETERMINATION  * 06430016
.*                                                                    * 06440016
.*   SGDSK DIFFERENTIATES BETWEEN THE NORMAL 24 BYTE SENSE, THE       * 06450016
.*   24+8 COMPATIBILITY SENSE AND THE REAL ECKD SENSE. IN ADDITION    * 06460016
.*   TO THIS, ALL SIM SENSE DATA ARE ALSO CALLED A CLASS OF THEIR     * 06470016
.*   OWN.                                                             * 06480016
.*   THE FIRST PART OF THE LOOP BETWEEN DER10000 AND DER22000 IS      * 06490016
.*   CONCERNED WITH THE SETTING OF FIVE VALUES. THESE VALUES ARE      * 06500016
.*   - DERCRRA1  (BITS INDICATING IF AND WHEN MSGS OR RECORDING IS    * 06510016
.*                DONE)                                               * 06520016
.*   - DERCRRL   (THE RETRY LIMIT)                                    * 06530016
.*   - DERCRRAS  (AN INDEX IN A BRANCH TABLE OF DERDOREC TO FIND THE  * 06540016
.*                PROPER SUBROUTINE FOR THIS KIND OF RECOVERY ACTION) * 06550016
.*   - DERCRRA2  (BITS THAT CONTROL THE FLOW IN THE SIMPLE RETRY      * 06560016
.*                ROUTINE AND ALSO SAY SOMETHING ABOUT PATH SELECTION)* 06570016
.*   - DERCRRA3  (BITS INDICATING DIFFERENT POSTING NEEDS OF THE CCB  * 06580016
.*                OF THE USER.)                                       * 06590016
.*   - DERCRRA4  (BITS THAT FURTHER QUALIFY WHAT MESSAGES OR RECORDS  * 06600016
.*                ARE TO BE WRITTEN)                                  * 06610016
.*                                                                    * 06620016
.*   FOR ALL SORTS OF SENSE DATA THE ANALYSIS IS DONE BY              * 06630016
.*   A SUBROUTINE THAT IS SOMEWHAT EXTERNAL TO SGDSK. IT IS THE       * 06640016
.*   DERFAST ROUTINE, WHICH IS ALSO ENTERED BY THE SENSE TASK         * 06650016
.*   IMMEDIATELY AFTER IT RETRIEVED THE SENSE DATA. THIS WAY          * 06660016
.*   IT COULD BE ENSURED THAT A LOST PATH GROUP ID IS RECOVERED       * 06670016
.*   BY THE ONLY TASK IN THE SYSTEM, THAT IS DOING IO WITHOUT A       * 06680016
.*   WAIT. SO NO OTHER TASKS IO GETS STARTED AND USES A PATH          * 06690016
.*   WHICH HAS NOT BEEN VERIFIED.                                     * 06700016
.*   THE ANALYSIS IS REPEATED (AT THE TIME SGDSK IS ENTERED) AND      * 06710016
.*   THE RESULTS ARE STORED IN THE DERCRRA.. FIELDS                   * 06720016
.*                                                                    * 06730016
.*   THEN AS A SECOND STEP, A COUPLE OF FURTHER CONDITIONS MAY        * 06740016
.*   SET SOME OF THE BITS ON OR OFF AGAIN. FOR ECKD SENSE DATA        * 06750016
.*   THIS IS THE EVALUATION OF A COMPOUND PROGRAM ACTION CODE,        * 06760016
.*   AND OF BYTE 24 (MESSAGING AND RECORDING NEEDS).                  * 06770016
.*   LOGICALLY THE TWO PARTS BELONG TOGETHER AND BOTH OF THEM         * 06780016
.*   CONSTITUTE STEP 1 IN THE OVERALL DESCRIPTION OF THE FLOW         * 06790016
.*   IN THE MAIN LOOP.                                                * 06800016
.*                                                                    * 06810016
.* NEW ERROR RECOGNITION:                                             * 06820016
.*                                                                    * 06830016
.*   WHENEVER AN OLD ERROR WAS OVERCOME WE SHOULD START OUR WORK      * 06840016
.*   WITH A FRESH SET OF RESOURCES. CERTAINLY IT CAN BE ARGUED,       * 06850016
.*   THAT AN INTERMEDIATE PRESENTATION OF STATISTICAL DATA BY THE     * 06860016
.*   DEVICE NEED NOT BE CONSIDERED THE DISAPPEARANCE OF THE PRE-      * 06870016
.*   CEEDING ERROR. (MAYBE FUTURE OBJECTIVE..)                        * 06880016
.*                                                                    * 06890016
.* THE ERROR CORRECTION FUNCTION DERECF:                              * 06900016
.*                                                                    * 06910016
.*   IN THE MANUAL THERE IS AN UNCLEAR PART                           * 06920016
.*   (GA26-1661-9, PAGE 6-5, IN THE MIDDLE OF THE PAGE)               * 06930016
.*   THAT IS GIVING SOME EXPLANATION ON WHAT SHOULD BE DONE IN CASE   * 06940016
.*   THERE IS AN ERROR DISPLACE IN BYTES 18 19 THAT IS SMALLER THAN   * 06950016
.*   THREE. THE SENTENCE IN THIS EXPLANATION:                         * 06960016
.*  "IF THE ERROR DISPLACEMENT IS ZERO, OR IF THE ERROR IS TOTALLY    * 06970016
.*   CONTAINED IN THE GAP THAT IMMEDIATELY PRECEDES THE DATA AREA,"   * 06980016
.*   WAS SOMEWHAT CONFUSING. FOR A READ KEY AND DATA COMMAND IT       * 06990016
.*   COULD HAVE MEANT, THAT THE ERROR DISPLACEMENT IN 18/19 COULD     * 07000016
.*   POINT BACK TO SOME PART IN THE KEY AREA OF THE DATA READ IN      * 07010016
.*   AND THAT ONLY THE PORTION IN THE DATA AREA SHOULD HAVE BEEN      * 07020016
.*   CORRECTED. UNFORTUNATELY IT IS NOT KNOWN, HOW MANY BYTES BELONG  * 07030016
.*   TO THE KEY AND HOW MANY BELONG TO THE DATA.                      * 07040016
.*   JACK FLYNN FROM SANTA THERESA WROTE A NOTE ABOUT THIS AND        * 07050016
.*   STATED, THAT THIS IS NOTHING TO WORRY ABOUT. HIS NOTE SAYS,      * 07060016
.*   THAT THE DATA IN STORAGE MAY BELONG TO EITHER KEY OR DATA        * 07070016
.*   AND THE RESTART DISPLACEMENT IN 15-17 AND THE ERROR DISPLACEMENT * 07080016
.*   IN 18/19 ALWAYS GIVE THE CORRECT STARTING PLACE TO APPLY THE     * 07090016
.*   CORRECTION INFORMATION.                                          * 07100016
.*                                                                    * 07110016
*                                                                     * 07120016
* ATTRIBUTES                                                          * 07130016
*                                                                     * 07140016
*        REUSABLE, PRIVILEGED, DISABLED                               * 07150016
.*                                                                    * 07160016
.*                                                                    * 07170016
.*   >>>>>>>>>>>>>>  FOR SECOND LEVEL SUPPORT <<<<<<<<<<<<            * 07180016
.*                                                                    * 07190016
.*     THERE IS AN AREA FOR PATCHES BY SECOND LEVEL IN DERTRACE.      * 07200016
.*     THIS SHOULD BE A GOOD PLACE TO IMPLEMENT ZAPS AND PATCHES      * 07210016
.*     IN THE FUTURE.                                                 * 07220016
.*                                                                    * 07230016
*                                                                     * 07240016
* CODING CONVENTIONS AND REGISTER ASSIGNMENTS                         * 07250016
*                                                                     * 07260016
*    DISK ERROR RECOVERY FOR THE NORMAL VSE SUPERVISOR (NOT THE       * 07270016
*    STAND ALONE SUPERVISOR) IS WORKING WITH A STACK AND HEAP         * 07280016
*    CONCEPT FOR DATA. ALL THE DATA THAT ARE ACCESSED IN READ/WRITE   * 07290016
*    MODE BY THE CODE OF SGDSK ARE CONTAINED IN A SINGLE DATA         * 07300016
*    AREA CALLED DERGLOB. THE STACK IS ALSO CONTAINED IN IT.          * 07310016
*    THE IDEA BEHIND THIS WAS TO FACILITATE MAINTENANCE. THE IDEA     * 07320016
*    OF PARALLEL PROCESSING OF DIFFERENT ERRORS AT THE SAME TIME      * 07330016
*    SEEMED POSSIBLE, BUT WAS GIVEN UP BECAUSE THERE SEEMED TO BE     * 07340016
*    NO NEED FOR IT. STILL IT WOULD BE NICE IF FUTURE DEVELOPERS      * 07350016
*    WOULD KEEP THE CODE REENTRANT (AS IT IS RIGHT NOW), ONE NEVER    * 07360016
*    KNOWS.                                                           * 07370016
*                                                                     * 07380016
*    REGISTER CONVENTION FOR THE ENTIRE CODE AND STACK MACHINE:       * 07390016
*    A NUMBER OF REGISTERS SHOULD NOT BE USED FOR PROCESSING.         * 07400016
*    RA  = HEAP POINTER. THE STACK ALSO IS A PART OF THE HEAP.        * 07410016
*    RC  = BASE REGISTER FOR ALL SUBROUTINES.                         * 07420016
*    RD  = STACK POINTER. POINTS TO THE LAST USED SAVE AREA FOR       * 07430016
*          REGISTERS.                                                 * 07440016
*    RE  = RETURN REGISTER. USED BY ALL SUBROUTINES.                  * 07450016
*                                                                     * 07460016
*    ANOTHER SET OF REGISTERS IS USED BY CONVENTION FOR THE           * 07470016
*    FOLLOWING PURPOSES, BUT MAY ALSO VARY IN USAGE.                  * 07480016
*                                                                     * 07490016
*    R1  = CCB POINTER. NORMALLY POINTS TO DERCCB IN GLOBAL AREA.     * 07500016
*    R2  = DEVICE ERROR ENTRY POINTER. USUALLY POINTS TO DERINWRK     * 07510016
*          IN THE GLOBAL AREA.                                        * 07520016
*    R3  = PUB POINTER.                                               * 07530016
*    R4  = CHANNEL QUEUE POINTER (CAUTION: NOT ALWAYS LOADED)         * 07540016
*    R8  = IN MOST CASES THE POINTER TO THE CCW JUST LOOKED AT.       * 07550016
*    RB  = USER CCB. SHOULD REALLY NOT BE VARIED.                     * 07560016
*    RF  = RETURN CODE, IF ANY.                                       * 07570016
*                                                                     * 07580016
*                                                                     * 07590016
*    R5,R6,R7,R9  ARE NOT ASSIGNED ANY SPECIFIC VALUE.                * 07600016
*                                                                     * 07610016
*                                                                     * 07620016
*     !!!!!!!!!!!  WARNINGS !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!           * 07630016
*                                                                     * 07640016
*     >>>>> READ THIS BEFORE YOU DO CHANGES! <<<<<<                   * 07650016
*                                                                     * 07660016
*  THERE IS A NUMBER OF THINGS THAT CAN NOT EASILY BE SEEN FROM       * 07670016
*  THE CODE AND MUST BE KNOWN TO ANY PERSON THAT DOES CHANGES TO      * 07680016
*  IT.                                                                * 07690016
*                                                                     * 07700016
*  --  IF CONCURRENT PROCESSING SHOULD BE INTRODUCED IN SGDSK IN      * 07710016
*      THE FUTURE, IT WOULD BE NICE, IF NO LOCAL VARIABLES WERE       * 07720016
*      INTRODUCED INTO THE CODE.                                      * 07730016
*      CONCURRENT PROCESSING IS MOST LIKELY TO BE INTRODUCED BY       * 07740016
*      USING THE RETRY EXIT FOR INITIATING A RETRY OPERATION.         * 07750016
*      THE FIELD CHQERRCT COULD BE USED TO IDENTIFY A HEAP AND        * 07760016
*      STACK AREA UNIQUE TO THIS KIND OF ERROR.                       * 07770016
*      THE ONLY THING IS, IT WOULD ALSO HAVE TO RETURN IN CASE OF     * 07780016
*      A GOOD ENDING TO ALLOW FOR MSG+RECORDING.                      * 07790016
*  --  IT WOULD BE REQ. FOR CONCURR. PROCESSING THAT ALL IO IS DONE   * 07800016
*      USING THE DERCCB (DE1CCB, DE2CCB RESPECTIVELY) AND NO OTHER.   * 07810016
*  --  THE PROBLEM OF PREPARATIONAL IO:                               * 07820016
*      IF WE DO IO IN ORDER TO PREPARE FOR THE IO THAT IS REALLY      * 07830016
*      INTENDED TO REPAIR THE ORIGINAL FAILING USER ACTION, THIS      * 07840016
*      IO WOULD ALSO HAVE TO BE TREATED IN AN ERROR BLOCK. NOW,       * 07850016
*      FOR DISK ERROR RECOVERY TASK DSK, THERE IS NO SUCH ERROR       * 07860016
*      BLOCK FILLED IN. I WOULD HAVE TO DO IT MYSELF. RIGHT NOW,      * 07870016
*      PREPARATIONAL IO IS NOT REQUIRED FOR ANY MORE MODERN DEVICE    * 07880016
*      ANY MORE, BUT IF YOU SHOULD INTRODUCE IT SOME TIME, BE         * 07890016
*      CAREFUL THAT IT IS HANDLED.                                    * 07900016
*  --  LOOK AT THE USING CONVENTION MENTIONED FOR REGISTERS RA,RC     * 07910016
*      RD AND RE. THE USINGS FOR RA AND RC ARE GENERATED BY EACH      * 07920016
*      SUBROUTINE HEADING AND NOT MENTIONED EXPLICITLY.               * 07930016
*  --  IF ANY FURTHER CCWS ARE CHAINED IN FRONT OF THE USER CHAIN,    * 07940016
*      AND THEY ARE READING SOMETHING INTO STORAGE, BE SURE YOU       * 07950016
*      SET THE SKIP BIT ON TO NOT FAIL BECAUSE OF INVALID STORAGE     * 07960016
*      PROTECTION KEY.                                                * 07970016
*********************************************************************** 07980016
         EJECT                                                          07990016
*                                                              @D51TDPM 08000016
*-------------------------------------------------------------*@D51TDPM 08010016
*   DSECTS USED BY SGDSK.                                      @D51TDPM 08020016
*-------------------------------------------------------------*@D51TDPM 08030016
*                                                              @D51TDPM 08040016
*                                                                       08050016
DERCSWVL DSECT     VALUES FROM THE CCB, ASSOCIATED WITH THE    @D51TDPM 08060016
*                  CSW, THAT THE REQUESTOR NEEDS ON COMPLETION @D51TDPM 08070016
*                  OF THE I/O REQUEST.                         @D51TDPM 08080016
DERCSW   DS   0X   START OF THE CSW INFORMATION.               @D51TDPM 08090016
         DS   X    RESERVED                                    @DERPDGL 08100016
DERCSWAD DS   XL3  THE FAILING CCW ADDRESS FROM THE CCB.       @D51TDPM 08110016
DERCSDST DS   X    THE DEVICE STATUS FROM THE CCB.             @D51TDPM 08120016
DERCSCST DS   X    THE CHANNEL STATUS FROM THE CCB.            @D51TDPM 08130016
*        EQU  B'10000000'     NOT USED IN DSK                  @DERPDGL 08140016
*        EQU  B'01000000'     NOT USED IN DSK                  @DERPDGL 08150016
DERCSPCK EQU  B'00100000'   CHANNEL PROGRAM CHECK              @DERPDGL 08160016
DERCSPRT EQU  B'00010000'   CHANNEL PROTECTION CHECK           @DERPDGL 08170016
DERCSDCK EQU  B'00001000'   CHANNEL DATA CHECK                 @DERPDGL 08180016
*        EQU  B'00000100'     NOT USED IN DSK                  @DERPDGL 08190016
*        EQU  B'00000010'     NOT USED IN DSK                  @DERPDGL 08200016
DERCSCHN EQU  B'00000001'   CHANNEL CHAINING CHECK             @DERPDGL 08210016
DERCSNOP EQU  X'FE'         NOT OPERATIONAL INDICATION         @DERPDGL 08220016
DERCSERP EQU  DERCSPCK+DERCSPRT+DERCSDCK+DERCSCHN              @DERPDGL 08230016
DERRSCNT DS   XL2  THE RESIDUAL COUNT FROM THE CCB.            @D51TDPM 08240016
DERCSWLN EQU  *-DERCSW  LENGTH OF THE DERCSWVL DSECT.          @D51TDPM 08250016
*                                                                       08260016
*                                                                       08270016
*                                                                       08280016
UCCBADR  DSECT                                                 @D51TDPM 08290016
UCCBCNT  DS    XL2                RESIDUAL COUNT               @D37ADDK 08300016
UCCBCOM1 DS    XL1                FIRST COMMUNICATION BYTE     @D37ADDK 08310016
DASDRRDC EQU   B'00000010'        USER REQUESTS THAT A READ    @D51TDPM 08320000
*                                 DATA CHECK ERROR CONDITION   @D51TDPM 08330000
*                                 BE RETURNED.                 @D51TDPM 08340000
DASDRWDC EQU   B'00001000'        USER REQUESTS THAT A WRITE   @D51TDPM 08350016
*                                 DATA CHECK ERROR CONDITION   @D51TDPM 08360016
*                                 BE RETURNED.                 @D51TDPM 08370016
UCCBCOM2 DS    XL1                SECOND COMMUNICATION BYTE    @D37ADDK 08380016
COUNTCK  EQU   X'80'              DATA CHECK IN COUNT AREA     @D51TDPM 08390016
ITRKFMT  EQU   X'40'                 INVALID TRACK FORMAT      @D31HMRH 08400016
DATACHEC EQU   X'10'              DASD DATA CHECK              @D51TDPM 08410000
VERFY    EQU   X'02'              VERIFY ERROR ON DASD         @D51TDPM 08420016
UCCBSTA  DS    0XL2               STATUS BYTES FROM CSW        @D37ADDK 08430016
UCCBSTA1 DS    XL1                STATUS BYTE 1                @D37ADDK 08440016
UCCBSTA2 DS    XL1                STATUS BYTE 2                @D37ADDK 08450016
         DS    XL1                LUB CLASS                    @D37ADDK 08460016
         DS    XL1                LUB NUMBER WITHIN CLASS      @D37ADDK 08470016
UCCBCCW  DS    XL4                CCW ADDRESS                  @D37ADDK 08480016
UCCBBY3  DS    XL1                THIRD COMMUNICATION BYTE     @D37ADDK 08490016
ITWPASSB EQU   X'10'              RETURN INVALID TRK FMT WRITE @DA43898 08500000
UCCBCSWW DS    XL3                CCW ADDRESS FROM CSW         @D37ADDK 08510016
*                                                                       08520016
         EJECT ,                                                        08530016
*                                                                       08540016
ERBLKADR DSECT ,                  ALREADY DECLARED DSECT       @D51CDBH 08550016
         ORG   ERRQFLG                                         @D51CDBH 08560016
.* THE FOLLOWING BIT COMBINATIONS HAVE THE FOLLOWING EFFECT IN @DERPDGL 08570016
.* ERRQFLG.                                                    @DERPDGL 08580016
.* O= OPERATOR INTERVENTION REQUIRED                           @DERPDGL 08590016
.* | P= PASSBACK ERROR TO USER                                 @DERPDGL 08600016
.* | | I= IGNORE BIT                                           @DERPDGL 08610016
.* | | | S= SUCCESS BIT                                        @DERPDGL 08620016
.* | | | | R= RETRY BIT                                        @DERPDGL 08630016
.* | | | | | RECONLY BIT                                       @DERPDGL 08640016
.* | | | | | |  CCB=0  (YES OR NO OR . FOR UNIMPORTANT)        @DERPDGL 08650016
.* | | | | | |  |  0P..X X    RF EVENTUALLY LEADS TO           @DERPDGL 08660016
.* | | | | | |  |      | |    |                                @DERPDGL 08670016
.* 0 . . . . 1  .      I P    DISP                             @DERPDGL 08680016
.* 1 . . . . 1  .      A      DISP                             @DERPDGL 08690016
.* 1 1 . . . 0  .      A      IGNORE                           @DERPDGL 08700016
.* 1 0 . 0 1 0  N      A      RETRY                            @DERPDGL 08710016
.* 1 0 . 0 0 0  .      A      IGNORE                           @DERPDGL 08720016
.* 1 0 . 1 . 0  N      A      IGNORE                           @DERPDGL 08730016
.* 0 1 . 0 . 0  N      I P    RETRY                            @DERPDGL 08740016
.* 0 1 . 0 . 0  Y      I P    IGNORE                           @DERPDGL 08750016
.* 0 1 0 1 . 0  N      I R    RETRY                            @DERPDGL 08760016
.* 0 1 1 1 . 0  N      I I    IGNORE                           @DERPDGL 08770016
.* 0 0 1 0 0 0  N      D I    -> $$ABERRO                      @DERPDGL 08780016
.* 0 0 1 0 0 0  Y      I I    IGNORE                           @DERPDGL 08790016
.* 0 0 1 0 1 0  N      D R    -> $$ABERRO                      @DERPDGL 08800016
.* 0 0 1 1 0 0  N      I I    IGNORE                           @DERPDGL 08810016
.* 0 0 0 1 1 0  N      I R    RETRY                            @DERPDGL 08820016
.* 0 0 0 1 1 0  Y      I R    IGNORE                           @DERPDGL 08830016
.*                                                             @DERPDGL 08840016
         ORG   ERRQCOMM                                        @D51CDBH 08850016
ERRQDFL  DS    B                  -->                          @D51CDBH 08860016
*        THIS BYTE TELLS THE ERP TASK WHAT IS REQUESTED OF IT. @D52WSBH 08870016
*                                                              @D52WSBH 08880016
ERQCANCL EQU   B'10000000'        -->                          @D52WSBH 08890016
*        THE MESSAGE SHOULD INDICATE THE JOB WAS CANCELLED.    @D52WSBH 08900016
*        IF THE ERP TASK WILL POST THE I/O REQUEST, IT SHOULD  @D52WSBH 08910016
*        PERFORM CANCEL PROCESSING.  THIS FLAG IS MEANINGLESS  @D52WSBH 08920016
*        IN AN ERROR BLOCK THAT DOES NOT REQUEST A MESSAGE.    @D52WSBH 08930016
*                                                              @D52WSBH 08940016
ERQPASBK EQU   B'01000000'        -->                          @D52WSBH 08950016
*        THE MESSAGE SHOULD INDICATE THAT THE CCB IS POSTED    @D52WSBH 08960016
*        WITH AN I/O ERROR.  IF THE ERP TASK WILL POST THE     @D52WSBH 08970016
*        I/O REQUEST, IT SHOULD PERFORM IGNORE PROCESSING.     @D52WSBH 08980016
*        THIS FLAG IS MEANINGLESS IN AN ERROR BLOCK THAT DOES  @D52WSBH 08990016
*        NOT REQUEST A MESSAGE.                                @D52WSBH 09000016
*                                                              @D52WSBH 09010016
ERQPTHDN EQU   B'00100000'        ISSUE A PATH DOWN MESSAGE.   @D51CDBH 09020016
ERQIMSG  EQU   B'00010000'        ISSUE A REGULAR MESSAGE (NOT @D51TDPM 09030016
*                                 RECOVERY ERROR OR PATH DOWN) @D51TDPM 09040016
*                                 FOR THIS ERROR CONDITION     @D51TDPM 09050016
ERQRECRD EQU   B'00001000'        RECORD FOR THIS ERROR        @D51TDPM 09060016
*                                 CONDITION.                   @D51TDPM 09070016
ERQRCVER EQU   B'00000100'        ISSUE A RECOVERY ERROR       @D51TDPM 09080016
*                                 MESSAGE FOR THIS ERROR COND. @D51TDPM 09090016
ERQANYM  EQU   ERQIMSG+ERQRCVER+ERQPTHDN                       @D52WSBH 09100016
*                                 WHEN ANY OF THESE BITS IS    @D52WSBH 09110016
*                                 SET, MESSAGING IS REQUESTED. @D52WSBH 09120016
ERQANYMR EQU   ERQANYM+ERQRECRD   WHEN ANY OF THESE BITS ARE   @D52WSBH 09130016
*                                 SET, EITHER RECORDING OR     @D51TDPM 09140016
*                                 MESSAGING IS REQUIRED FOR    @D51TDPM 09150016
*                                 THIS ERROR CONDITION.        @D51TDPM 09160016
ERQINTV  EQU   B'00000010'        THIS BIT IS SET WHEN ERP     @D51TDPM 09170016
*                                 TASK MUST PROCESS AN         @D51TDPM 09180016
*                                 INTERVENTION REQUIRED        @D51TDPM 09190016
*                                 CONDITION.                   @D51TDPM 09200016
ERQFROP  EQU   B'00000001'        -->                          @D21OTJF 09210016
*        THE OBR SHOULD INDICATE THAT WE RETRIED ON THE OTHER  @D21OTJF 09220016
*        PATH AS PART OF OUR RECOVERY.  THIS FLAG IS           @D52WSBH 09230016
*        MEANINGLESS IN AN ERROR BLOCK THAT DOES NOT REQUEST   @D52WSBH 09240016
*        RECORDING.                                            @D52WSBH 09250016
ERRQNRTY DS    FL1                RETRY COUNT FOR ORIGINAL     @D51CDBH 09260016
ERQCCWOP DS    X                  THE OPCODE OF THE FAILING    @D51TDPM 09270016
*                                 CCW ASSOCIATED WITH THE      @D51TDPM 09280016
*                                 ERROR DESCRIBED BY THE ERROR @D51TDPM 09290016
*                                 BLOCK.                       @D51TDPM 09300016
ERQCCWFL DS    X                  THE FLAGS FROM THE FAILING   @D51TDPM 09310016
*                                 CCW ASSOCIATED WITH THE      @D51TDPM 09320016
*                                 ERROR DESCRIBED BY THE ERROR @D51TDPM 09330016
*                                 BLOCK.                       @D51TDPM 09340016
*                                                                       09350016
         EJECT ,                                                        09360016
*                                                                       09370016
DERDTADR DSECT                                                 @D51TDPM 09380016
DERDTPUB DS    XL1                DOS PUB DEVICE TYPE CODE     @D37ADDK 09390016
DERDTMXT DS    XL1                MAX HEAD NUMBER OF DEVICE    @D37ADDK 09400016
DERDTECC DS    XL1                # OF ECC BYTES               @D14ZDDK 09410016
DERDTCLH DS    XL1                CLEAR MASK FOR LOW HEAD CALC @D14ZDDK 09420016
DERDTCLC DS    XL1                CLEAR MASK FOR HIGH CYL CALC @D14ZDDK 09430016
DERDTSHF DS    XL1                SHIFT COUNT FOR HIGH CYL CAL @D14ZDDK 09440016
DERDTDVT DS    XL1                DEVICE MASK                  @D37ADDK 09450016
DER3330  EQU   X'40'      BASIC SENSE FOR 333X DEVICE          @DERPDGL 09460016
DER3340  EQU   X'20'      BASIC SENSE FOR 334X DEVICE          @DERPDGL 09470016
DER3350  EQU   X'10'      BASIC SENSE FOR 3350 DEVICE          @DERPDGL 09480016
DERFBA   EQU   X'08'      BASIC SENSE FOR FBA  DEVICES         @DERPDGL 09490016
DER3375  EQU   X'04'      BASIC SENSE FOR 3375 DEVICES         @DERPDGL 09500016
DER3380  EQU   X'02'      BASIC SENSE FOR 3380 DEVICES         @DERPDGL 09510016
DERS24P8 EQU   X'01'      BASIC SENSE DATA IN 24+8 SENSE FORMAT@DERPDGL 09520016
.*                        THIS BIT IS SET IN COMBINATION WITH  @DERPDGL 09530016
.*                        OTHERS.                              @DERPDGL 09540016
DER370   EQU   DER3330+DER3340+DER3350+DER3375+DER3380         @DERPDGL 09550016
DERALL   EQU   DER370+DERFBA                                   @DERPDGL 09560016
DERDTLEN EQU   *-DERDTADR         LENGTH OF TABLE ENTRY                 09570016
*                                                                       09580016
         EJECT ,                                                        09590016
*                                                                       09600016
DERTBADR DSECT                                                          09610016
DERTBSNS DS    XL3                FIRST THREE SENSE BYTES      @D37ADDK 09620016
DERTBDEV DS    XL1                DEVICES ENTRY IS VALID FOR   @D37ADDK 09630016
DERTBECC DS    XL1                MAIN ERROR CLASSIFICATION... @D51TDPM 09640016
*                                   CODE FOR THE ERROR...      @D51TDPM 09650016
*                                   CONDITION THAT IS...       @D51TDPM 09660016
*                                   DESCRIBED BY THIS ENTRY.   @D51TDPM 09670016
DERTBLEN EQU   *-DERTBADR         LENGTH OF TABLE ENTRY        @D37ADDK 09680016
*                                                                       09690016
         EJECT ,                                                        09700016
&SYSECT  CSECT                                                          09710016
         DS    0D                 ALIGNMENT                             09720016
         DC    CL8'SGDSK'                                      @D66CDAP 09730016
         DC    CL8'D66CDAP'       /*@@LVLID*/                  @D66CDAP 09740000
*XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX* 09750016
*                                                                     * 09760016
*     SENSE DATA ANALYSIS ROUTINE. CALLED BY DSK AND SNS TASK.        * 09770016
*                                                                     * 09780016
*XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX* 09790016
*                                                              @DERPDGL 09800016
*   INTERFACE DESCRIPTION:                                     @DERPDGL 09810016
*   RF = BASE ADDRESS OF ROUTINE. LOADED ON ENTRY              @DERPDGL 09820016
*   RE = RETURN ADDRESS                                        @DERPDGL 09830016
*   R2 = POINTER TO DEVICE ERROR ENTRY                         @DERPDGL 09840016
*                                                              @DERPDGL 09850016
*   RETURN IS TO RE+0 IF EXIT IS LIKE TO IGNORE PROCESSING OF  @DERPDGL 09860016
*                     DSKEXIT. A MESSAGE IS NOT REQUIRED.      @DERPDGL 09870016
*                RE+4 IF SENSE DATA INDICATED THAT THE         @DERPDGL 09880016
*                     PATH GROUP ID OF THE DEVICE WAS LOST.    @DERPDGL 09890016
*                     SNS TASK SHOULD DO PATH VERIFICATION     @DERPDGL 09900016
*                     BEFORE ENTERING DSK FOR FURTHER PROCESS. @DERPDGL 09910016
*                RE+8 IF PROCESSING SHALL BE DONE AS USUAL     @DERPDGL 09920016
*                                                              @DERPDGL 09930016
DERFAST  DS    0H                                              @DERPDGL 09940016
         USING DERFAST,RF         BASE REGISTER OF ROUTINE     @DERPDGL 09950016
         USING ERBLKADR,R2        PTR TO DEVICE ERROR ENTRY    @DERPDGL 09960016
         STM   R0,RF,DERFSTSV     SAVE ALL REGS                @DERPDGL 09970016
         LR    RC,RF              TAKE RC AS BASE AS USUAL     @DERPDGL 09980016
         DROP  RF                                              @DERPDGL 09990016
         USING DERFAST,RC                                      @DERPDGL 10000016
         LH    R3,ERRQPUB                                      @DERPDGL 10010016
         USING PUBADR,R3          PTR TO PUB OF DEVICE         @DERPDGL 10020016
*                                                              @DERPDGL 10030016
         LA    RB,0               INDICATE NO KIND OF SNS DATA @DERPDGL 10040016
         CLI   PUBDEVTY,TFBA       BRANCH WHEN THE DEVICE IS...@D51TDPM 10050016
         BE    DERFSBAS              FBA.                      @D51TDPM 10060016
         CLI   ERRQLSNS,32         BRANCH WHEN THE SENSE DATA..@D51TDPM 10070016
         BNE   DERFSBAS              IS NOT 32 BYTES LONG.     @D51TDPM 10080016
         TM    ERRQSNS+27,DER24P8  BRANCH WHEN THE SENSE DATA..@D51TDPM 10090016
         BO    DERFSBP8              IS IN THE 24+8 FORMAT.    @D51TDPM 10100016
         TM    ERRQSNS+6,X'0F'     BRANCH WHEN NOT A SIM...    @D51TDPM 10110016
         BNO   DERFSECK              ERROR CONDITION.          @D51TDPM 10120016
*                                                              @D51TDPM 10130016
*  EVALUATE SIM FORMAT SENSE DATA                              @D51TDPM 10140016
*                                                              @D51TDPM 10150016
DERFSSIM LA    RB,DERCRSFS         REMEMBER SIM FORMAT.        @D51TDPM 10160016
         LA    RF,DERECSMN         SIM & NO OPERATOR ALERT     @D51TDPM 10170016
         TM    ERRQSNS+24,B'00000011'   BRANCH WHEN NO M&L...  @D51TDPM 10180016
         BZ    DERFSSI8                   BITS ARE SET.        @D51TDPM 10190016
         LA    RF,DERECSMA         SIM & OPERATOR ALERT        @D51TDPM 10200016
DERFSSI8 EQU   *                                               @D51TDPM 10210016
         B     DERF3000                                        @D51TDPM 10220016
*                                                              @D51TDPM 10230016
*  EVALUATE ECKD FORMAT SENSE DATA                             @D51TDPM 10240016
*                                                              @D51TDPM 10250016
DERFSECK LA    RB,DERCRSFE                                     @D51TDPM 10260016
*                                                              @DERPDGL 10270016
*     CONVERT THE SIMPLE PROGRAM ACTION CODE INTO A RECOVERY   @DERPDGL 10280016
.*    ACTION TABLE ENTRY, IF THERE IS ONE.                     @DERPDGL 10290016
.*                                                             @DERPDGL 10300016
         LA    RF,DERSIPDF        TAKE THE DEFAULT FOR NO      @DERPDGL 10310016
*                                   SIMPLE PROGRAM ACTION CODE @DERPDGL 10320016
         TM    ERRQSNS+25,X'80'   BRANCH IF ITS A COMPOUND     @DERPDGL 10330016
         BO    DEREKT02             PROGRAM ACTION CODE        @DERPDGL 10340016
         SLR   R5,R5              TAKE THE SIMPLE PROGRAM      @DERPDGL 10350016
         IC    R5,ERRQSNS+25        ACTION CODE.               @DERPDGL 10360016
         C     R5,=A(DERSIPMX)    BRANCH IF ITS IN KNOWN       @DERPDGL 10370016
         BL    DEREKT00             RANGE                      @DERPDGL 10380016
DEREKT01 LA    RF,DERECURE        TAKE A DEFAULT ACTION        @DERPDGL 10390016
         SLR   R5,R5              RESET BITS FOR DERCRRA3      @DERPDGL 10400016
         B     DEREKEX            LEAVE                        @DERPDGL 10410016
DEREKT00 IC    RF,DERSIPAC(R5)    TAKE ACTION INDEX            @DERPDGL 10420016
         LTR   RF,RF              IF THIS SIMPLE PAC WAS       @DERPDGL 10430016
         BZ    DEREKT01             UNKNOWN, TAKE DEFAULT..    @DERPDGL 10440016
*                                                              @DERPDGL 10450016
*   SINCE THE SIMPLE PAC DOES NOT ALWAYS GIVE US THE INFO      @DERPDGL 10460016
*   FOR SETTING THE BITS IN THE CCB CORRECTLY, WE ALSO         @DERPDGL 10470016
*   SCAN BYTE 22/23 FOR THINGS THAT MIGHT BE RELEVANT HERE.    @DERPDGL 10480016
*                                                              @DERPDGL 10490016
DEREKT02 SLR  R5,R5               ASSUME NO FURTHER BIT REQ.   @D51TDPM 10500016
*                                                              @D51TDPM 10510016
         SLR  R6,R6               SELECT THE                   @DERPDGL 10520016
         IC   R6,ERRQSNS+22         EXCEPTION                  @DERPDGL 10530016
         SRL  R6,4                  CLASS                      @DERPDGL 10540016
         SLL  R6,2                  IN                         @DERPDGL 10550016
         B    DEREKTB(R6)           ECKD SENSE DATA            @DERPDGL 10560016
DEREKTB  B    DEREKC0               CLASS 0                    @DERPDGL 10570016
         B    DEREKC1                     1                    @DERPDGL 10580016
         B    DEREKC2                     2                    @DERPDGL 10590016
         B    DEREKCXX                    3 DOES NOT EXIST     @DERPDGL 10600016
         B    DEREKC4                     4                    @DERPDGL 10610016
         B    DEREKCXX                    ..                   @DERPDGL 10620016
         B    DEREKC6                                          @DERPDGL 10630016
         B    DEREKCXX                                         @DERPDGL 10640016
         B    DEREKCXX                                         @DERPDGL 10650016
         B    DEREKCXX                                         @DERPDGL 10660016
         B    DEREKCXX                                         @DERPDGL 10670016
         B    DEREKCB                                          @DERPDGL 10680016
         B    DEREKCC                                          @DERPDGL 10690016
         B    DEREKCD                                          @DERPDGL 10700016
         B    DEREKCE                                          @DERPDGL 10710016
         B    DEREKCF                                          @DERPDGL 10720016
*                                                              @D51TDPM 10730016
*-------------------------------------------------------------*@D51TDPM 10740016
*   EXCEPTION CLASS X'0'.                                      @D51TDPM 10750016
*-------------------------------------------------------------*@D51TDPM 10760016
*                                                              @D51TDPM 10770016
DEREKC0  DS   0H                                               @D51TDPM 10780016
         CLI  ERRQSNS+22,X'01'    INVALID OR UNSUPPORTED COMMAND     GL 10790016
         BE   DEREKEX               RECEIVED FROM CHANNEL      @D51TDPM 10800016
         CLI  ERRQSNS+22,X'02'    INVALID COMMAND SEQUENCE WAS @D51TDPM 10810016
         BE   DEREKEX               RECEIVED FROM CHANNEL      @D51TDPM 10820016
         CLI  ERRQSNS+22,X'03'    INVALID PARAMETERLIST OF     @D51TDPM 10830016
         BE   DEREKEX               COMMAND DETECTED           @D51TDPM 10840016
         CLI  ERRQSNS+22,X'04'    CONFLICTING PARAMETERS IN    @D51TDPM 10850016
         BE   DEREKEX               ONE OR MORE COMMANDS       @D51TDPM 10860016
*                                                              @DERPDGL 10870016
         LA   R5,DERRA3EO         END OF CYLINDER.             @D51TDPM 10880016
         CLI  ERRQSNS+22,X'05'    NORMALLY IS A FILE PROTECT   @D51TDPM 10890016
         BNE  DEREK060              VIOLATION,                 @D51TDPM 10900016
         CLI  ERRQSNS+23,X'05'    BUT IN THIS CASE ITS A       @D51TDPM 10910016
         BE   DEREKEX               END OF CYLINDER INDICATION @D51TDPM 10920016
         SLR  R5,R5               NO NEED FOR FILE PROT. VIOL. @DERPDGL 10930016
         B    DEREKEX               INDICATION IN CCB          @D51TDPM 10940016
DEREK060 EQU  *                                                @D51TDPM 10950016
         LA   R5,DERRA3NR         NO RECORD FOUND.             @D51TDPM 10960016
         CLI  ERRQSNS+22,X'06'                                 @D51TDPM 10970016
         BE   DEREKEX                                          @D51TDPM 10980016
         LA   R5,DERRA3TR         INVALID TRACK FORMAT - READ  @D51TDPM 10990016
         CLC  ERRQSNS+22(2),=X'0703'                           @D51TDPM 11000016
         BE   DEREKEX                                          @D51TDPM 11010016
         LA   R5,DERRA3TW         INVALID TRACK FORMAT - WRITE @D51TDPM 11020016
         CLI  ERRQSNS+22,X'07'                                 @D51TDPM 11030016
         BE   DEREKEX                                          @D51TDPM 11040016
         LA   R5,0                SOMETHING ELSE               @D51TDPM 11050016
         B    DEREKEX                                          @D51TDPM 11060016
*                                                              @D51TDPM 11070016
*   EXCEPTION CLASS X'1'.                                      @D51TDPM 11080016
*                                                              @D51TDPM 11090016
DEREKC1  LA   R5,0                SOME CHANNEL OR CONTR.UNIT   @D51TDPM 11100016
         B    DEREKEX               EXCEPTION (NO CCB BIT HIT) @D51TDPM 11110016
*                                                              @D51TDPM 11120016
*   EXCEPTION CLASS X'2'.                                      @D51TDPM 11130016
*                                                              @D51TDPM 11140016
DEREKC2  LA   R5,0                NO SUBSYSTEM EXCEPTION IS    @D51TDPM 11150016
         B    DEREKEX               ANYHOW REFLECTED IN CCB    @D51TDPM 11160016
*                                                              @D51TDPM 11170016
*   EXCEPTION CLASS X'4'.                                      @D51TDPM 11180016
*                                                              @D51TDPM 11190016
DEREKC4  LA   R5,DERRA3DC         ALLWAYS SOME KIND OF DATA    @D51TDPM 11200016
         CLI  ERRQSNS+22,X'41'                                 @DERPDGL 11210016
         BE   DEREKC40                                         @DERPDGL 11220016
         CLI  ERRQSNS+22,X'45'                                 @DERPDGL 11230016
         BNE  DEREKEX                                          @DERPDGL 11240016
DEREKC40 LA   R5,DERRA3CC(,R5)                                 @DERPDGL 11250016
         B    DEREKEX               CHECK.                     @D51TDPM 11260016
*                                                              @D51TDPM 11270016
*   EXCEPTION CLASS X'6'.                                      @D51TDPM 11280016
*                                                              @D51TDPM 11290016
DEREKC6  LA   R5,DERRA4MD         INDICATE MDR RECORDING IN    @D51TDPM 11300016
         SLL  R5,8                  DERCRRA4 LATER ON          @DERPDGL 11310016
         B    DEREKEX               IS RECORDED AS MDR RECORD  @D51TDPM 11320016
*                                                              @D51TDPM 11330016
*   EXCEPTION CLASS B, C, D, E, F OR UNRECOGNIZED              @D51TDPM 11340016
*                                                              @D51TDPM 11350016
DEREKCXX DS   0H    UNRECOGNIZED EXCEPTION CLASS               @DERPDGL 11360016
DEREKCB  DS   0H    STOR.CONTR. TO DASD CONTR. INTERFACE EXCEP.@DERPDGL 11370016
DEREKCC  DS   0H    CONTROLLER EXCEPTION                       @DERPDGL 11380016
DEREKCD  DS   0H    CONTROLLER TO DEVICE CONNECTION EXCEPTION  @DERPDGL 11390016
DEREKCE  DS   0H    DEVICE RELATED EXCEPTIONS                  @D51TDPM 11400016
DEREKCF  DS   0H    CACHE RELATED  EXCEPTIONS                  @D51TDPM 11410016
*                                                              @D51TDPM 11420016
*   OTHER EXCEPTION CLASS                                      @D51TDPM 11430016
*                                                              @D51TDPM 11440016
DEREKEX  SLL   R5,16              KEEP FOUND BITS IN RF        @DERPDGL 11450016
         OR    RF,R5                                           @DERPDGL 11460016
         B     DERF3000                                        @DERPDGL 11470016
*                                                              @DERPDGL 11480016
DERSIPAC DC    AL1(DERSIPNE)    0:NO ERROR                     @DERPDGL 11490016
         DC    AL1(DERSIPPE)    1:PERMANENT ERROR              @DERPDGL 11500016
         DC    AL1(DERSIPIR)    2:INTERVENTION REQUIRED        @DERPDGL 11510016
         DC    AL1(DERSIPIR)    3:INTERVENTION REQ.ON DUPL.PAIR@DERPDGL 11520016
         DC    AL1(DERSIPUR)    4:UNCONDITIONAL RESERVE ENDED  @DERPDGL 11530016
*                                 RESERVATION OF A DEVICE.     @DERPDGL 11540016
         DC  10AL1(0)        5-0E:INVALID                      @DERPDGL 11550016
         DC    AL1(DERSIPCK)   0F:CKD CONVERSION MODE DEFEXT   @DERPDGL 11560016
*                                 HAD FALSE TRANSFER LENGTH    @DERPDGL 11570016
         DC    AL1(DERSIPUN)   10:UNIT CHECK NOT RELATED TO    @DERPDGL 11580016
*                                 CURRENTLY PROCESSING CCW CHAIN     GL 11590016
         DC    AL1(DERSIPEO)   11:END OF CYLINDER IN CCW CHAIN @DERPDGL 11600016
*                                 CAUSED BY OPERATION OUTSIDE  @DERPDGL 11610016
*                                 LOCREC DOMAIN.               @DERPDGL 11620016
         DC    AL1(DERSIPEV)   12:EXTENT VIOL. BY SEEK         @DERPDGL 11630016
         DC    AL1(DERSIPEV)   13:EXTENT VIOL. BY LOCREC       @DERPDGL 11640016
         DC    AL1(DERSIPEV)   14:EXTENT VIOL. BY MULTITR.CCW  @DERPDGL 11650016
         DC    AL1(DERSIPEV)   15:EXTENT VIOL. INSIDE LOCREC   @DERPDGL 11660016
         DC    AL1(DERSIPRE)   16:RESETTING EVENT (PATH GROUPS LOST) GL 11670016
         DC    AL1(DERSIPIL)   17:SPEC.INTERC.CONDITION OCCURED@DERPDGL 11680016
*                                 AND CONDITION WAS REMOVED.   @DERPDGL 11690016
         DC    AL1(DERSIPIN)   18:SPECIAL INTERCEPT WAS HIT    @DERPDGL 11700016
*                                 AND IS STILL ACTIVE.         @DERPDGL 11710016
         DC    AL1(DERSIPEO)   19:MULTITRAC CCW IN LOCREC DOM. @DERPDGL 11720016
*                                 FOUND END OF CYLINDER COND.  @DERPDGL 11730016
         DC    AL1(0)          1A:INVALID                      @DERPDGL 11740016
         DC    AL1(DERSIPMT)   1B:MODIFIED TRACK IN CACHE      @DERPDGL 11750016
         DC    AL1(DERSIPCI)   1C:ERROR DURING PCI FETCH MODE  @DERPDGL 11760016
         DC    AL1(DERSIPCP)   1D:LONG BUSY. STATE CHANGE PEND.@DERPDGL 11770016
DERSIPMX EQU   *-DERSIPAC      MAXIMUM PERMITTED PROG.ACT.CODE @DERPDGL 11780016
*                                                              @DERPDGL 11790016
*                                                              @D51TDPM 11800016
*  EVALUATE BASIC TYPE SENSE DATA.                             @D51TDPM 11810016
*                                                              @D51TDPM 11820016
DERFSBP8 LA    RB,DERCRSFC       REMEMBER 24+8 COMPAT. SENSE   @D51TDPM 11830016
DERFSBAS LA    RB,DERCRSFB(,RB)  REMEMBER BASIC SENSE FORMAT   @D51TDPM 11840016
*                                                              @D51TDPM 11850016
*  TRY TO FIND THE DEVICE IN DERDTADR                          @D51TDPM 11860016
*                                                              @D51TDPM 11870016
         L     R5,=A(DERDEV)      DEVICE TABLE ADDRESS.        @D37ADDK 11880016
         USING DERDTADR,R5                                     @D51TDPM 11890016
         L     R7,=A(DERDEVE)     ADDRESS OF LAST DEVICE ENTRY.@D51TDPM 11900016
         LA    R6,DERDTLEN        LENGTH OF DEVICE TABLE ENTRY.@D51TDPM 11910016
DERBS010 EQU   *                                               @D14ADDK 11920016
         CLC   DERDTPUB,PUBDEVTY  BRANCH WHEN ENTRY DOES NOT...@D37ADDK 11930016
         BNE   DERBS020             MATCH.                     @D51TDPM 11940016
         SLR   R7,R7              TAKE DEVICE TYPE FOR         @D51TDPM 11950016
         IC    R7,DERDTDVT          FURTHER INVESTIGATIONS     @DERPDGL 11960016
         B     DERBS030           BRANCH TO CONTINUE           @DERPDGL 11970016
DERBS020 BXLE  R5,R6,DERBS010     BRANCH WHEN NOT END OF TABLE.@D51TDPM 11980016
         DROP  R5                                              @D37ADDK 11990016
*                                                              @D51TDPM 12000016
*   IF DEVICE IS UNKNOWN, EXIT WITH RECOVERY ERROR             @D51TDPM 12010016
*                                                              @D51TDPM 12020016
         LA    RF,DERECRE         RECOVERY ERROR.              @D51TDPM 12030016
         B     DERBS080                                        @D51TDPM 12040016
DERBS030 DS    0H                                              @D51TDPM 12050016
*                                                              @D51TDPM 12060016
*   SET THE 24+8 INDICATION FOR TABLE SEARCH BELOW.            @D51TDPM 12070016
*                                                              @D51TDPM 12080016
         CLI   ERRQLSNS,32                                     @DERPDGL 12090016
         BNE   DERBS032                                        @DERPDGL 12100016
         CLI   PUBDEVTY,TFBA                                   @DERPDGL 12110016
         BE    DERBS032                                        @DERPDGL 12120016
         LA    R7,DERS24P8(,R7)                                @DERPDGL 12130016
DERBS032 DS    0H                                              @DERPDGL 12140016
         AGO   .NOSUP30                                        @D61ADJK 12150016
*                                                              @D51TDPM 12160016
*   TRY TO IDENTIFY THE ERROR CONDITION.                       @D51TDPM 12170016
*                                                              @D51TDPM 12180016
*   INTERVENTION IS REQUIRED - SPECIAL                         @D51TDPM 12190016
*                                                              @D51TDPM 12200016
         TM   ERRQSNS,X'40'                                    @D51TDPM 12210016
         BZ   DERSP010                                         @D51TDPM 12220016
         TM   ERRQSNS,X'10'                                    @D51TDPM 12230016
         BO   DERSP010                                         @D51TDPM 12240016
         LA   R0,DER3340+DER3350                               @D51TDPM 12250016
         NR   R0,R7                                            @D51TDPM 12260016
         BZ   DERSP010                                         @D51TDPM 12270016
         TM   ERRQSNS+10,X'0C'                                 @D51TDPM 12280016
         BZ   DERSP010                                         @D51TDPM 12290016
         LA   RF,DERECIRS                                      @D51TDPM 12300016
         B    DERBS080                                         @D51TDPM 12310016
DERSP010 EQU  *                                                @D51TDPM 12320016
.NOSUP30 ANOP                                                  @D61ADJK 12330016
*                                                              @D52WSPM 12340016
*   PINNED DATA - INFORMATIONAL,                               @D52WSPM 12350016
*   ATTENTION PRESENTED ON A VM SPECIAL INTERCEPT CONDITION,   @DA42666 12360016
*   AND CMD REJECT CAUSED BY A VM SPECIAL INTERCEPT CONDITION  @D61ADJK 12370016
*                                                              @D52WSPM 12380016
         LA   R0,DERS24P8                                      @D52WSPM 12390016
         NR   R0,R7                                            @D52WSPM 12400016
         BZ   DERSP020                                         @D52WSPM 12410016
         TM   ERRQSNS+2,B'00010000'                            @D52WSPM 12420016
         BNO  DERSP020                                         @D52WSPM 12430016
         TM   ERRQSNS+1,B'00010000'                            @D52WSPM 12440016
         BNO  DERSP022                                         @DA42666 12450016
         CLI  ERRQSNS+7,X'04'                                  @D52WSPM 12460016
         BNE  DERSP022                                         @D61ADJK 12470016
         LA   RF,DERECPDI                                      @D52WSPM 12480016
         B    DERBS080                                         @D52WSPM 12490016
DERSP022 DS   0H                                               @DA42666 12500016
*                                                              @DA42666 12510016
*   SPECIAL INTERCEPT BROKEN BY VM CACHE COMMAND?              @DA42666 12520016
.*  WITH VSE RUNNING UNDER VM A COMMAND MAY BE ISSUED THAT     @DA42666 12530016
.*  CAUSES THE SPECIAL INTERCEPT CONDITION OF A DEDICATED      @DA42666 12540016
.*  DASD TO BE BROKEN. WE SEE THIS AS AN UNSOLICITED INTERRUPT @DA42666 12550016
.*  WITH THE FOLLOWING 24+8 SENSE DATA: (ACTUAL CASE)          @DA42666 12560016
.*  000010004412010F81.... BYTE22: 0F0F1471                    @DA42666 12570016
.*  SEE GA32-0099-5 PAGE 188 AND 194                           @D61ADJK 12580016
*                                                              @D61ADJK 12590016
         CLI  ERRQSNS+7,X'0F'                                  @DA42666 12600016
         BNE  DERSP020                                         @DA42666 12610016
         CLI  ERRQSNS+8,X'81'                                  @DA42666 12620016
         BNE  DERSP024                                         @D61ADJK 12630016
         CLI  ERRQSNS+25,X'71'                                 @DA42666 12640016
         BNE  DERSP024                                         @D61ADJK 12650016
         OC   ERRQCHQA,ERRQCHQA                                @DA42666 12660016
         BNZ  DERSP024                                         @D61ADJK 12670016
         TM   SUPFLAG,VMSYS                                    @DA42666 12680016
         BNO  DERSP020                                         @DA42666 12690016
         LA   RF,DERECVMS                                      @DA42666 12700016
         B    DERBS080                                         @DA42666 12710016
DERSP024 DS   0H                                               @D61ADJK 12720016
*   COMMAND REJECT BECAUSE THE INTERFACE WAS DISABLED BY A VM  @D61ADJK 12730016
*   SET SPECIAL INTERCEPT CONDITION ORDER OF THE PSF COMMAND   @D61ADJK 12740016
.* VM ESTABLISHES THE SSIC STATE BY ISSUING THE APPROPRIATE    @D61ADJK 12750016
.* PSF CCW AND THEN PUTS THE DEVICE INTO IOASSIST FOR THE      @D61ADJK 12760016
.* PREFERRED GUEST.  THIS ALLOWS THE GUEST TO HAVE BETTER      @D61ADJK 12770016
.* PERFORMANCE ON I/O TO THAT DEVICE BECAUSE THE I/O GOES      @D61ADJK 12780016
.* DIRECTLY TO THE DEVICE AND DOES NOT GO THROUGH VM'S CCW     @D61ADJK 12790016
.* TRANSLATION. IF SSIC WERE NOT SET THE GUEST COULD DISCARD   @D61ADJK 12800016
.* ANY DATA IN CACHE, TURN CACHE OFF, ETC.  SSIC CAUSES ANY    @D61ADJK 12810016
.* OF THESE 'GLOBAL CCWS' TO BE UNIT CHECKED AND THE SUBSYSTEM @D61ADJK 12820016
.* DROPS OUT OF THE SSIC STATE FOR THAT DEVICE. THE UNIT CHECK @D61ADJK 12830016
.* CAUSES THE DEVICE TO COME OUT OF IOASSIST WHICH MEANS THAT  @D61ADJK 12840016
.* THE REDRIVE OF THE I/O BY THE GUEST GOES THROUGH VM'S CCW   @D61ADJK 12850016
.* TRANSLATION. VM CAN NOW VALIDATE THE GUEST'S AUTHORITY TO   @D61ADJK 12860016
.* ISSUE THAT I/O AND WILL EITHER LET IT GO TO THE DEIVCE OR   @D61ADJK 12870016
.* COMMAND REJECT IT.  AFTER THAT SSIC IS RE-ESTABLISHED AND   @D61ADJK 12880016
.* THE DEVICE IS PUT BACK INTO IOASSIST.                       @D61ADJK 12890016
.* THE KEY TO THIS WORKING IS THAT A SSIC UNIT CHECK CAUSES    @D61ADJK 12900016
.* SSIC TO BE RESET SO THAT THE REDRIVE WILL DO WHAT THE CCW   @D61ADJK 12910016
.* IS SUPPOSED TO DO.                                          @D61ADJK 12920016
.* SEE GA32-0099-5 PAGE 188 AND 194                            @D61ADJK 12930016
*                                                              @D61ADJK 12940016
         TM   ERRQSNS,X'80'                                    @D61ADJK 12950016
         BZ   DERSP020                                         @D61ADJK 12960016
         CLI  ERRQSNS+8,X'80'                                  @D61ADJK 12970016
         BNE  DERSP020                                         @D61ADJK 12980016
         CLI  ERRQSNS+25,X'70'                                 @D61ADJK 12990016
         BNE  DERSP020                                         @D61ADJK 13000016
         TM   SUPFLAG,VMSYS                                    @D61ADJK 13010016
         BNO  DERSP020                                         @D61ADJK 13020016
         LA   RF,DERECVMC                                      @D61ADJK 13030016
         B    DERBS080                                         @D61ADJK 13040016
DERSP020 EQU  *                                                @D52WSPM 13050016
*                                                              @D51TDPM 13060016
*   SUBSYSTEM INFORMATION                                      @D51TDPM 13070016
*                                                              @D51TDPM 13080016
         TM   ERRQSNS,X'10'                                    @D51TDPM 13090016
         BZ   DERSP030                                         @D51TDPM 13100016
         LA   R0,DERS24P8                                      @D61ADJK 13110016
         NR   R0,R7                                            @D51TDPM 13120016
         BZ   DERSP030                                         @D51TDPM 13130016
         CLI  ERRQSNS+7,X'F2'                                  @D51TDPM 13140016
         BE   DERSP025                                         @D51TDPM 13150016
         CLI  ERRQSNS+7,X'F4'                                  @D51TDPM 13160016
         BE   DERSP025                                         @D51TDPM 13170016
         CLI  ERRQSNS+7,X'FA'                                  @D51TDPM 13180016
         BE   DERSP025                                         @D51TDPM 13190016
         CLI  ERRQSNS+7,X'FB'                                  @D51TDPM 13200016
         BE   DERSP025                                         @D51TDPM 13210016
         B    DERSP030                                         @D52WSPM 13220016
DERSP025 EQU  *                                                @D51TDPM 13230016
         LA   RF,DERECSI                                       @D51TDPM 13240016
         B    DERBS080                                         @D51TDPM 13250016
DERSP030 EQU  *                                                @D51TDPM 13260016
*                                                              @D51TDPM 13270016
*   COUNTER OFFLOAD                                            @D51TDPM 13280016
*                                                              @D51TDPM 13290016
         TM   ERRQSNS+2,X'10'                                  @D51TDPM 13300016
         BZ   DERSP040                                         @D51TDPM 13310016
         TM   ERRQSNS+7,B'01100000'                            @DERPDGL 13320016
         BNO  DERSP040                                         @DERPDGL 13330016
         TM   ERRQSNS+7,B'10010000'                            @DERPDGL 13340016
         BNZ  DERSP040                                         @DERPDGL 13350016
         LA   RF,DERECCO                                       @D51TDPM 13360016
         B    DERBS080                                         @D51TDPM 13370016
DERSP040 EQU  *                                                @D51TDPM 13380016
*                                                              @D51TDPM 13390016
*   PATH FENCED                                                @D51TDPM 13400016
*                                                              @D51TDPM 13410016
         TM   ERRQSNS+1,X'10'                                  @D51TDPM 13420016
         BZ   DERSP050                                         @D51TDPM 13430016
         TM   ERRQSNS+2,X'10'                                  @D51TDPM 13440016
         BZ   DERSP050                                         @D51TDPM 13450016
         LA   R0,DER3380                                       @D51TDPM 13460016
         NR   R0,R7                                            @D51TDPM 13470016
         BZ   DERSP050                                         @D51TDPM 13480016
         CLI  ERRQSNS+7,X'03'                                  @D51TDPM 13490016
         BE   DERSP045                                         @D51TDPM 13500016
         CLI  ERRQSNS+7,X'75'                                  @D51TDPM 13510016
         BE   DERSP045                                         @D51TDPM 13520016
         CLI  ERRQSNS+7,X'7C'                                  @D51TDPM 13530016
         BE   DERSP045                                         @D51TDPM 13540016
         CLI  ERRQSNS+7,X'7D'                                  @D51TDPM 13550016
         BNE  DERSP050                                         @D51TDPM 13560016
DERSP045 EQU  *                                                @D51TDPM 13570016
         LA   RF,DERECPF                                       @D51TDPM 13580016
         B    DERBS080                                         @D51TDPM 13590016
DERSP050 EQU  *                                                @D51TDPM 13600016
*                                                              @D51TDPM 13610016
*   RESET NOTIFICATION                                         @D51TDPM 13620016
*                                                              @D51TDPM 13630016
         TM    ERRQSNS+2,X'10'                                 @D51TDPM 13640016
         BZ    DERSP060                                        @D51TDPM 13650016
         CLI   ERRQSNS+7,X'08'                                 @D51TDPM 13660016
         BE    DERSP055                                        @D51TDPM 13670016
         CLI   ERRQSNS+7,X'29'                                 @D51TDPM 13680016
         BNE   DERSP060                                        @D51TDPM 13690016
DERSP055 DS    0H                                              @D51TDPM 13700016
         LA    RF,DERECRN                                      @D51TDPM 13710016
         B     DERBS080                                        @D51TDPM 13720016
DERSP060 DS    0H                                              @D51TDPM 13730016
*                                                              @DA41424 13740016
*   OPERATION WAS TERMINATED BY SUBSYSTEM                      @DA41424 13750016
*                                                              @DA41424 13760016
         LA    R0,DERS24P8                                     @D61ADJK 13770016
         NR    R0,R7                                           @D61ADJK 13780016
         BZ    DERSP070                                        @D61ADJK 13790016
         TM    ERRQSNS+2,X'10'                                 @D51TDPM 13800016
         BZ    DERSP070                                        @D51TDPM 13810016
         CLI   ERRQSNS+7,X'F0'                                 @D51TDPM 13820016
         BNE   DERSP070                                        @D51TDPM 13830016
         CLI   ERRQSNS+25,X'00'                                @D52WSPM 13840016
         BNE   DERSP070                                        @D52WSPM 13850016
         LA    RF,DERECOT     OPERATION TERMINATION            @D52WSPM 13860016
         B     DERBS080                                        @D52WSPM 13870016
DERSP070 DS    0H                                              @D51TDPM 13880016
*                                                              @D51TDPM 13890016
*   CFWID MISMATCH AND PINNED DATA - NOT INFORMATIONAL.        @D51TDPM 13900016
*                                                              @D51TDPM 13910016
         LA    R0,DERS24P8                                     @D61ADJK 13920016
         NR    R0,R7                                           @D61ADJK 13930016
         BZ    DERSP080                                        @D61ADJK 13940016
         CLI   ERRQSNS+7,X'F6'                                 @D51TDPM 13950016
         BNE   DERSP080                                        @D51TDPM 13960016
         TM    ERRQSNS+0,B'10000000'                           @D51TDPM 13970016
         BZ    DERSP075                                        @D51TDPM 13980016
         LA    RF,DERECFWM    CFWID MISMATCH                   @D51TDPM 13990016
         B     DERBS080                                        @D51TDPM 14000016
DERSP075 DS    0H                                              @D51TDPM 14010016
         TM   ERRQSNS+0,B'00010000'                            @D51TDPM 14020016
         BZ   DERSP080                                         @D51TDPM 14030016
         LA   RF,DERECPDN    PINNED DATA - NOT INFORMATIONAL   @D51TDPM 14040016
         B    DERBS080                                         @D51TDPM 14050016
DERSP080 EQU  *                                                @D51TDPM 14060016
*                                                              @D52WSPM 14070016
*   SUBSYSTEM STORAGE NOTIFICATION                             @D52WSPM 14080016
*                                                              @D52WSPM 14090016
         LA   R0,DERS24P8                                      @D61ADJK 14100016
         NR   R0,R7                                            @D61ADJK 14110016
         BZ   DERSP090                                         @D61ADJK 14120016
         TM   ERRQSNS+2,B'00010000'                            @D52WSPM 14130016
         BZ   DERSP090                                         @D52WSPM 14140016
         CLI  ERRQSNS+7,X'F3'                                  @D52WSPM 14150016
         BE   DERSP085                                         @D52WSPM 14160016
         CLI  ERRQSNS+7,X'F9'                                  @D52WSPM 14170016
         BE   DERSP085                                         @D52WSPM 14180016
         CLI  ERRQSNS+7,X'FD'                                  @D52WSPM 14190016
         BE   DERSP085                                         @D52WSPM 14200016
         B    DERSP090                                         @D52WSPM 14210016
DERSP085 EQU  *                                                @D52WSPM 14220016
         LA   RF,DERECSSN                                      @D52WSPM 14230016
         B    DERBS080                                         @D52WSPM 14240016
DERSP090 EQU  *                                                @D52WSPM 14250016
*                                                              @D61ADJK 14260016
*   INVALID TRACK FORMAT DURING STAGING OR DESTAGING           @D61ADJK 14270016
*                                                              @D61ADJK 14280016
         LA   R0,DERS24P8                                      @D61ADJK 14290016
         NR   R0,R7                                            @D61ADJK 14300016
         BZ   DERSP100                                         @D61ADJK 14310016
         TM   ERRQSNS+1,B'11010000'                            @D61ADJK 14320016
         BNO  DERSP100                                         @D61ADJK 14330016
         TM   ERRQSNS+2,B'00010000'                            @D61ADJK 14340016
         BZ   DERSP100                                         @D61ADJK 14350016
         CLI  ERRQSNS+7,X'F7'                                  @D61ADJK 14360016
         BE   DERSP095                                         @D61ADJK 14370016
         B    DERSP100                                         @D61ADJK 14380016
DERSP095 EQU  *                                                @D61ADJK 14390016
         LA   RF,DERECIDF                                      @D61ADJK 14400016
         B    DERBS080                                         @D61ADJK 14410016
DERSP100 EQU  *                                                @D61ADJK 14420016
*                                                              @D61ADJK 14430016
*   DASD FAST WRITE INHIBIT                                    @D61ADJK 14440016
*                                                              @D61ADJK 14450016
         LA   R0,DERS24P8                                      @D61ADJK 14460016
         NR   R0,R7                                            @D61ADJK 14470016
         BZ   DERSP110                                         @D61ADJK 14480016
         TM   ERRQSNS+0,B'00010000'                            @D61ADJK 14490016
         BNO  DERSP110                                         @D61ADJK 14500016
         TM   ERRQSNS+1,B'00010000'                            @D61ADJK 14510016
         BNO  DERSP110                                         @D61ADJK 14520016
         TM   ERRQSNS+2,B'00010000'                            @D61ADJK 14530016
         BNO  DERSP110                                         @D61ADJK 14540016
         CLI  ERRQSNS+7,X'FE'                                  @D61ADJK 14550016
         BE   DERSP105                                         @D61ADJK 14560016
         B    DERSP110                                         @D61ADJK 14570016
DERSP105 EQU  *                                                @D61ADJK 14580016
         LA   RF,DERECFWI                                      @D61ADJK 14590016
         B    DERBS080                                         @D61ADJK 14600016
DERSP110 EQU  *                                                @D61ADJK 14610016
*                                                              @D51TDPM 14620016
*  CLASSIFY THE ERROR CONDITION BASED UPON SENSE BYTES 0 - 2.  @D51TDPM 14630016
*                                                              @D51TDPM 14640016
         LA    R5,DERERR-DERTBLEN LOAD ERROR CORRCTN TABL ADDR @D37ADDK 14650016
         USING DERTBADR,R5        DECL ERROR CORRCTN TABL BASE @D37ADDK 14660016
*                                                              @D51TDPM 14670016
DERBS070 EQU   *                                               @D51TDPM 14680016
         LA    R5,DERTBLEN(R5)    GET NEXT ENTRY               @D37ADDK 14690016
         LR    R6,R7              COPY DEVICE MASK             @D37ADDK 14700016
         N     R6,DERTBDEV-3      IS ENTRY RELEVANT            @D37ADDK 14710016
         BZ    DERBS070           NO  TRY AGAIN                @D37ADDK 14720016
*                                                              @D51TDPM 14730016
         L     R6,ERRQSNS         SET UP ACTUAL SENSE BYTES.   @D31HMRH 14740016
         N     R6,DERTBSNS        MASK OUT PERTINENT BITS.     @D37ADDK 14750016
         CLM   R6,B'1110',DERTBSNS   TRY NEXT ENTRY IF         @D37ADDK 14760016
         BNE   DERBS070              THERE IS NO MATCH.        @D37ADDK 14770016
         SLR   RF,RF              GET THE CLASSIFICATION...    @D51TDPM 14780016
         IC    RF,DERTBECC          CODE.                      @D51TDPM 14790016
DERBS080 DS    0H                                              @D51TDPM 14800016
         LA    R0,DER370            BRANCH IF DEVICE NOT       @DERPDGL 14810016
         NR    R0,R7                  CKD                      @DERPDGL 14820016
         BZ    DERBS090               DEVICE                   @DERPDGL 14830016
         CLI   ERRQSNS+7,X'41'      BRANCH IF ITS FORMAT 4     @DERPDGL 14840016
         BE    DERBS082               AND MESSAGE ONE          @DERPDGL 14850016
         CLI   ERRQSNS+7,X'45'      BRANCH IF ITS FORMAT 4     @DERPDGL 14860016
         BE    DERBS082               AND MESSAGE 5            @DERPDGL 14870016
         CLI   ERRQSNS+7,X'51'      BRANCH IF ITS FORMAT 5     @DERPDGL 14880016
         BE    DERBS082               AND MESSAGE 1            @DERPDGL 14890016
         LA    R0,DER3380           BRANCH IF ITS NO           @DERPDGL 14900016
         NR    R0,R7                  3380 OR ECKD             @DERPDGL 14910016
         BZ    DERBS090               IN 24+8 SENSE            @DERPDGL 14920016
         CLI   ERRQSNS+7,X'49'      BRANCH IF ITS FORMAT 4     @DERPDGL 14930016
         BE    DERBS082               AND MESSAGE 9            @DERPDGL 14940016
         CLI   ERRQSNS+7,X'59'      BRANCH IF ITS FORMAT 5     @DERPDGL 14950016
         BE    DERBS082               AND MESSAGE 9            @DERPDGL 14960016
         CLI   ERRQSNS+7,X'4D'      BRANCH IF ITS NOT FORMAT 4 @DERPDGL 14970016
         BNE   DERBS090               AND MESSAGE D            @DERPDGL 14980016
DERBS082 O     RF,=AL1(0,DERRA3CC,0,0)                         @DERPDGL 14990016
DERBS090 B     DERF3000                                        @D51TDPM 15000016
*                                                              @D51TDPM 15010016
*   SGDSK DEVICE TYPE CODE TABLE. FOR MAPPING SEE DERDTADR DSECT        15020016
*                                                                       15030016
DERDEV   DS    0F                                              @D14ZDDK 15040016
         DC    AL1(TFBA,0,4,0,0,0,DERFBA)                      @D51TDPM 15050016
***************************************************************@D31HMRH 15060016
*                   3380 ENTRY IS USED FOR 3390 RUNNING       *@D31HMRH 15070016
*                      IN TRACK EMULATION MODE                *@D31HMRH 15080016
***************************************************************@D31HMRH 15090016
         DC    AL1(TECKD,14,4,X'0F',X'0F',4,DER3380)           @D51TDPM 15100016
         DC    AL1(T3380,14,4,X'0F',X'0F',4,DER3380)           @D51TDPM 15110016
DERDEVE  DC    AL1(T3375,11,2,X'0F',X'03',6,DER3375)           @D61ADJK 15120016
         AGO   .NOSUP18                                        @DERPDGL 15130016
         DC    AL1(T334070,11,3,X'0F',X'03',5,DER3340)         @D51TDPM 15140016
         DC    AL1(T334036,11,3,X'0F',X'03',5,DER3340)         @D51TDPM 15150016
         DC    AL1(T3340,11,3,X'0F',X'03',5,DER3340)           @D51TDPM 15160016
         DC    AL1(T3330B,18,3,X'1F',X'03',5,DER3330)          @D51TDPM 15170016
         DC    AL1(T3330,18,3,X'1F',X'01',6,DER3330)           @D51TDPM 15180016
DERDEVE  DC    AL1(T3350,29,3,X'1F',X'03',5,DER3350)           @D51TDPM 15190016
.NOSUP18 ANOP                                                  @D61ADJK 15200016
*                                                                       15210016
         EJECT ,                                                        15220016
*-------------------------------------------------------------*         15230016
*                                                                       15240016
*   ERROR CLASSIFICATION CODE TABLE.                                    15250016
*                                                                       15260016
*   EACH ENTRY IN THE TABLE IS MAPPED BY THE DERTBADR DSECT.            15270016
*                                                                       15280016
*        ====> ATTENTION:                                               15290016
*                                                                       15300016
*              THE POSITIONS OF THE ERROR CORRECTION TABLE              15310016
*              ENTRIES DETERMINE THE SEQUENCE OF ERROR                  15320016
*              CONDITIONS TESTED AND THUS HAVE AN EFFECT ON             15330016
*              THE ERP LOGIC                                            15340016
*                                                                       15350016
*              EXAMPLE:                                                 15360016
*              (DATACHECK, OPINCOMP, CORRECT) FOR A 3330                15370016
*              MUST BE TESTED BEFORE (DATACHECK, CORRECT) FOR           15380016
*              A 3380 SINCE THE LATTER BIT COMBINATION IS A             15390016
*              SUBSET OF THE FIRST ONE AND WOULD RESULT IN A            15400016
*              MATCH IF ALL THREE BITS WERE SET.                        15410016
*                                                                       15420016
*-------------------------------------------------------------*         15430016
*                                                                       15440016
BLKSZXCP EQU   X'40'                 BLOCK SIZE EXCEPTION      @D31HMRH 15450016
MESSAGE  EQU   X'10'                 MESSAGE TO OPERATOR BIT   @D31HMRH 15460016
DER1ERRL EQU   X'20'                 FIRST ERROR LOGGED        @D21OTJF 15470016
*                                                                       15480016
DERERR   DS    0H                                                       15490016
*                                                                       15500016
*   END OF CYLINDER                                            @D51TDPM 15510016
         DC    AL1(0,ENDOFCYL,0)                                        15520016
         DC    AL1(DERALL-DERFBA)                              @D51TDPM 15530016
         DC    AL1(DERECEOC)                                   @D51TDPM 15540016
*                                                              @D51TDPM 15550016
*   NO RECORD FOUND                                            @D51TDPM 15560016
         DC    AL1(0,NORECFND,0)                                        15570016
         DC    AL1(DERALL-DERFBA)                              @D51TDPM 15580016
         DC    AL1(DERECNRF)                                   @D51TDPM 15590016
*                                                              @D51TDPM 15600016
*   INCOMPLETE DOMAIN.                                         @D51TDPM 15610016
.*                                                             @DERPDGL 15620016
.*?????? IN THE DOCUMENTATION FOR 3880 CU ONLY 3340 IS SAID TO @DERPDGL 15630016
.*  SET THIS BIT ON. ALL OTHER DEVICES DO NOT MENTION IT.      @DERPDGL 15640016
.*                                                             @DERPDGL 15650016
         DC    AL1(B'00000001',0,0)                            @D51TDPM 15660016
         DC    AL1(DERALL-DER3340)                             @D51TDPM 15670016
         DC    AL1(DERECID)                                    @D51TDPM 15680016
*                                                              @D51TDPM 15690016
*   LOG ONLY                                                   @D51TDPM 15700016
.*  THERE IS AN EMULATION MODE FOR 3330 AND 3340 DEVICES ON    @DERPDGL 15710016
.*  A 3370 (FBA) DASD, WHICH IS USING THIS BIT. ALSO BRYAN     @DERPDGL 15720016
.*  HENDERSON SAID, THAT THE 9332 DEVICE WOULD USE IT. THE BIT @DERPDGL 15730016
.*  INDICATES, THAT THE IO WAS SUCCESSFUL, JUST SOME OTHER     @DERPDGL 15740016
.*  INFORMATION SHOULD BE LOGGED. RETRY OF THE IO IS NOT       @DERPDGL 15750016
.*  REQUIRED.                                                  @DERPDGL 15760016
         DC    AL1(0,0,LOGONLY)                                         15770016
         DC    AL1(DERFBA)                                              15780016
         DC    AL1(DERECLO)                                    @D52WSBH 15790016
*                                                              @D52WSBH 15800016
*   LAST LOGGED ERROR                                          @D52WSBH 15810016
         DC    AL1(0,MESSAGE,ENVDATA)                          @D14AGMD 15820016
         DC    AL1(DER3375+DER3380+DERFBA)                     @D52WSBH 15830016
         DC    AL1(DERECLLE)                                   @D52WSBH 15840016
*                                                              @D51TDPM 15850016
*   DEVICE WRITE INHIBITED                                     @D51TDPM 15860016
         DC    AL1(COMREJ,X'02',0)                             @D51TDPM 15870016
         DC    AL1(DERALL-DER3380)                                      15880016
         DC    AL1(DERECDWI)                                   @D51TDPM 15890016
*                                                              @D51TDPM 15900016
*   BASIC COMMAND REJECT                                       @D51TDPM 15910016
         DC    AL1(COMREJ,0,0)                                          15920016
         DC    AL1(DERALL)                                              15930016
         DC    AL1(DERECBCR)                                   @D51TDPM 15940016
*                                                              @D51TDPM 15950016
*   INTERVENTION REQUIRED EQUIPMENT CHECK                      @D51TDPM 15960016
         DC    AL1(INTVRQD+EQUIPCHK,0,0)                                15970016
         DC    AL1(DERFBA)                                              15980016
         DC    AL1(DERECIRE)                                   @D51TDPM 15990016
*                                                              @D51TDPM 16000016
*   INTERVENTION IS REQUIRED - ENVIRONMENTAL DATA PRESENT      @D51TDPM 16010016
.*????????                                                     @DERPDGL 16020016
.*  I COULD NOT FIND THIS COMBINATION WITH ANY DEVICE ERP      @DERPDGL 16030016
.*  TABLE.                                                     @DERPDGL 16040016
         DC    AL1(INTVRQD,0,ENVDATA)                          @D51TDPM 16050016
         DC    AL1(DERALL)                                     @D51TDPM 16060016
         DC    AL1(DERECIED)                                   @D51TDPM 16070016
*                                                              @D51TDPM 16080016
*   INTERVENTION IS REQUIRED                                   @D51TDPM 16090016
         DC    AL1(INTVRQD,0,0)                                @D51TDPM 16100016
         DC    AL1(DERALL)                                     @D51TDPM 16110016
         DC    AL1(DERECIR)                                    @D51TDPM 16120016
*                                                              @D51TDPM 16130016
*   BLOCK SIZE EXCEPTION                                       @D51TDPM 16140016
         DC    AL1(0,BLKSZXCP,0)                               @D14ADDK 16150016
         DC    AL1(DERFBA)                                     @D14ADDK 16160016
         DC    AL1(DERECBSE)                                   @D51TDPM 16170016
*                                                              @D51TDPM 16180016
*   BUSOUT                                                     @D51TDPM 16190016
         DC    AL1(BUSOUT,0,0)                                          16200016
         DC    AL1(DERALL)                                              16210016
         DC    AL1(DERECB)                                     @D51TDPM 16220016
*                                                              @D51TDPM 16230016
*   ALTERNATE INTERFACE DISABLED                               @D51TDPM 16240016
         DC    AL1(EQUIPCHK,ALTINTDA,0)                                 16250016
         DC    AL1(DERALL)                                              16260016
         DC    AL1(DERECAID)                                   @D51TDPM 16270016
*                                                              @D51TDPM 16280016
*   PATH WRITE INHIBITED                                       @D51TDPM 16290016
         DC    AL1(EQUIPCHK,X'02',0)                           @D14ADDK 16300016
         DC    AL1(DER3380+DER3350)                                     16310016
         DC    AL1(DERECPWI)                                   @D51TDPM 16320016
*                                                              @D51TDPM 16330016
*   EQUIPMENT CHECK WITH ENVIRONMENTAL DATA IN 24+8 SENSE      @D51TDPM 16340016
         DC    AL1(EQUIPCHK,0,ENVDATA)                         @D14ADDK 16350016
         DC    AL1(DERS24P8)                                   @D14ADDK 16360016
         DC    AL1(DERECEEC)                                   @D51TDPM 16370016
*                                                              @D51TDPM 16380016
*   EQUIPMENT CHECK WITH PERMANENT ERROR IN    24+8 SENSE      @D51TDPM 16390016
         DC    AL1(EQUIPCHK,PERMERR,0)                         @D14ADDK 16400016
         DC    AL1(DERS24P8)                                   @D14ADDK 16410016
         DC    AL1(DERECEEC)                                   @D51TDPM 16420016
*                                                              @D51TDPM 16430016
*   PLAIN EQUIPMENT CHECK IN                   24+8 SENSE      @D51TDPM 16440016
         DC    AL1(EQUIPCHK,0,0)                               @D14ADDK 16450016
         DC    AL1(DERS24P8)                                   @D14ADDK 16460016
         DC    AL1(DERECECC)                                   @D51TDPM 16470016
*                                                              @D51TDPM 16480016
*   RECOVERABLE 3375/80 EQUIPMENT CHECK                        @D51TDPM 16490016
         DC    AL1(EQUIPCHK,0,0)                               @D14ADDK 16500016
         DC    AL1(DER3375+DER3380)                            @D14ADDK 16510016
         DC    AL1(DERECR7E)                                   @D51TDPM 16520016
*                                                              @D51TDPM 16530016
*   RECOVERABLE EQUIPMENT CHECK                                @D51TDPM 16540016
         DC    AL1(EQUIPCHK,0,0)                                        16550016
         DC    AL1(DERALL)                                              16560016
         DC    AL1(DERECREC)                                   @D51TDPM 16570016
*                                                              @D52WSPM 16580016
*   DATA CHECK RECOVERED ON SECONDARY                          @D52WSPM 16590016
         DC    AL1(DATACHK,0,ENVDATA)                          @D52WSPM 16600016
         DC    AL1(DERS24P8)                                   @D52WSPM 16610016
         DC    AL1(DERECDRS)                                   @D52WSPM 16620016
*                                                              @D51TDPM 16630016
*   PERMANENT DATA CHECK.                                      @D51TDPM 16640016
         DC    AL1(DATACHK,PERMERR,0)                          @D51TDPM 16650016
         DC    AL1(DERFBA)                                     @D51TDPM 16660016
         DC    AL1(DERECPDC)                                   @D51TDPM 16670016
         AGO   .NOSUP14                                        @D61ADJK 16680016
*   DATA CHECK 2                                               @D51TDPM 16690016
         DC    AL1(DATACHK+TRCNDCHK,OPINCOMP,CORRECT)                   16700016
         DC    AL1(DER3340)                                             16710016
         DC    AL1(DERECD02)                                   @D51TDPM 16720016
*                                                              @D51TDPM 16730016
*   DATA CHECK 3                                               @D51TDPM 16740016
         DC    AL1(DATACHK,OPINCOMP,CORRECT)                            16750016
         DC    AL1(DER3340+DER3350)                                     16760016
         DC    AL1(DERECD03)                                   @D51TDPM 16770016
*                                                              @D51TDPM 16780016
*   DATA CHECK 4                                               @D51TDPM 16790016
         DC    AL1(DATACHK,OPINCOMP,CORRECT)                            16800016
         DC    AL1(DER3330)                                             16810016
         DC    AL1(DERECD04)                                   @D51TDPM 16820016
.NOSUP14 ANOP                                                  @D61ADJK 16830016
*                                                              @D51TDPM 16840016
*   DATA CHECK 5                                               @D51TDPM 16850016
         DC    AL1(DATACHK,OPINCOMP,CORRECT)                            16860016
         DC    AL1(DERFBA)                                              16870016
         DC    AL1(DERECD05)                                   @D51TDPM 16880016
*                                                              @D51TDPM 16890016
*   CORRECTABLE DATA CHECK FOR 24+8 SENSE                      @D51TDPM 16900016
.*  FOR ANY DEVICE ATTACHED TO 3990 CONTROL UNIT, THE INDI-    @DERPDGL 16910016
.*  CATION OF A CORRECTABLE DATA CHECK IS ONLY GIVEN IN CASE   @DERPDGL 16920016
.*  OF PCI FETCH MODE AND SHALL NOT LEAD TO A RECOVERY OR      @DERPDGL 16930016
.*  RESTART ACTION.                                            @DERPDGL 16940016
.*                                                             @DERPDGL 16950016
         DC    AL1(DATACHK,0,CORRECT)                                   16960016
         DC    AL1(DERS24P8)                                   @DA26280 16970016
         DC    AL1(DERECCDC)                                   @D51TDPM 16980016
*                                                              @D51TDPM 16990016
*   DATA CHECK 6                                               @D51TDPM 17000016
.*  FOR 3880 WE SHALL DO THE RECOVERY ACTION (IMPLEMENTED      @DERPDGL 17010016
.*  IN DERECF) IN SOME CASES, WHEN THIS IS NOT NECESSARY,      @DERPDGL 17020016
.*  THE REAR DISPLACEMENT (BYTE 18,19) WILL BE ZERO IN SENSE.  @DERPDGL 17030016
.*                                                             @DERPDGL 17040016
         DC    AL1(DATACHK,0,CORRECT)                                   17050016
         DC    AL1(DER3330+DER3375+DER3380+DERFBA)             @DA26280 17060016
         DC    AL1(DERECD06)                                   @D51TDPM 17070016
         AGO   .NOSUP32                                        @D61ADJK 17080016
*   DATA CHECK 7                                               @D51TDPM 17090016
         DC    AL1(DATACHK,0,CORRECT)                                   17100016
         DC    AL1(DER3340+DER3350)                                     17110016
         DC    AL1(DERECD07)                                   @D51TDPM 17120016
*                                                              @D51TDPM 17130016
*   DATA CHECK 8                                               @D51TDPM 17140016
         DC    AL1(DATACHK,OPINCOMP,0)                                  17150016
         DC    AL1(DER3330+DER3350)                            @D14ADDK 17160016
         DC    AL1(DERECD08)                                   @D51TDPM 17170016
.NOSUP32 ANOP                                                  @D61ADJK 17180016
*                                                              @D51TDPM 17190016
*   DATA CHECK 9                                               @D51TDPM 17200016
         DC    AL1(DATACHK,OPINCOMP,0)                                  17210016
         DC    AL1(DERFBA)                                              17220016
         DC    AL1(DERECD09)                                   @D51TDPM 17230016
         AGO   .NOSUP33                                        @D61ADJK 17240016
*   DATA CHECK 10                                              @D51TDPM 17250016
         DC    AL1(DATACHK,0,0)                                         17260016
         DC    AL1(DER3340+DER3350)                            @KDL0047 17270016
         DC    AL1(DERECD10)                                   @D51TDPM 17280016
.NOSUP33 ANOP                                                  @D61ADJK 17290016
*                                                              @D51TDPM 17300016
*   PERMANENT DATA CHECK IN COMPATIBILITY SENSE                @D51TDPM 17310016
.*  INITIATE RECOVERY ACTION 1 FOR COMPATIBILITY SENSE DATA    @DERPDGL 17320016
.*  SEE GA32-0099-3 PAGE 235                                   @DERPDGL 17330016
.*                                                             @DERPDGL 17340016
         DC    AL1(DATACHK,PERMERR,0)                          @DERPDGL 17350016
         DC    AL1(DERS24P8)                                   @DERPDGL 17360016
         DC    AL1(DERECDCP)                                   @DERPDGL 17370016
*                                                              @D51TDPM 17380016
*   DATACHECK IN COMPATIBILITY SENSE                           @D51TDPM 17390016
.*  INITIATE RECOVERY ACTION 5 FOR COMPATIBILITY SENSE DATA    @DERPDGL 17400016
.*  SEE GA32-0099-3 PAGE 235                                   @DERPDGL 17410016
.*                                                             @DERPDGL 17420016
         DC    AL1(DATACHK,0,0)                                @DERPDGL 17430016
         DC    AL1(DERS24P8)                                   @DERPDGL 17440016
         DC    AL1(DERECDCS)                                   @DERPDGL 17450016
*                                                              @DERPDGL 17460016
*   DATA CHECK 11                                              @DERPDGL 17470016
.*  IF A 3880 GIVES ONLY DATA CHECK WE SHALL DO ACTION 4 OF    @DERPDGL 17480016
.*  MANUAL GA26-1661-9 PAGE 12-47. BUT WE DO NOT INHIBIT       @DA42963 17490016
.*  WRITES FOR A STORAGE DIRECTOR AFTER UNSUCCESSFUL RETRIES.  @DA42963 17500016
.*                                                             @DERPDGL 17510016
         DC    AL1(DATACHK,0,0)                                @D21OTJF 17520016
         DC    AL1(DER3380+DER3375)                            @D51TDPM 17530016
         DC    AL1(DERECD11)                                   @D51TDPM 17540016
         AGO   .NOSUP34                                        @D61ADJK 17550016
*   DATA CHECK 13                                              @D51TDPM 17560016
         DC    AL1(DATACHK,0,0)                                @D14AGMD 17570016
         DC    AL1(DER3330)                                    @D51TDPM 17580016
         DC    AL1(DERECD13)                                   @D51TDPM 17590016
.NOSUP34 ANOP                                                  @D61ADJK 17600016
*                                                              @D51TDPM 17610016
*   OPERATION INCOMPLETE OVERRUN                               @D51TDPM 17620016
         DC    AL1(OVERRUN,OPINCOMP,0)                                  17630016
         DC    AL1(DERFBA)                                              17640016
         DC    AL1(DERECOIO)                                   @D51TDPM 17650016
*                                                              @D51TDPM 17660016
*   BASIC FBA OVERRUN                                          @D51TDPM 17670016
         DC    AL1(OVERRUN,0,0)                                         17680016
         DC    AL1(DERFBA)                                              17690016
         DC    AL1(DERECBFO)                                   @D51TDPM 17700016
*                                                              @D51TDPM 17710016
*   BASIC OVERRUN ON 24+8 COMPATIBILITY SENSE                  @D51TDPM 17720016
.*  3990 CONTROL UNIT MANUAL SAYS, THAT IN CASE OF A 24 BYTE   @DERPDGL 17730016
.*  OVERRUN INDICATION THE PATH GROUP ID                       @DERPDGL 17740016
.*                                                             @DERPDGL 17750016
         DC    AL1(OVERRUN,0,0)                                         17760016
         DC    AL1(DERS24P8)                                   @D51TDPM 17770016
         DC    AL1(DERECBOC)                                   @D51TDPM 17780016
*                                                              @D51TDPM 17790016
*   BASIC OVERRUN                                              @D51TDPM 17800016
         DC    AL1(OVERRUN,0,0)                                         17810016
         DC    AL1(DERALL-DERFBA)                              @D51TDPM 17820016
         DC    AL1(DERECBO)                                    @D51TDPM 17830016
         AGO   .NOSUP36                                        @D61ADJK 17840016
*   OPERATION INCOMPLETE TRACK CONDITION CHECK                 @D51TDPM 17850016
         DC    AL1(TRCNDCHK,OPINCOMP,0)                                 17860016
         DC    AL1(DER3340)                                             17870016
         DC    AL1(DERECOIT)                                   @D51TDPM 17880016
*                                                              @D51TDPM 17890016
*   BASIC TRACK CONDITION CHECK                                @D51TDPM 17900016
         DC    AL1(TRCNDCHK,0,0)                                        17910016
         DC    AL1(DER3340)                                    @D51TDPM 17920016
         DC    AL1(DERECBTC)                                   @D51TDPM 17930016
*                                                              @D51TDPM 17940016
*   BASIC SEEK CHECK                                           @D51TDPM 17950016
         DC    AL1(SEEKCHK,0,0)                                         17960016
         DC    AL1(DER3340)                                    @D51TDPM 17970016
         DC    AL1(DERECBSC)                                   @D51TDPM 17980016
.NOSUP36 ANOP                                                  @D61ADJK 17990016
*                                                              @D51TDPM 18000016
*   INVALID TRACK FORMAT                                       @D51TDPM 18010016
         DC    AL1(0,ITRKFMT,0)                                         18020016
         DC    AL1(DERALL-DERFBA)                              @D51TDPM 18030016
         DC    AL1(DERECITF)                                   @D51TDPM 18040016
         AGO   .NOSUP35                                        @D61ADJK 18050016
*   FILE PROTECTED OVERFLOW                                    @D51TDPM 18060016
         DC    AL1(0,FILEPROT+OPINCOMP,0)                               18070016
         DC    AL1(DER3330+DER3340+DER3350)                    @D14ADDK 18080016
         DC    AL1(DERECFPO)                                   @D51TDPM 18090016
.NOSUP35 ANOP                                                  @D61ADJK 18100016
*                                                              @D51TDPM 18110016
*   BASIC FILE PROTECTED                                       @D51TDPM 18120016
         DC    AL1(0,FILEPROT,0)                                        18130016
         DC    AL1(DERALL-DER3340)                             @D51TDPM 18140016
         DC    AL1(DERECBFP)                                   @D51TDPM 18150016
         AGO   .NOSUP37                                        @D61ADJK 18160016
*   FILE PROTECTED 334X                                        @D51TDPM 18170016
         DC    AL1(0,FILEPROT,0)                                        18180016
         DC    AL1(DER3340)                                    @D51TDPM 18190016
         DC    AL1(DERECFPY)                                   @D51TDPM 18200016
.NOSUP37 ANOP                                                  @D61ADJK 18210016
*                                                              @D51TDPM 18220016
*   BASIC OPERATION INCOMPLETE                                 @D51TDPM 18230016
         DC    AL1(0,OPINCOMP,0)                                        18240016
         DC    AL1(DER3330+DER3350+DERFBA)                              18250016
         DC    AL1(DERECBOI)                                   @D51TDPM 18260016
*                                                              @D51TDPM 18270016
*   CORRECTABLE VERIFY ERROR                                   @D51TDPM 18280016
         DC    AL1(0,0,CHKDATA+CORRECT)                                 18290016
         DC    AL1(DERFBA)                                              18300016
         DC    AL1(DERECCVE)                                   @D51TDPM 18310016
*                                                              @D51TDPM 18320016
*   UNCORRECTABLE VERIFY ERROR                                 @D51TDPM 18330016
         DC    AL1(0,0,CHKDATA)                                         18340016
         DC    AL1(DERFBA)                                              18350016
         DC    AL1(DERECUVE)                                   @D51TDPM 18360016
*                                                              @D51TDPM 18370016
*   MISCELLANEOUS INFORMATION                                  @D51TDPM 18380016
         DC    AL1(0,MESSAGE,0)                                @D21KTJF 18390016
         DC    AL1(DERFBA)                                     @D21KTJF 18400016
         DC    AL1(DERECMI)                                    @D51TDPM 18410016
*                                                              @D51TDPM 18420016
*   FIRST LOGGED ERROR - 3380 OR 3390                          @D51TDPM 18430016
         DC    AL1(0,0,DER1ERRL+ENVDATA)                       @D21OTJF 18440016
         DC    AL1(DER3380)                                             18450016
         DC    AL1(DERECFLY)                                   @D51TDPM 18460016
*                                                              @D51TDPM 18470016
*   FIRST LOGGED ERROR - NOT 3380 OR 3390                      @D51TDPM 18480016
         DC    AL1(0,0,DER1ERRL+ENVDATA)                       @D21OTJF 18490016
         DC    AL1(DER3375+DERFBA)                                      18500016
         DC    AL1(DERECFLN)                                   @D51TDPM 18510016
*                                                              @D52WSBH 18520016
*   FORCED LOGGING EVENT                                       @D52WSBH 18530016
         DC    AL1(0,0,ENVDATA)                                @D52WSBH 18540016
         DC    AL1(DERALL)                                     @D52WSBH 18550016
         DC    AL1(DERECFLE)                                   @D52WSBH 18560016
*                                                              @D51TDPM 18570016
*   UNRECOGNIZED ERROR CONDITION.                              @D51TDPM 18580016
         DC    AL1(0,0,0)             THIS IS THE DEFAULT      @D14ZDDK 18590016
         DC    AL1(XFF)                     BIT COMBINATIONS.  @D14ZDDK 18600016
         DC    AL1(DERECURE)                                   @D51TDPM 18610016
*                                                                       18620016
*                                                              @DERPDGL 18630016
DERF3000 SLL   RB,8                                            @DERPDGL 18640016
         OR    RF,RB                                           @DERPDGL 18650016
*                                                              @DERPDGL 18660016
*   ANALYZE CODE FOR EXITS TO +0, +4 OR +8                     @DERPDGL 18670016
*                                                              @DERPDGL 18680016
         CLM   RE,7,=AL3(DER12100)   IS CALL FROM SGDSK CODE?  @DA42840 18690016
         BE    DERFSTX8                LEAVE IF YES            @DA42840 18700016
         LR    R5,RF                 FIND OUT IF WE SHOULD     @DERPDGL 18710016
         N     R5,=A(255)              LEAVE TO +4, INDICATING @DERPDGL 18720016
         C     R5,=A(DERECECC)         THAT THE PATH GROUP     @DERPDGL 18730016
         BE    DERF3100                ID WAS POSSIBLY LOST    @DERPDGL 18740016
         C     R5,=A(DERECBOC)         AND SHOULD BE RESET     @DERPDGL 18750016
         BE    DERF3100                BY THE SNS TASK         @DERPDGL 18760016
         C     R5,=A(DERECDCS)                                 @DERPDGL 18770016
         BNE   DERF3200                                        @DERPDGL 18780016
DERF3100 CLI   ERRQSNS+7,X'08'                                 @DERPDGL 18790016
         BE    DERFSTX4                                        @DERPDGL 18800016
DERF3200 C     R5,=A(DERECRN)                                  @DERPDGL 18810016
         BE    DERFSTX4                                        @DERPDGL 18820016
         C     R5,=A(DERSIPRE)                                 @DERPDGL 18830016
         BE    DERFSTX4                                        @DERPDGL 18840016
*                                                              @DERPDGL 18850016
         SLR   R1,R1                DO NOT USE SHORTCUT        @DERPDGL 18860016
         ICM   R1,7,ERRQCCB+1         IF THERE IS              @DERPDGL 18870016
         BZ    DERFSTX8               NO USER CCB ANY MORE     @DERPDGL 18880016
         USING CCBADR,R1                                       @DERPDGL 18890016
         CL    R1,=A(DERCCB)        DO NOT USE SHORTCUTS IF    @DERPDGL 18900016
         BE    DERFSTX8               ITS DSK RETRY..          @DERPDGL 18910016
*                                                              @DERPDGL 18920016
         CLI   ERRQLSNS,32          DO NOT USE SHORTCUTS IF    @DA41099 18930016
         BE    DERFI010               THE ADDRESS IN THE       @DA41099 18940016
         CLI   ERRQLSNS,24            CCBCSWW HAS TO BE        @DA41099 18950016
         BNE   DERFSTX8               CORRECTED FOR THE        @DA41099 18960016
         TM    ERRQSNS+2,X'04'        CALLER, SINCE IMPRECISE  @DA41099 18970016
         BO    DERFSTX8               ENDING                   @DA41099 18980016
         B     DERFI020               IS INDICATED IN          @DA41099 18990016
DERFI010 DS    0H                     THE                      @DA41099 19000016
         CLI   PUBDEVTY,TFBA          SENSE DATA               @DERPDGL 19010016
         BE    DERFI020               IN                       @DERPDGL 19020016
         TM    ERRQSNS+1,X'01'        SOME                     @DA41099 19030016
         BO    DERFSTX8               WAY                      @DA41099 19040016
DERFI020 DS    0H                                              @DA41099 19050016
*                                                              @DERPDGL 19060016
         LR    R0,RF                DO NOT USE SHORTCUT,       @DERPDGL 19070016
         N     R0,=AL1(0,0,DERCRSFC,0) IF THERE IS A STATE     @DERPDGL 19080016
         BZ    DERFI030               CHANGE PENDING COND.     @DERPDGL 19090016
         CLI   ERRQSNS+25,X'1D'       INDICATED IN 24+8        @DA42666 19100016
         BE    DERFSTX8               SENSE FORMAT             @DERPDGL 19110016
*                                                              @DERPDGL 19120016
DERFI030 C     R5,=A(DERECEOC)      TAKE A SHORTCUT FOR        @DERPDGL 19130016
         BE    DERFEOCY               END OF CYLINDER          @DERPDGL 19140016
         C     R5,=A(DERSIPEO)        PROCESSING               @DERPDGL 19150016
         BE    DERFEOCY                                        @DERPDGL 19160016
*                                                              @DERPDGL 19170016
         C     R5,=A(DERECNRF)      OR IF WE SHOULD LEAVE      @DERPDGL 19180016
         BE    DERFNRF                WITH A SHORT CUT         @DERPDGL 19190016
         C     R5,=A(DERSIPPE)        FOR NO RECORD FOUND      @DERPDGL 19200016
         BNE   DERFI040                                        @DERPDGL 19210016
         CLI   ERRQSNS+22,X'06'                                @DA42666 19220016
         BE    DERFNRF                                         @DERPDGL 19230016
*                                                              @DERPDGL 19240016
DERFI040 TM    CCBCOM1,OWNUCRT      OR IF USER                 @DERPDGL 19250016
         BO    DERFRECN               HAD SET THE BITS LEADING @DERPDGL 19260016
         TM    CCBCLS,CCBIORB                                  @DA43585 19270000
         BO    DERFSTX8                                        @DA43585 19280000
         TM    CCBBY3,USENSE          TO A RECORDING ONLY      @DERPDGL 19290016
         BNO   DERFSTX8               REQUEST AND ITS          @DERPDGL 19300016
DERFRECN C     R5,=A(DERECBCR)        BASIC COMMAND REJECT     @DERPDGL 19310016
         BE    DERFSTX0                                        @DERPDGL 19320016
         C     R5,=A(DERECIR)         INTERVENTION REQUIRED    @DERPDGL 19330016
         BE    DERFSTX0                                        @DERPDGL 19340016
         C     R5,=A(DERSIPIR)        OR INTV.REQ. IN ECKD     @DERPDGL 19350016
         BE    DERFSTX0                                        @DERPDGL 19360016
*                                                              @DERPDGL 19370016
         B     DERFSTX8             OR TAKE NORMAL EXIT        @DERPDGL 19380016
*                                                              @DERPDGL 19390016
DERFEOCY DS    0H                 END OF CYLINDER PROCESSING   @DERPDGL 19400016
         TM    CCBCLS,CCBIORB                                  @DA43585 19410000
         BO    DERFEOC1                                        @DA43585 19420000
         TM    CCBBY3,USENSE       BRANCH IF THERE HAD BEEN    @DERPDGL 19430016
         BO    DERFSTX0              ANY REASON TO MAKE THIS   @DERPDGL 19440016
DERFEOC1 TM    CCBCOM1,OWNUCRT       A RECONLY REQUEST         @DA43585 19450000
         BO    DERFSTX0              FOR SGDSK                 @DERPDGL 19460016
         NI    CCBCOM2,DERUIVAL                                @D51TDPM 19470016
         NI    CCBCOM1,X'FF'-DISERR                            @D51TDPM 19480016
         OI    CCBCOM2,ENDOFCYL    INDICATE EOC OCCURRED.      @D51TDPM 19490016
         B     DERFSTX0                                        @DERPDGL 19500016
*                                                              @DERPDGL 19510016
DERFNRF  DS    0H                 NO RECORD FOUND PROCESSING   @DERPDGL 19520016
         TM    CCBCOM2,NRFRETRY   BRANCH IF USER WANTED RETRY  @DERPDGL 19530016
         BO    DERFSTX8             OF THIS CONDITION          @DERPDGL 19540016
         TM    CCBCLS,CCBIORB                                  @DA43585 19550000
         BO    DERFNRF1                                        @DA43585 19560000
         TM    CCBBY3,USENSE       BRANCH IF THERE HAD BEEN    @DERPDGL 19570016
         BO    DERFSTX0              ANY REASON TO MAKE THIS   @DERPDGL 19580016
DERFNRF1 TM    CCBCOM1,OWNUCRT       A RECONLY REQUEST         @DA43585 19590000
         BO    DERFSTX0              FOR SGDSK                 @DERPDGL 19600016
         NI    CCBCOM2,DERUIVAL                                @D51TDPM 19610016
         NI    CCBCOM1,X'FF'-DISERR                            @D51TDPM 19620016
         OI    CCBCOM2,NORCDFND    INDICATE NO RECORD FOUND    @D51TDPM 19630016
DERFSTX0 LM    R0,RE,DERFSTSV                                  @DERPDGL 19640016
         BR    RE                                              @DERPDGL 19650016
DERFSTX4 LM    R0,RE,DERFSTSV                                  @DERPDGL 19660016
         B     4(,RE)                                          @DERPDGL 19670016
DERFSTX8 LM    R0,RE,DERFSTSV                                  @DERPDGL 19680016
         B     8(,RE)                                          @DERPDGL 19690016
         DROP  ,                                               @D66ADAP 19700016
         USING SYSS00,R0                                       @D66ADAP 19710016
         LTORG                                                 @DERPDGL 19720016
DERDCEOC DC    X'002000'                                       @DERPDGL 19730016
DERFSTSV DC    16F'0'                                          @DERPDGL 19740016
*XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX* 19750016
*                                                                     * 19760016
*                        ERP INITIALIZATION                           * 19770016
*                                                                     * 19780016
*XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX* 19790016
*                                                                       19800016
*                                                                       19810016
DER0000  DC    0H'0'              ENTRY POINT                  @D66CDAP 19820016
         BALR  RC,0               LOAD BASE POINTER            @D51TDPM 19830021
         BCTR  RC,0               ADJUST BASE REG              @D51TDPM 19840021
         BCTR  RC,0               TO POINT TO DER0000          @D51TDPM 19850021
         USING DER0000,RC         MAIN ROUTINE ADDRESSABILITY. @D51TDPM 19860016
         B     DER0100            SKIP CONSTANTS               @DERPDJK 19870021
         DC   A(DERGLOB)          DEBUG VECTOR TABLE           @DERPDJK 19880016
         DC   A(DERINWRK)                                      @DERPDJK 19890016
         DC   A(DERT)                                          @DERPDJK 19900016
         DC   A(DERDBGST)                                      @DERPDJK 19910016
DER0100  EQU   *                                               @D14ZDDK 19920016
*                                                              @D51TDPM 19950016
*------------------------------------------------------------* @D51TDPM 19960016
*   IF THERE IS NO ERROR BLOCK ON THE DSK WORK QUEUE, THEN     @D51TDPM 19970016
*   DEACTIVATE THE DSK TASK AND EXIT TO THE DISPATCHER.        @D51TDPM 19980016
*   OTHERWISE DEQUEUE AN ERROR BLOCK FROM THE DSK WORK QUEUE   @D51TDPM 19990016
*   AND PROCESS THE ERROR CONDITION THAT IT REPRESENTS.        @D51TDPM 20000016
*   TO PREVENT A TASK FROM CORRUPTING THE DSK WORK QUEUE DSK   @D51TDPM 20010016
*   MUST NOT LOSE CONTROL WHILE IT IS REMOVING AN ERROR BLOCK  @D51TDPM 20020016
*   FROM ITS WORK QUEUE.                                       @D51TDPM 20030016
*-------------------------------------------------------------*@D51TDPM 20040016
*                                                              @D51TDPM 20050016
&SYSERR  SETC  'SYSERROR'         SET SYSERROR VALUE           @DERPDGL 20060016
.*                                                             @D51TDPM 20070016
         L     R5,AERBLOC         ERBLOC BASE ADDRESS          @D37BDDK 20080021
         USING ERBLOC,R5          ERBLOC BASE POINTER          @D37BDDK 20090021
         L     R2,DSKERCHN        GET DSK CHAIN POINTER        @D37BDDK 20100021
         LTR   R2,R2              ANY ERROR ENQUEUED           @D37BDDK 20110021
         BNZ   DERS1000           YES,                         @D37BDDK 20120021
         L     R6,DISPAD          GET DISP BASE ADDRESS        @D51TDPM 20140021
         USING DISP,R6            DISP BASE POINTER            @D35EDDK 20150021
         SGSETUP UNPOST,STASK=DSK,WR1=R2 DEACTIVATE DSK TASK   @D37BDDK 20160016
         BR    R6                 =========================>>> @D37BDDK 20170016
         DROP  R6                 RELEASE DISP BASE            @D51TDPM 20180021
*                                                                       20190016
*-------------------------------------------------------------*@D51TDPM 20200016
*   CLEAR HIGH ORDER BYTES AND SWITCH TO 31 BIT AMODE          @D51TDPM 20210016
*-------------------------------------------------------------*@D51TDPM 20220016
         USING ERBLKADR,R2        ERROR ENTRY BASE POINTER     @D37BDDK 20221022
DERS1000 DS    0H                                              @DERPDGL 20230016
         LA    RC,0(,RC)          TURN OFF UPPERMOST BYTE      @DERPDGL 20250022
*        AMODESW SET,AMODE=31,WR=(RF) ENTER 31-BIT ADDR. MODE  @D52VDAP 20270016
         AMODESW SET,AMODE=31,WR=(RF) ENTER 31-BIT ADDR. MODE  @D52VDAP 20280016
         L     RA,ADERGLOB        GLOBAL WORK AREA ADDRESS     @DERPDGL 20350022
         USING DERGLOB,RA         DERGLOB BASE POINTER         @DERPDGL 20351022
         LA    RD,DERDERSV        ADDR. OF SAVE AREA-STACK     @D51TDPM 20410022
*-------------------------------------------------------------*@D51TDPM 20430016
*        SET UP THE GLOBAL AREA FOR THIS ERROR                 @D51TDPM 20440022
*-------------------------------------------------------------*@D51TDPM 20450016
         MVC   DSKERCHN,ERBLKPTR  DEQUEUE THE ERROR ENTRY      @DERPDGL 20490022
         DROP  R5                 RELEASE ERBLOC BASE          @DERPDGL 20500022
         XC    DERCLN00(DERCLNL0),DERCLN00  RESET GLOBAL DATA  @DERPDGL 20560022
         XC    DERCLN01(DERCLNL1),DERCLN01  RESET GLOBAL DATA  @DERPDGL 20570022
*-------------------------------------------------------------*@D51TDPM 20660016
*   TELL DEBUG WE ARE DEALING WITH A NEW I/O                   @D51TDPM 20670016
*-------------------------------------------------------------*@D51TDPM 20680016
 SGDSK  'CALL  DERTRACE         ','CALL FOR DEBUG ENTRY',      @DERPDGLX20700016
               NR='0                 DISPLAY SOME SENSE DATA'  @DERPDGL 20710016
*-------------------------------------------------------------*@D51TDPM 20730016
*  FREE THE DEQUEUED ERROR BLOCK IF THE LOCAL ERROR BLOCK      @D51TDPM 20740016
*  IS NOT ACTIVELY BEING USED.                                 @D51TDPM 20750016
*-------------------------------------------------------------*@D51TDPM 20760016
         NI    ERRQFLG,XFF-PASSBK-RTYERR-OPINT-IGNERR RESET    @D61SDJK 20770022
         OI    ERRQFLG,SUCCESS    ASSUME SUCCESSFUL FOR NOW    @DERPDGL 20771022
         MVC   DERINWRK,0(R2)     COPY THE ERROR ENTRY         @D51TDPM 20780022
         ST    R2,DERORGEB        SAVE ITS ADDRESS FOR EXIT    @DERPDGL 20790022
         NI    ERBLKFLG,XFF-ERQUEUED TELL NOT QUEUED ANY MORE  @DERPDGL 20800016
         LA    R2,DERINWRK        POINT TO WORK ERROR ENTRY NOW@DA37004 20820022
         TM    ERRQFLG,RECONLY    RECORDING ONLY REQUEST       @D51TDPM 20890022
         BNO   DER0710            NO,                          @D51TDPM 20900022
         OI    DEROEFL1,DEROEMEL  MINIMAL ERP LAYER.           @D51TDPM 20920022
DER0710  EQU   *                                               @D51TDPM 20930016
         L     R4,ERRQCHQA        CHANQ ADDRESS                @D51TDPM 21000022
         LTR   R4,R4              UNSOLICITED ERROR            @D51TDPM 21010022
         BZ    DER0750            YES,                         @D51TDPM 21020022
         USING CHQADR,R4                                       @D51TDPM 21040016
         SLR   R7,R7              CLEAR REGISTER               @D66CDAP 21050016
         ICM   R7,3,CHQTID        GET TASK-ID                  @D66CDAP 21060016
         AIF   (&VSE260).Y260010                               @D66CDAP 21070016
         SRL   R7,8               TASK-ID IS A SINGLE BYTE     @D66CDAP 21080016
.Y260010 ANOP                                                  @D66CDAP 21090016
         STH   R7,DERTID          SAVE TASK-ID                 @D66CDAP 21100016
         TM    DEROEFL1,DEROEMEL  BRANCH WHEN RECONLY HAD BEEN @D51TDPM 21110016
         BNZ   DER0780              SET ON ENTRY TO SGDSK.     @DA43182 21120016
         MVC   DERIOKEY,CHQCSW    REMEMBER THE STORAGE KEY OF  @DERPDGL 21130016
         NI    DERIOKEY,X'F0'       REQUESTOR (USED BITS ONLY) @DERPDGL 21140016
         TM    CHQPROC,CHQDASFP   FILE PROTECTION REQUIRED     @D51TDPM 21150016
         BNO   DER0800            NO,                          @D51TDPM 21160016
         OI    DERCHQGV,DERCHQFP  FILE PROTECTION PREFIXING.   @D51TDPM 21170016
         B     DER0800                                         @D51TDPM 21190016
DER0750  EQU   *                                               @D51TDPM 21200016
         OI    DEROEFL1,DEROEUIC  UNSOLICITED INTERRUPT.       @D51TDPM 21210016
         B     DER0800                                         @DA43182 21220016
DER0780  DS    0H                                              @DA43182 21230016
*                                                              @DA43182 21240016
*   SINCE ICKDSF ANALYZE CAUSES A LOT OF DATA CHECKS ON TRACKS @DA43182 21250016
*   THAT ARE OF NO INTEREST FOR THE USER, WE LEAVE RECORDING   @DA43182 21260016
*   TO ICKDSF. BUT SINCE WE DO NOT WANT TO DO RECOVERY ANYWAY  @DA43182 21270016
*   WE CAN JUST LEAVE SGDSK TO DSKEXIT.                        @DA43182 21280016
*                                                              @DA43182 21290016
         SLL   R7,2               OFFSET IN ATIBATAB           @D66CDAP 21300016
         AL    R7,ATIBATAB        ADDRESS OF TIB ADDRESS       @D66CDAP 21310016
         L     R7,0(,R7)          TIB BASE ADDRESS             @DA43182 21320016
         L     R7,TIBPCB-TIBADR(,R7) PCB BASE ADDRESS          @DA43182 21330016
         TM    PCBSSFL1-PCBADR(R7),ICKDSF IS THIS ICKDSF       @DA43182 21340016
         BNO   DER0800            NO, IT IS NOT                @DA43182 21350016
         MVI   DEREXITC,DEREXDSP  SET UP EXIT TO DISPATCHER    @DA43182 21360016
         MVC   DERWKCSW,ERRQCSW   SET UP (UNUSED) WORK CSW     @DA43182 21370016
         B     DERFNM90           LEAVE SGDSK CODE             @DA43182 21380016
DER0800  EQU   *                                               @D51TDPM 21390016
*                                                              @D51TDPM 21400016
*-------------------------------------------------------------*@D51TDPM 21410016
*   SET DSK'S SERVICE OWNER TO DSK WHEN IT PROCCESSING AT THE  @D51TDPM 21420016
*   MINIMAL ERP LAYER OR WHEN THE SERVICE OWNER ID IS NOT      @D51TDPM 21430016
*   AVAILABLE.  OTHERWISE SET DSK'S SERVICE OWNER TO THE       @D51TDPM 21440016
*   APPROPRIATE TASK ID.                                       @D51TDPM 21450016
*-------------------------------------------------------------*@D51TDPM 21460016
*                                                              @D51TDPM 21470016
         LA    RF,DSKTID          ASSUME DSK FOR NOW           @D66CDAP 21480016
         TM    DEROEFL1,DEROEUIC+DEROEMEL UNSOLICITED ERROR    @D51TDPM 21490016
         BNZ   DER0805            YES,                         @D66CDAP 21500016
         LH    RF,DERTID          GET THE TID.                 @D66CDAP 21510016
DER0805  EQU   *                                               @D51TDPM 21520016
         SGSETUP SWOWNER,STASK=DSK,WR1=RF,WR2=R7,OPTION=SETOWNER        21530016
*                                                              @D51TDPM 21540016
*-------------------------------------------------------------*@D51TDPM 21550016
*   TRY TO GET A PTR TO USER CCB INTO REGISTER RB.             @D51TDPM 21560016
*   IF  THE USER CCB IS NOT ACCESSIBLE HEREAFTER,              @D51TDPM 21570016
*   DEROEFL1,DEROEUCU IS ONE.                                  @D51TDPM 21580016
*-------------------------------------------------------------*@D51TDPM 21590016
*                                                              @D51TDPM 21600016
 SGDSK  'CALL  DERUCCB         ','GET USER CCB PTR ',          @DERPDGLX21610016
               I='2                 ON RETURN',                @DERPDGLX21620016
               O='B                 RB=PTR TO USER CCB'        @DERPDGL 21630016
         USING UCCBADR,RB         TAKE AS CCBPTR, IF ACCESSIBLE@D51TDPM 21640016
*                                                              @D51TDPM 21650016
*-------------------------------------------------------------*@D51TDPM 21660016
*   GET ADDRESSABILITY TO THE PUB AND IF RECOVERY IS POSSIBLE  @D51TDPM 21670016
*   THEN GENERATE A SET FILE MASK CCW APPROPRIATE FOR THE      @D51TDPM 21680016
*   DEVICE.                                                    @D51TDPM 21690016
*-------------------------------------------------------------*@D51TDPM 21700016
*                                                              @D51TDPM 21710016
         SLR   R3,R3              GET THE ADDRESS OF THE...    @D51TDPM 21720016
         ICM   R3,B'0011',ERRQPUB   PUB DEVICE ENTRY.          @D51TDPM 21730016
         BNZ   DER0810                                         @DERPDGL 21740016
         BAL   R5,&SYSERR                                      @DERPDGL 21750016
DER0810  DS    0H                                              @DERPDGL 21760016
         USING PUBADR,R3          PUB BASE ADDRESS             @D14CTJF 21770016
*                                                              @D51TDPM 21780016
*-------------------------------------------------------------*@D51TDPM 21790016
*   SET UP THE CCB THAT THE DSK TASK USES TO REQUEST I/O.      @D51TDPM 21800016
*-------------------------------------------------------------*@D51TDPM 21810016
*                                                              @D51TDPM 21820016
         LA    R1,DERCCB                                       @D51TDPM 21830016
         USING CCBADR,R1                                       @D51TDPM 21840016
         NI    CCBCOM1,XFF-TRABIT INDICATE: I/O NOT COMPLETE   @DERPDGL 21850016
         XC    CCBCSWW,CCBCSWW    PURGE CSW CCW ADDRESS        @DERPDGL 21860016
         XC    CCBSTA,CCBSTA      PURGE STATUS BYTES           @DERPDGL 21870016
         XC    CCBCNT,CCBCNT      PURGE RESIDUAL COUNT         @DERPDGL 21880016
         LTR   R4,R4              CHANQ. ENTRY PRESENT         @DERPDGL 21890016
         BZ    DER0900            BRANCH IF NOT                @DERPDGL 21900016
         MVC   CCBCSWW,CHQCSW+1   COPY USERS CSWCCW ADDRESS    @D37ADDK 21910016
         MVC   CCBSTA,CHQCSW+4    COPY USERS STATUS BYTES      @D37ADDK 21920016
         MVC   CCBCNT,CHQCSW+6    COPY USERS RESIDUAL COUNT    @D37ADDK 21930016
DER0900  LR    R5,R3              CALCULATE A 10 BIT...        @D14ZDDK 21940016
         SH    R5,YPUBTAB           PUB ENTRY NUMBER...        @D35SDDK 21950016
         SRL   R5,3                 AND STORE...               @D35SDDK 21960016
         STC   R5,CCBLNO            STORE...                   @D51TDPM 21970016
         NI    CCBCLS,X'FC'         IT                         @DERPDGL 21980016
         O     R5,CCBCLS-2          INTO                       @DERPDGL 21990016
         STH   R5,CCBCLS            CCBCLS/CCBLNO              @D51TDPM 22000016
         XC    CCBCCW+1(3),CCBCCW+1 CLEAR CHANNEL PROGRAM.     @D51TDPM 22010016
         TM    DEROEFL1,DEROEUCU  BRANCH IF THE USER CCB       @DERPDGL 22020016
         BO    DER0950              IS NOT ADDRESSABLE         @DERPDGL 22030016
         MVC   CCBCCW+1(3),UCCBCCW+1 TAKE USERS CHANNEL PROG.  @D51TDPM 22050016
DER0950  EQU   *                                               @D51TDPM 22060016
         MVI   CCBCCW,X'00'       TELL, NO PATH SELECTED AS YET@DERPDGL 22070016
*                                                              @D51TDPM 22080016
*-------------------------------------------------------------*@D51TDPM 22090016
*   IF THE SENSE OPERATION FAILED THEN SET AN UNSUCCESSFUL     @D51TDPM 22100016
*   RETURN CODE.                                               @D51TDPM 22110016
*-------------------------------------------------------------*@D51TDPM 22120016
*                                                              @D51TDPM 22130016
         CLI   ERRQMSG,RCVMSG     BRANCH WHEN THE SENSE DATA...@D51TDPM 22140016
         BNE   DER11000             IS VALID.                  @D51TDPM 22150016
 SGDSK  'CALL  DERTRACE         ','CALL FOR DEBUG ENTRY',      @DERPDGLX22170016
               NR='1                 DISPLAY SOME SENSE DATA'  @DERPDGL 22180016
         OI    DEROEFL1,DEROESIV  REMEMBER THAT THE SENSE...   @D51TDPM 22190016
         LA    RF,DERECSNS          DATA WAS...                @D51TDPM 22200016
         STC   RF,DERCRSC           INVALID.                   @D51TDPM 22210016
         MVI   DERRCVC,DERRVUAC   UNSUCCESSFUL AND COMPLETE.   @D51TDPM 22220016
         B     DER9000                                         @D51TDPM 22230016
*                                                              @D51TDPM 22240016
***************************************************************@D51TDPM 22250016
*   THE SENSE OPERATION WAS SUCCESSFUL;  START A LOOP AND      @D51TDPM 22260016
*   PROCESS THE ERROR CONDITION.                               @D51TDPM 22270016
***************************************************************@D51TDPM 22280016
*-------------------------------------------------------------*@DERPDGL 22290016
*   SET UP THE ERRQCSW FOR MESSAGING AND RECORDING.            @DERPDGL 22300016
.*  WE WILL TAKE THE DERWKCSW FROM THE DERCCB VALUES WHEN WE   @DERPDGL 22310016
.*  LEAVE, UNLESS WE GAVE UP WITHOUT EVEN HAVING DONE A RETRY. @DERPDGL 22320016
.*  IN THIS CASE WE WOULD SUPPLY THE ACCUMULATED CSW FROM THE  @DERPDGL 22330016
.*  CHANNEL QUEUE ENTRY. (SEE EXPLANATION OF CSW SETTING IN    @DERPDGL 22340016
.*  HEADER)                                                    @DERPDGL 22350016
*-------------------------------------------------------------*@DERPDGL 22360016
*                                                              @DERPDGL 22370016
DER10000 DS    0H                                              @D51TDPM 22380016
         OI    DERFLG1,DERCVCSW     TELL ERRQCSW UPDATED       @DERPDGL 22390016
         MVC   ERRQCSW+1(3),CCBCSWW                            @DERPDGL 22400016
         MVC   ERRQCSW+4(2),CCBSTA                             @DERPDGL 22410016
         MVC   ERRQCSW+6(2),CCBCNT                             @DERPDGL 22420016
         TM    DERFLG1,DERCVNUC   BRANCH IF SOME NON UNIT CHECK@DERPDGL 22430016
         BO    DER9000              IO FAILURE ENDED RECOVERY  @DERPDGL 22440016
*-------------------------------------------------------------*@DERPDGL 22450016
*   WRITE A TRACE ENTRY T SHOW SENSE DATA AND OTHERS.          @DERPDGL 22460016
*-------------------------------------------------------------*@DERPDGL 22470016
*                                                              @DERPDGL 22480016
DER11000 DS    0H                                              @D51TDPM 22490016
 SGDSK  'CALL  DERTRACE         ','CALL FOR DEBUG ENTRY',      @DERPDGLX22500016
               NR='2                 DISPLAY SOME SENSE DATA'  @DERPDGL 22510016
*                                                              @DERPDGL 22520016
*-------------------------------------------------------------*@DERPDGL 22530016
*   REINITIALIZE THE RECOVERY ATTRIBUTES WE HAD FROM PREV.LOOP @DERPDGL 22540016
*-------------------------------------------------------------*@DERPDGL 22550016
*                                                              @DERPDGL 22560016
         XC    DERCRRA1(DERRATBL),DERCRRA1   CLEAR ATTRIBUTES  @D51TDPM 22570016
*                                                              @DERPDGL 22580016
*-------------------------------------------------------------*@DERPDGL 22590016
*   FIND OUT WHAT KIND OF SENSE DATA IS GIVEN AND EVALUATE     @DERPDGL 22600016
.*  DERFAST IS ALSO CALLED BY SNS TASK AND DOES NOT HAVE       @DERPDGL 22610016
.*  REGISTER RA LOADED WITH DERGLOB NOR DOES IT STICK TO A     @DERPDGL 22620016
.*  STACKING CONVENTION.                                       @DERPDGL 22630016
*-------------------------------------------------------------*@DERPDGL 22640016
*                                                              @DERPDGL 22650016
DER12000 L     RF,=A(DERFAST)      GO, ANALYZE SENSE INFO      @DERPDGL 22660016
*                                  INPUT IS R2,RE AND RF       @DERPDGL 22670016
         BALR  RE,RF                                           @DERPDGL 22680016
DER12100 NOP   0                   RETURN: SHORTCUT            @DA42840 22690016
         NOP   0                   RETURN: LOST PATH GROUP     @DERPDGL 22700016
*                                                              @DERPDGL 22710016
         STCM  RF,8,DERCRRA4       STORE RECOVERY ATTRIBUTE 4  @DERPDGL 22720016
         STCM  RF,4,DERCRRA3       STORE RECOVERY ATTRIBUTE 3  @DERPDGL 22730016
         STCM  RF,2,DERCRSF        STORE TYPE OF SENSE         @DERPDGL 22740016
         STC   RF,DERCRSC          STORE ERROR CLASSIFICATION  @DERPDGL 22750016
*                                                              @DERPDGL 22760016
*-------------------------------------------------------------*@DERPDGL 22770016
*   OBTAIN THE FAILING CCW FROM THE CSW.                       @DERPDGL 22780016
*-------------------------------------------------------------*@DERPDGL 22790016
*                                                              @DERPDGL 22800016
 SGDSK  'CALL  DERGFCCW        ','SUPPLY FAILING CCW ADDR',    @DERPDGLX22810016
               I='1,2,3             ON RETURN',                @DERPDGLX22820016
               O='NONE              VALUES ARE SET'            @DERPDGL 22830016
*                                                              @DERPDGL 22840016
*-------------------------------------------------------------*@DERPDGL 22850016
*   FOR BASIC SENSE SOME ERROR CLASSIFICATION NEEDS TO BE      @DERPDGL 22860016
*   MODIFIED DEPENDING ON THE OPCODE OF THE FAILING CCW        @DERPDGL 22870016
*   AND WE HAVE TO COLLECT SOME CHARACTERISTICS OF THE DEVICE. @DERPDGL 22880016
*-------------------------------------------------------------*@DERPDGL 22890016
*                                                              @DERPDGL 22900016
         TM    DERCRSF,DERCRSFB                                @DERPDGL 22910016
         BNO   DER13000                                        @DERPDGL 22920016
*                                                              @D51TDPM 22930016
*  TRY TO FIND THE DEVICE IN DERDTADR AND REMEMBER SOME VALUES @D51TDPM 22940016
*                                                              @D51TDPM 22950016
         L     R5,=A(DERDEV)      DEVICE TABLE ADDRESS.        @D37ADDK 22960016
         USING DERDTADR,R5                                     @D51TDPM 22970016
         L     R7,=A(DERDEVE)     ADDRESS OF LAST DEVICE ENTRY.@D51TDPM 22980016
         LA    R6,DERDTLEN        LENGTH OF DEVICE TABLE ENTRY.@D51TDPM 22990016
DER12310 EQU   *                                               @D14ADDK 23000016
         CLC   DERDTPUB,PUBDEVTY  BRANCH WHEN ENTRY DOES NOT...@D37ADDK 23010016
         BNE   DER12320             MATCH.                     @D51TDPM 23020016
         MVC   DERCRMXT(5),DERDTMXT MOVE THAT DERDTADR ENTRY   @D51TDPM 23030016
         B     DER12330           BRANCH TO CONTINUE           @DERPDGL 23050016
DER12320 BXLE  R5,R6,DER12310     BRANCH WHEN NOT END OF TABLE.@D51TDPM 23060016
*                                                              @D51TDPM 23070016
*   IF DEVICE IS UNKNOWN, RECOVERY ERROR IS ALREADY INDICATED  @D51TDPM 23080016
*                                                              @D51TDPM 23090016
DER12330 DS    0H                                              @DERPDGL 23100016
*                                                              @DERPDGL 23110016
*-------------------------------------------------------------*@DERPDGL 23120016
*   MODIFY SOME ERROR CLASSIFICATION, DEPENDING ON THE KIND OF @DERPDGL 23130016
*   FAILING CCW WE HAD. (ONLY IN CASE OF BASIC OR COMPAT.SNS)  @DERPDGL 23140016
*                                                              @DERPDGL 23150016
*   FOR THE INVALID TRACK FORMAT INDICATION FROM SOME BASIC    @DERPDGL 23160016
*   SENSE, SEE IF IT WAS FOR READ OR WRITE.                    @DERPDGL 23170016
*-------------------------------------------------------------*@DERPDGL 23180016
*                                                              @DERPDGL 23190016
         CLI   DERCRSC,DERECITF   BRANCH WHEN NOT GENERIC      @D51TDPM 23200016
         BNE   DER12430             INVALID TRACK FORMAT ERROR @D61ADJK 23210016
*??????  THE FOLLOWING LOGIC ACCEPTS SEARCH COMMANDS AS        @DERPDGL 23220016
*        WRITE COMMANDS. THIS INHIBITS RETRIES FOR THEM .      @DERPDGL 23230016
         MVI   DERCRSC,DERECITR   ASSUME ITF FOR READ          @D52WSBH 23240016
         TM    DERCRFCO,X'01'     BRANCH IF CAN NOT BE READ    @DERPDGL 23250016
         BO    DER12410             OPCODE                     @DERPDGL 23260016
         TM    DERCRFCO,X'02'     BRANCH IF MUST BE READ       @DERPDGL 23270016
         BO    DER12430             OPCODE                     @DERPDGL 23280016
DER12410 MVI   DERCRSC,DERECITW   INVALID TRACK FORMAT - WRITE @D52WSBH 23290016
         AGO   .NOSUP29                                        @D61ADJK 23310016
         B     DER12430                                        @D51TDPM 23320016
DER12412 DS    0H                                              @D51TDPM 23330016
*                                                              @D51TDPM 23340016
*   CHANGE FILE PROTECT OVERFLOW ON LAST TRACK OF CYLINDER TO  @D51TDPM 23350016
*   FILE PROTECT OVERFLOW / END OF CYLINDER                    @D51TDPM 23360016
.*  THIS ERROR OCCURS, IF THE FILE MASK OF A SET FILE MASK     @DERPDGL 23370016
.*  COMMAND INDICATES THAT HEAD SWITCHING IS FORBIDDEN AND     @DERPDGL 23380016
.*  THERE IS AN OVERFLOW RECORD THAT WOULD DO AN IMPLICIT      @DERPDGL 23390016
.*  HEAD SWITCHING FOR A READ OPERATION. (SEE EXPLANATION      @DERPDGL 23400016
.*  OF OVERFLOW RECORDS ON 3350 IN 3880 MANUAL). IN THIS CASE  @DERPDGL 23410016
.*  WE SHOULD NORMALLY CONTINUE THE OPERATION ON THE REST OF   @DERPDGL 23420016
.*  THE OVERFLOW RECORD AND THUS ELIMINATE THE EFFECT OF THE   @DERPDGL 23430016
.*  SET FILE MASK. BUT HOWEVER, IF THE OVERFLOW RECORD         @DERPDGL 23440016
.*  CONTINUES ON THE NEXT CYLINDER, WE SIGNAL END OF           @DERPDGL 23450016
.*  CYLINDER INSTEAD.                                          @DERPDGL 23460016
*                                                              @D51TDPM 23470016
         CLI   DERCRSC,DERECFPO     BRANCH WHEN NOT FILE...    @D51TDPM 23480016
         BNE   DER12430               PROTECTED OVERFLOW.      @D51TDPM 23490016
 SGDSK  'CALL  DERLSTSK          ','SETUP LST USED SEEK ADDR', @DERPDGLX23500016
               I='1,3                 ON RETURN',              @DERPDGLX23510016
               O='NONE                ADDR IS IN DERLSEEK',    @DERPDGLX23520016
               E0='DER12430           ERROR: NOT POSSIBLE'     @DERPDGL 23530016
         CLC   DERCRMXT,DERSKHD+1   BRANCH WHEN NOT ON...      @D51TDPM 23540016
         BNE   DER12430               LAST TRACK OF CYL.       @D51TDPM 23550016
         MVI   DERCRSC,DERECFPE     MAKE FILE PROT. EOCYL      @D51TDPM 23560016
         B     DER12430                                        @D51TDPM 23580016
.NOSUP29 ANOP                                                  @D61ADJK 23590016
DER12430 DS    0H                                              @DERPDGL 23600016
*-------------------------------------------------------------*@DERPDGL 23610016
*   SEE, IF THE ERROR HAS CHANGED TO A DIFFERENT TYPE SINCE    @DERPDGL 23620016
*   THE LAST RETRY (OR IF WE HAD NO RETRY AS YET)              @DERPDGL 23630016
*-------------------------------------------------------------*@DERPDGL 23640016
*                                                              @DERPDGL 23650016
DER13000 TM    DERCRSF,DERCRSFE                                @DERPDGL 23660016
         BNO   DER13100                                        @DERPDGL 23670016
         MVC   DERDERSV(4),ERRQSNS+22                          @DERPDGL 23680016
         MVC   DERDERSV+4(3),CCBCSWW                           @DERPDGL 23690016
         CLC   DERLSTER,DERDERSV   BRANCH IF THE ERROR LOOKS   @DERPDGL 23700016
         BE    DER13999              SIMILAR TO THE ONE WE HAD @DERPDGL 23710016
         MVC   DERLSTER,DERDERSV   SET IT AS NEW LAST ERROR    @DERPDGL 23730016
         B     DER13200                                        @DERPDGL 23740016
*                                                              @DERPDGL 23750016
DER13100 MVC   DERDERSV(3),ERRQSNS+0                           @DERPDGL 23760016
         MVC   DERDERSV+3(1),ERRQSNS+7                         @DERPDGL 23770016
         MVC   DERDERSV+4(3),CCBCSWW                           @DERPDGL 23780016
         CLC   DERLSTER,DERDERSV   BRANCH IF THE ERROR LOOKS   @DERPDGL 23790016
         BE    DER13999              SIMILAR TO THE ONE WE HAD @DERPDGL 23800016
         MVC   DERLSTER,DERDERSV   SET THIS AS NEW LAST ERROR  @DERPDGL 23810016
*                                                              @DERPDGL 23830016
DER13200 DS    0H                                              @DERPDGL 23840016
         XC    DERTYCNT,DERTYCNT   PURGE RETRY COUNT           @DERPDGL 23850016
         MVI   DERCRPTU,X'00'      MAKE ALL PATHS AVAILABLE    @DERPDGL 23860016
*                                                              @DERPDGL 23870016
DER13999 DS    0H                                              @DERPDGL 23880016
*-------------------------------------------------------------*@DERPDGL 23890016
*   NOW, THAT WE FOUND OUT ABOUT WHAT ERROR IT IS, LET US      @DERPDGL 23900016
*   DEFINE THE RECOVERY, MESSAGING AND RECORDING NEEDS OF IT.  @DERPDGL 23910016
*-------------------------------------------------------------*@DERPDGL 23920016
*                                                              @DERPDGL 23930016
*   FIRST THE INFORMATION IS TAKEN FROM THE RECOVERY TABLE.    @DERPDGL 23940016
*                                                              @DERPDGL 23950016
DER14000 SLR   R5,R5              CONVERT THE...               @DERPDGL 23960016
         IC    R5,DERCRSC           CLASSIFICATION...          @DERPDGL 23970016
         BCTR  R5,0                 CODE INTO AN...            @DERPDGL 23980016
         MH    R5,=AL2(DERRATBL)    INDEX.                     @DERPDGL 23990016
         A     R5,=A(DERRATB)     ACCESS ATTRIBUTE TABLE       @DERPDGL 24000016
         OC    DERCRRA1(DERRATBL),0(R5)  SET THE ATTRIBUTES    @DERPDGL 24010016
*                                                              @DERPDGL 24020016
*   FOR ECKD SENSE LOOK AT THE PRESCRIPTION IN BYTES 24/25     @DERPDGL 24030016
*                                                              @DERPDGL 24040016
         TM    DERCRSF,DERCRSFE   BRANCH IF SENSE NOT IN ECKD  @DERPDGL 24050016
         BNO   DER15000             FORMAT                     @DERPDGL 24060016
         TM    ERRQSNS+25,X'80'   BRANCH IF NOT A COMPOUND     @DERPDGL 24080016
         BNO   DER14300             ACTION CODE                @DERPDGL 24090016
*                                                              @DERPDGL 24100016
.*    HANDLE A COMPOUND ACTION CODE                            @DERPDGL 24110016
.*                                                             @DERPDGL 24120016
         MVI   DERCRRAS,DERASSMP SIMPLE RETRY AS SUBROUTINE    @DERPDGL 24130016
*                                                              @DERPDGL 24140016
         TM    ERRQSNS+25,X'40'   BRANCH IF BYTE 26 HAS NO     @DERPDGL 24150016
         BNO   DER14100             CONFIGURATION DATA IN IT   @DERPDGL 24160016
         TM    ERRQSNS+26,X'20'   BRANCH IF ERROR WAS NOT ON   @DERPDGL 24170016
         BNO   DER14100             A PRIMARY OF A DUPLEX PAIR @DERPDGL 24180016
         OI    DERCRRA2,DERRA2BD  ALLOW TO BREAK DUPLEX PAIR   @DERPDGL 24200016
*                                                              @DERPDGL 24210016
DER14100 TM    ERRQSNS+25,X'20'   BRANCH IF NO VALID MESSAGE   @DERPDGL 24220016
         BNO   DER14200             IN SENSE BYTE 28           @DERPDGL 24230016
         CLI   ERRQSNS+28,X'17'   BRANCH IF MESSAGE IS NOT     @DERPDGL 24240016
         BNE   DER14200             WRITE INHIBIT CONTROLLER   @DERPDGL 24250016
         OI    DERCRRA2,DERRA2DU  ALLOW WRITE INHIBIT CONTROL. @DERPDGL 24270016
*                                                              @DERPDGL 24280016
DER14200 MVC   DERDERSV(1),ERRQSNS+25  RETRY LIMIT INDICATION  @DERPDGL 24290016
         NI    DERDERSV,X'03'       FROM PROGRAM ACTION CODE   @DERPDGL 24300016
         CLI   DERDERSV,0                                      @DERPDGL 24310016
         BE    DER14220           BRANCH IF ITS ZERO           @DERPDGL 24320016
         CLI   DERDERSV,1                                      @DERPDGL 24330016
         BE    DER14240           BRANCH IF ITS ONE            @DERPDGL 24340016
         CLI   DERDERSV,2                                      @DERPDGL 24350016
         BE    DER14250           BRANCH IF ITS TWO            @DERPDGL 24360016
         MVI   DERCRRL,X'FF'      TAKE THE LIMITS AS           @DERPDGL 24370016
         B     DER14260             DESCRIBED IN THE MANUAL    @DERPDGL 24380016
DER14220 MVI   DERCRRL,X'00'                                   @DERPDGL 24390016
         B     DER14260                                        @DERPDGL 24400016
DER14240 MVI   DERCRRL,X'02'                                   @DERPDGL 24410016
         B     DER14260                                        @DERPDGL 24420016
DER14250 MVI   DERCRRL,X'0A'                                   @DERPDGL 24430016
*                                                              @DERPDGL 24440016
DER14260 TM    ERRQSNS+25,X'10'   TEST THE ALTHERNATE PATH     @DERPDGL 24450016
         BO    DER14400             RETRY INDICATION           @DERPDGL 24460016
         OI    DERCRRA2,DERRA2NS  NO PATH SWITCHING PERMITTED  @DERPDGL 24470016
*                                                              @DERPDGL 24490016
*   DEAL WITH SOME SPECIAL CASES, IN WHICH ECKD INDICATED AN   @DERPDGL 24500016
*   UNCONDITIONAL SURRENDER, BUT WE OVERRULE THIS DECISION.    @DERPDGL 24510016
.*  WE WOULD NOT WANT TO CANCEL A NO RECORD FOUND CONDITION    @DERPDGL 24520016
.*  IF THE USER HAD TOLD US TO ACCEPT IT. THIS LOGIC ALSO      @DERPDGL 24530016
.*  COULD HAVE BEEN IMBEDED IN THE EXIT CODE DETERMINATION     @DERPDGL 24540016
.*  AFTER THE RECOVERY LOOP. BUT I DID IT HERE, SINCE THEN     @DERPDGL 24550016
.*  THE EXIT FROM THE LOOP HAS THE SAME RECOVERY RETURN CODE   @DERPDGL 24560016
.*  FOR OLD AND NEW DEVICES.                                   @DERPDGL 24570016
*                                                              @DERPDGL 24580016
DER14300 CLI   DERCRSC,DERSIPPE                                @DERPDGL 24590016
         BNE   DER14400                                        @DERPDGL 24600016
         TM    DERCRRA3,DERRA3NR    BRANCH IF NOT              @DERPDGL 24610016
         BNO   DER14310               NO RECORD FOUND ERROR    @DERPDGL 24620016
         TM    DEROEFL1,DEROEUCU    BRANCH IF THE USER CCB     @D61SDJK 24630000
         BO    DER14390               IS NOT ADDRESSABLE       @D61SDJK 24640000
         TM    UCCBCOM2,NRFRETRY    BRANCH WHEN USER WANTS NO  @DERPDGL 24650016
         BNO   DER14390               RETRY OF NRF.            @DERPDGL 24660016
DER14310 DS    0H                                              @DERPDGL 24670016
         TM    DERCRRA3,DERRA3EO    BRANCH IF NO END OF CYL.   @DERPDGL 24680016
         BNO   DER14400               CONDITION                @DERPDGL 24690016
DER14390 MVI   DERCRRA2,DERRA2SR                               @DERPDGL 24700016
*                                                              @DERPDGL 24720016
DER14400 TM    DERCRRA3,DERRA3TW    BRANCH IF INVALID TRACK    @DERPDGL 24730016
         BO    DER14415               FORMAT WRITE             @DA43898 24740000
         TM    ERRQSNS+24,B'00000001'                          @DERPDGL 24750016
         BNO   DER14410                                        @DERPDGL 24760016
         TM    ERRQSNS+24,B'00000010'                          @DERPDGL 24770016
         BNO   DER14420                                        @DERPDGL 24780016
         OI    DERCRRA1,DERRA1AM          MESSAGE IF PERSISTENT@DERPDGL 24790016
         B     DER14500                                        @DERPDGL 24810016
DER14410 TM    ERRQSNS+24,B'00000010'                          @DERPDGL 24820016
         BNO   DER14500                                        @DERPDGL 24830016
         OI    DERCRRA1,DERRA1OM          MESSAGE ONCE         @DERPDGL 24840016
         B     DER14500                                        @DERPDGL 24860016
DER14415 NI    DERCRRA1,XFF-DERRA1XM  SWITCH OFF MESSAGING     @DA43898 24870000
         TM    DEROEFL1,DEROEUCU    BRANCH IF THE USER CCB     @DA43898 24880000
         BO    DER14420               IS NOT ADDRESSABLE       @DA43898 24890000
         TM    UCCBBY3,ITWPASSB     BRANCH IF INV. TRACK FMT.  @DA43898 24900000
         BO    DER14500             WRITE SHALL BE REPORTED    @DA43898 24910000
DER14420 OI    DERCRRA1,DERRA1IM          MESSAGE ALWAYS       @DERPDGL 24920016
*                                                              @DERPDGL 24940016
DER14500 TM    ERRQSNS+24,B'00000100'                          @DERPDGL 24950016
         BNO   DER14510                                        @DERPDGL 24960016
         TM    ERRQSNS+24,B'00001000'                          @DERPDGL 24970016
         BNO   DER14520                                        @DERPDGL 24980016
         OI    DERCRRA1,DERRA1AR          RECORD IF PERSISTENT @DERPDGL 24990016
         B     DER17000                                        @DERPDGL 25010016
DER14510 TM    ERRQSNS+24,B'00001000'                          @DERPDGL 25020016
         BNO   DER17000                                        @DERPDGL 25030016
         OI    DERCRRA1,DERRA1OR          RECORD ONLY ONCE     @DERPDGL 25040016
         B     DER17000                                        @DERPDGL 25060016
DER14520 OI    DERCRRA1,DERRA1IR          RECORD UNCONDITIONAL @DERPDGL 25070016
         B     DER17000                                        @DERPDGL 25090016
*                                                              @DERPDGL 25100016
DER15000 CLI   DERCRSC,DERECITW     BRANCH IF NOT INVALID      @DA43898 25110000
         BNE   DER15005               TRACK FORMAT WRITE       @DA43898 25120000
         TM    DEROEFL1,DEROEUCU    BRANCH IF THE USER CCB     @DA43898 25130000
         BO    DER15005               IS NOT ADDRESSABLE       @DA43898 25140000
         TM    UCCBBY3,ITWPASSB     BRANCH IF INV. TRACK FMT.  @DA43898 25150000
         BNO   DER15005             WRITE SHALL NOT BE REPORTED@DA43898 25160000
         NI    DERCRRA1,XFF-DERRA1XM  SWITCH OFF MESSAGING     @DA43898 25170000
DER15005 TM    ERRQSNS+7,B'01100000'  BRANCH IF THE FORMAT     @DA43898 25180000
         BNO   DER15010                 IS                     @DERPDGL 25190016
         TM    ERRQSNS+7,B'10010000'    NOT                    @DERPDGL 25200016
         BNZ   DER15010                 FORMAT 6               @DERPDGL 25210016
         OI    DERCRRA4,DERRA4NS      IND. SEEK IN SNS INVALID @DERPDGL 25220016
*                                                              @DERPDGL 25240016
DER15010 TM    DERCRSF,DERCRSFC   BRANCH IF SENSE NOT IN       @DERPDGL 25250016
         BNO   DER16000             24+8 COMPATIBILITY FORMAT  @DERPDGL 25260016
*                                                              @DA42853 25270016
*     EREP WILL GIVE STRANGE MESSAGES IF UNIT CHECKS           @DA42853 25280016
*     ARE RECORDED THAT HAVE THE FOLLOWING CONDITIONS:         @DA42853 25290016
*     TAKEN FROM GA32-0099-05 PAGE 241                         @DA42853 25300016
*                                                              @DA42853 25310016
         CLI   DERCRSC,DERECPWI       PATH WRITE INHIBIT       @DA42853 25320016
         BE    DER15013               BRANCH IF YES            @DA42853 25330016
         CLI   DERCRSC,DERECLLE       LAST LOGGED ERROR        @DA42853 25340016
         BE    DER15011               BRANCH IF YES            @DA42853 25350016
         CLI   DERCRSC,DERECFLE       FORCED LOGGING EVENT     @DA42853 25360016
         BE    DER15011               BRANCH IF YES            @DA42853 25370016
         CLI   DERCRSC,DERECECC       SIMP.EQ.CK IN COMP.SNS   @DA42853 25380016
         BE    DER15011               BRANCH IF YES            @DA42853 25390016
         CLI   DERCRSC,DERECB         BUSOUT PARITY CHECK      @DA42853 25400016
         BE    DER15011               BRANCH IF YES            @DA42853 25410016
         CLI   DERCRSC,DERECEEC       EQCK AND ENV.DATA        @DA42853 25420016
         BE    DER15011               BRANCH IF YES            @DA42853 25430016
         CLI   DERCRSC,DERECSSN       SUBSYS.STOR.NOTIFICATION @DA42853 25440016
         BE    DER15011               BRANCH IF YES            @DA42853 25450016
         CLI   DERCRSC,DERECBOC       OVERRUN                  @DA42853 25460016
         BNE   DER15020               BRANCH IF NO             @DA42853 25470016
DER15011 CLI   ERRQSNS+7,X'04'        DO LOG IT IF FORMAT      @DA42853 25480016
         BNE   DER15012               *  0 MESSAGE 4 AND       @DA42853 25490016
         TM    ERRQSNS+1,MESSAGE      *  MESSAGE TO OP. ON.    @DA42853 25500016
         BO    DER15020               *                        @DA42853 25510016
DER15012 TM    ERRQSNS+7,X'F0'        DO NOT LOG IT IF         @DA42853 25520016
         BM    DER15020               *  ANY OTHER FORMAT 0    @DA42853 25530016
         BO    DER15014               *                        @DA42853 25540016
DER15013 NI    DERCRRA1,XFF-DERRA1XR  *                        @DA42853 25550016
         B     DER15020               *                        @DA42853 25560016
DER15014 CLI   ERRQSNS+7,X'F0'        *  OR IF FORMAT F AND    @DA42853 25570016
         BE    DER15013               *  MESSAGE TO OP. ON     @DA42853 25580016
         TM    ERRQSNS+1,MESSAGE      *  OR MESSAGE 0          @DA42853 25590016
         BO    DER15013               *                        @DA42853 25600016
DER15020 DS    0H                                              @DA42853 25610016
.*    IT COULD BE, THAT BREAKING A DUPLEX PAIR IS ALLOWED NOW. @DERPDGL 25620016
.*    WE SHOULD ONLY DO THIS, IF BYTE 25 INDICATES, THAT AN    @DERPDGL 25630016
.*    ERROR OCCURED ON A DUPLEX PAIR.                          @DERPDGL 25640016
.*                                                             @DERPDGL 25650016
         TM    ERRQSNS+25,X'C0'   IF NOT COMPOUND PAC AND      @DERPDGL 25660016
         BO    DER15100             SOMETHING ON DUPLEX PAIR   @DERPDGL 25670016
         NI    DERCRRA2,XFF-DERRA2BD  DO NOT ALLOW BREAKING    @DERPDGL 25680016
*                                                              @DERPDGL 25700016
.*    IF STATE CHANGE PENDING, DO ONLY THE MESSAGING AND RE-   @DERPDGL 25710016
.*    CORDING THAT WAS PRESCRIBED FOR THE ERROR CONDITION      @DERPDGL 25720016
.*    WE FOUND IN THE SENSE. BYTE 24 HAS NO MEANING IN 24+8    @DERPDGL 25730016
.*    SENSE. HENCE THE TABLE BITS FOR RECORD. AND MESSAGING    @DERPDGL 25740016
.*    ARE VALID.                                               @DERPDGL 25750016
.*                                                             @DERPDGL 25760016
DER15100 CLI   ERRQSNS+25,X'1D'   BRANCH IF NOT STATE CHANGE   @DERPDGL 25770016
         BNE   DER17000             PENDING INDICATION         @DERPDGL 25780016
         NI    DERCRRA1,DERRA1OM+DERRA1OR+DERRA1IR+DERRA1IM    @DERPDGL 25790016
         OI    DERCRRA2,DERRA2US    SET CODE FOR NO RECOVERY   @DERPDGL 25800016
         OI    DERCRRA3,DERRA3SC    SET CODE FOR DELAYED RETRY @DERPDGL 25810016
         B     DER17000                                        @DERPDGL 25830016
*                                                              @DERPDGL 25840016
DER16000 TM    DERCRSF,DERCRSFB   BRANCH IF ITS NOT BASIC      @DERPDGL 25850016
         BNO   DER17000             SENSE DATA (NO 24+8)       @DERPDGL 25860016
*                                                              @DERPDGL 25870016
         TM    ERRQSNS+7,B'00110000'  BRANCH IF THE FORMAT     @DERPDGL 25880016
         BNO   DER16100                 IS                     @DERPDGL 25890016
         TM    ERRQSNS+7,B'11000000'    NOT                    @DERPDGL 25900016
         BNZ   DER16100                 FORMAT 3               @DERPDGL 25910016
         OI    DERCRRA4,DERRA4NS      IND. SEEK IN SNS INVALID @DERPDGL 25920016
*                                                              @DERPDGL 25940016
DER16100 TM    ERRQSNS+1,B'10000000'  BRANCH WHEN PERMANENT... @D51TDPM 25950016
         BNO   DER16300                 ERROR BIT NOT SET      @DA42840 25960016
         CLI   DERCRSC,DERECLO        BRANCH WHEN THE ERROR    @D51TDPM 25970016
         BE    DER17000                 WAS LOG ONLY           @D51TDPM 25980016
         OI    DERCRRA2,DERRA2US      SET UNCOND. SURRENDER    @DERPDGL 26000016
         AGO   .NOSUP38                                        @D61ADJK 26010016
         CLI   DERCRSC,DERECD10       BRANCH WHEN THE ERROR    @DA42853 26020016
         BE    DER16200                 WAS A DATA CHECK 10    @DA42853 26030016
.NOSUP38 ANOP                                                  @D61ADJK 26040016
         CLI   DERCRSC,DERECD11       BRANCH WHEN THE ERROR    @DA42853 26050016
         BNE   DER17000                 WAS NO DATA CHECK 11   @DA42853 26060016
DER16200 OI    DERCRRA1,DERRA1OR      DO RECORDING             @DA42853 26070016
         B     DER17000                                        @DA42840 26080016
*                                                              @DA42840 26090016
DER16300 CLI   DERCRSC,DERECD11       IS IT DATA CHECK 11      @DA42840 26100016
         BNE   DER17000                 BRANCH IF NOT          @DA42840 26110016
         TM    ERRQSNS+7,B'01010000'  IS IT POSSIBLY FORMAT 5? @DA42963 26120016
         BNO   DER17000               NO                       @DA42963 26130016
         TM    ERRQSNS+7,B'10100000'  IS IT FORMAT 5 FOR SURE? @DA42963 26140016
         BNZ   DER17000               NO                       @DA42963 26150016
         TM    DEROEFL1,DEROEUCU    BRANCH IF THE USER CCB     @D61SDJK 26160000
         BO    DER17000               IS NOT ADDRESSABLE       @D61SDJK 26170000
         TM    UCCBCOM1,DASDRRDC      BRANCH IF USER WANTS TO  @DA42963 26180000
         BNO   DER17000                 GET READ DATA CHECKS   @DA42963 26190016
         NI    DERCRRA1,XFF-DERRA1XM  SWITCH OFF MESSAGING     @DA42840 26200016
*                                                              @D51TDPM 26210016
*-------------------------------------------------------------*@D51TDPM 26220016
*     UPDATE THE ERRQSEK, ERQCCWOP AND ERQCCWFL FIELDS         @D51TDPM 26230016
*     FOR ANY APPLICABLE MESSAGES.                             @D51TDPM 26240016
*-------------------------------------------------------------*@D51TDPM 26250016
*                                                              @D51TDPM 26260016
DER17000 TM    DERCRSF,DERCRSFB   BRANCH WHEN SENSE DATA NOT...@D51TDPM 26270016
         BZ    DER17200             IN BASIC FORMAT.           @D51TDPM 26280016
         CLI   PUBDEVTY,TFBA      BRANCH WHEN NOT AN           @D51TDPM 26290016
         BNE   DER17050             FBA DEVICE.                @D51TDPM 26300016
*                                                              @DERPDGL 26310016
         TM    DEROEFL1,DEROEUCU  BRANCH IF WE HAVE            @DA42992 26320016
         BO    DER17010             NO USER CCB                @DA42992 26330016
         LA    R9,FBALOC                                       @DERPDGL 26350016
 SGDSK  'CALL  DERSCAN         ','FIND THE LAST TIME ITS USED',      GLX26360016
               I='1,9               ON RETURN+4',              @DERPDGLX26370016
               O='5                 R5 POINTS TO FOUND CCW',   @DERPDGLX26380016
               E0='DER17010         ERROR:NO SUCH OPCODE'      @DERPDGL 26390016
         LR    R8,R5                                           @DERPDGL 26400016
         LA    R5,4               NR OF BYTES TO MOVE          @D14ZDDK 26410016
         LA    R6,4               OFFSET IN PARMLIST           @DERPDGL 26420016
         LA    R7,ERRQSEK         AREA TO MOVE IT TO           @DERPDGL 26430016
 SGDSK  'CALL  DERGETDT        ','GET DATA FROM PARAMETERS ',        GLX26440016
               I='5,6,7,8           ON RETURN+4',              @DERPDGLX26450016
               O='NONE              DATA ARE MOVED TO AREA',   @DERPDGLX26460016
               E0='DER17010         ERROR:DATA NOT ADDR.'      @DERPDGL 26470016
         B     DER17300                                        @DERPDGL 26480016
DER17010 XC    ERRQSEK,ERRQSEK                                 @DERPDGL 26490016
         B     DER17300                                        @DERPDGL 26510016
*                                                              @DERPDGL 26520016
DER17050 TM    DERCRRA4,DERRA4NS    BRANCH WHEN SEEK ADDRESS   @D51TDPM 26530016
         BNO   DER17100               IN SENSE DATA IS VALID   @D51TDPM 26540016
         CLI   DERCRFCO,DERSKOP     BRANCH WHEN THE FAILING... @D51TDPM 26550016
         BNE   DER17070               CCW IS NOT A SEEK CCW.   @D51TDPM 26560016
         L     R8,DERCCCWV          ADDRESS OF COMMAND CCW     @D14ZDDK 26570016
         LA    R5,4                 NR OF BYTES TO MOVE        @D14ZDDK 26580016
         LA    R6,2                 OFFSET IN PARMLIST         @DERPDGL 26590016
         LA    R7,ERRQSEK           AREA TO MOVE IT TO         @DERPDGL 26600016
 SGDSK  'CALL  DERGETDT          ','GET DATA FROM PARAMETERS ',      GLX26610016
               I='5,6,7,8             ON RETURN+4',            @DERPDGLX26620016
               O='NONE                DATA ARE MOVED TO AREA', @DERPDGLX26630016
               E0='DER17070           ERROR:DATA NOT ADDR.'    @DERPDGL 26640016
         B     DER17300                                        @D51TDPM 26660016
DER17070 XC    ERRQSEK,ERRQSEK                                 @DERPDGL 26670016
         MVI   ERRQSEK,X'80'                                   @DERPDGL 26680016
         B     DER17300                                        @DERPDGL 26700016
*                                                              @DERPDGL 26710016
DER17100 LR    R5,R3              COPY PUB POINTER             @D61ADJK 26720016
         SH    R5,YPUBTAB         GET OFFSET IN PUBTAB         @D61ADJK 26730016
         SRL   R5,1               DIVIDE BY TWO                @D61ADJK 26740016
         A     R5,APBXAREA        ADDRESS OF PUBX ADDRESSES    @D61ADJK 26750016
         L     R5,0(R5)           GET PUBX POINTER             @D61ADJK 26760016
         USING PBXADR,R5          DECLARE PUBX BASE POINTER    @D61ADJK 26770016
         CLI   PBXOBR+1,X'32'     DEVICE IS A 3390-9?          @D61ADJK 26780016
         BE    DER17200           YES, TAKE SENSE BYTES 29-31  @D61ADJK 26790016
         DROP  R5                 RELEASE PUBX BASE POINTER    @D61ADJK 26800016
*                                                              @D61ADJK 26810016
         SLR   R9,R9                                           @DERPDGL 26820016
         IC    R9,DERCRSHF        SHIFT COUNT FOR DEVICE.      @D51TDPM 26830016
         IC    R5,ERRQSNS+6       PREPARE HIGH CYL FOR SHIFT   @D37ADDK 26840016
         SRL   R5,0(R9)           SHIFT RIGHT HIGH CYL         @D14ZDDK 26850016
         STC   R5,ERRQSEK         STORE HIGH CYL BYTE          @D37ADDK 26860016
         NC    ERRQSEK(1),DERCRCLC CLEAR HIGH CYLINDER BITS.   @D51TDPM 26870016
         MVC   ERRQSEK+1(1),ERRQSNS+5 MOVE LOW CYL BYTE        @D37ADDK 26880016
*        MVI   ERRQSEK+2,X'00'         CLEAR HIGH HEAD BYTE    @D37ADDK 26890016
         MVC   ERRQSEK+3(1),ERRQSNS+6 MOVE LOW HEAD BYTE       @D37ADDK 26900016
         NC    ERRQSEK+3(1),DERCRCLH   CLEAR HIGH HEAD BITS.   @D51TDPM 26910016
         B     DER17300                                        @D51TDPM 26930016
*                                                              @DERPDGL 26940016
DER17200 TM    ERRQSNS+6,X'20'    BRANCH WHEN CYLINDER         @D51TDPM 26950016
         BNO   DER17070             AND HEAD INVALID           @D51TDPM 26960016
         MVC   ERRQSEK(2),ERRQSNS+29    CYLINDER ADDRESS.      @D51TDPM 26970016
*        MVI   ERRQSEK+2,X'00'    NO TRACKS CURRENTLY IN THIS  @D51TDPM 26980016
         MVC   ERRQSEK+3(1),ERRQSNS+31 HEAD ADDRESS.           @D51TDPM 26990016
*                                                              @D51TDPM 27010016
DER17300 DS    0H                                              @DERPDGL 27020016
         MVC   ERQCCWOP,DERCRFCO  UPDATE THE OPCODE AND        @D51TDPM 27030016
         MVI   ERQCCWFL,X'00'     SET DEFAULT FOR FLAGS        @D51TDPM 27040016
         L     R8,DERFCCWV        FAILING CCW ADDRESS.         @D51TDPM 27050016
         LTR   R8,R8              BRANCH WHEN THE FAILING CCW..@D51TDPM 27060016
         BZ    DER18000             IS NOT ACCESSIBLE.         @D51TDPM 27070016
         USING CCWADR,R8                                       @D51TDPM 27080016
         MVC   ERQCCWFL,CCWCHAIN    THE FLAGS.                 @D51TDPM 27090016
         DROP  R8                                              @D51TDPM 27100016
*                                                                       27120016
*-------------------------------------------------------------*@D51TDPM 27130016
*   TELL, THAT THERE WAS A RECOVERY ERROR (FOR EXAMPLE THE     @DERPDGL 27140016
*   DEVICE WAS NOT RECOGNIZED).                                @DERPDGL 27150016
*-------------------------------------------------------------*@D51TDPM 27160016
*                                                              @D51TDPM 27170016
DER18000 CLI   DERCRSC,DERECRE     BRANCH WHEN A RECOVERY...   @D51TDPM 27180016
         BNE   DER19000              ERROR DID NOT OCCUR.      @D51TDPM 27190016
         OI    DEROEFL1,DEROERCV   INDICATE RECOVERY ERROR.    @D51TDPM 27210016
*                                                              @DERPDGL 27220016
*-------------------------------------------------------------*@D51TDPM 27230016
*  LOOK IF A RECOVERY ACTION WOULD MAKE SENSE AND IF SO DO IT. @DERPDGL 27240016
*  LEAVE, IF A RECOVREY ACTION IS IMPOSSIBLE OR EXHAUSTED      @DERPDGL 27250016
*-------------------------------------------------------------*@D51TDPM 27260016
*                                                              @DERPDGL 27270016
DER19000 LA    RF,DERRVUAC        ASSUME RECOVERY UNSUCCESSFUL @D51TDPM 27280016
         TM    DEROEFL1,DEROERNP  BRANCH WHEN RECOVERY IS NOT..@D51TDPM 27290016
         BNZ   DER19110             POSSIBLE.                  @D51TDPM 27300016
 SGDSK  'CALL  DERDOREC        ','ATTEMPT TO RECOVER',         @DERPDGLX27310016
               I='1,2,3,B           FROM THE ERROR  ',         @DERPDGLX27320016
               O='B,F               CONDITION       '          @DERPDGL 27330016
*                                                              @DERPDGL 27340016
*  TRANSLATE THE RETURN CODE FROM DERDOREC AGAIN..             @DERPDGL 27350016
*                                                              @DERPDGL 27360016
         C     RF,=A(DERRRE)      INTO DEROEFL1 BIT AND        @DERPDGL 27370016
         BNE   DER19100             AND THE RETURN CODE USED   @DERPDGL 27380016
         OI    DEROEFL1,DEROERCV    BY DER0000                 @DERPDGL 27390016
DER19100 SRL   RF,2               CONVERT DERDOREC RETURN      @DERPDGL 27410016
         IC    RF,DER0RCTB(RF)      CODE INTO MAIN PATH        @DERPDGL 27420016
DER19110 STC   RF,DERRCVC           RETURN CODE...             @DERPDGL 27430016
 SGDSK  'CALL  DERTRACE        ','WRITE DEBUG ENTRY FOR',      @DERPDGLX27440016
               NR='3                THIS RUN THRU LOOP '       @DERPDGL 27450016
         TM    DERFLG1,DERCVNUC   BRANCH IF SOME NON UNIT CHECK@DERPDGL 27460016
         BO    DER20000             IO FAILURE ENDED RECOVERY  @DERPDGL 27470016
         CLI   DERRCVC,DERRVCOM   BRANCH WHEN RECOVERY IS...   @D51TDPM 27490016
         BNH   DER9000              COMPLETE.                  @D51TDPM 27500016
*                                                              @D52WSBH 27510016
*-------------------------------------------------------------*@DERPDGL 27520016
*   DO THE MESSAGING AND RECORDING IF ANYTHING HAS TO BE DONE. @DERPDGL 27530016
*-------------------------------------------------------------*@DERPDGL 27540016
*                                                              @DERPDGL 27550016
*   EITHER IMMEDIATE RECORDING IS INDICATED IN THE RECOVERY    @DERPDGL 27560016
*   ATTRIBUTES, OR ONE TIME RECORDING FOR EVERY PATH USED.     @DERPDGL 27570016
.*  IF IT IS ONE TIME RECORDING, WE HAVE TO FIND OUT           @DERPDGL 27580016
.*  IF THE PATH WAS CHANGED. FOR THIS WE KEEP A MASK CALLED    @DERPDGL 27590016
.*  DERLSTPU, WHICH IS INITIALLY SET TO ZERO. IF WE BUMPED     @DERPDGL 27600016
.*  AWAY FROM A PATH, THIS PATH WILL BE INDICATED IN THE       @DERPDGL 27610016
.*  DERCRPU MASK. NOW IF THIS IS DIFFERENT FROM OUR MASK,      @DERPDGL 27620016
.*  WE KNOW, WE MUST DO THE ONE TIME RECORDING.                @DERPDGL 27630016
.*  IT COULD ALSO BE, THAT THE PATH WAS NOT CHANGED, BUT       @DERPDGL 27640016
.*  THE ERROR CHANGED. THIS IS ALSO A SUCCESSFUL OVERCOME      @DERPDGL 27650016
.*  OF THE ORIGINAL ERROR AND DOES NOT NECESSARILY INCLUDE     @DERPDGL 27660016
.*  THE CHANGING OF A PATH. WE MAY HAVE HAD A FIRST KIND OF    @DERPDGL 27670016
.*  ERROR 4 TIMES AND THEN ANOTHER KIND OF ERROR 3 TIMES.      @DERPDGL 27680016
.*  PATH IS NEVER CHANGED BUT WE SHOULD STILL DO THE ONE       @DERPDGL 27690016
.*  TIME RECORDING FOR THE FIRST ERROR THAT OCCURED 4 TIMES.   @DERPDGL 27700016
*                                                              @DERPDGL 27710016
DER20000 TM    DERCRRA1,DERRA1MR  BRANCH IF NO RECORDING OR    @DERPDGL 27720016
         BZ    DER21000             MESSAGING AT ALL           @DERPDGL 27730016
         TM    DERCRRA1,DERRA1IM+DERRA1IR ANYTHING IMMEDIATE?  @DERPDGL 27740016
         BNZ   DER20100                                        @DERPDGL 27750016
         CLC   DERLSTPU,DERCRPTU  DID WE EVER START WORKING ON @DERPDGL 27760016
         BE    DER20010             ANOTHER PATH?              @DERPDGL 27770016
         MVC   DERLSTPU,DERCRPTU  YES, COPY AS MY MASK         @DERPDGL 27780016
         B     DER20100             AND GO AHEAD FOR MSG+RCRD. @DERPDGL 27800016
DER20010 TM    DERCRSF,DERCRSFE   IF THE SENSE DATA IN ECKD    @DERPDGL 27810016
         BNO   DER20020                LOOK SIMILAR TO THOSE   @DERPDGL 27820016
         MVC   DERDERSV(4),DERSNS+22   WE HAD BEFORE THE RETRY @DERPDGL 27830016
         MVC   DERDERSV+4(3),CCBCSWW   WE SHOULD NOT CONSIDER  @DERPDGL 27840016
         CLC   DERLSTER,DERDERSV       THE PREVIOUS ERROR      @DERPDGL 27860016
         BE    DER21000                SUCCESSFULLY OVERCOME   @DERPDGL 27870016
         B     DER20100                                        @DERPDGL 27880016
DER20020 MVC   DERDERSV(3),DERSNS+0    LIKEWISE IF THEY DO     @DERPDGL 27890016
         MVC   DERDERSV+3(1),DERSNS+7  FOR OTHER SENSE DATA    @DERPDGL 27900016
         MVC   DERDERSV+4(3),CCBCSWW   FORMAT                  @DERPDGL 27910016
         CLC   DERLSTER,DERDERSV                               @DERPDGL 27930016
         BE    DER21000                                        @DERPDGL 27940016
*                                                              @DERPDGL 27950016
*                                                              @DERPDGL 27960016
DER20100 DS    0H                                              @DERPDGL 27970016
*                                                              @DERPDGL 27990016
*  OBTAIN A FREE ERROR BLOCK IF POSSIBLE.                      @DERPDGL 28000016
*                                                              @DERPDGL 28010016
 SGDSK  'CALL  DERALLOC        ','OBTAIN FREE ERROR BLOCK',    @DERPDGLX28020016
               I='NONE              ON RETURN+4',              @DERPDGLX28030016
               O='F                 RF POINTS TO BLOCK  ',     @DERPDGLX28040016
               E0='DER21000         ERROR:NO BLOCK FOUND'      @DERPDGL 28050016
*                                                              @DERPDGL 28060016
.* FILL IT UP FOR PROCESSING                                   @DERPDGL 28070016
.*                                                             @DERPDGL 28080016
         MVC   0(L'DERINWRK,RF),0(R2)                          @DERPDGL 28100016
         LR    R2,RF                                           @DERPDGL 28110016
*                                                              @DERPDGL 28120016
*  SET THE "TEMPORARY" BIT FOR THE OBR. WE CAN SET THIS        @D52WSBH 28130016
*  UNCONDITIONALLY, SINCE WE WOULD NOT BE HERE IN CASE OF      @D52WSBH 28140016
*  AN EVENTUAL FAILURE.                                        @D52WSBH 28150016
*                                                              @D52WSBH 28160016
         OI    ERRQERPF,ERRQPTEM     MAKE OBR TEMPORARY.       @D52WSBH 28170016
*                                                              @D51TDPM 28180016
*  INDICATE IN THE ERROR BLOCK IF A RETRY WAS PERFORMED ON     @D51TDPM 28190016
*  THE OTHER PATH.                                             @D51TDPM 28200016
*                                                              @D51TDPM 28210016
         NI    ERRQDFL,X'FF'-ERQFROP   NO RETRY ON OTHER PATH. @D51TDPM 28220016
         TM    DERCRPTU,X'FF'        BRANCH WHEN THE PATH HAS  @D51TDPM 28230016
         BZ    DER20300                NOT BEEN SWITCHED.      @D51TDPM 28240016
         OI    ERRQDFL,ERQFROP       RETRIED ON OTHER PATH.    @D51TDPM 28250016
DER20300 EQU  *                                                @D51TDPM 28270016
*                                                              @D51TDPM 28280016
*  ASSUME NO IMMEDIATE MESSAGING OR RECORDING REQUIRED.        @D51TDPM 28290016
*  AND  USE DEFAULT OPERATOR CODE.                             @D51TDPM 28300016
*                                                              @D51TDPM 28310016
         NI    ERRQDFL,X'FF'-(ERQANYMR+ERQCANCL+ERQPASBK)      @D51TDPM 28320016
*                                                              @D51TDPM 28330016
*  REQUEST IMMEDIATE RECORDING IF IT IS REQUIRED.              @D51TDPM 28340016
*                                                              @D51TDPM 28350016
         TM    DERCRRA1,DERRA1IR+DERRA1OR WHEN ANY KIND OF     @D51TDPM 28360016
         BZ    DER20400              RECORDING NOT REQUIRED.   @D51TDPM 28370016
         OI    ERRQDFL,ERQRECRD    REQUEST RECORDING.          @D51TDPM 28380016
 SGDSK  'CALL  DERSDR          ','IND.REC.TYPE IN ERRQERPF',   @DERPDGLX28400016
               I='2                 *',                        @DERPDGLX28410016
               O='NONE              *'                         @DERPDGL 28420016
DER20400 EQU  *                                                @D51TDPM 28430016
*                                                              @D51TDPM 28440016
*  REQUEST IMMEDIATE MESSAGING IF IT IS REQUIRED.              @D51TDPM 28450016
*                                                              @D51TDPM 28460016
         TM    DERCRRA1,DERRA1IM+DERRA1OM WHEN ANY KIND OF     @D51TDPM 28470016
         BZ    DER20500             MESSAGING NOT REQUIRED.    @D51TDPM 28480016
         OI    ERRQDFL,ERQIMSG    REQUEST MESSAGING.           @D51TDPM 28490016
DER20500 EQU   *                                               @D51TDPM 28510016
*                                                              @DERPDGL 28520016
*                                                              @DERPDGL 28530016
 SGDSK  'CALL  DERERP          ','POST ERP FOR MESSAGING',     @DERPDGLX28540016
               I='2                 AND RECORDING REQUEST',    @DERPDGLX28550016
               O='NONE              *'                         @DERPDGL 28560016
*                                                              @DERPDGL 28570016
*-------------------------------------------------------------*@D51TDPM 28580016
*  UPDATE THE SENSE INFORMATION IN THE ERROR ENTRY WE HAVE.    @DERPDGL 28590016
*-------------------------------------------------------------*@D51TDPM 28600016
*                                                              @DERPDGL 28610016
DER21000 LA    R2,DERINWRK        RESTORE ERROR BLOCK POINTER  @DERPDGL 28620016
*??????? WE SHOULD FIRST LOOK, IF THE INFORMATION VALID OR NOT.@DERPDGL 28630016
         ICM   R5,B'0001',ERRQLSNS BRANCH WHEN SENSE LENGTH..  @D21OTJF 28640016
         BZ    DER22000              IS ZERO.                  @D51TDPM 28650016
         BCTR  R5,0               MINUS ONE                    @D37ADDK 28670016
         EX    R5,DER0EMVC        UPDATE SENSE INFO            @D37ADDK 28680016
DER22000 DS    0H                                              @DERPDGL 28690016
         B     DER10000                                        @D51TDPM 28700016
*                                                              @D51TDPM 28710016
***************************************************************@D51TDPM 28720016
*   END OF RECOVERY LOOP.                                      @D51TDPM 28730016
*   SET ANY INDICATORS IN THE USER'S CCB THAT IS REQUIRED      @D51TDPM 28740016
*   FOR RECOVERY OF THE ORIGINAL ERROR CONDITION.              @D51TDPM 28750016
***************************************************************@D51TDPM 28760016
*                                                              @D51TDPM 28770016
DER9000  DS    0H                                              @D51TDPM 28780016
         TM    DEROEFL1,DEROERCV  BRANCH WHEN RECOVERY ERROR   @D51TDPM 28790016
         BO    DERUI001             OCCURED                    @D51TDPM 28800016
         TM    DERFLG1,DERCVDSK   BRANCH IF PREPARATIONAL IO   @DERPDGL 28810016
         BO    DERUI000             OF DSK CAUSED ENDING       @DERPDGL 28820016
         TM    DERFLG1,DERCVNUC   BRANCH IF ENDING NOT FORCED  @DERPDGL 28830016
         BNO   DERUI000             BY NON UNITCHEK IO ERROR   @DERPDGL 28840016
DERUI001 LTR   RB,RB              BRANCH IF THERE IS NO CCB    @DERPDGL 28850016
         BZ    DERUIEX              THAT WE COULD POST         @DERPDGL 28860016
         USING UCCBADR,RB         USER CCB IS ADDRESSABLE      @D51TDPM 28870016
         OI    UCCBCOM1,DISERR    POST IRRECOV. I/O ERROR      @D51TDPM 28880016
         NI    UCCBCOM2,DERUIVAL  RESET ALL OTHER FLAGS        @D51TDPM 28890016
         B     DERUIEX                                         @DERPDGL 28910016
DERUI000 DS    0H                                              @DERPDGL 28930016
         TM    DEROEFL1,DEROEMAR  BRANCH WHEN MESSAGING AND... @D51TDPM 28940016
         BNZ   DERUIEX              RECORDING ONLY.            @D51TDPM 28950016
*                                                              @D51TDPM 28970016
*        RESET FLAGS IN USER CCB                               @D51TDPM 28980016
*                                                              @D51TDPM 28990016
         NI    UCCBCOM2,DERUIVAL                               @D51TDPM 29000016
         NI    UCCBCOM1,X'FF'-DISERR        NOT IRRECOVERABLE. @D51TDPM 29010016
DERUIVAL EQU   X'FF'-COUNTCK-ENDOFCYL-NORCDFND-ITRKFMT-VERFY-DATACHEC   29020016
*                                                              @D51TDPM 29030016
*        SET END OF CYLINDER IF REQUIRED                       @D51TDPM 29040016
*                                                              @D51TDPM 29050016
         TM    DERCRRA3,DERRA3EO    BRANCH WHEN AN...          @D51TDPM 29060016
         BNO   DERUI007               EOC CONDITION.           @D51TDPM 29070016
         OI    UCCBCOM2,ENDOFCYL    INDICATE EOC OCCURRED.     @D51TDPM 29080016
DERUI007 DS    0H                                              @D51TDPM 29100016
*                                                              @D51TDPM 29110016
*        SET NO RECORD FOUND IF REQUIRED                       @D51TDPM 29120016
*                                                              @D51TDPM 29130016
         TM    DERCRRA3,DERRA3NR    BRANCH WHEN NOT NO...      @D51TDPM 29140016
         BNO   DERUI017               RECORD FOUND.            @D51TDPM 29150016
         TM    UCCBCOM2,NRFRETRY    BRANCH WHEN USER DID NOT...@D51TDPM 29160016
         BNO   DERUI015               REQUEST NRF RETRY.       @D51TDPM 29170016
         CLI   DERRCVC,DERRVUAC     BRANCH WHEN THE ORIGINAL...@D51TDPM 29180016
         BNE   DERUI017               ERROR WAS NOT RECOVERED. @D51TDPM 29190016
DERUI015 OI    UCCBCOM2,NORCDFND    INDICATE NRF OCCURRED.     @D51TDPM 29200016
DERUI017 DS    0H                                              @D51TDPM 29220016
*                                                              @D51TDPM 29230016
*        SET INVALID TRACK FORMAT IF REQUIRED                  @D51TDPM 29240016
*                                                              @D51TDPM 29250016
         TM    DERCRRA3,DERRA3TW    BRANCH WHEN INVALID TRACK..@D51TDPM 29260016
         BO    DERUI025               FORMAT - WRITE.          @D51TDPM 29270016
         CLI   DERRCVC,DERRVUAC     BRANCH WHEN RECOVERY WAS...@D51TDPM 29280016
         BNE   DERUI027               NOT UNSUCCESSFUL.        @D51TDPM 29290016
         TM    DERCRRA3,DERRA3TR    BRANCH WHEN NOT INVALID    @D52WSBH 29300016
         BNO   DERUI027               TRACK FORMAT - READ      @D52WSBH 29310016
DERUI025 OI    UCCBCOM2,ITRKFMT     INDICATE ITF IN USER CCB.  @D51TDPM 29320016
DERUI027 DS    0H                                              @D51TDPM 29340016
*                                                              @D51TDPM 29350016
*        SET THE VERIFY ERROR INDICATION IF REQUIRED           @D51TDPM 29360016
*                                                              @D51TDPM 29370016
         CLI   DERRCVC,DERRVUAC     BRANCH WHEN RECOVERY WAS...@D51TDPM 29380016
         BNE   DERUI037               NOT UNSUCCESSFUL.        @D51TDPM 29390016
         TM    DERCRRA3,DERRA3VE    BRANCH WHEN SOME VERIFY    @D51TDPM 29400016
         BNO   DERUI037               ERROR OCCURED            @D51TDPM 29410016
         OI    UCCBCOM2,VERFY     VERIFY ERROR IN USER'S CCB.  @D51TDPM 29420016
DERUI037 DS    0H                                              @D51TDPM 29440016
*                                                              @D51TDPM 29450016
*        SET THE IRRECOVERABLE I/O INDICATOR IF REQUIRED       @D51TDPM 29460016
*                                                              @D51TDPM 29470016
         CLI   DERRCVC,DERRVUAC   BRANCH WHEN THE ORIGINAL...  @D51TDPM 29480016
         BNE   DERUI050             ERROR WAS NOT RECOVERED.   @D51TDPM 29490016
         OI    UCCBCOM1,DISERR    IRRECOVERABLE I/O UCCB.      @D51TDPM 29500016
DERUI050 DS    0H                                              @D51TDPM 29520016
*                                                              @D51TDPM 29530016
*        SET DATA CHECK INDICATION IF REQUIRED                 @D51TDPM 29540016
*                                                              @D51TDPM 29550016
         CLI   DERRCVC,DERRVUAC     BRANCH WHEN RECOVERY WAS...@D51TDPM 29560016
         BNE   DERUI057               NOT UNSUCCESSFUL.        @D51TDPM 29570016
         TM    DERCRRA3,DERRA3DC    BRANCH WHEN NOT A DATA...  @D51TDPM 29580016
         BNO   DERUI057               CHECK ERROR CONDITION.   @D51TDPM 29590016
DERUI055 OI    UCCBCOM2,DATACHEC    DATA CHECK IN USER'S CCB.  @D51TDPM 29600016
         TM    DERCRRA3,DERRA3CC    BRANCH WHEN NOT A DATA...  @D51TDPM 29620016
         BNO   DERUI057               CHECK IN COUNT AREA      @D51TDPM 29630016
DERUI056 OI    UCCBCOM2,COUNTCK     IND. DATA CHK IN COUNT FLD @D51TDPM 29640016
DERUI057 DS    0H                                              @DERPDGL 29660016
DERUIEX  DS    0H                                              @DERPDGL 29670016
*                                                              @DERPDGL 29680016
*-------------------------------------------------------------*@DERPDGL 29690016
*   UPDATE DERWKCSW WHICH IS USED TO UPDATE THE CSW FOR        @DERPDGL 29700016
*   DSKEXIT. (SEE DESCRIPTION IN HEADER)                       @DERPDGL 29710016
*-------------------------------------------------------------*@DERPDGL 29720016
*                                                              @DERPDGL 29730016
         TM    DERFLG1,DERCVCSW        DID WE HAVE >0 RETRIES  @DERPDGL 29740016
         BO    DERCW104                  THAT WERE UNSUCCESSF. @DERPDGL 29750016
         CLI   DERRCVC,DERRVSAC        WERE WE SUCCESSFUL IN   @DERPDGL 29760016
         BE    DERCW104                  JUST ONE RUN?         @DERPDGL 29770016
         LTR   RB,RB                   BRANCH IF WE HAVE NO    @DERPDGL 29780016
         BZ    DERCW102                  USER CCB ANY MORE.    @DERPDGL 29790016
         MVC   DERWKCSW+1(7),CHQCSW+1  TAKE STATUS FROM CHANQ  @DERPDGL 29800016
         B     DERCW110                                        @DERPDGL 29820016
DERCW102 MVC   DERWKCSW+1(7),ERRQCSW+1 TAKE ERRQ.CSW INSTEAD   @DERPDGL 29830016
         B     DERCW110                                        @DERPDGL 29850016
DERCW104 MVC   DERWKCSW+1(3),CCBCSWW   CSW CCW ADDRESS.        @D51TDPM 29860016
         MVC   DERWKCSW+4(2),CCBSTA    CSW UNIT/CHANNGEL STATUS@D51TDPM 29870016
         MVC   DERWKCSW+6(2),CCBCNT    CSW RESIDUAL COUNT.     @DERPDGL 29880016
DERCW110 DS    0H                                              @DERPDGL 29900016
.*                                                             @D51TDPM 29910016
.*   IF THE CCW ADDRESS IN THE WORK CSW WOULD IDENTIFY A DSK   @D51TDPM 29920016
.*   CCW, THEN REPORT THE CSW CCW ADDRESS GIVEN FOR THE        @D51TDPM 29930016
.*   ORIGINAL ERROR CONDITION.                                 @D51TDPM 29940016
.*                                                             @D51TDPM 29950016
.*       CLC   DERSOCA+1(3),DERWKCSW+1  BRANCH WHEN THE CCW IS @D51TDPM 29960016
.*       BH    DERCW200                BEFORE ANY DSK CCW.     @D51TDPM 29970016
.*       CLC   DEREOCA+1(3),DERWKCSW+1  BRANCH WHEN CCW IS     @D51TDPM 29980016
.*       BNH   DERCW200                AFTER ANY DSK CCW.      @D51TDPM 29990016
.*       MVC   DERWKCSW+1(3),ERRQCSW+1 USE ORIGINAL CSW CCW.   @D51TDPM 30000016
.*RCW200 DS    0H                                              @D51TDPM 30010016
*                                                              @D51TDPM 30020016
*-------------------------------------------------------------*@D51TDPM 30030016
*   IF THE ORIGINAL I/O REQUEST IS MADE AT THE FULL ERP LAYER  @D51TDPM 30040016
*   AND THE ORIGINAL I/O REQUEST IS NOT SUCCESSFULLY RECOVERED,@D51TDPM 30050016
*   THEN DETERMINE IF THE CRT OR SVT TASK REQUIRES THE SENSE   @D51TDPM 30060016
*   DATA.                                                      @D51TDPM 30070016
*-------------------------------------------------------------*@D51TDPM 30080016
*                                                              @D51TDPM 30090016
         TM    DERFLG1,DERCVNUC   BRANCH IF ENDING FORCED      @DERPDGL 30100016
         BO    DER9010              BY NON UNITCHEK IO ERROR   @DERPDGL 30110016
         TM    DEROEFL1,DEROEMEL  BRANCH WHEN I/O REQUEST AT...@D51TDPM 30120016
         BO    DER9010              THE MINIMAL ERP LAYER.     @D51TDPM 30130016
         CLI   DERRCVC,DERRVUAC   B IF ORIGINAL ERR.COND. IS   @D51TDPM 30140016
         BNE   DER9010              NOT UNSUCCESSFULLY RECOV.  @D51TDPM 30150016
         LA    R5,SVTTID          SVT TASK-ID                  @D66ADAP 30160016
         CH    R5,DERTID          BRANCH WHEN THE I/O REQUESTOR@D66CDAP 30170016
         BNE   DERRS200             IS NOT THE SVT TASK.       @D51TDPM 30180016
         TM    DEROEFL1,DEROEUCU  BRANCH WHEN THE USER'S CCB...@D51TDPM 30190016
         BO    DERRS200             IS NOT AVAILABLE.          @D51TDPM 30200016
         CLI   16(RB),X'04'       BRANCH WHEN THE USER DOES... @D51TDPM 30210016
         BNE   DERRS200             NOT WANT SENSE DATA.       @D51TDPM 30220016
         SLR   R5,R5              GET THE ADDRESS OF THE...    @D51TDPM 30230016
         ICM   R5,M7,17(RB)       ADDRESS OF WHERE TO MOVE SNS @D51TDPM 30240016
         MVC   0(3,R5),ERRQSNS    MOVE SENSE DATA.             @DA40705 30250016
DERRS200 EQU   *                                               @D51TDPM 30270016
*                                                              @D51TDPM 30280016
DER9010  EQU   *                                               @DERPDGL 30290016
*-------------------------------------------------------------*@DERPDGL 30300016
*   DETERMINE WHAT RETURN CODE SHOULD BE PASSED TO DSKEXIT.    @DERPDGL 30310016
*-------------------------------------------------------------*@DERPDGL 30320016
*     DEREXITC IS SET TO A CODE SPECIFYING WHAT RETURN CODE    @DERPDGL 30330016
*     DSK SHOULD GIVE TO DSKEXIT.  DEREXITC HAS A VALUE OF     @DERPDGL 30340016
*     DEREXIGN, DEREXCAN, DEREXED, DEREXEM AND DEREXDSP.       @DERPDGL 30350016
*     DEREXRTY IS ONLY MENTIONED HERE FOR COMPLETENESS BUT     @DERPDGL 30360016
*     ITS NOT USED AT THE MOMENT.                              @DERPDGL 30370016
*                                                              @DERPDGL 30380016
*     DEREXIGN  IS THE DEFAULT VALUE. IT IS ALSO GIVEN IF      @DERPDGL 30390016
*               RECOVERY WAS NOT POSSIBLE FOR MISSING CCB ADDR.@DERPDGL 30400016
*                                                              @DERPDGL 30410016
*     DEREXDSP  IS TAKEN, IF WE RELY ON THE ERP TASK TO        @DERPDGL 30420016
*               GO TO THE IGNORE, RETRY OR CANCEL EXIT OR THE  @D61NDJK 30430016
*               USER IS ALREADY POSTED (MINIMAL ERP LAYER).    @D61NDJK 30440016
*               IT IS SET FURTHER DOWN IN FINAL MESSAGING..    @DERPDGL 30450016
*                                                              @DERPDGL 30460016
*     DEREXCAN  FOR UNSUCCESSFUL RECOVERY AND IF CANCELLATION  @DERPDGL 30470016
*               IS NOT PREVENTED. IT IS PREVENTED IF THE USER  @DERPDGL 30480016
*               REQUESTS KNOWLEDGE ABOUT ALL UNSUCCESSFUL      @DERPDGL 30490016
*               I/O REQUESTS.                                  @DERPDGL 30500016
*                                                              @DERPDGL 30510016
*     DEREXED   IF A STATE CHANGE PENDING SITUATION IS         @DERPDGL 30520016
*               IS ASSOCIATED WITH AN ERROR CONDITION.         @DERPDGL 30530016
*                                                              @DERPDGL 30540016
*     DEREXEM   IF DSK PUT THE DEVICE INTO INTERVENTION        @DERPDGL 30550016
*               REQUIRED STATE AND THE REQUESTOR WAS A         @DERPDGL 30560016
*               SYSTEM TASK OR ANOTHER TASK WITH HEADQUEUEING. @DERPDGL 30570016
*                                                              @DERPDGL 30580016
*     DEREXRTY  IS NOT GIVEN AT THE MOMENT FOR ANY PURPOSE AT  @DERPDGL 30590016
*               AT ALL. IT WOULD HOWEVER BE HANDLED CORRECTLY  @DERPDGL 30600016
*               BY THE REST OF SGDSK CODE. IT WOULD SEND THE   @DERPDGL 30610016
*               DEVICE ERROR ENTRY TO ERP TASK AND THIS WOULD  @DERPDGL 30620016
*               REDRIVE THE IO AFTER A MESSAGE WAS WRITTEN.    @DERPDGL 30630016
*                                                              @DERPDGL 30640016
         TM    DEROEFL1,DEROEMEL  BRANCH WHEN MINIMAL ...      @D61NDJK 30660016
         BNZ   DEREXC60             ERP LAYER                  @D61NDJK 30670016
         TM    DEROEFL1,DEROEUCU  BRANCH WHEN NO USER CCB ...  @D61NDJK 30680016
         BNZ   DEREXC50             IS AVAILABLE               @D61NDJK 30690016
*                                                              @D51TDPM 30710016
*   TELL THE SUPERVISOR THAT DSK FOUND A STATE CHANGE PENDING  @D51TDPM 30720016
*   CONDITION ASSOCIATED WITH THE DEVICE.                      @D51TDPM 30730016
*                                                              @D51TDPM 30740016
         TM    DERCRRA3,DERRA3SC  BRANCH WHEN NO STATE CHANGE  @D51TDPM 30750016
         BNO   DEREXC10             PENDING CONDITION          @D51TDPM 30760016
         MVI   DEREXITC,DEREXED   USE SC/ED RETURN CODE.       @D51TDPM 30770016
         B     DEREXEX                                         @D51TDPM 30790016
DEREXC10 EQU   *                                               @D51TDPM 30800016
*                                                              @D51TDPM 30810016
*   USE THE CANCEL RETURN CODE WHEN APPROPRIATE.               @D51TDPM 30820016
*                                                              @D51TDPM 30830016
         CLI   DERRCVC,DERRVUAC   BRANCH IF NO UNSUCCESSFUL    @D51TDPM 30840016
         BNE   DEREXC34             RECOVERY                   @D51TDPM 30850016
.*       TM    DEROEFL1,DEROEUCU    USER CCB IS NEVER POSTED   @D51TDPM 30860016
.*       BO    DEREXC34               IF WE ARE HERE.          @D51TDPM 30870016
         TM    UCCBCOM1,ACCUNRIO    BRANCH IF ACCUNRIO SET     @D51TDPM 30880016
         BO    DEREXC34               BY USER                  @D51TDPM 30890016
         TM    UCCBCOM1,DASDRRDC    BRANCH IF READ DATA CHECKS @D51TDPM 30910000
         BNO   DEREXC30               SHALL NOT BE REPORTED    @D51TDPM 30920016
         TM    DERCRRA3,DERRA3VE      BRANCH IF IT WAS SOME    @DERPDGL 30930016
         BO    DEREXC34                 KIND OF  VERIFY ERROR  @DERPDGL 30940016
         TM    DERCRRA3,DERRA3DC      OR SOME KIND OF DATA     @DERPDGL 30950016
         BNO   DEREXC30                 CHECK OCCURED          @DERPDGL 30960016
         CLI   DERCRFCO,X'00'           BRANCH IF USER CCW WAS @DERPDGL 30970016
         BE    DEREXC30                   NOT ACCESSIBLE       @DERPDGL 30980016
         TM    DERCRFCO,X'01'           BRANCH IF USER CCW WAS @DERPDGL 30990016
         BNO   DEREXC34                   A READ OR READ VERIF.@DERPDGL 31000016
DEREXC30 DS    0H                                              @DERPDGL 31010016
         TM    UCCBCOM1,DASDRWDC    BRANCH IF WRITE DATA CHKS  @DERPDGL 31020000
         BNO   DEREXC31               SHALL NOT BE REPORTED    @DA43898 31030000
         TM    DERCRRA3,DERRA3DC      BRANCH IF IT WAS NOT A   @DERPDGL 31040016
         BNO   DEREXC31                 KIND OF DATA CHECK     @DA43898 31050000
         CLI   DERCRFCO,X'00'           BRANCH IF USER CCW WAS @DERPDGL 31060016
         BE    DEREXC31                   NOT ACCESSIBLE       @DA43898 31070000
         TM    DERCRFCO,X'01'           BRANCH IF IT WAS A     @DERPDGL 31080016
         BO    DEREXC34                   KIND OF WRITE        @DERPDGL 31090016
DEREXC31 DS    0H                                              @DA43898 31100000
         TM    UCCBBY3,ITWPASSB     BRANCH IF INV. TRACK FMT.  @DA43898 31110000
         BNO   DEREXC32             WRITE SHALL NOT BE REPORTED@DA43898 31120000
         TM    DERCRRA3,DERRA3TW    BRANCH IF IT WAS INVALID   @DA43898 31130000
         BO    DEREXC34               TRACK FORMAT WRITE       @DA43898 31140000
DEREXC32 DS    0H                                              @DERPDGL 31150016
         MVI   DEREXITC,DEREXCAN  USE CANCEL RETURN CODE.      @D51TDPM 31160016
         B     DEREXEX                                         @D51TDPM 31180016
DEREXC34 DS    0H                                              @D51TDPM 31190016
*                                                              @D51TDPM 31200016
*   USE THE EMERGENCY MESSAGE WHEN IT IS APPROPRIATE.          @D51TDPM 31210016
*   THE RETURN CODE FROM THE MAIN LOOP CAN ONLY BE             @D51TDPM 31220016
*   DERRVIRQ IF WE HAD A SOLICITED INTERRUPT WITH RECONLY      @D51TDPM 31230016
*   OFF WHEN WE CAME IN. SEE DEROERNP , DEROEUCU AND DEROEUIC  @D51TDPM 31240016
*                                                              @D51TDPM 31250016
         CLI   DERRCVC,DERRVIRQ   BRANCH WHEN THE DEVICE DOES..@D51TDPM 31260016
         BNE   DEREXC42             NOT REQUIRE INTERVENTION.  @D51TDPM 31270016
         CLC   DERTID,ARTIDH      BRANCH WHEN I/O REQUEST IS...@D66CDAP 31280016
         BL    DEREXC40             NON-AR SYSTEM I/O REQUEST. @D51TDPM 31290016
.*       USING CHQADR,R4          IT MUST HAVE BEEN SOLICITED  @DERPDGL 31300016
         TM    CHQFLG1,CHQHQA     BRANCH IF USER WAS NOT A     @DERPDGL 31310016
         BNO   DEREXC42             HEADQUEUE REQUESTOR        @DERPDGL 31320016
         TM    UCCBCOM1,ACCUNRIO  BRANCH IF USER ACCEPTED      @DERPDGL 31330016
         BO    DEREXC42             UNRECOVERABLE IO ERROR     @DERPDGL 31340016
DEREXC40 MVI   DEREXITC,DEREXEM   USE EMERGENCY MSG RETURN CODE@D51TDPM 31350016
         B     DEREXEX                                         @D51TDPM 31370016
DEREXC42 EQU   *                                               @D51TDPM 31380016
*                                                              @D51TDPM 31390016
*   OTHERWISE USE THE IGNORE RETURN CODE.                      @D51TDPM 31400016
*                                                              @D51TDPM 31410016
DEREXC50 MVI   DEREXITC,DEREXIGN  USE IGNORE RETURN CODE.      @D51TDPM 31420016
         B     DEREXEX                                         @D61NDJK 31440016
*                                                              @D61NDJK 31450016
DEREXC60 MVI   DEREXITC,DEREXDSP  USE DISPATCHER RETURN CODE   @D61NDJK 31460016
DEREXEX  EQU   *                                               @D51TDPM 31470016
*                                                              @D51TDPM 31480016
*-------------------------------------------------------------*@D51TDPM 31490016
*   TELL ERP TO GIVE A PATH DOWN MESSAGE, IF A PATH HAD BEEN   @DERPDGL 31500016
*   SET DOWN IN THE RECOVERY OF THIS ERROR.                    @DERPDGL 31510016
*-------------------------------------------------------------*@D51TDPM 31520016
*                                                              @DERPDGL 31530016
         TM    DERCRPDN,X'FF'     BRANCH WHEN A PATH WAS NOT...@DERPDGL 31540016
         BZ    DERPDM10             TAKEN DOWN.                @DERPDGL 31550016
*                                                              @DERPDGL 31570016
 SGDSK  'CALL  DERALLOC        ','OBTAIN FREE ERROR BLOCK',    @DERPDGLX31580016
               I='NONE              ON RETURN+4',              @DERPDGLX31590016
               O='F                 RF POINTS TO BLOCK  ',     @DERPDGLX31600016
               E0='DERPDM10         ERROR:NO BLOCK FOUND'      @D51TDPM 31610016
*                                                              @DERPDGL 31620016
         MVC   0(L'DERINWRK,RF),DERINWRK  SETUP FOR PROCESSING @DERPDGL 31630016
         LR    R2,RF              AND TAKE IT FOR BIT SETTINGS @DERPDGL 31640016
*                                                              @DERPDGL 31650016
*   REQUEST OPERATOR CODE "I" AND A PATH DOWN MESSAGE          @DERPDGL 31660016
*                                                              @DERPDGL 31670016
         NI    ERRQDFL,X'FF'-(ERQCANCL+ERQPASBK+ERQANYMR)      @DERPDGL 31680016
         OI    ERRQDFL,ERQPTHDN   REQUEST PATH DOWN MESSAGE    @DERPDGL 31690016
*                                                              @DERPDGL 31700016
 SGDSK  'CALL  DERERP          ','SCHEDULE MESSAGE ',          @DERPDGLX31720016
               I='2                 *',                        @DERPDGLX31730016
               O='NONE              *'                         @DERPDGL 31740016
*                                                                       31750016
DERPDM10 DS    0H                                              @DERPDGL 31760016
*                                                                       31770000
*-------------------------------------------------------------*@DA43984 31780000
*   TELL ERP TO GIVE A SIM MESSAGE, IF SENSE DATA REQUESTS     @DA43984 31790000
*   MESSAGING AND THE I/O REQUESTOR HAS OWN ERROR ROUTINE.     @DA43984 31800000
*   FOR OTHER I/O REQUESTORS, MESSAGING WILL BE DONE IN THE    @DA43984 31810000
*   FINAL MESSAGING ROUTINE.                                   @DA43984 31820000
*-------------------------------------------------------------*@DA43984 31830000
*                                                              @DA43984 31840000
         TM    DERCRRA4,DERRA4SI  BRANCH WHEN NO SIM ERROR     @DA43984 31850000
         BZ    DERSIMEX             CONDITION OCCURRED         @DA43984 31860000
         TM    DEROEFL1,DEROEMEL  WAS REQUEST AT MINIMAL ERP   @DA43984 31870000
         BZ    DERSIMEX             LAYER WHEN IT CAME IN?     @DA43984 31880000
         TM    DERCRRA1,DERRA1XM  BRANCH WHEN NO MESSAGING AT  @DA43984 31890000
         BZ    DERSIMEX             ALL IS REQUESTED           @DA43984 31900000
*                                                              @DA43984 31910000
 SGDSK  'CALL  DERALLOC        ','OBTAIN FREE ERROR BLOCK',    @DA43984X31920000
               I='NONE              ON RETURN+4',              @DA43984X31930000
               O='F                 RF POINTS TO BLOCK  ',     @DA43984X31940000
               E0='DERSIMEX         ERROR:NO BLOCK FOUND'      @DA43984 31950000
*                                                              @DA43984 31960000
         MVC   0(L'DERINWRK,RF),DERINWRK  SETUP FOR PROCESSING @DA43984 31970000
         LR    R2,RF              AND TAKE IT FOR BIT SETTINGS @DA43984 31980000
*                                                              @DA43984 31990000
*   REQUEST OPERATOR CODE "I"                                  @DA43984 32000000
*                                                              @DA43984 32010000
         MVI   ERRQDFL,ERQIMSG     REQUEST MESSAGING.          @DA43984 32020000
*                                                              @DA43984 32030000
 SGDSK  'CALL  DERERP          ','SCHEDULE MESSAGE ',          @DA43984X32040000
               I='2                 *',                        @DA43984X32050000
               O='NONE              *'                         @DA43984 32060000
*                                                                       32070000
DERSIMEX DS    0H                                              @DA43984 32080000
*                                                                       32090016
*-------------------------------------------------------------*@DERPDGL 32100016
*    IF APPROPRIATE, QUEUE AN ERROR BLOCK FOR THE ERP TASK TO  @DERPDGL 32110016
*    HAVE IT RECORD A "FINAL SDR."                             @DERPDGL 32120016
*-------------------------------------------------------------*@DERPDGL 32130016
*                                                              @DERPDGL 32140016
.*  WE LEFT THE RECOVERY LOOP, HENCE NEITHER THE IMMEDIATE     @DERPDGL 32150016
.*  NOR THE ONE TIME RECORDING CAN HAVE BEEN DONE IN THE LOOP. @DERPDGL 32160016
.*  THE ONE TIME RECORDING IS ALWAYS DONE, AFTER THE PATH WAS  @DERPDGL 32170016
.*  CHANGED, AND FOR THE CURRENT IO THIS CAN NOT YET HAVE BEEN @DERPDGL 32180016
.*  NOTICED, SINCE WE LEFT THE LOOP.                           @DERPDGL 32190016
.*  IF THERE IS NO RECORDING NEED AT ALL WE SKIP RECORDING.    @DERPDGL 32200016
.*  IF THERE IS AN IMMEDIATE NEED WE DO IT.                    @DERPDGL 32210016
.*  IF WE LEFT THE LOOP, BECAUSE WE WERE UNSUCCESSFUL, WE      @DERPDGL 32220016
.*     WOULD DO RECORDING FOR ONE TIME OR FOR UNSUCCESSFUL.    @DERPDGL 32230016
.*     AND ONE OF THEM MUST BE ON ANYWAY.                      @DERPDGL 32240016
.*  IF WE WERE SUCCESSFUL, WE WOULD ONLY RECORD FOR ONE TIME   @DERPDGL 32250016
.*     RECORDING.                                              @DERPDGL 32260016
.*                                                             @DERPDGL 32270016
         TM    DERFLG1,DERCVNUC   BRANCH IF ENDING FORCED      @DERPDGL 32280016
         BO    DERFNR90             BY NON UNITCHEK IO ERROR   @DERPDGL 32290016
         TM    DERCRRA1,DERRA1XR  BRANCH WHEN NO RECORDING     @DERPDGL 32300016
         BZ    DERFNR90             AT ALL IS REQUIRED         @DERPDGL 32310016
         TM    DERCRRA1,DERRA1IR  BRANCH IF RECORDING IN ALL   @DERPDGL 32320016
         BO    DERFNR00             CASES DEMANDED             @DERPDGL 32330016
         CLI   DERRCVC,DERRVSAC   BRANCH IF UNSUCCESSFUL       @DERPDGL 32340016
         BNE   DERFNR00             RECOVERY IN ABOVE LOOP     @DERPDGL 32350016
         TM    DERCRRA1,DERRA1OR  BRANCH IF ONE TIME RECORDING @DERPDGL 32360016
         BNO   DERFNR90             IS NOT INDICATED.          @DERPDGL 32370016
*                                                              @DERPDGL 32380016
DERFNR00 DS    0H                                              @DERPDGL 32390016
 SGDSK  'CALL  DERALLOC        ','OBTAIN FREE ERROR BLOCK',    @DERPDGLX32410016
               I='NONE              ON RETURN+4',              @D52BDGLX32420016
               O='F                 RF POINTS TO BLOCK  ',     @D52BDGLX32430016
               E0='DERFNR90         ERROR:NO BLOCK FOUND'      @D51TDPM 32440016
*                                                              @D52WSBH 32450016
*                                                              @D52WSBH 32460016
         MVC   0(L'DERINWRK,RF),DERINWRK SETUP WITH VALUES     @D52WSBH 32470016
         LR    R2,RF                                           @DERPDGL 32480016
*                                                              @D52WSBH 32490016
         OI    ERRQDFL,ERQRECRD   REQUEST RECORDING.           @D52WSBH 32500016
         NI    ERRQDFL,X'FF'-ERQANYM REQUEST NO MESSAGE        @D52WSBH 32510016
*                                                              @D52WSBH 32520016
*  INDICATE IN THE ERROR BLOCK IF A RETRY WAS PERFORMED ON     @D52WSBH 32530016
*  THE OTHER PATH.                                             @D52WSBH 32540016
*                                                              @D52WSBH 32550016
         NI    ERRQDFL,X'FF'-ERQFROP     ASSUME NOT ON OTHER P.@D52WSBH 32560016
         TM    DERCRPTU,X'FF'            BRANCH IF PATH HAS    @D52WSBH 32570016
         BZ    DERFNR45                    NOT BEEN SWITCHED   @D52WSBH 32580016
         OI    ERRQDFL,ERQFROP           SET RETRIED ON OTHER. @D52WSBH 32590016
DERFNR45 DS    0H                                              @D52WSBH 32610016
*                                                              @D52WSBH 32620016
*  INDICATE IN THE ERROR BLOCK IF THE ERROR CONDITION SHOULD   @D52WSBH 32630016
*  BE MARKED TEMPORARY.                                        @D52WSBH 32640016
*                                                              @D52WSBH 32650016
         NI    ERRQERPF,X'FF'-ERRQPTEM   NO TEMPORARY ERROR.   @D52WSBH 32660016
         CLI   DERRCVC,DERRVUAC          BRANCH WHEN RECOVERY..@D52WSBH 32670016
         BE    DERFNR60                    UNSUCCESSFUL.       @D52WSBH 32680016
         OI    ERRQERPF,ERRQPTEM         TEMPORARY ERROR       @D52WSBH 32690016
DERFNR60 DS    0H                                              @D52WSBH 32710016
*                                                              @D52WSBH 32720016
 SGDSK  'CALL  DERSDR          ','IND.REC.TYPE IN ERRQERPF',   @D52BDGLX32730016
               I='2                 *',                        @D52BDGLX32740016
               O='NONE              *'                         @D52BDGL 32750016
*                                                              @D52WSBH 32760016
 SGDSK  'CALL  DERERP          ','QUEUE THE ERROR  ',          @D52BDGLX32780016
               I='2                 BLOCK TO DO THE',          @D52BDGLX32790016
               O='NONE              RECORDING'                 @D52BDGL 32800016
*                                                              @D52WSBH 32810016
DERFNR90 DS    0H                                              @D52BDGL 32820016
*                                                              @D52WSBH 32830016
         LA    R2,DERINWRK        RESTORE ERBLKADR PTR         @DERPDGL 32840016
*                                                              @D51TDPM 32850016
*-------------------------------------------------------------*@DERPDGL 32860016
*   REQUEST FINAL MESSAGING                                    @DERPDGL 32870016
*-------------------------------------------------------------*@DERPDGL 32880016
*   SET ERQRCVER ON IF A RECOVERY ERROR MESSAGE IS NEEDED.     @DERPDGL 32890016
*   SET ERQIMSG ON IF A NON-RECOVERY ERROR MESSAGE IS NEEDED.  @DERPDGL 32900016
.*  PRINCIPALLY THE SAME LOGIC APPLIES AS FOR FINAL RECORDING  @DERPDGL 32910016
.*  IN ORDER TO CLARIFY IF WE NEED FINAL MESSAGING OR NOT.     @DERPDGL 32920016
.*  THE ONLY DIFFERENCE IS FOR THE MINIMAL ERP LAYER. THERE    @DERPDGL 32930016
.*  IS PROGRAMS, THAT DELIBERATELY FORCE COMMAND REJECTS AND   @DERPDGL 32940016
.*  HAVE USER OWN ERROR ROUTINE SPECIFIED (LIKE THE SERVICE    @DERPDGL 32950016
.*  TASK) IT DOES NOT MAKE MUCH SENSE TO GIVE A MESSAGE FOR    @DERPDGL 32960016
.*  THIS KIND OF ERROR TOO, SO WE OVERRULE THIS HERE.          @DERPDGL 32970016
*                                                              @DERPDGL 32980016
*   DETERMINE IF WE HAD A NON UNIT CHECK FAILURE THAT WOULD    @DERPDGL 32990016
*   NORMALLY BE HANDLED BY THE ERROR RECOVERY TRANSIENTS FOR   @DERPDGL 33000016
*   DISK ($$ABERD1) AND IF PREPARE FOR THIS TYPE OF MESSAGE.   @DERPDGL 33010016
*   IF HOWEVER THE IO FAILURE WAS CAUSED BY AN ERROR THAT WOULD@DERPDGL 33020016
*   NORMALLY BE HANDLED BY RAS PROCESSING DO NOT GIVE A MSG    @DERPDGL 33030016
*   AGAIN AND JUST POST THE USER.                              @DERPDGL 33040016
*                                                              @DERPDGL 33050016
         TM    DEROEFL1,DEROEIRE  BRANCH WHEN A RECOVERY ERROR @DERPDGL 33060016
         BNZ   DERFNM02             MESSAGE REQUESTED.         @DERPDGL 33070016
         TM    DERFLG1,DERCVNUC   BRANCH IF ENDING NOT FORCED  @DERPDGL 33080016
         BNO   DERNUCEX             BY NON UNITCHEK IO ERROR   @DERPDGL 33090016
         CLI   ERRQCSW+DERCSCST-DERCSW,DERCSNOP   BRANCH IF    @DERPDGL 33110016
         BE    DERFNM00             ERROR WAS NOT OPERATIONAL  @DERPDGL 33120016
         TM    ERRQCSW+DERCSCST-DERCSW,DERCSERP   BRANCH IF    @DERPDGL 33130016
         BNZ   DERFNM00             ERP WOULD NORMALLY CARE    @DERPDGL 33140016
         B     DERFNM90           NO MESSAGE PLEASE            @DERPDGL 33150016
DERNUCEX DS    0H                                              @DERPDGL 33160016
         TM    DEROEFL1,DEROEMEL  WAS REQUEST AT MINIMAL ERP   @D51TDPM 33170016
         BO    DERFNM90             LAYER WHEN IT CAME IN?     @DERPDGL 33180016
         CLI   DEREXITC,DEREXCAN  BRANCH IF MESSAGING IF USER  @DERPDGL 33190016
         BE    DERFNM00             SHALL BE CANCELLED         @DERPDGL 33200016
         TM    DERCRRA1,DERRA1XM  BRANCH WHEN NO MESSAGING AT  @DERPDGL 33210016
         BZ    DERFNM90             ALL IS REQUESTED           @DERPDGL 33220016
         TM    DERCRRA1,DERRA1IM  BRANCH IF MESSAGING IN ALL   @DERPDGL 33230016
         BO    DERFNM00             CASES DEMANDED             @DERPDGL 33240016
         CLI   DERRCVC,DERRVSAC   BRANCH IF UNSUCCESSFUL       @DERPDGL 33250016
         BNE   DERFNM00             RECOVERY IN ABOVE LOOP     @DERPDGL 33260016
         TM    DERCRRA1,DERRA1OM  BRANCH IF ONE TIME MESSAGING @DERPDGL 33270016
         BNO   DERFNM90             IS NOT INDICATED.          @DERPDGL 33280016
*                                                              @DERPDGL 33290016
DERFNM00 EQU   *                                               @DERPDGL 33300016
         MVI   ERRQDFL,ERQIMSG     REQUEST MESSAGING.          @DERPDGL 33310016
         B     DERFNM04                                        @DERPDGL 33330016
DERFNM02 EQU   *                                               @DERPDGL 33340016
         MVI   ERRQDFL,ERQRCVER    RECOVERY ERROR MESSAGE.     @DERPDGL 33350016
DERFNM04 EQU   *                                               @DERPDGL 33370016
*                                                              @DERPDGL 33380016
         CLI   DEREXITC,DEREXRTY       BRANCH IF REQUEST SHOULD@DERPDGL 33390016
         BNE   DERFNM06                  NOT BE RETRIED        @DERPDGL 33400016
         NI    ERRQFLG,XFF-PASSBK-IGNERR-OPINT                 @D61SDJK 33410000
         OI    ERRQFLG,SUCCESS+RTYERR                          @DERPDGL 33420016
         B     DERFNM50                                        @DERPDGL 33430016
*                                                              @DERPDGL 33440016
.*  SET THE ERQCANCL AND ERQPASBK FLAGS TO INDICATE WHAT       @DERPDGL 33450016
.*  OPERATOR CODE SHOULD BE IN THE MESSAGE AND, IF THIS IS     @DERPDGL 33460016
.*  GOING TO BE A SYNCHRONOUS FINAL MESSAGE, WHAT RETURN CODE  @DERPDGL 33470016
.*  THE ERP TASK SHOULD PASS TO DSKEXIT AFTER IT HAS ISSUED THE@DERPDGL 33480016
.*  MESSAGE.                                                   @DERPDGL 33490016
.*                                                             @DERPDGL 33500016
DERFNM06 CLI   DEREXITC,DEREXCAN       BRANCH IF JOB SHOULD    @DERPDGL 33510016
         BNE   DERFNM10                  NOT BE CANCELLED      @DERPDGL 33520016
         TM    DERCRRA4,DERRA4DM       BRANCH IF NO DECISION   @DERPDGL 33530016
         BNO   DERFNM07                  TYPE MSG DESIRABLE    @DERPDGL 33540016
         NI    ERRQFLG,XFF-PASSBK-IGNERR-OPINT-SUCCESS         @D61SDJK 33550000
         OI    ERRQFLG,RTYERR                                  @DERPDGL 33560016
         B     DERFNM40                  .                     @DERPDGL 33580016
DERFNM07 OI    ERRQDFL,ERQCANCL        SET CANCEL BIT ON       @DERPDGL 33590016
         B     DERFNM40                  .                     @DERPDGL 33610016
DERFNM10 EQU   *                                               @DERPDGL 33620016
         CLI   DERRCVC,DERRVUAC        BRANCH IF RECOVERY WAS  @DERPDGL 33630016
         BNE   DERFNM40                  SUCCESSFUL            @DERPDGL 33640016
         TM    DEROEFL1,DEROEUCU       BRANCH IF POSTING IS NOT@D51TDPM 33650016
         BO    DERFNM40                  POSSIBLE              @D51TDPM 33660016
         OI    ERRQDFL,ERQPASBK        SET PASSBACK ON         @DERPDGL 33670016
DERFNM40 EQU   *                                               @DERPDGL 33690016
*                                                              @DERPDGL 33700016
.*  SET ERQINTV FLAG TO TELL THE ERP TASK WHAT MESSAGE TYPE    @DERPDGL 33710016
.*  CODE AND DSKEXIT RETURN CODE TO USE.                       @DERPDGL 33720016
.*                                                             @DERPDGL 33730016
         CLI   DERRCVC,DERRVIRQ        IF WE ARE DOING         @DERPDGL 33740016
         BNE   DERFNM50                  INTERVENTION REQUIRED,@DERPDGL 33750016
         OI    ERRQDFL,ERQINTV           SET ON ERQINTV.       @DERPDGL 33760016
DERFNM50 EQU   *                                               @DERPDGL 33780016
*                                                              @DERPDGL 33790016
*   IF THE ORIGINAL IO WAS DONE BY A SYSTEM TASK (OTHER THAN   @DERPDGL 33800016
*   ATTENTION) THEN DO NOT TRY TO ACCESS ANY CCB DATA          @DERPDGL 33810016
*   OF IT, NOR CCW AND DO NOT TRY TO CANCEL IT.                @DERPDGL 33820016
*   IN OTHER WORDS: SET RECONLY ON.                            @DERPDGL 33830016
*   IF THE UNIT CHECK WAS UNSOLICITED, THE RECONLY BIT WOULD   @DA42666 33840016
*   LEAD TO QEDERR IN PUBCSFLG BEING LEFT ON AND SOFTWAIT OF   @DA42666 33850016
*   THE SYSTEM.                                                @DA42666 33860016
*                                                              @DERPDGL 33870016
         TM    DEROEFL1,DEROEUIC  IF UNIT CHECK IS UNSOLICITED @DA42666 33880016
         BO    DERFNM70             DO NOT USE RECONLY MSG     @DA42666 33890016
         CLC   DERTID,ARTIDH      IF NON-AR SYSTEM TASK,       @D66CDAP 33900016
         BL    DERFNM65             DO ASYNCHRONOUS MSG        @DERPDGL 33910016
         TM    CHQFLG1,CHQHQA     BRANCH IF THIS WAS NOT A     @DERPDGL 33920016
         BNO   DERFNM70             HEADQUEUE REQUEST          @DERPDGL 33930016
*                                                              @DERPDGL 33940016
DERFNM65 DS    0H                 DO ASYNCHRONOUS MESSAGE      @DERPDGL 33950016
         OI    ERRQFLG,RECONLY                                 @DERPDGL 33960016
         B     DERFNM75                                        @DERPDGL 33980016
*                                                              @DERPDGL 33990016
DERFNM70 DS    0H                 DO SYNCHRONOUS MESSAGE       @DERPDGL 34000016
         MVI   DEREXITC,DEREXDSP  REDIRECT EXIT TO DISPATCHER  @DERPDGL 34010016
DERFNM75 DS    0H                                              @DERPDGL 34020016
*                                                              @DERPDGL 34030016
 SGDSK  'CALL  DERERP          ','SET UP SOME FURTHER FIELDS', @DERPDGLX34050016
               I='2                 *',                        @DERPDGLX34060016
               O='NONE              *'                         @DERPDGL 34070016
*                                                              @DERPDGL 34080016
DERFNM90 DS    0H                                              @DERPDGL 34090016
*                                                              @DERPDGL 34100016
*-------------------------------------------------------------*@D51TDPM 34110016
*   SET UP THE RETURN CODE FOR DSKEXIT IN RF.                  @D51TDPM 34120016
*-------------------------------------------------------------*@D51TDPM 34130016
*                                                              @D51TDPM 34140016
         L     R9,AINTER          ADDRESSABILITY TO IOINTER SO @D31DTBH 34150016
         USING INTRTN,R9            WE CAN ACCESS ERPX FIELDS  @D31DTBH 34160016
*                                                              @D52WSBH 34170016
         L     RF,ERPXAD1         DISPATCHER EXIT              @D52WSBH 34180016
         CLI   DEREXITC,DEREXDSP  BRANCH WHEN DISPATCHER       @D52WSBH 34190016
         BE    DER9999              EXIT TO BE TAKEN.          @D52WSBH 34200016
*                                                              @D52WSBH 34210016
         L     RF,ERPXAD4         IGNORE EXIT.                 @D31DTBH 34220016
         CLI   DEREXITC,DEREXIGN  BRANCH WHEN IGNORE EXIT...   @D51TDPM 34230016
         BE    DER9999               IS NOT WANTED.            @D51TDPM 34240016
*                                                              @D52WSBH 34250016
         L     RF,ERPXRDLY        USE SC/ED EXIT.              @D31TDRH 34260016
         CLI   DEREXITC,DEREXED   BRANCH WHEN SC/ED EXIT...    @D51TDPM 34270016
         BE    DER9999                                         @D51TDPM 34280016
*                                                              @D52WSBH 34290016
         L     RF,ERPXMWRT        EMERGENCY MESSAGE EXIT.      @D37ADDK 34300016
         CLI   DEREXITC,DEREXEM   BRANCH WHEN AN EMERGENCY...  @D51TDPM 34310016
         BE    DER9999                                         @D51TDPM 34320016
*                                                              @D52WSBH 34330016
         L     RF,ERPXAD5         CANCEL EXIT.                 @D51DTPM 34340016
         CLI   DEREXITC,DEREXCAN  BRANCH WHEN CANCEL EXIT...   @D51TDPM 34350016
         BE    DER9999                                         @D51TDPM 34360016
*                                                              @D52WSBH 34370016
         L     RF,ERPXAD2         RETRY EXIT.                  @D51DTPM 34380016
         CLI   DEREXITC,DEREXRTY  BRANCH WHEN RETRY  EXIT...   @D51TDPM 34390016
         BE    DER9999                                         @D51TDPM 34400016
*                                                              @DERPDGL 34410016
*  THIS CODE SHOULD NEVER EXECUTE.  CASES ABOVE ARE EXHAUSTIVE.@D52WSBH 34420016
*                                                              @DERPDGL 34430016
DER9530  BAL   R5,&SYSERR                                      @D51TDPM 34440016
         DROP  R9                                              @D51TDPM 34450016
DER9999  EQU   *                                               @D51TDPM 34460016
*                                                              @D51TDPM 34470016
*-------------------------------------------------------------*@D51TDPM 34480016
*   EXIT TO DSKEXIT.  RF CONTAINS THE RETURN CODE.  R2         @D51TDPM 34490016
*   CONTAINS THE ADDRESS OF THE ERROR BLOCK.  R3 CONTAINS THE  @D51TDPM 34500016
*   ADDRESS OF THE PUB.  THE FINAL STATE OF THE CSW IS NOW     @D51TDPM 34510016
*   SET UP AS IF THIS STATE HAD BEEN GIVEN BY THE DEVICE       @D51TDPM 34520016
*   ITSELF.                                                    @D51TDPM 34530016
*-------------------------------------------------------------*@D51TDPM 34540016
*                                                              @D51TDPM 34550016
         MVC   CSW(8),DERWKCSW    ESTABLISH PROPER CSW.        @D51TDPM 34560016
 SGDSK  'CALL  DERTRACE         ','CALL FOR DEBUG ENTRY',      @DERPDGLX34570016
               NR='4                 DISPLAY SOME SENSE DATA'  @DERPDGL 34580016
*                                                              @DERPDGL 34590016
         SLR   R2,R2                                           @DERPDGL 34600016
 SGDSK  'CALL  DERERP          ','POST ERP FOR MESSAGING',     @DERPDGLX34610016
               I='2                 AND RECORDING REQUEST',    @DERPDGLX34620016
               O='NONE              *'                         @DERPDGL 34630016
*                                                              @DERPDGL 34640016
*-------------------------------------------------------------*@D51TDPM 34650016
*   SET UP THE ORIGINAL ERROR BLOCK FOR LEAVE TO SGERP         @D51TDPM 34660016
*-------------------------------------------------------------*@D51TDPM 34670016
*                                                              @DERPDGL 34680016
         L     R2,DERORGEB                    MAKE IT ADDRESS. @DERPDGL 34690016
         MVC   0(L'DERINWRK,R2),DERINWRK      COPY DERINWRK    @DERPDGL 34700016
         XC    ERBLKPTR,ERBLKPTR              DEQUEUE IT       @DERPDGL 34710016
         NI    ERBLKFLG,XFF-ERQUEUED-ERACTIVE SET IT INACTIVE  @DERPDGL 34720016
         NI    ERBLKFL1,XFF-NEEDDSK           TELL IT WAS DONE @D51TDPM 34730016
*                                                              @DERPDGL 34740016
*-------------------------------------------------------------*@D51TDPM 34750016
*        AMODESW SET,AMODE=24,WR=(R5) ENTER 24-BIT ADDR. MODE  @D52VDAP 34760016
         AMODESW SET,AMODE=24,WR=(R5) ENTER 24-BIT ADDR. MODE  @D52VDAP 34770016
*                                                              @DERPDGL 34780016
         L     R9,ERPBASE         LOAD SGERP BASE REGISTER     @D37ADDK 34790016
         USING SGERP,R9           DECLARE SGERP BASE           @D37ADDK 34800016
         B     DSKEXIT            =========================>>> @D37ADDK 34810016
         DROP  R2,R3,R9                                        @D51TDPM 34820016
*                                                              @DERPDGL 34830016
DER0RCTB DC   AL1(DERRVSAC)       SUCCESSFUL AND COMPLETE      @DERPDGL 34840016
         DC   AL1(DERRVUAC)       UNSUCCESSFUL AND COMPLETE    @DERPDGL 34850016
         DC   AL1(DERRVUNC)       UNSUCCESSFUL, NOT COMPLETE.  @DERPDGL 34860016
         DC   AL1(DERRVUAC)       UNSUCCESSFUL AND COMPLETE.   @DERPDGL 34870016
         DC   AL1(DERRVUAC)       UNSUCCESSFUL AND COMPLETE.   @DERPDGL 34880016
         DC   AL1(DERRVUAC)       UNSUCCESSFUL AND COMPLETE.   @DERPDGL 34890016
         DC   AL1(DERRVIRQ)       INTERVENTION REQUIRED.       @DERPDGL 34900016
         DS   0F                                               @DERPDGL 34910016
*                                                              @DERPDGL 34920016
DER0EMVC MVC  ERRQSNS-ERBLKADR(0,R2),DERSNS                    @DERPDGL 34930016
         DROP  ,                                               @D66ADAP 34940016
         USING SYSS00,R0                                       @D66ADAP 34950016
*                                                              @DERPDGL 34960016
ADERGLOB DC   A(DERGLOB)                                       @DERPDGL 34970016
DER24P8  EQU  B'10000000'    24 PLUS 8 SENSE DATA INDICATOR.   @D51TDPM 34980016
*                                                              @DERPDGL 34990016
         LTORG                                                 @D51TDPM 35000016
*-------------------------------------------------------------*@D51TDPM 35010016
*   RECOVERY ACTION TABLE.                                     @DERPDGL 35020016
*   ALSO DEFINES THE DEREC... CODES FOR DERCRSC                @DERPDGL 35030016
*-------------------------------------------------------------*@D51TDPM 35040016
DERRAVAL DSECT     RECOVERY ATTRIBUTE TABLE ENTRY.             @D52WSPM 35050016
DERRA1   DS   X    ATTRIBUTES CONTROLLING OCCURENCE OF         @DERPDGL 35060016
*                  MESSAGING AND RECORDING                     @DERPDGL 35070016
DERRA1AM EQU   B'10000000'  SINGEL MESSAGE IF UNSUCCSESSFULL   @DERPDGL 35080016
DERRA1AR EQU   B'01000000'  RECORDING IF UNSUCCESSFULL         @DERPDGL 35090016
DERRA1OM EQU   B'00100000'  SINGLE MESSAGE PER PATH            @DERPDGL 35100016
DERRA1OR EQU   B'00010000'  SINGLE RECORDING PER PATH          @DERPDGL 35110016
DERRA1IM EQU   B'00001000'  IMMEDIATE MESSAGE                  @DERPDGL 35120016
DERRA1IR EQU   B'00000100'  IMMEDIATE RECORDING                @DERPDGL 35130016
DERRA1MR EQU   DERRA1OM+DERRA1OR+DERRA1IM+DERRA1IR             @DERPDGL 35140016
DERRA1XR EQU   DERRA1AR+DERRA1OR+DERRA1IR                      @DERPDGL 35150016
DERRA1XM EQU   DERRA1AM+DERRA1OM+DERRA1IM                      @DERPDGL 35160016
*                                                              @DERPDGL 35170016
DERRARL  DS    X            RETRY LIMIT                        @DERPDGL 35180016
*                                                              @DERPDGL 35190016
DERRASUB DS    X            SUBROUTINE INDEX IN (DERASTAB)     @DERPDGL 35200016
*                                                              @DERPDGL 35210016
DERRA2   DS    X            PROCESSING BITS                    @DERPDGL 35220016
*                                                              @DERPDGL 35230016
DERRA2BD EQU   B'10000000'  BREAK A DUPLEX PAIR                @DERPDGL 35240016
DERRA2DU EQU   B'01000000'  WRITE INHIBIT CONTROLLER           @DERPDGL 35250016
DERRA2DS EQU   B'00100000'  WRITE INHIBIT STORAGE DIRECTOR     @DERPDGL 35260016
DERRA2DP EQU   B'00010000'  WRITE INHIBIT PATH                 @DERPDGL 35270016
DERRA2NS EQU   B'00001000'  PREVENT PATH SWITSCHING            @DERPDGL 35280016
DERRA2SR EQU   B'00000100'  ATTEMPT RECOVERY                   @DERPDGL 35290016
DERRA2US EQU   B'00000010'  UNCONDITIONAL SURRENDER            @DERPDGL 35300016
*        EQU   B'00000001'  RESERVED.                          @DERPDGL 35310016
*                                                              @DERPDGL 35320016
DERRA3   DS    X            PASSBACK INFORMATION               @DERPDGL 35330016
*                                                              @DERPDGL 35340016
DERRA3SC EQU   B'10000000'  STATE CHANGE PENDING               @DERPDGL 35350016
DERRA3EO EQU   B'01000000'  END OF CYLINDER                    @DERPDGL 35360016
DERRA3NR EQU   B'00100000'  NO RECORD FOUND                    @DERPDGL 35370016
DERRA3TR EQU   B'00010000'  INVALID TRACK FORMAT READ          @DERPDGL 35380016
DERRA3TW EQU   B'00001000'  INVALID TRACK FORMAT WRITE         @DERPDGL 35390016
DERRA3VE EQU   B'00000100'  VERIFY ERROR                       @DERPDGL 35400016
DERRA3DC EQU   B'00000010'  SOME SORT OF DATA CHECK            @DERPDGL 35410016
DERRA3CC EQU   B'00000001'  DATA CHECK IN COUNT FIELD          @DERPDGL 35420016
*                                                              @DERPDGL 35430016
DERRA4   DS   X    ATTRIBUTES CONTROLLING THE KIND OF          @DERPDGL 35440016
*                  MESSAGING AND RECORDING                     @DERPDGL 35450016
DERRA4DM EQU   B'10000000'    GIVE DECISION MSG IN CASE OF CANCEL    GL 35460016
DERRA4NS EQU   B'01000000'    SEEK ARGUMENT IN SENSE INVALID   @DERPDGL 35470016
*        EQU   B'00100000'    RESERVED                         @DERPDGL 35480016
*        EQU   B'00010000'    RESERVED                         @DERPDGL 35490016
*        EQU   B'00001000'    RESERVED                         @DERPDGL 35500016
*        EQU   B'00000100'    RESERVED                         @DERPDGL 35510016
DERRA4MD EQU   B'00000010'    RECORD SNS DATA AS MDR RECORD    @DERPDGL 35520016
DERRA4SI EQU   B'00000001'    RECORDING AND MESSAGING OF A SIM @DA43984 35530000
*                                                                       35540016
DERRATBL EQU  *-DERRAVAL  LENGTH OF ONE DERRATB ENTRY          @DERPDGL 35550016
&SYSECT  CSECT                                                          35560016
DERRATB  DS   0F                                               @D51TDPM 35570016
*                                                              @DERPDGL 35580016
*   SIM PRESENTED, OPERATOR ALERT                              @DERPDGL 35590016
*HERE                                                                   35600016
 DC AL1(DERRA1IM+DERRA1IR,255,DERASSMP,0,0,DERRA4SI)      SMA  @D51TDPM 35610016
DERECSMA EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 35620016
*                                                              @DERPDGL 35630016
*   SIM PRESENTED, NO OPERATOR ALERT                           @DERPDGL 35640016
 DC AL1(DERRA1IR,255,DERASSMP,0,0,DERRA4SI)               SMN  @D51TDPM 35650016
DERECSMN EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 35660016
*                                                              @DERPDGL 35670016
*   BASIC COMMAND REJECT                                       @DERPDGL 35680016
 DC AL1(DERRA1AM,0,0,DERRA2US,0,DERRA4NS)                 BCR  @D51TDPM 35690016
DERECBCR EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 35700016
*                                                              @DERPDGL 35710016
*   BASIC FILE PROTECT                                         @DERPDGL 35720016
 DC AL1(DERRA1AM,0,0,DERRA2US,0,0)                        BFP  @D51TDPM 35730016
DERECBFP EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 35740016
*                                                              @DERPDGL 35750016
*   INVALID TRACK FORMAT    (UNUSED ENTRY. IS ALWAYS ITR/ITW)  @DERPDGL 35760016
 DC AL1(DERRA1AM,0,0,0,0,0)                               ITF  @D52WSBH 35770016
DERECITF EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 35780016
*                                                              @DERPDGL 35790016
*   INCOMPLETE DOMAIN                                          @DERPDGL 35800016
 DC AL1(DERRA1AM+DERRA1IR,255,DERASSMP,0,0,0)             ID   @D51TDPM 35810016
DERECID  EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 35820016
*                                                              @DERPDGL 35830016
*   END OF CYLINDER                                            @DERPDGL 35840016
 DC AL1(0,0,DERASEOC,0,DERRA3EO,0)                        EOC  @D51TDPM 35850016
DERECEOC EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 35860016
*                                                              @DERPDGL 35870016
*   RESET NOTIFICATION                                         @DERPDGL 35880016
.*  LOGGING IS ONLY DONE IF NOT OVERCOME SUCCESSFULLY          @DA37503 35890016
 DC AL1(DERRA1AR+DERRA1AM,255,DERASRSN,0,0,DERRA4MD)      RN   @D51TDPM 35900016
DERECRN  EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 35910016
*                                                              @DERPDGL 35920016
*   PERMANENT DATA CHECK                                       @DERPDGL 35930016
 DC AL1(DERRA1AM+DERRA1IR,0,0,DERRA2US,DERRA3DC,0)        PDC  @D51TDPM 35940016
DERECPDC EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 35950016
*                                                              @DERPDGL 35960016
*   COUNTER OFFLOAD                                            @DERPDGL 35970016
 DC AL1(DERRA1IR,10,DERASSMP,0,0,DERRA4MD)                CO   @D51TDPM 35980016
DERECCO  EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 35990016
*                                                              @DERPDGL 36000016
*   RECOVERABLE EQUIPMENT CHECK                                @DERPDGL 36010016
 DC AL1(DERRA1AM+DERRA1OR,10,DERASSMP,0,0,0)              REC  @D51TDPM 36020016
DERECREC EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 36030016
*                                                              @DERPDGL 36040016
*   INTERVENTION REQUIRED                                      @DERPDGL 36050016
 DC AL1(DERRA1AM,1,DERASIRQ,0,0,0)                        IR   @D51TDPM 36060016
DERECIR  EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 36070016
*                                                              @DERPDGL 36080016
*   PATH FENCED                                                @DERPDGL 36090016
 DC AL1(DERRA1IR+DERRA1IM,255,DERASSMP,0,0,0)             PF   @D51TDPM 36100016
DERECPF  EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 36110016
*                                                              @DERPDGL 36120016
*   INTERVENTION REQUIRED EQUIPMENT CHECK                      @DERPDGL 36130016
 DC AL1(DERRA1AM+DERRA1OR,1,DERASIRQ,0,0,0)               IRE  @D51TDPM 36140016
DERECIRE EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 36150016
*                                                              @DERPDGL 36160016
*   ALTERNATE INTERFACE DISABLED                               @DERPDGL 36170016
 DC AL1(DERRA1IR+DERRA1IM,10,DERASSMP,0,0,0)              AID  @D51TDPM 36180016
DERECAID EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 36190016
*                                                              @DERPDGL 36200016
*   RECOVERABLE 3375/ 3380 EQUIPMENT CHECK                     @DERPDGL 36210016
 DC AL1(DERRA1AM+DERRA1OR,10,DERASSMP,0,0,0)              R7E  @D51TDPM 36220016
DERECR7E EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 36230016
*                                                              @DERPDGL 36240016
*   SUBSYSTEM INFORMATION                                      @DERPDGL 36250016
 DC AL1(DERRA1IM+DERRA1IR,10,DERASSMP,0,0,0)              SI   @D52WSPM 36260016
DERECSI  EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 36270016
*                                                              @DERPDGL 36280016
*   PATH WRITE INHIBIT                                         @DERPDGL 36290016
 DC AL1(DERRA1AM+DERRA1IR,0,DERASPWI,0,0,0)               PWI  @D51TDPM 36300016
DERECPWI EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 36310016
*                                                              @DERPDGL 36320016
*   INTERVENTION IS REQUIRED (SPECIAL)                         @DERPDGL 36330016
 DC AL1(DERRA1AM+DERRA1IR,1,DERASIRQ,0,0,0)               IRS  @D51TDPM 36340016
DERECIRS EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 36350016
*                                                              @DERPDGL 36360016
*   INTERVENTION REQUIRED, ENVIRONMENTAL DATA                  @DERPDGL 36370016
 DC AL1(DERRA1AM+DERRA1IR,255,DERASIRQ,0,0,0)             IED  @D51TDPM 36380016
DERECIED EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 36390016
*                                                              @DERPDGL 36400016
*   NO RECORD FOUND                                            @DERPDGL 36410016
 DC AL1(0,10,DERASNRF,0,DERRA3NR,0)                       NRF  @D51TDPM 36420016
DERECNRF EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 36430016
*                                                              @DERPDGL 36440016
         AGO   .NOSUP45                                        @D61ADJK 36450016
*   BASIC SEEK CHECK                                           @DERPDGL 36460016
 DC AL1(DERRA1AM+DERRA1OR,0,DERASBSC,0,0,0)               BSC  @D51TDPM 36470016
DERECBSC EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 36480016
*                                                              @DERPDGL 36490016
.NOSUP45 ANOP                                                  @D61ADJK 36500016
*   BUSOUT                                                     @DERPDGL 36510016
 DC AL1(DERRA1AM+DERRA1OR,1,DERASSMP,0,0,0)               B    @D51TDPM 36520016
DERECB   EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 36530016
*                                                              @DERPDGL 36540016
*   OPERATION INCOMPLETE OVERRUN                               @DERPDGL 36550016
 DC AL1(DERRA1AM,0,DERASOIO,0,0,0)                        OIO  @D51TDPM 36560016
DERECOIO EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 36570016
*                                                              @DERPDGL 36580016
*   BASIC FBA OVERRUN                                          @DERPDGL 36590016
 DC AL1(DERRA1AM+DERRA1OR,10,DERASSMP,0,0,0)              BFO  @D51TDPM 36600016
DERECBFO EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 36610016
*                                                              @DERPDGL 36620016
*   BASIC OVERRUN                                              @DERPDGL 36630016
 DC AL1(DERRA1AM+DERRA1OR,10,DERASSMP,0,0,0)              BO   @D51TDPM 36640016
DERECBO  EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 36650016
*                                                              @DERPDGL 36660016
*   DEVICE IS WRITE INHIBITED                                  @DERPDGL 36670016
 DC AL1(DERRA1AM,0,DERASDWI,0,0,0)                        DWI  @D51TDPM 36680016
DERECDWI EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 36690016
*                                                              @DERPDGL 36700016
         AGO   .NOSUP46                                        @D61ADJK 36710016
*   FILE PROTECT OVERFLOW, END OF CYLINDER                     @DERPDGL 36720016
 DC AL1(0,0,0,DERRA2SR,DERRA3EO,0)                        FPE  @D51TDPM 36730016
DERECFPE EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 36740016
*                                                              @DERPDGL 36750016
*   FILE PROTECTED 334X                                        @DERPDGL 36760016
 DC AL1(DERRA1AM,0,DERASFP,0,0,0)                         FPY  @D51TDPM 36770016
DERECFPY EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 36780016
*                                                              @DERPDGL 36790016
*   FILE PROTECTED OVERFLOW                                    @DERPDGL 36800016
 DC AL1(DERRA1AM,0,DERASOI,0,0,0)                         FPO  @D51TDPM 36810016
DERECFPO EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 36820016
*                                                              @DERPDGL 36830016
.NOSUP46 ANOP                                                  @D61ADJK 36840016
*   CFWID MISMATCH                                             @DERPDGL 36850016
 DC AL1(DERRA1AM,0,0,DERRA2US,0,0)                        FWM  @D51TDPM 36860016
DERECFWM EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 36870016
*                                                              @DERPDGL 36880016
*   CORRECTABLE VERIFY ERROR                                   @DERPDGL 36890016
 DC AL1(DERRA1OR,1,DERASCVE,0,DERRA3VE,0)                 CVE  @D51TDPM 36900016
DERECCVE EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 36910016
*                                                              @DERPDGL 36920016
*   UNCORRECTABLE VERIFY ERROR                                 @DERPDGL 36930016
 DC AL1(DERRA1AM+DERRA1OR,10,DERASSMP,0,DERRA3VE+DERRA3DC,0)   @DERPDGL 36940016
DERECUVE EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 36950016
*                                                              @DERPDGL 36960016
*   BLOCK SIZE EXCEPTION                                       @DERPDGL 36970016
 DC AL1(DERRA1AM,0,0,DERRA2US,0,0)                        BSE  @D51TDPM 36980016
DERECBSE EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 36990016
*                                                              @DERPDGL 37000016
*   INVALID TRACK FORMAT DURING STAGING OR DESTAGING           @DERPDGL 37010016
 DC AL1(DERRA1OM,255,DERASSMP,0,0,0)                      IDF  @D51TDPM 37020016
DERECIDF EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 37030016
*                                                              @DERPDGL 37040016
*   MISCELLANEOUS INFORMATION                                  @DERPDGL 37050016
 DC AL1(DERRA1IM,10,DERASSMP,0,0,0)                       MI   @D51TDPM 37060016
DERECMI  EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 37070016
*                                                              @DERPDGL 37080016
*   FIRST LOGGED ERROR 3380 / 3390                             @DERPDGL 37090016
 DC AL1(DERRA1IR+DERRA1AM,255,DERASSMP,0,0,0)             FLY  @DA43137 37100016
DERECFLY EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 37110016
*                                                              @DERPDGL 37120016
*   LOG ONLY                                                   @DERPDGL 37130016
 DC AL1(DERRA1IR,0,0,DERRA2SR,0,0)                        LO   @D51TDPM 37140016
DERECLO  EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 37150016
*                                                              @DERPDGL 37160016
         AGO   .NOSUP44                                        @D61ADJK 37170016
*   OPERATION INCOMPLETE, TRACK CONDITION CHECK                @DERPDGL 37180016
 DC AL1(DERRA1AM,0,DERASTCC,0,0,0)                        OIT  @D51TDPM 37190016
DERECOIT EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 37200016
*                                                              @DERPDGL 37210016
*   BASIC TRACK CONDITION CHECK                                @DERPDGL 37220016
 DC AL1(DERRA1AM,0,DERASTCC,0,0,0)                        BTC  @D51TDPM 37230016
DERECBTC EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 37240016
*                                                              @DERPDGL 37250016
.NOSUP44 ANOP                                                  @D61ADJK 37260016
*   BASIC OPERATION INCOMPLETE                                 @DERPDGL 37270016
 DC AL1(DERRA1AM,0,DERASOI,0,0,0)                         BOI  @D51TDPM 37280016
DERECBOI EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 37290016
*                                                              @DERPDGL 37300016
*   LAST LOGGED ERROR                                          @DERPDGL 37310016
 DC AL1(DERRA1IR+DERRA1IM,255,DERASSMP,0,0,0)             LLE  @D51TDPM 37320016
DERECLLE EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 37330016
*                                                              @DERPDGL 37340016
*   INVALID TRACK FORMAT WRITE                                 @DERPDGL 37350016
 DC AL1(DERRA1OM,0,0,DERRA2US,DERRA3TW,0)                 ITW  @D51TDPM 37360016
DERECITW EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 37370016
*                                                              @DERPDGL 37380016
*   INVALID TRACK FORMAT READ                                  @DERPDGL 37390016
 DC AL1(DERRA1AM,1,DERASSMP,0,DERRA3TR,0)                 ITR  @D51TDPM 37400016
DERECITR EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 37410016
*                                                              @DERPDGL 37420016
         AGO   .NOSUP40                                        @D61ADJK 37430016
*   DATA CHECK 2                                               @DERPDGL 37440016
 DC AL1(DERRA1AM+DERRA1OR,0,DERASC02,0,DERRA3DC,0)        D02  @D51TDPM 37450016
DERECD02 EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 37460016
*                                                              @DERPDGL 37470016
*   DATA CHECK 3                                               @DERPDGL 37480016
 DC AL1(DERRA1AM+DERRA1OR,0,DERASC34,0,DERRA3DC,0)        D03  @D51TDPM 37490016
DERECD03 EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 37500016
*                                                              @DERPDGL 37510016
*   DATA CHECK 4                                               @DERPDGL 37520016
 DC AL1(DERRA1AM+DERRA1OR,0,DERASC34,0,DERRA3DC,0)        D04  @D51TDPM 37530016
DERECD04 EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 37540016
*                                                              @DERPDGL 37550016
.NOSUP40 ANOP                                                  @D61ADJK 37560016
*   DATA CHECK 5  (NORMAL CORRECT. DATACK. FOR FBA DEVICES)    @DERPDGL 37570016
 DC AL1(DERRA1AM,0,DERASC05,0,DERRA3DC,0)                 D05  @DA42853 37580016
DERECD05 EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 37590016
*                                                              @DERPDGL 37600016
*   DATA CHECK 6                                               @DERPDGL 37610016
 DC AL1(DERRA1AM,0,DERASC67,0,DERRA3DC,0)                 D06  @D51TDPM 37620016
DERECD06 EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 37630016
*                                                              @DERPDGL 37640016
         AGO   .NOSUP41                                        @D61ADJK 37650016
*   DATA CHECK 7                                               @DERPDGL 37660016
 DC AL1(DERRA1AM+DERRA1OR,0,DERASC67,0,DERRA3DC,0)        D07  @D51TDPM 37670016
DERECD07 EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 37680016
*                                                              @DERPDGL 37690016
*   DATA CHECK 8                                               @DERPDGL 37700016
 DC AL1(DERRA1AM+DERRA1OR,0,DERASC08,0,DERRA3DC,0)        D08  @D51TDPM 37710016
DERECD08 EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 37720016
*                                                              @DERPDGL 37730016
.NOSUP41 ANOP                                                  @D61ADJK 37740016
*   DATA CHECK 9                                               @DERPDGL 37750016
 DC AL1(DERRA1AM,0,DERASOIO,0,DERRA3DC,0)                 D09  @DA42853 37760016
DERECD09 EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 37770016
*                                                              @DERPDGL 37780016
         AGO   .NOSUP42                                        @D61ADJK 37790016
*   DATA CHECK 10                                              @DERPDGL 37800016
 DC AL1(DERRA1AM,10,DERASSMP,0,DERRA3DC,0)                D10  @DA42853 37810016
DERECD10 EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 37820016
*                                                              @DERPDGL 37830016
.NOSUP42 ANOP                                                  @D61ADJK 37840016
*   DATA CHECK 11                                              @DERPDGL 37850016
 DC AL1(DERRA1AM,10,DERASSMP,0,DERRA3DC,0)                D11  @DA42853 37860016
DERECD11 EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 37870016
*                                                              @DERPDGL 37880016
*   UNRECOGNIZED ERROR CONDITION                               @DERPDGL 37890016
 DC AL1(DERRA1AM+DERRA1OR,10,DERASSMP,0,0,0)              URE  @D51TDPM 37900016
DERECURE EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 37910016
*                                                              @DERPDGL 37920016
*   RECOVERY ERROR                                             @DERPDGL 37930016
 DC AL1(0,0,0,0,0,0)                                      RE   @D51TDPM 37940016
DERECRE  EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 37950016
*                                                              @DERPDGL 37960016
*   INVALID SENSE DATA                                         @DERPDGL 37970016
 DC AL1(DERRA1OR,0,0,0,0,0)                               SNS  @D51TDPM 37980016
DERECSNS EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 37990016
*                                                              @DERPDGL 38000016
*   FIRST LOGGED ERROR, NOT 3380 / 3390                        @DERPDGL 38010016
 DC AL1(DERRA1IR+DERRA1IM,10,DERASSMP,0,0,0)              FLN  @D51TDPM 38020016
DERECFLN EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 38030016
*                                                              @DERPDGL 38040016
         AGO   .NOSUP43                                        @D61ADJK 38050016
*   DATA CHECK 13                                              @DERPDGL 38060016
 DC AL1(DERRA1AM+DERRA1OR,10,DERASSMP,0,DERRA3DC,0)       D13  @DERPDGL 38070016
DERECD13 EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 38080016
*                                                              @DERPDGL 38090016
.NOSUP43 ANOP                                                  @D61ADJK 38100016
*   PINNED DATA, INFORMATIONAL                                 @DERPDGL 38110016
 DC AL1(DERRA1IM+DERRA1IR,255,DERASSMP,0,0,DERRA4NS)      PDI  @D61ADJK 38120016
DERECPDI EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 38130016
*                                                              @DERPDGL 38140016
*   DATA CHECK RECOVERED ON SECONDARY                          @DERPDGL 38150016
 DC AL1(DERRA1IM+DERRA1IR,255,DERASSMP,DERRA2BD,DERRA3DC,0) DRS@D52WSPM 38160016
DERECDRS EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 38170016
*                                                              @DERPDGL 38180016
*   SUBSYSTEM STORAGE NOTIFICATION                             @DERPDGL 38190016
 DC AL1(DERRA1AM+DERRA1IR,255,DERASSMP,0,0,0)             SSN  @D52WSPM 38200016
DERECSSN EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 38210016
*                                                              @DERPDGL 38220016
*   OPERATION TERMINATION                                      @DERPDGL 38230016
 DC AL1(DERRA1AM,255,DERASSMP,0,0,0)                      OT   @DA42853 38240016
DERECOT  EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 38250016
*                                                              @DERPDGL 38260016
*   PINNED DATA, NOT INFORMATIONAL                             @DERPDGL 38270016
 DC AL1(DERRA1AM+DERRA1OR,0,0,DERRA2US,0,0)               PDN  @D52WSPM 38280016
DERECPDN EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 38290016
*                                                              @DERPDGL 38300016
*   FORCED LOGGING EVENT                                       @DERPDGL 38310016
 DC AL1(DERRA1AM+DERRA1IR,255,DERASSMP,0,0,DERRA4MD)      FLE  @D52WSBH 38320016
DERECFLE EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 38330016
*                                                              @DERPDGL 38340016
*   CORRECT. DATA CHECK  IN COMPATIBILITY SENSE                @DERPDGL 38350016
 DC AL1(DERRA1AM,0,DERASCA6,0,DERRA3DC,0)                 CDC  @DERPDGL 38360016
DERECCDC EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 38370016
*                                                              @DERPDGL 38380016
*   PERMANENT DATA CHECK IN COMPATIBILITY SENSE                @DERPDGL 38390016
 DC AL1(DERRA1AM+DERRA1OR,10,DERASSMP,DERRA2BD,DERRA3DC,0) DCP @DERPDGL 38400016
DERECDCP EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 38410016
*                                                              @DERPDGL 38420016
*   DATA CHECK IN COMPATIBILITY SENSE                          @DERPDGL 38430016
 DC AL1(DERRA1AM+DERRA1OR,10,DERASCA5,DERRA2BD,DERRA3DC,0) DCS @DERPDGL 38440016
DERECDCS EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 38450016
*                                                              @DERPDGL 38460016
*   BASIC OVERRUN        IN COMPATIBILITY SENSE                @DERPDGL 38470016
 DC AL1(DERRA1AM+DERRA1OR,10,DERASCA5,0,0,0)              BOC  @DERPDGL 38480016
DERECBOC EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 38490016
*                                                              @DERPDGL 38500016
*   SIMPLE EQUIP. CHECK  IN COMPATIBILITY SENSE                @DERPDGL 38510016
 DC AL1(DERRA1AM+DERRA1OR,10,DERASCA5,DERRA2BD,0,0)       ECC  @DERPDGL 38520016
DERECECC EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 38530016
*                                                              @DERPDGL 38540016
*   EQUIPMENT CHECK+ENV.DATA PRESENT OR                        @DERPDGL 38550016
*   EQUIPMENT CHECK+PERMANENT ERROR  IN 24+8 COMP. SENSE       @DERPDGL 38560016
 DC AL1(DERRA1AM+DERRA1OR,255,DERASSMP,DERRA2BD,0,0)      EEC  @DERPDGL 38570016
DERECEEC EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 38580016
*                                                              @DA42666 38590016
*   ATTENTION PRESENTED ON VM SET SPECIAL INTERCEPT CONDITION  @DA42666 38600016
*   ON DEDICATED DASD (VSE RUNNING UNDER VM)                   @DA42666 38610016
 DC AL1(0,0,0,DERRA2SR,0,0)                               VMS  @D61ADJK 38620016
DERECVMS EQU   (*-DERRATB)/DERRATBL                            @DA42666 38630016
*                                                              @D61ADJK 38640016
*   COMMAND REJECT CAUSED BY VM SET SPECIAL INTERCEPT          @D61ADJK 38650016
*   CONDITION ON DEDICATED DASD (VSE RUNNING UNDER VM)         @D61ADJK 38660016
 DC AL1(DERRA1AM,10,DERASSMP,0,0,DERRA4NS)                VMC  @D61ADJK 38670016
DERECVMC EQU   (*-DERRATB)/DERRATBL                            @D61ADJK 38680016
*                                                              @D61ADJK 38690016
*   DASD FAST WRITE INHIBITED ERROR  IN 24+8 COMP. SENSE       @D61ADJK 38700016
 DC AL1(DERRA1AM,255,DERASSMP,DERRA2BD,0,0)               FWI  @D61ADJK 38710016
DERECFWI EQU   (*-DERRATB)/DERRATBL                            @D61ADJK 38720016
*                                                              @DERPDGL 38730016
*    ERRORS FROM THE ECKD PROGRAM ACTION CODE EVALUATION       @DERPDGL 38740016
*                                                              @DERPDGL 38750016
*   DEFAULT ENTRY FOR COMPOUND PROGRAM ACTION CODE IN BYTE 25  @DERPDGL 38760016
 DC AL1(0,0,0,0,0,0)                                           @D51TDPM 38770016
DERSIPDF EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 38780016
*                                                              @DERPDGL 38790016
*   NO ERROR INDICATED. LOOK AT 22/23 FOR CCB BIT SETTING HINTS@DERPDGL 38800016
 DC AL1(0,0,0,DERRA2SR,0,0)                                    @D51TDPM 38810016
DERSIPNE EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 38820016
*                                                              @DERPDGL 38830016
*   PERMANENT ERROR INDICATED. LOOK AT 22/23 FOR CCB BITS      @DERPDGL 38840016
 DC AL1(0,0,0,DERRA2US,0,0)                                    @D51TDPM 38850016
DERSIPPE EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 38860016
*                                                              @DERPDGL 38870016
*   INTERVENTION REQUIRED                                      @DERPDGL 38880016
 DC AL1(DERRA1AM,1,DERASIRQ,0,0,0)                             @D51TDPM 38890016
DERSIPIR EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 38900016
*                                                              @DERPDGL 38910016
*   UNCONDITIONAL RESERVE  BROKE PREVIOUS RESERVATION          @DERPDGL 38920016
 DC AL1(0,0,DERASUNR,0,0,0)                                    @D51TDPM 38930016
DERSIPUR EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 38940016
*                                                              @DERPDGL 38950016
*   DEFINE EXTENT HAD A CKD CONVERSION MODE AND FAILED         @DERPDGL 38960016
 DC AL1(0,0,0,DERRA2US,0,0)                                    @D51TDPM 38970016
DERSIPCK EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 38980016
*                                                              @DERPDGL 38990016
*   UNIT CHECK IS NOT RELATED TO CURRENT CCW CHAIN             @DERPDGL 39000016
 DC AL1(0,255,DERASSMP,0,0,0)                                  @D51TDPM 39010016
DERSIPUN EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 39020016
*                                                              @DERPDGL 39030016
*   END OF CYLINDER DETECTED SOMEHOW.                          @DERPDGL 39040016
 DC AL1(0,0,0,DERRA2SR,DERRA3EO,0)                             @D51TDPM 39050016
DERSIPEO EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 39060016
*                                                              @DERPDGL 39070016
*   EXTENT VIOLATION BY SOME COMMAND (BASIC FILE PROTECT)      @DERPDGL 39080016
 DC AL1(0,0,0,DERRA2US,0,0)                                    @D51TDPM 39090016
DERSIPEV EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 39100016
*                                                              @DERPDGL 39110016
*   RESET NOTIFICATION CAME IN. PATH GROUPS MAY BE RESET.      @DERPDGL 39120016
 DC AL1(DERRA1AR+DERRA1AM,255,DERASRSN,0,0,0)                  @D51TDPM 39130016
DERSIPRE EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 39140016
*                                                              @DERPDGL 39150016
*   SPECIAL INTERCEPT CONDITION  (WITH CONDITION BEING RESET)  @DERPDGL 39160016
 DC AL1(0,10,DERASSMP,0,0,0)                                   @D61ADJK 39170016
DERSIPIL EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 39180016
*                                                              @DERPDGL 39190016
*   SPECIAL INTERCEPT CONDITION  (WITH CONDITION STILL SET)    @DERPDGL 39200016
 DC AL1(0,0,0,DERRA2SR,0,0)                                    @D61ADJK 39210016
DERSIPIN EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 39220016
*                                                              @DERPDGL 39230016
*   RETRY DONE IN PCI FETCH MODE. DATA IN STORAGE MAY BE FALSE @DERPDGL 39240016
 DC AL1(0,0,DERASCA6,0,DERRA3DC,0)                             @DERPDGL 39250016
DERSIPCI EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 39260016
*                                                              @DERPDGL 39270016
*   LONG BUSY INDICATED (STATE CHANGE PENDING)                 @DERPDGL 39280016
 DC AL1(0,0,0,DERRA2US,DERRA3SC,0)                             @DERPDGL 39290016
DERSIPCP EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 39300016
*                                                              @DERPDGL 39310016
*   MODIFIED TRACK FOUND IN CACHE ON WRITE COMMAND.            @DERPDGL 39320016
 DC AL1(DERRA1AM,255,DERASSMP,0,0,0)                           @DA43510 39330000
DERSIPMT EQU   (*-DERRATB)/DERRATBL                            @DERPDGL 39340016
*                                                                       39350016
*                                                              @DERPDGL 39360016
DERRATBN EQU   (*-DERRATB)/DERRATBL      # OF ENTRIES IN TABLE @D52WSBH 39370016
*                                                              @DERPDGL 39380016
***************************************************************         39390016
*  FUNCTION                                                    @D51TDPM 39400016
*     SET RB TO ZERO OR THE ADDRESS OF THE USER'S CCB.         @D51TDPM 39410016
*                                                              @D51TDPM 39420016
*     IF DSK IS PROCCESING A MINIMAL ERP REQUEST OR AN I/O     @D51TDPM 39430016
*     REQUEST WAS POSTED BEFORE THE UNIT CHECK STATUS, THEN    @D51TDPM 39440016
*     SET RB TO ZERO.  IF THE USER CCB IDENTIFIED BY THE INPUT @D51TDPM 39450016
*     ERROR BLOCK IS NOT ACCESSIBLE THEN SET RB TO ZERO.       @D51TDPM 39460016
*     OTHERWISE SET RB TO THE ADDRESS OF THE USER'S CCB        @D51TDPM 39470016
*     GIVEN IN THE ERROR BLOCK.                                @D51TDPM 39480016
*                                                              @D51TDPM 39490016
*  INPUT                                                       @D51TDPM 39500016
*    - R2 CONTAINS AN ADDRESS OF AN ERROR BLOCK.               @D51TDPM 39510016
*                                                              @D51TDPM 39520016
*  OUTPUT                                                      @D51TDPM 39530016
*    - RB CONTAINS THE ADDRESS OF THE USER'S CCB OR ZERO.      @D51TDPM 39540016
*                                                              @D51TDPM 39550016
***************************************************************         39560016
 AGO  .GUCCB                                                  *#SECURGL 39570016
.LUCCB   AIF ('&TEST'(1,14) NE 'CALL  DERUCCB ').LMKSFM       *#SECURGL 39580016
 AIF   ('&I'(2,2)  NE '2 '                     ).DSINVC       *#SECURGL 39590016
 AIF   ('&O'(2,2)  EQ 'B '                     ).DSHEAD       *#SECURGL 39600016
 AGO  .DSINVC                                                 *#SECURGL 39610016
.GUCCB    ANOP                                                *#SECURGL 39620016
.**************************************************************         39630016
DERUCCB  SGDSK 'HEADING        ','START OF CODEBLOCK'          @DERPDGL 39640016
         USING ERBLKADR,R2                                     @D51TDPM 39650016
*                                                              @D51TDPM 39660016
*   GET THE ADDRESS OF THE USER'S CCB.  FIRST, OBTAIN THE      @D51TDPM 39670016
*   ADDRESS OF THE UCCB FROM THE INPUT ERROR BLOCK.  SECOND,   @D51TDPM 39680016
*   IF A UCCB EXISTS, CHECK IT FOR ADDRESSABILITY.             @D51TDPM 39690016
*                                                              @D51TDPM 39700016
         SLR  RB,RB               ASSUME CCB NOT ACCESSIBLE    #DEBUGGL 39720016
         OI   DEROEFL1,DEROEUCU   ASSUME IT ALSO IN FLAGBITS   @DERPDGL 39730016
         OI   ERRQFLG,IGNERR      ASSUME IT FOR MESSAGES       @DERPDGL 39740016
         TM   DEROEFL1,DEROEMEL+DEROEUIC BRANCH IF MINIMAL ERP @D51TDPM 39750016
         BNZ  DERUB100              OR UNSOLICITED.            @D51TDPM 39760016
         SLR  R8,R8               GET THE USER'S CCB           @D51TDPM 39780016
         ICM  R8,B'0111',ERRQCCB+1  ADDRESS.                   @D51TDPM 39790016
         BZ   DERUB100            BRANCH IF USER IS POSTED     @D51TDPM 39800016
*                                                              @D51TDPM 39820016
*   IS THE USER'S CCB IN REAL STORAGE?                         @D51TDPM 39830016
*                                                              @D51TDPM 39840016
 SGDSK  'CALL  DERCVTVR        ','CONVERT VIRTUAL TO REAL',    @DERPDGLX39850016
               I='8                 ON RETURN',                @DERPDGLX39860016
               O='F                 RF IS REAL OR 0 '          @DERPDGL 39870016
         LTR   RF,RF              BRANCH WHEN THE FIRST BYTE...@D51TDPM 39880016
         BZ    DERUBERR             IS NOT ADDRESSABLE.        @D51TDPM 39890016
         LR    R1,R8              COULD THE OTHER              #DEBUGGL 39910016
         LA    RF,15(,R8)           PART OF THE CCB BE         @D66ADAP 39920016
         N     RF,PADDRMSK          ON ANOTHER                 @DERPDGL 39930016
         N     R1,PADDRMSK          REAL PAGE                  @DERPDGL 39940016
         CR    RF,R1                IN MEMORY??                @DERPDGL 39950016
         BE    DERUB040           BRANCH IF NOT                @DERPDGL 39960016
         LA    R8,15(,R8)         POINT TO END OF CCB IN VIRT. @D66ADAP 39980016
 SGDSK  'CALL  DERCVTVR        ','CONVERT VIRTUAL TO REAL',    @DERPDGLX39990016
               I='8                 ON RETURN',                @DERPDGLX40000016
               O='F                 RF IS REAL OR 0 '          @DERPDGL 40010016
         LTR   RF,RF              BRANCH WHEN THE LAST BYTE... @DERPDGL 40020016
         BZ    DERUBERR             IS NOT ADDRESSABLE.        @DERPDGL 40030016
*                                                              @DERPDGL 40040016
DERUB040 ICM   RB,B'0111',ERRQCCB+1        KEEP THAT USER CCB  @DERPDGL 40050016
         NI    DEROEFL1,XFF-DEROEUCU         IS ADDRESSABLE    @DERPDGL 40060016
.*                                                             @DERPDGL 40070016
.*    SINCE THE USER CCB IS ADDRESSABLE WE SHOULD NOT          @DERPDGL 40080016
.*    ISSUE OUR MESSAGES AS 0P..I I (INFORMATION IGNORE)       @DERPDGL 40090016
.*    MESSAGES.                                                @DERPDGL 40100016
*                                                              @DERPDGL 40110016
         NI    ERRQFLG,XFF-IGNERR          NO FURTHER I I MSGS @DERPDGL 40120016
*                                                              @DERPDGL 40130016
         TM    CCBCLS-CCBADR(RB),CCBCOPY   KEEP A BIT IF       @DERPDGL 40140016
         BNO   DERUB050                      USER CCB IS A     @DERPDGL 40150016
         OI    DERFLG1,DERCVUCC              COPIED CCB        @DERPDGL 40160016
DERUB050 DS    0H                                              @DERPDGL 40180016
*                                                              @DERPDGL 40190016
         TM    CCBCOM2-CCBADR(RB),CHNBIT   KEEP IN MIND IF THE @DERPDGL 40200016
         BNO   DERUB060                      USER INDICATED    @DERPDGL 40210016
         OI    DERFLG1,DERCVUCH              SELF MODIF.CCWS   @DERPDGL 40220016
DERUB060 DS    0H                                              @DERPDGL 40240016
*                                                              @DERPDGL 40250016
DERUB100 SGDSK 'RETURN         ','RETURN TO CALLER         ',  @DERPDGLX40260016
               OUTPUT=(RB)                                     @DERPDGL 40270016
DERUBERR DS    0H                                              @KD40391 40280016
         B     DERUB100                                        @KD40391 40300016
         DROP  ,                                               @D66ADAP 40310016
         USING SYSS00,R0                                       @D66ADAP 40320016
         LTORG                                                 @D51TDPM 40330016
*                                                                       40340016
***************************************************************         40350016
*  FUNCTION                                                    @D51TDPM 40360016
*     MAKE THE SET FILE MASK CCWS IN DERCCWF1,2 AND 3.         @D51TDPM 40370016
*                                                              @D51TDPM 40380016
*  INPUT                                                       @D51TDPM 40390016
*    - R3 CONTAINS THE PUB ADDRESS OF THE DEVICE IN QUESTION   @D51TDPM 40400016
*                                                              @D51TDPM 40410016
*  OUTPUT                                                      @D51TDPM 40420016
*    - DERCCWF1,2 AND 3 ARE SET.                               @D51TDPM 40430016
*                                                              @D51TDPM 40440016
***************************************************************         40450016
 AGO  .GMKSFM                                                 *#SECURGL 40460016
.LMKSFM  AIF ('&TEST'(1,14) NE 'CALL  DERMKSFM').LALLOC       *#SECURGL 40470016
 AIF   ('&I'(2,2)  NE '3 '                     ).DSINVC       *#SECURGL 40480016
 AIF   ('&O'(2,4)  EQ 'NONE'                   ).DSHEAD       *#SECURGL 40490016
 AGO  .DSINVC                                                 *#SECURGL 40500016
.GMKSFM   ANOP                                                *#SECURGL 40510016
.**************************************************************         40520016
DERMKSFM SGDSK 'HEADING        ','START OF CODEBLOCK'          @DERPDGL 40530016
         USING PUBADR,R3                                       @D51TDPM 40540016
*                                                              @D51TDPM 40560016
         MVI   DERSFMSK,X'00'     SET DEFAULT VALUES           @D51TDPM 40570016
         MVI   DERSFM,NOP         USE NO-OPERATION OPCODE.     @D51TDPM 40580016
*                                                              @D51TDPM 40590016
         CLI   PUBDEVTY,TFBA      BRANCH WHEN ERROR IS ON AN...@D37ADDK 40600016
         BE    DERMKS10             FBA DEVICE.                @D51TDPM 40610016
         CLC   DERTID,ARTIDH      BRANCH WHEN A SUPERVISOR     @D66CDAP 40620016
         BNH   DERMKS10             I/O REQUEST.               @D51TDPM 40630016
         TM    DERCHQGV,DERCHQFP  BRANCH WHEN FILE PROTECTION..@D51TDPM 40640016
         BZ    DERMKS10             IS NOT NEEDED.             @D51TDPM 40650016
*                                                              @D51TDPM 40660016
         MVI   DERSFM,SFM         USE SET FILE MASK OPCODE.    @D51TDPM 40680016
         LR    R5,R3              COPY PUB POINTER             @D51TDPM 40690016
         SH    R5,YPUBTAB         GET OFFSET IN PUBTAB         @D51TDPM 40700016
         SRL   R5,1               DIVIDE BY TWO                @D51TDPM 40710016
         A     R5,APBXAREA        ADDRESS OF PUBX ADDRESSES    @D51TDPM 40720016
         L     R5,0(R5)           GET PUBX POINTER             @D51TDPM 40730016
         USING PBXADR,R5          DECLARE PUBX BASE            @D51TDPM 40740016
         L     R5,PBXCCW          GET ADDR OF PROTECT CCW      @D51TDPM 40750016
         USING FPCCWADR,R5        DECLARE FILE PROT CCW BASE   @D51TDPM 40760016
         MVC   DERSVMSK,FPCCWMSK  GET FILE PROTECT MASK        @D51TDPM 40770016
         MVC   DERSFMSK,DERSVMSK  SAVE FILE PROTECT MASK       @D51TDPM 40780016
         DROP  R5                 DROP FILE PROTECT CCW BASE   @D51TDPM 40790016
*                                                              @DERPDGL 40800016
DERMKS10 MVC   DERCCWF1,DERSFM    SET UP FILE MASK...          @DA34685 40810016
         MVC   DERCCWF2,DERSFM      OR NOP...                  @DA25514 40820016
         MVC   DERCCWF3,DERSFM      CCWS.                      @DA25514 40830016
*                                                              @D51TDPM 40840016
DERMKSEX SGDSK 'RETURN         ','RETURN TO CALLER'            @DERPDGL 40850016
         DROP  ,                                               @D66ADAP 40860016
         USING SYSS00,R0                                       @D66ADAP 40870016
         LTORG                                                 @D51TDPM 40880016
*                                                                       40890016
***************************************************************         40900016
* FUNCTION                                                     @D51TDPM 40910016
*    OBTAIN AN ERROR BLOCK FROM A NUMBER OF WORK ERROR         @D51TDPM 40920016
*    BLOCKS. THESE ERROR BLOCKS ARE VEHICLES OF COMMUNICATION  @D51TDPM 40930016
*    WITH THE ERP SYSTEM TASK.                                 @D51TDPM 40940016
*                                                              @D51TDPM 40950016
* INPUT                                                        @D51TDPM 40960016
*    - NONE                                                    @D51TDPM 40970016
*                                                              @D51TDPM 40980016
* OUTPUT ON RETURN TO RETURN+4                                 @D51TDPM 40990016
*    - RF CONTAINS A FREE DEVICE ERROR ENTRY ADDRESS.          @D51TDPM 41000016
* OUTPUT ON RETURN TO RETURN+0                                 @D51TDPM 41010016
*    - NONE. NO FREE ERROR BLOCK ALLOCATED.                    @D51TDPM 41020016
*                                                              @D51TDPM 41030016
***************************************************************         41040016
 AGO  .GALLOC                                                 *#SECURGL 41050016
.LALLOC  AIF ('&TEST'(1,14) NE 'CALL  DERALLOC').LERP         *#SECURGL 41060016
 AIF   ('&I'(2,4)  NE 'NONE'                   ).DSINVC       *#SECURGL 41070016
 AIF   ('&O'(2,2)  NE 'F '                     ).DSINVC       *#SECURGL 41080016
 AIF   (T'&E0      NE 'O'                      ).DSHEAD       *#SECURGL 41090016
 AGO  .DSINVC                                                 *#SECURGL 41100016
.GALLOC   ANOP                                                *#SECURGL 41110016
.**************************************************************         41120016
DERALLOC SGDSK 'HEADING        ','START OF CODEBLOCK'          @DERPDGL 41130016
         USING ERBLKADR,R2                                     @D51TDPM 41140016
*                                                              @D51TDPM 41150016
*   ATTEMPT TO ACQUIRE A MESSAGING AND RECORDING ERROR BLOCK.  @D51TDPM 41160016
*                                                              @D51TDPM 41170016
         LA    R5,DERAEB          FIRST ERROR BLOCK.           @D51TDPM 41190016
         LA    R8,ERBLKHDL+L'ERRQ LENGTH OF AN ERROR BLOCK.    @D51TDPM 41200016
         LA    R9,DERAEBE         LAST ERROR BLOCK.            @D51TDPM 41210016
*                                                              @D51TDPM 41220016
DERAL010 TM    ERBLKFLG-ERBLKADR(R5),ERACTIVE                  @D51TDPM 41230016
         BNO   DERAL020                                        @D51TDPM 41240016
         BXLE  R5,R8,DERAL010                                  @D51TDPM 41260016
         B     DERALEX0                                               * 41270016
*                                                              @D51TDPM 41280016
DERAL020 LR    RF,R5              BRANCH WHEN AN ERROR BLOCK...@D51TDPM 41290016
DERALEX4 DS    0H                                              @DERPDGL 41300016
         SGDSK 'RETURN4        ','RETURN TO CALLER         ',  @DERPDGLX41320016
               OUTPUT=(RF)                                     @DERPDGL 41330016
DERALEX0 DS    0H                                              @DERPDGL 41340016
         SGDSK 'RETURN         ','RETURN TO CALLER         '   @DERPDGL 41360016
         DROP  ,                                               @D66ADAP 41370016
         USING SYSS00,R0                                       @D66ADAP 41380016
*                                                                       41390016
*   LIST OF ALLOCATABLE ERROR BLOCKS.                          @D51TDPM 41400016
*                                                              @D51TDPM 41410016
         DC   C' DERAEB:'                                      @DERPDGL 41420016
DERAEB   DC   14XL(ERBLKHDL+L'ERRQ)'00'                        @D51TDPM 41430016
DERAEBE  DC   XL(ERBLKHDL+L'ERRQ)'00'  LAST ERROR BLOCK.       @D51TDPM 41440016
         LTORG                                                 @D51TDPM 41450016
*                                                                       41460016
***************************************************************         41470016
* FUNCTION                                                     @D51TDPM 41480016
*    FILL UP SOME FIELDS IN THE ERROR ENTRY POINTED TO BY      @D51TDPM 41490016
*    REGISTER R2. IF IT IS NOT THE GENERAL WORK ERROR BLOCK    @D51TDPM 41500016
*    QUEUE THE ERROR ENTRY IN THE CHAIN FOR LATER POSTING.     @D51TDPM 41510016
*    IF REGISTER R2 DOES NOT POINT TO AN ERROR BLOCK BUT       @D51TDPM 41520016
*    CONTAINS ZERO, GO AHEAD FOR POSTING.                      @D51TDPM 41530016
*                                                              @D51TDPM 41540016
* INPUT                                                        @D51TDPM 41550016
*    - R2 POINTS TO AN ERROR BLOCK.                            @D51TDPM 41560016
*                                                              @D51TDPM 41570016
* OUTPUT                                                       @D51TDPM 41580016
*    - NONE                                                    @D51TDPM 41590016
*                                                              @D51TDPM 41600016
***************************************************************         41610016
 AGO  .GERP                                                   *#SECURGL 41620016
.LERP    AIF ('&TEST'(1,14) NE 'CALL  DERERP  ').LSDR         *#SECURGL 41630016
 AIF   ('&I'(2,2)  NE '2 '                     ).DSINVC       *#SECURGL 41640016
 AIF   ('&O'(2,4)  EQ 'NONE'                   ).DSHEAD       *#SECURGL 41650016
 AGO  .DSINVC                                                 *#SECURGL 41660016
.GERP     ANOP                                                *#SECURGL 41670016
.**************************************************************         41680016
DERERP   SGDSK 'HEADING        ','START OF CODEBLOCK'          @DERPDGL 41690016
         USING ERBLKADR,R2                                     @D51TDPM 41700016
         LTR    R2,R2             BRANCH IF THIS INVOCATION    @DERPDGL 41720016
         BZ     DERER040            IS FOR REAL POSTING        @DERPDGL 41730016
*                                                              @D51TDPM 41740016
*   ENQUEUE FOR LATER POSTING TO ERP TASK                      @D51TDPM 41750016
*                                                              @D51TDPM 41760016
         NI   ERBLKFL1,X'FF'-NEEDTASK  THE ERP TASK WILL BE... @D51TDPM 41770016
         OI   ERBLKFL1,NEEDERP           POSTED.               @D51TDPM 41780016
*                                                              @D51TDPM 41790016
*  INVOKE ERP TASK TO QUEUE DEVICE ERROR ENTRY TO ITS CHAIN.   @D51TDPM 41800016
*                                                              @D51TDPM 41810016
         NI    ERBLKFLG,X'FF'-ERQUEUED  RESET QUEUED STATUS.   @D51TDPM 41820016
         LA    R9,DERINWRK        IF THIS IS THE WORK ERROR    @DERPDGL 41830016
         CR    R2,R9              BLOCK WE WANT TO PASS ON     @DERPDGL 41840016
         BE    DERER020           EXIT, DO NOT INVOKE ERP      @DERPDGL 41850016
         LA    R5,DERQUDEB-(ERBLKPTR-ERBLKADR)                 @DERPDGL 41870016
         L     R9,DERQUDEB        ENQUEUE IT IN CHAIN OF       @DERPDGL 41880016
DERER005 LTR   R9,R9                                           @DERPDGL 41890016
         BZ    DERER010                                        @DERPDGL 41900016
         LR    R5,R9                                           @DERPDGL 41920016
         L     R9,ERBLKPTR-ERBLKADR(,R9)                       @DERPDGL 41930016
         B     DERER005                                        @DERPDGL 41940016
DERER010 ST    R2,ERBLKPTR-ERBLKADR(,R5)  TO BE POSTED         @DERPDGL 41950016
         XC    ERBLKPTR,ERBLKPTR                               @DERPDGL 41960016
         OI    ERRQFLG,RECONLY    FOR RECONLY SEE DESCR. ABOVE @DERPDGL 41970016
         OI    ERBLKFLG,ERQUEUED  TELL ITS QUEUED              @D51TDPM 41980016
*                                                              @DERPDGL 41990016
* IN AN ASYNCHRONOUS MESSAGE, THE MESSAGE WRITER CANNOT       *@D51TDPM 42000016
* GET THE VIRTUAL CCB ADDRESS FROM THE REAL ONE, SO WE DO THE *@D51TDPM 42010016
* CONVERSION NOW AND SUPPLY VIRTUAL TO THE MESSAGE WRITER.    *@D51TDPM 42020016
*                                                              @DERPDGL 42030016
DERER020 TM    ERRQFLG,RECONLY    SKIP TRANSLATION IF NOT AN   @D52WSBH 42040016
         BNO   DERERPEX             ASYNCHRONOUS REQUEST       @D52WSBH 42050016
         TM    DEROEFL1,DEROEUCU  BRANCH WHEN I/O HAS...       @D51TDPM 42060016
         BO    DERERPEX             ALREADY BEEN POSTED.       @D51TDPM 42070016
         USING CCBADR,RB                                       @D51TDPM 42080016
         TM    CCBCLS,CCBCOPY     BRANCH WHEN A EXCP REAL...   @D51TDPM 42090016
         BNO   DERERPEX             I/O REQUEST.               @D51TDPM 42100016
         MVC   ERRQCCB+1(3),CCBVA+1 USE THE VIRTUAL CCB ADDR.  @D51TDPM 42120016
         DROP  RB                                              @D51TDPM 42130016
         B     DERERPEX                                        @DERPDGL 42140016
*                                                              @D51TDPM 42150016
DERER040 DS    0H                                              @DERPDGL 42160016
         L     R2,DERQUDEB        TAKE QUEUED IF THERE IS ANY  @DERPDGL 42180016
         LTR   R2,R2                                           @DERPDGL 42190016
         BZ    DERERPEX                                        @DERPDGL 42200016
         MVC   DERQUDEB,ERBLKPTR  PREPARE FOR NEXT IN LOOP     @DERPDGL 42210016
         XC    ERBLKPTR,ERBLKPTR  PURGE QUEUE POINTER          @DERPDGL 42220016
         NI    ERBLKFLG,X'FF'-ERQUEUED  RESET QUEUED STATUS.   @D51TDPM 42230016
         STM   R0,RF,DERDERSV     REGISTERS USED BY INTEQPST.  @D51TDPM 42240016
         L     R9,AINTER          OBTAIN ADDRESSABILITY..      @D51TDPM 42250016
         USING INTRTN,R9            ADDRESSABILITY..           @D51TDPM 42260016
         L     R6,DISPAD            TO THE POSTING..           @D61NDJK 42270016
         L     RD,AINTEQS           ROUTINE...                 @D51TDPM 42280016
         USING INTEQSET,RD          AND CALL..                 @D51TDPM 42290016
         AMODESW SET,AMODE=24,WR=(R7) ENTER 24-BIT ADDR. MODE  @D52VDAP 42300016
         BAL   R7,INTEQPST           IT                        @D14ZDDK 42310016
         DROP  R9,RC                                           @D51TDPM 42320016
         BALR  RA,0               RESTORE GLOBAL AREA          @DERPDGL 42330016
         USING *,RA                                            @DERPDGL 42340016
         ICM   RA,8,=X'00'                                     @DERPDGL 42350016
         AMODESW SET,AMODE=31,WR=(R7) ENTER 31-BIT ADDR. MODE  @D52VDAP 42360016
         L     RA,=A(DERGLOB)     POINTER AND RELOAD           @DERPDGL 42370016
         USING DERGLOB,RA                                      @DERPDGL 42380016
         LM    R0,RE,DERDERSV     ALL REGS                     @DERPDGL 42390016
         USING DERERP,RC                                       @D51TDPM 42400016
         B     DERER040           BRANCH FOR NEXT ERROR ENTRY  @DERPDGL 42410016
*                                                                       42420016
DERERPEX SGDSK 'RETURN         ','RETURN TO CALLER         '   @DERPDGL 42430016
         DROP  ,                                               @D66ADAP 42440016
         USING SYSS00,R0                                       @D66ADAP 42450016
         LTORG                                                 @DERPDGL 42460016
*                                                                       42470016
***************************************************************         42480016
*  FUNCTION                                                    @D51TDPM 42490016
*     TO DETERMINE WHAT KIND OF SDR THE ERP TASK NEEDS TO      @D51TDPM 42500016
*     BUILD.                                                   @D51TDPM 42510016
*                                                              @D51TDPM 42520016
*  INPUT                                                       @D51TDPM 42530016
*    - R2 CONTAINS THE ADDRESS OF AN ERROR BLOCK.              @D51TDPM 42540016
*                                                              @D51TDPM 42550016
*  OUTPUT                                                      @D51TDPM 42560016
*    - ERRQERPF INDICATES WHAT KIND OF RECORD SHOULD BE        @D51TDPM 42570016
*      RECORDED.                                               @D51TDPM 42580016
*                                                              @D51TDPM 42590016
***************************************************************         42600016
 AGO  .GSDR                                                   *#SECURGL 42610016
.LSDR    AIF ('&TEST'(1,14) NE 'CALL  DERSDR  ').LLSTSK       *#SECURGL 42620016
 AIF   ('&I'(2,2)  NE '2 '                     ).DSINVC       *#SECURGL 42630016
 AIF   ('&O'(2,4)  EQ 'NONE'                   ).DSHEAD       *#SECURGL 42640016
 AGO  .DSINVC                                                 *#SECURGL 42650016
.GSDR     ANOP                                                *#SECURGL 42660016
.**************************************************************         42670016
DERSDR   SGDSK 'HEADING        ','START OF CODEBLOCK'          @DERPDGL 42680016
         USING ERBLKADR,R2                                     @D51TDPM 42690016
*                                                              @DERPDGL 42710016
*   RECORD MDR FOR COUNTER OFFLOAD OR FORCED LOGGING EVENT     @DERPDGL 42720016
*                                                              @DERPDGL 42730016
         TM    DERCRRA4,DERRA4MD  BRANCH WHEN AN MDR SHOULD    @DERPDGL 42740016
         BO    DERSD010             BE RECORDED                @DERPDGL 42750016
*                                                              @DERPDGL 42760016
*   RECORD AN ANR FOR ANY SIM PRESENTED ERROR CONDITION.       @DERPDGL 42770016
*                                                              @DERPDGL 42780016
         TM    DERCRRA4,DERRA4SI  BRANCH WHEN A SIM RECORD     @DERPDGL 42790016
         BO    DERSD020             SHOULD BE RECORDED         @DERPDGL 42800016
*                                                              @DERPDGL 42810016
*   OTHERWISE RECORD AN OBR.                                   @DE1TDPM 42820016
*                                                              @D51TDPM 42830016
         OI    ERRQERPF,ERRQPOBR                OBR.           @D51TDPM 42850016
         NI    ERRQERPF,X'FF'-ERRQPSIR-ERRQPMDR NOT ANR OR MDR.@D51TDPM 42860016
         L     R5,DERTYCNT        UPDATE THE RETRY COUNT...    @D51TDPM 42870016
         STC   R5,ERRQNRTY          FOR OBRS.                  @D51TDPM 42880016
         B     DERSDEX                                         @D51TDPM 42890016
DERSD010 EQU   *                                               @D52WSBH 42900016
         OI    ERRQERPF,ERRQPMDR                               @D51TDPM 42920016
         NI    ERRQERPF,X'FF'-ERRQPOBR-ERRQPSIR                @D51TDPM 42930016
         B     DERSDEX                                         @D51TDPM 42940016
DERSD020 EQU   *                                               @D51TDPM 42950016
         OI    ERRQERPF,ERRQPSIR                ANR.           @D51TDPM 42970016
         NI    ERRQERPF,X'FF'-ERRQPOBR-ERRQPMDR NOT OBR OR MDR.@D51TDPM 42980016
*                                                              @D51TDPM 42990016
DERSDEX  SGDSK 'RETURN         ','RETURN TO CALLER         '   @DERPDGL 43000016
         DROP  ,                                               @D66ADAP 43010016
         USING SYSS00,R0                                       @D66ADAP 43020016
         LTORG                                                 @DERPDGL 43030016
*                                                              @D51TDPM 43040016
*                                                                       43050016
***************************************************************         43060016
*  FUNCTION                                                    @D51TDPM 43070016
*     TO FIND THE LAST USED SEEK ADDRESS.                      @D51TDPM 43080016
*                                                              @D51TDPM 43090016
*  INPUT                                                       @D51TDPM 43100016
*    - R1 CONTAINS THE ADDRESS OF A CCB.                       @D51TDPM 43110016
*    - R3 CONTAINS THE ADDRESS OF THE PUB.                     @D51TDPM 43120016
*                                                              @D51TDPM 43130016
*  OUTPUT ON EXIT RETURN PLUS                                  @D51TDPM 43140016
*    - 4  DERLSEEK IN DERGLOB IS SET TO SEEK ADDRESS           @D51TDPM 43150016
*    - 0  DERLSEEK COULD NOT BE CONSTRUCTED. IT IS ZEROED.     @D51TDPM 43160016
*                                                              @D51TDPM 43170016
***************************************************************         43180016
 AGO  .GLSTSK                                                 *#SECURGL 43190016
.LLSTSK  AIF ('&TEST'(1,14) NE 'CALL  DERLSTSK').LGETDT       *#SECURGL 43200016
 AIF   ('&I'(2,4)  NE '1,3 '                   ).DSINVC       *#SECURGL 43210016
 AIF   ('&O'(2,4)  NE 'NONE'                   ).DSINVC       *#SECURGL 43220016
 AIF   (T'&E0      EQ 'O'                      ).DSINVC       *#SECURGL 43230016
 AIF   (T'&E4      EQ 'O'                      ).DSHEAD       *#SECURGL 43240016
 AGO  .DSINVC                                                 *#SECURGL 43250016
.GLSTSK   ANOP                                                *#SECURGL 43260016
.**************************************************************         43270016
DERLSTSK SGDSK 'HEADING        ','START OF CODEBLOCK'          @DERPDGL 43280016
         USING CCBADR,R1                                       @D51TDPM 43290016
         USING PUBADR,R3                                       @D51TDPM 43300016
*                                                              @D51TDPM 43320016
.*  WE CAN ONLY RETRIEVE A SEEK ARGUMENT IF THE USER DID NOT   @D61ADJK 43330016
.*  INDICATE, THAT THE CHAIN IS SELF MODIFYING.                @D61ADJK 43340016
.*                                                             @D61ADJK 43350016
         TM    DERFLG1,DERCVUCH   BRANCH IF USER SPECIFIED     @D61ADJK 43360016
         BO    DERLSEX0             CHNBIT IN CCB. SEEK MODIF.?@D61ADJK 43370016
*                                                              @D61ADJK 43380016
         XC    DERLSEEK,DERLSEEK                               @D51TDPM 43390016
         CLI   PUBDEVTY,TFBA      IS IT A FBA DEVICE           @D37ADDK 43400016
         BE    DERLSEX4           YES  SKIP CKD CODE           @D37ADDK 43410016
*                                                              @D51TDPM 43420016
         LA    R9,SEEK            LOOK FOR LAST SEEK.          @DERPDGL 43430016
 SGDSK  'CALL  DERSCAN         ','FIND THE LAST TIME ITS USED',      GLX43440016
               I='1,9               ON RETURN+4',              @DERPDGLX43450016
               O='5                 R5 POINTS TO FOUND CCW',   @DERPDGLX43460016
               E0='DERLSEX0         ERROR:NO SUCH OPCODE'      @DERPDGL 43470016
         LR    R8,R5                                           @DERPDGL 43480016
*                                                              @DERPDGL 43490016
*                                                              @D51TDPM 43510016
         LA    R5,4               NUMBER OF BYTES TO MOVE      @D14ZDDK 43520016
         LA    R6,2                                            @DERPDGL 43530016
         LA    R7,DERLSEEK                                     @DERPDGL 43540016
 SGDSK  'CALL  DERGETDT        ','GET DATA FROM PARAMETERS ',        GLX43550016
               I='5,6,7,8           ON RETURN+4',              @DERPDGLX43560016
               O='NONE              DATA ARE MOVED TO AREA',   @DERPDGLX43570016
               E0='DERLSEX0         ERROR:DATA NOT ADDR.'      @DERPDGL 43580016
*                                                                       43600016
DERLSEX4 SGDSK 'RETURN4        ','RETURN TO CALLER         '   @DERPDGL 43610016
DERLSEX0 DS    0H                                              @DERPDGL 43620016
         XC    DERLSEEK,DERLSEEK                               @D51TDPM 43630016
         MVI   DERLSEEK,X'80'     INITIALIZE INVALID SEEK ADDR @D14ZDDK 43640016
         SGDSK 'RETURN         ','ERROR EXIT TO CALLER     '   @DERPDGL 43660016
         DROP  ,                                               @D66ADAP 43670016
         USING SYSS00,R0                                       @D66ADAP 43680016
         LTORG                                                 @DERPDGL 43690016
*                                                                       43700016
***************************************************************         43710016
*  FUNCTION                                                    @D51TDPM 43720016
*     FIND AND MOVE A NUMBER OF CCW DATA FROM A CCW, OFFSET    @D51TDPM 43730016
*     AND LENGTH TO A SPECIFIED AREA.                          @D51TDPM 43740016
*                                                              @D51TDPM 43750016
*  INPUT                                                       @D51TDPM 43760016
*    - R8 POINTS TO A CCW.                                     @D51TDPM 43770016
*    - R5 CONTAINS THE LENGTH OF THE DATA TO BE MOVED.         @D51TDPM 43780016
*    - R6 CONTAINS THE OFFSET OF THE FIRST BYTE OF DATA.       @D51TDPM 43790016
*    - R7 POINTER TO THE AREA THAT THE DATA SHALL BE MOVED TO. @D51TDPM 43800016
*                                                              @D51TDPM 43810016
*  OUTPUT ON EXIT RETURN PLUS                                  @D51TDPM 43820016
*    - 4  IF ALL DATA WERE MOVED TO AREA GIVEN BY R7           @D51TDPM 43830016
*    - 0  IF SOME OF THE DATA WERE NOT ADDRESSABLE.            @D51TDPM 43840016
*                                                              @D51TDPM 43850016
***************************************************************         43860016
 AGO  .GGETDT                                                 *#SECURGL 43870016
.LGETDT  AIF ('&TEST'(1,14) NE 'CALL  DERGETDT').LDOREC       *#SECURGL 43880016
 AIF   ('&I'(2,8)  NE '5,6,7,8 '               ).DSINVC       *#SECURGL 43890016
 AIF   ('&O'(2,4)  NE 'NONE'                   ).DSINVC       *#SECURGL 43900016
 AIF   (T'&E0      EQ 'O'                      ).DSINVC       *#SECURGL 43910016
 AIF   (T'&E4      EQ 'O'                      ).DSHEAD       *#SECURGL 43920016
 AGO  .DSINVC                                                 *#SECURGL 43930016
.GGETDT   ANOP                                                *#SECURGL 43940016
.**************************************************************         43950016
DERGETDT SGDSK 'HEADING        ','START OF CODEBLOCK'          @DERPDGL 43960016
         USING CCWADR,R8                                       @D51TDPM 43970016
*                                                              @D51TDPM 43990016
DERGDT10 EQU   *                                               @D14ZDDK 44000016
         LA    R0,0(R5,R6)        FROM-BYTE OFFSET             @D14ZDDK 44010016
         BCTR  R0,0                                            @DERPDGL 44020016
         STM   R0,RF,DERDERSV                                  @D51TDPM 44030016
         L     R6,DISPAD          GET ADDRESSABILITY TO THE... @D51TDPM 44040016
         USING DISP,R6              DISPATCHER.                @D51TDPM 44050016
         AMODESW SET,AMODE=24,WR=(R7) ENTER 24-BIT ADDR. MODE  @D52VDAP 44060016
         BAL   R7,GETDADR         GET DATA ADDRESS             @D14ZDDK 44070016
         DROP  R6,RC                                           @D51TDPM 44080016
         BALR  RA,0                      RESTORE GLOBAL AREA   @DERPDGL 44090016
         USING *,RA                                            @DERPDGL 44100016
         ICM   RA,8,=X'00'                                     @DERPDGL 44110016
         AMODESW SET,AMODE=31,WR=(R7) ENTER 31-BIT ADDR. MODE  @D52VDAP 44120016
         L     RA,=A(DERGLOB)            POINTER AND RELOAD    @DERPDGL 44130016
         USING DERGLOB,RA                                      @DERPDGL 44140016
         LM    R0,RE,DERDERSV            ALL REGS EXCEPT ANSWER@DERPDGL 44150016
         USING DERGETDT,RC               REG OF GETDADR        @D51TDPM 44160016
         LTR   RF,RF              BRANCH IF THE DATA ADDRESS   @D14ZDDK 44170016
         BZ    DERGDTX0             WAS INVALID                @D14ZDDK 44180016
         LA    R4,0(R5,R7)        TO-BYTE ADDRESS              @D14ZDDK 44190016
         BCTR  R4,0                                            @DERPDGL 44200016
         MVC   0(1,R4),0(RF)      MOVE ONE BYTE OF SEEK ADDR   @D14ZDDK 44210016
         BCT   R5,DERGDT10        REPEAT UNTIL 4 BYTES MOVED   @D14ZDDK 44220016
*                                                                       44240016
DERGDTX4 SGDSK 'RETURN4        ','RETURN TO CALLER         '   @DERPDGL 44250016
DERGDTX0 DS    0H                                              @DERPDGL 44260016
         SGDSK 'RETURN         ','ERROR EXIT TO CALLER     '   @DERPDGL 44280016
         DROP  ,                                               @D66ADAP 44290016
         USING SYSS00,R0                                       @D66ADAP 44300016
         LTORG                                                 @DERPDGL 44310016
*                                                                       44320016
***************************************************************         44330016
*  FUNCTION                                                    @D51TDPM 44340016
*     WHEN AN ACTION EXISTS THAT WILL ALLOW RECOVERY FROM THE  @D51TDPM 44350016
*     GIVEN ERROR CONDITION, THAT RECOVERY ACTION IS PERFORMED.@D51TDPM 44360016
*     A COMPLETION CODE WILL INDICATE IF ANY RECOVERY ACTION   @D51TDPM 44370016
*     WAS PERFORMED AND WHETHER THE RECOVERY WAS SUCCESSFUL.   @D51TDPM 44380016
*     WHEN ENTERED, THE USER CCB MUST BE ADDRESSABLE !!!       @D51TDPM 44390016
*                                                              @D51TDPM 44400016
*  INPUT                                                       @D51TDPM 44410016
*    - R1 CONTAINS THE ADDRESS OF THE GIVEN CCB.               @D51TDPM 44420016
*    - R2 CONTAINS ADDRESS OF THE GIVEN ERROR BLOCK.           @D51TDPM 44430016
*    - R3 CONTAINS THE ADDRESS OF THE PUB.                     @D51TDPM 44440016
*    - RB CONTAINS THE ADDRESS OF THE USER CCB (IS ADDRESSABLE)@D51TDPM 44450016
*                                                              @D51TDPM 44460016
*  OUTPUT                                                      @D51TDPM 44470016
*     - RF CONTAINS AN ERROR RECOVERY COMPLETION CODE.         @D51TDPM 44480016
DERRSUC  EQU   X'0000'    SUCCESSFUL RECOVERY                  @D51TDPM 44490016
DERREXH  EQU   X'0004'    RECOVERY EXHAUSTED FOR ORIGINAL ERR  @D51TDPM 44500016
DERRAUC  EQU   X'0008'    ANOTHER UNIT CHECK DURING RECOVERY   @D51TDPM 44510016
DERRUS   EQU   X'000C'    NON UC STATUS RECEIV. ON DSK IO      @DERPDGL 44520016
DERRRE   EQU   X'0010'    INTERNAL PROCESSING ERROR            @D51TDPM 44530016
DERRED   EQU   X'0014'    RETRY INHIBITED BY USER              @D51TDPM 44540016
DERRIR   EQU   X'0018'    RETRY REQ.DUE TO INTERV.REQ.ERROR    @D51TDPM 44550016
*                                                              @D51TDPM 44560016
*    - RB MAY HAVE A ZERO INSTEAD OF A USER CCB IF THIS WAS    @D51TDPM 44570016
*         PAGED OUT                                            @D51TDPM 44580016
*                                                              @D51TDPM 44590016
***************************************************************         44600016
 AGO  .GDOREC                                                 *#SECURGL 44610016
.LDOREC  AIF ('&TEST'(1,14) NE 'CALL  DERDOREC').LRHAO        *#SECURGL 44620016
 AIF   ('&I'(2,8)  NE '1,2,3,B '               ).DSINVC       *#SECURGL 44630016
 AIF   ('&O'(2,4)  EQ 'B,F '                   ).DSHEAD       *#SECURGL 44640016
 AGO  .DSINVC                                                 *#SECURGL 44650016
.GDOREC   ANOP                                                *#SECURGL 44660016
.**************************************************************         44670016
DERDOREC SGDSK 'HEADING        ','START OF CODEBLOCK'          @DERPDGL 44680016
         USING CCBADR,R1                                       @D51TDPM 44690016
         USING ERBLKADR,R2                                     @D51TDPM 44700016
         USING PUBADR,R3                                       @D51TDPM 44710016
         USING UCCBADR,RB                                      @D51TDPM 44720016
*                                                              @D51TDPM 44730016
*   UNCONDITIONAL SURRENDER IS CONSIDERED APPROPRIATE FOR      @D51TDPM 44740016
*     DERRA2US IN DERRATB IS ON                                @DERPDGL 44750016
*                                                              @D51TDPM 44760016
         LA    RF,DERREXH         UNCONDITIONAL SURRENDER.     @D51TDPM 44780016
         TM    DERCRRA2,DERRA2US  BRANCH WHEN UNSUCCESSFUL...  @D51TDPM 44790016
         BO    DERDOEX              RECOVERY APPROPRIATE       @D51TDPM 44800016
*                                                              @D51TDPM 44810016
*   IF NO RECOVERY IS NECESSARY THEN SET THE SUCCESSFUL        @D51TDPM 44820016
*   RECOVERY RETURN CODE.                                      @D51TDPM 44830016
*                                                              @D51TDPM 44840016
         LA    RF,DERRSUC         SUCCESSFUL RECOVERY          @D51TDPM 44860016
         TM    DERCRRA2,DERRA2SR  BRANCH WHEN SUCCESSFUL...    @D51TDPM 44870016
         BO    DERDOEX              RECOVERY IS APPROPRIATE.   @D51TDPM 44880016
*                                                              @D51TDPM 44900016
*   PREPARE A SET FILE MASK CCW.                               @D51TDPM 44910016
*                                                              @D51TDPM 44920016
 SGDSK  'CALL  DERMKSFM        ','SET ALL SFM CCWS',           @DERPDGLX44930016
               I='3                 ON RETURN ',               @DERPDGLX44940016
               O='NONE              DERCCWF1,2 AND 3 ARE SET'  @DERPDGL 44950016
*                                                              @D51TDPM 44960016
*   IT WAS NO SPECIAL CASE IN THE SENSE OF THE LINES ABOVE.    @D51TDPM 44970016
*   NOW JUST EXECUTE WHAT IS GIVEN AS SUBROUTINE IN THE        @D51TDPM 44980016
*   RECOVERY ATTRIBUTE FOR THIS KIND OF ERROR .                @D51TDPM 44990016
*                                                              @D51TDPM 45000016
         LA    RF,DERRRE                                       @DERPDGL 45010016
         SLR   R5,R5                                           @DERPDGL 45020016
         IC    R5,DERCRRAS                                     @DERPDGL 45030016
         B     DERASTAB(R5)                                    @DERPDGL 45040016
DERASTAB B     DERDOEX             NO RECOVERY SUBROUTINE      @DERPDGL 45050016
DERASSMP EQU   (*-DERASTAB)                                    @DERPDGL 45060016
         B     DERTYSMC            SIMPLE RETRY                @DERPDGL 45070016
DERASDWI EQU   (*-DERASTAB)                                    @DERPDGL 45080016
         B     DERDWI              DEVICE WRITE INHIBITED      @DERPDGL 45090016
DERASPWI EQU   (*-DERASTAB)                                    @DERPDGL 45100016
         B     DERPWI              PATH WRITE INHIBITED        @DERPDGL 45110016
DERASIRQ EQU   (*-DERASTAB)                                    @DERPDGL 45120016
         B     DERIRQ              INTERVENTION REQUIRED       @DERPDGL 45130016
DERASC02 EQU   (*-DERASTAB)                                    @DERPDGL 45140016
         B     DERDC02             DATA CHECK 2                @DERPDGL 45150016
DERASC34 EQU   (*-DERASTAB)                                    @DERPDGL 45160016
         B     DERDC34             DATA CHECK 3 4              @DERPDGL 45170016
DERASC05 EQU   (*-DERASTAB)                                    @DERPDGL 45180016
         B     DERDC05             DATA CHECK 5                @DERPDGL 45190016
DERASC67 EQU   (*-DERASTAB)                                    @DERPDGL 45200016
         B     DERDC67             DATA CHECK 6 7              @DERPDGL 45210016
DERASC08 EQU   (*-DERASTAB)                                    @DERPDGL 45220016
         B     DERDC08             DATA CHECK 8                @DERPDGL 45230016
DERASOIO EQU   (*-DERASTAB)                                    @DERPDGL 45240016
         B     DEROIO              OPERAT.INCOMPLETE OVERRUN   @DERPDGL 45250016
DERASOI  EQU   (*-DERASTAB)                                    @DERPDGL 45260016
         B     DEROI               OPERATION INCOMPLETE        @DERPDGL 45270016
DERASBSC EQU   (*-DERASTAB)                                    @DERPDGL 45280016
         B     DERBSC              BASIC SEEK CHECK            @DERPDGL 45290016
DERASFP  EQU   (*-DERASTAB)                                    @DERPDGL 45300016
         B     DERFP               FILE PROTECTED              @DERPDGL 45310016
DERASTCC EQU   (*-DERASTAB)                                    @DERPDGL 45320016
         B     DERTCC              TRACK CONDITION CHECK       @DERPDGL 45330016
DERASCA5 EQU   (*-DERASTAB)                                    @DERPDGL 45340016
         B     DERCA5              24+8 SENSE ERP ACTION 5     @DERPDGL 45350016
DERASCA6 EQU   (*-DERASTAB)                                    @DERPDGL 45360016
         B     DERCA6              PCI FETCH MODE INFORMATION  @DERPDGL 45370016
DERASEOC EQU   (*-DERASTAB)                                    @DERPDGL 45380016
         B     DEREOC              END OF CYLINDER             @DERPDGL 45390016
DERASRSN EQU   (*-DERASTAB)                                    @DERPDGL 45400016
         B     DERRSN              RESET NOTIFICATION          @DERPDGL 45410016
DERASUNR EQU   (*-DERASTAB)                                    @DERPDGL 45420016
*        B     DERUNR              UNCONDITIONAL RESERVE       @D66ADAP 45430019
         B     DERRSN              UNCONDITIONAL RESERVE       @D66ADAP 45431019
DERASCVE EQU   (*-DERASTAB)                                    @DERPDGL 45440016
         B     DERCVE              CORRECTABLE VERIFY ERROR    @DERPDGL 45450016
DERASNRF EQU   (*-DERASTAB)                                    @DERPDGL 45460016
         B     DERNRF              NO RECORD FOUND CONDITION   @DERPDGL 45470016
*                                                              @D51TDPM 45480016
DERDOEX  SGDSK 'RETURN         ','RETURN TO CALLER         ',  @DERPDGLX45490016
               OUTPUT=(RB,RF)                                  @DERPDGL 45500016
*                                                              @DERPDGL 45510016
*-------------------------------------------------------------*@D51TDPM 45520016
*  FUNCTION                                                    @D51TDPM 45530016
*     DO A SIMPLE RETRY AS APPROPRIATE RECOVERY ACTION         @D51TDPM 45540016
*-------------------------------------------------------------*@D51TDPM 45550016
DERTYSMC DS    0H                                              @D52..GL 45560016
 SGDSK  'CALL  DERTYSMP        ','DO A SIMPLE RETRY',          @DERPDGLX45580016
               I='1,2,3,B           ON RETURN',                @DERPDGLX45590016
               O='B,F               RF IS RETURN CODE'         @DERPDGL 45600016
         B     DERDOEX                                         @D51TDPM 45610016
*-------------------------------------------------------------*@D51TDPM 45620016
*  FUNCTION                                                    @D51TDPM 45630016
*    HANDLE A NO RECORD FOUND CONDITION FOR NON ECKD DEVICES   @D51TDPM 45640016
.*   FOR THESE DEVICES IT MAY MAKE SENSE TO REPEAT THE IO      @DERPDGL 45650016
.*   SOME TIMES, SINCE THE NO RECORD FOUND MAY BE CAUSED BY    @DERPDGL 45660016
.*   A DASD MALFUNCTION (NOT LIKELY BUT.. )                    @DERPDGL 45670016
*-------------------------------------------------------------*@D51TDPM 45680016
DERNRF   DS    0H                                              @D52..GL 45690016
         LA    RF,DERRSUC         SUCCESSFUL RECOVERY          @D51TDPM 45710016
         TM    UCCBCOM2,NRFRETRY  BRANCH WHEN USER WANTS NO    @D51TDPM 45720016
         BNO   DERDOEX              RETRY OF NRF.              @D51TDPM 45730016
 SGDSK  'CALL  DERTYSMP        ','DO A SIMPLE RETRY',          @DERPDGLX45750016
               I='1,2,3,B           ON RETURN',                @DERPDGLX45760016
               O='B,F               RF IS RETURN CODE'         @DERPDGL 45770016
         B     DERDOEX                                         @D51TDPM 45780016
*-------------------------------------------------------------*@D51TDPM 45790016
*  FUNCTION                                                    @D51TDPM 45800016
*     HANDLE A CORRECTABLE VERIFY ERROR                        @D51TDPM 45810016
.*  IF THE USER WROTE SOME DATA ON A DASD, AND THE DASD TRIED  @D51TDPM 45820016
.*  TO READ THE DATA BACK, BUT SUCCEEDED ONLY WITH A           @D51TDPM 45830016
.*  CORRECTABLE DATA CHECK, IT INDICATES CORRECTABLE VERIFY    @D51TDPM 45840016
.*  ERROR. NOW, THE USER HAD INHIBITED RETRY OF THE CHANNEL    @D51TDPM 45850016
.*  PROGRAM BY SETTING THE CHNBIT IN THE CCB. WE DO NOT WANT   @D51TDPM 45860016
.*  HIM TO CONSIDER HIS I/O UNSUCCESSFUL, SINCE NEXT TIME HE   @D51TDPM 45870016
.*  WILL GET HIS DATA, EVEN IF WE WILL HAVE TO DO SOME CORR.   @D51TDPM 45880016
.*  ACTION ON IT. SO SET OFF THE UNIT CHECK BIT.               @D51TDPM 45890016
.*                                                             @D51TDPM 45900016
*-------------------------------------------------------------*@D51TDPM 45910016
DERCVE   DS    0H                                              @D52..GL 45920016
 SGDSK  'CALL  DERTYSMP        ','DO A SIMPLE RETRY',          @DERPDGLX45940016
               I='1,2,3,B           ON RETURN',                @DERPDGLX45950016
               O='B,F               RF IS RETURN CODE'         @DERPDGL 45960016
         LTR   RF,RF                                           @DERPDGL 45970016
         BZ    DERDOEX                                         @DERPDGL 45980016
         NI    CCBSTA,XFF-UNITCK                               @DERPDGL 46000016
         LA    RF,DERRSUC                                      @DERPDGL 46010016
         B     DERDOEX                                         @D51TDPM 46020016
*-------------------------------------------------------------*@D51TDPM 46030016
*  FUNCTION                                                    @D51TDPM 46040016
*     RECOVER FROM A DEVICE WRITE INHIBITED ERROR CONDITION.   @D51TDPM 46050016
*-------------------------------------------------------------*@D51TDPM 46060016
DERDWI   DS    0H                                              @D51TDPM 46070016
         CLC   DERTID,ARTIDH      BRANCH WHEN I/O REQUEST IS...@D66CDAP 46090016
         BL    DERDW050             NON-AR SYSTEM I/O REQUEST. @D51TDPM 46100016
         LA    RF,DERREXH         UNCONDITIONAL SURRENDER.     @DERPDGL 46110016
         OI    DERCRRA4,DERRA4DM  ALLOW DECISION MESSAGE.      @DERPDGL 46120016
         B     DERDWEX                                         @D51TDPM 46130016
DERDW050 EQU   *                                               @D51TDPM 46140016
.*       OI    PUBCSFLG,OPINTV    SET INTERVENTION REQUIRED    @D61SDJK 46160000
         LA    RF,DERRIR            INTERVENTION REQUIRED.     @D51TDPM 46170016
DERDWEX  B     DERDOEX                                         @D51TDPM 46180016
*-------------------------------------------------------------*@D51TDPM 46190016
*  FUNCTION                                                    @D51TDPM 46200016
*     RECOVER FROM A PATH WRITE INHIBITED ERROR CONDITION.     @D51TDPM 46210016
*-------------------------------------------------------------*@D51TDPM 46220016
DERPWI   DS   0H                                               @D51TDPM 46230016
 SGDSK  'CALL  DERTYSMP        ','DO A SIMPLE RETRY',          @DERPDGLX46250016
               I='1,2,3,B           ON RETURN',                @DERPDGLX46260016
               O='B,F               RF IS RETURN CODE'         @DERPDGL 46270016
 SGDSK  'CALL  DERPDOWN        ','TAKE ORIGINAL PATH DOWN',    @DERPDGLX46280016
               I='3                 *',                        @DERPDGLX46290016
               O='NONE              *'                         @DERPDGL 46300016
DERPWEX  B     DERDOEX                                         @D51TDPM 46310016
*-------------------------------------------------------------*@D51TDPM 46320016
*  FUNCTION                                                    @D51TDPM 46330016
*     RECOVER FROM THE VARIOUS INTERVENTION REQUIRED ERROR     @D51TDPM 46340016
*     CONDITIONS.                                              @D51TDPM 46350016
*-------------------------------------------------------------*@D51TDPM 46360016
DERIRQ   DS    0H                                              @D51TDPM 46370016
 SGDSK  'CALL  DERTYSMP        ','DO A SIMPLE RETRY',          @DERPDGLX46390016
               I='1,2,3,B           ON RETURN',                @DERPDGLX46400016
               O='B,F               RF IS RETURN CODE'         @DERPDGL 46410016
         LA    R5,4                                            @D52..GL 46420016
         CR    RF,R5                                           @D52..GL 46430016
         BNE   DERIR10                                         @D52..GL 46440016
         LA    RF,DERRIR          INDICATE INTERVENTION        @D51TDPM 46460016
.*       OI    PUBCSFLG,OPINTV      IS REQUIRED                @D61SDJK 46470000
         B     DERIREX                                         @D52..GL 46480016
DERIR10  DS    0H                                              @D52..GL 46490016
DERIREX  B     DERDOEX                                         @D51TDPM 46500016
*-------------------------------------------------------------*@D51TDPM 46510016
*  FUNCTION                                                    @D51TDPM 46520016
*     DATA CHECK 2 ERROR RECOVERY.                             @D51TDPM 46530016
*-------------------------------------------------------------*@D51TDPM 46540016
DERDC02  DS    0H                                              @D51TDPM 46550016
         AGO   .NOSUP00                                        @DERPDGL 46560016
 SGDSK  'CALL  DERECF          ','DO DATA CORRECTION',         @DERPDGLX46570016
               I='2,3               ON RETURN ',               @DERPDGLX46580016
               O='7,8,9             R8 PTR TO CCW, R7=REST',   @DERPDGLX46590016
               E0='DERD2C10         ERROR: DATA NOT CORRECTED' @DERPDGL 46600016
 SGDSK  'CALL  DERRHAO         ','READ HOME ADDRESS DATA',     @DERPDGLX46610016
               I='1,2,3             ON RETURN ',               @DERPDGLX46620016
               O='B,F               RF POINTS TO DATA'         @DERPDGL 46630016
         LTR   RF,RF              BRANCH WHEN THE HOME...      @D51TDPM 46640016
         BZ    DERD2C10             ADDRESS READ FAILED.       @D51TDPM 46650016
         LH    R5,DERHH             INCREMENT HEAD             @D37ADDK 46660016
         LA    R5,1(R5)             NUMBER                     @D37ADDK 46670016
         STH   R5,DERHH             BY ONE                     @D37ADDK 46680016
         LA    R5,DERCCWS2                                     @D51TDPM 46690016
 SGDSK  'CALL  DERDCFIN        ','COMPLETE RECOVERY ',         @DERPDGLX46700016
               I='1,2,3,5           ON RETURN',                @DERPDGLX46710016
               O='B,F               RF CONTAINS COMPL.CODE'    @DERPDGL 46720016
         B     DERD2CEX                                        @D51TDPM 46730016
DERD2C10 EQU   *                                               @D51TDPM 46740016
.NOSUP00 ANOP                                                  @DERPDGL 46750016
         LA    RF,DERRRE          RETURN RECOVERY ERROR FOR... @D51TDPM 46770016
DERD2CEX B     DERDOEX                                         @D51TDPM 46780016
*                                                                       46790016
*-------------------------------------------------------------*@D51TDPM 46800016
*  FUNCTION                                                    @D51TDPM 46810016
*     DATA CHECK 3 AND 4 ERROR RECOVERY.                       @D51TDPM 46820016
*-------------------------------------------------------------*@D51TDPM 46830016
DERDC34  DS    0H                                              @D51TDPM 46840016
         AGO   .NOSUP27                                        @D61ADJK 46850016
 SGDSK  'CALL  DERECF          ','DO DATA CORRECTION',         @DERPDGLX46870016
               I='2,3               ON RETURN ',               @DERPDGLX46880016
               O='7,8,9             R8 PTR TO CCW, R7=REST',   @DERPDGLX46890016
               E0='DERD3C10         ERROR: DATA NOT CORRECTED' @DERPDGL 46900016
*                                                                       46910016
         CLI   PUBDEVTY,T3330B        BRANCH WHEN NOT A...     @DELETED 46920016
         BE    DERD3C33                 333X TYPE DEVICE.      @DELETED 46930016
         CLI   PUBDEVTY,T3330         BRANCH WHEN NOT A...     @DELETED 46940016
         BNE   DERD3C05                 333X TYPE DEVICE.      @DELETED 46950016
DERD3C33 TM    ERRQSNS+23,B'00000001' BRANCH WHEN CHANNEL      @DELETED 46960016
         BO    DERD3C20                 TRUNCATED DATA.        @DELETED 46970016
DERD3C05 DS    0H                                              @DELETED 46980016
*                                                                       46990016
 SGDSK  'CALL  DERCONSK        ','MAKE SEEK ADDR AT DERCCHH',  @DERPDGLX47000016
               I='1,2,3             ON RETURN',                @DERPDGLX47010016
               O='NONE              RF IS RETURN CODE',        @DERPDGLX47020016
               E0='DERD3C10         ERROR: ADDR.NOT MADE'      @DERPDGL 47030016
         LH    R5,DERHH             INCREMENT HEAD             @D37ADDK 47050016
         LA    R5,1(R5)             NUMBER                     @D37ADDK 47060016
         STH   R5,DERHH             BY ONE                     @D37ADDK 47070016
         LA    R5,DERCCWS2                                     @D51TDPM 47080016
 SGDSK  'CALL  DERDCFIN        ','COMPLETE RECOVERY ',         @DERPDGLX47090016
               I='1,2,3,5           ON RETURN',                @DERPDGLX47100016
               O='B,F               RF CONTAINS COMPL.CODE'    @DERPDGL 47110016
         B     DERD3CEX                                        @D51TDPM 47120016
DERD3C10 EQU   *                                               @D51TDPM 47130016
         LA    RF,DERRRE          RETURN RECOVERY ERROR FOR... @D51TDPM 47150016
*                                                              @D51TDPM 47160016
*   HANDLE DATA CHECK 4 AS A RECOVERABLE EQUIPMENT CHECK.      @D51TDPM 47170016
*                                                              @D51TDPM 47180016
         B     DERD3CEX                                        @D51TDPM 47190016
DERD3C20 EQU   *                                               @D51TDPM 47200016
 SGDSK  'CALL  DERTYSMP        ','DO A SIMPLE RETRY',          @DERPDGLX47210016
               I='1,2,3,B           ON RETURN',                @DERPDGLX47220016
               O='B,F               RF IS RETURN CODE'         @DERPDGL 47230016
.NOSUP27 ANOP                                                  @D61ADJK 47240016
         LA    RF,DERRRE          RETURN RECOVERY ERROR FOR... @D51TDPM 47250016
DERD3CEX B     DERDOEX                                         @D51TDPM 47260016
*                                                              @D51TDPM 47270016
*-------------------------------------------------------------*@D51TDPM 47280016
*  FUNCTION                                                    @D51TDPM 47290016
*     DATA CHECK 5 ERROR RECOVERY.                             @D51TDPM 47300016
.*    THIS IS THE NORMAL CORRECTABLE DATA CHECK FOR FBA        @DERPDGL 47310016
.*    DEVICES. IT DID NOT OCCUR IN THE LAST BLOCK OF A         @DERPDGL 47320016
.*    LOCATE DOMAIN, HENCE OPERATION INCOMPLETE IS SET.        @DERPDGL 47330016
*-------------------------------------------------------------*@D51TDPM 47340016
DERDC05  DS    0H                                              @D51TDPM 47350016
         LA    RF,DERRRE          ASSUME RECOVERY ERROR        @D51TDPM 47370016
 SGDSK  'CALL  DERECF          ','DO DATA CORRECTION',         @DERPDGLX47380016
               I='2,3               ON RETURN ',               @DERPDGLX47390016
               O='7,8,9             R8 PTR TO CCW, R7=REST',   @DERPDGLX47400016
               E0='DERDOEX          ERROR: DATA NOT CORRECTED' @DERPDGL 47410016
*                                                                       47420016
*  THE REST OF THE RECOVERY IS THE SAME AS FOR OPERATION       @D51TDPM 47430016
*  INCOMPLETE OVERRUN.                                         @D51TDPM 47440016
*                                                                       47450016
*-------------------------------------------------------------*@D51TDPM 47460016
*  FUNCTION                                                    @D51TDPM 47470016
*     OPERATION INCOMPLETE OVERRUN ERROR RECOVERY.             @D51TDPM 47480016
*-------------------------------------------------------------*@D51TDPM 47490016
DEROIO   DS    0H                                              @D51TDPM 47500016
*                                                              @D51TDPM 47520016
         LA    R9,X'63'           TAKE DEFINE EXTENT OPCODE    @DERPDGL 47530016
 SGDSK  'CALL  DERSCAN         ','FIND THE LAST TIME ITS USED',      GLX47540016
               I='1,9               ON RETURN+4',              @DERPDGLX47550016
               O='5                 R5 POINTS TO FOUND CCW',   @DERPDGLX47560016
               E0='DEROD500         ERROR:NO SUCH OPCODE'      @DERPDGL 47570016
         LR    R8,R5                                           @DERPDGL 47590016
         USING CCWADR,R8                                       @D51TDPM 47600016
         MVC   DERCCWX4,CCWTOT    MOVE DEFINE EXTENT CCW       @D14ZDDK 47610016
         MVC   DERLPS,ERRQSNS+8   MOVE LOCATE PARAMETERS       @D37ADDK 47620016
         DROP  R8                                              @DERPDGL 47630016
*                                                              @D37ADDK 47640016
 SGDSK  'CALL  DERRSCW2        ','POINT TO CCWS IN RF AND R8', @DERPDGLX47650016
               I='1,2,3             RF IS RESTART CCW',        @DERPDGLX47660016
               O='8,F               R8 IS INTERRUPTED CCW'     @DERPDGL 47670016
         LTR   RF,RF              BRANCH WHEN RESTART CCW...   @D51TDPM 47680016
         BZ    DEROD500             WAS NOT BUILT.             @D51TDPM 47690016
         USING CCWADR,RF                                       @D51TDPM 47710016
         MVC   DERCCWR4(8),CCWTOT MOVE IN RESTART CCW.         @D51TDPM 47720016
         DROP  RF                                              @D51TDPM 47730016
         USING CCWADR,R8                                       @D51TDPM 47740016
         TM    CCWCHAIN,CC+DC     BRANCH WHEN TIC IS NOT       @D51TDPM 47750016
         BZ    DEROD100             NECCESSARY.                @D51TDPM 47760016
 SGDSK  'CALL  DERMKTIC        ','TRY TO TIC TO NEXT CCW ',    @DERPDGLX47780016
               I='8                 ON RETURN+4',              @DERPDGLX47790016
               O='8                 R8 NXT CCWS VIRT.ADD',     @DERPDGLX47800016
               E0='DEROD500         ERROR:TIC NOT BUILT'       @D51TDPM 47810016
         DROP  R8                                              @D51TDPM 47820016
         MVC   DERCCWR4+8(8),DERTIC    MOVE IN THE TIC CCW.    @D51TDPM 47830016
DEROD100 EQU   *                                               @D37ADDK 47840016
         LA    R5,DERCCWX4        USE THE NEW CHANNEL...       @D51TDPM 47850016
         STCM  R5,B'0111',CCBCCW+1  PROGRAM.                   @D51TDPM 47860016
*                                                              @D51TDPM 47870016
 SGDSK  'CALL  DERIO           ','DO UNLIMITED RETRY ',        @DERPDGLX47890016
               I='1,2,3,B           ON RETURN ',               @D61SDJKX47900000
               O='B,F               RF IS RETURN CODE'         @DERPDGL 47910016
         B     DERODEX                                         @D51TDPM 47920016
DEROD500 EQU   *                                               @D51TDPM 47930016
         LA    RF,DERRRE          RECOVERY ERROR.              @D51TDPM 47950016
DERODEX  B     DERDOEX                                         @D51TDPM 47960016
*-------------------------------------------------------------*@DERPDGL 47970016
*  FUNCTION                                                    @DERPDGL 47980016
*     RECOVERY ACTION 5 OF 3990 24+8 COMPATIBILITY SENSE.      @DERPDGL 47990016
*     LOOK FOR LOST PATH GROUP ID. SET IT AGAIN IF IT WAS LOST.@DERPDGL 48000016
.*    SINCE STAND ALONE SUPERVISOR IS RUNNING A SINGLE PATH,   @DERPDGL 48010016
.*    WE NEED NOT CARE ABOUT PATH GROUP IDS. THEY CAN BE LOST, @DERPDGL 48020016
.*    IT SHOULD NOT MATTER.                                    @DERPDGL 48030016
*-------------------------------------------------------------*@DERPDGL 48040016
DERCA5   DS    0H                                              @DERPDGL 48050016
         TM    ERRQSNS+2,X'80'    BRANCH IF INHIBIT WRITE IS   @DERPDGL 48070016
         BNO   DERCA520             NOT REQUESTED              @DERPDGL 48080016
         CLI   ERRQSNS+25,X'17'   BRANCH IF ITS                @DERPDGL 48090016
         BE    DERCA522             FOR                        @DERPDGL 48100016
         CLI   ERRQSNS+25,X'57'     THE                        @DERPDGL 48110016
         BE    DERCA522             CONTROLLER                 @DERPDGL 48120016
         CLI   ERRQSNS+25,X'18'   BRANCH IF ITS                @DERPDGL 48130016
         BE    DERCA524             FOR                        @DERPDGL 48140016
         CLI   ERRQSNS+25,X'58'     THE                        @DERPDGL 48150016
         BE    DERCA524             PATH                       @DERPDGL 48160016
         CLI   ERRQSNS+25,X'19'   BRANCH IF ITS                @DERPDGL 48170016
         BE    DERCA526             FOR THE                    @DERPDGL 48180016
         CLI   ERRQSNS+25,X'59'     STORAGE DIRECTOR           @DERPDGL 48190016
         BNE   DERCA520                                        @DERPDGL 48200016
DERCA526 OI    DERCRRA2,DERRA2DS  WRITE INHIBIT STORAGE DIR.   @DERPDGL 48210016
         B     DERCA520                                        @DERPDGL 48230016
DERCA522 OI    DERCRRA2,DERRA2DU  WRITE INHIBIT CONTROLLER     @DERPDGL 48240016
         B     DERCA520                                        @DERPDGL 48260016
DERCA524 OI    DERCRRA2,DERRA2DP  WRITE INHIBIT PATH           @DERPDGL 48270016
DERCA520 DS    0H                                              @DERPDGL 48290016
*                                                              @DERPDGL 48300016
 SGDSK  'CALL  DERTYSMP        ','DO A SIMPLE RETRY',          @DERPDGLX48310016
               I='1,2,3,B           ON RETURN',                @DERPDGLX48320016
               O='B,F               RF IS RETURN CODE'         @DERPDGL 48330016
DERCA5X  B     DERDOEX                                         @DERPDGL 48340016
*-------------------------------------------------------------*@DERPDGL 48350016
*  FUNCTION                                                    @DERPDGL 48360016
*     INFORM A PCI USER OF A CORRECTABLE DATA CHECK. CORRECTIVE@DERPDGL 48370016
*     ACTION IS IN HIS OWN RESPONSIBILITY.                     @DERPDGL 48380016
*-------------------------------------------------------------*@DERPDGL 48390016
DERCA6   DS    0H                                              @DERPDGL 48400016
         LA    RF,DERREXH         RECOVERY EXHAUSTED FOR ME..  @DERPDGL 48420016
DERCA6X  B     DERDOEX                                         @DERPDGL 48430016
*-------------------------------------------------------------*@DERPDGL 48440016
*  FUNCTION                                                    @DERPDGL 48450016
*     AN END OF CYLINDER CONDITION CAME IN IN BASIC SENSE      @DERPDGL 48460016
*     DATA FORMAT. THIS END OF CYLINDER MAY BE POINTING        @DERPDGL 48470016
*     TO AN SGDSK READ COUNT COMMAND.                          @DERPDGL 48480016
.*    THIS CAN BE CAUSED BY A RESUMPTION OF A USER CHAIN       @DERPDGL 48490016
.*    IF A CORRECTABLE DATA CHECK HAPPENED ON THE LAST         @DERPDGL 48500016
.*    RECORD OF A CYLINDER, THE CHAIN OF THE USER CONTAINED    @DERPDGL 48510016
.*    READ MULTITRACK COMMANDS AND WE ADDED A READ COUNT       @DERPDGL 48520016
.*    MULTITRACK IN ORDER TO SKIP THE ONE RECORD WE HAD        @DERPDGL 48530016
.*    FIXED IN STORAGE. WE WILL THEN RECEIVE AN END OF         @DERPDGL 48540016
.*    CYLINDER CONDITION ON THE READ COUNT MULTITRACK THAT     @DERPDGL 48550016
.*    WE INSERTED.                                             @DERPDGL 48560016
*     WE SHOULD ADJUST THE CCBCSW ADDRESS AND THE RESIDUAL     @DERPDGL 48570016
*     COUNT TO THE VALUES, THAT THEY WOULD HAVE CONTAINED      @DERPDGL 48580016
*     IF THERE HAD NEVER BEEN A CORRECTABLE DATA CHECK.        @DERPDGL 48590016
*-------------------------------------------------------------*@DERPDGL 48600016
DEREOC   DS    0H                                              @DERPDGL 48610016
         CLC   DERSOCA(4),DERFCCWV  BRANCH WHEN THE FAILING CCW@DERPDGL 48630016
         BH    DEREOC10               IS BEFORE ANY DSK CCW    @DERPDGL 48640016
         CLC   DEREOCA(4),DERFCCWV  BRANCH IF THE CCW IS       @DERPDGL 48650016
         BNH   DEREOC10               AFTER ANY DSK CCW        @DERPDGL 48660016
         L     R8,DERFCCWV          TAKE FAILING CCW ADDRESS   @DERPDGL 48680016
 SGDSK  'CALL  DERBUMP           ','BUMP TO NEXT CCW ',        @DERPDGLX48690016
               I='8                   ON RETURN TO +8 ',       @DERPDGLX48700016
               O='8                   R8 POINTS TO NXT CCW',   @DERPDGLX48710016
               E0='DEREOC10           ERROR: NOT ADDRESSABLE', @DERPDGLX48720016
               E4='DEREOC10           ERROR: CHAIN ENDED'      @DERPDGL 48730016
 SGDSK  'CALL  DERCVTVR          ','CONVERT VIRTUAL TO REAL',  @DERPDGLX48740016
               I='8                   ON RETURN',              @DERPDGLX48750016
               O='F                   RF IS REAL OR 0 '        @DERPDGL 48760016
         LA    RF,8(,RF)            ADD 8 FOR CSW CCW VALUE    @DERPDGL 48770016
         STCM  RF,7,CCBCSWW         STORE ADDR. OF NEXT+8 INTO @DERPDGL 48780016
         USING CCWADR,R8              CCB CSW CCW ADDR. LOCAT. @DERPDGL 48790016
         LH    R5,CCWLNG            FAKE THE PROPER COUNT      @DERPDGL 48800016
         STH   R5,CCBCNT              VALUE INTO THE RESIDUAL  @DERPDGL 48810016
         DROP  R8                     COUNT BYTES              @DERPDGL 48820016
DEREOC10 DS    0H                                              @DERPDGL 48830016
         LA    RF,DERRSUC           INDICATE SUCCESSFUL RECOV. @DERPDGL 48840016
DEREOCX  B     DERDOEX                                         @DERPDGL 48850016
*-------------------------------------------------------------*@DERPDGL 48860016
*  FUNCTION                                                    @DERPDGL 48870016
*     AN UNCONDITIONAL RESERVE HAS BEEN ISSUED                 @DERPDGL 48880019
*     MAKE SURE LCK-TASK GETS INFORMED                         @DERPDGL 48890019
*-------------------------------------------------------------*@DERPDGL 48910016
         AGO   .SKIP010                                                 48911019
DERUNR   DS    0H                                              @DERPDGL 48920016
         CLM   R3,7,PUBDLF+1      IS THIS THE DLF DEVICE       @DY46XXX 48931028
         BNE   DERRSN10           NO,                          @D66ADAP 48932019
         OI    PUBDLF,X'80'       INDICATE DEVICE RESET        @D66ADAP 48935020
DERUNR10 DS    0H'0'                                                    48939119
         LA    RF,DERREXH         ENSURE EXHAUSTED EXIT        @DERPDGL 49000020
DERUNRX  B     DERDOEX            TAKE GENERAL EXIT            @DERPDGL 49010020
.SKIP010 ANOP                                                           49011019
*-------------------------------------------------------------*@DERPDGL 49020016
*  FUNCTION                                                    @DERPDGL 49030016
*     A RESET NOTIFICATION HAS BEEN RECOGNIZED.                @DERPDGL 49040019
*     INFORM LCK-TASK IF APPLICABLE                            @DERPDGL 49050019
*                                                              @DERPDGL 49060019
*-------------------------------------------------------------*@DERPDGL 49070016
DERRSN   DS    0H                                              @DERPDGL 49080016
         CLM   R3,7,PUBDLF+1      IS THIS THE DLF DEVICE       @DY46XXX 49100028
         BNE   DERRSN10           NO,                          @D66ADAP 49110016
         OI    PUBDLF,X'80'       INDICATE DEVICE RESET        @D66ADAP 49140020
         LA    RF,DERREXH         TAKE RECOVERY EXHAUSTED      @DERPDGL 49150016
         LA    R5,LCKTID          LCK TASK-ID                  @D66CDAP 49160016
         CH    R5,DERTID          IS THIS A LCK TASK REQUEST   @D66CDAP 49170016
         BE    DERRSNX            YES, SGLOCK DOES THE RETRY   @DERPDGL 49180020
DERRSN10 DS    0H'0'                                                    49190016
 SGDSK  'CALL  DERTYSMP        ','DO A SIMPLE RETRY',          @DERPDGLX49210016
               I='1,2,3,B           ON RETURN',                @DERPDGLX49220016
               O='B,F               RF IS RETURN CODE'         @DERPDGL 49230016
DERRSNX  B     DERDOEX                                         @DERPDGL 49240016
*-------------------------------------------------------------*@DERPDGL 49250016
*  FUNCTION                                                    @DERPDGL 49260016
*     DATA CHECK 6 AND 7 ERROR RECOVERY.                       @DERPDGL 49270016
.*    BACKGROUND:                                              @DERPDGL 49280016
.*    A DATA CHECK WAS DETECTED WHEN EITHER READING A SINGLE   @DERPDGL 49290016
.*    RECORD FROM A TRACK OR ALL OF THE RECORDS ON IT.         @DERPDGL 49300016
.*    THE CONTROL UNIT KNOWS, THAT A RESTART CCW TYPE 2        @DERPDGL 49310016
.*    MIGHT HAVE TO BE BUILT AND INITIATES CHANNEL COMMAND     @DERPDGL 49320016
.*    RETRY. HENCE THE FAILING CCW IN THE CSW POINTS TO THE    @DERPDGL 49330016
.*    FIRST COMMAND IN A POSSIBLE DATA CHAIN AND THE           @DERPDGL 49340016
.*    RESIDUAL COUNT IS EQUAL TO THE COUNT OF THIS 1ST CCW.    @DERPDGL 49350016
.*                                                             @DERPDGL 49360016
.*    FOR THE TECHNIQUE USED IN DATA CORRECTION FUNCTION       @DERPDGL 49370016
.*    SEE ALSO GA26-1661-9 3880 MANUAL PAGE 6-4 AND 6-5.       @DERPDGL 49380016
*-------------------------------------------------------------*@D51TDPM 49390016
DERDC67  DS    0H                                              @D51TDPM 49400016
         LA    RF,DERRRE          ASSUME RECOVERY ERROR        @D51TDPM 49420016
         CLC   DERFCCWV,DERCCCWV  DID WE HAVE A CHANNEL COMMAND@DERPDGL 49430016
         BNE   DERD7CEX           RETRY OPERATION?             @DERPDGL 49440016
 SGDSK  'CALL  DERECF          ','DO DATA CORRECTION',         @DERPDGLX49460016
               I='2,3               ON RETURN ',               @DERPDGLX49470016
               O='7,8,9             R8 PTR TO CCW, R7=REST',   @DERPDGLX49480016
               E0='DERD7CEX         ERROR: DATA NOT CORRECTED' @DERPDGL 49490016
         XR    RF,RF              RESET ERROR INDICATION       @D52..GL 49500016
         ST    R8,DERLSTCW        SAVE LAST CCW ADDRESS.       @D51TDPM 49510016
*                                                              @D51TDPM 49520016
*   DETERMINE IF WE SHOULD FINISH RECOVERY.                    @D51TDPM 49530016
.*  IF THE USER HAD A READ MULTIPLE CCW, THERE MAY BE A NUMBER @D51TDPM 49540016
.*  OF RECORDS LEFT ON THE TRACK, EVEN IF THE COMMAND OR DATA  @DERPDGL 49550016
.*  CHAINING IS OFF. SO WE CAN NOT ASSUME THAT THIS RECORD WAS @DERPDGL 49560016
.*  THE LAST RECORD.                                           @DERPDGL 49570016
*                                                              @D51TDPM 49580016
         CLI   DERCRFCO,DERRMCKD  BRANCH IF WE CANNOT ASSUME,  @D51TDPM 49590016
         BE    DERD7C22             THAT ALL DATA ARE READ     @D51TDPM 49600016
.*                                                             @D51TDPM 49620016
.*  IF ITS NO READ MULTIPLE, AND DATA CHAINING IS OFF WE CAN   @DERPDGL 49630016
.*  SAY THAT THE OPERATION WOULD HAVE FINISHED WITH THIS RECORD      GL 49640016
.*                                                             @D51TDPM 49650016
         L     R8,DERLSTCW        TAKE LAST CCW OF POSSIBLE    @D51TDPM 49660016
         USING CCWADR,R8            DATA CHAIN                 @D51TDPM 49670016
         TM    CCWCHAIN,DC+CC     BRANCH IF NOT LST IN CHANNEL @D51TDPM 49680016
         BNZ   DERD7C12             PROGRAM                    @D51TDPM 49690016
.*                                                             @DELETED 49710016
         AGO   .NOSUP20                                        @DELETED 49720016
         CLI   PUBDEVTY,T3330B        BRANCH WHEN NOT A...     @DELETED 49730016
         BE    DERD7C33                 333X TYPE DEVICE.      @DELETED 49740016
         CLI   PUBDEVTY,T3330         BRANCH WHEN NOT A...     @DELETED 49750016
         BNE   DERD7C17                 333X TYPE DEVICE.      @DELETED 49760016
DERD7C33 TM    ERRQSNS+23,B'00000001' BRANCH WHEN CHANNEL DID  @DELETED 49770016
         BO    DERD7C12                 NOT TRUNCATE TRANSFER  @DELETED 49780016
.NOSUP20 ANOP                                                  @DELETED 49790016
.*                                                             @DELETED 49800016
         B     DERD7C17                                        @DERPDGL 49810016
*                                                              @D51TDPM 49820016
.*  IF ANY CHAINING WAS ON STILL, THE CCW CHAIN WOULD HAVE     @DERPDGL 49830016
.*  BEEN FINISHED ANYWAY, IF THE SLI BIT WAS OFF AND THERE           GL 49840016
.*  WAS A DIFFERENCE BETWEEN THE RECORD LENGTH AND THE NR OF         GL 49850016
.*  BYTES REQUESTED BY THE USER OR IF DATA CHAINING WAS ON           GL 49860016
.*  AND THAT DIFFERENCE WAS NOT 0.                                   GL 49870016
.*                                                             @D51TDPM 49880016
         DROP  R8                                              @DA41424 49890016
         USING CCWADR,R9                                       @DA41424 49900016
DERD7C12 TM    CCWCHAIN,DC        BRANCH WHEN SLI WOULD BE     @DA41424 49910016
         BO    DERD7C14             IGNORED                    @DA41424 49920016
         TM    CCWCHAIN,SLI       BRANCH WHEN INCORRECT...     @D51TDPM 49940016
         BO    DERD7C22             LENGTH IS SUPPRESSED.      @D51TDPM 49950016
         DROP  R9                                              @DA41424 49960016
DERD7C14 LTR   R7,R7                                           @D51TDPM 49970016
         BZ    DERD7C22                                        @D51TDPM 49980016
*                                                              @D51TDPM 49990016
.*  WE DECIDED, THAT THE I/O OPERATION IS FINISHED FOR THE     @DERPDGL 50000016
.*  USER. NOW LET US STORE THE RESIDUAL COUNT WHICH WAS              GL 50010016
.*  DESTROYED BY THE CHANNEL COMMAND RETRY. THE VALUE OF             GL 50020016
.*  R7 CAN ALSO BE NEGATIVE. THIS MEANS, THAT THE NUMBER             GL 50030016
.*  OF BYTES FOR THE RECORD ON THE TRACK WAS BIGGER THAN THE SUM     GL 50040016
.*  OF ALL COUNT FIELDS OF THE DATA CHAINED CCWS                     GL 50050016
.*                                                             @D51TDPM 50060016
DERD7C17 EQU   *                                               @D51TDPM 50070016
         XC    CCBCNT,CCBCNT      ZERO RESIDUAL COUNT          @D37ADDK 50090016
         LTR   R7,R7              BRANCH WHEN BYTE TRANSFER... @D51TDPM 50100016
         BM    DERD7CB5             DIFFERENCE IS NEGATIVE.    @D51TDPM 50110016
         STH   R7,CCBCNT          STORE RESIDUAL COUNT         @D37ADDK 50130016
.*                                                             @DA41424 50140016
.*  NEXT THE ADDRESS FOR THE CCW BELONGING TO THAT RESIDUAL    @DA41424 50150016
.*  COUNT HAS TO BE STORED. R9 CONTAINS THE VIRTUAL ADDRESS    @DA41424 50160016
.*                                                             @DA41424 50170016
DERD7CB5 LR    R8,R9              TAKE FOR SUBROUTINE INPUT    @DA41424 50180016
 SGDSK  'CALL  DERCVTVR        ','CONVERT VIRTUAL TO REAL',    @DERPDGLX50190016
               I='8                 ON RETURN',                @DERPDGLX50200016
               O='F                 RF IS REAL OR 0 '          @DERPDGL 50210016
         LA    R8,8(RF)           IT SHOULD ALWAYS EXIST       @DA25327 50220016
         STCM  R8,B'0111',CCBCSWW STORE IT TO CCB              @DA41424 50230016
.*                                                             @DA41424 50240016
.*  NOW AGAIN, WE HAVE TO DECIDE, IF THE USER SHOULD BE        @DA41424 50250016
.*  POSTED INCORRECT LENGTH.                                   @DA41424 50260016
.*                                                             @DA41424 50270016
         LR    R8,R9              GET FAILING CCW IN DATA CHAIN@D51TDPM 50280016
         USING CCWADR,R8                                       @DA41424 50290016
         TM    CCWCHAIN,DC        BRANCH WHEN SLI BIT WOULD    @D51TDPM 50300016
         BO    DERD7CB7             BE IGNORED BY DATACHAINING @D51TDPM 50310016
         TM    CCWCHAIN,SLI       BRANCH WHEN INCORRECT...     @D51TDPM 50320016
         BO    DERD7CB9             LENGTH IS SUPPRESSED.      @D51TDPM 50330016
.*                                                             @DA41424 50340016
DERD7CB7 LTR   R7,R7              BRANCH WHEN INCORR. LENGTH   @D51TDPM 50350016
         BZ    DERD7CB9             WOULD NOT HAVE OCCURED     @D51TDPM 50360016
         OI    CCBSTA2,IL         POST INCORRECT LENGTH        @D37ADDK 50370016
*                                                              @DA41424 50390016
.*  NOW SAY WE FINISHED IN THE REST OF THE CCB BITS.           @DA41424 50400016
.*  WE CORRECT THE STATUS INFORMATION BY SETTING THE UNIT      @DERPDGL 50410016
.*  CHECK BIT OFF. THE DATA ARE CORRECTED NOW AND HENCE UNIT   @DERPDGL 50420016
.*  CHECK IS NOT TRUE ANY MORE. FOR THE REST OF THE STATUS     @DERPDGL 50430016
.*  SETTINGS SEE CSW EXPLANATIONS IN HEADER.                   @DERPDGL 50440016
.*  WE WANT TO BEHAVE JUST AS IF THE MACHINE HAD NEVER HAD     @DA41424 50450016
.*  A CORRECTABLE DATA CHECK. THE FOLLOWING REACTIONS ARE      @DA41424 50460016
.*  NORMALLY SHOWN BY THE MACHINE:                             @DA41424 50470016
.*  1.) DC ON, SLI ON OR OFF, RES.CNT  > 0 (BUT RRRR)          @DA41424 50480016
.*      THE MACHINE WOULD SAY: ........0C40RRRR IN THE CSW     @DA41424 50490016
.*  2.) DC ON, SLI ON OR OFF, RES.CNT  < 0                     @DA41424 50500016
.*      THE MACHINE WOULD SAY: ........0C400000                @DA41424 50510016
.*  3.) CC ON, SLI ON, RES.CNT         > 0 (BUT RRRR)          @DA41424 50520016
.*      CONTINUE THE CHAIN                                     @DA41424 50530016
.*  4.) CC ON, SLI OFF, RES.CNT        > 0 (BUT RRRR)          @DA41424 50540016
.*      THE MACHINE WOULD SAY: ........0C40RRRR                @DA41424 50550016
.*  5.) CC ON, SLI OFF, RES.CNT        < 0 (BUT RRRR)          @DA41424 50560016
.*      THE MACHINE WOULD SAY: ........0C400000                @DA41424 50570016
.*  6.) CC ON, SLI OFF, RES.CNT        = 0                     @DA41424 50580016
.*      CONTINUE THE CHAIN                                     @DA41424 50590016
.*                                                             @DA41424 50600016
.*  IN OTHER WORDS: SLI IS SUPPRESSED BY DATA CHAINING.        @DA41424 50610016
.*  A CHAIN IS DISCONTINUED IF THERE WAS A RESIDUAL COUNT,     @DA41424 50620016
.*  AND THE RESIDUAL COUNT WAS NOT NEGLECTED BECAUSE OF        @DA41424 50630016
.*  SLI, OR                                                    @DA41424 50640016
.*  THE CHAIN HAD COME TO ITS END ALREADY (WE HAD A DATA CHECK @DA41424 50650016
.*  IN THE VERY LAST CCW OF THE CHAIN).                        @DA41424 50660016
.*                                                             @DA41424 50670016
DERD7CB9 NI    CCBSTA1,XFF-UNITCK TURN OFF UNIT CHECK BIT      @DERPDGL 50680016
         OI    CCBSTA1,X'0C'      TURN ON CHANNEL END DEVEND   @DA42853 50690016
         LA    RF,DERRSUC         SUCCESSFUL RECOVERY.         @DERPDGL 50700016
         B     DERD7CEX                                        @DERPDGL 50710016
*                                                              @D51TDPM 50720016
*   DETERMINE HOW TO ISSUE I/O FOR RESUMPTION OF OPERATION     @D51TDPM 50730016
*                                                              @D51TDPM 50740016
DERD7C22 DS    0H                                              @DERPDGL 50750016
         AGO   .NOSUP22                                        @DELETED 50760016
         CLI   PUBDEVTY,T3330B        BRANCH WHEN NOT A...     @DELETED 50770016
         BE    DERD7C33                 333X TYPE DEVICE.      @DELETED 50780016
         CLI   PUBDEVTY,T3330         BRANCH WHEN NOT A...     @DELETED 50790016
         BNE   DERD7C25                 333X TYPE DEVICE.      @DELETED 50800016
DERD7C33 TM    ERRQSNS+23,B'00000001' BRANCH WHEN CHANNEL DID  @DELETED 50810016
         BNO   DERD7C25                 NOT TRUNCATE TRANSFER  @DELETED 50820016
 SGDSK  'CALL  DERTYSMP        ','DO A SIMPLE RETRY',          @DELETEDX50830016
               I='1,2,3,B           ON RETURN',                @DELETEDX50840016
               O='B,F               RF IS RETURN CODE'         @DELETED 50850016
         B     DERD7CEX                                        @DELETED 50860016
DERD7C25 EQU   *                                               @DELETED 50870016
.NOSUP22 ANOP                                                  @DELETED 50880016
*                                                              @DA41424 50890016
*   BUILD THE TIC TO THE CONTINUING CCW OF THE USER CHAIN.     @DA41424 50900016
.*  THIS IS THE NEXT ONE BEHIND THE LAST IN THE DATA CHAIN     @DA41424 50910016
.*  THAT FAILED (IF IT WAS A CHAIN OF COURSE).                 @DA41424 50920016
.*  BUILDING OF THE RESTART CCW AND THE CCW THAT WE HAVE TO    @DERPDGL 50930016
.*  TIC TO ARE DIFFERENT IN CASE OF READ MULTIPLE COUNT KEY    @DERPDGL 50940016
.*  DATA. WITH NORMAL COMMANDS WE WOULD ONLY DEAL WITH A       @DERPDGL 50950016
.*  SINGLE RECORD. THIS SINGLE RECORD IS NOW FIXED IN STORAGE  @DERPDGL 50960016
.*  AND WE WOULD ALWAYS RESTART BEHIND THE DATA CHAIN (IF      @DERPDGL 50970016
.*  THERE WAS A DATA CHAINED SEQUENCE OF CCWS).                @DERPDGL 50980016
.*  FOR RMCKD WE HAVE TO CONTINUE IN THE MIDDLE OF THAT CHAIN. @DERPDGL 50990016
.*  OTHERWISE WE MAY OMIT A COUPLE OF RECORDS.                 @DERPDGL 51000016
.*  EXAMPLE: SIX RECORDS ARE READ USING 3 CCWS, ALL DATA       @DERPDGL 51010016
.*           CHAINED. THE FIRST ONE HAS THE COMMAND CODE       @DERPDGL 51020016
.*           RMCKD. THE OTHERS POINT TO DIFFERENT PLACES IN    @DERPDGL 51030016
.*           STORAGE. IF WE DO NOT START IN THE MIDDLE OF      @DERPDGL 51040016
.*           THE DATA CHAIN, WE LOOSE SOME RECORDS.            @DERPDGL 51050016
.*  WITH NORMAL CKD COMMANDS, THE ENTIRE RECORD HAD BEEN IN    @DERPDGL 51060016
.*  STORAGE. FOR RMCKD A RESTART CCW TYPE 2 IS BUILT, WHICH    @DERPDGL 51070016
.*  MEANS, THAT THE REST OF THE RECORDS OF THE TRACK STILL     @DERPDGL 51080016
.*  NEED  TO BE READ.                                          @DERPDGL 51090016
*                                                              @DA41424 51100016
         CLI   DERCRFCO,DERRMCKD  BRANCH WHEN THE FAILING CCW..@D51TDPM 51110016
         BNE   DERD7I10             OP CODE IS NOT RMCKD.      @D51TDPM 51120016
         LR    R8,R9              TAKE PTR TO NEXT IN DATA CHAIN     GL 51130016
         USING CCWADR,R8                                       @D51TDPM 51140016
         TM    CCWCHAIN,DC+CC     BRANCH IF THERE IS NO CCW    @KQD0137 51150016
         BZ    DERD7I20             BEHIND THIS ONE..          @KQD0137 51160016
         DROP  R8                                              @D51TDPM 51180016
         B     DERD7I12                                        @DERPDGL 51190016
DERD7I10 L     R8,DERLSTCW        GET FAILING CCW              @D51TDPM 51200016
DERD7I12 DS    0H                                              @DERPDGL 51210016
 SGDSK  'CALL  DERMKTIC        ','TRY TO TIC TO NEXT CCW ',    @DERPDGLX51220016
               I='8                 ON RETURN+4',              @DERPDGLX51230016
               O='8                 R8 NXT CCWS VIRT.ADD',     @DERPDGLX51240016
               E0='DERD7I95         ERROR:TIC NOT BUILT'       @D51TDPM 51250016
         ST    R8,DERNXTCW        REMEMBER THE NEXT CCW.       @DA40861 51260016
*                                                              @D51TDPM 51270016
*   BUILD THE FBA CHANNEL PROGRAM.                             @D51TDPM 51280016
.*  ACCORDING TO THE ERROR RECOVERY PRESCRIPTIONS WE NEED NOT  @DERPDGL 51290016
.*  CONSTRUCT A LOCATE BLOCK COMMAND, SINCE THE PLAIN          @DERPDGL 51300016
.*  CORRECTABLE DATA CHECK CAN ONLY BE SET BY THE FBA DEVICE   @DERPDGL 51310016
.*  IF IT OCCURED IN THE LAST BLOCK OF THE DOMAIN CORRENTLY    @DERPDGL 51320016
.*  PROCESSED. IN OTHER WORDS, THE NEXT SENSIBLE COMMAND TO    @DERPDGL 51330016
.*  FOLLOW IN THE USER CHAIN IS A LOCATE BLOCK ANYWAY. THERE   @DERPDGL 51340016
.*  CANNOT BE ANY FURTHER READ OR WRITE COMMAND. IF THE        @DERPDGL 51350016
.*  CORRECTABLE DATA CHECK HAD BEEN DETECTED IN ANY OTHER      @DERPDGL 51360016
.*  BLOCK BUT THE LAST ONE, FBA WOULD HAVE SET THE OPERATION   @DERPDGL 51370016
.*  INCOMPLETE BIT IN ADDITION (BYTE 1 BIT 7). THIS IS NOT     @DERPDGL 51380016
.*  DEALT WITH IN THIS CODE.                                   @DERPDGL 51390016
*                                                              @D51TDPM 51400016
         CLI   PUBDEVTY,TFBA      BRANCH WHEN THE DEVICE IS... @D51TDPM 51410016
         BNE   DERD7I20             NOT AN FBA DEVICE.         @D51TDPM 51420016
*                                                              @D51TDPM 51440016
         LA    R9,X'63'           TAKE DEFINE EXTENT OPCODE    @DERPDGL 51450016
 SGDSK  'CALL  DERSCAN         ','FIND THE LAST TIME ITS USED',      GLX51460016
               I='1,9               ON RETURN+4',              @DERPDGLX51470016
               O='5                 R5 POINTS TO FOUND CCW',   @DERPDGLX51480016
               E0='DERD7I95         ERROR:NO SUCH OPCODE'      @DERPDGL 51490016
         LR    R8,R5                                           @DERPDGL 51500016
         MVC   DERCCWX5,0(R8)     MOVE DEFINE EXTENT CCW       @D14ZDDK 51510016
         LA    R5,DERCCWX5        POINT TO RESTART CCWS        @D14ZDDK 51520016
         MVC   DERCCWT5,DERTIC    COPY TIC TO USER             @DA24935 51530016
         B     DERD7I90                                        @D51TDPM 51540016
DERD7I20 EQU   *                                               @D51TDPM 51550016
*                                                              @D51TDPM 51560016
*   BUILD THE CKD CHANNEL PROGRAM WHERE THE FAILING CCW WAS    @D51TDPM 51570016
*   A READ MULTIPLE CKD CCW.                                   @D51TDPM 51580016
*                                                              @DERPDGL 51590016
         CLI   DERCRFCO,DERRMCKD  BRANCH WHEN THE FAILING CCW..@D51TDPM 51600016
         BNE   DERD7I50             OP CODE IS NOT RMCKD.      @D51TDPM 51610016
 SGDSK  'CALL  DERRSCW2        ','POINT TO CCWS IN RF AND R8', @DERPDGLX51620016
               I='1,2,3             RF IS RESTART CCW',        @DERPDGLX51630016
               O='8,F               R8 IS INTERRUPTED CCW'     @DERPDGL 51640016
         LTR   RF,RF              BRANCH WHEN THE RESTART CCW..@D51TDPM 51650016
         BZ    DERD7I95             IS NOT BUILT.              @D51TDPM 51660016
         MVI   DERCCW,DERRMCKD    SET CCW2 OP CODE TO '5E'     @D21OTJF 51680016
 SGDSK  'CALL  DERCONSK        ','MAKE SEEK ADDR AT DERCCHH',  @DERPDGLX51690016
               I='1,2,3             ON RETURN',                @DERPDGLX51700016
               O='NONE              RF IS RETURN CODE',        @DERPDGLX51710016
               E0='DERD7I95         ERROR: ADDR.NOT MADE'      @DERPDGL 51720016
         MVC   DERSARG,ERRQSNS+8  COPY SEARCH ARGUMENT         @DA22771 51730016
         MVC   DERCCWR3,DERCCW    COPY TRAILER                 @DA24935 51740016
         LA    R5,DERCCWS3        POINT TO RESTART CCWS        @D51TDPM 51750016
         B     DERD7I90                                        @D51TDPM 51760016
DERD7I50 EQU   *                                               @D51TDPM 51770016
*                                                              @D51TDPM 51780016
*   BUILD THE CKD CHANNEL PROGRAM WHERE THE FAILING CCW WAS    @D51TDPM 51790016
*   NOT A READ MULTIPLE CKD CCW.                               @D51TDPM 51800016
*                                                              @D51TDPM 51810016
         L     R8,DERNXTCW        CCW AFTER LAST IN DATA CHAIN.@D51TDPM 51820016
         MVC   DERCCW,DERTIC      NO RESTART CCW.              @D51TDPM 51830016
         TM    0(R8),X'10'        BRANCH IF THE USERS CCW      @DERPDGL 51840016
         BO    DERD7I30             REQUIRES ORIENTATION OF    @DERPDGL 51850016
         CLI   0(R8),X'01'          DISK HEAD IN FRONT OF THE  @DERPDGL 51860016
         BE    DERD7I30             COUNT FIELD OF THE NEXT    @DERPDGL 51870016
         CLI   0(R8),X'0F'          RECORD. (I.E. FOR ANY      @DERPDGL 51880016
         BE    DERD7I30             COMMAND DEALING WITH COUNT,@DERPDGL 51890016
         CLI   0(R8),X'22'          WRITE SPECIAL CKD, READ    @DERPDGL 51900016
         BE    DERD7I30             SECTOR AND SPACE COUNT)    @DERPDGL 51910016
         MVC   DERCCW,DERCCWCT    COPY READ COUNT CCW          @DA25502 51930016
         TM    0(R8),X'80'        IS IT MULTI TRACK OPERATION  @D35DDDK 51940016
         BNO   DERD7I30           NO  READ COUNT IS OK         @DA40880 51950016
         OI    DERCCW,X'80'       MAKE IT A MULTI TRK READ CNT @DA25502 51970016
*                                                              @DERPDGL 51980016
DERD7I30 EQU   *                                               @DA22771 51990016
 SGDSK  'CALL  DERCONSK        ','MAKE SEEK ADDR AT DERCCHH',  @DERPDGLX52000016
               I='1,2,3             ON RETURN',                @DERPDGLX52010016
               O='NONE              RF IS RETURN CODE',        @DERPDGLX52020016
               E0='DERD7I95         ERROR: ADDR.NOT MADE'      @DERPDGL 52030016
         MVC   DERSARG,ERRQSNS+8  COPY SEARCH ARGUMENT         @DA22771 52040016
         MVC   DERCCWR3,DERCCW    COPY TRAILER                 @DA24935 52050016
         LA    R5,DERCCWS3        POINT TO RESTART CCWS        @D51TDPM 52060016
*                                                              @D51TDPM 52070016
DERD7I90 EQU   *                  CHANNEL PROGRAM WAS BUILT    @D37ADDK 52080016
         STCM  R5,B'0111',CCBCCW+1 SET UP CHANNEL PROGRAM.     @D51TDPM 52090016
 SGDSK  'CALL  DERIO           ','DO UNLIMITED RETRY ',        @DERPDGLX52110016
               I='1,2,3,B           ON RETURN ',               @D61SDJKX52120000
               O='B,F               RF IS RETURN CODE'         @DERPDGL 52130016
         B     DERD7CEX                                        @D51TDPM 52140016
DERD7I95 EQU   *                                               @D51TDPM 52150016
         LA    RF,DERRRE          RECOVERY ERROR.              @D51TDPM 52160016
*                                                              @D51TDPM 52170016
*   RECOVER FROM THE ERROR AS IF IT WERE A RECOVERABLE         @D51TDPM 52180016
*   EQUIPMENT CHECK ERROR.                                     @D51TDPM 52190016
*                                                              @D51TDPM 52200016
DERD7CEX B     DERDOEX                                         @D51TDPM 52210016
*                                                              @D51TDPM 52220016
*-------------------------------------------------------------*@D51TDPM 52230016
*  FUNCTION                                                    @D51TDPM 52240016
*     DATA CHECK 8 ERROR RECOVERY.                             @D51TDPM 52250016
*-------------------------------------------------------------*@D51TDPM 52260016
DERDC08  DS    0H                                              @D51TDPM 52270016
         AGO   .NOSUP28                                        @D61ADJK 52280016
 SGDSK  'CALL  DERCONSK        ','MAKE SEEK ADDR AT DERCCHH',  @DERPDGLX52300016
               I='1,2,3             ON RETURN',                @DERPDGLX52310016
               O='NONE              RF IS RETURN CODE',        @DERPDGLX52320016
               E0='DERD8C10         ERROR: ADDR.NOT MADE'      @DERPDGL 52330016
         LA    R5,DERCCWS2                                     @D51TDPM 52340016
 SGDSK  'CALL  DERDCFIN        ','COMPLETE RECOVERY ',         @DERPDGLX52350016
               I='1,2,3,5           ON RETURN',                @DERPDGLX52360016
               O='B,F               RF CONTAINS COMPL.CODE'    @DERPDGL 52370016
         B     DERD8CEX                                        @D51TDPM 52380016
DERD8C10 EQU   *                                               @D51TDPM 52390016
.NOSUP28 ANOP                                                  @D61ADJK 52410016
         LA    RF,DERRRE          RETURN RECOVERY ERROR FOR... @D51TDPM 52420016
DERD8CEX B     DERDOEX                                         @D51TDPM 52430016
*                                                                       52440016
*-------------------------------------------------------------*@D51TDPM 52450016
*  FUNCTION                                                    @D51TDPM 52460016
*     OPERATION INCOMPLETE ERROR RECOVERY.                     @D51TDPM 52470016
*-------------------------------------------------------------*@D51TDPM 52480016
DEROI    DS    0H                                              @D51TDPM 52490016
*                                                                       52510016
         CLI   PUBDEVTY,TFBA      BRANCH WHEN THE DEVICE IS... @D51TDPM 52520016
         BNE   DEROI100             NOT FBA.                   @D51TDPM 52530016
*                                                              @D51TDPM 52540016
         LA    R9,X'63'           TAKE DEFINE EXTENT OPCODE    @DERPDGL 52550016
 SGDSK  'CALL  DERSCAN         ','FIND THE LAST TIME ITS USED',      GLX52560016
               I='1,9               ON RETURN+4',              @DERPDGLX52570016
               O='5                 R5 POINTS TO FOUND CCW',   @DERPDGLX52580016
               E0='DEROI500         ERROR:NO SUCH OPCODE'      @DERPDGL 52590016
         LR    R8,R5                                           @DERPDGL 52600016
         USING CCWADR,R8                                       @D51TDPM 52610016
         MVC   DERCCWX4,0(R8)     MOVE DEFINE EXTENT CCW       @D14ZDDK 52630016
         MVC   DERLPS,ERRQSNS+8   MOVE LOCATE PARAMETERS       @D37ADDK 52640016
 SGDSK  'CALL  DERRSCW1        ','POINT TO CCWS IN RF AND R8', @DERPDGLX52650016
               I='1,2,3             RF IS RESTART CCW',        @DERPDGLX52660016
               O='8,F               R8 IS INTERRUPTED CCW'     @DERPDGL 52670016
         LTR   RF,RF              BRANCH WHEN RESTART CCW...   @D51TDPM 52680016
         BZ    DEROI500             WAS NOT BUILT.             @D51TDPM 52690016
         MVC   DERCCWR4(8),0(RF)  MOVE IN RESTART CCW.         @D51TDPM 52710016
         TM    CCWCHAIN,DC+CC     BRANCH IF THERE IS NO        @DERPDGL 52720016
         BZ    DEROI090             CONTINUATION OF CHAIN      @DERPDGL 52730016
 SGDSK  'CALL  DERMKTIC        ','TRY TO TIC TO NEXT CCW ',    @DERPDGLX52740016
               I='8                 ON RETURN+4',              @DERPDGLX52750016
               O='8                 R8 NXT CCWS VIRT.ADD',     @DERPDGLX52760016
               E0='DEROI500         ERROR:TIC NOT BUILT'       @D51TDPM 52770016
         MVC   DERCCWR4+8(8),DERTIC    MOVE IN THE TIC CCW.    @D51TDPM 52780016
DEROI090 LA    R5,DERCCWX4        USE THE FBA CHANNEL PROGRAM. @D51TDPM 52790016
         DROP  R8                 DROP CCWADR POINTER          @DERPDGL 52800016
         B     DEROI200                                        @D51TDPM 52810016
*                                                                       52820016
DEROI100 EQU   *                                               @D37ADDK 52830016
 SGDSK  'CALL  DERLSTSK          ','SETUP LST USED SEEK ADDR', @DERPDGLX52850016
               I='1,3                 ON RETURN',              @DERPDGLX52860016
               O='NONE                ADDR IS IN DERLSEEK',    @DERPDGLX52870016
               E0='DEROI500           ERROR: NOT POSSIBLE'     @DERPDGL 52880016
         MVC   DERCCHH,DERLSEEK   MOVE IN THE SEEK ADDRESS.    @D51TDPM 52890016
*                                                                       52900016
*   MAKE THE SEEK AND SEARCH CCWS.                             @D51TDPM 52910016
*                                                                       52920016
         CLI   DERCRSC,DERECBOI                                @D51TDPM 52930016
         BE    DEROI020                                        @D51TDPM 52940016
         LH    RF,DERHH           INCREMENT HEAD               @D37ADDK 52950016
         LA    RF,1(RF)             NUMBER                     @D37ADDK 52960016
         STH   RF,DERHH             BY ONE                     @D37ADDK 52970016
         B     DEROI030                                        @D51TDPM 52980016
DEROI020 DS    0H                                              @D37ADDK 52990016
         MVC   DERHH,ERRQSEK+2    USE FAILING HEAD.            @D51TDPM 53000016
*                                                                       53010016
DEROI030 DS    0H                                              @D37ADDK 53020016
 SGDSK  'CALL  DERRSCW1        ','POINT TO CCWS IN RF AND R8', @DERPDGLX53030016
               I='1,2,3             RF IS RESTART CCW',        @DERPDGLX53040016
               O='8,F               R8 IS INTERRUPTED CCW'     @DERPDGL 53050016
         LTR   RF,RF              BRANCH WHEN RESTART CCW...   @D51TDPM 53060016
         BZ    DEROI500             WAS NOT BUILT.             @D51TDPM 53070016
         MVC   DERCCWR2(8),0(RF)  MOVE IN RESTART CCW.         @D51TDPM 53090016
         USING CCWADR,R8                                       @D51TDPM 53100016
         TM    CCWCHAIN,DC+CC     BRANCH IF THERE IS NO        @DERPDGL 53110016
         BZ    DEROI040             CONTINUATION OF CHAIN      @DERPDGL 53120016
 SGDSK  'CALL  DERMKTIC        ','TRY TO TIC TO NEXT CCW ',    @DERPDGLX53130016
               I='8                 ON RETURN+4',              @DERPDGLX53140016
               O='8                 R8 NXT CCWS VIRT.ADD',     @DERPDGLX53150016
               E0='DEROI500         ERROR:TIC NOT BUILT'       @D51TDPM 53160016
         MVC   DERCCWR2+8(8),DERTIC    MOVE IN THE TIC CCW.    @D51TDPM 53170016
DEROI040 LA    R5,DERCCWS2        USE THE CKD CHANNEL PROGRAM. @D51TDPM 53180016
         DROP  R8                 DROP CCWADR POINTER          @DERPDGL 53190016
*                                                              @D51TDPM 53200016
DEROI200 STCM  R5,B'0111',CCBCCW+1  USE NEW CHANNEL PROGRAM.   @D51TDPM 53210016
 SGDSK  'CALL  DERIO           ','DO UNLIMITED RETRY ',        @DERPDGLX53220016
               I='1,2,3,B           ON RETURN ',               @D61SDJKX53230000
               O='B,F               RF IS RETURN CODE'         @DERPDGL 53240016
         B     DEROIEX                                         @D51TDPM 53250016
*                                                              @D51TDPM 53260016
DEROI500 LA    RF,DERRRE          REOCVERY ERROR.              @D51TDPM 53270016
DEROIEX  B     DERDOEX                                         @D51TDPM 53290016
*                                                                       53300016
*-------------------------------------------------------------*@D51TDPM 53310016
*  FUNCTION                                                    @D51TDPM 53320016
*     RECOVER FROM A BASIC SEEK CHECK ERROR.                   @D51TDPM 53330016
*-------------------------------------------------------------*@D51TDPM 53340016
DERBSC   DS    0H                                              @D51TDPM 53350016
         AGO   .NOSUP04                                        @DERPDGL 53360016
         CLC   DERTYCNT,=F'10'    BRANCH WHEN > 10 RETRIES     @D51TDPM 53370016
         BH    DERDOEX              FOR ORIGINAL ERROR         @D51TDPM 53380016
         MVC   DERSVCCB,CCBADR    SAVE THE CCB.                @D37ADDK 53390016
         LA    R5,DERCCWRC        GET RECALIBRATE CCW ADDRESS  @D34SDDK 53400016
         ST    R5,CCBCCW          STORE CCW ADDR IN ERP CCB    @D37ADDK 53410016
 SGDSK  'CALL  DERIO           ','DO IO AND GET COMPL.CODE',   @DERPDGLX53420016
               I='1,2,3,B           ON RETURN',                @D61SDJKX53430000
               O='B,F               RF IS COMPLETION CODE'     @DERPDGL 53440016
         MVC   CCBADR(L'DERSVCCB),DERSVCCB  RESTORE OLD CCB    @D51TDPM 53450016
         LTR   RF,RF              BRANCH WHEN THE I/O WAS...   @D51TDPM 53460016
         BZ    DERBC010             SUCCESSFUL.                @D51TDPM 53470016
         LA    RF,DERRRE          RECOVERY ERROR.              @D51TDPM 53480016
         B     DERBC020                                        @D51TDPM 53490016
DERBC010 EQU   *                                               @D51TDPM 53500016
 SGDSK  'CALL  DERTYSMP        ','DO A SIMPLE RETRY',          @DERPDGLX53510016
               I='1,2,3,B           ON RETURN',                @DERPDGLX53520016
               O='B,F               RF IS RETURN CODE'         @DERPDGL 53530016
.NOSUP04 ANOP                                                  @DERPDGL 53540016
         LA    RF,DERRRE          RECOVERY ERROR.              @D61ADJK 53550016
DERBC020 B     DERDOEX                                         @D51TDPM 53560016
*                                                                       53570016
*-------------------------------------------------------------*@D51TDPM 53580016
*  FUNCTION                                                    @D51TDPM 53590016
*     FILE PROTECT ERROR RECOVERY.                             @D51TDPM 53600016
*-------------------------------------------------------------*@D51TDPM 53610016
DERFP    DS    0H                                              @D51TDPM 53620016
         AGO   .NOSUP06                                        @DERPDGL 53630016
 SGDSK  'CALL  DERRHAO         ','READ HOME ADDRESS DATA',     @DERPDGLX53640016
               I='1,2,3             ON RETURN ',               @DERPDGLX53650016
               O='B,F               RF POINTS TO DATA'         @DERPDGL 53660016
         LTR   RF,RF              BRANCH WHEN READ HOME...     @D51TDPM 53670016
         BZ    DERFP500             ADDRESS OPERATION FAILS.   @D51TDPM 53680016
         TM    DERHOMAD,ALTTRK    IS IT ALTERNATE TRACK        @D35DDDK 53690016
         BZ    DERFP400                                        @D51TDPM 53700016
         CLC   DERCCHH,DERHOMAD+1 IS THIS ON THE PRIMARY TRACK @DMQ6142 53710016
         BE    DERFP500                                        @D51TDPM 53720016
.*       L     R8,DERFCCWR        FAILING CCW ADDRESS.         @OBSOLET 53730016
.*       LTR   R8,R8              BRANCH WHEN THE FAILING CCW..@OBSOLET 53740016
.*       BZ    DERFP500             IS NOT AVAILABLE.          @OBSOLET 53750016
.* INVOCATION  DERMKTIC HAS BEEN CHANGED AND THIS CODE IS NOT UPDATEDGL 53760016
.*             I='8                 ON RETURN+4',              @OBSOLET 53770016
.*             O='8                 R8 NXT CCWS VIRT.ADD',     @OBSOLET 53780016
.*             E0='DERFP500         ERROR:TIC NOT BUILT'       @OBSOLET 53790016
         MVC   DERCCW,DERTIC      NO RESTART CCW.              @D51TDPM 53800016
         LH    RF,DERHH           INCREMENT THE                @D37ADDK 53810016
         LA    RF,1(RF)             HEAD NUMBER                @D37ADDK 53820016
         STH   RF,DERHH             BY ONE                     @D37ADDK 53830016
         MVC   DERSFMSK,DERSVMSK  RESTORE THE FILE MASK.       @D51TDPM 53840016
         MVC   DERCCWF1,DERSFM    BACK TO INITIAL SFM CCW      @DA34685 53850016
         MVC   DERCCWF2,DERSFM    BACK TO INITIAL SFM CCW      @DA25514 53860016
         MVC   DERCCWF3,DERSFM    BACK TO INITIAL SFM CCW      @DA25514 53870016
         LA    R5,DERCCWS1        USE TRACK CONDITION CHECK... @D34SDDK 53880016
         STCM  R5,B'0111',CCBCCW+1   CHANNEL PROGRAM.          @D51TDPM 53890016
         MVC   DERCCWR1,DERCCW    COPY TRAILER                 @DA25502 53900016
 SGDSK  'CALL  DERIO           ','DO UNLIMITED RETRY ',        @DERPDGLX53910016
               I='1,2,3,B           ON RETURN ',               @D61SDJKX53920000
               O='B,F               RF IS RETURN CODE'         @DERPDGL 53930016
         B     DERFPEX                                         @D51TDPM 53940016
DERFP400 EQU   *                                               @D51TDPM 53950016
         LA    RF,DERREXH         UNCONDITIONAL SURRENDER.     @DERPDGL 53960016
         B     DERFPEX                                         @D51TDPM 53970016
DERFP500 EQU   *                                               @D51TDPM 53980016
.NOSUP06 ANOP                                                  @DERPDGL 53990016
         LA    RF,DERRRE          RECOVERY ERROR.              @D51TDPM 54000016
DERFPEX  B     DERDOEX                                         @D51TDPM 54010016
*                                                                       54020016
*-------------------------------------------------------------*@D51TDPM 54030016
*  FUNCTION                                                    @D51TDPM 54040016
*     TRACK CONDITION CHECK ERROR RECOVERY.                    @D51TDPM 54050016
*-------------------------------------------------------------*@D51TDPM 54060016
DERTCC   DS    0H                                              @D51TDPM 54070016
         AGO   .NOSUP02                                        @DERPDGL 54080016
         L     R8,DERFCCWR        FAILING CCW ADDRESS.         @D51TDPM 54090016
         LTR   R8,R8              BRANCH WHEN THE FAILING CCW..@D51TDPM 54100016
         BZ    DERTC500             IS NOT AVAILABLE.          @D51TDPM 54110016
         CLI   DERCRSC,DERECOIT   B IF NOT OPER.INCOMP.-TRACK  @D51TDPM 54120016
         BNE   DERTC005             CONDITION CHECK            @D51TDPM 54130016
         LA    R8,8(R8)           CONT.CCW IS BEHIND FAILING   @D51TDPM 54140016
DERTC005 EQU   *                                               @D51TDPM 54150016
.* INVOCATION  DERMKTIC HAS BEEN CHANGED AND NOT UPDATED HERE  @DERPDGL 54160016
.*             I='8                 ON RETURN+4',              @DERPDGL 54170016
.*             O='F                 RF NXT CCWS VIRT.ADD',     @DERPDGL 54180016
.*             E0='DERTC500         ERROR:TIC NOT BUILT'       @D51TDPM 54190016
         CLI   DERCRSC,DERECOIT   B IF NOT OPER.INCOMP.-TRACK  @D51TDPM 54200016
         BNE   DERTC010             CONDITION CHECK            @D51TDPM 54210016
 SGDSK  'CALL  DERRSCW2        ','POINT TO CCWS IN RF AND R8', @DERPDGLX54220016
               I='1,2,3             RF IS RESTART CCW',        @DERPDGLX54230016
               O='8,F               R8 IS INTERRUPTED CCW'     @DERPDGL 54240016
         LTR   RF,RF              BRANCH IF NO RESTART CCW     @DERPDGL 54250016
         BZ    DERTC500             WAS BUILT                  @DERPDGL 54260016
         B     DERTC020                                        @D51TDPM 54270016
DERTC010 EQU   *                                               @D51TDPM 54280016
         MVC   DERCCW,DERTIC      NO RESTART CCW.              @D51TDPM 54290016
DERTC020 EQU   *                                               @D51TDPM 54300016
 SGDSK  'CALL  DERRHAO         ','READ HOME ADDRESS DATA',     @DERPDGLX54310016
               I='1,2,3             ON RETURN ',               @DERPDGLX54320016
               O='B,F               RF POINTS TO DATA'         @DERPDGL 54330016
         LTR   RF,RF              BRANCH IF HOMEADDRESS COULD  @DERPDGL 54340016
         BZ    DERTC500             NOT BE READ                @DERPDGL 54350016
         CLC   DERCCHH,DERHOMAD+1 IS THIS ON THE PRIMARY TRACK @DMQ6142 54360016
         BE    DERTC500           YES  RECOVERY NOT POSSIBLE   @DMQ6142 54370016
         TM    DERHOMAD,ALTTRK    IS IT ALTERNATE TRACK        @D35DDDK 54380016
         BO    DERTC030           YES  GO INCREMENT SEEK ADDR  @D37ADDK 54390016
         MVI   DERCCWF1,SFM       ASSURE SFM CCW               @D14ZDDK 54400016
         OI    DERSFMSK,INHALLSK  INHIBIT ALL SEEKS            @DA34417 54410016
         MVC   DERCCWF2,DERCCWF1  USE THIS SFM CCW ON ALT TRK  @DA25514 54420016
         MVC   DERCCWF3,DERCCWF1  USE THIS SFM CCW ON ALT TRK  @DA25514 54430016
         B     DERTC050           SEEK ADDRESS IS OK           @D37ADDK 54440016
DERTC030 EQU   *                                               @D37ADDK 54450016
         LH    RF,DERHH           INCREMENT THE                @D37ADDK 54460016
         LA    RF,1(RF)             HEAD NUMBER                @D37ADDK 54470016
         STH   RF,DERHH             BY ONE                     @D37ADDK 54480016
DERTC040 EQU   *                                               @DA34685 54490016
         MVC   DERSFMSK(1),DERSVMSK RESTORE FILE PROTECT MASK  @DA34685 54500016
         MVC   DERCCWF1,DERSFM    BACK TO INITIAL SFM CCW      @DA34685 54510016
         MVC   DERCCWF2,DERSFM    BACK TO INITIAL SFM CCW      @DA25514 54520016
         MVC   DERCCWF3,DERSFM    BACK TO INITIAL SFM CCW      @DA25514 54530016
DERTC050 EQU   *                                               @D34SDDK 54540016
         LA    R5,DERCCWS1        USE TRACK CONDITION CHECK... @D34SDDK 54550016
         STCM  R5,B'0111',CCBCCW+1   CHANNEL PROGRAM.          @D51TDPM 54560016
         MVC   DERCCWR1,DERCCW    COPY TRAILER                 @DA25502 54570016
 SGDSK  'CALL  DERIO           ','DO UNLIMITED RETRY ',        @DERPDGLX54580016
               I='1,2,3,B           ON RETURN ',               @D61SDJKX54590000
               O='B,F               RF IS RETURN CODE'         @DERPDGL 54600016
         B     DERTCEX                                         @D51TDPM 54610016
DERTC500 EQU   *                                               @D51TDPM 54620016
.NOSUP02 ANOP                                                  @DERPDGL 54630016
         LA    RF,DERRRE          RECOVERY ERROR.              @D51TDPM 54640016
DERTCEX  B     DERDOEX                                         @D51TDPM 54650016
*                                                                       54660016
         DROP  ,                                               @D66ADAP 54670016
         USING SYSS00,R0                                       @D66ADAP 54680016
         LTORG                                                 @D51TDPM 54690016
*-------------------------------------------------------------*@D51TDPM 54700016
*    END OF SELECT OF RECOVERY ACTIONS.                                 54710016
*    THE FOLLOWING ARE SUBROUTINES TO RECOVERY ACTIONS                  54720016
*-------------------------------------------------------------*@D51TDPM 54730016
*                                                                       54740016
         AGO   .NOSUP12     SEE UNSUPPORTED REMARK IN HEADER   @DERPDGL 54750016
.*  THIS FUNCTION WAS NOT YET REMOVED TO FACILITATE SUPPORT    @DERPDGL 54760016
.*  REINTRODUCTION FOR 333X AND 334X IN CASE ITS NEEDED..      @DERPDGL 54770016
***************************************************************         54780016
*  FUNCTION                                                    @D51TDPM 54790016
*     PERFORM THE READ HOME ADDRESS OPERATION.                 @D51TDPM 54800016
*                                                              @D51TDPM 54810016
*  INPUT                                                       @D51TDPM 54820016
*    - R1 CONTAINS THE ADDRESS OF A CCB.                       @D51TDPM 54830016
*    - R2 CONTAINS THE ADDRESS OF AN ERROR BLOCK.              @D51TDPM 54840016
*    - R3 CONTAINS THE ADDRESS OF A PUB.                       @D51TDPM 54850016
*                                                              @D51TDPM 54860016
*  OUTPUT                                                      @D51TDPM 54870016
*    - RF POINTS TO READ HOME ADDRESS DATA WHICH IS MAPPED BY  @D51TDPM 54880016
*      DERHADAT.  RF IS ZERO WHEN THE READ HOME ADDRESS        @D51TDPM 54890016
*      OPERATION FAILED.                                       @D51TDPM 54900016
*                                                              @D51TDPM 54910016
***************************************************************         54920016
 AGO  .GRHAO                                                  *#SECURGL 54930016
.LRHAO   AIF ('&TEST'(1,14) NE 'CALL  DERRHAO ').LECF         *#SECURGL 54940016
 AIF   ('&I'(2,6)  NE '1,2,3 '                 ).DSINVC       *#SECURGL 54950016
 AIF   ('&O'(2,4)  EQ 'B,F '                   ).DSHEAD       *#SECURGL 54960016
 AGO  .DSINVC                                                 *#SECURGL 54970016
.GRHAO    ANOP                                                *#SECURGL 54980016
.**************************************************************         54990016
DERRHAO  SGDSK 'HEADING        ','START OF CODEBLOCK'          @DERPDGL 55000016
         USING CCBADR,R1                                       @D51TDPM 55010016
         USING ERBLKADR,R2                                     @D51TDPM 55020016
         USING PUBADR,R3                                       @D51TDPM 55030016
*                                                              @D51TDPM 55040016
         MVC   DERSEEK(2),=X'0000'    BUILD SEEK ADDRESS FROM  @D51TDPM 55050016
         MVC   DERSEEK+2(4),ERRQSEK   FAILING SEEK ADDRESS     @D51TDPM 55060016
         MVC   DERSVCCB,CCBADR    MAKE CCB.                    @D37ADDK 55070016
         LA    R5,DERCCWRH        GET READ HA CCW ADDRESS      @D34SDDK 55080016
         ST    R5,CCBCCW          STORE CCW ADDR IN ERP CCB    @D37ADDK 55090016
         IC    R5,DERIOKEY        SET STORAGE KEY FOR IO       @DERPDGL 55100016
         MVI   DERIOKEY,0           OPERATION TO ZERO.         @DERPDGL 55110016
 SGDSK  'CALL  DERIO           ','DO IO AND GET COMPL.CODE',   @DERPDGLX55120016
               I='1,2,3,B           ON RETURN',                @D61SDJKX55130000
               O='B,F               RF IS COMPLETION CODE'     @DERPDGL 55140016
         STC   R5,DERIOKEY        RESET STORAGE KEY FOR IO OPS.@DERPDGL 55150016
         MVC   CCBADR(L'DERSVCCB),DERSVCCB   RESTORE CCB       @D37ADDK 55160016
         LTR   RF,RF              BRANCH WHEN THE I/O WAS...   @D51TDPM 55170016
         BZ    DERHA010             SUCCESSFUL.                @D51TDPM 55180016
         LA    RF,0               IND.NO HOME ADDR.DATA AVAIL. @D51TDPM 55190016
         B     DERHA020                                        @D51TDPM 55200016
DERHA010 EQU   *                                               @D51TDPM 55210016
         LA    RF,DERHOMAD        RETURN ADDR OF HOME ADDR DATA@D51TDPM 55220016
DERHA020 SGDSK 'RETURN         ','RETURN TO CALLER         ',  @DERPDGLX55230016
               OUTPUT=(RB,RF)                                  @DERPDGL 55240016
         DROP  ,                                               @D66ADAP 55250016
         USING SYSS00,R0                                       @D66ADAP 55260016
         LTORG                                                 @D51TDPM 55270016
.NOSUP12 ANOP                                                  @DERPDGL 55280016
*                                                                       55290016
***************************************************************         55300016
*  FUNCTION                                                    @D51TDPM 55310016
*     PERFORM DATA CORRECTION FOR DATA CHECK ERROR CONDITIONS. @D51TDPM 55320016
.*    FOR UNCLARITIES IN THE BOOK SEE DERECF COMMENT ABOVE     @DERPDGL 55330016
*                                                              @D51TDPM 55340016
*  INPUT                                                       @D51TDPM 55350016
*    - R2 CONTAINS THE ADDRESS OF AN ERROR BLOCK.              @D51TDPM 55360016
*    - R3 CONTAINS THE ADDRESS OF A PUB.                       @D51TDPM 55370016
*                                                              @D51TDPM 55380016
*  OUTPUT ON EXIT TO RETURN PLUS 4:                            @D51TDPM 55390016
*    - R7 CONTAINS A VALUE, THAT CAN BE USED FOR THE CONSTRUC- @D51TDPM 55400016
*         TION OF THE RESIDUAL COUNT FOR A CORRECTABLE DATA    @D51TDPM 55410016
*         CHECK THAT IMPLIED CHANNEL COMMAND RETRY.            @D51TDPM 55420016
*         IF THE VALUE IS >= 0, IT IS A RESIDUAL COUNT         @D51TDPM 55430016
*         IF IT IS < 0  THE USER HAD ASKED FOR LESS DATA       @D51TDPM 55440016
*         THAN THE RECORD ACTUALLY CONTAINED.                  @D51TDPM 55450016
*    - R8 CONTAINS THE VIRTUAL ADDRESS OF THE LAST CCW DATA    @D51TDPM 55460016
*         CHAINED TO THE FAILING COMMAND CCW.                  @D51TDPM 55470016
*    - R9 CONTAINS THE VIRTUAL ADDRESS OF THE CCW THAT BELONGS @D51TDPM 55480016
*         TO THE RESIDUAL COUNT VALUE IN REGISTER R7.          @D51TDPM 55490016
.*        IN OTHER WORDS THE ADDRESS OF THAT CCW, THAT         @DA41424 55500016
.*        PROCESSING STOPPED WITH. IN CASE OF JUST ONE         @DA41424 55510016
.*        CCW ITS THIS ADDRESS, WITH A DATA CHAIN OF SEVERAL   @DA41424 55520016
.*        IT CAN ALSO BE SOMEWHERE IN THE MIDDLE OR            @DA41424 55530016
.*        EQUAL TO R8, THE END.                                @DA41424 55540016
*                                                              @D51TDPM 55550016
*  OUTPUT ON EXIT TO RETURN PLUS 0: (ERROR EXIT)               @D51TDPM 55560016
*    - NONE                                                    @D51TDPM 55570016
*                                                              @D51TDPM 55580016
***************************************************************         55590016
 AGO  .GECF                                                   *#SECURGL 55600016
.LECF    AIF ('&TEST'(1,14) NE 'CALL  DERECF  ').LCONSK       *#SECURGL 55610016
 AIF   ('&I'(2,4)  NE '2,3 '                   ).DSINVC       *#SECURGL 55620016
 AIF   ('&O'(2,6)  NE '7,8,9 '                 ).DSINVC       *#SECURGL 55630016
 AIF   (T'&E0      EQ 'O'                      ).DSINVC       *#SECURGL 55640016
 AIF   (T'&E4      EQ 'O'                      ).DSHEAD       *#SECURGL 55650016
 AGO  .DSINVC                                                 *#SECURGL 55660016
.GECF     ANOP                                                *#SECURGL 55670016
.**************************************************************         55680016
DERECF   SGDSK 'HEADING        ','START OF CODEBLOCK'          @DERPDGL 55690016
         USING ERBLKADR,R2                                     @D51TDPM 55700016
         USING PUBADR,R3                                       @D51TDPM 55710016
*                                                              @D51TDPM 55730016
         L     R8,DERCCCWV        FAILING COMMAND CCW ADDR.    @D51TDPM 55740016
         LTR   R8,R8              BRANCH WHEN THE FAILING...   @DERPDGL 55750016
         BZ    DERCFEX0             CCW IS NOT ACCESSIBLE.     @DERPDGL 55760016
         CLI   PUBDEVTY,TFBA      BRANCH WHEN THE DEVICE IS... @D51TDPM 55780016
         BNE   DERCF010             NOT FBA.                   @D51TDPM 55790016
         SLR   R5,R5                                           @DERPDGL 55810016
         ICM   R5,3,ERRQSNS+16    LOAD BLOCKS TRANSFERRED      @D37ADDK 55820016
 SGDSK  'CALL  DERFBABS        ','GET BLOCKSIZE OF DEVICE',    @DERPDGLX55830016
               I='3                 ON RETURN ',               @DERPDGLX55840016
               O='F                 RF IS BLOCKSIZE  '         @DERPDGL 55850016
         LTR   RF,RF              BRANCH WHEN BLOCKSIZE IS...  @D51TDPM 55860016
         BZ    DERCFEX0             INVALID.                   @D51TDPM 55870016
         MR    R4,RF              NUMBER OF BYTES TRANSFERRED. @D35DDDK 55890016
         B     DERCF020                                        @D51TDPM 55900016
DERCF010 EQU   *                                               @D51TDPM 55910016
         SLR   R5,R5                   GET THE NUMBER OF...    @D51TDPM 55920016
         ICM   R5,B'0111',ERRQSNS+15     BYTES TRANSFERRED.    @D51TDPM 55930016
DERCF020 EQU   *                                               @D51TDPM 55940016
         DROP  R3                 PUB NO LONGER REQUIRED       @DA41424 55960016
         LR    R7,R5              REMEMBER BYTES TRANSFERRED.  @D51TDPM 55970016
         SLR   R0,R0              CLEAR WORK REGISTER          @D14ZDDK 55980016
         ICM   R0,3,ERRQSNS+18    INSERT REAR DISPLACEMENT     @D37ADDK 55990016
         SR    R5,R0              SUBTRACT REAR DISPLACEMENT   @D37ADDK 56000016
         SLR   R3,R3               GET THE NUMBER OF ERROR...  @D51TDPM 56010016
         ICM   R3,B'0001',DERCRECC   CORRECTION BYTES.         @D51TDPM 56020016
         CR    R3,R0              B IF NR OF BYTES TO CORRECT  @D51TDPM 56030016
         BL    DERCF030             IS THE SAME AS EXPECTED    @D51TDPM 56040016
         LR    R3,R0                                           @D51TDPM 56050016
DERCF030 EQU   *                                               @D51TDPM 56070016
         LA    R4,ERRQSNS+20                                   @DERPDGL 56080016
         DROP  R2                 R2 NOW USED AS COUNTER       @DA41424 56090016
*                                                                       56100016
*   NOW START ACTUAL CORRECTION OF BYTES                       @D51TDPM 56110016
*    - R2 COUNTS THE NR OF CCWS TO AVOID AN ENDLESS LOOP       @D51TDPM 56120016
*    - R3 IS THE NUMBER OF BYTES TO CORRECT                    @D51TDPM 56130016
*    - R4 POINTS TO ERROR CORRECTION BYTES.                    @D51TDPM 56140016
*    - R5 CONTAINS THE DISPLACEMENT FROM THE START OF THE CCW  @D51TDPM 56150016
*         DATA AREA TO THE BYTES IN ERROR.                     @D51TDPM 56160016
*    - R6 CONTAINS THE COUNT OF THE CCW, THAT REGISTER R8      @D51TDPM 56170016
*         POINTS TO.                                           @D51TDPM 56180016
*    - R7 AT THE BEGINNING OF THE LOOP, IT CONTAINS THE LENGTH @D51TDPM 56190016
*         OF THE RECORD ON THE TRACK, AS TAKEN FROM SENSE      @D51TDPM 56200016
*         DATA. BY SUBTRACTING THE COUNTS OF THE SCANNED       @DA41424 56210016
*         CCWS THIS IS MADE THE RESIDUAL COUNT OF THE REQUEST  @DA41424 56220016
*    - R8 STARTS AS THE BEGIN ADDRESS OF THE DATA CHAIN (IF    @D51TDPM 56230016
*         THERE IS ONE) AND FINALLY POINTS AT THE LAST CCW IN  @DA41424 56240016
*         THE CHAIN.                                           @DA41424 56250016
*    - R9 WILL BE A POINTER TO THE CCW FOR THE RESIDUAL COUNT  @D51TDPM 56260016
*         WHICH IS IN R7                                       @D51TDPM 56270016
*                                                              @D51TDPM 56280016
         USING CCWADR,R8                                       @D51TDPM 56290016
         LA    R2,4000            ALLOW DATA CHAIN OF THIS LNG.@DA41424 56300016
         LR    R9,R8              INITIALIZE CCW POINTER       @DA41424 56310016
         XR    R6,R6              NUMBER OF BYTES IN THE...    @D51TDPM 56320016
         ICM   R6,3,CCWLNG          CURRENT CCW.               @D51TDPM 56330016
*                                                              @D51TDPM 56340016
         LTR   R3,R3              BRANCH WHEN THERE ARE NO...  @D51TDPM 56350016
         BZ    DERBY120             CORRECTION BYTES.          @DA41511 56360016
DERBY050 EQU   *                                               @DL28754 56380016
         LR    R0,R5              DISP INTO R0.                @DL28754 56390016
         CLR   R0,R6              IS ERROR IN THIS SEGMENT     @DL28754 56400016
         BNL   DERBY120           NO  SKIP                     @DL28754 56410016
         TM    CCWCHAIN,SKIP      IS SKIP FLAG ON IN CCW       @DL28754 56420016
         BO    DERBY110           YES  SKIP                    @DL28754 56430016
*                                                                       56440016
*  THERE'S A SPECIAL CASE FOR PAGE-IN I/O.  PAGE-IN I/O IS THE          56450016
*  ONLY DISK READ I/O IN THE SYSTEM THAT READS INTO A PAGE              56460016
*  FRAME WHICH IS NOT ADDRESSABLE.  THEREFORE, THE ONLY WAY WE          56470016
*  CAN CORRECT THIS DATA CHECK IN THAT CASE IS TO TURN OFF DAT          56480016
*  AND USE REAL ADDRESSING.  WE DON'T HAVE A GOOD WAY OF                56490016
*  DETERMINING IF THE I/O IN QUESTION IS PAGE-IN I/O, BUT WE            56500016
*  PRESUME IT IS IF IT IS BY THE PMR TASK AND THE FAILING CCW  @D51CDBH 56510016
*  HAS A COUNT OF 4K.                                          @DA40798 56520016
*  (AND OF COURSE, AT THIS POINT WE KNOW IT IS A DISK READ).            56530016
*                                                                       56540016
*   GET THE ADDRESS OF THE TASK THAT REQUESTED THE I/O         @D51TDPM 56550016
*   ASSOCIATED WITH THE ORIGINAL ERROR CONDITION.              @D51TDPM 56560016
*                                                                       56570016
         LA    RF,PMRTID          PMR TASK-ID                  @D66CDAP 56580016
         CH    RF,DERTID          REQUEST FROM PMR TASK        @D66CDAP 56590016
         BNE   DERBY100             NO  SKIP SPECIAL ACTION    @D36ZDDK 56600016
         CLC   CCWLNG,DER4K       IF COUNT NOT 4K, NOT PAGE-IN,@D51CDBH 56610016
         BNE   DERBY100             SO BRANCH                  @D51CDBH 56620016
*                                                              @D51CDBH 56630016
*  IT'S PAGE-IN I/O.                                          *         56640016
*                                                             *         56650016
*  WE NOW TAKE ADVANTAGE OF THE FACT THAT THE FAILING CCW     *         56660016
*  IS READING INTO A SINGLE WHOLE PAGE FRAME.                 *@D51CDBH 56670016
*                                                             *         56680016
*  SINCE WE ARE USING REAL ADDRESSING, WE MUST WORK IN 31-BIT *@D51CDBH 56690016
*  MODE, SINCE REAL ADDRESSES CAN BE > 16M.                   *@D51CDBH 56700016
*                                                                       56710016
         STNSM DERSM,B'11111011'  SET DAT BIT OFF              @D51CDBH 56720016
         SR    RF,RF              GET ADDR DATA                @D51CDBH 56730016
         ICM   RF,B'0111',CCWBUF+1  OR IDAL IN RF              @D51CDBH 56740016
         TM    CCWCHAIN,IDAL                                   @DA41381 56750016
         BNO   DERBY090                                        @DA41381 56760016
         L     RF,0(RF)           GET ADDR OF FRAME IN RF      @D51CDBH 56770016
DERBY090 DS    0H                                              @DA41381 56780016
         LA    RF,0(RF,R5)        ADD FORWARD DISPLACEMENT     @DL28754 56790016
         XC    0(1,RF),0(R4)      APPLY ECC BYTE TO DATA       @DL28754 56800016
         SSM   DERSM              RESTORE DAT BIT              @D51CDBH 56810016
*                                                                       56820016
 SGDSK  'CALL  DERTRACE         ','CALL FOR DEBUG ENTRY',      @DERPDGLX56830016
               NR='5                 TELL WHAT WAS CHANGED'    @DERPDGL 56840016
         B     DERBY110           EVER ONWARD                  @DL28754 56850016
*                                                                       56860016
DERBY100 EQU   *                                               @D35DDDK 56870016
         STM   R0,RE,DERDERSV                                  @D51TDPM 56880016
         L     R6,DISPAD          GET ADDRESSABILITY TO THE... @D51TDPM 56890016
         USING DISP,R6              DISPATCHER.                @D51TDPM 56900016
         AMODESW SET,AMODE=24,WR=(R7) ENTER 24-BIT ADDR. MODE  @D52VDAP 56910016
         BAL   R7,GETDADR         GET DATA ADDRESS             @D14ZDDK 56920016
         DROP  R6,RC                                           @D51TDPM 56930016
         BALR  RA,0                      RESTORE GLOBAL AREA   @DERPDGL 56940016
         USING *,RA                                            @DERPDGL 56950016
         ICM   RA,8,=X'00'                                     @DERPDGL 56960016
         AMODESW SET,AMODE=31,WR=(R7) ENTER 31-BIT ADDR. MODE  @D52VDAP 56970016
         L     RA,=A(DERGLOB)            POINTER AND RELOAD    @DERPDGL 56980016
         USING DERGLOB,RA                                      @DERPDGL 56990016
         LM    R0,RE,DERDERSV            ALL REGS EXCEPT ANSWER@DERPDGL 57000016
         USING DERECF,RC                 REG OF GETDADR        @D51TDPM 57010016
         LTR   RF,RF              SET CONDITION CODE           @D14ZDDK 57030016
         BZ    DERCFEX0           SKIP IF INVALID              @D14ZDDK 57040016
         XC    0(1,RF),0(R4)      APPLY ECC BYTE TO DATA       @DL28754 57050016
 SGDSK  'CALL  DERTRACE         ','CALL FOR DEBUG ENTRY',      @DERPDGLX57060016
               NR='6                 TELL WHAT WAS CHANGED'    @DERPDGL 57070016
*                                                              @DL28754 57080016
DERBY110 LA    R4,1(R4)           POINT TO NEXT ECC BYTE       @DL28754 57090016
         LA    R5,1(R5)           INCR FORWARD DISPLACEMENT    @DL28754 57100016
         BCT   R3,DERBY050        DECR AND TEST LOOP COUNT     @DL28754 57110016
*                                                                       57120016
DERBY120 TM    CCWCHAIN,DC        IS DATA CHAIN FLAG ON        @D14ZDDK 57130016
         BZ    DERBY140           NO  SKIP                     @D37ADDK 57140016
         BCT   R2,DERBY121        LEAVE IF PERMITTED NR OF DATA@DA41424 57160016
         B     DERCFEX0             CHAINED CCWS EXCEEDED      @DA41424 57180016
DERBY121 LTR   R7,R7              ONLY DECREMENT IF THE NR IS  @DA41424 57190016
         BM    DERBY122             NOT YET NEGATIVE !!        @DA41424 57200016
         SR    R7,R6              DECR.CLOCKED BYTES BY COUNT  @DERPDGL 57220016
         LR    R9,R8              KEEP CCW IN MIND             @DA41424 57230016
DERBY122 DS    0H                                              @DA41424 57240016
         SR    R5,R6              DECR FORWARD DISPLACEMENT    @DERPDGL 57250016
 SGDSK  'CALL  DERBUMP         ','BUMP TO NEXT CCW ',          @DERPDGLX57260016
               I='8                 ON RETURN TO +8 ',         @DERPDGLX57270016
               O='8                 R8 POINTS TO NXT CCW',     @DERPDGLX57280016
               E0='DERCFEX0         ERROR: NOT ADDRESSABLE',   @DERPDGLX57290016
               E4='DERCFEX0         ERROR: CHAIN ENDED'        @DERPDGL 57300016
DERBY130 EQU   *                                               @DL28754 57310016
         ICM   R6,3,CCWLNG        GET COUNT FROM NEW CCW       @DERPDGL 57320016
         LTR   R3,R3              ARE ECF BYTES USED UP        @D36ZDDK 57330016
         BNP   DERBY120           YES  LOOP AND CLEAN UP       @DL28754 57340016
         B     DERBY050           CONTINUE ECF ON NEW SEGMENT  @D34DDDK 57360016
*                                                              @DERPDGL 57370016
DERBY140 DS    0H                                              @D35DDDK 57380016
         LTR   R7,R7                COUNT WHILE WALKING THRU   @DA41424 57390016
         BP    DERBY142             USER CHAIN,                @DA41424 57400016
         LCR   R7,R7              JUST MAKE IT POSITIVE AND    @DA41424 57420016
         B     DERBY150           LEAVE.                       @DA41424 57430016
*                                 OTHERWISE                    @DA41424 57440016
.*  COMING HERE MEANS, THAT THE NUMBER OF BYTES FOR THE        @DA41424 57450016
.*  RECORD ON THE TRACK WAS BIGGER THAN THE NUMBER OF          @DA41424 57460016
.*  BYTES REQUESTED BY THE SUM OF ALL DATA CHAINED CCWS.       @DA41424 57470016
.*  OR THAT THE CORRECTABLE DATA CHECK WAS IN THE LAST OR      @DA41424 57480016
.*  POSSIBLY ONLY CCW IN THE CHAIN.                            @DA41424 57490016
.*                                                             @DA41424 57500016
DERBY142 LCR   R7,R7              MAKE THE POSITIVE VALUE      @DERPDGL 57510016
         AR    R7,R6                NEGATIVE AND ADD LAST COUNT@DERPDGL 57520016
.*                                  THE RESULT SHOULD BE POS.  @DA41424 57530016
         LR    R9,R8              TAKE CURRENT AS CCW ADDRESS  @DA41424 57540016
*                                                              @DA41424 57560016
DERBY150 DS    0H                 FINISHED.                    @D51TDPM 57570016
DERCFEX4 DS    0H                                              @DERPDGL 57580016
 SGDSK  'CALL  DERTRACE         ','CALL FOR DEBUG ENTRY',      @DERPDGLX57590016
               NR='7                 TELL WHAT WAS CHANGED'    @DERPDGL 57600016
         SGDSK 'RETURN4        ','RETURN TO CALLER         ',  @DERPDGLX57610016
               OUTPUT=(R7,R8,R9)                               @DERPDGL 57620016
DERCFEX0 DS    0H                                              @DERPDGL 57630016
 SGDSK  'CALL  DERTRACE         ','CALL FOR DEBUG ENTRY',      @DERPDGLX57640016
               NR='8                 TELL WHAT WAS CHANGED'    @DERPDGL 57650016
         SGDSK 'RETURN         ','ERROR EXIT TO CALLER     '   @DERPDGL 57660016
         DROP  ,                                               @D66ADAP 57670016
         USING SYSS00,R0                                       @D66ADAP 57680016
*                                                                       57690016
DER4K    DC    H'4096'            CONSTANT: HALFWORD 4K        @D51CDBH 57700016
         LTORG                                                 @D51TDPM 57710016
*                                                                       57720016
***************************************************************         57730016
*  FUNCTION                                                    @D51TDPM 57740016
*     CONTRUCT THE GLOBAL SEEK ADDRESS.                        @D51TDPM 57750016
*                                                              @D51TDPM 57760016
*  INPUT                                                       @D51TDPM 57770016
*    - R1 CONTAINS THE ADDRESS OF A CCB.                       @D51TDPM 57780016
*    - R2 CONTAINS THE ADDRESS OF AN ERROR BLOCK.              @D51TDPM 57790016
*    - R3 CONTAINS THE ADDRESS OF A PUB.                       @D51TDPM 57800016
*                                                              @D51TDPM 57810016
*  OUTPUT                                                      @D51TDPM 57820016
*    - RETURN PLUS 4: DERCCHH IS SET UP CORRECTLY              @D51TDPM 57830016
*    - RETURN PLUS 0: ERROR.                                   @D51TDPM 57840016
***************************************************************         57850016
 AGO  .GCONSK                                                 *#SECURGL 57860016
.LCONSK  AIF ('&TEST'(1,14) NE 'CALL  DERCONSK').LDCFIN       *#SECURGL 57870016
 AIF   ('&I'(2,6)  NE '1,2,3 '                 ).DSINVC       *#SECURGL 57880016
 AIF   ('&O'(2,4)  EQ 'NONE'                   ).DSHEAD       *#SECURGL 57890016
 AGO  .DSINVC                                                 *#SECURGL 57900016
.GCONSK   ANOP                                                *#SECURGL 57910016
.**************************************************************         57920016
DERCONSK SGDSK 'HEADING        ','START OF CODEBLOCK'          @DERPDGL 57930016
         USING CCBADR,R1                                       @D51TDPM 57940016
         USING ERBLKADR,R2                                     @D51TDPM 57950016
         USING PUBADR,R3                                       @D51TDPM 57960016
*                                                              @D51TDPM 57970016
 SGDSK  'CALL  DERLSTSK          ','SETUP LST USED SEEK ADDR', @DERPDGLX57990016
               I='1,3                 ON RETURN',              @DERPDGLX58000016
               O='NONE                ADDR IS IN DERLSEEK',    @DERPDGLX58010016
               E0='DERCSKE0           ERROR: NOT POSSIBLE'     @DERPDGL 58020016
         MVC   DERCCHH,DERLSEEK        SEEK ADDRESS.           @D51TDPM 58040016
         MVC   DERHH+1(1),ERRQSNS+6    NEW TRACK...            @D51TDPM 58050016
         NC    DERHH+1(1),DERCRCLH       ADDRESS.              @D51TDPM 58060016
DERCSKE4 SGDSK 'RETURN4        ','RETURN SEEK MADE'            @DERPDGL 58070016
DERCSKE0 SGDSK 'RETURN         ','RETURN ERROR'                @DERPDGL 58080016
         DROP  ,                                               @D66ADAP 58090016
         USING SYSS00,R0                                       @D66ADAP 58100016
         LTORG                                                 @D51TDPM 58110016
*                                                                       58120016
         AGO   .NOSUP31     SEE UNSUPPORTED REMARK IN HEADER   @D61ADJK 58130016
.*  THIS FUNCTION WAS NOT YET REMOVED TO FACILITATE SUPPORT    @D61ADJK 58140016
.*  REINTRODUCTION FOR 3350 IN CASE ITS NEEDED..               @D61ADJK 58150016
***************************************************************         58160016
*  FUNCTION                                                    @D51TDPM 58170016
*     FINISH RECOVERY FOR MOST OF THE DATA CHECK ERROR         @D51TDPM 58180016
*     CONDITIONS.  THIS INCLUDES BUILDING THE RESTART AND      @D51TDPM 58190016
*     TIC TO CONTINUATION CCWS.  THEN I/O IS REQUESTED FOR     @D51TDPM 58200016
*     THE NEWLY BUILT CHANNEL PROGRAM.                         @D51TDPM 58210016
*                                                              @D51TDPM 58220016
*  INPUT                                                       @D51TDPM 58230016
*    - R1 CONTAINS THE ADDRESS OF A CCB.                       @D51TDPM 58240016
*    - R2 CONTAINS THE ADDRESS OF AN ERROR BLOCK.              @D51TDPM 58250016
*    - R3 CONTAINS THE ADDRESS OF A PUB.                       @D51TDPM 58260016
*    - R5 CONTAINS THE ADDRESS OF THE FIRST CCW IN THE CHANNEL @D51TDPM 58270016
*      PROGRAM FOR WHICH UNLIMITED RETRY IS REQUESTED.         @D51TDPM 58280016
*                                                              @D51TDPM 58290016
*  OUTPUT                                                      @D51TDPM 58300016
*    - RF WILL BE SET TO THE RECOVERY COMPLETION CODE.         @D51TDPM 58310016
*    - RB MAY HAVE A ZERO INSTEAD OF A USER CCB IF THIS WAS    @D51TDPM 58320016
*         PAGED OUT                                            @D51TDPM 58330016
*                                                              @D51TDPM 58340016
***************************************************************         58350016
 AGO  .GDCFIN                                                 *#SECURGL 58360016
.LDCFIN  AIF ('&TEST'(1,14) NE 'CALL  DERDCFIN').LFBABS       *#SECURGL 58370016
 AIF   ('&I'(2,8)  NE '1,2,3,5 '               ).DSINVC       *#SECURGL 58380016
 AIF   ('&O'(2,4)  EQ 'B,F '                   ).DSHEAD       *#SECURGL 58390016
 AGO  .DSINVC                                                 *#SECURGL 58400016
.GDCFIN   ANOP                                                *#SECURGL 58410016
.**************************************************************         58420016
DERDCFIN SGDSK 'HEADING        ','START OF CODEBLOCK'          @DERPDGL 58430016
         USING CCBADR,R1                                       @D51TDPM 58440016
         USING ERBLKADR,R2                                     @D51TDPM 58450016
         USING PUBADR,R3                                       @D51TDPM 58460016
*                                                              @D51TDPM 58480016
*                                                              @D51TDPM 58490016
*   USE THE GIVEN CHANNEL PROGRAM.                             @D51TDPM 58500016
*                                                              @D51TDPM 58510016
         STCM  R5,B'0111',CCBCCW+1                             @D51TDPM 58520016
 SGDSK  'CALL  DERRSCW2        ','POINT TO CCWS IN RF AND R8', @DERPDGLX58530016
               I='1,2,3             RF IS RESTART CCW',        @DERPDGLX58540016
               O='8,F               R8 IS INTERRUPTED CCW'     @DERPDGL 58550016
         LTR   RF,RF              BRANCH WHEN RESTART CCW...   @D51TDPM 58560016
         BZ    DERDC500             WAS NOT BUILT.             @D51TDPM 58570016
         USING CCWADR,R8                                       @D51TDPM 58580016
         TM    CCWCHAIN,CC+DC     BRANCH WHEN TIC IS NOT       @D51TDPM 58590016
         BZ    DERDC100             NECCESSARY.                @D51TDPM 58600016
 SGDSK  'CALL  DERMKTIC        ','TRY TO TIC TO NEXT CCW ',    @DERPDGLX58610016
               I='8                 ON RETURN+4',              @DERPDGLX58620016
               O='8                 R8 NXT CCWS VIRT.ADD',     @DERPDGLX58630016
               E0='DERDC500         ERROR:TIC NOT BUILT'       @D51TDPM 58640016
         DROP  R8                                              @D51TDPM 58650016
DERDC100 EQU   *                                               @D51TDPM 58660016
         MVC   DERCCWR2,DERCCW    COPY TRAILER                 @DA24935 58670016
         MVC   DERCCWR4,DERCCW    COPY TRAILER                 @DA24935 58680016
 SGDSK  'CALL  DERIO           ','DO UNLIMITED RETRY ',        @DERPDGLX58690016
               I='1,2,3,B           ON RETURN ',               @D61SDJKX58700000
               O='B,F               RF IS RETURN CODE'         @DERPDGL 58710016
DERDCEX  SGDSK 'RETURN         ','RETURN TO CALLER         ',  @DERPDGLX58720016
               OUTPUT=(RF)                                     @DERPDGL 58730016
DERDC500 EQU   *                                               @D51TDPM 58740016
         LA    RF,DERRRE          RECOVERY ERROR.              @D51TDPM 58760016
         B     DERDCEX                                         @D51TDPM 58770016
         DROP  ,                                               @D66ADAP 58780016
         USING SYSS00,R0                                       @D66ADAP 58790016
         LTORG                                                 @D51TDPM 58800016
.NOSUP31 ANOP                                                  @D61ADJK 58810016
***************************************************************         58820016
*  FUNCTION                                                    @D51TDPM 58830016
*     DETERMINE THE SIZE OF THE BLOCKS ON A GIVEN FBA DEVICE.  @D51TDPM 58840016
*                                                              @D51TDPM 58850016
*  INPUT                                                       @D51TDPM 58860016
*    - R3 CONTAINS THE ADDRESS OF A PUB.                       @D51TDPM 58870016
*                                                              @D51TDPM 58880016
*  OUTPUT                                                      @D51TDPM 58890016
*    - RF CONTAINS THE BLOCK SIZE.  RF IS ZERO WHEN THE        @D51TDPM 58900016
*      BLOCKSIZE CANNOT BE DETERMINED.                         @D51TDPM 58910016
*                                                              @D51TDPM 58920016
***************************************************************         58930016
 AGO  .GFBABS                                                 *#SECURGL 58940016
.LFBABS  AIF ('&TEST'(1,14) NE 'CALL  DERFBABS').LRSTOP       *#SECURGL 58950016
 AIF   ('&I'(2,2)  NE '3 '                     ).DSINVC       *#SECURGL 58960016
 AIF   ('&O'(2,2)  EQ 'F '                     ).DSHEAD       *#SECURGL 58970016
 AGO  .DSINVC                                                 *#SECURGL 58980016
.GFBABS   ANOP                                                *#SECURGL 58990016
.**************************************************************         59000016
DERFBABS SGDSK 'HEADING        ','START OF CODEBLOCK'          @DERPDGL 59010016
         USING PUBADR,R3                                       @D51TDPM 59020016
*                                                              @D51TDPM 59040016
         STM   R5,R3,DERDERSV     SAVE REGISTERS FOR CALL.     @D51TDPM 59050016
         AMODESW SET,AMODE=24,WR=(R7) ENTER 24-BIT ADDR. MODE  @D52VDAP 59060016
         L     RC,BASESERI        LOAD SERTASK BASE            @D35DDDK 59070016
         DROP  RC                                              @D51TDPM 59080016
         USING SGSERI,RC          DECLARE SERTASK BASE         @D35DDDK 59090016
         BAL   R7,AVRFVCTE        GET VOLUME CHARACTERISTICS   @D14ZDDK 59100016
         DROP  RC                                              @D51TDPM 59110016
         BALR  RA,0                      RESTORE GLOBAL AREA   @DERPDGL 59120016
         USING *,RA                                            @DERPDGL 59130016
         ICM   RA,8,=X'00'                                     @DERPDGL 59140016
         AMODESW SET,AMODE=31,WR=(R7) ENTER 31-BIT ADDR. MODE  @D52VDAP 59150016
         L     RA,=A(DERGLOB)            POINTER AND RELOAD    @DERPDGL 59160016
         USING DERGLOB,RA                                      @DERPDGL 59170016
         LM    R5,R3,DERDERSV            ALL REGS EXCEPT ANSWER@DERPDGL 59180016
         USING DERFBABS,RC               REG OF AVRFVCTE       @D51TDPM 59190016
*                                                              @DERPDGL 59200016
         LTR   R4,R4              IS RETURNED ADDR VALID       @D35DDDK 59210016
         BNP   DERGB020           NO  CLEAR REGISTERS          @D35DDDK 59220016
         USING VCTEADR,R4         DECLARE VCTE ADDRESSABILITY  @D51CDBH 59240016
         LH    RF,VCTFBLKS        GET FBA BLOCKSIZE            @D51TDPM 59250016
         DROP  R4                 NO LONGER ADDRESSES VCTE     @D51CDBH 59260016
         B     DERGBEX                                         @D51TDPM 59270016
DERGB020 EQU   *                                               @D51TDPM 59280016
         LA    RF,0               CANNOT FIND BLOCKSIZE.       @D51TDPM 59290016
DERGBEX  SGDSK 'RETURN         ','RETURN TO CALLER         ',  @DERPDGLX59300016
               OUTPUT=(RF)                                     @DERPDGL 59310016
         DROP  ,                                               @D66ADAP 59320016
         USING SYSS00,R0                                       @D66ADAP 59330016
         LTORG                                                 @D51TDPM 59340016
*                                                                       59350016
***************************************************************         59360016
*  FUNCTION                                                    @D51TDPM 59370016
*     SET UP THE RESTART CCW OPCODE.                           @D51TDPM 59380016
*                                                              @D51TDPM 59390016
*  INPUT                                                       @D51TDPM 59400016
*    - R2 CONTAINS THE ADDRESS OF A ERBLKADR.                  @D51TDPM 59410016
*    - R3 CONTAINS THE ADDRESS OF A PUB.                       @D51TDPM 59420016
*    - R5 CONTAINS THE ADDRESS OF A CCW WHOSE OPCODE           @D51TDPM 59430016
*      WILL BE UPDATED.                                        @D51TDPM 59440016
*                                                              @D51TDPM 59450016
*  OUTPUT                                                      @D51TDPM 59460016
*    - THE OPCODE WILL BE SET IN THE SPECIFIED CCW.            @D51TDPM 59470016
*                                                              @D51TDPM 59480016
***************************************************************         59490016
 AGO  .GRSTOP                                                 *#SECURGL 59500016
.LRSTOP  AIF ('&TEST'(1,14) NE 'CALL  DERRSTOP').LRSCW2       *#SECURGL 59510016
 AIF   ('&I'(2,6)  NE '2,3,5 '                 ).DSINVC       *#SECURGL 59520016
 AIF   ('&O'(2,4)  EQ 'NONE'                   ).DSHEAD       *#SECURGL 59530016
 AGO  .DSINVC                                                 *#SECURGL 59540016
.GRSTOP   ANOP                                                *#SECURGL 59550016
.**************************************************************         59560016
DERRSTOP SGDSK 'HEADING        ','START OF CODEBLOCK'          @DERPDGL 59570016
         USING ERBLKADR,R2                                     @D51TDPM 59580016
         USING PUBADR,R3                                       @D51TDPM 59590016
         USING CCWADR,R5                                       @D51TDPM 59600016
*                                                              @D51TDPM 59610016
         CLI   PUBDEVTY,TFBA      IS IT A FBA DEVICE           @D37ADDK 59620016
         BNE   DERCO020           NO  SKIP FBA CODE            @D37ADDK 59630016
*                                                              @D51TDPM 59640016
         MVI   CCWCODE,X'41'      USE FBA WRITE COMMAND CODE   @D35DDDK 59650016
         TM    ERRQSNS+8,X'01'    IS IT A WRITE OPERATION      @D37ADDK 59670016
         BNZ   DERCO030                                        @D51TDPM 59680016
         MVI   CCWCODE,X'42'      USE FBA READ COMMAND CODE.   @D51TDPM 59690016
         B     DERCO030                                        @D51TDPM 59710016
DERCO020 EQU   *                                               @D37ADDK 59720016
         MVC   CCWCODE(1),ERRQSNS+3     CKD COMMAND CODE       @D37ADDK 59730016
DERCO030 SGDSK 'RETURN         ','RETURN TO CALLER         '   @DERPDGL 59750016
         DROP  ,                                               @D66ADAP 59760016
         USING SYSS00,R0                                       @D66ADAP 59770016
         LTORG                                                 @D51TDPM 59780016
*                                                                       59790016
***************************************************************         59800016
*  FUNCTION                                                    @D51TDPM 59810016
*     BUILD RESTART CCW 2.                                     @D51TDPM 59820016
*                                                              @D51TDPM 59830016
*  INPUT                                                       @D51TDPM 59840016
*    - R1 CONTAINS THE ADDRESS OF A CCB.                       @D51TDPM 59850016
*    - R2 CONTAINS THE ADDRESS OF ERBLKADR                     @D51TDPM 59860016
*    - R3 CONTAINS THE ADDRESS OF A PUB.                       @D51TDPM 59870016
*                                                              @D51TDPM 59880016
*  OUTPUT                                                      @D51TDPM 59890016
*    - RF CONTAINS THE ADDRESS OF THE RESTART CCW.  THE        @D51TDPM 59900016
*      ADDRESS IS ZERO WHEN THE RESTART CCW CANNOT BE BUILT.   @D51TDPM 59910016
*    - R8 WILL POINT TO THE INTERRUPTED CCW WHEN THE RESTART   @D51TDPM 59920016
*      CCW WAS BUILT.                                          @D51TDPM 59930016
*                                                              @D51TDPM 59940016
***************************************************************         59950016
 AGO  .GRSCW2                                                 *#SECURGL 59960016
.LRSCW2  AIF ('&TEST'(1,14) NE 'CALL  DERRSCW2').LRSCW1       *#SECURGL 59970016
 AIF   ('&I'(2,6)  NE '1,2,3 '                 ).DSINVC       *#SECURGL 59980016
 AIF   ('&O'(2,4)  EQ '8,F '                   ).DSHEAD       *#SECURGL 59990016
 AGO  .DSINVC                                                 *#SECURGL 60000016
.GRSCW2   ANOP                                                *#SECURGL 60010016
.**************************************************************         60020016
DERRSCW2 SGDSK 'HEADING        ','START OF CODEBLOCK'          @DERPDGL 60030016
         USING CCBADR,R1                                       @D51TDPM 60040016
         USING ERBLKADR,R2                                     @D51TDPM 60050016
         USING PUBADR,R3                                       @D51TDPM 60060016
*                                                              @D51TDPM 60080016
         XR    R7,R7              CLEAR COUNTER                @D35DDDK 60090016
         CLI   PUBDEVTY,TFBA      IS IT A FBA DEVICE           @D37ADDK 60100016
         BNE   DERSS020           NO  SKIP FBA CODE            @D37ADDK 60110016
 SGDSK  'CALL  DERFBABS        ','GET BLOCKSIZE OF DEVICE',    @DERPDGLX60130016
               I='3                 ON RETURN ',               @DERPDGLX60140016
               O='F                 RF IS BLOCKSIZE  '         @DERPDGL 60150016
         LTR   R4,RF              IS RETURNED BLOCKSIZE ZERO   @D35DDDK 60160016
         BZ    DERSS300           YES  TAKE ERROR EXIT         @D35DDDK 60170016
DERSS020 EQU   *                                               @D37ADDK 60190016
         L     R8,DERCCCWV        FAILING CCW ADDRESS.         @D51TDPM 60200016
         LTR   R8,R8              BRANCH WHEN FAILING CCW...   @D51TDPM 60210016
         BZ    DERSS300             IS NOT ACCESSIBLE.         @D51TDPM 60220016
         USING CCWADR,R8            FAILING CCW.               @D35DDDK 60230016
         LA    R5,DERCCW          SET UP THE RESTART CCW...    @D51TDPM 60240016
 SGDSK  'CALL  DERRSTOP        ','SET UP OPCODE IN CCW',       @DERPDGLX60250016
               I='2,3,5             *',                        @DERPDGLX60260016
               O='NONE              *'                         @DERPDGL 60270016
         DROP  R1                                              @D51TDPM 60280016
*                                                              @DERPDGL 60290016
DERSS030 EQU   *                                               @DMS0408 60300016
         SLR   R1,R1              CLEAR REGISTER 1             @DMS0408 60320016
         ICM   R1,3,CCWLNG        INSERT CCW COUNT             @DMS0408 60330016
         AR    R1,R7              ADD COUNT                    @DMS0408 60340016
         LR    R7,R1              TAKE NEW COUNT               @DMS0408 60350016
         SLR   R0,R0              PREPARE R0 FOR CALCULATIONS  @D35DDDK 60360016
         CLI   PUBDEVTY,TFBA      IS IT A FBA DEVICE           @D37ADDK 60370016
         BNE   DERSS050           NO  SKIP FBA CODE            @D37ADDK 60380016
         DR    R0,R4              DIVIDE COUNT BY BLKSIZE      @D35DDDK 60400016
         LTR   R0,R0              IS REMAINDER ZERO            @D35DDDK 60410016
         BZ    DERSS040           YES  SKIP                    @D35DDDK 60420016
         LA    R1,1(R1)           ADD ONE                      @D35DDDK 60430016
DERSS040 EQU   *                                               @D37ADDK 60450016
         SLR   R0,R0                                           @DERPDGL 60460016
         ICM   R0,3,ERRQSNS+16    LOAD NO OF BLKS XFERRED      @D37ADDK 60470016
         CR    R1,R0              R1 BLKS > BLKS XFERRED       @D35DDDK 60480016
         BH    DERSS090           YES  SKIP                    @DA25501 60490016
         B     DERSS060           SKIP CKD CODE                @D37ADDK 60500016
DERSS050 EQU   *                                               @D37ADDK 60510016
         SLR   R0,R0                                           @DERPDGL 60520016
         ICM   R0,7,ERRQSNS+15    GET RESTART DISPLACEMENT     @D37ADDK 60530016
         SR    R1,R0              SUBTRACT RESTART DISP        @D37ADDK 60540016
         LR    R0,R1              SAVE RESULT                  @DA25501 60550016
         BH    DERSS095           SKIP IF RESULT POSITIVE      @DA25501 60560016
DERSS060 EQU   *                                               @DA25501 60570016
         TM    CCWCHAIN,DC        IS IT DATA CHAINING          @DA25501 60590016
         BZ    DERSS080           NO  SKIP                     @D35DDDK 60600016
 SGDSK  'CALL  DERBUMP         ','BUMP TO NEXT CCW ',          @DERPDGLX60620016
               I='8                 ON RETURN TO +8 ',         @DERPDGLX60630016
               O='8                 R8 POINTS TO NXT CCW',     @DERPDGLX60640016
               E0='DERSS300         ERROR: NOT ADDRESSABLE',   @DERPDGLX60650016
               E4='DERSS300         ERROR: CHAIN ENDED'        @DERPDGL 60660016
         B     DERSS030           B IF NORMAL NEXT CCW         @DERPDGL 60670016
*                                                              @DERPDGL 60680016
DERSS080 EQU   *                                               @D36ZDDK 60690016
         LA    R7,1               USE COUNT OF ONE             @D36ZDDK 60710016
         L     R1,R1*4(,RD)       RESTORE CCB POINTER          @DERPDGL 60720016
         USING CCBADR,R1          FROM SAVE AREA               @DERPDGL 60730016
         STH   R7,CCBCNT          INSERT AS RESIDUAL COUNT     @DERPDGL 60740016
         MVC   DERCCW+1(7),1(R8)  MOVE LAST 7 BYTES OF CCW     @DMI0257 60750016
         NI    DERCCW+4,XFF-DERPCI SET OFF PCI BIT             @DA23968 60760016
         OI    DERCCW+4,SKIP      SET SKIP BIT ON              @D35DDDK 60770016
         TM    DERCCW,X'01'       IS IT A WRITE CCW            @D37ADDK 60780016
         BZ    DERSS110           NO  SKIP                     @D37ADDK 60790016
         LA    RF,DERZERO         POINT TO ZERO                @D35DDDK 60800016
         NI    DERCCW+4,XFF-IDAL  CLEAR IDAL BIT               @D35DDDK 60810016
         B     DERSS130           BRANCH                       @D35DDDK 60830016
         DROP  R1                 DROP CCB POINTER             @DERPDGL 60840016
*                                                              @DERPDGL 60850016
*   NUMBER OF DEMANDED BLOCKS WAS HIGHER THAN NUMBER OF        @DERPDGL 60860016
*   TRANSFERRED BLOCKS FOR AN FBA DEVICE                       @DERPDGL 60870016
*                                                              @DERPDGL 60880016
DERSS090 EQU   *                                               @DMS0408 60890016
         SLR   R1,R1              CALCULATE REMAINING          @DMS0408 60910016
         ICM   R1,3,ERRQSNS+16      REST-COUNT                 @D37ADDK 60920016
         MR    R0,R4                FOR THE                    @D35DDDK 60930016
         LR    R0,R7                RESTART                    @DMS0408 60940016
         SR    R0,R1                CCW                        @D35DDDK 60950016
*                                                              @DERPDGL 60960016
*   NOW START BUILDING THE RESTART CCW                         @DERPDGL 60970016
*                                                              @DERPDGL 60980016
DERSS095 EQU   *                                               @DA25501 60990016
         L     R1,R1*4(,RD)       ESTABLISH ADDRESSABILITY...  @D51TDPM 61010016
         USING CCBADR,R1            TO GIVEN CCB.              @D51TDPM 61020016
         LR    R7,R0              TAKE  FINAL COUNT            @DA25501 61030016
         STCM  R0,3,CCBCNT        ALSO IN CCB                  @DA34768 61040016
         MVC   DERCCW+1(7),1(R8)  MOVE LAST 7 BYTES OF CCW     @DMI0257 61050016
         NI    DERCCW+4,XFF-DERPCI SET OFF PCI BIT             @DA23968 61060016
*                                                              @DMI0257 61070016
DERSS110 SLR   RF,RF                                           @D51TDPM 61080016
         ICM   RF,B'0111',CCWBUF+1     LOAD I/O AREA ADDRESS   @D37ADDK 61090016
         TM    CCWCHAIN,IDAL      IS IDAL BIT ON               @D35DDDK 61100016
         BZ    DERSS120           NO  SKIP                     @D35DDDK 61110016
         LR    R9,RF              INTERRUPTED CCW IDAL.        @D51TDPM 61130016
 SGDSK  'CALL  DERBIDAL        ','BUILD A NEW IDAL ',          @DERPDGLX61140016
               I='1,8,9             ON RETURN',                @DERPDGLX61150016
               O='F                 RF POINTS TO NEW IDAL'     @DERPDGL 61160016
         LTR   RF,RF              BRANCH WHEN THE NEW IDAL...  @D51TDPM 61170016
         BZ    DERSS300             CANNOT BE BUILT.           @D51TDPM 61180016
         B     DERSS130           GO TO COMMON PATH            @D35DDDK 61190016
DERSS120 EQU   *                                               @D35DDDK 61200016
         SLR   R0,R0              CLEAR REGISTER 0             @DMS0408 61210016
         ICM   R0,3,CCWLNG        INSERT CCW COUNT             @DMS0408 61220016
         AR    RF,R0              ADD CCW CNT TO DATA ADR      @DMS0408 61230016
         SR    RF,R7              SUBTRACT CALCULATED COUNT    @DMS0408 61240016
DERSS130 EQU   *                                               @D35DDDK 61250016
         STCM  RF,7,DERCCW+1      STORE NEW DATA ADDRESS       @D35DDDK 61270016
         STH   R7,DERCCW+6        MOVE COUNT                   @DMS0408 61280016
         LA    RF,DERCCW          MADE RESTART CCW.            @D51TDPM 61290016
         B     DERSSEX                                         @D51TDPM 61300016
DERSS300 EQU   *                                               @D51TDPM 61310016
         LA    RF,0               DID NOT MAKE RESTART CCW.    @D51TDPM 61320016
DERSSEX  SGDSK 'RETURN         ','RETURN TO CALLER         ',  @DERPDGLX61340016
               OUTPUT=(R8,RF)                                  @DERPDGL 61350016
         DROP  ,                                               @D66ADAP 61360016
         USING SYSS00,R0                                       @D66ADAP 61370016
         LTORG                                                 @D51TDPM 61380016
*                                                                       61390016
*                                                                       61400016
***************************************************************         61410016
*  FUNCTION                                                    @D51TDPM 61420016
*     BUILD RESTART CCW 1. A DESCRIPTION OF THIS PROCEDURE     @D51TDPM 61430016
*     IS GIVEN IN                                              @D51TDPM 61440016
*       IBM 3880 STORAGE CONTROL MODEL 13, GA32-0067-3 (PG 122)         61450016
.*    THE RESTART CCW TYPE 1 IS NORMALLY CONSTRUCTED IN THE    @DERPDGL 61460016
.*    FOLLOWING SITUATION. THERE IS A 3350 DEVICE AND IT HAD   @DERPDGL 61470016
.*    AN OVERFLOW RECORD. THIS RECORD SPANS FROM SOME TRACK TO @DERPDGL 61480016
.*    SAY 3 OR 4 TRACKS LATER. WHEN THIS RECORD IS READ AND    @DERPDGL 61490016
.*    THERE IS A SWITCH TO THE NEXT HEAD TO READ THE NEXT PART @DERPDGL 61500016
.*    OF IT WITH THE SAME CCW STILL BEING PROCESSED, THERE     @DERPDGL 61510016
.*    MAY BE A UNIT CHECK IN THIS OPERATION. THERE WAS NO      @DERPDGL 61520016
.*    CHANNEL COMMAND RETRY DONE FOR THIS ERROR AND HENCE THE  @DERPDGL 61530016
.*    CSW CONTAINS THE REST OF THE CCW COUNT THAT WAS NOT YET  @DERPDGL 61540016
.*    PROCESSED. THE RESTART CCW SHALL NOW REFLECT THAT PART.  @DERPDGL 61550016
.*    THE DIFFERENCE FROM A RESTART CCW TYPE 2 IS, THAT IN     @DERPDGL 61560016
.*    THIS CASE A CHANNEL COMMAND RETRY OPERATION WAS DONE     @DERPDGL 61570016
.*    AND HENCE THE NUMBER OF BYTES TRANSFERRED FROM THE       @DERPDGL 61580016
.*    CONTROL UNIT TO THE CHANNEL IS IN BYTE 15/16/17 OF THE   @DERPDGL 61590016
.*    SENSE DATA.                                              @DERPDGL 61600016
.*    FOR A READ COMMAND THE CONTROL UNIT DOES NOT STOP SENDING@DERPDGL 61610016
.*    DATA TO THE CHANNEL UNTIL THE ENTIRE RECORD IS PROCESSED.@DERPDGL 61620016
.*    STILL, IF THE CCW COUNT HAS BEEN USED UP THE CHANNEL     @DERPDGL 61630016
.*    STOPS STORING THE INCOMING DATA INTO STORAGE.            @DERPDGL 61640016
.*    NOW IF WE WANT TO RESTART THIS OPERATION, TO MAKE THE    @DERPDGL 61650016
.*    CONTROL UNIT SKIP OVER THE REST OF THE UNPROCESSED       @DERPDGL 61660016
.*    OVERFLOW RECORD WE HAVE TO SET ON THE SKIP BIT IN THE    @DERPDGL 61670016
.*    CCW TO NOT TRANSPORT THE DATA INTO STORAGE.              @DERPDGL 61680016
.*    FOR A WRITE CCW THE REST OF THE RECORD WOULD NORMALLY    @DERPDGL 61690016
.*    BE PURGED BY THE CONTROL UNIT IF THERE ARE LESS BYTES    @DERPDGL 61700016
.*    IN THE CCW COUNT FIELD THAN IN THE RECORD. TO INITIATE   @DERPDGL 61710016
.*    THIS PURGE OPERATION WE HAVE TO ISSUE A SINGLE WRITE     @DERPDGL 61720016
.*    WITH A ZERO TO THE NEXT SUBSEQUENT PLACE IN THE RECORD.  @DERPDGL 61730016
.*                                                             @DERPDGL 61740016
*                                                              @D51TDPM 61750016
*  INPUT                                                       @D51TDPM 61760016
*    - R1 CONTAINS THE ADDRESS OF A CCB.                       @D51TDPM 61770016
*    - R2 CONTAINS THE ADDRESS OF A ERBLKADR.                  @D51TDPM 61780016
*    - R3 CONTAINS THE ADDRESS OF A PUB.                       @D51TDPM 61790016
*                                                              @D51TDPM 61800016
*  OUTPUT                                                      @D51TDPM 61810016
*    - RF CONTAINS THE ADDRESS OF THE RESTART CCW.  THE        @D51TDPM 61820016
*      ADDRESS IS ZERO WHEN THE RESTART CCW CANNOT BE BUILT.   @D51TDPM 61830016
*    - R8 WILL POINT TO THE INTERRUPTED CCW WHEN THE RESTART   @D51TDPM 61840016
*      CCW WAS BUILT.                                          @D51TDPM 61850016
*                                                              @D51TDPM 61860016
***************************************************************         61870016
 AGO  .GRSCW1                                                 *#SECURGL 61880016
.LRSCW1  AIF ('&TEST'(1,14) NE 'CALL  DERRSCW1').LBIDAL       *#SECURGL 61890016
 AIF   ('&I'(2,6)  NE '1,2,3 '                 ).DSINVC       *#SECURGL 61900016
 AIF   ('&O'(2,4)  EQ '8,F '                   ).DSHEAD       *#SECURGL 61910016
 AGO  .DSINVC                                                 *#SECURGL 61920016
.GRSCW1   ANOP                                                *#SECURGL 61930016
.**************************************************************         61940016
DERRSCW1 SGDSK 'HEADING        ','START OF CODEBLOCK'          @DERPDGL 61950016
         USING CCBADR,R1                                       @D51TDPM 61960016
         USING ERBLKADR,R2                                     @D51TDPM 61970016
         USING PUBADR,R3                                       @D51TDPM 61980016
*                                                              @D51TDPM 62000016
         L     R8,DERFCCWV        FAILING CCW ADDRESS.         @D51TDPM 62010016
         LTR   R8,R8              BRANCH WHEN THE FAILING...   @D51TDPM 62020016
         BZ    DERFF500             CCW IS NOT ACCESSIBLE.     @D51TDPM 62030016
         USING CCWADR,R8          DECLARE CCW BASE             @D35DDDK 62040000
*                                                              @D51TDPM 62050016
         LA    R5,DERCCW          POINT TO COPY OF RESTART CCW.@D51TDPM 62060016
 SGDSK  'CALL  DERRSTOP        ','SET UP OPCODE IN CCW',       @DERPDGLX62070016
               I='2,3,5             *',                        @DERPDGLX62080016
               O='NONE              *'                         @DERPDGL 62090016
         MVC   DERCCW+4(1),CCWCHAIN MOVE USERS CCW FLAGS       @D35DDDK 62100016
*                                                              @D51TDPM 62110016
         SLR   RF,RF               GET 31 BIT COMPATABLE...    @D51TDPM 62120016
         ICM   RF,B'0111',CCWBUF+1   DATA ADDRESS.             @D51TDPM 62130016
         OC    CCBCNT,CCBCNT      BRANCH IF RESIDUAL CNT NOT 0 @DERPDGL 62140016
         BNZ   DERFF010                                        @DERPDGL 62150016
         TM    DERCRFCO,X'01'     BRANCH IF COMMAND NOT A      @DERPDGL 62170016
         BNO   DERFF005             WRITE TYPE COMMAND         @DERPDGL 62180016
         LA    R5,1               TAKE A ONE AS COUNT AND      @DERPDGL 62200016
         STH   R5,DERCCW+6          INSERT IN RESTART CCW      @DERPDGL 62210016
         NI    DERCCW+4,XFF-IDAL-DERPCI                        @DERPDGL 62220016
         LA    RF,DERZERO         POINT DATA ADDRESS TO A ZERO @DERPDGL 62230016
         STCM  RF,7,DERCCW+1      STORE NEW DATA ADDRESS       @D35DDDK 62240016
         B     DERFF050                                        @DERPDGL 62250016
DERFF005 LA    R5,1               INSERT A ONE IN THE CCBCNT   @DERPDGL 62260016
         STH   R5,CCBCNT            TO CREATE A LEGAL ADDR     @DERPDGL 62270016
         OI    DERCCW+4,SKIP      SET SKIP BIT ON              @D35DDDK 62280016
DERFF010 TM    CCWCHAIN,IDAL      IS IDAL BIT ON               @D35DDDK 62290016
         BZ    DERFF020           NO  SKIP                     @D35DDDK 62300016
         LR    R9,RF              INTERRUPTED CCW IDAL.        @D51TDPM 62310016
 SGDSK  'CALL  DERBIDAL        ','BUILD A NEW IDAL ',          @DERPDGLX62330016
               I='1,8,9             ON RETURN',                @DERPDGLX62340016
               O='F                 RF POINTS TO NEW IDAL'     @DERPDGL 62350016
         LTR   RF,RF              BRANCH WHEN NEW IDAL WAS...  @D51TDPM 62360016
         BZ    DERFF500             NOT BUILT.                 @D51TDPM 62370016
         B     DERFF030           GO TO COMMON PART            @D35DDDK 62380016
DERFF020 EQU   *                                               @D35DDDK 62390016
         SLR   R0,R0              CLEAR REGISTER 0             @DMS0408 62400016
         ICM   R0,3,CCWLNG        INSERT CCW COUNT             @DMS0408 62410016
         AR    RF,R0              ADD CCW COUNT                @DMS0408 62420016
         ICM   R0,3,CCBCNT        INSERT RESIDUAL COUNT        @DMJ0131 62430016
         SR    RF,R0              SUB RESIDUAL COUNT           @DMS0408 62440016
DERFF030 EQU   *                                               @D35DDDK 62450016
*                                                              @D51TDPM 62460016
         STCM  RF,7,DERCCW+1      STORE NEW DATA ADDRESS       @D35DDDK 62480016
         NI    DERCCW+4,XFF-DERPCI SET OFF PCI BIT             @DA23968 62490016
         MVC   DERCCW+6(2),CCBCNT USE RESIDUAL COUNT           @D37ADDK 62500016
*                                                              @DERPDGL 62510016
DERFF050 LA    RF,DERCCW          RESTART CCW BUILT.           @D51TDPM 62520016
         B     DERFFEX                                         @D51TDPM 62530016
*                                                              @DERPDGL 62540016
DERFF500 LA    RF,0               RESTART CCW WAS NOT BUILT.   @D51TDPM 62550016
DERFFEX  SGDSK 'RETURN         ','RETURN TO CALLER',           @DERPDGLX62570016
               OUTPUT=(R8,RF)                                  @DERPDGL 62580016
         DROP  ,                                               @D66ADAP 62590016
         USING SYSS00,R0                                       @D66ADAP 62600016
         LTORG                                                 @D51TDPM 62610016
*                                                                       62620016
***************************************************************         62630016
*  FUNCTION                                                    @D51TDPM 62640016
*     REBUILD THE IDAL FOR THE INTERRUPTED CCW SO THAT IT      @D51TDPM 62650016
*     TRANSFERS THE CORRECT AMOUNT OF DATA TO THE CORRECT      @D51TDPM 62660016
*     PLACE.                                                   @D51TDPM 62670016
*                                                              @D51TDPM 62680016
*  INPUT                                                       @D51TDPM 62690016
*    - R1 CONTAINS THE ADDRESS OF A CCB.                       @D51TDPM 62700016
*    - R8 CONTAINS THE ADDRESS OF THE INTERRUPTED CCW.         @D51TDPM 62710016
*    - R9 CONTAINS THE ADDRESS OF THE OLD IDAL.                @D51TDPM 62720016
*                                                              @D51TDPM 62730016
*  OUTPUT                                                      @D51TDPM 62740016
*    - RF ADDRESS OF THE REBUILT IDAL.  THE ADDRESS IS ZERO IF @D51TDPM 62750016
*      A NEW IDAL CANNOT BE MADE.                              @D51TDPM 62760016
*                                                              @D51TDPM 62770016
***************************************************************         62780016
 AGO  .GBIDAL                                                 *#SECURGL 62790016
.LBIDAL  AIF ('&TEST'(1,14) NE 'CALL  DERBIDAL').LTYSMP       *#SECURGL 62800016
 AIF   ('&I'(2,6)  NE '1,8,9 '                 ).DSINVC       *#SECURGL 62810016
 AIF   ('&O'(2,2)  EQ 'F '                     ).DSHEAD       *#SECURGL 62820016
 AGO  .DSINVC                                                 *#SECURGL 62830016
.GBIDAL   ANOP                                                *#SECURGL 62840016
.**************************************************************         62850016
DERBIDAL SGDSK 'HEADING        ','START OF CODEBLOCK'          @DERPDGL 62860016
         USING CCBADR,R1                                       @D51TDPM 62870016
*                                                              @D51TDPM 62890016
         SLR   R0,R0              CLEAR OFFSET                 @D35DDDK 62900000
         LR    R7,R0              CLEAR WORK REGISTER          @D37ADDK 62910000
         XC    DERIDAL,DERIDAL    CLEAR IDAL WORK FIELD        @DERPDGL 62920016
         USING CCWADR,R8          DECLARE CCW BASE             @D35DDDK 62930000
         ICM   R0,3,CCWLNG        INSERT CCW COUNT             @D37ADDK 62940000
         DROP  R8                 DROP CCW DSECT               @D35DDDK 62950000
         ICM   R7,3,CCBCNT        INSERT RESIDUAL COUNT        @DMJ0131 62960000
         SR    R0,R7              SUBTRACT RESIDUAL COUNT      @DMS0408 62970000
         LA    R6,DERIDAL         POINT TO ERP IDAL            @D35DDDK 62980016
         LR    R8,R9              POINT TO USERS IDAL          @D35DDDK 62990016
 SGDSK  'CALL  DERCVTRV        ','CONVERT REAL TO VIRTUAL ',   @DERPDGLX63000016
               I='8                 ON RETURN',                @DERPDGLX63010016
               O='F                 RF =0 OR VIRTUAL ADDR'     @DERPDGL 63020016
         LTR   R8,RF              BRANCH WHEN IDAL CANNOT...   @D51TDPM 63030016
         BZ    DERID300             BE ACCESSED.               @D51TDPM 63040016
*                                                                       63050016
*              IDAL CCW = OPADDR.....1..COUNT                 *@D31HMRH 63060016
*                           ADDR -> IDAWS FULLWORD ADDRESSES  *@D31HMRH 63070016
*              TRANSFER DATA TO THESE ADDRESSES IN 2K BLOCKS  *@D31HMRH 63080016
*                 PER IDAW                                    *@D31HMRH 63090016
*              IDAW 1 MAY POINT TO A LESS THAN 2K BLOCK WHICH *@D31HMRH 63100016
*                 DOES NOT HAVE TO BE ON A 2K BOUNDARY        *@D31HMRH 63110016
*              IDAW 2-NTH MUST POINT TO 2K BLOCKS AND EACH    *@D31HMRH 63120016
*                 BLOCK MUST BE ON A 2K BOUNDARY              *@D31HMRH 63130016
*                                                                       63140016
DERID020 EQU   *                                               @DA35162 63150016
         L     RF,0(R8)           GET IDAW                     @DA35162 63160016
         LTR   RF,RF              END OF IDAL                  @DA35162 63170000
         BZ    DERID030           YES                          @DA35162 63180000
         ST    RF,0(R6)           STORE COPY OF IDAW           @DA35162 63200016
         LA    R6,4(R6)           SHIFT COPY POINTER           @D35DDDK 63210016
*                                                                       63220016
*              STORAGE FOR A MAX. OF 33 IDAWS RESERVED        *@D31HMRH 63230016
*                                                                       63240016
         LA    R5,DERIDALE                                     @DERPDGL 63250016
         CLR   R6,R5              IS COPY COMPLETE             @DA33722 63260016
         BNL   DERID030           YES  SKIP                    @D35DDDK 63270000
 SGDSK  'CALL  DERCVTVR        ','CONVERT VIRTUAL TO REAL',    @DERPDGLX63290016
               I='8                 ON RETURN',                @DERPDGLX63300016
               O='F                 RF IS REAL OR 0 '          @DERPDGL 63310016
         LA    R8,4(RF)           POINT TO NEXT IDAW           @DA25327 63320016
 SGDSK  'CALL  DERCVTRV        ','CONVERT REAL TO VIRTUAL ',   @DERPDGLX63330016
               I='8                 ON RETURN',                @DERPDGLX63340016
               O='F                 RF =0 OR VIRTUAL ADDR'     @DERPDGL 63350016
         LTR   R8,RF                                           @D51TDPM 63360016
         BNZ   DERID020           YES  GO ON                   @D35DDDK 63370000
DERID030 EQU   *                                               @D35DDDK 63380016
         LA    RF,DERIDAL         POINT TO COPIED IDAL         @D35DDDK 63390016
DERID040 EQU   *                                               @D35DDDK 63400016
*                                                             *@D31HMRH 63410016
*              THIS LOOP LOCATES THE LAST BYTE TRANSFERRED    *@D31HMRH 63420016
*                 AND THE IDAW BLOCK IT IS LOCATED IN         *@D31HMRH 63430016
*              1. R0 = THE NUMBER OF BYTES ALREADY TRANSFERRED*@D31HMRH 63440016
*                 R8 IS LOADED WITH THE CURRENT IDAW          *@D31HMRH 63450016
*              2. R8'S HIGH ORDER BITS ARE CLEARED WITH X'7FF'*@D31HMRH 63460016
*              3. SUBTRACT H'2048 FROM R8                     *@D31HMRH 63470016
*              4. TAKE THE TWO' COMPLEMENT OF R8              *@D31HMRH 63480016
*              5. R8 NOW CONTAINS EITHER X'800' (2048) OR THE *@D31HMRH 63490016
*                    DISPLACEMENT TO THE BYTE TO RESTART THE  *@D31HMRH 63500016
*                    TRANSFER OF DATA AT                      *@D31HMRH 63510016
*              6. IF R0 IS LESS THAN R8, THEN R0 POINTS TO THE*@D31HMRH 63520016
*                    BYTE TO RESTART DATA TRANSFER AT         *@D31HMRH 63530016
*                    A. UPDATE THE CURRENT IDAW               *@D31HMRH 63540016
*                    B. ADDRESS OF IDAW IS IN R15             *@D31HMRH 63550016
*                    C. EXIT                                  *@D31HMRH 63560016
*              7. IF R0 IS NOT LESS THAN R8, THEN RESTART     *@D31HMRH 63570016
*                    BYTE IS NOT CONTAINED IN THIS BLOCK      *@D31HMRH 63580016
*                    A. SUBTRACT R8 (X'800') FROM R0          *@D31HMRH 63590016
*                    B. LOOP                                  *@D31HMRH 63600016
.*                                                            *@D31HMRH 63610016
.*             AN EXAMPLE.                                    *@D31HMRH 63620016
.*             IDAL = 0007FC00, 00089800, 00000000            *@D31HMRH 63630016
.*             CCW COUNT      = 1300                          *@D31HMRH 63640016
.*             RESIDUAL COUNT =  400                          *@D31HMRH 63650016
.*             TRANSFERRED    =  900                          *@D31HMRH 63660016
.*                                                            *@D31HMRH 63670016
.*             1. 7FC00 AND 7FF = 400                         *@D31HMRH 63680016
.*             2. 400 - 800 = (-400)                          *@D31HMRH 63690016
.*             3. (-400) 2'S COMPLEMENT = 400                 *@D31HMRH 63700016
.*             4. 900 IS NOT LESS THAN 400                    *@D31HMRH 63710016
.*             5. 900 - 400 = 500                             *@D31HMRH 63720016
.*                LOOP                                        *@D31HMRH 63730016
.*             1. 89800 AND 7FF = 0                           *@D31HMRH 63740016
.*             2. 0 - 800 = (-800)                            *@D31HMRH 63750016
.*             3. (-800) 2'S COMPLEMENT = 800                 *@D31HMRH 63760016
.*             4. 500 IS LESS THAN 800                        *@D31HMRH 63770016
.*             5. ADD 500 TO CURRENT IDAW                     *@D31HMRH 63780016
.*                LEAVE LOOP                                  *@D31HMRH 63790016
.*                                                            *@D31HMRH 63800016
         L     R8,0(RF)           POINT TO IO PART             @D35DDDK 63810016
         N     R8,IDALMSK         GET REMAINDER TO 2K          @DMJ0131 63820016
         SH    R8,H2048           SUBTRACT 2K                  @D35DDDK 63830016
         LCR   R8,R8              GET LENGTH OF IO PART        @D35DDDK 63840000
         CR    R0,R8              IS OFFSET WITHIN PART        @D35DDDK 63850000
         BL    DERID050           YES  BRANCH OUT              @D35DDDK 63860000
         LA    RF,4(RF)           POINT TO NEXT IDAW           @D35DDDK 63880000
         SR    R0,R8              DECR OFFSET BY PART LEN      @D35DDDK 63890000
         B     DERID040           LOOP                         @D35DDDK 63900000
DERID050 EQU   *                                               @D35DDDK 63910016
         L     R8,0(RF)           LOAD NEW START IDAW          @D35DDDK 63920016
         LTR   R8,R8              BRANCH IF THIS IDAW COULD NOT@DERPDGL 63930016
         BZ    DERID300             BE COPIED FROM USER        @DERPDGL 63940016
         AR    R8,R0              ADD OFFSET                   @D35DDDK 63960000
         ST    R8,0(RF)           STORE UPDATED IDAW           @D35DDDK 63970000
         LR    R7,RF              TAKE NEW IDAW POINTER        @DERPDGL 63980016
         SLR   R0,R0                                           @DERPDGL 63990016
         ICM   R0,3,CCBCNT        TAKE REMAINING PART          @DERPDGL 64000016
DERID060 L     R8,0(R7)           POINT TO IO PART             @DERPDGL 64010016
         LA    R7,4(,R7)          BUMP TO NEXT POINTER         @DERPDGL 64020016
         LTR   R8,R8              BRANCH IF THIS IDAW COULD NOT@DERPDGL 64030016
         BZ    DERID300             BE COPIED FROM USER        @DERPDGL 64040016
         N     R8,IDALMSK         GET REMAINDER TO 2K          @DERPDGL 64060016
         SH    R8,H2048           SUBTRACT 2K                  @DERPDGL 64070016
         LCR   R8,R8              GET LENGTH OF IO PART        @DERPDGL 64080016
         SR    R0,R8              IS OFFSET WITHIN PART        @DERPDGL 64090016
         BP    DERID060           YES  BRANCH OUT              @DERPDGL 64100016
         B     DERID400                                        @D51TDPM 64110016
DERID300 EQU   *                                               @D51TDPM 64120016
         SLR   RF,RF              CANNOT BUILD IDAL.           @D51TDPM 64130016
DERID400 SGDSK 'RETURN         ','RETURN TO CALLER         ',  @DERPDGLX64150016
               OUTPUT=(RF)                                     @DERPDGL 64160016
         DROP  ,                                               @D66ADAP 64170016
         USING SYSS00,R0                                       @D66ADAP 64180016
         LTORG                                                 @D51TDPM 64190016
*                                                                       64200016
***************************************************************         64210016
*  FUNCTION                                                    @D51TDPM 64220016
*     ATTEMPT A SIMPLE RETRY. THE SIMPLE RETRY REQUEST IS      @D51TDPM 64230016
*     CONTROLLED BY THE BIT SETTINGS IN THE RECOVERY ACTIONS.  @D51TDPM 64240016
*     FOR THE SPECIFIC STEPS SEE THE DESCRIPTIONS BELOW.       @D51TDPM 64250016
*                                                              @D51TDPM 64260016
*  INPUT                                                       @D51TDPM 64270016
*    - R1 CONTAINS THE ADDRESS OF THE GIVEN CCB.               @D51TDPM 64280016
*    - R2 CONTAINS ADDRESS OF THE GIVEN ERROR BLOCK.           @D51TDPM 64290016
*    - R3 CONTAINS THE ADDRESS OF THE PUB.                     @D51TDPM 64300016
*    - RB PTR TO THE ADDRESSABLE (!!!) USER CCB .              @D51TDPM 64310016
*                                                              @D51TDPM 64320016
*  OUTPUT                                                      @D51TDPM 64330016
*     - RF CONTAINS A RETRY COMPLETION CODE.                   @D51TDPM 64340016
*       = X'00000000' WHEN A RETRY WAS DONE AND THE I/O        @D51TDPM 64350016
*                     FOR THE RETRY WAS SUCCESSFUL.            @D51TDPM 64360016
*       = X'00000004' WHEN RECOVERY EXHAUSTED..                @D51TDPM 64370016
*       = X'00000008' WHEN A RETRY WAS DONE AND THE I/O        @D51TDPM 64380016
*                     FOR THE RETRY WAS UNIT CHECKED.          @D51TDPM 64390016
*       = X'0000000C' WHEN A RETRY WAS DONE AND THE I/O        @D51TDPM 64400016
*                     FOR THE RETRY FAILED FOR REASONS         @D51TDPM 64410016
*                     OTHER THAN A UNIT CHECK.                 @D51TDPM 64420016
*       = X'00000010' WHEN A RETRY WAS NOT DONE BECAUSE A      @D51TDPM 64430016
*                     RETRY CHANNEL PROGRAM COULD NOT          @D51TDPM 64440016
*                     BE BUILT.                                @D51TDPM 64450016
*       = X'00000014' WHEN RETRY INHIBITED BY USER CCB         @D51TDPM 64460016
*                     BIT SETTING.                             @D51TDPM 64470016
*                                                              @D51TDPM 64480016
*     - WHEN A RETRY IS DONE AND THE DEVICE, THAT IS THE       @D51TDPM 64490016
*       TARGET OF THE I/O FOR THE RETRY, HAS MULTIPLE PATHS,   @D51TDPM 64500016
*       THEN THE 9TH BYTE OF THE CCB GIVEN AS INPUT WILL       @D51TDPM 64510016
*       INDICATE THE PATH TO WHICH I/O FOR THE RETRY WAS       @D51TDPM 64520016
*       DIRECTED.                                              @D51TDPM 64530016
*                                                              @D51TDPM 64540016
*    - RB MAY HAVE A ZERO INSTEAD OF A USER CCB IF THIS WAS    @D51TDPM 64550016
*         PAGED OUT                                            @D51TDPM 64560016
*                                                              @D51TDPM 64570016
***************************************************************         64580016
 AGO  .GTYSMP                                                 *#SECURGL 64590016
.LTYSMP  AIF ('&TEST'(1,14) NE 'CALL  DERTYSMP').LPDOWN       *#SECURGL 64600016
 AIF   ('&I'(2,8)  NE '1,2,3,B '               ).DSINVC       *#SECURGL 64610016
 AIF   ('&O'(2,4)  EQ 'B,F '                   ).DSHEAD       *#SECURGL 64620016
 AGO  .DSINVC                                                 *#SECURGL 64630016
.GTYSMP   ANOP                                                *#SECURGL 64640016
.**************************************************************         64650016
DERTYSMP SGDSK 'HEADING        ','START OF CODEBLOCK'          @DERPDGL 64660016
         USING CCBADR,R1                                       @D51TDPM 64670016
         USING ERBLKADR,R2                                     @D51TDPM 64680016
         USING PUBADR,R3                                       @D51TDPM 64690016
         USING UCCBADR,RB                                      @D51TDPM 64700016
*                                                              @D51TDPM 64710016
*   IF THE USER SAID, THAT HE HAD A SELF MODIFYING CHANNEL     @D51TDPM 64720016
*   PROGRAM WE DO NOT RETRY, UNLESS THE FAILING CCW IS THE     @D51TDPM 64730016
*   VERY FIRST IN THE CCW CHAIN.                               @D51TDPM 64740016
*                                                              @D51TDPM 64750016
         TM    UCCBCOM2,CHNBIT    BRANCH WHEN RETRY IS NOT     @D51TDPM 64760016
         BNO   DERSM100             INHIBITED.                 @D51TDPM 64770016
         LA    RF,DERRED          ASSUME RETRY INHIBITED       @D51TDPM 64790016
         L     R8,DERFCCWR        FAILING CCW ADDRESS.         @D51TDPM 64800016
         LTR   R8,R8              BRANCH WHEN THE FAILING...   @D51TDPM 64810016
         BZ    DERSMEX              CCW IS NOT ACCESSIBLE.     @D51TDPM 64820016
         CLM   R8,B'0111',CCBCCW+1 BRANCH WHEN THE FAILING...  @D51TDPM 64830016
         BNE   DERSMEX               CCW IS NOT THE FIRST CCW  @D51TDPM 64840016
DERSM100 DS    0H                                              @D51TDPM 64860016
*                                                              @D51TDPM 64870016
*   TRY TO BUILD THE CHANNEL PROGRAM  REQUIRED FOR RETRY.      @D51TDPM 64880016
*   THE INPUT CHANNEL PROGRAM IS USED AS THE RETRY CHANNEL     @D51TDPM 64890016
*   PROGRAM UNDER TWO CONDITIONS.  FIRST, WHEN THE FIRST CCW   @D51TDPM 64900016
*   OF THE INPUT CHANNEL PROGRAM IS A DSK CCW.  SECOND, WHEN   @D51TDPM 64910016
*   SFM PREFIXING IS NOT REQUIRED.                             @D51TDPM 64920016
*                                                              @D51TDPM 64930016
         CLI   PUBDEVTY,TFBA        BRANCH WHEN ERROR IS ON    @D37ADDK 64940016
         BE    DERRPEX                AN FBA DEVICE            @D51TDPM 64950016
         CLC   DERTID,ARTIDH        BRANCH WHEN A SUPERVISOR   @D66CDAP 64960016
         BNH   DERRPEX                I/O REQUEST              @D51TDPM 64970016
         TM    DERCHQGV,DERCHQFP    BRANCH WHEN FILE PROTECT   @D51TDPM 64980016
         BZ    DERRPEX                IS NOT NEEDED            @D51TDPM 64990016
         CLC   DERSOCA+1(3),CCBCCW+1    BRANCH WHEN THE CCW IS @D51TDPM 65000016
         BH    DERRP100             BEFORE ANY DSK CCW.        @D51TDPM 65010016
         CLC   DEREOCA+1(3),CCBCCW+1    BRANCH WHEN THE CCW IS @D51TDPM 65020016
         BH    DERRPEX              ABOVE ANY DSK CCW.         @D51TDPM 65030016
DERRP100 EQU   *                                               @D51TDPM 65040016
*                                                              @D51TDPM 65050016
*   ATTEMPT TO PREFIX THE INPUT CHANNEL PROGRAM WITH A SFM     @D51TDPM 65060016
*   CCW.                                                       @D51TDPM 65070016
*     THE THREE CCWS AT DERCCW00 ARE USED TO PREFIX THE        @D51TDPM 65080016
*     GIVEN CHANNEL PROGRAM WITH AN SFM CCW.  IN STORAGE       @D51TDPM 65090016
*     ADDRESS ORDER THE THREE CCWS ARE SET UP AS FOLLOWS.      @D51TDPM 65100016
*     THE FIRST CCW IS THE FIRST CCW IN THE GIVEN CHANNEL      @D51TDPM 65110016
*     PROGRAM.  THE SECOND CCW IS WHATEVER CCW IS AT DERSFM.   @D51TDPM 65120016
*     THE THIRD CCW IT A TIC BACK TO THE GIVEN CHANNEL PROGRAM.@D51TDPM 65130016
*     THE TIC CCW WILL TRANSFER TO THE FIRST CCW, BEGINNING    @D51TDPM 65140016
*     WITH THE SECOND CCW IN THE GIVEN CHANNEL PROGRAM, THAT IS@D51TDPM 65150016
*     NEITHER A TIC CCW OR A SFM CCW.                          @D51TDPM 65160016
*                                                              @D51TDPM 65170016
*                                                              @D51TDPM 65180016
*   IF THE USER'S FIRST CCW IS ADDRESSABLE THEN COPY IT AND    @D51TDPM 65190016
*   THE SET FILE MASK CCW.                                     @D51TDPM 65200016
*                                                              @D51TDPM 65210016
         SLR   R8,R8              USE 31 BIT ADDRESS.          @D51TDPM 65230016
         ICM   R8,B'0111',CCBCCW+1 REQUESTOR'S FIRST CCW.      @D51TDPM 65240016
 SGDSK  'CALL  DERCVTRV        ','CONVERT REAL TO VIRTUAL ',   @DERPDGLX65250016
               I='8                 ON RETURN',                @DERPDGLX65260016
               O='F                 RF =0 OR VIRTUAL ADDR'     @DERPDGL 65270016
         LTR   R8,RF              BRANCH WHEN THE REQUESTOR'S..@D51TDPM 65280016
         BZ    DERPX100             CCW IS NOT ADDRESSABLE.    @D51TDPM 65290016
         MVC   DERCCW00,0(R8)     COPY REQUESTOR'S FIRST CCW.  @D51TDPM 65310016
         MVC   DERCCWF0,DERSFM    COPY SET FILE MASK CCW.      @D51TDPM 65320016
*                                                              @D51TDPM 65330016
*   ATTEMPT TO MAKE THE TIC CCW THAT WILL TRANSFER BACK TO     @D51TDPM 65340016
*   THE USER'S CHANNEL PROGRAM.                                @D51TDPM 65350016
*                                                              @D51TDPM 65360016
DERPX025 EQU   *                                               @D51TDPM 65370016
 SGDSK  'CALL  DERMKTIC        ','TRY TO TIC TO NEXT CCW ',    @DERPDGLX65380016
               I='8                 ON RETURN+4',              @DERPDGLX65390016
               O='8                 R8 NXT CCWS VIRT.ADD',     @DERPDGLX65400016
               E0='DERPX100         ERROR:TIC NOT BUILT'       @D51TDPM 65410016
         CLI   0(R8),SFM          BRANCH WHEN THE TARGET CCW...@D51TDPM 65420016
         BE    DERPX025             IS A SFM CCW.              @D51TDPM 65430016
*                                                              @D51TDPM 65440016
         MVC   DERCCWT0,DERTIC    COPY THE TIC CCW.            @D51TDPM 65450016
         LA    R5,DERCCW00        DSK RETRY CP.                @D51TDPM 65460016
         STCM  R5,B'0111',CCBCCW+1  SET IT IN CCBCCW           @D51TDPM 65470016
         B     DERRPEX                                         @D51TDPM 65490016
DERPX100 EQU   *                                               @D51TDPM 65500016
         LA    RF,DERRRE          PREFIXING WAS NOT SUCCESSFUL.@D51TDPM 65520016
         B     DERSMEX                                         @D51TDPM 65530016
DERRPEX  EQU   *                                               @D51TDPM 65540016
*                                                              @DERPDGL 65550016
*   IF THE RETRY COUNTER IS LESS THAN THE RETRY LIMIT, THEN    @DERPDGL 65560016
*   RETRY THE I/O ON THE CURRENT PATH.                         @DERPDGL 65570016
*                                                              @DERPDGL 65580016
         SLR   R5,R5              TAKE THE NUMBER OR RETRIES   @DERPDGL 65590016
         IC    R5,DERCRRL           PRESCRIBED                 @DERPDGL 65600016
         C     R5,DERTYCNT        BRANCH WHEN THE RETRY LIMIT..@DERPDGL 65610016
         BH    DERRY250             WOULD NOT BE EXCEEDED      @DERPDGL 65620016
*                                                              @DERPDGL 65640016
*   SEE IF IT WAS INDICATED BY SENSE DATA EVALUATION, THAT IN  @DERPDGL 65650016
*   CASE OF UNSUCCESSFUL RECOVERY ON THIS PATH WE SHOULD       @DERPDGL 65660016
*   WRITE INHIBIT A CONTROLLER, A STORAGE DIRECTOR OR A PATH.  @DERPDGL 65670016
*                                                              @DERPDGL 65680016
DERRY170 TM    DERCRRA2,DERRA2DU+DERRA2DS+DERRA2DP             @DERPDGL 65690016
         BZ    DERRY180                                        @DERPDGL 65700016
         MVI   DERDIASC,X'20'                                  @DERPDGL 65720016
         TM    DERCRRA2,DERRA2DU   BRANCH IF FENCE THE         @DERPDGL 65730016
         BO    DERRY160              CONTROLLER                @DERPDGL 65740016
         MVI   DERDIASC,X'80'                                  @DERPDGL 65760016
         TM    DERCRRA2,DERRA2DS   BRANCH IF FENCE THE         @DERPDGL 65770016
         BO    DERRY160              STORAGE DIRECTOR          @DERPDGL 65780016
         MVI   DERDIASC,X'40'      FENCE THE PATH              @DERPDGL 65800016
DERRY160 MVC   DERSVCCB,DERCCB     PRESERVE CCB                @DERPDGL 65810016
         LA    R5,DERDIACC         SETUP CCB FOR START IO      @DERPDGL 65820016
         STCM  R5,7,CCBCCW+1                                   @DERPDGL 65830016
         NI    CCBCOM2,XFF-CHNBIT  RESET NOT RETRYABLE BIT     @DERPDGL 65840016
 SGDSK  'CALL  DERIO            ','DO UNLIMITED RETRY ',       @DERPDGLX65850016
               I='1,2,3,B            ON RETURN ',              @D61SDJKX65860000
               O='B,F                RF IS RETURN CODE'        @DERPDGL 65870016
         LTR   RF,RF               BRANCH WHEN THE I/O...      @DERPDGL 65880016
         BNZ   DERRY290              WAS UNSUCCESSFUL.         @DERPDGL 65890016
         MVC   DERCCB(L'DERCCB),DERSVCCB   RESTORE CCB         @DERPDGL 65910016
         NI    DERCRRA2,XFF-DERRA2DU-DERRA2DS-DERRA2DP         @DERPDGL 65920016
*                                                              @DERPDGL 65930016
*   RETRY COUNT IS EXHAUSTED ON THE CURRENT PATH. IF THERE IS  @DERPDGL 65940016
*   SOME OTHER PATH WE WANT TO SWITCH TO LET US DO THIS.       @DERPDGL 65950016
*   FOR PATH WRITE INHIBITED WE DID IT ALREADY BEFORE WE       @DERPDGL 65960016
*   ENTERED DERTYSMP FOR SIMPLE RETRY.                         @DERPDGL 65970016
*                                                              @DERPDGL 65980016
DERRY180 TM    DERCRRA2,DERRA2NS  BRANCH IF SWITCHING OF PATHS @DERPDGL 65990016
         BO    DERRY200             IS FORBIDDEN BY SENSE DATA @DERPDGL 66000016
 SGDSK  'CALL  DERPTHSL        ','BUMP TO NEXT PATH IN CCB',   @DERPDGLX66020016
               I='1,2,3,B           *',                        @D61SDJKX66030000
               O='NONE              *',                        @DERPDGLX66040016
               E0='DERRY200         ERROR: NO PATH LEFT'       @DERPDGL 66050016
         XC    DERTYCNT,DERTYCNT  SET THE RETRY COUNT TO ZERO. @D51TDPM 66060016
         B     DERRY250                                        @D51TDPM 66070016
DERRY200 DS    0H                                              @D51TDPM 66080016
*                                                              @DERPDGL 66090016
*   IF THERE IS AN INDICATION SET BY SENSE DATA EVALUATION,    @DERPDGL 66100016
*   THAT IT MAY MAKE SENSE TO BREAK A DUPLEX PAIR NOW THAT     @DERPDGL 66110016
*   RECOVERY HAS FAILED ON ALL PATHS WE WANTED TO TRY,         @DERPDGL 66120016
*   INQUIRE IF IT IS A DUPLEX PAIR AND IF SO SUSPEND IT.       @DERPDGL 66130016
.*                                                             @DERPDGL 66140016
.*  THE ENTIRE PROCESS OF THE SUSPENSION OF A DUPLEX PAIR      @DERPDGL 66150016
.*  IS AS FOLLOWS (BASED ON THE DESCRIPTION BY MIKE PAULSEN    @DERPDGL 66160016
.*  OF SANJOSE, PAULSEN AT STLVM4):                            @DERPDGL 66170016
.*                                                             @DERPDGL 66180016
.*  THE REQUEST IS RECEIVED BY THE CONTROL UNIT. THE CONTROL   @DERPDGL 66190016
.*  UNIT NOW DECIDES, IF A DESTAGING OF TRACKS FROM THE CACHE  @DERPDGL 66200016
.*  TO A DASD HAS TO BE PERFORMED OR NOT. IF IT HAS, IT SETS   @DERPDGL 66210016
.*  THE PAIR STATE CHANGE PENDING. THE VERY NEXT IO TO THIS    @DERPDGL 66220016
.*  DUPLEX PAIR WILL RECEIVE A UNIT CHECK WITH A X1D IN THE    @DERPDGL 66230016
.*  BYTE 25: STATE CHANGE PENDING CONDITION.                   @DERPDGL 66240016
.*  THIS STATE CHANGE PENDING CONDITION WILL BE FINISHED BY    @DERPDGL 66250016
.*  A X85 INTERRUPT FROM THE DEVICE. SINCE IT IS VERY LIKELY,  @DERPDGL 66260016
.*  THAT THIS NEXT IO REQUEST IS ONE OF OUR SUBSEQUENT RETRIES @DERPDGL 66270016
.*  FOR ERROR RECOVERY ON THE SECONDARY DEVICE OF THE DUPLEX   @DERPDGL 66280016
.*  PAIR WE WILL REDRIVE THE REQUEST THEN.                     @DERPDGL 66290016
.*                                                             @DERPDGL 66300016
.*  IF THE DESTAGING IS NOT REQUIRED WE IMMEDIATELY TALK TO    @DERPDGL 66310016
.*  THE SECOND DASD OF THE DUPLEX PAIR, ONCE WE HAVE RECEIVED  @DERPDGL 66320016
.*  CHANNEL END DEVICE END ON THE SUSPENSION COMMAND.          @DERPDGL 66330016
.*                                                             @DERPDGL 66340016
.*  IN ORDER TO HAVE A POSSIBILITY FOR THE SERVICE PERSONNEL   @D61ADJK 66350016
.*  TO IDENTIFY SGDSK INITIATED SUSPENSIONS OF A DUPLEX PAIR,  @D61ADJK 66360016
.*  A WORK ERROR ENTRY IS SET UP IN CASE OF SUCCESSFUL         @D61ADJK 66370016
.*  SUSPENSION. THIS WILL CAUSE ERP TASK TO ISSUE A SUBSYSTEM  @D61ADJK 66380016
.*  MESSAGE ASYNCHRONOUSLY.                                    @D61ADJK 66390016
*                                                              @DERPDGL 66400016
         TM    DERCRRA2,DERRA2BD  BRANCH IF BREAKING DUPLEX    @DERPDGL 66410016
         BNO   DERRY300             IS NOT DESIRABLE           @DERPDGL 66420016
*                                                              @DERPDGL 66430016
         MVC   DERSVCCB,CCBADR    INITIALIZE CCB.              @D52WSPM 66450016
*                                                              @D52WSPM 66460016
.*  SET UP THE CCW WITH A STORE PURGES THE PATH MASK IN THE    @DERPDGL 66470016
.*  CCB AGAIN. THIS WILL RESET IT TO THE ORIGINAL PATH MASK    @DERPDGL 66480016
.*  IN THE CCB. LATER IT IS RESTORED FROM DERSVCCB             @DERPDGL 66490016
.*                                                             @DERPDGL 66500016
         LA    R5,DERCCWSS        SENSE SUBSYSTEM STATUS...    @D52WSPM 66510016
         ST    R5,CCBCCW            CHANNEL PROGRAM.           @D52WSPM 66520016
         IC    R5,DERIOKEY        PREPARE IO KEY FOR THIS      @DERPDGL 66530016
         MVI   DERIOKEY,0           OPERATION..                @DERPDGL 66540016
         NI    CCBCOM2,XFF-CHNBIT RESET NOT RETRYABLE BIT      @DERPDGL 66550016
 SGDSK  'CALL  DERIO           ','DO IO FOR SSS COMMAND',      @DERPDGLX66560016
               I='1,2,3,B           ON RETURN ',               @D61SDJKX66570000
               O='B,F               RF IS RETURN CODE'         @DERPDGL 66580016
         STC   R5,DERIOKEY        RESTORE NORMAL IO KEY        @DERPDGL 66590016
         LTR   RF,RF              BRANCH WHEN THE I/O...       @D52WSPM 66600016
         BNZ   DERRY290             WAS UNSUCCESSFUL.          @D52WSPM 66610016
         TM    DERSDSB1,DERSPDDP  BRANCH WHEN NOT PRIMARY...   @D52WSPM 66630016
         BZ    DERRY295             OF A DUPLEX PAIR.          @D52WSPM 66640016
         TM    DERSDSB1,DERSDPS   BRANCH WHEN DUPLEX PAIR...   @D61ADJK 66650016
         BNZ   DERRY295             SUSPENDED OR PENDING       @D61ADJK 66660016
*                                                              @D52WSPM 66670016
.*  IF SENSE SUBSYSTEM STATUS FORMAT INDICATES A 3990-6/7      @D61ADJK 66680016
.*  CU, THE SECONDARY UNIT ADDRESS CAN BE TAKEN DIRECTLY FROM  @D61ADJK 66690016
.*  SENSE SUBSYSTEM STATUS DATA BYTE 27 (FCR 228-M).           @D61ADJK 66700016
.*                                                             @D61ADJK 66710016
         MVC   DERSDPPU,DERSDUA   PRIMARY UNIT ADDRESS.        @D52WSPM 66730016
         MVC   DERSUWK1,DERSDSB2  SECONDARY UNIT ADDRESS...    @D52WSPM 66740016
         CLI   DERSFORM,DERSBODM  IS IT A 3990-6/7 ?           @D61ADJK 66750016
         BE    DERRY220           YES                          @D61ADJK 66760016
         BH    DERRY295           FORMAT IS UNKNOWN            @D61ADJK 66770016
         NI    DERSUWK1,DERSODSF  SECONDARY UNIT ADDRESS SUFFIX@D61ADJK 66790016
         MVC   DERSUWK2,DERSDUA   SECONDARY UNIT ADDRESS...    @D61ADJK 66800016
         NI    DERSUWK2,DERSODPF    PREFIX.                    @D61ADJK 66810016
         OC    DERSUWK1,DERSUWK2  SECONDARY UNIT...            @D52WSPM 66820016
DERRY220 MVC   DERSDPSU,DERSUWK1    ADDRESS.                   @D61ADJK 66830016
*                                                              @D52WSPM 66840016
         LA    R5,DERPSFSD        SUSPEND DUPLEX...            @D52WSPM 66850016
         ST    R5,CCBCCW            CHANNEL PROGRAM.           @D52WSPM 66860016
 SGDSK  'CALL  DERIO           ','DO PREPARATIONAL IO',        @DERPDGLX66870016
               I='1,2,3,B           ON RETURN ',               @D61SDJKX66880000
               O='B,F               RF IS RETURN CODE'         @DERPDGL 66890016
         LTR   RF,RF              BRANCH WHEN THE I/O...       @D52WSPM 66900016
         BNZ   DERRY290             WAS NOT SUCCESSFUL         @D52WSPM 66910016
 SGDSK  'CALL  DERALLOC        ','OBTAIN FREE ERROR BLOCK',    @D61ADJKX66930016
               I='NONE              ON RETURN+4',              @D61ADJKX66940016
               O='F                 RF POINTS TO BLOCK  ',     @D61ADJKX66950016
               E0='DERRY230         ERROR:NO BLOCK FOUND'      @D61ADJK 66960016
*                                                              @D61ADJK 66970016
         MVC   0(L'DERINWRK,RF),DERINWRK SETUP WITH VALUES     @D61ADJK 66980016
         LR    R2,RF                                           @D61ADJK 66990016
*                                                              @D61ADJK 67000016
         OI    ERRQPRFL,ERRQBDPM  TELL SUSPENSION SUCCESSFUL.  @D61ADJK 67020016
         NI    ERRQDFL,X'FF'-(ERQCANCL+ERQPASBK+ERQANYMR)      @D61ADJK 67030016
*                                                              @D61ADJK 67040016
 SGDSK  'CALL  DERERP          ','QUEUE THE ERROR  ',          @D61ADJKX67050016
               I='2                 BLOCK TO DO THE',          @D61ADJKX67060016
               O='NONE              RECORDING'                 @D61ADJK 67070016
*                                                              @D61ADJK 67080016
DERRY230 DS    0H                                              @D61ADJK 67090016
         LA    R2,DERINWRK        RESTORE ERBLKADR PTR         @D61ADJK 67100016
*                                                              @D52WSPM 67110016
*   RESTORE THE OLD CCB FROM SAVE POSITION                     @D52WSPM 67120016
*                                                              @D52WSPM 67130016
         MVC   CCBADR(L'DERSVCCB),DERSVCCB  RESTORE OLD CCB    @D52WSPM 67140016
*                                                              @D52WSPM 67150016
*   WE HAVE NOW SUSPENDED A DUPLEX PAIR. THIS STARTS A FRESH   @D52WSPM 67160016
*   RUN THROUGH ALL CHANNEL PATHS WITH FULL RETRY COUNT        @D52WSPM 67170016
*                                                              @D52WSPM 67180016
         MVI   DERCRPTU,X'00'     MAKE ALL PATHS AVAILABLE AGAIN     GL 67190016
         XC    DERTYCNT,DERTYCNT  RETRY COUNT ZERO.            @D52WSPM 67200016
*                                                              @D52WSPM 67210016
DERRY250 DS    0H                                              @DERPDGL 67220016
 SGDSK  'CALL  DERIO           ','DO IO AND GET COMPL.CODE',   @DERPDGLX67240016
               I='1,2,3,B           ON RETURN',                @D61SDJKX67250000
               O='B,F               RF IS COMPLETION CODE'     @DERPDGL 67260016
*                                                              @D51TDPM 67270016
         L    R5,DERTYCNT         INCREMENT THE...             @D52WSPM 67280016
         LA   R5,1(R5)              RETRY...                   @D52WSPM 67290016
         ST   R5,DERTYCNT           COUNT.                     @D52WSPM 67300016
         B    DERSMEX                                          @DA42963 67310016
*                                                              @D51TDPM 67320016
*   TELL RECOVERY EXHAUSTED AND POSSIBLY BY FAILING            @DERPDGL 67330016
*   PREPARATIONAL IO FROM DSK                                  @DERPDGL 67340016
*                                                              @DERPDGL 67350016
DERRY290 OI    DERFLG1,DERCVDSK   TELL ITS BECAUSE OF DSK      @DERPDGL 67360016
DERRY295 MVC   CCBADR(L'DERSVCCB),DERSVCCB  RESTORE OLD CCB    @D52WSPM 67380016
DERRY300 LA    RF,DERREXH         NO RETRY DONE ...            @DERPDGL 67400016
*                                                              @D51TDPM 67420016
DERSMEX  SGDSK 'RETURN         ','RETURN TO CALLER         ',  @DERPDGLX67430016
               OUTPUT=(RB,RF)                                  @DERPDGL 67440016
         DROP  ,                                               @D66ADAP 67450016
         USING SYSS00,R0                                       @D66ADAP 67460016
         LTORG                                                 @D51TDPM 67470016
*                                                                       67480016
***************************************************************         67490016
*  FUNCTION                                                    @D51TDPM 67500016
*     SET ALL THOSE PATHS DOWN, THAT ARE INDICATED IN THE      @D51TDPM 67510016
*     MASK BYTE FOR PATHS, THAT WE SWITCHED AWAY FROM.         @D51TDPM 67520016
*                                                              @D51TDPM 67530016
*  INPUT                                                       @D51TDPM 67540016
*    - R3 CONTAINS THE ADDRESS OF THE PUB                      @D51TDPM 67550016
*                                                              @D51TDPM 67560016
*  GLOBAL VARIABLES                                            @D51TDPM 67570016
*    - DERCRPTU FLAGS ALL THOSE PATHS THAT WE SWITCHED         @DERPDGL 67580016
*      AWAY FROM, SINCE THE ERROR RECOVERY WAS NOT SUCCESSFUL  @DERPDGL 67590016
*      ON THEM.                                                @DERPDGL 67600016
*                                                              @D51TDPM 67610016
*  OUTPUT ON EXIT TO RETURN+0:                                 @D51TDPM 67620016
*    - THE PATHS ARE SET DOWN IN THE CORRESPONDING BITS IN     @D51TDPM 67630016
*      PUBX                                                    @D61SDJK 67640000
*                                                              @D51TDPM 67650016
***************************************************************         67660016
 AGO  .GPDOWN                                                 *#SECURGL 67670016
.LPDOWN  AIF ('&TEST'(1,14) NE 'CALL  DERPDOWN').LPTHSL       *#SECURGL 67680016
 AIF   ('&I'(2,2)  NE '3 '                     ).DSINVC       *#SECURGL 67690016
 AIF   ('&O'(2,4)  EQ 'NONE'                   ).DSHEAD       *#SECURGL 67700016
 AGO  .DSINVC                                                 *#SECURGL 67710016
.GPDOWN   ANOP                                                *#SECURGL 67720016
.**************************************************************         67730016
DERPDOWN SGDSK 'HEADING        ','START OF CODEBLOCK'          @DERPDGL 67740016
         USING PUBADR,R3                                       @D51TDPM 67750016
         SH    R3,YPUBTAB         MAKE PUB POINTER A           @DERPDGL 67770016
         SRL   R3,1                 POINTER                    @DERPDGL 67780016
         A     R3,APBXAREA          TO                         @DERPDGL 67790016
         L     R3,0(,R3)            PUBX INSTEAD               @DERPDGL 67800016
         USING PBXADR,R3                                       @DERPDGL 67810016
         OC    PBXNOERP(1),DERCRPTU TELL THESE CHPIDS ARE DOWN @D61SDJK 67880030
         NC    DERCRPTU(1),PBXLPM   SET THE BITS OFF IN LPM IF @DERPDGL 67890016
         XC    PBXLPM(1),DERCRPTU     THEY ARE NOT OFF ALREADY @DERPDGL 67900016
         OC    DERCRPDN(1),DERCRPTU TELL THESE CHPIDS ARE DOWN @DERPDGL 67910016
*                                                              @DERPDGL 67920016
DERPDNEX SGDSK 'RETURN         ','RETURN TO CALLER         '   @DERPDGL 67930016
*                                                              @D61SDJK 67940000
DERPDNE0 TM    PBXLPM,*-*                                      @D61SDJK 67950000
         DROP  ,                                               @D66ADAP 67960016
         USING SYSS00,R0                                       @D66ADAP 67970016
         LTORG                                                 @DERPDGL 67980016
*                                                              @DERPDGL 67990016
***************************************************************         68000016
*  FUNCTION                                                    @D51TDPM 68010016
*     FILL IN OR SWITCH A PATH ON WHICH THE I/O TO A DEVICE    @D51TDPM 68020016
*     IS PERFORMED.                                            @D61SDJK 68030000
*     BOTH HAVE IN COMMON, THAT                                @D51TDPM 68040016
*       IF THE CCBCCW (I.E. THE PATH SELECTION BYTE OF CCB)    @D51TDPM 68050016
*       IS ZERO ON ENTRY, THEY FILL IN THE PATH ON WHICH THE   @D51TDPM 68060016
*       ERROR HAD OCCURED.                                     @D51TDPM 68070016
*       IF IT IS NOT ZERO, THEY BUMP TO THE NEXT AVAILABLE     @D51TDPM 68080016
*       PATH.                                                  @D61SDJK 68090000
*                                                              @D51TDPM 68100016
*  INPUT                                                       @D51TDPM 68110016
*    - R1 CONTAINS THE ADDRESS OF A CCB.                       @D51TDPM 68120016
*    - R2 CONTAINS THE ERROR BLOCK ADDRESS.                    @D51TDPM 68130016
*    - R3 CONTAINS THE ADDRESS OF THE PUB.                     @D51TDPM 68140016
*    - RB CONTAINS THE ADDRESS OF THE USER CCB                 @D61SDJK 68150000
*                                                              @D51TDPM 68160016
*  GLOBAL VARIABLES                                            @D51TDPM 68170016
*    - DERCRPTU FLAGS ALL THOSE PATHS THAT WE SWITCHED         @DERPDGL 68180016
*      AWAY FROM, SINCE THE ERROR RECOVERY WAS NOT SUCCESSFUL  @DERPDGL 68190016
*      ON THEM.                                                @DERPDGL 68200016
*                                                              @D51TDPM 68210016
*  OUTPUT ON EXIT TO RETURN+4:                                 @D51TDPM 68220016
*    - CCBCCW (THE PATH MASK) IS EITHER SWITCHED TO THE        @D51TDPM 68230016
*      NEXT AVAILABLE OR INITIALIZED                           @D51TDPM 68240016
*    - DERCRPTU IS GIVEN AN ADDITIONAL BIT IF CALL WAS FOR     @DERPDGL 68250016
*      SWITCHING THE PATH.                                     @DERPDGL 68260016
*                                                              @D51TDPM 68270016
*  OUTPUT ON EXIT TO RETURN+0:                                 @D51TDPM 68280016
*    - CCBCCW IS RESET TO THE VALUE CORRESPONDING TO THE       @D51TDPM 68290016
*      PATH THAT THE ORIGINAL ERROR CONDITION CAME IN FROM.    @DERPDGL 68300016
*                                                              @D51TDPM 68310016
***************************************************************         68320016
 AGO  .GPTHSL                                                 *#SECURGL 68330016
.LPTHSL  AIF ('&TEST'(1,14) NE 'CALL  DERPTHSL').LGFCCW       *#SECURGL 68340016
 AIF   ('&I'(2,8)  NE '1,2,3,B '               ).DSINVC       *#SECURGL 68350000
 AIF   ('&O'(2,4)  NE 'NONE'                   ).DSHEAD       *#SECURGL 68360016
 AIF   (T'&E0      EQ 'O'                      ).DSINVC       *#SECURGL 68370016
 AIF   (T'&E4      EQ 'O'                      ).DSHEAD       *#SECURGL 68380016
 AGO  .DSINVC                                                 *#SECURGL 68390016
.GPTHSL   ANOP                                                *#SECURGL 68400016
.**************************************************************         68410016
DERPTHSL SGDSK 'HEADING        ','START OF CODEBLOCK'          @DERPDGL 68420016
         USING CCBADR,R1                                       @D51TDPM 68430016
         USING ERBLKADR,R2                                     @D51TDPM 68440016
         USING PUBADR,R3                                       @D51TDPM 68450016
         USING UCCBADR,RB                                      @D61SDJK 68460000
         LR    R6,R3              MAKE A POINTER TO THE        @DERPDGL 68480016
         SH    R6,YPUBTAB           PUBX                       @DERPDGL 68490016
         SRL   R6,1                                            @DERPDGL 68500016
         A     R6,APBXAREA                                     @DERPDGL 68510016
         L     R6,0(,R6)                                       @DERPDGL 68520016
         USING PBXADR,R6                                       @DERPDGL 68530016
         CLI   CCBCCW,X'00'       IF WE CAME IN FOR INITIAL    @DERPDGL 68540016
         BNE   DERPTH20             SETTING OF THE PATH MASK   @DERPDGL 68550016
*                                                              @DERPDGL 68570016
*   CONVERT THE ERRQPATH INTO A PATH MASK BYTE AND USE IT      @DERPDGL 68580016
*                                                              @DERPDGL 68590016
         SLR   R5,R5              TAKE THE CHPID THAT THE      @DERPDGL 68600016
         IC    R5,ERRQPATH        ERROR CAME IN ON             @DERPDGL 68610016
         SLR   R7,R7              SET PATH-MASK TO ZERO        @SCSI    68611026
         CLC   PBXSCH,XFFFF       DOES DEVICE EXIST            @SCSI    68612026
         BE    DERPTH10           NO, ITS A SIMULATED DEVICE   @SCSI    68613026
         LA    R8,PBXCHPID        POINT TO CHPID-ID            @SCSI    68650027
         LA    R7,X'80'           START WITH FIRST PATH        @DERPDGL 68680016
DERPTH00 DS    0H                 LOOP                         @DERPDGL 68690016
         CLM   R5,1,0(R8)         BRANCH IF CHPID IS NOT       @DERPDGL 68700016
         BE    DERPTH10           FLAGGED AS INSTALLED.        @DERPDGL 68740027
DERPTH02 LA    R8,1(,R8)          BUMP TO NEXT CHPID           @DERPDGL 68750016
         SRL   R7,1               BUMP TO NEXT BIT IN PATHMASK @DERPDGL 68770016
         LTR   R7,R7              MORE PATHES LEFT             @DERPDGL 68780027
         BNZ   DERPTH00           YES, REPEAT IT               @DERPDGL 68790027
         TM    IJBFLG08,IJBDEBUG  DEBUG ACTIVE                 @SCSI    68791027
         BZ    DERPTH10           NO, CONTINUE                 @SCSI    68792027
         BAL   R5,&SYSERR         SYSTEM ERROR OTHERWISE       @DERPDGL 68800016
DERPTH10 DS    0H                                              @DERPDGL 68810016
         STC   R7,CCBCCW          ASSUME THIS ONE WILL BE USED @DERPDGL 68820016
         STC   R7,DERORGPT        KEEP AS ORIGINAL PATH        @DERPDGL 68830016
         B     DERPSEX4                                        @DERPDGL 68840016
*                                                              @DERPDGL 68850016
*   CALL HAD NOT BEEN FOR INITIALIZATION. SWITCH TO NEXT       @DERPDGL 68860016
*                                                              @DERPDGL 68870016
DERPTH20 DS    0H                                              @DERPDGL 68880016
         SLR   R7,R7              TAKE THE MASK OF CURRENT     @DERPDGL 68890016
         IC    R7,CCBCCW            PATH FROM CCB              @DERPDGL 68900016
         CLI   PBXLPM,X'00'       LEAVE UNSUCCESSFULLY IF      @DERPDGL 68910016
         BE    DERPSEX0             THERE IS NO BIT IN PBXLPM  @DERPDGL 68920016
*                                                              @DERPDGL 68940016
DERPTH24 SRA   R7,1               SHIFT TO THE RIGHT           @DERPDGL 68950016
         BNZ   DERPTH30           BRANCH IF NOT SHIFTED EMPTY  @DERPDGL 68960016
         LA    R7,X'80'           TAKE 1ST ON LEFT AS ROTATE   @DERPDGL 68970016
DERPTH30 DS    0H                                              @DERPDGL 68980016
         EX    R7,DERPTHE1        BRANCH IF WE ARRIVED AT      @DERPDGL 68990016
         BO    DERPSEX0             THE BEGINNING AGAIN        @DERPDGL 69000016
         EX    R7,DERPTHE2        BRANCH IF THIS BIT IS NOT    @DERPDGL 69010016
         BNO   DERPTH24             SET IN PBXLPM              @DERPDGL 69020016
         CLI   UCCBCCW,X'00'      TAKE THIS ONE IF THERE IS    @D61SDJK 69030000
         BE    DERPTH35             NO USER PATH MASK GIVEN    @D61SDJK 69040000
         EX    R7,DERPTHE3        BRANCH IF THIS BIT IS NOT    @D61SDJK 69050000
         BNO   DERPTH24             SET IN USER CCB PATH MASK  @D61SDJK 69060000
DERPTH35 DS    0H                                              @D61SDJK 69070000
*                                                              @DERPDGL 69090016
*   WE FOUND NEXT USER PATH IN THE LPM WHICH HAS NOT YET BEEN  @D61SDJK 69100000
*   USED FOR RECOVERY. LETS USE IT                             @DERPDGL 69110016
*                                                              @DERPDGL 69120016
         OC    DERCRPTU,CCBCCW    MARK AS SWITCHED FROM        @DERPDGL 69130016
         STC   R7,CCBCCW                                       @DERPDGL 69140016
.GPTHSL4 ANOP                                                  @DERPDGL 69150016
DERPSEX4 SGDSK 'RETURN4        ','RETURN TO CALLER         '   @DERPDGL 69160016
DERPSEX0 MVC   CCBCCW(1),DERORGPT RESET TO ORIGINAL PATH AGAIN @DERPDGL 69170016
         SGDSK 'RETURN         ','RETURN TO CALLER         '   @DERPDGL 69190016
*                                                              @DERPDGL 69200016
DERPTHE1 TM    DERORGPT,*-*                                    @DERPDGL 69220016
DERPTHE2 TM    PBXLPM,*-*                                      @DERPDGL 69230016
DERPTHE3 TM    UCCBCCW,*-*                                     @D61SDJK 69240000
         DROP  ,                                               @D66ADAP 69250016
         USING SYSS00,R0                                       @D66ADAP 69260016
         LTORG                                                 @DERPDGL 69270016
*                                                              @D51TDPM 69280016
***************************************************************         69290016
*  FUNCTION                                                    @D51TDPM 69300016
*     GET THE ADDRESS OF THE FAILING CCW AND THE FAILING       @D51TDPM 69310016
*     COMMAND CCW. THE ADDRESSES SHOULD BE IDENTICAL IN        @D51TDPM 69320016
*     MOST CASES.                                              @D51TDPM 69330016
*                                                              @D51TDPM 69340016
*  INPUT                                                       @D51TDPM 69350016
*    - R1 CONTAINS THE ADDRESS OF A CCB.                       @D51TDPM 69360016
*    - R2 CONTAINS THE ADDRESS OF THE ERBLOC.                  @D51TDPM 69370016
*    - R3 CONTAINS THE PUB ADDR OF THE DEVICE                  @D51TDPM 69380016
*                                                              @D51TDPM 69390016
*  OUTPUT                                                      @D51TDPM 69400016
*    - DERFCCWV, DERFCCWR AND DERCCCWV ARE SET                 @D51TDPM 69410016
*                                                              @D51TDPM 69420016
***************************************************************         69430016
 AGO  .GGFCCW                                                 *#SECURGL 69440016
.LGFCCW  AIF ('&TEST'(1,14) NE 'CALL  DERGFCCW').LSCAN        *#SECURGL 69450016
 AIF   ('&I'(2,6)  NE '1,2,3 '                 ).DSINVC       *#SECURGL 69460016
 AIF   ('&O'(2,4)  EQ 'NONE'                   ).DSHEAD       *#SECURGL 69470016
 AGO  .DSINVC                                                 *#SECURGL 69480016
.GGFCCW   ANOP                                                *#SECURGL 69490016
.**************************************************************         69500016
DERGFCCW SGDSK 'HEADING        ','START OF CODEBLOCK'          @DERPDGL 69510016
         USING CCBADR,R1                                       @D51TDPM 69520016
         USING ERBLKADR,R2                                     @D51TDPM 69530016
         USING PUBADR,R3                                       @D51TDPM 69540016
*                                                              @D51TDPM 69560016
*   INITIALIZE THE FAILING VIRTUAL CCW ADDRESS AND THE FAILING @D51TDPM 69570016
*   REAL CCW ADDRESS TO ZERO.                                  @D51TDPM 69580016
*                                                              @D51TDPM 69590016
         TM   DEROEFL1,DEROEMAR   BRANCH WHEN MESSAGING AND... @D51TDPM 69600016
         BNZ  DERFC090              RECORDING ONLY.            @D51TDPM 69610016
DERGF100 EQU  *                                                @D51TDPM 69620016
*                                                              @D51TDPM 69630016
*   ATTEMPT TO LOCATE THE FAILING CCW AND THE FAILING COMMAND  @D51TDPM 69640016
*   CCW.  VERIFY THAT THE ADDRESSES ARE VALID.                 @D51TDPM 69650016
*                                                              @D51TDPM 69660016
         CLI   ERRQLSNS,32         BRANCH IF 32 BYTE SENSE OR  @DA41099 69670016
         BE    DERFC010              24 BYTE COMPATIBLE        @DA41099 69680016
         CLI   ERRQLSNS,24         BRANCH IF NOT 24 BYTE SENSE @DA41099 69690016
         BNE   DERFC090              SINCE UNKNOWN LENGTH..    @DA41099 69700016
         TM    ERRQSNS+2,X'04'     BRANCH IF IMPRECISE ENDING  @DA41099 69710016
         BO    DERFC020              INDICATED                 @DA41099 69720016
         B     DERFC030            CONTINUE, NO IMPRECISE END  @DA41099 69730016
DERFC010 DS    0H                                              @DA41099 69740016
         CLI   PUBDEVTY,TFBA       BRANCH IF DEVICE IS FBA     @DERPDGL 69750016
         BE    DERFC030              DEVICE (NO IMPREC.ENDING) @DERPDGL 69760016
         TM    ERRQSNS+1,X'01'     BRANCH IF IMPRECISE ENDING  @DA41099 69770016
         BNO   DERFC030              NOT INDICATED IN SENSE    @DA41099 69780016
DERFC020 DS    0H                                              @DA41099 69790016
*                                                              @DERPDGL 69810016
*  IMPRECISE ENDING IS ON. HANDLE IT BY CALCULATING THE        @DA41511 69820016
*  CCWCSW ADDRESS FROM THE INFORMATION IN THE SENSE DATA.      @DERPDGL 69830016
*  TO DO THIS, WE FIRST LOOK FOR THE LAST LOCATE RECORD        @DERPDGL 69840016
*  COMMAND IN FRONT OF THE FAILING CCW.                        @DERPDGL 69850016
*                                                              @DERPDGL 69860016
         LA    R9,LOCREC          TAKE LOCATE RECORD OPCODE    @DERPDGL 69870016
 SGDSK  'CALL  DERSCAN         ','FIND THE LAST TIME ITS USED',      GLX69880016
               I='1,9               ON RETURN+4',              @DERPDGLX69890016
               O='5                 R5 POINTS TO FOUND CCW',   @DERPDGLX69900016
               E0='DERFC090         ERROR:NO SUCH OPCODE'      @D51TDPM 69910016
*                                                              @DERPDGL 69930016
*  WE FOUND THE CCW SOMEWHERE IN THE DOMAIN OF THE LOCATE      @DERPDGL 69940016
*  RECORD AND WILL NOW GO BACK TO SCAN THE DOMAIN A SECOND     @DERPDGL 69950016
*  TIME, UNLESS IT IS THE SPECIAL CASE OF A NO RECORD FOUND    @DERPDGL 69960016
*  CONDITION.                                                  @DERPDGL 69970016
.* THIS CASE IS SPECIAL SINCE THE RESULT OF THE CALCULATION    @DERPDGL 69980016
.* ACCORDING TO THE PRESCRIPTION GIVEN IN THE 3990 MANUAL      @DERPDGL 69990016
.* WOULD STILL RETURN THE FIRST DATA TRANSFER COMMAND AS       @DERPDGL 70000016
.* THE FAILING COMMAND, IF WE HAVE A NO RECORD FOUND CONDITION.@DERPDGL 70010016
.* THE NUMBER OF UNITS OF TRANSFER THAT WERE NOT SUCCESSFULLY  @DERPDGL 70020016
.* TRANSMITTED TO STORAGE (AS GIVEN IN SENSE BYTE 3) IS SET TO @DERPDGL 70030016
.* THE FULL AMOUNT MENTIONED IN THE LOCATE RECORD DOMAIN. FOR  @DERPDGL 70040016
.* A DATA CHECK WE WOULD RIGHTLY ASSUME THAT THIS HAPPENED IN  @DERPDGL 70050016
.* THE FIRST DATA TRANSFER COMMAND. FOR A NO RECORD FOUND WE   @DERPDGL 70060016
.* KNOW, THAT IT IS THE LOCATE RECORD ITSELF THAT FAILED.      @DERPDGL 70070016
*                                                              @DERPDGL 70080016
         LR    R8,R5               TAKE LOCATE RECORD POINTER  @DERPDGL 70090016
         USING CCWADR,R8                                       @DERPDGL 70100016
         LA    R0,3                FOR BYTE 3 OF LOCREC PARMS  @DERPDGL 70110016
         STM   R0,RE,DERDERSV                                  @DERPDGL 70120016
         L     R6,DISPAD           GET ADDRESSABILITY TO THE...@DERPDGL 70130016
         USING DISP,R6               DISPATCHER.               @DERPDGL 70140016
         AMODESW SET,AMODE=24,WR=(R7) ENTER 24-BIT ADDR. MODE  @D52VDAP 70150016
         BAL   R7,GETDADR          GET DATA ADDRESS            @D14ZDDK 70160016
         DROP  R6,RC                                           @DERPDGL 70170016
         BALR  RA,0                RESTORE GLOBAL AREA         @DERPDGL 70180016
         USING *,RA                                            @DERPDGL 70190016
         ICM   RA,8,=X'00'                                     @DERPDGL 70200016
         AMODESW SET,AMODE=31,WR=(R7) ENTER 31-BIT ADDR. MODE  @D52VDAP 70210016
         L     RA,=A(DERGLOB)            POINTER AND RELOAD    @DERPDGL 70220016
         USING DERGLOB,RA                                      @DERPDGL 70230016
         LM    R0,RE,DERDERSV            ALL REGS EXCEPT ANSWER@DERPDGL 70240016
         USING DERGFCCW,RC               REG OF GETDADR        @D51TDPM 70250016
         LTR   RF,RF               TEST IF THE ADDRESS EXISTED @DERPDGL 70260016
         BZ    DERFC090                                        @DERPDGL 70270016
*                                                              @DERPDGL 70280016
         SLR   R5,R5               TAKE RECORD COUNT OUT OF    @DERPDGL 70290016
         IC    R5,0(,RF)             DOMAIN OF LOCREC COMMAND  @DERPDGL 70300016
*                                                              @DERPDGL 70320016
         TM    CCWCHAIN,DC         BRANCH IF LOCREC HAS DATA   @DERPDGL 70330016
         BO    DERFC090              CHAINING ON.              @DERPDGL 70340016
*                                                              @DERPDGL 70350016
         SLR   R9,R9               TAKE NUMBER OF REMAINING    @DERPDGL 70360016
         IC    R9,ERRQSNS+3          RECORDS TO BE TRANSFERRED @DERPDGL 70370016
         SR    R5,R9               SUBTRACT IT TO GET DONE ONES@DERPDGL 70380016
         LTR   R9,R5               BRANCH IF IT IS             @DERPDGL 70390016
         BM    DERFC090              NOT A POSITIVE NUMBER     @DERPDGL 70400016
         BNZ   DERFC200            BRANCH IF IT IS > 0         @DERPDGL 70410016
         TM    DERCRRA3,DERRA3NR   BRANCH IF WE ARE NOT HERE   @DERPDGL 70420016
         BNO   DERFC200              FOR NO RECORD FOUND       @DERPDGL 70430016
         LR    R4,R8               TAKE LOCATE AS COMMAND CCW  @DERPDGL 70440016
         B     DERFC242            AND ENTER IN CCBCSWW        @DERPDGL 70460016
*                                                              @DERPDGL 70470016
DERFC200 LA    R9,1(,R9)           LOOP AT LEAST ONCE.         @DERPDGL 70480016
 SGDSK  'CALL  DERBUMP          ','BUMP TO NEXT CCW ',         @DERPDGLX70490016
               I='8                  ON RETURN TO +8 ',        @DERPDGLX70500016
               O='8                  R8 POINTS TO NXT CCW',    @DERPDGLX70510016
               E0='DERFC090          ERROR: NOT ADDRESSABLE',  @DERPDGLX70520016
               E4='DERFC090          ERROR: CHAIN ENDED'       @DERPDGL 70530016
*                                                              @DERPDGL 70540016
DERFC210 CLI   CCWCODE,READSCNT    BRANCH IF A READ COUNT      @DERPDGL 70560016
         BE    DERFC220              SINGLE TRACK              @DERPDGL 70570016
         CLI   CCWCODE,READMCNT    BRANCH IF NOT A READ COUNT  @DERPDGL 70580016
         BNE   DERFC230              MULTI TRACK               @DERPDGL 70590016
DERFC220 LR    R4,R8               KEEP OLD COMMAND CCW        @DERPDGL 70600016
DERFC222 LR    R5,R8               KEEP OLD FOR DATA CHAIN CHK @DERPDGL 70610016
 SGDSK  'CALL  DERBUMP          ','BUMP TO NEXT CCW ',         @DERPDGLX70620016
               I='8                  ON RETURN TO +8 ',        @DERPDGLX70630016
               O='8                  R8 POINTS TO NXT CCW',    @DERPDGLX70640016
               E0='DERFC090          ERROR: NOT ADDRESSABLE',  @DERPDGLX70650016
               E4='DERFC300          ERROR: CHAIN ENDED'       @DERPDGL 70660016
         TM    CCWCHAIN-CCWADR(R5),DC  BRANCH IF LAST CCW HAD  @DERPDGL 70670016
         BO    DERFC222              DATA CHAINING ON          @DERPDGL 70680016
         CLI   CCWCODE,RDDATA                                  @DERPDGL 70690016
         BE    DERFC230                                        @DERPDGL 70700016
         CLI   CCWCODE,RDKYDATA                                @DERPDGL 70710016
         BE    DERFC230                                        @DERPDGL 70720016
         CLI   CCWCODE,READDATA                                @DERPDGL 70730016
         BE    DERFC230                                        @DERPDGL 70740016
         CLI   CCWCODE,RDKYDATA+MULTITRK                       @DERPDGL 70750016
         BNE   DERFC240                                        @DERPDGL 70760016
*                                                              @DERPDGL 70770016
DERFC230 LR    R4,R8               KEEP OLD COMMAND CCW        @DERPDGL 70780016
DERFC232 LR    R5,R8               KEEP OLD FOR DATA CHAIN CHK @DERPDGL 70800016
 SGDSK  'CALL  DERBUMP         ','BUMP TO NEXT CCW ',          @DERPDGLX70810016
               I='8                 ON RETURN TO +8 ',         @DERPDGLX70820016
               O='8                 R8 POINTS TO NXT CCW',     @DERPDGLX70830016
               E0='DERFC090         ERROR: NOT ADDRESSABLE',   @DERPDGLX70840016
               E4='DERFC300         ERROR: CHAIN ENDED'        @DERPDGL 70850016
         TM    CCWCHAIN-CCWADR(R5),DC  BRANCH IF LAST CCW HAD  @DERPDGL 70860016
         BO    DERFC232              DATA CHAINING ON          @DERPDGL 70870016
*                                                              @DERPDGL 70880016
DERFC240 BCT   R9,DERFC210         BRANCH IF STILL ENTITY LEFT @DERPDGL 70890016
DERFC242 LR    R8,R4               TAKE LAST COMMAND CCW       @DERPDGL 70900016
 SGDSK  'CALL  DERCVTVR        ','CONVERT VIRTUAL TO REAL',    @DERPDGLX70910016
               I='8                 ON RETURN',                @DERPDGLX70920016
               O='F                 RF IS REAL OR 0 '          @DERPDGL 70930016
         LTR   R8,RF               BRANCH IF THE CONVERSION    @DERPDGL 70940016
         BZ    DERFC090              FAILED.                   @DERPDGL 70950016
         ST    R8,DERFCCWR         STORE REAL ADDR OF FAILING  @DERPDGL 70960016
         ST    R4,DERFCCWV         STORE VIRT ADDR OF FAILING  @DERPDGL 70970016
         ST    R4,DERCCCWV         STORE VIRT ADDR OF COMMAND  @DERPDGL 70980016
         MVC   DERCRFCO,0(R4)      STORE OPCODE OF FAILING     @DERPDGL 70990016
         LA    R8,8(,R8)                                       @DERPDGL 71000016
         STCM  R8,B'0111',CCBCSWW CORRECT THE CCBCSWW FOR      @DERPDGL 71010016
         B     DERGFEX              IMPRECISE ENDING CASES     @DERPDGL 71030016
*                                                              @DERPDGL 71040016
DERFC300 BCTR  R9,0                SEE, IF PREMATURE END OF    @DERPDGL 71050016
         LTR   R9,R9                 CHAIN OR IF LEGAL ENDING  @DERPDGL 71060016
         BZ    DERFC242            BRANCH IF LEGAL ENDING      @DERPDGL 71070016
         B     DERFC090            BRANCH IF PREMATURE         @DERPDGL 71080016
*                                                              @DERPDGL 71090016
.*  SAN JOSE PROMISED, THAT NORMALLY ALL UNIT CHECKS COME IN   @DERPDGL 71100016
.*  AFTER A CHANNEL COMMAND RETRY OPERATION, IF A RESTART CCW  @DERPDGL 71110016
.*  TYPE TWO IS GOING TO BE BUILT. THERE SHOULD NOT BE A       @DERPDGL 71120016
.*  CHANNEL COMMAND RETRY OPERATION BY THE CONTROL UNIT IN     @DERPDGL 71130016
.*  CASE A RESTART CCW TYPE 1 IS REQUIRED. BUT ALL THESE       @DERPDGL 71140016
.*  PROMISES WERE JUST GIVEN ON THE PHONE AND WE HAVE NO       @DERPDGL 71150016
.*  CHOICE TO PROOVE IT. SO WE WILL CHECK IN ALL REQUIRED      @DERPDGL 71160016
.*  PLACES IF THE ASSUMPTION "CHANNEL COMMAND RETRY WAS        @DERPDGL 71170016
.*  INITIATED" IS CORRECT OR NOT. UNFORTUNATELY THIS REQUIRES  @DERPDGL 71180016
.*  A COMPLETE SCAN OF THE CCW CHAIN EACH AND EVERY TIME WE    @DERPDGL 71190016
.*  COME THRU HERE.                                            @DERPDGL 71200016
.*  A CHANNEL COMMAND RETRY OPERATION WOULD MEAN, THAT THE     @DERPDGL 71210016
.*  FAILING CCW IN THE CSW IS ALWAYS THE FIRST CCW (COMMAND    @DERPDGL 71220016
.*  CCW) IN A DATA CHAIN, IF THERE IS SUCH A DATA CHAIN.       @DERPDGL 71230016
.*                                                             @DERPDGL 71240016
DERFC030 DS    0H                                              @DA41099 71250016
         SLR   R9,R9              NOTHING TO SCAN FOR.         @DERPDGL 71270016
 SGDSK  'CALL  DERSCAN         ','JUST SET FAILING CCW AND   ',      GLX71280016
               I='1,9               COMMAND CCW',              @DERPDGLX71290016
               O='5                 ADDRESS ',                 @DERPDGLX71300016
               E0='DERFC090         ERROR:SOMETHING WRONG'     @D51TDPM 71310016
*                                                              @D51TDPM 71320016
DERGFEX  SGDSK 'RETURN         ','RETURN TO CALLER         '   @DERPDGL 71330016
DERFC090 DS    0H                 PREPARE FOR ERROR EXIT       @DERPDGL 71340016
         XR   R8,R8                                            @DERPDGL 71360016
         ST   R8,DERFCCWR         RESET REAL FAILING CCW ADDR. @DERPDGL 71370016
         ST   R8,DERFCCWV         RESET VIRT.FAILING CCW ADDR. @DERPDGL 71380016
         ST   R8,DERCCCWV         RESET VIRT.COMMAND CCW ADDR. @DERPDGL 71390016
         MVI  DERCRFCO,X'00'      RESET OPCODE OF FAILING CCW  @DERPDGL 71400016
         B     DERGFEX            LEAVE                        @DERPDGL 71410016
         DROP  ,                                               @D66ADAP 71420016
         USING SYSS00,R0                                       @D66ADAP 71430016
         LTORG                                                 @D51TDPM 71440016
*                                                                       71450016
***************************************************************         71460016
*  FUNCTION                                                    @DERPDGL 71470016
*     SCAN THE CCW CHAIN FOR THE LAST OCCURENCE OF A CERTAIN   @DERPDGL 71480016
*     OPCODE (LOCATE RECORD OR SEEK) IN THE CHAIN BEFORE THE   @DERPDGL 71490016
*     CCW INDICATED AS THE FAILING CCW IN THE CCBCSWW.         @DERPDGL 71500016
.*                                                             @DERPDGL 71510016
.* THERE IS THE FOLLOWING PROBLEM IN THIS CODE. IT CAN BE,     @DERPDGL 71520016
.* THAT AFTER A STATUS MODIFIER COMMAND, THE TIC THAT FOLLOWS  @DERPDGL 71530016
.* IT DOES NOT POINT BACK TO THIS STATUS MODIFIER. THIS IS     @DERPDGL 71540016
.* THE CASE FOR EXAMPLE WITH READ COUNT, SEARCH KEY COMBINA-   @DERPDGL 71550016
.* TIONS. WE THEREFORE KEEP THE ADDRESSES OF THE LAST 10       @DERPDGL 71560016
.* COMMAND CCWS WE FOUND IN MIND AND TRY TO IDENTIFY THE       @DERPDGL 71570016
.* FOUND TIC TARGET AMONG THESE. IF WE CAN NOT FIND IT,        @DERPDGL 71580016
.* SORRY, WE GIVE UP. THE ADDRESSES ARE KEPT IN A BUFFER,      @DERPDGL 71590016
.* THAT IS FILLED FROM BOTTOM TO TOP.                          @DERPDGL 71600016
.*                                                             @DERPDGL 71610016
*                                                              @DERPDGL 71620016
*  INPUT                                                       @DERPDGL 71630016
*    - R1 CONTAINS THE ADDRESS OF A CCB.                       @DERPDGL 71640016
*    - R9 CONTAINS THE OPCODE WE ARE LOOKING FOR.              @DERPDGL 71650016
*         IF THIS OPCODE IS ZERO, WE JUST WANT TO HAVE THE     @DERPDGL 71660016
*         FAILING CCW AND THE FAILING COMMAND CCW SET          @DERPDGL 71670016
*                                                              @DERPDGL 71680016
*  OUTPUT ON RETURN TO RETURN+4                                @DERPDGL 71690016
*    - R5 CONTAINS THE ADDRESS OF THE CCW WE LOOKED FOR.       @DERPDGL 71700016
*                                                              @DERPDGL 71710016
*  OUTPUT ON RETURN TO RETURN+0                                @DERPDGL 71720016
*    - NONE. CHAIN WAS AMBIGUOUS OR OPCODE NOT FOUND           @DERPDGL 71730016
***************************************************************         71740016
 AGO  .GSCAN                                                  *#SECURGL 71750016
.LSCAN   AIF ('&TEST'(1,14) NE 'CALL  DERSCAN ').LBUMP        *#SECURGL 71760016
 AIF   ('&I'(2,4)  NE '1,9 '                   ).DSINVC       *#SECURGL 71770016
 AIF   ('&O'(2,2)  NE '5 '                     ).DSINVC       *#SECURGL 71780016
 AIF   (T'&E0      NE 'O'                      ).DSHEAD       *#SECURGL 71790016
 AGO  .DSINVC                                                 *#SECURGL 71800016
.GSCAN    ANOP                                                *#SECURGL 71810016
.**************************************************************         71820016
DERSCAN  SGDSK 'HEADING         ','START OF CODEBLOCK'         @DERPDGL 71830016
         USING CCBADR,R1                                       @DERPDGL 71840016
*                                                              @DERPDGL 71860016
.*  IN CASE A USER TRANSLATED CHAIN HAS CHNBIT ON IN CCB       @D61ADJK 71870016
.*  WE CANNOT BE SURE THE CHAIN IS STILL VALID.                @D61ADJK 71880016
.*                                                             @D61ADJK 71890016
         TM    DERFLG1,DERCVUCH    BRANCH IF USER DID NOT      @D61ADJK 71900016
         BNO   DERSCN01              SPECIFY CHNBIT IN CCB     @D61ADJK 71910016
         TM    DERFLG1,DERCVUCC    BRANCH IF HIS CHAIN IS      @D61ADJK 71920016
         BNO   DERSCNE0              POSSIBLY MODIFIED.        @D61ADJK 71930016
DERSCN01 SLR   R8,R8               TAKE CSW CCW ADDRESS        @D61ADJK 71940016
         ICM   R8,B'0111',CCBCSWW    FROM CCB.                 @DERPDGL 71950016
         BZ    DERSCNE0            LEAVE IF NO ENDING CCW      @DA42922 71960016
         S     R8,=F'8'            SUBTRACT 8 TO POINT TO CCW  @DERPDGL 71970016
 SGDSK  'CALL  DERCVTRV         ','CONVERT REAL TO VIRTUAL ',  @DERPDGLX71980016
               I='8                  ON RETURN',               @DERPDGLX71990016
               O='F                  RF =0 OR VIRTUAL ADDR'    @DERPDGL 72000016
         LTR   R7,RF               BRANCH IF VIRTUAL ADDR.     @DERPDGL 72010016
         BZ    DERSCNE0              IS NOT ADDRESSABLE        @DERPDGL 72020016
         LTR   R9,R9               BRANCH IF NOT SETTING OF    @DERPDGL 72030016
         BNZ   DERSCN00              FAILING CCW VALUES REQU.  @DERPDGL 72040016
         ST    R7,DERFCCWV         STORE VIRT.ADDR OF FAILING  @DERPDGL 72050016
         ST    R8,DERFCCWR         STORE REAL ADDR OF FAILING  @DERPDGL 72060016
DERSCN00 DS    0H                                              @DERPDGL 72070016
         SLR   R8,R8               TAKE START OF CCW CHAIN     @DERPDGL 72090016
         ICM   R8,B'0111',CCBCCW+1   FROM CCB.                 @DERPDGL 72100016
 SGDSK  'CALL  DERCVTRV         ','CONVERT REAL TO VIRTUAL ',  @DERPDGLX72110016
               I='8                  ON RETURN',               @DERPDGLX72120016
               O='F                  RF =0 OR VIRTUAL ADDR'    @DERPDGL 72130016
         LTR   R8,RF               BRANCH IF VIRTUAL ADDR.     @DERPDGL 72140016
         BZ    DERSCNE0              IS NOT ADDRESSABLE        @DERPDGL 72150016
         SLR   R5,R5               RESET PTR TO LAST FOUND CCW @DERPDGL 72170016
         LA    R4,=XL8'00'         POINT TO CCW WITHOUT DC ON  @DERPDGL 72180016
         LA    R6,4095             SET BDY FOR INFINITE LOOP   @DERPDGL 72190016
         XC    DERSCABU(12*4),DERSCABU  CLR TAB.OF FOUND CCWS  @DERPDGL 72200016
         B     DERSCN50            BEGIN WITH WHILE LOOP       @DERPDGL 72210016
*                                                              @DERPDGL 72220016
*  PREPARATIONS ALL DONE. NOW LOOK FOR THE OPCODE IN QUESTION. @DERPDGL 72230016
*                                                              @DERPDGL 72240016
         USING CCWADR,R8                                       @DERPDGL 72250016
DERSCN10 DS    0H                  LOOP START                  @DERPDGL 72260016
         TM    CCWCHAIN-CCWADR(R4),DC  BRANCH IF DATA CHAINING @DERPDGL 72270016
         BO    DERSCN40                                        @DERPDGL 72280016
.*                                                             @DERPDGL 72290016
.*  SORT IN THE NEW FOUND COMMAND CCW INTO BUFFER OF KNOWNS    @DERPDGL 72300016
.*                                                             @DERPDGL 72310016
         MVC   DERSCABU(11*4),DERSCABU+(1*4)     SORT IN THE   @DERPDGL 72320016
         ST    R8,DERSCABU+11*4      NEW FOUND COMMAND CCW     @DERPDGL 72330016
.*                                                             @DERPDGL 72340016
         MVC   DERDERSV(1),CCWCODE MOVE INTO WORKFIELD         @DERPDGL 72350016
         NI    DERDERSV,X'7F'      SWITCH OFF MULTITRACK BIT   @DERPDGL 72360016
         CLI   DERDERSV,SKE        BRANCH IF COMMAND IS        @DERPDGL 72370016
         BE    DERSCN30              SEARCH KEY EQUAL          @DERPDGL 72380016
         CLI   DERDERSV,SEARCH     BRANCH IF COMMAND IS        @DERPDGL 72390016
         BE    DERSCN30              SEARCH                    @DERPDGL 72400016
         CLI   DERDERSV,SEARCHA    BRANCH IF COMMAND IS        @DERPDGL 72410016
         BE    DERSCN30              SEARCH HOME ADDRESS       @DERPDGL 72420016
         CLI   DERDERSV,SKH        BRANCH IF COMMAND IS        @DERPDGL 72430016
         BE    DERSCN30              SEARCH KEY HIGH           @DERPDGL 72440016
         CLI   DERDERSV,SIDH       BRANCH IF COMMAND IS        @DERPDGL 72450016
         BE    DERSCN30              SEARCH ID HIGH            @DERPDGL 72460016
         CLI   DERDERSV,SCHKHE     BRANCH IF COMMAND IS        @DERPDGL 72470016
         BE    DERSCN30              SEARCH KEY HIGH OR EQUAL  @DERPDGL 72480016
         CLI   DERDERSV,SIDEH      BRANCH IF COMMAND IS NOT    @DERPDGL 72490016
         BNE   DERSCN40              SEARCH ID EQUAL OR HIGH   @DERPDGL 72500016
.*                                                             @DERPDGL 72510016
.*  SINCE IT IS A STATUS MODIFIER, LOOK IF THERE IS A TIC      @DERPDGL 72520016
.*  BEHIND IT THAT LEADS US TO A PLACE WE HAD COME THRU ALREADY@DERPDGL 72530016
.*  IF THERE IS NO TIC BEHIND THE STATUS MODIFIER, WE REFUSE   @DERPDGL 72540016
.*  TO SCAN ON WITH THIS LOGIC...                              @DERPDGL 72550016
.*                                                             @DERPDGL 72560016
DERSCN30 DS    0H                                              @DERPDGL 72570016
         LR    R4,R8               PRESERVE OLD ADDRESS        @DERPDGL 72580016
 SGDSK  'CALL  DERBUMP          ','BUMP TO NEXT CCW ',         @DERPDGLX72590016
               I='8                  ON RETURN TO +8 ',        @DERPDGLX72600016
               O='8                  R8 POINTS TO NXT CCW',    @DERPDGLX72610016
               E0='DERSCNE0          ERROR: NOT ADDRESSABLE',  @DERPDGLX72620016
               E4='DERSCNE0          ERROR: CHAIN ENDED'       @DERPDGL 72630016
         LA    R3,11*4               TAKE INDEX OF 1ST TO TEST @DERPDGL 72640016
DERSCN32 C     R8,DERSCABU(R3)     COMPARE IF WE HAD THIS ONE  @DERPDGL 72650016
         BE    DERSCN34              ALREADY.                  @DERPDGL 72660016
         S     R3,=A(4)              IF NOT, TAKE NEXT ONE     @DERPDGL 72670016
         BNM   DERSCN32              UNTIL ALL USED UP.        @DERPDGL 72680016
         B     DERSCNE0              NO TIC BEHIND STATUS MOD. @DERPDGL 72700016
DERSCN34 TM    CCWCHAIN-CCWADR(R4),DC B IF STATUS MODIFIER WITH@DERPDGL 72710016
         BO    DERSCNE0              DATA CHAINING ON (...)    @DERPDGL 72720016
         LR    R8,R4                                           @DERPDGL 72740016
         LA    R4,=XL8'00'                                     @DERPDGL 72750016
 SGDSK  'CALL  DERCVTVR         ','CONVERT VIRTUAL TO REAL',   @DA42922X72760016
               I='8                  ON RETURN',               @DA42922X72770016
               O='F                  RF IS REAL OR 0 '         @DA42922 72780016
         LTR   R8,RF               BRANCH WHEN THE FIRST BYTE..@DA42922 72790016
         BZ    DERSCNE0              IS NOT ADDRESSABLE.       @DA42922 72800016
         LA    R8,2*8(,R8)          GO BEHIND TIC              @DA42922 72810016
 SGDSK  'CALL  DERCVTRV         ','CONVERT REAL TO VIRTUAL',   @DA42922X72820016
               I='8                  ON RETURN',               @DA42922X72830016
               O='F                  RF IS REAL OR 0 '         @DA42922 72840016
         LTR   R8,RF               BRANCH WHEN THE FIRST BYTE..@DA42922 72850016
         BZ    DERSCNE0              IS NOT ADDRESSABLE.       @DA42922 72860016
         TM    0(R8),X'07'         IS THIS A TIC AGAIN?        @DA42922 72870016
         BNZ   DERSCN50            BRANCH IF NOT               @DA42922 72880016
         TM    0(R8),X'08'         IS IT REALLY A TIC          @DA42922 72890016
         BZ    DERSCN50            BRANCH IF NOT               @DA42922 72900016
         B     DERSCN42            BUMP OVER THIS ONCE MORE.   @DA42922 72910016
DERSCN40 LR    R4,R8               PRESERVE OLD CCW POINTER    @DERPDGL 72920016
DERSCN42 DS    0H                                              @DA42922 72930016
 SGDSK  'CALL  DERBUMP          ','BUMP TO NEXT CCW ',         @DERPDGLX72940016
               I='8                  ON RETURN TO +8 ',        @DERPDGLX72950016
               O='8                  R8 POINTS TO NXT CCW',    @DERPDGLX72960016
               E0='DERSCNE0          ERROR: NOT ADDRESSABLE',  @DERPDGLX72970016
               E4='DERSCNE0          ERROR: CHAIN ENDED'       @DERPDGL 72980016
DERSCN50 DS    0H                                              @DERPDGL 72990016
*                                                              @DERPDGL 73000016
         TM    CCWCHAIN-CCWADR(R4),DC  BRANCH IF DATA CHAINING @DERPDGL 73010016
         BO    DERSCN60                                        @DERPDGL 73020016
         LTR   R9,R9               BRANCH IF NOT SETTING OF    @DERPDGL 73030016
         BNZ   DERSCN55              FAILING CCW VALUES REQU.  @DERPDGL 73040016
         ST    R8,DERCCCWV         STORE VIRT.ADDR OF COMMAND  @DERPDGL 73050016
         MVC   DERCRFCO,0(R8)      STORE COMMAND OPCODE        @DERPDGL 73060016
         B     DERSCN60                                        @DERPDGL 73080016
DERSCN55 CLM   R9,1,CCWCODE        BRANCH WHEN ITS NOT SPECIF. @DERPDGL 73090016
         BNE   DERSCN56              OPCODE                    @DA43137 73100016
DERSCN58 LR    R5,R8               TAKE PTR TO INTERESTING CCW @DA43137 73110016
         B     DERSCN60                                        @DA43137 73130016
DERSCN56 CLM   R9,1,=AL1(SEEK)     DO WE SEARCH FOR A SEEK ?   @DA43137 73140016
         BNE   DERSCN60            NO, ===============>        @DA43137 73150016
         CLC   CCWCODE,=AL1(SEEKCYL) IS IT SEEK CYLINDER ?     @DA43137 73160016
         BE    DERSCN58            YES, FOUND ========>        @DA43137 73170016
DERSCN60 DS    0H                                              @DERPDGL 73180016
         CR    R8,R7               LOOP WHILE CCWPTR IS NOT    @DERPDGL 73190016
         BE    DERSCNE4              THE ADDR.GIVEN IN CSW     @DERPDGL 73200016
         BCT   R6,DERSCN10         LOOP WHILE INFINITE CTR > 0 @DERPDGL 73210016
*                                                              @DERPDGL 73220016
DERSCNE0 DS    0H                                              @DERPDGL 73230016
         SGDSK 'RETURN         ','RETURN COULD NOT FIND IT.'   @DERPDGL 73250016
DERSCNE4 LTR   R9,R9              BRANCH IF WE WERE NOT        @DERPDGL 73260016
         BZ    DERSCE40             LOOKING FOR AN OPCODE      @DERPDGL 73270016
         LTR   R5,R5              BRANCH IF WE DID NOT         @DERPDGL 73280016
         BZ    DERSCNE0             FIND IT.                   @DERPDGL 73290016
DERSCE40 DS    0H                                              @DERPDGL 73300016
         SGDSK 'RETURN4        ','FOUND IT AND RETURN ADDRESS', DERPDGLX73310016
               OUTPUT=(R5)                                     @DERPDGL 73320016
         DROP  ,                                               @D66ADAP 73330016
         USING SYSS00,R0                                       @D66ADAP 73340016
         LTORG                                                 @DERPDGL 73350016
*                                                              @DERPDGL 73360016
***************************************************************         73370016
*  FUNCTION                                                    @DERPDGL 73380016
*     BUMP TO NEXT CCW, SKIPPING TICS                          @DERPDGL 73390016
*                                                              @DERPDGL 73400016
*  INPUT                                                       @DERPDGL 73410016
*    - R8 VIRTUAL ADDRESS POINTING TO A CCW                    @DERPDGL 73420016
*                                                              @DERPDGL 73430016
*  OUTPUT                                                      @DERPDGL 73440016
*    - R8 POINTS TO NEXT CCW. VIRTUAL ADDRESS IS RETURNED.     @DERPDGL 73450016
*                                                              @DERPDGL 73460016
*  RETURNPOINT:                                                @DERPDGL 73470016
*    - RE+0 NEXT CCW NOT ADDRESSABLE IN VIRTUAL STORAGE.       @DERPDGL 73480016
*    - RE+4 IF CHAIN HAD ENDED. R8 POINTS BEHIND LAST CCW      @DERPDGL 73490016
*    - RE+8 NORMAL EXIT. R8 POINTS TO NEXT CCW, TICS SKIPPED.  @DERPDGL 73500016
*                                                              @DERPDGL 73510016
***************************************************************         73520016
 AGO  .GBUMP                                                  *#SECURGL 73530016
.LBUMP   AIF ('&TEST'(1,14) NE 'CALL  DERBUMP ').LCVTRV       *#SECURGL 73540016
 AIF   ('&I'(2,2)  NE '8 '                     ).DSINVC       *#SECURGL 73550016
 AIF   ('&O'(2,2)  NE '8 '                     ).DSINVC       *#SECURGL 73560016
 AIF   (T'&E0      EQ 'O'                      ).DSINVC       *#SECURGL 73570016
 AIF   (T'&E4      NE 'O'                      ).DSHEAD       *#SECURGL 73580016
 AGO  .DSINVC                                                 *#SECURGL 73590016
.GBUMP    ANOP                                                *#SECURGL 73600016
.**************************************************************         73610016
DERBUMP  SGDSK 'HEADING        ','START OF CODEBLOCK'          @DERPDGL 73620016
*                                                              @DERPDGL 73630016
         LR    R5,R8                                           @DERPDGL 73650016
         LR    R7,R8              SAVE CURRENT CCW ADDRESS     @DA42600 73660016
         TM    0(R5),X'0F'-TIC    COULD IT BE A TIC?           @DERPDGL 73670016
         BZ    DERBUM28           YES, LOOK FOR IT             @DERPDGL 73680016
DERBUM10 LA    R8,8(,R8)          PROCEED TO NEXT VIRTUAL CCW  @DERPDGL 73690016
         TM    CCWCHAIN-CCWADR(R5),CC+DC  WAS THERE A NEXT ONE?@DERPDGL 73700016
         BZ    DERBUME4           NO, END OF CHAIN             @DERPDGL 73710016
         LR    R6,R8              IS THE NEXT ONE ON SAME      @DERPDGL 73720016
         N     R5,PADDRMSK          PAGE?                      @DERPDGL 73730016
         N     R6,PADDRMSK                                     @DERPDGL 73740016
         CR    R5,R6                                           @DERPDGL 73750016
         BNE   DERBUM40           NO, DO CONVERSIONS           @DERPDGL 73760016
DERBUM20 TM    0(R8),X'0F'-TIC    IS IT A TIC                  @DERPDGL 73770016
         BNZ   DERBUME8           NO  SKIP                     @DERPDGL 73780016
         TM    0(R8),TIC          IS IT A TIC                  @DERPDGL 73790016
         BNO   DERBUME8           NO  SKIP                     @DERPDGL 73800016
         B     DERBUM30                                        @DERPDGL 73810016
*                                                              @DERPDGL 73820016
DERBUM28 TM    0(R5),TIC          IS IT A TIC                  @DERPDGL 73830016
         BNO   DERBUM10           NO  SKIP                     @DERPDGL 73840016
DERBUM30 DS    0H                 YES, ITS A TIC AND WE FOLLOW @DERPDGL 73850016
         ICM   R8,B'0111',CCWBUF+1-CCWADR(R8)   TAKE TARGET    @DERPDGL 73870016
         ICM   R8,B'1000',=X'00'                               @DERPDGL 73880016
 SGDSK  'CALL  DERCVTRV        ','CONVERT REAL TO VIRTUAL ',   @DERPDGLX73890016
               I='8                 ON RETURN',                @DERPDGLX73900016
               O='F                 RF =0 OR VIRTUAL ADDR'     @DERPDGL 73910016
         LTR   R8,RF                                           @DERPDGL 73920016
         BNZ   DERBUME8                                        @DERPDGL 73930016
         B     DERBUME0                                        @DERPDGL 73940016
*                                                              @DERPDGL 73950016
DERBUM40 LR    R8,R7              RESTORE OLD CURRENT CCW ADDR @DA42600 73960016
 SGDSK  'CALL  DERCVTVR        ','CONVERT VIRTUAL TO REAL',    @DERPDGLX73980016
               I='8                 ON RETURN',                @DERPDGLX73990016
               O='F                 RF IS REAL OR 0 '          @DERPDGL 74000016
         LTR   R8,RF                                           @DERPDGL 74010016
         BZ    DERBUME0                                        @DERPDGL 74020016
         LA    R8,8(,R8)          BUMP TO NEXT IN REAL         @DERPDGL 74030016
 SGDSK  'CALL  DERCVTRV        ','CONVERT REAL TO VIRTUAL ',   @DERPDGLX74040016
               I='8                 ON RETURN',                @DERPDGLX74050016
               O='F                 RF =0 OR VIRTUAL ADDR'     @DERPDGL 74060016
         LTR   R8,RF                                           @DERPDGL 74070016
         BNZ   DERBUM20                                        @DERPDGL 74080016
*        B     DERBUME0                                        @DERPDGL 74090016
*                                                              @DERPDGL 74100016
DERBUME0 DS    0H                                              @DERPDGL 74110016
         SGDSK 'RETURN         ','RETURN NOT ADDRESSABLE   '   @DERPDGL 74130016
DERBUME4 DS    0H                                              @DERPDGL 74140016
         SGDSK 'RETURN4        ','RETURN END OF CHAIN REACHED' @DERPDGL 74160016
DERBUME8 DS    0H                                              @DERPDGL 74170016
         SGDSK 'RETURN8        ','RETURN NORMAL            ',  @DERPDGLX74190016
               OUTPUT=(R8)                                     @DERPDGL 74200016
         DROP  ,                                               @D66ADAP 74210016
         USING SYSS00,R0                                       @D66ADAP 74220016
         LTORG                                                 @DERPDGL 74230016
*                                                                       74240016
***************************************************************         74250016
*  FUNCTION                                                    @D51TDPM 74260016
*     THE VIRTAD PROCEDURE IS CALLED TO CONVERT THE REAL       @D51TDPM 74270016
*     ADDRESS TO A VIRTUAL ADDRESS.                            @D51TDPM 74280016
*                                                              @D51TDPM 74290016
*  INPUT                                                       @D51TDPM 74300016
*    - R8 CONTAINS A REAL ADDRESS.                             @D51TDPM 74310016
*                                                              @D51TDPM 74320016
*  OUTPUT                                                      @D51TDPM 74330016
*    - RF CONTAINS THE VIRTUAL ADDRESS OR ZERO IF INEXISTANT   @D51TDPM 74340016
*                                                              @D51TDPM 74350016
***************************************************************         74360016
 AGO  .GCVTRV                                                 *#SECURGL 74370016
.LCVTRV  AIF ('&TEST'(1,14) NE 'CALL  DERCVTRV').LCVTVR       *#SECURGL 74380016
 AIF   ('&I'(2,2)  NE '8 '                     ).DSINVC       *#SECURGL 74390016
 AIF   ('&O'(2,2)  EQ 'F '                     ).DSHEAD       *#SECURGL 74400016
 AGO  .DSINVC                                                 *#SECURGL 74410016
.GCVTRV   ANOP                                                *#SECURGL 74420016
.**************************************************************         74430016
DERCVTRV SGDSK 'HEADING        ','START OF CODEBLOCK'          @DERPDGL 74440016
         L    R1,IJBSMCOM                                      @DERPDGL 74450016
         USING SMCOM,R1                                        @DERPDGL 74460016
         LR   RF,R8                                            @DERPDGL 74470016
         CL   RF,SMCSUPND                                      @DERPDGL 74480016
         BL   DERCVTRX                                         @DERPDGL 74490016
         DROP R1                                               @DERPDGL 74500016
*                                                              @D51TDPM 74510016
         STM  R0,RE,DERDERSV SAVE REGISTERS ACCROSS VIRTAD.    @D51TDPM 74520016
         LR   R9,R8          SET INPUT TO VIRTAD.              @D51TDPM 74530016
         AMODESW CALL,ADDRESS=VIRTAD,REGS=R6                   @D52VDAP 74540016
*SGLINK  VIRTAD,INPUT=(R6,R9),OUTPUT=RF,WORK=R9                @D52VDAP 74550016
         DROP  RC                                              @DERPDGL 74560016
         BALR  RA,0                      RESTORE GLOBAL AREA   @DERPDGL 74570016
         USING *,RA                                            @DERPDGL 74580016
         L     RA,=A(DERGLOB)            POINTER AND RELOAD    @DERPDGL 74590016
         USING DERGLOB,RA                                      @DERPDGL 74600016
         LM    R0,RE,DERDERSV            ALL REGS EXCEPT ANSWER@DERPDGL 74610016
         USING DERCVTRV,RC               REG OF GETDADR        @D51TDPM 74620016
DERCVTRX SGDSK 'RETURN         ','RETURN TO CALLER         ',  @DERPDGLX74630016
               OUTPUT=(RF)                                     @DERPDGL 74640016
         DROP  ,                                               @D66ADAP 74650016
         USING SYSS00,R0                                       @D66ADAP 74660016
         LTORG                                                 @DERPDGL 74670016
*                                                                       74680016
***************************************************************         74690016
*  FUNCTION                                                    @D51TDPM 74700016
*     TO CONVERT A VIRTUAL ADDRESS TO THE CORRESPONDING REAL   @D51TDPM 74710016
*     ADDRESS.  THE VIRTUAL ADDRESS IS GIVEN IN R8.  THE REAL  @D51TDPM 74720016
*     ADDRESS IS RETURNED IN RF.  RF WILL BE ZERO WHEN THE     @D51TDPM 74730016
*     VIRTUAL ADDRESS DOES NOT HAVE A CORRESPONDING REAL       @D51TDPM 74740016
*     ADDRESS.                                                 @D51TDPM 74750016
*                                                              @D51TDPM 74760016
*     THE REALAD MACRO SERVICE IS USED TO CONVERT THE VIRTUAL  @D51TDPM 74770016
*     ADDRESS TO A REAL ADDRESS.                               @D51TDPM 74780016
*                                                              @D51TDPM 74790016
*  INPUT                                                       @D51TDPM 74800016
*    - R8 CONTAINS A REAL ADDRESS.                             @D51TDPM 74810016
*                                                              @D51TDPM 74820016
*  OUTPUT                                                      @D51TDPM 74830016
*     - RF CONTAINS A VIRTUAL ADDRESS.                         @D51TDPM 74840016
*                                                              @D51TDPM 74850016
***************************************************************         74860016
 AGO  .GCVTVR                                                 *#SECURGL 74870016
.LCVTVR  AIF ('&TEST'(1,14) NE 'CALL  DERCVTVR').LMKTIC       *#SECURGL 74880016
 AIF   ('&I'(2,2)  NE '8 '                     ).DSINVC       *#SECURGL 74890016
 AIF   ('&O'(2,2)  EQ 'F '                     ).DSHEAD       *#SECURGL 74900016
 AGO  .DSINVC                                                 *#SECURGL 74910016
.GCVTVR   ANOP                                                *#SECURGL 74920016
.**************************************************************         74930016
DERCVTVR SGDSK 'HEADING        ','START OF CODEBLOCK'          @DERPDGL 74940016
*                                                              @D51TDPM 74950016
         L    R1,IJBSMCOM                                      @DERPDGL 74960016
         USING SMCOM,R1                                        @DERPDGL 74970016
         LR   RF,R8                                            @DERPDGL 74980016
         CL   RF,SMCSUPND                                      @DERPDGL 74990016
         BL   DERCVTEX                                         @DERPDGL 75000016
         DROP R1                                               @DERPDGL 75010016
         LR   R1,R8               PASS THE VIRTUAL ADDRESS.    @D51TDPM 75020016
         REALAD (1)               REAL ADDRESS IN R0.          @D51TDPM 75030016
         LR   RF,R0               TAKE RESPONSE                @D51TDPM 75040016
*                                                              @D51TDPM 75050016
DERCVTEX SGDSK 'RETURN         ','RETURN TO CALLER         ',  @DERPDGLX75060016
               OUTPUT=(RF)                                     @DERPDGL 75070016
         DROP  ,                                               @D66ADAP 75080016
         USING SYSS00,R0                                       @D66ADAP 75090016
         LTORG                                                          75100016
*                                                                       75110016
***************************************************************         75120016
*  FUNCTION                                                    @D51TDPM 75130016
*     ATTEMPT TO BUILD A TIC  AT LABEL DERTIC, TO THE NEXT CCW @D51TDPM 75140016
*     SUBSEQUENT TO THE ONE SPECIFIED IN R8.                   @D51TDPM 75150016
*     THE TIC AT DERTIC WILL BE A NOP, IF THERE IS NO SUCH     @D51TDPM 75160016
*     SUBSEQUENT CCW IN STORAGE.                               @D51TDPM 75170016
*                                                              @D51TDPM 75180016
*  INPUT                                                       @D51TDPM 75190016
*    - R8 CONTAINS THE VIRTUAL ADDRESS OF A CCW.               @D51TDPM 75200016
*                                                              @D51TDPM 75210016
*  OUTPUT                                                      @D51TDPM 75220016
*    - DERTIC CONTAINS A TIC OR NOP CCW.                       @D51TDPM 75230016
*    - R8 CONTAINS PTR TO CCW BEING TIC-ED TO                  @DA41136 75240016
*                                                              @D51TDPM 75250016
*  RETURNPOINTS                                                @D51TDPM 75260016
*    +0 FOR SOME ERROR OCCURED. DERTIC IS NOPPED.              @D51TDPM 75270016
*    +4 FOR NORMAL RETURN R8 IS OUTPUT                         @D51TDPM 75280016
*                                                              @D51TDPM 75290016
***************************************************************         75300016
 AGO  .GMKTIC                                                 *#SECURGL 75310016
.LMKTIC  AIF ('&TEST'(1,14) NE 'CALL  DERMKTIC').LIO          *#SECURGL 75320016
 AIF   ('&I'(2,2)  NE '8 '                     ).DSINVC       *#SECURGL 75330016
 AIF   ('&O'(2,2)  NE '8 '                     ).DSINVC       *#SECURGL 75340016
 AIF   (T'&E0      NE 'O'                      ).DSHEAD       *#SECURGL 75350016
 AGO  .DSINVC                                                 *#SECURGL 75360016
.GMKTIC   ANOP                                                *#SECURGL 75370016
.**************************************************************         75380016
DERMKTIC SGDSK 'HEADING        ','START OF CODEBLOCK'          @DERPDGL 75390016
*                                                              @D51TDPM 75410016
*   IF THE INPUT CCW IS NOT ADDRESSABLE SET THE DERTIC OPCODE  @D51TDPM 75420016
*   TO A NOP.                                                  @D51TDPM 75430016
*                                                              @D51TDPM 75440016
         MVI   DERTIC,NOP         TIC CCW NOT BUILT.           @D51TDPM 75450016
 SGDSK  'CALL  DERBUMP           ','BUMP TO NEXT CCW ',        @DERPDGLX75460016
               I='8                   ON RETURN TO +8 ',       @DERPDGLX75470016
               O='8                   R8 POINTS TO NXT CCW',   @DERPDGLX75480016
               E0='DERMKE0            ERROR: NOT ADDRESSABLE', @DERPDGLX75490016
               E4='DERMKE0            ERROR: CHAIN ENDED'      @DERPDGL 75500016
 SGDSK  'CALL  DERCVTVR        ','CONVERT VIRTUAL TO REAL',    @DERPDGLX75510016
               I='8                 ON RETURN',                @DERPDGLX75520016
               O='F                 RF IS REAL OR 0 '          @DERPDGL 75530016
*                                                              @D51TDPM 75540016
*   BUILD THE TIC CCW.                                         @D51TDPM 75550016
*                                                              @D51TDPM 75560016
         STCM  RF,B'0111',DERTIC+1 SET THE TRANSFER ADDRESS.   @D51TDPM 75570016
         MVI   DERTIC,TIC         TIC CCW IS BUILT.            @D51TDPM 75580016
DERMKE4  SGDSK 'RETURN4        ','RETURN NORMAL            ',  @DERPDGLX75590016
               OUTPUT=(R8)                                     @DERPDGL 75600016
DERMKE0  DS     0H                                             @KD40391 75610016
         SGDSK 'RETURN         ','RETURN AND NO TIC FOUND'     @DERPDGL 75630016
         DROP  ,                                               @D66ADAP 75640016
         USING SYSS00,R0                                       @D66ADAP 75650016
         LTORG                                                 @DERPDGL 75660016
*                                                              @D51TDPM 75670016
***************************************************************         75680016
*  FUNCTION                                                    @D51TDPM 75690016
*     PERFORM HEADQUEUE I/O USING A GIVEN CCB.                 @D51TDPM 75700016
.*    THE STORAGE KEY FOR THE IO OPERATION IS INSERTED INTO    @DERPDGL 75710016
.*    THE FIRST BYTE OF THE CCB. THIS IS A SPECIAL INTERFACE   @DERPDGL 75720016
.*    WITH THE IO SUPERVISOR.                                  @DERPDGL 75730016
.*    SINCE THERE POSSIBLY IS AN INPUT CCW CHAINED IN FRONT    @DERPDGL 75740016
.*    OF THE USER CHAIN, THAT REQUESTS INPUT INTO KEY 0 AREAS, @DERPDGL 75750016
.*    THE SKIP BIT IS ALWAYS ON FOR THESE CCWS. IN THIS CASE   @DERPDGL 75760016
.*    THE OPERATION SHOULD CONTINUE NORMALLY (SEE ALSO ESA390  @DERPDGL 75770016
.*    PRINCIPLES OF OPS, SA22-7201 PAGE 15-32.)                @DERPDGL 75780016
*                                                              @D51TDPM 75790016
*  INPUT                                                       @D51TDPM 75800016
*    - R1 CONTAINS THE ADDRESS OF THE GIVEN CCB.               @D51TDPM 75810016
*    - R2 POINTER TO DEVICE ERROR ENTRY                        @D51TDPM 75820016
*    - R3 POINTER TO PUB OF DEVICE                             @D51TDPM 75830016
*    - RB CONTAINS THE ADDRESS OF THE USER CCB                 @D61SDJK 75840000
*                                                              @D51TDPM 75850016
*  OUTPUT                                                      @D51TDPM 75860016
*    - RF CONTAINS HEADQUEUE I/O REQUEST COMPLETION CODE.      @D51TDPM 75870016
*                                                              @D51TDPM 75880016
*      X'00' IF SUCCESSFUL COMPLETION OF I/O                   @D51TDPM 75890016
*      X'08' IF A UNIT CHECK OCCURED                           @D51TDPM 75900016
*      X'0C' IF A NON UNIT CHECK ERROR OCCURED                 @D51TDPM 75910016
*                                                              @D51TDPM 75920016
*    - RB MAY HAVE A ZERO INSTEAD OF A USER CCB IF THIS WAS    @D51TDPM 75930016
*         PAGED OUT                                            @D51TDPM 75940016
*                                                              @D51TDPM 75950016
***************************************************************         75960016
 AGO  .GIO                                                    *#SECURGL 75970016
.LIO     AIF ('&TEST'(1,14) NE 'CALL  DERIO   ').LTRACE       *#SECURGL 75980016
 AIF   ('&I'(2,8)  NE '1,2,3,B '               ).DSINVC       *#SECURGL 75990000
 AIF   ('&O'(2,4)  EQ 'B,F '                   ).DSHEAD       *#SECURGL 76000016
 AGO  .DSINVC                                                 *#SECURGL 76010016
.GIO      ANOP                                                *#SECURGL 76020016
.**************************************************************         76030016
DERIO    SGDSK 'HEADING        ','START OF CODEBLOCK'          @DERPDGL 76040016
         USING CCBADR,R1                                       @D51TDPM 76050016
         USING UCCBADR,RB                                      @D61SDJK 76060000
*                                                              @D51TDPM 76080016
         CLI   CCBCCW,X'00'       BRANCH IF THE CCB PATH MASK  @DERPDGL 76090016
         BNE   DERIO010             IS ALREADY INITIALIZED.    @DERPDGL 76100016
         BALR  R5,0               NO PATH THERE IS SYSTEM ERROR@DERPDGL 76110016
 SGDSK  'CALL  DERPTHSL        ','SELECT A PATH IN THE CCB',   @DERPDGLX76120016
               I='1,2,3,B           *',                        @D61SDJKX76130000
               O='NONE              *',                        @DERPDGLX76140016
               E0='&SYSERR          ERROR: NO PATH LEFT'       @DERPDGL 76150016
DERIO010 DS    0H                                              @DERPDGL 76170016
*                                                              @DERPDGL 76180016
*   SET UP THE STORAGE KEY FOR THE IO OPERATION                @DERPDGL 76190016
*                                                              @DERPDGL 76200016
         MVC   CCBCNT(1),DERIOKEY SET KEY FOR IO OPERATION     @DERPDGL 76210016
         MVI   CCBCNT+1,0         SET OTHER BYTE TO ZERO       @DERPDGL 76220016
*                                                              @DERPDGL 76230016
         SYSIO (1)                PERFORM HEADQUEUE IO         @DERPDGL 76240016
         SLR   RF,RF              PREPARE RETURN CODE          @DERPDGL 76250016
         TM    CCBCOM1,DISERR     BRANCH IF THE I/O WAS...     @D51TDPM 76260016
         BNO   DERIO050             SUCCESSFUL                 @D51TDPM 76270016
*                                                              @D51TDPM 76290016
         LA    RF,DERRAUC         SET UNIT CHECKED...          @D51TDPM 76300016
         TM    CCBSTA1,UNITCK     BRANCH IF THE I/O WAS ...    @D51TDPM 76310016
         BNZ   DERIO050             UNIT CHECKED.              @D51TDPM 76320016
*                                                              @D51TDPM 76340016
         LA    RF,DERRUS          SET UNSUCCESSFUL BUT NOT...  @D51TDPM 76350016
         OI    DERFLG1,DERCVNUC   INDICATE IN DERFLAG          @DERPDGL 76360016
         XC    DERSNS,DERSNS      CLEAR SENSE BYTES            @DERPDGL 76370016
*                                                              @D51TDPM 76380016
*   SINCE WE LOST CONTROL BY THIS I/O, SEE IF OUR CCB IS       @D51TDPM 76390016
*   STILL ACCESSIBLE. IT MIGHT HAVE BEEN PAGED OUT IN CASE OF  @D51TDPM 76400016
*   EXCP REAL REQUESTORS.                                      @D51TDPM 76410016
*                                                              @D51TDPM 76420016
DERIO050 DS    0H                                              @KD40391 76430016
         TM    DERFLG1,DERCVUCC   BRANCH IF USER CCB WAS A     @DERPDGL 76450016
         BO    DERIOEX            COPIED CCB                   @DERPDGL 76460016
 SGDSK  'CALL  DERUCCB         ','GET USER CCB PTR ',          @DERPDGLX76480016
               I='2                 ON RETURN',                @DERPDGLX76490016
               O='B                 RB=PTR TO USER CCB'        @DERPDGL 76500016
*                                                              @D51TDPM 76510016
*   THE SAME THING MAY BE TRUE FOR OUR FAILING CCW.            @D51TDPM 76520016
.*  THE FOLLOWING CODE IS NOT COMPLETE. IT SHOULD NOT REALLY   @DERPDGL 76530016
.*  FAKE A BAD RETURN CODE BUT RATHER INDICATE, THAT A RETRY   @DERPDGL 76540016
.*  OF THE ORIGINAL CHANNEL PROGRAM IS NOT POSSIBLE ANY MORE.  @DERPDGL 76550016
.*  IN FACT THE ENTIRE CHAIN OF THE USER WOULD HAVE TO BE      @DERPDGL 76560016
.*  CHECKED BEFORE DOING ANYTHING. IT COULD ALSO HAVE BEEN     @DERPDGL 76570016
.*  PAGED OUT SOMEWHERE IN THE MIDDLE OR AT THE END OF THE     @DERPDGL 76580016
.*  CHAIN. WE DO NOT TAKE THIS INTO CONSIDERATION HERE.        @DERPDGL 76590016
*                                                              @D51TDPM 76600016
         L     R8,DERFCCWV                                     @DERPDGL 76610016
         LR    R5,RF              PRESERVE RETURN CODE REGISTER@DERPDGL 76620016
 SGDSK  'CALL  DERCVTVR        ','CONVERT VIRTUAL TO REAL ',   @DERPDGLX76630016
               I='8                 ON RETURN',                @DERPDGLX76640016
               O='F                 RF =0 OR REAL ADDR'        @DERPDGL 76650016
         CL    RF,DERFCCWR        BRANCH IF IT STILL IS IN     @DERPDGL 76660016
         BE    DERIO060             STORAGE                    @DERPDGL 76670016
         XR    RF,RF                                           @DERPDGL 76690016
         ST    RF,DERFCCWR        PURGE REAL AND VIRTUAL       @DERPDGL 76700016
         ST    RF,DERFCCWV          CCW ADDRESS                @DERPDGL 76710016
         LA    R5,DERREXH         INDICATE SOME DESASTER..     @DERPDGL 76720016
DERIO060 LR    RF,R5                                           @DERPDGL 76730016
*                                                              @D51TDPM 76740016
DERIOEX  SGDSK 'RETURN         ','RETURN TO CALLER         ',  @DERPDGLX76750016
               OUTPUT=(RB,RF)                                  @DERPDGL 76760016
         DROP  ,                                               @D66ADAP 76770016
         USING SYSS00,R0                                       @D66ADAP 76780016
*                                                              @DERPDGL 76790016
         LTORG                                                 @DERPDGL 76800016
*                                                                       76810016
***************************************************************         76820016
*  FUNCTION                                                    @DERPDGL 76830016
*    WRITE TRACE ENTRIES INTO A TRACE AREA. THIS FUNCTION      @DERPDGL 76840016
*    SHALL PROVIDE THE NECESSARY INFORMATION FOR DEBUGGING     @DERPDGL 76850016
*                                                              @DERPDGL 76860016
*    A TRACE TABLE ENTRY HAS THE FOLLOWING PRINCIPLE FORMAT:   @DERPDGL 76870016
*    EACH ENTRY CONSISTS OF ONE OR MORE CHUNKS OF 32 BYTES.    @DERPDGL 76880016
*    THE FIRST TWO BYTES CONTAIN THE IO NUMBER, THE THIRD      @DERPDGL 76890016
*    BYTE CONTAINS THE NUMBER THAT IDENTIFIES THE TYPE OF      @DERPDGL 76900016
*    ENTRY. THERE IS DIFFERENT TYPES OF ENTRIES GENERATED      @DERPDGL 76910016
*    IN DIFFERENT POSITIONS OF THE PROGRAM. THE NORMAL SEQUENCE@DERPDGL 76920016
*    OF ENTRIES IS: FIRST A TYPE 2 ENTRY TO GIVE THE ENTRY     @DERPDGL 76930016
*    CONDITIONS FOR THE RECOVERY LOOP, THEN THE TYPE 3 ENTRY   @DERPDGL 76940016
*    WHICH IS WRITTEN RIGTH BEFORE WE DECIDE TO EITHER         @DERPDGL 76950016
*    LEAVE THE RECOVERY LOOP OR NOT. AND THE TYPE 4 ENTRY      @DERPDGL 76960016
*    WHICH IS WRITTEN IMMEDIATELY BEFORE EXITING TO DSKEXIT.   @DERPDGL 76970016
*                                                              @DERPDGL 76980016
*    NOW WITH A RECOVERY COMPRISING 255 RETRIES ON SEVERAL     @DERPDGL 76990016
*    PATHS THERE WOULD BE 255 TYPE 2 ENTRIES AND 255 TYPE 3    @DERPDGL 77000016
*    ENTRIES WHICH WOULD MAKE THE AREA WRAP AROUND IMMEDIATELY @DERPDGL 77010016
*    AND NOTHING COULD BE SEEN ANY MORE. MOREOVER MOST OF THE  @DERPDGL 77020016
*    ENTRIES WILL CONTAIN SIMILAR INFORMATION WHICH IS NO USE. @DERPDGL 77030016
*    HENCE SOME OF THE ENTRIES ARE NOT WRITTEN TO THE DEBUG    @DERPDGL 77040016
*    AREA. THE RULES OF THIS KIND OF COMPACTING ARE AS         @DERPDGL 77050016
*    FOLLOWS:                                                  @DERPDGL 77060016
*    A TYPE 3 ENTRY WILL ONLY BE WRITTEN IF THE FOOTPRINTING   @DERPDGL 77070016
*    MASK IN IT IS NOT ENTIRELY SIMILAR TO THE FOOTPRINTING    @DERPDGL 77080016
*    INFORMATION IN THE PREVIOUSLY WRITTEN TYPE 3 ENTRY.       @DERPDGL 77090016
*    A TYPE 2 ENTRY WILL ALWAYS BE WRITTEN, WHEN A TYPE 3      @DERPDGL 77100016
*    ENTRY HAS BEEN WRITTEN BEFORE.                            @DERPDGL 77110016
*    IT WILL OTHERWISE NOT BE WRITTEN, IF THE LAST TYPE 2      @DERPDGL 77120016
*    ENTRY WAS SIMILAR IN ALL RELEVANT FIELDS.                 @DERPDGL 77130016
*    IF IT WOULD HAVE BEEN SIMILAR, THE OLD ENTRY IS CHANGED   @DERPDGL 77140016
*    A LITTLE BIT, INSTEAD OF WRITING A NEW ENTRY. THE FIRST   @DERPDGL 77150016
*    BYTE OF THE FOUR BYTE CCB ADDRESS (WHICH IS ALWAYS ZERO   @DERPDGL 77160016
*    OTHERWISE, SINCE A CCB HAS TO BE BELOW THE 16 MB LINE)    @DERPDGL 77170016
*    IS INCREMENTED TO PROVIDE A COUNTER.                      @DERPDGL 77180016
*    THE CHPID IN THE ENTRY IS SUBSTITUTED AGAINST THE PATH    @DERPDGL 77190016
*    MASK FROM THE DERCCB TO REFLECT THE PATH THAT THE RETRIES @DERPDGL 77200016
*    ARE DONE ON. SUCH AN ENTRY IS THEN CALLED A TYPE 9        @DERPDGL 77210016
*    ENTRY.                                                    @DERPDGL 77220016
*                                                              @DERPDGL 77230016
*                                                              @DERPDGL 77240016
*  INPUT                                                       @DERPDGL 77250016
*    - A TRACE TYPE INDICATION AT RETURN+0                     @DERPDGL 77260016
*                                                              @DERPDGL 77270016
*  OUTPUT ON RETURN TO RETURN+4                                @DERPDGL 77280016
*    - NONE. A TRACE TABLE ENTRY IS WRITTEN.                   @DERPDGL 77290016
*                                                              @DERPDGL 77300016
***************************************************************         77310016
 AGO  .GTRACE                                                 *#SECURGL 77320016
.LTRACE  AIF ('&TEST'(1,14) NE 'CALL  DERTRACE').LMSG         *#SECURGL 77330016
 AIF   (T'&NR      NE 'O'                      ).DSHEAD       *#SECURGL 77340016
 AGO  .DSINVC                                                 *#SECURGL 77350016
.GTRACE   ANOP                                                *#SECURGL 77360016
.**************************************************************         77370016
DERTRACE SGDSK 'HEADING        ','START OF CODEBLOCK'          @DERPDGL 77380016
*                                                              @DERPDGL 77390016
         L     R6,=A(DERDBGMS)                                 @DERPDGL 77400016
         USING DERDBGMS,R6                                     @DERPDGL 77410016
         LH    R4,DERDBGAC        MAKE REGISTER POINTER TO     @DERPDGL 77420016
         LA    R4,DERDEBUG(R4)    ADD ORIGIN OF DEBUG AREA     @DERPDGL 77430016
         MVC   0(2,R4),DERDBGIO   SET I/O NR THAT IS PROCESSED @DERPDGL 77440016
         L     R5,4(,RE)          TAKE NR OF DEBUG ENTRY TYPE  @DERPDGL 77450016
         STC   R5,2(,R4)          WRITE IT TO DEBUG AREA       @DERPDGL 77460016
         SLL   R5,2               MAKE IT INDEX IN BRANCH TAB  @DERPDGL 77470016
         C     R5,=A(DERTRANR)    COMPARE IF VALID NUMBER      @DERPDGL 77480016
         BL    DERTRATB(R5)         BY THE NR BEHIND RETURN    @DERPDGL 77490016
         BAL   R5,&SYSERR                                      @DERPDGL 77500016
DERTRATB B     DERTR000           ROUTINE FOR ENTRY TYPE 0     @DERPDGL 77510016
         B     DERTR100              1                         @DERPDGL 77520016
         B     DERTR100              2                         @DERPDGL 77530016
         B     DERTR200              3                         @DERPDGL 77540016
         B     DERTR300              4                         @DERPDGL 77550016
         B     DERTR400              5                         @DERPDGL 77560016
         B     DERTR400              6                         @DERPDGL 77570016
         B     DERTR500              7                         @DERPDGL 77580016
         B     DERTR500              8                         @DERPDGL 77590016
DERTRANR EQU   (*-DERTRATB)                                    @DERPDGL 77600016
DERTR000 SLR   R5,R5            INCREMENT THE IO NR PROCESSED  @DERPDGL 77610016
         ICM   R5,3,DERDBGNR                                   @DERPDGL 77620016
         LA    R5,1(,R5)                                       @DERPDGL 77630016
         STH   R5,DERDBGNR                                     @DERPDGL 77640016
         STH   R5,DERDBGIO                                     @DERPDGL 77650016
         B     DERTRAEX                                        @DERPDGL 77660016
*                                                              @DERPDGL 77670016
* LAYOUT FOR TYPE 1 AND 2 (OR 9) (INPUT INFORMATION)           @DERPDGL 77680016
*                                                              @DERPDGL 77690016
DERTR100 DS    0H                                              @DERPDGL 77700016
         MVI   3(R4),X'00'           24 BYTE SENSE             @DERPDGL 77710016
         CLI   DERINWRK+ERRQLSNS-ERBLKADR,24                   @DERPDGL 77720016
         BE    DERTR110                                        @DERPDGL 77730016
         MVI   3(R4),X'03'           INVALID SENSE LENGTH      @DERPDGL 77740016
         CLI   DERINWRK+ERRQLSNS-ERBLKADR,32                   @DERPDGL 77750016
         BNE   DERTR110                                        @DERPDGL 77760016
         MVI   3(R4),X'02'           REAL 32 BYTE SENSE        @DERPDGL 77770016
         TM    DERINWRK+ERRQSNS-ERBLKADR+27,X'80'              @DERPDGL 77780016
         BNO   DERTR110                                        @DERPDGL 77790016
         MVI   3(R4),X'01'           24+8 BYTE SENSE           @DERPDGL 77800016
DERTR110 DS    0H                                              @DERPDGL 77810016
*                                                              @DERPDGL 77820016
.*  SUPPLY SENSE BYTES 0,1,2,7,22,23,24,25                     @DERPDGL 77830016
.*                                                             @DERPDGL 77840016
         MVC   4(3,R4),DERINWRK+ERRQSNS-ERBLKADR               @DERPDGL 77850016
         MVC   7(1,R4),DERINWRK+ERRQSNS-ERBLKADR+7             @DERPDGL 77860016
         MVC   8(2,R4),DERINWRK+ERRQSNS-ERBLKADR+22            @DERPDGL 77870016
         MVC   10(2,R4),DERINWRK+ERRQSNS-ERBLKADR+24           @DERPDGL 77880016
*                                                              @DERPDGL 77890016
.*  SUPPLY PUB ADDRESS, CHPID OF ERROR AND TASK ID IN CHANQ    @DERPDGL 77900016
.*                                                             @DERPDGL 77910016
         MVC   12(2,R4),DERINWRK+ERRQPUB-ERBLKADR              @DERPDGL 77920016
         MVC   14(1,R4),DERINWRK+ERRQPATH-ERBLKADR             @DERPDGL 77930016
         MVI   15(R4),0            CLEAR UNUSED BYTE           @DERPDGL 77940016
*                                                              @DERPDGL 77950016
.*  SUPPLY CCB ADDRESS, CSWCCW ADR., CURRENT DEBUG ENTRY,      @DERPDGL 77960016
.*                                                             @DERPDGL 77970016
         MVC   16(4,R4),DERINWRK+ERRQCCB-ERBLKADR              @DERPDGL 77980016
.*                                                             @DERPDGL 77990016
         MVC   20(8,R4),DERINWRK+ERRQCSW-ERBLKADR              @DERPDGL 78000016
         MVC   28(2,R4),DERTID     PROVIDE TASK-ID             @D66CDAP 78010016
         XC    30(2,R4),30(R4)     CLEAR UNUSED INFO           @D66CDAP 78020016
         B     DERTR888                                        @DERPDGL 78030016
*                                                              @DERPDGL 78040016
* LAYOUT FOR TYPE 3:  (FLOW INFORMATION)                       @DERPDGL 78050016
*                                                              @DERPDGL 78060016
DERTR200 DS    0H                                              @DERPDGL 78070016
         CLC   DERT,DERTOLD        DO NOT WRITE ENTRIES, THAT  @DERPDGL 78080016
         BE    DERTRAEX            ARE SIMILAR TO PREVIOUS ONES@DERPDGL 78090016
         MVC   3(1,R4),DERCRSC     ERROR CLASSIFICATION        @DERPDGL 78100016
         MVC   4(28,R4),DERT       BIT MAP FROM TRACING        @DERPDGL 78110016
         LH    R4,DERDBGAC         BUMP TO NEXT 32 BYTE ENTRY  @DERPDGL 78120016
         LA    R4,32(,R4)          IN THE                      @DERPDGL 78130016
         N     R4,DERDBGMS         DEBUG WRAP AROUND           @DERPDGL 78140016
         STH   R4,DERDBGAC         AREA                        @DERPDGL 78150016
         LA    R4,DERDEBUG(R4)                                 @DERPDGL 78160016
         MVC   0(32,R4),DERT+28    MOVE REST OF THE BIT MAP    @DERPDGL 78170016
         MVC   DERTOLD,DERT        KEEP IT FOR NEXT TIME       @DERPDGL 78180016
         OC    DERTACCU,DERT       ACCUMULATE IT               @DERPDGL 78190016
         XC    DERT,DERT           PURGE IT                    @DERPDGL 78200016
         MVC   28(4,R4),DERINWRK+ERRQSEK-ERBLKADR              @DERPDGL 78210016
         LH    R4,DERDBGAC         BUMP TO NEXT 32 BYTE ENTRY  @DERPDGL 78220016
         LA    R4,32(,R4)          IN THE                      @DERPDGL 78230016
         N     R4,DERDBGMS         DEBUG WRAP AROUND           @DERPDGL 78240016
         STH   R4,DERDBGAC         AREA                        @DERPDGL 78250016
         LA    R4,DERDEBUG(R4)                                 @DERPDGL 78260016
         MVC   0(5,R4),DERCRRA1                                @DERPDGL 78270016
         LH    R3,DERINWRK+ERRQPUB-ERBLKADR     GIVE SOME      @DERPDGL 78280016
         SH    R3,YPUBTAB                       INFOS ABOUT    @DERPDGL 78290016
         SRL   R3,1                             THE PUBX       @DERPDGL 78300016
         A     R3,APBXAREA                      AT THE TIME    @DERPDGL 78310016
         L     R3,0(,R3)                        THE RECOVERY   @DERPDGL 78320016
         MVC   5(1,R4),PBXPIM-PBXADR(R3)        LOOP RUN       @DERPDGL 78330016
         MVC   6(1,R4),PBXPAM-PBXADR(R3)        TOOK PLACE..   @DERPDGL 78340016
         MVC   7(1,R4),PBXLPM-PBXADR(R3)                       @DERPDGL 78350016
         MVC   8(1,R4),PBXNOOPR-PBXADR(R3)                     @DERPDGL 78360016
         MVC   9(1,R4),PBXNOPVF-PBXADR(R3)                     @DERPDGL 78370016
         MVC  10(1,R4),PBXNOERP-PBXADR(R3)                     @DERPDGL 78380016
         MVC  11(1,R4),PBXPVPEN-PBXADR(R3)                     @DERPDGL 78390016
         MVC  12(1,R4),DERCRRA4                                @DERPDGL 78400016
         XC    13(19,R4),13(R4)    PURGE REST                  @DERPDGL 78410016
         XC    DERTOLA2,DERTOLA2   INDICATE WE WANT TWO TYPE ENTRY   GL 78420016
         B     DERTR888                                        @DERPDGL 78430016
*                                                              @DERPDGL 78440016
* LAYOUT FOR TYPE 4:  (EXIT INFORMATION)                       @DERPDGL 78450016
*                                                              @DERPDGL 78460016
DERTR300 DS    0H                                              @DERPDGL 78470016
         MVC   3(1,R4),DEREXITC    EXIT CODE                   @DERPDGL 78480016
         MVC   4(1,R4),DERCRSC     ERROR CLASSIFICATION        @DERPDGL 78490016
         MVC   5(1,R4),DERRCVC     RECOVERY RESULT             @DERPDGL 78500016
         MVC   6(1,R4),DEROEFL1    FLAGS..                     @DERPDGL 78510016
         MVC   7(1,R4),DERCRPDN    PATHS TAKEN DOWN            @DERPDGL 78520016
         MVC   8(1,R4),DERCRFCO    OPCODE OF FAILING CCW IF ANY@DERPDGL 78530016
         MVC   9(7,R4),DERWKCSW+1  CSW SET INTO LOW CORE       @DERPDGL 78540016
         MVC  16(1,R4),DERINWRK+ERRQFLG-ERBLKADR  (RECONLY..)  @DERPDGL 78550016
         MVC  17(1,R4),DERINWRK+ERRQDFL-ERBLKADR               @DERPDGL 78560016
         MVC  20(4,R4),DERORGEB    ORIGINAL ERROR BLOCK ADDRESS@DERPDGL 78570016
         MVC  24(8,R4),DERT+50     SOME FURTHER FOOTPRINTS     @DERPDGL 78580016
         OC    DERTACCU,DERT       ACCUMULATE IT               @DERPDGL 78590016
         B     DERTR888                                        @DERPDGL 78600016
*                                                              @DERPDGL 78610016
* LAYOUT FOR TYPE 5 AND 6: (DATA CORRECTION INFORMATION)       @DERPDGL 78620016
*                                                              @DERPDGL 78630016
DERTR400 DS    0H                                              @DERPDGL 78640016
         MVC   3(9,R4),DERINWRK+ERRQSNS-ERBLKADR+15            @DERPDGL 78650016
         MVC   12(12,R4),R3*4(RD)  FETCH FROM STACK: R3,4,5    @DERPDGL 78660016
         ST    R8,24(,R4)                                      @DERPDGL 78670016
         ST    RF,28(,R4)                                      @DERPDGL 78680016
         B     DERTR888                                        @DERPDGL 78690016
*                                                              @DERPDGL 78700016
* LAYOUT FOR TYPE 7 AND 8: (DATA CORRECTION EXIT INFO)         @DERPDGL 78710016
*                                                              @DERPDGL 78720016
DERTR500 DS    0H                                              @DERPDGL 78730016
         MVC   4(7*4,R4),R3*4(RD)  FETCH REGS R3-R9            @DERPDGL 78740016
DERTR888 DS    0H                                              @DERPDGL 78750016
         LH    R4,DERDBGAC        ADVANCE TO THE NEXT ENTRY    @DERPDGL 78760016
         LA    R4,32(,R4)           IN THE DEBUG AREA.         @DERPDGL 78770016
         N     R4,DERDBGMS          BY BUMPING IN THE          @DERPDGL 78780016
         STH   R4,DERDBGAC          WRAP AROUND AREA.          @DERPDGL 78790016
DERTRAEX SGDSK 'RETURN4        ','RETURN TO CALLER         '   @DERPDGL 78800016
         DROP  ,                                               @D66ADAP 78810016
         USING SYSS00,R0                                       @D66ADAP 78820016
         LTORG                                                 @DERPDGL 78830016
*                                                                       78840016
***************************************************************         78850016
*  FUNCTION: WRITE A MESSAGE TO THE OPERATOR CONSOLE          *         78860016
*                                                             *         78870016
*  ON ENTRY: (RF,RE,R2 = STANDARD USE, SEE ABOVE)             *         78880016
*    R2 POINTS TO A DEVICE ERROR ENTRY                        *         78890016
*                                                             *         78900016
*  ON EXIT:                                                   *         78910016
*    A MESSAGE IS WRITTEN                                     *         78920016
*                                                             *         78930016
***************************************************************         78940016
 AGO  .GMSG                                                   *#SECURGL 78950016
.LMSG    AIF ('&TEST'(1,14) NE 'CALL  DERMSG  ').DSINVS       *#SECURGL 78960016
 AIF   ('&I'(2,2)  NE '2 '                     ).DSINVC       *#SECURGL 78970016
 AIF   ('&O'(2,4)  EQ 'NONE'                   ).DSHEAD       *#SECURGL 78980016
 AGO  .DSINVC                                                 *#SECURGL 78990016
.GMSG     ANOP                                                *#SECURGL 79000016
.**************************************************************         79010016
DERMSG   SGDSK 'HEADING        ','START OF CODEBLOCK'          @D61ADJK 79020016
*                                                              @D61ADJK 79030016
         USING ERBLKADR,R2                                     @D61ADJK 79040016
         LA    R5,DERMSGEO        INITIALIZE WORK REGISTERS    @D61ADJK 79050016
         LR    R6,R5                                           @D61ADJK 79060016
         LR    R7,R5                                           @D61ADJK 79070016
         LR    R8,R5                                           @D61ADJK 79080016
*                                                              @D61ADJK 79090016
*  INQUIRE ABOUT KIND OF MESSAGE                               @D61ADJK 79100016
*                                                              @D61ADJK 79110016
         TM    ERRQPRFL,ERRQBDPM  ISSUE SUBSYSTEM MESSAGE?     @D61ADJK 79120016
         BZ    DERMSGEX           NO                           @D61ADJK 79130016
*                                                              @D61ADJK 79140016
*  SET UP SUBSYSTEM MESSAGE                                    @D61ADJK 79150016
*                                                              @D61ADJK 79160016
         LA    R5,DERDPMSG        GET MESSAGE POINTER          @D61ADJK 79170016
         LH    R3,ERRQPUB         GET ADDRESS OF ERRONEOUS PUB @D61ADJK 79180016
         USING PUBADR,R3          PUB BASE POINTER             @D61ADJK 79190016
         LH    R9,PUBCHANN        GET CUU IN WORK REGISTER     @D61ADJK 79200016
         STH   R9,DERMSGFW        MAKE CUU PRINTABLE           @D61ADJK 79210016
         UNPK  DERDPCUU(4),DERMSGFW(3)                         @D61ADJK 79220016
         TR    DERDPCUU(3),DERMSGTR-X'F0'                      @D61ADJK 79230016
         MVI   DERDPCUU+3,C' '                                 @D61ADJK 79240016
*                                                              @D61ADJK 79250016
*  WRITE PREPARED MESSAGE                                      @D61ADJK 79260016
*                                                              @D61ADJK 79270016
         WTO   TEXT=(((R5),D),((R6),D),((R7),D),((R8),DE)),    @D61ADJKX79280016
               ROUTCDE=(2,11),DESC=(3)                         @D61ADJK 79290016
*                                                              @D61ADJK 79300016
DERMSGEX DS    0H                                              @D61ADJK 79310016
         SGDSK 'RETURN        ','RETURN'                       @D61ADJK 79320016
         DROP  ,                                               @D66ADAP 79330016
         USING SYSS00,R0                                       @D66ADAP 79340016
*                                                              @D61ADJK 79350016
*   LIST OF MESSAGES                                           @D61ADJK 79360016
*                                                              @D61ADJK 79370016
DERDPMSG DC    AL2(58)                                         @D61ADJK 79380016
         DC    C'1H20I PRIMARY DEVICE '                        @D61ADJK 79390016
DERDPCUU DC    C'    '                                         @D61ADJK 79400016
         DC    C'WAS SET TO SUSPENDED DUPLEX STATE'            @D61ADJK 79410016
*                                                              @D61ADJK 79420016
         DS    XL128                                           @D61ADJK 79430016
DERMSGFW DC    D'0'                                            @D61ADJK 79440016
DERMSGTR DC    C'0123456789ABCDEF'                             @D61ADJK 79450016
DERMSGEO DC    AL2(0)                                          @D61ADJK 79460016
*                                                              @D61ADJK 79470016
         LTORG                                                 @D61ADJK 79480016
***************************************************************         79490016
*  FUNCTION: PROVIDE AN ENTRY FOR ERP TASK TO CALL            *         79500016
*    THE MESSAGE WRITER DERMSG IN A PROPER WAY.               *         79510016
*  ON ENTRY:                                                  *         79520016
*    R2 POINTS TO A DEVICE ERROR ENTRY                        *         79530016
*  ON EXIT:                                                   *         79540016
*    MESSAGE IS WRITTEN.                                      *         79550016
***************************************************************         79560016
DERERPMS DS    0H                 START OF CODEBLOCK           @DERPDGL 79570016
         USING DERERPMS,RC                                     @DERPDGL 79580016
         LA    RD,DERERPST                                     @DERPDGL 79590016
         STM   R0,RF,0(RD)                                     @DERPDGL 79600016
 SGDSK  'CALL  DERMSG          ','GO WRITE MESSAGE ',          @D61ADJKX79610016
               I='2                 R2=PTR TO ERROR ENTRY',    @D61ADJKX79620016
               O='NONE              ON RETURN MSG IS DONE'     @D61ADJK 79630016
         LM    R0,RF,0(RD)                                     @DERPDGL 79640016
         BR    RE                                              @DERPDGL 79650016
         DROP  ,                                               @D66ADAP 79660016
         USING SYSS00,R0                                       @D66ADAP 79670016
DERERPST DC   (6*16)F'0'          CALL STACK FOR ERP.          @D51TDPM 79680016
         DC   X'FF'                                            @DERPDGL 79690016
         LTORG                                                 @DERPDGL 79700016
         EJECT ,                                                        79710016
*                                                                       79720016
*-------------------------------------------------------------*@D52WSBH 79730016
*   GLOBAL VARIABLES / MISCELLANEOUS DATA AREAS               *@D52WSBH 79740016
*-------------------------------------------------------------*@D52WSBH 79750016
         DS   0D                                               @D66CDAP 79760016
         DC   CL8'DERGLOB:'                                    @DERPDGL 79770016
DERGLOB  EQU  *                                                @D52WSBH 79780016
*-------------------------------------------------------------*@D52WSBH 79790016
DERCLN00 DS    0X       BEGIN OF 1ST AREA TO CLEAN ON ENTRY    @DERPDGL 79800016
*-------------------------------------------------------------*@D52WSBH 79810016
DERLSTER DS    XL7      THE LAST ERROR WE ENCOUNTERED. THE     @DERPDGL 79820016
*                          VALUE TAKEN FOR COMPARISON IS       @D51TDPM 79830016
*        FOR NON ECKD SNS: DERCRSC/SENSE BYTE 7 FOR            @DERPDGL 79840016
*        FOR ECKD SENSE  : SENSE BYTES 22/23                   @DERPDGL 79850016
DERLSTPU DS    X        USED TO REMEMBER THE PATHS, THAT WE DID@DERPDGL 79860016
*                          RECORDING ON ALREADY.               @DERPDGL 79870016
DERORGPT DS    X        THE PATH MASK, THAT THE ORIGINAL ERROR @DERPDGL 79880016
*                          CAME IN ON.                         @D61SDJK 79890000
DERCRPTU DS    X        MASK OF THOSE PATHS, THAT WERE TRIED IN@DERPDGL 79900016
*                          A DSK RECOVERY ACTION, BUT WERE     @DERPDGL 79910016
*                          NOT USED SUCCESSFULLY.              @DERPDGL 79920016
DERCRPDN DS    X        MASK OF THOSE PATHS, THAT WERE SET     @DERPDGL 79930016
*                          DOWN BY DSK IN DERPDOWN             @DERPDGL 79940016
*-------------------------------------------------------------*@DERPDGL 79950016
*                                                              @DERPDGL 79960016
DERFLG1  DS   X         MISCELLANEOUS BIT FLAGS; SEE BELOW     @DERPDGL 79970016
*        EQU  B'10000000'  RESERVED                            @DERPDGL 79980016
*        EQU  B'01000000'  RESERVED                            @DERPDGL 79990016
DERCVUCC EQU  B'00100000'  THE USER CCB IS A COPIED CCB        @DERPDGL 80000016
DERCVUCH EQU  B'00010000'  THE USER CCB HAD THE CHNBIT ON      @DERPDGL 80010016
DERCVCSW EQU  B'00001000'  IF SET DO NOT PROVIDE ERRQCSW AS CSW@DERPDGL 80020016
DERCVNUC EQU  B'00000100'  WE HAD A NON UNIT CHECK IO FAILURE  @DERPDGL 80030016
*        EQU  B'00000010'  RESERVED                            @DERPDGL 80040016
DERCVDSK EQU  B'00000001'  RECOVERY ENDED BY PREPARATIONAL IO  @DERPDGL 80050016
*                          ERROR, NOT BY RETRY OF USER REQUEST @DERPDGL 80060016
*-------------------------------------------------------------*@DERPDGL 80070016
*                                                              @D51TDPM 80080016
DERRCVC  DS   X         DSK RECOVERY COMPLETION CODE.          @D51TDPM 80090016
DERRVSAC EQU  X'00'     RECOVERY IS COMPLETE AND SUCCESSFUL    @D51TDPM 80100016
DERRVUAC EQU  X'01'     RECOVERY IS COMPLETE BUT NOT SUCCESSF. @D51TDPM 80110016
DERRVIRQ EQU  X'03'     RECOVERY FOR THE ORIGINAL ERROR        @D51TDPM 80120016
*                       CONDITION REQUIRED THAT THE DEVICE BE  @D51TDPM 80130016
*                       PUT IN THE INTERVENTION REQUIRED STATE.@D51TDPM 80140016
*                       SINCE THE I/O MUST BE REISSUED, DSK    @D51TDPM 80150016
*                       RECOVERY IS COMPLETE.                  @D51TDPM 80160016
DERRVCOM EQU  X'7F'     WHEN THE CODE IN DERRC IS GREATER THAN @D51TDPM 80170016
*                       THIS VALUE THEN RECOVERY IS NOT        @D51TDPM 80180016
*                       COMPLETE.                              @D51TDPM 80190016
DERRVUNC EQU  X'FF'     THE LAST ERROR CONDITION ENCOUNTERED   @D51TDPM 80200016
*                       WAS NOT SUCCESSFULLY RECOVERED AND     @D51TDPM 80210016
*                       FURTHER RECOVERY IS POSSIBLE.          @D51TDPM 80220016
*-------------------------------------------------------------*@D52WSBH 80230016
*                                                              @D51TDPM 80240016
DEREXITC DS   X         INDICATES WHAT TO DO ON RETURN TO      @D52WSBH 80250016
*                       SUPERVISOR. NOT USED IF SYNCHRONOUS    @D52WSBH 80260016
*                       MESSAGE IS REQUIRED.                   @D52WSBH 80270016
DEREXED  EQU  X'01'     GIVE STATE CH./EMER.DESTAGE RCODE      @D51TDPM 80280016
DEREXEM  EQU  X'02'     GIVE EMERGENCY MESSAGE RCODE           @D51TDPM 80290016
DEREXRTY EQU  X'03'     GIVE RETRY RETURN CODE (REISSUE REQ.)  @D52WSBH 80300016
DEREXIGN EQU  X'04'     GIVE IGNORE RCODE TO DSKEXIT           @D51TDPM 80310016
DEREXCAN EQU  X'05'     GIVE CANCEL RCODE TO DSKEXIT           @D51TDPM 80320016
DEREXDSP EQU  X'06'     GIVE DISPATCHER EXIT TO DSKEXIT        @D51TDPM 80330016
*                                                              @D51TDPM 80340016
*-------------------------------------------------------------*@D52WSBH 80350016
*                                                              @D51TDPM 80360016
DERCHQGV DS   X    BOOLEAN INDICATORS DERIVED FROM THE CHANQ.  @D51TDPM 80370016
DERCHQFP EQU  B'10000000'    FIL.PROT.PREFIXING REQUIRED       @D51TDPM 80380016
*                                                                       80390016
*-------------------------------------------------------------*@D52WSBH 80400016
*                                                                       80410016
DEROEFL1 DS   X    FLAGS THAT CHARACTERIZE THE ORIG.ERROR COND.@D51TDPM 80420016
DEROEUCU EQU  B'10000000'    USER CCB IS NOT ADDRESSABLE       @D51TDPM 80430016
DEROEUIC EQU  B'01000000'    UNSOLICITED INTERRUPT ERROR       @D51TDPM 80440016
DEROESIV EQU  B'00100000'    SENSE DATA INVALID                @D51TDPM 80450016
DEROEMEL EQU  B'00010000'    THE I/O REQUEST ASSOCIATED WITH   @D51TDPM 80460016
*                            THE ORIGINAL ERROR CONDITION WAS  @D51TDPM 80470016
*                            MADE AT THE MINIMAL ERP LAYER.    @D51TDPM 80480016
DEROERTY EQU  B'00001000'    A RETRYABLE ERROR CONDITION       @D51TDPM 80490016
*                            OCCURRED DURING THE RECOVERY FOR  @D51TDPM 80500016
*                            THE ORIGINAL ERROR CONDITION.     @D51TDPM 80510016
DEROERCV EQU  B'00000010'    A RECOVERY ERROR OCCURRED DURING  @D51TDPM 80520016
*                            THE ATTEMPTED RECOVERY OF THE     @D51TDPM 80530016
*                            ORIGINAL ERROR CONDITION.         @D51TDPM 80540016
*        EQU  B'00000001'    RESERVED                          @DERPDGL 80550016
DEROEIRE EQU  DEROERCV+DEROESIV  RECOV.ERROR MSG AS FINAL MSG  @D51TDPM 80560016
DEROERNP EQU  DEROEMEL+DEROEUCU+DEROERCV  RECOVERY NOT POSSIB. @D51TDPM 80570016
DEROEMAR EQU  DEROEMEL+DEROEUCU  MESSAGING AND REC ONLY REQUEST@D52WSBH 80580016
*-------------------------------------------------------------*@D52WSBH 80590016
*                                                                       80600016
DERIOKEY DS   X    THE STORAGE KEY THAT WAS USED IN THE IO     @DERPDGL 80610016
*                     OPERATION DONE BY THIS TASK. WILL BE USED@DERPDGL 80620016
*                     FOR ALL RETRIES. SPECIFIED IN CCBCNT     @DERPDGL 80630016
         DS   X    RESERVED                                    @D66CDAP 80640016
DERTID   DS   XL2  THE TID OF THE TASK THAT REQUESTED THE I/O  @D66CDAP 80650016
*                     WHICH ENCOUNTERED THE ORIGINAL ERROR     @D66CDAP 80660016
*                     CONDITION.                               @D66CDAP 80670016
DERTYCNT DS   F    THE NUMBER OF CONSECUTIVE RETRIES           @D52WSPM 80680016
*                     DONE ON THE PATH TO WHICH RETRIES ARE    @D52WSPM 80690016
*                     CURRENTLY BEING DIRECTED.  TWO RETRIES   @D52WSPM 80700016
*                     ARE CONSECUTIVE WHEN A PATH IS NOT       @D52WSPM 80710016
*                     SWITCHED OR A DUPLEX PAIR IS NOT         @D52WSPM 80720016
*                     SUSPENDED BETWEEN THE RETRIES. THE       @D52WSPM 80730016
*                     PATH TO WHICH I/O FOR A RETRY IS         @D52WSPM 80740016
*                     DIRECTED IS DEFINED BY DERPTHSL.         @D52WSPM 80750016
*-------------------------------------------------------------*@D51TDPM 80760016
DERLSEEK DS    0XL4       AREA FOR CALCULATING THE LAST USED   @D51TDPM 80770016
*                         SEEK ADDRESS, CONSISTING OF          @D51TDPM 80780016
DERSKCYL DS    XL2          CYLINDER ADDRESS OF THE SEEK       @D51TDPM 80790016
DERSKHD  DS    XL2          TRACK ADDRESS OF THE SEEK          @D51TDPM 80800016
*                                                              @D51TDPM 80810016
*-------------------------------------------------------------*@D51TDPM 80820016
*   THE WORK DEVICE ERROR ENTRY WE WORK WITH,                  @D51TDPM 80830016
*   THE BIT SETTINGS FOR RECOVERY AND RECORDING,               @D51TDPM 80840016
*   THE INDICATORS FOR CCB BIT SETTINGS AND A WORK CSW FOR LOWC@D51TDPM 80850016
*-------------------------------------------------------------*@D51TDPM 80860016
DERINWRK DS   XL(ERBLKHDL+L'ERRQ) CURRENT ERROR BLOCK. IS USED @D51TDPM 80870016
*                                 WITH EVERY RUN THRU LOOP     @D51TDPM 80880016
*                                 BETWEEN DER10000 AND DER9000 @D51TDPM 80890016
*                                                              @DERPDGL 80900016
DERCRSF  DS    X        TYPE OF SENSE DATA INDICATION          @D51TDPM 80910016
DERCRSFS EQU   X'00'        SENSE IS IN SIM FORMAT SENSE.      @D51TDPM 80920016
DERCRSFE EQU   X'01'        SENSE IS IN ECKD FORMAT SENSE.     @D51TDPM 80930016
DERCRSFB EQU   X'02'        SENSE IS IN BASIC FORMAT SENSE.    @D51TDPM 80940016
DERCRSFC EQU   X'04'        SENSE IS IN 24+8 FORMAT            @D51TDPM 80950016
*                           (ALWAYS SET TOGETHER WITH DERCRSFB)@DERPDGL 80960016
*                                                              @DERPDGL 80970016
DERCRSC  DS    X        THIS IS THE MAIN ERROR CLASSIFICATION  @D51TDPM 80980016
*                       CODE (NAMED DEREC...) .                @D51TDPM 80990016
*                                                              @DERPDGL 81000016
DERCRFCO DS    X        COMMAND CODE OF FAILING CCW            @D51TDPM 81010016
*                                                              @DERPDGL 81020016
DERCRMXT DS    X        THE MAXIMUM TRACK/HEAD ADDRESS FOR ANY @D51TDPM 81030016
*                       GIVEN CYLINDER OF THE DEVICE ON WHICH  @D51TDPM 81040016
*                       THE CLASSIFIED ERROR OCCURRED.         @D51TDPM 81050016
DERCRECC DS    X        THE NUMBER OF ERROR CORRECTING CODE    @D51TDPM 81060016
*                       BYTES FOR THE DEVICE ON WHICH THE      @D51TDPM 81070016
*                       CLASSFIED ERROR OCCURRED.              @D51TDPM 81080016
DERCRCLH DS    X        MASK FOR CLEARING UNUSED BITS OF THE   @D51TDPM 81090016
*                       LOW ORDER BYTE OF THE HEAD FIELD OF    @D51TDPM 81100016
*                       THE FAILING SEEK ADDRESS.              @D51TDPM 81110016
DERCRCLC DS    X        MASK FOR CLEARING UNUSED BITS OF THE   @D51TDPM 81120016
*                       HIGH ORDER BYTE OF THE CYLINDER FIELD  @D51TDPM 81130016
*                       OF THE FAILING SEEK ADDRESS.           @D51TDPM 81140016
DERCRSHF DS    X        THE NUMBER OF BITS TO SHIFT RIGHT SENSE@D51TDPM 81150016
*                       BYTE 6 TO ELIMINATE UNWANTED BITS IN   @D51TDPM 81160016
*                       THE HIGH ORDER BYTE OF THE CYLINDER    @D51TDPM 81170016
*                       FIELD OF THE FAILING SEEK ADDRESS.     @D51TDPM 81180016
*                                                              @DERPDGL 81190016
DERCRRA1 DS    X        BOOLEAN INDICATORS FOR ACTIONS         @DERPDGL 81200016
*                       REQUIRED DURING RECOVERY OF THE        @DERPDGL 81210016
*                       ERROR CLASSIFIED IN THE ECCR.          @DERPDGL 81220016
*                                                              @DERPDGL 81230016
DERCRRL  DS    X                  RETRY LIMIT                  @DERPDGL 81240016
DERCRRAS DS    X                  SUBROUTINE INDEX             @DERPDGL 81250016
DERCRRA2 DS    X                  ERROR ATTRIBUTES             @DERPDGL 81260016
DERCRRA3 DS    X                  PASSBACK INFORMATION         @DERPDGL 81270016
DERCRRA4 DS    X                  MESSAGING/RECORDING CONTROL  @DERPDGL 81280016
DERCCCWV DS    A                  VIRTUAL CCW ADDRESS          @D51TDPM 81290016
DERFCCWR DS    A                  REAL CCW ADDRESS             @D51TDPM 81300016
DERFCCWV DS    A                  VIRTUAL ADDRESS OF FAIL. CCW @D51TDPM 81310016
*                                                                       81320016
DERWKCSW DS    D                  CSW TO BE RETURNED TO IOINTER@D51TDPM 81330016
DERCLNL0 EQU   *-DERCLN00  LENGTH OF 1ST AREA TO CLEAN ON ENTRY@DERPDGL 81340016
*                                                              @D51TDPM 81350016
*-------------------------------------------------------------*@D51TDPM 81360016
DERCLN01 DS    0X          BEGIN OF SECOND AREA TO CLEAN       @DERPDGL 81370016
DERSCABU DS    12A          DERSCAN KEEPS LAST 12 CCW ADDR.    @D51TDPM 81380016
*                           IT FOLLOWED IN THIS FIELD          @D51TDPM 81390016
DERLSTCW DS    A            ADDRESS OF THE LAST CCW DATA       @D51TDPM 81400016
*                           CHAINED TO FAILING COMMAND CCW.    @D51TDPM 81410016
DERNXTCW DS    A            ADDRESS OF THE NEXT CCW AFTER THE..@D51TDPM 81420016
*                           LAST DATA CHAINED CCW.             @D51TDPM 81430016
DERORGEB DS    A            ADDRESS OF THE ERROR BLOCK THAT WE @D51TDPM 81440016
*                           CHAINED FROM THE DSK CHAIN.        @DERPDGL 81450016
DERQUDEB DS    A            ADDRESS OF CHAIN OF QUEUED ERROR   @D51TDPM 81460016
*                           BLOCKS FOR MSG AND RECORDING       @DERPDGL 81470016
DERSM    DS    X            VALUE OF SYSTEM MASK BEFORE IT WAS @D51CDBH 81480016
*                           CHANGED FOR DAT OFF IN DERECF      @D51CDBH 81490016
.*                                                             @DERPDGL 81500016
DERDBGIO DS    H            CHANGED FOR DAT OFF IN DERECF      @DERPDGL 81510016
DERT     DS    XL60         TRACE BITMAP FOR EARMARKING        @DERPDGL 81520016
.*                            THE BITS IN IT ARE SET BY        @DERPDGL 81530016
.*                            THE SGDSK SGCOV INVOCATIONS      @DERPDGL 81540016
.*                            THE NR= GIVES BYTE,BIT           @DERPDGL 81550016
DERTOLD  DS    XL60         KEPT EARMARKING FROM LAST RUN      @DERPDGL 81560016
.*                            IN ORDER TO NOT OVERWRITE THE    @DERPDGL 81570016
.*                            DEBUG AREA WITH ONLY EQUAL       @DERPDGL 81580016
.*                            ENTRIES, WITH IONUMBER AND ENTRY @DERPDGL 81590016
DERTOLA2 DS    A            KEPT ADD. OF LST 2 TYPE ENTRY.     @DERPDGL 81600016
*-------------------------------------------------------------*@D51TDPM 81610016
DERCLNL1 EQU   *-DERCLN01  LENGTH OF 2ND AREA TO CLEAN ON ENTRY@DERPDGL 81620016
*-------------------------------------------------------------*@D51TDPM 81630016
DERTACCU DS    XL60         KEPT EARMARKING FROM ALL RUNS.     @D51CDBH 81640016
.*                            THIS IS TO LEAVE A PERMANENT     @DERPDGL 81650016
.*                            FOOTPRINTING FROM IPL ONWARDS    @DERPDGL 81660016
*                                                              @D51TDPM 81670016
*-------------------------------------------------------------*@DA42922 81680016
*   PATCH AREA, ALWAYS ADDRESSABLE BY BASE REG OF DERGLOB      @DA42922 81690016
*-------------------------------------------------------------*@DA42922 81700016
         USING DERGLOB,RA        ESTABLISH USING FOR PATCHAREA @DA42922 81710016
DERTLVL2 DC    50S(*)            FOR LEVEL 2 TRAPS & CHANGES   @DA42922 81720016
         DROP  RA                DROP USING AGAIN.             @DA42922 81730016
*-------------------------------------------------------------*@D51TDPM 81740016
*   DSK CCBS                                                   @D51TDPM 81750016
*-------------------------------------------------------------*@D51TDPM 81760016
*                                                              @D51TDPM 81770016
DERCCB   CCB  SYSRES,*,X'1501',DERSNS GENERATE DSK CCB.        @D37ADDK 81780016
         ORG   DERCCB+6           ORG FOR FLAG SETTING         @D37ADDK 81790016
         DC    AL1(XCPR+CCBPHYAD) EXCP REAL + PHYS ADDR        @D37ADDK 81800016
         ORG   DERCCB+12          ORG FOR FLAG SETTING         @D37ADDK 81810016
         DC    AL1(ERRTIN+USENSE) USE BY ERP AND SENSE DESIRED @D37ADDK 81820016
         ORG   ,                  RESET ORG                    @D37ADDK 81830016
DERSNS   DS    XL32               SENSE DATA RETURNED TO DSK.  @D51TDPM 81840016
*                                                                       81850016
DERSVCCB DS    XL(16)        SAVE AREA FOR THE CCB IF SOME     @D66ADAP 81860016
*                            REQUEST MUST BE EXECUTED FIRST    @D51TDPM 81870016
*-------------------------------------------------------------*         81880016
*        DSK CCWS.                                                      81890016
*-------------------------------------------------------------*         81900016
DERSOCA  DC   A(*)      START OF THE DSK CCW AREA.                      81910016
*                                                                       81920016
*-------------------------------------------------------------*@D52WSPM 81930016
DERSUWK1 DS   XL1            WORK AREA TO BUILD UNIT ADDRESS   @D52WSPM 81940016
*                            OF THE OTHER DEVICE OF A DUPLEX   @D52WSPM 81950016
*                            PAIR.                             @D52WSPM 81960016
DERSUWK2 DS   XL1            WORK AREA TO BUILD UNIT ADDRESS   @D52WSPM 81970016
*                            OF THE OTHER DEVICE OF A DUPLEX   @D52WSPM 81980016
*                            PAIR.                             @D52WSPM 81990016
*                                                                       82000016
*                                                                       82010016
DERCCWSS CCW   DERSSSC,DERSNSS,SLI,DERSNSL   SNSS STATUS CCW   @D61ADJK 82020016
DERSNSS  DS    0X                                              @D61ADJK 82030016
DERSFORM DS    XL1           FORMAT OF SENSE SUBSYSTEM STATUS  @D61ADJK 82040016
DERSBODM EQU   B'00000001'   IT IS A 3990-6/7                  @D61ADJK 82050016
DERSDUA  DS    XL1           DEVICE UNIT ADDRESS.              @D52WSPM 82060016
DERSODPF EQU   B'11000000'   THESE BITS FORM THE UNIT ADDRESS  @D52WSPM 82070016
*                            OF THE OTHER DEVICE IN A DUPLEX   @D52WSPM 82080016
*                            PAIR WHEN PREFIXED TO BITS 2-7 OF @D52WSPM 82090016
*                            DEVICE STATUS BYTE 2.             @D52WSPM 82100016
         DS    XL24          UNDEFINED.                        @D52WSPM 82110016
DERSDSB1 DS    XL1           DEVICE STATUS BYTE 1.             @D52WSPM 82120016
DERSPDDP EQU   B'00001000'   THE DEVICE RECEIVED THE SENSE     @D52WSPM 82130016
*                            SUBSYSTEM STATUS COMMAND WHEN IT  @D52WSPM 82140016
*                            WAS THE PRIMARY DEVICE OF A DUPLEX@D52WSPM 82150016
*                            PAIR.                             @D52WSPM 82160016
DERSDPS  EQU   B'00000011'   THE DEVICE RECEIVED THE SENSE     @D61ADJK 82170016
*                            SUSBSYSTEM STATUS COMMAND WHEN IT @D61ADJK 82180016
*                            WAS IN THE SUSPENDED DUPLEX STATE @D61ADJK 82190016
*                            OR THE DUPLEX PAIR IS PENDING.    @D61ADJK 82200016
DERSDSB2 DS    XL1           SECONDARY DUPLEX PAIR UNIT ADDR.  @D61ADJK 82210016
DERSODSF EQU   B'00111111'   THESE BITS FORM THE UNIT ADDRESS  @D52WSPM 82220016
*                            OF THE OTHER DEVICE IN A DUPLEX   @D52WSPM 82230016
*                            PAIR WHEN SUFIXED TO THE FIRST    @D52WSPM 82240016
*                            TWO BITS OF THE DEVICE UNIT       @D52WSPM 82250016
*                            ADDRESS.                          @D52WSPM 82260016
         DS    XL16          UNDEFINED.                        @D61ADJK 82270016
DERSNSL  EQU   *-DERSNSS     LENGTH OF SUBSYSTEM STATUS DATA   @D61ADJK 82280016
*                                                                       82290016
DERSSSC  EQU   X'54'    THE COMMAND CODE FOR THE SENSE         @D52WSPM 82300016
*                       SUBSYSTEM STATUS COMMAND.              @D52WSPM 82310016
*-------------------------------------------------------------*@D52WSPM 82320016
DERPSFSD CCW   DERPSFC,DERSDPP,SLI,L'DERSDPP PSF CCW.          @D52WSPM 82330016
DERSDPP  DS    0XL4                                            @D52WSPM 82340016
         DC    AL1(DERSDPO)       PSF ORDER.                   @D52WSPM 82350016
         DC    AL1(DERSDPPF)      PSF FLAGS.                   @D61ADJK 82360016
DERSDPPU DS    XL1           PRIMARY DEVICE UNIT ADDRESS.      @D52WSPM 82370016
DERSDPSU DS    XL1           SECONDARY DEVICE UNIT ADDRESS.    @D52WSPM 82380016
DERPSFC  EQU   X'27'    THE COMMAND CODE FOR THE PERFORM       @D52WSPM 82390016
*                       SUBSYSTEM FUNCTION COMMAND.            @D52WSPM 82400016
DERSDPO  EQU   X'14'         SUSPEND DUPLEX PAIR ORDER.        @D52WSPM 82410016
DERSDPPF EQU   B'00000001'   PRIMARY VOLUME IS FAILING VOLUME. @D52WSPM 82420016
*-------------------------------------------------------------*@D52WSPM 82430016
DERDIACC CCW   SFM,DERDIASF,CC,1  SET FILE MASK FOR DIAGNOSTIC @D52WSPM 82440016
         CCW   DCTL,DERDIAAR,0,4  DIAGNOSTIC CONTROL CCW       @D52WSPM 82450016
DERDIAAR DC    X'02'    COMMAND FOR INHIBIT WRITE              @D52WSPM 82460016
DERDIASC DC    X'00'    SUBCOMMAND (FILLED IN BY PROGRAM)      @D52WSPM 82470016
         DC    XL2'00'  RESERVED BYTES                         @DERPDGL 82480016
DERDIASF DC    B'00000100'  DIAGNOSTIC AUTHORIZATION           @DERPDGL 82490016
*-------------------------------------------------------------*@D52WSPM 82500016
DERCCWRC CCW   RECAL,DERHOMAD,SLI,1 RECALIBRATE CCW            @D35DDDK 82510016
*-------------------------------------------------------------*         82520016
         AGO   .NOSUP08                                        @DERPDGL 82530016
DERCCWRH CCW   SEEK,DERSEEK,CC,6  SEEK                                  82540016
         CCW   RDHOM,DERHOMAD,CC+SLI,5 CCW TO READ HA                   82550016
         CCW   READR0,DERCCHH,SLI,4 CCW TO READ R0             @D35DDDK 82560016
.NOSUP08 ANOP                                                  @DERPDGL 82570016
*-------------------------------------------------------------*         82580016
DERCCW00 CCW   0,0,0,0            COPY AREA FOR FIRST USER CCW @D37ADDK 82590016
DERCCWF0 CCW   0,0,0,0            SFM                          @D14ZDDK 82600016
DERCCWT0 CCW   0,0,0,0            TIC TO USER                  @D14ZDDK 82610016
*-------------------------------------------------------------*         82620016
DERCCWS1 CCW   SEEK,DERSEEK,CC,6  SEEK                         @D34SDDK 82630016
DERCCWF1 CCW   0,0,0,0            SFM OR NOP                   @DA24935 82640016
         CCW   SEARCHA,DERCCHH,CC+SLI,4 SEARCH                 @D34SDDK 82650016
         CCW   TIC,*-8,0,0        TIC                          @D34SDDK 82660016
         CCW   RDHOM,DERHOMAD,CC+SKIP,5 READ HA AND SKIP       @D35DDDK 82670016
DERCCWR1 DC    XL16'00'           REST OF CCW CHAIN            @D14ZDDK 82680016
*-------------------------------------------------------------*         82690016
DERCCWS2 CCW   SEEK,DERSEEK,CC,6  SEEK CCW                     @D37ADDK 82700016
DERCCWF2 CCW   0,0,0,0            SFM OR NOP                   @DA24935 82710016
         CCW   SEARCH,DERCCHH,CC,5 SEARCH CCW                  @D37ADDK 82720016
         CCW   TIC,*-8,0,0        TIC BACK                     @D37ADDK 82730016
DERCCWR2 DC    XL16'00'           REST OF CCW CHAIN            @D14ZDDK 82740016
*-------------------------------------------------------------*         82750016
DERCCWS3 CCW   SEEK,DERSEEK,CC,6  SEEK                         @DA22771 82760016
DERCCWF3 CCW   0,0,0,0            SFM OR NOP                   @DA25514 82770016
         CCW   RDHOM,DERHOMAD,SKIP+SLI+CC,5 READ HA            @D14ZDDK 82780016
         CCW   SEARCH,DERSARG,CC,5 SEARCH ID EQUAL             @DA22771 82790016
         CCW   TIC,*-8,0,0        TIC BACK                              82800016
DERCCWR3 DC    XL16'00'           REST OF CCW CHAIN            @DA25502 82810016
*-------------------------------------------------------------*         82820016
DERCCWX4 CCW   0,0,0,0            DEFINE EXTENT CCW            @D14ZDDK 82830016
         CCW   FBALOC,DERLPS,CC,8 LOCATE CCW                   @D37ADDK 82840016
DERCCWR4 DC    XL16'00'           REST OF CCW CHAIN            @D14ZDDK 82850016
DERLPS   DS    XL8                                                      82860016
*-------------------------------------------------------------*         82870016
DERCCWX5 CCW   0,0,0,0            DEFINE EXTENT                @D14ZDDK 82880016
DERCCWT5 CCW   0,0,0,0            TIC TO USER                  @DA24935 82890016
*-------------------------------------------------------------*         82900016
DERCCWCT CCW   READSCNT,DERSVCT,SKIP+SLI+CC,8 READ COUNT CCW   @D14ZDDK 82910016
DERSVCT  DS    D                                                        82920016
*-------------------------------------------------------------*         82930016
DERSFM   CCW   SFM,DERSFMSK,CC+SLI,1 BUILD AREA FOR SFM CCW    @D31HMRH 82940016
DERSFMSK DS    X                  FILE MASK FOR THE SET FILE            82950016
*                                 MASK CCW AT DERSFM.                   82960016
DERSVMSK DS    X                  DEFAULT FILE MASK FOR THE             82970016
*                                 DEVICE ON WHICH THE ORIGINAL          82980016
*                                 ERROR CONDITION OCCURRED.             82990016
*-------------------------------------------------------------*         83000016
DERCCW   CCW   0,0,0,0            BUILD AREA FOR CCW1/CCW2     @DA25502 83010016
*                                                                       83020016
DERTIC   CCW   TIC,0,0,0          CCW THAT WILL TRANSFER TO    @D14ZDDK 83030016
*                                 THE LAST CCW SPECIFIED ON             83040016
*                                 CALL TO DERMKTIC.  IF THE             83050016
*                                 OPCODE IS NOP THEN THIS CCW           83060016
*                                 IS NOT A VALID TIC CCW.               83070016
*                                                                       83080016
DERIDAL  DC    XL132'00'          COPY AREA FOR USER IDAL      @DA35245 83090016
DERIDALE EQU   *                  END OF IDAL AREA             @DA35245 83100016
DERRMCKD EQU   X'5E'    OPERATION CODE FOR A READ MULTIPLE              83110016
*                       CKD CCW.                                        83120016
DERSKOP  EQU   X'07'    OPERATION CODE FOR A SEEK CCW.                  83130016
DERPCI   EQU   X'08'              CCW PCI BIT                  @D31HMRH 83140016
DERZERO  DC    X'0000'            ZERO                         @D14ZDDK 83150016
DERHOMAD DC    XL6'00'            AREA FOR READ HA             @D35DDDK 83160016
DERSEEK  DS    0XL6               SEEK FIELD                   @D35DDDK 83170016
         DC    XL2'00'            BB      BLOCK (ALWAYS ZERO)  @D35DDDK 83180000
DERCCHH  DS    0XL4               CCHH    CYLINDER AND HEAD    @D35DDDK 83190016
DERCC    DC    XL2'00'            CC      CYLINDER             @D37ADDK 83200016
DERHH    DC    XL2'00'            HH      HEAD                 @D37ADDK 83210016
         DC    X'01'              R       RECORD               @D37ADDK 83220000
DERSARG  DC    XL5'00'            RESTART SEARCH ARGUMENT      @DA22771 83230016
DEREOCA  DC    A(*)     END OF THE DSK CCW AREA.                        83240016
*-------------------------------------------------------------*         83250016
*-------------------------------------------------------------*         83260016
DERCLSTK EQU  11                  NR OF SAVE AREAS IN STACK    @D51TDPM 83270016
DERDERSV DS   (DERCLSTK*16)F      CALL STACK OF SGDSK.         @D51TDPM 83280016
*                                 STACK IS ONLY PROTECTED FOR  @D51TDPM 83290016
*                                 DEBUG SUPERVISOR GENERATION  @D51TDPM 83300016
         DC   X'FF'               STACK END INDICATION         @DERPDGL 83310016
*                                                                       83320016
         EJECT ,                                                        83330016
*                                                                       83340016
*-------------------------------------------------------------*@D51TDPM 83350016
*   DSK DATA FOR WRAP AROUND DEBUG AREA PROCESSING             @D51TDPM 83360016
*-------------------------------------------------------------*@D51TDPM 83370016
*                                                              @D51TDPM 83380016
         ORG   ((((*+15-SYSS00)/16)*16)+SYSS00)                @D61SDJK 83390016
DERDBGST DC    C'DERDEBUG'                                     @DERPDGL 83400016
DERDBGMS DC    A(X'03FF')       MASK FOR WRAP AROUND WRITING   @D66ADAP 83410016
DERDBGAC DC    H'0'             CURRENT OFFSET IN AREA         @DERPDGL 83420016
DERDBGNR DC    H'0'             NR OF I/O ERROR PROCESSED      @DERPDGL 83430016
         ORG   ((((*+15-SYSS00)/16)*16)+SYSS00)                @DERPDGL 83440016
DERDEBUG DC    64XL16'00'                                      @D66ADAP 83450016
         AGO   .MACEXIT                                        @D66ADAP 83460016
.*                                                             @DERPDGL 83470016
.**************************************************************@DERPDGL 83480016
.* MECHANISMS TO HANDLE ALL SAFEGUARDING OF CALLS AND RETURNS  @DERPDGL 83490016
.* IN SGDSK.                                                   @DERPDGL 83500016
.**************************************************************@DERPDGL 83510016
.*                                                             @DERPDGL 83520016
.*     GIVE A NOTE FOR AN INVALID REGISTER CONVENTION          @DERPDGL 83530016
.*                                                             @DERPDGL 83540016
.DSINVC  MNOTE 8,'WRONG REGISTER CONVENTION'                   #SECURGL 83550016
         AGO  .MACEXIT                                         #SECURGL 83560016
.**************************************************************@DERPDGL 83570016
.*                                                             @DERPDGL 83580016
.*     CHECK OTHER INVOCATIONS EXCEPT CALL SUBROUTINE          @DERPDGL 83590016
.*                                                             @DERPDGL 83600016
.DSINVS  ANOP                                                  #SECURGL 83610016
.*                                                             #SECURGL 83620016
.* RING1 SETC '                                    '(2,K'&SYSLIST(1)-2) 83630016
         AIF ('&TEST'(1,6)  EQ 'SGCOV '        ).MAKCOV        #SECURGL 83640016
&STRING1 SETC '                                    '                    83650016
&STRING2 SETC  '&SYSLIST(2)'(2,K'&SYSLIST(2)-2)                         83660016
         AIF ('&TEST'(1,7)  EQ 'RETURN '       ).MAKRET        #SECURGL 83670016
         AIF ('&TEST'(1,8)  EQ 'RETURN4 '      ).MAKRET4       #SECURGL 83680016
         AIF ('&TEST'(1,8)  EQ 'RETURN8 '      ).MAKRET8       #SECURGL 83690016
         AIF ('&TEST'(1,8)  EQ 'HEADING '      ).MAKHEAD       #SECURGL 83700016
         AIF ('&TEST'(1,12) EQ 'STARTINCLUDE'  ).MAKINCL       #SECURGL 83710016
         AIF ('&TEST'(1,12) EQ 'ENDINCLUDE  '  ).MAKEINC       #SECURGL 83720016
         MNOTE 8,'INVOCATION WITH UNKNOWN SUBJECT'             #SECURGL 83730016
         AGO   .MACEXIT                                        @D66ADAP 83740016
.**************************************************************#SECURGL 83750016
.*                                                             #SECURGL 83760016
.*    MAKE A STANDARD CALL TO ALL SUBROUTINES                  #SECURGL 83770016
.*                                                             #SECURGL 83780016
.DSHEAD  ANOP                                                  #SECURGL 83790016
&X       SETA  5  = LENGTH OF 'CALL' OR 'INCL' KEYWORD + QUOTE          83800016
.DSHEA2  ANOP                                                           83810016
&X       SETA  &X+1                                                     83820016
         AIF   ('&SUBJ'(&X,1) EQ ' ').DSHEA2                            83830016
&Y       SETA  &X                                                       83840016
&X       SETA  0                                                        83850016
.DSHEA4  ANOP                                                  @DERPDGL 83860016
&X       SETA  &X+1                                            @DERPDGL 83870016
         AIF   ('&SUBJ'(&X+&Y,1) NE ' ').DSHEA4                         83880016
&STRING  SETC  '&SUBJ'(&Y,&X)                                           83890016
&STRING1 SETC  '                                              '         83900016
.*                                                             @DERPDGL 83910016
.*   IF IT IS DEBUG GENERATE A SAFETY CHECK IF SAVE AREA EMPTY @DERPDGL 83920016
.*                                                             @DERPDGL 83930016
         AIF   (NOT &BGDEBUG).DSHEAB                                    83940016
&STRING3 SETC '16*4(RD),X''FF''&STRING1'(1,K'&SYSLIST(1)-5).'*'         83950016
&LABEL   CLI   &STRING3                                                 83960016
.DSHEAB  ANOP                                                  @DERPDGL 83970016
.*                                                             @DERPDGL 83980016
.*                                                             @DERPDGL 83990016
&STRING2 SETC  '&SYSLIST(2)'(2,K'&SYSLIST(2)-2)                         84000016
&STRING3 SETC 'R0,RF,16*4(RD)&STRING1'(1,K'&SYSLIST(1)-5)               84010016
&STRING3 SETC '&STRING3&STRING2'                                        84020016
         STM   &STRING3                                                 84030016
&STRING3 SETC '0H''0'',X''58C0'',S(*+6)&STRING1'(1,K'&SYSLIST(1)-4)     84040016
&STRING3 SETC '&STRING3 .'                                              84050016
         DC    &STRING3                                                 84060016
         AIF   (NOT &BGDEBUG).DSHEA5                                    84070016
&STRING3 SETC 'RE,4(,RC)&STRING1'(1,K'&SYSLIST(1)-5).'  .'              84080016
         BAL   &STRING3                                                 84090016
.DSHEA5  AIF   (&BGDEBUG).DSHEA6                                        84100016
&STRING3 SETC 'RE,0(,RC)&STRING1'(1,K'&SYSLIST(1)-5).'  .'              84110016
         BAL   &STRING3                                                 84120016
.DSHEA6  ANOP                                                           84130016
&STRING3 SETC 'AL4(&STRING)&STRING1'(1,K'&SYSLIST(1)-5).'  .'           84140016
         DC    &STRING3                                                 84150016
         AIF   (T'&E0 EQ  'O').DSHEA7                                   84160016
&STRING  SETC  '&E0'(2,K'&E0-2)                                         84170016
         B         &STRING                                              84180016
.DSHEA7  ANOP                                                           84190016
         AIF   (T'&E4 EQ  'O').DSHEA8                                   84200016
&STRING  SETC  '&E4'(2,K'&E4-2)                                         84210016
         B         &STRING                                              84220016
.DSHEA8  ANOP                                                           84230016
.*                                                             @DERPDGL 84240016
.*   PROCESS THE NUMBER PARAMETER NR GIVEN IN CASE OF DERTRACE @DERPDGL 84250016
.*                                                             @DERPDGL 84260016
         AIF   ('&STRING' EQ 'DERPRPMS').DSNUMB                @DERPDGL 84270016
         AIF   ('&STRING' NE 'DERTRACE').DSHEA10               @DERPDGL 84280016
.DSNUMB  ANOP                                                  @DERPDGL 84290016
&X       SETA  0                                               @DERPDGL 84300016
.DSHEA9  ANOP                                                  @DERPDGL 84310016
&X       SETA  &X+1                                            @DERPDGL 84320016
         AIF   ('&NR'(&X,1) NE ' ').DSHEA9                     @DERPDGL 84330016
&X       SETA  &X-2                                            @DERPDGL 84340016
&STRING  SETC  '&NR'(2,&X)                                     @DERPDGL 84350016
         DC    AL4(&STRING)                                    @DERPDGL 84360016
         AGO   .MACEXIT                                        @D66ADAP 84370016
.DSHEA10 ANOP                                                  @DERPDGL 84380016
.*                                                             @DERPDGL 84390016
.*   PROCESS INFORMATIONAL INPUT OUTPUT CONVENTION HINTS       @DERPDGL 84400016
.*                                                             @DERPDGL 84410016
         AIF   (NOT &SGDSK OR NOT &BGDEBUG).QRHDEX             #SECURGL 84420016
&STRING  SETC  '&I'(2,K'&I-2)                                  #SECURGL 84430016
 MNOTE *,'        INPUT  =&STRING'                             #SECURGL 84440016
&STRING  SETC  '&O'(2,K'&O-2)                                  #SECURGL 84450016
 MNOTE *,'        OUTPUT =&STRING'                             #SECURGL 84460016
.QRHDEX  ANOP                                                  #SECURGL 84470016
         AGO   .MACEXIT                                        @D66ADAP 84480016
.**************************************************************#SECURGL 84490016
.*                                                             #SECURGL 84500016
.*    MAKE A COVERAGE POINT AND A TRACE EARMARKING POINT       #SECURGL 84510016
.*                                                             #SECURGL 84520016
.MAKCOV  ANOP                                                  #SECURGL 84530016
&X       SETA  6  = LENGTH OF 'SGCOV' KEYWORD PLUS QUOTE                84540016
.DCOV00  ANOP                                                           84550016
&X       SETA  &X+1                                                     84560016
         AIF   ('&SUBJ'(&X,1) EQ ' ').DCOV00                            84570016
&Y       SETA  &X                                                       84580016
&X       SETA  0                                                        84590016
.DCOV10  ANOP                                                  @DERPDGL 84600016
&X       SETA  &X+1                                            @DERPDGL 84610016
         AIF   ('&SUBJ'(&X+&Y,1) EQ '''').DCOV20                        84620016
         AIF   ('&SUBJ'(&X+&Y,1) NE ' ').DCOV10                         84630016
.DCOV20  ANOP                                                  @DERPDGL 84640016
&STRING  SETC  '&SUBJ'(&Y,&X)                                           84650016
         SGCOV &STRING                                                  84660016
&STRING  SETC  '8040201008040201'((&NR(2)+1)*2-1,2)                     84670016
         OI    DERT+&NR(1),X'&STRING'                                   84680016
         AGO   .MACEXIT                                        @D66ADAP 84690016
.**************************************************************#SECURGL 84700016
.*                                                             #SECURGL 84710016
.*    MAKE A STANDARD HEADING FOR ALL SUBROUTINES              #SECURGL 84720016
.*                                                             #SECURGL 84730016
.MAKHEAD ANOP                                                  #SECURGL 84740016
         AIF   (T'&NAME EQ 'O').NONAME                         @DERPDGL 84750016
&STRING3 SETC  'C''&NAME'''                                             84760016
         DC    &STRING3                                                 84770016
.NONAME  ANOP                                                  @DERPDGL 84780016
&STRING3 SETC  '0H&STRING1'(1,K'&SYSLIST(1)+3).'&STRING2'               84790016
&NAME    DS    &STRING3                                                 84800016
&STRING3 SETC '*,RC&STRING1'(1,K'&SYSLIST(1)+3).'*'                     84810016
         USING &STRING3                                                 84820016
&STRING3 SETC 'DERGLOB,RA&STRING1'(1,K'&SYSLIST(1)+3).'*'               84830016
         USING &STRING3                                                 84840016
         AIF   (NOT &BGDEBUG).MAKHEA1                                   84850016
&STRING3 SETC 'R5,&SYSERR&STRING1'(1,K'&SYSLIST(1)+3).'*'               84860016
         BAL   &STRING3                                                 84870016
&LABSUF  SETC  '&NAME'(4,K'&NAME-3)                                     84880016
&LABEL   SETC  'D$N&LABSUF'                                    @DERPDGL 84890016
&STRING3 SETC '*-4&STRING1'(1,K'&SYSLIST(1)+3).'*'                      84900016
&LABEL   BE    &STRING3                                                 84910016
.MAKHEA1 ANOP                                                           84920016
&STRING3 SETC 'RD,16*4(,RD)&STRING1'(1,K'&SYSLIST(1)+3).'*'             84930016
         LA    &STRING3                                                 84940016
&STRING3 SETC 'RE,RE*4(,RD)&STRING1'(1,K'&SYSLIST(1)+3).'*'             84950016
         ST    &STRING3                                                 84960016
         AGO   .MACEXIT                                        @D66ADAP 84970016
.**************************************************************#SECURGL 84980016
.*                                                             #SECURGL 84990016
.*    MAKE A STANDARD RETURN  FOR ALL SUBROUTINES              #SECURGL 85000016
.*                                                                      85010016
.MAKRET8 ANOP                                                           85020016
&ROF     SETA  8+4                                             @DERPDGL 85030016
         AGO   .MAKRETB                                        @DERPDGL 85040016
.MAKRET4 ANOP                                                           85050016
&ROF     SETA  4+4                                             @DERPDGL 85060016
         AGO   .MAKRETB                                        @DERPDGL 85070016
.MAKRET  ANOP                                                           85080016
&ROF     SETA  0+4                                             @DERPDGL 85090016
.MAKRETB ANOP                                                  @DERPDGL 85100016
&STRING3 SETC  '0H&STRING1'(1,K'&SYSLIST(1)+3).'&STRING2'               85110016
&NAME    DS    &STRING3                                                 85120016
         AIF   ('&OUTPUT' EQ 'O').NOOUTPT                               85130016
&COUNT1  SETA  1                                                        85140016
.MAKRT10 AIF   ('&OUTPUT(&COUNT1)' EQ '').NOOUTPT                       85150016
&RX      SETC  '&OUTPUT(&COUNT1)'                                       85160016
&STRING3 SETC '&RX,&RX*4(,RD)&STRING1'(1,K'&SYSLIST(1)+3).'  .'         85170016
         ST    &STRING3                                                 85180016
&COUNT1  SETA  &COUNT1+1                                                85190016
         AGO   .MAKRT10                                                 85200016
.NOOUTPT ANOP                                                           85210016
&STRING3 SETC 'R0,RF,0(RD)&STRING1'(1,K'&SYSLIST(1)+3).'  .'            85220016
         LM    &STRING3                                                 85230016
.*                                                                      85240016
         AIF   (NOT &BGDEBUG).MAKRE10                                   85250016
&STRING3 SETC '16*4(RD),X''00''&STRING1'(1,K'&SYSLIST(1)+3).'  .'       85260016
         MVI   &STRING3                                                 85270016
.MAKRE10 ANOP                                                           85280016
.*                                                                      85290016
&STRING3 SETC '&ROF.(,RE)&STRING1'(1,K'&SYSLIST(1)+3).'  .'             85300016
         B     &STRING3                                                 85310016
         AGO   .MACEXIT                                        @D66ADAP 85320016
.**************************************************************#SECURGL 85330016
.*                                                             #SECURGL 85340016
.*    MAKE A STANDARD INCLUDE BEGINNING                        #SECURGL 85350016
.*                                                             #SECURGL 85360016
.MAKINCL ANOP                                                  #SECURGL 85370016
&STRING3 SETC  '0H&STRING1'(1,K'&SYSLIST(1)+3).'&STRING2'               85380016
&NAME    DS    &STRING3                                                 85390016
         AGO   .MACEXIT                                        @D66ADAP 85400016
.**************************************************************#SECURGL 85410016
.*                                                             #SECURGL 85420016
.*    MAKE A STANDARD INCLUDE ENDING                           #SECURGL 85430016
.*                                                             #SECURGL 85440016
.MAKEINC ANOP                                                  #SECURGL 85450016
&STRING3 SETC  '0H&STRING1'(1,K'&SYSLIST(1)+3).'&STRING2'               85460016
&NAME    DS    &STRING3                                                 85470016
.MACEXIT AIF  (T'&SUBJ EQ 'O').G999999 IF EXPANSION FOR TEST *#SECURGL  85480016
         MEXIT                                                          85490016
.G999999 AIF   (NOT &SGDSK).MEXI                               @D66ADAP 85500016
         PRINT NOGEN                                           @D66ADAP 85510000
.MEXI    ANOP                                                  @D66ADAP 85520016
         MEND                                                           85530016
