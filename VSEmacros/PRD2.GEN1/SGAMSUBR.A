         MACRO                                                 @D14ZDJB 00001000
         SGAMSUBR &SUBROUT=,      SUBROUTINE NAME              @D14ZDJB*00002000
               &INPUT=,           INPUT REGISTERS              @D14ZDJB*00003000
               &OUTPUT=,          OUTPUT REGISTERS             @D14ZDJB*00004000
               &NOMOD=,           REGISTERS, NOT TO BE MODIFIED@D14ZDJB*00005000
               &LINK=,            LINK REGISTER                @D14ZDJB*00006000
               &IGN=,             IGN FOR SGLINK               @D52VDMZ*00007000
               &NOMODS=,          NOMODS FOR SGLINK            @D52VDMZ*00008000
               &CREATE=NO,        MODULE CREATION OPTION       @D14ZDJB*00009000
               &CBASE=,           CALLER BASE                  @D51IDMZ*00010000
               &SUBROUC=          CALLING ROUTINE              @D51IDMZ 00011000
         GBLA  &AGMINSG           MINIMUM SYSTEM GETVIS        @D14CDJB 00012000
.*                                    FOR SAA MASTER DUMP IN K @D52VDMZ 00013000
         GBLA  &AGMISGE           MINIMUM ABS. SYSTEM GETVIS   @D51IDMZ 00014000
.*                                IN K LEFT BY EXC. REQUESTORS @D51IDMZ 00015000
         GBLA  &AGMAXEX           MAXIMUM SYSTEM GETVIS FOR    @D14CDJB 00016000
.*                                  EXCESSIVE FUNCTIONS IN 10% @D149DJB 00017000
         GBLA  &AGPSIZB           GENERATED PAGE SIZE          @D14NDJB 00018000
         GBLB  &BGDEBUG           DEBUG OPTION                 @D14ZDJB 00019000
         LCLA  &KSUBR             LENGTH OF SUBROUTINE NAME    @D51IDMZ 00020000
         LCLA  &I                                              @D14ZDJB 00021000
         LCLA  &L                                              @D14ZDJB 00022000
         LCLA  &M                                              @D14ZDJB 00023000
         LCLA  &N                                              @D14ZDJB 00024000
         LCLA  &ENTR                                           @D14ZDJB 00025000
         LCLC  &LINKR                                          @D14ZDJB 00026000
         LCLC  &C                                              @D14ZDJB 00027000
         LCLC  &D                                              @D14ZDJB 00028000
         LCLC  &E                                              @D14ZDJB 00029000
         LCLC  &EC                                             @D52VDKH 00030000
         LCLC  &RWORK                                          @D14ZDJB 00031000
         LCLC  &INPREG                                         @D14ZDJB 00032000
         LCLC  &OUTREG                                         @D14ZDJB 00033000
         LCLC  &WRKREG                                         @D14ZDJB 00034000
         LCLC  &NMDREG                                         @D14ZDJB 00035000
         LCLC  &SETUP                                          @D14ZDJB 00036000
         LCLC  &TSTREG(16)                                     @D14ZDJB 00037000
         LCLC  &KEYW                                           @D14ZDJB 00038000
         LCLC  &H                                              @D14ZDJB 00039000
         LCLC  &TBASE             BASE OF SUBROUTINE(TARGET B.)@D51IDMZ 00040000
         ACTR  2000                                            @D14ZDJB 00041000
&H       SETC  ' '                                             @D14CDJB 00042000
         AIF   (&AGPSIZB GT 2048).PG4096                       @D14NDJB 00043000
&H       SETC  'H'                                             @D14CDJB 00044000
.PG4096  ANOP                                                  @D14NDJB 00045000
         AGO   .NOHDER                                         @D14ZDJB 00046000
***************************************************************@D149DJB 00047000
*                                                             *@D149DJB 00048000
.*       IBM DISK OPERATING SYSTEM                            *@D149DJB 00049000
*        SUPERVISOR - SGAMSUBR - 5686-066                     *@D41TDKY 00050000
*        LICENSED MATERIALS - PROPERTY OF IBM                 *@D41TDKY 00051000
*        THIS MACRO IS "RESTRICTED MATERIALS OF IBM"          *@D41TDKY 00052000
*        5686-066 (C) COPYRIGHT IBM CORP. 1984, 2001          *         00053000
*        SEE COPYRIGHT INSTRUCTIONS                           *@D41TDKY 00054000
.*                                                            *@D149DJB 00055000
.* SGAMSUBR CONTAINS SUBROUTINES FOR GETVIS/FREEVIS PROCESSING*@D51IDMZ 00056000
.* FOR EVERY ROUTINE TWO BASE INDICATIONS ARE SET:            *@D51IDMZ 00057000
.* TBASE : BASE OF THE ROUTINE (BASE OF CALLED ROUTINE)       *@D51IDMZ 00058000
.* CBASE : BASE OF THE ROUTINE (BASE OF CALLING ROUTINE)      *@D51IDMZ 00059000
.* THE MACRO IS DIVIDED INTO THREE PARTS:                     *@D51IDMZ 00060000
.* PART1 CONTAINS SUBROUTINES BELONGING TO SGAM ( HAVE THE    *@D51IDMZ 00061000
.* SAME BASE AS SGAM).                                        *@D51IDMZ 00062000
.* FOR THESE ROUTINES TBASE = AMBASE IS SET                   *@D51IDMZ 00063000
.* (TBASE IS THE BASE OF THE ROUTINE)                         *@D51IDMZ 00064000
.* WHEN CALLING ANOTHER ROUTINE CBASE=AMBASE MUST BE SET      *@D51IDMZ 00065000
.* PART2 CONTAINS SUBROUTINES HAVING BASE SGAMSUBR            *@D51IDMZ 00066000
.* FOR THESE ROUTINES TBASE=CBASE=GVSUBR IS SET               *@D51IDMZ 00067000
.* PART3 CONTAINS SUBROUTINES HAVING AN OWN BASE REGISTER     *@D51IDMZ 00068000
.* WHEN ENTERING THE SUBROUTINE THE BASE REGISTER MUST BE     *@D51IDMZ 00069000
.* LOADED.                                                    *@D51IDMZ 00070000
.* FOR THESE ROUTINES TBASE=CBASE=OWN                         *@D51IDMZ 00071000
.* FURTHERMORE, WHEN CALLING ANOTHER SUBROUTINE,              *@D51IDMZ 00072000
.* SUBROUC='SUBROUTINE NAME' MUST BE SET                      *@D51IDMZ 00073000
.* SPCHNMBR IS A 2 BYTE FIELD, LENGTH ADDED IN THE INSTRUCTION*@DY40045 00074000
.* POOL/FTCHPR PARAMETER NOT HANDLED FOR LOC=BELOW/ANY AF 5.2 *@KX40608 00075000
.* PAGE ALIGNMENT IN VISTAB DOES NOT WORK CORRECTLY FOR       *@DY42692 00076000
.* LOC=ANY AND PAGE=YES REQUEST                               *@DY42692 00077000
.* SYSTEM ABEND CODE NOT IN CORRECT POSITION                  *@DY44889 00078000
.* SKIP MIN1/MIN2 PROCESSING FOR LOC=ANY PARTITION REQUESTS   *@DY44889 00079000
.* (BETTER PERFORMANCE)                                       *@DY44889 00080000
.* TELL SGDEBUG THAT CI IS INCONSISTENT (DY45096 IN 2.3)      *@DY45096 00081000
.* INCREASE NUMBER OF SVA SUBPOOLS                            *@DY45383 00082000
.* MORE THAN 255 TASKS                                        *@D66ODOW 00083000
.* HW AFTER GETVIS XX,ALL SINCE MVS SUBPOOL ENTRY NOT INIT.   *@DY@@@MZ 00084000
.* FREE SPACE RELATED OS390 SVA SUBPOOLS IN STATIC PARTITION  *@DY45712 00085000
.* VARIOUS PROBLEMS IN GETVIS PART                            *@DY45586 00086000
.* SDAID: SET INDICATION IF FREEVIS ALL IS RELATED TO AN      *@DA46055 00087000
.*        EXCLUSIVE SUBPOOL OF A DETACHED SUBTASK.            *@DA46055 00088000
*                                                             *@D149DJB 00089000
***************************************************************@D149DJB 00090000
.NOHDER  ANOP                                                  @D14ZDJB 00091000
.**************************************************************@D149DJB 00092000
.*   PERFORM CHECKING OF CREATE PARAMETER                      @D149DJB 00093000
.**************************************************************@D149DJB 00094000
         AIF   ('&CREATE' EQ 'NO').CHKLNK                      @D14ZDJB 00095000
         AIF   ('&CREATE' EQ 'YES').CHKCRSR                    @D14ZDJB 00096000
         AIF   ('&CREATE'(1,3) EQ 'OPT').CHKLNK                @D52VDKH 00097000
         MNOTE  8,'INVALID CREATE SPECIFICATION,MACRO IGNORED' @D14ZDJB 00098000
         MEXIT                                                 @D14ZDJB 00099000
.CHKCRSR ANOP                                                  @D14ZDJB 00100000
         AIF   (T'&SUBROUT EQ 'O').CREATEA                     @D14ZDJB 00101000
         MNOTE  8,'CREATE SPECIFICATION NOT ALLOWED WHEN SUBROUT SPECIF*00102000
               IED, MACRO IGNORED'                             @D14ZDJB 00103000
         MEXIT                                                 @D14ZDJB 00104000
.**************************************************************@D149DJB 00105000
.*   PERFORM CHECKING OF LINK REGISTER                         @D149DJB 00106000
.**************************************************************@D149DJB 00107000
.CHKLNK  ANOP                                                  @D14ZDJB 00108000
         AIF   (T'&LINK NE 'O').CHKLNK1                        @D14ZDJB 00109000
         MNOTE  8,'LINK REGISTER IS MISSING'                   @D14ZDJB 00110000
         AGO   .CHKSUBR                                        @D14ZDJB 00111000
.CHKLNK1 ANOP                                                  @D14ZDJB 00112000
         AIF   (N'&LINK EQ 1).CHKSUBR                          @D14ZDJB 00113000
         AIF   ('&LINK(1)' EQ 'FUNCTION').CHKSUBR              @D64ADKH 00114000
         MNOTE  8,'ONLY ONE LINK REGISTER ALLOWED'             @D14ZDJB 00115000
.**************************************************************@D149DJB 00116000
.*   GOTO CORRESPONDING SUBROUTINE                             @D149DJB 00117000
.*     GETVIS SUBROUTINES                                      @D149DJB 00118000
.**************************************************************@D149DJB 00119000
.CHKSUBR ANOP                                                  @D14ZDJB 00120000
         AIF   ('&SUBROUT' EQ 'GTVSINI0').GTVSIN0              @D52VDMZ 00121000
         AIF   ('&SUBROUT' EQ 'GTVSINI1').GTVSIN1              @D52VDMZ 00122000
         AIF   ('&SUBROUT' EQ 'GTVSINI2').GTVSIN2              @D52VDMZ 00123000
         AIF   ('&SUBROUT' EQ 'GTVSINI3').GTVSIN3              @D52VDMZ 00124000
         AIF   ('&SUBROUT' EQ 'GVSBPOOL').GVSBPOL              @D14ZDJB 00125000
         AIF   ('&SUBROUT' EQ 'GVSCPBDY').GVSCPBY              @D14ZDJB 00126000
         AIF   ('&SUBROUT' EQ 'GVGPMIN1').GVGPMN1              @D14ZDJB 00127000
         AIF   ('&SUBROUT' EQ 'GVSCVSTB').GVSCVSB              @D14ZDJB 00128000
         AIF   ('&SUBROUT' EQ 'GVSCVST1').GVSCVS1              @D61NDMZ 00129000
         AIF   ('&SUBROUT' EQ 'GVGETPAG').GVGETPG              @D14ZDJB 00130000
         AIF   ('&SUBROUT' EQ 'GVUPPIE0').GVUPIE0              @D14ZDJB 00131000
         AIF   ('&SUBROUT' EQ 'GVUPPIE1').GVUPIE1              @D14ZDJB 00132000
         AIF   ('&SUBROUT' EQ 'GVCHOPT').GVCHOPT               @D51IDMZ 00133000
         AIF   ('&SUBROUT' EQ 'GVINTFV').GVINTFV               @D51IDMZ 00134000
         AIF   ('&SUBROUT' EQ 'GVPROT').GVPROT                 @D52VDMZ 00135000
         AIF   ('&SUBROUT' EQ 'GVSTAT').GVSTAT                 @DY44311 00136000
         AIF   ('&SUBROUT' EQ 'GVPFIXSV').GVPFXSV              @D14ZDJB 00137000
.**************************************************************@D149DJB 00138000
.*     FREEVIS SUBROUTINES                                     @D149DJB 00139000
.**************************************************************@D149DJB 00140000
         AIF   ('&SUBROUT' EQ 'FVPGMR').FVPGMR                 @D14ZDJB 00141000
         AIF   ('&SUBROUT' EQ 'FVSBPOOL').FVSBPOL              @D14ZDJB 00142000
         AIF   ('&SUBROUT' EQ 'STVSTBPG').STVSBPG              @D14ZDJB 00143000
         AIF   ('&SUBROUT' EQ 'FVCHKEPG').FVCHKEP              @D14ZDJB 00144000
         AIF   ('&SUBROUT' EQ 'FVFREPDS').FVFRPDS              @D14ZDJB 00145000
         AIF   ('&SUBROUT' EQ 'FVCHOPT').FVCHOPT               @D51IDMZ 00146000
         AIF   ('&SUBROUT' EQ 'FVUPCPTR').FVUPCPT              @D51XDMZ 00147000
         AIF   ('&SUBROUT' EQ 'GVXPART').GVXPART               @D52VDKH 00148000
         AIF   ('&SUBROUT' EQ 'GVXING').GVXING                 @D52VDKH 00149000
         AIF   ('&SUBROUT' EQ 'FVROUTED').FVROUTD              @D52VDKH 00150000
         AIF   ('&SUBROUT' EQ 'FREEALL').FREEALL               @D52VDKH 00151000
.**************************************************************@D149DJB 00152000
.*     COMMON SUBROUTINES                                      @D149DJB 00153000
.**************************************************************@D149DJB 00154000
         AIF   ('&SUBROUT' EQ 'GVFVPTR').GVFVPTR               @D14ZDJB 00155000
         AIF   ('&SUBROUT' EQ 'GFSTKEYV').GFSTKYV              @D14ZDJB 00156000
         AIF   ('&SUBROUT' EQ 'GFSTKEYP').GFSTKYP              @D14ZDJB 00157000
         AIF   ('&SUBROUT' EQ 'GFSCINDT').GFSCIND              @D14ZDJB 00158000
         AIF   ('&SUBROUT' EQ 'GFENQDEQ').GFENQDQ              @D14ZDJB 00159000
         AIF   ('&SUBROUT' EQ 'SETVSTAB').SETVSTB              @D14ZDJB 00160000
         AIF   ('&SUBROUT' EQ 'GFSFIXSB').GFSFIXS              @D14ZDJB 00161000
         AIF   ('&SUBROUT' EQ 'GVFVMIR1').GVFVMR1              @D52VDKH 00162000
         AIF   ('&SUBROUT' EQ 'GVFVMIR2').GVFVMR2              @D52VDKH 00163000
         AIF   ('&SUBROUT' EQ 'GVFVGATS').GVFVGATS             @D64ADKH 00164000
         AIF   ('&SUBROUT' EQ 'GMFMACTV').GMFMACTV             @D64ADKH 00165000
         AIF   ('&SUBROUT' EQ 'FVDISCRD').FVDISCRD             @D64ADKH 00166000
         AIF   ('&SUBROUT' EQ 'IJBSSM2').IJBSSM2               @D64ADKH 00167000
         AIF   (NOT &BGDEBUG).NOTRACE                          @D14ZDJB 00168000
         AIF   ('&SUBROUT' EQ 'GVTRACE').GVTRACE               @D14ZDJB 00169000
         AIF   ('&SUBROUT' EQ 'FVTRACE').FVTRACE               @D14ZDJB 00170000
.NOTRACE ANOP                                                  @D14ZDJB 00171000
         MNOTE  8,'UNKNOWN SUBROUTINE SPECIFIED,MACRO IGNORED' @D14ZDJB 00172000
         MEXIT                                                 @D14ZDJB 00173000
.**************************************************************@D149DJB 00174000
.*                                                             @D149DJB 00175000
.*       BYTE SETTINGS USED IN SETC INSTRUCTIONS               @D149DJB 00176000
.*                                                             @D149DJB 00177000
.*       0    =      REGISTER IS NOT NEEDED NOR ALTERED        @D149DJB 00178000
.*       1    =      REGISTER SPECIFICATION IS MANDATORY       @D149DJB 00179000
.*                                                             @D149DJB 00180000
.**************************************************************@D149DJB 00181000
.CREATEA ANOP                                                  @D14ZDJB 00182000
.* FIRST PART: ROUTINES WITHIN THIS PART HAVE TBASE=AMBASE     @D51IDMZ 00183000
.* WHEN CALLING ANOTHER ROUTINE CBASE=AMBASE IS SET            @D51IDMZ 00184000
         DC    CL20'GVFVSUBRA 08/17/2005' MODULE NAME AND DATE @DY45712 00185590
         DC    CL8'DY46339 '       LAST APAR FIX/ CLC          @DY46339 00186180
         SPACE 1                                               @D14ZDJB 00187000
***************************************************************@D51IDMZ 00188000
*                                                              @D51IDMZ 00189000
*   ROUTINE TO DO INTERNAL FREEVIS PROCESSING                  @D51IDMZ 00190000
*                                                              @D51IDMZ 00191000
*   MODULE GVINTFV                                             @D51IDMZ 00192000
*    IF SUBPOOL WAS CREATED BY CURRENT REQUEST                 @D51IDMZ 00193000
*      THEN FREEVIS SUBPOOL                                    @D51IDMZ 00194000
*    ELSE                                                      @D51IDMZ 00195000
*      FREEVIS AREA                                            @D51IDMZ 00196000
*   ENDMODULE GVINTFV                                          @D51IDMZ 00197000
*                                                              @D51IDMZ 00198000
*     CALLED BY : GETVIS                                       @D51IDMZ 00199000
*     CALLS     : FVSBPOOL, FREEVNOS                           @D52VDMZ 00200000
*                                                              @D51IDMZ 00201000
*     INPUT  : RB  :  SHIFT MODIFIER FOR SVA/SPACE REQUEST     @D51IDMZ 00202000
*              RC --> ANCHOR TABLE (VISTAB)                    @D51IDMZ 00203000
*              RA --> TCB PTR                                  @D52VDMZ 00204000
*              RD --> REQUESTOR SAVE AREA                      @D51IDMZ 00205000
*     OUTPUT : RF  :  RETURN CODE : X'20' (PFIX FAILURE)       @D51IDMZ 00206000
*     LINK   : R7                                              @D51IDMZ 00207000
*     WORK   : R0,R1,R2,R3,R4,R5,R8,R9                         @D51IDMZ 00208000
*                                                              @D52VDMZ 00209000
*              R8 MAY NOT BE USED AS WORK REG WHEN CALLED      @D52VDMZ 00210000
*              DURING FREEVIS ALL PROCESSING                   @D52VDMZ 00211000
         AGO    .CREATEQ                                       @D14ZDJB 00212000
.GVINTFV ANOP                                                  @D14ZDJB 00213000
.*             0123456789ABCDEF                                @D149DJB 00214000
&INPREG  SETC '0000000000111100'                               @D14ZDJB 00215000
&OUTREG  SETC '0000000000000001'                               @D14ZDJB 00216000
&WRKREG  SETC '1111110011000000'                               @D52VDMZ 00217000
&NMDREG  SETC '0000001100111110'                               @D52VDMZ 00218000
&LINKR   SETC 'R7'                                             @D14ZDJB 00219000
&TBASE   SETC 'AMBASE'                                         @D51IDMZ 00220000
.*EXCLSYMS=(SAVR2NDF,SAVR2ND7,SAVR2ND6)                        @D52VDMZ 00221000
         AGO    .TESTALL                                       @D14ZDJB 00222000
.CREATEQ ANOP                                                  @D14ZDJB 00223000
***************************************************************@D149DJB 00224000
         SPACE 2                                               @D14CDJB 00225000
         USING ANCHTAB,RC                                      @D14CDJB 00226000
         USING SVEARA,RD                                       @D51IDMZ 00227000
GVINTFV  DS    0H                                              @D51IDMZ 00228000
*SGLINK  GVINTFV,S,INPUT=(R7:LINK,RA,RB,RC,RD),OUTPUT=(RF),            *00229000
               WORK=(R0-R2,R3,R4,R5,R8,R9,RE,RF),AMODE=31,             *00230000
               NOMODR=(R7),                                            *00231000
               MODSYM=(SAVR2NDF,SAVR2ND7,SAVR2ND6),                    *00232000
               SUBROUT=(FVSBPOOL,FREEVNOS)                              00233000
         OI    GVFVFLGS,GVFVINT                                @D52VDKH 00234000
         SR    RF,RF                                           @D51IDMZ 00235000
         MVC   SAVR2NDF,SVER0F    SAVE OPTIONS                 @D52VDKH 00236000
         NC    SVER0F,GVINTCO     CLEAR OPTION REGISTER        @D51IDMZ 00237000
         ST    R7,SAVR2ND7        SAVE LINK REG R7             @D51IDMZ 00238000
         L     R5,SPIDSAV         GET CURRENT SUBPOOL OFFSET   @D52VDKH 00239000
         USING SUBPINT,R5                                      @D51IDMZ 00240000
         TM    SPITFLAG,SPPFXPND  PFIX REQUEST PENDING         @D52VDKH 00241000
         BO    GVINTFA            YES, FREEVIS AREA ONLY       @D52VDKH 00242000
         TM    SPITFLAG,SPCREATE  SUBPOOL JUST CREATED         @D51IDMZ 00243000
         BZ    GVINTFA            NO, FREEVIS AREA ONLY        @D51IDMZ 00244000
         DROP  R5                 RELEASE SUBPOOL INDEX BASE   @D51IDMZ 00245000
* FREEVIS SUBPOOL, PREPARE INPUT                               @D51IDMZ 00246000
         OI    SVER0F+D3,FVSPID   INDICATE FREEVIS SUBPOOL     @D51IDMZ 00247000
         L     R1,SSPNPTR         PTR TO SP NAME IN USER AREA  @D51IDMZ 00248000
         ST    R1,SVER01          PASS BACK TO USER            @D52VDKH 00249000
*SGLINK  FVSBPOOL,INPUT=(R1,R5,R7:LINK,RA,RB,RC,RD,RE,RF),             *00250000
               NOMODS=(SAVR2NDF,SAVR2ND7,ADDRSAV),             @D64ADKH*00251000
               NOMODR=(R6,RA,RC,RD),AMODE=31,OUTPUT=(RF)                00252000
         SGAMSUBR SUBROUT=FVSBPOOL,                            @D51IDMZ*00253000
               INPUT=(R1,R5,RA,RB,RC,RD,RE,RF),                @D64ADMZ*00254000
               NOMOD=(R6,RA,RC,RD),                            @D51IDMZ*00255000
               LINK=(R7),         FREEVIS TOTAL SUBPOOL        @D51IDMZ*00256000
               NOMODS=(SAVR2NDF,SAVR2ND7,SAVR2ND6),            @D52VDMZ*00257000
               CBASE=AMBASE                                    @D51IDMZ 00258000
         B     GVINTFVE           GOTO EXIT                    @D51IDMZ 00259000
GVINTFA  DS    0H                 FREEVIS RESERVED AREA        @D51IDMZ 00260000
         LM    R0,R1,SVER00       GET LENGTH AND ADDRESS       @D51IDMZ 00261000
         SLR   RF,RF              INPUT FOR FREEVSMR           @D51IDMZ 00262000
         ST    R6,SAVR2ND6                                     @D51IDMZ 00263000
*SGLINK  FREEVNOS,INPUT=(R0,R1,RA,RB,RC,RD,RE,RF),OUTPUT=(RF),         *00264000
               AMODE=31,NOMODS=(SAVR2ND6,SAVR2NDF,ADDRSAV,SAVR2ND7),   *00265000
               NOMODR=(RA,RB,RC,RD,RE)                         @D64ADKH 00266000
         BAL   R6,FREEVNOS        FREEVIS STORAGE              @D51IDMZ 00267000
         L     R6,SAVR2ND6        RESTORE R6                   @D51IDMZ 00268000
GVINTFVE DS    0H                                              @D51IDMZ 00269000
         MVC   SVER01,ADDRSAV     USER'S INITIAL INPUT ADDR    @D52VDKH 00270000
         MVC   SVER0F,SAVR2NDF    RESET OPTIONS                @D52VDKH 00271000
         L     R7,SAVR2ND7        RESTORE R7                   @D51IDMZ 00272000
         LA    RF,SMERR20         INDICATE PFIX FAILURE        @D51IDMZ 00273000
         NI    GVFVFLGS,X'FF'-GVFVINT                          @D52VDKH 00274000
         BR    R7                 RETURN TO CALLER             @D51IDMZ 00275000
         DS    0F                                              @D51IDMZ 00276000
GVINTCO  DC    X'00000204'        DO NOT RESET SPACE AND SVA   @D51IDMZ 00277000
         EJECT                                                 @D51IDMZ 00278000
***************************************************************@D149DJB 00279000
*  CONSTANTS AND DATA AREAS USED BY SGAM                       @D149DJB 00280000
***************************************************************@D149DJB 00281000
         SPACE 1                                               @D14CDJB 00282000
AGVFVSUB DC    A(GVFVSUBR)        ADDRESS OF SGAM SUBROUTINES  @D14CDJB 00283000
AGTVSINI DC    A(GTVSINIT)        ADDRESS OF GTVSINIT SUBROUT. @D51IDMZ 00284000
AFVUPCPT DC    A(FVUPCPTR)        ADDRESS OF FVUPCPTR SUBROUT. @D51XDMZ 00285000
AGVXPART DC    A(GVXPART)         ADDRESS OF GVXPART SUBROUT.  @D52VDKH 00286000
AGVXING  DC    A(GVXING)          ADDRESS OF GVXING SUBROUT .  @D52VDKH 00287000
AGVCHOPT DC    A(GVCHOPT)         ADDRESS OF GVCHOPT SUBROUT.  @D51XDMZ 00288000
AFVCHOPT DC    A(FVCHOPT)         ADDRESS OF FVCHOPT SUBROUT.  @D51XDMZ 00289000
AFVROUTE DC    A(FVALLRTD)        ADDRESS OF FVALLRTD SUBROUT. @D52VDKH 00290000
AFREEALL DC    A(FREEALL)         ADDRESS OF FREEVIS ALL       @D52VDKH 00291000
AGVSBPOO DC    A(GVSBPOOL)        ADDRESS OF GVSBPOOL SUBROUT. @D52VDKH 00292000
AGVGPMIN DC    A(GVGPMIN1)        ADDRESS OF GVGPMIN1 SUBROUT. @D52VDKH 00293000
AGVPROT  DC    A(GVPROT)          ADDRESS OF GVPROT SUBROUT.   @D52VDMZ 00294000
AGVSCVST DC    A(GVSCVSTB)        ADDRESS OF GVSCVSTB SUBROUT. @D52VDMZ 00295000
AGVFVGAT DC    A(GVFVGATING)      ADDRESS OF GATING   SUBROUT. @D64ADKH 00296000
AGMFMACT DC    A(GMFM_ACTIVATE)   ADDRESS OF SUBPOOL ACTIVATION@D64ADKH 00297000
AFVDISCR DC    A(FV_DISCARD)      ADDRESS OF SUBPOOL DISCARD   @D64ADKH 00298000
AGMFMENT DC    A(GMFMENTRY)       ADDRESS OF GATING   SUBROUT. @D64ADKH 00299000
ASGETSFR DC    A(SGETVIS)         ADDRESS OF SGETVIS SUBROUT.  @D67FDMZ 00300000
A_CDDELETE  DC A(PHADLALL)                                     @D64ADMZ 00301000
AFVSBPOO DC    A(FVSBPOOL)        ADDR OF FREEVIS SUBPOOL ROUT.@D64ADMZ 00302000
AGVSTAT  DC    A(GVSTAT)          ADDRESS OF GVSTAT SUBROUT.   @DY44311 00303000
GVIJB    DC    CL3'IJB'           CONSTANT FOR SUBPOOL ID      @D51IDKH 00304000
         DC    X'00'              ALIGN ON HALFWORD BDY        @D51IDMZ 00305000
ZERONAME DC    XL6'00'            INITIAL SUBPOOL NAME         @D14CDJB 00306000
         SPACE 1                                               @D14CDJB 00307000
         AIF   (NOT &BGDEBUG).NODBGX1  SKIP FOR DEBUG=NO       @D14CDJB 00308000
GVTRSSID DC    XL2'00'            SUBPOOL NUMBER FOR TRACE     @D51IDMZ 00309000
.NODBGX1 ANOP                                                  @D14CDJB 00310000
GVFVEND  EQU   *                  END OF GETVIS/FREEVIS CODE   @D14CDJB 00311000
GVFVLGTH EQU   GVFVEND-GETVIS     LENGTH OF GETVIS/FREEVIS CODE@D14CDJB 00312000
         DROP  RA,RE                                           @D35EDUL 00313000
         EJECT                                                 @D14CDJB 00314000
.* ************************************************************@D149DJB 00315000
.* PART2:                                                               00316000
.* SUBROUTINES FOR GETVIS/FREEVIS WHICH USE NOT THE BASE REGISTER OF    00317000
.* SGAM BUT THE BASE REGISTER WITH CONTENTS: A(GVFVSUBR)                00318000
.* FOR ROUTINES IN TBASE=GVSUBR IS SET.                                 00319000
.* IF ONE OF THESE SUBROUTINES CALLS ANOTHER SUBROUTINE USING           00320000
.* SGAMSUBR CBASE=GVSUBR MUST BE SET.                                   00321000
***************************************************************@D149DJB 00322000
         SPACE 2                                               @D14ZDJB 00323000
         DC    CL20'GVFVSUBRB 02/08/02' MODULE NAME AND DATE   @D67FCMZ 00324000
         SPACE 1                                               @D14ZDJB 00325000
***************************************************************@D149DJB 00326000
*                                                              @D149DJB 00327000
*  GVFVPTR : ROUTINE TO                                        @D52VDMZ 00328000
*            CHECK GETVIS/FREEVIS OPTIONS (DONE BY SUBROUTINE) @D64ADMZ 00329000
*            CLOSE GATE (DONE BY SUBROUTINE)                   @D64ADKH 00330000
*            AND TO SET EXECUTION FLAGS (AMODE, RMODE)         @D52VDMZ 00331000
*                                                              @D149DJB 00332000
*            THE ADDRESS OF THE REQUESTING TASKS SAVE AREA IS  @D64ADKH 00333000
*            RETURNED                                                   00334000
*            THE PFIX INDICATION IS RESET FOR LENGTH 0 REQUESTS AND     00335000
*            INVALID OPTIONS                                   @D64ADMZ 00336000
*                                                              @D51IDMZ 00337000
*     CALLED BY : GETVIS  FREEVIS SGETVIS SFREEVIS             @D64ADKH 00338000
*     CALLS     : GVFVGATING GVCHOPT FVCHOPT                   @D149DJB 00339000
*                                                              @D149DJB 00340000
*    INPUT  : R6 --> DISPATCHER RETURN ADDRESS                 @D52VDMZ 00341000
*             RA --> REQUESTOR'S TCB                           @D149DJB 00342000
*             RD --> REQUESTOR'S SAVE AREA ADDR (TCBSAVE)      @D64ADMZ 00343000
*             RE --> BASE                                      @D52VDMZ 00344000
*                                                              @D149DJB 00345000
*    OUTPUT : RC  :  0 (GETVIS AREA NOT YET AVAILABLE)         @D64ADMZ 00346000
*                    IN THIS CASE NO GATES ARE CLOSED          @D64ADMZ 00347000
*             RC  :  PTR TO CI OTHERWISE                       @D64ADMZ 00348000
*                    IN THIS CASE THE APPROPRIATE GATES ARE CLOSED      00349000
*             RF  :  0 OK                                      @D149DJB 00350000
*             RF  :  X'0C'                                     @D64ADMZ 00351000
*                    (SET IN GVFVGATING)                       @D64ADMZ 00352000
*             TCBIEXFLG                                        @D52VDMZ 00353000
*             TCB.DFWKCOMG(COMREG ADDRESS, PARTITION ONLY)     @D52VDMZ 00354000
*    LINK   : R8                                               @D149DJB 00355000
*    WORK   : R3,R4,R5                                         @D52VDMZ 00356000
*                                                              @D149DJB 00357000
         AGO    .CREATE3                                       @D14ZDJB 00358000
.GVFVPTR ANOP                                                  @D14ZDJB 00359000
.*             0123456789ABCDEF                                @D149DJB 00360000
&INPREG  SETC '0000001000100110'                               @D14ZDJB 00361000
&OUTREG  SETC '0000000000001001'                               @D14ZDJB 00362000
&WRKREG  SETC '0001110000000000'                               @D14ZDJB 00363000
&NMDREG  SETC '1110001111110110'                               @D52VDMZ 00364000
&LINKR   SETC 'R8'                                             @D14ZDJB 00365000
&TBASE   SETC 'GVSUBR'                                         @D51IDMZ 00366000
.*EXCLSYMS=()                                                  @D52VDMZ 00367000
         AGO    .TESTALL                                       @D14ZDJB 00368000
.CREATE3 ANOP                                                  @D14ZDJB 00369000
***************************************************************@D149DJB 00370000
         SPACE 1                                               @D14CDJB 00371000
GVFVSUBR DS    0H                                              @D14ZDJB 00372000
         USING GVFVSUBR,RE                                     @D14ZDJB 00373000
         USING TCBADR,RA                                       @D14CDJB 00374000
         USING SVEARA,RD                                       @D64ADMZ 00375000
GVFVPTR  DS    0H                                              @D14CDJB 00376000
*SGLINK  GVFVPTR,S,INPUT=(R6,R8:LINK,RA,RD),OUTPUT=(RC,RF),            *00377000
               WORK=(R1,R2,R4-R5,R9,RB-RC,RE,RF),AMODE=31,             *00378000
               NOMODR=(R8,RD),SUBROUT=(GVFVGATING:IGN(R8),             *00379000
               GVCHOPT:IGN(R8),FVCHOPT:IGN(R8))                         00380000
***************************************************************@D149DJB 00381000
*  TEST FOR CORRECT OPTION INPUT                              *@D149DJB 00382000
***************************************************************@D149DJB 00383000
         LH    RF,PIK             GET REQUESTOR'S PIK          @D14CDJB 00384000
         LTR   RF,RF              REQUESTOR WITH PIK = 0 ?     @D14CDJB 00385000
         BNZ   GVFVPTR0           NO, DO FURTHER CHECKING      @D51IDMZ 00386000
         TM    SVER0F+D2,GVFVSPIN SPACE REQUEST                @D51IDMZ 00387000
         BO    GVFVPTS2           YES                          @D64ADKH 00388000
         TM    SVER0F+D3,SVAIND   SVA REQUEST                  @DY44311 00389000
         BO    GVFVPTS2           GATE SYSTEM GETVIS           @DY44311 00390000
         TM    SVER0F+D1,GVSTATAL+GVSTATSZ IS IT STATUS=ALL OR @DY44311 00391000
         BNZ   GVFVPTS0           =SIZE GATE PARTITION         @D64ADMZ 00392000
         OI    SVER0F+D3,SVAIND   FORCE SVA REQUEST            @D51IDMZ 00393000
         B     GVFVPTS2                                        @D51IDMZ 00394000
GVFVPTR0 DS    0H                                              @D51IDMZ 00395000
         TM    SVER0F+D3,SVAIND   REQUEST FOR SVA?             @D51IDMZ 00396000
         BO    GVFVPTR1           YES ==>                      @D51IDMZ 00397000
         TM    SVER0F+D2,GVFVSPIN SPACE REQUEST                @D51IDMZ 00398000
         BZ    GVFVPTS0           NO  ==> PARTITION REQUEST    @D64ADKH 00399000
************************************************************** @D149DJB 00400000
*   PROCESSING FOR SVA / SPACE REQUEST                       * @D149DJB 00401000
************************************************************** @D149DJB 00402000
GVFVPTR1 DS    0H                 CHECK AUTHORIZATION          @D51IDMZ 00403000
         USING DISP,R6                                         @D14CDJB 00404000
         SR    R4,R4              CLEAR FOR INSERT             @D52VDMZ 00405000
         IC    R4,SVEPSW+1        GET REQUESTOR'S PSW KEY      @D14CDJB 00406000
         SRA   R4,D4              KEY IS ONLY 4 BITS LONG      @D14CDJB 00407000
*                                 DID HE EXECUTE IN KEY ZERO?  @D149DJB 00408000
         BNZ   ERR21              NO,CANCEL                    @D14CDJB 00409000
GVFVPTS2 DS    0H                                              @D64ADKH 00410000
* RESET PFIX INDICATION FOR LENGTH 0 REQUEST                            00411000
.* SPACE AND PFIX IS CURRENTLY NOT ALLOWED. BUT TO MINIMIZE THE         00412000
.* DIFFERENCES BETWEEN SPACE AND SVA REQUESTS, PFIX IS CHECK FOR        00413000
.* SPACE, TOO.                                                          00414000
         CLI   SVCIC,FVISSVC      FREEVIS REQUEST ?            @D64ADKH 00415000
         BE    GVFVPTS0           YES                          @D64ADKH 00416000
         TM    SVER0F+D3,GVPFIX   GETVIS PFIX REQUEST ?        @D64ADKH 00417000
         BZ    GVFVPTS0           NO                           @D64ADKH 00418000
         L     R4,SVER00          IS LENGTH OF REQUEST ..      @D64ADKH 00419000
         LTR   R4,R4              .. >  0                      @D64ADKH 00420000
         BP    GVFVPTS0           YES, DO GATE HANDLING        @D64ADKH 00421000
GVFVPTS1 DS    0H                                              @D64ADKH 00422000
         NI    SVER0F+D3,X'FF'-GVPFIX RESET PFIX INDICATION    @D64ADKH 00423000
GVFVPTS0 DS    0H                                              @D64ADKH 00424000
         LR    RF,R8              SAVE RETURN ADDRESS          @D64ADKH 00425000
         LA    R9,0                                            @D64ADKH 00426000
         LA    R5,0               INDICATE GETVIS/FREEVIS      @D64ADKH 00427000
*SGLINK  GVFVGATING,INPUT=(R5,R8:LINK,R9,RA,RD),OUTPUT=(R9,RC),        *00428000
               AMODE=31,NOMODR=(R6,RA,RD,RF)                            00429000
         SGAMSUBR SUBROUT=GVFVGATS,                            @D64ADKH*00430000
               INPUT=(R5,R9,RA,RD),                            @D64ADMZ*00431000
               NOMOD=(R0,R1,R2,R3,R6,R7,RA,RD,RE,RF),          @D64ADKH*00432000
               OUTPUT=(R9,RC),                                 @D64ADMZ*00433000
               LINK=(R8),         SET STORAGE KEY TO ZERO      @D64ADKH*00434000
               CBASE=GVSUBR                                    @D64ADKH 00435000
         LR    R8,RF              RESTORE RETURN ADDRESS       @D64ADKH 00436000
         LR    RF,R9              GET RETURN CODE              @D64ADMZ 00437000
************************************************************** @D149DJB 00438000
*   INITIALIZE RF, SET CALLER'S AMODE/RMODE AND RETURN       * @D52VDMZ 00439000
************************************************************** @D149DJB 00440000
         DS    0H                                              @D14CDJB 00441000
         CLI   TCBIEXFL,X'00'     ALREADY SET BY INTERNAL CALL @D67FDMZ 00442000
         BNE   GVFVPTSE           YES, DO NOT OVERWRITE        @D67FDMZ 00443000
         MVC   TCBIEXFL,TCBEXFLG  GET CALLER'S EXECUTION FLAG  @D52VDMZ 00444000
GVFVPTSE DS    0H                                              @D67FDMZ 00445000
         BR    R8                 RETURN ===>                  @D14CDJB 00446000
         DROP  R6                                              @D14CDJB 00447000
         DROP  RD                 RELEASE SAVE AREA            @D64ADMZ 00448000
         DROP  RA                 RELEASE TCB                  @D64ADMZ 00449000
         EJECT                                                 @D14CDJB 00450000
***************************************************************@D149DJB 00451000
*                                                              @D149DJB 00452000
*   ROUTINE TO PFIX SVA SPACE                                  @D149DJB 00453000
*                                                              @D149DJB 00454000
*   MODULE GVPFIXSV                                            @D149DJB 00455000
*      IF PFIX REQUESTED                                       @D149DJB 00456000
*        THEN CALL PAGE MANAGER TO PFIX REQUESTED SPACE        @D149DJB 00457000
*             IF PFIX NOT SUCCESSFUL (RC¬=0)                   @D149DJB 00458000
*               THEN RETURN TO CALLER                          @D51IDMZ 00459000
*               ELSE SET PFIX BITS ON IN CHAIN TABLE ENTRIES   @D149DJB 00460000
*      EXIT GVPFIXSV                                           @D149DJB 00461000
*   ENDMODULE GVPFIXSV                                         @D149DJB 00462000
*                                                              @D149DJB 00463000
*     CALLED BY : GETVIS                                       @D149DJB 00464000
*     CALLS     : GFSFIXSB, GTVSINI2, GTVSINI3                 @D52VDMZ 00465000
*                                                              @D149DJB 00466000
*     INPUT  : R4 --> BEGIN ADDRESS OF AREA TO BE FIXED        @D149DJB 00467000
*              R5  :  NUMBER OF BYTES TO BE FIXED              @D149DJB 00468000
*              R6  :  DISPAD OR RETURN ADDR. OF INT. CALLER    @D52VDMZ 00469000
*              RB  :  SHIFT MODIFIER FOR SVA REQUEST           @D149DJB 00470000
*              RC --> ANCHOR TABLE (VISTAB)                    @D149DJB 00471000
*              RD --> REQUESTOR SAVE AREA                      @D149DJB 00472000
*              RF --> 0                                        @D149DJB 00473000
*     OUTPUT : RF  :  RETURN CODE : PFIX FAILED                @D149DJB 00474000
*     LINK   : R7                                              @D149DJB 00475000
*     WORK   : R0,R1,R2,R3,R4,R5,R8,RE                         @D149DJB 00476000
*                                                              @D149DJB 00477000
         AGO    .CREATED                                       @D14ZDJB 00478000
.GVPFXSV ANOP                                                  @D14ZDJB 00479000
.*             0123456789ABCDEF                                @D149DJB 00480000
&INPREG  SETC '0000111000011101'                               @D52VDMZ 00481000
&OUTREG  SETC '0000000000000001'                               @D14ZDJB 00482000
&WRKREG  SETC '1111110010000010'                               @D52VDMZ 00483000
&NMDREG  SETC '0000001101111100'                               @D52VDMZ 00484000
&LINKR   SETC 'R7'                                             @D14ZDJB 00485000
&TBASE   SETC 'GVSUBR'                                         @D51IDMZ 00486000
.*EXCLSYMS=()                                                  @D52VDMZ 00487000
         AGO    .TESTALL                                       @D14ZDJB 00488000
.CREATED ANOP                                                  @D14ZDJB 00489000
***************************************************************@D149DJB 00490000
         SPACE 2                                               @D14CDJB 00491000
         USING ANCHTAB,RC                                      @D14CDJB 00492000
         USING SVEARA,RD                                       @D14CDJB 00493000
GVPFIXSV DS    0H                                              @D14CDJB 00494000
*SGLINK  GVPFIXSV,S,INPUT=(R4,R5,R6,R7:LINK,RB,RC,RD,RF),OUTPUT=(RF),  *00495000
               WORK=(R0,R1,R2-R5,R8,RE,RF),AMODE=31,                   *00496000
               NOMODR=(R7),                                            *00497000
               SUBROUT=(GFSFIXSB,GTVSINI2:IGN(RB),GTVSINI3:IGN(RB))     00498000
         LTR   R5,R5                                           @D64ADKH 00499000
         BZR   R7                                              @D64ADKH 00500000
         BCTR  R5,0               DECR. LENGTH BY 1 TO         @DA36550 00501000
*                                 CALCULATE CORRECT END ADDRESSES       00502000
         LR    R0,R4              GET START ADDRESS            @D14CDJB 00503000
         LA    R1,D0(R4,R5)       GET END ADDRESS              @D14CDJB 00504000
         S     R4,BVIRTMEM        GET RELATIVE START ADDRESS   @D14CDJB 00505000
         LR    R3,R4              GET RELATIVE                 @D14CDJB 00506000
         AR    R3,R5                        END ADDRESS        @D14CDJB 00507000
         SRL   R4,PNSHIFT         RELATIVE START PAGE NUMBER   @D14CDJB 00508000
         SRL   R3,PNSHIFT         RELATIVE END PAGE NUMBER     @D14CDJB 00509000
         LR    R2,R3                 SAVE IT                   @DA36550 00510000
         SR    R3,R4              # OF PAGES AFFECTED - 1      @D14CDJB 00511000
         SLL   R4,SUBPCHN2        GET CHAIN ENTRY PTR          @D14CDJB 00512000
         A     R4,BSUBPCHN        GET CHAIN ENTRY ADDRESS      @D14CDJB 00513000
*                                 OF FIRST PAGE AFFECTED                00514000
         SLL   R2,SUBPCHN2        GET CHAIN ENTRY PTR          @DA36550 00515000
         A     R2,BSUBPCHN        GET CHAIN ENTRY ADDRESS      @DA36550 00516000
*                                 OF LAST PAGE AFFECTED                 00517000
***************************************************************@D149DJB 00518000
*  SPECIAL HANDLING FOR PFIX REQUEST AFTER SCAN VISTAB         @D149DJB 00519000
***************************************************************@D149DJB 00520000
         LTR   R3,R3              MORE THAN ONE PAGE AFFECTED? @D14CDJB 00521000
         BZ    GVPFIXOP           NO  ===>                     @D14CDJB 00522000
***************************************************************         00523000
*  SEE IF FIRST PAGE IS ALREADY FIXED                          @DA36550 00524000
***************************************************************         00525000
         USING SUBPCHN,R4                                      @D14CDJB 00526000
         TM    SPCHFLAG,SPPGPFIX  FIRST PAGE ALREADY PFIXED ?  @D14CDJB 00527000
         BNO   GVPFIX1            NO  ===>                     @DA36550 00528000
         BCTR  R3,0               DECREASE NO. OF PAGES        @DA36550 00529000
         L     R4,SPCHFORW        NEXT PAGE MUST BE FIXED      @DA36550 00530000
         DROP  R4                                              @D14CDJB 00531000
         A     R0,PAGESIZE        START FIXING ON              @DA36550 00532000
         SRL   R0,PNSHIFT         NEXT PAGE                    @DA36550 00533000
         SLL   R0,PNSHIFT         BOUNDARY                     @DA36550 00534000
         LTR   R3,R3              MORE THAN ONE PAGE AFFECTED? @DA36550 00535000
         BZ    GVPFIXOP           NO  ===>                     @DA36550 00536000
GVPFIX1  EQU   *                                               @DA36550 00537000
***************************************************************         00538000
*  SEE IF LAST PAGE IS ALREADY FIXED                           @DA36550 00539000
***************************************************************         00540000
         USING SUBPCHN,R2                                      @DA36550 00541000
         TM    SPCHFLAG,SPPGPFIX  LAST PAGE ALREADY FIXED ?    @DA36550 00542000
         DROP  R2                                              @DA36550 00543000
         BNO   GVPFIXPM           NO ===>                      @DA36550 00544000
         SRL   R1,PNSHIFT         ADDRESS OF LAST BYTE         @DA36550 00545000
         SLL   R1,PNSHIFT         ON PREVIOUS                  @DA36550 00546000
         BCTR  R1,0               PAGE                         @DA36550 00547000
         BCTR  R3,0               NO. OF PAGES TO BE FIXED     @DA36550 00548000
         B     GVPFIXPM           FIX PAGES                    @DA36550 00549000
***************************************************************@D149DJB 00550000
*  ONLY ONE PAGE AFFECTED BY PFIX REQUEST                      @D149DJB 00551000
***************************************************************@D149DJB 00552000
GVPFIXOP EQU   *                                               @D14CDJB 00553000
         USING SUBPCHN,R4                                      @D14CDJB 00554000
         TM    SPCHFLAG,SPPGPFIX  PAGE ALREADY PFIXED ?        @D14CDJB 00555000
         DROP  R4                                              @D14CDJB 00556000
         BOR   R7                 YES, RETURN                  @D64ADKH 00557000
***************************************************************@D149DJB 00558000
*  PFIX NECESSARY, SET PFIX PENDING FOR SUBPOOL                @D149DJB 00559000
***************************************************************@D149DJB 00560000
GVPFIXPM EQU   *                                               @D14CDJB 00561000
         L     R8,SPIDSAV         GET PTR TO SUBP. INDEX TABLE @D52VDKH 00562000
         USING SUBPINT,R8                                      @D51IDMZ 00563000
         ST    R8,SSPPTRCI        SAVE PTR                     @D52VDMZ 00564000
         OI    SPITFLAG,SPPFXPND  INDICATE PFIX PENDING        @D51IDMZ 00565000
         MVC   SVPFSPID,SSPNPTR   SAVE SUBPOOL POINTER         @D52VDKH 00566000
         MVC   SVPFR1,ADDRSAV     SAVE USER'S ADDRESS          @D52VDKH 00567000
         ST    RF,SPIDSAV         MUST BE CLEARED FOR FREEVIS  @KD40203 00568000
         MVC   SAVRQST,GMFMRQST        SAVE REQUEST RELATED..  @D64ADKH 00569000
         MVC   SMAXGAP,MAXGAP          .VALUES (MAYBE DESTROY.)@D64ADMZ 00570000
         MVC   SMAXGAP_ABV,MAXGAP_ABV  .SINCE GETVIS GATE IS.. @D64ADMZ 00571000
         MVC   SMAXGAP_BDY,MAXGAP_BDY  .OPENED DURING PFIX     @D64ADMZ 00572000
         MVI   GMFMRQST,X'00'                                  @D64ADKH 00573000
         DROP  R8                 SUBPOOL INDEX TABLE          @D51IDMZ 00574000
***************************************************************@D149DJB 00575000
*  NOW PFIX PAGE(S)                                            @D149DJB 00576000
***************************************************************@D149DJB 00577000
*SGLINK  GFSFIXSB,INPUT=(R0,R1,R6,R8:LINK,RC,RD,RF),OUTPUT=(RF),       *00578000
               NOMODR=(R3,R4,R6,R7,RA-RC,RD),AMODE=31                   00579000
         SGAMSUBR SUBROUT=GFSFIXSB,                            @D14CDJB*00580000
               INPUT=(R0,R1,R6,RC,RD),                         @D52VDMZ*00581000
               OUTPUT=(RF),                                    @D14CDJB*00582000
               NOMOD=(R3,R4,R6,R7,RB,RC,RD),                   @D52VDMZ*00583000
               LINK=(R8),         PFIX PAGES                   @D14CDJB*00584000
               CBASE=GVSUBR                                    @D51IDMZ 00585000
*                                                                       00586000
*  SWITCH CI TO WAS IT WAS BEFORE OPENING THE GATE                      00587000
*                                                                       00588000
         LR    R2,RB              SAVE RB                      @D52VDMZ 00589000
         LR    R8,R7              SAVE LINK REGISTER           @D52VDMZ 00590000
         LA    RB,2                                            @D52VDKH 00591000
*SGLINK  GTVSINI2,INPUT=(R7:LINK,RB,RC,RD),                            *00592000
               NOMODR=(R2,R3,R4,R6,R8,RA,RC,RD,RF),AMODE=31             00593000
         SGAMSUBR SUBROUT=GTVSINI2,                            @D14CDJB*00594000
               INPUT=(RB,RC,RD,RE),                            @D52VDMZ*00595000
               NOMOD=(R2,R3,R4,R6,R8,RA,RC,RD,RF),             @D52VDMZ*00596000
               IGN=(RB),                                       @D52VDMZ*00597000
               LINK=(R7),                                      @D14CDJB*00598000
               CBASE=GVSUBR       INITIALIZE GETVIS AREA       @D52VDMZ 00599000
* SWITCH SUBPOOL TOO                                                    00600000
         L     R5,SSPPTRCI        GET PTR TO SP INDEX TABLE    @D52VDMZ 00601000
         LA    RB,3                                            @D52VDKH 00602000
*SGLINK  GTVSINI3,INPUT=(R5,R7:LINK,RB,RC),                            *00603000
               NOMODR=(R2,R3,R4,R5,R6,R8,RA,RC,RD,RF),AMODE=31          00604000
         SGAMSUBR SUBROUT=GTVSINI3,                            @D14CDJB*00605000
               INPUT=(R5,RB,RC,RE),                            @D52VDMZ*00606000
               NOMOD=(R2,R3,R4,R5,R6,R8,RA,RC,RD,RF),          @D52VDMZ*00607000
               IGN=(RB),                                       @D52VDMZ*00608000
               LINK=(R7),                                      @D14CDJB*00609000
               CBASE=GVSUBR       INITIALIZE GETVIS AREA       @D52VDMZ 00610000
         LR    RB,R2              RESTORE RB                   @D52VDMZ 00611000
         LR    R7,R8              RESTORE LINK REGISTER        @D52VDMZ 00612000
         MVC   SSPNPTR,SVPFSPID   REST. SP PTR IN USER'S AREA  @D52VDKH 00613000
         MVC   ADDRSAV,SVPFR1     RESTORE  USER'S ADDRESS      @D52VDKH 00614000
         ST    R5,SPIDSAV         STORE IT                     @D52VDMZ 00615000
         USING SUBPINT,R5                                      @D52VDMZ 00616000
         NI    SPITFLAG,X'FF'-SPPFXPND RESET PFIX PENDING      @D52VDKH 00617000
         MVC   GMFMRQST,SAVRQST      RESTORE REQUEST..         @D64ADKH 00618000
         MVC   MAXGAP,SMAXGAP          .. RELATED VALUES..     @D64ADMZ 00619000
         MVC   MAXGAP_ABV,SMAXGAP_ABV  .. AS THEY WERE BEFORE. @D64ADMZ 00620000
         MVC   MAXGAP_BDY,SMAXGAP_BDY  ... PFIX PROCESSING     @D64ADMZ 00621000
         DROP  R5                 SUBPOOL INDEX TABLE          @D52VDKH 00622000
         LTR   RF,RF              DID FIXING WORK ?            @D14CDJB 00623000
         BNZR  R7                 NO, RETURN                   @D64ADKH 00624000
***************************************************************@D149DJB 00625000
*  SET PFIX BIT IN CORRESPONDING CHAIN TABLE ENTRIES           @D149DJB 00626000
***************************************************************@D149DJB 00627000
         LA    R3,D1(R3)          SET PAGE COUNTER             @D14CDJB 00628000
GTVSPFLP EQU   *                                               @D14CDJB 00629000
         USING SUBPCHN,R4                                      @D14CDJB 00630000
         OI    SPCHFLAG,SPPGPFIX  INDICATE PAGE AS PFIXED      @D14CDJB 00631000
         LA    R4,SUBPCHNL(R4)    GOTO NEXT CHAIN ENTRTY       @D14CDJB 00632000
         BCT   R3,GTVSPFLP        ===> REPEAT INDICATION       @D14CDJB 00633000
         DROP  R4                                              @D14CDJB 00634000
***************************************************************@D149DJB 00635000
*  RETURN                                                               00636000
***************************************************************@D149DJB 00637000
         BR    R7                 ===> RETURN TO CALLER        @D14CDJB 00638000
         DROP  RC,RD                                           @D14CDJB 00639000
         EJECT                                                 @D14CDJB 00640000
***************************************************************@D149DJB 00641000
*                                                              @D149DJB 00642000
*   ROUTINE TO CHECK FOR EMPTY PAGE(S) WITHIN ONE SUBPOOL .    @D149DJB 00643000
*                                                              @D149DJB 00644000
*   MODULE FVCHKEPG                                            @D149DJB 00645000
*       IF FIRST PAGE IS NOT EMPTY                             @D149DJB 00646000
*         THEN IF ONLY ONE PAGE TO BE HANDLED                  @D149DJB 00647000
*                THEN GOTO FVCHKUPD                            @D51XDMZ 00648000
*         ELSE SKIP FIRST PAGE POINTER TO NEXT PAGE            @D149DJB 00649000
*       ELSE                                                   @D149DJB 00650000
*          IF ONLY ONE PAGE TO BE HANDLED                      @D51XDMZ 00651000
*                THEN GOTO FVCHKUPD                            @D149DJB 00652000
*       IF LAST PAGE IS NOT EMPTY                              @D149DJB 00653000
*         THEN IF NO PAGES INBETWEEN                           @D149DJB 00654000
*                THEN GOTO FVCHKUPD                            @D149DJB 00655000
*         ELSE SKIP LAST PAGE POINTER TO ONE PAGE BEFORE       @D149DJB 00656000
*       LABEL : FVPGEMPT                                       @D149DJB 00657000
*       EXECUTE GFENQDEQ                                       @D149DJB 00658000
*       LABEL : FVCHKUPD                                       @D51XDMZ 00659000
*       EXECUTE FVUPCPTR   (ROUTINE TO UPDATE CURRENT POINTER) @D51XDMZ 00660000
*       EXECUTE FVPGMR                                         @D149DJB 00661000
*   ENDMODULE FVCHKEPG                                         @D149DJB 00662000
*                                                              @D149DJB 00663000
*     CALLED BY : FREEVIS                                      @D149DJB 00664000
*     CALLS     : GFENQDEQ FVUPCPTR FVPGMR                     @D51XDMZ 00665000
*                                                              @D149DJB 00666000
*     INPUT  : RA  :  TCBPTR                                   @D52VDMZ 00667000
*              RB  :  SYSTEM/PARTITION/SPACE FREEVIS INDICATOR @D149DJB 00668000
*              RC --> ANCHOR TABLE                             @D149DJB 00669000
*              RD --> REQUESTOR SAVE AREA                      @D149DJB 00670000
*              RF  :  0                                        @D149DJB 00671000
*     OUTPUT : RF  :  0                                        @D149DJB 00672000
*     LINK   : R7                                              @D149DJB 00673000
*     WORK   : R2,R3,R4,R5,R8,R9                               @D149DJB 00674000
*              R0,R1  (USED IN CALLED ROUTINES)                @D52VDMZ 00675000
*                                                              @D149DJB 00676000
         AGO    .CREATEM                                       @D14ZDJB 00677000
.FVCHKEP ANOP                                                  @D14ZDJB 00678000
.*             0123456789ABCDEF                                @D149DJB 00679000
&INPREG  SETC '0000000000111111'                               @D14ZDJB 00680000
&OUTREG  SETC '0000000000000001'                               @D14ZDJB 00681000
&WRKREG  SETC '1111110011000000'                               @D52VDMZ 00682000
&NMDREG  SETC '0000001100111110'                               @D52VDMZ 00683000
&LINKR   SETC 'R7'                                             @D14ZDJB 00684000
&TBASE   SETC 'GVSUBR'                                         @D51IDMZ 00685000
.*EXCLSYMS=(SAVREG3,SAVREG9,SAVREG2)                           @D52VDMZ 00686000
         AGO    .TESTALL                                       @D14ZDJB 00687000
.CREATEM ANOP                                                  @D14ZDJB 00688000
***************************************************************@D149DJB 00689000
         SPACE 2                                               @D14CDJB 00690000
         USING ANCHTAB,RC                                      @D14CDJB 00691000
         USING SVEARA,RD                                       @D14CDJB 00692000
         USING SUBPINT,R5                                      @D51XDMZ 00693000
FVCHKEPG DS    0H                                              @D14CDJB 00694000
*SGLINK  FVCHKEPG,S,INPUT=(R7:LINK,RA,RB,RC,RD,RF),OUTPUT=(RF),        *00695000
               WORK=(R0-R3,R4,R5,R8,R9,RE,RF),AMODE=31,                *00696000
               NOMODR=(R7),                                            *00697000
               MODSYM=(SAVREG3,SAVREG9,SAVREG2),                       *00698000
               SUBROUT=(GFENQDEQ,FVUPCPTR,FVPGMR,GVFVMIR1)              00699000
         L     R3,SVER01          GET START ADDRESS            @D14CDJB 00700000
         S     R3,BVIRTMEM        GET RELATIVE START ADDRESS   @D14CDJB 00701000
         L     R9,SVER00          GET LENGTH                   @D14CDJB 00702000
         BCTR  R9,0               MINUS ONE                    @D14CDJB 00703000
         AR    R9,R3              GET RELATIVE END ADDRESS     @D14CDJB 00704000
         SRL   R9,PNSHIFT         GET RELATIVE END PAGE #      @D14NDJB 00705000
         SLL   R9,SUBPCHN2        GET RELATIVE END CHAIN ENTRY @D14CDJB 00706000
         A     R9,BSUBPCHN        GET LAST CHAIN ENTRY ADDRESS @D14CDJB 00707000
         SRL   R3,PNSHIFT         GET RELATIVE START PAGE #    @D14NDJB 00708000
         SLL   R3,SUBPCHN2        GET REL. START CHAIN ENTRY   @D14CDJB 00709000
         A     R3,BSUBPCHN        GET CHAIN ENTRY ADDRESS      @D14CDJB 00710000
         ST    R3,SAVREG3         R3 MIGHT BE CHANGED LATERON  @D51XDMZ 00711000
         ST    R9,SAVREG9         R9 MIGHT BE CHANGED LATERON  @D51XDMZ 00712000
         USING SUBPCHN,R3                                      @D14CDJB 00713000
         L     R2,SPCHBACK        SAVE BACKWARD PTR OF..       @D51XDMZ 00714000
         ST    R2,SAVREG2         .. FIRST PAGE                @D51XDMZ 00715000
***************************************************************@D51XDMZ 00716000
*    GET SUBPOOL INDEX TABLE ENTRY WHERE PAGES BELONG TO       @D51XDMZ 00717000
***************************************************************@D51XDMZ 00718000
         L     R5,SPIDSAV         GET ENTRY IN INDEX TABLE     @D52VDMZ 00719000
         DROP  R3                                              @D14CDJB 00720000
***************************************************************@D149DJB 00721000
*    CHECK IF FIRST PAGE IS EMPTY                              @D149DJB 00722000
***************************************************************@D149DJB 00723000
         USING SUBPCHN,R3                                      @D14CDJB 00724000
         L     R4,SPCHVSTB        GET REL. PAGE VISTAB PTR     @D51IDMZ 00725000
         A     R4,BVISTAB         GET PAGE VISTAB POINTER      @D14CDJB 00726000
         LTR   RB,RB              SVA OR SPACE REQUEST ?       @D51IDKH 00727000
         BNZ   FVCHKSVA           YES ===>                     @D14CDJB 00728000
         C&H   RF,D0(R4)          PARTITION PAGE EMPTY         @D14CDJB 00729000
         BE    FVFSTEMP           YES ===>                     @D14CDJB 00730000
         B     FVCHKFNE           NO  ===>                     @D14CDJB 00731000
FVCHKSVA EQU   *                                               @D14CDJB 00732000
         LA    R2,SVBYTPPG/4      GET NUMBER OF FULLWORDS      @D14CDJB 00733000
FVCHKSVB EQU   *                                               @D14CDJB 00734000
         C     RF,D0(R4)          VISTAB BYTES ZERO ?          @D14CDJB 00735000
         BNE   FVCHKFNE           NO  ===>                     @D14CDJB 00736000
         LA    R4,D4(R4)          GOTO NEXT 4 VISTAB BYTES     @D14CDJB 00737000
         BCT   R2,FVCHKSVB        ===> CONTINUE CHECK          @D14CDJB 00738000
FVFSTEMP DS    0H                 FIRST PAGE EMPTY             @D14CDJB 00739000
         OI    SPITFLG1,SPFPEMTY  INDICATE FIRST PAGE EMPTY    @D51XDMZ 00740000
         OI    SPITFLG1,SPLPEMTY  MIGHT BE RESET AGAIN         @D51XDMZ 00741000
         CR    R3,R9              ONLY ONE PAGE TO BE TESTED ? @D14CDJB 00742000
         BE    FVPGEMPT           YES ===>                     @D14CDJB 00743000
         B     FVCHKLST           ===> CHECK LAST ENTRY        @D14CDJB 00744000
FVCHKFNE DS    0H                 FIRST PAGE NOT EMPTY         @D14CDJB 00745000
         CR    R3,R9              ONLY ONE PAGE TO BE TESTED ? @D14CDJB 00746000
         BE    FVCHKUPD           YES => UPDATE CURRENT POINTER@D51XDMZ 00747000
         OI    SPITFLG1,SPLPEMTY  MIGHT BE RESET AGAIN         @D51XDMZ 00748000
         L     R3,SPCHFORW        GOTO NEXT CHAIN ENTRY        @D14CDJB 00749000
         DROP  R3                                              @D14CDJB 00750000
***************************************************************@D149DJB 00751000
*    CHECK IF LAST PAGE IS EMPTY                               @D149DJB 00752000
***************************************************************@D149DJB 00753000
FVCHKLST EQU   *                                               @D14CDJB 00754000
         USING SUBPCHN,R9                                      @D14CDJB 00755000
         L     R4,SPCHVSTB        GET REL. PAGE VISTAB PTR     @D51IDMZ 00756000
         A     R4,BVISTAB         GET PAGE VISTAB POINTER      @D14CDJB 00757000
         DROP  R9                                              @D14CDJB 00758000
         LTR   RB,RB              SVA OR SPACE REQUEST ?       @D51IDKH 00759000
         BNZ   FVCHKSVC           YES ===>                     @D14CDJB 00760000
         C&H   RF,D0(R4)          PARTITION PAGE EMPTY         @D14CDJB 00761000
         BE    FVPGEMPT           YES ===>                     @D14CDJB 00762000
         B     FVCHKLNE           NO  ===>                     @D14CDJB 00763000
FVCHKSVC EQU   *                                               @D14CDJB 00764000
         LA    R2,SVBYTPPG/4      GET NUMBER OF FULLWORDS      @D14CDJB 00765000
FVCHKSVD EQU   *                                               @D14CDJB 00766000
         C     RF,D0(R4)          VISTAB BYTES ZERO ?          @D14CDJB 00767000
         BNE   FVCHKLNE           NO  ===>                     @D14CDJB 00768000
         LA    R4,D4(R4)          GOTO NEXT 4 VISTAB BYTES     @D14CDJB 00769000
         BCT   R2,FVCHKSVD        ===> CONTINUE CHECK          @D14CDJB 00770000
         B     FVPGEMPT           ===> LAST PAGE IS EMPTY      @D14CDJB 00771000
FVCHKLNE DS    0H                 LAST PAGE NOT EMPTY          @D14CDJB 00772000
         NI    SPITFLG1,XFF-SPLPEMTY RESET LAST PAGE EMPTY IND.@D51XDMZ 00773000
         CR    R3,R9              PAGE(S) IN BETWEEN ?         @D14CDJB 00774000
         BE    FVCHKUPD           NO => UPDATE CURRENT POINTER @D51XDMZ 00775000
         LA    R2,SUBPCHNL        GET CHAIN ENTRY LENGTH       @D14CDJB 00776000
         SR    R9,R2              BUMP TO ENTRY BEFORE LAST    @D14CDJB 00777000
***************************************************************@D149DJB 00778000
*    ENQUEUE/DEQUEUE PAGES                                     @D149DJB 00779000
***************************************************************@D149DJB 00780000
FVPGEMPT DS    0H                                              @D14CDJB 00781000
         OI    SPITFLG1,SPCLPMR   INDICATE PMR TO BE CALLED    @D51XDMZ 00782000
         LA    R2,FIRSTPNT-(SPITFRST-SUBPINT)  GET DUMMY INDEX @D14CDJB 00783000
*                                      TABLE ENTRY FOR ENQUEUE @D149DJB 00784000
         LR    R4,R9              GET END OF CHAIN             @D14CDJB 00785000
         SR    R4,R3              MINUS START                  @D14CDJB 00786000
         SRL   R4,SUBPCHN2        NUMBER OF PAGES              @D14CDJB 00787000
         LA    R4,D1(R4)                      TO DEQUEUE       @D14CDJB 00788000
*SGLINK  GFENQDEQ,INPUT=(R2,R3,R4,R5,R8:LINK,R9,RC),OUTPUT=(RF),       *00789000
               NOMODR=(R3,R5,R6,R7,R9,RA-RC,RD),AMODE=31,              *00790000
               NOMODS=(SAVREG3,SAVREG9,SAVREG2)                         00791000
         SGAMSUBR SUBROUT=GFENQDEQ,                            @D14CDJB*00792000
               INPUT=(R2,R3,R4,R5,R9,RC),                      @D14CDJB*00793000
               OUTPUT=(RF),                                    @D51XDMZ*00794000
               NOMOD=(R3,R5,R6,R7,R9,RB,RC,RD),                @D14CDJB*00795000
               NOMODS=(SAVREG3,SAVREG9,SAVREG2),               @D52VDMZ*00796000
               LINK=(R8),         ENQUEUE AND DEQUEUE PAGE(S)  @D14CDJB*00797000
               CBASE=GVSUBR                                    @D51IDMZ 00798000
FVCHKUPD DS    0H                 UPDATE CURRENT POINTER       @D51XDMZ 00799000
*SGLINK  FVUPCPTR,INPUT=(R5,R8:LINK,RB,RC),OUTPUT=(RF),                *00800000
               NOMODR=(R3,R5,R6,R7,R9,RA,RB,RC,RD),AMODE=31             00801000
         SGAMSUBR SUBROUT=FVUPCPTR,                            @D51XDMZ*00802000
               INPUT=(R5,RB,RC,RE),                            @D51XDMZ*00803000
               NOMOD=(R3,R5,R6,R7,R9,RA,RB,RC,RD),             @D52VDMZ*00804000
               OUTPUT=(RF),                                    @D51XDMZ*00805000
               LINK=(R8),         UPDATE CURRENT POINTER       @D51XDMZ*00806000
               CBASE=GVSUBR                                    @D51XDMZ 00807000
         TM    SPITFLG1,SPCLPMR   PMR TO BE CALLED             @D51XDMZ 00808000
         BZ    FVCHK200           NO, CLEAR NOT EMPTY PAGES    @D52VDMZ 00809000
*SGLINK  FVPGMR,INPUT=(R3,R4:LINK,R5,R9,RA,RB,RC,RD),OUTPUT=(RF),      *00810000
               NOMODR=(R5,R6,R7,RA-RD),AMODE=31                         00811000
         SGAMSUBR SUBROUT=FVPGMR,                              @D14CDJB*00812000
               INPUT=(R3,R5,R9,RA,RB,RC,RD),                   @D14NDJB*00813000
               NOMOD=(R5,R6,R7,RD),                            @D52VDMZ*00814000
               OUTPUT=(RF),                                    @D52VDMZ*00815000
               LINK=(R4),         GOTO PAGE MGR IF NECCESSARY  @D14CDJB*00816000
               CBASE=GVSUBR                                    @D51IDMZ 00817000
         TM    SPITFLG1,SPFPEMTY+SPLPEMTY BOTH FIRST AND LAST  @D52VDMZ 00818000
         BO    FVCHK500           PAGE EMPTY => RETURN         @D52VDMZ 00819000
FVCHK200 DS    0H                 FIRST,LAST OR BOTH PAGES ARE @D52VDMZ*00820000
                                  NOT EMPTY, SAVREG9 NO LONGER VALID    00821000
         L     R2,SVER01          GET BEGIN ADDR               @D52VDMZ 00822000
         L     R3,SVER00          GET LENGTH                   @D52VDMZ 00823000
         BCTR  R3,0               LENGTH MINUS ONE             @D52VDKH 00824000
         SRL   R3,LDVBYTBI(RB)    ROUND UP LENGTH              @D52VDMZ 00825000
         LA    R3,D1(R3)                 TO MULTIPLE           @D52VDMZ 00826000
         SLL   R3,LDVBYTBI(RB)             OF STORAGE UNITS    @D52VDMZ 00827000
         LR    R4,R3                                           @D52VDMZ 00828000
         AR    R4,R2              R4 = END ADDRESS+1           @D52VDKH 00829000
         TM    SPITFLG1,SPFPEMTY  FIRST PAGE EMPTY             @D52VDMZ 00830000
         BO    FVCHK400           YES => CLEAR LAST PAGE       @D52VDMZ 00831000
         TM    SPITFLG1,SPCLPMR   FREE PAGES IN BETWEEN        @D52VDMZ 00832000
         BZ    FVCHK450           NO, FIRST AND LAST ARE CONT. @D52VDMZ 00833000
         LR    R3,R2              CLEAR FROM BEGIN TILL END..  @D52VDMZ 00834000
         SRL   R3,PNSHIFT           .. OF                      @D52VDMZ 00835000
         LA    R3,1(,R3)               .. PAGE                 @D52VDMZ 00836000
         SLL   R3,PNSHIFT         R3 = NEXT PAGE BOUNDARY      @D52VDMZ 00837000
         SR    R3,R2              R3 = BYTES TO BE CLEARED     @D52VDMZ 00838000
         TM    GVFVFLGS,GVFVABVE  REQUEST FOR ABOVE            @@@@@@KH 00839000
         BZ    FVCHK350           NO,  DO NOT MIRROR           @@@@@@KH 00840000
         LR    R1,R3              GET LENGTH                   @@@@@@KH 00841000
*SGLINK  GVFVMIR1,INPUT=(R1,RB,RC,RD),OUTPUT=(R1),                     *00842000
               NOMODR=(R2,R3,R4,R5,R6,R7,R8,R9,RA,RB,RC,RD,RE),AMODE=31 00843000
         SGAMSUBR SUBROUT=GVFVMIR1, RE-MIRROR RETURNED ADDRESS @D52VDKH*00844000
               INPUT=(R1,RB,RC,RD),                            @D52VDKH*00845000
               OUTPUT=(R1),                                    @D52VDKH*00846000
               NOMOD=(R2,R3,R4,R5,R6,R7,R8,R9,RA,RB,RC,RD,RE), @D52VDKH*00847000
               LINK=(INLINE)                                   @D52VDKH 00848000
         LR    R2,R1              BEGIN ADDRESS (MIRRORED)     @D52VDMZ 00849000
FVCHK350 DS    0H                                              @D52VDMZ 00850000
         SR    R8,R8              CLEAR FOR .....              @D52VDMZ 00851000
         LR    R9,R8                ... MVCL                   @D52VDMZ 00852000
         MVCL  R2,R8              CLEAR FIRST PAGE PORTION     @D52VDMZ 00853000
         TM    SPITFLG1,SPLPEMTY  LAST PAGE EMPTY              @D52VDMZ 00854000
         BO    FVCHK500                                        @D52VDMZ 00855000
FVCHK400 DS    0H                 CLEAR AREA IN LAST PAGE      @D52VDMZ 00856000
         LR    R2,R4              CLEAR FROM BEGIN OF PAGE..   @D52VDMZ 00857000
         BCTR  R2,0               .. TIL END OF AREA           @D52VDMZ 00858000
         SRL   R2,PNSHIFT         CALCULATE BEGIN ..           @D52VDMZ 00859000
         SLL   R2,PNSHIFT              .. OF PAGE              @D52VDMZ 00860000
         LR    R3,R4              CALCULATE LENGTH =           @D52VDMZ 00861000
         SR    R3,R2              .. END ADDR+1 - BEGIN ADDR   @D52VDMZ 00862000
FVCHK450 DS    0H                 CLEAR AREA                   @D52VDMZ 00863000
         TM    GVFVFLGS,GVFVABVE  REQUEST FOR ABOVE            @@@@@@KH 00864000
         BZ    FVCHK550           NO, DO NOT MIRROR            @@@@@@KH 00865000
         L     R8,SVER01          SAVE SVER01                  @D61NDMZ 00866000
         ST    R2,SVER01          STORE MODIFIED BEGIN ADDRESS @D61NDMZ 00867000
         LR    R1,R3              GET LENGTH                   @@@@@@KH 00868000
*SGLINK  GVFVMIR1,INPUT=(R1,RB,RC,RD),OUTPUT=(R1),                     *00869000
               NOMODR=(R2,R3,R4,R5,R6,R7,R8,R9,RA,RB,RC,RD,RE),AMODE=31 00870000
         SGAMSUBR SUBROUT=GVFVMIR1, RE-MIRROR RETURNED ADDRESS @D52VDKH*00871000
               INPUT=(R1,RB,RC,RD),                            @D52VDKH*00872000
               OUTPUT=(R1),                                    @D52VDKH*00873000
               NOMOD=(R2,R3,R4,R5,R6,R7,R8,R9,RA,RB,RC,RD,RE), @D52VDKH*00874000
               LINK=(INLINE)                                   @D52VDKH 00875000
         LR    R2,R1              BEGIN ADDRESS (MIRRORED)     @D52VDMZ 00876000
         ST    R8,SVER01          SET SVER01 TO ORIGINAL ADDR  @D61NDMZ 00877000
FVCHK550 DS    0H                                              @D52VDMZ 00878000
         SR    R8,R8              PREPARE FOR ...              @D52VDMZ 00879000
         LR    R9,R8                ... MVCL                   @D52VDMZ 00880000
         MVCL  R2,R8                                           @D52VDMZ 00881000
FVCHK500 DS    0H                 DONE                         @D52VDMZ 00882000
         NI    SPITFLG1,XFF-SPFPEMTY-SPLPEMTY-SPCLPMR RESET    @D51XDMZ 00883000
*                                 INDICATION                   @D51XDMZ 00884000
         BR    R7                 ===> RETURN TO CALLER        @D14CDJB 00885000
         DROP  RC,RD                                           @D14CDJB 00886000
         DROP  R5                                              @D51XDMZ 00887000
         EJECT                                                 @D14CDJB 00888000
***************************************************************@D149DJB 00889000
*                                                              @D149DJB 00890000
*   ROUTINE TO CALL THE PAGE MANAGER FOR EMPTY PARTITION       @D149DJB 00891000
*     SVA / SPACE PAGES                                        @D149DJB 00892000
*                                                              @D149DJB 00893000
*   MODULE FVPGMR                                              @D149DJB 00894000
*      IF SVA/SPACE REQUEST THEN                               @D149DJB 00895000
*        DO                                                    @D149DJB 00896000
*              IF SUBPOOL FETCHPROTECTED OR PAGES PFIXED       @DA36550 00897000
*                 OR SUBPOOL PART.KEY PROTECTED                @D51IDMZ 00898000
*                    THEN                                      @DA36550 00899000
*                     DO                                       @DA36550 00900000
*                       EXECUTE GFSETKEY                       @DA36550 00901000
*                       EXIT FVPGMR                            @D149DJB 00902000
*                     END                                      @DA36550 00903000
*        END                                                   @D149DJB 00904000
*      EXECUTE FVFREPDS                                        @D149DJB 00905000
*      EXIT FVPGMR                                             @D149DJB 00906000
*   ENDMODULE FVPGMR                                           @D149DJB 00907000
*                                                              @D149DJB 00908000
*     CALLED BY : FVSBPOOL  FVCHKEPG                           @D149DJB 00909000
*     CALLS     : FVFREPDS  GFSETKEY                           @DA36550 00910000
*                                                              @D149DJB 00911000
*     INPUT  : R3 --> CHAIN TABLE ENTRY TO FIRST PAGE          @D149DJB 00912000
*                                            TO BE HANDLED     @D149DJB 00913000
*              R5 --> SUBPOOL INDEX TABLE ENTRY                @D149DJB 00914000
*              R9 --> CHAIN TABLE ENTRY TO LAST PAGE           @D149DJB 00915000
*                                            TO BE HANDLED     @D149DJB 00916000
*              RB  :  SYSTEM/SPACE/PARTITION FREEVIS INDICATOR @D51IDMZ 00917000
*              RC --> ANCHOR TABLE (VISTAB)                    @D149DJB 00918000
*              RD --> REQUESTOR SAVE AREA                      @D149DJB 00919000
*     OUTPUT : RF = 0                                          @D149DJB 00920000
*     LINK   : R4                                              @D149DJB 00921000
*     WORK   : R0,R1,R2,R8                                     @D52VDMZ 00922000
*              R9 (IN CALLED ROUTINE)                          @D52VDMZ 00923000
*                                                              @D149DJB 00924000
         AGO    .CREATE1                                       @D14ZDJB 00925000
.FVPGMR  ANOP                                                  @D14ZDJB 00926000
.*             0123456789ABCDEF                                @D149DJB 00927000
&INPREG  SETC '0001010001111100'                               @D14NDJB 00928000
&OUTREG  SETC '0000000000000001'                               @D14ZDJB 00929000
&WRKREG  SETC '1111000011000000'                               @D52VDMZ 00930000
&NMDREG  SETC '0000111100111110'                               @D52VDMZ 00931000
&LINKR   SETC 'R4'                                             @D14ZDJB 00932000
&TBASE   SETC 'GVSUBR'                                         @D51IDMZ 00933000
.*EXCLSYMS=()                                                  @D52VDMZ 00934000
         AGO    .TESTALL                                       @D14ZDJB 00935000
.CREATE1 ANOP                                                  @D14ZDJB 00936000
***************************************************************@D149DJB 00937000
         SPACE 2                                               @D14CDJB 00938000
         USING ANCHTAB,RC                                      @D14CDJB 00939000
FVPGMR   DS    0H                                              @D14CDJB 00940000
*SGLINK  FVPGMR,S,INPUT=(R3,R4:LINK,R5,R9,RA,RB,RC,RD),OUTPUT=(RF),    *00941000
               WORK=(R0,R1-R3,R8,R9,RE),NOMODR=(R4),                   *00942000
               AMODE=31,SUBROUT=(GFSTKEYP,FVFREPDS)                     00943000
         LR    R0,R3              GET ENTRY                    @D14CDJB 00944000
         S     R0,BSUBPCHN                  OFFSET             @D14CDJB 00945000
         SRL   R0,SUBPCHN2        GET PAGE NUMBER              @D14CDJB 00946000
         SLL   R0,PNSHIFT         GET RELATIVE PAGE ADDRESS    @D14NDJB 00947000
         A     R0,BVIRTMEM        GET START ADDRESS            @D14CDJB 00948000
         LR    R1,R9              GET ENTRY                    @D14CDJB 00949000
         S     R1,BSUBPCHN                  OFFSET             @D14CDJB 00950000
         SRL   R1,SUBPCHN2        GET PAGE NUMBER              @D14CDJB 00951000
         SLL   R1,PNSHIFT         GET RELATIVE END ADDRESS     @D14NDJB 00952000
         A     R1,BVIRTMEM        GET                          @D14CDJB 00953000
         A     R1,PAGESIZE            END                      @D14CDJB 00954000
         BCTR  R1,0                       ADDRESS              @D14CDJB 00955000
         LA    R2,0                                            @D64ADKH 00956000
         LTR   RB,RB              PARTITION REQUEST ?          @D51IDKH 00957000
         BZ    FVPGFCHP           YES ===>                     @D64ADKH 00958000
***************************************************************@D149DJB 00959000
*  HANDLING FOR SVA OR SPACE REQUEST                           @D149DJB 00960000
***************************************************************@D149DJB 00961000
         LR    R8,R3              SAVE START POINTER           @D14CDJB 00962000
***************************************************************@D149DJB 00963000
*  RESET PFIX BIT IN CORRESPONDING CHAIN TABLE ENTRIES         @D149DJB 00964000
***************************************************************@D149DJB 00965000
         USING SUBPCHN,R8                                      @D14CDJB 00966000
FVPGMPFL EQU   *                                               @D14CDJB 00967000
         TM    SPCHFLAG,SPPGPFIX  THIS PAGE FIXED ?            @D14CDJB 00968000
         BNO   FVPGMPNF           NO  ===>                     @D14CDJB 00969000
         NI    SPCHFLAG,XFF-SPPGPFIX  IND. PAGE AS NOT PFIXED  @D14CDJB 00970000
         LA    R2,D4              GET PFREE INDICATOR          @D14CDJB 00971000
FVPGMPNF EQU   *                                               @D14CDJB 00972000
         CR    R8,R9              LAST PAGE REACHED ?          @D14CDJB 00973000
         L     R8,SPCHFORW        GOTO NEXT PAGE               @D14CDJB 00974000
         BNE   FVPGMPFL           NO  ===> REPEAT SEARCH       @D14CDJB 00975000
         DROP  R8                                              @D14CDJB 00976000
         LTR   R2,R2              ANY PAGE PFIXED ?            @D14CDJB 00977000
         LA    R2,0                                            @D64ADKH 00978000
         BNZ   FVPGMINV           YES =>                       @D14CDJB 00979000
FVPGFCHP EQU   *                                               @DA36550 00980000
         USING SUBPINT,R5                                      @D14CDJB 00981000
         TM    SPITFLAG,SPPKEYPR  SUBPOOL KEY-PROTECTED ?      @D51IDKH 00982000
         BO    FVPGMINV_1         YES, UNDO PROTECTION         @D51IDKH 00983000
         TM    SPITFLAG,SPFTCHPR  IS SUBPOOL FETCH PROTECTED ? @D14CDJB 00984000
         BNO   FVPGMPAR           NO  ===>                     @D14NDJB 00985000
         DROP  R5                                              @D14CDJB 00986000
FVPGMINV_1  DS  0H                                             @D64ADKH 00987000
         LTR   RB,RB                                           @D64ADKH 00988000
         BNZ   FVPGMINV                                        @D64ADKH 00989000
         L     R8,PIBPTR2              GET CURRENT PCB..       @D64ADKH 00990000
         USING PIB2ADR,R8                                      @D64ADKH 00991000
         L     R8,PIBPCB               .. OUT OF PIB2          @D64ADKH 00992000
         USING PCBADR,R8                                       @D64ADKH 00993000
         IC    R2,PCEKEY               GET PARTITION KEY       @D64ADKH 00994000
         DROP  R8                                              @D64ADKH 00995000
FVPGMINV EQU   *                                               @D14CDJB 00996000
*SGLINK  GFSTKEYP,INPUT=(R0,R1,R2,R8:LINK,RA,RB,RC),OUTPUT=(RF),       *00997000
               NOMODR=(R4,R5,R6,R7,RA,RB,RC,RD),AMODE=31                00998000
         SGAMSUBR SUBROUT=GFSTKEYP,                            @D52VDMZ*00999000
               INPUT=(R0,R1,R2,RA,RB,RC),                      @D52VDMZ*01000000
               NOMOD=(R4,R5,R6,R7,RA,RB,RC,RD),                @D52VDMZ*01001000
               OUTPUT=(RF),                                    @D52VDMZ*01002000
               LINK=(R8),         SET STORAGE KEY TO ZERO      @D52VDMZ*01003000
               CBASE=GVSUBR                                    @D52VDMZ 01004000
         BR    R4                 ===> RETURN TO CALLER        @D14NDJB 01005000
***************************************************************@D149DJB 01006000
*  HANDLING FOR PARTITION REQUEST                              @D149DJB 01007000
***************************************************************@D149DJB 01008000
FVPGMPAR EQU   *                                               @D14NDJB 01009000
*SGLINK  FVFREPDS,INPUT=(R0,R1,R8:LINK,RB,RC),OUTPUT=(RF),             *01010000
               NOMODR=(R4,R5,R6,R7,R9,RA-RC,RD),AMODE=31                01011000
         SGAMSUBR SUBROUT=FVFREPDS,                            @D14CDJB*01012000
               INPUT=(R0,R1,RB,RC),                            @D14NDJB*01013000
               OUTPUT=(RF),                                    @D52VDMZ*01014000
               NOMOD=(R4,R5,R6,R7,R9,RB,RC,RD),                @D14CDJB*01015000
               LINK=(R8),         FREE/CLEAR PAGE              @D14CDJB*01016000
               CBASE=GVSUBR                                    @D51IDMZ 01017000
         BR    R4                 ===> RETURN TO CALLER        @D14CDJB 01018000
         DROP  RC                                              @D14CDJB 01019000
         EJECT                                                 @D14CDJB 01020000
***************************************************************@D149DJB 01021000
*                                                              @D149DJB 01022000
*   ROUTINE TO UPDATE CURRENT POINTERS                         @D149DJB 01023000
*       AND TO PREPARE INPUT FOR THE SETVSTAB ROUTINE          @D149DJB 01024000
*                                                              @D149DJB 01025000
*   MODULE GVUPPI                                              @D149DJB 01026000
*     IF POOL SPECIFIED THEN RESTORE CURRENT POINTERS          @D51XDMZ 01027000
*     IF ENTERED AFTER GVGETPAG (GFENQDEQ) REQUEST             @D149DJB 01028000
*       THEN UPDATE SSEARCH IN ANCHOR TABLE                    @D149DJB 01029000
*            UPDATE SVWORK1 IN ANCHOR TABLE                    @D149DJB 01030000
*     STORE ADDRESS IN USER AREA                               @D149DJB 01031000
*     UPDATE CURRENT POINTER (SPITCURP,SPITRLVB,SPITBITO)      @D51XDMZ 01032000
*     ACCORDING TO FIRST FIT ALGORTIHM                         @D51XDMZ 01033000
*     EXIT GVUPPI                                              @D149DJB 01034000
*   ENDMODULE GVUPPI                                           @D149DJB 01035000
*                                                              @D149DJB 01036000
*     CALLED BY : GETVIS  GVSBPOOL  GVGPMIN1                   @D51XDMZ 01037000
*     CALLS     :   ---                                        @D149DJB 01038000
*                                                              @D149DJB 01039000
*     INPUT (AFTER GVSCVSTB) :                                 @D149DJB 01040000
*              R1 --> LAST VISTAB BYTE OF FOUND AREA           @D149DJB 01041000
*              R3  :  BIT OFFSET IN LAST VISTAB BYTE (LAST     @D149DJB 01042000
*                     OCCUPIED BIT)                            @D149DJB 01043000
*              R4 --> FOUND GETVIS AREA                        @D149DJB 01044000
*              R9  :  0                                        @D149DJB 01045000
*              SSEARCH : FIRST VISTAB BYTE OF FOUND AREA       @D51XDMZ 01046000
*              SVWORK1 : FIRST OCCUPIED BIT IN FIRST VISTAB BYT@D51XDMZ 01047000
*     INPUT (AFTER GFENQDEQ) :                                 @D149DJB 01048000
*              R3 --> SUBPOOL CHAIN ENTRY OF FIRST FOUND PAGE  @D149DJB 01049000
*              R9 --> SUBPOOL CHAIN ENTRY OF LAST FOUND PAGE   @D149DJB 01050000
*     INPUT (BOTH) :                                           @D149DJB 01051000
*              R2 --> SUBPOOL INDEX TABLE ENTRY                @D149DJB 01052000
*              RB  :  SHIFT MODIFIER FOR SVA REQUEST           @D149DJB 01053000
*              RC --> ANCHOR TABLE                             @D149DJB 01054000
*              RD --> USER SAVE AREA                           @D149DJB 01055000
*              RF  :  0                                        @D149DJB 01056000
*     OUTPUT : R0  :  INDICATOR FOR SETVSTAB (000000FF)        @D149DJB 01057000
*              R1  :  LAST BYTE IN VISTAB TO BE SET            @D149DJB 01058000
*              R3  :  BIT OFFSET IN LAST VISTAB BYTE (LAST     @D149DJB 01059000
*                     OCCUPIED BIT)                            @D149DJB 01060000
*              RF  :  0                                        @D149DJB 01061000
*              SSEARCH : FIRST VISTAB BYTE OF FOUND AREA       @D51XDMZ 01062000
*              SVWORK1 : FIRST OCCUPIED BIT IN FIRST VISTAB BYT@D51XDMZ 01063000
*     LINK   : R8                                              @D149DJB 01064000
*     WORK   : R4,R5,R9                                        @D149DJB 01065000
*                                                              @D149DJB 01066000
         AGO    .CREATEY                                       @D14ZDJB 01067000
.GVUPIE0 ANOP                                                  @D14ZDJB 01068000
.*             0123456789ABCDEF                                @D149DJB 01069000
&INPREG  SETC '0111100001011101'                               @D14ZDJB 01070000
&OUTREG  SETC '1101000000000001'                               @D14ZDJB 01071000
&WRKREG  SETC '0000110001000000'                               @D14ZDJB 01072000
&NMDREG  SETC '0010001110111110'                               @D52VDMZ 01073000
&LINKR   SETC 'R8'                                             @D14ZDJB 01074000
&TBASE   SETC 'GVSUBR'                                         @D51IDMZ 01075000
.*EXCLSYMS=(SVWORK1,SSEARCH)                                   @D52VDMZ 01076000
         AGO    .TESTALL                                       @D14ZDJB 01077000
.GVUPIE1 ANOP                                                  @D14ZDJB 01078000
.*             0123456789ABCDEF                                @D149DJB 01079000
&INPREG  SETC '0011000001011101'                               @D14ZDJB 01080000
&OUTREG  SETC '1101000000000001'                               @D14ZDJB 01081000
&WRKREG  SETC '0000110001000000'                               @D14ZDJB 01082000
&NMDREG  SETC '0010001110111110'                               @D52VDMZ 01083000
&LINKR   SETC 'R8'                                             @D14ZDJB 01084000
&TBASE   SETC 'GVSUBR'                                         @D51IDMZ 01085000
.*EXCLSYMS=(SVWORK1,SSEARCH)                                   @D52VDMZ 01086000
         AGO    .TESTALL                                       @D14ZDJB 01087000
.CREATEY ANOP                                                  @D14ZDJB 01088000
***************************************************************@D149DJB 01089000
         SPACE 2                                               @D14CDJB 01090000
         USING ANCHTAB,RC                                      @D14CDJB 01091000
         USING SVEARA,RD                                       @D14CDJB 01092000
         USING SUBPINT,R2                                      @D14CDJB 01093000
GVUPPIE0 DS    0H                                              @D14CDJB 01094000
*SGLINK  GVUPPIE0,S,INPUT=(R1,R2,R3,R4,R8:LINK,R9,RB,RC,RD,RF),        *01095000
               OUTPUT=(R0,R1,R3,RF),WORK=(R4,R5,R9),                   *01096000
               NOMODR=(R8),AMODE=31,                                   *01097000
               MODSYM=(SVWORK1,SSEARCH)                                 01098000
GVUPPIE1 DS    0H                                              @D14CDJB 01099000
*SGLINK  GVUPPIE1,S,INPUT=(R2,R3,R8:LINK,R9,RB,RC,RD,RF),              *01100000
               OUTPUT=(R0,R1,R3,RF),WORK=(R4,R5,R9),                   *01101000
               NOMODR=(R8),AMODE=31,                                   *01102000
               MODSYM=(SVWORK1,SSEARCH)                                 01103000
         TM    SVER0F+D3,GVPOOL   POOL SPECIFIED               @D51XDMZ 01104000
         BZ    GVUPPI0            NO                           @D51XDMZ 01105000
         MVC   SPITCURP,SCURPSAV  RESTORE ...                  @D51XDMZ 01106000
         MVC   SPITRLVB,SRLVBSAV  ... CURRENT                  @D51XDMZ 01107000
         MVC   SPITBITO,SBITOSAV  ...    POINTER               @D51XDMZ 01108000
GVUPPI0  DS    0H                                              @D51XDMZ 01109000
         LTR   R9,R9              CALL AFTER GFENQDEQ ?        @D14CDJB 01110000
         BNZ   GVUPPIPG           YES ==>                      @D14CDJB 01111000
***************************************************************@D149DJB 01112000
*   PART OF GVUPPI WHEN REQUEST COMES AFTER GVSCVSTB           @D149DJB 01113000
*     R5 = R1 (LAST VISTAB BYTE OF FOUND AREA)                 @D51XDMZ 01114000
*     CALCULATE R9 = CHAIN ENTRY OF LAST PAGE                  @D51XDMZ 01115000
*     CALCULATE RA = CHAIN ENTRY OF FIRST PAGE                 @D51XDMZ 01116000
***************************************************************@D149DJB 01117000
         LR    R5,R1              GET LAST VISTAB BYTE OF AREA @D14CDJB 01118000
*     CALCULATE R9 = CHAIN ENTRY OF LAST PAGE                  @D51XDMZ 01119000
         L     R9,SVER00          GET REQUESTED LENGTH         @D14CDJB 01120000
         AR    R9,R4              GET END ADDRESS              @D14CDJB 01121000
         S     R9,BVIRTMEM        GET RELATIVE END ADDRESS     @D14CDJB 01122000
         BCTR  R9,0               MINUS ONE                    @D14CDJB 01123000
         SRL   R9,PNSHIFT         GET RELATIVE                 @D14NDJB 01124000
         SLL   R9,SUBPCHN2               CHAIN ADDRESS         @D14CDJB 01125000
         A     R9,BSUBPCHN        GET CHAIN ENTRY              @D14CDJB 01126000
*     CALCULATE RA = CHAIN ENTRY OF FIRST PAGE                 @D51XDMZ 01127000
         LR    RA,R4              GET FOUND ADDRESS            @D51XDMZ 01128000
         S     RA,BVIRTMEM        GET RELATIVE BEGIN ADDRESS   @D51XDMZ 01129000
         SRL   RA,PNSHIFT         GET RELATIVE PAGE NUMBER     @D51XDMZ 01130000
         SLL   RA,SUBPCHN2        GET CHAIN TABLE OFFSET       @D51XDMZ 01131000
         A     RA,BSUBPCHN        GET FIRST PAGE CHAIN ENTRY   @D51XDMZ 01132000
         B     GVUPPICO           ===> GOTO COMMON CODE        @D51XDMZ 01133000
***************************************************************@D149DJB 01134000
*   PART OF GVUPPI WHEN REQUEST COMES AFTER GFENQDEQ           @D149DJB 01135000
*     CALCULATE SVWORK1 (=0), SSEARCH                          @D51XDMZ 01136000
*     SAVE RA = CHAIN ENTRY OF FIRST FOUND PAGE                @D51XDMZ 01137000
*     CALCUALATE R5 = LAST VISTAB BYTE OF FOUND AREA           @D51XDMZ 01138000
*     SET OUTPUT REGISTER R1 = R5                              @D51XDMZ 01139000
*     CALCUALATE R4 = ADDRESS OF FOUND GETVIS AREA             @D51XDMZ 01140000
***************************************************************@D149DJB 01141000
GVUPPIPG EQU   *                                               @D14CDJB 01142000
         ST    RF,SVWORK1         CLEAR BIT OFFSET             @D14CDJB 01143000
         LR    RA,R3              GET CHAIN ENTRY OF FIRST PAGE@D51XDMZ 01144000
         USING SUBPCHN,R3                                      @D14CDJB 01145000
         L     R5,SPCHVSTB        GET FIRST PAGE VISTAB OFFSET @D51IDMZ 01146000
         DROP  R3                                              @D14CDJB 01147000
         LR    R4,R5              PREPARE FOR ADDR. CALCULATION@D14CDJB 01148000
         A     R5,BVISTAB         GET VISTAB ADDRESS OF PAGE   @D14CDJB 01149000
         ST    R5,SSEARCH         INPUT FOR SETVSTAB           @D14CDJB 01150000
         L     R0,SVER00          GET REQUESTED BYTE LENGTH    @D14CDJB 01151000
         BCTR  R0,0               MINUS ONE                    @D14CDJB 01152000
         SRDA  R0,LDVBYTB(RB)     NUMBER OF BYTES AND FRACTION @D14CDJB 01153000
         SRL   R1,BITREG-(LDVBYTB-LDVBYTBI) GET NUMBER OF BITS @D14CDJB 01154000
         LA    R3,D1(R1)          GET INPUT FOR SETVSTAB       @D14CDJB 01155000
         AR    R5,R0              GET LAST VISTAB BYTE         @D14CDJB 01156000
         LR    R1,R5              GET INPUT FOR SETVSTAB       @D14CDJB 01157000
         SLA   R4,LDVBYTB(RB)     MULTIPLY BY VIRT. SIZE/BYTE  @D14CDJB 01158000
         A     R4,BVIRTMEM      ADD START ADDR. OF GETVIS AREA @D14CDJB 01159000
***************************************************************@D149DJB 01160000
*   COMMON PART                                                @D149DJB 01161000
*    INPUT                                                     @D51XDMZ 01162000
*       R3 = BIT OFFSET IN LAST VISTAB BYTE (NOMOD)            @D51XDMZ 01163000
*       R4 = ADDRESS OF FOUND AREA                             @D51XDMZ 01164000
*       R5 = LAST VISTAB BYTE OF FOUND AREA                    @D51XDMZ 01165000
*       R9 = CHAIN ENTRY OF LAST PAGE                          @D51XDMZ 01166000
*       RA = CHAIN ENTRY OF FIRST PAGE (SPITNEW)               @D51XDMZ 01167000
*       SSEARCH : FIRST VISTAB BYTE OF FOUND AREA              @D51XDMZ 01168000
*       SVWORK1 : FIRST BIT WITHIN FIRST VISTAB BYTE           @D51XDMZ 01169000
***************************************************************@D149DJB 01170000
GVUPPICO DS    0H                                              @D51XDMZ 01171000
         ST    R4,SVER01          STORE ADDR. IN USER REGISTER @D14CDJB 01172000
         S     R5,BVISTAB         REL.VISTAB ADDR. OF LAST BYTE@D14CDJB 01173000
         USING SUBPCHN,R9                                      @D14CDJB 01174000
         S     R5,SPCHVSTB        GET LAST PAGE REL.VISTAB OFF.@D51IDMZ 01175000
         DROP  R9                                              @D14CDJB 01176000
         L     RF,SPITCURP        FIRST REQUEST FOR EMPTY ..   @D51XDMZ 01177000
         LTR   RF,RF              ... SUBPOOL                  @D51XDMZ 01178000
         BM    GVUPCP             YES, UPDATE CURRENT POINTER  @D51XDMZ 01179000
         CR    RA,RF              COMPARE SPITNEW , SPITCURP   @D51XDMZ 01180000
         BL    GVUPPI00           SPITNEW < SPITCURP => UPDATE @D51XDMZ 01181000
         BH    GVUPPIEX           SPITNEW > SPITCURP => NO UPD.@D51XDMZ 01182000
***************************************************************@D149DJB 01183000
*  SPITNEW = SPITCURP                                          @D51XDMZ 01184000
*   CALCULATE RELATIVE VISTAB OFFSET OF BEGIN ADDRESS(SRLVBNEW)@D51XDMZ 01185000
*   SRLVBNEW < SPITRLVB : NOT POSSIBLE SINCE CURRENT POINTER   @D51XDMZ 01186000
*                         POINTS TO FIRST POSSIBLE GAP         @D51XDMZ 01187000
*   SRLVBNEW = SPITRLVB :                                      @D51XDMZ 01188000
*     IF NO OF BITS USED IN SPITBIT0 = SVWORK1 THEN            @D51XDMZ 01189000
*     FOUND AREA STARTS AT CURRENT POINTER                     @D51XDMZ 01190000
*       => UPDATE CURRENT POINTER                              @D51XDMZ 01191000
*   SRLVBNEW > SPITRLVB :                                      @D51XDMZ 01192000
*    SRLVBNEW = SPITRLVB+1 AND SPITBITO = FF AND SVWORK1=0     @D51XDMZ 01193000
*     THEN UPDATE CURRENT POINTER                              @D51XDMZ 01194000
***************************************************************@D149DJB 01195000
         L     R4,SSEARCH         CALCULATE RELATIVE ...       @D51XDMZ 01196000
         S     R4,BVISTAB           VISTAB OFFSET ...          @D51XDMZ 01197000
         USING SUBPCHN,RA                                      @D51XDMZ 01198000
         S     R4,SPCHVSTB            OF FIRST PAGE (SRLVBNEW) @D51XDMZ 01199000
         DROP  RA                                              @D51XDMZ 01200000
         SR    RF,RF              CLEAR FOR INSERT             @D51XDMZ 01201000
         IC    RF,SPITRLVB                                     @D51XDMZ 01202000
         CR    R4,RF              SRLVBNEW = SPITRLVB          @D51XDMZ 01203000
         BH    GVUPPIC2           NO , ">"                     @D51XDMZ 01204000
         SR    R4,R4              "=", AT LEAST ONE '0' BIT    @D51XDMZ 01205000
         IC    R4,SPITBITO        MUST EXIST WITHIN SPITBITO   @D51XDMZ 01206000
         SLA   R4,BITREG-BITBYT-1 PREPARE FOR SHIFT            @D51XDMZ 01207000
         SR    RA,RA                                           @D51XDMZ 01208000
GVUPPIC0 SLA   R4,D1              CALCULATE NO OF 1'S UNTIL    @D51XDMZ 01209000
         BNO   GVUPPIC1             FIRST '0' BIT IS FOUND     @D51XDMZ 01210000
         LA    RA,1(RA)           COUNT NO OF SHIFTS           @D51XDMZ 01211000
         B     GVUPPIC0                                        @D51XDMZ 01212000
GVUPPIC1 DS    0H                                              @D51XDMZ 01213000
         C     RA,SVWORK1         NEW AREA STARTS AT THE ..    @D51XDMZ 01214000
         BE    GVUPCP             CURRENT POINTER=> UPDATE     @D51XDMZ 01215000
         B     GVUPPIEX           NO => DO NOT UPDATE CUR.PTR  @D51XDMZ 01216000
GVUPPIC2 LA    RF,1(RF)                                        @D51XDMZ 01217000
         CR    R4,RF              R4 > SPITRLVB + 1 ?          @D51XDMZ 01218000
         BH    GVUPPIEX           YES => DO NOT UPDATE CURR.PTR@D51XDMZ 01219000
         CLI   SPITBITO,XFF       GAP BETWEEN CURR.PTR AND NEW @D51XDMZ 01220000
         BNE   GVUPPIEX           AREA? YES => NO UPDATE       @D51XDMZ 01221000
         CLC   SVWORK1,F0         GAP BETWEEN CURR. PTR AND NEW@D51XDMZ 01222000
         BE    GVUPCP             AREA ? NO => UPDATE          @D51XDMZ 01223000
         B     GVUPPIEX           YES => NO UPDATE             @D51XDMZ 01224000
GVUPPI00 DS    0H                                              @D51XDMZ 01225000
***************************************************************@D51XDMZ 01226000
*  SPITNEW < SPITCURP                                          @D51XDMZ 01227000
*   SINCE SPITCURP POINTS TO THE PAGE WITH THE FIRST POSSIBLE  @D51XDMZ 01228000
*   GAP, SPITNEW < SPITCURP MEANS THAT AT LEAST ONE PAGE WAS   @D51XDMZ 01229000
*   TAKEN FROM THE FREE QUEUE AND R4 DENOTES A PAGE BOUNDARY.  @D51XDMZ 01230000
*   IF THE REQUEST IS A MULTIPLE OF A PAGE, NO GAP IS CREATED  @D51XDMZ 01231000
*   AND THE CURRENT POINTER IS NOT UPDATED.                    @D51XDMZ 01232000
***************************************************************@D51XDMZ 01233000
*  GET NUMBER OF VISTAB BYTES PER PAGE                         @D51XDMZ 01234000
         LTR   RB,RB              SVA/SPACE REQUEST            @D51XDMZ 01235000
         BM    GVUPPI10           YES                          @D51XDMZ 01236000
         LA    RF,PABYTPPG        PARTITION PAGE               @D51XDMZ 01237000
         B     GVUPPI20                                        @D51XDMZ 01238000
GVUPPI10 DS    0H                                              @D51XDMZ 01239000
         LA    RF,SVBYTPPG        SVA/SPACE PAGE               @D51XDMZ 01240000
GVUPPI20 DS    0H                                              @D51XDMZ 01241000
         BCTR  RF,0                                            @D51XDMZ 01242000
         CR    R5,RF              LAST VISTAB BYTE OF PAGE ?   @D51XDMZ 01243000
         BL    GVUPCP             NO=>UPDATE, POSS. GAP CREATED@D51XDMZ 01244000
         CH    R3,H8              ALL BITS USED IN LAST BYTE   @D51XDMZ 01245000
         BE    GVUPPIEX           YES, NO GAP CREATED          @D51XDMZ 01246000
GVUPCP   DS    0H                 UPDATE CURRENT POINTER       @D51XDMZ 01247000
         ST    R9,SPITCURP        STORE NEW START POINTER      @D14CDJB 01248000
         STC   R5,SPITRLVB        STORE NEW CURRENT POINTER    @D14CDJB 01249000
         L     R0,ADDRMASK        GET DUMMY MASK               @D14CDJB 01250000
         LA    R4,BITBYT          COMPUTE COMPLEMENT           @D14CDJB 01251000
         SR    R4,R3                         OF BIT VALUE      @D14CDJB 01252000
         SLL   R0,D0(R4)          EVALUATE CURRENT BIT MASK    @D14CDJB 01253000
         STC   R0,SPITBITO        STORE BIT MASK               @D14CDJB 01254000
GVUPPIEX DS    0H                                              @D14CDJB 01255000
         LA    R0,HEXFF           SET INDICATOR FOR SETVSTAB   @D14CDJB 01256000
         L     RA,TCBPTR          RA WAS USED AS WORK REGISTER @D51XDMZ 01257000
         USING TCBADR,RA          REESTABLISH ADDRESSIBILITY   @D51XDMZ 01258000
         SR    RF,RF              CLEAR RF FOR FURTHER USE     @D51XDMZ 01259000
         BR    R8                 ==> RETURN TO CALLER         @D14CDJB 01260000
         DROP  R2                                              @D14CDJB 01261000
         DROP  RC,RD                                           @D14CDJB 01262000
         EJECT                                                 @D14CDJB 01263000
***************************************************************@D149DJB 01264000
*                                                              @D149DJB 01265000
*   ROUTINE TO RETRIEVE PAGE(S) FROM THE POOL OF EMPTY PAGES   @D149DJB 01266000
*                                                              @D149DJB 01267000
*   MODULE GVGETPAG                                            @D149DJB 01268000
*     IF PAGE(S) NOT AVAILABLE                                 @D149DJB 01269000
*      OR SVA/SP REQUEST AND NON-VITAL REQUESTOR EXCEEDS LIMIT @D149DJB 01270000
*      OR SVA REQUEST AND EXCESSIVE REQUESTOR EXCEEDS LIMIT  @D149DJB   01271000
*       THEN SET RC = 0C                                       @D149DJB 01272000
*            EXIT GVGETPAG                                     @D149DJB 01273000
*     GET CURRENT POINTER WITHIN POOL OF EMPTY PAGES           @D149DJB 01274000
*     SCAN POOL OF EMPTY PAGES FOR N CONTIGUOUS PAGES          @D149DJB 01275000
*     IF PAGE(S) NOT FOUND                                     @D149DJB 01276000
*       THEN SET RC = 0C                                       @D149DJB 01277000
*     EXIT GVGETPAG                                            @D149DJB 01278000
*   ENDMODULE GVGETPAG                                         @D149DJB 01279000
*                                                              @D149DJB 01280000
*     CALLED BY : GETVIS  GVSBPOOL GVGPMIN1                    @D149DJB 01281000
*     CALLS     :   ---                                        @D149DJB 01282000
*                                                              @D149DJB 01283000
*     INPUT  : R3 --> PAGE TO START SEARCH                     @D149DJB 01284000
*              R4  :  NUMBER OF PAGES TO BE LOOKED FOR         @D149DJB 01285000
*              RC --> ANCHOR TABLE                             @D149DJB 01286000
*              RD --> REQUESTOR SAVE AREA                      @D149DJB 01287000
*              RF  :  0                                        @D52VDMZ 01288000
*     OUTPUT : R3 --> CHAIN TABLE ENTRY TO FIRST FOUND PAGE    @D149DJB 01289000
*              R5 --> DUMMY SUBPOOL INDEX TABLE ENTRY          @D149DJB 01290000
*              R9 --> CHAIN TABLE ENTRY TO LAST FOUND PAGE     @D149DJB 01291000
*              RF  :  0 (FOUND) , X'0C'(NOT FOUND)             @D52VDMZ 01292000
*     LINK   : R8                                              @D149DJB 01293000
*     WORK   : R9                                              @D149DJB 01294000
*                                                              @D149DJB 01295000
         AGO    .CREATEI                                       @D14ZDJB 01296000
.GVGETPG ANOP                                                  @D14ZDJB 01297000
.*             0123456789ABCDEF                                @D149DJB 01298000
&INPREG  SETC '0001100000001101'                               @D52VDMZ 01299000
&OUTREG  SETC '0001010001000001'                               @D14ZDJB 01300000
&WRKREG  SETC '0000000001000000'                               @D14ZDJB 01301000
&NMDREG  SETC '1110101110111110'                               @D14ZDJB 01302000
&LINKR   SETC 'R8'                                             @D14ZDJB 01303000
&TBASE   SETC 'GVSUBR'                                         @D51IDMZ 01304000
.*EXCLSYMS=()                                                  @D52VDMZ 01305000
         AGO    .TESTALL                                       @D14ZDJB 01306000
.CREATEI ANOP                                                  @D14ZDJB 01307000
***************************************************************@D149DJB 01308000
         SPACE 2                                               @D14CDJB 01309000
         USING ANCHTAB,RC                                      @D14CDJB 01310000
         USING SVEARA,RD                                       @D14CDJB 01311000
GVGETPAG DS    0H                                              @D14CDJB 01312000
*SGLINK  GVGETPAG,S,INPUT=(R3,R4,R8:LINK,RC,RD,RF),OUTPUT=(R3,R5,R9,   *01313000
               RF),WORK=(R9),NOMODR=(R8),                              *01314000
               AMODE=31                                                 01315000
         LTR   R3,R3              END OF QUEUE REACHED ?       @D14CDJB 01316000
         BM    GVPGNERR           YES ===>                     @D14CDJB 01317000
         L     R9,GTVSPGCT        GET ACTUAL PAGE COUNT        @D52VDKH 01318000
         AR    R9,R4              PLUS REQUESTED ONES          @D14CDJB 01319000
         C     R9,GTVSMXCT        ARE THEY AVAILABLE           @D52VDKH 01320000
         BNH   GVPGCKER           YES ===>                     @D14CDJB 01321000
         CLI   GMFMRQST,X'00'     GETVIS REQUEST               @D64ADMZ 01322000
         BE    GVGETPAG_1         YES                          @D64ADMZ 01323000
* GETMAIN REQUEST                                              @D64ADMZ 01324000
         TM    GMFMFLGS,VAR       MAX GAP ONLY OF INTEREST IN CASE OF  *01325000
                                  VARIALBE REQRUESTS           @D64ADMZ 01326000
         BZ    GVPGNERR           SET AS NOT FOUND             @D64ADMZ 01327000
         OI    GVFVFLG2,GPAGEXIT  USE ERR.EXIT AFT. SUBP. SCAN @D64ADMZ 01328000
         B     GVPGCKER           UPDATE MAX. COUNT            @D64ADMZ 01329000
GVGETPAG_1 DS  0H                                              @D64ADMZ 01330000
         TM    SVER0F+D3,SVAIND   SVA  REQUEST ?               @D51IDKH 01331000
         BZ    GVPGNERR           NO  ===> PAGES NOT AVAILABLE @D14CDJB 01332000
         L     R5,PIBPTR2         CHECK IF SERVICE OWNER IS..  @D52VDMZ 01333000
         USING PIB2ADR,R5                                      @D52VDMZ 01334000
         L     R5,PIBPCB          .. MASTER DUMP               @D52VDMZ 01335000
         USING PCBADR,R5                                       @D52VDMZ 01336000
         TM    PCBSAAPT,PCBMSAAE  MASTER DUMP ACTIVE           @D52VDMZ 01337000
         BO    GVPGSTSR           YES ===> START SEARCHING     @D51IDMZ 01338000
         B     GVPGNERR           NO  ===> SET AS NOT FOUND    @D14CDJB 01339000
GVPGCKER EQU   *                                               @D14CDJB 01340000
         TM    SVER0F+D3,SVAIND   SVA  REQUEST ?               @D51IDMZ 01341000
         BZ    GVPGSTSR           NO  ===>                     @D14CDJB 01342000
         TM    SVER0F+D2,GVEXREQ  EXCESSIVE REQUESTOR ?        @D14CDJB 01343000
         BNO   GVPGSTSR           NO  ===> START SEARCHING     @D14CDJB 01344000
         C     R9,GTVSEXCT        MAXIMUM COUNT EXCEEDED ?     @D52VDKH 01345000
         BH    GVPGNERR           YES ===> SET AS NOT FOUND    @D14CDJB 01346000
         DROP  R5                                              @D14CDJB 01347000
***************************************************************@D149DJB 01348000
*   LOOP TO SCAN POOL OF EMPTY PAGES                           @D149DJB 01349000
***************************************************************@D149DJB 01350000
GVPGSTSR EQU   *                                               @D14CDJB 01351000
         LR    R5,R3              GET START OF QUEUE           @D14CDJB 01352000
GVPGCONT EQU   *                                               @D14CDJB 01353000
         LR    R9,R4              SAVE NUMBER OF PAGES         @D14CDJB 01354000
         LR    R3,R5              GET START OF QUEUE           @D14CDJB 01355000
GVPGSLP  EQU   *                                               @D14CDJB 01356000
         BCTR  R9,0               REDUCE PAGES BY ONE          @D14CDJB 01357000
         LTR   R9,R9              LOOK FOR ADDITIONAL PAGES ?  @D14CDJB 01358000
         BZ    GVPGSEX            NO  ==>                      @D14CDJB 01359000
         USING SUBPCHN,R5                                      @D14CDJB 01360000
         TM    SPCHFLAG,SPPGCONC  NEXT PAGE CONTIGUOUS ?       @D14CDJB 01361000
         L     R5,SPCHFORW        GO TO NEXT PAGE              @D14CDJB 01362000
         BO    GVPGSLP            YES ==>                      @D14CDJB 01363000
         LR    RF,R4              NO OF REQUESTED PAGES - NO ..@D64ADMZ 01364000
         SR    RF,R9              OF NOT FOUND = NO OF FOUND   @D64ADMZ 01365000
         C     RF,MAXGAP          <= FOUND IN PREVIOUS SEARCH  @D64ADMZ 01366000
         BNH   GVPGSLP_1          YES                          @D64ADMZ 01367000
         ST    RF,MAXGAP          SET NEW MAX. VALUE           @D64ADMZ 01368000
GVPGSLP_1 DS   0H                                              @D64ADMZ 01369000
         CR    R3,R5              END OF STORAGE REACHED ?     @D14CDJB 01370000
         BL    GVPGCONT           NO  ===>                     @D14CDJB 01371000
         DROP  R5                                              @D14CDJB 01372000
***************************************************************@D149DJB 01373000
*   PAGE(S) NOT FOUND                                          @D149DJB 01374000
***************************************************************@D149DJB 01375000
GVPGNERR EQU   *                                               @D14CDJB 01376000
         TM    GVFVFLG2,GPAGEXIT  PAGE COUNT WAS EXCEEDED?     @D64ADMZ 01377000
         BO    GVPGSEX_1          YES, CHECK MAXGAP            @D64ADMZ 01378000
GVPGNERR_1 DS  0H                                              @D64ADMZ 01379000
         LA    RF,SMERR0C         GET ERROR CODE               @D14CDJB 01380000
         BR    R8                 ===> RETURN TO CALLER        @D64ADMZ 01381000
***************************************************************@D149DJB 01382000
*   PAGE(S) FOUND                                              @D149DJB 01383000
***************************************************************@D149DJB 01384000
GVPGSEX  EQU   *                                               @D14CDJB 01385000
         TM    GVFVFLG2,GPAGEXIT  PAGE COUNT WAS EXCEEDED  ..  @D64ADMZ 01386000
         BO    GVPGSEX_1          .. YES                       @D64ADMZ 01387000
         LR    R9,R5              LOAD OUTPUT REGISTER         @D14CDJB 01388000
         LA    R5,FIRSTPNT-(SPITFRST-SUBPINT)  DUMMY INDEX PTR @D14CDJB 01389000
         SR    RF,RF              CLEAR RETURN CODE            @D64ADMZ 01390000
         BR    R8                 ==> RETURN TO CALLER         @D14CDJB 01391000
GVPGSEX_1 DS   0H                                              @D64ADMZ 01392000
* CHECK IF MAXGAP CAN BE SATISFIED. REQUEST MIGHT NOT WORK IN SVA,      01393000
* SINCE NOT ALL FREE PAGES ARE AVAILABLE FOR NORMAL REQUESTOR           01394000
         NI    GVFVFLG2,XFF-GPAGEXIT RESET INDICATION          @D64ADMZ 01395000
         L     R9,GTVSPGCT        NO OF CURRENT USED PAGES     @D64ADMZ 01396000
         A     R9,MAXGAP          + MAX. NO OF CONT. PAGES     @D64ADMZ 01397000
         C     R9,GTVSMXCT        .. <= AVA. PAGES IN AREA     @D64ADMZ 01398000
         BNH   GVPGNERR_1         .. YES                       @D64ADMZ 01399000
         L     R9,GTVSMXCT        NO OF AVAI. PAGES MINUS ..   @D64ADMZ 01400000
         S     R9,GTVSPGCT        .. NO OF CURRENT USED        @D64ADMZ 01401000
         ST    R9,MAXGAP          .. = MAX. REQUEST            @D64ADMZ 01402000
         B     GVPGNERR_1         EXCEEDED, USE ERROR EXIT     @D64ADMZ 01403000
         DROP  RC,RD                                           @D14CDJB 01404000
         EJECT                                                 @D14CDJB 01405000
***************************************************************@D149DJB 01406000
*                                                              @D149DJB 01407000
*   ROUTINE TO LOOK FOR GETVIS SPACE ON 2K/4K BOUNDARY         @DY38212 01408000
*                                                              @DY38212 01409000
*   FOR 370/VM MODE                                            @DY38212 01410000
*     GETVIS REQUEST <= 2K => ALIGN ON 2K BOUNDARY             @DY38212 01411000
*     GETVIS REQUEST >  2K => AKIGN ON 4K BOUNDARY             @DY38212 01412000
*                                                              @D149DJB 01413000
*   MODULE GVSCPBDY                                            @D149DJB 01414000
*     IF REQUESTED SPACE FOUND                                 @D149DJB 01415000
*       THEN SET RC = 00                                       @D149DJB 01416000
*       ELSE SET RC = 0C                                       @D149DJB 01417000
*     EXIT GVSCPBDY                                            @D149DJB 01418000
*   ENDMODULE GVSCPBDY                                         @D149DJB 01419000
*                                                              @D149DJB 01420000
*     CALLED BY : GVSBPOOL                                     @D149DJB 01421000
*     CALLS     :   ---                                        @D149DJB 01422000
*                                                              @D149DJB 01423000
*     INPUT  : R0  :  REQUESTED LENGTH IN VISTAB BITS          @D149DJB 01424000
*              R5 --> PAGE (CHAIN TABLE ENTRY) TO START SEARCH @D149DJB 01425000
*              R9 --> PAGE (CHAIN TABLE ENTRY) TO END SEARCH   @D149DJB 01426000
*              RB  :  SHIFT MODIFIER FOR SVA REQUESTS          @D149DJB 01427000
*              RC --> ANCHOR TABLE                             @D149DJB 01428000
*     OUTPUT : R1 --> LAST SCANNED BYTE IN VISTAB (IF FOUND)   @D149DJB 01429000
*              R3  :  BIT OFFSET IN LAST VISTAB BYTE           @D149DJB 01430000
*              R4 --> REQUESTED GETVIS SPACE (IF FOUND)        @D149DJB 01431000
*              RF  :  RETURN CODE : 0C (SPACE NOT FOUND)       @D149DJB 01432000
*     LINK   : R8                                              @D149DJB 01433000
*     WORK   : R1,R3,R4,RF                                     @D149DJB 01434000
*                                                              @D149DJB 01435000
*   AUXILIARY WORK FIELDS (UPDATED IN ANCHOR TABLE) :          @D149DJB 01436000
*     SSEARCH : VISTAB BYTE ADDRESS OF FOUND AREA              @D149DJB 01437000
*     SVWORK1 : BIT OFFSET IN SSEARCH OF FOUND AREA (0..7)     @D149DJB 01438000
*     SAVR2ND6, SAVR2ND7, SAVSHIFT                             @D52VDMZ 01439000
*                                                              @D149DJB 01440000
         AGO    .CREATEG                                       @D14ZDJB 01441000
.GVSCPBY ANOP                                                  @D14ZDJB 01442000
.*             0123456789ABCDEF                                @D149DJB 01443000
&INPREG  SETC '1000010001011000'                               @D14ZDJB 01444000
&OUTREG  SETC '0101100000000001'                               @D14ZDJB 01445000
&WRKREG  SETC '0000000000000000'                               @D14ZDJB 01446000
&NMDREG  SETC '1010011111111110'                               @D14ZDJB 01447000
&LINKR   SETC 'R8'                                             @D14ZDJB 01448000
&TBASE   SETC 'GVSUBR'                                         @D51IDMZ 01449000
.*EXCLSYMS=(SVWORK1,SSEARCH,SAVRND6,SAVR2ND7,SAVSHIFT)         @D52VDMZ 01450000
         AGO    .TESTALL                                       @D14ZDJB 01451000
.CREATEG ANOP                                                  @D14ZDJB 01452000
***************************************************************@D149DJB 01453000
         SPACE 2                                               @D14CDJB 01454000
         USING ANCHTAB,RC                                      @D14CDJB 01455000
GVSCPBDY DS    0H                                              @D14CDJB 01456000
*SGLINK  GVSCPBDY,S,INPUT=(R0,R5,R8:LINK,R9,RB,RC),OUTPUT=(R1,R3,R4,   *01457000
               RF),NOMODR=(R8),AMODE=31,WORK=(R1,R3,R4,RF),            *01458000
               MODSYM=(SVWORK1,SSEARCH,SAVR2ND6,SAVR2ND7)               01459000
         L     RF,PAGESIZE        GET PAGE VALUE               @DA33314 01460000
         SRL   RF,LDVBYTB(RB)     GET BYTE REPRESENTATION      @DA33314 01461000
         USING SUBPCHN,R9                                      @DA33314 01462000
         A     RF,SPCHVSTB        GET LAST PAGE VISTAB PTR.    @D51IDMZ 01463000
         DROP  R9                                              @DA33314 01464000
         USING SUBPCHN,R5                                      @DA33314 01465000
         L     R1,SPCHVSTB        GET FIRST PAGE VISTAB PTR.   @D51IDMZ 01466000
         DROP  R5                                              @DA33314 01467000
***************************************************************@DA33314 01468000
*    CHAIN ENTRY LOOP                                          @DA33314 01469000
***************************************************************@DA33314 01470000
GVSCPBLO DS    0H                                              @DA33314 01471000
         LR    R4,RF              PTR LAST AVAIL. VISTAB BYTE  @DA33314 01472000
         SR    R4,R1              GET # OF VISTAB BYTES        @DA33314 01473000
         SLL   R4,LDBITBYT        GET # OF VISTAB BITS         @DA33314 01474000
         CR    R0,R4              ENOUGH SPACE IN THIS AREA ?  @DA33314 01475000
         BH    GVSCPBER           NO  ===>                     @DA33314 01476000
         TM    GVFVFLGS,GVFVABVE  THIS REQUEST FOR ABOVE       @D52VDKH 01477000
         BO    GVSCMIRR           THEN ALLOW FOR MIRRORING     @D52VDKH 01478000
GVSCMIR3 DS    0H                                              @D52VDKH 01479000
         A     R1,BVISTAB         GET CURRENT VISTAB PTR.      @DA33314 01480000
         ST    R1,SSEARCH         SAVE IT FOR SETVSTAB         @DA33314 01481000
         LR    R4,R0              GET LENGTH IN VISTAB BITS    @DA33314 01482000
***************************************************************@DA33314 01483000
*    VISTAB LOOP                                               @DA33314 01484000
***************************************************************@DA33314 01485000
GVSCPBLP EQU   *                                               @DA33314 01486000
         C     R4,F32             FOUR BYTES NECESSARY ?       @DA33314 01487000
         L     R3,D0(R1)          GET FOUR VISTAB BYTES        @DA33314 01488000
         BL    GVSCPBLA           NO  ===>                     @DA33314 01489000
         LTR   R3,R3              ARE VISTAB BYTES EMPTY ?     @DA33314 01490000
         BNZ   GVSCPBN2           NO  ===> (SPACE NOT FOUND)   @DA33314 01491000
         LA    R1,D4(R1)          GOTO NEXT FOUR VISTAB BYTES  @DA33314 01492000
         S     R4,F32             SUBTRACT 32 FROM BIT LENGTH  @DA33314 01493000
         BNZ   GVSCPBLP           ===> REPEAT SCAN IF REST     @DA33314 01494000
         BCTR  R1,0               SET R1 INPUT FOR SETVSTAB    @DA33314 01495000
         LA    R3,D8              SET R3 INPUT FOR SETVSTAB    @DA33314 01496000
         B     GVSCPBLB           ===> COMPUTE REST            @DA33314 01497000
GVSCPBLA EQU   *                                               @DA33314 01498000
         SRL   R3,D1              RIGHT POSIT. FOR ARITH. SHIFT@DA33314 01499000
         SLA   R3,D0(R4)          CHECK FOR REST OF SPACE      @DA33314 01500000
         BNO   GVSCPBFN           FOUND ===>                   @DA33314 01501000
GVSCPBN2 EQU   *                                               @DA33314 01502000
         S     R1,BVISTAB         GET CURRENT VISTAB OFFSET    @DA33314 01503000
         LR    R4,R0              GET LENGTH OF GETVIS  ...    @DY38212 01504000
         SLL   R4,LDVBYTBI(RB)    ... REQUEST IN BYTE          @DY38212 01505000
         L     R3,PAGESIZE                                     @D52VDKH 01506000
         SRL   R3,1               PAGESIZE/2                   @D52VDKH 01507000
         LTR   RB,RB              SVA OR SPACE REQUEST ?       @D51IDKH 01508000
         BZ    GVSCPBPS           NO  ===>                     @DA33314 01509000
         CR    R4,R3              REQUESTED LENGTH <= 2K       @DY38212 01510000
         BH    GVSCPBS4           NO,ALIGN ON 4K BOUNDARY      @DY38212 01511000
         CLI   GMFMRQST,X'00'                                  @D64ADKH 01512000
         BNE   GVSCPBS4           ALIGN ON 4K BOUNDARY         @D64ADKH 01513000
         LA    R1,SVBYTP2K(R1)    GO TO                        @DA33314 01514000
         SRL   R1,LSVBTP2K            NEXT VISTAB              @DA33314 01515000
         SLL   R1,LSVBTP2K                   PAGE BOUNDARY     @DA33314 01516000
         B     GVSCPBCC           ===> CONTINUE                @DA33314 01517000
GVSCPBS4 DS    0H                 ALIGN ON 4K BOUNDARY (SVA)   @DY38212 01518000
         LA    R1,SVBYTP4K(R1)    GO TO                        @DY38212 01519000
         SRL   R1,LSVBTP4K            NEXT VISTAB (SVA)        @DY38212 01520000
         SLL   R1,LSVBTP4K                    4K  BOUNDARY     @DY38212 01521000
         B     GVSCPBCC           ===> CONTINUE                @DY38212 01522000
GVSCPBPS EQU   *                                               @DA33314 01523000
         CR    R4,R3              GETVIS REQUEST <= 2K         @DY38212 01524000
         BH    GVSCPBP4           NO,ALIGN ON 4K BOUNDARY      @DY38212 01525000
         CLI   GMFMRQST,X'00'                                  @D64ADKH 01526000
         BNE   GVSCPBP4           ALIGN ON 4K BOUNDARY         @D64ADKH 01527000
         LA    R1,PABYTP2K(R1)    GO TO                        @DA33314 01528000
         SRL   R1,LPABTP2K            NEXT VISTAB              @DA33314 01529000
         SLL   R1,LPABTP2K                   PAGE BOUNDARY     @DA33314 01530000
         B     GVSCPBCC           CONTINUE                     @DY38212 01531000
GVSCPBP4 DS    0H                 ALIGN ON 4K BOUNDARY         @DY38212 01532000
         LA    R1,PABYTP4K(R1)    GO TO                        @DY38212 01533000
         SRL   R1,LPABTP4K            NEXT VISTAB (PARTITION)  @DY38212 01534000
         SLL   R1,LPABTP4K                    4K  BOUNDARY     @DY38212 01535000
GVSCPBCC EQU   *                                               @DA33314 01536000
         CR    R1,RF              NEXT PAGE BDY ALREADY CHECKED@DY38212 01537000
         BL    GVSCPBLO           NO  ===>                     @DA33314 01538000
***************************************************************@DA33314 01539000
*    EXIT CODE OF GVSCPBDY                                     @DA33314 01540000
***************************************************************@DA33314 01541000
GVSCPBER EQU   *                                               @DA33314 01542000
         LA    RF,SMERR0C         GET RETURN CODE              @DA33314 01543000
         BR    R8                 ==> RETURN TO CALLER         @D52VDKH 01544000
GVSCPBFN EQU   *                                               @DA33314 01545000
         BCTR  R4,0               BIT NUMBER MINUS ONE         @DA33314 01546000
         SRDL  R4,LDBITBYT        LAST VISTAB BYTE NUMBER      @DA33314 01547000
         AR    R1,R4              GET LAST SCANNED VISTAB BYTE @DA33314 01548000
         SRL   R5,BITREG-LDBITBYT  FRACTION IN LOW POSITION    @DA33314 01549000
         LA    R3,D1(R5)          GET LAST SCANNED VISTAB BIT  @DA33314 01550000
GVSCPBLB EQU   *                                               @DA33314 01551000
         L     R4,SSEARCH         LOAD OUTPUT REGISTER         @DA33314 01552000
         S     R4,BVISTAB         GET RELATIVE VISTAB PTR      @DA33314 01553000
         SLA   R4,LDVBYTB(RB)     GET RELATIVE ADDRESS         @DA33314 01554000
         A     R4,BVIRTMEM        GET ADDRESS                  @DA33314 01555000
         SR    RF,RF              CLEAR RETURN CODE            @DA33314 01556000
         ST    RF,SVWORK1         GET FIRST SCANNED VISTAB BIT @DA33314 01557000
GVSCPBRT EQU   *                                               @DA33314 01558000
         BR    R8                 ==> RETURN TO CALLER         @DA33314 01559000
*************************************************                       01560000
*                                                                       01561000
* TO MAKE SURE THAT A MIRRORED ADDRESS LIES ON A PAGE BOUNDARY          01562000
* THE END OF THE RETURNED STORAGE AREA (BEFORE MIRRORING IS DONE)       01563000
* MUST BE ALIGNED TO THE END OF A PAGE                                  01564000
*                                                                       01565000
*************************************************                       01566000
GVSCMIRR EQU   *                                               @D52VDKH 01567000
         LR    R3,R0                REQUESTED LENGTH           @D52VDKH 01568000
         BCTR  R3,0                 -1                         @D52VDKH 01569000
         SRL   R3,LDBITBYT          IN VISTAB BYTES            @D52VDKH 01570000
         LA    R3,1(R3)             PLUS 1                     @D52VDKH 01571000
         AR    R3,R1                IDENTIFIES 1ST VISTAB BYTE @D52VDKH 01572000
*                                   AFTER THE AREA TO BE SCAN'D@D52VDKH 01573000
         L     R4,PAGESIZE          REPRESENT PAGESIZE/2 IN    @D52VDKH 01574000
         SRL   R4,LDVBYTB-LDBITBYT+1(RB)           VISTAB BITS @D52VDKH 01575000
         LA    RF,1                 SHIFT MODIFIER FOR BELOW   @D52VDKH 01576000
         CR    R0,R4                REQUESTED SIZE             @D52VDKH 01577000
         BH    GVSCMIR0             >  PAGESIZE/2              @D64ADKH 01578000
         CLI   GMFMRQST,X'00'                                  @D64ADKH 01579000
         BE    GVSCMIR1                                        @D64ADKH 01580000
GVSCMIR0 DS    0H                                              @D64ADKH 01581000
         SLL   R4,1                                            @D52VDKH 01582000
         SR    RF,RF                SHIFT MODIFIER FOR BELOW   @D52VDKH 01583000
         CR    R0,R4                                           @D64ADKH 01584000
         BE    GVSCMIR3                                        @D64ADKH 01585000
GVSCMIR1 DS    0H                                              @D52VDKH 01586000
         SRL   R4,LDBITBYT          PAGE(PAGE/2) IN VISTAB BYTS@D52VDKH 01587000
         BCTR  R4,0                 MINUS 1                    @D52VDKH 01588000
         ST    R4,SAVR2ND7          SAVE IT FOR LATER USE      @D52VDKH 01589000
         STC   RF,SAVSHIFT          SAVE FOR LATER USE         @D52VDKH 01590000
         AR    R3,R4                                           @D52VDKH 01591000
         LPR   R4,RB                                           @D52VDKH 01592000
         SR    R4,RF                ADJUST FOR PAGE/2, IF NEED @D52VDKH 01593000
         SRL   R3,PNSHIFT-LDVBYTB(R4) R3 IDENTIFIES 1ST BYTE   @D52VDKH 01594000
         SLL   R3,PNSHIFT-LDVBYTB(R4) IN VISTAB OF NEXT PAGE   @D52VDKH 01595000
         LR    RF,R5                  SAVE FOR LATER USE       @D52VDKH 01596000
         LR    R4,R0                  REQUESTED LENGTH         @D52VDKH 01597000
         SRDL  R4,LDBITBYT            IN VISTAB BYTES          @D52VDKH 01598000
         SR    R3,R4                                           @D52VDKH 01599000
         SRL   R5,BITREG-LDBITBYT     REMAINING # OF VISTAB BIT@D52VDKH 01600000
         LTR   R5,R5                  IS IT 0?                 @D52VDKH 01601000
         BZ    GVSCMIR2               YES, ==>                 @D52VDKH 01602000
         LNR   R5,R5                  CALCULATE BITS TO ...    @D52VDKH 01603000
         LA    R5,BITBYT(R5)          ... SKIP                 @D52VDKH 01604000
         BCTR  R3,0                   START SEARCH IN PREV. BYT@D52VDKH 01605000
GVSCMIR2 DS    0H                                              @D52VDKH 01606000
         SR    R3,R1                  OFFSET TO PAGE BDY       @D52VDKH 01607000
         ST    R3,SSEARCH             SAVE INTERMEDIATELY      @D52VDKH 01608000
         ST    R5,SVWORK1             OUTPUT FOR SETVSTAB      @D52VDKH 01609000
         LR    R5,RF                  RESTORE VALUE            @D52VDKH 01610000
         A     R1,BVISTAB             ADDRESS OF VISTAB BYTE   @D52VDKH 01611000
GVSCMIR4 DS    0H                                              @D52VDKH 01612000
*************************************************                       01613000
*                                                                       01614000
* SEARCH FOR FREE VISTAB BITS                                           01615000
*                                                                       01616000
*************************************************                       01617000
         LR    RF,R1                  IDENTIFYING A PAGE BDY   @D52VDKH 01618000
         LR    R4,R0                   REQUESTED LENGTH        @D52VDKH 01619000
         A     R1,SSEARCH           VISTAB BYTE TO START SEARCH@D52VDKH 01620000
         L     R3,SVWORK1           CONSIDER BIT OFFSET        @D52VDKH 01621000
         LTR   R3,R3                WITHIN THAT BYTE ?         @D52VDKH 01622000
         BZ    GVSCMIR5             NO ==>                     @D52VDKH 01623000
         ST    R6,SAVR2ND6                                     @D52VDKH 01624000
         L     R6,0(,R1)            GET FIRST VISTAB BYTE      @D52VDKH 01625000
         SLL   R6,0(R3)             SKIP OVER OFFSET BITS      @D52VDKH 01626000
         LNR   R3,R3                                           @D52VDKH 01627000
         LA    R3,BITBYT(R3)        CHECK REMAINING BITS IN    @D52VDKH 01628000
         SRL   R6,1                                            @D52VDKH 01629000
         SLA   R6,0(R3)             SKIP OVER OFFSET BITS      @D52VDKH 01630000
         L     R6,SAVR2ND6                                     @D52VDKH 01631000
         BO    GVSCMIR6             NOT ALL ZERO, ==>          @D52VDKH 01632000
         SR    R4,R3                FREE BITS ARE FOUND        @D52VDKH 01633000
         LA    R1,1(,R1)            MOVE TO NEXT VISTAB BYTE   @D52VDKH 01634000
         LTR   R4,R4                JUST THESE FEW BITS ?      @D52VDKH 01635000
         BZ    GVSCMIR8             YES, DONE                  @D52VDKH 01636000
GVSCMIR5 DS    0H                                              @D52VDKH 01637000
         C     R4,F32                SEARCH FULL BYTES         @D52VDKH 01638000
         L     R3,0(,R1)             CHECK NEXT VISTAB WORD    @D52VDKH 01639000
         BL    GVSCMIR7                                        @D52VDKH 01640000
         LTR   R3,R3                                           @D52VDKH 01641000
         BNZ   GVSCMIR6              NOT ALL BITS ARE ZERO     @D52VDKH 01642000
         LA    R1,4(,R1)             MOVE TO NEXT VISTAB WORD  @D52VDKH 01643000
         S     R4,F32                DECREASE COUNTER          @D52VDKH 01644000
         BNZ   GVSCMIR5                                        @D52VDKH 01645000
         B     GVSCMIR8                                        @D52VDKH 01646000
GVSCMIR7 DS    0H                                              @D52VDKH 01647000
         SRL   R3,1                TEST REMAINING VISTAB BYTES @D52VDKH 01648000
         SLA   R3,0(R4)                                        @D52VDKH 01649000
         BO    GVSCMIR6            NOT ALL ZERO                @D52VDKH 01650000
         SRL   R4,LDBITBYT                                     @D52VDKH 01651000
         AR    R1,R4              1ST VISTAB BYTE NOT SCANNED  @D52VDKH 01652000
GVSCMIR8 DS    0H                                              @D52VDKH 01653000
         BCTR  R1,0                  LAST VISTAB BYTE SCANNED  @D52VDKH 01654000
         LA    R3,BITBYT             ALL BITS IN BYTE SCANNED  @D52VDKH 01655000
         LR    R4,RF                LATEST PAGE BOUNDARY       @D52VDKH 01656000
         A     R4,SSEARCH            PLUS OFFSET FOR SEARCH    @D52VDKH 01657000
         ST    R4,SSEARCH           START OF LATEST SEARCH     @D52VDKH 01658000
         S     R4,BVISTAB                                      @D52VDKH 01659000
         SLL   R4,LDVBYTB(RB)                                  @D52VDKH 01660000
         L     RF,SVWORK1            ADD EXTRA BITS            @D52VDKH 01661000
         SLL   RF,LDVBYTB-LDBITBYT(RB)                         @D52VDKH 01662000
         AR    R4,RF                                                    01663000
         A     R4,BVIRTMEM            START ADDRESS OF AREA    @D52VDKH 01664000
         SR    RF,RF                  RETURN CODE = 0          @D52VDKH 01665000
         BR    R8                     DONE                     @D52VDKH 01666000
GVSCMIR6 DS    0H                                              @D52VDKH 01667000
         SR    RF,RF                                           @D52VDKH 01668000
         IC    RF,SAVSHIFT                                     @D52VDKH 01669000
         LPR   R3,RB                                           @D52VDKH 01670000
         SR    R3,RF                                           @D52VDKH 01671000
         S     R1,BVISTAB         PREREQ FOR CORRECT SHIFTS    @DY42692 01672000
         A     R1,SAVR2ND7        JUMP TO 1ST VISTAB BYTE OF   @DY42692 01673000
         LA    R1,1(,R1)          NEXT PAGE                    @DY42692 01674000
         SRL   R1,PNSHIFT-LDVBYTB(R3) R1 IDENTIFIES 1ST BYTE   @D52VDKH 01675000
         SLL   R1,PNSHIFT-LDVBYTB(R3) IN VISTAB OF NEXT PAGE   @D52VDKH 01676000
         A     R1,BVISTAB                                      @DY42692 01677000
         L     RF,PAGESIZE               CHECK IF ENOUGH       @D52VDKH 01678000
         SRL   RF,LDVBYTB(RB)            VISTAB BITS ARE       @D52VDKH 01679000
         USING SUBPCHN,R9                LEFT OVER TO          @D52VDKH 01680000
         A     RF,SPCHVSTB               SATISFY REQUEST       @D52VDKH 01681000
         DROP  R9                                              @D52VDKH 01682000
         A     RF,BVISTAB                                      @D52VDKH 01683000
         SR    RF,R1                                           @D52VDKH 01684000
         SLL   RF,LDBITBYT                                     @D52VDKH 01685000
         CR    R0,RF                                           @D52VDKH 01686000
         BH    GVSCPBER                  VISTAB EXHAUSTED      @D52VDKH 01687000
         B     GVSCMIR4              START SEARCH AGAIN        @D52VDKH 01688000
         DROP  RC                                              @D14CDJB 01689000
         EJECT                                                 @D14CDJB 01690000
***************************************************************@D149DJB 01691000
*                                                              @D149DJB 01692000
*   ROUTINE TO FREE PAGE DATA SET COPY AND TO CLEAR STORAGE    @D149DJB 01693000
*                                                              @D149DJB 01694000
*   MODULE FVFREPDS                                            @D149DJB 01695000
*        IF PART. REQ. AND EXECUTING REAL                      @D149DJB 01696000
*          CLEAR STORAGE                                       @D149DJB 01697000
*        ELSE                                                  @D149DJB 01698000
*          CALL PMR TO SET NO VALID COPY ON PDS AND TO CLEAR   @D149DJB 01699000
*          PAGES THAT ARE IN STORAGE                           @D149DJB 01700000
*          (ADVANTAGE: PAGES ARE NOT BROUGHT IN STORAGE FOR    @D52VDMZ 01701000
*          CLEAR. IF THE PAGE IS REFERENCED AGAIN NO PAGE FAULT@D52VDMZ 01702000
*          OCCURS. USER GETS A CLEARED FRAME.)                 @D52VDMZ 01703000
*          IF PAGES COULD NOT BE CLEARED BY PMR, CLEAR STORAGE @KD40295 01704000
*      EXIT FVFREPDS                                           @D149DJB 01705000
*   ENDMODULE FVFREPDS                                         @D149DJB 01706000
*                                                              @D149DJB 01707000
*     CALLED BY : FVPGMR                                       @D149DJB 01708000
*     CALLS     : PAGE MANAGER (AFREEPDS)                      @D149DJB 01709000
*                 (PAGE MANAGER LEAVES ALL REGISTERS UNCHANGED)@D149DJB 01710000
*                                                              @D149DJB 01711000
*     INPUT  : R0 --> FIRST BYTE TO BE FREED                   @D149DJB 01712000
*              R1 --> LAST BYTE TO BE FREED                    @D149DJB 01713000
*              RB  :  SYSTEM/PARTITION FREEVIS INDICATOR       @D149DJB 01714000
*              RC  :  ANCHOR TABLE                             @D149DJB 01715000
*     OUTPUT : RF = 0                                          @D52VDMZ 01716000
*     LINK   : R8                                              @D149DJB 01717000
*     WORK   : R0,R1,R2,R3                                     @D52VDMZ 01718000
*                                                              @D149DJB 01719000
         AGO    .CREATE2                                       @D14ZDJB 01720000
.FVFRPDS ANOP                                                  @D14ZDJB 01721000
.*             0123456789ABCDEF                                @D149DJB 01722000
&INPREG  SETC '1100000000011000'                               @D14ZDJB 01723000
&OUTREG  SETC '0000000000000001'                               @D14ZDJB 01724000
&WRKREG  SETC '1111000000000000'                               @D52VDKH 01725000
&NMDREG  SETC '0000111111111110'                               @D52VDMZ 01726000
&LINKR   SETC 'R8'                                             @D14ZDJB 01727000
&TBASE   SETC 'GVSUBR'                                         @D51IDMZ 01728000
.*EXCLSYMS=()                                                  @D52VDMZ 01729000
         AGO    .TESTALL                                       @D14ZDJB 01730000
.CREATE2 ANOP                                                  @D14ZDJB 01731000
***************************************************************@D149DJB 01732000
         SPACE 2                                               @D14CDJB 01733000
         USING ANCHTAB,RC                                      @D51IDKH 01734000
FVFREPDS DS    0H                                              @D14CDJB 01735000
*SGLINK  FVFREPDS,S,INPUT=(R0,R1,R8:LINK,RB,RC),OUTPUT=(RF),           *01736000
               WORK=(R0,R1-R3,RF),NOMODR=(R8),                         *01737000
               AMODE=31,SUBROUT=(GVFVMIR2)                              01738000
***************************************************************@D149DJB 01739000
* CALLED DURING                                                         01740000
*    FREEVIS SUBPOOL PROCESSING                                         01741000
*    FREEVIS ALL PROCESSING FOR FREEVIS EXCL. TASK SUBPOOL AND FETCH    01742000
*    SUBPOOL                                                            01743000
*    FREEVIS PROCESSING FOR PAGES THAT ARE ENQUEUED IN THE FREE QUEUE   01744000
***************************************************************@D149DJB 01745000
         TM    GVFVFLGS,GVFVABVE  LAST REQUEST FOR ABOVE       @D52VDKH 01746000
         BZ    FVFREP1            THEN DO NOT MIRROR           @D52VDKH 01747000
*SGLINK  GVFVMIR2,INPUT=(R0,R1,RC),OUTPUT=(R0,R1,RF),                  *01748000
               NOMODR=(R3,R4,R5,R6,R7,R8,R9,RA,RB,RC,RD,RE)             01749000
         SGAMSUBR SUBROUT=GVFVMIR2,  MIRROR RETURNED ADDRESS   @D52VDKH*01750000
               INPUT=(R0,R1,RC),                               @D52VDKH*01751000
               OUTPUT=(R0,R1,RF),                              @D52VDKH*01752000
               NOMOD=(R3,R4,R5,R6,R7,R8,R9,RA,RB,RC,RD,RE),    @D52VDKH*01753000
               LINK=(INLINE)                                   @D52VDKH 01754000
FVFREP1  DS    0H                                              @D52VDKH 01755000
         LTR   RB,RB              SVA OR SPACE REQUEST         @D52VDMZ 01756000
         BNZ   FVFREC00           YES => CALL PMR              @D52VDMZ 01757000
         L     RF,PCBPTR          GET CURRENT PCB              @D52VDMZ 01758000
         USING PCBADR,RF                                       @D51VDMZ 01759000
         L     RF,PCEPIB          GET CORRESPONDING PIB ADDR.  @D51VDMZ 01760000
         USING PIBADR,RF                                       @D14CDJB 01761000
         TM    PIBDATFL,PIBTRAM   PROGRAM RUNNING VIRTUAL      @D52VDMZ 01762000
         BO    FVFREC00           YES ===> CALL PMR            @D52VDMZ 01763000
         DROP  RF                                              @D52VDMZ 01764000
***************************************************************@D149DJB 01765000
*   CLEAR STORAGE FOR  EXECUTING REAL AND                               01766000
*                 ERROR DURING PMR PROCESSING                           01767000
***************************************************************@D149DJB 01768000
FVFREP00 DS    0H                                              @D52VDMZ 01769000
         LR    RA,R4              SAVE LINK REGISTER           @D14NDJB 01770000
         LR    RF,R5              SAVE SUBPOOL INDEX TABLE PTR @D14NDJB 01771000
         LR    R2,R0              GET START ADDRESS            @D14NDJB 01772000
FVFREP05 DS    0H                                              @D52VDMZ 01773000
         LR    R3,R1              GET END ADDRESS              @D14NDJB 01774000
         SR    R3,R2              GET                          @D52VDMZ 01775000
         LA    R3,D1(R3)               LENGTH                  @D14NDJB 01776000
         SR    R4,R4              INPUT REGISTERS              @D14NDJB 01777000
         LR    R5,R4                        FOR MOVE LONG      @D14NDJB 01778000
         C     R3,ADDRMSK         LENGTH <= 16MB - 1           @D52VDMZ 01779000
         BNH   FVFREP10           YES                          @D52VDMZ 01780000
         L     R3,ADDRMSK         CLEAR 16MB-1(MAX POS. LENGTH)@D52VDMZ 01781000
FVFREP10 DS    0H                                              @D52VDMZ 01782000
         MVCL  R2,R4              CLEAR STORAGE                @D14NDJB 01783000
         LTR   R2,R2              CLEARED TILL 2 GB-1          @D52VDMZ 01784000
         BNP   FVFREP20           YES                          @D52VDMZ 01785000
         CR    R2,R1              TOTAL AREA CLEARED           @D52VDMZ 01786000
         BNH   FVFREP05           NO                           @D52VDMZ 01787000
FVFREP20 DS    0H                                              @D52VDMZ 01788000
         LR    R4,RA              RESTORE LINK REGISTER        @D14NDJB 01789000
         LR    R5,RF              REST. SUBPOOL INDEX TABLE PTR@D14NDJB 01790000
         SR    RF,RF              SET RETURN CODE REGISTER     @D14CDJB 01791000
FVFREEXT L     RA,TCBPTR          RESTORE TCB POINTER          @D52VDMZ 01792000
         BR    R8                 ===> RETURN TO CALLER        @D14CDJB 01793000
         SPACE                                                          01794000
FVFREC00 DS    0H                                              @D52VDMZ 01795000
***************************************************************@D52VDMZ 01796000
*   CALL PMR TO SET NO VALID COPY ON PAGE DATA SET AND TO CLEAR         01797000
*   PAGES, THAT ARE IN STORAGE                                          01798000
*   ADVANTAGE:                                                          01799000
*   FREEVIS    ONLY PAGES THAT ARE IN STORAGE ARE CLEARED.              01800000
*              PAGES NOT IN STORAGE NEED NOT TO BE CLEARED. NO VALID    01801000
*              COPY BIT IS SET. (SEE FOLLOWING GETVIS DESCRIPTION)      01802000
*   GETVIS     IF A PAGE IS REFERENCED BY A FOLLOWING GETVIS REQUEST    01803000
*              THAT IS NOT IN STORAGE THE USER GETS A CLEARED FRAME.    01804000
*              NO PAGE-IN FROM PAGE DATA SET.                           01805000
*    FREEVIS SUBPOOL                                                    01806000
*    FREEVIS ALL PROCESSING FOR FREEVIS EXCL. TASK SUBPOOL AND FETCH    01807000
*    SUBPOOL                                                            01808000
*    FREEVIS PROCESSING FOR PAGES THAT ARE ENQUEUED IN THE FREE QUEUE   01809000
*    PMR I/F                                                            01810000
*     INPUT:  R0, R1 (BEGIN-,END ADDRESS), R7, R8                       01811000
*     OUTPUT: RF =0 FUNCTION COMPLETED SUCCESSFULLY                     01812000
*             RF =4 AT LEAST ONE PAGE NOT CLEARED (PAGE CONNECTED)      01813000
***************************************************************@D149DJB 01814000
         LR    R3,R7              SAVE LINK REGISTER           @KD40295 01815000
         LR    RA,R8              SAVE LINK REGISTER           @D14CDJB 01816000
         L     R8,APMGMDAT        SET BIT 0 ON TO REQUEST...   @D14CDJB 01817000
         O     R8,BIT0OMSK        CLEAR OF PAGES IN STORAGE    @D14CDJB 01818000
         USING PMGMDATA,R8        DATA AREA ADDRESSABILITY     @D14CDJB 01819000
         L     R7,AFREEPDS        ADDRESS OF FREEPDS ROUTINE   @D14CDJB 01820000
         DROP  R8                                              @D14CDJB 01821000
*        AMODESW CALL,REGS=(R7,R7) CALL PAGE MANAGER ROUTINE   @D52VDMZ 01822000
         AMODESW CALL,REGS=(R7,R7) CALL PAGE MANAGER ROUTINE   @D52VDMZ 01823000
         LR    R8,RA              RESTORE LINK REGISTER        @D14CDJB 01824000
         LR    R7,R3              RESTORE LINK REGISTER        @KD40295 01825000
         LTR   RF,RF              SUCCESSFULLY CLEARED         @KD40295 01826000
         BZ    FVFREEXT           YES                          @KD40295 01827000
         B     FVFREP00           NO, DO CLEAR AREA            @KD40295 01828000
         SPACE                                                          01829000
         DROP  RC                                              @D51IDKH 01830000
         EJECT                                                 @D14ZDJB 01831000
***************************************************************@D149DJB 01832000
*                                                              @D149DJB 01833000
*   ROUTINE TO SET THE STORAGE KEY OF A GIVEN ADDRESS RANGE    @D149DJB 01834000
*                                                              @D149DJB 01835000
*   MODULE GFSTKEYP                                            @D52VDMZ 01836000
*       CALL PAGE MANAGER TO SET STORAGE KEY                   @D149DJB 01837000
*   ENDMODULE GFSTKEYP                                         @D149DJB 01838000
*                                                              @D149DJB 01839000
*     CALLED BY : GETVIS   GTVSINIT                            @D149DJB 01840000
*                 FREEVIS  FVPGMR                              @D149DJB 01841000
*     CALLS     : PAGE MANAGER (AINVPSUB) (370/ESA MODE)       @D149DJB 01842000
*                                                              @D149DJB 01843000
*     INPUT  : R0 --> START ADDRESS OF AREA                    @D149DJB 01844000
*              R1 --> END ADDRESS OF AREA                      @D149DJB 01845000
*              R2  :  REQUESTED KEY                            @D52VDKH 01846000
*              RA  :  TCBPTR                                   @D52VDMZ 01847000
*              RB  :  PARTITION/SPACE/SYSTEM GETVIS/FREEVIS    @D51IDMZ 01848000
*                     INDICATOR (MODE = 370/ESA ONLY)          @D149DJB 01849000
*              RC  :  POINTER TO CONTROL INFORMATION                    01850000
*     OUTPUT : RF = 0                                          @D51IDKH 01851000
*     LINK   : R8                                              @D149DJB 01852000
*     WORK   : R2,R9                                           @D149DJB 01853000
*                                                              @D149DJB 01854000
         AGO    .GFSTE                                         @D52VDMZ 01855000
.GFSTKYP ANOP                                                  @D52VDMZ 01856000
.*             0123456789ABCDEF                                @D52VDMZ 01857000
&INPREG  SETC '1110000000111000'                               @D52VDMZ 01858000
&OUTREG  SETC '0000000000000001'                               @D52VDMZ 01859000
&WRKREG  SETC '0010000001000000'                               @D52VDMZ 01860000
&NMDREG  SETC '1101111110111110'                               @D52VDMZ 01861000
&LINKR   SETC 'R8'                                             @D52VDMZ 01862000
&TBASE   SETC 'GVSUBR'                                         @D52VDMZ 01863000
.*EXCLSYMS=(TCBXXSA,TCBGVR12)                                  @D64ADMZ 01864000
.*EXCLSYMS=(SAVREG0,SAVREG1,SAVREG2,SAVREG3,SAVREG4,SAVREG5,SAVREG6)    01865000
.*EXCLSYMS=(SAVREG7,SAVREG8,SAVREG9)                                    01866000
         AGO    .TESTALL                                       @D14ZDJB 01867000
.GFSTE   ANOP                                                  @D52VDMZ 01868000
***************************************************************@D149DJB 01869000
         SPACE 2                                               @D14CDJB 01870000
         USING TCBADR,RA                                       @D64ADMZ 01871000
GFSTKEYP DS    0H                                              @D52VDMZ 01872000
*SGLINK  GFSTKEYP,S,INPUT=(R0,R1,R2,R8:LINK,RA,RB,RC),OUTPUT=(RF),     *01873000
               WORK=(R2,R9,RE),NOMODR=(R8),                            *01874000
               AMODE=31,                                               *01875000
               MODSYM=(SAVREG0,SAVREG1,SAVREG2,SAVREG3,SAVREG4,        *01876000
               SAVREG5,SAVREG6,SAVREG7,SAVREG8,SAVREG9,TCBXXSA,        *01877000
               TCBGVR12,SAVREGA,SAVREGB,SAVREGC,SAVREGD,SAVREGE,       *01878000
               SAVREGF),SUBROUT=(GVFVMIR2:IGN(R0,R1))                   01879000
*                                                                       01880000
* SPECIAL CASE:                                                         01881000
*   IF CONTROL AREA IS TO BE PROTECTED THEN MIRRORING MAY NOT BE DONE,  01882000
*   SINCE ADDRESSES ARE CORRECT                                         01883000
*                                                                       01884000
         CR    RC,R0              START ADDRESS EQUALS         @D52VDKH 01885000
         BE    GFSK1              BEGIN OF CONTROL INFO, ==>   @D52VDKH 01886000
         USING ANCHTAB,RC                                      @D52VDKH 01887000
         TM    GVFVFLGS,GVFVABVE  REQUEST FOR ABOVE            @D52VDKH 01888000
         BZ    GFSK1              THEN DO NOT MIRROR           @D52VDKH 01889000
*SGLINK  GVFVMIR2,INPUT=(R0,R1,RC),OUTPUT=(R0,R1,RF),                  *01890000
               NOMODR=(R3,R4,R5,R6,R7,R8,R9,RA,RB,RC,RD,RE)             01891000
         SGAMSUBR SUBROUT=GVFVMIR2, RE-MIRROR RETURNED ADDRESS @D52VDKH*01892000
               INPUT=(R0,R1,RC),                               @D52VDKH*01893000
               OUTPUT=(R0,R1,RF),                              @D52VDKH*01894000
               NOMOD=(R2,R3,R4,R5,R6,R7,R8,R9,RA,RB,RC,RD,RE), @D52VDKH*01895000
               LINK=(INLINE)                                   @D52VDKH 01896000
GFSK1    DS    0H                                              @D52VDKH 01897000
         LTR   RB,RB              PARTITION REQUEST ?          @D51IDKH 01898000
         BNZ   GFSKSVAC           NO                           @D51IDKH 01899000
         SPACE 1                                               @D14CDJB 01900000
*   FOR A PARTITION, THE GETVIS CONTROL AREA CANNOT BE USED TO          01901000
*   SAVE REGISTERS, SINCE AT INITIALIZATION SETKEY IS CALLED            01902000
*   TO PROTECT THE CONTROL AREA. THE PAGE MGR CLEARS THE PAGE           01903000
         L     RF,TCBATCBE                                     @D64ADKH 01904000
         USING TCBXADR,RF                                      @D64ADKH 01905000
         TM    TCBXSAUS,TCBXXSAU SAVE AREA FREE                @D64ADMZ 01906000
         BZ    GFSKPAR           YES                           @D64ADMZ 01907000
         ST    R5,GFREG5         SAVE R5                       @D64ADMZ 01908000
         BAL   R5,SYSERROR       NO, MUST NOT OCCUR            @D64ADMZ 01909000
GFREG5   DC    F'0'              ORIGINAL CONTENTS OF R5       @D64ADMZ 01910000
GFSKPAR  DS    0H                                                       01911000
         OI    TCBXSAUS,TCBXXSAU SAVE AREA IN USE              @D64ADMZ 01912000
         STM   RB,RE,TCBXXSA     SAVE REGISTERS IN TCB         @D64ADKH 01913000
         STM   R3,R8,TCBXXSA+16                                @D64ADKH 01914000
         DROP  RF                                              @D64ADKH 01915000
         L     R7,AGSKSVAR       RETURN ADDRESS FOR PAGE MGR   @D52VDMZ 01916000
         B     GFSKPMR                                         @D51IDKH 01917000
GFSKSVAC EQU   *                                               @D51IDKH 01918000
         STM   R0,RF,SAVREGS      SAVE REGS IN CONTROL AREA    @D51IDKH 01919000
         ST    RC,TCBGVR12        PAGE MGR MAY DESTROY RC      @D51IDKH 01920000
         L     R7,AGFSKPGM        RETURN ADDRESS FOR PAGE MGR  @D52VDMZ 01921000
         DROP  RA                                              @D14CDJB 01922000
GFSKPMR  EQU   *                                               @D51IDKH 01923000
*  WATCH OUT: RE IS BASE REGISTER FOR CODE                              01924000
         DROP  RE                 RELEASE CODE BASE            @D52VDMZ 01925000
         LR    RE,R7              RETURN ADDRESS FOR PAGE MGR  @D51IDKH 01926000
         LR    RD,R0              START OF AREA                @D14CDJB 01927000
         L     R9,AINVPSUB        ADDRESS OF P INVALIDATION RT @D14NDJB 01928000
         LR    R5,R2              KEY FOR PAGE MANAGER         @D14CDJB 01929000
* TO CALL THE PMR ROUTINE, AMODESW RETURN IS USED (BRANCH TO   @D52VDMZ 01930000
* THE PMR ROUTINE). THE PAGE MANAGER RETURNS TO REGISTER RE    @D52VDMZ 01931000
* WITH AMODESW RETURN. AMODESW CALL CANNOT BE USED TO CALL THE @D52VDMZ 01932000
* PMR, BECAUSE THE MACRO LOADS THE FOLLOWING ADDRESS IN THE    @D52VDMZ 01933000
* RETURN ADDRESS.                                              @D52VDMZ 01934000
* AMODESW RETURN,REG=(R9)         CALL PAGE MANAGER ROUTINE    @D52VDMZ 01935000
         AMODESW RETURN,REG=(R9)  CALL PAGE MANAGER ROUTINE    @D52VDMZ 01936000
         USING GVFVSUBR,RE        RE-ESTABLISH BASE            @D52VDMZ 01937000
         USING TCBADR,RA                                       @D51IDKH 01938000
GFSKSVAR DS    0H                                              @D51IDKH 01939000
         L     RA,TCBPTR          GET BACK RC FROM TCB         @D51IDKH 01940000
         L     RF,TCBATCBE                                     @D64ADKH 01941000
         USING TCBXADR,RF                                      @D64ADKH 01942000
         LM    RB,RE,TCBXXSA     RESTORE REGISTERS             @D64ADKH 01943000
         LM    R3,R8,TCBXXSA+16                                @D64ADKH 01944000
         NI    TCBXSAUS,X'FF'-TCBXXSAU  SAVE AREA FREE         @D64ADMZ 01945000
         DROP  RF                                              @D64ADKH 01946000
         SR    RF,RF              RESET RETURN CODE            @D51IDKH 01947000
         TM    GVFVFLGS,GVFVABVE  REQUEST FOR ABOVE            @D52VDKH 01948000
         BZ    GFSK3              THEN DO NOT MIRROR           @D52VDKH 01949000
*SGLINK  GVFVMIR2,INPUT=(R0,R1,RC),OUTPUT=(R0,R1,RF),                  *01950000
               NOMODR=(R3,R4,R5,R6,R7,R8,R9,RA,RB,RC,RD,RE)             01951000
         SGAMSUBR SUBROUT=GVFVMIR2, RE-MIRROR RETURNED ADDRESS @D52VDKH*01952000
               INPUT=(R0,R1,RC),                               @D52VDKH*01953000
               OUTPUT=(R0,R1,RF),                              @D52VDKH*01954000
               NOMOD=(R2,R3,R4,R5,R6,R7,R8,R9,RA,RB,RC,RD,RE), @D52VDKH*01955000
               LINK=(INLINE)                                   @D52VDKH 01956000
GFSK3    DS    0H                                              @D52VDKH 01957000
         BR    R8                 ===> RETURN TO CALLER        @D14CDJB 01958000
GFSKPGM  EQU   *                                               @D14CDJB 01959000
         L     RA,TCBPTR          GET BACK RC FROM TCB         @D51IDKH 01960000
         L     RC,TCBGVR12                                              01961000
         LM    R0,RF,SAVREGS      RESTORE ALL REGS             @D51IDKH 01962000
         SR    RF,RF              RESET RETURN CODE            @D51IDKH 01963000
         TM    GVFVFLGS,GVFVABVE  REQUEST FOR ABOVE            @D52VDKH 01964000
         BZ    GFSK2              THEN DO NOT MIRROR           @D52VDKH 01965000
*SGLINK  GVFVMIR2,INPUT=(R0,R1,RC),OUTPUT=(R0,R1,RF),                  *01966000
               NOMODR=(R3,R4,R5,R6,R7,R8,R9,RA,RB,RC,RD,RE)             01967000
         SGAMSUBR SUBROUT=GVFVMIR2, RE-MIRROR RETURNED ADDRESS @D52VDKH*01968000
               INPUT=(R0,R1,RC),                               @D52VDKH*01969000
               OUTPUT=(R0,R1,RF),                              @D52VDKH*01970000
               NOMOD=(R2,R3,R4,R5,R6,R7,R8,R9,RA,RB,RC,RD,RE), @D52VDKH*01971000
               NOMODS=(SAVREGS),                               @D52VDKH*01972000
               LINK=(INLINE)                                   @D52VDKH 01973000
GFSK2    DS    0H                                              @D52VDKH 01974000
         BR    R8                 ===> RETURN TO CALLER        @D14CDJB 01975000
         DROP  RC                 DROP ANCHTAB                 @D51IDKH 01976000
         DROP  RA                 RELEASE TCB                  @D64ADMZ 01977000
         DS    0F                                              @D52VDMZ 01978000
AGFSKPGM DC    AL1(128),AL3(GFSKPGM)                           @D52VDMZ 01979000
AGSKSVAR DC    AL1(128),AL3(GFSKSVAR)                          @D52VDMZ 01980000
.VMP00   ANOP                                                  @D52VDMZ 01981000
         EJECT                                                 @D14CDJB 01982000
***************************************************************@D149DJB 01983000
*                                                              @D149DJB 01984000
*   ROUTINE TO SCAN THE SUBPOOL INDEX TABLE FOR A GIVEN NAME   @D149DJB 01985000
*                                                              @D149DJB 01986000
*   MODULE GFSCINDT                                            @D149DJB 01987000
*     IF NAME FOUND IN SUBPOOL INDEX TABLE                     @D149DJB 01988000
*       THEN SET RC = 00                                       @D149DJB 01989000
*       ELSE SET RC = 16                                       @D149DJB 01990000
*     EXIT GFSCINDT                                            @D149DJB 01991000
*   ENDMODULE GFSCINDT                                         @D149DJB 01992000
*                                                              @D149DJB 01993000
*     CALLED BY : GETVIS   FREEVIS                             @D149DJB 01994000
*     CALLS     :  ---                                         @D149DJB 01995000
*                                                              @D149DJB 01996000
*     INPUT  : R3 --> NAME TO LOOK FOR                         @D149DJB 01997000
*              RC --> ANCHOR TABLE                             @D149DJB 01998000
*              RD --> SAVE AREA                                @D52VDMZ 01999000
*     OUTPUT : R2 --> ENTRY IN SUBPOOL ID TABLE                @D149DJB 02000000
*              R3  :  SUBPOOL OFFSET                           @D149DJB 02001000
*              RF  :  RETURN CODE : 10 (ENTRY NOT FOUND)       @D149DJB 02002000
*     LINK   : R8                                              @D149DJB 02003000
*     WORK   : R5                                              @D149DJB 02004000
*                                                              @D149DJB 02005000
         AGO    .CREATE4                                       @D14ZDJB 02006000
.GFSCIND ANOP                                                  @D14ZDJB 02007000
.*             0123456789ABCDEF                                @D149DJB 02008000
&INPREG  SETC '0001000000001100'                               @D14ZDJB 02009000
&OUTREG  SETC '0011000000000001'                               @D14ZDJB 02010000
&WRKREG  SETC '0000010000000000'                               @D14ZDJB 02011000
&NMDREG  SETC '1100101111111110'                               @D14ZDJB 02012000
&LINKR   SETC 'R8'                                             @D14ZDJB 02013000
&TBASE   SETC 'GVSUBR'                                         @D51IDMZ 02014000
.*EXCLSYMS=()                                                  @D52VDMZ 02015000
         AGO    .TESTALL                                       @D14ZDJB 02016000
.CREATE4 ANOP                                                  @D14ZDJB 02017000
***************************************************************@D149DJB 02018000
         SPACE 2                                               @D14CDJB 02019000
         USING ANCHTAB,RC                                      @D14CDJB 02020000
         USING SVEARA,RD                                       @D51IDKH 02021000
GFSCINDT DS    0H                                              @D14CDJB 02022000
*SGLINK  GFSCINDT,S,INPUT=(R3,R8:LINK,RC,RD),OUTPUT=(R2,R3,RF),        *02023000
               WORK=(R2,R5),NOMODR=(R8),                               *02024000
               AMODE=31                                                 02025000
         LH    R5,MXSUBPLH        GET LOOP COUNTER             @D14CDJB 02026000
         L     R2,BSUBPIND        GET START OF INDEX TABLE     @D14CDJB 02027000
         USING SUBPINT,R2                                      @D14CDJB 02028000
         LTR   R5,R5              ONLY SUBPOOL 0 PRESENT ?     @D14CDJB 02029000
         BZ    GFSCIERR           YES ===>                     @D14CDJB 02030000
GFSCITLP EQU   *                                               @D14CDJB 02031000
         LA    R2,SUBPINTL(R2)    GOTO NEXT SUBPOOL ENTRY      @D14CDJB 02032000
         CLC   SPITNAME(L'SPITNAME),D0(R3)   ENTRY FOUND ?     @D14CDJB 02033000
         BE    GFSCITFD           ==> YES                      @D14CDJB 02034000
GFSCIAGN EQU   *                                               @D51IDKH 02035000
         BCT   R5,GFSCITLP        REPEAT LOOP                  @D14CDJB 02036000
GFSCIERR EQU   *                                               @D14CDJB 02037000
         LA    RF,SMERR10         SET RETURN CODE              @D14CDJB 02038000
         BR    R8                 ==> RETURN TO CALLER         @D14CDJB 02039000
GFSCITFD EQU   *                                               @D14CDJB 02040000
***************************************************************         02041000
*  IF A NEW SUBPOOL IS TO BE CREATED (SPITNAME = ZERONAME)              02042000
*  SPITPIK IS NOT PART OF THE NAME (IS NOT YET VALID).                  02043000
*  IT'S SUFFICIENT TO CHECK ONLY THE FIRST BYTE SINCE ZERONAME          02044000
*  IS THE ONLY SUBPOOL THAT IS ALLOWED TO BE SPECIFIED WITH FIRST       02045000
*  BYTE EQUAL TO ZERO                                                   02046000
***************************************************************         02047000
         CLI  D0(R3),X00         FIRST BYTE OF ZERONAME  ?     @D51IDMZ 02048000
         BE   GFSCINP            YES , EMPTY ENTRY FOUND       @D51IDMZ 02049000
***************************************************************         02050000
*  FOR A SPACE REQUEST, THE PIK IS PART OF THE SUBPOOL'S NAME.          02051000
*  FOR A SVA OR PARTITION REQUEST, X'FFFF' IS USED INSTEAD.             02052000
***************************************************************         02053000
         TM    SVER0F+D2,GVFVSPIN  SPACE REQUEST               @D51IDKH 02054000
         BZ    GFSCINS             NO, USE X'FFFF'             @D51IDKH 02055000
         LH    RF,PIK              YES, USE PARTITION'S PIK    @D51IDKH 02056000
         B     GFSCICMP                                        @D51IDKH 02057000
GFSCINS  EQU   *                                               @D51IDKH 02058000
         LA    RF,1                                            @D51IDKH 02059000
         LNR   RF,RF                                           @D51IDKH 02060000
GFSCICMP EQU   *                                               @D51IDKH 02061000
         CH    RF,SPITPIK         PIK DOES NOT MATCH           @D51IDKH 02062000
         BNE   GFSCIAGN           CHECK REST OF SUBPOOLS                02063000
GFSCINP  DS    0H                                              @D51IDKH 02064000
         SR    RF,RF                                           @D51IDKH 02065000
         LR    R3,R2              GET PTR TO ENTRY             @D14CDJB 02066000
         S     R3,BSUBPIND        SUBTRACT START ADDRESS       @D14CDJB 02067000
         BR    R8                 ==> RETURN TO CALLER         @D14CDJB 02068000
         DROP  R2,RC,RD                                        @D51IDKH 02069000
         EJECT                                                 @D14CDJB 02070000
***************************************************************@D149DJB 02071000
*                                                              @D149DJB 02072000
*   ROUTINE TO DEQUEUE PAGE(S) FROM ONE SUBPOOL AND ENQUEUE    @D149DJB 02073000
*   THESE PAGES TO ANOTHER ONE WITH THE FOLLOWING SCHEME :     @D149DJB 02074000
*           POOL OF EMPTY PAGES <----> SUBPOOL                 @D149DJB 02075000
*      GETVIS : POOL OF EMPTY PAGES --> SUBPOOL                @D149DJB 02076000
*                 (DEQUEUE)         --> (ENQEUEU)              @D149DJB 02077000
*      FREEVIS: SUBPOOL             --> POOL OF EMPTY PAGES    @D149DJB 02078000
*                 (DEQUEUE)         --> (ENQEUEU)              @D149DJB 02079000
*   NOTE THAT IF MORE THAN ONE PAGE ARE TO BE DEQUEUED/EN-     @D149DJB 02080000
*   QUEUED THESE PAGES ARE CONTIGUOUS.                         @D149DJB 02081000
*                                                              @D149DJB 02082000
*   MODULE GFENQDEQ                                            @D149DJB 02083000
*    DEQUEUE PROCESSING                                        @D149DJB 02084000
*     REMOVE ENTRIES FROM DEQUEUE CHAIN                        @D149DJB 02085000
*     UPDATE SPCHFLAG IN CORRESPONDING DEQUEUE CHAIN ENTRY     @D149DJB 02086000
*     UPDATE SPITFIRST IF NECESSARY                            @D149DJB 02087000
*     IF DEQUEUE FROM POOL OF EMPTY PAGES                      @D51XDMZ 02088000
*       THEN UPDATE SPITCURP                                   @D149DJB 02089000
*     IF DEQUEUE FROM SUBPOOL AND SUBPOOL EMPTY                @D51XDMZ 02090000
*       THEN UPDATE SPITCURP,SPITRLVB,SPITBITO                 @D51XDMZ 02091000
*    ENQUEUE PROCESSING                                        @D149DJB 02092000
*     UPDATE SPITFIRST IF NECESSARY                            @D149DJB 02093000
*     UPDATE SPITCURP IF POOL OF EMPTY PAGES AND POOL EMPTY    @D51XDMZ 02094000
*     ENQUEUE ENTRIES IN ENQUEUE CHAIN                         @D149DJB 02095000
*     SET CONCATENATION FLAG IN CORRESPONDING ENTRIES IF       @D149DJB 02096000
*                                                NECESSARY     @D149DJB 02097000
*     IF DEQUEUE FROM CHAIN OF EMPTY PAGES                     @D149DJB 02098000
*       THEN UPDATE CHAIN OF LAST USED PAGES  ?                @D149DJB 02099000
*   ENDMODULE GFENQDEQ                                         @D149DJB 02100000
*                                                              @D149DJB 02101000
*    CALLED BY : GETVIS   GVSBPOOL GVGPMIN1                    @D149DJB 02102000
*                FVSBPOOL FVCHKEPG                             @D149DJB 02103000
*    CALLS     :   ---                                         @D149DJB 02104000
*                                                              @D149DJB 02105000
*     INPUT  : R2 --> ENQUEUE SUBPOOL INDEX TABLE ENTRY        @D149DJB 02106000
*              R3 --> CHAIN TABLE ENTRY TO FIRST DEQUEUE PAGE  @D149DJB 02107000
*              R4  :  NUMBER OF PAGES TO BE ENQUEUED/DEQUEUED  @D149DJB 02108000
*              R5 --> DEQUEUE SUBPOOL INDEX TABLE ENTRY        @D149DJB 02109000
*              R9 --> CHAIN TABLE ENTRY TO LAST DEQUEUE PAGE   @D149DJB 02110000
*              RC --> ANCHOR TABLE                             @D149DJB 02111000
*                                                              @D149DJB 02112000
*     OUTPUT : RF = 0                                          @D149DJB 02113000
*                                                              @D149DJB 02114000
*     LINK   : R8                                              @D149DJB 02115000
*     WORK   : R0,R1,R4                                        @D52VDMZ 02116000
*                                                              @D149DJB 02117000
         AGO    .CREATE5                                       @D14ZDJB 02118000
.GFENQDQ ANOP                                                  @D14ZDJB 02119000
.*             0123456789ABCDEF                                @D149DJB 02120000
&INPREG  SETC '0011110001001000'                               @D14ZDJB 02121000
&OUTREG  SETC '0000000000000001'                               @D14ZDJB 02122000
&WRKREG  SETC '1100100000000000'                               @D52VDMZ 02123000
&NMDREG  SETC '0011011111111110'                               @D52VDMZ 02124000
&LINKR   SETC 'R8'                                             @D14ZDJB 02125000
&TBASE   SETC 'GVSUBR'                                         @D51IDMZ 02126000
.*EXCLSYMS=()                                                  @D52VDMZ 02127000
         AGO    .TESTALL                                       @D14ZDJB 02128000
.CREATE5 ANOP                                                  @D14ZDJB 02129000
***************************************************************@D149DJB 02130000
         SPACE 2                                               @D14CDJB 02131000
         USING ANCHTAB,RC                                      @D14CDJB 02132000
GFENQDEQ DS    0H                                              @D14CDJB 02133000
*SGLINK  GFENQDEQ,S,INPUT=(R2,R3,R4,R5,R8:LINK,R9,RC),OUTPUT=(RF),     *02134000
               WORK=(R0,R1,R4,RF),NOMODR=(R8),                         *02135000
               AMODE=31                                                 02136000
         NI    GVFVFLGS,XFF-GVCHKPRO NO NEED TO CHECK PROTECT. @D64ADMZ 02137000
         LR    R0,R4              SAVE PAGE CTR (FROM GVGETPAG)@D14CDJB 02138000
         USING SUBPINT,R5                                      @D14CDJB 02139000
         USING SUBPCHN,R9                                      @D14CDJB 02140000
         C     R3,SPCHFORW        LAST CONTIGUOUS PAGE(S) ?    @D14CDJB 02141000
         BE    GFDEQLCP           YES ===>                     @D14CDJB 02142000
         DROP  R9                                              @D14CDJB 02143000
***************************************************************@D149DJB 02144000
*   UPDATE SPCHFLAG, SPCHFORW AND SPCHBACK IN DEQUEUE CHAIN    @D149DJB 02145000
*     AND SPITFRST IN DEQUEUE INDEX TABLE                      @D149DJB 02146000
*     (SPITCURP IS UPDATED ONLY IF POOL OF EMPTY PAGES)        @D51XDMZ 02147000
***************************************************************@D149DJB 02148000
         USING SUBPCHN,R3                                      @D14CDJB 02149000
         L     R1,SPCHBACK        GET BACKWARD PTR OF 1ST PAGE @D14CDJB 02150000
         DROP  R3                                              @D14CDJB 02151000
         USING SUBPCHN,R1                                      @D14CDJB 02152000
         NI    SPCHFLAG,XFF-SPPGCONC  RESET CONCATENATION FLAG @D14CDJB 02153000
         DROP  R1                                              @D14CDJB 02154000
         USING SUBPCHN,R9                                      @D14CDJB 02155000
         L     RF,SPCHFORW        GET FORW. PTR OF LAST PAGE   @D14CDJB 02156000
         DROP  R9                                              @D14CDJB 02157000
         USING SUBPCHN,R1                                      @D14CDJB 02158000
         ST    RF,SPCHFORW        STORE IT IN DEQUEUE CHAIN    @D14CDJB 02159000
         DROP  R1                                              @D14CDJB 02160000
         USING SUBPCHN,RF                                      @D14CDJB 02161000
         ST    R1,SPCHBACK        STORE IT IN DEQUEUE CHAIN    @D14CDJB 02162000
         DROP  RF                                              @D14CDJB 02163000
         B     GFDEQCNE                                        @D14CDJB 02164000
GFDEQLCP EQU   *                                               @D14CDJB 02165000
         LA    RF,D1              SET EMPTY INDICATOR          @D14CDJB 02166000
         LNR   RF,RF                  (NEGATIVE POINTER)       @D14CDJB 02167000
GFDEQCNE EQU   *                                               @D14CDJB 02168000
         C     R3,SPITFRST        FIRST POINTER TO BE CHANGED? @D14CDJB 02169000
         BH    GFDEQNFU           NO  ===>                     @D14CDJB 02170000
         ST    RF,SPITFRST        STORE NEW FIRST PAGE PTR     @D14CDJB 02171000
GFDEQNFU EQU   *                                               @D14CDJB 02172000
         C     R5,BSUBPIND        DEQUEUE FROM 'PAGE POOL' ?   @D14CDJB 02173000
         BNL   GFDEQCES           NO => CHECK FOR EMPTY SUBPOL @D51XDMZ 02174000
         L     R4,SPITCURP        GET CURRENT PTR              @D51XDMZ 02175000
         CR    R4,R9              CURRENT PTR INSIDE NEW CHAIN?@D14CDJB 02176000
         BH    GFENQ              YES ===>                     @D14CDJB 02177000
         CR    R4,R3              SPITCURP INSIDE NEW CHAIN ?  @D51XDMZ 02178000
         BL    GFENQ              YES ===>                     @D51XDMZ 02179000
         ST    RF,SPITCURP        STORE NEW CURRENT PTR        @D51XDMZ 02180000
         B     GFENQ                                           @D51XDMZ 02181000
GFDEQCES DS    0H                 CHECK FOR EMPTY SUBPOOL      @D51XDMZ 02182000
         LTR   RF,RF              SUBPOOL EMPTY ?              @D51XDMZ 02183000
         BNM   GFENQ              NO ==>                       @D51XDMZ 02184000
         ST    RF,SPITCURP        SPITCURP NO LONGER VALID     @D51XDMZ 02185000
         MVI   SPITRLVB,X00       RESET CURRENT VISTAB OFFSET  @D51XDMZ 02186000
         MVI   SPITBITO,X00       CLEAR BIT MASK VALUE         @D51XDMZ 02187000
         DROP  R5                                              @D14CDJB 02188000
***************************************************************@D149DJB 02189000
*   PROCESS ENQUEUE CHAIN                                      @D149DJB 02190000
*    IF ENQUEUE CHAIN IS EMPTY THEN                            @D51XDMZ 02191000
*      UPDATE SPITFRST                                         @D51XDMZ 02192000
*      IF ENQUEUE IN PAGE POOL THEN UPDATE SPITCURP            @D51XDMZ 02193000
*      IF ENQUEUE IN SUBPOOL THEN SPITCURP IS NOT UPDATED SINCE@D51XDMZ 02194000
*        IT IS USED AND UPDATED IN ROUTINE GVUPPI              @D51XDMZ 02195000
***************************************************************@D149DJB 02196000
GFENQ    EQU   *                                               @D14CDJB 02197000
         USING SUBPINT,R2                                      @D14CDJB 02198000
         L     R1,SPITFRST        GET PTR TO FIRST PAGE        @D51XDMZ 02199000
         LTR   R1,R1              IS ENQUEUE EMPTY ?           @D14CDJB 02200000
         BNM   GFENQCHK           NO  ===>                     @D14CDJB 02201000
         ST    R3,SPITFRST        GET PTR TO FIRST CHAIN PAGE  @D14CDJB 02202000
         C     R2,BSUBPIND        ENQUEUE IN PAGE POOL ?       @D51XDMZ 02203000
         BNL   GFENQ1             NO  ===>                     @D51XDMZ 02204000
         ST    R3,SPITCURP        GET PTR TO ENQUEUE CHAIN     @D14CDJB 02205000
GFENQ1   DS    0H                                              @D14CDJB 02206000
         USING SUBPCHN,R9                                      @D14CDJB 02207000
         ST    R3,SPCHFORW        CLOSE CHAIN                  @D14CDJB 02208000
         NI    SPCHFLAG,XFF-SPPGCONC  RESET CONCATENATION FLAG @D14CDJB 02209000
         DROP  R9                                              @D14CDJB 02210000
         USING SUBPCHN,R3                                      @D14CDJB 02211000
         ST    R9,SPCHBACK        CLOSE CHAIN                  @D14CDJB 02212000
         DROP  R3                                              @D14CDJB 02213000
         C     R5,BSUBPIND        DEQUEUE FROM 'PAGE POOL' ?   @D14CDJB 02214000
         BNL   GFENQEXX           NO  ===>                     @D14CDJB 02215000
         B     GFENQEX            ===>                         @D14CDJB 02216000
***************************************************************@D149DJB 02217000
*   CHECK ENQUEUE CHAIN                                        @D149DJB 02218000
*    IF PAGES ARE ENQUEUED IN SUBPOOL, SPITCURP CAN'T BE USED  @D51XDMZ 02219000
*    TO START SCAN, SINCE SPITCURP MIGHT BE ALREADY UPDATED    @D51XDMZ 02220000
*    DURING MIN1 PROCESSING, WHERE GFENQDEQ IS CALLED AFTER    @D51XDMZ 02221000
*    UPDATING THE CURRENT POINTER                              @D51XDMZ 02222000
***************************************************************@D149DJB 02223000
GFENQCHK EQU   *                                               @D14CDJB 02224000
         USING SUBPCHN,R1                                      @D14CDJB 02225000
         CR    R9,R1              NEW PAGES BEFORE OLD ONES?   @D14CDJB 02226000
         L     R1,SPCHBACK        GOTO LAST PAGE               @D14CDJB 02227000
         BL    GFENQUFP           YES ===>                     @D14CDJB 02228000
         CR    R3,R1              NEW PAGES BEHIND OLD ONES?   @D14CDJB 02229000
         BH    GFENQUPD           YES ===>                     @D14CDJB 02230000
         L     R1,SPITFRST        GET PTR TO FIRST PAGE        @D14CDJB 02231000
         C     R2,BSUBPIND        ENQUEUE IN PAGE POOL ?       @D51XDMZ 02232000
         BNL   GFENQLP            NO=>START SCAN AT FIRST PAGE @D51XDMZ 02233000
         L     R4,SPITCURP        GET CURRENT PAGE             @D51XDMZ 02234000
         CR    R3,R4              START SCAN AT FIRST PAGE ?   @D14CDJB 02235000
         BL    GFENQLP            YES ===>                     @D14CDJB 02236000
         LR    R1,R4              START SCAN AT CURRENT PAGE   @D14CDJB 02237000
***************************************************************@D149DJB 02238000
*   SCAN ENQUEUE CHAIN                                         @D149DJB 02239000
***************************************************************@D149DJB 02240000
GFENQLP  EQU   *                                               @D14CDJB 02241000
         C     R3,SPCHFORW        NEXT PAGE HIGHER ?           @D14CDJB 02242000
         BL    GFENQUPD           YES ===>                     @D14CDJB 02243000
         L     R1,SPCHFORW        GOTO NEXT PAGE               @D14CDJB 02244000
         B     GFENQLP            ===> REPEAT SCAN             @D14CDJB 02245000
***************************************************************@D149DJB 02246000
*   NOW ENQUEUE NEW PAGE(S) AND UPDATE POINTERS                @D149DJB 02247000
***************************************************************@D149DJB 02248000
GFENQUFP EQU   *                                               @D14CDJB 02249000
         ST    R3,SPITFRST        UPDATE FIRST PAGE PTR        @D14CDJB 02250000
GFENQUPD EQU   *                                               @D14CDJB 02251000
         L     R4,SPCHFORW        SAVE OLD FORWARD PTR         @D14CDJB 02252000
         ST    R3,SPCHFORW        STORE NEW FORWARD PTR        @D14CDJB 02253000
         LA    RF,SUBPCHNL(R1)    GOTO NEXT CHAIN ENTRY        @D14CDJB 02254000
         CR    RF,R3              NEXT PAGE CONTIGUOUS ?       @D14CDJB 02255000
         BNE   GFENQLNC           NO  ===>                     @D14CDJB 02256000
         OI    SPCHFLAG,SPPGCONC  SET CONCATENATION FLAG       @D14CDJB 02257000
         DROP  R1                                              @D14CDJB 02258000
GFENQLNC EQU   *                                               @D14CDJB 02259000
         USING SUBPCHN,R3                                      @D14CDJB 02260000
         ST    R1,SPCHBACK        STORE NEW BACKWARD PTR       @D14CDJB 02261000
         DROP  R3                                              @D14CDJB 02262000
         USING SUBPCHN,R9                                      @D14CDJB 02263000
         ST    R4,SPCHFORW        STORE NEW FORWARD PTR        @D14CDJB 02264000
         NI    SPCHFLAG,XFF-SPPGCONC  RESET CONCATENATION FLAG @D14CDJB 02265000
         LA    RF,SUBPCHNL(R9)    GOTO NEXT CHAIN ENTRY        @D14CDJB 02266000
         CR    RF,R4              NEXT PAGE CONTIGUOUS ?       @D14CDJB 02267000
         BNE   GFENQCFP           NO  ===>                     @D14CDJB 02268000
         OI    SPCHFLAG,SPPGCONC  SET CONCATENATION FLAG       @D14CDJB 02269000
         DROP  R9                                              @D14CDJB 02270000
GFENQCFP EQU   *                                               @D14CDJB 02271000
         USING SUBPCHN,R4                                      @D14CDJB 02272000
         ST    R9,SPCHBACK        STORE NEW BACKWARD PTR       @D14CDJB 02273000
         DROP  R4                                              @D14CDJB 02274000
         C     R5,BSUBPIND        DEQUEUE FROM 'PAGE POOL' ?   @D14CDJB 02275000
         BNL   GFENQEXX           NO  ===>                     @D14CDJB 02276000
***************************************************************@D149DJB 02277000
*   UPDATE PAGE USAGE COUNTS                                   @D149DJB 02278000
***************************************************************@D149DJB 02279000
GFENQEX  EQU   *                                               @D14CDJB 02280000
         L     R1,GTVSPGCT        GET ACTUAL PAGE COUNT        @D52VDKH 02281000
         AR    R1,R0              PLUS REQUESTED PAGES         @D14CDJB 02282000
         ST    R1,GTVSPGCT        UPDATE ACTUAL PAGE COUNT     @D52VDKH 02283000
         SGVSEPT PROBE=17         I/F TO PERFORMANCE TOOL      @D51IDMZ 02284000
         L     R1,SPITPUSC        GET PAGE USAGE COUNT         @D64ADMZ 02285000
         AR    R1,R0              PLUS REQUESTED PAGES         @D64ADMZ 02286000
         ST    R1,SPITPUSC        STORE PAGE USAGE COUNT       @D64ADMZ 02287000
         SR    R1,R1              CLEAR SUBPOOL ID FIELD       @D14CDJB 02288000
         B     GFENQEXA           ===> GOTO EXIT CODE          @D14CDJB 02289000
GFENQEXX EQU   *                                               @D14CDJB 02290000
         L     R1,GTVSPGCT        GET ACTUAL PAGE COUNT        @D52VDKH 02291000
         SR    R1,R0              MINUS PAGES GIVEN BACK       @D14CDJB 02292000
         ST    R1,GTVSPGCT        UPDATE ACTUAL PAGE COUNT     @D52VDKH 02293000
         SGVSEPT PROBE=17         I/F TO PERFORMANCE TOOL      @D51IDMZ 02294000
         L     R1,SPITPUSC-SUBPINT(R5) GET CURRENT PAGE USAGE ...       02295000
*                                 .. COUNT                     @D64ADMZ 02296000
         SR    R1,R0              SUBTRACT RETURNED PAGES      @D64ADMZ 02297000
         ST    R1,SPITPUSC-SUBPINT(R5) UPDATE PAGE USAGE COUNT @D64ADMZ 02298000
***************************************************************@D149DJB 02299000
*   UPDATE SUBPOOL ID (NUMBER) FIELD IN NEW CHAIN ENTRIES      @D149DJB 02300000
***************************************************************@D149DJB 02301000
GFENQEXA EQU   *                                               @D14CDJB 02302000
         LR    R4,R3              FIRST ENTRY TO BE UPDATED    @D14CDJB 02303000
         LH    R1,SPITNMBR        GET INDEX ENTRY NUMBER       @D51IDMZ 02304000
         C     R2,BSUBPIND        ENQUEUE FOR 'PAGE POOL' ?    @D14CDJB 02305000
         BNL   GFENQEXL           NO  ===>                     @D14CDJB 02306000
         LH    R1,XFFFF           FFFF IS ID FOR 'PAGE POOL'   @D51IDMZ 02307000
GFENQEXL EQU   *                                               @D14CDJB 02308000
         USING SUBPCHN,R4                                      @D14CDJB 02309000
         STH   R1,SPCHNMBR        INSERT NUMBER                @D51IDMZ 02310000
         CR    R4,R9              LAST ENTRY REACHED ?         @D14CDJB 02311000
         L     R4,SPCHFORW        GOTO NEXT PAGE               @D14CDJB 02312000
         BNE   GFENQEXL           NO  ===>                     @D14CDJB 02313000
         SR    RF,RF              RESET RETURN CODE REGISTER   @D14CDJB 02314000
         C     R2,BSUBPIND        ENQUEUE FOR 'PAGE POOL' ?    @D52VDMZ 02315000
         BLR   R8                 YES, RETURN                  @D52VDMZ 02316000
         OI    GVFVFLGS,GVCHKPRO  INDICATE PAGES ENQUEUED IN.. @D52VDMZ 02317000
         ST    R3,FPAGEPRO        .. SUBPOOL IN CASE OF..      @D52VDMZ 02318000
         ST    R9,LPAGEPRO        .. PROTECTION REQUEST        @D52VDMZ 02319000
         BR    R8                 ==> RETURN TO CALLER         @D14CDJB 02320000
         DROP  R2,R4                                           @D14CDJB 02321000
         DROP  RC                                              @D36IDJB 02322000
         EJECT                                                 @D14ZDJB 02323000
************************************************************** @D369DJB 02324000
*                                                                    RZ 02325000
*    VISTAB BIT SETTING ROUTINE                                @D369DJB 02326000
*                                                                    RZ 02327000
*        THIS ROUTINE SETS A BITSTRING IN THE VISTAB TO              RZ 02328000
*        '0'S OR  TO '1'S DEPENDING                                  RZ 02329000
*        ON REG 0 : X'FFFFFF00' OR X'000000FF'.                      RZ 02330000
*        THE START ADDRESS OF THE BITSTRING IS CONTAINED IN          RZ 02331000
*        SSEARCH,THE BIT # IN SVWORK1                                RZ 02332000
*                                                              @D149DJB 02333000
*    CALLED BY : GETVIS   GVSBPOOL                             @D149DJB 02334000
*                FREEVIS                                       @D149DJB 02335000
*    CALLS     :   ---                                         @D149DJB 02336000
*                                                              @D149DJB 02337000
*    INPUT  : R0  :  INDICATOR FOR BIT SETTING                 @D149DJB 02338000
*             R1 --> END ADDRESS OF BITSTRING                  @D149DJB 02339000
*             R3  :  BIT OFFSET IN LAST VISTAB BYTE            @D149DJB 02340000
*             RC --> ANCHOR TABLE                              @D149DJB 02341000
*             SSEARCH                                          @D149DJB 02342000
*             SVWORK1                                          @D149DJB 02343000
*    OUTPUT : NONE                                             @D149DJB 02344000
*    LINK   : R8                                               @D149DJB 02345000
*    WORK   : R2,R3,R4,R5                                      @D149DJB 02346000
*                                                                    RZ 02347000
         AGO    .CREATE6                                       @D14ZDJB 02348000
.SETVSTB ANOP                                                  @D14ZDJB 02349000
.*             0123456789ABCDEF                                @D149DJB 02350000
&INPREG  SETC '1101000000001000'                               @D14ZDJB 02351000
&OUTREG  SETC '0000000000000000'                               @D14ZDJB 02352000
&WRKREG  SETC '0011110000000000'                               @D14ZDJB 02353000
&NMDREG  SETC '1100001111111111'                               @D14ZDJB 02354000
&LINKR   SETC 'R8'                                             @D14ZDJB 02355000
&TBASE   SETC 'GVSUBR'                                         @D51IDMZ 02356000
.*EXCLSYMS=(SVWORK1,SSEARCH)                                   @D52VDMZ 02357000
         AGO    .TESTALL                                       @D14ZDJB 02358000
.CREATE6 ANOP                                                  @D14ZDJB 02359000
************************************************************** @D369DJB 02360000
         SPACE 3                                                        02361000
         USING ANCHTAB,RC                                      @D14CDJB 02362000
         USING SVEARA,RD                                       @D14CDJB 02363000
SETVSTAB DS    0H                                              @D14CDJB 02364000
*SGLINK  SETVSTAB,S,INPUT=(R0,R1,R3,R8:LINK,RC),                       *02365000
               WORK=(R2,R3,R4,R5),NOMODR=(R8),                         *02366000
               AMODE=31,MODSYM=(SVWORK1,SSEARCH)                        02367000
         L     R2,SSEARCH         GET START ADDR. OF BITSTRING @D14CDJB 02368000
         SR    R4,R4              CLEAR WORKREGISTER           @D367DJB 02369000
         IC    R4,0(R2)           GET FIRST BYTE               @D14CDJB 02370000
PCKGVIS2 EQU   *                  IF ANCHOR TABLE OVERLAYED    @DA11894 02371000
         CR    R2,R1              ONLY ONE BYTE TO BE UPDATED? @D14CDJB 02372000
         BNE   GETVISMO           NO  ===>                     @D14CDJB 02373000
***************************************************************@D149DJB 02374000
*    ONLY ONE BYTE IN THE VISTAB HAS TO BE UPDATED             @D149DJB 02375000
***************************************************************@D149DJB 02376000
         LNR   R3,R3              COMPL. OF LAST BIT # IN BYTE @D367DJB 02377000
         LA    R3,BITBYT(R3)                                   @D367DJB 02378000
         SRDA  R4,0(R3)           SAVE LAST BITS IN BYTE       @D367DJB 02379000
         A     R3,SVWORK1         GET BIT # OF FIRST BIT       @D367DJB 02380000
         SLA   R4,0(R3)           SAVE FIRST BITS IN BYTE      @D367DJB 02381000
         LTR   R0,R0              TEST SET/RESET               @D367DJB 02382000
         BM    GETVIS35 .         RESET                              WF 02383000
         OR    R4,R0              SET LAST BYTE TO X'FF'       @D367DJB 02384000
         B     GETVIS36 .                                            WF 02385000
GETVIS35 NR    R4,R0              RESET LAST BYTE TO X'00'     @D367DJB 02386000
GETVIS36 SRA   R4,0(R3)           SHIFT BACK FIRST BITS        @D367DJB 02387000
         S     R3,SVWORK1         SUBTR. SHIFT # OF LAST BITS  @D367DJB 02388000
         SLDA  R4,0(R3)           SHIFT BACK LAST BITS         @D367DJB 02389000
         B     GETVIS33 .         GO TO STORE BYTE BACK INTO VISTAB  RZ 02390000
***************************************************************@D149DJB 02391000
*    MORE THAN ONE BYTE IN THE VISTAB HAS TO BE UPDATED        @D149DJB 02392000
***************************************************************@D149DJB 02393000
GETVISMO EQU   *                                               @D14CDJB 02394000
         L     R5,SVWORK1         GET BIT # IN FIRST BYTE      @D367DJB 02395000
         SLL   R4,0(R5)           SAVE FIRST BITS IN FIRST BYTE@D367DJB 02396000
         LTR   R0,R0              TEST SET/RESET               @D367DJB 02397000
         BM    GETVS29A           RESET                              RZ 02398000
         OR    R4,R0              SET LAST BYTE TO X'FF'       @D367DJB 02399000
         B     GETVS29B                                              RZ 02400000
GETVS29A EQU   *                                               @D35EDJB 02401000
         NR    R4,R0              SET LAST BYTE TO X'00'       @D367DJB 02402000
GETVS29B EQU   *                                               @D35EDJB 02403000
         SRL   R4,0(R5)           REST. FIRST BITS IN 1. BYTE  @D367DJB 02404000
         STC   R4,0(R2)           STORE BYTE BACK INTO VISTAB  @D367DJB 02405000
GETVIS30 EQU   *                                               @D14CDJB 02406000
         SR    R5,R5                                           @D218DKH 02407000
         LTR   R0,R0              SET OR RESET BITS            @D218DKH 02408000
         BM    GETVIS31           RESET ===>                   @D218DKH 02409000
         BCTR  R5,0               SET R5 TO X'FFFFFFFF'        @D218DKH 02410000
GETVIS31 EQU   *                                               @D14CDJB 02411000
         LR    R4,R2                                           @D218DKH 02412000
         LA    R2,D4(R2)          SEE IF THE NEXT 4 BYTES ARE  @D218DKH 02413000
         CR    R2,R1              TO BE MODIFIED ?             @D218DKH 02414000
         BNL   GETVIS34           NO ===>                      @D218DKH 02415000
         ST    R5,D1(R4)          SET/RESET THEM               @D218DKH 02416000
         B     GETVIS31           TRY AGAIN                    @D218DKH 02417000
GETVIS34 EQU   *                                               @D14CDJB 02418000
         LR    R2,R4                                           @D218DKH 02419000
GETVIS37 EQU   *                                               @D14CDJB 02420000
         LA    R2,D1(R2)          INCREASE POINTER             @D14CDJB 02421000
         CR    R2,R1              TEST END OF BITSTRING        @D14CDJB 02422000
         BNL   GETVIS32 .         BRANCH IF LAST BYTE                RZ 02423000
         STC   R0,0(R2)           SET/RESET ONE BYTE           @D14CDJB 02424000
PCKGVIS3 EQU   *                  IF ANCHOR TABLE OVERLAYED    @DA11894 02425000
         B     GETVIS37 .         CONTINUE TO NEXT BYTE        @D218DKH 02426000
GETVIS32 EQU   *                                               @D14CDJB 02427000
         IC    R4,D0(R2)          GET LAST BYTE                @D14CDJB 02428000
PCKGVIS4 EQU   *                  IF ANCHOR TABLE OVERLAYED    @DA11894 02429000
         LNR   R3,R3              COMPL. OF BIT # IN LAST BYTE @D367DJB 02430000
         SRDA  R4,BITBYT(R3)      SAVE LAST BITS IN BYTE       @D367DJB 02431000
         LTR   R0,R0              TEST SET/RESET               @D367DJB 02432000
         BM    GETVS32A           RESET                              RZ 02433000
         OR    R4,R0              SET BITS TO '1'              @D367DJB 02434000
         B     GETVS32B                                              RZ 02435000
GETVS32A EQU   *                                               @D35EDJB 02436000
         NR    R4,R0              RESET BITS TO '0'            @D367DJB 02437000
GETVS32B EQU   *                                               @D35EDJB 02438000
         SLDA  R4,BITBYT(R3)      RESTORE LAST BITS IN BYTE    @D367DJB 02439000
GETVIS33 EQU   *                                               @D14CDJB 02440000
         STC   R4,D0(R2)          STORE BYTE BACK INTO VISTAB  @D14CDJB 02441000
         AGO   .NOCMP01                                        @D14ZDJB 02442000
         LTR   R0,R0              GETVIS REQUEST ?             @D14CDJB 02443000
         BNM   STVSRET            YES ===> RETURN TO CALLER    @D14NDJB 02444000
         LTR   R0,R0              GETVIS REQUEST ?             @D14ZDJB 02445000
         BM    STVSRETX           NO  ===> CLEAR STORAGE       @D14ZDJB 02446000
         CLCL  R2,R4              STORAGE OVERWRITTEN          @D14ZDJB 02447000
         B     STVSRET            NO  ===> RETURN TO CALLER    @D14ZDJB 02448000
         LTR   RB,RB              SYSTEM REQUEST ?             @D14ZDJB 02449000
         BNZ   GVSYSERR           YES ===>                     @D14ZDJB 02450000
         CLM   R6,M7,DISPAD+D1    WAS IT CDLOAD REQUEST ?      @D14ZDJB 02451000
         BE    GVERR21            NO  ===>                     @D14ZDJB 02452000
         L     R6,DISPAD          GET DISPATCHER ADDRESS       @D14ZDJB 02453000
         USING DISP,R6                                         @D14ZDJB 02454000
         L     R5,PIBPTR2         USE PIB2 PTR....             @D51IDMZ 02455000
         USING PIB2ADR,R5         ... TO ACCESS PCB            @D51IDMZ 02456000
         L     R5,PIBPCB          GET PCB POINTER              @D51IDMZ 02457000
         USING PCBADR,R5                                       @D14ZDJB 02458000
         MVI   CDLDBYTE,ZERO      RESET CDLOAD OWNERSHIP       @D14ZDJB 02459000
         LA    R5,SRQCDL          POINT TO RESOURCE QUEUE      @D14ZDJB 02460000
         DROP  R5                                              @D14ZDJB 02461000
         BAL   RF,RPOST           FREE AND POST ALL WAITERS    @D14ZDJB 02462000
*SGLINK  RPOST,INPUT=(R5,R6,RF),WORK=(R5,RE)                   @D14ZDJB 02463000
GVERR21  B     ERR21              ===> CANCEL WITH ILLEGAL SVC @D14ZDJB 02464000
         DROP  R6                                              @D14ZDJB 02465000
GVSYSERR BAL   R5,SYSERROR        ===> GOTO HARD WAIT          @D14ZDJB 02466000
         DC    C'GETVIS SPACE OVERWRITTEN'                     @D14ZDJB 02467000
STVSRETX DS    0H                                              @D14ZDJB 02468000
STVSRET  EQU   *                                               @D14CDJB 02469000
.NOCMP01 ANOP                                                  @D14ZDJB 02470000
         BR    R8                 ===> RETURN TO CALLER        @D14CDJB 02471000
         DROP  RC,RD                                           @D14CDJB 02472000
         EJECT                                                 @D14CDJB 02473000
***************************************************************@D149DJB 02474000
*                                                              @D149DJB 02475000
*   ROUTINE TO RESET VISTAB BITS OF ONE PAGE .                 @D149DJB 02476000
*                                                              @D149DJB 02477000
*   MODULE STVSTBPG                                            @D149DJB 02478000
*       IF SVA REQUEST                                         @D149DJB 02479000
*         THEN RESET 16/32 BYTES FOR 2K/4K PAGES               @D149DJB 02480000
*         ELSE RESET 2/4 BYTES FOR 2K/4K PAGES                 @D149DJB 02481000
*   ENDMODULE STVSTBPG                                         @D149DJB 02482000
*                                                              @D149DJB 02483000
*     CALLED BY : FVSBPOOL                                     @D149DJB 02484000
*     CALLS     :   ---                                        @D149DJB 02485000
*                                                              @D149DJB 02486000
*     INPUT  : R9 --> SUBPOOL CHAIN ENTRY OF CORRESPONDING PAGE@D149DJB 02487000
*              RB  :  SYSTEM/PARTITION FREEVIS INDICATOR       @D149DJB 02488000
*              RC --> ANCHOR TABLE                             @D149DJB 02489000
*              RF  :  0                                        @D149DJB 02490000
*     OUTPUT : NONE                                            @D149DJB 02491000
*     LINK   : R8                                              @D149DJB 02492000
*     WORK   : R0,R4                                           @D149DJB 02493000
*                                                              @D149DJB 02494000
         AGO    .CREATEL                                       @D14ZDJB 02495000
.STVSBPG ANOP                                                  @D14ZDJB 02496000
.*             0123456789ABCDEF                                @D149DJB 02497000
&INPREG  SETC '0000000001011001'                               @D14ZDJB 02498000
&OUTREG  SETC '0000000000000000'                               @D14ZDJB 02499000
&WRKREG  SETC '1000100000000000'                               @D14ZDJB 02500000
&NMDREG  SETC '0111011111111111'                               @D14ZDJB 02501000
&LINKR   SETC 'R8'                                             @D14ZDJB 02502000
&TBASE   SETC 'GVSUBR'                                         @D51IDMZ 02503000
.*EXCLSYMS=()                                                  @D52VDMZ 02504000
         AGO    .TESTALL                                       @D14ZDJB 02505000
.CREATEL ANOP                                                  @D14ZDJB 02506000
***************************************************************@D149DJB 02507000
         SPACE 2                                               @D14CDJB 02508000
         USING SUBPCHN,R9                                      @D14CDJB 02509000
         USING ANCHTAB,RC                                      @D14CDJB 02510000
STVSTBPG DS    0H                                              @D14CDJB 02511000
*SGLINK  STVSTBPG,S,INPUT=(R8:LINK,R9,RB,RC,RF),                       *02512000
               WORK=(R0,R4),NOMODR=(R8),                               *02513000
               AMODE=31                                                 02514000
         L     R4,SPCHVSTB        GET PAGE RELATIVE VISTAB PTR @D51IDMZ 02515000
         A     R4,BVISTAB         GET PAGE VISTAB PTR          @D14CDJB 02516000
         LTR   RB,RB              SVA OR SPACE REQUEST ?       @D51IDKH 02517000
         BNZ   STVSTBSV           YES ===>                     @D14CDJB 02518000
         ST&H  RF,D0(R4)          RESET BYTES IN PART. VISTAB  @D14CDJB 02519000
         B     STVSTBPR           ===> RETURN TO CALLER        @D14CDJB 02520000
***************************************************************@D149DJB 02521000
*    RESET BYTES IN SVA VISTAB                                 @D149DJB 02522000
***************************************************************@D149DJB 02523000
STVSTBSV EQU   *                                               @D14CDJB 02524000
         LA    R0,SVBYTPPG/4      # OF 'REGISTERS' TO REPRESENT@D14CDJB 02525000
*                                         ONE SVA/SPACE PAGE   @D14CDJB 02526000
STVSTBLP EQU   *                                               @D14CDJB 02527000
         ST    RF,D0(R4)          RESET 4 VISTAB BYTES         @D14CDJB 02528000
         LA    R4,D4(R4)          GOTO NEXT 4 VISTAB BYTES     @D14CDJB 02529000
         BCT   R0,STVSTBLP        ===> CONTINUE RESETTING      @D14CDJB 02530000
STVSTBPR EQU   *                                               @D14CDJB 02531000
         BR    R8                 ===> RETURN TO CALLER        @D14CDJB 02532000
         DROP  R9,RC                                           @D14CDJB 02533000
         EJECT                                                 @D14CDJB 02534000
***************************************************************@D149DJB 02535000
*                                                              @D149DJB 02536000
*   ROUTINE TO PFIX/PFREE SVA SPACE                            @DA36550 02537000
*                                                              @D149DJB 02538000
*   MODULE GFSFIXSB                                            @D149DJB 02539000
*      OPEN GETVIS GATE                                        @D52VDMZ 02540000
*      CALL PAGE MANAGER TO PFIX AREA                          @DA36550 02541000
*      CLOSE GETVIS GATE                                       @D52VDMZ 02542000
*      EXIT GFSFIXSB                                           @D149DJB 02543000
*   ENDMODULE GFSFIXSB                                         @D149DJB 02544000
*                                                              @D149DJB 02545000
*     CALLED BY : GVPFIXSV                                     @D149DJB 02546000
*     CALLS     : PAGE MANAGER (ASFIXSUB) BY USING SPFIX       @D149DJB 02547000
*                                                              @D149DJB 02548000
*     INPUT  : R0 --> FIRST BYTE TO BE FIXED                   @D149DJB 02549000
*              R1 --> LAST BYTE TO BE FIXED                    @D149DJB 02550000
*              R6 --> IF DISPAD THEN SVC REQUEST               @D52VDMZ 02551000
*                     OTHERWISE INTERNAL CALL                  @D52VDMZ 02552000
*              RC --> PTR TO CONTROL INFO.                     @D52VDMZ 02553000
*              RD --> PTR SAVE AREA                            @D52VDMZ 02554000
*              RF = 0                                                   02555000
*     OUTPUT : RF                                              @D149DJB 02556000
*     LINK   : R8                                              @D149DJB 02557000
*     WORK   : R0, R1, R2, R5                                  @D52VDMZ 02558000
*                                                              @D149DJB 02559000
         AGO    .CREATEN                                       @D14ZDJB 02560000
.GFSFIXS ANOP                                                  @D14ZDJB 02561000
.*             0123456789ABCDEF                                @D149DJB 02562000
&INPREG  SETC '1100001000001100'                               @D52VDMZ 02563000
&OUTREG  SETC '0000000000000001'                               @D14ZDJB 02564000
&WRKREG  SETC '1110010000000000'                               @D52VDMZ 02565000
&NMDREG  SETC '0001101111111110'                               @D52VDMZ 02566000
&LINKR   SETC 'R8'                                             @D14ZDJB 02567000
&TBASE   SETC 'GVSUBR'                                         @D51IDMZ 02568000
.*EXCLSYMS=()                                                  @D52VDMZ 02569000
         AGO    .TESTALL                                       @D14ZDJB 02570000
.CREATEN ANOP                                                  @D14ZDJB 02571000
***************************************************************@D149DJB 02572000
         SPACE 2                                               @D14CDJB 02573000
         USING ANCHTAB,RC                                      @D51IDMZ 02574000
         USING SVEARA,RD                                       @D52VDMZ 02575000
GFSFIXSB DS    0H                                              @D14CDJB 02576000
*SGLINK  GFSFIXSB,S,INPUT=(R0,R1,R6,R8:LINK,RC,RD,RF),OUTPUT=(RF),     *02577000
               WORK=(R0-R2,R5,RF),NOMODR=(R8),                         *02578000
               AMODE=31,SUBROUT=(GVFVMIR2,GVFVGATING:IGN(R0-RF))        02579000
         SPACE                                                          02580000
         TM    GVFVFLGS,GVFVABVE  LAST REQUEST FOR ABOVE       @D52VDKH 02581000
         BZ    GFSFIX10           THEN DO NOT MIRROR           @D52VDKH 02582000
*SGLINK  GVFVMIR2,INPUT=(R0,R1,RC),OUTPUT=(R0,R1,RF),                  *02583000
               NOMODR=(R3,R4,R5,R6,R7,R8,R9,RA,RB,RC,RD,RE)             02584000
         SGAMSUBR SUBROUT=GVFVMIR2, RE-MIRROR RETURNED ADDRESS @D52VDKH*02585000
               INPUT=(R0,R1,RC),                               @D52VDKH*02586000
               OUTPUT=(R0,R1,RF),                              @D52VDKH*02587000
               NOMOD=(R2,R3,R4,R5,R6,R7,R8,R9,RA,RB,RC,RD,RE), @D52VDKH*02588000
               LINK=(INLINE)                                   @D52VDKH 02589000
GFSFIX10 DS    0H                                              @D52VDKH 02590000
         ST    R0,SVPFLIST        BEGIN OF AREA TO BE HANDLED  @D14CDJB 02591000
         SR    R1,R0              LENGTH OF AREA TO BE HANDLED @D14CDJB 02592000
         ST    R1,SVPFLIST+D4     STORE IT                     @D14CDJB 02593000
***************************************************************@D52VDMZ 02594000
*  OPEN GETVIS GATE                                            @D52VDMZ 02595000
***************************************************************@D52VDMZ 02596000
         L     R5,GVFVGATE        POINT TO RESOURCE DESCRIPTOR @D64ADKH 02597000
         LTR   R5,R5              IS IT ALLOWED TO OPEN GATE   @D64ADKH 02598000
         BM    GFSFIX12           YES                          @D64ADKH 02599000
         BAL   R5,SYSERROR        NO, MUST NOT OCCURR          @D64ADMZ 02600000
GFSFIX12 DS    0H                                              @D64ADMZ 02601000
         LA    R5,0(R5)                                        @D64ADKH 02602000
         ST    R5,GVFVGATE                                     @D64ADKH 02603000
         ST    R5,GVFVGATE_SAV    GVFVGATE MIGHT BE CHANGED    @D64ADMZ 02604000
*                                 DURING PFIX PROCESSING       @D64ADKH 02605000
         LR    R2,R6              SAVE R6                      @D52VDMZ 02606000
         LR    R1,RE              SAVE BASE                    @D52VDMZ 02607000
         L     R6,DISPAD                                       @D52VDMZ 02608000
         USING DISP,R6                                         @D52VDMZ 02609000
         BAL   RF,RPOST           POST ALL WAITERS             @D52VDMZ 02610000
*SGLINK  RPOST,INPUT=(R5,R6,RF),WORK=(R5,RE)                   @D52VDMZ 02611000
         DROP  R6                 RELEASE DISP                 @D52VDMZ 02612000
         LR    R6,R2              RESTORE R6                   @D52VDMZ 02613000
         LR    RE,R1              RESTORE BASE                 @D52VDMZ 02614000
         SR    RF,RF                                           @D52VDMZ 02615000
***************************************************************@D52VDMZ 02616000
*  PFIX AREA                                                   @D52VDMZ 02617000
***************************************************************@D52VDMZ 02618000
         LA    R1,SVPFLIST        ADDR OF PFIX  PARAMETER LIST @D14CDJB 02619000
         LA    R2,GVSAVPFX-16     ADDR SAVE AREA - 16          @D52VDMZ 02620000
         TM    GVFVFLGS,GVFVBR    INTERNAL REQUEST             @D64ADKH 02621000
         BO    GFSFXSB0           YES => RLOC=ANY              @D64ADKH 02622000
.* PROBLEMS IF INTERNAL AND SVC REQUEST USE THE SAME SUBPOOL   @D52VDMZ 02623000
         TM    SVER0F+2,GVLOCANY  GETVIS IN ABOVE AREA         @D52VDMZ 02624000
         BO    GFSFXSB0           YES,IN SVA 31 => RLOC=ANY    @D52VDMZ 02625000
.* PFIX GATE HANDLING IS DONE BY GETVIS                        @D51IDMZ 02626000
.* DO NOT WAIT FOR TFREE IF REQUESTOR IS ERP                   @D51IDMZ 02627000
         CLC   TID,ERPTIDH        IF REQU. IS ERP, DO NOT SET..@D66ODOW 02628000
         BE    GFSFXS35           .. TASK IN WAITING FOR TFREE @D52VDMZ 02629000
*        SPFIX ADDRESS=(1),RLOC=BELOW,SAVE=(2),GATE=NO         @D52VDMZ 02630000
         SPFIX ADDRESS=(1),RLOC=BELOW,SAVE=(2),GATE=NO         @D52VDMZ 02631000
         B     GFSFXSB1                                        @D52VDMZ 02632000
GFSFXS35 DS    0H                                              @D52VDMZ 02633000
*        SPFIX ADDRESS=(1),RLOC=BELOW,SAVE=(2),GATE=NO,RETURN=YES       02634000
         SPFIX ADDRESS=(1),RLOC=BELOW,SAVE=(2),GATE=NO,RETURN=YES       02635000
         B     GFSFXSB1                                        @D52VDMZ 02636000
GFSFXSB0 DS    0H                                              @D52VDMZ 02637000
         CLC   TID,ERPTIDH        IF REQU. IS ERP, DO NOT SET..@D66ODOW 02638000
         BE    GFSFXS40           .. TASK IN WAITING FOR TFREE @D52VDMZ 02639000
*        SPFIX ADDRESS=(1),RLOC=ANY,SAVE=(2),GATE=NO           @D52VDMZ 02640000
         SPFIX ADDRESS=(1),RLOC=ANY,SAVE=(2),GATE=NO           @D52VDMZ 02641000
         B     GFSFXSB1                                        @D52VDMZ 02642000
GFSFXS40 DS    0H                                              @D52VDMZ 02643000
*        SPFIX ADDRESS=(1),RLOC=ANY,SAVE=(2),GATE=NO,RETURN=YES         02644000
         SPFIX ADDRESS=(1),RLOC=ANY,SAVE=(2),GATE=NO,RETURN=YES         02645000
GFSFXSB1 DS    0H                                              @D52VDMZ 02646000
***************************************************************         02647000
*  CLOSE GETVIS GATE AGAIN                                     @D52VDMZ 02648000
*   GVFVGATE_SAV IS IDENTICAL WITH GVFVGATE EXCEPT HIGH ORDER  @D52ADMZ 02649000
*   BIT. IN CASE GETVIS GATE IS CLOSED BY ANOTHER REQUEST,     @D52ADMZ 02650000
*   HIGH ORDER BIT MIGHT BE SET.                               @D52ADMZ 02651000
***************************************************************         02652000
         L     R9,GVFVGATE_SAV   GET GETVIS GATE TO BE CLOSED  @D64ADMZ 02653000
         LA    R5,0              FOR BOTH GETVIS AND GETMAIN   @D64ADKH 02654000
.* GATING MUST BE DONE AS GETVIS REQUEST. REASON: IF THE PFIX WAS DONE  02655000
.* FOR A GETMAIN REQUEST, THE PFIXPEND BIT IS SET. IN THIS CASE NO      02656000
.* FURTHER GETMAIN REQUEST IS ALLOWED. BUT THE PFIXPEND WAS SET FOR     02657000
.* THIS REQUEST, SO THE GATE CAN BE CLOSED AGAIN.                       02658000
*SGLINK  GVFVGATING,INPUT=(R5,R8:LINK,R9,RA,RD),OUTPUT=(RC),           *02659000
               AMODE=31,NOMODR=()                                       02660000
         SGAMSUBR SUBROUT=GVFVGATS,                            @D64ADKH*02661000
               INPUT=(R5,R9,RA,RD),                            @D64ADMZ*02662000
               NOMOD=(R0,R1,R2,R3,R6,R7,RA,RD,RE,RF),          @D64ADKH*02663000
               OUTPUT=(R9,RC),                                 @D64ADMZ*02664000
               LINK=(R8),         SET STORAGE KEY TO ZERO      @D64ADKH*02665000
               CBASE=GVSUBR                                    @D64ADKH 02666000
         LM    R9,R8,GVSAVPFX                                  @D64ADKH 02667000
***************************************************************         02668000
*  CAUTION: NOTE, THAT THE CI MUST BE SWITCHED BEFORE BEING USED        02669000
*           BECAUSE IT MIGHT HAVE CHANGED DURING GATE OPEN              02670000
***************************************************************         02671000
         BR    R8                 ===> RETURN TO CALLER        @D14CDJB 02672000
         SPACE 2                                               @D14CDJB 02673000
GVSAVPFX DS    16F                SAVE AREA FOR GETVIS REGISTER@D52VDMZ 02674000
         DROP  RC                 RELEASE ANCHOR TABLE         @D51IDMZ 02675000
         DROP  RD                 RELEASE SAVE AREA            @D52VDMZ 02676000
         EJECT                                                 @D14CDJB 02677000
***************************************************************@D149DJB 02678000
*  CONSTANTS AND DATA AREAS USED BY SGAMSUBR                   @D149DJB 02679000
***************************************************************@D149DJB 02680000
         SPACE 1                                               @D14CDJB 02681000
         AIF   (NOT &BGDEBUG).NODBGXX  SKIP FOR DEBUG=NO       @D14CDJB 02682000
         AGO   .NODBGXX                                        @D52VDMZ 02683000
GFSRPTCH DC    20S(*)             PATCH AREA                   @D14CDJB 02684000
.NODBGXX ANOP                                                  @D14CDJB 02685000
GFSREND  EQU   *                  END OF GETVIS/FREEVIS CODE   @D14CDJB 02686000
GFSRLGTH EQU   GFSREND-GVFVSUBR   LENGTH OF SUBROUTINES        @D14CDJB 02687000
         DROP  RE                                              @D51IDKH 02688000
         AIF   (NOT &BGDEBUG).NODBG07  SKIP FOR DEBUG=NO       @D36ZDJB 02689000
         AGO   .NODBG07                                        @D52VDMZ 02690000
         EJECT                                                 @D36ZDJB 02691000
************************************************************** @D369DJB 02692000
*                                                            * @D369DJB 02693000
*  THIS PART OF SGAMSUBR IS FOR FOR DEBUGGING AND STATISTIC  * @D149DJB 02694000
*  PURPOSES ONLY.                                            * @D369DJB 02695000
*                                                            * @D369DJB 02696000
*    FUNCTION FOR PARTITION GETVIS/FREEVIS REQUESTS :        * @D369DJB 02697000
*                                                            * @D369DJB 02698000
*       ALL BG GETVIS AND FREEVIS REQUESTS ARE RECORDED.     * @D369DJB 02699000
*       IF ANOTHER PARTITION IS WANTED, FIELD PARIDBG        * @D369DJB 02700000
*       MUST BE PDZAPPED. THE TRACE TABLE, WHICH HAS 100     * @D369DJB 02701000
*       ENTRIES, IS UPDATED IN A WRAP-AROUND-MODE.           * @D369DJB 02702000
*                                                            * @D369DJB 02703000
*       GETVIS/FREEVIS                                       * @D369DJB 02704000
*        TRACE ENTRY   DS  CL4'WXYZ'  TRACE ENTRY INDICATION * @D369DJB 02705000
*                        WITH  W : G : GETVIS                * @D369DJB 02706000
*                                  F : FREEVIS               * @D369DJB 02707000
*                                  A : FREEVIS ALL           * @D369DJB 02708000
*                              X : R : REAL                  * @D149DJB 02709000
*                                  V : VIRTUAL               * @D369DJB 02710000
*                              Y :     SUBPOOL ID (NUMBER)   * @D149DJB 02711000
*                              Z : JCL PHASE ID (SVEEND-1 OF * @D369DJB 02712000
*                                       PARTITION SAVE AREA) * @D369DJB 02713000
*                      DS  F    INSTRUCTION ADDRESS FROM     * @D369DJB 02714000
*                                                 USER PSW   * @D369DJB 02715000
*                      DS  F    REQUESTED LENGTH (R0) OR     * @D369DJB 02716000
*                               GETVIS AREA ADDRESS IF FVALL * @D369DJB 02717000
*                               OR SUBPOOL NAME (6 BYTES)    * @D149DJB 02718000
*                      DS  F    POINTER TO GETVIS AREA (R1)  * @D369DJB 02719000
*                               OR PART. END ADDR. IF FVALL  * @D369DJB 02720000
*                               OR RETURN CODE (2 BYTES)     * @D149DJB 02721000
*                                                            * @D369DJB 02722000
*    FUNCTION FOR SYSTEM GETVIS/FREEVIS REQUESTS :           * @D369DJB 02723000
*                                                            * @D369DJB 02724000
*       80 SYSTEM GETVIS ENTRIES ARE PROVIDED. EACH GETVIS   * @D369DJB 02725000
*       REQUEST IS RECORDED. IF A FREEVIS REQUEST IS         * @D369DJB 02726000
*       ISSUED, THE CORRESPONDING GETVIS ENTRY IS LOOKED     * @D369DJB 02727000
*       FOR AND DELETED, IF FOUND. IF THERE IS NO SUCH       * @D369DJB 02728000
*       GETVIS ENTRY, THIS FREEVIS REQUEST IS INSERTED       * @D369DJB 02729000
*       INTO THE FREEVIS TRACE TABLE. IF ONE OF THE SYSTEM   * @D369DJB 02730000
*       TABLES IS FULL, NO GETVIS AND FREEVIS REQUESTS ARE   * @D369DJB 02731000
*       RECORDED ANYMORE.                                    * @D369DJB 02732000
*                                                            * @D369DJB 02733000
*        GETVIS ENTRY  DS  F    INSTRUCTION ADDRESS FROM     * @D369DJB 02734000
*                                                 USER PSW   * @D369DJB 02735000
*                      DS  F    REQUESTED LENGTH (R0)        * @D369DJB 02736000
*                      DS  F    POINTER TO GETVIS AREA (R1)  * @D369DJB 02737000
*                                                            * @D369DJB 02738000
*        FREEVIS ENTRY DS  F    INSTRUCTION ADDRESS FROM     * @D369DJB 02739000
*                                                 USER PSW   * @D369DJB 02740000
*                      DS  F    REQUESTED LENGTH (R0)        * @D369DJB 02741000
*                      DS  F    POINTER TO GETVIS AREA (R1)  * @D369DJB 02742000
*                                                            * @D369DJB 02743000
************************************************************** @D369DJB 02744000
         EJECT                                                 @D36ZDJB 02745000
***************************************************************@D149DJB 02746000
*                                                              @D149DJB 02747000
*    ROUTINES TO TRACE GETVIS REQUESTS :                       @D149DJB 02748000
*                                                              @D149DJB 02749000
*      REGISTER USAGE :                                        @D149DJB 02750000
*                                                              @D149DJB 02751000
*        INPUT REGISTER  : RB,RC,RD,RF                         @D149DJB 02752000
*        WORK REGISTERS  : R1,R2,R3,R5                         @D149DJB 02753000
*        OUTPUT REGISTER : NONE                                @D149DJB 02754000
*        REGISTERS WHICH MUST NOT BE DESTROYED :               @D149DJB 02755000
*                          R6 : DISPATCHER RETURN ADDRESS      @D149DJB 02756000
*                          RA : TCB POINTER                    @D149DJB 02757000
*                          RF : RETURN CODE REGISTER (ZERO)    @D149DJB 02758000
*                                                              @D149DJB 02759000
         AGO    .CREATE7                                       @D14ZDJB 02760000
.GVTRACE ANOP                                                  @D14ZDJB 02761000
.*             0123456789ABCDEF                                @D149DJB 02762000
&INPREG  SETC '0000000000011101'                               @D14ZDJB 02763000
&OUTREG  SETC '0000000000000000'                               @D14ZDJB 02764000
&WRKREG  SETC '0111010000000000'                               @D14ZDJB 02765000
&NMDREG  SETC '1000101111111111'                               @D14ZDJB 02766000
&LINKR   SETC 'R8'                                             @D14ZDJB 02767000
&TBASE   SETC 'GVSUBR'                                         @D51IDMZ 02768000
.*EXCLSYMS=()                                                  @D52VDMZ 02769000
         AGO    .TESTALL                                       @D14ZDJB 02770000
.CREATE7 ANOP                                                  @D14ZDJB 02771000
************************************************************** @D149DJB 02772000
         USING GVFVSUBR,RE      SGAMSUBR ADDRESSABILITY        @D14ZDJB 02773000
         USING TCBADR,RA        TCB ADDRESSABILITY             @D14ZDJB 02774000
         USING SVEARA,RD        USER SAVE AREA ADDRESSABILITY  @D14ZDJB 02775000
         USING ANCHTAB,RC         ANCHOR TABLE ADDRESSABILITY  @D14ZDJB 02776000
FVTRACE  DS    0H                 FREEVIS HANDLING             @D51IDMZ 02777000
*SGLINK  FVTRACE,S,INPUT=(R8:LINK,RB,RC,RD,RF),                        *02778000
               WORK=(R1,R2,R3,R4,R5),NOMODR=(R0,R6,R7,R8,R9,RA,RB,     *02779000
               RC,RD,RE,RF),AMODE=31                                    02780000
         LA    RE,GVTRACE                                      @D51IDKH 02781000
         USING GVTRACE,RE       SGAMSUBR ADDRESSABILITY        @D51IDKH 02782000
         B     FVTRACE1                                        @D51IDMZ 02783000
GVTRACE  DS    0H                 GETVIS HANDLING              @D14ZDJB 02784000
*SGLINK  GVTRACE,S,INPUT=(R8:LINK,RB,RC,RD,RF),                        *02785000
               WORK=(R1,R2,R3,R5),NOMODR=(R0,R4,R6,R7,R8,R9,RA,RB,     *02786000
               RC,RD,RE,RF),AMODE=31                                    02787000
         USING GVFVSUBR,RE      SGAMSUBR ADDRESSABILITY        @D14ZDJB 02788000
         LA    RE,GVTRACE                                      @D51IDKH 02789000
         USING GVTRACE,RE       SGAMSUBR ADDRESSABILITY        @D51IDKH 02790000
         TM    SVER0F+D3,SVAIND   PARTITION REQUEST            @D51IDKH 02791000
         BZ    GVTRCPAR           YES, ===>                    @D51IDKH 02792000
         BAL   R2,SYSGVHDL        HANDLE SYSTEM GETVIS REQUEST @D14ZDJB 02793000
         B     GVTRCRET           ===> GOTO RETURN CODE        @D14ZDJB 02794000
GVTRCPAR EQU   *                                               @D14ZDJB 02795000
         TM    SVER0F+D2,GVFVSPIN  DO NOT TRACE FOR SPACE REQ. @D51IDKH 02796000
         BO    GVTRCRET                                        @D51IDKH 02797000
         BAL   R2,PARGVHDL        HANDLE PART. GETVIS REQUEST  @D14ZDJB 02798000
GVTRCRET EQU   *                                               @D14ZDJB 02799000
         L     RE,AMBASE                                       @D51IDKH 02800000
         BR    R8                 ===> RETURN TO CALLER        @D14ZDJB 02801000
         EJECT                                                 @D14ZDJB 02802000
************************************************************** @D369DJB 02803000
*                                                            * @D369DJB 02804000
*    ROUTINE TO HANDLE SYSTEM GETVIS REQUESTS :              * @D369DJB 02805000
*                                                            * @D369DJB 02806000
*      THE SYSTEM GETVIS AND FREEVIS REQUESTS ARE TRACED IN  * @D369DJB 02807000
*      THE ABOVE DESCRIBED WAY. IF THE GETVIS TRACE AREA IS  * @D369DJB 02808000
*      FULL THE CURRENT TRACE AREA POINTER WILL BE SET       * @D369DJB 02809000
*      INVALID AND THERE WILL BE NO RECORDING ANYMORE.       * @D369DJB 02810000
*                                                            * @D369DJB 02811000
*      REGISTER USAGE :                                      * @D369DJB 02812000
*                                                            * @D369DJB 02813000
*        INPUT REGISTER  : NONE                              * @D369DJB 02814000
*        WORK REGISTERS  : R1,R2,R3,R5                       * @D149DJB 02815000
*        OUTPUT REGISTER : NONE                              * @D369DJB 02816000
*        REGISTERS WHICH MUST NOT BE DESTROYED :             * @D369DJB 02817000
*                          R6 : DISPATCHER RETURN ADDRESS    * @D369DJB 02818000
*                          RA : TCB POINTER                  * @D369DJB 02819000
*                          RF : RETURN CODE REGISTER (ZERO)  * @D369DJB 02820000
*                                                            * @D369DJB 02821000
************************************************************** @D369DJB 02822000
SYSGVHDL DS    0H                 SYSTEM GETVIS HANDLING       @D36ZDJB 02823000
         L     R5,SYSGVCNT        LOAD SYSTEM GETVIS COUNT     @D36ZDJB 02824000
         LA    R5,D1(R5)          INCREMENT BY ONE             @D36ZDJB 02825000
         ST    R5,SYSGVCNT        STORE SYSTEM GETVIS COUNT    @D36ZDJB 02826000
         L     R3,SYSGVCUR        GET CURRENT TRACE ENTRY      @D36ZDJB 02827000
         LTR   R3,R3              TRACE AREA EXHAUSTED ?       @D36ZDJB 02828000
         BMR   R2                 YES ==> EXIT                 @D36ZDJB 02829000
         CLI   SVCIC,38           GETVIS FOR TCB OR TIB ?      @D14ZDJB 02830000
         BER   R2                 YES ==> EXIT                 @D14ZDJB 02831000
         USING DGVTRACE,R3                                     @D14ZDJB 02832000
         L     R5,SVEPSW2         GET NSI FROM PSW             @D36ZDJB 02833000
         CLM   R6,M7,DISPAD+D1    INTERNAL GETVIS ?            @D52VDMZ 02834000
         BE    SYSGVNIN           NO  ===>                     @D14ZDJB 02835000
         L     R1,AMBASE          GET GETVIS CODE BASE         @D14ZDJB 02836000
         USING GETVIS,R1                                       @D14ZDJB 02837000
         L     R5,SVISRETA        GET REQUESTOR SVC ADDRESS    @D14ZDJB 02838000
         DROP  R1                                              @D14ZDJB 02839000
SYSGVNIN EQU   *                                               @D14ZDJB 02840000
         ST    R5,DGVTRNSI        STORE IT IN TRACE AREA       @D14ZDJB 02841000
         L     R5,SVER00          GET REQUESTED LENGTH         @D36ZDJB 02842000
         ST    R5,DGVTRLEN        STORE IT IN TRACE AREA       @D14ZDJB 02843000
         L     R5,SVER01          GET GETVIS ADDRESS           @D36ZDJB 02844000
         LTR   RF,RF              WAS GETVIS SUCCESSFUL ?      @D14ZDJB 02845000
         BZ    SYSGVNRC           YES ===>                     @D14ZDJB 02846000
         STC   RF,DGVTRRC         STORE RC IN TRACE AREA       @D14ZDJB 02847000
         TM    SVER0F+D3,GVSPID   WAS SUBPOOL SPECIFIED ?      @D14ZDJB 02848000
         BZ    SYSGVLP            NO  ===>                     @D14ZDJB 02849000
         MVC   DGVTRSNM,D0(R5)    STORE SUBPOOL NAME           @D14ZDJB 02850000
         B     SYSGVLP            ===> UPDATE POINTERS         @D14ZDJB 02851000
SYSGVNRC EQU   *                                               @D14ZDJB 02852000
         ST    R5,DGVTRGAD        STORE IT IN TRACE AREA       @D14ZDJB 02853000
         S     R5,BVIRTMEM        RELATIVE START OF AREA       @D14ZDJB 02854000
         SRL   R5,PNSHIFT         RELATIVE PAGE NUMBER OF AREA @D14ZDJB 02855000
         SLL   R5,SUBPCHN2        RELATIVE CHAIN ENTRY OF AREA @D14ZDJB 02856000
         A     R5,BSUBPCHN        CHAIN ENTRY OF AREA          @D14ZDJB 02857000
         USING SUBPCHN,R5                                      @D14ZDJB 02858000
         LH    R1,SPCHNMBR        GET SUBPOOL ID               @D51IDMZ 02859000
         DROP  R5                                              @D14ZDJB 02860000
         STH   R1,DGVTRSID        STORE IT IN TRACE ENTRY      @D51IDMZ 02861000
         C     R3,SYSGVTPE        IS R3 ABOVE TEMPORARY END ?  @D36ZDJB 02862000
         BL    SYSGVLP            NO  ==> GO TO NEXT FREE ENTRY@D36ZDJB 02863000
         ST    R3,SYSGVTPE        SET POINTER TO TEMPORARY END @D36ZDJB 02864000
SYSGVLP  EQU   *                                               @D36ZDJB 02865000
         LA    R3,GVTRENLN(R3)    GO TO NEXT TRACE ENTRY       @D14ZDJB 02866000
         C     R3,SYSGVEND        WAS IT LAST ENTRY ?          @D36ZDJB 02867000
         BE    SYSTREND           YES ==>                      @D36ZDJB 02868000
         L     R5,DGVTRGAD        GET ADDR. PART OF NEXT ENTRY @D14ZDJB 02869000
         LTR   R5,R5              TRACE ENTRY EMPTY            @D36ZDJB 02870000
         BNZ   SYSGVLP            NO  ==> GO TO NEXT ENTRY     @D36ZDJB 02871000
         ST    R3,SYSGVCUR        SET POINTER TO FREE ENTRY    @D36ZDJB 02872000
         BR    R2                 ==> RETURN TO CALLER         @D36ZDJB 02873000
SYSTREND EQU   *                                               @D36ZDJB 02874000
         MVI   SYSGVCUR,XFF       SET GETVIS POINTER INVALID   @D36ZDJB 02875000
         MVI   SYSFVCUR,XFF       SET FREEVIS POINTER INVALID  @D36ZDJB 02876000
         BR    R2                 RETURN TO CALLER             @D36ZDJB 02877000
         DROP  R3                                              @D14ZDJB 02878000
         EJECT                                                 @D14ZDJB 02879000
************************************************************** @D369DJB 02880000
*                                                            * @D369DJB 02881000
*    ROUTINE TO HANDLE PARTITION GETVIS REQUESTS :           * @D369DJB 02882000
*                                                            * @D369DJB 02883000
*      THE PARTITION GETVIS REQUESTS ARE TRACED IN THE       * @D369DJB 02884000
*      ABOVE DESCRIBED WAY.                                  * @D369DJB 02885000
*                                                            * @D369DJB 02886000
*      REGISTER USAGE :                                      * @D369DJB 02887000
*                                                            * @D369DJB 02888000
*        INPUT REGISTER  : NONE                              * @D369DJB 02889000
*        WORK REGISTERS  : R1,R3,R5                          * @D369DJB 02890000
*        OUTPUT REGISTER : NONE                              * @D369DJB 02891000
*        REGISTERS WHICH MUST NOT BE DESTROYED :             * @D369DJB 02892000
*                          R6 : DISPATCHER RETURN ADDRESS    * @D369DJB 02893000
*                          RA : TCB POINTER                  * @D369DJB 02894000
*                          RD : USER SAVE AREA POINTER       * @D369DJB 02895000
*                          RE : SGAM BASE REGISTER           * @D369DJB 02896000
*                          RF : RETURN CODE REGISTER (ZERO)  * @D369DJB 02897000
*                                                            * @D369DJB 02898000
************************************************************** @D369DJB 02899000
PARGVHDL DS    0H                 PARTITION GETVIS HANDLING    @D36ZDJB 02900000
         L     R1,PIBPTR2                                      @D51IDMZ 02901000
         USING PIB2ADR,R1                                      @D51IDMZ 02902000
         L     R1,PIBPCB          GET CURRENT PCB POINTER      @D51IDMZ 02903000
         USING PCBADR,R1          PCB ADDRESSABILITY           @D51IDMZ 02904000
         CLC   PCELID,PARIDBG        IS IT BG PARTITION ?      @D51IDMZ 02905000
         BNER  R2                 NO ==> RETURN                @D36ZDJB 02906000
         L     R5,PARGVCNT        LOAD PARTITION GETVIS COUNT  @D36ZDJB 02907000
         LA    R5,D1(R5)          INCREMENT BY ONE             @D36ZDJB 02908000
         ST    R5,PARGVCNT        STORE PARTITION GETVIS COUNT @D36ZDJB 02909000
         L     R3,PGVFVCUR        GET CURRENT TRACE ENTRY      @D36ZDJB 02910000
         USING DGVTRACE,R3                                     @D14ZDJB 02911000
         MVI   DGVTRFCT,GETVSIND  INDICATE GETVIS REQUEST      @D14ZDJB 02912000
         MVI   DGVTRMOD,REALIND   INDICATE REAL REQUEST        @D14ZDJB 02913000
         L     R1,PCEPIB          GET CURRENT PIB POINTER      @D51IDMZ 02914000
         USING PIBADR,R1          PIB ADDRESSABILITY           @D51IDMZ 02915000
         TM    PIBDATFL,PIBTRAM   REAL REQUEST ?               @D51IDMZ 02916000
         DROP  R1                                              @D36ZDJB 02917000
         BNO   PGVREAL            YES ==>                      @D36ZDJB 02918000
         MVI   DGVTRMOD,VIRTIND   INDICATE VIRTUAL REQUEST     @D14ZDJB 02919000
PGVREAL  EQU   *                                               @D36ZDJB 02920000
         L     R5,SVEPSW2         GET NSI FROM PSW             @D36ZDJB 02921000
         ST    R5,DGVTRNSI        STORE IT IN TRACE AREA       @D14ZDJB 02922000
         L     R5,SVER00          GET REQUESTED LENGTH         @D36ZDJB 02923000
         ST    R5,DGVTRLEN        STORE IT IN TRACE AREA       @D14ZDJB 02924000
         IC    R5,SVEEND-D1       GET JCL PHASE ID             @D36ZDJB 02925000
         STC   R5,DGVTRNME        AND STORE IT                 @D36ZDJB 02926000
         L     R5,SVER01          GET GETVIS ADDRESS           @D36ZDJB 02927000
         LTR   RF,RF              WAS GETVIS SUCCESSFUL ?      @D14ZDJB 02928000
         BZ    PARGVNRC           YES ===>                     @D14ZDJB 02929000
         STC   RF,DGVTRRC         STORE RC IN TRACE AREA       @D14ZDJB 02930000
         TM    SVER0F+D3,GVSPID   WAS SUBPOOL SPECIFIED ?      @D14ZDJB 02931000
         BZ    PARGVSF            NO  ===>                     @D14ZDJB 02932000
         MVC   DGVTRSNM,D0(R5)    STORE SUBPOOL NAME           @D14ZDJB 02933000
         B     PARGVSF            ===> UPDATE POINTERS         @D14ZDJB 02934000
PARGVNRC EQU   *                                               @D14ZDJB 02935000
         ST    R5,DGVTRGAD        STORE IT IN TRACE AREA       @D14ZDJB 02936000
         S     R5,BVIRTMEM        RELATIVE START OF AREA       @D14ZDJB 02937000
         SRL   R5,PNSHIFT         RELATIVE PAGE NUMBER OF AREA @D14ZDJB 02938000
         SLL   R5,SUBPCHN2        RELATIVE CHAIN ENTRY OF AREA @D14ZDJB 02939000
         A     R5,BSUBPCHN        CHAIN ENTRY OF AREA          @D14ZDJB 02940000
         USING SUBPCHN,R5                                      @D14ZDJB 02941000
         LH    R1,SPCHNMBR        GET SUBPOOL ID               @D51IDMZ 02942000
         DROP  R5                                              @D14ZDJB 02943000
         STH   R1,DGVTRSID        STORE IT IN TRACE ENTRY      @D51IDMZ 02944000
PARGVSF  EQU   *                                               @D14ZDJB 02945000
         LA    R3,GVTRENLN(R3)    INCREMENT TRACE POINTER      @D14ZDJB 02946000
         C     R3,PGVFVEND        WAS THIS LAST TRACE ENTRY ?  @D36ZDJB 02947000
         BL    PGVNOWRP           NO ==>                       @D36ZDJB 02948000
         L     R3,PGVFVBEG        GET TRACE AREA BEGIN         @D36ZDJB 02949000
PGVNOWRP EQU   *                                               @D36ZDJB 02950000
         ST    R3,PGVFVCUR        STORE IT AS CURRENT POINTER  @D36ZDJB 02951000
         BR    R2                 RETURN TO CALLER             @D36ZDJB 02952000
         DROP  R3                                              @D14ZDJB 02953000
         EJECT                                                 @D14ZDJB 02954000
***************************************************************@D149DJB 02955000
*                                                              @D149DJB 02956000
*    ROUTINES TO TRACE FREEVIS REQUESTS :                      @D149DJB 02957000
*                                                              @D149DJB 02958000
*      REGISTER USAGE :                                        @D149DJB 02959000
*                                                              @D149DJB 02960000
*        INPUT REGISTER  : RB,RC,RD,RF                         @D149DJB 02961000
*        WORK REGISTERS  : R1,R2,R3,R4,R5                      @D149DJB 02962000
*        OUTPUT REGISTER : NONE                                @D149DJB 02963000
*        REGISTERS WHICH MUST NOT BE DESTROYED :               @D149DJB 02964000
*                          R6 : DISPATCHER RETURN ADDRESS      @D149DJB 02965000
*                          RA : TCB POINTER                    @D149DJB 02966000
*                          RF : RETURN CODE REGISTER (ZERO)    @D149DJB 02967000
*                                                              @D149DJB 02968000
         AGO    .CREATE8                                       @D14ZDJB 02969000
.FVTRACE ANOP                                                  @D14ZDJB 02970000
.*             0123456789ABCDEF                                @D149DJB 02971000
&INPREG  SETC '0000000000011101'                               @D14ZDJB 02972000
&OUTREG  SETC '0000000000000000'                               @D14ZDJB 02973000
&WRKREG  SETC '0111110000000000'                               @D14ZDJB 02974000
&NMDREG  SETC '1000001111111111'                               @D14ZDJB 02975000
&LINKR   SETC 'R8'                                             @D14ZDJB 02976000
&TBASE   SETC 'GVSUBR'                                         @D51IDMZ 02977000
.*EXCLSYMS=()                                                  @D52VDMZ 02978000
         AGO    .TESTALL                                       @D14ZDJB 02979000
.CREATE8 ANOP                                                  @D14ZDJB 02980000
************************************************************** @D149DJB 02981000
         SPACE 2                                               @D14ZDJB 02982000
FVTRACE1 DS    0H                 FREEVIS HANDLING             @D14ZDJB 02983000
         TM    SVER0F+D3,SVAIND   SYSTEM GETVIS REQUEST?       @D51IDKH 02984000
         BZ    FVTRCPAR           NO  ===> (PARTITION REQUEST) @D14ZDJB 02985000
         BAL   R2,SYSFVHDL        HANDLE SYSTEM FREEVIS REQUEST@D14ZDJB 02986000
         B     FVTRCRET           ===> GOTO RETURN CODE        @D14ZDJB 02987000
FVTRCPAR EQU   *                                               @D14ZDJB 02988000
         TM    SVER0F+D2,GVFVSPIN NO TRACE FOR SPACE REQUEST   @D51IDKH 02989000
         BO    FVTRCRET                                        @D51IDKH 02990000
         L     R1,PIBPTR2                                      @D51IDMZ 02991000
         USING PIB2ADR,R1                                      @D51IDMZ 02992000
         L     R1,PIBPCB          GET CURRENT PCB POINTER      @D51IDMZ 02993000
         USING PCBADR,R1          PCB ADDRESSABILITY           @D51IDMZ 02994000
         CLC   PCELID,PARIDBG     IS IT BG PARTITION ?         @D51IDMZ 02995000
         BNE   FVTRCRET           NO ==> RETURN                @D14ZDJB 02996000
         DROP  R1                                              @D36ZDJB 02997000
         BAL   R2,PARFVHDL        HANDLE PARTITION FREEVIS REQUEST      02998000
FVTRCRET EQU   *                                               @D14ZDJB 02999000
         L     RE,AMBASE                                       @D51IDKH 03000000
         BR    R8                 ===> RETURN TO CALLER        @D14ZDJB 03001000
         EJECT                                                 @D14ZDJB 03002000
************************************************************** @D369DJB 03003000
*                                                            * @D369DJB 03004000
*    ROUTINE TO HANDLE SYSTEM FREEVIS REQUESTS :             * @D369DJB 03005000
*                                                            * @D369DJB 03006000
*      THE SYSTEM GETVIS AND FREEVIS REQUESTS ARE TRACED IN  * @D369DJB 03007000
*      THE ABOVE DESCRIBED WAY. IF THE FREEVIS TRACE AREA IS * @D369DJB 03008000
*      FULL THE CURRENT TRACE AREA POINTER WILL BE SET       * @D369DJB 03009000
*      INVALID AND THERE WILL BE NO RECORDING ANYMORE.       * @D369DJB 03010000
*                                                            * @D369DJB 03011000
*        INPUT REGISTER  : NONE                              * @D369DJB 03012000
*        WORK REGISTERS  : R1,R3,R4,R5                       * @D369DJB 03013000
*        OUTPUT REGISTER : NONE                              * @D369DJB 03014000
*        REGISTERS WHICH MUST NOT BE DESTROYED :             * @D369DJB 03015000
*                          R6 : DISPATCHER RETURN ADDRESS    * @D369DJB 03016000
*                          RA : TCB POINTER                  * @D369DJB 03017000
*                          RF : RETURN CODE REGISTER         * @D149DJB 03018000
*                                                            * @D369DJB 03019000
************************************************************** @D369DJB 03020000
SYSFVHDL DS    0H                 SYSTEM FREEVIS HANDLING      @D36ZDJB 03021000
         L     R5,SYSFVCNT        LOAD SYSTEM FREEVIS COUNT    @D36ZDJB 03022000
         LA    R5,D1(R5)          INCREMENT BY ONE             @D36ZDJB 03023000
         ST    R5,SYSFVCNT        STORE SYSTEM FREEVIS COUNT   @D36ZDJB 03024000
         L     R3,SYSFVCUR        GET CURRENT TRACE ENTRY      @D36ZDJB 03025000
         LTR   R3,R3              TRACE AREA EXHAUSTED ?       @D36ZDJB 03026000
         BMR   R2                 YES ==> EXIT                 @D36ZDJB 03027000
         L     R1,SVER01          GET GETVIS ADDRESS           @D36ZDJB 03028000
         USING DGVTRACE,R3                                     @D14ZDJB 03029000
         LTR   RF,RF              WAS FREEVIS OKAY ?           @D14ZDJB 03030000
         BZ    SYSFVNRC           YES ===>                     @D14ZDJB 03031000
         BR    R2                 NO  ==> EXIT                 @D14ZDJB 03032000
************************************************************** @D149DJB 03033000
*    FREEVIS WAS NOT O.K. (RETURN CODE = ¬0)                 * @D149DJB 03034000
************************************************************** @D149DJB 03035000
         STC   RF,DGVTRRC         STORE RETURN CODE            @D14ZDJB 03036000
         TM    SVER0F+D3,SMFVALL  COMREG SUBPOOL SPECIFIED ?   @D14ZDJB 03037000
         BO    SYSFVRSB           YES ===>                     @D14ZDJB 03038000
         TM    SVER0F+D3,FVSPID   SUBPOOL SPECIFIED ?          @D14ZDJB 03039000
         BNO   SYSFVNFN           NO  ===>                     @D14ZDJB 03040000
SYSFVRSB EQU   *                                               @D14ZDJB 03041000
         MVC   DGVTRSNM(L'DGVTRSNM),D0(R1)  INSERT SUBPOOL NAME@D14ZDJB 03042000
         B     SYSFVNFD           YES ===>                     @D14ZDJB 03043000
************************************************************** @D149DJB 03044000
*    FREEVIS WAS O.K. (RETURN CODE = 0)                      * @D149DJB 03045000
************************************************************** @D149DJB 03046000
SYSFVNRC EQU   *                                               @D14ZDJB 03047000
         LA    R4,GVTRENLN        GET TRACE ENTRY LENGTH       @D14ZDJB 03048000
         L     R5,SYSGVTPE        GET TEMPORARY END OF GETVIS  @D36ZDJB 03049000
*                            TRACE TO AVOID TOO MUCH SEARCHING @D369DJB 03050000
         L     R3,SYSGVBEG        GET BEGIN OF GETVIS TRACE    @D36ZDJB 03051000
         TM    SVER0F+D3,SMFVALL  COMREG SUBPOOL SPECIFIED ?   @D14ZDJB 03052000
         BO    SYSFVSUB           YES ===>                     @D14ZDJB 03053000
         TM    SVER0F+D3,FVSPID   SUBPOOL SPECIFIED ?          @D14ZDJB 03054000
         BNO   SYSFVLP            NO  ===>                     @D14ZDJB 03055000
************************************************************** @D149DJB 03056000
*    SCAN GETVIS TRACE ENTRIES FOR SUBPOOL REQUEST           * @D149DJB 03057000
************************************************************** @D149DJB 03058000
SYSFVSUB EQU   *                                               @D14ZDJB 03059000
         L     R1,AMBASE          GET SGAM BASE                @D14ZDJB 03060000
         USING GETVIS,R1                                       @D14ZDJB 03061000
SYSFVSLP EQU   *                                               @D14ZDJB 03062000
         CLC   DGVTRSID(L'DGVTRSID),GVTRSSID  SUBPOOL ID MATCH?@D14ZDJB 03063000
         BNE   SYSFVSNF           NO  ===>                     @D14ZDJB 03064000
         XC    DGVTRACE+2(GVTRENLN-2),DGVTRACE+2  CLEAR ENTRY  @D14ZDJB 03065000
         C     R3,SYSGVCUR        NEW CURRENT ENTRY ?          @D14ZDJB 03066000
         BNL   SYSFVSNF           NO  ===>                     @D14ZDJB 03067000
         ST    R3,SYSGVCUR        STORE NEW CURRENT ENTRY      @D14ZDJB 03068000
SYSFVSNF EQU   *                                               @D14ZDJB 03069000
         BXLE  R3,R4,SYSFVSLP     ===> GOTO NEXT ENTRY         @D14ZDJB 03070000
         B     SYSTRNC            ===> GOTO EXIT CODE          @D14ZDJB 03071000
         DROP  R1                                              @D14ZDJB 03072000
************************************************************** @D149DJB 03073000
*    SCAN GETVIS TRACE ENTRIES FOR NON-SUBPOOL REQUEST       * @D149DJB 03074000
************************************************************** @D149DJB 03075000
SYSFVLP  EQU   *                                               @D36ZDJB 03076000
         C     R1,DGVTRGAD        COMPARE GETVIS ADDRESSES     @D14ZDJB 03077000
         BE    SYSTRMTC           ==> EQUAL                    @D36ZDJB 03078000
         BXLE  R3,R4,SYSFVLP      ==> GOTO NEXT ENTRY          @D36ZDJB 03079000
         L     R3,SYSFVCUR        GET FREE FREEVIS ENTRY       @D36ZDJB 03080000
************************************************************** @D149DJB 03081000
*    UPDATE FREEVIS TRACE ENTRY IF AREA NOT FOUND OR RC ¬= 0 * @D149DJB 03082000
************************************************************** @D149DJB 03083000
SYSFVNFN EQU   *                                               @D14ZDJB 03084000
         ST    R1,DGVTRGAD        STORE ADDRESS IN TRACE AREA  @D14ZDJB 03085000
         L     R5,SVER00          GET REQUESTED LENGTH         @D36ZDJB 03086000
         ST    R5,DGVTRLEN        STORE IT IN TRACE AREA       @D14ZDJB 03087000
SYSFVNFD EQU   *                                               @D14ZDJB 03088000
         L     R5,SVEPSW2         GET NSI FROM PSW             @D36ZDJB 03089000
         CLM   R6,M7,DISPAD+D1    INTERNAL GETVIS ?            @D52VDMZ 03090000
         BE    SYSFVNIN           NO  ===>                     @D14ZDJB 03091000
         L     R1,AMBASE          GET GETVIS CODE BASE         @D14ZDJB 03092000
         USING GETVIS,R1                                       @D14ZDJB 03093000
         L     R5,SVISRETA        GET REQUESTOR SVC ADDRESS    @D14ZDJB 03094000
         DROP  R1                                              @D14ZDJB 03095000
SYSFVNIN EQU   *                                               @D14ZDJB 03096000
         ST    R5,DGVTRNSI        STORE IT IN TRACE AREA       @D14ZDJB 03097000
         LA    R3,GVTRENLN(R3)    GO TO NEXT TRACE ENTRY       @D14ZDJB 03098000
         ST    R3,SYSFVCUR        SET POINTER TO FREE ENTRY    @D14ZDJB 03099000
         C     R3,SYSFVEND        WAS IT LAST ENTRY ?          @D36ZDJB 03100000
         BNER  R2                 NO  ==> RETURN TO CALLER     @D36ZDJB 03101000
         MVI   SYSGVCUR,XFF       SET GETVIS POINTER INVALID   @D36ZDJB 03102000
         MVI   SYSFVCUR,XFF       SET FREEVIS POINTER INVALID  @D36ZDJB 03103000
         BR    R2                 ==> RETURN TO CALLER         @D36ZDJB 03104000
************************************************************** @D149DJB 03105000
*    UPDATE GETVIS TRACE ENTRY FOR NON-SUBPOOL REQUEST       * @D149DJB 03106000
************************************************************** @D149DJB 03107000
SYSTRMTC EQU   *                                               @D36ZDJB 03108000
         XC    DGVTRACE+2(GVTRENLN-2),DGVTRACE+2  CLEAR ENTRY  @D14ZDJB 03109000
         L     R5,SYSGVCUR        GET CURRENT GETVIS TRACE PTR @D36ZDJB 03110000
         CR    R5,R3              NEW FREE ENTRY LOWER THAN OLD@D36ZDJB 03111000
         BL    SYSTRNC            NO  ==>                      @D36ZDJB 03112000
         ST    R3,SYSGVCUR        STORE NEW CURRENT POINTER    @D36ZDJB 03113000
SYSTRNC  EQU   *                                               @D36ZDJB 03114000
         L     R5,SYSGVTPE        GET TEMP. GETVIS TRACE END   @D36ZDJB 03115000
         CR    R5,R3              NEW TEMP. END EQUAL OLD ONE  @D36ZDJB 03116000
         BNER  R2                 NO  ==> RETURN TO CALLER     @D36ZDJB 03117000
         SR    R3,R4              REDUCE TEMPORARY END BY ONE  @D36ZDJB 03118000
         ST    R3,SYSGVTPE        STORE IT                     @D36ZDJB 03119000
         BR    R2                 RETURN TO CALLER             @D36ZDJB 03120000
         DROP  R3                                              @D14ZDJB 03121000
         EJECT                                                 @D14ZDJB 03122000
************************************************************** @D369DJB 03123000
*                                                            * @D369DJB 03124000
*    ROUTINE TO HANDLE PARTITION FREEVIS REQUESTS :          * @D369DJB 03125000
*                                                            * @D369DJB 03126000
*      THE PARTITION FREEVIS REQUESTS ARE TRACED IN THE      * @D369DJB 03127000
*      ABOVE DESCRIBED WAY.                                  * @D369DJB 03128000
*                                                            * @D369DJB 03129000
*      REGISTER USAGE :                                      * @D369DJB 03130000
*                                                            * @D369DJB 03131000
*        INPUT REGISTER  : R4 : PCB POINTER (FOR FREEVIS ALL)* @D369DJB 03132000
*        WORK REGISTERS  : R1,R3,R5                          * @D369DJB 03133000
*        OUTPUT REGISTER : NONE                              * @D369DJB 03134000
*        REGISTERS WHICH MUST NOT BE DESTROYED :             * @D369DJB 03135000
*                          R6 : DISPATCHER RETURN ADDRESS    * @D369DJB 03136000
*                          RA : TCB POINTER                  * @D369DJB 03137000
*                          RE : SGAM BASE REGISTER           * @D369DJB 03138000
*                          RF : RETURN CODE REGISTER (ZERO)  * @D369DJB 03139000
*                                                            * @D369DJB 03140000
************************************************************** @D369DJB 03141000
PARFVHDL DS    0H                 PARTITION FREEVIS HANDLING   @D36ZDJB 03142000
         L     R3,PGVFVCUR        GET CURRENT TRACE ENTRY      @D36ZDJB 03143000
         USING DGVTRACE,R3                                     @D14ZDJB 03144000
         L     R4,PIBPTR2                                      @D51IDMZ 03145000
         USING PIB2ADR,R4                                      @D51IDMZ 03146000
         L     R4,PIBPCB          GET CURRENT PCB POINTER      @D51IDMZ 03147000
         USING PCBADR,R4          ADDRESS PCB                  @D51IDMZ 03148000
         L     R1,PCEPIB          GET CURRENT PIB POINTER      @D51IDMZ 03149000
         DROP  R4                                              @D51IDMZ 03150000
         TM    SVER0F+D3,SMFVALL  FREEVIS ALL REQUEST ?        @D36ZDJB 03151000
         BNO   PNOFVALL           NO ==>                       @D36ZDJB 03152000
         CLC   TID(2),IJBHMTID    EXCLUSIVE SUBPOOL ?          @D51IDMZ 03153000
         BH    PNOFVALL           YES ===>                     @D14ZDJB 03154000
************************************************************** @D369DJB 03155000
*   FREEVIS ALL HANDLING                                     * @D369DJB 03156000
************************************************************** @D369DJB 03157000
         L     R5,FVALLCNT        LOAD FREEVIS ALL COUNT       @D36ZDJB 03158000
         LA    R5,D1(R5)          INCREMENT BY ONE             @D36ZDJB 03159000
         ST    R5,FVALLCNT        STORE FREEVIS ALL COUNT      @D36ZDJB 03160000
         MVI   DGVTRFCT,FVALLIND  INDICATE FREEVIS ALL REQEST  @D14ZDJB 03161000
         USING PIBADR,R1          PIB ADDRESSABILITY           @D14ZDJB 03162000
         TM    PIBDATFL,PIBTRAM   REAL REQUEST ?               @D51IDMZ 03163000
         BNO   PARFVARL           YES ==>                      @D36ZDJB 03164000
         DROP  R1                                              @D14ZDJB 03165000
         MVI   DGVTRMOD,VIRTIND   INDICATE VIRTUAL REQUEST     @D14ZDJB 03166000
         USING PCBADR,R4          ADDRESS PCB                  @D36ZDJB 03167000
         L     R5,SMVPEND         GET VIRTUAL PARTITION END    @D36ZDJB 03168000
         B     PARFVACO           ==> GOTO COMMON FV ALL HANDL.@D36ZDJB 03169000
PARFVARL EQU   *                  REAL FV ALL HANDLING         @D36ZDJB 03170000
         MVI   DGVTRMOD,REALIND   INDICATE REAL REQUEST        @D14ZDJB 03171000
         L     R5,SMRPEND         GET REAL PARTITION END       @D36ZDJB 03172000
         DROP  R4                                              @D36ZDJB 03173000
PARFVACO EQU   *                  COMMON FV ALL HANDLING       @D36ZDJB 03174000
         BCTR  R5,R0              GET PARTITION END ADDRESS    @D36ZDJB 03175000
         ST    R5,DGVTRPEN        AND STORE IT IN TRACE AREA   @D14ZDJB 03176000
         L     R5,BVIRTMEM        GET GETVIS AREA START        @D14ZDJB 03177000
         ST    R5,DGVTRPPE        STORE IT IN TRACE AREA       @D14ZDJB 03178000
         B     PARFVCOM           ==> GOTO COMMON FREEVIS HDL. @D36ZDJB 03179000
************************************************************** @D369DJB 03180000
*   PARTITION FREEVIS HANDLING                               * @D369DJB 03181000
************************************************************** @D369DJB 03182000
PNOFVALL EQU   *                  PARTITION FREEVIS HANDLING   @D36ZDJB 03183000
         L     R5,PARFVCNT        LOAD PARTITION FREEVIS COUNT @D36ZDJB 03184000
         LA    R5,D1(R5)          INCREMENT BY ONE             @D36ZDJB 03185000
         ST    R5,PARFVCNT        STORE PARTITION FREEVIS COUNT@D36ZDJB 03186000
         MVI   DGVTRFCT,FREVSIND  INDICATE FREEVIS REQUEST     @D14ZDJB 03187000
         L     R5,SVER01          GET GETVIS ADDRESS           @D36ZDJB 03188000
         LTR   RF,RF              WAS FREEVIS OKAY ?           @D14ZDJB 03189000
         BZ    PARFVNRC           YES ===>                     @D14ZDJB 03190000
         STC   RF,DGVTRRC         STORE RETURN CODE            @D14ZDJB 03191000
         ST    R5,DGVTRGAD        STORE ADDRESS IN TRACE AREA  @D14ZDJB 03192000
         B     PARFVCNF           ===> INSERT REST             @D14ZDJB 03193000
PARFVNRC EQU   *                                               @D14ZDJB 03194000
         MVI   DGVTRMOD,REALIND   INDICATE REAL REQUEST        @D14ZDJB 03195000
         USING PIBADR,R1          PIB ADDRESSABILITY           @D36ZDJB 03196000
         TM    PIBDATFL,PIBTRAM   REAL REQUEST ?               @D51IDMZ 03197000
         DROP  R1                                              @D36ZDJB 03198000
         BNO   PARFVRL            YES ==>                      @D36ZDJB 03199000
         MVI   DGVTRMOD,VIRTIND   INDICATE VIRTUAL REQUEST     @D14ZDJB 03200000
PARFVRL  EQU   *                                               @D36ZDJB 03201000
         TM    SVER0F+D3,FVSPID   SUBPOOL SPECIFIED ?          @D14ZDJB 03202000
         BO    PARFVSUB           YES ===>                     @D14ZDJB 03203000
         TM    SVER0F+D3,SMFVALL  EXCLUSIVE SUBPOOL ?          @D14ZDJB 03204000
         BNO   PARFVNSB           NO  ===>                     @D14ZDJB 03205000
         MVC   DGVTRSNM(L4),SPTASK   INSERT CHARACTERS: TASK   @D14ZDJB 03206000
         IC    R1,TIDBYTE         INSERT                       @D14ZDJB 03207000
         STC   R1,DGVTRSNM+D4         TASK ID                  @D14ZDJB 03208000
         B     PARFVINR           ===> INSERT REST             @D14ZDJB 03209000
PARFVSUB EQU   *                                               @D14ZDJB 03210000
         MVC   DGVTRSNM(L'DGVTRSNM),D0(R5)  INSERT SUBPOOL NAME@D14ZDJB 03211000
         B     PARFVCOM           ===> GOTO COMMON CODE        @D14ZDJB 03212000
PARFVNSB EQU   *                                               @D14ZDJB 03213000
         ST    R5,DGVTRGAD        STORE ADDRESS IN TRACE AREA  @D14ZDJB 03214000
         S     R5,BVIRTMEM        RELATIVE START OF AREA       @D14ZDJB 03215000
         SRL   R5,PNSHIFT         RELATIVE PAGE NUMBER OF AREA @D14ZDJB 03216000
         SLL   R5,SUBPCHN2        RELATIVE CHAIN ENTRY OF AREA @D14ZDJB 03217000
         A     R5,BSUBPCHN        CHAIN ENTRY OF AREA          @D14ZDJB 03218000
         USING SUBPCHN,R5                                      @D14ZDJB 03219000
         LH    R1,SPCHNMBR        GET SUBPOOL ID               @D51IDMZ 03220000
         DROP  R5                                              @D14ZDJB 03221000
         STH   R1,DGVTRSID        STORE IT IN TRACE ENTRY      @D51IDMZ 03222000
PARFVCNF EQU   *                                               @D14ZDJB 03223000
         IC    R5,SVEEND-D1       GET JCL PHASE ID             @D36ZDJB 03224000
         STC   R5,DGVTRNME        AND STORE IT                 @D14ZDJB 03225000
PARFVINR EQU   *                                               @D14ZDJB 03226000
         L     R5,SVER00          GET REQUESTED LENGTH         @D36ZDJB 03227000
         ST    R5,DGVTRLEN        STORE IT IN TRACE AREA       @D14ZDJB 03228000
************************************************************** @D369DJB 03229000
*   COMMON PART OF FREEVIS HANDLING                          * @D369DJB 03230000
************************************************************** @D369DJB 03231000
PARFVCOM EQU   *                  COMMON FREEVIS HANDLING      @D36ZDJB 03232000
         L     R5,SVEPSW2         GET NSI FROM PSW             @D36ZDJB 03233000
         ST    R5,DGVTRNSI        STORE IT IN TRACE AREA       @D14ZDJB 03234000
         LA    R3,GVTRENLN(R3)    INCREMENT TRACE POINTER      @D14ZDJB 03235000
         C     R3,PGVFVEND        WAS IT THE LAST TRACE ENTRY ?@D36ZDJB 03236000
         BL    PFVNOWRP           NO ==>                       @D36ZDJB 03237000
         L     R3,PGVFVBEG        GET TRACE AREA BEGIN         @D36ZDJB 03238000
PFVNOWRP EQU   *                                               @D36ZDJB 03239000
         ST    R3,PGVFVCUR        STORE IT AS CURRENT POINTER  @D36ZDJB 03240000
         BR    R2                 RETURN TO CALLER             @D36ZDJB 03241000
         DROP  R3,RA,RC,RD                                     @D14ZDJB 03242000
         EJECT                                                 @D36ZDJB 03243000
************************************************************** @D369DJB 03244000
*    TRACE TABLES                                            * @D369DJB 03245000
************************************************************** @D369DJB 03246000
         SPACE 2                                               @D36ZDJB 03247000
SPTASK   DC    CL4'TASK'          EXCLUSIVE SUBPOOL NAME       @D14ZDJB 03248000
PARIDBG  DC    CL2'BG'            BG INDICATOR                 @D36ZDJB 03249000
         SPACE 2                                               @D36ZDJB 03250000
         DC    CL4'CNTS'          EYE CATCHER                  @D14ZDJB 03251000
SYSGVCNT DC    F'0'               SYSTEM GETVIS COUNT          @D36ZDJB 03252000
SYSFVCNT DC    F'0'               SYSTEM FREEVIS COUNT         @D36ZDJB 03253000
PARGVCNT DC    F'0'               PARTITION GETVIS COUNT       @D36ZDJB 03254000
PARFVCNT DC    F'0'               PARTITION FREEVIS COUNT      @D36ZDJB 03255000
FVALLCNT DC    F'0'               FREEVIS ALL COUNT            @D36ZDJB 03256000
         SPACE 2                                               @D36ZDJB 03257000
         DC    CL4'SGPT'          EYE CATCHER                  @D14ZDJB 03258000
SYSGVBEG DC    A(SYSGVTR)         BEGIN OF SYSTEM GETVIS TRACE @D36ZDJB 03259000
SYSGVTPE DC    A(SYSGVTR)         TEMPORARY END OF TRACE AREA  @D36ZDJB 03260000
SYSGVCUR DC    A(SYSGVTR)         CURRENT POINTER WITHIN       @D36ZDJB 03261000
*                                        SYSTEM GETVIS TRACE   @D369DJB 03262000
SYSGVEND DC    A(SYSGVTRE)        END OF SYSTEM GETVIS TRACE   @D36ZDJB 03263000
         SPACE 2                                               @D36ZDJB 03264000
         DC    CL4'SFPT'          EYE CATCHER                  @D14ZDJB 03265000
SYSFVBEG DC    A(SYSFVTR)         BEGIN OF SYSTEM FREEVIS TRACE@D36ZDJB 03266000
SYSFVCUR DC    A(SYSFVTR)         CURRENT POINTER WITHIN       @D36ZDJB 03267000
*                                        SYSTEM FREEVIS TRACE  @D369DJB 03268000
SYSFVEND DC    A(SYSFVTRE)        END OF SYSTEM FREEVIS TRACE  @D36ZDJB 03269000
         SPACE 2                                               @D36ZDJB 03270000
         DC    CL4'PPTR'          EYE CATCHER                  @D14ZDJB 03271000
PGVFVBEG DC    A(PGVFVTR)         BEGIN OF PARTITION TRACE     @D36ZDJB 03272000
PGVFVCUR DC    A(PGVFVTR)         CURRENT POINTER WITHIN       @D36ZDJB 03273000
*                                            PARTITION TRACE   @D369DJB 03274000
PGVFVEND DC    A(PGVFVTRE)        END OF PARTITION TRACE       @D36ZDJB 03275000
         SPACE 2                                               @D36ZDJB 03276000
         DROP  RE                 END OF RE ADDRESSABILITY     @D36ZDJB 03277000
         SPACE 2                                               @D36ZDJB 03278000
         DS    0F                 ALIGNMENT                    @D14ZDJB 03279000
         DC    CL4'SGTR'          EYE CATCHER                  @D14ZDJB 03280000
SYSGVTR  DC    640X'C7E5000000000000000000000000000000000000'  @D51IDMZ 03281000
*                                        GETVIS TRACE AREA     @D149DJB 03282000
SYSGVTRE EQU   *                  SYSTEM GETVIS TRACE AREA END @D36ZDJB 03283000
         SPACE 2                                               @D36ZDJB 03284000
         DC    CL4'SFTR'          EYE CATCHER                  @D14ZDJB 03285000
SYSFVTR  DC    80X'C6E5000000000000000000000000000000000000'   @D51IDMZ 03286000
*                                       FREEVIS TRACE AREA     @D149DJB 03287000
SYSFVTRE EQU   *                  SYSTEM FREEVIS TRACE AREA END@D36ZDJB 03288000
         SPACE 2                                               @D36ZDJB 03289000
         DC    CL4'PATR'          EYE CATCHER                  @D14ZDJB 03290000
PGVFVTR  DC    (80*5)F'0'         PARTITION TRACE AREA         @D51IDMZ 03291000
PGVFVTRE EQU   *                  PARTITION TRACE AREA END     @D36ZDJB 03292000
         SPACE 2                                               @D36ZDJB 03293000
GVFVTR   EQU   PGVFVTRE-SYSGVHDL  LENGTH OF GETVIS/FREEVIS     @D36ZDJB 03294000
*                                  TRACE AREA AND UPDATE CODE  @D369DJB 03295000
         EJECT                                                 @D14CDJB 03296000
***************************************************************@D369DJB 03297000
*                                                              @D369DJB 03298000
*   RECOVERY ROUTINE FOR GETVIS/FREEVIS :                      @D149DJB 03299000
*                                                              @D369DJB 03300000
*     THIS ROUTINE IS CALLED BY THE PROGRAM CHECK HANDLER      @D149DJB 03301000
*     WHEN A PROGRAM CHECK OCCURED WITHIN THE GETVIS/FREEVIS   @D149DJB 03302000
*     CODE. THIS MAY BE CAUSED BY AN ERROR IN THE GETVIS/      @D149DJB 03303000
*     FREEVIS CODE OR DUE TO AN OVERLAY OF THE GETVIS CONTROL  @D149DJB 03304000
*     TABLE. WHEN IT IS AN PARTITION REQUEST, THE USER IS      @D149DJB 03305000
*     CANCELLED WITH ERROR 25 OTHERWISE THE SYSTEM GOES TO     @D149DJB 03306000
*     HARDWAIT.                                                @D149DJB 03307000
*                                                              @D369DJB 03308000
*   INPUT : R0 : END OF GETVIS AREA                            @D369DJB 03309000
*           RC : START OF GETVIS AREA                          @D369DJB 03310000
*                                                              @D369DJB 03311000
*   OUTPUT: NONE                                               @D369DJB 03312000
*                                                              @D369DJB 03313000
*   LINK REGISTER : RXXX                                       @D149DJB 03314000
*                                                              @D369DJB 03315000
***************************************************************@D369DJB 03316000
         SPACE 2                                               @D36ZDJB 03317000
         USING DISP,R6                                         @D14CDJB 03318000
GVFVREC  DS    0H                                              @D14CDJB 03319000
***************************************************************@D369DJB 03320000
*   CANCEL USER                                                @D369DJB 03321000
***************************************************************@D369DJB 03322000
ANCHOVLD EQU   *                                               @D36ZDJB 03323000
         L     R6,DISPAD          GET DISPATCHER ADDRESS       @D36ZDJB 03324000
         L     R5,PIBPTR2                                      @D51IDMZ 03325000
         USING PIB2ADR,R5                                      @D51IDMZ 03326000
         L     R5,PIBPCB          GET CURRENT PCB POINTER      @D51IDMZ 03327000
         USING PCBADR,R5          PCB ADDRESSABILITY           @D36ZDJB 03328000
         CLC   CDLDBYTE(L1),TIDBYTE  TASK OWNING CDLOAD ?      @D36ZDJB 03329000
         BNE   ERR25              NO ==> CANCEL                @D36ZDJB 03330000
         MVI   CDLDBYTE,ZERO      RESET CDLOAD OWNERSHIP       @D37ZDJB 03331000
         LA    R5,SRQCDL          ADDR. OF CDLOAD WAIT QUEUE   @D14BDJB 03332000
         DROP  R5                                              @D36ZDJB 03333000
         BAL   RF,RPOST           FREE AND POST ALL WAITERS    @D36ZDJB 03334000
*SGLINK  RPOST,INPUT=(R5,R6,RF),WORK=(R5,RE)                   @D14ZDJB 03335000
         B     ERR25              ==> CANCEL                   @D36ZDJB 03336000
         DROP  R6                                              @D14CDJB 03337000
.NODBG07 ANOP                                                  @D36ZDJB 03338000
         EJECT                                                 @D51IDMZ 03339000
***************************************************************@D369DJB 03340000
* THE FOLLOWING SUBROUTINES HAVE THEIR OWN BASE                @D51IDMZ 03341000
***************************************************************@D369DJB 03342000
.* THIS IS PART 3 WHERE EVERY SUBROUTINE HAS ITS OWN BASE.    *@D51IDMZ 03343000
.* FOR THESE ROUTINES TBASE=OWN IS SET.                       *@D51IDMZ 03344000
.* IF ONE OF THESE ROUTINES CALLS ANOTHER ROUTINE USING       *@D51IDMZ 03345000
.* SGAMSUBR, CBASE=OWN MUST BE SET. FURTHERMORE               *@D51IDMZ 03346000
.* SUBROUC=&SUBROUT MUST BE CODED.                            *@D51IDMZ 03347000
.* FOR EVERY ROUTINE THE BASE MUST BE DEFINED WITHIN THE      *@D51IDMZ 03348000
.* ADDRESS RANGE OF SGAM (BASE AMBASE)                        *@D51IDMZ 03349000
*********************************************************************** 03350000
*                                                                       03351000
*   GTVSINI0 : GETVIS CONTROL AREA INITIALIZATION ROUTINE      @D149DJB 03352000
*   GTVSINI1 : FREEVIS INITIALIZATION ROUTINE                  @D52VDMZ 03353000
*   GTVSINI2 : SWITCH CONTROL INFO                             @D52VDMZ 03354000
*   GTVSINI3 : SWITCH SUBPOOL FIELDS                           @D52VDMZ 03355000
*                                                                       03356000
*    MODULE GTVSINIT:                                          @D149DJB 03357000
*     SELECT(RB):                                              @D149DJB 03358000
*       WHEN(0) : GTVSINI0 (INTIALIZE FOR GETVIS)              @D52VDMZ 03359000
*       WHEN(1) : GTVSINI1 (INTIALIZE FOR FREEVIS)             @D52VDMZ 03360000
*       WHEN(2) : GTVSINI2 (SWITCH CNTRL. INFO,DUPL. FIELDS)   @D52VDMZ 03361000
*       WHEN(3) : GTVSINI3 (SWITCH SUBPOOL, DUPLICATE FIELDS)  @D52VDMZ 03362000
*     END SELECT                                               @D52VDMZ 03363000
*                                                                       03364000
*    GTVSINIT0:                                                         03365000
*         LOC=RES HANDLING                                     @D52VDMZ 03366000
*         IF GETVIS CONTROL AREA IS INITIALIZED                @D149DJB 03367000
*           THEN EXIT GTVSINIT                                 @D149DJB 03368000
*         IF SVA REQUEST                                       @D149DJB 03369000
*           THEN INDICATE INIT. BY SETTING SYSFLAG4 IN SYSCOM  @D149DJB 03370000
*         COMPUTE LENGTH OF GETVIS AREA                        @D149DJB 03371000
*         COMPUTE THEREOF LENGTH OF GETVIS CONTROL INFORMATION @D149DJB 03372000
*         IF PARTITION GETVIS REQUEST                          @D149DJB 03373000
*           THEN EXECUTE GFSETKEY (KEY 0 FOR CONTROL INFORM.)  @D149DJB 03374000
*                SET IJBGVCTL IN PARTITION COMREG              @D149DJB 03375000
*         INITIALIZE VISTAB HEADER                             @D149DJB 03376000
*         INITIALIZE SUBPOOL CHAIN TABLE                       @D149DJB 03377000
*         INITIALIZE SUBPOOL INDEX TABLE                       @D149DJB 03378000
*         IF SVA OR SPACE REQUEST                              @D149DJB 03379000
*           THEN EXIT GTVSINIT                                 @D149DJB 03380000
*           ELSE OCCUPY FIRST 128 BYTES FOR VSAM ANCHOR INFORM.@D149DJB 03381000
*                INDICATE INIT. BY SETTING OPTNBYTE IN COMREG  @D149DJB 03382000
*                EXIT GTVSINIT                                 @D149DJB 03383000
*    GTVSINIT1:                                                         03384000
*    GTVSINIT2:                                                         03385000
*    GTVSINIT3:                                                         03386000
*    ENDMODULE GTVSINIT                                        @D149DJB 03387000
*                                                                    RZ 03388000
*   CALLED BY : GETVIS                                         @D149DJB 03389000
*   CALLS     : GFSTKEYV (BGVM) GFSTKEYP (BG370)               @D149DJB 03390000
*                                                              @D149DJB 03391000
*   INPUT                                                      @D52VDMZ 03392000
*      COMMON                                                  @D52VDMZ 03393000
*          RB --> INDICATES REQUEST (GETVIS,FREEVIS)           @D52VDKH 03394000
*                   0 ==> INITIALIZE FOR GETVIS                         03395000
*                   1 ==> INITIALIZE FOR FREEVIS                        03396000
*                   2 ==> SWITCH CONTROL INFO, DUPLICATE FIELDS         03397000
*                   3 ==> SWITCH SUBPOOL INDEX, DUPLICATE FIELDS        03398000
*          RE --> BASE REGISTER                                @D51IDMZ 03399000
*      RB = 0                                                  @D52VDMZ 03400000
*          RA --> TCBPTR                                       @D52VDMZ 03401000
*          RD --> REQUESTOR'S SAVE AREA                        @D149DJB 03402000
*          RF  : 0                                             @D52VDMZ 03403000
*          DFWKCOMG (COMREG ADDR) : PARTITION ONLY             @D52VDMZ 03404000
*      RB = 1                                                  @D52VDMZ 03405000
*          RD --> REQUESTOR'S SAVE AREA                        @D149DJB 03406000
*          RF  : 0                                             @D52VDMZ 03407000
*          DFWKCOMG (COMREG ADDR) : PARTITION ONLY             @D52VDMZ 03408000
*      RB = 2                                                  @D52VDMZ 03409000
*          RC --> PTR TO CI                                    @D52VDMZ 03410000
*          RD --> REQUESTOR'S SAVE AREA                        @D149DJB 03411000
*      RB = 3                                                  @D52VDMZ 03412000
*          R5 --> SUBPOOL INDEX                                @D52VDMZ 03413000
*          RC --> PTR TO CI                                    @D52VDMZ 03414000
*   OUTPUT :                                                   @D149DJB 03415000
*      (CALLED WITH RB=0)                                      @D149DJB 03416000
*            RF  : 0 : INITIALIZATION OK                       @D149DJB 03417000
*                  4 : THE CORRESPONDING REAL PARTITION IS 0K  @D149DJB 03418000
*                      OR SVA IS NOT YET INITIALIZED           @D149DJB 03419000
*               X'0C : ONLY ONE PAGE GETVIS (RB=0)             @D52VDMZ 03420000
*               X'30 : IPL REQUEST          (RB=0)             @D52VDMZ 03421000
*                      STATUS SIZE|ALL REQ. (RB=0)             @DY44311 03422000
*            RB  :  0  FOR PARTITION GETVIS/FREEVIS            @D52VDMZ 03423000
*                   -3 FOR SYSTEM OR SPACE GETVIS/FREEVIS      @D52VDMZ 03424000
*            RC --> ANCHOR TABLE                               @D52VDMZ 03425000
*                   0 IN CASE RF /= 0                          @D52VDMZ 03426000
*      (CALLED WITH RB=1)                                      @D149DJB 03427000
*            RF  : 0 : INITIALIZATION OK                       @D149DJB 03428000
*                  4 : THE CORRESPONDING REAL PARTITION IS 0K  @D149DJB 03429000
*                  8 : LENGTH NEGATIVE                         @D149DJB 03430000
*               X'0C : INVALID START ADDRESS                   @D52VDMZ 03431000
*               X'10 : LENGTH EXCEEDS GETVIS AREA              @D149DJB 03432000
*            RB  :  0  FOR PARTITION GETVIS/FREEVIS            @D52VDMZ 03433000
*                   -3 FOR SYSTEM OR SPACE GETVIS/FREEVIS      @D52VDMZ 03434000
*            RC --> ANCHOR TABLE                               @D52VDMZ 03435000
*                   0 IN CASE OF ERROR                         @D52VDMZ 03436000
*            RF  : 0 : INITIALIZATION OK                       @D149DJB 03437000
*                  4 : THE CORRESPONDING REAL PARTITION IS 0K  @D149DJB 03438000
*                  4   SVA IS NOT YET INITIALIZED (RB=0)       @D149DJB 03439000
*               X'10   GETVIS NOT YET INITIALIZED (RB=1)       @D149DJB 03440000
*               X'0C : ONLY ONE PAGE GETVIS (RB=0)             @D52VDMZ 03441000
*               X'2C : CI MOVED             (RB=0)             @D52VDMZ 03442000
*               X'30 : LENGTH 0 REQ. BY IPL (RB=0)             @D52VDMZ 03443000
*            RB  :  0  FOR PARTITION GETVIS/FREEVIS            @D52VDMZ 03444000
*                   -3 FOR SYSTEM OR SPACE GETVIS/FREEVIS      @D52VDMZ 03445000
*            RC --> ANCHOR TABLE                               @D52VDMZ 03446000
*                   0 IN CASE OF ERROR                         @D52VDMZ 03447000
*      (CALLED WITH RB=2|3)                                    @D149DJB 03448000
*            RF  : 0                                           @D149DJB 03449000
*   WORK (RB=0) : R0,R1,R2,R3,R4,R5,R8,R9                               03450000
*   WORK (RB=1) : R0,R1,R2,R3,R4,R5,R8,R9                               03451000
*   WORK (RB=2) : R0,R1,R2,R3,R4,R5,R8,R9                               03452000
*   LINK   : R7                                                @D149DJB 03453000
*                                                              @D149DJB 03454000
         AGO    .CREATEB                                       @D14ZDJB 03455000
.GTVSIN1 ANOP                                                  @D14ZDJB 03456000
.*             0123456789ABCDEF                                @D149DJB 03457000
&INPREG  SETC '0000000000010111'                               @D52VDMZ 03458000
&OUTREG  SETC '0000000000011001'                               @D52VDMZ 03459000
&WRKREG  SETC '1111110011000000'                               @D14ZDJB 03460000
&NMDREG  SETC '0000001100100110'                               @D52VDMZ 03461000
&LINKR   SETC 'R7'                                             @D14ZDJB 03462000
&TBASE   SETC 'OWN'                                            @D51IDMZ 03463000
.*EXCLSYMS=()                                                  @D52VDMZ 03464000
         AGO    .TESTALL                                       @D14ZDJB 03465000
.GTVSIN2 ANOP                                                  @D14ZDJB 03466000
.*             0123456789ABCDEF                                @D149DJB 03467000
&INPREG  SETC '0000000000011110'                               @D52VDMZ 03468000
&OUTREG  SETC '0000000000000000'                               @D52VDMZ 03469000
&WRKREG  SETC '0000000000010000'                               @D14ZDJB 03470000
&NMDREG  SETC '1111111111101111'                               @D52VDMZ 03471000
&LINKR   SETC 'R7'                                             @D14ZDJB 03472000
&TBASE   SETC 'OWN'                                            @D51IDMZ 03473000
.*EXCLSYMS=()                                                  @D52VDMZ 03474000
         AGO    .TESTALL                                       @D14ZDJB 03475000
.GTVSIN3 ANOP                                                  @D14ZDJB 03476000
.*             0123456789ABCDEF                                @D149DJB 03477000
&INPREG  SETC '0000010000011010'                               @D52VDMZ 03478000
&OUTREG  SETC '0000000000000000'                               @D52VDMZ 03479000
&WRKREG  SETC '0000000000010000'                               @D14ZDJB 03480000
&NMDREG  SETC '1111111111101111'                               @D52VDMZ 03481000
&LINKR   SETC 'R7'                                             @D14ZDJB 03482000
&TBASE   SETC 'OWN'                                            @D51IDMZ 03483000
.*EXCLSYMS=()                                                  @D52VDMZ 03484000
         AGO    .TESTALL                                       @D14ZDJB 03485000
.GTVSIN0 ANOP                                                  @D14ZDJB 03486000
.*             0123456789ABCDEF                                @D149DJB 03487000
&INPREG  SETC '0000000000110111'                               @D52VDMZ 03488000
&OUTREG  SETC '0000000000011001'                               @D52VDMZ 03489000
&WRKREG  SETC '1111110011000000'                               @D14ZDJB 03490000
&NMDREG  SETC '0000001100100110'                               @D52VDMZ 03491000
&LINKR   SETC 'R7'                                             @D14ZDJB 03492000
&TBASE   SETC 'OWN'                                            @D51IDMZ 03493000
.*EXCLSYMS=(SAVREGS)                                           @DY45752 03494000
         AGO    .TESTALL                                       @D14ZDJB 03495000
.CREATEB ANOP                                                  @D14ZDJB 03496000
*                                                              @DA33870 03497000
* CHANGE ACTIVITY:                                             @DA33870 03498000
* DY33870 - PROGRAM CHECK DURING IUI-VSAM DIALOG SELECTION 5.  @DA33870 03499000
* DY36124   GETVIS AREA FRAGMENTATION                          @DA36124 03500000
* DY36211   REUSAGE OF STORAGE GAPS                            @DA36211 03501000
* DY36550   FAILURE TO PFIX PAGES IN THE SYSTEM GETVIS AREA    @DA36550 03502000
* DY36823   SUBPOOL INDEX TABLE ENTRY SPITCURP PTR CORRUPTION  @DA36823 03503000
* SPE DY37265                                                  @D218DKH 03504000
* DY38212   2K/4K BOUNDARY FOR PAGE=YES IN /370 - VM MODE      @DY38212 03505000
*********************************************************************** 03506000
         SPACE 3                                                        03507000
         USING TCBADR,RA                                       @D52VDMZ 03508000
         USING SVEARA,RD                                       @D14CDJB 03509000
         USING GTVSINIT,RE                                     @D51IDMZ 03510000
GTVSINIT DS    0H                 COMMON ENTRY FOR INTIALIZAT. @D367DJB 03511000
         LTR   RB,RB              IS IT A FREEVIS REQUEST ?    @D52VDKH 03512000
         BZ    GTVSINT2           NO, GETVIS                   @D52VDKH 03513000
         BCT   RB,GTVSIENT        SWITCH FIELDS                @D52VDKH 03514000
**************************************************************          03515000
*   INITIALIZATION FOR FREEVIS                               *          03516000
**************************************************************          03517000
*SGLINK  GTVSINI1,S,INPUT=(R7:LINK,RB-RD,RF),OUTPUT=(RB,RC,RF),        *03518000
               WORK=(R0-R2,R3-R5,R8,R9,RC,RE,RF),NOMODR=(R7),          *03519000
               AMODE=31,SUBROUT=(FVSCHECK)                              03520000
         TM    SVER0F+D3,SVAIND   SYSTEM GETVIS REQUEST ?      @D52VDKH 03521000
         BZ    FVSINIT6           NO ===>                      @D52VDKH 03522000
*                                                                       03523000
*  FOR SVA                                                              03524000
*                                                                       03525000
*  WARNING: THE PATH FOR FREEVIS ROUTED MUST NOT ALTER R1               03526000
*                                                                       03527000
FVSINIT0 DS    0H                                              @D52VDKH 03528000
         LTR   RC,RC              ?????                        @D64ADKH 03529000
         BNZ   FVSINIT1                                        @D64ADKH 03530000
         TM    SYSFLAG4,ANCHSVA   SVA INITIALIZED?             @D52VDKH 03531000
         BZ    GTVSVAIN           NO, ERROR                    @D52VDKH 03532000
         L     RB,IJBSMCOM        ADDRESS SMCOM                @D52VDKH 03533000
         USING SMCOM,RB                                        @D52VDKH 03534000
         L     RC,SMCSGV31        GET PTR TO CONTROL INFO      @D52VDKH 03535000
         DROP  RB                                              @D52VDKH 03536000
FVSINIT1 DS    0H                                              @D52VDKH 03537000
         USING ANCHTAB,RC                                      @D52VDKH 03538000
         LA    RB,LDVBYTBI-LDVBYTSV SHIFT MODIFIER FOR ..      @D52VDKH 03539000
         LNR   RB,RB              .. SVA/SPACE REQUESTS        @D52VDKH 03540000
* FOR FREEVIS ROUTED, ALL AND SUBPOOL DO ONLY SET LOC          @D52VDMZ 03541000
*SGLINK  GTVSINI4,S,INPUT=(R7:LINK,RB-RD,RF),OUTPUT=(RB,RC,RF),        *03542000
               WORK=(R1,RC,RE,RF),NOMODR=(R7),AMODE=31                  03543000
         TM    SVER0F+D3,SMFVALL+FVSPID ?                      @D64ADMZ 03544000
         BNZ   FVSINITY              YES, SET LOC              @D52VDKH 03545000
         TM    SVER0F+D1,FVROUTED                              @D64ADMZ 03546000
         BO    FVSINITY              YES, SET LOC              @D64ADMZ 03547000
*SGLINK  FVSCHECK,INPUT=(R8:LINK,RB-RD),OUTPUT=(RF),                   *03548000
               NOMODR=(R6,R7,RA-RD),                                   *03549000
               AMODE=31                                                 03550000
         BAL   R8,FVSCHECK        CHECK USER'S INPUT           @D52VDKH 03551000
         LTR   RF,RF                                           @D52VDKH 03552000
         BNZ   FVSNGOOD           SEES TO BE A PROBLEM         @D52VDKH 03553000
         BR    R7                  EXIT                        @D52VDKH 03554000
FVSINIT6 EQU   *                                               @D52VDKH 03555000
         TM    SVER0F+D2,GVFVPMSP   REQUEST FOR PMR SPACE      @D52VDMZ 03556000
         BO    FVSINITA             YES                        @D52VDMZ 03557000
         TM    SVER0F+D2,GVFVSPIN   REQUEST FOR SPACE GETVIS?  @D52VDKH 03558000
         BZ    FVSINIT9             NO, ==> PARTITION          @D52VDKH 03559000
*                                                                       03560000
*  FOR SPACE                                                            03561000
*                                                                       03562000
         L     R1,PIBPTR2         GET CURRENT PCB OUT OF...    @D52VDKH 03563000
         USING PIB2ADR,R1         .. PIB2                      @D52VDKH 03564000
         L     R1,PIBPCB                                       @D52VDKH 03565000
         USING PCBADR,R1                                       @D52VDKH 03566000
         TM    PCEFLAG,PCEDYNP         DYNAMIC PARTITION       @D52VDKH 03567000
         BO    FVSINIT7                YES ==>                 @D52VDKH 03568000
         DROP  R1                                              @D52VDKH 03569000
         OI    SVER0F+D3,SVAIND     SET SVA INDICATOR, ROUTED  @D52VDKH 03570000
         B     FVSINIT0                                        @D52VDKH 03571000
FVSINIT7 EQU   *                  SPACE REQUEST                @D52VDKH 03572000
* PTR TO CI (RC) IS SET DURING GVFVGATING. BUT THE CI MAY NOT YET BE    03573000
* INITIALIZED. THIS IS ALLOWED DURING GETVIS, BUT IS AN ERROR DURING    03574000
* FREEVIS                                                               03575000
         USING ANCHTAB,RC         ADDR ANCHOR TABLE            @D64ADMZ 03576000
         TM    GVFVFLG2,SPGVINIT  SP. GETV. INITIALIZED?       @D64ADMZ 03577000
         BZ    GTVSVAIN           SPACE GETVIS NOT INITIALIZED @D64ADMZ 03578000
         B     FVSINIT1                                        @D52VDKH 03579000
         DROP  RC                 RELEASE ANCHTAB              @D52VDKH 03580000
FVSINITA DS    0H                 PMR REQUEST                  @D52VDMZ 03581000
*                                                                       03582000
*  FOR PMR SPACE                                                        03583000
*                                                                       03584000
         L     RC,SCBPTR          GET SCB OF PMR SPACE         @D52VDMZ 03585000
         USING SCBADR,RC                                       @D52VDMZ 03586000
         L     RC,SCBPMSPC        IS PMR SPACE GETVIS AREA..   @D52VDMZ 03587000
         LTR   RC,RC              INITIALIZED                  @D52VDMZ 03588000
         BZ    GTVSVAIN           NO                           @D52VDMZ 03589000
         DROP  RC                                              @D52VDMZ 03590000
         USING ANCHTAB,RC                                      @D52VDMZ 03591000
         LA    RB,LDVBYTBI-LDVBYTSV SHIFT MODIFIER FOR ..      @D52VDMZ 03592000
         LNR   RB,RB              .. SVA/SPACE REQUESTS        @D52VDMZ 03593000
*SGLINK  FVSCHECK,INPUT=(R8:LINK,RB-RD),OUTPUT=(RF),                   *03594000
               NOMODR=(R6,R7,RA-RD),                                   *03595000
               AMODE=31                                                 03596000
         BAL   R8,FVSCHECK        CHECK USER'S INPUT           @D52VDKH 03597000
         AIF   (NOT &BGDEBUG).NODBGFI                          @D52VDKH 03598000
         BALR  R5,0               ADDRESS FOR HW FED           @D52VDKH 03599000
         LTR   RF,RF              SPACE FOUND ?                @D52VDKH 03600000
         BNZ   SYSERROR           NO  ===>                     @D52VDKH 03601000
.NODBGFI ANOP                                                  @D52VDKH 03602000
         BR    R7                                              @D52VDMZ 03603000
FVSINIT9 EQU   *                  PARTITION GETVIS             @D52VDKH 03604000
*                                                                       03605000
*  FOR PARTITION                                                        03606000
*                                                                       03607000
         LTR   RC,RC              AREA INITIALIZED AND..       @D64ADKH 03608000
         BNZ   FVSINIT8           ... GATES CLOSED             @D64ADKH 03609000
         L     R3,DFWKCOMG        GET COMREG ADDRESS           @D52VDMZ 03610000
         USING COMREG,R3                                       @D52VDKH 03611000
         L     RC,IJBGVCTL        PTR TO PART. GETV. CNTRL.INFO@D52VDKH 03612000
         TM    OPTNBYTE,ANCHTBIT  GETVIS AREA INITIALIZED ?    @D52VDKH 03613000
         BNO   FVSINITZ           NO  ===>                     @D52VDKH 03614000
FVSINIT8 EQU   *                  SPACE REQUEST                @D52VDKH 03615000
         TM    SVER0F+3,SMFVALL   IS FREEVIS ALL REQUESTED?    @D52VDKH 03616000
         BO    FVSINITX           YES, FORCE BELOW             @D52VDKH 03617000
         TM    SVER0F+3,FVSPID    SUBPOOL TO BE FREED ?        @D52VDKH 03618000
         BO    FVSINITY           YES, SET LOC                 @D52VDKH 03619000
         L     R8,LGTHSAV         BOUNDARY XING IN PROCESS ?   @D52VDKH 03620000
         LTR   R8,R8                                           @D52VDKH 03621000
         BNZ   FVSINTNX           YES, NO FURTHER CHECKING     @D52VDKH 03622000
*SGLINK  FVSCHECK,INPUT=(R8:LINK,RB-RD),OUTPUT=(RF),                   *03623000
               NOMODR=(R6,R7,RA-RD),                                   *03624000
               AMODE=31                                                 03625000
         BAL   R8,FVSCHECK        CHECK USER'S INPUT           @D52VDKH 03626000
         LTR   RF,RF              ACCEPTABLE ?                 @D52VDKH 03627000
         BNZ   FVSNGOOD           OH NO                        @D52VDKH 03628000
         BR    R7                  EXIT                        @D52VDKH 03629000
FVSINTNX DS    0H                 WE ARE IN ABOVE AREA         @D52VDKH 03630000
         OI    SVER0F+2,GVLOCBEL  FORCE PROCESSING TO START    @D52VDKH 03631000
         B     GVRES150           IN PART BELOW                @D52VDKH 03632000
FVSINITZ DS    0H                                              @D52VDKH 03633000
*  PSEUDO PARTITION ?????????????                                       03634000
         L     R1,PPEND           GET START OF                 @D52VDKH 03635000
         A     R1,F1                    PARTITION GETVIS AREA  @D52VDKH 03636000
         DROP  R3                                              @D52VDKH 03637000
         L     R2,PCBPTR          GET CURRENT PCB              @D52VDKH 03638000
         USING PCBADR,R2                                       @D52VDKH 03639000
         CL    R1,PCBAPEND        GETVIS AREA PROVIDED ?       @D52VDKH 03640000
         DROP  R2                                              @D52VDKH 03641000
         BE    GTVSVAIN           NO  ===> REAL GETVIS IS 0K   @D52VDKH 03642000
*        SLR   RC,RC              CLEAR PTR TO CONTROL AREA    @D52VDKH 03643000
         LA    RF,16                                           @D52VDKH 03644000
         BR    R7                 RETURN                       @D52VDKH 03645000
FVSINITX DS    0H                                              @D52VDKH 03646000
         B     GVRES050           FORCE PROC. TO START BELOW   @D52VDMZ 03647000
FVSINITY DS    0H                                              @D52VDKH 03648000
         TM    GVFVFLGS,GVFVABVE  SWITCHED TO ABOVE PART ?     @D52VDKH 03649000
         BO    FVIABVE            YES, ==>                     @D52VDKH 03650000
         DROP  RC                                              @D52VDKH 03651000
         OI    SVER0F+2,GVLOCBEL   NO, INDICATE PROCESSING BELO@D52VDKH 03652000
         BR    R7                  AND RETURN                  @D52VDKH 03653000
FVIABVE  DS    0H                                              @D52VDKH 03654000
         OI    SVER0F+2,GVLOCANY   INDICATE PROCESSING ABVE    @D52VDKH 03655000
         BR    R7                  AND RETURN                  @D52VDKH 03656000
         EJECT                                                          03657000
**************************************************************          03658000
*   INITIALIZATION FOR GETVIS                                *          03659000
**************************************************************          03660000
*SGLINK  GTVSINI0,S,INPUT=(R7:LINK,RA-RC,RD,RF),OUTPUT=(RB,RC,RF),     *03661000
               WORK=(R0,R1,R2,R3-R5,R8,R9,RC,RE),NOMODR=(R7),          *03662000
               AMODE=31,SUBROUT=(GFSTKEYP)                              03663000
GTVSINT2 DS    0H                                              @D51IDKH 03664000
         LA    RB,LDVBYTBI-LDVBYTSV SHIFT MODIFIER FOR ..      @D52VDKH 03665000
         LNR   RB,RB              .. SVA/SPACE/PMR REQUESTS    @D52VDKH 03666000
         TM    SVER0F+D3,SVAIND   SYSTEM GETVIS REQUEST ?      @D51IDKH 03667000
         BNZ   GTVSINT5           YES ===>                     @D51IDKH 03668000
         TM    SVER0F+D2,GVFVSPIN      REQUEST FOR SPACE GETV? @D52VDMZ 03669000
         BO    GTVSISP0                YES                     @D52VDMZ 03670000
         TM    SVER0F+D2,GVFVPMSP      PMR SPACE REQUEST       @D52VDMZ 03671000
         BZ    GTVSINT3                NO, MUST BE PARTITION   @D52VDMZ 03672000
************************************************************** @D369DJB 03673000
*   INITIALIZATION PART FOR PMR SPACE                                   03674000
************************************************************** @D369DJB 03675000
         L     R5,SCBPTR               GET SCB OF PMR SPACE    @D52VDMZ 03676000
         USING SCBADR,R5                                       @D52VDMZ 03677000
         L     RC,SCBPMSPC        GET CONTROL INFO             @D52VDMZ 03678000
         LTR   RC,RC              PMR SPACE INITIALIZED        @D52VDMZ 03679000
         BNZ   GVRES300           YES TREAT AS ONE AREA        @D52VDMZ 03680000
         L     R0,SCBSPGVE        END OF PMR SPACE AREA        @D52VDMZ 03681000
         L     RC,SCBSPGVB        BEGIN OF PMR SPACE AREA      @D52VDMZ 03682000
         ST    RC,SCBPMSPC        SAVE IT                      @D52VDMZ 03683000
         DROP  R5                                              @D52VDMZ 03684000
         B     GTVSICOM           COMMON PATH FOR SPACE/PMR    @D52VDMZ 03685000
**************************************************************          03686000
*   INITIALIZATION PART FOR SPACE GETVIS AREA                *          03687000
**************************************************************          03688000
GTVSISP0 DS    0H                                              @D52VDMZ 03689000
* RC POINTS TO CI (DONE DURING GATING), EVEN IF CI IS NOT YET           03690000
* INITIALIZED.                                                          03691000
         L     R4,PIBPTR2         GET CURRENT PIB2             @D51IDMZ 03692000
         USING PIB2ADR,R4              SEE IF SPACE GETVIS     @D51IDKH 03693000
         L     R4,PIBPCB          GET CURRENT PCB              @D51IDMZ 03694000
         USING PCBADR,R4               SEE IF SPACE GETVIS     @D51IDKH 03695000
         TM    PCEFLAG,PCEDYNP    SPACE REQUEST FOR DYN. PART. @D51IDKH 03696000
         BO    GTVSINT6           YES ==>                      @D51IDKH 03697000
         OI    SVER0F+D3,SVAIND   REQUEST IS ROUTED TO SVA     @D51IDKH 03698000
         B     GTVSINT5           INITIALIZE SVA               @D51IDKH 03699000
GTVSINT6 DS    0H                                              @D51IDKH 03700000
         USING ANCHTAB,RC         ADDR ANCHOR TABLE            @D64ADMZ 03701000
         TM    GVFVFLG2,SPGVINIT  SP. GETV. INITIALIZED?       @D64ADMZ 03702000
         BO    GVRES300           YES, FORCE LOC=BELOW         @D52VDMZ 03703000
         OI    GVFVFLG2,SPGVINIT  INDICATE INITIALIZED         @D64ADMZ 03704000
         DROP  RC                 RELEASE ANCHOR TABLE         @D64ADMZ 03705000
         L     RC,SCBPTR                                       @D51IDKH 03706000
         USING SCBADR,RC                                       @D51IDKH 03707000
         L     R0,SCBSPGVE             END OF SPACE GETVIS AREA@D51IDKH 03708000
         L     RC,SCBSPGVB             BEGIN OF SPACE GETVIS   @D51IDKH 03709000
         DROP  RC                 RELEASE SCB                  @D52VDMZ 03710000
* COMMON PATH FOR SPACE / PMR SPACE                            @D52VDMZ 03711000
GTVSICOM DS    0H                 COMMON PATH                  @D52VDMZ 03712000
         USING ANCHTAB,RC                                      @D52VDKH 03713000
         ST    R0,EVIRTMEM        END OF BELOW PART            @D52VDKH 03714000
         LR    R4,RC              START OF GETVIS AREA         @D52VDKH 03715000
         A     R4,PAGESIZE        + MINIMUM CONTR. INFORMATION @D52VDKH 03716000
         LR    R5,R0              GET LENGTH OF                @D52VDKH 03717000
         SR    R5,R4                         GETVIS AREA       @D52VDKH 03718000
         LA    R5,1(,R5)          ONE MORE LITTLE BYTE         @D52VDKH 03719000
         B     GETVISIR                                        @D52VDKH 03720000
         DROP  R4,RC                                           @D51IDKH 03721000
************************************************************** @D369DJB 03722000
*   INITIALIZATION PART FOR SVA                              * @D369DJB 03723000
************************************************************** @D369DJB 03724000
GTVSINT5 DS    0H                                              @D51IDKH 03725000
         L     R8,IJBSMCOM        GET ADDRESS OF SMCOM         @D52VDMZ 03726000
         USING SMCOM,R8                                        @D52VDMZ 03727000
         TM    SYSFLAG4,ANCHSVA   FIRST REQUEST ?              @D14CDJB 03728000
         BZ    GTVSFRST           YES                          @D52VDKH 03729000
* PTR TO CI SET IN GVFVGATING                                           03730000
GTVSINT51 DS    0H                                             @D64ADKH 03731000
         TM    SMCFLG1,SMCGVBEL   BELOW AREA INITIALIZED?      @DDCR360 03732000
         BO    GTVSLRES           YES, DO LOC=RES HANDLING     @DDCR360 03733000
         TM    SVER0F+D2,GVLOCANY LOC=ANY SET ?                @DDCR360 03734000
         BO    GTVSLRES           YES, CONTINUE                @DDCR360 03735000
         TM    SVER0F+D2,GVLOCBEL LOC=BELOW SET ?              @DDCR360 03736000
         BO    GTVSVAIN_1         YES, BUT AREA NOT AVAILABLE  @DDCR360 03737000
         TM    TCBIEXFL,TCBIEXRM  CALLER IN RMODE 31 ?         @DDCR360 03738000
         BO    GTVSLRES           YES, LOC=ANY HANDLING        @DDCR360 03739000
         B     GTVSVAIN_1         NO, RETURN AREA NOT AVAIL.   @DDCR360 03740000
GTVSFRST DS    0H                                              @D52VDKH 03741000
         TM    SVER0F+D2,GVIPL    IPL=YES SPECIFIED            @DDCR360 03742000
         BZ    GTVFRST1           NO, HANDLE REQUEST           @DDCR360 03743000
         L     R5,SVER00          NO OF DYN. PARTITIONS        @DDCR360 03744000
         STH   R5,SMCNODYN        SAVE IT FOR LATER USE        @DDCR360 03745000
         L     R5,SVER01          SIZE OF GETVIS AREA IN BYTES @DDCR360 03746000
         A     R5,PAGESIZE        ROUND ..                     @DDCR360 03747000
         BCTR  R5,0               .. TO                        @DDCR360 03748000
         SRL   R5,PNSHIFT         ...    NEXT                  @DDCR360 03749000
         SLL   R5,PNSHIFT         ...       PAGE BOUNDARY      @DDCR360 03750000
         B     GETVISIR           CALCULATE SIZE OF CI         @DDCR360 03751000
GTVFRST1 DS    0H                                              @D52VDKH 03752000
         L     RC,SMCSVIS         BEGIN OF SYSTEM GETVIS AREA  @D52VDMZ 03753000
         LTR   RC,RC              SVA BEGIN ALREADY INITIALIZED@D52VDKH 03754000
         BZ    GTVSVAIN_1         NO  ===>                     @D51IDMZ 03755000
         L     R0,SMCESVIS        END OF SYSTEM GETVIS AREA    @D52VDKH 03756000
         LTR   R0,R0              SVA END ALREADY INITIALIZED  @D52VDKH 03757000
         BZ    GTVSVAIN           NO  ===>                     @D51IDKH 03758000
         L     R4,SMCSGV31        BEGIN OF SYSTEM GETVIS 31 BIT@DDCR360 03759000
         LTR   R4,R4              ALREADY INITIALIZED          @DDCR360 03760000
         BZ    GTVSVAIN           NO  ===>                     @DDCR360 03761000
         L     R5,SMCESG31        END OF SYSTEM GETVIS 31 BIT  @DDCR360 03762000
         LTR   R5,R5              ALREADY INITIALIZED          @DDCR360 03763000
         BZ    GTVSVAIN           NO  ===>                     @DDCR360 03764000
         TM    SMCFLG1,SMCGVBEL   BELOW AREA INITIALIZED?      @DDCR360 03765000
         BO    GTVFRST2           YES, CONTINUE                @DDCR360 03766000
         TM    SVER0F+D2,GVLOCANY LOC=ANY SET ?                @DDCR360 03767000
         BO    GTVFRST2           YES, REQUEST CAN BE HANDLED  @DDCR360 03768000
         TM    SVER0F+D2,GVLOCBEL LOC=BELOW SET ?              @DDCR360 03769000
         BO    GTVSVAIN           YES, AREA NOT AVAILABLE      @DDCR360 03770000
         TM    TCBIEXFL,TCBIEXRM  CALLER IN RMODE 31 ?         @DDCR360 03771000
         BO    GTVFRST2           YES, REQUEST CAN BE HANDLED  @DDCR360 03772000
         B     GTVSVAIN           NO, RETURN AREA NOT AVAIL.   @DDCR360 03773000
         DROP  R8                 RELEASE SMCOM                @D52VDMZ 03774000
GTVFRST2 DS    0H                                              @DDCR360 03775000
*PAGE FAULTS MAY OCCUR WHEN UPDATING THE CI, THEREFORE THE GETVIS       03776000
*GATE MUST BE CLOSED IN ADVANCE                                         03777000
*THIS IS THE FIRST REQUEST FOR THE SYSTEM GETVIS AREA, THEREFORE        03778000
*THE GATES HAD NOT BEEN CLOSED IN THE GATING ROUTINE. ALL GATES MUST    03779000
*OPEN.                                                                  03780000
         TM    SVER0F+D3,GVPFIX   PFIX REQUEST                 @D64ADMZ 03781000
         BZ    GTVFRST2_3         NO, CLOSE GETVIS GATE        @D64ADMZ 03782000
         L     R2,ASRQTAB                                      @D64ADMZ 03783000
         LA    R2,SRQSPFIX-SRQTAB(,R2) ADDR OF PFIX RESOURCE   @D64ADMZ 03784000
         USING RQADR,R2                                        @D64ADMZ 03785000
         TM    RSCDESC,FREEBIT    PFIX GATE OPEN               @D66ODOW 03786000
         BO    GTVFRST2_2         YES                          @D66ODOW 03787000
         BAL   R5,SYSERROR        PFIX GATE MUST BE OPEN       @D64ADMZ 03788000
*                                 INVALID ASSUMPTION OTHERWISE @D64ADMZ 03789000
GTVFRST2_2 DS  0H                                              @D64ADMZ 03790000
         MVC   RSCDESC,TID        CLOSE PFIX GATE, IDENT OWNER @D66ODOW 03791000
         DROP  R2                                              @D64ADMZ 03792000
GTVFRST2_3 DS  0H                 CLOSE GETVIS GATE            @D64ADMZ 03793000
         L     R2,ASRQTAB                                      @D64ADMZ 03794000
         LA    R2,SRQSGTVS-SRQTAB(,R2) ADDR GETVIS GATE        @D64ADMZ 03795000
         USING RQADR,R2                                        @D64ADMZ 03796000
         MVC   RSCDESC,TID        CLOSE GETVIS GATE, IDENT OWNE@D66ODOW 03797000
         DROP  R2                                              @D64ADMZ 03798000
         O     R2,BIT0OMSK        INDICATION FOR OPEN GATE     @D64ADMZ 03799000
         USING ANCHTAB,R4                                      @D52VDKH 03800000
         ST    R2,GVFVGATE        REMEMBER GATE FOR OPEN       @D64ADMZ 03801000
         ST    RC,BVIRTMEM        BEGIN OF BELOW PART          @D52VDKH 03802000
         ST    R0,EVIRTMEM        END OF BELOW PART            @D52VDKH 03803000
         ST    R5,AEVRTMEM        END OF ABOVE PART            @D52VDKH 03804000
         DROP  R4                                              @D52VDKH 03805000
         SR    R0,RC              CALCULATE LENGTH OF PART     @D52VDKH 03806000
         A     R0,F1              BELOW                        @D52VDKH 03807000
         LR    RC,R4              RC POINTS TO CONTROL INFO    @D52VDKH 03808000
         LR    R8,RC              CALCULATE LENGTH OF PART     @D52VDKH 03809000
         A     R8,PAGESIZE        ABOVE                        @D52VDKH 03810000
         LR    R4,R5              SAVE END ADDRESS             @D52VDKH 03811000
         SR    R5,R8              MINUS FIRST BYTE AFTER       @D52VDKH 03812000
         LA    R5,1(,R5)          CONTROL INFORMATION          @D52VDKH 03813000
         AR    R5,R0              ADD LENGTH OF BELOW PART     @D52VDKH 03814000
         LR    R0,R4              GET END ADDRESS              @D52VDKH 03815000
GTVSVAIS DS    0H                                              @D52VDKH 03816000
         OI    SYSFLAG4,ANCHSVA   INDICATE INITIALIZATION      @D51IDKH 03817000
         B     GETVISIR           CALL MAIN INIT.ROUTINE       @D37CDFG 03818000
************************************************************** @D369DJB 03819000
*   INITIALIZATION PART FOR PARTITION                        * @D369DJB 03820000
*        NOW TEST FOR FIRST REFERENCE OF GETVIS                         03821000
************************************************************** @D369DJB 03822000
GTVSINT3 EQU   *                                               @D51IDKH 03823000
         SR    RB,RB              CLEAR SHIFT MODIFIER         @D52VDKH 03824000
         LTR   RC,RC              CI SET                       @D64ADKH 03825000
         BNZ   GTVSLRES           YES                          @D64ADKH 03826000
         L     R3,DFWKCOMG        GET COMREG ADDRESS           @D52VDMZ 03827000
         USING COMREG,R3                                       @D367DJB 03828000
         L     RC,IJBGVCTL        NEC. FOR CDLOAD              @D64ADMZ 03829000
         TM    OPTNBYTE,ANCHTBIT  FIRST REQUEST                @D64ADMZ 03830000
         BO    GTVSLRES           NO                           @D64ADKH 03831000
************************************************************** @D149DJB 03832000
*        PARTITION END ADDRESS +1 IS CONTAINED IN STORAGE      @D35EDUL 03833000
*        MANAGEMENT CONTROL BLOCK (SMCB)                       @D35EDUL 03834000
*   LOAD R0 WITH END ADDRESS OF PARTITION                    * @D369DJB 03835000
************************************************************** @D369DJB 03836000
         L     R4,PCBPTR          GET CURRENT PCB              @D52VDMZ 03837000
         USING PCBADR,R4          PCB ADDRESSABILITY           @D365DJB 03838000
         L     R8,PCEPIB          GET PTR TO CURRENT PIB       @D51IDMZ 03839000
         USING PIBADR,R8          PIB ADDRESSABILITY           @D36IDJB 03840000
         TM    PIBDATFL,PIBTRAM   REAL REQUEST ?               @D51IDMZ 03841000
         DROP  R8                                              @D36IDJB 03842000
         BO    GTVSVIRT                                        @D35DDUL 03843000
         L     R0,SMRPEND         END ADDRESS OF REAL PARTITN  @D35CDUL 03844000
         B     GTVSREAL                                        @D35DDUL 03845000
GTVSVIRT EQU   *                                               @D35DDUL 03846000
         L     R0,SMVPEND         END ADDRESS OF VIRTUAL PART  @D35DDUL 03847000
         DROP  R4                 DROP PCB BASE                @D367DJB 03848000
GTVSREAL EQU   *                                               @D35DDUL 03849000
         BCTR  R0,R0              REDUCE BY 1                  @D35DDUL 03850000
************************************************************** @D369DJB 03851000
*   GET COMREG AND ANCHOR TABLE POINTER                      * @D369DJB 03852000
************************************************************** @D369DJB 03853000
         C     R3,CRADDR          PSEUDO PARTITION REQUEST?    @D14CDJB 03854000
         BE    NOETSS2            NO, SKIP                     @D14CDJB 03855000
         L     R5,SVER02          GET ETSS GETVIS PARMTER LIST @D35ZDUL 03856000
         L     R0,4(R5)           GET PSEUDO PARTITION HI ADR  @D35ZDUL 03857000
NOETSS2  EQU   *                                               @D35ZDUL 03858000
************************************************************** @D369DJB 03859000
*   TEST IF GETVIS AREA IS PROVIDED AND LOAD LENGTH OF       * @D369DJB 03860000
*   GETVIS AREA                                              * @D369DJB 03861000
************************************************************** @D369DJB 03862000
         L     RC,PPEND          GET START OF                  @D14CDJB 03863000
         A     RC,F1                        GETVIS AREA        @D14CDJB 03864000
         LR    R5,R0             GET END OF PARTITION          @D367DJB 03865000
         SR    R5,RC             GET AVAILABLE GETVIS AREA     @D367DJB 03866000
         BNP   GTVSVAIN          NO GETVIS AREA PROVIDED       @D52VDMZ 03867000
         L     R4,PAGESIZE       ASSUME THAT VISTAB IS 1 PAGE  @D14NDJB 03868000
         SR    R5,R4             GETVIS AREA MINUS VISTAB      @D367DJB 03869000
         LA    R5,1(,R5)         ONE MORE BYTE                 @D52VDKH 03870000
         BP    GTVSINT_GT        ===> SKIP IF NOT MINUS 1      @D14CDJB 03871000
         LA    RF,SMERR0C        SET AS NOT FOUND              @D14CDJB 03872000
         SLR   RC,RC                                           @D52VDKH 03873000
         BR    R7                ==> EXIT                      @D14CDJB 03874000
         SPACE 2                                               @D37CDFG 03875000
* CLOSE PARTITION GETVIS GATE                                           03876000
* (GATING NOT NECESSARY FOR PSEUDO PARTITION SINCE NO SUBTASKING)       03877000
* NORMALLY, TOGETHER WITH THE PARTITION GETVIS GATE, THE LOCAL LOCK     03878000
* IS OBTAINED IN OS390 EMULATION MODE. BUT AT THIS POINT IN TIME        03879000
* THE PCBMVSEM IS NOT YET SET. SO WE WORK ONLY WITH THE GETVIS GATE.    03880000
* THIS IS NO DANGER, SINCE AT THIS POINT IN TIME ONLY THE MAINTASK IS   03881000
* ACTIVE.                                                               03882000
GTVSINT_GT DS  0H                                              @DY45752 03883000
         C     R3,CRADDR          PSEUDO PARTITION REQUEST?    @D64ADMZ 03884000
         BNE   GETVISIR           YES, NO GATING NECESSARY     @D64ADMZ 03885000
         LR    R4,R5              SAVE AVAILABLE GETVIS AREA   @D64ADMZ 03886000
         LR    R1,RC              SAVE PTR TO CI               @D64ADMZ 03887000
         L     R5,PCBPTR                                       @D64ADMZ 03888000
         USING PCBADR,R5                                       @D64ADMZ 03889000
         LA    R5,SRQGTV          ADDR PART.GETVIS GATE        @D64ADMZ 03890000
         USING RQADR,R5                                        @D64ADMZ 03891000
GTVSINT_P0 DS  0H                                              @D64ADMZ 03892000
         TM    RSCDESC,FREEBIT    RESOURCE AVAILABLE           @D66ODOW 03893000
         BO    GTVSINT_P1         YES                          @D66ODOW 03894000
         BAL   RC,RWAIT           WAIT FOR RESOURCE            @D64ADMZ 03895000
*SGLINK  RWAIT,INPUT=(R5,RC)                                   @D64ADMZ 03896000
         B     GTVSINT_P0         TRY AGAIN                    @D64ADMZ 03897000
GTVSINT_P1 DS  0H                                              @D64ADMZ 03898000
         MVC   RSCDESC,TID        CLOSE GATE, IDENTIFY OWNER   @D66ODOW 03899000
         DROP  R5                 RELEASE RQADR                @D64ADMZ 03900000
         LR    R5,R4              RESTORE GETVIS AREA          @D64ADMZ 03901000
         LR    RC,R1              RESTORE PTR TO CI            @D64ADMZ 03902000
************************************************************** @D369DJB 03903000
* COMMON PART OF SYSTEM/PARTITION/SPACE GETVIS INITIALIZATION* @D149DJB 03904000
*                                                              @D379DFG 03905000
*        FIND OUT HOW MANY PAGES ARE NEEDED FOR THE VISTAB,    @D35EDUL 03906000
*        AND FIX THE PAGES IF THE REQUESTOR RUNS IN REAL MODE. @D35EDUL 03907000
*        R5 : GETVIS AREA MINUS ANCHOR TABLE AND VISTAB        @D369DJB 03908000
************************************************************** @D369DJB 03909000
GETVISIR DS    0H                                              @D14CDJB 03910000
         USING ANCHTAB,RC                                      @D52VDKH 03911000
         LR    R4,R5              SAVE AVAILABLE GETVIS AREA   @D14CDJB 03912000
         SRL   R5,LDVBYTB(RB)     VISTAB LNG IN BYTES          @D367DJB 03913000
         LA    R5,VISTAB-ANCHTAB(R5)  LENGTH OF ANCHOR         @D367DJB*03914000
                                           TABLE AND VISTAB    @D367DJB 03915000
         SRL   R4,PNSHIFT         GET NUMBER                   @D14NDJB 03916000
         SR    R1,R1                                           @D51IDMZ 03917000
         TM    SVER0F+D3,SVAIND   SVA INITIALIZATION           @D51IDMZ 03918000
         BZ    GTVSINT4           NO => NO OF SUBPOOLS CORRECT @D51IDMZ 03919000
         L     R1,IJBSMCOM        GET ADDR OF SMCOM            @DDCR360 03920000
         USING SMCOM,R1                                        @DDCR360 03921000
         LH    R1,SMCNODYN        GET NO OF DYN. PART. (>=0)   @DDCR360 03922000
         DROP  R1                 RELEASE SMCOM                @DDCR360 03923000
         SLL   R1,2               RESERVE 4 SUBP. PER DYN.PART.@D51IDMZ 03924000
         LA    R1,200(,R1)        ADD 1 SP/TASK FOR IEXT PROC. @DY45383 03925000
GTVSINT4 LA    R1,MAXSUBPL(,R1)   GET MAXIMUM # OF SUBPOOLS    @D51IDMZ 03926000
         CR    R1,R4              MORE PAGES THAN SUBPOOLS ?   @D14CDJB 03927000
         BNH   GTVSINT7           YES ===>                     @D51IDMZ 03928000
         LR    R1,R4              SAVE NUMBER OF PAGES         @D14CDJB 03929000
GTVSINT7 DS    0H                                              @D51IDMZ 03930000
         LA    R1,2(R1)                                        @D64ADKH 03931000
         LA    R9,SUBPINTL        SUBPOOL INDEX TABLE LENGTH   @D14CDJB 03932000
         MR    R8,R1              GET NUMBER OF BYTES USED     @D14CDJB 03933000
*                                 FOR THE SUBPOOL INDEX TABLE  @D149DJB 03934000
         AR    R5,R9              ADD TO ANCHOR TABLE          @D14CDJB 03935000
         SLL   R4,SUBPCHN2        GET NUMBER OF BYTES USED     @D14CDJB 03936000
*                                 FOR THE SUBPOOL CHAIN TABLE  @D149DJB 03937000
         AR    R5,R4              ADD TO ANCHOR TABLE          @D14CDJB 03938000
         LA    R5,D6(R5)          ADD ALIGNMENT FOR INDEX      @D14CDJB 03939000
*                                              AND CHAIN TABLE @D149DJB 03940000
         LTR   RB,RB              SVA OR SPACE OR PMR SPACE REQ@D52VDMZ 03941000
         BNZ   GVINTSVH           YES ===>                     @D14CDJB 03942000
************************************************************** @D149DJB 03943000
*   SET KEY FOR VISTAB PAGES                                 * @D149DJB 03944000
************************************************************** @D149DJB 03945000
         LR    RC,R0              GET END ADDRESS              @D14CDJB 03946000
         SR    RC,R5              MINUS LENGTH                 @D14CDJB 03947000
         LA    RC,1(,RC)          ADD ONE                      @D52VDKH 03948000
         SRL   RC,PNSHIFT         SET ADDRESS ON NEXT          @D14NDJB 03949000
         SLL   RC,PNSHIFT               LOWER PAGE BOUNDARY    @D14NDJB 03950000
         LR    R1,R0              GET END OF ANCHOR TABLE      @D14CDJB 03951000
         LR    R0,RC              GET START OF ANCHOR TABLE    @D14CDJB 03952000
         SR    R2,R2              KEY FOR ANCHOR TABLE         @D14CDJB 03953000
*SGLINK  GFSTKEYP,INPUT=(R0,R1,R2,R8:LINK,RA,RB,RC),OUTPUT=(RF),       *03954000
               NOMODR=(R3,R4,R6,R7,RA-RC,RD),AMODE=31                   03955000
         SGAMSUBR SUBROUT=GFSTKEYP,                            @D52VDMZ*03956000
               INPUT=(R0,R1,R2,RA,RB,RC),                      @D52VDMZ*03957000
               NOMOD=(R3,R4,R6,R7,RB,RC,RD),                   @D52VDMZ*03958000
               OUTPUT=(RF),                                    @D52VDMZ*03959000
               LINK=(R8),         SET STORAGE KEY TO ZERO      @D52VDMZ*03960000
               SUBROUC=GTVSINIT,                               @D52VDMZ*03961000
               CBASE=OWN                                       @D52VDMZ 03962000
         LR    R0,RC              GET START OF ANCHOR TABLE    @D14CDJB 03963000
         BCTR  R0,0               END OF PART. GETVIS AREA     @D14CDJB 03964000
         L     R5,PPEND           GET START OF PARTITION       @D14CDJB 03965000
         A     R5,F1                           GETVIS AREA     @D51IDMZ 03966000
         ST    RC,IJBGVCTL        SAVE START OF ANCHOR TABLE   @D14CDJB 03967000
         ST    R5,BVIRTMEM        BEGIN OF BELOW PART          @D52VDKH 03968000
         L     R5,ADDRMSK         R5 = 16MB -1                 @D52VDMZ 03969000
         CR    R0,R5              EVIRTMEM     <= 16MB-1       @D52VDMZ 03970000
         ST    R0,EVIRTMEM                                     @D52VDKH 03971000
         BNH   GTVSINT9           YES                          @D52VDMZ 03972000
         LA    R5,1(,R5)          END OF PART. >= 16MB         @D52VDMZ 03973000
         ST    R5,ABVRTMEM        ABVRTMEM = 16MB              @D52VDKH 03974000
         BCTR  R5,0                                            @D52VDKH 03975000
         ST    R5,EVIRTMEM                                     @D52VDKH 03976000
         ST    R0,AEVRTMEM                                     @D52VDKH 03977000
GTVSINT9 EQU   *                                               @D52VDKH 03978000
         C     R3,CRADDR          ICCF REQUEST ?               @D14CDJB 03979000
         BNE   GVINTHDR           YES ===>                     @D14NDJB 03980000
         L     R4,PCBPTR          GET CURRENT PCB              @D52VDMZ 03981000
         USING PCBADR,R4                                       @D14CDJB 03982000
         ST    RC,PCBAPEND        END OF ACTUAL PARTITION      @D14CDJB 03983000
         LA    R4,SRQGTV          ADDR GETVIS GATE             @D64ADMZ 03984000
         O     R4,BIT0OMSK        INDICATE 'OPEN GETVIS GATE'  @D64ADMZ 03985000
         ST    R4,GVFVGATE        SAVE GATE + INDICATION       @D64ADMZ 03986000
         B     GVINTHDR           ===> BUILD HEADER            @D14NDJB 03987000
         DROP  R3,R4                                           @D14CDJB 03988000
************************************************************** @D149DJB 03989000
*   BUILD REGISTER FOR SVA/SPACE/PMR SPACE VISTAB HEADER                03990000
************************************************************** @D149DJB 03991000
GVINTSVH EQU   *                                               @D14CDJB 03992000
         A     R5,PAGESIZE                                     @D52VDKH 03993000
         BCTR  R5,0                                            @D52VDKH 03994000
         SRL   R5,PNSHIFT         CONVERT BYTES INTO PAGES     @D14NDJB 03995000
         SLL   R5,PNSHIFT         CONV VISTAB PAGES INTO BYTES @D52VDKH 03996000
         TM    SVER0F+D2,GVIPL    IPL=YES SPECIFIED            @DDCR360 03997000
         BO    GTVSIPLR           STOP PROCESSING              @DDCR360 03998000
         ALR   R5,RC              GET START OF GETVIS AREA     @D52VDMZ 03999000
* IT IS GUARANTEED BY IPL, THAT THE CI FITS INTO SPACE                  04000000
         L     R4,AEVRTMEM        DO WE HAVE A PART ABOVE ..   @D52VDKH 04001000
         LTR   R4,R4              ..(CAN ONLY OCCUR FOR SVA)   @D52VDKH 04002000
         BNZ   GVINTABV           YES                          @D52VDKH 04003000
         ST    R5,BVIRTMEM        STORE START OF BELOW PART    @D52VDKH 04004000
         B     GVINTHDR                                        @D52VDKH 04005000
GVINTABV DS    0H                                              @D52VDKH 04006000
.* CHANGES HAVE TO BE DONE IN CASE THERE IS A SPACE AREA ABOVE          04007000
         BCTR  R5,0               R5 = LAST BYTE OF CI         @D52VDMZ 04008000
         L     R4,IJBSMCOM        ADDR SMCOM                   @D52VDMZ 04009000
         USING SMCOM,R4                                        @D52VDMZ 04010000
         CL    R5,SMCESG31        END OF CI EXCEEDS SGETVIS 31 @D52VDMZ 04011000
         BL    GVINTCIA           NO                           @D52VDMZ 04012000
         DROP  R4                 RELEASE SMCOM                @DDCR360 04013000
         BAL   R5,SYSERROR        YES,SYSTEM ERROR             @DDCR360 04014000
GVINTCIA DS    0H                                              @D52VDMZ 04015000
         LA    R5,1(,R5)          R5 = FIRST BYTE AFTER CI     @D52VDMZ 04016000
         ST    R5,ABVRTMEM        STORE START OF ABOVE PART    @D52VDKH 04017000
GVINTHDR EQU   *                                               @D14CDJB 04018000
************************************************************** @D149DJB 04019000
*   BUILD VISTAB HEADER                                      * @D149DJB 04020000
************************************************************** @D149DJB 04021000
         LA    R4,VISTAB          GET VISTAB BEGIN ADDR. AND   @D14CDJB 04022000
         ST    R4,BVISTAB         STORE IN VISTAB HEADER       @D14CDJB 04023000
*                                                              @D33GDGU 04024000
*        THE END OF VISTAB HAS TO BE COMPUTED FROM THE         @D33GDGU 04025000
*        AVAILABLE GETVIS AREA                                 @D33GDGU 04026000
*                                                              @D33GDGU 04027000
* THE FOLLOWING MUST BE DONE TWICE, FOR ABOVE AND BELOW                 04028000
*                                                              @D52VDKH 04029000
GVINTTWC EQU   *                                               @D52VDKH 04030000
         L     R5,EVIRTMEM        GET LAST BYTE OF PART        @D52VDKH 04031000
         S     R5,BVIRTMEM        GETVISAREA SIZE IN BYTES     @D367DJB 04032000
         LR    R1,R5              GET LENGTH OF GETVIS AREA    @D14CDJB 04033000
         SRL   R1,PNSHIFT         GET NUMBER                   @D14NDJB 04034000
         LA    R1,D1(R1)                  OF PAGES             @D14CDJB 04035000
         ST    R1,NBRGVPG         AND STORE IT                 @D52VDKH 04036000
         SR    R2,R2              ALL PARTITION GETVIS         @D14CDJB 04037000
         LR    R9,R1                        CAN BE ALLOCATED   @D149DJB 04038000
*                                                              @D33GDGU 04039000
*        VITAL AND EXCESSIVE REQUESTORS ARE ONLY CONSIDERED    @D51IDMZ 04040000
*        FOR SVA REQUESTS NOT FOR PARTITION AND SPACE          @D51IDMZ 04041000
*                                                              @D51IDMZ 04042000
         TM    SVER0F+D3,SVAIND   SVA REQUEST                  @D51IDMZ 04043000
         BZ    GVINHDRX           NO, TAKE ALL PAGES           @D51IDMZ 04044000
         TM    GVFVFLGS,GVFVABVE  ABOVE PART BEING INIT'LSD ?  @D52VDKH 04045000
         BO    GVINHDRX           YES, IGNORE VITAL & EXCESSIVE@D52VDKH 04046000
.*                                                             @D33GDGU 04047000
.* CALCULATE NUMBER OF PAGES THAT CAN NOT BE USED BY EXC. REQU.@D51IDMZ 04048000
.* R9 = MIN ((48K/4K),((ALL PAGES - VITAL PAGES)*2)/10)        @D51IDMZ 04049000
.*                                                             @D51IDMZ 04050000
         LA    R2,(&AGMINSG*1024+&AGPSIZB-1)/&AGPSIZB  MINIMUM @D14NDJB 04051000
*                                 PAGES FOR SAA MASTER DUMP    @D52VDMZ 04052000
         LA    RF,D10-&AGMAXEX    MINIMUM PERCENTAGE * 10 LEFT @D51IDMZ 04053000
         SR    R9,R2              R9= ALL PAGES - VITAL PAGES  @D14CDJB 04054000
         MR    R8,RF              #(PAGES) * PERCENTAGE FACTOR @D14CDJB 04055000
         LA    RF,D10             PREPARE FOR DIVIDE           @D14CDJB 04056000
         DR    R8,RF              #(PAGES) / 10                @D14CDJB 04057000
         LA    RF,(&AGMISGE*1024+&AGPSIZB-1)/&AGPSIZB  MINIMUM @D51IDMZ 04058000
*                                 ABSOL.VALUE LEFT BY EXC. REQ.@D51IDMZ 04059000
         CR    R9,RF              R9 = MIN(48K/4K AND 20% ..   @D51IDMZ 04060000
         BNH   GVINHDR1           .. OF ALL PAGES - VITAL ..   @D51IDMZ 04061000
         LR    R9,RF              .. PAGES                     @D51IDMZ 04062000
GVINHDR1 DS    0H                                              @D51IDMZ 04063000
         LR    RF,R1              CALCULATE R9 = HIGH ...      @D51IDMZ 04064000
         SR    RF,R2              ... WATER MARK ....          @D51IDMZ 04065000
         SR    RF,R9              ... FOR ...                  @D51IDMZ 04066000
         LR    R9,RF              .. EXCESSIVE REQUESTORS      @D51IDMZ 04067000
         SR    RF,RF              CLEAR RETURN CODE REGISTER   @D51IDMZ 04068000
GVINHDRX EQU   *                                               @D14CDJB 04069000
         SR    R1,R2              HIGH WATER MARK FOR          @D14CDJB 04070000
*                                         GENERAL REQUESTORS   @D149DJB 04071000
         ST    R9,GTVSEXCT        HIGH WATER MARK FOR          @D52VDKH 04072000
*                                        EXCESSIVE REQUESTORS  @D149DJB 04073000
         ST    R1,GTVSMXCT        STORE IT IN HEADER           @D52VDKH 04074000
         ST    RF,GTVSPGCT        RESET ACTUAL PAGE COUNT      @D52VDKH 04075000
         SRA   R5,LDVBYTB(RB)     GETVIS AREA SIZE IN NR.      @D367DJB 04076000
*                                 OF VISTAB BYTES              @D33GDGU 04077000
         AR    R5,R4              ADD VISTAB LNG.TO VSTB.ADDR  @D367DJB 04078000
         ST    R5,EVISTAB         AND STORE IN HEADER          @D367DJB 04079000
         TM    GVFVFLGS,GVFVABVE  ABOVE PART BEING INIT'LSD ?  @D52VDKH 04080000
         BO    GVINTNXT           YES, DONE                    @D52VDKH 04081000
         CLC   ABVRTMEM,EVIRTMEM  IS THERE A PART ABOVE ?      @D52VDKH 04082000
         BNH   GVINTNX1           NO, DONE                     @D52VDKH 04083000
         OI    GVFVFLGS,GVFVABVE  ABOVE PART BEING INIT'LSD    @D52VDKH 04084000
         MVC   DUPCILSV(2*MOVECIL),NBRGVPG   SWITCH FIELDS     @D52VDKH 04085000
         LA    R4,1(,R5)           BEGIN OF VISTAB FOR         @D52VDKH 04086000
         ST    R4,BVISTAB          ABOVE PART                  @D52VDKH 04087000
         B     GVINTTWC                                        @D52VDKH 04088000
GVINTNXT EQU   *                                               @D52VDKH 04089000
         MVC   ANBRGVPG(MOVECIL),NBRGVPG     SWITCH FIELDS     @D52VDKH 04090000
         MVC   NBRGVPG(MOVECIL),DUPCILSV     SWITCH FIELDS     @D52VDKH 04091000
         NI    GVFVFLGS,X'FF'-GVFVABVE    CONTINUE BELOW       @D52VDKH 04092000
GVINTNX1 EQU   *                                               @D52VDKH 04093000
         LA    R5,D3(R5)          SET ADDRESS OF               @D14CDJB 04094000
         SRL   R5,D2                   SUBPOOL INDEX TABLE     @D14CDJB 04095000
         SLL   R5,D2                      ON FULLWORD BOUNDARY @D14CDJB 04096000
         ST    R5,BSUBPIND        STORE IT IN ANCHOR TABLE     @D14CDJB 04097000
         L     R4,NBRGVPG         GET NUMBER OF PAGES          @D52VDKH 04098000
         A     R4,ANBRGVPG        SUM FOR ABOVE + BELOW        @D52VDKH 04099000
         BCTR  R4,0               MINUS ONE                    @D14CDJB 04100000
         SR    R2,R2                                           @D51IDMZ 04101000
         TM    SVER0F+D3,SVAIND   SVA INITIALIZATION           @D51IDMZ 04102000
         BZ    GVINHDR3           NO => NO OF SUBPOOLS CORRECT @D51IDMZ 04103000
         L     R2,IJBSMCOM        GET ADDR OF SMCOM            @DDCR360 04104000
         USING SMCOM,R2                                        @DDCR360 04105000
         LH    R2,SMCNODYN        GET NO OF DYN. PART. (>=0)   @DDCR360 04106000
         DROP  R2                 RELEASE SMCOM                @DDCR360 04107000
         SLL   R2,2               RESERVE 4 SUBP. PER DYN.PART.@D52VDMZ 04108000
         LA    R2,200(,R2)        ADD 1 SP/TASK FOR IEXT PROC. @DY45452 04109000
GVINHDR3 LA    R2,MAXSUBPL-1(,R2) GET MAXIMUM # OF SUBPOOLS -1 @D51IDMZ 04110000
         CR    R2,R4              MORE PAGES THAN SUBPOOLS ?   @D14CDJB 04111000
         BNH   GVINHDRA           YES ===>                     @D14CDJB 04112000
         LR    R2,R4              SAVE NUMBER OF PAGES - 1     @D14CDJB 04113000
GVINHDRA EQU   *                                               @D14CDJB 04114000
         STH   R2,MXSUBPLH        SAVE MAXIMUM NUMBER - 1      @D14CDJB 04115000
         LA    R2,SUBPINTL        GET LENGTH OF INDEX ENTRY    @D14CDJB 04116000
         MH    R2,MXSUBPLH        GET NUMBER OF BYTES USED     @D14CDJB 04117000
*                                 FOR THE SUBPOOL INDEX TABLE  @D149DJB 04118000
         LA    R2,SUBPINTL(R2)                                 @D64ADKH 04119000
         LA    R2,SUBPINTL(R2)                                 @D64ADKH 04120000
         AR    R5,R2              ADD IT                       @D14CDJB 04121000
         ST    R5,ESUBPIND        STORE IT IN ANCHOR TABLE     @D14CDJB 04122000
         S     R4,ANBRGVPG        SUBTRACT PAGES FROM ABOVE    @D52VDKH 04123000
         LA    R5,SUBPINTL(R5)    GOTO START OF CHAIN TABLE    @D14CDJB 04124000
         LA    R5,D3(R5)          SET ADDRESS OF               @D14CDJB 04125000
         SRL   R5,D2                   SUBPOOL CHAIN TABLE     @D14CDJB 04126000
         SLL   R5,D2                      ON FULLWORD BOUNDARY @D14CDJB 04127000
         ST    R5,BSUBPCHN        STORE IT IN ANCHOR TABLE     @D14CDJB 04128000
         ST    R5,GTVSHIGH        STORE IT IN ANCHOR TABLE     @D14CDJB 04129000
         ST    R5,CURPOINT        STORE IT IN ANCHOR TABLE     @D14CDJB 04130000
         ST    R5,FIRSTPNT        STORE IT IN ANCHOR TABLE     @D14CDJB 04131000
         SLL   R4,SUBPCHN2        GET NUMBER OF BYTES USED     @D14CDJB 04132000
*                                 FOR THE SUBPOOL CHAIN TABLE  @D149DJB 04133000
         AR    R5,R4              ADD IT                       @D14CDJB 04134000
         ST    R5,ESUBPCHN        STORE IT IN ANCHOR TABLE     @D14CDJB 04135000
         LA    R4,SUBPCHNL        AGTVSHI =                    @D52VDKH 04136000
         LNR   R4,R4              ABSUBCHN -                   @D52VDKH 04137000
         ST    R4,AGTVSHI         LENGTH(PAGE CHAIN ENTRY)     @D52VDKH 04138000
* DO SAME FOR ABOVE PART                                                04139000
         CLC   ABVRTMEM,EVIRTMEM  IS THERE A PART ABOVE ?      @D52VDKH 04140000
         BNH   GVINTNA1           NO, SKIP THIS                @D52VDKH 04141000
         ST    R5,AGTVSHI         STORE IT IN ANCHOR TABLE     @D52VDKH 04142000
         LA    R5,SUBPCHNL(,R5)   BEGIN OF PAGES ABOVE         @D52VDKH 04143000
         ST    R5,ABSUBCHN        STORE IT IN ANCHOR TABLE     @D52VDKH 04144000
         ST    R5,ACURPNT         STORE IT IN ANCHOR TABLE     @D52VDKH 04145000
         ST    R5,AFRSTPNT        STORE IT IN ANCHOR TABLE     @D52VDKH 04146000
         L     R4,ANBRGVPG        NUMBER OF PAGES ABOVE        @D52VDKH 04147000
         BCTR  R4,0               MINUS ONE                    @D52VDKH 04148000
         SLL   R4,SUBPCHN2        GET NUMBER OF BYTES USED     @D52VDKH 04149000
*                                 FOR THE SUBPOOL CHAIN TABLE  @D52VDKH 04150000
         AR    R5,R4              ADD IT                       @D52VDKH 04151000
         ST    R5,AESUBCHN        STORE IT IN ANCHOR TABLE     @D52VDKH 04152000
*                                                                       04153000
GVINTNA1 DS    0H                                              @D52VDKH 04154000
         LA    R5,SUBPCHNL-1(R5)  LAST SIGNIFICANT BYTE        @D14CDJB 04155000
         ST    R5,EGVCTLB         STORE IT IN ANCHOR TABLE     @D14CDJB 04156000
         SRL   R5,PNSHIFT         GET END OF                   @D14NDJB 04157000
         LA    R5,D1(R5)                GETVIS CONTROL         @D14NDJB 04158000
         SLL   R5,PNSHIFT                    INFORMATION + 1   @D14NDJB 04159000
         ST    R5,ENDGVCTL        STORE IT IN ANCHOR TABLE     @D14NDJB 04160000
         MVI   SVPFEND,X'FF'      MARK END OF (PFIX)PARMLIST   @D51IDKH 04161000
************************************************************** @D149DJB 04162000
*   INITIALIZE SUBPOOL CHAIN TABLE                           * @D149DJB 04163000
*   MUST BE DONE TWICE, BELOW AND ABOVE                                 04164000
************************************************************** @D149DJB 04165000
GVINTTW2 EQU   *                                               @D52VDKH 04166000
         L     R5,NBRGVPG         GET NUMBER OF ENTRIES        @D52VDKH 04167000
         L     R2,BSUBPCHN        GET START OF CHAIN TABLE     @D14CDJB 04168000
         LA    R1,SUBPCHNL        GET ENTRY LENGTH             @D14CDJB 04169000
         SR    R2,R1              POINT TO ONE ENTRY BEFORE    @D14CDJB 04170000
         SR    R4,R4              INIT. PAGE VISTAB PTR.       @D14CDJB 04171000
GVICHNLP EQU   *                                               @D14CDJB 04172000
         LR    R8,R2              SAVE BACKWARD POINTER        @D14CDJB 04173000
         LA    R2,SUBPCHNL(R2)    GOTO NEXT CHAIN TABLE ENTRY  @D14CDJB 04174000
         LA    R1,SUBPCHNL(R2)    INIT. CHAIN FORWARD POINTER  @D14CDJB 04175000
         USING SUBPCHN,R2                                      @D14CDJB 04176000
         ST    R1,SPCHFORW        STORE FORWARD POINTER        @D14CDJB 04177000
         ST    R8,SPCHBACK        STORE BACKWARD POINTER       @D14CDJB 04178000
         OI    SPCHFLAG,SPPGCONC  INDICATE PAGE CONCATENATION  @D14CDJB 04179000
         MVC   SPCHNMBR,XFFFF         SET 'SUBPOOL ID'         @D51IDMZ 04180000
         ST    R4,SPCHVSTB        STORE REL. VISTAB POINTER    @D51IDMZ 04181000
         LA    R4,PABYTPPG(R4)    INCREASE AS FOR PARTITION    @D14CDJB 04182000
         LTR   RB,RB              SVA OR SPACE INITIALIZATION ?@D51IDKH 04183000
         BZ    GVICHNA            NO  ===>                     @D14CDJB 04184000
         LA    R4,SVBYTPPG-PABYTPPG(R4)    ADD SVA DIFFERENCE  @D14CDJB 04185000
GVICHNA  EQU   *                                               @D14CDJB 04186000
         BCT   R5,GVICHNLP        REPEAT LOOP                  @D14CDJB 04187000
         L     R1,BSUBPCHN        FORWARD PTR TO FIRST PAGE    @D14CDJB 04188000
         ST    R1,SPCHFORW        STORE FORWARD PTR            @D14CDJB 04189000
         NI    SPCHFLAG,XFF-SPPGCONC   INDICATE PAGE NOT CONC. @D14CDJB 04190000
         DROP  R2                                              @D14CDJB 04191000
         USING SUBPCHN,R1                                      @D14CDJB 04192000
         ST    R2,SPCHBACK        STORE BACKWARD POINTER OF    @D14CDJB 04193000
         DROP  R1                                 FIRST PAGE   @D14CDJB 04194000
         TM    GVFVFLGS,GVFVABVE  PROCESSING FOR ABOVE ?       @D52VDKH 04195000
         BO    GVINTNX2           YES, DONE                    @D52VDKH 04196000
         CLC   ABVRTMEM,EVIRTMEM  IS THERE A PART ABOVE ?      @D52VDKH 04197000
         BNH   GVINTNX3           NO, DONE                     @D52VDKH 04198000
         OI    GVFVFLGS,GVFVABVE  ABOVE PART BEING INIT'LSD    @D52VDKH 04199000
         MVC   DUPCILSV(2*MOVECIL),NBRGVPG   SWITCH FIELDS     @D52VDKH 04200000
         B     GVINTTW2                                        @D52VDKH 04201000
GVINTNX2 EQU   *                                               @D52VDKH 04202000
         MVC   ANBRGVPG(MOVECIL),NBRGVPG     SWITCH FIELDS     @D52VDKH 04203000
         MVC   NBRGVPG(MOVECIL),DUPCILSV     SWITCH FIELDS     @D52VDKH 04204000
         NI    GVFVFLGS,X'FF'-GVFVABVE    CONTINUE BELOW       @D52VDKH 04205000
************************************************************** @D149DJB 04206000
*   INITIALIZE SUBPOOL INDEX TABLE AND RETURN                * @D149DJB 04207000
************************************************************** @D149DJB 04208000
GVINTNX3 EQU   *                                               @D52VDKH 04209000
         LH    R5,MXSUBPLH        GET NUMBER OF SUBPOOLS       @D14CDJB 04210000
         LA    R5,2(R5)                                        @D64ADKH 04211000
         SR    R8,R8              INITIALIZE SUBPOOL NUMBER    @D14CDJB 04212000
         LA    R4,D1              GET NEGATIVE                 @D14CDJB 04213000
         LNR   R4,R4                       VALUE               @D14CDJB 04214000
         L     R1,BSUBPIND        GET START OF INDEX TABLE     @D14CDJB 04215000
         USING SUBPINT,R1                                      @D14CDJB 04216000
         ST    R4,SPITCURP        CURRENT PTR FOR SUBPOOL 0    @D14CDJB 04217000
         ST    R4,SPITFRST        FIRST PAGE PTR FOR SUBPOOL 0 @D14CDJB 04218000
         ST    R4,ASPTCURP        CURRENT PTR FOR SUBPOOL 0    @D52VDKH 04219000
         ST    R4,ASPTFRST        FIRST PAGE PTR FOR SUBPOOL 0 @D52VDKH 04220000
         LA    R2,1                                            @D51IDKH 04221000
         LNR   R2,R2              'FFFF' INTO R2               @D51IDKH 04222000
         LTR   R5,R5              ONLY SUBPOOL 0 PRESENT ?     @D14CDJB 04223000
         BZ    GVIIDCON           YES ===>                     @D14CDJB 04224000
GVIIDTLP EQU   *                                               @D14CDJB 04225000
         LA    R8,D1(R8)          INCREMENT SUBPOOL NUMBER     @D14CDJB 04226000
         LA    R1,SUBPINTL(R1)    GOTO NEXT ENTRY              @D14CDJB 04227000
         ST    R4,SPITCURP        INITIALIZE CURRENT PTR       @D14CDJB 04228000
         ST    R4,SPITFRST        INITIALIZE FIRST PAGE PTR    @D14CDJB 04229000
         ST    R4,ASPTCURP        CURRENT PTR FOR SUBPOOL 0    @D52VDKH 04230000
         ST    R4,ASPTFRST        FIRST PAGE PTR FOR SUBPOOL 0 @D52VDKH 04231000
         STH   R8,SPITNMBR        INITIALIZE SUBPOOL NUMBER    @D51KDMZ 04232000
         STH   R2,SPITPIK         INITIALIZE SUBPOOL'S PIK     @D51IDKH 04233000
         BCT   R5,GVIIDTLP        REPEAT LOOP                  @D14CDJB 04234000
         MVC   GMFMSPNM(5),GVFV_IMVS                           @D64ADKH 04235000
         DROP  R1                                              @D14CDJB 04236000
GVIIDCON DS    0H                                              @D14CDJB 04237000
         TM    SVER0F+D3,SVAIND   IF REQUEST IS FOR SVA        @D52VDMZ 04238000
         BO    GTVINTP0           YES, SET VISTAB BITS         @D61NDMZ 04239000
         TM    SVER0F+D2,GVFVPMSP+GVFVSPIN IF SPACE OR PMRSPACE@D52VDMZ 04240000
         BNZ   GVRES300           .. REQ => FORCE LOC=BELOW    @D52VDMZ 04241000
************************************************************** @D149DJB 04242000
*   SET VISTAB BITS ON FOR VSAM ANCHOR INFORMATION           * @D149DJB 04243000
*   (PARTITION AND SVA)                                      * @D61NDMZ 04244000
************************************************************** @D149DJB 04245000
GTVINTP  DS    0H                 SET FOR PARTITION            @D52VDMZ 04246000
         MVI   VISTAB,GVVSAMIN    RESERVE FIRST 128 BYTES      @D14CDJB 04247000
*                                 FOR VSAM IN PARTITION        @D61NDMZ 04248000
         B     GTVINTP1                                        @D61NDMZ 04249000
GTVINTP0 DS    0H                 SET FOR SVA                  @D61NDMZ 04250000
         MVI   VISTAB,GVVSAMSI    RESERVE FIRST 128 BYTES      @D61NDMZ 04251000
*                                 FOR VSAM IN SVA              @D61NDMZ 04252000
GTVINTP1 DS    0H                                              @D52VDMZ 04253000
         L     R2,BSUBPCHN        GET START OF CHAIN TABLE     @D14CDJB 04254000
         USING SUBPCHN,R2                                      @D14CDJB 04255000
         NI    SPCHFLAG,XFF-SPPGCONC  RESET CONCATENATION FLAG @D14CDJB 04256000
         STH   RF,SPCHNMBR        SET SUBPOOL ID               @D51IDMZ 04257000
         L     R5,SPCHFORW        ENQUEUE FIRST PAGE           @D14CDJB 04258000
         ST    R2,SPCHFORW                   TO SUBPOOL 0      @D14CDJB 04259000
         ST    R2,SPCHBACK        THE SAME WITH BACKWARD PTR   @D14CDJB 04260000
         DROP  R2                                              @D14CDJB 04261000
         L     R1,BSUBPIND        GET START OF INDEX TABLE     @D14CDJB 04262000
         USING SUBPINT,R1                                      @D14CDJB 04263000
         ST    R2,SPITCURP        CURRENT PTR FOR SUBPOOL 0    @D14CDJB 04264000
         ST    R2,SPITFRST        FIRST PAGE PTR FOR SUBPOOL 0 @D14CDJB 04265000
         MVI   SPITBITO,GVVSAMIN  BIT MASK OF CURRENT POINTER  @D51XDMZ 04266000
*                                 ASSUME PARTITION             @D61NDMZ 04267000
         TM    SVER0F+D3,SVAIND   IS REQUEST FOR SVA           @D61NDMZ 04268000
         BZ    GTVINTP2           NO,PART.,SET UP CORRECT      @D61NDMZ 04269000
         MVI   SPITBITO,GVVSAMSI  BIT MASK OF CURRENT POINTER  @D61NDMZ 04270000
*                                 FOR SVA                      @D61NDMZ 04271000
GTVINTP2 DS    0H                                              @D52VDMZ 04272000
         DROP  R1                                              @D14CDJB 04273000
         CR    R5,R2              ONLY ONE PAGE PRESENT ?      @D14CDJB 04274000
         BNE   GVIVSAMM           NO  ===>                     @D14CDJB 04275000
         ST    R4,CURPOINT        INDICATE EMPTY QUEUE         @D14CDJB 04276000
         ST    R4,FIRSTPNT        INDICATE EMPTY QUEUE         @D14CDJB 04277000
         B     GVIVSAMO           ===> CONTINUE                @D14CDJB 04278000
GVIVSAMM EQU   *                                               @D14CDJB 04279000
         ST    R5,CURPOINT        STORE NEW CURRENT POINTER    @D14CDJB 04280000
         ST    R5,FIRSTPNT        STORE NEW FIRST PAGE PTR     @D14CDJB 04281000
         L     R2,ESUBPCHN        GET LAST CHAIN ENTRY         @D14CDJB 04282000
         USING SUBPCHN,R5                                      @D14CDJB 04283000
         ST    R2,SPCHBACK        DEQUEUE FIRST PAGE           @D14CDJB 04284000
         DROP  R5                                              @D14CDJB 04285000
         USING SUBPCHN,R2                                      @D14CDJB 04286000
         ST    R5,SPCHFORW        DEQUEUE FIRST PAGE           @D14CDJB 04287000
         DROP  R2                                              @D14CDJB 04288000
GVIVSAMO EQU   *                                               @D14CDJB 04289000
         LA    R2,D1              SET ACTUAL                   @D14CDJB 04290000
         ST    R2,GTVSPGCT                PAGE COUNT           @D52VDKH 04291000
         TM    SVER0F+D3,SVAIND   IS REQUEST FOR SVA           @D61NDMZ 04292000
         BO    GTVSHCIM           YES                          @D61NDMZ 04293000
         USING COMREG,R3                                       @D14CDJB 04294000
         OI    OPTNBYTE,ANCHTBIT SET INITIALZTN FLAG IN COMREG @D35DDUL 04295000
         DROP  R3                 DROP COMREG BASE             @D367DJB 04296000
         B     GTVSLRES           DO LOC=RES HANDLING          @D52VDKH 04297000
GTVSHCIM DS    0H                 HANDLE CI MOVED AND ANCHORBIT@D61NDMZ 04298000
* SET ANCHTBIT AND IJBGVCTL IN AR COMREG                                04299000
         L     R3,APCBATAB        GET POINTER TO PCB TABLE     @D61NDMZ 04300000
         L     R3,0(,R3)          FIRST ENTRY IS SYSPCB        @D61NDMZ 04301000
         USING PCBADR,R3          ADDRESS SYSPCB               @D61NDMZ 04302000
         L     R3,PCECOMRA        GET AR COMREG                @D61NDMZ 04303000
         USING COMREG,R3          ADDRESS COMREG               @D61NDMZ 04304000
         L     R5,BVIRTMEM        PPEND = BVIRTMEM (BEGIN OF.. @D61NDMZ 04305000
         BCTR  R5,0               VSAM CI ) - 1 ..             @D61NDMZ 04306000
         ST    R5,PPEND           .. USED BY VSAM              @D61NDMZ 04307000
         ST    RC,IJBGVCTL        PTR TO SYS GETVIS CI, USED ..@D61NDMZ 04308000
*                                 DURING CDLOAD PROCESSING     @D61NDMZ 04309000
         OI    OPTNBYTE,ANCHTBIT SET INITIALZTN FLAG IN COMREG @D61NDMZ 04310000
         DROP  R3                 RELEASE COMREG               @D61NDMZ 04311000
GTVSLRES DS    0H                                              @D52VDKH 04312000
         TM    SVER0F+D1,GVSTATSZ+GVSTATAL GETVIS STATUS COMM. @DY44311 04313000
         BZ    GVRES060            NO                          @DY44311 04314000
* NO OF PAGES * 8 + (L(SPITNAME) + L(SPITPIK) + 8 BYTES FOR BELOW AND   04315000
* ABOVE PAGE COUNT) PER SUBPOOL                                         04316000
         L     R1,NBRGVPG          NO OF PAGES                 @DY44311 04317000
         TM    GVFVFLGS,GVFVABVE   CI SWITCHED TO ABOVE        @DY44311 04318000
         BO    GVRES010            YES                         @DY44311 04319000
         A     R1,ANBRGVPG         NO OF PAGES IN ABOVE AREA   @DY44311 04320000
         B     GVRES020                                        @DY44311 04321000
GVRES010 DS    0H                                              @DY44311 04322000
         A     R1,BNBRGVPG         NO OF PAGES IN BELOW AREA   @DY44311 04323000
GVRES020 DS    0H                                              @DY44311 04324000
         SLL   R1,3                NO OF PAGES * 8             @DY44311 04325000
         LA    R5,L'SPITNAME+L'SPITPIK+8                       @DY44311 04326000
         MH    R5,MXSUBPLH         R5*(NO OF SUBPOOLS-1)       @DY44311 04327000
         LA    R5,L'SPITNAME+L'SPITPIK+8+4(,R5) ADD ONE ENTRY + END     04328000
*                                  INDICATOR                   @DY44311 04329000
         AR    R1,R5               TOTAL LENGTH                @DY44311 04330000
         SR    R5,R5               OTHERWISE IT'S COUNTED AGAIN@DY45752 04331000
         TM    SVER0F+D3,SVAIND    SVA REQUEST                 @D64ADMZ 04332000
         BO    GVRES025            YES                         @D64ADMZ 04333000
* MUST BE PARTITION. CALCULATE NO OF PARTITION RELATED MVS SUBPOOLS     04334000
         L     R3,APCBATAB        APCBATAB                     @D66ODOW 04335000
         L     R5,SVER00          GET PIK OF REQ. PARTITION    @D64ADMZ 04336000
         SRL   R5,2               PIK /4                       @D64ADMZ 04337000
         AR    R3,R5              OFFSET IN PCBATAB            @D66ODOW 04338000
         ICM   R3,15,0(R3)        GET PCB                      @D66ODOW 04339000
         USING PCBADR,R3                                       @D66ODOW 04340000
*                                                                       04341000
         SR    R5,R5              PAGE COUNT OF ROUTED SUBPOOLS@D66GGMZ 04342000
         SR    RF,RF              NO OF SPLES                  @D66ODOW 04343000
         SR    R0,R0              PREPARE FOR 'GET TASK WITH   @D66ODAP 04344000
***                               ...HIGHEST PRIORITY'                  04345000
         TM    PCEFLAG,PCEDYNP    DYN. PART.                   @D66GGMZ 04346000
         BO    GVTIDLP            YES, NO ROUTED SPACE REQU.   @DY45936 04347000
*                                 NO SYSTEM GETVIS GATE NEEDED @D66GGMZ 04348000
*  GATE SYSTEM GETVIS                                                   04349000
         ST    RC,TCBGVR12        SAVE PTR TO PART. CI         @DY45752 04350000
         OI    SVER0F+3,SVAIND    SET SVA INDICATION           @DY45752 04351000
         STM   R0,RF,SAVREGS      SAVE REGISTERS               @DY45752 04352000
         LA    R9,0               DETERMINE GATE               @DY45752 04353000
         LA    R5,0               INDICATE GETVIS/FREEVIS      @DY45752 04354000
*SGLINK  GVFVGATING,INPUT=(R5,R8:LINK,R9,RA,RD),OUTPUT=(R9,RC),        *04355000
               AMODE=31,NOMODR=(R6,RA,RD,RF)                            04356000
         SGAMSUBR SUBROUT=GVFVGATS,                            @DY45752*04357000
               INPUT=(R5,R9,RA,RD),                            @DY45752*04358000
               NOMOD=(R0,R1,R2,R3,R6,R7,RA,RD,RE,RF),          @DY45752*04359000
               OUTPUT=(R9,RC),                                 @DY45752*04360000
               LINK=(R8),                                      @DY45752*04361000
               SUBROUC=GTVSINIT,                               @DY45752*04362000
               CBASE=OWN                                       @DY45752 04363000
         LR    R9,RC              SAVE PTR TO SYS. GETVIS CI   @DY45752 04364000
         L     RC,TCBGVR12        GET PTR TO PART. CI          @DY45752 04365000
         ST    R9,SAVR2ND7        SAVE PTR TO SYS GETVIS CI    @DY45752 04366000
         LM    R0,RF,SAVREGS      RESTORE REGISTERS            @DY45752 04367000
         NI    SVER0F+3,X'FF'-SVAIND RESET,OTHERWISE GVSTAT    @DY45752 04368000
*                                 DOES NOT SHOW PARTITION      @DY45752 04369000
         OI    GVFVFLG2,GVSTOSVA  OPEN SGETV GATE AFTER GVSTAT @DY45752 04370000
         DROP  RA                 RELEASE TCB                  @DY45752 04371000
         L     R2,SCBPTR          GET SCB OF CURRENT SPACE     @DY45936 04372000
         ICM   R2,15,SCBSPL-SCBADR(R2)   SCBSPL PRESENT?       @DY45936 04373000
         BNZ   GVTIDLP_SPL        YES                          @DY45936 04374000
GVTIDLP  DS    0H                 PROCESS ALL TASKS            @D64ADMZ 04375000
         LR    R2,R0              COPY TIB POINTER IF ANY      @D66ODAP 04376000
*        DISPMAC FUNC=TIB,SFUNC=NEXTLOW,INP2=R3,INP1=R2,ERREXIT=GVTHW1  04377000
         DISPMAC FUNC=TIB,SFUNC=NEXTLOW,INP2=R3,INP1=R2,ERREXIT=GVTHW1 X04378000
                                                               @D66ODOW 04379000
         LTR   R0,R2              ALL TIB'S PROCESSED          @D66ODAP 04380000
         BZ    GVTIDLPE           YES, --->                    @D66ODOW 04381000
         USING TIBADR,R2                                       @D64ADMZ 04382000
         L     R2,TIBTCB          GET TCB POINTER              @D64ADMZ 04383000
         DROP  R2                 RELEASE TIB                  @D64ADMZ 04384000
         USING TCBADR,R2                                       @D64ADMZ 04385000
         ICM   R2,15,TCBSPL       GET FIRST SPLE               @D64ADMZ 04386000
         DROP  R2                 RELEASE TCB                  @D64ADMZ 04387000
         BZ    GVTIDLP            TASK DOES NOT OWN SUBPOOLS   @D66ODOW 04388000
         USING SPLE,R2            ADDR SPLE                    @D64ADMZ 04389000
GVTIDLP_SPL DS  0H                                             @D64ADMZ 04390000
         CLI   SPTYPE,X'03'       IS IT PARTITION STORAGE      @D64ADMZ 04391000
         BE    GVTIDLP_SPL2       YES                          @D64ADMZ 04392000
         CLI   SPTYPE,X'02'       IS IT SPACE STORAGE          @D64ADMZ 04393000
         BNE   GVTIDLP_SPL1       NO                           @D64ADMZ 04394000
         TM    PCEFLAG,PCEDYNP    FOR DYN. PART. NO ROUTING    @D64ADMZ 04395000
         BO    GVTIDLP_SPL1                                    @D64ADMZ 04396000
         LA    R4,SUBPINTBUF      ADDR SUBPINT                 @D66GGMZ 04397000
         USING SUBPINT,R4                                      @D66GGMZ 04398000
         A     R5,SPITPUSC        ADD NO OF PAGES              @D66GGMZ 04399000
         DROP  R4                                              @D66GGMZ 04400000
         DROP  R3                 RELEASE PCB                  @D66ODOW 04401000
GVTIDLP_SPL2 DS 0H                                             @D64ADMZ 04402000
         LA    RF,1(,RF)          ONE MORE SUBPOOL             @D66ODOW 04403000
GVTIDLP_SPL1 DS 0H                                             @D64ADMZ 04404000
         ICM   R2,15,PNEXTSPLE     DOES NEXT SPLE EXIST        @D64ADMZ 04405000
         BZ    GVTIDLP            NO, CHECK NEXT TASK          @D66ODOW 04406000
         B     GVTIDLP_SPL        CHECK NEXT SPLE              @D64ADMZ 04407000
         SPACE                                                          04408000
GVTHW1   DS    0H                                              @D66ODOW 04409000
         BAS   R5,SYSERROR                                     @D66ODOW 04410000
         SPACE                                                          04411000
GVTIDLPE DS    0H                                              @D66ODOW 04412000
         LR    R3,RF              NO OF SPLES INTO CORRECT REG @D66ODOW 04413000
         SR    RF,RF              CLEAR RETURN CODE            @D64ADMZ 04414000
         B     GVRES028           ALL TASKS PROCESSED          @D64ADMZ 04415000
GVRES025 DS    0H                  CALC. NO OF MVS SYS.SUBPOOLS@DY44311 04416000
         SR    R3,R3               NO OF MVS SYS SUBPOOLS      @DY44311 04417000
         L     R2,IJBSMCOM                                     @D64ADMZ 04418000
         USING SMCOM,R2                                        @D64ADMZ 04419000
         ICM   R2,15,SMCSYSPL      GET ADDR OF FIRST SPLE      @D64ADMZ 04420000
         BZ    GVRES028            NO MVS SYS.SUBPOOLS AVAIL.  @D64ADMZ 04421000
         DROP  R2                  RELEASE SMCOM               @D64ADMZ 04422000
         USING SPLE,R2             ADDR SPLE                   @D64ADMZ 04423000
GVRES026 DS    0H                                              @D64ADMZ 04424000
         LA    R3,1(,R3)           NO OF SPLES                 @D64ADMZ 04425000
         ICM   R2,15,PNEXTSPLE     DOES NEXT SPLE EXIST        @D64ADMZ 04426000
         BNZ   GVRES026            NO                          @D64ADMZ 04427000
         DROP  R2                  RELEASE SPLE                @D64ADMZ 04428000
GVRES028 DS    0H                                              @D64ADMZ 04429000
         ST    R3,NOMVSSPL         NO OF MVS SUBPOOLS          @D64ADMZ 04430000
         SLL   R5,3                NO OF PAGES * 8             @D66GGMZ 04431000
         AR    R1,R5               ADD IT TO TOTAL SIZE        @D66GGMZ 04432000
         LA    R5,L'SPITNAME+L'SPITPIK+8  LENGTH PER SUBPOOL   @D64ADMZ 04433000
         MR    R2,R5               * NO OF MVS SUBPOOLS (IN R3)@D64ADMZ 04434000
         AR    R1,R3               ADD IT TO TOTAL SIZE        @D64ADMZ 04435000
GVRES029 DS    0H                                              @D64ADMZ 04436000
         TM    SVER0F+D1,GVSTATAL  GETVIS STATUS=ALL           @DY44311 04437000
         BO    GVRES030            YES                         @DY44311 04438000
         ST    R1,SVER00           PASS SIZE TO  AR            @DY44311 04439000
         LA    RF,SMERR30          RC TO STOP PROCESSING       @DY44311 04440000
         BR    R7                  RETURN                      @DY44311 04441000
GVRES030 DS    0H                  CHECK IF LENGTH IS SUFFIC.  @DY44311 04442000
* BETWEEN STATUS=SIZE AND STATUS=ALL REQUEST THE PARTITION GETVIS AREA  04443000
* MIGHT HAVE BEEN REFORMATTED SO THAT THE LENGTH IS TOO SMALL.          04444000
         L     R5,SVER01           GET ADDR OF OUTPUT AREA     @DY44311 04445000
         C     R1,0(,R5)           FIRST WORD CONTAINS LENGTH  @DY44311 04446000
         BNH   GVRES035            SIZE STILL SUFFICIENT       @DY44311 04447000
         LA    RF,4                STATUS=ALL NOT POSSIBLE     @DY44311 04448000
         BR    R7                  RETURN                      @DY44311 04449000
GVRES035 DS    0H                  CHECK IF LENGTH IS SUFFIC.  @DY44311 04450000
         OI    SVER0F+D2,GVLOCBEL  FORCE LOC=BELOW             @DY44311 04451000
GVRES060 DS    0H                                              @DY44311 04452000
         MVC   ADDRSAV,SVER01      SAVE USER'S INPUT ADDR      @D52VDKH 04453000
**************************************************************          04454000
*   LOC = RES HANDLING                                       *          04455000
.* LOC = RES HANDLING FOR GETMAIN/FREEMAIN IS DONE IN IJBSSM2A.         04456000
.* THEREFORE EITHER LOC=ANY OR LOC=BELOW IS SET FOR GETMAIN/FREEMAIN    04457000
.* AND TCBIEXFL IS NOT SET/NEEDED.                                      04458000
**************************************************************          04459000
         TM    SVER0F+D2,GVLOCBEL LOC BELOW SET?               @D52VDMZ 04460000
         BO    GVRES100           YES, NO RES HANDLING         @D52VDMZ 04461000
         TM    SVER0F+D2,GVLOCANY LOC=ANY SET ?                @D52VDMZ 04462000
         BO    GVRES210           YES, NO RES HAND.,RESET POOL @D52VDMZ 04463000
         USING TCBADR,RA          ADDRESS CURRENT TCB          @D64ADMZ 04464000
         TM    TCBIEXFL,TCBIEXRM  CALLER IN RMODE 31 ?         @D52VDMZ 04465000
         BO    GVRES200           YES, SET LOC=ANY             @D52VDMZ 04466000
GVRES050 DS    0H                 FORCE LOC=BELOW              @D52VDMZ 04467000
         OI    SVER0F+D2,GVLOCBEL RMODE 24, SET LOC=BELOW      @D52VDMZ 04468000
GVRES100 DS    0H                  LOC=BELOW REQUEST           @D52VDMZ 04469000
         TM    GVFVFLGS,GVFVABVE   WAS LAST REQUEST FOR ABOVE? @D52VDKH 04470000
         BZR   R7                  NO, WAS FOR BELOW=> RETURN  @D52VDMZ 04471000
GVRES150 DS    0H                  LOC=BELOW REQUEST           @D52VDMZ 04472000
*  SWITCH FIELDS FOR PROCESSING BELOW                                   04473000
         MVC   ANBRGVPG(MOVECIL),NBRGVPG     SWITCH FIELDS     @D52VDKH 04474000
         MVC   NBRGVPG(MOVECIL),DUPCILSV     SWITCH FIELDS     @D52VDKH 04475000
         NI    GVFVFLGS,X'FF'-GVFVABVE    CONTINUE BELOW       @D52VDKH 04476000
         BR    R7                         EXIT                 @D52VDKH 04477000
GVRES200 DS    0H                  LOC=ANY REQUEST             @D52VDMZ 04478000
         OI    SVER0F+D2,GVLOCANY RMODE 31, SET LOC=ANY        @D52VDMZ 04479000
GVRES210 DS    0H                  LOC=ANY REQUEST             @D52VDMZ 04480000
         NI    SVER0F+D3,XFF-GVPOOL RESET POSSIBLE POOL IND.   @D52VDMZ 04481000
GVRES220 DS    0H                  LOC=ANY REQUEST             @D52VDMZ 04482000
         TM    GVFVFLGS,GVFVABVE   WAS LAST REQUEST FOR ABOVE? @D52VDKH 04483000
         BOR   R7                  YES => RETURN               @D52VDKH 04484000
         CLC   ABVRTMEM,EVIRTMEM   IS THERE A PART ABOVE ?     @D52VDKH 04485000
         BNH   GVRES310            NO, SET LOC FOR BELOW       @D52VDKH 04486000
* SWITCH FIELDS FOR PROCESSING ABOVE                                    04487000
         OI    GVFVFLGS,GVFVABVE   ABOVE PART BEING INIT'LSD   @D52VDKH 04488000
         MVC   DUPCILSV(2*MOVECIL),NBRGVPG  SWITCH FIELDS      @D52VDKH 04489000
         BR    R7                 ===> EXIT                    @D52VDKH 04490000
GVRES300 DS    0H                                              @D52VDMZ 04491000
         MVC   ADDRSAV,SVER01      SAVE USER'S INPUT ADDR      @D52VDKH 04492000
GVRES310 DS    0H                                              @D52VDMZ 04493000
         NI    SVER0F+D2,X'FF'-GVLOCANY                        @D52VDKH 04494000
         OI    SVER0F+D2,GVLOCBEL         FORCE LOC=BELOW      @D52VDKH 04495000
         BR    R7                 ===> EXIT                    @D52VDKH 04496000
GTVSVAIN DS    0H                                              @D14CDJB 04497000
         SLR   RC,RC              CLEAR POINTER TO CONTROL AREA@D52VDKH 04498000
GTVSVAIN_1 DS  0H                                              @D14CDJB 04499000
         LA    RF,SMERR04         GET RETURN CODE              @D14CDJB 04500000
         BR    R7                 ===> EXIT                    @D14CDJB 04501000
GTVSIPLR DS    0H                 IPL=YES REQUEST              @DDCR360 04502000
         ST    R5,SVER00          PASS SIZE OF CI TO IPL       @DDCR360 04503000
         LA    RF,SMERR30         RC TO STOP PROCESSING        @DDCR360 04504000
         SR    RC,RC              CLEAR RC TO BE CONSISTENT, RC=0, I.E.*04505000
                                  AREA DOES NOT EXIST          @DDCR360 04506000
         BR    R7                 RETURN TO GETVIS MAIN PATH   @DDCR360 04507000
         SPACE                                                          04508000
*SGLINK  GTVSINI3,S,INPUT=(R5,R7:LINK,RB,RC),                          *04509000
               WORK=(RB,RE),NOMODR=(R7),                               *04510000
               AMODE=31                                                 04511000
         SPACE                                                          04512000
GTVSSWSP DS    0H                                              @D52VDKH 04513000
*                                                                       04514000
* SWITCH SUBPOOL FIELDS                                                 04515000
*                                                                       04516000
         USING SUBPINT,R5                                      @D52VDKH 04517000
         TM    GVFVFLGS,GVFVABVE  CONTROL INFO SWITCHED TO ABVE@D52VDKH 04518000
         BZ    GTVSIEN1           NO, ==> BELOW PROCESSING     @D52VDKH 04519000
         TM    SPITFLG1,SPSWABVE  SUBPOOL SWITCHED TO ABVE ?   @D52VDKH 04520000
         BOR   R7                 YES, DONE                    @D52VDKH 04521000
         OI    SPITFLG1,SPSWABVE  INDICATE SWITCHING TO ABVE   @D52VDKH 04522000
         B     GTVSECOM           SWITCH                       @D52VDKH 04523000
GTVSIEN1 DS    0H                 CONTROL INFO SWITCHED TO ABVE@D52VDKH 04524000
         TM    SPITFLG1,SPSWABVE  SUBPOOL SWITCHED TO ABVE ?   @D52VDKH 04525000
         BZR   R7                 NO,, DONE                    @D52VDKH 04526000
         NI    SPITFLG1,X'FF'-SPSWABVE  INDICATE SWITCHING BEL @D52VDKH 04527000
GTVSECOM DS    0H                 SWITCH FIELDS                @D52VDKH 04528000
         MVC   DUPSBPSV(MOVESPTL),ASPTFRST                     @D52VDKH 04529000
         MVC   ASPTFRST(MOVESPTL),SPITFRST                     @D52VDKH 04530000
         MVC   SPITFRST(MOVESPTL),DUPSBPSV                     @D52VDKH 04531000
         BR    R7                  ALL DONE                    @D52VDKH 04532000
GTVSIENT DS    0H                                              @D52VDKH 04533000
.* NOTE, THAT CALLING PROGRAMS RELY ON RF NOT CHANGED DURING            04534000
.* CHANGE OF CI AND SUBPOOL SWITCH                                      04535000
         BCT   RB,GTVSSWSP        SWITCH SUBPOOL FIELDS        @D52VDKH 04536000
*SGLINK  GTVSINI2,S,INPUT=(R7:LINK,RB,RC,RD),                          *04537000
               WORK=(RB,RE),NOMODR=(R7),                               *04538000
               AMODE=31                                                 04539000
* SWITCH CONTROL INFO. ACCORDING TO LOC                        @D52VDMZ 04540000
         TM    SVER0F+D2,GVLOCBEL SWITCH FOR PROCESSING BELOW? @D52VDMZ 04541000
         BO    GVRES100           YES                          @D52VDMZ 04542000
         B     GVRES220           SWITCH FOR PROCESSING ABOVE  @D52VDMZ 04543000
         DROP  R5                                              @D52VDKH 04544000
FVSCHECK DS    0H                                              @D52VDKH 04545000
************************************************************** @D52VDMZ 04546000
*  FUNCTION : CHECK USER'S INPUT                             * @D52VDMZ 04547000
*             IF INPUT IS OK, SET-UP CONTROL INFO, SET LOC   * @D52VDMZ 04548000
*   INPUT  : RB, RC                                          * @D52VDMZ 04549000
*   OUTPUT : RF = 0                                          * @D52VDMZ 04550000
*            RF = 4 LENGTH IS ZERO                           * @D52VDMZ 04551000
*            RF > 4 ERROR                                    * @D52VDMZ 04552000
*            ADDRSAV = USER'S R1                             * @D52VDMZ 04553000
*            SPIDSAV = ADDRESS OF CURRENTLY ACTIVE SUBPOOL   * @D52VDMZ 04554000
*                      (ADDRESS POINTS TO SUBPOOL INDEX TAB.)* @D52VDMZ 04555000
*   WORK   : R0,R1,R4,R5,R9                                  * @D52VDMZ 04556000
*   LINK   : R8                                              * @D52VDMZ 04557000
*   NOMOD  : R7,RB,RC                                        * @D52VDMZ 04558000
************************************************************** @D52VDMZ 04559000
*SGLINK  FVSCHECK,S,INPUT=(R8:LINK,RB-RD),OUTPUT=(RF),                 *04560000
               WORK=(R0-R3,R4,R5,R9,RF),NOMODR=(R8),                   *04561000
               AMODE=31,MODSYM=(ADDRSAV,SPIDSAV),                      *04562000
               SUBROUT=(GVFVMIR1,FVSCSP,FVSSPIDC,FVSPX)                 04563000
         LA    RF,0               CLEAR RETURN CODE            @D52VDKH 04564000
         LM    R0,R1,SVER00       GET USER'S INPUT             @D52VDMZ 04565000
         ST    R1,ADDRSAV         SAVE USER'S INPUT            @D52VDMZ 04566000
         LA    R1,0(,R1)          TREAT FREEVIS ADDRESS AS..   @D52VDMZ 04567000
         ST    R1,SVER01          .. 31 BIT ADDRESS            @D52VDMZ 04568000
         LTR   R0,R0              CHECK LENGTH                 @D52VDMZ 04569000
         BM    FVSRET8            LENGTH IS NEGATIVE => ERROR  @D52VDMZ 04570000
         BZ    FVSRET4            LENGTH IS ZERO (ALLOWED)     @D52VDMZ 04571000
         LR    R5,R0                                           @D64ADKH 04572000
         BCTR  R5,0                                            @D64ADKH 04573000
         SRA   R5,LDVBYTBI(RB)                                 @D64ADKH 04574000
         LA    R5,1(R5)                                        @D64ADKH 04575000
         SLA   R5,LDVBYTBI(RB)                                 @D64ADKH 04576000
         LR    R0,R5                                           @D64ADKH 04577000
         BNO   FVSC0010                                        @D64ADKH 04578000
         L     R0,SVER00                                       @D64ADKH 04579000
         SRA   R0,LDVBYTBI(RB)                                 @D64ADKH 04580000
         SLA   R0,LDVBYTBI(RB)                                 @D64ADKH 04581000
         ST    R0,SVER00                                       @D64ADKH 04582000
FVSC0010 DS    0H                                              @D64ADKH 04583000
         SR    R5,R5              CLEAR WORK REGISTER          @D52VDMZ 04584000
         LR    R4,R1              IS START ADDRESS A ...       @D52VDMZ 04585000
         SRDA  R4,LDVBYTBI(RB)    .. MULTIPLE OF ....          @D52VDMZ 04586000
         LTR   R5,R5              ... VIRTUAL SIZE/BIT         @D52VDMZ 04587000
         BNZ   FVSRET0D           NO => ERROR                  @D64ADKH 04588000
         C     R1,BVIRTMEM        CHECK FOR VALID START ADDRESS@D52VDMZ 04589000
         BL    FVSC0100           NOT WITHIN SWITCH. AR.=>CONT.@D52VDMZ 04590000
         C     R1,EVIRTMEM        CHECK FOR VALID START ADDRESS@D52VDMZ 04591000
         BH    FVSC0600           NOT WITHIN SWITCH. AR.=>CONT.@D52VDMZ 04592000
         LR    R4,R0              GET LENGTH ..                @D52VDMZ 04593000
         BCTR  R4,0               .. MINUS ONE                 @D52VDMZ 04594000
         AR    R4,R1              R4 = END ADDRESS VALID?      @D52VDMZ 04595000
         BM    FVSRET10           NO, NEGATIVE                 @D52VDMZ 04596000
         CL    R4,EVIRTMEM        OUTSIDE SW. AREA OR NEGATIVE @D52VDMZ 04597000
         BH    FVSC0700           YES                          @D52VDMZ 04598000
*  BEGIN OF SW. AREA  <= R1 (BA)<=R4(EA)  <= END OF SWITCHED AREA       04599000
         TM    GVFVFLGS,GVFVABVE  AREA SWITCHED TO ABOVE       @D52VDMZ 04600000
         BZ    FVSC0050           NO                           @D52VDMZ 04601000
         OI    SVER0F+D2,GVLOCANY SET LOC ACCORDING TO CI      @D52VDMZ 04602000
         L     R1,SVER00          GET END ADDRESS OF AREA      @D52VDKH 04603000
*SGLINK  GVFVMIR1,INPUT=(R1,RB,RC,RD),OUTPUT=(R1),                     *04604000
               NOMODR=(R2,R3,R4,R5,R6,R7,R8,R9,RA,RB,RC,RD,RE),AMODE=31 04605000
         SGAMSUBR SUBROUT=GVFVMIR1,  MIRROR RETURNED ADDRESS   @D52VDKH*04606000
               INPUT=(R1,RB,RC,RD),                            @D52VDKH*04607000
               OUTPUT=(R1),                                    @D52VDKH*04608000
               NOMOD=(R2,R3,R4,R5,R6,R7,R8,R9,RA,RB,RC,RD,RE), @D52VDKH*04609000
               LINK=(INLINE)                                   @D52VDKH 04610000
         ST    R1,SVER01           USER'S ADDRESS              @D52VDKH 04611000
         B     FVSC0060                                        @D52VDMZ 04612000
FVSC0050 DS    0H                                              @D52VDMZ 04613000
         OI    SVER0F+D2,GVLOCBEL SET LOC ACCORDING TO CI      @D52VDMZ 04614000
FVSC0060 DS    0H                                              @D52VDMZ 04615000
*SGLINK  FVSCSP,INPUT=(R0,R1,R9:LINK,RC,RF),OUTPUT=(R0,RF),            *04616000
               WORK=(R1-R3,R5),NOMODR=(R9),                            *04617000
               AMODE=31                                                 04618000
         BAL   R9,FVSCSP          CHECK SUBPOOL, RET. FOR RF=0 @D52VDMZ 04619000
*SGLINK  FVSSPIDC,INPUT=(R9:LINK,RC),OUTPUT=(RF),                      *04620000
               WORK=(R0-R2,R4,R5),AMODE=31                              04621000
         BAL   R9,FVSSPIDC        CALCULATE SPIDSAV            @D52VDMZ 04622000
         B     FVSRET0            RETURN TO CALLER             @D52VDMZ 04623000
FVSC0100 DS    0H                                              @D52VDMZ 04624000
         TM    GVFVFLGS,GVFVABVE  START ADDR NOT VALID IF ..   @D52VDMZ 04625000
         BZ    FVSRET0C           .. AREA SWITCHED TO BELOW    @D52VDMZ 04626000
* AREA SWITCHED TO ABOVE (ONLY POSSIBLE FOR SVA AND PARTITION) @D52VDMZ 04627000
         C     R1,BBVRTMEM        START ADDR < BEGIN OF PART.  @D52VDMZ 04628000
         BL    FVSRET0C           ..GETV. OR SVA BELOW = ERROR @D52VDMZ 04629000
         LTR   RB,RB              SVA REQUEST                  @D52VDMZ 04630000
         BNZ   FVSC0500           YES                          @D52VDMZ 04631000
* R1 IN BELOW PART OF PARTITION                                @D52VDMZ 04632000
         LR    R4,R0              GET LENGTH ..                @D52VDMZ 04633000
         BCTR  R4,0               .. MINUS ONE                 @D52VDMZ 04634000
         AR    R4,R1              R4 = END ADDRESS VALID?      @D52VDMZ 04635000
         BM    FVSRET10           NO, NEGATIVE                 @D52VDMZ 04636000
         CL    R4,EVIRTMEM        OUTSIDE PART. GETV. OR NEG.? @D52VDMZ 04637000
         BH    FVSRET10           YES                          @D52VDMZ 04638000
         C     R4,BEVRTMEM        END ADDR IN BELOW PART ?     @D52VDMZ 04639000
         BH    FVSC0200           NO => BDY CROSSING           @D52VDMZ 04640000
         BAL   R9,FVSSWBEL        SWITCH FIELDS FOR PROC. BELOW@D52VDMZ 04641000
*SGLINK  FVSCSP,INPUT=(R0,R1,R9:LINK,RC,RF),OUTPUT=(R0,RF),            *04642000
               WORK=(R1-R3,R5),NOMODR=(R9),                            *04643000
               AMODE=31                                                 04644000
         BAL   R9,FVSCSP          CHECK SUBPOOL, RET. FOR RF=0 @D52VDMZ 04645000
*SGLINK  FVSSPIDC,INPUT=(R9:LINK,RC),OUTPUT=(RF),                      *04646000
               WORK=(R0-R2,R4,R5),NOMODR=(R9),                         *04647000
               AMODE=31                                                 04648000
         BAL   R9,FVSSPIDC        CALCULATE SPIDSAV            @D52VDMZ 04649000
         B     FVSRET0                                         @D52VDMZ 04650000
FVSC0200 DS    0H                                              @D52VDMZ 04651000
* AREA SWITCHED TO ABOVE, BDY CROSSING                                  04652000
         L     R1,BVIRTMEM        BEGIN OF PART. GETVIS ABOVE  @D52VDMZ 04653000
         SR    R4,R1              LENGHT OF ABOVE - 1          @D52VDMZ 04654000
         L     R1,EVIRTMEM                                     @D52VDMZ 04655000
         SR    R1,R4              BEGIN OF ABOVE CORR. TO CHAIN@D52VDMZ 04656000
         LA    R0,1(R4)           LENGTH OF ABOVE              @D52VDMZ 04657000
*SGLINK  FVSCSP,INPUT=(R0,R1,R9:LINK,RC,RF),OUTPUT=(R0,RF),            *04658000
               WORK=(R1-R3,R5),NOMODR=(R9),                            *04659000
               AMODE=31                                                 04660000
         BAL   R9,FVSCSP          CHECK SUBPOOL, RET. FOR RF=0 @D52VDMZ 04661000
         BAL   R9,FVSSWBEL        SWITCH FIELDS FOR PROC. BELOW@D52VDMZ 04662000
         L     R1,SVER01          GET START ADDRESS            @D52VDMZ 04663000
         L     R4,EVIRTMEM        GET LENGTH ...               @D52VDMZ 04664000
         SR    R4,R1              .. OF ..                     @D52VDMZ 04665000
         LA    R0,1(,R4)          ... BELOW PART               @D52VDMZ 04666000
*SGLINK  FVSCSP,INPUT=(R0,R1,R9:LINK,RC,RF),OUTPUT=(R0,RF),            *04667000
               WORK=(R1-R3,R5),NOMODR=(R9),                            *04668000
               AMODE=31                                                 04669000
         BAL   R9,FVSCSP          CHECK SUBPOOL, RET. FOR RF=0 @D52VDMZ 04670000
         NI    SVER0F+D2,X'FF'-GVLOCBEL                        @D64ADKH 04671000
         BAL   R9,FVSSWABV        SWITCH FIELDS FOR PROC. ABOVE@D52VDMZ 04672000
*SGLINK  FVSSPIDC,INPUT=(R9:LINK,RC),OUTPUT=(RF),                      *04673000
               WORK=(R0-R2,R4,R5),NOMODR=(R9),                         *04674000
               AMODE=31                                                 04675000
         BAL   R9,FVSSPIDC        CALCULATE SPIDSAV            @D52VDMZ 04676000
*SGLINK  FVSPX,INPUT=(R9:LINK,RB-RD),                                  *04677000
               WORK=(R0,R1),NOMODR=(R9),                               *04678000
               AMODE=31                                                 04679000
         BAL   R9,FVSPX           X-ING BDY, SPLIT REQUEST     @D52VDMZ 04680000
         B     FVSRET0            RETURN TO CALLER             @D52VDMZ 04681000
         SPACE 1                                                        04682000
FVSC0500 DS    0H                 SVA, AREA SWITCHED TO ABOVE  @D52VDMZ 04683000
*                                 R1 >= BEGIN OF BELOW SVA     @D52VDMZ 04684000
         C     R1,BEVRTMEM        R1 <= END OF BELOW SVA       @D52VDMZ 04685000
         BH    FVSRET0C           NO => ERROR                  @D52VDMZ 04686000
*  BEGIN OF BELOW SVA <= R1 <= END OF BELOW SVA                @D52VDMZ 04687000
         LR    R4,R0              GET LENGTH ..                @D52VDMZ 04688000
         BCTR  R4,0               .. MINUS ONE                 @D52VDMZ 04689000
         AR    R4,R1              R4=END ADDRESS VALID?        @D52VDMZ 04690000
         BM    FVSRET10           NO, NEGATIVE                 @D52VDMZ 04691000
         CL    R4,BEVRTMEM        END ADDR IN BELOW PART ?     @D52VDMZ 04692000
         BH    FVSRET10           NO => ERROR                  @D52VDMZ 04693000
*  BEGIN OF BELOW SVA <= R1<=END ADDR <= END OF BELOW SVA      @D52VDMZ 04694000
         BAL   R9,FVSSWBEL        SWITCH FIELDS FOR PROC. BELOW@D52VDMZ 04695000
*SGLINK  FVSCSP,INPUT=(R0,R1,R9:LINK,RC,RF),OUTPUT=(R0,RF),            *04696000
               WORK=(R1-R3,R5),NOMODR=(R9),                            *04697000
               AMODE=31                                                 04698000
         BAL   R9,FVSCSP          CHECK SUBPOOL, RET. FOR RF=0 @D52VDMZ 04699000
*SGLINK  FVSSPIDC,INPUT=(R9:LINK,RC),OUTPUT=(RF),                      *04700000
               WORK=(R0-R2,R4,R5),NOMODR=(R9),                         *04701000
               AMODE=31                                                 04702000
         BAL   R9,FVSSPIDC        CALCULATE SPIDSAV            @D52VDMZ 04703000
         B     FVSRET0            RETURN TO CALLER             @D52VDMZ 04704000
         SPACE 1                                                        04705000
FVSC0600 DS    0H                 R1 > EVIRTMEM                @D52VDMZ 04706000
         TM    GVFVFLGS,GVFVABVE  START ADDR NOT VALID IF ..   @D52VDMZ 04707000
         BO    FVSRET0C           .. AREA SWITCHED TO ABOVE    @D52VDMZ 04708000
         CLC   ABVRTMEM,EVIRTMEM  DOES ABOVE PART EXIST ?      @D52VDMZ 04709000
         BNH   FVSRET0C           NO, INVALID START ADDRESS    @D52VDMZ 04710000
         C     R1,ABVRTMEM        START ADDR IN ABOVE PART     @D52VDMZ 04711000
         BL    FVSRET0C           NO, INVALID START ADDRESS    @D52VDMZ 04712000
         C     R1,AEVRTMEM        START ADDR IN ABOVE PART     @D52VDMZ 04713000
         BH    FVSRET0C           NO, INVALID START ADDRESS    @D52VDMZ 04714000
* BEGIN ABOVE <= R1 <= END ABOVE, AREA SWITCHED BELOW          @D52VDMZ 04715000
         LR    R4,R0              LENGTH MINUS..               @D52VDMZ 04716000
         BCTR  R4,0               .. ONE                       @D52VDMZ 04717000
         AR    R4,R1              R4 = END ADDRESS             @D52VDMZ 04718000
         BM    FVSRET10           NO, NEGATIVE                 @D52VDMZ 04719000
         CL    R4,AEVRTMEM        END ADDR IN ABOVE PART ?     @D52VDMZ 04720000
         BH    FVSRET10           NO => ERROR                  @D52VDMZ 04721000
* BEGIN ABOVE <= R1<=END ADDR <= END ABOVE, AREA SWITCHED BELOW         04722000
         BAL   R9,FVSSWABV        SWITCH FIELDS FOR PROC. ABOVE@D52VDMZ 04723000
         L     R1,SVER00                                       @D52VDKH 04724000
*SGLINK  GVFVMIR1,INPUT=(R1,RB,RC,RD),OUTPUT=(R1),                     *04725000
               NOMODR=(R2,R3,R4,R5,R6,R7,R8,R9,RA,RB,RC,RD,RE),AMODE=31 04726000
         SGAMSUBR SUBROUT=GVFVMIR1,  MIRROR USER'S ADDRESS     @D52VDKH*04727000
               INPUT=(R1,RB,RC,RD),                            @D52VDKH*04728000
               OUTPUT=(R1),                                    @D52VDKH*04729000
               NOMOD=(R2,R3,R4,R5,R6,R7,R8,R9,RA,RB,RC,RD,RE), @D52VDKH*04730000
               LINK=(INLINE)                                   @D52VDKH 04731000
         ST    R1,SVER01           USER'S ADDRESS              @D52VDKH 04732000
*SGLINK  FVSCSP,INPUT=(R0,R1,R9:LINK,RC,RF),OUTPUT=(R0,RF),            *04733000
               WORK=(R1-R3,R5),NOMODR=(R9),                            *04734000
               AMODE=31                                                 04735000
         BAL   R9,FVSCSP          CHECK SUBPOOL, RET. FOR RF=0 @D52VDMZ 04736000
*SGLINK  FVSSPIDC,INPUT=(R9:LINK,RC),OUTPUT=(RF),                      *04737000
               WORK=(R0-R2,R4,R5),NOMODR=(R9),                         *04738000
               AMODE=31                                                 04739000
         BAL   R9,FVSSPIDC        CALCULATE SPIDSAV            @D52VDMZ 04740000
         B     FVSRET0                                         @D52VDMZ 04741000
         SPACE 1                                                        04742000
FVSC0700 DS    0H                                              @D52VDMZ 04743000
* BVIRTMEM <= R1 <= EVIRTMEM < R4 (END ADDRESS)                @D52VDMZ 04744000
         LTR   RB,RB              BDY CROSSING ONLY POSSIBLE.. @D52VDMZ 04745000
         BNZ   FVSRET10           ... FOR PARTITION            @D52VDMZ 04746000
         TM    GVFVFLGS,GVFVABVE  END ADDR NOT VALID IF ..     @D52VDMZ 04747000
         BO    FVSRET10           .. AREA SWITCHED TO ABOVE    @D52VDMZ 04748000
         CL    R4,AEVRTMEM        END ADDR OUTSIDE ABOVE PART. OR NEG. *04749000
                                  OR ABOVE PART DOES NOT EXIST @D52VDMZ 04750000
         BH    FVSRET10           .. AREA SWITCHED TO ABOVE    @D52VDMZ 04751000
* AREA SWITCHED TO BELOW, BEGIN IN BELOW, END IN ABOVE         @D52VDMZ 04752000
         L     R4,EVIRTMEM        CALCULATE LENGTH..           @D52VDMZ 04753000
         SR    R4,R1              .. OF BELOW ..               @D52VDMZ 04754000
         LA    R0,1(,R4)          .... REQUEST                 @D52VDMZ 04755000
*SGLINK  FVSCSP,INPUT=(R0,R1,R9:LINK,RC,RF),OUTPUT=(R0,RF),            *04756000
               WORK=(R1-R3,R5),NOMODR=(R9),                            *04757000
               AMODE=31                                                 04758000
         BAL   R9,FVSCSP          CHECK SUBPOOL, RET. FOR RF=0 @D52VDMZ 04759000
         BAL   R9,FVSSWABV        SWITCH FIELDS FOR PROC. ABOVE@D52VDMZ 04760000
         L     R1,EVIRTMEM        START OF ABOVE REQUEST       @D52VDMZ 04761000
         L     R4,SVER00                                       @D52VDMZ 04762000
         SR    R4,R0                                           @D52VDMZ 04763000
         LR    R0,R4              R0 = LENGTH OF ABOVE REQUEST @D52VDMZ 04764000
         SR    R1,R0              BEGIN OF ABOVE AREA ....     @D52VDMZ 04765000
         LA    R1,1(,R1)          .. CORRESPONDING TO SP CHAIN @D52VDMZ 04766000
*SGLINK  FVSCSP,INPUT=(R0,R1,R9:LINK,RC,RF),OUTPUT=(R0,RF),            *04767000
               WORK=(R1-R3,R5),NOMODR=(R9),                            *04768000
               AMODE=31                                                 04769000
         BAL   R9,FVSCSP          CHECK SUBPOOL, RET. FOR RF=0 @D52VDMZ 04770000
*SGLINK  FVSSPIDC,INPUT=(R9:LINK,RC),OUTPUT=(RF),                      *04771000
               WORK=(R0-R2,R4,R5),NOMODR=(R9),                         *04772000
               AMODE=31                                                 04773000
         BAL   R9,FVSSPIDC        CALCULATE SPIDSAV            @D52VDMZ 04774000
*SGLINK  FVSPX,INPUT=(R9:LINK,RB-RD),                                  *04775000
               WORK=(R0,R1),NOMODR=(R9),                               *04776000
               AMODE=31                                                 04777000
         BAL   R9,FVSPX           X-ING BDY, SPLIT REQUEST     @D52VDMZ 04778000
         B     FVSRET0                                         @D52VDMZ 04779000
         SPACE 1                                                        04780000
FVSRET0D DS    0H                                              @D64ADKH 04781000
         CLI   GMFMRQST,X'00'                                  @D64ADKH 04782000
         BE    FVSRET0C                                        @D64ADKH 04783000
         LA    RF,1                                            @D64ADKH 04784000
         B     FVSRET0C                                        @D64ADKH 04785000
FVSRET10 LA    RF,4(,RF)          END ADDR NOT VALID           @D52VDMZ 04786000
FVSRET0C LA    RF,4(,RF)          START ADDR NOT VALID         @D52VDMZ 04787000
FVSRET8  LA    RF,4(,RF)          LENGTH IS NEGATIVE           @D52VDMZ 04788000
FVSRET4  LA    RF,4(,RF)          LENGTH IS ZERO               @D52VDMZ 04789000
FVSRET0  DS    0H                                              @D52VDMZ 04790000
         LA    R1,0                                            @D64ADKH 04791000
         STH   R1,SPIDSAVH                                     @D64ADKH 04792000
         BR    R8                 RETURN TO CALLER             @D52VDMZ 04793000
GVFV_IMVS DC   C'IMVS-'                                        @D64ADKH 04794000
**************************************************************          04795000
*  CHECK IF LENGTH IS WITHIN ONE SUBPOOL                     *          04796000
*   INPUT : R0 = LENGTH TO CHECK                             *          04797000
*           R1 = START ADDRESS OF AREA TO BE CHECKED         *          04798000
*           RF = 0                                           *          04799000
*   OUTPUT: RF = 0 , SPIDSAVH                                *          04800000
*           R0 = LENGTH (INPUT NOT MODIFIED)                 *          04801000
*           RF = 16 ERROR (NO RETURN TO CALLER)              *          04802000
*   LINK    R9                                               *          04803000
*   WORK    R1,R2,R3,R5                                      *          04804000
**************************************************************          04805000
FVSCSP   DS    0H                                              @D52VDMZ 04806000
*SGLINK  FVSCSP,S,INPUT=(R0,R1,R9:LINK,RC,RF),OUTPUT=(R0,RF),          *04807000
               WORK=(R1-R3,R5),NOMODR=(R9),                            *04808000
               AMODE=31                                                 04809000
         LR    R2,R0              GET LENGTH                   @D14CDJB 04810000
         BCTR  R2,0               MINUS ONE                    @D14CDJB 04811000
         S     R1,BVIRTMEM        GET RELATIVE START ADDRESS   @D14CDJB 04812000
         AR    R2,R1              GET RELATIVE END ADDRESS     @D14CDJB 04813000
         SRL   R2,PNSHIFT         GET RELATIVE PAGE NUMBER     @D14NDJB 04814000
         SLL   R2,SUBPCHN2        GET RELATIVE END CHAIN ENTRY @D14CDJB 04815000
         A     R2,BSUBPCHN        GET END CHAIN ENTRY ADDRESS  @D14CDJB 04816000
         SRL   R1,PNSHIFT         GET RELATIVE START PAGE #    @D14NDJB 04817000
         SLL   R1,SUBPCHN2        GET RELATIVE CHAIN ENTRY     @D14CDJB 04818000
         A     R1,BSUBPCHN        GET 1ST CHAIN ENTRY ADDRESS  @D14CDJB 04819000
         USING SUBPCHN,R1                                      @D14CDJB 04820000
         CLC   SPCHNMBR,XFFFF     FREEVIS : POOL OF EMPTY PGS? @D51IDMZ 04821000
         BE    FVSCSPER           YES ===> ERROR EXIT          @D52VDMZ 04822000
FVSCSPID DS    0H                                              @D52VDMZ 04823000
         CR    R1,R2              LAST PAGE CHECKED ?          @D14CDJB 04824000
         BE    FVSCSP0            YES, CHECK FOR BDY CROSSING  @D52VDMZ 04825000
         CLC   SPCHNMBR,SPCHNMBR+SUBPCHNL      DO ID'S MATCH ? @D51IDMZ 04826000
         BNE   FVSCSPER           YES ===> ERROR EXIT          @D52VDMZ 04827000
         L     R1,SPCHFORW        GOTO NEXT CHAIN PTR          @D14CDJB 04828000
         B     FVSCSPID           ===> REPEAT CHECK            @D52VDMZ 04829000
*********************************************************               04830000
*        SAME SUBPOOL ?                                                 04831000
*********************************************************               04832000
FVSCSP0  DS    0H                                              @D52VDMZ 04833000
         LH    R3,SPCHNMBR        GET SUBPOOL NUMBER           @D52VDMZ 04834000
         LH    R5,SPIDSAVH        IF BOUNDARY IS NOT BEING..   @D52VDMZ 04835000
         LTR   R5,R5              CROSSED BOTH SUBREQUESTS..   @D52VDKH 04836000
         BZ    FVSCSP1            MUST ADDRESS SAME SUBPOOL    @D52VDKH 04837000
         CR    R5,R3              SAME SUBPOOL ?               @D52VDMZ 04838000
         BNE   FVSCSPER           NO  ===> ERROR EXIT          @D52VDMZ 04839000
FVSCSP1  DS    0H                                              @D52VDMZ 04840000
         STH   R3,SPIDSAVH        SAVE SUBPOOL NUMBER          @D52VDKH 04841000
         BR    R9                 RETURN TO MAIN PATH          @D52VDMZ 04842000
         SPACE 1                                                        04843000
FVSCSPER DS    0H                                              @D52VDMZ 04844000
         ST    RF,SPIDSAV         CLEAR FOR LATER USE          @D52VDMZ 04845000
         B     FVSRET10           GIVE RETURN CODE             @D52VDMZ 04846000
         DROP  R1                 RELEASE SUBPOOL CHAIN        @D52VDMZ 04847000
         SPACE 1                                                        04848000
*********************************************************               04849000
*  SWITCH FIELDS FOR PROCESSING BELOW                                   04850000
*********************************************************               04851000
FVSSWBEL DS    0H                                              @D52VDMZ 04852000
         MVC   ANBRGVPG(MOVECIL),NBRGVPG     SWITCH FIELDS     @D52VDKH 04853000
         MVC   NBRGVPG(MOVECIL),DUPCILSV     SWITCH FIELDS     @D52VDKH 04854000
         NI    GVFVFLGS,X'FF'-GVFVABVE    CONTINUE BELOW       @D52VDKH 04855000
         OI    SVER0F+D2,GVLOCBEL         FORCE LOC=BELOW      @D52VDKH 04856000
         BR    R9                                              @D52VDMZ 04857000
*********************************************************               04858000
*  SWITCH FIELDS FOR PROCESSING ABOVE                                   04859000
*********************************************************               04860000
FVSSWABV DS    0H                                              @D52VDMZ 04861000
         OI    GVFVFLGS,GVFVABVE  ABOVE PART BEING INIT'LSD    @D52VDMZ 04862000
         MVC   DUPCILSV(2*MOVECIL),NBRGVPG   SWITCH FIELDS     @D52VDMZ 04863000
         OI    SVER0F+D2,GVLOCANY         FORCE LOC=ANY        @D52VDKH 04864000
         BR    R9                                              @D52VDMZ 04865000
******************************************************************      04866000
*  CALCULATE ADDRESS OF SUBPOOL NAME IN SUBPOOL INDEX TABLE (ABS)       04867000
******************************************************************      04868000
FVSSPIDC DS    0H                                              @D52VDMZ 04869000
*SGLINK  FVSSPIDC,S,INPUT=(R9:LINK,RC),OUTPUT=(RF),                    *04870000
               WORK=(R0-R2,R4,R5),NOMODR=(R9),                         *04871000
               AMODE=31,MODSYM=(SPIDSAV),                              *04872000
               SUBROUT=(GMFM_ACTIV:IGN(R8,RE))                          04873000
         CLI   GMFMRQST,X'00'                                  @D64ADKH 04874000
         BNE   FM_ACTIVATE                                     @D64ADKH 04875000
         LH    R2,SPIDSAVH                                     @D64ADKH 04876000
         CLM   R2,3,MXSUBPLH                                   @D64ADKH 04877000
         BH    FVSRET10                                        @D64ADKH 04878000
         LA    R2,SUBPINTL        R2 = BEGIN OF SUBPOOL INDEX  @D52VDMZ 04879000
         MH    R2,SPIDSAVH             TABLE + LENGTH OF AN    @D52VDMZ 04880000
         A     R2,BSUBPIND             ENTRY * SUBPOOL NUMBER  @D52VDMZ 04881000
         ST    R2,SPIDSAV                                      @D52VDMZ 04882000
         BR    R9                                              @D52VDMZ 04883000
FM_ACTIVATE  DS  0H                                            @D64ADKH 04884000
         LR    R0,R8                                           @D64ADKH 04885000
         LR    R1,R7                                           @D64ADKH 04886000
*SGLINK  GMFM_ACTIV,INPUT=(R8:LINK,RC),OUTPUT=(R5,RF),         @D64ADKH*04887000
               AMODE=31,NOMODR=(R0,R1,R4,R6,RA-RD)                      04888000
         SGAMSUBR SUBROUT=GMFMACTV,                            @D64ADKH*04889000
               INPUT=(RC),                                     @D64ADKH*04890000
               OUTPUT=(R5,RF),                                 @D64ADKH*04891000
               NOMOD=(R0,R1,R6,RA,RB,RC,RD),                   @D64ADKH*04892000
               LINK=(R8),                                      @D64ADKH*04893000
               SUBROUC=GTVSINIT,                               @D64ADKH*04894000
               CBASE=OWN                                       @D64ADKH 04895000
         LR    R8,R0                                           @D64ADKH 04896000
         LR    R7,R1                                           @D64ADKH 04897000
         LTR   RF,RF                                           @D64ADKH 04898000
         BNZ   FVSP_HW                                         @D64ADKH 04899000
         USING SUBPINT,R5                                      @D64ADKH 04900000
         CLC   SPIDSAVH,SPITNMBR                               @D64ADKH 04901000
         DROP  R5                                              @D64ADKH 04902000
         BNE   FVSRET10                                        @D64ADKH 04903000
         BR    R9                                              @D64ADKH 04904000
FVSP_HW  DS    0H                                              @D64ADKH 04905000
         BAL   R5,SYSERROR                                     @D64ADKH 04906000
         SPACE 1                                               @D52VDMZ 04907000
******************************************************************      04908000
*  FREEVIS REQUEST IS CROSSING BDY, SPLIT UP REQUEST                    04909000
******************************************************************      04910000
FVSPX    DS    0H                                              @D52VDMZ 04911000
*SGLINK  FVSPX,S,INPUT=(R9:LINK,RB-RD),                                *04912000
               WORK=(R0,R1),NOMODR=(R9),SUBROUT=(GVFVMIR1),            *04913000
               AMODE=31,MODSYM=(LGTHSAV,SVER00,SVER01)                  04914000
*                                                              @D52VDKH 04915000
* AREA IS CROSSING BOUNDARY, SPLIT UP REQUEST                  @D52VDKH 04916000
*                                                              @D52VDKH 04917000
         L     R1,SVER00                                       @D52VDKH 04918000
         ST    R1,LGTHSAV         SAVE TOTAL LENGTH OF REQUEST @D52VDKH 04919000
         BCTR  R1,0                                            @D52VDKH 04920000
         A     R1,SVER01                                       @D52VDKH 04921000
         MVC   SVER01,BVIRTMEM    ADDRESS FOR 1ST SUBREQUEST   @D52VDKH 04922000
         S     R1,BVIRTMEM        LENGTH FOR 1ST SUBREQUEST    @D52VDKH 04923000
         LA    R1,1(,R1)                                       @D52VDKH 04924000
         LR    R0,R1                                           @D52VDKH 04925000
*SGLINK  GVFVMIR1,INPUT=(R1,RB,RC,RD),OUTPUT=(R1),                     *04926000
               NOMODR=(R2,R3,R4,R5,R6,R7,R8,R9,RA,RB,RC,RD,RE),AMODE=31 04927000
         SGAMSUBR SUBROUT=GVFVMIR1,  MIRROR RETURNED ADDRESS   @D52VDKH*04928000
               INPUT=(R1,RB,RC,RD),                            @D52VDKH*04929000
               OUTPUT=(R1),                                    @D52VDKH*04930000
               NOMOD=(R2,R3,R4,R5,R6,R7,R8,R9,RA,RB,RC,RD,RE), @D52VDKH*04931000
               LINK=(INLINE)                                   @D52VDKH 04932000
         ST    R1,SVER01           MIRRORED ADDRESS AND        @D52VDKH 04933000
         ST    R0,SVER00           LENGTH FOR SUBREQUEST       @D52VDKH 04934000
         BR    R9                  EXIT                        @D52VDKH 04935000
*                                                                       04936000
FVSNGOOD DS    0H                                              @D52VDKH 04937000
*                                                                       04938000
*  USER'S REGISTERS 1 AND/OR 2 CONTAIN INVALID INPUT FOR FREEVIS        04939000
*                                                                       04940000
         LA    R5,4                                            @D52VDKH 04941000
         CR    RF,R5              RC = 4 (LENGTH ZERO)         @D52VDKH 04942000
         BNER  R7                 NO, TERMINATE REQUEST        @D52VDKH 04943000
         LA    RF,0               USER SPECIFIED SIZE=0        @D52VDKH 04944000
         BR    R7                 OK, RETURN                   @D52VDKH 04945000
         DROP  RC,RD                                           @D14CDJB 04946000
         DROP  RA                 RELEASE TCB                  @D52VDMZ 04947000
         DROP  RE                 RELEASE BASE                 @D51IDMZ 04948000
         EJECT                                                 @D14CDJB 04949000
***************************************************************@D149DJB 04950000
*                                                              @D149DJB 04951000
*   ROUTINE TO FREE TOTAL SUBPOOL .                            @D149DJB 04952000
*                                                              @D149DJB 04953000
*   MODULE FVSBPOOL                                            @D149DJB 04954000
*       RESET SUBPOOL INDEX TABLE OFFSET IN USER AREA          @D149DJB 04955000
*       DO UNTIL SPECIFIED SUBPOOL IS EMPTY                    @D149DJB 04956000
*         PREPARE INPUT FOR STVSTBPG                           @D149DJB 04957000
*         EXECUTE STVSTBPG                                     @D149DJB 04958000
*         PREPARE INPUT FOR GFENQDEQ                           @D149DJB 04959000
*         EXECUTE GFENQDEQ                                     @D149DJB 04960000
*         EXECUTE FVPGMR                                       @D149DJB 04961000
*       END                                                    @D149DJB 04962000
*       RESET SUBPOOL NAME FIELD IN SUBPOOL ID TABLE           @D149DJB 04963000
*   ENDMODULE FVSBPOOL                                         @D149DJB 04964000
*                                                              @D149DJB 04965000
*     CALLED BY : FREEVIS                                      @D149DJB 04966000
*     CALLS     : STVSTBPG GFENQDEQ FVPGMR                     @D149DJB 04967000
*                                                              @D149DJB 04968000
*     INPUT  : R1 --> USER AREA WITH SUBPOOL ID                @D149DJB 04969000
*                     (FREEVIS SUBPOOL)                        @D64ADMZ 04970000
*            : R1 = 0                                          @D64ADMZ 04971000
*              (CALLED DURING UPDATE PROCESSING TO INIT        @D64ADMZ 04972000
*               MVS SUBPOOL ENTRY IN SUBPOOL INDEX TABLE)      @D64ADMZ 04973000
*              R5 --> SUBPOOL INDEX TABLE ENTRY                @D149DJB 04974000
*              RB  :  SHIFT MODIFIER FOR SVA REQUEST           @D149DJB 04975000
*              RC --> ANCHOR TABLE                             @D149DJB 04976000
*              RD --> USER SAVE AREA                                    04977000
*              RF  :  0                                        @D149DJB 04978000
*     OUTPUT : NONE                                            @D149DJB 04979000
*     LINK   : R7                                              @D149DJB 04980000
*     WORK   : R2,R3,R4,R8,R9,RF                               @D149DJB 04981000
*             :R0,R1 (IN CALLED ROUTINES)                      @D52VDMZ 04982000
*                                                              @D149DJB 04983000
         AGO    .CREATEK                                       @D14ZDJB 04984000
.FVSBPOL ANOP                                                  @D14ZDJB 04985000
.*             0123456789ABCDEF                                @D149DJB 04986000
&INPREG  SETC '0100010000111111'                               @D14ZDJB 04987000
&OUTREG  SETC '0000000000000000'                               @D14ZDJB 04988000
&WRKREG  SETC '1111100011000001'                               @D52VDMZ 04989000
&NMDREG  SETC '0000011100111110'                               @D52VDMZ 04990000
&LINKR   SETC 'R7'                                             @D14ZDJB 04991000
&TBASE   SETC 'OWN'                                            @D64ADMZ 04992000
.*EXCLSYMS=(SAVREG0,SAVREG1)                                   @D52VDMZ 04993000
         AGO    .TESTALL                                       @D14ZDJB 04994000
.CREATEK ANOP                                                  @D14ZDJB 04995000
***************************************************************@D149DJB 04996000
         SPACE 2                                               @D14CDJB 04997000
         USING FVSBPOOL,RE                                     @D64ADMZ 04998000
         USING ANCHTAB,RC                                      @D14CDJB 04999000
         USING SUBPINT,R5                                      @D14CDJB 05000000
         USING SVEARA,RD                                       @D52VDKH 05001000
FVSBPOOL DS    0H                                              @D14CDJB 05002000
*SGLINK  FVSBPOOL,S,INPUT=(R1,R5,R7:LINK,RA,RB,RC,RD,RE,RF),           *05003000
               WORK=(R0-R3,R4,R8,R9,RE,RF),AMODE=31,                   *05004000
               MODSYM=(SAVREG0,SAVREG1),OUTPUT=(RF),                   *05005000
               SUBROUT=(GTVSINI2:IGN(R7,RB),GTVSINI3:IGN(R7,RB),       *05006000
               FVPGMR,STVSTBPG,GFENQDEQ)                                05007000
         LTR   R1,R1              FREEVIS SUBPOOL              @D64ADKH 05008000
         BZ    FVSBDONE_1         NO, UPDATE MVS SUBPOOL ENTRY @DY45525 05009000
         STH   RF,D6(,R1)         CLEAR USER OFFSET FIELD      @D14CDJB 05010000
         LR    R3,R7              SAVE LINK REGISTER           @D52VDKH 05011000
         LR    R2,RB              SAVE REGISTER                @D52VDKH 05012000
         LA    RB,3               SWITCH SUBPOOL               @D52VDKH 05013000
*SGLINK  GTVSINI3,INPUT=(R5,R7:LINK,RB,RC),                            *05014000
               NOMODR=(R2,R3,R5,R6,RA,RC,RD,RF),AMODE=31                05015000
         SGAMSUBR SUBROUT=GTVSINI3,                            @D52VDMZ*05016000
               INPUT=(R5,RB,RC,RE),                            @D52VDMZ*05017000
               NOMOD=(R2,R3,R5,R6,RA,RC,RD),                   @D52VDMZ*05018000
               IGN=(RB,RE),                                    @D52VDMZ*05019000
               LINK=(R7),                                      @D14CDJB*05020000
               CBASE=OWN,         INITIALIZE GETVIS AREA       @D64ADMZ*05021000
               SUBROUC=FVSBPOOL                                @D64ADMZ 05022000
         LR    RB,R2              RESTORE REGISTER             @D52VDKH 05023000
         LR    R7,R3              RESTORE LINK REGISTER        @D52VDKH 05024000
***************************************************************@D149DJB 05025000
*   FREE WHOLE SUBPOOL                                         @D149DJB 05026000
***************************************************************@D149DJB 05027000
FVSBLOOP EQU   *                                               @D14CDJB 05028000
         LA    R2,FIRSTPNT-(SPITFRST-SUBPINT)  DUMMY IND. ENTRY@D14CDJB 05029000
         L     R3,SPITFRST        GET PTR TO FIRST PAGE        @D14CDJB 05030000
         LTR   R3,R3              HAS SUBPOOL AT LEAST 1 PAGE? @D14CDJB 05031000
         BM    FVSBRESP           NO  ===>                     @D14CDJB 05032000
         LR    R9,R3              GET PTR IN CHAIN TABLE       @D14CDJB 05033000
FVSBLPA  EQU   *                                               @D14CDJB 05034000
*SGLINK  STVSTBPG,INPUT=(R8:LINK,R9,RB,RC,RF),                         *05035000
               NOMODR=(R2,R3,R5,R6,R7,R9,RA-RC,RD,RF),AMODE=31          05036000
         SGAMSUBR SUBROUT=STVSTBPG,                            @D14CDJB*05037000
               INPUT=(R9,RB,RC,RF),                            @D14CDJB*05038000
               NOMOD=(R2,R3,R5,R6,R7,R9,RA,RB,RC,RD),          @D14CDJB*05039000
               LINK=(R8),         CLEAR VISTAB OF THIS PAGE    @D14CDJB*05040000
               CBASE=OWN,         INITIALIZE GETVIS AREA       @D64ADMZ*05041000
               SUBROUC=FVSBPOOL                                @D64ADMZ 05042000
         USING SUBPCHN,R9                                      @D14CDJB 05043000
         TM    SPCHFLAG,SPPGCONC  NEXT PAGE CONTIGUOUS ?       @D14CDJB 05044000
         BNO   FVSBLPB            NO  ===>                     @D14CDJB 05045000
         L     R9,SPCHFORW        GO TO NEXT PAGE              @D14CDJB 05046000
         B     FVSBLPA            SCAN SUBPOOL                 @D14CDJB 05047000
         DROP  R9                                              @D14CDJB 05048000
FVSBLPB  DS    0H                                              @D14CDJB 05049000
         LR    R4,R9              GET END OF CHAIN             @D14CDJB 05050000
         SR    R4,R3              MINUS START                  @D14CDJB 05051000
         SRL   R4,SUBPCHN2        NUMBER OF PAGES              @D14CDJB 05052000
         LA    R4,D1(R4)                       TO DEQUEUE      @D14CDJB 05053000
*SGLINK  GFENQDEQ,INPUT=(R2,R3,R4,R5,R8:LINK,R9,RC),OUTPUT=(RF),       *05054000
               NOMODR=(R3,R5,R6,R7,R9,RA,RB,RC,RD),AMODE=31             05055000
         SGAMSUBR SUBROUT=GFENQDEQ,                            @D14CDJB*05056000
               INPUT=(R2,R3,R4,R5,R9,RC),                      @D14CDJB*05057000
               OUTPUT=(RF),                                    @D51XDMZ*05058000
               NOMOD=(R3,R5,R6,R7,R9,RA,RB,RC,RD),             @D14CDJB*05059000
               LINK=(R8),         ENQUEUE AND DEQUEUE PAGE(S)  @D14CDJB*05060000
               CBASE=OWN,         INITIALIZE GETVIS AREA       @D64ADMZ*05061000
               SUBROUC=FVSBPOOL                                @D64ADMZ 05062000
*SGLINK  FVPGMR,INPUT=(R3,R4:LINK,R5,R9,RA,RB,RC,RD),OUTPUT=(RF),      *05063000
               NOMODR=(R5,R6,R7,RA-RC,RD),AMODE=31                      05064000
         SGAMSUBR SUBROUT=FVPGMR,                              @D14CDJB*05065000
               INPUT=(R3,R5,R9,RA,RB,RC,RD),                   @D14NDJB*05066000
               NOMOD=(R5,R6,R7,RB,RC,RD),                      @D14CDJB*05067000
               OUTPUT=(RF),                                    @D52VDMZ*05068000
               LINK=(R4),         PFREE PAGE(S) IF NECCESSARY  @D14CDJB*05069000
               CBASE=OWN,         INITIALIZE GETVIS AREA       @D64ADMZ*05070000
               SUBROUC=FVSBPOOL                                @D64ADMZ 05071000
         B     FVSBLOOP           ===> REPEAT DEQUEUE          @D14CDJB 05072000
FVSBRESP DS    0H                                              @D14CDJB 05073000
*                                                                       05074000
* SEE THAT BOTH PARTS ARE FREED                                         05075000
*                                                                       05076000
         TM    SPITFLG1,SPBTHPRT      BOTH PARTS PROCESSED ?   @D52VDKH 05077000
         BO    FVSBDONE               YES, DONE                @D52VDKH 05078000
         OI    SPITFLG1,SPBTHPRT      INDICATE 2ND PART IN PROC@D52VDKH 05079000
         TM    SVER0F+2,GVLOCANY      1ST PART WAS ABOVE ?     @D52VDKH 05080000
         BZ    FVSBABVE               NO, WAS BELOW            @D52VDKH 05081000
         OI    SVER0F+2,GVLOCBEL      PROCESS BELOW NOW        @D52VDKH 05082000
         NI    SVER0F+2,X'FF'-GVLOCANY                         @D52VDKH 05083000
         ST    RB,SAVREG0                                      @D52VDKH 05084000
         ST    R7,SAVREG1                                      @D52VDKH 05085000
*                                                                       05086000
*  SWITCH CONTROL INFO FIELDS TO BELOW                                  05087000
*                                                                       05088000
         LA    RB,2                                            @D52VDKH 05089000
*SGLINK  GTVSINI2,INPUT=(R7:LINK,RB,RC,RD),                            *05090000
               NOMODR=(R5,R6,RA,RC,RD,RF),AMODE=31,                    *05091000
               NOMODS=(SAVREG0,SAVREG1)                                 05092000
         SGAMSUBR SUBROUT=GTVSINI2,                            @D14CDJB*05093000
               INPUT=(RB,RC,RD,RE),                            @D52VDMZ*05094000
               NOMOD=(R5,R6,RA,RC,RD),                         @D52VDMZ*05095000
               IGN=(RB,RE),                                    @D52VDMZ*05096000
               LINK=(R7),                                      @D14CDJB*05097000
               NOMODS=(SAVREG0,SAVREG1),                       @D52VDMZ*05098000
               CBASE=OWN,         INITIALIZE GETVIS AREA       @D64ADMZ*05099000
               SUBROUC=FVSBPOOL                                @D64ADMZ 05100000
* SWITCH SUBPOOL TOO                                                    05101000
FVSBSPSW DS    0H                                              @D52VDKH 05102000
         LA    RB,3                                            @D52VDKH 05103000
*SGLINK  GTVSINI3,INPUT=(R5,R7:LINK,RB,RC),                            *05104000
               NOMODR=(R5,R6,RA,RC,RD,RF),AMODE=31,                    *05105000
               NOMODS=(SAVREG0,SAVREG1)                                 05106000
         SGAMSUBR SUBROUT=GTVSINI3,                            @D14CDJB*05107000
               INPUT=(R5,RB,RC,RE),                            @D52VDMZ*05108000
               NOMOD=(R5,R6,RA,RC,RD),                         @D52VDMZ*05109000
               IGN=(RB,RE),                                    @D52VDMZ*05110000
               LINK=(R7),                                      @D14CDJB*05111000
               CBASE=OWN,         INITIALIZE GETVIS AREA       @D64ADMZ*05112000
               SUBROUC=FVSBPOOL                                @D64ADMZ 05113000
         L     RB,SAVREG0                                      @D52VDKH 05114000
         L     R7,SAVREG1                                      @D52VDKH 05115000
         B     FVSBLOOP            REPEAT FOR BELOW PART       @D52VDKH 05116000
FVSBABVE DS    0H                                              @D52VDKH 05117000
         OI    SVER0F+2,GVLOCANY      PROCESS ABOVE NOW        @D52VDKH 05118000
         NI    SVER0F+2,X'FF'-GVLOCBEL                         @D52VDKH 05119000
         ST    RB,SAVREG0                                      @D52VDKH 05120000
         ST    R7,SAVREG1                                      @D52VDKH 05121000
         LA    RB,2                                            @D52VDKH 05122000
*SGLINK  GTVSINI2,INPUT=(R7:LINK,RB,RC,RD),                            *05123000
               NOMODR=(R5,R6,RA,RC,RD,RF),AMODE=31,                    *05124000
               NOMODS=(SAVREG0,SAVREG1)                                 05125000
         SGAMSUBR SUBROUT=GTVSINI2,                            @D52VDMZ*05126000
               INPUT=(RB,RC,RD,RE),                            @D52VDMZ*05127000
               NOMOD=(R5,R6,RA,RC,RD),                         @D52VDMZ*05128000
               IGN=(RB,RE),                                    @D52VDMZ*05129000
               LINK=(R7),                                      @D14CDJB*05130000
               NOMODS=(SAVREG0,SAVREG1),                       @D52VDMZ*05131000
               CBASE=OWN,         INITIALIZE GETVIS AREA       @D64ADMZ*05132000
               SUBROUC=FVSBPOOL                                @D64ADMZ 05133000
         TM    SVER0F+2,GVLOCBEL  IS THERE A PART ABOVE ?      @D52VDKH 05134000
         BZ    FVSBSPSW           YES, PROCESS IT              @D52VDKH 05135000
         L     RB,SAVREG0                                      @D52VDKH 05136000
         L     R7,SAVREG1                                      @D52VDKH 05137000
FVSBDONE DS    0H                                              @D52VDKH 05138000
         NI    SPITFLG1,XFF-SPBTHPRT  RESET                    @DY45525 05139000
FVSBDONE_1 DS  0H                                              @DY45525 05140000
         LA    R2,SUBPINTL        R2 POINTS TO LAST ..         @D64ADKH 05141000
         MH    R2,MXSUBPLH        .. ENTRY IN SUBPOOL INDEX..  @D64ADKH 05142000
         LA    R2,SUBPINTL*2(R2)  .. TABLE. THIS ENTRY IS USED @D64ADMZ 05143000
         A     R2,BSUBPIND        .. FOR INITIALIZATION        @D64ADKH 05144000
***************************************************************@D149DJB 05145000
*    REMOVE SPID FROM SUBPOOL INDEX TABLE                      @D149DJB 05146000
*     SPITNMBR IS NEVER CLEARED, SPITNAME ONLY FOR GETVIS REQ. @D64ADMZ 05147000
***************************************************************@D149DJB 05148000
.*    SPITKEY AND SPITFLAG MUST NOT BE CLEARED FOR MVS SUBPOOLS@DY45525 05149000
.*    REASON: THE SPLES ARE NOT FREED WITH SUBPOOL RELEASE.    @DY45525 05150000
.*    IF SPITKEY AND SPITFLAG ARE CLEARED THE SPLE ELEMENT DOES@DY45525 05151000
.*    NOT SHOW THE KEY OF A SUBPOOL ANY LONGER.                @DY45525 05152000
***************************************************************@D149DJB 05153000
         CLI   GMFMRQST,X'00'     GETVIS REQUEST               @DY45525 05154000
         BE    FVINIT_GET         YES                          @DY45525 05155000
         MVC   SPITPIK(SUBPVARL3),SPITPIK-SUBPINT(R2)          @DY45525 05156000
         BR    R7              .. REQ, SINCE DUMMY NAME        @DY45525 05157000
* CLEAR SPITNAME FOR VSE SUBPOOL, SPITKEY INITIALIZED WITH NEXT REQ.    05158000
         MVC   SPITNAME(SUBPVARL1),SPITNAME-SUBPINT(R2)        @D64ADKH 05159000
         BR    R7                                              @DY45525 05160000
FVINIT_GET DS  0H              INIT GETVIS SUBPOOL ENTRY       @DY45525 05161000
* CLEAR ENTRY EXCEPT SPITNMBR. ALL OTHER FIELDS INIT. WITH NEXT REQUEST 05162000
         MVC   SPITNAME(SUBPVARL1),SPITNAME-SUBPINT(R2)        @DY45525 05163000
         MVC   SPITKEY(SUBPVARL2),SPITKEY-SUBPINT(R2)          @DY45525 05164000
         BR    R7                                              @D64ADKH 05165000
         DROP  R5,RC,RD                                        @D52VDKH 05166000
         DROP  RE              RELEASE ROUTINE BASE            @D64ADMZ 05167000
         EJECT                                                 @D14CDJB 05168000
***********************************************************             05169000
*   FVROUTED : FREEVIS ALL REQUESTS FOR SPACE GETVIS IN SVA             05170000
*                                                                       05171000
*      MODULE FVROUTED:                                                 05172000
*      THIS ROUTINE IS CALLED DURING UNBATCH PROCESSING.                05173000
*      IT FREES ALL SUBPOOLS OF A STATIC PARTITION                      05174000
*      WHICH WERE ROUTED TO THE SVA.                                    05175000
*        A) VSE SUBPOOLS (IDENTIFIED BY SUBPOOL INDEX TABLE)            05176000
*        B) MVS SUBPOOLS (IDENTIFIED BY SPLE)                           05177000
*      ENDMODULE FVROUTED                                               05178000
*                                                                       05179000
*   CALLED BY : FREEVIS                                                 05180000
*   CALLS     : FVSBPOOL, GTVSINIT                                      05181000
*                                                                       05182000
*   INPUT  : RD --> REQUESTOR'S SAVE AREA                               05183000
*            RE --> BASE REGISTER                                       05184000
*   OUTPUT : RF  : 0 : INITIALIZATION OK                                05185000
*                  4 : THE CORRESPONDING REAL PARTITION IS 0K           05186000
*                      OR THE SVA IS NOT YET INITIALIZED                05187000
*            RB  :  0  FOR PARTITION GETVIS/FREEVIS                     05188000
*                   -3 FOR SYSTEM OR SPACE GETVIS/FREEVIS               05189000
*            RC --> ANCHOR TABLE (SYSTEM GETVIS AREA)                   05190000
*                   SYSTEM GETVIS GATE ALREADY CLOSED                   05191000
*                                                                       05192000
*   WORK   : R3,R5,R7                                                   05193000
*            R0,R2,R4,R8,R9                                             05194000
*   LINK   : R1                                                         05195000
*                                                                       05196000
         AGO    .CREATET                                       @D52VDKH 05197000
.FVROUTD ANOP                                                  @D52VDKH 05198000
.*             0123456789ABCDEF                                         05199000
&INPREG  SETC '0000000000100110'                               @D52VDMZ 05200000
&OUTREG  SETC '0000000000011001'                               @D52VDKH 05201000
&WRKREG  SETC '1011110111000000'                               @D52VDMZ 05202000
&NMDREG  SETC '0100001000100110'                               @D52VDMZ 05203000
&LINKR   SETC 'R1'                                             @D52VDKH 05204000
&TBASE   SETC 'OWN'                                            @D52VDKH 05205000
.*EXCLSYMS=(SAVR2ND6)                                          @D52VDMZ 05206000
         AGO    .TESTALL                                       @D52VDKH 05207000
.CREATET ANOP                                                  @D52VDKH 05208000
*                                                              @D52VDKH 05209000
* CHANGE ACTIVITY:                                                      05210000
*        MOVE FROM SGAM TO MAKE IT A SUBROUTINE                @D52VDKH 05211000
*********************************************************************** 05212000
         SPACE 3                                                        05213000
         USING SVEARA,RD                                       @D52VDKH 05214000
         USING FVALLRTD,RE                                     @D52VDKH 05215000
         USING ANCHTAB,RC                                      @D14CDJB 05216000
FVALLRTD EQU   *                                               @D51IDKH 05217000
*SGLINK  FVROUTED,S,INPUT=(R1:LINK,RA,RC,RD),OUTPUT=(RF),              *05218000
               WORK=(R0,R2-R5,R7-R9,RB,RE,RF),NOMODR=(R1),             *05219000
               AMODE=31,MODSYM=(SAVR2ND6,SVWORK1),                     *05220000
               SUBROUT=(GTVSINI1:IGN(R1,RC),FVSBPOOL:IGN(R1),          *05221000
               DSC_LSQA_NS:IGN(R1))                                     05222000
         SR    RF,RF                   CLEAR RETURN CODE       @D51IDKH 05223000
         TM    SVER0F+D3,SVAIND        IN DYNAMIC PARTITION ?  @D51IDKH 05224000
         BZ    FVERROR                 YES, ILLEGAL SVC        @D51IDKH 05225000
         L     R3,CRADDR          GET CURRENT COMREG ADDR      @D51IDKH 05226000
         USING COMREG,R3          COMREG ADDRESSABILITY        @D35EDUL 05227000
         TM    JCSW5,JCLACTIV     REQUEST BY JCL ?             @D14NDJB 05228000
         BZ    FVERROR            NO, ILLEGAL SVC              @D51IDKH 05229000
         DROP  R3                                              @D51IDKH 05230000
***************************************************************         05231000
*      NOTE:                                                            05232000
*      WHILE THE PCB OF A DYNAMIC PARTITION IS FREED AT                 05233000
*      DEALLOCATION OF THE PARTITION, THE PCB OF A STATIC               05234000
*      PARTITION SURVIVES. HENCE THE INDEX IN THE SUBPOOLNAME           05235000
*      MUST BE CLEARED. THIS IS DONE DURING FREEVIS PROCESSING.         05236000
*      SINCE R1 IS INPUT FOR THE FREEVIS SUBPOOL ROUTINE, R1            05237000
*      POINTS ALWAYS TO THE PCB SUBPOOLNAME TO HAVE AN AREA TO          05238000
*      BE CLEARED.                                                      05239000
*                                                                       05240000
***************************************************************         05241000
***************************************************************@D149DJB 05242000
*  DO INITIALISATION                                                    05243000
***************************************************************@D149DJB 05244000
         LA    RB,1               IDENTIFY CALLER AS FREEVIS   @D52VDKH 05245000
         ST    R1,SAVR2ND6        SAVE    RETURN ADDRESS       @D64ADKH 05246000
*SGLINK  GTVSINI1,INPUT=(R7:LINK,RB-RD,RF),OUTPUT=(RB,RC,RF),          *05247000
               NOMODR=(R6,RA,RD),AMODE=31,NOMODS=(SAVR2ND6)             05248000
         SGAMSUBR SUBROUT=GTVSINI1,                            @D14CDJB*05249000
               INPUT=(RB,RD,RE,RF),                            @D52VDMZ*05250000
               OUTPUT=(RB,RC,RF),                              @D52VDMZ*05251000
               NOMOD=(R6,RA,RD),                               @D52VDMZ*05252000
               LINK=(R7),                                      @D14CDJB*05253000
               NOMODS=(SAVR2ND6),                              @D52VDMZ*05254000
               CBASE=OWN,         INITIALIZE GETVIS AREA       @D52VDKH*05255000
               SUBROUC=FVROUTED                                @D52VDKH 05256000
         L     R1,SAVR2ND6        RESTORE RETURN ADDRESS       @D64ADKH 05257000
         LTR   RF,RF              ERROR OCCURED ?              @D52VDKH 05258000
         BNZR  R1                 YES ===> (RF ALREADY SET)    @D52VDKH 05259000
         TM    SVER0F+D1,FVROS390  FREE OS390 SUBPOOLS ONLY    @DY45712 05260000
         BO    FVRTDRET           YES, SKIP VSE SUBPOOLS       @DY45712 05261000
         SPACE                                                          05262000
*  FREEVIS VSE SUBPOOLS                                        @D52VDKH 05263000
         SPACE                                                          05264000
         LA    R3,SUBPINTL                                     @D51IDKH 05265000
         MH    R3,MXSUBPLH        MAX. NUMBER OF SUBPOOLS      @D51IDKH 05266000
         A     R3,BSUBPIND        ADDRESS OF LAST POSSIBLE     @D51IDKH 05267000
         ST    R3,SVWORK1         SUBPOOL INDEX                @D51IDKH 05268000
         L     R5,BSUBPIND        START OF SUBPOOL INDEX TABLE @D51IDKH 05269000
         OI    SVER0F+D3,FVSPID   SET INDICATOR FOR SUBPOOL    @D51IDKH 05270000
         OI    SVER0F+D2,GVFVSPIN                              @D64ADKH 05271000
         USING SUBPINT,R5         PROCESSING                   @D51IDKH 05272000
FVALLRO1 EQU   *                                               @D51IDKH 05273000
         LA    R5,SUBPINTL(R5)      ADDRESS NEXT SUBPOOL                05274000
         C     R5,SVWORK1           ALL SUBPOOLS PROCESSED?    @D51IDKH 05275000
         BH    FVRTDRET             YES, DONE                  @D52VDKH 05276000
         CLC   SPITPIK,PIK          SUBPOOL USED BY THIS PATITN@D51IDKH 05277000
         BNE   FVALLRO1             NO, IGNORE                 @D51IDKH 05278000
         L     R1,PIBPTR2         RELOAD PCB PTR. GET PCB..    @D52VDMZ 05279000
         USING PIB2ADR,R1                                      @D51IDKH 05280000
         L     R1,PIBPCB           .. OUT OF PIB2              @D52VDMZ 05281000
         USING PCBADR,R1                                       @D51IDKH 05282000
         LA    R1,PCBPSPID        ADDRESS OF SUBPOOL ID FOR    @D51IDKH 05283000
         DROP  R1                 ROUTED REQUESTS              @D51IDKH 05284000
*SGLINK  FVSBPOOL,INPUT=(R1,R5,R7:LINK,RA,RB,RC,RD,RF),OUTPUT=(RF),    *05285000
               NOMODR=(R6,RA,RD),AMODE=31,NOMODS=(SAVR2ND6)             05286000
         SGAMSUBR SUBROUT=FVSBPOOL, YES, FREE IT               @D51IDKH*05287000
               INPUT=(R1,R5,RA,RB,RC,RD,RE,RF),                @D64ADMZ*05288000
               NOMOD=(R6,RA,RD),                               @D51IDKH*05289000
               LINK=(R7),                                      @D51IDKH*05290000
               CBASE=OWN,         FREE TOTAL SUBPOOL           @D52VDKH*05291000
               NOMODS=(SAVR2ND6),                              @D52VDMZ*05292000
               SUBROUC=FVROUTED                                @D52VDKH 05293000
         B     FVALLRO1           CHECK NEXT SUBPOOL           @D51IDKH 05294000
         DROP  R5                 RELEASE SUBPOOL INDEX        @D51IDKH 05295000
         SPACE                                                          05296000
*  FREE LSQA (SPACE) SUBPOOLS (AND CORRESPONDING SPLES), THAT ARE       05297000
*  OWNED BY THE ADDRESS SPACE (LIFE-TIME).                              05298000
*  BOTH SUBPOOLS AND SPLES ARE IN SYSTEM GETVIS AREA SINCE STATIC       05299000
*  PARTITION                                                            05300000
         SPACE                                                          05301000
FVRTDRET EQU   *                                               @D52VDKH 05302000
*                                                                       05303000
*  ON RETURN SYSTEM GETVIS GATE IS STILL CLOSED                         05304000
*                                                                       05305000
         OI    GMFMFLG2,LSQA      FREE LSQA (SPACE) SUBPOOLS.. @D64ADKH 05306000
*                                 .. AND CORR. SPLES           @D64ADKH 05307000
         L     R7,SCBPTR                                       @D64ADKH 05308000
         LA    R2,SCBSPL-SCBADR(R7)                            @D64ADKH 05309000
         L     R8,SAVR2ND6        GET BACK RETURN ADDRESS      @D64ADKH 05310000
*SGLINK  DSC_LSQA_NS,INPUT=(R2,R7:LINK,RC,RD),OUTPUT=(RF),     @D64ADKH*05311000
               NOMODR=(R6,R8,RA-RD)                            @D64ADKH 05312000
         SGAMSUBR SUBROUT=FVDISCRD,                            @D64ADKH*05313000
               INPUT=(R2),                                     @D64ADMZ*05314000
               LINK=(R7),                                      @D64ADKH*05315000
               CBASE=OWN,                                      @D64ADKH*05316000
               NOMODS=(SAVR2ND6),                              @D64ADKH*05317000
               SUBROUC=FVROUTED                                @D64ADKH 05318000
         NI    SVER0F+D3,X'FF'-FVSPID                          @D64ADKH 05319000
         LR    R1,R8                                           @D64ADKH 05320000
         BR    R1                                              @D64ADKH 05321000
         DROP  RC,RD                                           @D52VDKH 05322000
FVERROR  DS    0H                 ERROR EXIT FOR SFREEVIS ROUT.@D51IDKH 05323000
         L     R6,DISPAD          GET DISPATCHER ADDRESS       @D51IDKH 05324000
         USING DISP,R6                                         @D52VDKH 05325000
         DROP  RE                                              @D52VDKH 05326000
         B     ERR21              ILLEGAL SVC                  @D51IDKH 05327000
         DROP  R6                 RELEASE DISPATCHER           @D51IDKH 05328000
         EJECT                                                 @D52VDKH 05329000
***************************************************************@D149DJB 05330000
*                                                              @D149DJB 05331000
*   ROUTINE TO LOOK FOR REQUESTED GETVIS SPACE .               @D149DJB 05332000
*    THIS IS DONE IN THE EXISTING SUBPOOL.                     @D61NDMZ 05333000
*    THE CURRENT POINTER MIGHT NOT POINT TO A GAP. THEREFORE   @D61NDMZ 05334000
*    THE SUBPOOL IS SCANNED COMPLETELY TO FIND THE FIRST GAP.  @D61NDMZ 05335000
*    THE CURRENT PTR IS UPDATED TO POINT TO THIS GAP OR THE    @D61NDMZ 05336000
*    END OF THE SUBPOOL IF THERE IS NO GAP AT ALL.             @D61NDMZ 05337000
*    SINCE FOR POOL=YES OR PAGE=YES REQUESTS PART OF THE       @D61NDMZ 05338000
*    SUBPOOL ARE SKIPPED, THE CURRENT POINTER CANNOT BE UPDATED@D61NDMZ 05339000
*                                                              @D149DJB 05340000
*   MODULE GVSBPOOL                                            @D149DJB 05341000
*      INITIALIZE SCAN POINTERS                                @D149DJB 05342000
*      IF SUBPOOL IS NOT EMPTY                                 @D149DJB 05343000
*        THEN DO WHILE SUBPOOL NOT SCANNED COMPLETELY          @D149DJB 05344000
*               IF PAGE CROSSING ALLOWED FOR SVA REQUEST       @D149DJB 05345000
*                 THEN TAKE ALL CONTIGUOUS PAGES               @D149DJB 05346000
*               IF PAGE BOUNDARY REQUESTED                     @D149DJB 05347000
*                 THEN EXECUTE GVSCPBDY                        @D149DJB 05348000
*                 ELSE EXECUTE GVSCVSTB                        @D149DJB 05349000
*               IF RC = 0                                      @D149DJB 05350000
*                 THEN EXECUTE GVUPPIE0                        @D149DJB 05351000
*                      EXECUTE SETVSTAB                        @D149DJB 05352000
*                      EXIT GVSBPOOL                           @D149DJB 05353000
*             ENDDO                                            @D149DJB 05354000
*      IF REQUEST > ONE PAGE                                   @D218DKH 05355000
*        THEN SET RC=12 AND EXIT GVSBPOOL                      @D218DKH 05356000
*      EXECUTE GVGETPAG                                        @D149DJB 05357000
*      IF RC = 0                                               @D149DJB 05358000
*        THEN EXECUTE GFENQDEQ                                 @D149DJB 05359000
*             EXECUTE GVUPPIE1                                 @D149DJB 05360000
*             EXECUTE SETVSTAB                                 @D149DJB 05361000
*             IF SVA SUBPOOL TO BE FETCH PROTECTED             @D149DJB 05362000
*               THEN EXECUTE GFSETKEY                          @D149DJB 05363000
*      EXIT GVSBPOOL                                           @D149DJB 05364000
*   ENDMODULE GVSBPOOL                                         @D149DJB 05365000
*                                                              @D149DJB 05366000
*     CALLED BY : GETVIS                                       @D149DJB 05367000
*     CALLS     : GVSCPBDY  GVSCVSTB  GVGETPAG  GVUPPIE0       @D149DJB 05368000
*                 GFENQDEQ  SETVSTAB  GFSETKEY  GVUPPIE1       @D149DJB 05369000
*                                                              @D149DJB 05370000
*     INPUT  : R0  :  LENGTH OF REQUESTED AREA                 @D149DJB 05371000
*              R2 --> ENTRY IN SUBPOOL INDEX TABLE             @D149DJB 05372000
*              RA  :  TCBPTR                                   @D52VDMZ 05373000
*              RB  :  SHIFT MODIFIER FOR SVA/SPACE REQUEST     @D149DJB 05374000
*              RC --> ANCHOR TABLE (VISTAB)                    @D149DJB 05375000
*              RD --> REQUESTOR SAVE AREA                      @D149DJB 05376000
*     OUTPUT : RF  :  RETURN CODE : 0C (SPACE NOT FOUND)       @D149DJB 05377000
*     LINK   : R7                                              @D149DJB 05378000
*     WORK   : R0,R1,R3,R4,R5,R8,R9,RF                         @D149DJB 05379000
*                                                              @D149DJB 05380000
         AGO   .CREATEF                                        @D14ZDJB 05381000
.GVSBPOL ANOP                                                  @D14ZDJB 05382000
.*             0123456789ABCDEF                                @D149DJB 05383000
&INPREG  SETC '1010000000111100'                               @D52VDMZ 05384000
&OUTREG  SETC '0000000000000001'                               @D14ZDJB 05385000
&WRKREG  SETC '1101110011000001'                               @D52VDMZ 05386000
&NMDREG  SETC '0010001100111110'                               @D52VDMZ 05387000
&LINKR   SETC 'R7'                                             @D14ZDJB 05388000
&TBASE   SETC 'OWN'                                            @D52VDKH 05389000
.*EXCLSYMS=()                                                  @D52VDMZ 05390000
         AGO    .TESTALL                                       @D14ZDJB 05391000
.CREATEF ANOP                                                  @D14ZDJB 05392000
***************************************************************@D149DJB 05393000
.* GVSBPOOL IS NOT ALLOWED TO BE CALLED AFTER GFENQDEQ.                 05394000
.* AFTER GFENQDEQ, SPITCURP MIGHT BE < 0 EVEN IF SUBPOOL IS NOT EMPTY   05395000
.* ( IF PAGES ARE ENQUEUED IN EMPTY SUBPOOL).                           05396000
         SPACE 2                                               @D14CDJB 05397000
         USING ANCHTAB,RC                                      @D14CDJB 05398000
         USING SVEARA,RD                                       @D14CDJB 05399000
         USING SUBPINT,R2                                      @D14CDJB 05400000
         USING GVSBPOOL,RE                                     @D52VDKH 05401000
GVSBPOOL DS    0H                                              @D14CDJB 05402000
*SGLINK  GVSBPOOL,S,INPUT=(R0,R2,R7:LINK,RA,RB,RC,RD),OUTPUT=(RF),     *05403000
               WORK=(R0,R1,R3-R5,R8,R9,RE,RF),NOMODR=(R7),             *05404000
               AMODE=31,SUBROUT=(GVSCPBDY,GVSCVST1,GVSCVSTB,GVUPPIE0,  *05405000
               SETVSTAB:IGN(R2),GVGETPAG,GFENQDEQ)                      05406000
         LR    R5,R0              GET REQUESTED BYTE LENGTH    @D14CDJB 05407000
         BCTR  R5,0               MINUS ONE                    @D14CDJB 05408000
         SRA   R5,LDVBYTBI(RB)    CONVERT IN BIT LENGTH        @D14CDJB 05409000
         LA    R5,D1(R5)          GET REQUESTED BIT LENGTH     @D14CDJB 05410000
         LR    R0,R5              R0 FOR FURTHER USE           @D14CDJB 05411000
         L     R5,SPITCURP        GET PTR IN CHAIN TABLE       @D14CDJB 05412000
         LTR   R5,R5              HAS SUBPOOL AT LEAST 1 PAGE? @D14CDJB 05413000
         BM    GVSNFND3           NO  ===>                     @D61NDMZ 05414000
         LR    R9,R5              GET PTR IN CHAIN TABLE       @D14CDJB 05415000
         IC    RF,SPITRLVB        GET CURRENT POINTER          @D14CDJB 05416000
         IC    R3,SPITBITO        GET BIT MASK                 @D14CDJB 05417000
         TM    SVER0F+D3,GVPOOL   POOL SPECIFIED               @D61NDMZ 05418000
         BO    GVSBLOOP           YES, NO UPDATE OF CURRENT PTR@D61NDMZ 05419000
         OI    GVFVFLGS,GVUPDCP+GVFIRSTT INDICATE UPDATE CURRENT PTR   *05420000
                                  AND SCAN OF FIRST CONT. AREA @D61NDMZ 05421000
***************************************************************@D149DJB 05422000
*   START SEARCHING                                            @D149DJB 05423000
***************************************************************@D149DJB 05424000
GVSBLOOP EQU   *                                               @D14CDJB 05425000
         USING SUBPCHN,R9                                      @D14CDJB 05426000
         TM    SVER0F+D3,SGVNPGX  PAGE XING ALLOWED FOR SVA ?  @D14CDJB 05427000
         BO    GVSBLPB            NO  ===>                     @D14CDJB 05428000
GVSBLPA  EQU   *                                               @D14CDJB 05429000
         TM    SPCHFLAG,SPPGCONC  NEXT PAGE CONTIGUOUS ?       @D14CDJB 05430000
         BNO   GVSBLPB            NO  ===>                     @D14CDJB 05431000
         L     R9,SPCHFORW        GO TO NEXT PAGE              @D14CDJB 05432000
         B     GVSBLPA            SCAN SUBPOOL                 @D14CDJB 05433000
GVSBLPB  EQU   *                                               @D14CDJB 05434000
         TM    SVER0F+D3,PAGEIND  PAGE BOUNDARY REQUESTED ?    @D14CDJB 05435000
         BZ    GVSBLPC            NO  ===>                     @D14CDJB 05436000
         NI    GVFVFLGS,XFF-GVUPDCP-GVFIRSTT UPDATE CURRENT PTR@D61NDMZ 05437000
* NOT POSSIBLE, SINCE PAGES ARE NOT SCANNED COMPLETELEY                 05438000
*SGLINK  GVSCPBDY,INPUT=(R0,R5,R8:LINK,R9,RB-RC),OUTPUT=(R1,R3,R4,RF), *05439000
               NOMODR=(R0,R2,R5,R6,R7,R9,RA-RC,RD),AMODE=31             05440000
         SGAMSUBR SUBROUT=GVSCPBDY,                            @D14CDJB*05441000
               INPUT=(R0,R5,R9,RB,RC),                         @D14CDJB*05442000
               OUTPUT=(R1,R3,R4,RF),                           @D14CDJB*05443000
               NOMOD=(R0,R2,R5,R6,R7,R9,RB,RC,RD),             @D14CDJB*05444000
               LINK=(R8),         LOOK FOR SPACE ON PAGE BDY.  @D14CDJB*05445000
               CBASE=OWN,                                      @D52VDKH*05446000
               SUBROUC=GVSBPOOL                                @D52VDKH 05447000
         B     GVSBLPD            ===> CONTINUE SUBPOOL SCAN   @D14CDJB 05448000
GVSBLPC  EQU   *                                               @D14CDJB 05449000
*SGLINK  GVSCVST1,INPUT=(R0,R2,R3,R5,R8:LINK,R9,RB,RC,RF),             *05450000
               OUTPUT=(R1,R3,R4,RF),NOMODR=(R0,R2,R5-R7,R9,RA-RC,RD),  *05451000
               AMODE=31,                                                05452000
         SGAMSUBR SUBROUT=GVSCVST1,                            @D61NDMZ*05453000
               INPUT=(R0,R2,R3,R5,R9,RB,RC,RF),                @D61NDMZ*05454000
               OUTPUT=(R1,R3,R4,RF),                           @D14CDJB*05455000
               NOMOD=(R0,R2,R6,R7,R9,RB,RC,RD),                @D61NDMZ*05456000
               LINK=(R8),         SCAN VISTAB                  @D14CDJB*05457000
               CBASE=OWN,                                      @D52VDKH*05458000
               SUBROUC=GVSBPOOL                                @D52VDKH 05459000
GVSBLPD  EQU   *                                               @D14CDJB 05460000
         LTR   RF,RF              SPACE FOUND ?                @D14CDJB 05461000
         BZ    GVSBFND            YES ===>                     @D14CDJB 05462000
***************************************************************@D51XDMZ 05463000
*   CHECK FOR TOTAL SUBPOOL SCAN                               @D51XDMZ 05464000
*    IF POOL PARAMETER IS SPECIFIED THE SUBPOOL IS SCANNED     @D51XDMZ 05465000
*      FORM SPITCURP TILL SPITCURP (WRAP AROUND)               @D51XDMZ 05466000
*    ELSE                                                      @D51XDMZ 05467000
*      SINCE SPITCURP POINTS TO THE FIRST PAGE IN THE SUBPOOL  @D51XDMZ 05468000
*      WITH A POSSIBLE GAP, SEARCH IS DONE FROM SPITCURP TILL  @D51XDMZ 05469000
*      END OF SUBPOOL. SEARCH FROM BEGIN TILL SPITCURP IS NOT  @D51XDMZ 05470000
*      NECESSARY.                                              @D51XDMZ 05471000
***************************************************************@D51XDMZ 05472000
         TM    SVER0F+D3,GVPOOL   POOL SPECIFIED               @D51XDMZ 05473000
         BO    GVSBPOL0           YES, CHECK FOR WRAP AROUND   @D51XDMZ 05474000
         L     R5,SPCHFORW        IF (R5=R9.SPCHFORW)  =       @D61NDMZ 05475000
         C     R5,SPITFRST        SPITFRST THEN TOTAL SUBPOOL  @D61NDMZ 05476000
         BE    GVSBNFND           SCANNED AND AREA NOT FOUND   @D61NDMZ 05477000
         SR    RF,RF              RESET CURRENT POINTER        @D51XDMZ 05478000
         SR    R3,R3              RESET BIT MASK               @D51XDMZ 05479000
         LR    R9,R5              GOTO NEXT SUBPOOL PAGE       @D51XDMZ 05480000
         B     GVSBLOOP           REPEAT SEARCH                @D51XDMZ 05481000
GVSBPOL0 C     R5,SPITCURP        CHECK FOR WRAP AROUND        @D14CDJB 05482000
         L     R5,SPCHFORW        GOTO NEXT SUBPOOL PAGE       @D14CDJB 05483000
         DROP  R9                                              @D14CDJB 05484000
         BNL   GVSBLTOF           ===> LOW CASE IS SPECIAL     @D14CDJB 05485000
         C     R9,SPITCURP        TOTAL SUBPOOL SCANNED ?      @D14CDJB 05486000
         BNL   GVSBNFND           YES ===> SPACE NOT FOUND     @D14CDJB 05487000
GVSBLTOF EQU   *                                               @D14CDJB 05488000
         SR    RF,RF              RESET CURRENT POINTER        @D14CDJB 05489000
         SR    R3,R3              RESET BIT MASK               @D14CDJB 05490000
         LR    R9,R5              GOTO NEXT SUBPOOL PAGE       @D14CDJB 05491000
         C     R5,SPITCURP        TOTAL SUBPOOL SCANNED ?      @D14CDJB 05492000
         BNE   GVSBLOOP           NO  ===> REPEAT SEARCH       @D14CDJB 05493000
***************************************************************@D149DJB 05494000
*   SPACE NOT FOUND UP TO NOW.                                 @D149DJB 05495000
*   SCAN FIRST PAGE (IN THIS CASE THE FOREGOING PAGE DOES NOT  @D149DJB 05496000
*   BELONG TO THIS SUBPOOL), IGNORING THE CURRENT POINTER.     @D149DJB 05497000
***************************************************************@D149DJB 05498000
         TM    SVER0F+D3,PAGEIND  PAGE BOUNDARY REQUESTED ?    @D14CDJB 05499000
         BO    GVSBNFND           YES ===> (NO SCAN OF FIRST   @D14CDJB 05500000
*                                               PAGE AGAIN !)  @D149DJB 05501000
         USING SUBPCHN,R9                                      @D14CDJB 05502000
         TM    SPCHFLAG,SPPGCONC  NEXT PAGE CONTIGUOUS ?       @D14CDJB 05503000
         BNO   GVSBSCFA           NO  ===>                     @D14CDJB 05504000
         L     R9,SPCHFORW        GO TO NEXT PAGE              @D14CDJB 05505000
         DROP  R9                                              @D14CDJB 05506000
GVSBSCFA EQU   *                                               @D14CDJB 05507000
*SGLINK  GVSCVSTB,INPUT=(R0,R3,R5,R8:LINK,R9,RB,RC,RF),OUTPUT=(R1,R3,  *05508000
               R4,RF),NOMODR=(R0,R2,R5,R6,R7,R9-RC,RD),AMODE=31         05509000
         SGAMSUBR SUBROUT=GVSCVSTB,                            @D14CDJB*05510000
               INPUT=(R0,R3,R5,R9,RB,RC,RF),                   @D14CDJB*05511000
               OUTPUT=(R1,R3,R4,RF),                           @D14CDJB*05512000
               NOMOD=(R0,R2,R5,R6,R7,RB,RC,RD),                @D14CDJB*05513000
               LINK=(R8),         SCAN VISTAB                  @D14CDJB*05514000
               CBASE=OWN,                                      @D52VDKH*05515000
               SUBROUC=GVSBPOOL                                @D52VDKH 05516000
         LTR   RF,RF              SPACE FOUND ?                @D14CDJB 05517000
         BNZ   GVSBNFND           NO  ===>                     @D14CDJB 05518000
***************************************************************@D149DJB 05519000
*    REQUESTED SPACE FOUND IN SUBPOOL                          @D149DJB 05520000
*     CURRENT POINTER UPDATED IN GVSCVSTB, IF GVUPDCP WAS SET  @D61NDMZ 05521000
***************************************************************@D149DJB 05522000
GVSBFND  DS    0H                                              @D14CDJB 05523000
         LTR   R0,R0              LENGTH 0 REQUEST ?           @D14CDJB 05524000
         BNZ   GVSBNZER           NO  ===>                     @D14CDJB 05525000
         ST    R4,SVER01          STORE ADDRESS IN USER AREA   @D14CDJB 05526000
         TM    SVER0F+D3,GVPOOL   POOL SPECIFIED               @D52VDMZ 05527000
         BZR   R7                 NO, RETURN                   @D52VDMZ 05528000
         MVC   SPITCURP,SCURPSAV  RESTORE ...                  @D52VDMZ 05529000
         MVC   SPITRLVB,SRLVBSAV  ... CURRENT                  @D52VDMZ 05530000
         MVC   SPITBITO,SBITOSAV  ...    POINTER               @D52VDMZ 05531000
         BR    R7                 ===> RETURN TO CALLER        @D14CDJB 05532000
GVSBNZER EQU   *                                               @D14CDJB 05533000
         SR    R9,R9              SET INDICATOR FOR GVUPPI     @D14CDJB 05534000
*SGLINK  GVUPPIE0,INPUT=(R1,R2,R3,R4,R8:LINK,R9,RB,RC,RD,RF),          *05535000
               OUTPUT=(R0,R1,R3,RF),NOMODR=(R2,R6,R7,RA-RD),AMODE=31    05536000
         SGAMSUBR SUBROUT=GVUPPIE0,                            @D14CDJB*05537000
               INPUT=(R1,R2,R3,R4,R9,RB,RC,RD,RF),             @D14CDJB*05538000
               OUTPUT=(R0,R1,R3,RF),                           @D14CDJB*05539000
               NOMOD=(R6,R7,RB,RD),                            @D14CDJB*05540000
               LINK=(R8),         SET POINTER AND PREPARE INPUT@D14CDJB*05541000
               CBASE=OWN,                                      @D52VDKH*05542000
               SUBROUC=GVSBPOOL                                @D52VDKH 05543000
.* R2 IS CHANGED DURING SETVSTAB PROCESSING. BUT SINCE THE AREA WAS     05544000
.* FOUND, R2 IS NO LONGER USED BY THE CALLER OF GVSBPOOL                05545000
*SGLINK  SETVSTAB,INPUT=(R0,R1,R3,R8:LINK,RC),                         *05546000
               NOMODR=(R6,R7,RA-RD,RF),AMODE=31                         05547000
         SGAMSUBR SUBROUT=SETVSTAB,                            @D14CDJB*05548000
               INPUT=(R0,R1,R3,RC),                            @D14CDJB*05549000
               NOMOD=(R6,R7,RB,RC,RD,RF),                      @D52VDMZ*05550000
               LINK=(R8),         SET VISTAB BITS              @D14CDJB*05551000
               IGN=(R2),                                       @D52VDMZ*05552000
               CBASE=OWN,                                      @D52VDKH*05553000
               SUBROUC=GVSBPOOL                                @D52VDKH 05554000
         BR    R7                 ===> RETURN TO CALLER        @D14CDJB 05555000
***************************************************************@D149DJB 05556000
*    REQUESTED SPACE NOT FOUND IN SUBPOOL                      @D149DJB 05557000
*      R9: CHAIN TABLE ENTRY OF LAST SCANNED PAGE              @D61NDMZ 05558000
***************************************************************@D149DJB 05559000
GVSBNFND DS    0H                                              @D14CDJB 05560000
         TM    GVFVFLGS,GVUPDCP   UPDATE REQUIRED              @D61NDMZ 05561000
         BZ    GVSNFND3           NO                           @D61NDMZ 05562000
         NI    GVFVFLGS,X'FF'-GVUPDCP RESET                    @D61NDMZ 05563000
         ST    R9,SPITCURP        LAST PAGE IN SUBPOOL         @D61NDMZ 05564000
         LA    RF,PABYTPPG        NO OF VISTAB BYTES PER PAGE  @D61NDMZ 05565000
         LTR   RB,RB              PARTITION REQUEST            @D61NDMZ 05566000
         BZ    GVSNFND2           YES                          @D61NDMZ 05567000
         LA    RF,SVBYTPPG        SET UP FOR SVA               @D61NDMZ 05568000
GVSNFND2 DS    0H                                              @D61NDMZ 05569000
         BCTR  RF,0               BYTE OFFSET IN LAST PAGE     @D61NDMZ 05570000
         STC   RF,SPITRLVB        POINT TO LAST BYTE OF SUBPOOL@D61NDMZ 05571000
         MVI   SPITBITO,X'FF'     NO FREE BIT IN LAST BYTE     @D61NDMZ 05572000
GVSNFND3 DS    0H                                              @D61NDMZ 05573000
         LA    RF,SMERR0C         SET RETURN CODE              @D52VDMZ 05574000
         L     R4,SVER00          GET REQUESTED LENGTH         @D218DKH 05575000
         LTR   R4,R4              RETURN WITH 'NOT FOUND' FOR..@D52VDMZ 05576000
         BZR   R7                 .. LENGTH 0 REQUEST          @D52VDMZ 05577000
         L     R3,PAGESIZE                                     @D218DKH 05578000
         CR    R4,R3              MORE THAN A PAGE REQUESTED ? @D218DKH 05579000
         BHR   R7                 YES ==>                      @D52VDMZ 05580000
         LA    R4,D1              LOOK FOR ONE PAGE            @D14CDJB 05581000
         SR    RF,RF              RESET RETURN CODE REGISTER   @D14CDJB 05582000
         L     R3,FIRSTPNT        START OF SEARCH              @D14CDJB 05583000
*SGLINK  GVGETPAG,INPUT=(R3,R4,R8:LINK,RC,RD,RF),OUTPUT=(R3,R5,R9,RF), *05584000
               NOMODR=(R2,R4,R6,R7,RA-RC,RD),AMODE=31                   05585000
         SGAMSUBR SUBROUT=GVGETPAG,                            @D14CDJB*05586000
               INPUT=(R3,R4,RC,RD,RF),                         @D14CDJB*05587000
               OUTPUT=(R3,R5,R9,RF),                           @D14CDJB*05588000
               NOMOD=(R2,R4,R6,R7,RB,RC,RD),                   @D14CDJB*05589000
               LINK=(R8),         LOOK FOR EMPTY PAGE          @D14CDJB*05590000
               CBASE=OWN,                                      @D52VDKH*05591000
               SUBROUC=GVSBPOOL                                @D52VDKH 05592000
         LTR   RF,RF              PAGE FOUND ?                 @D14CDJB 05593000
         BNZR  R7                 NO  ==> RETURN TO CALLER     @D14CDJB 05594000
         C     R9,GTVSHIGH        HIGH WATER MARK EXCEEDED ?   @D218DKH 05595000
         BNH   GVSBNCHG           NO  ==>                      @D218DKH 05596000
         ST    R9,GTVSHIGH        STORE NEW HIGH WATER MARK    @D218DKH 05597000
GVSBNCHG EQU   *                                               @D218DKH 05598000
*SGLINK  GFENQDEQ,INPUT=(R2,R3,R4,R5,R8:LINK,R9,RC),OUTPUT=(RF),       *05599000
               NOMODR=(R2,R3,R6,R7,R9,RB,RC,RD),AMODE=31                05600000
         SGAMSUBR SUBROUT=GFENQDEQ,                            @D14CDJB*05601000
               INPUT=(R2,R3,R4,R5,R9,RC),                      @D14CDJB*05602000
               OUTPUT=(RF),                                    @D51XDMZ*05603000
               NOMOD=(R2,R3,R6,R7,R9,RB,RC,RD),                @D14CDJB*05604000
               LINK=(R8),         ENQUEUE AND DEQUEUE PAGE(S)  @D14CDJB*05605000
               CBASE=OWN,                                      @D52VDKH*05606000
               SUBROUC=GVSBPOOL                                @D52VDKH 05607000
         TM    GVFVFLGS,GVFVABVE      REQUEST FOR ABOVE ?      @D52VDKH 05608000
         BO    GVSBNCAB               YES, ==>                 @D52VDKH 05609000
*                                                                       05610000
*  SAME LOGIC AS FOR LABEL GETVISED                                     05611000
*                                                                       05612000
         TM    SVER0F+D3,SGVNPGX+PAGEIND  XING OR PBDY ?       @D52VDKH 05613000
         BNZ   GVSBPFCT           NO  ===>                     @D52VDKH 05614000
GVSBPRV  EQU   *                                               @D52VDKH 05615000
         USING SUBPCHN,R3                                      @D14CDJB 05616000
         L     R5,SPCHBACK        GET PAGE BEFORE NEW ONES     @D14CDJB 05617000
         DROP  R3                                              @D14CDJB 05618000
         USING SUBPCHN,R5                                      @D14CDJB 05619000
         TM    SPCHFLAG,SPPGCONC  NEW PAGE CONTIGUOUS WITH OLD @D14CDJB 05620000
         BNO   GVSBPFCT           NO  ===>                     @D14CDJB 05621000
         DROP  R5                                              @D14CDJB 05622000
***************************************************************@D149DJB 05623000
*    SEARCH NEW CONTIGUOUS PAGES TO AVOID FRAGMENTATION        @D149DJB 05624000
***************************************************************@D149DJB 05625000
GVSBPGA  EQU   *                                               @D52VDKH 05626000
         L     R1,SVER00          GET LENGTH                   @D14CDJB 05627000
         BCTR  R1,0               MINUS ONE                    @D14CDJB 05628000
         SRA   R1,LDVBYTBI(RB)    CONVERT IN BIT LENGTH        @D14CDJB 05629000
         LA    R1,D1(R1)          GET REQUESTED BIT LENGTH     @D14CDJB 05630000
         LR    R0,R1              R0 FOR FURTHER USE           @D14CDJB 05631000
         TM    SVER0F+D3,PAGEIND  PAGE BOUNDARY REQUESTED ?    @DA33314 05632000
         BO    GVSBSCPG           NO  ===>                     @DA33314 05633000
GVSBNOPB EQU   *                                               @DA33314 05634000
         SR    R3,R3              RESET CURRENT BIT MASK       @DA33314 05635000
*SGLINK  GVSCVSTB,INPUT=(R0,R3,R5,R8:LINK,R9,RB,RC,RF),OUTPUT=(R1,R3,  *05636000
               R4,RF),NOMODR=(R0,R2,R6,R7,RA-RC,RD),AMODE=31            05637000
         SGAMSUBR SUBROUT=GVSCVSTB,                            @DA33314*05638000
               INPUT=(R0,R3,R5,R9,RB,RC,RF),                   @DA33314*05639000
               OUTPUT=(R1,R3,R4,RF),                           @DA33314*05640000
               NOMOD=(R0,R2,R6,R7,RB,RC,RD),                   @DA33314*05641000
               LINK=(R8),         SCAN VISTAB                  @DA33314*05642000
               CBASE=OWN,                                      @D52VDKH*05643000
               SUBROUC=GVSBPOOL                                @D52VDKH 05644000
GVSBCRET EQU   *                                               @DA33314 05645000
         AIF   (NOT &BGDEBUG).NODBGNR                          @DA33314 05646000
         BALR  R5,0               ADDRESS FOR HW FED           @DA33314 05647000
         LTR   RF,RF              SPACE FOUND ?                @DA33314 05648000
         BNZ   SYSERROR           NO  ===>                     @DA33314 05649000
.NODBGNR ANOP                                                  @DA33314 05650000
         SR    R9,R9              SET INDICATOR FOR GVUPPI     @DA33314 05651000
***************************************************************@DA33314 05652000
*    NEW PAGE NOT CONTIGUOUS, RETURN IMMEDIATELY               @DA33314 05653000
***************************************************************@DA33314 05654000
GVSBPFCT EQU   *                                               @DA33314 05655000
*SGLINK  GVUPPIE0,INPUT=(R1,R2,R3,R4,R8:LINK,R9,RB,RC,RD,RF),          *05656000
               OUTPUT=(R0,R1,R3,RF),NOMODR=(R2,R6,R7,RA-RC,RD),AMODE=31 05657000
         SGAMSUBR SUBROUT=GVUPPIE0,                            @DA33314*05658000
               INPUT=(R1,R2,R3,R4,R9,RB,RC,RD,RF),             @DA33314*05659000
               OUTPUT=(R0,R1,R3,RF),                           @DA33314*05660000
               NOMOD=(R2,R6,R7,RB,RC,RD),                      @DA33314*05661000
               LINK=(R8),         SET POINTER AND PREPARE INPUT@DA33314*05662000
               CBASE=OWN,                                      @D52VDKH*05663000
               SUBROUC=GVSBPOOL                                @D52VDKH 05664000
         LR    RF,R2              SAVE INDEX TABLE ADDRESS     @DA33314 05665000
         DROP  R2                                              @DA33314 05666000
*SGLINK  SETVSTAB,INPUT=(R0,R1,R3,R8:LINK,RC),                         *05667000
               NOMODR=(R6,R7,RA-RC,RD,RF),AMODE=31                      05668000
         SGAMSUBR SUBROUT=SETVSTAB,                            @DA33314*05669000
               INPUT=(R0,R1,R3,RC),                            @DA33314*05670000
               NOMOD=(R6,R7,RB,RC,RD,RF),                      @DA33314*05671000
               LINK=(R8),         SET VISTAB BITS              @DA33314*05672000
               IGN=(R2),                                       @D61NDMZ*05673000
               CBASE=OWN,                                      @D52VDKH*05674000
               SUBROUC=GVSBPOOL                                @D52VDKH 05675000
         LR    R2,RF              RESTORE INDEX TABLE ADDRESS  @DA33314 05676000
         SR    RF,RF              RESET RETURN CODE REGISTER   @DA33314 05677000
         BR    R7                 RETURN TO CALLER             @D52VDMZ 05678000
GVSBSCPG EQU   *                                               @D52VDKH 05679000
*SGLINK  GVSCPBDY,INPUT=(R0,R5,R8:LINK,R9,RB,RC),OUTPUT=(R1,R3,R4,RF), *05680000
               NOMODR=(R0,R2,R6,R7,RA-RC,RD),AMODE=31                   05681000
         SGAMSUBR SUBROUT=GVSCPBDY,                            @DA33314*05682000
               INPUT=(R0,R5,R9,RB,RC),                         @DA33314*05683000
               OUTPUT=(R1,R3,R4,RF),                           @DA33314*05684000
               NOMOD=(R0,R2,R6,R7,RB,RC,RD),                   @DA33314*05685000
               LINK=(R8),         LOOK FOR SPACE ON 2K BDY.    @DA33314*05686000
               CBASE=OWN,                                      @D52VDKH*05687000
               SUBROUC=GVSBPOOL                                @D52VDKH 05688000
         B     GVSBCRET           ===> RETURN                  @DA33314 05689000
GVSBNCAB EQU   *                                               @D52VDKH 05690000
         TM    SVER0F+D3,PAGEIND  PAGE BDY REQUESTED ?         @D52VDKH 05691000
         BNO   GVSBMP                                          @D52VDKH 05692000
         LR    R5,R3              1ST PAGE CHAIN ENTRY FOR SRCH@D52VDKH 05693000
         B     GVSBPGA            NO, CARE FOR ALIGNMENT       @D52VDKH 05694000
GVSBMP   EQU   *                                               @D52VDKH 05695000
         TM    SVER0F+D3,SGVNPGX  PAGE CROSSING ALLOWED ?      @D52VDKH 05696000
         BO    GVSBPFCT           NO  ===>                     @D52VDKH 05697000
         B     GVSBPRV            CHECK PREVIOUS PAGE TOO      @D52VDKH 05698000
         DROP  RC,RD,RE                                        @D52VDKH 05699000
         EJECT                                                 @D14CDJB 05700000
***************************************************************@D149DJB 05701000
*                                                              @D149DJB 05702000
*   ROUTINE TO CHECK GETVIS OPTIONS                            @D51IDMZ 05703000
*                                                              @D51IDMZ 05704000
*   MODULE GVCHOPT                                             @D51IDMZ 05705000
*      CHECK SPECIFIED OPTIONS                                 @D51IDMZ 05706000
*      SET RETURN CODE IF OPTIONS ARE NOT VALID                @D51IDMZ 05707000
*   ENDMODULE GVCHOPT                                          @D51IDMZ 05708000
*                                                              @D51IDMZ 05709000
*     CALLED BY : GETVIS                                       @D51IDMZ 05710000
*     CALLS     : NONE                                         @D51IDMZ 05711000
*                                                              @D51IDMZ 05712000
*     INPUT  : RD --> ADDRESS OF SAVE AREA                     @D51IDMZ 05713000
*            : RE --> BASE                                     @D52VDMZ 05714000
*     OUTPUT : RF=0(OK),                                       @D64ADMZ 05715000
*            : RF=X'14' (INVALID OPTION) (RESET PFIX IND.)     @D64ADMZ 05716000
*     LINK   : R8                                              @D51IDMZ 05717000
*     WORK   : R1,R2,R4                                        @D51IDMZ 05718000
*                                                              @D51IDMZ 05719000
         AGO    .CREATEO                                       @D51IDMZ 05720000
.GVCHOPT ANOP                                                  @D51IDMZ 05721000
.*             0123456789ABCDEF                                @D51IDMZ 05722000
&INPREG  SETC '0000000000000110'                               @D51IDMZ 05723000
&OUTREG  SETC '0000000000000001'                               @D51IDMZ 05724000
&WRKREG  SETC '0110100000000000'                               @D51IDMZ 05725000
&NMDREG  SETC '1001011111111110'                               @D52VDMZ 05726000
&LINKR   SETC 'R8'                                             @D51IDMZ 05727000
&TBASE   SETC 'OWN'                                            @D51IDMZ 05728000
.*EXCLSYMS=()                                                  @D52VDMZ 05729000
         AGO    .TESTALL                                       @D51IDMZ 05730000
.CREATEO ANOP                                                  @D51IDMZ 05731000
***************************************************************@D51IDMZ 05732000
         SPACE 2                                               @D51IDMZ 05733000
         USING GVCHOPT,RE                                      @D51XDMZ 05734000
GVCHOPT  DS    0H                                              @D51IDMZ 05735000
*SGLINK  GVCHOPT,S,INPUT=(R8:LINK,RD),OUTPUT=(RF),                     *05736000
               WORK=(R1,R2,R4,RE),NOMODR=(R8)                           05737000
         USING SVEARA,RD          ADDRESS USER SAVE AREA       @D51IDMZ 05738000
         L     RF,SVER0F          GET SPECIFIED OPTIONS        @D51IDMZ 05739000
         LTR   R4,RF              OPTIONS SPECIFIED ?          @D51IDMZ 05740000
         BZ    GVCHRET            NO, RETURN TO CALLER         @D51IDMZ 05741000
         LA    R2,GTABENTN        GET NUMBER OF ENTRIES IN TAB.@D51IDMZ 05742000
         LA    R1,GVOPTAB         GET BEGIN OF TABLE           @D51IDMZ 05743000
GVCH0    LR    R4,RF              RESTORE SPECIFIED OPTIONS    @D51IDMZ 05744000
         N     R4,0(,R1)          GET OPTION TO BE CHECKED     @D51IDMZ 05745000
         BZ    GVCHNXT            NO, GET NEXT OPTION          @D51IDMZ 05746000
         LR    R4,RF              RESTORE OPTIONS              @D51IDMZ 05747000
         N     R4,4(,R1)          RESET OPTION NOT OF INTEREST @D51IDMZ 05748000
         CL    R4,4(,R1)          ARE ALL REQUESTED OPTIONS ON @D51IDMZ 05749000
         BNE   GVCHRET4           NO, OPTIONS ARE INVALID      @D51IDMZ 05750000
         LR    R4,RF              RESTORE OPTIONS              @D51IDMZ 05751000
         N     R4,8(,R1)          RESET OPTION NOT OF INTEREST @D51IDMZ 05752000
         BNZ   GVCHRET4           INVALID OPTIONS SPECIFIED    @D51IDMZ 05753000
GVCHNXT  LA    R1,GTABENTL(R1)    ADDRESS NEXT ENTRY IN TABLE  @D51IDMZ 05754000
         BCT   R2,GVCH0           MORE OPTIONS TO BE CHECKED ? @D51IDMZ 05755000
         LA    RF,0               NO, ALL OPTIONS VALID        @D51IDMZ 05756000
         B     GVCHRET            RETURN                       @D51IDMZ 05757000
GVCHRET4 LA    RF,SMERR14         INDICATE INVALID OPTION      @D64ADMZ 05758000
         NI    SVER0F+D3,X'FF'-GVPFIX  RESET PFIX INDICATION   @D64ADMZ 05759000
GVCHRET  BR    R8                 RETURN TO CALLER             @D51IDMZ 05760000
         DROP  RD                                              @D51IDMZ 05761000
GVOPTAB  DS    0H                 GETVIS OPTION TABLE          @D51IDMZ 05762000
* STATUS=ALL, CURRENTLY ONLY SUPPORTED FOR SVA, PARTITION      @DY44311 05763000
         DC    X'00020000'        TEST STATUS=ALL              @DY44311 05764000
         DC    X'00020000'        OPTIONS THAT MUST BE SPECIF. @DY44311 05765000
         DC    X'FFFDFFFB'        OPTIONS THAT MUST NOT BE SP. @DY44311 05766000
GTABENTL EQU   *-GVOPTAB          LENGTH OF ONE ENTRY          @D61NDMZ 05767000
* STATUS=SIZE, CURRENTLY ONLY SUPPORTED FOR SVA, PARTITION     @DY44311 05768000
         DC    X'00010000'        TEST STATUS=SIZE             @DY44311 05769000
         DC    X'00010000'        OPTIONS THAT MUST BE SPECIF. @DY44311 05770000
         DC    X'FFFEFFFB'        OPTIONS THAT MUST NOT BE SP. @DY44311 05771000
* IPL = YES                                                    @D61NDMZ 05772000
         DC    X'00008000'        TEST IPL=YES OPTION          @D61NDMZ 05773000
         DC    X'00008004'        OPTIONS THAT MUST BE SPECIF. @D61NDMZ 05774000
         DC    X'FFFF7FFB'        OPTIONS THAT MUST NOT BE SP. @D61NDMZ 05775000
* SPACE = YES                                                  @D51IDMZ 05776000
         DC    X'00000200'        TEST SPACE=YES OPTION        @D51IDMZ 05777000
         DC    X'00000200'        OPTIONS THAT MUST BE SPECIF. @D51IDMZ 05778000
         DC    X'FFFFC1B6'        OPTIONS THAT MUST NOT BE SP. @D51IDMZ 05779000
* SPACE = PARTKEY                                              @D51IDMZ 05780000
         DC    X'00000400'        TEST SPACE=PARTKEY OPTION    @D51IDMZ 05781000
         DC    X'00000608'        OPTIONS THAT MUST BE SPECIF. @D51IDMZ 05782000
         DC    X'FFFFC1F6'        OPTIONS THAT MUST NOT BE SP. @D51IDMZ 05783000
* SPACE = FTCHPR                                               @D51IDMZ 05784000
         DC    X'00000040'        TEST SPACE=FTCHPR            @D51IDMZ 05785000
         DC    X'00000248'        OPTIONS THAT MUST BE SPECIF. @D51IDMZ 05786000
         DC    X'FFFFC5B6'        OPTIONS THAT MUST NOT BE SP. @D51IDMZ 05787000
* SPID SPECIFIED                                               @D51IDMZ 05788000
         DC    X'00000008'        TEST SPID OPTION             @D51IDMZ 05789000
         DC    X'00000008'        OPTIONS THAT MUST BE SPECIF. @D51IDMZ 05790000
         DC    X'FFFFC1A2'        OPTIONS THAT MUST NOT BE SP. @D51IDMZ 05791000
* SPCNTRL SPECIFIED                                            @D51IDMZ 05792000
         DC    X'00000800'        TEST SPID OPTION             @D51IDMZ 05793000
         DC    X'00000808'        OPTIONS THAT MUST BE SPECIF. @D51IDMZ 05794000
         DC    X'FFFFC1A2'        OPTIONS THAT MUST NOT BE SP. @D51IDMZ 05795000
* POOL SPECIFIED                                               @D51IDMZ 05796000
         DC    X'00000002'        TEST POOL OPTION             @D51IDMZ 05797000
         DC    X'00000002'        OPTIONS THAT MUST BE SPECIF. @D51IDMZ 05798000
         DC    X'FFFFCFF8'        OPTIONS THAT MUST NOT BE SP. @D51IDMZ 05799000
* PFIX SPECIFIED                                               @D51IDMZ 05800000
         DC    X'00000010'        TEST PFIX=YES OPTION         @D51IDMZ 05801000
         DC    X'0000001C'        OPTIONS THAT MUST BE SPECIF. @D51IDMZ 05802000
         DC    X'FFFFC7E2'        OPTIONS THAT MUST NOT BE SP. @D51IDMZ 05803000
* SVA SPECIFIED                                                @D51IDMZ 05804000
         DC    X'00000004'        TEST SVA = YES OPTION        @D51IDMZ 05805000
         DC    X'00000000'        OPTIONS THAT MUST BE SPECIF. @D51IDMZ 05806000
         DC    X'FFFC47E0'        OPTIONS THAT MUST NOT BE SP. @DY44311 05807000
* LOC = BELOW SPECIFIED                                        @D51IDMZ 05808000
         DC    X'00001000'        TEST LOC = BELOW OPTION      @D51IDMZ 05809000
         DC    X'00001000'        OPTIONS THAT MUST BE SPECIF. @D51IDMZ 05810000
         DC    X'FFFFE180'        OPTIONS THAT MUST NOT BE SP. @KX40608 05811000
* LOC = ANY SPECIFIED                                          @D51IDMZ 05812000
         DC    X'00002000'        TEST LOC = ANY OPTION        @D51IDMZ 05813000
         DC    X'00002000'        OPTIONS THAT MUST BE SPECIF. @D51IDMZ 05814000
         DC    X'FFFFD180'        OPTIONS THAT MUST NOT BE SP. @KX40608 05815000
* IF NONE OF THE ABOVE OPTIONS WAS CHECKED DO THE FINAL CHECK  @D51IDMZ 05816000
         DC    X'FFFFFFFF'        TEST REMAINING OPTIONS       @D51IDMZ 05817000
         DC    X'00000000'        OPTIONS THAT MUST BE SPECIF. @D51IDMZ 05818000
         DC    X'FFFC4180'        OPTIONS THAT MUST NOT BE SP. @D51IDMZ 05819000
GTABENTN EQU   (*-GVOPTAB)/GTABENTL NO OF ENTRIES IN TABLE     @D51IDMZ 05820000
         DROP  RE                 RELEASE BASE                 @D51XDMZ 05821000
         EJECT                                                 @D51IDMZ 05822000
***************************************************************@D149DJB 05823000
*                                                              @D149DJB 05824000
*   ROUTINE TO CHECK FREEVIS OPTIONS                           @D51IDMZ 05825000
*                                                              @D51IDMZ 05826000
*   MODULE FVCHOPT                                             @D51IDMZ 05827000
*      CHECK SPECIFIED OPTIONS                                 @D51IDMZ 05828000
*      SET RETURN CODE IF OPTIONS ARE NOT VALID                @D51IDMZ 05829000
*   ENDMODULE FVCHOPT                                          @D51IDMZ 05830000
*                                                              @D51IDMZ 05831000
*     CALLED BY : FREEVIS                                      @D51IDMZ 05832000
*     CALLS     : NONE                                         @D51IDMZ 05833000
*                                                              @D51IDMZ 05834000
*     INPUT  : RD --> ADDRESS OF SAVE AREA                     @D51IDMZ 05835000
*              RE --> BASE                                     @D51IDMZ 05836000
*     OUTPUT : RF=0 (OK), RF=X'14' (INVALID OPTION)            @D64ADMZ 05837000
*     LINK   : R8                                              @D51IDMZ 05838000
*     WORK   : R1,R2,R4                                        @D51IDMZ 05839000
*                                                              @D51IDMZ 05840000
         AGO    .CREATEP                                       @D51IDMZ 05841000
.FVCHOPT ANOP                                                  @D51IDMZ 05842000
.*             0123456789ABCDEF                                @D51IDMZ 05843000
&INPREG  SETC '0000000000000110'                               @D51IDMZ 05844000
&OUTREG  SETC '0000000000000001'                               @D64ADMZ 05845000
&WRKREG  SETC '0110100000000000'                               @D51IDMZ 05846000
&NMDREG  SETC '1001011111111110'                               @D51IDMZ 05847000
&LINKR   SETC 'R8'                                             @D51IDMZ 05848000
&TBASE   SETC 'OWN'                                            @D51IDMZ 05849000
.*EXCLSYMS=()                                                  @D52VDMZ 05850000
         AGO    .TESTALL                                       @D51IDMZ 05851000
.CREATEP ANOP                                                  @D51IDMZ 05852000
***************************************************************@D51IDMZ 05853000
         SPACE 2                                               @D51IDMZ 05854000
         USING FVCHOPT,RE                                      @D51XDMZ 05855000
FVCHOPT  DS    0H                                              @D51IDMZ 05856000
*SGLINK  FVCHOPT,S,INPUT=(R8:LINK,RD),OUTPUT=(RF),                     *05857000
               WORK=(R1,R2,R4,RE),NOMODR=(R8)                           05858000
         USING SVEARA,RD          ADDRESS USER SAVE AREA       @D51IDMZ 05859000
         L     RF,SVER0F          GET SPECIFIED OPTIONS        @D51IDMZ 05860000
         LTR   R4,RF              OPTIONS SPECIFIED ?          @D51IDMZ 05861000
         BZ    FVCHRET            NO, RETURN TO CALLER         @D51IDMZ 05862000
         LA    R2,FTABENTN        GET NUMBER OF ENTRIES IN TAB.@D51IDMZ 05863000
         LA    R1,FVOPTAB         GET BEGIN OF TABLE           @D51IDMZ 05864000
FVCH0    LR    R4,RF              RESTORE SPECIFIED OPTIONS    @D51IDMZ 05865000
         N     R4,0(,R1)          GET OPTION TO BE CHECKED     @D51IDMZ 05866000
         BZ    FVCHNXT            NO, GET NEXT OPTION          @D51IDMZ 05867000
         LR    R4,RF              RESTORE OPTIONS              @D51IDMZ 05868000
         N     R4,4(,R1)          RESET OPTION NOT OF INTEREST @D51IDMZ 05869000
         BNZ   FVCHRET4           INVALID OPTIONS SPECIFIED    @D51IDMZ 05870000
FVCHNXT  LA    R1,FTABENTL(R1)    ADDRESS NEXT ENTRY IN TABLE  @D51IDMZ 05871000
         BCT   R2,FVCH0           MORE OPTIONS TO BE CHECKED ? @D51IDMZ 05872000
         LA    RF,0               NO, ALL OPTIONS VALID        @D51IDMZ 05873000
         B     FVCHRET            RETURN                       @D51IDMZ 05874000
FVCHRET4 LA    RF,SMERR14         INDICATE INVALID OPTION      @D64ADMZ 05875000
FVCHRET  BR    R8                 RETURN TO CALLER             @D51IDMZ 05876000
         DROP  RD                                              @D51IDMZ 05877000
FVOPTAB  DS    0H                 FREEVIS OPTION TABLE         @D51IDMZ 05878000
* SPACE = YES                                                  @D51IDMZ 05879000
         DC    X'00000200'        TEST SPACE=YES OPTION        @D51IDMZ 05880000
         DC    X'FFFFFDFD'        OPTIONS THAT MUST NOT BE SP. @D51IDMZ 05881000
FTABENTL EQU   *-FVOPTAB          LENGTH OF ONE ENTRY          @D51IDMZ 05882000
* FREEVIS ALL SPECIFIED                                        @D51IDMZ 05883000
         DC    X'00000008'        TEST ALL OPTION              @D51IDMZ 05884000
         DC    X'FFFFFFF7'        NO OTHER OPTIONS ARE ALLOWED @D51IDMZ 05885000
* SVA = YES                                                    @D51IDMZ 05886000
         DC    X'00000004'        TEST SVA=YES OPTION          @D51IDMZ 05887000
         DC    X'FFFFFFF9'        OPTIONS THAT MUST NOT BE SP. @D51IDMZ 05888000
* SUBPOOL SPECIFIED                                            @D51IDMZ 05889000
         DC    X'00000002'        TEST SUBPOOL OPTION          @D51IDMZ 05890000
         DC    X'FFFFFDF9'        OPTIONS THAT MUST NOT BE SP. @D51IDMZ 05891000
* ALL OTHER OPTIONS                                            @D51IDMZ 05892000
         DC    X'FFFFFFFF'        TEST REMAINING OPTIONS       @D51IDMZ 05893000
         DC    X'FFFFFDF1'        OPTIONS THAT MUST NOT BE SP. @D51IDMZ 05894000
FTABENTN EQU   (*-FVOPTAB)/FTABENTL NO OF ENTRIES IN TABLE     @D51IDMZ 05895000
         DROP  RE                 RELEASE BASE                 @D51XDMZ 05896000
         EJECT                                                 @D51IDMZ 05897000
*********************************************************************** 05898000
*                                                                       05899000
*   FVUPCPTR : FREEVIS UPDATE CURRENT POINTER ROUTINE          @D51XDMZ 05900000
*                                                                       05901000
*      MODULE FVUPCPTR:                                        @D51XDMZ 05902000
*         IF SUBPOOL EMPTY THEN                                @D51XDMZ 05903000
*            RETURN (CURRENT POINTERS ARE ALREADY UPDATED)     @D51XDMZ 05904000
*         IF CURRENT POINTER IS BELOW FREED AREA THEN          @D51XDMZ 05905000
*            RETURN                                            @D51XDMZ 05906000
*         IF PAGE WHERE FREED AREA STARTS IS NOT EMPTY THEN    @D51XDMZ 05907000
*            UPDATE CURRENT POINTER (GAP CREATED IN FIRST PAGE)@D51XDMZ 05908000
*            RETURN                                            @D51XDMZ 05909000
*         IF PAGE WHERE FREED AREA ENDS IS NOT EMPTY THEN      @D51XDMZ 05910000
*            UPDATE CURRENT POINTER (GAP CREATED LAST PAGE)    @D51XDMZ 05911000
*            RETURN                                            @D51XDMZ 05912000
*         IF START PAGE AND END PAGE ARE EMPTY AND THE CURRENT @D51XDMZ 05913000
*            POINTER POINTS TO A PAGE BEHIND THE END PAGE THEN @D51XDMZ 05914000
*              RETURN                                          @D51XDMZ 05915000
*         IF THE CURRENT POINTER POINTER IS WITHIN THE FREED   @D51XDMZ 05916000
*            AREA THEN                                         @D51XDMZ 05917000
*             UPDATE CURRENT POINTER                           @D51XDMZ 05918000
*             (CURRENT POINTER POINTS TO THE FIRST GAP WITHIN  @D51XDMZ 05919000
*              THE FOLLOWING PAGE. IF NOT PAGE IS FOLLOWING    @D51XDMZ 05920000
*              TAKE PAGE BEFORE FREED ARAE (NO GAP)            @D51XDMZ 05921000
*      ENDMODULE FVUPCPTR                                      @D51XDMZ 05922000
*                                                                       05923000
*   CALLED BY : FVCHKEPG                                       @D51XDMZ 05924000
*   CALLS     : NONE                                           @D51XDMZ 05925000
*                                                              @D51XDMZ 05926000
*   INPUT    R5 --> SUBPOOL INDEX TABLE ENTRY                  @D51XDMZ 05927000
*            RB  :  SVA(SPACE)/PARTITION INDICATOR             @D51XDMZ 05928000
*            RC --> ANCHOR TABLE                               @D51XDMZ 05929000
*            RE --> BASE REGISTER                              @D51XDMZ 05930000
*                                                              @D51XDMZ 05931000
*       SAVREG3 --> CHAIN TABLE ENTRY TO PAGE WHERE FREED AREA @D51XDMZ 05932000
*                   BEGINS                                     @D51XDMZ 05933000
*       SAVREG9 --> CHAIN TABLE ENTRY TO PAGE WHERE FREED AREA @D51XDMZ 05934000
*                   ENDS                                       @D51XDMZ 05935000
*       SAVREG2 --> SAVREG3.SPCHBACK                           @D51XDMZ 05936000
*                                                              @D51XDMZ 05937000
*   OUTPUT : RF  : 0                                           @D51XDMZ 05938000
*   WORK   : R1,R4                                             @D52VDMZ 05939000
*   LINK   : R8                                                @D51XDMZ 05940000
*                                                              @D51XDMZ 05941000
         AGO    .CREATER                                       @D51XDMZ 05942000
.FVUPCPT ANOP                                                  @D51XDMZ 05943000
.*             0123456789ABCDEF                                @D51XDMZ 05944000
&INPREG  SETC '0000010000011010'                               @D51XDMZ 05945000
&OUTREG  SETC '0000000000000001'                               @D51XDMZ 05946000
&WRKREG  SETC '0100100000000000'                               @D51XDMZ 05947000
&NMDREG  SETC '1011011111111110'                               @D51XDMZ 05948000
&LINKR   SETC 'R8'                                             @D51XDMZ 05949000
&TBASE   SETC 'OWN'                                            @D51XDMZ 05950000
.*EXCLSYMS=()                                                  @D52VDMZ 05951000
         AGO    .TESTALL                                       @D51XDMZ 05952000
.CREATER ANOP                                                  @D51XDMZ 05953000
*                                                              @D51XDMZ 05954000
*********************************************************************** 05955000
         SPACE 3                                                        05956000
         USING ANCHTAB,RC                                      @D51XDMZ 05957000
         USING SUBPINT,R5                                      @D51XDMZ 05958000
         USING FVUPCPTR,RE                                     @D51XDMZ 05959000
FVUPCPTR DS    0H                 UPDATE CURRENT POINTER       @D51XDMZ 05960000
*SGLINK  FVUPCPTR,S,INPUT=(R5,R8:LINK,RB,RC),OUTPUT=(RF),              *05961000
               WORK=(R1,R4,RE),NOMODR=(R8)                              05962000
         L     R4,SPITFRST        IF SUBPOOL IS EMPTY, THE     @D51XDMZ 05963000
         LTR   R4,R4              CURRENT POINTER IS ALR. SET  @D51XDMZ 05964000
         BM    FVUPCPTE           SUBPOOL IS EMPTY => EXIT     @D51XDMZ 05965000
         L     R1,SAVREG3         RESTORE FIRST PAGE CHAIN ENT.@D51XDMZ 05966000
         C     R1,SPITCURP        FIRST POSSIBLE GAP BELOW     @D51XDMZ 05967000
         BH    FVUPCPTE           FREED AREA = > NO UPDATE     @D51XDMZ 05968000
* GET NUMBER OF VISTAB BYTES PER PAGE                          @D51XDMZ 05969000
         LTR   RB,RB              PARTITION REQUEST            @D51XDMZ 05970000
         BZ    FVUPCP00           YES                          @D51XDMZ 05971000
         LA    RF,SVBYTPPG        NO OF BYTES/SVA(SPACE) PAGE  @D51XDMZ 05972000
         B     FVUPCP05           YES                          @D51XDMZ 05973000
FVUPCP00 LA    RF,PABYTPPG        NO OF BYTES/PARTITON PAGE    @D51XDMZ 05974000
FVUPCP05 DS    0H                                              @D51XDMZ 05975000
         BCTR  RF,0               NO OF VISTAB BYTES - 1       @D51XDMZ 05976000
*                                                              @D51XDMZ 05977000
* SPITCURP >= R1                                               @D51XDMZ 05978000
* IF FIRST PAGE IS NOT EMPTY, THEN UPDATE CURRENT POINT        @D51XDMZ 05979000
* IF LAST PAGE IS NOT EMPTY, THEN UPDATE CURRENT POINT         @D51XDMZ 05980000
*                                                              @D51XDMZ 05981000
         TM    SPITFLG1,SPFPEMTY  FIRST PAGE EMPTY             @D51XDMZ 05982000
         BZ    FVUPCP30           NO => UPDATE                 @D51XDMZ 05983000
         TM    SPITFLG1,SPLPEMTY  LAST PAGE EMPTY              @D51XDMZ 05984000
         BO    FVUPCP10           YES                          @D51XDMZ 05985000
         L     R1,SAVREG9         RESTORE LAST PAGE CHAIN ENT. @D51XDMZ 05986000
         B     FVUPCP30           => UPDATE CURRENT POINTER    @D51XDMZ 05987000
FVUPCP10 DS    0H                 FIRST AND LAST PAGE EMPTY    @D51XDMZ 05988000
         L     R4,SAVREG9         RESTORE LAST PAGE CHAIN ENT. @D51XDMZ 05989000
*                                                              @D51XDMZ 05990000
* FIRST AND LAST PAGE ARE EMPTY (AND ENQUEUED IN PAGE POOL)    @D51XDMZ 05991000
*  IF R4 < SPITCURP THEN                                       @D51XDMZ 05992000
*    NO UPDATE (NO GAP CREATED, CURRENT PTR BEHIND FREED AREA) @D51XDMZ 05993000
*  ELSE                                                        @D51XDMZ 05994000
*   ** R1<= SPITCURP <=R4,I.E. CURRENT PTR WITHIN FREED AREA   @D51XDMZ 05995000
*   ** SINCE SUBPOOL IS NOT EMPTY, EITHER FOLLOWING OR PREVIOUS@D51XDMZ 05996000
*   ** PAGE EXISTS                                             @D51XDMZ 05997000
*    IF FOLLOWING PAGE EXISTS THEN                             @D51XDMZ 05998000
*       SPITCURP = R4.SPCHFORW                                 @D51XDMZ 05999000
*       UPDATE SPITRLVB,SPITBITO                               @D51XDMZ 06000000
*    ELSE                                                      @D51XDMZ 06001000
*       SPITCURP = R1.SPCHBACK                                 @D51XDMZ 06002000
*       UPDATE SPITRLVB,SPITBITO                               @D51XDMZ 06003000
*                                                              @D51XDMZ 06004000
         C     R4,SPITCURP        SPITCURP BEHIND FREED AREA   @D51XDMZ 06005000
         BL    FVUPCPTE           YES, NO UPDATE NECESSARY     @D51XDMZ 06006000
         L     R4,SAVREG2         RESTORE OLD BACKWARD PTR     @D51XDMZ 06007000
         USING SUBPCHN,R4         ADDRESS LAST PAGE CHAIN ENTRY@D51XDMZ 06008000
         L     R1,SPCHFORW                                     @D51XDMZ 06009000
         DROP  R4                                              @D51XDMZ 06010000
         C     R1,SPITCURP        DOES FOLLOWING PAGE EXIST ?  @D51XDMZ 06011000
         BH    FVUPCP30           YES, UPDATE CURRENT POINTER  @D51XDMZ 06012000
         ST    R4,SPITCURP        SET CURRENT PTR BACK         @D51XDMZ 06013000
* NO GAP POSSIBLE BEFORE OLD CURRENT POINTER                   @D51XDMZ 06014000
         STC   RF,SPITRLVB        REL.PAGE VISTAB OFFSET       @D51XDMZ 06015000
         MVI   SPITBITO,XFF       BIT MASK OF REL.PAGE VIST.PTR@D51XDMZ 06016000
         B     FVUPCPTE           ===> EXIT                    @D51XDMZ 06017000
FVUPCP30 DS    0H                 UPDATE CURRENT POINTER       @D51XDMZ 06018000
*                                                              @D51XDMZ 06019000
*  INPUT : R1 : NEW CURRENT PAGE CHAIN ENTRY                   @D51XDMZ 06020000
*        : RF : NO OF VISTAB BYTES PER PAGE - 1                @D51XDMZ 06021000
         ST    R1,SPITCURP        SET NEW SPITCURP             @D51XDMZ 06022000
*  FIND FIRST BYTE WITH FREE BIT                               @D51XDMZ 06023000
         USING SUBPCHN,R1                                      @D51XDMZ 06024000
         L     R1,SPCHVSTB        GET VISTAB START ADDRESS ..  @D51XDMZ 06025000
         A     R1,BVISTAB         ... OF NEW CURRENT PAGE      @D51XDMZ 06026000
         DROP  R1                                              @D51XDMZ 06027000
         SR    R4,R4              CLEAR FOR LOOP               @D51XDMZ 06028000
FVUPCP40 DS    0H                 FIND FIRST BYTE WITH FREE BIT@D51XDMZ 06029000
         TM    D0(R1),XFF         IS A FREE BIT WITHIN THE BYTE@D51XDMZ 06030000
         BNO   FVUPCP50           YES                          @D51XDMZ 06031000
         LA    R4,1(R4)           INCREASE BYTE COUNTER        @D51XDMZ 06032000
         LA    R1,1(R1)           ADDRESS NEXT BYTE            @D51XDMZ 06033000
         BCT   RF,FVUPCP40        CHECK NEXT BYTE              @D51XDMZ 06034000
FVUPCP50 DS    0H                 FIND FIRST FREE BIT IN BYTE  @D51XDMZ 06035000
         STC   R4,SPITRLVB        REL. PAGE VISTAB OFFSET      @D51XDMZ 06036000
         SR    RF,RF                                           @D51XDMZ 06037000
         TM    0(R1),XFF          ALL BITS '1' ?               @D51XDMZ 06038000
         BO    FVUPCP70           YES                          @D51XDMZ 06039000
         BZ    FVUPCP90           ALL BITS '0'                 @D51XDMZ 06040000
         SR    R4,R4              CLEAR FOR INSERT             @D51XDMZ 06041000
         IC    R4,D0(R1)          GET BYTE FROM VISTAB         @D51XDMZ 06042000
         SLA   R4,BITREG-BITBYT-1 SHIFT INTO CORRECT POSITION  @D51XDMZ 06043000
FVUPCP60 DS    0H                 SEARCH FIRST ZERO BIT        @D51XDMZ 06044000
         SLA   R4,D1              SHIFT LEFT TO TEST OVERFLOW  @D51XDMZ 06045000
         BNO   FVUPCP80           '0' BIT FOUND                @D51XDMZ 06046000
         LA    RF,1(RF)           COUNT # OF SHIFTS            @D51XDMZ 06047000
         B     FVUPCP60           CONTINUE LOOP                @D51XDMZ 06048000
FVUPCP70 DS    0H                 FIND FIRST FREE BIT IN BYTE  @D51XDMZ 06049000
         LA    RF,BITBYT          NO OF BITS PER BYTE          @D51XDMZ 06050000
FVUPCP80 DS    0H                 R0=NO OF '1' BITS            @D51XDMZ 06051000
         LA    R4,BITBYT          COMPUTE COMPLEMENT ..        @D51XDMZ 06052000
         SR    R4,RF              .. OF BIT VALUE              @D51XDMZ 06053000
         L     RF,ADDRMASK        GET DUMMY MASK               @D51XDMZ 06054000
         SLL   RF,D0(R4)          EVALUATE CURRENT BIT MASK    @D51XDMZ 06055000
FVUPCP90 STC   RF,SPITBITO        STORE NEW BIT MASK           @D51XDMZ 06056000
FVUPCPTE DS    0H                 EXIT PROCESSING              @D51XDMZ 06057000
         SR    RF,RF                                           @D51XDMZ 06058000
         BR    R8                 RETURN TO CALLER             @D51XDMZ 06059000
         DROP  R5                 RELEASE SUBPOOL INDEX TABLE  @D51XDMZ 06060000
         DROP  RC                 RELEASE ANCHOR TABLE         @D51XDMZ 06061000
         DROP  RE                 RELEASE BASE                 @D51XDMZ 06062000
         EJECT                                                 @D51XDMZ 06063000
*********************************************************************** 06064000
*                                                                       06065000
*   GVXPART  : IMPLEMENTS BOUNDARY X-ING PER PART                       06066000
*                                                                       06067000
*              THE ROUTINE IS CALLED TWICE. FOR EACH SUBREQUEST         06068000
*              IT TRIES TO ALLOCATE THE REQUESTED SIZE AT THE           06069000
*              END OF THE PART                                          06070000
*                                                                       06071000
*      MODULE GVXPART                                                   06072000
*             CALCULATE MAXIMUM NUMBER OF PAGES NEEDED AT THE END       06073000
*                       OF THE PART (=N)                                06074000
*             IF THEY ARE ALL ON THE FREE_QUEUE THE USE THEM            06075000
*             ELSE                                                      06076000
*             IF N-1 PAGES ARE ON THE FREE_QUEUE THEN                   06077000
*                       THE NTH PAGE MUST BE THE LAST OF THE SUBPOOL    06078000
*                       AND IT MUST HAVE ENOUGH FREE SPACE AT ITS END   06079000
*                       OR THE REQUEST FAILS                            06080000
*      ENDMODULE GVXPART                                                06081000
*                                                                       06082000
*   CALLED BY : GVXING, FVXING                                          06083000
*   CALLS     : GVGETPAG, GFENQDEQ, GVSCVSTB, SETVSTAB, GVPFIXSV        06084000
*                                                                       06085000
*   INPUT    R2 --> SUBPOOL INDEX TABLE ENTRY                           06086000
*            RA --> TCBPTR                                              06087000
*            RB --> SVA(SPACE)/PARTITION INDICATOR                      06088000
*            RC --> ANCHOR TABLE                                        06089000
*            RD --> CALLER'S SAVE AREA                                  06090000
*            RE --> BASE REGISTER                                       06091000
*        SVER00 --> REQUESTED LENGTH FOR THIS SUBREQUEST                06092000
*                   ROUNDED T MULTIPLES OF THE ALLOCATION UNIT          06093000
*                                                                       06094000
*   OUTPUT : RF  : RETURN CODE                                          06095000
*        SVER01  : START ADDRESS OF ALLOCATED AREA                      06096000
*   WORK   : R0,R1,R3,R4,R5,R8,R9                                       06097000
*   LINK   : R7                                                         06098000
*                                                                       06099000
         AGO    .CREATEU                                       @D52VDKH 06100000
.GVXPART ANOP                                                  @D52VDKH 06101000
.*             0123456789ABCDEF                                         06102000
&INPREG  SETC '0010000000111110'                               @D52VDKH 06103000
&OUTREG  SETC '0000000000000001'                               @D52VDKH 06104000
&WRKREG  SETC '1101110011000000'                               @D52VDMZ 06105000
&NMDREG  SETC '0010001100111110'                               @D52VDMZ 06106000
&LINKR   SETC 'R7'                                             @D52VDKH 06107000
&TBASE   SETC 'OWN'                                            @D52VDKH 06108000
.*EXCLSYMS=(SAVR3RD7)                                          @D52VDMZ 06109000
         AGO    .TESTALL                                       @D52VDKH 06110000
.CREATEU ANOP                                                  @D52VDKH 06111000
*                                                                       06112000
*********************************************************************** 06113000
         SPACE 3                                                        06114000
         USING ANCHTAB,RC                                      @D52VDKH 06115000
         USING SVEARA,RD                                       @D52VDKH 06116000
         USING SUBPINT,R2                                      @D52VDKH 06117000
         USING GVXPART,RE                                      @D52VDKH 06118000
GVXPART  DS    0H                 ENTRY POINT                  @D52VDKH 06119000
*SGLINK  GVXPART,S,INPUT=(R2,R7:LINK,RA,RB,RC,RD),OUTPUT=(RF),         *06120000
               WORK=(R0,R1,R3-R5,R8,R9,RE,RF),NOMODR=(R7),             *06121000
               AMODE=31,MODSYM=(SAVR3RD7),                             *06122000
               SUBROUT=(GTVSINI3:IGN(R7,RB),                           *06123000
               GVGETPAG,GFENQDEQ,GVSCVSTB,GVUPPIE0,SETVSTAB:IGN(R2))    06124000
*************************************************************           06125000
* PREPARE TO GET PAGES FROM FREE_QUEUE                                  06126000
*                                                                       06127000
*        OUTPUT :                                                       06128000
*               R3 = FIRST PAGE TO GET FROM FREE_QUEUE                  06129000
*               R4 = NO. OF PAGES NEEDED FROM FREE_QUEUE                06130000
*               RF = 0                                                  06131000
*************************************************************           06132000
         SLR   RF,RF              CLEAR RETURN CODE            @D52VDKH 06133000
         L     R4,SVER00          SIZE FOR SUBREQUEST          @D52VDKH 06134000
         A     R4,PAGESIZE        CONVERT TO MAXIMUM NUMBER    @D52VDKH 06135000
         BCTR  R4,0               OF PAGES NEEDED              @D52VDKH 06136000
         SRL   R4,PNSHIFT                                      @D52VDKH 06137000
         L     R3,ESUBPCHN        LAST PAGE IN STORAGE         @D52VDKH 06138000
         LR    R1,R4              NO OF PAGES                  @D52VDKH 06139000
         BCTR  R1,0               -1                           @D52VDKH 06140000
         SLL   R1,SUBPCHN2        X LENGTH OF CHAIN TABLE ENTRY@D52VDKH 06141000
         SR    R3,R1                                           @D52VDKH 06142000
         C     R3,BSUBPCHN        WITHIN VALID AREA ?          @D52VDKH 06143000
         BL    GVXPEROR           NO WAY ...                   @D52VDKH 06144000
         LR    R8,RB                                           @D52VDKH 06145000
         LA    RB,3               SWITCH SUBPOOL INFO          @D52VDKH 06146000
         LR    R5,R2                                           @D52VDKH 06147000
         ST    R7,SAVR3RD7        SAVE RETURN ADDRESS          @D52VDKH 06148000
*SGLINK  GTVSINI3,INPUT=(R5,R7:LINK,RB,RC),NOMODS=(SAVR3RD7),          *06149000
               NOMODR=(R2,R3,R4,R6,R8,RA,RC,RD,RF),AMODE=31             06150000
         SGAMSUBR SUBROUT=GTVSINI3,                            @D14CDJB*06151000
               INPUT=(R5,RB,RC,RE),                            @D52VDMZ*06152000
               NOMOD=(R2,R3,R4,R6,R8,RA,RC,RD,RF),             @D52VDMZ*06153000
               IGN=(RB),                                       @D52VDMZ*06154000
               LINK=(R7),                                      @D14CDJB*06155000
               NOMODS=(SAVR3RD7),                              @D52VDMZ*06156000
               CBASE=OWN,         INITIALIZE GETVIS AREA       @D51IDKH*06157000
               SUBROUC=GVXPART                                 @D52VDKH 06158000
         L     R7,SAVR3RD7        SAVE RETURN ADDRESS          @D52VDKH 06159000
         LR    RB,R8                                           @D52VDKH 06160000
         USING SUBPCHN,R3                                      @D52VDKH 06161000
         CLC   SPCHNMBR,XFFFF     IS THIS PAGE UNUSED ?        @D52VDKH 06162000
         BNE   GVXPUSED           NO, SEE IF IT CAN BE USED    @D52VDKH 06163000
         DROP  R3                                              @D52VDKH 06164000
GVXPGETM EQU   *                                               @D52VDKH 06165000
*************************************************************           06166000
* GET PAGES FROM FREE_QUEUE                                             06167000
*                                                                       06168000
*        INPUT  :                                                       06169000
*               R3 = FIRST PAGE TO GET FROM FREE_QUEUE                  06170000
*               R4 = NO. OF PAGES NEEDED FROM FREE_QUEUE                06171000
*        OUTPUT :                                                       06172000
*               R3 = FIRST PAGE GOTTEN FROM FREE_QUEUE                  06173000
*               R5 = POINTER TO FREE_QUEUE                              06174000
*               R9 = LAST PAGE GOTTEN FROM FREE_QUEUE                   06175000
*               RF = RC                                                 06176000
*************************************************************           06177000
*SGLINK  GVGETPAG,INPUT=(R3,R4,R8:LINK,RC,RD,RF),OUTPUT=(R3,R5,R9,RF), *06178000
               NOMODR=(R2,R4,R6,R7,RA-RC,RD),AMODE=31                   06179000
         SGAMSUBR SUBROUT=GVGETPAG,                            @D52VDKH*06180000
               INPUT=(R3,R4,RC,RD,RF),                         @D52VDKH*06181000
               OUTPUT=(R3,R5,R9,RF),                           @D52VDKH*06182000
               NOMOD=(R2,R4,R6,R7,RB,RC,RD),                   @D52VDKH*06183000
               LINK=(R8),                                      @D52VDKH*06184000
               CBASE=OWN,         SCAN SUBPOOL 0 FOR PAGE(S)   @D52VDKH*06185000
               SUBROUC=GVXPART                                 @D52VDKH 06186000
         LTR   RF,RF              PAGES FOUND ?                @D52VDKH 06187000
         BNZ   GVXPEROR           NO, ERROR                    @D52VDKH 06188000
*************************************************************           06189000
* ENQUEU PAGES INTO SUBPOOL                                             06190000
*                                                                       06191000
*        INPUT  :                                                       06192000
*               R2 = SUBPOOL INDEX (ENQ)                                06193000
*               R3 = FIRST PAGE TO GET FROM FREE_QUEUE                  06194000
*               R4 = NO. OF PAGES NEEDED FROM FREE_QUEUE                06195000
*               R5 = FREEQ_QUEUE POINTER (DEQ)                          06196000
*               R9 = LAST PAGE TO GET FROM FREE_QUEUE                   06197000
*        OUTPUT :                                                       06198000
*               R4 = UNDEFINED                                          06199000
*               R5 = FIRST PAGE FROM FREE_QUEUE (R3)                    06200000
*               RF = 0                                                  06201000
*************************************************************           06202000
*SGLINK  GFENQDEQ,INPUT=(R2,R3,R4,R5,R8:LINK,R9,RC),OUTPUT=(RF),       *06203000
               NOMODR=(R2,R3,R6,R7,R9,RA-RC,RD),AMODE=31                06204000
         SGAMSUBR SUBROUT=GFENQDEQ,                            @D52VDKH*06205000
               INPUT=(R2,R3,R4,R5,R9,RC),                      @D52VDKH*06206000
               OUTPUT=(RF),                                    @D52VDKH*06207000
               NOMOD=(R2,R3,R6,R7,R9,RB,RC,RD),                @D52VDKH*06208000
               LINK=(R8),                                      @D52VDKH*06209000
               CBASE=OWN,                                      @D52VDKH*06210000
               SUBROUC=GVXPART                                 @D52VDKH 06211000
GVXPNOPG DS    0H                                              @D52VDKH 06212000
         L     R4,SVER00          SIZE FOR SUBREQUEST          @D52VDKH 06213000
         LR    R0,R4              R0 TO CONTAIN SIZE OF        @D52VDKH 06214000
         BCTR  R4,0               -1                           @D52VDKH 06215000
         SRA   R0,LDVBYTBI(RB)    SUBREQUEST IN NUMBER OF      @D52VDKH 06216000
         LNR   R4,R4                                           @D52VDKH 06217000
         A     R4,EVIRTMEM        START ADDRESS FOR SUBREQUEST @D52VDKH 06218000
         S     R4,BVIRTMEM        RELATIVE ...                 @D52VDKH 06219000
         LR    R1,R4              SAVE IT                      @D52VDKH 06220000
         SRL   R1,PNSHIFT         PAGE OFFSET IN GETVIS AREA   @D52VDKH 06221000
         SLL   R1,SUBPCHN2                                     @D52VDKH 06222000
         A     R1,BSUBPCHN        PAGE CHAIN TABLE ENTRY       @D52VDKH 06223000
         SLR   R5,R5                                           @D52VDKH 06224000
         SRDA  R4,LDVBYTB(RB)     BYTE OFFSET IN VISTAB        @D52VDKH 06225000
         USING SUBPCHN,R1                                      @D52VDKH 06226000
         S     R4,SPCHVSTB        GET RELATIVE OFFSET IN  PAGE @D52VDKH 06227000
         DROP  R1                                              @D52VDKH 06228000
         LR    RF,R4              AND STORE IT                 @D52VDKH 06229000
         SRL   R5,BITREG-(LDVBYTB-LDVBYTBI)  BIT DISPLACEMENT  @D52VDKH 06230000
         LA    R4,XFF                                          @D52VDKH 06231000
         LA    R8,8               GET BIT MASK FOR 1ST BYTE    @D52VDKH 06232000
         SR    R8,R5              (CURPOINT) IN LOW ORDER BYTE @D52VDKH 06233000
         SLL   R4,D0(R8)          OF R4 WITH OCCUPIED BITS ON  @D52VDKH 06234000
         LR    R3,R4              AND STORE IT                 @D52VDKH 06235000
         LR    R5,R1              START SEARCH HERE            @D52VDKH 06236000
*************************************************************           06237000
* SCAN VISTAB FOR FREE STORAGE                                          06238000
*                                                                       06239000
*        INPUT  :                                                       06240000
*               R0 = REQUESTED LENGTH IN VISTAB BITS                    06241000
*               R3 = BIT OFFSET TO START SEARCH                         06242000
*               R5 = PAGE TO START SEARCH                               06243000
*               R9 = PAGE TO END SEARCH                                 06244000
*        OUTPUT :                                                       06245000
*               R1 = LAST SCANNED VISTAB BYTE                           06246000
*               R3 = BIT OFFSET IN ABOVE BYTE                           06247000
*               R4 = REQUESTED SPACE (ADDR)                             06248000
*               RF = RC                                                 06249000
*************************************************************           06250000
GVXPSCAN DS    0H                                              @D52VDKH 06251000
*SGLINK  GVSCVSTB,INPUT=(R0,R3,R5,R8:LINK,R9,RB,RC,RF),OUTPUT=(R1,R3,  *06252000
               R4,RF),NOMODR=(R0,R2,R6,R7,R9,RA-RC,RD),AMODE=31         06253000
         SGAMSUBR SUBROUT=GVSCVSTB,                            @D52VDKH*06254000
               INPUT=(R0,R3,R5,R9,RB,RC,RF),                   @D52VDKH*06255000
               OUTPUT=(R1,R3,R4,RF),                           @D52VDKH*06256000
               NOMOD=(R0,R2,R6,R7,R9,RB,RC,RD),                @D52VDKH*06257000
               LINK=(R8),                                      @D52VDKH*06258000
               CBASE=OWN,                                      @D52VDKH*06259000
               SUBROUC=GVXPART                                 @D52VDKH 06260000
         LTR   RF,RF              SPACE FOUND ?                @D52VDKH 06261000
         BNZ   GVXPDEQU           NO  ===>                     @D52VDKH 06262000
         ST    R9,GTVSHIGH        STORE NEW HIGH WATER MARK    @D52VDKH 06263000
         SR    R9,R9              SET INDICATOR FOR GVUPPI     @D52VDKH 06264000
         L     R8,SPITCURP        IF SUBPOOL WAS EMPTY BEFORE  @D52VDKH 06265000
         LTR   R8,R8              SET UP CURRENT POINTER TO    @D52VDKH 06266000
         BNM   GVXPUPPI                                        @D52VDKH 06267000
         ST    R5,SPITCURP        FIRST PAGE                   @D52VDKH 06268000
GVXPUPPI EQU   *                                               @D52VDKH 06269000
.* WHEN CALLED AFTER GFENQDEQ, R1 IS NOT SET. IT MUST BE CODED          06270000
.* BECAUSE OF SYNTAX CHECKING                                           06271000
*SGLINK  GVUPPIE0,INPUT=(R1,R2,R3,R4,R8:LINK,R9,RB,RC,RD,RF),          *06272000
               OUTPUT=(R0,R1,R3,RF),NOMODR=(R2,R6,R7,RA-RC,RD),AMODE=31 06273000
         SGAMSUBR SUBROUT=GVUPPIE0,                            @D52VDKH*06274000
               INPUT=(R1,R2,R3,R4,R9,RB,RC,RD,RF),             @D52VDKH*06275000
               OUTPUT=(R0,R1,R3,RF),                           @D52VDKH*06276000
               NOMOD=(R2,R6,R7,RB,RC,RD),                      @D52VDKH*06277000
               LINK=(R8),                                      @D52VDKH*06278000
               CBASE=OWN,                                      @D52VDKH*06279000
               SUBROUC=GVXPART                                 @D52VDKH 06280000
         ST    R2,SAVR3RD7        SAVE INDEX TABLE ADDRESS     @D52VDKH 06281000
*SGLINK  SETVSTAB,INPUT=(R0,R1,R3,R8:LINK,RC),                         *06282000
               NOMODR=(R6,R7,RA-RC,RD),AMODE=31,NOMODS=(SAVR3RD7)       06283000
         SGAMSUBR SUBROUT=SETVSTAB,                            @D52VDKH*06284000
               INPUT=(R0,R1,R3,RC),                            @D52VDKH*06285000
               NOMOD=(R6,R7,RB,RC,RD),                         @D52VDKH*06286000
               IGN=(R2),                                       @D52VDMZ*06287000
               LINK=(R8),                                      @D52VDKH*06288000
               NOMODS=(SAVR3RD7),                              @D52VDMZ*06289000
               CBASE=OWN,                                      @D52VDKH*06290000
               SUBROUC=GVXPART                                 @D52VDKH 06291000
         L     R2,SAVR3RD7        RESTORE SUBPOOL INDEX        @D52VDKH 06292000
         SLR   RF,RF              CLEAR RETURN CODE            @D52VDKH 06293000
         TM    GVFVFLGS,GVCHKPRO  NEW PAGES ENQUEUED ?         @D64ADMZ 06294000
         BZR   R7                 NO, SKIP PROTECTION CHECK    @D64ADMZ 06295000
         ST    R7,SAVR3RD7        SAVE LINK REGISTER           @D64ADMZ 06296000
         ST    R2,SAVR3RDF        SAVE SUBPOOL ENTRY           @D64ADMZ 06297000
*SGLINK  GVPROT,INPUT=(R7:LINK,RA-RD),OUTPUT=(RF),                     *06298000
               NOMODR=(R6,RA,RB,RC,RD)                                  06299000
         SGAMSUBR SUBROUT=GVPROT,                              @D64ADMZ*06300000
               INPUT=(RC,RD,RE),                               @D64ADMZ*06301000
               OUTPUT=(RF),                                    @D64ADMZ*06302000
               NOMOD=(R6,RA,RB,RC,RD),                         @D64ADMZ*06303000
               LINK=(R7),                                      @D64ADMZ*06304000
               CBASE=OWN,                                      @D64ADMZ*06305000
               SUBROUC=GVXPART                                 @D52VDKH 06306000
         L     R7,SAVR3RD7        RESTORE LINK REGISTER        @D64ADMZ 06307000
         L     R2,SAVR3RDF        RESTORE SUBPOOL ENTRY        @D64ADMZ 06308000
         BR    R7                 RETURN                       @D52VDKH 06309000
GVXPUSED DS    0H                                              @D52VDKH 06310000
*************************************************************           06311000
* PAGE TO START SEARCH ON IS NOT ON FREE_QUEUE                          06312000
*      MUST BELONG TO SUBPOOL THEN                                      06313000
*      NO USE IF REQUEST FOR PAGE BOUNDARY ALIGNMENT                    06314000
*************************************************************           06315000
         TM    GVFVFLGS,GVFVABVE  PAGE ALIGNMENT NOT RELEVANT  @D52VDKH 06316000
         BO    GVXPSIZE           IN ABOVE PART BUT            @D52VDKH 06317000
         TM    SVER0F+3,PAGEIND   PAGE BDY ALIGNMENT REQ'D ?   @D52VDKH 06318000
         BO    GVXPEROR           PROHIBITING IN BELOW PART    @D52VDKH 06319000
GVXPSIZE DS    0H                                              @D52VDKH 06320000
         USING SUBPCHN,R3                                      @D52VDKH 06321000
         CLC   SPCHNMBR,SPITNMBR  DOES PAGE BELONG TO SUBPOOL? @D52VDKH 06322000
         BNE   GVXPEROR           NO, THAT'S IT                @D52VDKH 06323000
         LR    R9,R3              LAST  PAGE FOR GVSCVSTB      @D52VDKH 06324000
         LA    R3,SUBPCHNL(,R3)   FIRST PAGE FOR GVGETPAG      @D52VDKH 06325000
         BCT   R4,GVXPCHEK        NO OF PAGES TO GET           @D52VDKH 06326000
         B     GVXPNOPG           SCAN LAST PAGE OF SUBPOOL    @D52VDKH 06327000
GVXPCHEK DS    0H                                              @D52VDKH 06328000
         CLC   SPCHNMBR,XFFFF     IS THIS PAGE UNUSED ?        @D52VDKH 06329000
         BE    GVXPGETM           YES, GET NEEDED PAGES        @D52VDKH 06330000
         DROP  R3                                              @D52VDKH 06331000
GVXPEROR EQU   *                                               @D52VDKH 06332000
* FIND MAXIMUM NUMBER OF FREE PAGES AT END OF BELOW AREA                06333000
         LA    R1,SUBPCHNL        LENGTH OF A PAGE CHAIN ENTRY @D64ADMZ 06334000
         L     R3,ESUBPCHN        LAST PAGE OF BELOW PART      @D64ADMZ 06335000
         USING SUBPCHN,R3                                      @D64ADMZ 06336000
GVXPEROR_1 DS  0H                                              @D64ADMZ 06337000
         CLC   SPCHNMBR,XFFFF     IS THIS PAGE FREE ?          @D64ADMZ 06338000
         BNE   GVXPEROR_3         NO, ==>                      @D64ADMZ 06339000
         C     R3,BSUBPCHN        ALL PAGES FROM BELOW CHECKED?@D64ADMZ 06340000
         BNE   GVXPEROR_2         CONTINUE CHECK BELOW         @D64ADMZ 06341000
         SLR   R3,R1              POINT TO END OF BELOW CHAIN  @D64ADMZ 06342000
         B     GVXPEROR_3                                      @D64ADMZ 06343000
GVXPEROR_2 DS  0H                                              @D64ADMZ 06344000
         SLR   R3,R1              CHECK PAGE BEFORE            @D64ADMZ 06345000
         B     GVXPEROR_1                                      @D64ADMZ 06346000
GVXPEROR_3 DS  0H                                              @D64ADMZ 06347000
         LNR   R4,R3              R4 = NO OF FREE ..           @D64ADMZ 06348000
         A     R4,ESUBPCHN        .. PAGES AT END ..           @D64ADMZ 06349000
         SRL   R4,SUBPCHN2        .. OF BELOW AREA             @D64ADMZ 06350000
         A     R4,MAXGAP_BDY      ADD NO OF FREE PAGES AT..    @D64ADMZ 06351000
         ST    R4,MAXGAP_BDY      .. BEGIN OF ABOVE AREA       @D64ADMZ 06352000
         LA    RF,12              GETVIS EXHAUSTED             @D52VDKH 06353000
         BR    R7                 RETURN TO CALLER             @D52VDKH 06354000
GVXPDEQU DS    0H                 DEQUE PAGES                  @D52VDKH 06355000
*************************************************************           06356000
* PUT PAGES BACK ON FREE_QUEUE                                          06357000
*                                                                       06358000
*        INPUT  :                                                       06359000
*               R2 = SUBPOOL INDEX (DEQ)                                06360000
*               R5 = PAGE BEFORE 1ST PAGE TO BE DEQUEUED                06361000
*               R9 = LAST PAGE TO BE DEQUEUED                           06362000
*************************************************************           06363000
         CR    R9,R5                                           @D52VDKH 06364000
         BE    GVXPEROR                                        @D52VDKH 06365000
         LR    R4,R9               LAST PAGE TO BE DEQUEUED    @D52VDKH 06366000
         SR    R4,R5               PAGE BEFORE 1ST PAGE ...    @D52VDKH 06367000
         SRL   R4,SUBPCHN2         NO. OF PAGES TO BE DEQUEUED @D52VDKH 06368000
         LA    R3,SUBPCHNL(,R5)    FIRST PAGE TO BE DEQUEUED   @D52VDKH 06369000
         LR    R5,R2                                           @D52VDKH 06370000
         LA    R2,FIRSTPNT-(SPITFRST-SUBPINT)                  @D52VDKH 06371000
*SGLINK  GFENQDEQ,INPUT=(R2,R3,R4,R5,R8:LINK,R9,RC),OUTPUT=(RF),       *06372000
               NOMODR=(R3,R5,R6,R7,R9,RA-RC,RD),AMODE=31                06373000
         SGAMSUBR SUBROUT=GFENQDEQ,                            @D52VDKH*06374000
               INPUT=(R2,R3,R4,R5,R9,RC),                      @D52VDKH*06375000
               OUTPUT=(RF),                                    @D52VDKH*06376000
               NOMOD=(R2,R3,R5,R6,R7,R9,RB,RC,RD),             @D52VDKH*06377000
               NOMODS=(SAVR3RD7),                              @D52VDMZ*06378000
               LINK=(R8),                                      @D52VDKH*06379000
               CBASE=OWN,                                      @D52VDKH*06380000
               SUBROUC=GVXPART                                 @D52VDKH 06381000
         LR    R2,R5              RESTORE SUBPOOL INDEX        @D52VDKH 06382000
         B     GVXPEROR           GETVIS EXHAUSTED             @D52VDKH 06383000
         DROP  R2                 RELEASE SUBPOOL INDEX TABLE  @D52VDKH 06384000
         DROP  RC                 RELEASE ANCHOR TABLE         @D52VDKH 06385000
         DROP  RD                 RELEASE ANCHOR TABLE         @D52VDKH 06386000
         DROP  RE                 RELEASE BASE                 @D52VDKH 06387000
         EJECT                                                          06388000
*********************************************************************** 06389000
*                                                                       06390000
*   FREEALL  : IMPLEMENTS FREEVIS ALL                                   06391000
*                                                                       06392000
*   CALLED BY : FREEVIS MAIN PATH                                       06393000
*   CALLS     : GTVSINIT                                                06394000
*                                                                       06395000
*   INPUT    R6 --> DISPAD                                              06396000
*            RA --> TCBPTR                                              06397000
*            RD --> CALLER'S SAVE AREA                                  06398000
*            RE --> BASE REGISTER                                       06399000
*            RF --> 0                                                   06400000
*                                                                       06401000
*   OUTPUT : RF  : RETURN CODE                                          06402000
*                                                                       06403000
*   WORK   : R0,R1,R3,R4,R5,R7,R9,RB,RC                                 06404000
*   LINK   : R8                                                         06405000
*                                                                       06406000
         AGO    .CREATEZ                                       @D52VDKH 06407000
.FREEALL ANOP                                                  @D52VDKH 06408000
.*             0123456789ABCDEF                                         06409000
&INPREG  SETC '0000001000100111'                               @D52VDKH 06410000
&OUTREG  SETC '0000000000000001'                               @D52VDKH 06411000
&WRKREG  SETC '1111110101011000'                               @D52VDMZ 06412000
&NMDREG  SETC '0000001010100110'                               @D52VDMZ 06413000
&LINKR   SETC 'R8'                                             @D52VDKH 06414000
&TBASE   SETC 'OWN'                                            @D52VDKH 06415000
.*EXCLSYMS=(SAVR3RD8,SVCSV3)                                   @D52VDMZ 06416000
         AGO    .TESTALL                                       @D52VDKH 06417000
.CREATEZ ANOP                                                  @D52VDKH 06418000
*                                                                       06419000
*********************************************************************** 06420000
         SPACE 3                                                        06421000
         USING ANCHTAB,RC                                      @D52VDKH 06422000
         USING SVEARA,RD                                       @D52VDKH 06423000
         USING FREEALL,RE                                      @D52VDKH 06424000
FREEALL  EQU   *                                               @D52VDKH 06425000
*SGLINK  FREEALL,S,INPUT=(R6,R8:LINK,RA,RC,RD,RF),OUTPUT=(RC,RF),      *06426000
               WORK=(R0-R2,R3,R4,R5,R7,R9,RB,RC,RE,RF),NOMODR=(R8),    *06427000
               AMODE=31,MODSYM=(SAVR3D8,SVCSV3),                       *06428000
               SUBROUT=(GTVSINI1:IGN(R8),FVTRACE,FVSBPOOL:IGN(R8),     *06429000
               GVFVGATING:IGN(R8),FREEVSM0:IGN(R8),                    *06430000
               FV_DISCARD,DSC_LSQA,DSC_SPLE,DSC_LSQA_NS)                06431000
         USING TCBADR,RA                                       @D52VDKH 06432000
         USING ANCHTAB,RC                                      @D52VDKH 06433000
         USING PCBADR,R4                                                06434000
         USING DISP,R6            DISPATCHER ADDRESSABILITY    @D14CDJB 06435000
         CLC   TID(2),IJBHMTID    REQUEST FROM A MAIN TASK?    @D51IDMZ 06436000
         BNH   FVALLPAR           YES ===>                     @D14CDJB 06437000
***************************************************************@D149DJB 06438000
*   HANDLE FREEVIS ALL FOR SUBTASK                                      06439000
***************************************************************@D149DJB 06440000
         L     R4,PCBPTR          GET CURRENT PCB              @D64ADKH 06441000
         NI    SVER0F+D3,X'FF'-SMFVALL NO LONGER NEC.          @D64ADKH 06442000
         OI    SVER0F+D3,FVSPID                                @D64ADKH 06443000
         ST    R8,SAVR3RD8        SAVE RETURN ADDRESS          @D64ADKH 06444000
* SET LOC DEPENDING ON SWITCH OF CI                                     06445000
         LA    RB,1               IDENTIFY CALLER AS FREEVIS   @D52VDKH 06446000
*SGLINK  GTVSINI1,INPUT=(R7:LINK,RB-RD,RF),OUTPUT=(RB,RC,RF),          *06447000
               NOMODR=(R6,RA,RD),AMODE=31,NOMODS=(SAVR3RD8)             06448000
         SGAMSUBR SUBROUT=GTVSINI1,                            @D14CDJB*06449000
               INPUT=(RB,RD,RE,RF),                            @D52VDMZ*06450000
               OUTPUT=(RB,RC,RF),                              @D52VDMZ*06451000
               NOMOD=(R6,RA,RD),                               @D52VDMZ*06452000
               IGN=(R8),                                       @D52VDMZ*06453000
               LINK=(R7),                                      @D14CDJB*06454000
               CBASE=OWN,         INITIALIZE GETVIS AREA       @D52VDKH*06455000
               SUBROUC=FREEALL                                 @D52VDKH 06456000
         LH    R5,TCBSPOFF        GET SUBPOOL OFFSET           @D52VDKH 06457000
         LTR   R5,R5              DOES SUBPOOL EXIST ?         @D14CDJB 06458000
         BZ    FM_DISCARD_PVT     NO  ===>                     @D64ADKH 06459000
         A     R5,BSUBPIND        GET SUBPOOL INDEX ADDRESS    @D52VDKH 06460000
*-----------HOOK FOR SDAID------------------------------------ @DA46055 06461000
         L     R1,TCBATCBE        GET ADDRESS OF TCB-EXTENSION @DA46055 06462000
         USING TCBXADR,R1         AND MAKE IT ADDRESSABLE.     @DA46055 06463000
         OI    TCBXFLG2,TCBXSDEX  SET INDICATION FOR EXCL SUBP @DA46055 06464000
         DROP  R1                 DROP ADDRESSABILITY.         @DA46055 06465000
*-----------END OF SDAID HOOK--------------------------------- @DA46055 06466000
         LA    R1,TCBSPOFF-D6     GET DUMMY SPID ADDRESS       @D14CDJB 06467000
         B     FVALLXSP           ===> FREE TOTAL SUBPOOL      @D14CDJB 06468000
***************************************************************@D149DJB 06469000
*   HANDLE FREEVIS ALL FOR PARTITION                           @D149DJB 06470000
*     THE PARTITION GETVIS GATE IS CLOSED                      @D64ADMZ 06471000
***************************************************************@D149DJB 06472000
FVALLPAR EQU   *                                               @D14CDJB 06473000
         L     R3,DFWKCOMG        GET COMREG ADDRESS           @D52VDMZ 06474000
         L     R1,TIBPTR          GET TIB POINTER              @D64ADKH 06475000
         USING TIBADR,R1                                       @D64ADKH 06476000
         TM    TIBFLAG1,EOTACT    REQUEST FROM END OF TASK     @D64ADKH 06477000
         BO    FVALLAUT           YES, CONTINUE                @D64ADMZ 06478000
         USING COMREG,R3          COMREG ADDRESSABILITY        @D35EDUL 06479000
         TM    JCSW5,JCLACTIV     REQUEST BY JCL ?             @D14NDJB 06480000
         BO    FVALLAUT           YES ===>                     @D14NDJB 06481000
* INPUT FOR ERR21: R6 DISPATCHER ADDRESS                       @D52VDMZ 06482000
         B     ERR21              CANCEL WITH ILLEGAL SVC      @D52VDMZ 06483000
***************************************************************         06484000
*  FREEVIS ANCHOR TABLES IN SPACE GETVIS AREA (SVA FOR ST. PART)        06485000
***************************************************************         06486000
FVALLAUT EQU   *                                               @D14NDJB 06487000
         L     R4,PCBPTR          GET CURRENT PCB              @D64ADKH 06488000
         TM    OPTNBYTE,ANCHTBIT  IS GETVIS INITIALIZED        @D52VDMZ 06489000
         BNO   FVGVAPTR           NO, SKIP PART. PROCESSING    @D52VDMZ 06490000
         NI    SVER0F+3,XFF-SMFVALL RESET FREEVIS ALL INDIC.   @D64ADKH 06491000
         L     RC,IJBGVCTL        GET PTR TO ANCHOR TABLE      @D52VDMZ 06492000
         L     R1,ANCHFWP         DOES FOLLOWING ANCHOR ...    @D52VDMZ 06493000
         LTR   R1,R1              ... TABLE EXIST              @D52VDMZ 06494000
         BZ    FVALNANC           NO                           @D52VDMZ 06495000
         OI    IJBMSWB1,IJBCIINC  TELL DEBUG TO SKIP CONS.CHECK@DY45190 06496000
         ST    R8,SAVR3RD8        SAVE RETURN ADDRESS          @D64ADKH 06497000
         DROP  R4                 PCB DESTROYED DURING FREEVIS @D52VDMZ 06498000
         LA    R0,ANCHDIRL        PROVIDE LENGTH FOR FREEVIS.. @D52VDMZ 06499000
         ST    R0,SVER00          ..NOT CHANGED DURING FREEVIS @D52VDMZ 06500000
         ST    RC,ANCSAV1         SAVE PTR TO ANCHOR TABLE     @D52VDMZ 06501000
         LA    RF,0               CLEAR RETURN CODE            @D52VDKH 06502000
FVALANC0 DS    0H                                              @D52VDMZ 06503000
         MVC   ANCHBWP,ANCHFWP-ANCHTAB(R1) SAVE ADDR OF NEXT AT@D52VDMZ 06504000
         ST    R1,SVER01          PROVIDE ADDR FOR FREEVIS     @D52VDMZ 06505000
         OI    SVER0F+D2,GVFVSPIN SET SPACE INDICATOR          @D51IDMZ 06506000
         LA    R9,0                                            @D64ADKH 06507000
         LA    R5,0                                            @D64ADKH 06508000
*SGLINK  GVFVGATING,INPUT=(R5,R8:LINK,R9,RA,RD),OUTPUT=(RC),           *06509000
               AMODE=31,NOMODR=(RA,RD,RF)                               06510000
         SGAMSUBR SUBROUT=GVFVGATS,                            @D64ADKH*06511000
               INPUT=(R5,R9,RA,RD),                            @D64ADMZ*06512000
               NOMOD=(R0,R1,R2,R3,R6,R7,RA,RD,RE,RF),          @D64ADKH*06513000
               OUTPUT=(R9,RC),                                 @D64ADMZ*06514000
               LINK=(R8),         SET STORAGE KEY TO ZERO      @D64ADKH*06515000
               CBASE=OWN,                                      @D64ADKH*06516000
               SUBROUC=FREEALL                                 @D64ADKH 06517000
         OI    GMFMFLGS,GMFM_SYSTEM  INTERNAL REQUEST, GATE OPENED BY   06518000
* NOW RC POINTS TO SPACE GETVIS CI (SVA FOR STATIC PART.)               06519000
*                                    REQUESTOR                 @D61ADMZ 06520000
FV_ANCH_LOOP   DS  0H                                          @D64ADKH 06521000
         SPACE                                                          06522000
* FREEVIS ANCHOR TABLE                                                  06523000
         SPACE                                                          06524000
         DROP  RE                 RELEASE FREEVIS ALL BASE     @D52VDMZ 06525000
         L     RE,AMBASE          BASE OF FREEVIS MAIN PATH    @D52VDMZ 06526000
         L     R6,AFREEVIS-GETVIS(RE)                          @D52VDMZ 06527000
*SGLINK FREEVSM0,AMODE=31,                                     @D52VDMZ*06528000
               INPUT=(R6,RA,RC-RF),                            @D52VDMZ*06529000
               OUTPUT=(RF),                                    @D52VDMZ*06530000
               NOMODR=(R6,RA,RD),                              @D52VDMZ*06531000
               NOMODS=(SAVR3RD8)                               @D52VDMZ 06532000
         AMODESW CALL,AMODE=31,REGS=(R6,R6)                    @D52VDMZ 06533000
         L     RE,AFREEALL-GETVIS(RE)  RELOAD FREEVIS ALL BASE @D52VDMZ 06534000
         USING FREEALL,RE                                      @D52VDKH 06535000
         LTR   RF,RF              FREEVIS OK?                  @D52VDMZ 06536000
         BZ    FVALANC1           YES                          @D52VDMZ 06537000
         BAL   R5,SYSERROR        NO, SHOULD NOT OCCUR         @D52VDMZ 06538000
FVALANC1 DS    0H                                              @D52VDMZ 06539000
         L     R6,ANCSAV1         GET PTR TO PART.GETVIS CI    @D64ADMZ 06540000
         L     R1,ANCHBWP-ANCHTAB(R6)  DOES FOLLOWING ANCHOR.. @D64ADMZ 06541000
         LTR   R1,R1              .. EXIST                     @D52VDMZ 06542000
         BZ    FVALANC2           NO MORE ANCHOR TABLES        @D64ADKH 06543000
         MVC   ANCHBWP-ANCHTAB(,R6),ANCHFWP-ANCHTAB(R1)        @D64ADMZ 06544000
*                                 SAVE PTR TO NEXT ANCHOR TABLE@D64ADMZ 06545000
         ST    R1,SVER01          PROVIDE ADDR FOR FREEVIS     @D64ADKH 06546000
         OI    SVER0F+D2,GVFVSPIN SET SPACE INDICATOR          @D64ADKH 06547000
         B     FV_ANCH_LOOP       FREE NEST ANCH TAB           @D64ADKH 06548000
FVALANC2 DS    0H                                              @D52VDMZ 06549000
         L     R3,DFWKCOMG        RESTORE COMREG               @DY45190 06550000
         NI    IJBMSWB1,X'FF'-IJBCIINC DEBUG DOES CONS. CHECK  @DY45190 06551000
         NI    GMFMFLGS,X'FF'-GMFM_SYSTEM  RESET INTERNAL REQ. @D64ADKH 06552000
         L     R5,GVFVGATE        POINT TO RESOURCE DESCRIPTOR @D64ADKH 06553000
         LA    R5,0(R5)           SPACE GETVIS GATE (SVA FOR   @D64ADKH 06554000
         ST    R5,GVFVGATE        STATIC PART.)                @D64ADKH 06555000
         L     RC,ANCSAV1         RC POINTS TO PART.CI AGAIN  .@D52VDMZ 06556000
         LR    R1,RE              SAVE BASE                    @D52VDMZ 06557000
         L     R6,DISPAD          GET DISPATCHER ADDRESS       @D64ADKH 06558000
         BAL   RF,RPOST           POST ALL WAITERS             @D52VDMZ 06559000
*SGLINK  RPOST,INPUT=(R5,R6,RF),WORK=(R5,RE)                   @D52VDMZ 06560000
         LR    RE,R1              RESTORE BASE                 @D52VDMZ 06561000
         SR    RF,RF                                           @D52VDMZ 06562000
         L     R8,SAVR3RD8        RESTORE RETURN ADDRESS       @D52VDMZ 06563000
         USING PCBADR,R4          PCB ADDRESSABILITY           @D52VDMZ 06564000
FVALNANC DS    0H                                              @D52VDMZ 06565000
.* RA SHOULD STILL POINT TO TCB, L R7 IS SAFETY CODE                    06566000
         SPACE                                                          06567000
* REMOVE TASK RELATED SPLES FROM SPL (TCBSPL) WITH PRIVATE STORAGE      06568000
* (STORAGE IN PARTITION GETVIS AREA). SUBPOOL STORAGE IN PARTITION      06569000
* NEEDS NOT TO BE FREEDED SINCE PARTITION IS INVALIDATED.               06570000
* IF SPLE IS NOT WITHIN THE PARTITION GETVIS CI, BUT IN THE SPACE       06571000
* (SYSTEM) GETVIS AREA, IT IS REMOVED DURING LSQA PROCESSING LATERON.   06572000
         SPACE                                                          06573000
         L     R7,TCBPTR                                       @D64ADKH 06574000
         LA    R2,TCBSPL-TCBADR(R7)  ADDR. SPLE                @D64ADKH 06575000
         OI    GMFMFLG2,FSPLE        REMOVE SPLE IN SPL        @D64ADKH 06576000
*SGLINK  DSC_SPLE,INPUT=(R2,R7:LINK,RC-RD),OUTPUT=(RF),        @D64ADKH*06577000
                NOMODR=(R6,R8,RA-RC,RD)                                 06578000
         SGAMSUBR SUBROUT=FVDISCRD,                            @D64ADKH*06579000
               INPUT=(R2),                                     @D64ADMZ*06580000
               LINK=(R7),                                      @D64ADKH*06581000
               SUBROUC=FREEALL,                                @D64ADKH*06582000
               CBASE=OWN                                       @D64ADKH 06583000
         OI    SVER0F+3,SMFVALL   SET AGAIN FREEVIS ALL        @D64ADKH 06584000
         L     R3,DFWKCOMG        RESTORE COMREG ADDRESS       @D64ADKH 06585000
         L     R4,PCBPTR          GET CURRENT PCB              @D64ADKH 06586000
***************************************************************@D149DJB 06587000
*  DO INITIALISATION                                                    06588000
***************************************************************@D149DJB 06589000
         LA    RB,1               IDENTIFY CALLER AS FREEVIS   @D52VDKH 06590000
*SGLINK  GTVSINI4,INPUT=(R7:LINK,RB-RD,RF),OUTPUT=(RB,RC,RF),          *06591000
               NOMODR=(R3,R4,R6,RA,RD),AMODE=31                         06592000
         SGAMSUBR SUBROUT=GTVSINI1,                            @D14CDJB*06593000
               INPUT=(RB,RD,RE,RF),                            @D52VDMZ*06594000
               OUTPUT=(RB,RC,RF),                              @D52VDMZ*06595000
               NOMOD=(R6,RA,RD),                               @D52VDMZ*06596000
               IGN=(R3,R4,R8),                                 @D52VDMZ*06597000
               LINK=(R7),                                      @D14CDJB*06598000
               CBASE=OWN,         INITIALIZE FOR FREEVIS       @D52VDKH*06599000
               SUBROUC=FREEALL                                 @D52VDKH 06600000
         XI    OPTNBYTE,ANCHTBIT  RESET INITIALIZATION INDICATR@D35EDUL 06601000
         XC    LABELPTR,LABELPTR  CLEAR PTR TO GETVIS LBL SPACE@DA37315 06602000
.* DEPENDING ON THE ACTUAL SIZE OF THE CONTROL INFO, SMVPEND AND        06603000
.* ENDGVCTL MAY BE DIFFERENT                                   @D51IDMZ 06604000
         L     R5,PCEPIB          GET PIB POINTER              @D51IDMZ 06605000
         USING PIBADR,R5                                       @D51IDMZ 06606000
         TM    PIBDATFL,PIBTRAM   VIRTUAL REQUEST              @D51IDMZ 06607000
         BO    FVALVIRT           YES, TAKE VIRT. END OF PART. @D51IDMZ 06608000
         DROP  R5                 RELEASE PIB                  @D51IDMZ 06609000
         L     R5,SMRPEND         END OF REAL PARTITION + 1    @D51IDMZ 06610000
         B     FVALCON                                         @D51IDMZ 06611000
FVALVIRT DS    0H                                              @D51IDMZ 06612000
         L     R5,SMVPEND         END OF PARTITION + 1         @D51IDMZ 06613000
FVALCON  DS    0H                                              @D51IDMZ 06614000
         STM   R9,R8,SVCSV3       SAVE ALL REGS BEHIND SYS SA  @D35EDUL 06615000
         LR    R5,R3              SAVE COMREG POINTER          @D14CDJB 06616000
         AIF   (NOT &BGDEBUG).NODBG03  SKIP FOR DEBUG=NO       @D36ZDJB 06617000
         AGO   .NODBG03                                        @D52VDMZ 06618000
*SGLINK  FVTRACE,INPUT=(R8:LINK,RB,RC,RD,RF),                          *06619000
               NOMODR=(R6,RC,RF),AMODE=31,NOMODS=(SAVR3RD8)             06620000
         SGAMSUBR SUBROUT=FVTRACE,                             @D14ZDJB*06621000
               INPUT=(RB,RC,RD,RF),                            @D14ZDJB*06622000
               NOMOD=(R6,RC,RF),                               @D14ZDJB*06623000
               LINK=(R8),                                      @D14ZDJB*06624000
               NOMODS=(SAVR3RD8),                              @D52VDMZ*06625000
               CBASE=OWN,         INITIALIZE GETVIS AREA       @D52VDKH*06626000
               SUBROUC=FREEALL                                 @D52VDKH 06627000
         L     R4,SVCSV3+(SVER04-SVER09)  RELOAD PCB PTR       @D51IDMZ 06628000
         L     R5,SVCSV3+(SVER03-SVER09)  RELOAD COMREG PTR    @D14ZDJB 06629000
         L     R1,SVCSV3+(SVER01-SVER09)  RELOAD TIB POINTER   @D14NDJB 06630000
.NODBG03 ANOP                                                  @D36ZDJB 06631000
         DROP  R3                                              @D14CDJB 06632000
         USING COMREG,R5          COMREG ADDRESSABILITY        @D14CDJB 06633000
         L     RD,BVIRTMEM        GET START OF PARTITION       @D14CDJB 06634000
         L     R3,SVCSV3+(SVER05-SVER09)  RESTORE END ADDRESS  @D51IDMZ 06635000
         TM    JCSW1,JASWITCH     JOB ACCOUNTING ACTIVE ?      @D14CDJB 06636000
         BO    FVALNOJA           NO  ===>                     @D14CDJB 06637000
         TM    TIBFLAG1,EOTACT    REQUEST FROM END OF TASK     @D14NDJB 06638000
         DROP  R1                                              @D14NDJB 06639000
         BNO   FVALNOJA           NO  ===>                     @D14CDJB 06640000
         L     R1,GTVSHIGH        PTR TO HIGHEST PAGE IN CHAIN @D14CDJB 06641000
         S     R1,BSUBPCHN        GET OFFSET OF PAGE IN CHAIN  @D14CDJB 06642000
         L     R7,AGTVSHI         SAME PROCEDURE ...           @D52VDKH 06643000
         S     R7,ABSUBCHN        TO GET VALUE FROM ABOVE      @D52VDKH 06644000
         AR    R1,R7              ADD IT ALL UP                @D52VDKH 06645000
         SRL   R1,SUBPCHN2        GET PAGE NUMBER              @D14CDJB 06646000
         LA    R1,D2(,R1)         2 PAGES WERE LOST IN CALCUL. @D52VDKH 06647000
         SLL   R1,PNSHIFT         GET NUMBER OF BYTES          @D14CDJB 06648000
         AR    R1,R3              + END OF CONTROL AREA + 1    @D14CDJB 06649000
         S     R1,IJBGVCTL        - START OF CONTROL AREA      @D14CDJB 06650000
         L     R7,JAPART          PTR TO JA PARTITION TABLE    @D14CDJB 06651000
         USING ACCTABLE,R7                                     @D14CDJB 06652000
         A     R1,ACCTHICR        ADD OLD HIGH CORE VALUE      @D14CDJB 06653000
         ST    R1,ACCTHICR        STORE NEW HIGH CORE VALUE    @D14CDJB 06654000
         DROP  R7                                              @D14CDJB 06655000
         DROP  R5                                              @D14CDJB 06656000
FVALNOJA EQU   *                                               @D14CDJB 06657000
         L     R5,GVFVGATE        PARTITION GETVIS GATE        @D64ADKH 06658000
         LTR   R5,R5                                           @D64ADKH 06659000
         BNM   FVALNOPST          NO                           @D64ADKH 06660000
* FROM NOW WE RUN WITH PART. GETVIS GATE OPEN. THIS IS NO PROBLEM       06661000
* SINCE ONLY THE MAINTASK IS ACTIVE IN THE PARTITION.                   06662000
         LA    R5,0(R5)           OPEN PART. GETVIS GATE       @D64ADKH 06663000
         LR    R1,RE                                           @D64ADKH 06664000
         BAL   RF,RPOST           POST ALL WAITERS             @D64ADKH 06665000
*SGLINK  RPOST,INPUT=(R5,R6,RF),WORK=(R5,RE)                   @D64ADKH 06666000
         LR    RE,R1              RESTORE BASE                 @D64ADKH 06667000
FVALNOPST DS   0H                                              @D64ADKH 06668000
         LR    R1,R3              END OF PARTITION+1           @D35EDUL 06669000
         BCTR  R1,R0              END OF PARTITION             @D35EDUL 06670000
         SR    R5,R5                                           @D51IDKH 06671000
         IC    R5,PCEKEY                                       @D51IDKH 06672000
         L     RE,AINVPSUB        ADDRESS OF P INVALIDATION RT @D14NDJB 06673000
* AMODESW CALL,REGS=(RE,RE)                                    @D52VDMZ 06674000
         AMODESW CALL,REGS=(RE,RE) CALL PAGE MANAGER ROUTINE   @D52VDMZ 06675000
         L     RA,TCBPTR          RELOAD REQUESTOR'S TCB ADDR. @D36IDJB 06676000
         LM    R9,R8,SVCSV3       RESTORE ALL REGISTERS        @D35EDUL 06677000
         USING COMREG,R3          COMREG ADDRESSABILITY        @D14CDJB 06678000
         ST    RF,IJBGVCTL        RESET ANCHOR TABLE POINTER   @D14CDJB 06679000
         STH   RF,TCBSPOFF        RESET EXCLUSIVE SUBPOOL INDEX@D14CDJB 06680000
         ST    R5,PCBAPEND        END OF ACTUAL PARTITION      @D14CDJB 06681000
FVGVAPTR EQU   *                                               @D36ZDJB 06682000
         ST    RF,SVER0F                                       @D64ADKH 06683000
         TM    JCSW5,JCLACTIV     JOB CONTROL ACTIVE ?         @D14NDJB 06684000
         BNO   FVALNOPP           NO  ===>                     @D14NDJB 06685000
         L     R5,SMVGVIS         PERMANENT GETVIS AREA ADDRESS@D52VDMZ 06686000
         BCTR  R5,R0              MINUS ONE                    @D35EDUL 06687000
         ST    R5,PPEND           STORE AS PARTITION END FOR PP@D35EDUL 06688000
FVALNOPP DS    0H                                              @D14NDJB 06689000
         SPACE                                                          06690000
* CLOSE THE SPACE GATE (SYSTEM GETVIS FOR STATIC PART.)                 06691000
* REQUEST AS FREEMAIN TO AVOID THAT ANOTHER GETMAIN REQUEST RUNS        06692000
* IN PARALLEL. THIS CAN HAPPEN SINCE DURING PFIX PROCESSING THE GATE    06693000
* IS OPENED. FREEVIS OF FETCH SUBPOOL COULD RUN IN PARALLEL, BUT        06694000
* NOT FREEMAIN OF MVS SUBPOOLS (SEE FM_DISCARD_LSQA).                   06695000
         SPACE                                                          06696000
         OI    SVER0F+D2,GVFVSPIN SET SPACE INDICATOR          @D51IDMZ 06697000
         OI    SVER0F+D3,FVSPID                                @D64ADKH 06698000
         LR    R7,R8                                           @D64ADKH 06699000
         LA    R9,0                                            @D64ADKH 06700000
         LA    R5,1               GATE AS FREEMAIN REQUEST     @D64ADMZ 06701000
*SGLINK  GVFVGATING,INPUT=(R5,R8:LINK,R9,RA,RD),OUTPUT=(RC),           *06702000
               AMODE=31,NOMODR=(R6,R7,RA,RD,RF)                         06703000
         SGAMSUBR SUBROUT=GVFVGATS,                            @D64ADKH*06704000
               INPUT=(R5,R9,RA,RD),                            @D64ADMZ*06705000
               NOMOD=(R0,R1,R2,R3,R6,R7,RA,RD,RE,RF),          @D64ADKH*06706000
               OUTPUT=(R9,RC),                                 @D64ADMZ*06707000
               LINK=(R8),         SET STORAGE KEY TO ZERO      @D64ADKH*06708000
               CBASE=OWN,                                      @D64ADKH*06709000
               SUBROUC=FREEALL                                 @D64ADKH 06710000
         LR    R8,R7                                           @D64ADKH 06711000
               SPACE                                                    06712000
* NOW RC POINTS TO SPACE GETVIS CI (SVA FOR STATIC PART.)               06713000
               SPACE                                                    06714000
***************************************************************@D149DJB 06715000
*  DO INITIALISATION                                                    06716000
***************************************************************@D149DJB 06717000
         LA    RB,1               IDENTIFY CALLER AS FREEVIS   @D52VDKH 06718000
*SGLINK  GTVSINI1,INPUT=(R7:LINK,RB-RD,RF),OUTPUT=(RB,RC,RF),          *06719000
               NOMODR=(R6,RA,RD),AMODE=31                               06720000
         SGAMSUBR SUBROUT=GTVSINI1,                            @D14CDJB*06721000
               INPUT=(RB,RD,RE,RF),                            @D52VDMZ*06722000
               OUTPUT=(RB,RC,RF),                              @D52VDMZ*06723000
               NOMOD=(R6,RA,RD),                               @D52VDMZ*06724000
               IGN=(R3,R8),                                    @D52VDMZ*06725000
               LINK=(R7),                                      @D14CDJB*06726000
               CBASE=OWN,         INITIALIZE GETVIS AREA       @D52VDKH*06727000
               SUBROUC=FREEALL                                 @D52VDKH 06728000
         USING ANCHTAB,RC         REESTABLISH ADDRESSIBILITY   @D51GDMZ 06729000
         ST    R8,SAVR3RD8                                     @D64ADKH 06730000
         LH    R5,IJBSPIND        GET SUBPOOL INDEX            @D52VDKH 06731000
         LTR   R5,R5              DOES IT EXIST ?              @D64ADKH 06732000
         BZ    FM_DISCARD_LSQA    NO  ===>                     @D64ADKH 06733000
         A     R5,BSUBPIND        ADDRESS OF INDEX TABLE ENTRY @D14CDJB 06734000
         LA    R1,IJBSPNAM        ADDRESS OF SUBPOOL NAME      @D14CDJB 06735000
         ST    RF,IJBDECPY        CLEAR DE COPY POINTER        @DA33314 06736000
         SPACE                                                          06737000
*  FREEVIS FETCH SUBPOOL IN SPACE GETVIS (SVA FOR STATIC PART.)         06738000
         SPACE                                                          06739000
FVALLXSP EQU   *                                               @D14CDJB 06740000
*SGLINK  FVSBPOOL,INPUT=(R1,R5,R7:LINK,RA,RB,RC,RD,RF),OUTPUT=(RF),    *06741000
               NOMODR=(R6,RA,RD),AMODE=31,NOMODS=(SAVR3RD8)             06742000
         SGAMSUBR SUBROUT=FVSBPOOL,                            @D14CDJB*06743000
               INPUT=(R1,R5,RA,RB,RC,RD,RE,RF),                @D64ADMZ*06744000
               NOMOD=(R6,RD),                                  @D14CDJB*06745000
               LINK=(R7),                                      @D52VDKH*06746000
               NOMODS=(SAVR3RD8),                              @D52VDMZ*06747000
               CBASE=OWN,         INITIALIZE GETVIS AREA       @D52VDKH*06748000
               SUBROUC=FREEALL                                 @D52VDKH 06749000
         TM    SVER0F+D2,GVFVSPIN  DO WE WORK FOR SPACE        @D64ADKH 06750000
         BO    FM_DISCARD_LSQA     YES                         @D64ADKH 06751000
FM_DISCARD_PVT   DS  0H                                        @D64ADKH 06752000
         L     R8,SAVR3RD8        RESTORE FREEALL LINK REG.    @D64ADKH 06753000
* ARBEITET MAN AUCH FUER EINE ANDERE TASK ALS DIE CURRENT???            06754000
         L     R7,TCBPTR          GET CURRENT TCB              @D64ADKH 06755000
         LA    R2,TCBSPL-TCBADR(R7)  A(ADDR OF SPLE CHAIN)     @D64ADKH 06756000
*SGLINK  FV_DISCARD,INPUT=(R2,R7:LINK,RC-RD),OUTPUT=(RF),      @D64ADKH*06757000
                NOMODR=(R6,R8,RA-RC,RD)                        @D64ADKH 06758000
         SGAMSUBR SUBROUT=FVDISCRD,                            @D64ADKH*06759000
               INPUT=(R2),                                     @D64ADMZ*06760000
               LINK=(R7),                                      @D64ADKH*06761000
               SUBROUC=FREEALL,                                @D64ADKH*06762000
               CBASE=OWN                                       @D64ADKH 06763000
         B     FVALL_RET                                       @D64ADKH 06764000
         SPACE                                                          06765000
FM_DISCARD_LSQA  DS  0H                                        @D64ADKH 06766000
         SPACE                                                          06767000
* DISCARD TASK RELATED SUBPOOLS (AND CORRESPONDING SPLES) IN LSQA       06768000
* (SPACE).                                                              06769000
* DISCARD TASK RELATED SPLES THAT ARE ALLOCATED IN SPACE (SYSTEM)       06770000
* GETVIS AREA.                                                          06771000
* DURING DISCARD SUBPOOL PROCESSING THE WORK AREA GMFMWRK1 IS USED.     06772000
* THIS AREA IS ALSO USED BY A GETMAIN/FREEMAIN REQUEST. THAT'S WHY      06773000
* NO GETMAIN/FREEMAIN REQUEST MAY RUN IN PARALLEL. THIS WAS PREVENTED   06774000
* BY CLOSING THE GATE AS FREEMAIN REQUESTOR.                            06775000
         SPACE                                                          06776000
         L     R8,SAVR3RD8                                     @D64ADKH 06777000
         L     R7,TCBPTR                                       @D64ADKH 06778000
         LA    R2,TCBSPL-TCBADR(R7)                            @D64ADKH 06779000
         OI    GMFMFLG2,LSQA     DISCARD LSQA SUBPOOLS AND SPLE@D64ADKH 06780000
*SGLINK  DSC_LSQA_NS,INPUT=(R2,R7:LINK,RC-RD),                 @D64ADKH*06781000
                NOMODR=(R6,RA-RC,RD),NOMODS=(SAVR3RD8)         @D64ADKH 06782000
         SGAMSUBR SUBROUT=FVDISCRD,                            @D64ADKH*06783000
               INPUT=(R2),                                     @D64ADMZ*06784000
               LINK=(R7),                                      @D64ADKH*06785000
               SUBROUC=FREEALL,                                @D64ADKH*06786000
               CBASE=OWN                                       @D64ADKH 06787000
FVALL_RET  DS  0H                                              @D64ADKH 06788000
         NI    SVER0F+D3,X'FF'-FVSPID                          @D64ADKH 06789000
         OI    SVER0F+D3,SMFVALL                               @D64ADKH 06790000
         SPACE                                                          06791000
.* AT THIS POINT IN TIME ONE GATE IS CLOSED                             06792000
.* SUBTASK PROCESSING: PARTITION GETVIS GATE                            06793000
.* MAINTASK PROCESSING: SPACE GATE (SVA FOR STATIC PART.)               06794000
         BR    R8                 NORMAL RETURN                @D52VDKH 06795000
         SPACE 3                                               @D52VDMZ 06796000
         DROP  R3                 DROP COMREG POINTER          @D51IDMZ 06797000
         DROP  R4                 DROP PCBPTR                  @D51IDMZ 06798000
         DROP  R6                                              @D52VDKH 06799000
         DROP  RA                                              @D52VDKH 06800000
         DROP  RC                 RELEASE ANCHOR TABLE         @D52VDKH 06801000
         DROP  RD                 RELEASE ANCHOR TABLE         @D52VDKH 06802000
         DROP  RE                 RELEASE BASE                 @D52VDKH 06803000
         EJECT                                                          06804000
*********************************************************************** 06805000
*                                                                       06806000
*   GVXING   : IMPLEMENTS BOUNDARY X-ING FOR PARTITION GETVIS AREA      06807000
*                                                                       06808000
*      MODULE GVXING                                                    06809000
*             CALCULATE MAXIMUM SPACE AVAILABLE AT END OF ABOVE PART    06810000
*             THE DIFFERENCE TO THE REQUESTED SIZE IS NEEDED AT THE     06811000
*                 END OF THE BELOW PART                                 06812000
*                 IF PAGE BOUNDARY ALIGNMENT IS REQUIRED THEN           06813000
*                    ROUND UP SIZE NEEDED FROM BELOW PART               06814000
*                    REDUCE SIZE NEEDED FROM ABOVE PART ACCORDINGLY     06815000
*                                                                       06816000
*             CALL GVXPART TO GET NEEDED SPACE FROM BELOW               06817000
*             IF RC ¬= 0 THEN RETURN                                    06818000
*             ELSE                                                      06819000
*                CALL GVXPART TO GET NEEDED SPACE FROM ABOVE            06820000
*                RETURN                                                 06821000
*                                                                       06822000
*      ENDMODULE GVXING                                                 06823000
*                                                                       06824000
*   CALLED BY : GETVIS MAIN PATH (END)                                  06825000
*   CALLS     : GVXPART                                                 06826000
*                                                                       06827000
*   INPUT    R2 --> SUBPOOL INDEX TABLE ENTRY                           06828000
*            RB --> SVA(SPACE)/PARTITION INDICATOR                      06829000
*            RC --> ANCHOR TABLE                                        06830000
*            RD --> CALLER'S SAVE AREA                                  06831000
*            RE --> BASE REGISTER                                       06832000
*        SVER00 --> REQUESTED LENGTH                                    06833000
*                                                                       06834000
*   OUTPUT : RF  : RETURN CODE                                          06835000
*        SVER01  : START ADDRESS OF ALLOCATED AREA                      06836000
*   WORK   : R0,R1,R3,R4,R5,R7,R9                                       06837000
*   LINK   : R8                                                         06838000
*                                                                       06839000
         AGO    .CREATEV                                       @D52VDKH 06840000
.GVXING  ANOP                                                  @D52VDKH 06841000
.*             0123456789ABCDEF                                         06842000
&INPREG  SETC '0010000000111110'                               @D52VDKH 06843000
&OUTREG  SETC '0000000000000001'                               @D52VDKH 06844000
&WRKREG  SETC '1101110101000000'                               @D52VDMZ 06845000
&NMDREG  SETC '0010001010111110'                               @D52VDMZ 06846000
&LINKR   SETC 'R8'                                             @D52VDKH 06847000
&TBASE   SETC 'OWN'                                            @D52VDKH 06848000
.*EXCLSYMS=(SAVR3RD8)                                          @D52VDMZ 06849000
         AGO    .TESTALL                                       @D52VDKH 06850000
.CREATEV ANOP                                                  @D52VDKH 06851000
*                                                                       06852000
*********************************************************************** 06853000
         SPACE 3                                                        06854000
         USING ANCHTAB,RC                                      @D52VDKH 06855000
         USING SVEARA,RD                                       @D52VDKH 06856000
         USING SUBPINT,R2                                      @D52VDKH 06857000
         USING GVXING,RE                                       @D52VDKH 06858000
GVXING   DS    0H                 ENTRY POINT                  @D52VDKH 06859000
*SGLINK  GVXING,S,INPUT=(R2,R8:LINK,RB,RC,RD),OUTPUT=(RF),             *06860000
               WORK=(R0,R1,R3-R5,R7,R9,RE,RF),NOMODR=(R8),             *06861000
               AMODE=31,MODSYM=(SAVR3RD8),SUBROUT=(GVXPART:IGN(R8),    *06862000
               GTVSINI2:IGN(RB))                                        06863000
*************************************************************           06864000
* SEE WHAT'S AVAILABLE ABOVE                                            06865000
*    (GETVIS AREA MUST BE SWITCHED TO BELOW PART)                       06866000
*************************************************************           06867000
         MVC   LGTHSAV,SVER00     SAVE REQUESTED LENGTH        @D52VDKH 06868000
         LA    R1,SUBPCHNL        LENGTH OF A PAGE CHAIN ENTRY @D52VDKH 06869000
         L     R7,AESUBCHN        LAST PAGE OF ABOVE PART      @D52VDKH 06870000
         USING SUBPCHN,R7                                      @D52VDKH 06871000
GVXILOOP DS    0H                                              @D52VDKH 06872000
         CLC   SPCHNMBR,XFFFF     IS THIS PAGE FREE ?          @D52VDKH 06873000
         BNE   GVXINOTF           NO, ==>                      @D52VDKH 06874000
         C     R7,ABSUBCHN        ALL PAGES FROM ABOVE CHECKED?@D52VDMZ 06875000
         BNE   GVXICABV           CONTINUE CHECK ABOVE         @D52VDMZ 06876000
         SLR   R7,R1              POINT TO END OF BELOW CHAIN  @D52VDMZ 06877000
         B     GVXINOTF                                        @D52VDMZ 06878000
GVXICABV DS    0H                                              @D52VDMZ 06879000
         SLR   R7,R1              CHECK PAGE BEFORE            @D52VDKH 06880000
         B     GVXILOOP                                        @D52VDKH 06881000
GVXINOTF DS    0H                                              @D52VDKH 06882000
         LNR   R4,R7                                           @D52VDKH 06883000
         A     R4,AESUBCHN                                     @D52VDKH 06884000
         SRL   R4,SUBPCHN2        NO. OF FREE PAGES            @D52VDKH 06885000
         LA    R3,0               INITIALIZE COUNTER           @D52VDKH 06886000
         CLC   SPCHNMBR,SPITNMBR  IS THIS PAGE ON SUBPOOL ?    @D52VDKH 06887000
         BNE   GVXIADDP           NO, ==>                      @D52VDKH 06888000
         LA    R5,0               COMPARE VALUE                @D52VDKH 06889000
         L     R1,SPCHVSTB                1ST VISTAB BYTE      @D52VDKH 06890000
         A     R1,ABVISTAB                OF THIS PAGE         @D52VDKH 06891000
         DROP  R7                                              @D52VDKH 06892000
         L     RF,PAGESIZE                                     @D52VDKH 06893000
         SRL   RF,LDVBYTBI+LDBITBYT(RB)                        @D52VDKH 06894000
         AR    RF,R1            1ST VISTAB BYTE OF FOLLOW. PAGE@D52VDKH 06895000
GVXIFREE EQU   *                                               @D52VDKH 06896000
         S     RF,F4                                           @D52VDKH 06897000
         CR    RF,R1             OUT OF THIS PAGE ?            @D52VDKH 06898000
         BL    GVXISNGL          YES,                          @D52VDKH 06899000
         CL    R5,0(,RF)         ALL VISTAB BITS ZERO ?        @D52VDKH 06900000
         BNE   GVXISNGL          YES, REPEAT                   @D52VDKH 06901000
         LA    R3,32(,R3)        32 FREE BITS FOUND            @D52VDKH 06902000
         B     GVXIFREE          YES, REPEAT                   @D52VDKH 06903000
GVXISNGL EQU   *                                               @D52VDKH 06904000
         LA    RF,3(,RF)                                       @D52VDKH 06905000
GVXILOPS EQU   *                                               @D52VDKH 06906000
         CR    RF,R1              OUT OF BOUNDS ?              @D52VDKH 06907000
         BL    GVXIADDP           YES, ADD PAGES               @D52VDKH 06908000
         CLI   0(RF),X'00'        THIS BYTE ALL ZERO ?         @D52VDKH 06909000
         BNE   GVXIREST           NO, COUNT REST AS SINGLE BITS@D52VDKH 06910000
         LA    R3,8(,R3)          YES, 8 MORE BITS FOUND       @D52VDKH 06911000
         BCT   RF,GVXILOPS        CHECK IT                     @D52VDKH 06912000
GVXIREST EQU   *                                               @D52VDKH 06913000
         LA    R1,0                                            @D52VDKH 06914000
         IC    R0,0(,RF)                                       @D52VDKH 06915000
GVXISHFT EQU   *                                               @D52VDKH 06916000
         SRDL  R0,1                                            @D52VDKH 06917000
         LTR   R1,R1                                           @D52VDKH 06918000
         BNZ   GVXIADDP                                        @D52VDKH 06919000
         LA    R3,1(,R3)                                       @D52VDKH 06920000
         B     GVXISHFT                                        @D52VDKH 06921000
GVXIADDP EQU   *                                               @D52VDKH 06922000
         ST    R4,MAXGAP_BDY      NO OF FREE PAGES ADJ. TO 16MB@D64ADMZ 06923000
         SLL   R4,PNSHIFT         NO. OF PAGES TIMES 4K        @D52VDKH 06924000
         SLL   R3,LDVBYTBI(RB)    VISTQB BITS IN STORAGE BYTES @D52VDKH 06925000
         AR    R3,R4                                           @D52VDKH 06926000
         LTR   R3,R3              ANY FREE SPACE FOUND ?       @D52VDKH 06927000
         BZ    GVXIEROR           NO, EXIT                     @D52VDKH 06928000
*************************************************************           06929000
* CALCULATE WHAT'S NEEDED FROM BELOW                                    06930000
*     AND TRY TO GET IT                                                 06931000
*************************************************************           06932000
         S     R3,LGTHSAV                                      @D52VDKH 06933000
         LPR   R3,R3                                           @D52VDKH 06934000
         BCTR  R3,0                                            @D52VDKH 06935000
         SRL   R3,LDVBYTBI(RB)                                 @D52VDKH 06936000
         LA    R3,1(,R3)          ROUND TO NEXT MULTIPLE       @D52VDKH 06937000
         SLL   R3,LDVBYTBI(RB)    OF ALLOCATION UNIT           @D52VDKH 06938000
         TM    SVER0F+3,PAGEIND   PAGE BDY ALIGNMENT ?         @D52VDKH 06939000
         BNO   GVXIFIND           NO, ==>                      @D52VDKH 06940000
         BCTR  R3,0                                            @D52VDKH 06941000
         SRL   R3,PNSHIFT                                      @D52VDKH 06942000
         LA    R3,1(,R3)          ROUND TO NEXT MULTIPLE       @D52VDKH 06943000
         SLL   R3,PNSHIFT         OF PAGESIZE                  @D52VDKH 06944000
GVXIFIND EQU   *                                               @D52VDKH 06945000
         ST    R3,SVER00          THIS IS NEEDED BELOW         @D52VDKH 06946000
         LNR   R3,R3              MIGHT NOT NEED ANYTHING      @D52VDKH 06947000
         A     R3,LGTHSAV         FROM ABOVE ANYMORE           @D52VDKH 06948000
         LTR   R3,R3              IF SO,                       @D52VDKH 06949000
         BNP   GVXIEROR           MAKE FULL SEARCH BELOW       @D52VDKH 06950000
         ST    R8,SAVR3RD8                                     @D52VDKH 06951000
*SGLINK  GVXPART,INPUT=(R2,R7:LINK,RB,RC,RD),OUTPUT=(RF),              *06952000
               NOMODR=(R6,RA,RB,RC,RD),AMODE=31,NOMODS=(SAVR3RD8)       06953000
         SGAMSUBR SUBROUT=GVXPART,                             @D52VDKH*06954000
               INPUT=(R2,RA,RB,RC,RD,RE),                      @D52VDKH*06955000
               OUTPUT=(RF),                                    @D52VDKH*06956000
               NOMOD=(R6,RA,RB,RC,RD),                         @D52VDKH*06957000
               IGN=(R8),                                       @D52VDMZ*06958000
               LINK=(R7),                                      @D52VDKH*06959000
               NOMODS=(SAVR3RD8),                              @D52VDMZ*06960000
               CBASE=OWN,                                      @D52VDKH*06961000
               SUBROUC=GVXING                                  @D52VDKH 06962000
         L     R8,SAVR3RD8                                     @D52VDKH 06963000
         LTR   RF,RF              SPACE FOUND BELOW?           @D52VDKH 06964000
         BNZ   GVXIOVER           NO, EXIT                     @D52VDKH 06965000
*************************************************************           06966000
* NOW GET REST FROM ABOVE PART                                          06967000
*************************************************************           06968000
         L     R3,SVER00         CALCULATE WHAT'S NEEDED FROM  @D52VDKH 06969000
         LNR   R3,R3             ABOVE                         @D52VDKH 06970000
         A     R3,LGTHSAV                                      @D52VDKH 06971000
         BCTR  R3,0                                            @D52VDKH 06972000
         SRL   R3,LDVBYTBI(RB)                                 @D52VDKH 06973000
         LA    R3,1(,R3)                                       @D52VDKH 06974000
         SLL   R3,LDVBYTBI(RB)                                 @D52VDKH 06975000
         ST    R3,SVER00                                       @D52VDKH 06976000
*                                                                       06977000
*  SWITCH CONTROL INFO FIELDS FOR ABOVE                                 06978000
*                                                                       06979000
         NI    SVER0F+2,X'FF'-GVLOCBEL                         @D52VDKH 06980000
         OI    SVER0F+2,GVLOCANY                               @D52VDKH 06981000
         LR    R3,RB               SAVE RB                     @D52VDKH 06982000
         LA    RB,2                                            @D52VDKH 06983000
*SGLINK  GTVSINI2,INPUT=(R7:LINK,RB,RC,RD),                            *06984000
                NOMODR=(R2,R3,R6,R8,RA,RC,RD,RF),AMODE=31,             *06985000
                NOMODS=(SAVR3RD8)                              @D64ADKH 06986000
         SGAMSUBR SUBROUT=GTVSINI2,                            @D52VDKH*06987000
               INPUT=(RB,RC,RD,RE),                            @D52VDKH*06988000
               NOMOD=(R2,R3,R6,R8,RA,RC,RD,RF),                @D52VDMZ*06989000
               NOMODS=(SAVR3RD8),                              @D52VDMZ*06990000
               IGN=(RB),                                       @D52VDMZ*06991000
               LINK=(R7),                                      @D52VDKH*06992000
               CBASE=OWN,         INITIALIZE GETVIS AREA       @D52VDKH*06993000
               SUBROUC=GVXING                                  @D52VDKH 06994000
         LR    RB,R3              RESTORE RB                   @D52VDKH 06995000
*                                                                       06996000
* GET SPACE FROM ABOVE                                                  06997000
*                                                                       06998000
*SGLINK  GVXPART,INPUT=(R2,R7:LINK,RB,RC,RD),OUTPUT=(RF),              *06999000
               NOMODR=(R6,RA-RD),AMODE=31,NOMODS=(SAVR3RD8)             07000000
         SGAMSUBR SUBROUT=GVXPART,                             @D52VDKH*07001000
               INPUT=(R2,RA,RB,RC,RD,RE),                      @D52VDKH*07002000
               OUTPUT=(RF),                                    @D52VDKH*07003000
               NOMOD=(R6,RD),                                  @D52VDMZ*07004000
               NOMODS=(SAVR3RD8),                              @D52VDMZ*07005000
               IGN=(R8),                                       @D52VDMZ*07006000
               LINK=(R7),                                      @D52VDKH*07007000
               CBASE=OWN,                                      @D52VDKH*07008000
               SUBROUC=GVXING                                  @D52VDKH 07009000
         L     R8,SAVR3RD8                                     @D52VDKH 07010000
*                                                                       07011000
*  SWITCH CONTROL INFO FIELDS FOR BELOW                                 07012000
*                                                                       07013000
         NI    SVER0F+2,X'FF'-GVLOCANY                         @D52VDKH 07014000
         OI    SVER0F+2,GVLOCBEL                               @D52VDKH 07015000
         LR    R3,RB               SAVE RB                     @D52VDKH 07016000
         LA    RB,2                                            @D52VDKH 07017000
*SGLINK  GTVSINI2,INPUT=(R7:LINK,RB,RC,RD),                            *07018000
               NOMODR=(R3,R6,R8,RA,RC,RD,RF),AMODE=31                   07019000
         SGAMSUBR SUBROUT=GTVSINI2,                            @D52VDKH*07020000
               INPUT=(RB,RC,RD,RE),                            @D52VDKH*07021000
               NOMOD=(R3,R6,R8,RA,RC,RD,RF),                   @D52VDMZ*07022000
               LINK=(R7),                                      @D52VDKH*07023000
               IGN=(RB),                                       @D52VDMZ*07024000
               CBASE=OWN,         INITIALIZE GETVIS AREA       @D52VDKH*07025000
               SUBROUC=GVXING                                  @D52VDKH 07026000
         LR    RB,R3              RESTORE RB                   @D52VDKH 07027000
         L     R3,LGTHSAV         RECALCULATE                  @D52VDKH 07028000
         S     R3,SVER00          ADDRESS FROM BELOW           @D52VDKH 07029000
         BCTR  R3,0                                            @D52VDKH 07030000
         SRL   R3,LDVBYTBI(RB)                                 @D52VDKH 07031000
         LA    R3,1(,R3)                                       @D52VDKH 07032000
         SLL   R3,LDVBYTBI(RB)                                 @D52VDKH 07033000
         LNR   R3,R3                                           @D52VDKH 07034000
         A     R3,ABVRTMEM                                     @D52VDKH 07035000
         ST    R3,SVER01                                       @D52VDKH 07036000
         MVC   SVER00,LGTHSAV                                  @D52VDKH 07037000
         ST    RF,LGTHSAV                                      @D52VDKH 07038000
         BR    R8                                              @D52VDKH 07039000
GVXIEROR EQU   *                                               @D52VDKH 07040000
         LA    RF,12              CROSSING IMPOSSIBLE          @D52VDKH 07041000
GVXIOVER EQU   *                                               @D52VDKH 07042000
         MVC   SVER00,LGTHSAV                                  @D52VDKH 07043000
         LA    R7,0                                            @D52VDKH 07044000
         ST    R7,LGTHSAV                                      @D52VDKH 07045000
         BR    R8                 DONE                         @D52VDKH 07046000
         DROP  R2                 RELEASE SUBPOOL INDEX TABLE  @D52VDKH 07047000
         DROP  RC                 RELEASE ANCHOR TABLE         @D52VDKH 07048000
         DROP  RD                 RELEASE ANCHOR TABLE         @D52VDKH 07049000
         DROP  RE                 RELEASE BASE                 @D52VDKH 07050000
         EJECT                                                          07051000
***************************************************************@D149DJB 07052000
*                                                              @D149DJB 07053000
*   ROUTINE TO LOOK FOR GETVIS SPACE FOR N - 1 OR N-2 PAGES    @D218DKH 07054000
*                                                              @D149DJB 07055000
*   MODULE GVGPMIN1                                            @D149DJB 07056000
*     IF REQUESTED SPACE FOUND                                 @D149DJB 07057000
*       THEN SET RC = 00                                       @D149DJB 07058000
*       ELSE SET RC = 0C                                       @D149DJB 07059000
*     EXIT GVGPMIN1                                            @D149DJB 07060000
*   ENDMODULE GVGPMIN1                                         @D149DJB 07061000
*                                                              @D149DJB 07062000
*     CALLED BY : SGAM                                         @D149DJB 07063000
*     CALLS     : GVGETPAG GFENQDEQ                            @D149DJB 07064000
*                                                              @D149DJB 07065000
*     INPUT  : R2 --> SUBPOOL INDEX TABLE ENTRY                @D149DJB 07066000
*              R4  :  NUMBER OF PAGES TO BE LOOKED FOR         @D149DJB 07067000
*              RB  :  SHIFT MODIFIER FOR SVA/SPACE REQUEST     @D149DJB 07068000
*              RC --> ANCHOR TABLE                             @D149DJB 07069000
*              RD --> REQUESTOR SAVE AREA                      @D149DJB 07070000
*              RE --> BASE                                     @D52VDMZ 07071000
*              RF  :  0                                        @DY45037 07072000
*     OUTPUT : R0  :  INDICATOR FOR BIT SETTING (SETVSTAB)     @D149DJB 07073000
*              R1 --> LAST SCANNED BYTE IN VISTAB (IF FOUND)   @D149DJB 07074000
*              R3  :  BIT OFFSET IN LAST VISTAB BYTE           @D149DJB 07075000
*              R9  :  0 OR PTR TO LAST PAGE OF FOUND AREA      @D149DJB 07076000
*              RF  :  RETURN CODE : 0C (SPACE NOT FOUND)       @D149DJB 07077000
*     LINK   : R7                                              @D149DJB 07078000
*     WORK   : R4,R8                                           @D149DJB 07079000
*                                                              @D149DJB 07080000
*   AUXILIARY WORK FIELDS (UPDATED IN ANCHOR TABLE) :          @D149DJB 07081000
*     SSEARCH : VISTAB BYTE ADDRESS OF FOUND AREA              @D149DJB 07082000
*     SVWORK1 : BIT OFFSET IN SSEARCH OF FOUND AREA (0..7)     @D149DJB 07083000
*                                                              @D149DJB 07084000
         AGO    .CREATEC                                       @D14ZDJB 07085000
.GVGPMN1 ANOP                                                  @D14ZDJB 07086000
.*             0123456789ABCDEF                                @D149DJB 07087000
&INPREG  SETC '0010100000011111'                               @DY45037 07088000
&OUTREG  SETC '1101000001000001'                               @D14ZDJB 07089000
&WRKREG  SETC '0100110010000000'                               @D14ZDJB 07090000
&NMDREG  SETC '0010001100111110'                               @D14ZDJB 07091000
&LINKR   SETC 'R7'                                             @D14ZDJB 07092000
&TBASE   SETC 'OWN'                                            @D52VDKH 07093000
.*EXCLSYMS=(SAVREG5,SAVREG9)                                   @D52VDMZ 07094000
         AGO    .TESTALL                                       @D14ZDJB 07095000
.CREATEC ANOP                                                  @D14ZDJB 07096000
***************************************************************@D149DJB 07097000
         SPACE 2                                               @D14CDJB 07098000
         USING ANCHTAB,RC                                      @D14CDJB 07099000
         USING SVEARA,RD                                       @D14CDJB 07100000
         USING GVGPMIN1,RE                                     @D52VDKH 07101000
GVGPMIN1 DS    0H                                              @D14CDJB 07102000
*SGLINK  GVGPMIN1,S,INPUT=(R2,R4,R7:LINK,RB,RC,RD),OUTPUT=(R0,R1,      *07103000
               R3,R9,RF),WORK=(R0,R1,R3,R4,R5,R8,R9,RF),NOMODR=(R7),   *07104000
               AMODE=31,MODSYM=(SAVREG5,SAVREG9),SUBROUT=(GVGETPAG,    *07105000
               GVSCPBDY,GVSCVSTB,GVUPPIE0,SETVSTAB:IGN(R2),GFENQDEQ)    07106000
         TM    SVER0F+D3,SVAIND    SVA REQUEST ?               @DY45037 07107000
         BO    GVGPMIN1_0          YES, MIN1/MIN2 PROCESSING   @DY45037 07108000
         TM    SVER0F+D2,GVFVPMSP+GVFVSPIN PMR OR SPACE GETVIS @DY45037 07109000
         BNZ   GVGPMIN1_0          YES, MIN1/MIN2 PROCESSING   @DY45037 07110000
         TM    SVER0F+2,GVLOCANY  GETVIS IN PART. ABOVE AREA   @DY45037 07111000
         BO    GVGPMIN2           TAKE ALL PAGES FROM FREE QUE.@DY45037 07112000
GVGPMIN1_0 DS  0H                                              @DY45037 07113000
         L     R3,FIRSTPNT                                     @D218DKH 07114000
         LTR   R3,R3                                           @D218DKH 07115000
         BM    GVGPMIN2                                        @D218DKH 07116000
         USING SUBPINT,R2                                      @D14CDJB 07117000
         L     R3,SPITFRST        GET PTR TO 1ST PAGE IN POOL  @D218DKH 07118000
         DROP  R2                                              @D52VDKH 07119000
         LTR   R3,R3              SUBPOOL EMPTY ?              @D14CDJB 07120000
         BNM   GVGPAGSS           NO  ===>                     @D14CDJB 07121000
GVGPMIN2 EQU   *                                               @D14CDJB 07122000
         NI    GVFVFLGS,X'FF'-GVMIN2                           @D52VDKH 07123000
         LA    RF,SMERR0C         GET RETURN CODE              @D14CDJB 07124000
         BR    R7                 ===> RETURN TO CALLER        @D14CDJB 07125000
***************************************************************@D149DJB 07126000
*  NOW TRY TO FIND N-1 PAGES WHICH ARE CONTIGUOUS TO SUBPOOL  *@D149DJB 07127000
*  AND IF CHAINED WITH THESE PAGES WILL SATISFY REQUEST       *@D149DJB 07128000
***************************************************************@D149DJB 07129000
GVGPAGSS EQU   *                                               @D14CDJB 07130000
         L     R3,SVER00          GET REQUESTED LENGTH         @D14CDJB 07131000
         BCTR  R3,0               MINUS ONE                    @D14CDJB 07132000
         SRA   R3,LDVBYTBI(RB)    CONVERT IN BIT LENGTH        @D14CDJB 07133000
         LA    R3,D1(R3)          REQUESTED BIT LENGTH         @D14CDJB 07134000
         LR    R0,R3              R0 FOR FURTHER USE           @D14CDJB 07135000
         BCTR  R4,0               NUMBER OF PAGES MINUS ONE    @DA33314 07136000
         TM    GVFVFLGS,GVMIN2    N-2 PAGES TO LOOK FOR ?      @D52VDKH 07137000
         BNO   GVGIR5             NO, ==>                      @D218DKH 07138000
         BCTR  R4,0               NOPAGES - 1                  @D218DKH 07139000
         B     GVGIR3             DETERMINE START VALUE        @D218DKH 07140000
GVGIR5   EQU   *                                               @DA36211 07141000
***************************************************************         07142000
*   DETERMINE START VALUE FOR MIN1 PROCESSING                           07143000
***************************************************************         07144000
         TM    GVFVFLGS,GVFVABVE  THIS REQUEST FOR ABOVE       @D52VDKH 07145000
         BZ    GVGIR6             THEN THIS IS A VALID START   @D52VDKH 07146000
         TM    SVER0F+D3,PAGEIND  PAGE BOUNDARY REQUESTED ?    @D52VDKH 07147000
         BO    GVGIR3             YES, NOT A VALID START       @D52VDKH 07148000
GVGIR6   EQU   *                                               @D52VDKH 07149000
         SLR   R8,R8             START := SUBPOOL_Q -          @D218DKH 07150000
         LA    R9,SUBPCHNL       A_PAGE_DESCRIPTOR(NOPAGES-1)  @D218DKH 07151000
         MR    R8,R4                                           @D218DKH 07152000
         USING SUBPINT,R2                                      @D52VDKH 07153000
         L     R3,SPITFRST                                     @D218DKH 07154000
         SR    R3,R9                                           @D218DKH 07155000
         C     R3,BSUBPCHN      IF START < BSUBPCHN            @D218DKH 07156000
         BL    GVGIR3           THEN ==>                       @D218DKH 07157000
GVGIR4   EQU   *                                               @DA36211 07158000
         CLC   SPCHNMBR-SUBPCHN(2,R3),XFFFF    IF START SUBP_ID@D51IDMZ 07159000
         BE    GVGPAGLP                   < 0 THEN ==>         @D218DKH 07160000
GVGIR3   EQU   *                                               @DA36211 07161000
***************************************************************         07162000
*   DETERMINE START VALUE FOR MIN2 PROCESSING                           07163000
***************************************************************         07164000
         L     R3,FIRSTPNT        GET START POINT              @D14CDJB 07165000
         L     R8,SPITFRST        YES, START := FREE_Q         @D218DKH 07166000
         DROP  R2                                              @D52VDKH 07167000
GVGIR0   EQU   *                                               @DA36211 07168000
         CR    R3,R8              WHILE START < SUBPOOL_Q      @D218DKH 07169000
         BNL   GVGIR1                                          @D218DKH 07170000
         C     R3,SPCHFORW-SUBPCHN(R3)  IF START >= START.FORW @D218DKH 07171000
         BNL   GVGPN14                  THEN ==>               @D218DKH 07172000
         L     R3,SPCHFORW-SUBPCHN(R3)  ELSE                   @D218DKH 07173000
         B     GVGIR0                   START := START.FORW    @D218DKH 07174000
GVGIR1   EQU   *                                               @DA36211 07175000
         L     R8,SPCHBACK-SUBPCHN(R8)   SET LAST              @D218DKH 07176000
         TM    GVFVFLGS,GVMIN2    N-2 PAGES TO LOOK FOR ?      @D52VDKH 07177000
         BO    GVGIR2                 YES, ==>                 @D218DKH 07178000
         TM    SVER0F+D3,PAGEIND  PAGE BOUNDARY REQUESTED ?    @D52VDKH 07179000
         BZ    GVGIR7             NO, HAVE A VALID START       @D52VDKH 07180000
         TM    GVFVFLGS,GVFVABVE  REQUEST FOR ABOVE            @D52VDKH 07181000
         BZ    GVGIR2             NO, NOT A VALID START        @D52VDKH 07182000
GVGIR7   EQU   *                                               @D52VDKH 07183000
         C     R8,ESUBPCHN         END OF PAGE CHAIN ?         @D218DKH 07184000
         BE    GVGIR2              YES, ==>                    @D218DKH 07185000
         LA    R8,SUBPCHNL(R8)     LAST + A_PAGE_DESCRIPTOR(1) @D218DKH 07186000
GVGIR2   EQU   *                                               @DA36211 07187000
         CR    R3,R8                     IF START > LAST       @D218DKH 07188000
         BH    GVGPN14                   THEN ==>              @D218DKH 07189000
GVGPAGLP EQU   *                                               @DA36211 07190000
*SGLINK  GVGETPAG,INPUT=(R3,R4,R8:LINK,RC,RD,RF),OUTPUT=(R3,R5,R9,RF), *07191000
               NOMODR=(R0,R2,R4,R6,R7,RA,RB,RC,RD),AMODE=31             07192000
         SGAMSUBR SUBROUT=GVGETPAG,                            @D14CDJB*07193000
               INPUT=(R3,R4,RC,RD,RF),                         @D14CDJB*07194000
               OUTPUT=(R3,R5,R9,RF),                           @D14CDJB*07195000
               NOMOD=(R0,R2,R4,R6,R7,RA,RB,RC,RD),             @DA33314*07196000
               LINK=(R8),                                      @D14CDJB*07197000
               CBASE=OWN,                                      @D52VDKH*07198000
               SUBROUC=GVGPMIN1                                @D52VDKH 07199000
         LTR   RF,RF              PAGE(S) FOUND ?              @D14CDJB 07200000
         BNZ   GVGPN14            NO  ===>                     @D218DKH 07201000
***************************************************************@D149DJB 07202000
*  LOOK FOR REST OF REQUESTED SPACE WITH NEW PAGES INVOLVED   *@DA33314 07203000
***************************************************************@D149DJB 07204000
         LR    R5,R3              FIRST FOUND CHAIN ENTRY      @DA36211 07205000
         TM    SVER0F+D3,PAGEIND  PAGE BOUNDARY REQUESTED ?    @D52VDKH 07206000
         BZ    GVGPAG1            NO, INCLUDE PREVIOUS PAGE    @D52VDKH 07207000
         TM    GVFVFLGS,GVFVABVE  THIS REQUEST FOR ABOVE       @D52VDKH 07208000
         BZ    GVGPAGRP           NO, NEED NOT CHECK PREV. PAGE@D52VDKH 07209000
GVGPAG1  EQU   *                                               @D52VDKH 07210000
         C     R3,BSUBPCHN        DOES FOREGOING PAGE EXIST ?  @D14CDJB 07211000
         BNH   GVGPAGRP           NO  ===>                     @D14CDJB 07212000
         LA    R1,SUBPCHNL        CHAIN ENTRY LENGTH           @D14CDJB 07213000
         LR    RA,R3              FIRST FOUND CHAIN ENTRY      @D14CDJB 07214000
         SR    RA,R1              FOREGOING CHAIN ENTRY        @D14CDJB 07215000
         USING SUBPCHN,RA                                      @D14CDJB 07216000
         USING SUBPINT,R2                                      @D14CDJB 07217000
         CLC   SPITNMBR,SPCHNMBR      DOES FOREGOING CHAIN     @D51IDMZ 07218000
*                                    ENTRY BELONG TO SUBPOOL ? @D149DJB 07219000
         BNE   GVGPAGRP           NO  ===>                     @D14CDJB 07220000
         DROP  R2,RA                                           @D14CDJB 07221000
         LR    R5,RA              FIRST PAGE TO SCAN           @DA33314 07222000
GVGPAGRP EQU   *                                               @DA33314 07223000
         LR    RA,R9              LAST PAGE TO SCAN            @DA33314 07224000
         TM    SVER0F+D3,PAGEIND  PAGE BOUNDARY REQUESTED ?    @D52VDKH 07225000
         BZ    GVGPAG2            NO, INCLUDE FOLLOWING PAGE   @D52VDKH 07226000
         TM    GVFVFLGS,GVFVABVE  THIS REQUEST FOR ABOVE       @D52VDKH 07227000
         BNZ   GVGPAGCP           YES,NEED NOT CHECK FOLL. PAGE@D52VDKH 07228000
GVGPAG2  EQU   *                                               @D52VDKH 07229000
         C     R9,ESUBPCHN        DOES FOLLOWING PAGE EXIST ?  @DA33314 07230000
         BNL   GVGPAGCP           NO  ===>                     @DA36211 07231000
         LA    RA,SUBPCHNL(R9)    LAST FOUND CHAIN ENTRY + 1   @DA33314 07232000
         USING SUBPCHN,RA                                      @DA33314 07233000
         USING SUBPINT,R2                                      @DA33314 07234000
         CLC   SPITNMBR,SPCHNMBR      DOES FOLLOWING CHAIN     @D51IDMZ 07235000
*                                    ENTRY BELONG TO SUBPOOL ? @DA33314 07236000
         BE    GVGPAGPL           YES ===>                     @DA33314 07237000
         LR    RA,R9              LAST PAGE TO SCAN            @DA36211 07238000
         DROP  R2,RA                                           @DA33314 07239000
GVGPAGCP EQU   *                                               @DA36211 07240000
         CR    R3,R5              NEW PAGES RIGHT OR LEFT      @DA33314 07241000
*                                    CONTIGUOUS TO OLD ONES ?  @DA33314 07242000
         BE    GVGPAGNC           NO  ===>                     @DA36211 07243000
GVGPAGPL EQU   *                                               @DA33314 07244000
         TM    GVFVFLGS,GVMIN2    LOOKING FOR N-2 PAGES ?      @D52VDKH 07245000
         BNO   GVGPN11            NO, ==>                      @D218DKH 07246000
         CR    R3,R5              TWO ADDITIONAL PAGES         @D218DKH 07247000
         BE    GVGPAGNC           PRECEEDING AND               @D218DKH 07248000
         CR    R9,RA              FOLLOWING THE N-2 PAGES      @D218DKH 07249000
         BE    GVGPAGNC           ARE NEEDED                   @D218DKH 07250000
GVGPN11  EQU   *                                               @DA33314 07251000
         LR    R9,RA              LAST PAGE TO SCAN            @DA33314 07252000
         TM    SVER0F+D3,PAGEIND  PAGE BOUNDARY REQUESTED ?    @DA33314 07253000
         BNO   GVGPAGSV           NO  ===>                     @DA33314 07254000
         LR    RA,R5              SAVE FIRST PAGE POINTER      @DA33314 07255000
*SGLINK  GVSCPBDY,INPUT=(R0,R5,R8:LINK,R9,RB,RC),OUTPUT=(R1,R3,R4,RF), *07256000
               NOMODR=(R0,R2,R6,R7,R9,RA,RB,RC,RD),AMODE=31             07257000
         SGAMSUBR SUBROUT=GVSCPBDY,                            @DA33314*07258000
               NOMOD=(R0,R2,R6,R7,R9,RA,RB,RC,RD),             @DA33314*07259000
               INPUT=(R0,R5,R9,RB,RC),                         @DA33314*07260000
               OUTPUT=(R1,R3,R4,RF),                           @DA33314*07261000
               LINK=(R8),         LOOK FOR SPACE ON 2K BDY.    @DA33314*07262000
               CBASE=OWN,                                      @D52VDKH*07263000
               SUBROUC=GVGPMIN1                                @D52VDKH 07264000
         LR    R5,RA              RESTORE FIRST PAGE POINTER   @DA33314 07265000
         B     GVGPAGCC           ===> GOTO COMMON CODE        @DA33314 07266000
GVGPAGSV EQU   *                                               @DA33314 07267000
         SR    R3,R3              RESET CURRENT BIT MASK       @DA33314 07268000
*SGLINK  GVSCVSTB,INPUT=(R0,R3,R5,R8:LINK,R9,RB,RC,RF),OUTPUT=(R1,R3,  *07269000
               R4,RF),NOMODR=(R0,R2,R6,R7,R9,RA-RC,RD),AMODE=31         07270000
         SGAMSUBR SUBROUT=GVSCVSTB,                            @DA33314*07271000
               INPUT=(R0,R3,R5,R9,RB,RC,RF),                   @DA33314*07272000
               OUTPUT=(R1,R3,R4,RF),                           @DA33314*07273000
               NOMOD=(R0,R2,R6,R7,R9,RB,RC,RD),                @DA33314*07274000
               LINK=(R8),         SCAN VISTAB                  @DA33314*07275000
               CBASE=OWN,                                      @D52VDKH*07276000
               SUBROUC=GVGPMIN1                                @D52VDKH 07277000
GVGPAGCC EQU   *                                               @DA33314 07278000
         SR    R8,R8                                           @DA33314 07279000
         USING SUBPCHN,R9                                      @DA33314 07280000
         USING SUBPINT,R2                                      @DA33314 07281000
         CLC   SPITNMBR,SPCHNMBR      IS LAST ENTRY NEW ONE ?  @D51IDMZ 07282000
         BNE   GVGPAGNN           YES ===>                     @DA33314 07283000
         LA    R8,SUBPCHNL        CHAIN ENTRY LENGTH           @DA33314 07284000
         DROP  R9                                              @DA33314 07285000
GVGPAGNN EQU   *                                               @DA33314 07286000
         LTR   RF,RF              SPACE FOUND ?                @DA33314 07287000
         BZ    GVGPAGEN           YES ===> RETURN              @DA33314 07288000
         SR    R9,R8              SKIP BACK TO NEW ONE         @DA33314 07289000
         LR    RF,R5              CALCULATE FIRST FREE PAGE    @D52VDKH 07290000
         USING SUBPCHN,RF                                      @D52VDKH 07291000
         CLC   SPITNMBR,SPCHNMBR      IS FIRST ENTRY NEW ONE ? @D52VDKH 07292000
         DROP  RF                                              @D52VDKH 07293000
         BNE   GVGPAGN1           YES ===>                     @D52VDKH 07294000
         LA    RF,SUBPCHNL(,RF)     NEXT ONE IS IT             @D52VDKH 07295000
GVGPAGN1 EQU   *                                               @D52VDKH 07296000
         L     R4,SVER00          RESTORE                      @DA33314 07297000
         A     R4,PAGESIZE           NUMBER                    @DA33314 07298000
         BCTR  R4,0                    OF REQUESTED            @DA33314 07299000
         SRL   R4,PNSHIFT                       PAGES          @DA33314 07300000
         BCTR  R4,0                    MINUS ONE               @DA36211 07301000
         TM    GVFVFLGS,GVMIN2    N-2 PAGES TO LOOK FOR ?      @D52VDKH 07302000
         BNO   GVGPAGNC           NO, ==>                      @D218DKH 07303000
         BCTR  R4,0               NUMBER OF PAGES MINUS TWO    @D218DKH 07304000
GVGPAGNC EQU   *                                               @DA33314 07305000
***************************************************************         07306000
*        PAGES WERE FOUND BUT GAP IS NOT BIG ENOUGH                     07307000
***************************************************************         07308000
         L     R3,SPITFRST                 IF                  @D218DKH 07309000
         L     RA,SPCHBACK-SUBPCHN(R3)     FOUND > LAST        @D218DKH 07310000
         CR    R9,RA                                           @D218DKH 07311000
         BH    GVGPN14                     THEN ==>            @D218DKH 07312000
         LR    R5,R9                                           @D218DKH 07313000
GVGNESUB EQU   *                                               @DA33314 07314000
         CR    R3,R9                WHILE NEXT_IN_SUB < FOUND  @D218DKH 07315000
         BNL   GVGNIS                                          @D218DKH 07316000
         L     R3,SPCHFORW-SUBPCHN(R3)  NEXT_IN_SUB :=         @D218DKH 07317000
         B     GVGNESUB                 NEXT_IN_SUB.FORW       @D218DKH 07318000
GVGNIS   EQU   *                                               @D218DKH 07319000
         TM    GVFVFLGS,GVMIN2    N-2 PAGES TO LOOK FOR ?      @D52VDKH 07320000
         BO    GVGNSTRT                                        @D218DKH 07321000
         TM    SVER0F+D3,PAGEIND  PAGE BOUNDARY REQUESTED ?    @D52VDKH 07322000
         BZ    GVGPAG3            NO,                          @D52VDKH 07323000
         TM    GVFVFLGS,GVFVABVE  THIS REQUEST FOR ABOVE       @D52VDKH 07324000
         BNZ   GVGNSTRT           YES,                         @D52VDKH 07325000
GVGPAG3  EQU   *                                               @D52VDKH 07326000
         LA    RA,SUBPCHNL(RA)    LAST := LAST+1               @D218DKH 07327000
         SLR   R8,R8                                           @D218DKH 07328000
         LA    R9,SUBPCHNL        START :=                     @D218DKH 07329000
         MR    R8,R4              NEXT_IN_SUB -                @D218DKH 07330000
         LR    R8,R3              A_PAGE_DESCRIPTOR(NOPAGES-1) @D218DKH 07331000
         SR    R8,R9                                           @D218DKH 07332000
         CR    R8,RF              START < FOUND ?              @D52VDKH 07333000
         BNH   GVGNSTRT           THEN ==>                     @D218DKH 07334000
         CLC   SPCHNMBR-SUBPCHN(2,R8),XFFFF    IF NEXT_IN_SUB  @D51IDMZ 07335000
         BNE   GVGNSTRT                  NOT IN FREE_Q ==>     @D218DKH 07336000
         LR    R3,R8                                           @D218DKH 07337000
         SLR   RF,RF                     CLEAR RETURN CODE     @D218DKH 07338000
         B     GVGPAGLP                  START AGAIN           @D218DKH 07339000
GVGNSTRT EQU   *                                               @DA33314 07340000
         C     R5,SPCHFORW-SUBPCHN(R5)  IF START >= START.FORW @D218DKH 07341000
         BNL   GVGPN14                  THEN ==>               @D218DKH 07342000
         L     R5,SPCHFORW-SUBPCHN(R5)  ELSE                   @D218DKH 07343000
         CR    R5,R3                    START := START.FORW    @D218DKH 07344000
         BL    GVGNSTRT                 UNTIL                  @D218DKH 07345000
         LR    R3,R5                    START > NEXT_IN_SUB    @D218DKH 07346000
         CR    R5,RA                    IF START <= LAST       @D218DKH 07347000
         BH    GVGPN14                  NO, ==>                @D218DKH 07348000
         SLR   RF,RF                    CLEAR RETURN CODE      @D218DKH 07349000
         B     GVGPAGLP                 THEN START AGAIN       @D218DKH 07350000
GVGPN14  EQU   *                                               @D218DKH 07351000
         TM    GVFVFLGS,GVMIN2    N-2 PAGES TO LOOK FOR ?      @D52VDKH 07352000
         BNO   GVGPN12            NO, ==>                      @D218DKH 07353000
         NI    GVFVFLGS,X'FF'-GVMIN2 RESET INDICATOR           @D52VDKH 07354000
         LA    R4,2(R4)           LOOK FOR N-1                 @D218DKH 07355000
         SLR   RF,RF              CLEAR RETURN CODE            @D218DKH 07356000
         B     GVGPAGSS           PAGES                        @D218DKH 07357000
GVGPN12  EQU   *                                               @D218DKH 07358000
         LA    RF,SMERR0C         GET ERROR CODE               @DA33314 07359000
         B     GVGPAGRT           ===> RETURN TO CALLER        @DA33314 07360000
***************************************************************@DA33314 07361000
*  SPACE FOUND UPDATE ALL RELEVANT FIELDS                     *@DA33314 07362000
*   INPUT: R1 ; LAST VISTAB BYTE                              *@D51XDMZ 07363000
*          R2 : SUBPOOL INDEX TABLE ENTRY                     *@D51XDMZ 07364000
*          R3 : OFFSET WITHIN LAST VISTAB BYTE                *@D51XDMZ 07365000
*          R4 : FOUND ADDRESS                                 *@D51XDMZ 07366000
*          R5 : FIRST CHAIN ENTRY PTR                         *@D51XDMZ 07367000
*          R8 : 0 OR LENGTH OF PAGE CHAIN ENTRY               *@D51XDMZ 07368000
*          R9 : LAST PAGE CHAIN ENTRY PTR (IS EITHER ENTRY OF *@D51XDMZ 07369000
*               LAST NEW ENQUEUED PAGE (R8=0) OR FOLLOWING    *@D51XDMZ 07370000
*               ENTRY (R8 = SUBPCHNL)                         *@D51XDMZ 07371000
***************************************************************@DA33314 07372000
GVGPAGEN EQU   *                                               @DA33314 07373000
         SR    R9,R8              SKIP EVENT. BACK TO NEW ONE  @DA33314 07374000
         C     R9,GTVSHIGH        R9 <= GTVSHIGH               @D51XDMZ 07375000
         BNH   GVGPSKIP           YES                          @D51XDMZ 07376000
         ST    R9,GTVSHIGH        STORE NEW HIGH WATER MARK    @D51XDMZ 07377000
GVGPSKIP DS    0H                                              @D51XDMZ 07378000
         ST    R5,SAVREG5         SAVE R5 FOR LATER USE        @D51XDMZ 07379000
         ST    R9,SAVREG9         SAVE R9 FOR LATER USE        @D51XDMZ 07380000
         SR    R9,R9              INPUT FOR GVUPPI             @D51XDMZ 07381000
*SGLINK  GVUPPIE0,INPUT=(R1,R2,R3,R4,R8:LINK,R9,RB,RC,RD,RF),          *07382000
               OUTPUT=(R0,R1,R3,RF),NOMODR=(R2,R6,R7,RA-RC,RD),        *07383000
               NOMODS=(SAVREG5,SAVREG9),AMODE=31                        07384000
         SGAMSUBR SUBROUT=GVUPPIE0,                            @D51XDMZ*07385000
               INPUT=(R1,R2,R3,R4,R9,RB,RC,RD,RF),             @D51XDMZ*07386000
               OUTPUT=(R0,R1,R3,RF),                           @D51XDMZ*07387000
               NOMOD=(R2,R6,R7,RB,RC,RD),                      @D51XDMZ*07388000
               NOMODS=(SAVREG5,SAVREG9),                       @D52VDMZ*07389000
               LINK=(R8),                                      @D51XDMZ*07390000
               CBASE=OWN,                                      @D52VDKH*07391000
               SUBROUC=GVGPMIN1                                @D52VDKH 07392000
         LR    RF,R2              SAVE INDEX TABLE POINTER     @DA33314 07393000
         DROP  R2                                              @DA33314 07394000
*SGLINK  SETVSTAB,INPUT=(R0,R1,R3,R8:LINK,RC),                         *07395000
               NOMODR=(R6,RA,RB,RC,RD,RF),AMODE=31,                    *07396000
               NOMODS=(SAVREG5,SAVREG9)                                 07397000
         SGAMSUBR SUBROUT=SETVSTAB,                            @DA33314*07398000
               INPUT=(R0,R1,R3,RC),                            @DA33314*07399000
               NOMOD=(R6,RA,RB,RC,RD,RF),                      @D51XDMZ*07400000
               IGN=(R2),                                       @D52VDMZ*07401000
               LINK=(R8),                                      @DA33314*07402000
               CBASE=OWN,                                      @D52VDKH*07403000
               SUBROUC=GVGPMIN1                                @D52VDKH 07404000
         LR    R2,RF              RESTORE INDEX TABLE POINTER  @DA33314 07405000
         SR    RF,RF              CLEAR RETURN CODE REGISTER   @D51XDMZ 07406000
         L     R3,SAVREG5         RESTORE 1ST CHAIN ENTRY PTR  @D51XDMZ 07407000
         L     R9,SAVREG9         RESTORE LST CHAIN ENTRY PTR  @D51XDMZ 07408000
         USING SUBPINT,R2                                      @DA33314 07409000
         USING SUBPCHN,R3                                      @DA33314 07410000
         CLC   SPITNMBR,SPCHNMBR  IS FIRST ENTRY NEW ONE ?     @D51IDMZ 07411000
         BNE   GVGPAGNF           YES ===>                     @DA33314 07412000
         LA    R3,SUBPCHNL(R3)    SKIP FORWARD TO NEW ONE      @DA33314 07413000
         DROP  R2,R3                                           @DA33314 07414000
GVGPAGNF EQU   *                                               @DA33314 07415000
         L     R4,SVER00          RESTORE                      @DA33314 07416000
         A     R4,PAGESIZE           NUMBER                    @DA33314 07417000
         BCTR  R4,0                    OF                      @DA33314 07418000
         SRL   R4,PNSHIFT               ADDITIONAL             @DA33314 07419000
         BCTR  R4,0                            PAGES           @DA33314 07420000
         TM    GVFVFLGS,GVMIN2    N-2 PAGES TO LOOK FOR ?      @D52VDKH 07421000
         BNO   GVGPN13            NO, ==>                      @D218DKH 07422000
         BCTR  R4,0               NUMBER OF PAGES MINUS TWO    @D218DKH 07423000
GVGPN13  EQU   *                                               @D218DKH 07424000
         LA    R5,FIRSTPNT-(SPITFRST-SUBPINT)  DUMMY INDEX PTR @DA33314 07425000
*SGLINK  GFENQDEQ,INPUT=(R2,R3,R4,R5,R8:LINK,R9,RC),OUTPUT=(RF),       *07426000
               NOMODR=(R2,R3,R6,RA-RC,RD),AMODE=31,                    *07427000
               NOMODS=(SAVREG5,SAVREG9)                                 07428000
         SGAMSUBR SUBROUT=GFENQDEQ,                            @DA33314*07429000
               INPUT=(R2,R3,R4,R5,R9,RC),                      @DA33314*07430000
               OUTPUT=(RF),                                    @D51XDMZ*07431000
               NOMOD=(R2,R3,R6,RB,RC,RD),                      @DA33314*07432000
               NOMODS=(SAVREG5,SAVREG9),                       @D52VDMZ*07433000
               LINK=(R8),                                      @DA33314*07434000
               CBASE=OWN,                                      @D52VDKH*07435000
               SUBROUC=GVGPMIN1                                @D52VDKH 07436000
***************************************************************@D149DJB 07437000
*  RESTORE TCB POINTER AND RETURN TO CALLER                   *@D149DJB 07438000
***************************************************************@D149DJB 07439000
GVGPAGRT EQU   *                                               @D14CDJB 07440000
         L     RA,TCBPTR          RESTORE TCB PTR              @D14CDJB 07441000
         NI    GVFVFLGS,X'FF'-GVMIN2  RESET INDICATOR          @D52VDKH 07442000
         BR    R7                 ===> RETURN TO CALLER        @D14CDJB 07443000
         DROP  RC,RD,RE                                        @D52VDKH 07444000
         EJECT ,                                               @D37CDFG 07445000
***************************************************************@D52VDMZ 07446000
*                                                              @D52VDMZ 07447000
*   ROUTINE DO TO FETCH / KEY PROTECTION                       @D52VDMZ 07448000
*    IT IS CALLED WHEN PAGES WERE TAKEN FROM THE FREE QUEUE    @D52VDMZ 07449000
*    SINCE OTHERWISE THE AFFECTED AREA IS ALREADY PROTECTED    @D52VDMZ 07450000
*                                                              @D52VDMZ 07451000
*   MODULE GVPROT                                              @D52VDMZ 07452000
*     IF USER REQUESTED FETCH OR KEY PROTECTION                @D52VDMZ 07453000
*       THEN CALL PAGE MANAGER TO DO PROTECTION                @D52VDMZ 07454000
*       ELSE RETURN                                            @D52VDMZ 07455000
*     EXIT GVPROT                                              @D52VDMZ 07456000
*   ENDMODULE GVPROT                                           @D52VDMZ 07457000
*                                                              @D52VDMZ 07458000
*     CALLED BY : SGAM                                         @D52VDMZ 07459000
*     CALLS     :                                              @D52VDMZ 07460000
*                                                              @D52VDMZ 07461000
*     INPUT    RC  :  ANCHOR TABLE                             @D52VDMZ 07462000
*              RD  :  REQUESTOR SAVE AREA                      @D52VDMZ 07463000
*              RE  :  BASE                                     @D52VDMZ 07464000
*              FPAGEPRO : PAGE CHAIN ENTRY OF FIRST PROT.PAGE  @D52VDMZ 07465000
*              LPAGEPRO : PAGE CHAIN ENTRY OF LAST PROT. PAGE  @D52VDMZ 07466000
*     OUTPUT : RF  : 0                                                  07467000
*     LINK   : R7                                              @D52VDMZ 07468000
*     WORK   : R0,R1,R2,R8                                     @D52VDMZ 07469000
*                                                              @D52VDMZ 07470000
*   AUXILIARY WORK FIELDS : NONE                               @D52VDMZ 07471000
*                                                              @D52VDMZ 07472000
         AGO    .CREATEJ                                       @D52VDMZ 07473000
.GVPROT  ANOP                                                  @D52VDMZ 07474000
.*             0123456789ABCDEF                                @D52VDMZ 07475000
&INPREG  SETC '0000000000001110'                               @D52VDMZ 07476000
&OUTREG  SETC '0000000000000001'                               @D52VDMZ 07477000
&WRKREG  SETC '1110000010000000'                               @D52VDMZ 07478000
&NMDREG  SETC '0001111101111110'                               @D52VDMZ 07479000
&LINKR   SETC 'R7'                                             @D52VDMZ 07480000
&TBASE   SETC 'OWN'                                            @D52VDKH 07481000
.*EXCLSYMS=()                                                  @D52VDMZ 07482000
         AGO    .TESTALL                                       @D52VDMZ 07483000
.CREATEJ ANOP                                                  @D52VDMZ 07484000
***************************************************************@D52VDMZ 07485000
         SPACE 2                                               @D52VDMZ 07486000
         USING ANCHTAB,RC                                      @D52VDMZ 07487000
         USING SVEARA,RD                                       @D52VDMZ 07488000
         USING GVPROT,RE                                       @D52VDMZ 07489000
GVPROT   DS    0H                                              @D52VDMZ 07490000
*SGLINK  GVPROT,S,INPUT=(R7:LINK,RA-RD),OUTPUT=(RF),                   *07491000
               WORK=(R0-R2,R8,R9,RE),NOMODR=(R7),                      *07492000
               AMODE=31,SUBROUT=(GFSTKEYP)                              07493000
         NI    GVFVFLGS,XFF-GVCHKPRO   RESET NEW PAGE INDICATOR@D52VDMZ 07494000
         L     R1,SPIDSAV                                      @D64ADKH 07495000
         USING SUBPINT,R1                                      @D64ADKH 07496000
         SR    R2,R2                                           @D64ADKH 07497000
         IC    R2,SPITKEY                                      @D64ADKH 07498000
         TM    SPITFLAG,SPFTCHPR                               @D64ADKH 07499000
         BZ    GVPROT00                NO, CHECK FOR KEY       @D52VDMZ 07500000
         LA    R1,X08                                          @D64ADKH 07501000
         OR    R2,R1                                           @D64ADKH 07502000
         B     GVPROT10                COMMON PROCESSING       @D52VDMZ 07503000
GVPROT00 DS    0H                                              @D52VDMZ 07504000
         TM    SPITFLAG,SPPKEYPR                               @D64ADKH 07505000
         DROP  R1                                              @D64ADKH 07506000
         BZR   R7                      NO, RETURN              @D52VDMZ 07507000
GVPROT10 DS    0H                      COMMON PROCESSING       @D52VDMZ 07508000
         L     R0,FPAGEPRO             1ST PAGE DESCRIPTOR     @D52VDMZ 07509000
         S     R0,BSUBPCHN             OFFSET IN CHAIN TABLE   @D52VDMZ 07510000
         SLL   R0,PNSHIFT-SUBPCHN2     OFFS. OF PAGE IN STORAGE@D52VDMZ 07511000
         A     R0,BVIRTMEM             ABS. ADDRESS OF PAGE    @D52VDMZ 07512000
         L     R1,LPAGEPRO             LST PAGE DESCRIPTOR     @D52VDMZ 07513000
         S     R1,BSUBPCHN             OFFSET IN CHAIN TABLE   @D52VDMZ 07514000
         SLL   R1,PNSHIFT-SUBPCHN2     OFFS. OF PAGE IN STORAGE@D52VDMZ 07515000
         A     R1,BVIRTMEM             ABS. ADDRESS OF PAGE    @D52VDMZ 07516000
GVPROT20 DS    0H                      COMMON PROCESSING       @D52VDMZ 07517000
*SGLINK  GFSTKEYP,INPUT=(R0,R1,R2,R8:LINK,RA,RB,RC),OUTPUT=(RF),       *07518000
               NOMODR=(R3,R4,R6,R7,RA,RB,RC,RD),AMODE=31                07519000
         SGAMSUBR SUBROUT=GFSTKEYP,                            @D52VDMZ*07520000
               INPUT=(R0,R1,R2,RA,RB,RC),                      @D52VDMZ*07521000
               NOMOD=(R3,R4,R6,R7,RA,RB,RC,RD,RE),             @D52VDMZ*07522000
               OUTPUT=(RF),                                    @D52VDMZ*07523000
               LINK=(R8),         SET STORAGE KEY TO ZERO      @D52VDMZ*07524000
               SUBROUC=GVPROT,                                 @D52VDMZ*07525000
               CBASE=OWN                                       @D52VDMZ 07526000
         BR    R7                 ===> RETURN TO CALLER        @D52VDMZ 07527000
         DROP  RC,RD,RE           REL. ANCHTAB,SAVE AREA, BASE @D52VDMZ 07528000
         EJECT ,                                               @D52VDMZ 07529000
***************************************************************@D149DJB 07530000
*                                                             *@D149DJB 07531000
*   ROUTINE TO SCAN VISTAB                                    *@D149DJB 07532000
*                                                                    RZ 07533000
*        THIS ROUTINE SEARCHES A BITSTRING OF '0'S WHICH       @D369DJB 07534000
*        REPRESENT THE REQUIRED LENGTH CONTAINED IN REG 0.     @D369DJB 07535000
*        THE SEARCH STARTS AT THE CURRENT                      @D369DJB 07536000
*        POINTER AND CONTINUES UNTIL A BITSTRING IS FOUND OR THE     RZ 07537000
*        VISTAB IS EXHAUSTED. FURTHERMORE THE CURRENT POINTER IS        07538000
*        UPDATED TO POINT TO THE FIRST GAP (IF GVUPDCP IS SET).         07539000
*                                                              @D369DJB 07540000
*   MODULE GVSCVSTB                                            @D149DJB 07541000
*     IF REQUESTED SPACE FOUND IN GIVEN AREA                   @D149DJB 07542000
*       THEN SET RC = 00                                       @D149DJB 07543000
*       ELSE SET RC = 0C                                       @D149DJB 07544000
*     EXIT GVSCVSTB                                            @D149DJB 07545000
*   ENDMODULE GVSCVSTB                                         @D149DJB 07546000
*                                                              @D149DJB 07547000
*   NOTE : 8 VISTAB BYTES REPRESENT 1 K BYTES IN THE SVA       @D149DJB 07548000
*          1 VISTAB BYTE REPRESENTS 1 K BYTES IN THE PARTITION @D149DJB 07549000
*                                                              @D149DJB 07550000
*     CALLED BY : GVSBPOOL                                     @D149DJB 07551000
*     CALLS     :   ---                                        @D149DJB 07552000
*                                                              @D149DJB 07553000
*     INPUT  : R0  :  LENGTH OF REQUESTED AREA IN VISTAB BITS  @D149DJB 07554000
*              R3  :  CURRENT BIT POINTER (BIT MASK), I.E. BITS IN      07555000
*                     VISTAB BYTE TO BE SKIPPED, BECAUSE OF:            07556000
*                     A) VISTAB BITS ARE ONE OR                         07557000
*                     B) VISTAB BITS TO BE IGNORED (E.G. PAGE=YES AND   07558000
*                        REQUEST FOR ABOVE)                             07559000
*              R5 --> PAGE (CHAIN TABLE ENTRY) TO START SEARCH @D149DJB 07560000
*              R9 --> PAGE (CHAIN TABLE ENTRY) TO END SEARCH   @D149DJB 07561000
*              RB  :  SHIFT MODIFIER FOR SVA REQUESTS          @D149DJB 07562000
*              RC --> ANCHOR TABLE                             @D149DJB 07563000
*              RF  :  CURRENT PAGE VISTAB POINTER              @D149DJB 07564000
*     OUTPUT : R1 --> LAST SCANNED BYTE IN VISTAB (IF FOUND)   @D149DJB 07565000
*              R3  :  BIT OFFSET IN LAST VISTAB BYTE           @D149DJB 07566000
*              R4 --> REQUESTED GETVIS SPACE                   @D149DJB 07567000
*              RF  :  RETURN CODE : 0C (SPACE NOT FOUND)       @D149DJB 07568000
*     LINK   : R8                                              @D149DJB 07569000
*     WORK   : R1,R3,R4,RF                                     @D149DJB 07570000
*                                                              @D149DJB 07571000
*   AUXILIARY WORK FIELDS (UPDATED IN ANCHOR TABLE) :          @D149DJB 07572000
*     SSEARCH : VISTAB BYTE ADDRESS OF FOUND AREA              @D149DJB 07573000
*     SVWORK1 : BIT OFFSET IN SSEARCH OF FOUND AREA (0..7)     @D149DJB 07574000
*                                                              @D149DJB 07575000
         AGO    .CREATEH                                       @D14ZDJB 07576000
.GVSCVSB ANOP                                                  @D14ZDJB 07577000
.*             0123456789ABCDEF                                @D149DJB 07578000
&INPREG  SETC '1001010001011001'                               @D14ZDJB 07579000
&OUTREG  SETC '0101100000000001'                               @D14ZDJB 07580000
&WRKREG  SETC '0101100000000000'                               @D52VDMZ 07581000
&NMDREG  SETC '1010011111111110'                               @D14ZDJB 07582000
&LINKR   SETC 'R8'                                             @D14ZDJB 07583000
&TBASE   SETC 'OWN'                                            @D51IDMZ 07584000
.*EXCLSYMS=(SVWORK1,SSEARCH)                                   @D52VDMZ 07585000
         AGO    .TESTALL                                       @D14ZDJB 07586000
.GVSCVS1 ANOP                                                  @D14ZDJB 07587000
.*             0123456789ABCDEF                                @D61NDMZ 07588000
&INPREG  SETC '1011010001011001'                               @D61NDMZ 07589000
&OUTREG  SETC '0101100000000001'                               @D61NDMZ 07590000
&WRKREG  SETC '0101110000000000'                               @D61NDMZ 07591000
&NMDREG  SETC '1010001111111110'                               @D61NDMZ 07592000
&LINKR   SETC 'R8'                                             @D14ZDJB 07593000
&TBASE   SETC 'OWN'                                            @D51IDMZ 07594000
.*EXCLSYMS=(SVWORK1,SSEARCH)                                   @D52VDMZ 07595000
.*EXCLSYMS=(SAVREG0,SAVREG1,SAVREG2,SAVREG3,SAVREG4,SAVREG5,SAVREG6)    07596000
.*EXCLSYMS=(SAVREG7,SAVREG8,SAVREG9)                                    07597000
         AGO    .TESTALL                                       @D14ZDJB 07598000
.CREATEH ANOP                                                  @D14ZDJB 07599000
***************************************************************@D149DJB 07600000
         SPACE 2                                               @D14CDJB 07601000
         USING ANCHTAB,RC                                      @D14CDJB 07602000
         USING GVSCVSTB,RE                                     @D52VDMZ 07603000
GVSCVSTB DS    0H                                              @D14CDJB 07604000
*SGLINK  GVSCVST1,S,INPUT=(R0,R2,R3,R5,R8:LINK,R9,RB,RC,RF),           *07605000
               OUTPUT=(R1,R3,R4,RF),WORK=(R1,R3-R4),NOMODR=(R8),       *07606000
               AMODE=31,MODSYM=(SVWORK1,SSEARCH,                       *07607000
               SAVREG0,SAVREG1,SAVREG2,SAVREG3,SAVREG4,SAVREG5,        *07608000
               SAVREG6,SAVREG7,SAVREG8,SAVREG9)                         07609000
*SGLINK  GVSCVSTB,S,INPUT=(R0,R3,R5,R8:LINK,R9,RB,RC,RF),              *07610000
               OUTPUT=(R1,R3,R4,RF),WORK=(R1,R3,R4),NOMODR=(R8),       *07611000
               AMODE=31,MODSYM=(SVWORK1,SSEARCH,                       *07612000
               SAVREG0,SAVREG1,SAVREG2,SAVREG3,SAVREG4,SAVREG5,        *07613000
               SAVREG6,SAVREG7,SAVREG8,SAVREG9)                         07614000
.* A LENGTH 0 REQUEST SEARCHES FOR A GAP WITHIN THE EXISTING SUBPOOL.   07615000
.* A GAP MEANS, THERE IS AT LEAST ONE FREE BIT. SO THE SEARCH FOR A     07616000
.* LENGTH 0 REQUEST IS THE SAME AS THE SEARCH FOR A LENGTH 128 REQUEST, 07617000
.* EXCEPT THAT NO STORAGE IS RESERVED.                                  07618000
.* A LENGTH 0 REQUEST DIDN'T WORK IN ALL CASES, SINCE THE END CRITERIA  07619000
.* WAS NOT MET. THEREFORE, SEARCH WAS CHANGED TO ONE BIT.               07620000
         LTR   R0,R0              REQUEST WITH LENGTH 0                 07621000
         BNZ   GETVIS00           NO                                    07622000
         LA    R0,1(,R0)          SEARCH ONE BIT               @D61NDMZ 07623000
         OI    GVFVFLG2,GVLNG0RQ  INDICATE LENGTH 0 REQUEST    @D64ADKH 07624000
GETVIS00 DS    0H                                                       07625000
         SR    R1,R1              CLEAR REGISTER               @D367DJB 07626000
         USING SUBPCHN,R5                                      @D14CDJB 07627000
         A     RF,SPCHVSTB        GET RELATIVE VISTAB START    @D51IDMZ 07628000
         DROP  R5                                              @D14CDJB 07629000
         L     RA,PAGESIZE        GET PAGE VALUE               @D14CDJB 07630000
         SRL   RA,LDVBYTB(RB)     VISTAB BYTE REPRESENTATION   @D14CDJB 07631000
         USING SUBPCHN,R9                                      @D14CDJB 07632000
         A     RA,SPCHVSTB        GET RELATIVE BYTE ADDRESS    @D51IDMZ 07633000
         DROP  R9                                              @D14CDJB 07634000
         SR    RA,RF              # OF VISTAB BYTES TO SCAN    @D14CDJB 07635000
         SLL   RA,LDBITBYT        # OF VISTAB BITS TO SCAN     @D14CDJB 07636000
         A     RF,BVISTAB         ABSOLUTE SCAN START IN VISTAB@D61NDMZ 07637000
         CR    RA,R0              ENOUGH SPACE ?               @D14CDJB 07638000
         BL    GVSCVR0C           NO  ===> SET RETURN CODE     @D14CDJB 07639000
         SR    R4,R4                                           @D14CDJB 07640000
         ST    R4,SVWORK1         CLEAR SHIFT COUNTER FIELD    @D14CDJB 07641000
         LA    R1,X'FF'           SET LOW ORDER BYTE           @D218DKH 07642000
         NR    R3,R1              CLEAR HIGH ORDER BYTES       @D218DKH 07643000
         XR    R1,R3              ALL BITS SET IN R3 ?         @D218DKH 07644000
         BNZ   GETVIS6            NO, ==>                      @D218DKH 07645000
GETVIS50 DS    0H                                              @D218DKH 07646000
         LA    R3,BITBYT          NO. OF BITS PER BYTE         @D218DKH 07647000
         LA    RF,D1(RF)          GO TO NEXT VISTAB BYTE       @D61NDMZ 07648000
         SR    RA,R3              DECR. NO. OF VISTAB BITS     @D218DKH 07649000
         CR    RA,R0              STILL ENOUGH AVAILABLE ?     @D218DKH 07650000
         BL    GVSCVR0C           NO, ==>                      @D218DKH 07651000
         NI    GVFVFLGS,XFF-GVFIRSTT NO GAP AT CURRENT PTR     @D61NDMZ 07652000
         B     GETVIS48           GO SKIP "X'FF'" BYTES        @D218DKH 07653000
GETVIS6  EQU   *                                               @D218DKH 07654000
         SR    R1,R1                                           @D218DKH 07655000
         ST    RF,SSEARCH         SEARCH START ADDRESS         @D14CDJB 07656000
         IC    R4,D0(RF)          GET BYTE FROM VISTAB         @D14CDJB 07657000
         OR    R4,R3              PREVENT SEARCHING IN 1ST POS., NEC.  *07658000
                                  BECAUSE OF PAGE ALIGNM. ABOVE@D52VDMZ 07659000
         LA    R3,X'FF'                                        @D218DKH 07660000
         XR    R3,R4              BYTE EXHAUSTED ?             @D218DKH 07661000
         BZ    GETVIS50           YES, ==>                     @D218DKH 07662000
************************************************************** @D369DJB 07663000
*   NOW START SEARCH FOR REQUESTED GETVIS AREA               * @D369DJB 07664000
*   AND UPDATE CURRENT POINTER IF NECESSARY                  * @D369DJB 07665000
************************************************************** @D369DJB 07666000
         LTR   R4,R4              START WITH FIRST BIT ?       @D52VDKH 07667000
         BNZ   GETVIS65           NO ===>                      @D52VDKH 07668000
         TM    GVFVFLGS,GVFIRSTT  ENTRY FOR THE FIRST TIME     @D61NDMZ 07669000
         BO    GETVIS80           CURRENT POINTER IS CORRECT   @D61NDMZ 07670000
         TM    GVFVFLGS,GVUPDCP   UPDATE CURRENT PTR REQUESTED @D61NDMZ 07671000
         BZ    GETVIS60           NO                           @D61NDMZ 07672000
         NI    GVFVFLGS,XFF-GVUPDCP STOP SCAN FOR GAP          @D61NDMZ 07673000
         USING SUBPINT,R2         ADDRESS SUBPOOL              @D61NDMZ 07674000
         ST    R5,SPITCURP        SET CURRENT ..               @D61NDMZ 07675000
         MVI   SPITRLVB,X'00'     .. POINTER TO FOUND ..       @D61NDMZ 07676000
         MVI   SPITBITO,X'00'     .. GAP                       @D61NDMZ 07677000
         DROP  R2                                              @D61NDMZ 07678000
GETVIS80 DS    0H                                              @D61NDMZ 07679000
         NI    GVFVFLGS,XFF-GVUPDCP-GVFIRSTT                   @D61NDMZ 07680000
GETVIS60 DS    0H                                              @D61NDMZ 07681000
         LA    R3,BITBYT          LESS THAN A VISTAB BYTE      @D218DKH 07682000
         CR    R0,R3              TO BE TESTED ?               @D218DKH 07683000
         BL    GETVIS65           YES ===>                     @D218DKH 07684000
         LR    R3,R0                                           @D218DKH 07685000
         B     GETVIS4            TEST WHOLE VISTAB BYTES      @D218DKH 07686000
GETVIS65 DS    0H                                                    RZ 07687000
         SR    R3,R3                                           @D218DKH 07688000
         B     PCKGVIS1                                        @D218DKH 07689000
GETVIS22 EQU   * .                                                   RZ 07690000
         SR    R4,R4                                           @D367DJB 07691000
         IC    R4,D0(RF)          GET BYTE FROM VISTAB         @D14CDJB 07692000
PCKGVIS1 EQU   *                  IF ANCHOR TABLE OVERLAYED    @DA11894 07693000
         SLA   R4,BITREG-BITBYT-1 SHIFT INTO CORRECT POSITION  @D367DJB 07694000
GETVIS23 EQU   *                                               @D14CDJB 07695000
         SLA   R4,D1              SHIFT LEFT TO TEST OVERFLOW  @D14CDJB 07696000
         LA    R3,1(R3)           COUNT # OF SHIFTS            @D367DJB 07697000
         BO    GETVIS26           TEST OVERFLOW FROM SHIFT           RZ 07698000
         TM    GVFVFLGS,GVFIRSTT  ENTRY FOR THE FIRST TIME     @D61NDMZ 07699000
         BO    GETVIS71           CURRENT POINTER IS CORRECT   @D61NDMZ 07700000
         TM    GVFVFLGS,GVUPDCP   UPDATE CURRENT PTR REQUESTED @D61NDMZ 07701000
         BZ    GETVIS70           NO                           @D61NDMZ 07702000
         STM   R0,RF,SAVREGS      SAVE REGISTERS               @D61NDMZ 07703000
         BCTR  R3,0               NO OF ONES SHIFTED           @D....KH 07704000
         BAL   R8,GETVUPCP        UPDATE CURRENT POINTER       @D61NDMZ 07705000
         LM    R0,RF,SAVREGS      RESTORE REGISTERS            @D61NDMZ 07706000
GETVIS71 DS    0H                                              @D61NDMZ 07707000
         NI    GVFVFLGS,XFF-GVUPDCP-GVFIRSTT                   @D61NDMZ 07708000
GETVIS70 DS    0H                                              @D61NDMZ 07709000
         LA    R1,D1(R1)          INCREASE BIT LENGTH COUNTER  @D14CDJB 07710000
         CR    R1,R0              CHECK LENGTH SUFFICIENT      @D14CDJB 07711000
         BNL   GETVIS3            GO CALCULATE ADDRESS               RZ 07712000
         CH    R3,H8              TEST BYTE ALREADY EXHAUSTED  @D14CDJB 07713000
         BL    GETVIS23           NO,CONTINUE SHIFT                  RZ 07714000
         LA    R3,BITBYT          BITS IN A BYTE               @D14CDJB 07715000
         SR    RA,R3              SUBTRACT FROM BIT COUNTER    @D14CDJB 07716000
         LA    RF,D1(RF)          INCREASE POINTER             @D14CDJB 07717000
         LR    R3,R0              NO. OF "0" BITS TO SEARCH    @D218DKH 07718000
         SR    R3,R1              (R1 = BITS ALREADY FOUND)    @D218DKH 07719000
GETVIS4  EQU   *                                               @D14CDJB 07720000
         LA    R4,BITWD                                        @D218DKH 07721000
         SR    RA,R4              DECR. NO. OF VISTAB BITS     @D218DKH 07722000
         SR    R3,R4              AT LEAST A FULLWORD NEEDED ? @D218DKH 07723000
         BM    GETVIS41           NO, ==>                      @D218DKH 07724000
         SR    R4,R4                                           @D218DKH 07725000
         C     R4,D0(RF)          NEXT 4 BYTES "0" ?           @D218DKH 07726000
         BE    GETVIS51           YES, ==>                     @D218DKH 07727000
         LA    RA,BITWD(RA)       ADJUST NO. OF VISTAB BITS    @D218DKH 07728000
         B     GETVIS42           SKIP USED VISTAB BYTES       @D218DKH 07729000
GETVIS51 EQU   *                                               @D14CDJB 07730000
         LA    R1,BITWD(R1)       ADJUST NO. OF BITS FOUND     @D218DKH 07731000
         LA    RF,D4(RF)          ADRESS NEXT FULLWORD         @D218DKH 07732000
         B     GETVIS4                                         @D218DKH 07733000
GETVIS41 EQU   *                                               @D14CDJB 07734000
         LA    R4,BITHWD                                       @D218DKH 07735000
         AR    RA,R4                                           @D218DKH 07736000
         AR    R3,R4              AT LEAST A HALFWORD NEEDED ? @D218DKH 07737000
         BM    GETVIS43           NO, ==>                      @D218DKH 07738000
         SR    R4,R4                                           @D218DKH 07739000
         CH    R4,D0(RF)          NEXT 2 BYTES "0" ?           @D218DKH 07740000
         BE    GETVIS52           YES, ==>                     @D218DKH 07741000
         LA    RA,BITHWD(RA)      ADJUST NO. OF VISTAB BITS    @D218DKH 07742000
         B     GETVIS42           SKIP USED VISTAB BYTES       @D218DKH 07743000
GETVIS52 EQU   *                                               @D14CDJB 07744000
         LA    R1,BITHWD(R1)      INCR. NO. OF BITS FOUND      @D218DKH 07745000
         LA    RF,D2(RF)          SKIP TO NEXT HALFWORD        @D218DKH 07746000
         LA    R4,BITBYT          AT MOST ONE MORE             @D218DKH 07747000
         SR    RA,R4              FULL BYTE                    @D218DKH 07748000
         SR    R3,R4              TO                           @D218DKH 07749000
         BM    GETVIS44           TEST                         @D218DKH 07750000
         B     GETVIS57                                        @D218DKH 07751000
GETVIS43 EQU   *                                               @D14CDJB 07752000
         LA    R4,BITBYT                                       @D218DKH 07753000
         AR    RA,R4                                           @D218DKH 07754000
         AR    R3,R4              AT LEAST ONE BYTE TO TEST ?  @D218DKH 07755000
         BM    GETVIS44           NO, ==>                      @D218DKH 07756000
GETVIS57 EQU   *                                               @D218DKH 07757000
         CLI   D0(RF),X'00'       IS THE BYTE ALL "0" ?        @D218DKH 07758000
         BE    GETVIS53           YES, ==>                     @D218DKH 07759000
         LA    RA,BITBYT(RA)      ADJUST NO. OF VISTAB BITS    @D218DKH 07760000
         B     GETVIS48           SKIP USED VISTAB BYTES       @D218DKH 07761000
GETVIS53 EQU   *                                               @D218DKH 07762000
         LA    R1,BITBYT(R1)      INCR. NO. OF BITS FOUND      @D218DKH 07763000
         LA    RF,D1(RF)          GO TO NEXT BYTE              @D218DKH 07764000
         LTR   R3,R3              MORE BITS NEEDED ?           @D218DKH 07765000
         BZ    GETVIS7            NO, ==>                      @D218DKH 07766000
         B     GETVIS61           TEST REMAINING BITS          @D31CDKH 07767000
GETVIS44 EQU   *                                               @D14CDJB 07768000
         AR    RA,R4                                           @D218DKH 07769000
         AR    R3,R4              MORE BITS NEEDED ?           @D218DKH 07770000
         BZ    GETVIS7            NO, ==>                      @D218DKH 07771000
GETVIS61 EQU   *                  TEST REMAINING BITS          @D14CDJB 07772000
         SR    R3,R3                                           @D218DKH 07773000
         CLI   D0(RF),XFF         NEXT BYTE ALL USED UP ?      @D218DKH 07774000
         BNE   GETVIS22           NO, ==>                      @D218DKH 07775000
         B     GETVIS48           SKIP BYTE                    @D218DKH 07776000
GETVIS42 EQU   *                                               @D14CDJB 07777000
         LA    R3,BITBYT                                       @D218DKH 07778000
         CLI   D0(RF),X'00'       SKIP "0" BYTES               @D218DKH 07779000
         BNE   GETVIS45                                        @D218DKH 07780000
         LA    RF,D1(RF)          GO TO NEXT BYTE              @D218DKH 07781000
         SR    RA,R3              ADJUST NO. OF VISTAB BITS    @D218DKH 07782000
         B     GETVIS42                                        @D218DKH 07783000
GETVIS45 EQU   *                                               @D14CDJB 07784000
         CR    RA,R0              ENOUGH BITS LEFT ?           @D218DKH 07785000
         BL    GVSCVR0C           NO, ==>                      @D218DKH 07786000
GETVIS48 EQU   *                                               @D14CDJB 07787000
         LA    R3,BITWD                                        @D218DKH 07788000
         LA    R4,1                                            @D218DKH 07789000
         LNR   R4,R4              R4 = X'FFFFFFFF'             @D218DKH 07790000
GETVIS47 EQU   *                                               @D14CDJB 07791000
         C     R4,D0(RF)          A FULLWORD OF X'FF' ?        @D218DKH 07792000
         BNE   GETVIS46           NO, ==>                      @D218DKH 07793000
         SR    RA,R3              ADJUST NO. OF VISTAB BITS    @D218DKH 07794000
         LA    RF,D4(RF)          SKIP THOSE 4 BYTES           @D218DKH 07795000
         CR    RA,R0              ENOUGH BITS LEFT ?           @D218DKH 07796000
         BL    GVSCVR0C           NO, ==>                      @D218DKH 07797000
         B     GETVIS47                                        @D218DKH 07798000
GETVIS46 EQU   *                                               @D14CDJB 07799000
         LA    R3,BITBYT                                       @D218DKH 07800000
GETVIS49 EQU   *                                               @D14CDJB 07801000
         CLI   D0(RF),X'FF'       WHOLE BYTE USED UP ?         @D218DKH 07802000
         BNE   GETVIS55           NO, ==>                      @D218DKH 07803000
         LA    RF,D1(RF)          SKIP THE BYTE                @D218DKH 07804000
         SR    RA,R3              ADJUST NO. OF VISTAB BITS    @D218DKH 07805000
         CR    RA,R0              ENOUGH BITS LEFT ?           @D218DKH 07806000
         BL    GVSCVR0C           NO, ==>                      @D218DKH 07807000
         B     GETVIS49                                        @D218DKH 07808000
*------------------------------------------------------------* @D36ZDJB 07809000
GETVIS26 DS    0H                 'ONE' SHIFTED                @D14CDJB 07810000
         NI    GVFVFLGS,XFF-GVFIRSTT UPDATE CURRENT POINTER    @D61NDMZ 07811000
         CH    R3,H8              TEST BYTE EXHAUSTED ?        @D14CDJB 07812000
         BL    GETVIS59           NO ===>                      @D14CDJB 07813000
         LA    RF,D1(RF)                                       @D61NDMZ 07814000
         SR    RA,R3              ADJUST NO. OF VISTAB BITS    @D218DKH 07815000
         CR    RA,R0              ENOUGH BITS LEFT ?           @D218DKH 07816000
         BL    GVSCVR0C           NO, ==>                      @D218DKH 07817000
         B     GETVIS48           SKIP X"FF' BYTES             @DY43555 07818000
GETVIS55 EQU   *                                               @D14CDJB 07819000
         ST    RF,SSEARCH         NO,CONT. SEARCH IN THIS BYTE @D14CDJB 07820000
         SR    R1,R1                                           @D218DKH 07821000
         ST    R1,SVWORK1         SAVE NEW SEARCH START ADDR.  @D367DJB 07822000
         CR    R0,R3              LESS THAN 8 BITS NEEDED ?    @D218DKH 07823000
         BL    GETVIS56           YES, ==>                     @D218DKH 07824000
         CLI   D0(RF),X'00'       NEXT BYTE ALL "0" BITS ?     @D218DKH 07825000
         BNE   GETVIS56           NO, ==>                      @D218DKH 07826000
         TM    GVFVFLGS,GVUPDCP   UPDATE CURRENT PTR REQUESTED @D61NDMZ 07827000
         BZ    GETVIS58           NO                           @D61NDMZ 07828000
         STM   R0,RF,SAVREGS      SAVE REGISTERS               @D61NDMZ 07829000
         SR    R3,R3              PREP. INPUT (NO '1'S SHIFTED)@D61NDMZ 07830000
         BAL   R8,GETVUPCP        UPDATE CURRENT POINTER       @D61NDMZ 07831000
         LM    R0,RF,SAVREGS      RESTORE REGISTERS            @D61NDMZ 07832000
GETVIS58 DS    0H                                              @D61NDMZ 07833000
         LR    R3,R0                                           @D218DKH 07834000
         B     GETVIS4                                         @D218DKH 07835000
GETVIS56 EQU   *                                               @D14CDJB 07836000
         SR    R3,R3                                           @D218DKH 07837000
         B     GETVIS22                                        @D218DKH 07838000
GETVIS59 EQU   *                                               @D14CDJB 07839000
         ST    RF,SSEARCH         NO,CONT. SEARCH IN THIS BYTE @D14CDJB 07840000
         ST    R3,SVWORK1         SAVE NEW SEARCH START ADDR.  @D367DJB 07841000
         LR    R1,R0              GET BIT LENGTH               @D14CDJB 07842000
         AR    R1,R3              PLUS EXHAUSTED BITS          @D14CDJB 07843000
         CR    RA,R1              ENOUGH SPACE ?               @D14CDJB 07844000
         BL    GVSCVR0C           NO  ===>                     @D14CDJB 07845000
         SR    R1,R1              RESET LENGTH COUNTER         @D14CDJB 07846000
         B     GETVIS23           ===> CONTINUE SEARCH         @D14CDJB 07847000
         SPACE 2                                                        07848000
*                                                                    RZ 07849000
*        CALCULATE VIRTUAL ADDRESS                                   RZ 07850000
*        SSEARCH CONTAINS START ADDRESS OF BITSTRING IN VISTAB       RZ 07851000
*        SVWORK1 CONTAINS BIT #                                      RZ 07852000
*                                                                    RZ 07853000
         SPACE 1                                                        07854000
GVSCVR0C DS    0H                                              @D14CDJB 07855000
         TM    GVFVFLGS,GVUPDCP   UPDATE CURRENT PTR REQUESTED @D61NDMZ 07856000
         BZ    GVSCVRC1           YES, STOP SEARCH             @D61NDMZ 07857000
         NI    GVFVFLGS,XFF-GVFIRSTT RESET UNCONDITIONAL       @D61NDMZ 07858000
         LA    R3,BITWD           NO OF BITS PER FULLWORD      @D61NDMZ 07859000
         LA    R4,1                                            @D61NDMZ 07860000
         LNR   R4,R4              R4 = X'FFFFFFFF'             @D61NDMZ 07861000
GVSCVRC3 DS    0H                                              @D61NDMZ 07862000
         LTR   RA,RA              CONTIG. AREA TOTALLY SCANNED @D61NDMZ 07863000
         BNP   GVSCVRC1           YES, STOP SEARCH             @D61NDMZ 07864000
         C     R4,D0(RF)          A FULLWORD OF X'FF' ?        @D61NDMZ 07865000
         BNE   GVSCVRC2           NO, ==>                      @D61NDMZ 07866000
         LA    RF,D4(RF)          POINT TO NEXT FULLWORD       @D61NDMZ 07867000
         SR    RA,R3                                           @D61NDMZ 07868000
         B     GVSCVRC3           NO, ==>                      @D61NDMZ 07869000
GVSCVRC2 DS    0H                                              @D61NDMZ 07870000
         LA    R3,BITBYT          R3=8 (NO OF BITS PER BYTE)   @D61NDMZ 07871000
GVSCVRC6 DS    0H                                              @D61NDMZ 07872000
         CLI   D0(RF),X'FF'       WHOLE BYTE USED UP ?         @D61NDMZ 07873000
         BNE   GVSCVRC4           NO, ==>                      @D61NDMZ 07874000
         LA    RF,D1(RF)          SKIP THE BYTE                @D61NDMZ 07875000
         SR    RA,R3              ADJUST NO. OF VISTAB BITS    @D61NDMZ 07876000
         LTR   RA,RA              BITS LEFT TO SCAN            @D61NDMZ 07877000
         BP    GVSCVRC6           YES, CONTINUE SCAN           @D61NDMZ 07878000
GVSCVRC1 DS    0H                                              @D61NDMZ 07879000
         LA    RF,SMERR0C         GET ERROR CODE               @D14CDJB 07880000
         B     GVSCVRET           ===> RETURN TO CALLER        @D14CDJB 07881000
GVSCVRC4 DS    0H                                              @D61NDMZ 07882000
         SR    R4,R4                                           @D61NDMZ 07883000
         IC    R4,D0(RF)          GET VISTAB BYTE              @D61NDMZ 07884000
         SLA   R4,BITREG-BITBYT-1 SHIFT INTO CORRECT POSITION  @D61NDMZ 07885000
         LA    R3,0               INITIALIZE SHIFT ..          @D61NDMZ 07886000
         BCTR  R3,0               .. COUNT TO '-1'             @D61NDMZ 07887000
GVSCV020 DS    0H                                              @D61NDMZ 07888000
         LA    R3,1(,R3)          COUNT # OF SHIFTS            @D61NDMZ 07889000
         SLA   R4,D1              SHIFT LEFT TO TEST OVERFLOW  @D61NDMZ 07890000
         BO    GVSCV020           '1' SHIFTED, CONTINUE SEARCH @D61NDMZ 07891000
         STM   R0,RF,SAVREGS      SAVE REGISTERS               @D61NDMZ 07892000
         BAL   R8,GETVUPCP        UPDATE CURRENT POINTER       @D61NDMZ 07893000
         LM    R0,RF,SAVREGS      RESTORE REGISTERS            @D61NDMZ 07894000
         B     GVSCVRC1                                        @D52VDMZ 07895000
GETVIS7  EQU   * .                                             @D218DKH 07896000
         LA    R3,BITBYT          ALL 8 BITS SCANNED IN BYTE   @D218DKH 07897000
         BCTR  RF,0               LAST BYTE SCANNED            @D218DKH 07898000
GETVIS3  DS    0H                                                    RZ 07899000
         LR    R1,RF              GET VISTAB ADDRESS           @D14CDJB 07900000
         L     R4,SSEARCH         GET START ADDRESS            @D367DJB 07901000
         S     R4,BVISTAB         SUBTR. START ADDR. OF VISTAB @D367DJB 07902000
         SLA   R4,LDVBYTB(RB)     MULTIPLY BY VIRT. SIZE/BYTE  @D367DJB 07903000
         A     R4,BVIRTMEM      ADD START ADDR. OF GETVIS AREA @D367DJB 07904000
         L     RF,SVWORK1         GET BIT #                    @D14CDJB 07905000
         SLA   RF,LDVBYTBI(RB)    MULTIPLY BY VIRT. SIZE/BIT   @D14CDJB 07906000
         AR    R4,RF              AND ADD                      @D14CDJB 07907000
         SR    RF,RF              SET RETURN CODE              @D14CDJB 07908000
GVSCVRET EQU   *                                               @D14CDJB 07909000
         TM    GVFVFLG2,GVLNG0RQ  IS IT A LENGTH 0 REQUEST     @D64ADKH 07910000
         BZ    GVSCVRT1           NO, R0 IS CORRECT            @D61NDMZ 07911000
         SR    R0,R0              SET R0 TO LENGTH 0           @D61NDMZ 07912000
         NI    GVFVFLG2,XFF-GVLNG0RQ                           @D64ADKH 07913000
GVSCVRT1 DS    0H                                              @D14CDJB 07914000
         L     RA,TCBPTR          RESTORE TCB ADDRESS          @D14CDJB 07915000
         BR    R8                 ==> RETURN TO CALLER         @D14CDJB 07916000
GETVUPCP DS    0H                 ROUTINE TO UPDATE CURR. PTR  @D61NDMZ 07917000
*                                                                       07918000
* INPUT : R2: SUBPOOL INDEX TABLE ENTRY                                 07919000
*         R3: NO OF '1' BITS SHIFTED                                    07920000
*         RB: SHIFT MODIFIER                                            07921000
*         RF: ADDR OF VISTAB BYTE WITH FREE BIT                         07922000
* OUTPUT: UPDATED CURRENT POINTER                                       07923000
*         RESET UPDATE INDICATION                                       07924000
*                                                                       07925000
         NI    GVFVFLGS,XFF-GVUPDCP                            @D61NDMZ 07926000
         LA    R4,BITBYT          R4 = 8  MINUS ..             @D61NDMZ 07927000
         SR    R4,R3              .. NO OF '1' BITS SHIFTED    @D61NDMZ 07928000
         LA    R3,X'FF'                                        @D61NDMZ 07929000
         SLL   R3,D0(R4)                                       @D61NDMZ 07930000
         USING SUBPINT,R2         ADDRESS SUBPOOL              @D61NDMZ 07931000
         STC   R3,SPITBITO        NEW BIT MASK                 @D61NDMZ 07932000
         LR    R5,RF                                           @D61NDMZ 07933000
         S     R5,BVISTAB         BYTE OFFSET IN VISTAB        @D61NDMZ 07934000
         L     R3,PAGESIZE        GET NO OF VISTAB BYTES..     @D61NDMZ 07935000
         SRL   R3,LDVBYTB(RB)     .. TO REPRESENT ONE PAGE     @D61NDMZ 07936000
         SR    R4,R4              CLEAR FOR DIVIDE             @D61NDMZ 07937000
         DR    R4,R3                                           @D61NDMZ 07938000
         STC   R4,SPITRLVB        NEW BYTE OFFSET              @D61NDMZ 07939000
         SLL   R5,SUBPCHN2        OFFSET IN PAGE CHAIN TABLE   @D61NDMZ 07940000
         A     R5,BSUBPCHN        ADDR OF PAGE CHAIN ENTRY     @D61NDMZ 07941000
         ST    R5,SPITCURP        NEW PAGE CHAIN TABLE ENTRY   @D61NDMZ 07942000
         DROP  R2                 RELEASE SUBPOOL              @D61NDMZ 07943000
         BR    R8                 RETURN TO CALLER             @D61NDMZ 07944000
         DROP  RC                 RELEASE ANCHOR TABLE         @D14CDJB 07945000
         DROP  RE                 RELEASE BASE                 @D52VDMZ 07946000
         EJECT                                                 @D14CDJB 07947000
***************************************************************@DY44311 07948000
*                                                              @DY44311 07949000
*   PROVIDE FORMATTED GETVIS CI FOR GETVIS STATUS COMMAND      @DY44311 07950000
*                                                              @DY44311 07951000
*   MODULE GVSTAT                                              @DY44311 07952000
*     CALLED BY : SGAM                                         @DY44311 07953000
*     CALLS     : NONE                                         @DY44311 07954000
*                                                              @DY44311 07955000
*     INPUT    RC  :  ANCHOR TABLE                             @DY44311 07956000
*                     RC= PART.GETVIS CI IF GETVIS XX,..       @DY45752 07957000
*                     SAVR2ND7 = SYS.GETVIS CI IF MVS SUBPOOLS @DY45752 07958000
*                     AVAILABLE                                @DY45752 07959000
*                     RC= SYS.GETVIS CI IF GETVIS SVA,..       @DY44311 07960000
*              RD  :  REQUESTOR SAVE AREA                      @DY44311 07961000
*              RE  :  BASE                                     @DY44311 07962000
*              SVER01 : ADDR OF OUTPUT AREA, PROVIDED BY CALLER@DY44311 07963000
*     OUTPUT : RF  : 0                                         @DY44311 07964000
*     LINK   : R8                                              @DY44311 07965000
*     WORK   : R0,R1,R2,R3,R4,R5,R7,R9,RB,RF                   @D64ADMZ 07966000
*                                                              @DY44311 07967000
         AGO    .CREATJ1                                       @DY44311 07968000
.GVSTAT  ANOP                                                  @DY44311 07969000
.*             0123456789ABCDEF                                @DY44311 07970000
&INPREG  SETC '0000000000101110'                               @DY44311 07971000
&OUTREG  SETC '0000000000000001'                               @DY44311 07972000
&WRKREG  SETC '1111110101010000'                               @DY44311 07973000
&NMDREG  SETC '0000001010101110'                               @DY44311 07974000
&LINKR   SETC 'R8'                                             @DY44311 07975000
&TBASE   SETC 'OWN'                                            @DY44311 07976000
.*EXCLSYMS=(SAVR3RD6,SAVR3RD8,SAVR3RDD,TCBGVR12,SAVREGS)       @D66GGMZ 07977000
.*EXCLSYMS=(SAVREG0,SAVREG1,SAVREG2,SAVREG3,SAVREG4,SAVREG5)   @D66GGMZ 07978000
.*EXCLSYMS=(SAVREG6,SAVREG7,SAVREG8,SAVREG9,SAVREGA,SAVREGB)   @D66GGMZ 07979000
.*EXCLSYMS=(SAVREGC,SAVREGD,SAVREGE,SAVREGF)                   @D66GGMZ 07980000
         AGO    .TESTALL                                       @DY44311 07981000
.CREATJ1 ANOP                                                  @DY44311 07982000
***************************************************************@DY44311 07983000
         SPACE 2                                                        07984000
         USING TCBADR,RA                                       @D66GGMZ 07985000
         USING ANCHTAB,RC                                      @DY44311 07986000
         USING SVEARA,RD                                       @DY44311 07987000
         USING GVSTAT,RE                                       @DY44311 07988000
GVSTAT   DS    0H                                              @DY44311 07989000
*SGLINK  GVSTAT,S,INPUT=(R8:LINK,RA,RC,RD,RE),OUTPUT=(RF),             *07990000
               WORK=(R0,R1,R2,R3,R4,R5,R7,R9,RB),NOMODR=(R8),          *07991000
               NOMODR=(R6,R8,RA,RC,RD,RE),                             *07992000
               AMODE=31,                                               *07993000
               MODSYM=(SAVREG0,SAVREG1,SAVREG2,SAVREG3,SAVREG4,        *07994000
               SAVREG5,SAVREG6,SAVREG7,SAVREG8,SAVREG9,TCBXXSA,        *07995000
               TCBGVR12,SAVREGA,SAVREGB,SAVREGC,SAVREGD,SAVREGE,       *07996000
               SAVREGF)                                                 07997000
         ST    R6,SAVR3RD6                                     @D64ADMZ 07998000
         ST    R8,SAVR3RD8        SAVE LINK REGISTER           @D64ADMZ 07999000
         ST    RD,SAVR3RDD        SAVE PTR TO SAVE AREA        @D64ADMZ 08000000
         ST    RC,TCBGVR12        SAVE PTR TO CI               @D66GGMZ 08001000
         L     R1,SVER01          GET ADDR OF OUTPUT AREA      @DY44311 08002000
         LH    R2,MXSUBPLH                                     @DY44311 08003000
         LA    R2,1(,R2)          NO OF SUBPOOLS               @DY44311 08004000
         LA    RB,GVSTAT_SPLPE_1  CONTINUATION ADDR FOR VSE-SP @DY44311 08005000
         L     R5,BSUBPIND        FIRST SUBPOOL INDEX          @DY44311 08006000
         USING SUBPINT,R5                                      @DY44311 08007000
GVSTAT_SPLP DS 0H                 LOOP THROUGH SUBPOOLS        @DY44311 08008000
*        SWITCH CI FOR PROCESSING BELOW                                 08009000
         TM    GVFVFLGS,GVFVABVE        SWITCHED TO BELOW      @DY44311 08010000
         BZ    GVSTAT_SPLP00            YES                    @DY44311 08011000
         MVC   ANBRGVPG(MOVECIL),NBRGVPG     SWITCH FIELDS     @D52VDKH 08012000
         MVC   NBRGVPG(MOVECIL),DUPCILSV     SWITCH FIELDS     @D52VDKH 08013000
         NI    GVFVFLGS,X'FF'-GVFVABVE    CONTINUE BELOW       @D52VDKH 08014000
GVSTAT_SPLP00 DS 0H                                            @DY44311 08015000
*        SWITCH SUBPOOL TO BELOW                               @DY44311 08016000
         TM    SPITFLG1,SPSWABVE  SUBPOOL SWITCHED TO ABVE ?   @DY44311 08017000
         BZ    GVSTAT_SPLP0       NO, TO BELOW                 @DY44311 08018000
         NI    SPITFLG1,X'FF'-SPSWABVE RESET SWITCH TO ABOVE   @DY44311 08019000
         MVC   DUPSBPSV(MOVESPTL),ASPTFRST                     @DY44311 08020000
         MVC   ASPTFRST(MOVESPTL),SPITFRST                     @DY44311 08021000
         MVC   SPITFRST(MOVESPTL),DUPSBPSV                     @DY44311 08022000
         SPACE                                                          08023000
GVSTAT_SPLP0 DS 0H                LOOP THROUGH SUBPOOLS        @DY44311 08024000
         SPACE                                                          08025000
         L     R3,SPITFRST        GET FIRST BELOW PAGE         @DY44311 08026000
         LTR   R3,R3              DOES IT EXIST                @DY44311 08027000
         BP    GVSTAT_SPLP1       YES                          @DY44311 08028000
         L     R3,ASPTFRST        GET FIRST ABOVE PAGE         @DY44311 08029000
         LTR   R3,R3              DOES IT EXIST                @DY44311 08030000
         BM    GVSTAT_SPLPE       NO, SUBPOOL EMPTY,PROC. NEXT @DY44311 08031000
* SWITCH CI AND SUBPOOL TO ABOVE                                        08032000
         OI    GVFVFLGS,GVFVABVE  SWITCH TO ABOVE              @DY44311 08033000
         MVC   DUPCILSV(2*MOVECIL),NBRGVPG                     @DY44311 08034000
         OI    SPITFLG1,SPSWABVE                               @DY44311 08035000
         MVC   DUPSBPSV(MOVESPTL),ASPTFRST                     @DY44311 08036000
         MVC   ASPTFRST(MOVESPTL),SPITFRST                     @DY44311 08037000
         MVC   SPITFRST(MOVESPTL),DUPSBPSV                     @DY44311 08038000
GVSTAT_SPLP1 DS 0H                PROCESS NON-EMPTY SUBPOOL    @DY44311 08039000
         MVC   0(L'SPITNAME,R1),SPITNAME   MOVE SUBPOOL NAME   @DY44311 08040000
         MVC   L'SPITNAME(L'SPITPIK,R1),SPITPIK MOVE PIK       @DY44311 08041000
         LA    R1,L'SPITNAME+L'SPITPIK(,R1) NEXT FREE ADDRESS  @DY44311 08042000
         L     R4,TCBGVR12        GET PTR TO CI (PART IF       @D66GGMZ 08043000
*                                 GETVIS XX,SVA IF GETVIS SVA) @D66GGMZ 08044000
         ST    R1,ADDRSAV-ANCHTAB(R4) SAVE IN PART. CI         @D66GGMZ 08045000
         LA    R1,8(,R1)          NEXT FREE ADDRESS            @DY44311 08046000
*        LOOP THROUGH SUBPOOL PAGES                            @DY44311 08047000
         LA    R4,0               NO OF PAGES IN SUBPOOL       @DY44311 08048000
         USING SUBPCHN,R3                                               08049000
GVSTAT_PGLP DS 0H                                                       08050000
         LR    R7,R3              SAVE BEGIN                   @DY44311 08051000
         LA    R9,1               NO OF CONT. PAGES            @DY44311 08052000
         LA    R4,1(,R4)          NO OF PAGES IN SUBPOOL       @DY44311 08053000
GVSTAT_PGLPC DS 0H                LOOP THROUGH CONT. PAGES     @DY44311 08054000
         TM    SPCHFLAG,SPPGCONC  NEXT PAGE CONTIGUOUS         @DY44311 08055000
         L     R3,SPCHFORW        GET NEXT PAGE                @DY44311 08056000
         BZ    GVSTAT_CALAD       NOT CONT.                    @DY44311 08057000
         LA    R9,1(,R9)          NO OF CONT. PAGES                     08058000
         LA    R4,1(,R4)          NO OF PAGES                  @DY44311 08059000
         B     GVSTAT_PGLPC                                    @DY44311 08060000
GVSTAT_CALAD DS 0H                CALCULATE ADDRESS            @DY44311 08061000
*  R7 BEGIN, R9 NO OF CONT. PAGES                                       08062000
         LR    R0,R7              SAVE BEGIN OF CONT. AREA     @DY44311 08063000
         SLL   R9,PNSHIFT         CONTIGUOUS AREA              @DY44311 08064000
         S     R7,BSUBPCHN        OFFSET IN SUBPOOL CHAIN TABLE@DY44311 08065000
         SLL   R7,PNSHIFT-4       NO OF PAGES*4K               @DY44311 08066000
         A     R7,BVIRTMEM        BEGIN ADDRESS                @DY44311 08067000
         TM    GVFVFLGS,GVFVABVE  DID WE PROCESS PART ABOVE    @DY44311 08068000
         BZ    GVSTAT_SAVAD       NO, DONE                     @DY44311 08069000
         LR    RF,R9                                           @DY44311 08070000
         BCTR  RF,0                                            @DY44311 08071000
         AR    R7,RF                                           @DY44311 08072000
         S     R7,BVIRTMEM                                     @DY44311 08073000
         LNR   R7,R7                                           @DY44311 08074000
         A     R7,EVIRTMEM                                     @DY44311 08075000
GVSTAT_SAVAD DS 0H                                             @DY44311 08076000
         ST    R7,0(,R1)          SAVE IT                      @DY44311 08077000
         BCTR  R9,0                                            @DY44311 08078000
         AR    R7,R9              END OF CONT. AREA            @DY44311 08079000
         ST    R7,4(,R1)          SAVE IT                      @DY44311 08080000
         LA    R1,8(,R1)          POINT TO NEXT ENTRY          @DY44311 08081000
         CR    R3,R0              DOES SUBPOOL HAS MORE PAGES  @DY44311 08082000
         BH    GVSTAT_PGLP        YES                          @DY44311 08083000
         L     R3,TCBGVR12        GET PTR TO PART. CI          @D66GGMZ 08084000
         L     R7,ADDRSAV-ANCHTAB(R3) SAVE IN PART. CI         @D66GGMZ 08085000
         TM    GVFVFLGS,GVFVABVE  DID WE PROCESS PART ABOVE    @DY44311 08086000
         BO    GVSTAT_SPDONE      YES                          @DY44311 08087000
         ST    R4,0(,R7)          SAVE NO PAGES IN SUBPOOL     @DY44311 08088000
         SR    R4,R4                                           @DY44311 08089000
* PROCESS ABOVE                                                @DY44311 08090000
         L     R3,ASPTFRST        GET FIRST SUBPOOOL PAGE ABOVE@DY44311 08091000
         LTR   R3,R3              DOES IT EXIST?               @DY44311 08092000
         BM    GVSTAT_SPDONE      NO, SUBPOOL PROCESSED        @DY44311 08093000
         OI    GVFVFLGS,GVFVABVE  SWITCH TO ABOVE              @DY44311 08094000
         MVC   DUPCILSV(2*MOVECIL),NBRGVPG                     @DY44311 08095000
* SWITCH SUBPOOL TO ABOVE                                      @DY44311 08096000
         OI    SPITFLG1,SPSWABVE                               @DY44311 08097000
         MVC   DUPSBPSV(MOVESPTL),ASPTFRST                     @DY44311 08098000
         MVC   ASPTFRST(MOVESPTL),SPITFRST                     @DY44311 08099000
         MVC   SPITFRST(MOVESPTL),DUPSBPSV                     @DY44311 08100000
         B     GVSTAT_PGLP        LOOP ON ABOVE PAGES OF SUBP. @DY44311 08101000
GVSTAT_SPDONE DS 0H               BOTH PARTS OF SUBPOOL PROCE. @DY44311 08102000
         ST    R4,4(,R7)          SAVE NO PAGES IN SUBPOOL     @DY44311 08103000
         LA    R0,8                                            @DY44311 08104000
         LR    R3,R1                                           @DY44311 08105000
         SR    R3,R0              POINT TO LAST ENTRY          @DY44311 08106000
         OI    0(R3),X'80'        INDICATE SUBPOOL PROCESSED   @DY44311 08107000
GVSTAT_SPLPE DS 0H                SUBPOOL PROCESSED            @DY44311 08108000
         BCTR  R2,RB              PROCESS NEXT SUBPOOL         @D64ADMZ 08109000
         SPACE                                                          08110000
*        ALL VSE SUBPOOLS PROCESSED                                     08111000
         SPACE                                                          08112000
* PROCESS MVS SUBPOOLS. THIS CODE IS ENTERED ONLY ONCE, SET R2 ACCOR.   08113000
         ICM   R2,15,NOMVSSPL     GET NUMBER OF MVS SUBPOOLS   @D64ADMZ 08114000
         BZ    GVSTAT_SPLPE_2     NO MVS SUBPOOLS, DONE        @D64ADMZ 08115000
         TM    SVER0F+D3,SVAIND   SVA REQUEST                  @D64ADMZ 08116000
         BO    GVSTAT_SPLPE_3     YES                          @D64ADMZ 08117000
*  PROCESS PARTITION SUBPOOLS                                           08118000
         LA    RB,GVSTAT_TIDLP_SPL   CONTINUATION ADDRESS      @D64ADMZ 08119000
         LA    R2,1(,R2)          ONE MORE TO TERM. LOOP CORR. @D64ADMZ 08120000
         L     R6,APCBATAB        APCBATAB                     @D64ADMZ 08121000
         L     R4,SVER00          GET PIK OF REQ. PARTITION    @D64ADMZ 08122000
         SRL   R4,2               PIK /4                       @D64ADMZ 08123000
         AR    R6,R4              OFFSET IN PCBATAB            @D64ADMZ 08124000
         ICM   R6,15,0(R6)        GET PCB                      @D64ADMZ 08125000
         USING PCBADR,R6                                       @D64ADMZ 08126000
         SR    R0,R0              PREPARE FOR 'GET TASK WITH   @D66ODOW 08127000
***                               ...HIGHEST PRIORITY'                  08128000
         ST    R0,SAVR2ND                                               08129000
         L     RC,TCBGVR12        SETUP PARTITION CI           @DY45936 08130000
         TM    GVFVFLG2,GVSTOSVA  SVA GATE SET?                @DY45936 08131000
         BZ    GVSTAT_TIDLP       NO                           @DY45936 08132000
         L     R3,SCBPTR          GET SCB OF CURRENT SPACE     @DY45936 08133000
         ICM   R3,15,SCBSPL-SCBADR(R3)   SCBSPL PRESENT?       @DY45936 08134000
         BZ    GVSTAT_TIDLP       NO                           @DY45936 08135000
         ST    R3,NEXT_SPLE       PROCESS                      @DY45936 08136000
         B     GVSTAT_TIDLP_SPL_5    THE SCBSPLE               @DY45936 08137000
GVSTAT_TIDLP   DS   0H            PROCESS ALL TASKS            @D64ADMZ 08138000
         L     R3,SAVR2ND         COPY TIB POINTER IF ANY      @D66GGMZ 08139000
*        DISPMAC FUNC=TIB,SFUNC=NEXTLOW,INP2=R6,INP1=R3,ERREXIT=GVTHW2  08140000
         DISPMAC FUNC=TIB,SFUNC=NEXTLOW,INP2=R6,INP1=R3,ERREXIT=GVTHW2 X08141000
                                                               @D66ODOW 08142000
         ST    R3,SAVR2ND         SAVE TIB PTR FOR NEXT CYCLE  @D66GGMZ 08143000
         LTR   R3,R3              ALL TASKS PROCESSED          @D66ODOW 08144000
         BNZ   GVSTAT_TIDLP00     NO   --->                    @D66GGMZ 08145000
         TM    PCEFLAG,PCEDYNP    DYN. PART.                   @D66GGMZ 08146000
         BO    GVSTAT_CLPE        SYS.GETVIS CI NOT AFFECTED   @D66GGMZ 08147000
* CLEAR OS390 SUBPOOL ENTRY IN SYSTEM GETVIS CI                @DY45586 08148000
         L     RC,TCBGVR12        SETUP PARTITION CI           @D66GGMZ 08149000
         L     RC,SAVR2ND7        GET PTR TO SYS.GETVIS CI     @D66GGMZ 08150000
         LA    R5,SUBPINTL        R5 POINTS TO LAST BUT ONE..  @D66GGMZ 08151000
         MH    R5,MXSUBPLH        .. ENTRY IN SUBPOOL INDEX..  @D66GGMZ 08152000
         LA    R5,SUBPINTL(R5)    .. TABLE. THIS ENTRY HOLDS   @D66GGMZ 08153000
         A     R5,BSUBPIND        .. MVS SUBPOOL TO BE PROCESS.@D66GGMZ 08154000
         LA    R4,SUBPINTL(,R5)   R4 NOW POINTS TO INIT ENTRY  @DY45586 08155000
         MVC   0(SUBPINTL,R5),0(R4) INIT MVS SUBPOOL ENTRY     @DY45586 08156000
GVSTAT_CLPE DS 0H                 POINT TO OS390 PART.SUBP.ENT.@DY45586 08157000
         L     RC,TCBGVR12        GET PTR TO PART. GETVIS CI   @D66GGMZ 08158000
         LA    R5,SUBPINTL        R5 POINTS TO LAST BUT ONE..  @D66GGMZ 08159000
         MH    R5,MXSUBPLH        .. ENTRY IN SUBPOOL INDEX..  @D66GGMZ 08160000
         LA    R5,SUBPINTL(R5)    .. TABLE. THIS ENTRY HOLDS   @D66GGMZ 08161000
         A     R5,BSUBPIND        .. MVS SUBPOOL TO BE PROCESS.@D66GGMZ 08162000
         B     GVSTAT_SPLPE_20    ALL TASKS PROCESSED          @DY45586 08163000
         USING PCBADR,R6                                                08164000
GVSTAT_TIDLP00 DS   0H            PROCESS TASK                 @D66GGMZ 08165000
         L     RC,TCBGVR12        GET PTR TO PART. GETVIS CI   @D66GGMZ 08166000
         USING TIBADR,R3                                       @D64ADMZ 08167000
         L     R3,TIBTCB          GET TCB POINTER              @D64ADMZ 08168000
         DROP  R3                 RELEASE TIB                  @D64ADMZ 08169000
         MVC   NEXT_SPLE,TCBSPL-TCBADR(R3)     GET FIRST SPLE  @D64ADMZ 08170000
         USING SPLE,R3            ADDR SPLE                    @D64ADMZ 08171000
GVSTAT_TIDLP_SPL DS  0H                                        @D64ADMZ 08172000
         L     RC,TCBGVR12        GET PTR TO PART. CI          @D66GGMZ 08173000
         ICM   R3,15,NEXT_SPLE    TASK HAS MORE SUBPOOLS ?     @D64ADMZ 08174000
         BZ    GVSTAT_TIDLP       NO, PROCESS NEXT TASK        @D66ODOW 08175000
GVSTAT_TIDLP_SPL_5    DS  0H                                   @DY45936 08176000
         MVC   NEXT_SPLE,PNEXTSPLE GET NEXT SPLE               @D64ADMZ 08177000
         CLI   SPTYPE,X'03'       IS IT PARTITION STORAGE      @D64ADMZ 08178000
         BE    GVSTAT_TIDLP_PR    YES, PROCESS SUBPOOL         @D64ADMZ 08179000
         CLI   SPTYPE,X'02'       IS IT SPACE STORAGE          @D64ADMZ 08180000
         BNE   GVSTAT_TIDLP_SPL   NO, CHECK NEXT SUBPOOL       @D64ADMZ 08181000
         TM    PCEFLAG,PCEDYNP    DYN. PART.                   @D64ADMZ 08182000
         BO    GVSTAT_TIDLP_SPL   YES, DO NOT CONS. SUBPOOL    @D64ADMZ 08183000
* SWITCH GATE                                                           08184000
         L     RC,SAVR2ND7        GET PTR TO SYS.GETVIS CI     @D66GGMZ 08185000
         DROP  R6                 RELEASE PCB                  @D64ADMZ 08186000
GVSTAT_TIDLP_PR DS  0H            PROCESS SUBPOOL              @D64ADMZ 08187000
         LA    R5,SUBPINTL        R5 POINTS TO LAST BUT ONE..  @D64ADMZ 08188000
         MH    R5,MXSUBPLH        .. ENTRY IN SUBPOOL INDEX..  @D64ADMZ 08189000
         LA    R5,SUBPINTL(R5)    .. TABLE. THIS ENTRY HOLDS   @D64ADMZ 08190000
         A     R5,BSUBPIND        .. MVS SUBPOOL TO BE PROCESS.@D64ADMZ 08191000
         LA    R4,SUBPINTBUF      GET ADDR OF SUBPINT          @D64ADMZ 08192000
         MVC   0(SUBPINTL,R5),0(R4)  MVS SUBPOOL TO BE PROCESS.@D64ADMZ 08193000
         B     GVSTAT_SPLP        PROCESS SUBPOOL              @D64ADMZ 08194000
         SPACE                                                          08195000
GVTHW2   DS    0H                                              @D66ODOW 08196000
         BAS   R5,SYSERROR                                     @D66ODOW 08197000
         SPACE                                                          08198000
GVSTAT_SPLPE_3 DS 0H              PROCESS MVS SUBPOOLS         @D64ADMZ 08199000
         L     R4,IJBSMCOM                                     @D64ADMZ 08200000
         USING SMCOM,R4                                        @D64ADMZ 08201000
         MVC   NEXT_SPLE,SMCSYSPL GET FIRST SYS. SUBPOOL SPLE  @D64ADMZ 08202000
         DROP  R4                 RELEASE SMCOM                @D64ADMZ 08203000
         LA    R2,1(,R2)          ONE MORE TO TERM.LOOP HERE   @D64ADMZ 08204000
         LA    R5,SUBPINTL        R5 POINTS TO LAST BUT ONE..  @D64ADMZ 08205000
         MH    R5,MXSUBPLH        .. ENTRY IN SUBPOOL INDEX..  @D64ADMZ 08206000
         LA    R5,SUBPINTL(R5)    .. TABLE. THIS ENTRY HOLDS   @D64ADMZ 08207000
         A     R5,BSUBPIND        .. MVS SUBPOOL TO BE PROCESS.@D64ADMZ 08208000
         LA    RB,GVSTAT_SPLPE_4  CONT. ADDR MVS SUBPOOL LOOP  @D64ADMZ 08209000
GVSTAT_SPLPE_4 DS 0H              PROCESS MVS SUBPOOLS         @D64ADMZ 08210000
         ICM   R4,15,NEXT_SPLE    GET NEXT MVS SPLE            @D64ADMZ 08211000
         BZ    GVSTAT_SPLPE_20    ALL MVS SUBPOOLS PROCESSED   @DY45586 08212000
         USING SPLE,R4                                         @D64ADMZ 08213000
         MVC   NEXT_SPLE,PNEXTSPLE  SAVE ADDR OF NEXT SPLE     @D64ADMZ 08214000
         LA    R4,SUBPINTBUF      GET ADDR OF SUBPINT          @D64ADMZ 08215000
         MVC   0(SUBPINTL,R5),0(R4)  MVS SUBPOOL TO BE PROCESS.@D64ADMZ 08216000
         B     GVSTAT_SPLP        PROCESS SUBPOOL              @D64ADMZ 08217000
         DROP  R4                 RELEASE SPLE                 @D64ADMZ 08218000
GVSTAT_SPLPE_20 DS 0H             INIT MVS SUBPOOL ENTRY       @DY45586 08219000
         LA    R4,SUBPINTL(,R5)   R4 NOW POINTS TO INIT ENTRY  @DY45586 08220000
         MVC   0(SUBPINTL,R5),0(R4) INIT MVS SUBPOOL ENTRY     @DY45586 08221000
GVSTAT_SPLPE_2 DS 0H              ALL SUBPOOLS (VSE+MVS) PROC. @D64ADMZ 08222000
         MVI   0(R1),X'FF'        END INDICATOR                @DY44311 08223000
         SR    RF,RF              CLEAR RETURN CODE            @DY44311 08224000
         L     R6,SAVR3RD6        RESTORE                      @D64ADMZ 08225000
         L     R8,SAVR3RD8        RESTORE LINK REGISTER        @D64ADMZ 08226000
         L     RD,SAVR3RDD        RESTORE SAVE AREA PTR        @D64ADMZ 08227000
         BR    R8                 ===> RETURN TO CALLER        @DY44311 08228000
GVSTAT_SPLPE_1 DS 0H              PROCESS VSE SUBPOOLS         @DY44311 08229000
         LA    R5,SUBPINTL(,R5)   POINT TO NEXT SUBPOOL INDEX  @DY44311 08230000
         CLI   SPITNAME,X'00'     DOES SUBPOOL EXIST           @DY44311 08231000
         BE    GVSTAT_SPLPE       NO, GOTO NEXT SUBPOOL        @DY44311 08232000
         B     GVSTAT_SPLP        PROCESS SUBPOOL              @DY44311 08233000
         DROP  R3                 SUBPOOL CHAIN TABLE ENTRY    @DY44311 08234000
         DROP  R5                 REL. SUBPOOL INDEX           @DY44311 08235000
         DROP  RC,RD,RE           REL. ANCHTAB,SAVE AREA, BASE @DY44311 08236000
         DROP  RA                 REL. TCB                     @D66GGMZ 08237000
         EJECT                                                          08238000
*********************************************************************** 08239000
*                                                                       08240000
*   GVFVMIR1 : COMMON ROUTINE TO TO DO ADDRESS MIRRORING                08241000
*                                                                       08242000
*      MODULE GVFVMIR1:   GENERATES INLINE CODE                         08243000
*                                                                       08244000
*         R1 := MIRRORED(R1)                                            08245000
*      ENDMODULE                                                        08246000
*                                                                       08247000
*      MIRRORING AN ADDRESS                                             08248000
*                                                                       08249000
*                                                                       08250000
*             INPUT = LENGTH                                            08251000
*             OUTPUT = MIRRORED ADDRESS                                 08252000
*             MIRRD_ADDR = EVIRTMEM - (ADDR - BVIRTMEM)                 08253000
*                                                                       08254000
*   CALLED BY : MULTIPLE                                                08255000
*   CALLS     : NONE                                                    08256000
*                                                                       08257000
*   INPUT    R1  :  LENGTH                                              08258000
*            RB  :  SHIFT MODIFIER                                      08259000
*            RC  :  PTR TO CI                                           08260000
*            RD  :  PTR TO CALLER'S SAVE AREA                           08261000
*                                                                       08262000
*   OUTPUT : R1  : MIRRORED ADDRESS                                     08263000
*                                                                       08264000
*********************************************************************** 08265000
         AGO    .CREATES                                       @D52VDKH 08266000
.GVFVMR1 ANOP                                                  @D52VDKH 08267000
.*             0123456789ABCDEF                                @D52VDKH 08268000
&INPREG  SETC '0100000000011100'                               @D52VDKH 08269000
&OUTREG  SETC '0100000000000000'                               @D52VDKH 08270000
&WRKREG  SETC '0000000000000000'                               @D52VDKH 08271000
&NMDREG  SETC '1011111111111111'                               @D52VDKH 08272000
&LINKR   SETC '  '                                             @D52VDKH 08273000
&TBASE   SETC '   '                                            @D52VDKH 08274000
.*EXCLSYMS=()                                                  @D52VDMZ 08275000
         AGO    .TESTALL                                       @D52VDKH 08276000
.CREATES ANOP                                                           08277000
         SPACE 2                                                        08278000
*SGLINK  GVFVMIR1,S,INPUT=(R1,RB,RC,RD),OUTPUT=(R1),                   *08279000
               NOMODR=(R0,R2,R3,R4,R5,R6,R7,R8,R9,RA,RB,RC,RD,RE,RF),  *08280000
               AMODE=31                                                 08281000
         SPACE 3                                                        08282000
*        BCTR  R1,0                                            @D52VDKH 08283000
*        SRA   R1,LDVBYTBI(RB)    ROUNDING OF SIZE             @D52VDKH 08284000
*        LA    R1,1(,R1)                                       @D52VDKH 08285000
*        SLA   R1,LDVBYTBI(RB)                                 @D52VDKH 08286000
*        BCTR  R1,0                                            @D52VDKH 08287000
*        A     R1,SVER01                                       @D52VDKH 08288000
*        S     R1,BVIRTMEM              MIRROR START ADDRESS   @D52VDKH 08289000
*        LNR   R1,R1                    OF AREA                @D52VDKH 08290000
*        A     R1,EVIRTMEM                                     @D52VDKH 08291000
         EJECT                                                 @D64ADKH 08292000
         AGO   .CREATE0                                        @D64ADKH 08293000
.MIR1GEN ANOP                                                  @D52VDKH 08294000
         BCTR  R1,0                                            @D52VDKH 08295000
         SRA   R1,LDVBYTBI(RB)    ROUNDING OF SIZE             @D52VDKH 08296000
         LA    R1,1(,R1)                                       @D52VDKH 08297000
         SLA   R1,LDVBYTBI(RB)                                 @D52VDKH 08298000
         BCTR  R1,0                                            @D52VDKH 08299000
         A     R1,SVER01                                       @D52VDKH 08300000
         S     R1,BVIRTMEM              MIRROR START ADDRESS   @D52VDKH 08301000
         LNR   R1,R1                    OF AREA                @D52VDKH 08302000
         A     R1,EVIRTMEM                                     @D52VDKH 08303000
         AGO   .MACEND                                         @D14ZDJB 08304000
.CREATE0 ANOP                                                  @D64ADKH 08305000
*********************************************************************** 08306000
*                                                                       08307000
*   GVFVMIR2 : COMMON ROUTINE TO TO DO ADDRESS MIRRORING                08308000
*                                                                       08309000
*      MODULE GVFVMIR2:   GENERATES INLINE CODE                         08310000
*                                                                       08311000
*         R1 := MIRRORED(R1)                                            08312000
*         R0 := MIRRORED(R0)                                            08313000
*         EXCHANGE R0,R1                                                08314000
*         RF := 0                                                       08315000
*         RETURN                                                        08316000
*      ENDMODULE                                                        08317000
*                                                                       08318000
*      MIRRORING AN ADDRESS                                             08319000
*                                                                       08320000
*                                                                       08321000
*             INPUT = ADDRESS                                           08322000
*             OUTPUT = MIRRORED ADDRESS                                 08323000
*             MIRRD_ADDR = EVIRTMEM - (ADDR - BVIRTMEM)                 08324000
*                                                                       08325000
*   CALLED BY : MULTIPLE                                                08326000
*   CALLS     : NONE                                                    08327000
*                                                                       08328000
*   INPUT    R0  :  START ADDRESS OF AREA                               08329000
*            R1  :  END ADDRESS OF AREA                                 08330000
*            RC  :  PTR TO CONTROL INFO                                 08331000
*                                                                       08332000
*   OUTPUT : RF  : 0                                                    08333000
*          : R0,R1 : MIRRORED ADDRESSES                                 08334000
*                                                                       08335000
*********************************************************************** 08336000
         AGO    .CREATEW                                       @D52VDKH 08337000
.GVFVMR2 ANOP                                                  @D52VDKH 08338000
.*             0123456789ABCDEF                                @D52VDKH 08339000
&INPREG  SETC '1100000000001000'                               @D52VDKH 08340000
&OUTREG  SETC '1100000000000001'                               @D52VDKH 08341000
&WRKREG  SETC '0000000000000000'                               @D52VDKH 08342000
&NMDREG  SETC '0011111111111110'                               @D52VDKH 08343000
&LINKR   SETC '  '                                             @D52VDKH 08344000
&TBASE   SETC '   '                                            @D52VDKH 08345000
.*EXCLSYMS=()                                                  @D52VDMZ 08346000
         AGO    .TESTALL                                       @D52VDKH 08347000
.CREATEW ANOP                                                           08348000
         SPACE 2                                                        08349000
*SGLINK  GVFVMIR2,S,INPUT=(R0,R1,RC),OUTPUT=(R0,R1,RF),                *08350000
               NOMODR=(R2,R3,R4,R5,R6,R7,R8,R9,RA,RB,RC,RD,RE),AMODE=31 08351000
         SPACE 3                                                        08352000
*        S     R1,BVIRTMEM              MIRROR START ADDRESS   @D52VDKH 08353000
*        LNR   R1,R1                    OF AREA                @D52VDKH 08354000
*        A     R1,EVIRTMEM                                     @D52VDKH 08355000
*        S     R0,BVIRTMEM                MIRROR END ADDRESS   @D52VDKH 08356000
*        LNR   R0,R0                      OF AREA              @D52VDKH 08357000
*        A     R0,EVIRTMEM                                     @D52VDKH 08358000
*        LR    RF,R1                                           @D52VDKH 08359000
*        LR    R1,R0                       EXCHANGE NEW        @D52VDKH 08360000
*        LR    R0,RF                       START ADDRESS AND   @D52VDKH 08361000
*        SLR   RF,RF                       END ADDRESS         @D52VDKH 08362000
         EJECT                                                 @D64ADKH 08363000
         AGO   .CREATE9                                        @D64ADKH 08364000
.MIR2GEN ANOP                                                  @D52VDKH 08365000
         S     R1,BVIRTMEM              MIRROR START ADDRESS   @D52VDKH 08366000
         LNR   R1,R1                    OF AREA                @D52VDKH 08367000
         A     R1,EVIRTMEM                                     @D52VDKH 08368000
         S     R0,BVIRTMEM                MIRROR END ADDRESS   @D52VDKH 08369000
         LNR   R0,R0                      OF AREA              @D52VDKH 08370000
         A     R0,EVIRTMEM                                     @D52VDKH 08371000
         LR    RF,R1                                           @D52VDKH 08372000
         LR    R1,R0                       EXCHANGE NEW        @D52VDKH 08373000
         LR    R0,RF                       START ADDRESS AND   @D52VDKH 08374000
         SLR   RF,RF                       END ADDRESS         @D52VDKH 08375000
         AGO   .MACEND                                         @D14ZDJB 08376000
.CREATE9 ANOP                                                  @D64ADKH 08377000
***************************************************************@D149DJB 08378000
*                                                              @D149DJB 08379000
*  GVFVGATING: ROUTINE TO RESERVE THE APPROPRIATE GATES        @D64ADKH 08380000
*              AND RETURN THE PTR TO THE GETVIS CI IN RC       @D64ADMZ 08381000
*                                                              @D149DJB 08382000
*        GATE CLOSED MEANS THAT ANOTHER TASK IN THE PARTITION  @D33GDGU 08383000
*        IS JUST DOING A PARTITION OR SPACE GETVIS REQUEST     @D33GDGU 08384000
*        OR THAT ANY OTHER TASK CURRENTLY USING THE SYSTEM     @D35DDUL 08385000
*        GETVIS AREA.                                          @D35DDUL 08386000
*                                                              @D36ZDJB 08387000
*        THE GATING CODE MAY NOT BE INTERRUPTED BY A PAGE      @D35EDUL 08388000
*        FAULT (GETVIS CODE IS IN FIXED PART OF THE SUPERVISOR)@D35EDUL 08389000
*                                                              @D149DJB 08390000
*        IN CASE OF A PFIX REQUEST, THE PFIX GATE IS CLOSED    @D51IDMZ 08391000
*        BEFORE GATING THE GETVIS ROUTINE.                     @D51IDMZ 08392000
*        THIS IS DONE FOR TWO REASONS:                         @D51IDMZ 08393000
*        1)ONLY ONE SAVE AREA IS NEEDED WHEN CALLING THE PFIX  @D51IDMZ 08394000
*          ROUTINE                                             @D51IDMZ 08395000
*        2)TO PROTECT THE SUBPOOL FOR WHICH A PFIX REQUEST IS  @D51IDMZ 08396000
*          PENDING AGAINST FURTHER PFIX REQUESTS(IF THE PFIX   @D51IDMZ 08397000
*          REQUEST FAILS AND THE SUBPOOL IS IN CREATION,       @D51IDMZ 08398000
*          THE WHOLE SUBPOOL IS FREED.                         @D52VDMZ 08399000
*                                                              @D51IDMZ 08400000
*  SVA REQUEST                                                 @D64ADMZ 08401000
*    IF AREA NOT INITIALIZED =>                                @D64ADMZ 08402000
*       RC=0 AND GETVIS (PFIX) GATE OPEN                       @D64ADMZ 08403000
*    IF AREA INITIALIZED                                       @D64ADMZ 08404000
*       RC=ADDR(CI) AND GETVIS (PFIX) GATE CLOSED              @D64ADMZ 08405000
*  SPACE REQUEST                                               @D64ADMZ 08406000
*    IF AREA NOT INITIALIZED =>                                @D64ADMZ 08407000
*       SET PTR TO CI IN PCB, RC=ADDR(CI) AND CLOSE GATE(S)    @D64ADMZ 08408000
*    IF AREA INITIALIZED =>                                    @D64ADMZ 08409000
*       RC=ADDR(CI) AND GETVIS (PFIX) GATE CLOSED              @D64ADMZ 08410000
*  PARTITION REQUEST                                           @D64ADMZ 08411000
*    IF AREA NOT INITIALIZED =>                                @D64ADMZ 08412000
*       RC=0 AND GETVIS GATE OPEN                              @D64ADMZ 08413000
*    IF AREA INITIALIZED =>                                    @D64ADMZ 08414000
*       RC=ADDR(CI) AND GETVIS GATE CLOSED                     @D64ADMZ 08415000
*                                                              @D51IDMZ 08416000
*     CALLED BY : GVFVPTR SGETVIS SFREEVIS FREEALL (R4=R5=R9=0)@D64ADKH 08417000
*                 GFSFIXSB (R4=R5=0,R9=GETVIS GATE)            @D64ADMZ 08418000
*                 GETMAIN/FREEMAIN (R4=R9=0, R5=1)             @D64ADMZ 08419000
*                 DISCARD LSQA (R4=R5=R9=0)                    @D64ADMZ 08420000
*                 INTERNAL FREEMAIN (R9=0,R5=1,R4=GETVIS GATE) @D64ADMZ 08421000
*                 CURRENTLY ONLY THESE COMBPIANTIONS ARE POSS. @D64ADMZ 08422000
*     CALLS     : RWAIT                                        @D149DJB 08423000
*                                                              @D149DJB 08424000
*    INPUT  : R9:    IF NOT ZERO --> GETVIS GATE TO BE CLOSED  @D64ADKH 08425000
*                    IF ZERO     --> GETVIS GATE TO BE CLOSED MUST BE   08426000
*                                    DETERMINED(SVA,SPACE,PART)@D64ADMZ 08427000
*             R5:    0 FOR GETVIS/FREEVIS                      @D64ADKH 08428000
*                    1 FOR GETMAIN/FREEMAIN                    @D64ADKH 08429000
*             RA --> REQUESTOR'S TCB                           @D52VDMZ 08430000
*             RD --> REQUESTOR SAVE AREA (TCBSAVE)             @D64ADKH 08431000
*                                                              @D149DJB 08432000
*    OUTPUT : RC  :  0, IF AREA NOT AVAILABLE                  @D52VDMZ 08433000
*                    ADDR OF CONTROL INFO, OTHERWISE           @D64ADKH 08434000
*             TCB.DFWKCOMG(COMREG ADDRESS, PARTITION ONLY)     @D52VDMZ 08435000
*             GATES CLOSED AND GVFVGATE SET IF RC ¬= 0         @D64ADKH 08436000
*             R9  : RETURN CODE                                @D64ADKH 08437000
*             R9  : 0                                          @D64ADKH 08438000
*             R9  : X'0C' ONLY IF ICCF REQUEST NOT POSSIBLE    @D64ADKH 08439000
*             R9  : X'04' PART. GETVIS NOT AVAILABLE (STATUS REQUEST    08440000
*                   ONLY)                                      @DY44311 08441000
*             R9  : X'34' MORE THAN 32 TASKS ATTACHED IN PART. @D64ADKH 08442000
*                         TIBIMASK NOT SET.OS390 REQ.NOT ALLOW.@D64ADKH 08443000
*    LINK   : R8                                               @D64ADKH 08444000
*    WORK   : R4,R5,R9,RB                                      @D64ADKH 08445000
*                                                              @D149DJB 08446000
         AGO    .CREATEX                                       @D64ADKH 08447000
.GVFVGATS ANOP                                                 @D64ADKH 08448000
.*             0123456789ABCDEF                                @D149DJB 08449000
&INPREG  SETC '0000010001100100'                               @D14ZDJB 08450000
&OUTREG  SETC '0000000001001000'                               @D14ZDJB 08451000
&WRKREG  SETC '0000110001010000'                               @D14ZDJB 08452000
&NMDREG  SETC '1111001110100111'                               @D52VDMZ 08453000
&LINKR   SETC 'R8'                                             @D64ADKH 08454000
&TBASE   SETC 'OWN'                                            @D64ADKH 08455000
.*EXCLSYMS=()                                                  @D52VDMZ 08456000
         AGO    .TESTALL                                       @D14ZDJB 08457000
.CREATEX ANOP                                                  @D14ZDJB 08458000
***************************************************************@D149DJB 08459000
         SPACE 1                                               @D14CDJB 08460000
GVFVGATING DS 0H                                               @D64ADKH 08461000
         USING GVFVGATING,RE                                   @D64ADKH 08462000
         USING TCBADR,RA                                       @D14CDJB 08463000
*SGLINK  GVFVGATING,S,INPUT=(R5,R8:LINK,R9,RA,RD),OUTPUT=(R9,RC),      *08464000
               WORK=(R4,R5,R9,RB),AMODE=31,NOMODR=(R8)                  08465000
         USING SVEARA,RD                                       @D14CDJB 08466000
.*TIBIMASK IS USED TO MAKE AN OS390 SUBPOOL UNIQUE (PART.AND SPACE)     08467000
.*TIBIMASK IS ONLY SET FOR THE FIRST 32 TASKS IN THE PART. IF MORE      08468000
.*TASKS ARE ATTACHED, TIBIMASK IS ZERO AND GETMAIN REQ. ARE REJECTED    08469000
.*(ALL REQUESTS ALTHOUGH SVA REQUESTS WOULD WORK).                      08470000
.*WE REMOVE THE CHECK: REASON:                                          08470100
.*TIBIMASK IS NOT SET FOR SYSTEM TASKS. SO WE END WITH SMERR34          08470200
.*ALTHOUGH GETMAIN FOR SYSTEM GETVIS WOULD WORK (USED BY VENDORS).      08470300
.*IN CASE OF SMERR34 WE END WITH HARDWAIT FFF SINCE REG C IS NOT        08470400
.*CLEARED.                                                              08470500
.*WHEN MORE TASKS ARE SUPPORTED TIBIMASK MUST BE REPLACED BY A NEW      08470600
.*INTERFACE. SO WE SKIP THIS CODE.                                      08470700
         LTR   R5,R5              GETMAIN/FREEMAIN REQUEST     @D67BDMZ 08471000
         B     GVFVGT20           NO, TIBIMASK NOT NEEDED      @DY46339 08472490
         L     R4,TIBPTR          GET CURRENT TIB              @D67BDMZ 08473000
         USING TIBADR,R4                                       @D67BDMZ 08474000
         ICM   R4,15,TIBIMASK     TIBIMASK SET                 @D67BDMZ 08475000
         BNZ   GVFVGT20           YES, CONTINUE                @D67BDMZ 08476000
         DROP  R4                 RELEASE TIB                  @D67BDMZ 08477000
         LA    R9,SMERR34         STOP PROCESSING              @D67BDMZ 08478000
         BR    R8                 RETURN                       @D67BDMZ 08479000
GVFVGT20 DS    0H                                              @D67BDMZ 08480000
         SLL   R5,31              SHIFT GETMAIN/FREEMAIN INDICATOR      08481000
*                                 IN HIGH ORDER BIT            @D64ADKH 08482000
         LTR   R9,R9              GATE SPECIFIED               @D64ADKH 08483000
         BZ    GVFVGT13           NO, FIND CORRESP. GETVIS GATE@D64ADKH 08484000
GVFVGT16 DS    0H                                              @D64ADKH 08485000
         OR    R9,R5              SET GETMAIN/FREEMAIN IND.    @D64ADKH 08486000
         LA    R4,0               PFIX NOT TO BE CLOSED        @D64ADKH 08487000
         B     GVFVGT11           GO, CLOSE GETVIS GATE        @D64ADKH 08488000
GVFVGT13 DS    0H                                              @D64ADKH 08489000
         LA    RC,0               NO CI SET UP TO NOW          @D64ADKH 08490000
         TM    SVER0F+D3,SVAIND   REQUEST FOR SVA?             @D51IDMZ 08491000
         BO    GVFVGT01           YES => GATE SYSTEM GETVIS    @D64ADKH 08492000
         LH    R9,PIK             GETMAIN/FREEMAIN NOT ALLOWED.@D64ADMZ 08493000
         LTR   R9,R9              FROM SYSTEM TASKS FOR SPACE..@D64ADMZ 08494000
         BNZ   GVFVGT13_1         GETVIS AND PART. GETVIS..    @D64ADMZ 08495000
         LTR   R5,R5              SINCE TIBIMASK NOT SET       @D64ADMZ 08496000
         BNZ   GVFVGT07_2         GETMAIN/FREEMAIN REQUEST     @D64ADMZ 08497000
GVFVGT13_1 DS  0H                                              @D64ADMZ 08498000
         TM    SVER0F+D2,GVFVSPIN SPACE REQUEST                @D51IDMZ 08499000
         BNO   GVFVGT02           NO  ==> PARTITION REQUEST    @D64ADKH 08500000
************************************************************** @D149DJB 08501000
*   PROCESSING FOR SPACE REQUEST                             *          08502000
************************************************************** @D149DJB 08503000
         L     RB,PIBPTR2         LOAD REQUESTOR'S PIB2 PTR    @D51IDMZ 08504000
         USING PIB2ADR,RB                                      @D51IDMZ 08505000
         L     RB,PIBPCB          LOAD REQUESTOR'S PCB PTR     @D51IDMZ 08506000
         USING PCBADR,RB                                       @D51IDMZ 08507000
         TM    PCEFLAG,PCEDYNP    SPACE REQUEST FOR DYN. PART. @D51IDMZ 08508000
         BZ    GVFVGT00           NO, ROUTE REQUEST TO SVA     @D64ADKH 08509000
         ICM   RC,15,PCBDYSPC     PTR TO CI AVAILABLE ?        @D64ADMZ 08510000
         BNZ   GVFVGTSP_1         YES, CONTINUE                @D64ADMZ 08511000
         L     RC,SCBPTR          GET CURRENT SCB              @D64ADMZ 08512000
         USING SCBADR,RC                                       @D64ADMZ 08513000
         L     RC,SCBSPGVB                                     @D64ADMZ 08514000
         ST    RC,PCBDYSPC        SET PTR TO CONTROL INFO.     @D64ADMZ 08515000
         DROP  RC                 RELEASE SCB                  @D64ADMZ 08516000
GVFVGTSP_1 DS  0H                                              @D64ADMZ 08517000
         LA    R9,SRQDYSGV        POINT TO SPACE GATE          @D51IDMZ 08518000
         DROP  RB                                              @D51IDMZ 08519000
         B     GVFVGT03                                        @D64ADKH 08520000
GVFVGT00 EQU   *                                               @D64ADKH 08521000
         OI    SVER0F+D3,SVAIND   REQUEST FOR SVA              @D64ADKH 08522000
************************************************************** @D149DJB 08523000
*   PROCESSING FOR SVA  REQUEST                              *          08524000
************************************************************** @D149DJB 08525000
GVFVGT01 EQU   *                                               @D64ADKH 08526000
         L     R9,ASRQTAB         R9=GETVIS RESOURCE           @D61RDKH 08527000
         LA    R9,SRQSGTVS-SRQTAB(,R9) PTR TO RSRCE DESCRIPTOR @D61RDKH 08528000
         L     R4,IJBSMCOM        GET ADDRESS OF SMCOM         @D52VDMZ 08529000
         USING SMCOM,R4                                        @D52VDMZ 08530000
         TM    SYSFLAG4,ANCHSVA   AREA INITIALIZED ?           @D14CDJB 08531000
         BZ    GVFV_EXIT          NO                           @D64ADMZ 08532000
         L     RC,SMCSGV31        PTR TO CI OF SYSTEM GETVIS   @D52VDKH 08533000
         DROP  R4                                              @D64ADKH 08534000
************************************************************** @D149DJB 08535000
*   PROCESSING FOR SVA AND SPACE REQUEST                     *          08536000
************************************************************** @D149DJB 08537000
GVFVGT03 EQU   *                                               @D64ADKH 08538000
         OR    R9,R5              DIST. BETWEEN GETMAIN/GETVIS @D64ADKH 08539000
         LA    R4,0               PFIX GATE NOT TO BE CLOSED   @D64ADKH 08540000
         TM    SVER0F+D3,GVPFIX   GETVIS PFIX REQUEST ?        @D51IDMZ 08541000
         BZ    GVFVGT11           NO,                          @D64ADMZ 08542000
         L     R4,ASRQTAB         R4=ADDR OF PFIX RESOURCE     @D61RDKH 08543000
         LA    R4,SRQSPFIX-SRQTAB(,R4) PTR TO RSRCE DESCRIPTOR @D61RDKH 08544000
************************************************************** @D149DJB 08545000
*    IF IT IS A GETVIS PFIX REQUEST THEN                     *          08546000
*     CLOSE PFIX GATE AND GETVIS GATE                        *          08547000
************************************************************** @D149DJB 08548000
         USING RQADR,R4                                        @D64ADKH 08549000
GVFVGT05 DS    0H                 CHECK LENGTH                 @D52VDMZ 08550000
         TM    RSCDESC,FREEBIT    PFIX GATE OPEN               @D66ODOW 08551000
         DROP  R4                                              @D64ADKH 08552000
         BO    GVFVCG             YES => CHECK GETVIS GATE     @D66ODOW 08553000
         LR    RB,RC                                           @D64ADKH 08554000
         LR    R5,R4                                           @D64ADKH 08555000
         BAL   RC,RWAIT           WAIT FOR GATE                @D51IDMZ 08556000
*SGLINK  RWAIT,INPUT=(R5,RC)                                   @D51IDKH 08557000
         LR    RC,RB                                           @D64ADKH 08558000
         B     GVFVGT05           TRY AGAIN                    @D51IDMZ 08559000
GVFVGT11 DS    0H                                              @D64ADKH 08560000
         LTR   R9,R9              GETVIS GATE TO BE CLOSED     @D64ADKH 08561000
         BP    GVFVCG             AND GETVIS REQUEST           @D64ADKH 08562000
         USING ANCHTAB,RC                                      @D64ADKH 08563000
GVFVGT10 DS    0H                 GETMAIN REQUEST              @D52VDMZ 08564000
         TM    GMFMFLGS,PFIXPEND  GETMAIN PFIX REQUEST PENDING?@D64ADKH 08565000
         BZ    GVFVCG             NO                           @D64ADKH 08566000
* WHEN A GETMAIN PFIX REQUEST IS PENDING, NO FURTHER GETMAIN REQUEST    08567000
* IS ALLOWED (INDEPENDENT ON PFIX OR NOT)                               08568000
         LR    RB,RC              SAVE RC                      @D64ADKH 08569000
         L     R5,ASRQTAB                                      @D61RDKH 08570000
         LA    R5,SRQSPFIX-SRQTAB(,R5) PTR TO RSRCE DESCRIPTOR @D61RDKH 08571000
         BAL   RC,RWAIT           WAIT FOR GATE                @D51IDMZ 08572000
*SGLINK  RWAIT,INPUT=(R5,RC)                                   @D51IDKH 08573000
         LR    RC,RB              RESTORE RC                   @D64ADKH 08574000
         B     GVFVGT10           TRY AGAIN                    @D51IDMZ 08575000
         DROP  RC                                              @D64ADKH 08576000
GVFVCG   DS    0H                                              @D51IDMZ 08577000
         LR    RB,R9              REMOVE GETMAIN/FREEMAIN..    @D64ADKH 08578000
         SLL   RB,1               .. INDICATOR                 @D64ADKH 08579000
         LTR   RB,RB              GETVIS GATE TO BE CLOSED     @D64ADKH 08580000
         BZ    GVFVGT09           NO                           @D64ADKH 08581000
         TM    SVER0F+D1,GVSTATAL+GVSTATSZ IS IT STATUS COMMAND@D67FDMZ 08582000
         BNZ   GVFVCG_00          YES, NO SETLOCK REQ/POSSIBLE @D67FDMZ 08583000
         L     R5,PIBPTR2         GET PCB OF SERVICE OWNER     @D67FDMZ 08584000
         USING PIB2ADR,R5                                      @D67FDMZ 08585000
         L     R5,PIBPCB          GET PCB                      @D67FDMZ 08586000
         USING PCBADR,R5                                       @D67FDMZ 08587000
         TM    PCBFLAG,PCBMVSEM   OS390 EMULATION MODE         @D67FDMZ 08588000
         BZ    GVFVCG_00          NO, SETLOCK NOT NECESSARY    @D67FDMZ 08589000
         LA    R5,SRQGTV          PART. GETVIS GATE            @D67FDMZ 08590000
         DROP  R5                 RELEASE PCB                  @D67FDMZ 08591000
         SRL   RB,1               SHIFT GATE IN CORRECT POS.   @D67FDMZ 08592000
         CR    R5,RB              CLOSE PART. GETVIS GATE?     @D67FDMZ 08593000
         BNE   GVFVCG_00          NO                           @D67FDMZ 08594000
         L     RB,TCBATCBE        GET TCB EXTENSION            @D67FDMZ 08595000
         USING TCBXADR,RB                                      @D67FDMZ 08596000
         TM    TCBXSAUS,TCBXXSAU SAVE AREA FREE                @D67FDMZ 08597000
         BZ    GVFVCG_2           YES                          @D67FDMZ 08598000
         ST    R5,GVFVREG5        SAVE R5                      @D67FDMZ 08599000
         BAL   R5,SYSERROR        NO, MUST NOT OCCUR           @D67FDMZ 08600000
GVFVREG5 DC    F'0'               ORIGINAL CONTENTS OF R5      @D64ADMZ 08601000
GVFVCG_2 DS    0H                                              @D67FDMZ 08602000
         OI    TCBXSAUS,TCBXXSAU  SAVE AREA IN USE             @D67FDMZ 08603000
         LR    R5,RD              SAVE ORIGINAL SAVE AREA ADDR @D67FDMZ 08604000
         LA    RD,TCBXXSA         SAVE AREA USED BY SETLOCK    @D67FDMZ 08605000
         DROP  RB                 RELEASE TCBXADR              @D67FDMZ 08606000
         LR    RB,RF              RF USED BY CALLING ROUTINE   @D67FDMZ 08607000
*        SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,REGS=SAVE       @D67FDMZ 08608000
         SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,REGS=SAVE       @D67FDMZ 08609000
         L     RD,TCBATCBE        GET TCB EXTENSION            @D67FDMZ 08610000
         NI    TCBXSAUS-TCBXADR(RD),X'FF'-TCBXXSAU  RESET INUSE@D67FDMZ 08611000
         LR    RD,R5              RESTORE SAVE AREA ADDRESS    @D67FDMZ 08612000
         LR    R5,RF              SAVE SETLOCK RETURN CODE     @D67FDMZ 08613000
         LR    RF,RB              GET ORIGINAL RF              @D67FDMZ 08614000
         LTR   R5,R5              LOCK OBTAINED BY THIS REQUEST@D67FDMZ 08615000
         BNZ   GVFVCG_00          NO                           @D67FDMZ 08616000
         OI    TCBGRFLG,TCBSETLR  DO SETLOCK RELEASE ON EXIT   @D67FDMZ 08617000
GVFVCG_00 DS   0H                                              @D67FDMZ 08618000
         USING RQADR,R9                                        @D64ADKH 08619000
         TM    RSCDESC,FREEBIT    GETVIS GATE OPEN ?           @D66ODOW 08620000
         DROP  R9                                              @D64ADKH 08621000
         BO    GVFVGT04           YES                          @D66ODOW 08622000
         TM    SVER0F+D1,GVSTATAL+GVSTATSZ IS IT STATUS COMMAND@D64ADMZ 08623000
         BZ    GVFVCG_1           NO, CLOSE GATE               @D64ADMZ 08624000
         TM    SVER0F+D3,SVAIND   SVA REQUEST                  @D64ADMZ 08625000
         BO    GVFVCG_1           YES, CLOSE GATE              @D64ADMZ 08626000
         LA    R9,SMERR04         DO NOT WAIT IN CASE OF PART. @D64ADMZ 08627000
         BR    R8                 REQ., AR MIGHT HANG          @D64ADMZ 08628000
GVFVCG_1 DS    0H                                              @D64ADMZ 08629000
         LR    RB,RC                                           @D64ADKH 08630000
         LR    R5,R9              INPUT FOR RWAIT              @D64ADKH 08631000
         BAL   RC,RWAIT           WAIT FOR GATE                @D51IDMZ 08632000
*SGLINK  RWAIT,INPUT=(R5,RC)                                   @D51IDKH 08633000
         LR    RC,RB                                           @D64ADKH 08634000
         LTR   R4,R4              PFIX GATE TO BE CLOSED       @D64ADKH 08635000
         BNZ   GVFVGT05           YES, CHECK PFIX GATE         @D64ADKH 08636000
         B     GVFVGT11           TRY GETVIS GATE              @D64ADKH 08637000
GVFVGT04 DS    0H                                              @D51IDMZ 08638000
         USING RQADR,R9                                        @D52VDMZ 08639000
         MVC   RSCDESC,TID        CLOSE GETVIS GATE, IDENT OWNE@D66ODOW 08640000
         DROP  R9                 RELEASE RESOURCE DESC.       @D52VDMZ 08641000
GVFVGT09 DS    0H                                              @D51IDMZ 08642000
         LTR   R4,R4              PFIX GATE TO BE CLOSED       @D64ADKH 08643000
         BZ    GVFVGT06           NO                           @D64ADKH 08644000
         USING RQADR,R4                                        @D52VDMZ 08645000
         MVC   RSCDESC,TID        CLOSE PFIX GATE, IDENT OWNER @D66ODOW 08646000
         LTR   R9,R9              GETVIS REQUEST AND GATE ,,   @D64ADKH 08647000
         BP    GVFVGT06_1         ..CLOSED BY THIS REQUEST     @D64ADKH 08648000
         USING ANCHTAB,RC                                      @D64ADKH 08649000
         OI    GMFMFLGS,PFIXPEND  INDICATE PFIX PEND F. GETMAIN@D64ADKH 08650000
         DROP  RC                                              @D64ADKH 08651000
         DROP  R4                 RELEASE PFIX RESOURCE DESC.  @D52VDMZ 08652000
         B     GVFVGT06           ==>                          @D14CDJB 08653000
************************************************************** @D369DJB 08654000
*   GET COMREG AND ANCHOR TABLE POINTER FOR PARTITION        * @D149DJB 08655000
************************************************************** @D369DJB 08656000
GVFVGT02 EQU   *                                               @D14CDJB 08657000
         L     R9,TIBPTR          GET TIB POINTER              @D64ADMZ 08658000
         USING TIBADR,R9          GET TIB ADDRESSABILITY       @D64ADMZ 08659000
         TM    TIBFLAG2,ICCFPP    PSEUDO PARTITION REQUEST?    @D36GDJB 08660000
         DROP  R9                                              @D14CDJB 08661000
         BZ    GVFVGT07           NO  ==>                      @D14CDJB 08662000
         L     R9,IJBETSS         GET ICCF VECTOR TABLE        @DY43823 08663000
         USING DTSVECDS,R9        TELL ASSEMBLER               @DY43823 08664000
         TM    DTSFLG2,DTSCANCL   ICCF SUPVR CANCELLED?        @DY43823 08665000
         BNO   GVFVGT02_1         NO, CONTINUE                 @DY43823 08666000
         DROP  R9                                              @DY43823 08667000
         LA    R9,SMERR0C         NO GETVIS AVAILABLE          @DY43823 08668000
         BR    R8                 RETURN                       @DY43823 08669000
GVFVGT02_1 DS  0H                                              @D14CDJB 08670000
         L     R4,SVER02          GET ETSS GETVIS PARMTER LIST @D14CDJB 08671000
         L     RB,0(R4)           GET PSEUDO PARTITION COMREG  @D14CDJB 08672000
         ST    RB,DFWKCOMG        SAVE COMREG POINTER          @D14CDJB 08673000
         USING COMREG,RB                                       @D367DJB 08674000
         TM    OPTNBYTE,ANCHTBIT  TEST FIRST REQUEST           @D35DDUL 08675000
         BZ    GVFV_EXIT          NO  ==> RETURN TO CALLER     @D64ADMZ 08676000
         L     RC,IJBGVCTL        LOAD BASE REG OF ANCHOR TABLE@D52VDMZ 08677000
         DROP  RB                                              @D64ADKH 08678000
         B     GVFV_EXIT          ===> RETURN                  @D64ADMZ 08679000
GVFVGT07 DS    0H                                              @D14CDJB 08680000
         TM    SVER0F+D1,GVSTATAL+GVSTATSZ IS IT STATUS COMMAND@D64ADMZ 08681000
         BZ    GVFVGT07_1         NO                           @D64ADMZ 08682000
         L     R9,APCBATAB        APCBATAB                     @DY44311 08683000
         L     RB,SVER00          GET PIK OF REQ. PARTITION    @DY44311 08684000
         SRL   RB,2               PIK /4                       @DY44311 08685000
         AR    R9,RB              OFFSET IN PCBATAB            @DY44311 08686000
         ICM   R9,15,0(R9)        GET PCB, PARTITION ALLOCATED @DY44311 08687000
         BZ    GVFVGT07_2         NO                           @D64ADMZ 08688000
         USING PCBADR,R9                                       @D64ADKH 08689000
         L     RB,PCECOMRA        GET COMREG ADDR              @D64ADMZ 08690000
         B     GVFVGT07_4                                      @D64ADMZ 08691000
GVFVGT07_2 DS 0H                                               @D64ADMZ 08692000
         LA    R9,SMERR04         AREA NOT AVAILABLE           @D64ADMZ 08693000
         BR    R8                 RETURN                       @D64ADMZ 08694000
GVFVGT07_1 DS 0H                                               @D64ADMZ 08695000
         L     R9,PIBPTR2         GET PCB OF SERVICE OWNER     @D67FDMZ 08696000
         L     R9,PIBPCB-PIB2ADR(R9)                           @D67FDMZ 08697000
         L     RB,PCECOMRA        GET COMREG ADDR              @D64ADMZ 08698000
         ST    RB,DFWKCOMG        SAVE COMREG PTR              @D64ADMZ 08699000
GVFVGT07_4 DS 0H                                               @D64ADMZ 08700000
         USING COMREG,RB                                       @D367DJB 08701000
         TM    OPTNBYTE,ANCHTBIT  TEST FIRST REQUEST           @D35DDUL 08702000
         BO    GVFVGT07_3         NO                           @D64ADMZ 08703000
         TM    SVER0F+D1,GVSTATAL+GVSTATSZ IS IT STATUS=ALL OR @DY44311 08704000
         BZ    GVFV_EXIT          STATUS=SIZE THEN RETURN      @D64ADMZ 08705000
         LA    R9,SMERR04         AREA NOT AVAILABLE           @D64ADMZ 08706000
         BR    R8                                              @D64ADMZ 08707000
GVFVGT07_3 DS 0H                                               @D64ADMZ 08708000
         L     RC,IJBGVCTL        LOAD BASE REG OF ANCHOR TABLE@D52VDMZ 08709000
         DROP  RB                 RELEASE COMREG               @D64ADKH 08710000
         LA    R9,SRQGTV          POINT TO GETVIS QUEUE        @D14CDJB 08711000
         DROP  R9                 DROP PCB                     @D64ADKH 08712000
         OR    R9,R5              OR GETMAIN/GETVIS INDICATION @D64ADKH 08713000
         LA    R4,0               NO PFIX REQUEST              @D64ADKH 08714000
         B     GVFVGT11           HANDLE GETVIS GATE           @D64ADKH 08715000
GVFVGT06 DS    0H                                              @D14CDJB 08716000
         LR    RB,R9                                           @D64ADKH 08717000
         SLL   RB,1               REMOVE GETMAIN INDICATION    @D64ADMZ 08718000
         LTR   RB,RB              WAS GETVIS GATE CLOSED ..    @D64ADMZ 08719000
*                                 .. BY THIS REQUEST           @D64ADMZ 08720000
         BZ    GVFVGT_CLR         NO                           @D64ADKH 08721000
         USING ANCHTAB,RC                                      @D64ADKH 08722000
GVFVGT06_1 DS  0H                                              @D64ADMZ 08723000
         O     R9,BIT0OMSK        INDICATION TO OPEN GETVIS..  @D64ADKH 08724000
*                                 ..GATE AT EXIT               @D64ADKH 08725000
         ST    R9,GVFVGATE        SAVE GATE + INDICATION       @D64ADKH 08726000
         B     GVFV_EXIT          RETURN ===>                  @D64ADMZ 08727000
GVFVGT_CLR DS 0H                                               @D64ADKH 08728000
         NC    GVFVGATE,BIT0OFF   DO NOT OPEN GETVIS GATE ..   @D64ADKH 08729000
*                                 ..AT EXIT FROM THIS REQUEST  @D64ADKH 08730000
GVFV_EXIT DS   0H                                              @D64ADMZ 08731000
         SR    R9,R9              CLEAR RETURN CODE            @D64ADKH 08732000
         BR    R8                                              @D64ADKH 08733000
         DROP  RD,RA,RE,RC                                     @D64ADKH 08734000
         EJECT                                                 @D14CDJB 08735000
***************************************************************         08736000
*                                                                       08737000
*  GMFM_ACTIVATE         ACTIVATE AN MVS SUBPOOL FOR GETVIS/FREEVIS     08738000
*                                                                       08739000
*        THE MVS SUBPOOL IS MAINTAINED BY IJBSSM2                       08740000
*        FOR GETVIS/FREEVIS PROCESSING THE RELEVANT INFORMATION         08741000
*        MUST BE COPIED TO THE SUBPOOL INDEX TABLE                      08742000
*                                                                       08743000
*                                                                       08744000
*     CALLED BY : GETVISMR, FREEVSMR (MAIN PATH), AND                   08745000
*                 GTVSINIT (FREEVIS INITIALIZATION)                     08746000
*     CALLS     : IJBSSM2, ACTIVATE_SUBPOOL                             08747000
*                                                                       08748000
*    INPUT  : SPIDSAV                                                   08749000
*             RC = ADDR(CONTROL INFO)                                   08750000
*                                                                       08751000
*    OUTPUT : GMFMSPNM+6 = INDEX INTO SUBPOOL INDEX TABLE               08752000
*             SPIDSAV = BSUBPINT+(MXSUBPLH+1)*SUBPINTL                  08753000
*             RF = RETURN CODE                                          08754000
*             MXSUBPLH+1 IN SUBPOOL INDEX TABLE = MVS SUBPOOL INFO      08755000
*    LINK   : R8                                                        08756000
*    WORK   : R4,R5,R7                                                  08757000
*                                                                       08758000
         AGO    .CREATE_01                                     @D64ADKH 08759000
.GMFMACTV ANOP                                                 @D64ADKH 08760000
.*             0123456789ABCDEF                                @D149DJB 08761000
&INPREG  SETC '0000000000001000'                               @D64ADKH 08762000
&OUTREG  SETC '0000010000000001'                               @D64ADKH 08763000
&WRKREG  SETC '0000110100000010'                               @D64ADKH 08764000
&NMDREG  SETC '1111001011111100'                               @D64ADKH 08765000
&LINKR   SETC 'R8'                                             @D64ADKH 08766000
&TBASE   SETC 'OWN'                                            @D64ADKH 08767000
.*EXCLSYMS=()                                                  @D52VDMZ 08768000
         AGO    .TESTALL                                       @D14ZDJB 08769000
.CREATE_01 ANOP                                                @D64ADKH 08770000
***************************************************************@D149DJB 08771000
         USING GMFM_ACTIVATE,RE                                @D64ADKH 08772000
         USING ANCHTAB,RC                                      @D64ADKH 08773000
         SPACE 1                                               @D14CDJB 08774000
GMFM_ACTIVATE  DS  0H                                          @D64ADKH 08775000
*SGLINK  GMFM_ACTIV,S,INPUT=(R8:LINK,RC),OUTPUT=(R5,RF),               *08776000
               WORK=(R2,R5,RE),AMODE=31,NOMODR=(R8)                     08777000
         SPACE                                                          08778000
         LA    RF,0               CLEAR RETURN CODE            @D64ADKH 08779000
         L     R5,SPIDSAV         IS MVS SUBPOOL ALREADY ACTIVE@D64ADKH 08780000
         LTR   R5,R5              (LIST REQUEST ONLY) ?        @D64ADKH 08781000
         BNZR  R8                 YES                          @D64ADKH 08782000
         LA    R5,SUBPINTL        LENGTH OF SUBPOOL ENTRY      @D64ADKH 08783000
         MH    R5,MXSUBPLH        MAX. NUMBER OF SUBPOOLS      @D64ADKH 08784000
         LA    R5,SUBPINTL(R5)    SLOT FOR MVS SUBPOOLS        @D64ADKH 08785000
         STH   R5,GMFMSPNM+6      SUBPOOL INDEX                @D64ADKH 08786000
         A     R5,BSUBPIND        ADDRESS OF SUBPOOL ENTRY     @D64ADKH 08787000
         ST    R5,SPIDSAV         SAVE IT                      @D64ADKH 08788000
         LR    R2,R8              SAVE RETURN ADDRESS          @D64ADKH 08789000
.* IF SPITMVSP = 0, SUBPOOL DOES NOT YET EXIST                          08790000
.* CREATE SPLE                                                          08791000
*SGLINK  ACTIVATE,INPUT=(R8,RC-RF),OUTPUT=(RF)                 @D64ADKH*08792000
                NOMODR=(R1,R2-R6,R7,R9-RC,RD)                  @D64ADKH 08793000
         SGAMSUBR SUBROUT=IJBSSM2,                             @D64ADKH*08794000
               LINK=(FUNCTION,SM2ACT),                         @D64ADKH*08795000
               SUBROUC=GMFMACTIV,                              @D64ADKH*08796000
               CBASE=OWN                                       @D64ADKH 08797000
         LR    R8,R2              RESTORE RETURN ADDRESS       @D64ADKH 08798000
         LTR   RF,RF              ACTIVATE DONE                @D64ADKH 08799000
         BZR   R8                 YES                          @D64ADKH 08800000
         LA    R5,0               INDICATE ...                 @D64ADKH 08801000
         ST    R5,SPIDSAV         .. NO SUBPOOL PROCESSED..    @D64ADKH 08802000
         STH   R5,GMFMSPNM+6      .. UP TO NOW                 @D64ADKH 08803000
         BR    R8                 RETURN ===>                  @D14CDJB 08804000
         DROP  RC,RE                                           @D64ADKH 08805000
         EJECT                                                 @D14CDJB 08806000
***************************************************************         08807000
*                                                                       08808000
*  LINK TO MODULE IJBSSM2                                               08809000
*                                                                       08810000
*     FOLLOWING CODE IS GENERATED                                       08811000
*        LA  RF,<FUNCTION CODE>                                         08812000
*        L   R8,ASVASVDL                                                08813000
*        L   R8,AIJBSSM2-SVASVDL(,R8)                                   08814000
*        BALR RE,R8  (AMODE = 31)                                       08815000
*        L    RE,<BASE ADDRESS OF CALLER>                               08816000
*                                                                       08817000
         AGO    .CREATE_02                                     @D64ADKH 08818000
.IJBSSM2  ANOP                                                 @D64ADKH 08819000
.*             0123456789ABCDEF                                @D149DJB 08820000
&INPREG  SETC '0000000000000000'                               @D64ADKH 08821000
&OUTREG  SETC '0000000000000000'                               @D64ADKH 08822000
&WRKREG  SETC '0000000000000000'                               @D64ADKH 08823000
&NMDREG  SETC '0000000000000000'                               @D64ADKH 08824000
&LINKR   SETC '00'                                             @D64ADKH 08825000
&TBASE   SETC 'MODULE'                                         @D64ADKH 08826000
.*EXCLSYMS=()                                                  @D52VDMZ 08827000
         AGO    .TESTALL                                       @D14ZDJB 08828000
.CREATE_02 ANOP                                                @D64ADKH 08829000
***************************************************************@D149DJB 08830000
         EJECT                                                 @D14CDJB 08831000
*********************************************************************** 08832000
*                                                                       08833000
*   ENTRY POINTS FOR GETMAIN, FREEMAIN, AND STORAGE                     08834000
*                                                                       08835000
*      GMFMSVC04 : GETMAIN REQUEST                                      08836000
*      GMFMSVC05 : FREEMAIN REQUEST                                     08837000
*      GMFMSVC0A : GETMAIN/FREEMAIN REQUEST                             08838000
*      GMFMSVC78 : GETMAIN/FREEMAIN REQUEST                             08839000
*      GMFMPC    : STORAGE REQUEST                                      08840000
*                                                                       08841000
*      GMFMSVC..  ARE ACTIVATED VIA SIMSVC AND                          08842000
*      GMFMSVC78  ADDITIONALLY VIA BASSM                                08843000
*      GMFMSVC..                                                        08844000
*                                                                       08845000
*        INPUT                                                          08846000
*           R6 : RETURN ADDR (=ADDR(DISP) WHEN SVC)                     08847000
*           RA : ADDR(TCB)                                              08848000
*           SVER00, SVER01, SVER0F IN TCBSAVE SAVE AREA                 08849000
*           TCBEXFLG                                                    08850000
*        OUTPUT                                                         08851000
*           SVER00, SVER01, SVER0F IN TCBSAVE SAVE AREA                 08852000
*        WORK                                                           08853000
*           ALL EXCEPT R6,RA                                            08854000
*                                                                       08855000
*      GMFMPC     IS  ACTIVATED VIA PROGRAM CALL                        08856000
*                                                                       08857000
*        INPUT : NONE                                                   08858000
*                THE SVC INTERFACE IS ACHIEVED BY USING A DISP. SERVICE 08859000
*        OUTPUT = AS SPECIFIED FOR THE RESPECTIVE REQUESTS              08860000
*                                                                       08861000
*  GETMAIN/FREEMAIN AND STORAGE IS ALLOWED IN NATIVE ENVIRONMENT,       08862000
*  BUT NOT IN ICCF PSEUDO PARTITION (CANCEL WITH ILLEGAL SVC)           08863000
*********************************************************************** 08864000
         SPACE  3                                              @D64ADKH 08865000
         USING GMFMENTRY,RE                                    @D64ADKH 08866000
GMFMENTRY DS   0H                                              @D64ADKH 08867000
****                                                                    08868000
         SPACE  2                                              @D64ADKH 08869000
GMFMSVC04 DS   0H               GETMAIN                        @D64ADKH 08870000
         SPACE                                                          08871000
         BALR  RE,0                                            @D64ADKH 08872000
         LA    R0,(*-GMFMENTRY) ADJUST BASE REGISTER           @D64ADKH 08873000
         LA    RE,0(RE)                                        @D64ADKH 08874000
         SR    RE,R0                                           @D64ADKH 08875000
         LA    R0,4             IDENTIFY REQUEST (SVC NO)      @D64ADKH 08876000
         B     COMMON_CODE                                     @D64ADKH 08877000
         SPACE                                                          08878000
GMFMSVC05 DS   0H               FREEMAIN                       @D64ADKH 08879000
         SPACE                                                          08880000
         BALR  RE,0                                            @D64ADKH 08881000
         LA    R0,(*-GMFMENTRY) ADJUST BASE REGISTER           @D64ADKH 08882000
         LA    RE,0(RE)                                        @D64ADKH 08883000
         SR    RE,R0                                           @D64ADKH 08884000
         LA    R0,5             IDENTIFY REQUEST (SVC NO)      @D64ADKH 08885000
         B     COMMON_CODE                                     @D64ADKH 08886000
         SPACE                                                          08887000
GMFMSVC0A DS   0H               GETMAIN/FREEMAIN               @D64ADKH 08888000
         SPACE                                                          08889000
         BALR  RE,0                                            @D64ADKH 08890000
         LA    R0,(*-GMFMENTRY) ADJUST BASE REGISTER           @D64ADKH 08891000
         LA    RE,0(RE)                                        @D64ADKH 08892000
         SR    RE,R0                                           @D64ADKH 08893000
         LA    R0,X'0A'         IDENTIFY REQUEST (SVC NO)      @D64ADKH 08894000
         B     COMMON_CODE                                     @D64ADKH 08895000
         SPACE                                                          08896000
GMFMSVC78 DS   0H               GETMAIN/FREEMAIN               @D64ADKH 08897000
         SPACE                                                          08898000
         BALR  RE,0                                            @D64ADKH 08899000
         LA    R0,(*-GMFMENTRY) ADJUST BASE REGISTER           @D64ADKH 08900000
         LA    RE,0(RE)                                        @D64ADKH 08901000
         SR    RE,R0                                           @D64ADKH 08902000
         LA    R0,X'78'         IDENTIFY REQUEST  (SVC NO)     @D64ADKH 08903000
         B     COMMON_CODE                                     @D64ADKH 08904000
         SPACE                                                          08905000
GMFMPC   DS    0H                                              @D64ADKH 08906000
         SPACE                                                          08907000
         L     R6,DISPAD                                       @D64ADKH 08908000
         USING DISP,R6                                         @D64ADKH 08909000
         L     RF,TIBPTR        GET CURRENT TIB                @D64ADMZ 08910000
         TM    TIBFLAG2-TIBADR(RF),ICCFPP ICCF PSEUDO PART.    @D64ADMZ 08911000
         BO    ERR21            YES, NOT ALLOWED               @D64ADMZ 08912000
         SPACE                                                          08913000
         L     RE,LPPARM-LPA(,R4)   GET BASE ADDRESS           @D64XDMZ 08914000
         L     R6,ADISPSER        BASE OF DISPSERV             @D64ADKH 08915000
         DROP  R6                                              @D64ADKH 08916000
         LA    R0,8(,0)           FUNCTION CODE TO GET SVC ST. @D64ADKH 08917000
*SGLINK  DISPSERV,INPUT=(R0,R6,R7),WORK=(R2,R3,R4)                      08918000
*        AMODESW CALL,REGS=(R7,R6)                             @D64ADKH 08919000
         AMODESW CALL,REGS=(R7,R6) =========> GET SVC STATE    @D64ADKH 08920000
         L     RA,TCBPTR                                       @D64ADKH 08921000
         LA    R0,X'FF'         IDENTIFY REQUEST (PC)          @D64ADKH 08922000
         LA    R6,STORAGE_PR                                   @D64ADKH 08923000
         O     R6,BIT0OMSK                                     @D64ADKH 08924000
         B     COMMON_CODE_1                                   @D64ADKH 08925000
*                                                                       08926000
COMMON_CODE DS 0H                                              @D64ADKH 08927000
*                                                                       08928000
         L     RF,TIBPTR        GET CURRENT TIB                @D64ADMZ 08929000
         TM    TIBFLAG2-TIBADR(RF),ICCFPP ICCF PSEUDO PART.    @D64ADMZ 08930000
         BZ    COMMON_CODE_0    NO, CONTINUE                   @D66CDMZ 08931000
         L     R6,DISPAD                                       @D66CDMZ 08932000
         USING DISP,R6                                         @D66CDMZ 08933000
         B     ERR21            YES, NOT ALLOWED               @D66CDMZ 08934000
         DROP  R6               RELEASE DISP                   @D64ADMZ 08935000
COMMON_CODE_0 DS 0H                                            @D66CDMZ 08936000
*                                                                       08937000
*        AMODESW SET,AMODE=31,WR=(RF)  SWITCH TO AMODE 31      @D64ADKH 08938000
         AMODESW SET,AMODE=31,WR=(RF)                          @D64ADKH 08939000
         SPACE                                                          08940000
         USING TCBADR,RA                                       @D64ADKH 08941000
COMMON_CODE_1 DS 0H                                            @D64ADKH 08942000
*                                                                       08943000
* INPUT R0: SVC NUMBER OR X'FF' FOR STORAGE PC                          08944000
*       R6: RETURN ADDRESS                                              08945000
*       RE: BASE                                                        08946000
*       RA: TCBPTR                                                      08947000
         SPACE                                                          08948000
         L     RD,TCBSAVE       ADDR(USER SAVE AREA)           @D64ADKH 08949000
         SPACE                                                          08950000
*                                                                       08951000
         USING SVEARA,RD                                       @D64ADKH 08952000
         L     R1,SVER0F      SAVE OPTIONS, SINCE SVER0F IS UPDATED     08953000
*                             DURING GETSTYPE                  @D64ADKH 08954000
.* GETSTYPE SETS THE OPTIONS IN SVER0F, WHICH ARE NECESSARY TO          08955000
.* DO GATE HANDLING                                                     08956000
*SGLINK  GETSTYPE,INPUT=(R0,R8,RD,RE:LINK,RF),                 @D64ADKH*08957000
               OUTPUT=(RF),NOMODR=(R0,R1,R6,RA,RD)             @D64ADKH 08958000
         SGAMSUBR SUBROUT=IJBSSM2,                             @D64ADKH*08959000
               LINK=(FUNCTION,SM2GET),                         @D64ADKH*08960000
               SUBROUC=GMFMENTR,                               @D64ADKH*08961000
               CBASE=OWN                                       @D64ADKH 08962000
         LTR   RF,RF          VALID REQUEST                    @D64ADKH 08963000
         BZ    GMFM_COMMON_8  YES                              @D64ADKH 08964000
.* SVER0F NOT CHANGED WHEN RF /= 0                                      08965000
         LA    RC,0           INDICATION TO STOP PROCESSING    @D64ADKH 08966000
         LR    R1,RF          SAVE RETURN CODE                 @D64ADKH 08967000
         B     EXIT_CODE                                       @D64ADKH 08968000
         SPACE                                                          08969000
GMFM_COMMON_8  DS  0H                                          @D64ADKH 08970000
         SPACE                                                          08971000
         LA    R9,0           DETERMINE GETVIS GATE TO CLOSE   @D64ADKH 08972000
         LA    R5,1           INDICATE GETMAIN/FREEMAIN        @D64ADKH 08973000
*SGLINK  GVFVGATING,INPUT=(R5,R8:LINK,R9,RA,RD),OUTPUT=(R9,RC)         *08974000
               AMODE=31,NOMODR=(R0,R1,R6,RA,RD)                         08975000
         SGAMSUBR SUBROUT=GVFVGATS,                            @D64ADKH*08976000
               INPUT=(R5,R9,RA,RD),                            @D64ADMZ*08977000
               NOMOD=(R0,R1,R2,R3,R6,R7,RA,RD,RE,RF),          @D64ADKH*08978000
               OUTPUT=(R9,RC),                                 @D64ADMZ*08979000
               LINK=(R8),         SET STORAGE KEY TO ZERO      @D64ADKH*08980000
               CBASE=OWN,                                      @D64ADKH*08981000
               SUBROUC=GMFMENTR                                @D64ADKH 08982000
         LTR   RC,RC          IF CI SET, GATES ARE CLOSED..    @D64ADKH 08983000
         BNZ   GMFM_COMMON_1  ..PROCESSING CAN CONTINUE        @D64ADKH 08984000
         SPACE                                                          08985000
* THE FIRST REQUEST FOR AN AREA MUST ALWAYS BE A GETVIS REQUEST.        08986000
* SO AT THE FIRST GETMAIN REQUEST, THE CI MUST BE AVAILABLE (RC/=0)     08987000
* 1) SVA : FIRST REQUEST DONE BY IPL                                    08988000
* 2) SPACE:FIRST REQUEST DONE DURING INTIALIZATION OF DYNAMIC PART.     08989000
*    (ASSUMPTION NO LONGER VALID FOR X-MODE???)                         08990000
* 3) PART.:FIRST REQUEST ALWAYS DONE BY JCL                             08991000
* EXCEPTION: EXEC ..,REAL MAY HAVE NO GETVIS AREA AT ALL.               08992000
         ST    R1,SVER0F      SET ORIGINAL CONTENTS OF SVER0F  @D64ADKH 08993000
         LA    R1,4           ERROR CODE                       @D64ADKH 08994000
         B     EXIT_CODE                                       @D64ADKH 08995000
         SPACE                                                          08996000
GMFM_COMMON_1  DS  0H                                          @D64ADKH 08997000
         SPACE                                                          08998000
*THE GETMAIN REQUEST IS MAPPED TO A GETVIS REQUEST IN AN ARTIFICAL      08999000
*SAVE AREA, POINTED TO BY REGISTER RD. THIS SAVE AREA IS USED BY        09000000
*GETVIS PROCESSING, WHEN IT IS CALLED BY THE GETMAIN REQUEST.           09001000
         USING ANCHTAB,RC                                      @D64ADKH 09002000
         LR    R8,RD           SAVE USER'S SAVE AREA ADDRESS   @D64ADKH 09003000
         LA    RD,GMFMWRK1     RD = ADDR ARTIFICAL SAVE AREA   @D64ADKH 09004000
         MVC   SVER0F(4),SVER0F-SVEARA(R8)  MOVE OPTIONS SET UP TO NOW  09005000
*                                                              @D64ADKH 09006000
         ST    R1,SVER0F-SVEARA(,R8) SET ORIGINAL CONTENTS     @D64ADKH 09007000
         STC   R0,GMFMRQST     SVC NUMBER OR X'FF'             @D64ADKH 09008000
         ST    R8,SVER04       ADDR OF USER SAVE AREA          @D64ADKH 09009000
         ST    R6,SVER05       SAVE RETURN ADDR                @D64ADKH 09010000
         ST    RE,SVER08       SAVE BASE ADDR                  @D64ADMZ 09011000
*SGLINK  ANALYZE,INPUT=(R8,RC,RD,RE:LINK,RF),                  @D64ADKH*09012000
               OUTPUT=(R8,RF),                                 @D64ADKH*09013000
               NOMODR=(RA,RC,RD)                               @D64ADKH 09014000
         SGAMSUBR SUBROUT=IJBSSM2,                             @D64ADKH*09015000
               LINK=(FUNCTION,SM2ANA),                         @D64ADKH*09016000
               SUBROUC=GMFMENTR,                               @D64ADKH*09017000
               CBASE=OWN                                       @D64ADKH 09018000
         LTR   RF,RF               ANALYZE WORKED              @D64ADKH 09019000
         BZ    GMFM_COMMON_3       YES                         @D64ADKH 09020000
         LA    R2,NOSLOTS          WAS NO SPACE FOR SPLE...    @D64ADKH 09021000
         CR    RF,R2               .. AVAILABLE                @D64ADKH 09022000
         BE    GMFM_COMMON_2       YES, GET SPACE              @D64ADKH 09023000
         ST    RF,SVER0F           INVALID REQUEST, SAVE RETC. @D64ADKH 09024000
         B     EXIT_CODE                                       @D64ADKH 09025000
         SPACE                                                          09026000
GMFM_COMMON_2  DS  0H              GET SPACE FOR SPLE          @D64ADKH 09027000
         SPACE                                                          09028000
* FOR THE SPLE REQUEST, THE USER SAVE AREA IS USED AND MUST BE UPDATED  09029000
* TO CONTAIN THE REQUEST                                                09030000
* LOCATION OF SPLE : SVA FOR SVA AND ROUTED SPACE REQUESTS              09031000
*                    (SYSTEM GETVIS GATE ALREADY CLOSED)                09032000
*                    SPACE GETVIS FOR SPACE AND PARTITION REQUESTS      09033000
*                    (SPACE REQUEST : GATE ALREADY CLOSED)              09034000
*                    (PARTITION REQUEST: SPACE GATE MUST BE CLOSED)     09035000
         L     R7,SVER04           GET ADDR OF USER SAVE AREA  @D64ADKH 09036000
         MVC   SVER09(5*4),SVER0E-SVEARA(R7) SAVE SVER0E-SVER02@D64ADKH 09037000
         MVC   SVER02-SVEARA(4,R7),GMFMFLGS SAVE OPTIONS       @D64ADKH 09038000
         ST    RC,SVER0E           SAVE PTR TO CI              @D64ADKH 09039000
         ST    RD,SVER0E-SVEARA(,R7)  SAVE RD IN SVER0E        @D64ADKH 09040000
         ST    R8,SVER00-SVEARA(,R7)  SET SPLE LENGTH A. OPTION@D64ADKH 09041000
         MVC   SVER0F-SVEARA(4,R7),GMSPLEOPTS IN USER SAVE AREA@D64ADKH 09042000
         TM    SVER0F+D3,SVAIND       SVA REQUEST              @D64ADKH 09043000
         BO    GMFM_COMMON_0          YES                      @D64ADKH 09044000
         NI    SVER0F-SVEARA+D3(R7),X'FF'-SVAIND               @D64ADKH 09045000
         OI    SVER0F-SVEARA+D2(R7),GVFVSPIN                   @D64ADKH 09046000
         TM    SVER0F+D2,GVFVSPIN     SPACE REQUEST            @D64ADKH 09047000
         BZ    GMFM_COMMON_5          NO, CLOSE GATE           @D64ADKH 09048000
         SPACE                                                          09049000
GMFM_COMMON_0  DS  0H                                          @D64ADKH 09050000
         SPACE                                                          09051000
         OI    GMFMFLGS,GMFM_SYSTEM  INTERNAL REQ. GATE OPEND BY        09052000
*                                    REQUESTOR                 @D64ADKH 09053000
         MVI   GMFMRQST,X'00'      INDICATE GETVIS REQUEST     @D64ADKH 09054000
         LR    RD,R7               USE USER'S SAVE AREA        @D64ADKH 09055000
         B     GMFM_COMMON_10                                  @D64ADKH 09056000
         SPACE                                                          09057000
GMFM_COMMON_5  DS  0H      ORIGINAL REQUEST WAS FOR PARTITION  @D64ADKH 09058000
*                          CLOSE SPACE GATE                    @D64ADKH 09059000
         LR    RD,R7                                           @D64ADKH 09060000
         LA    R9,0                                            @D64ADKH 09061000
         LA    R5,0                                            @D64ADKH 09062000
*SGLINK  GVFVGATING,INPUT=(R5,R8:LINK,R9,RA,RD),OUTPUT=(R9,RC),        *09063000
               AMODE=31,NOMODR=(R7,RA)                                  09064000
         SGAMSUBR SUBROUT=GVFVGATS,                            @D64ADKH*09065000
               INPUT=(R5,R9,RA,RD),                            @D64ADMZ*09066000
               NOMOD=(R0,R1,R2,R3,R6,R7,RA,RD,RE,RF),          @D64ADKH*09067000
               OUTPUT=(R9,RC),                                 @D64ADMZ*09068000
               LINK=(R8),         SET STORAGE KEY TO ZERO      @D64ADKH*09069000
               CBASE=OWN,                                      @D64ADKH*09070000
               SUBROUC=GMFMENTR                                @D64ADKH 09071000
         SPACE                                                          09072000
GMFM_COMMON_10  DS  0H                                         @D64ADKH 09073000
         LA    RF,0                                            @D64ADKH 09074000
*SGLINK  GETVISMR,INPUT=(R6:LINK,RA,RC-RF),OUTPUT=(RF),                *09075000
               NOMODR=(RA,RD)                                           09076000
         L     RE,AMBASE                                       @D64ADKH 09077000
         BAL   R6,GETVISMR-GETVIS(RE)                          @D64ADKH 09078000
         LR    R7,RD           R7 POINTS TO USER SAVE AREA     @D64ADKH 09079000
         L     RD,SVER0E       RD POINTS TO ARTIFICAL SAVE.AREA@D64ADKH 09080000
         L     RC,SVER0E       RESTORE PTR TO CI               @D64ADKH 09081000
         L     RE,SVER08       RESTORE BASE                    @D64ADKH 09082000
         L     R6,SVER05       RESTORE RETURN ADDRESS          @D64ADKH 09083000
         MVC   GMFMFLGS(4),SVER02-SVEARA(R7)                   @D64ADKH 09084000
         MVC   GMFMSPLE,SVER01-SVEARA(R7)  ADDR OF SPLE        @D64ADKH 09085000
         MVC   SVER0E-SVEARA(5*4,R7),SVER09 RESTORE SVER0E-SVER02 IN    09086000
*                                    USER'S SAVE AREA          @D64ADMZ 09087000
         LTR   RF,RF           GETVIS FOR SPLE WORKED?         @D64ADKH 09088000
         BZ    GMFM_COMMON_3   YES                             @D64ADKH 09089000
         LA    RF,0            NO                              @D64ADKH 09090000
         ST    RF,GMFMSPLE     CLEAR ADDRESS                   @D64ADKH 09091000
         LA    RF,X'1C'                                        @D64ADKH 09092000
         ST    RF,SVER0F                                       @D64ADKH 09093000
         B     EXIT_CODE                                       @D64ADKH 09094000
GMFM_COMMON_3  DS  0H                                          @D64ADKH 09095000
         MVC   SVER03,SVER0F     SAVE OPTIONS USED FOR LIST REQ@D64ADMZ 09096000
*                                SVER0F WILL CONTAIN RET.CODE           09097000
         TM    GMFMFLGS,GM       GETMAIN REQUEST               @D64ADKH 09098000
         BZ    GMFM_COMMON_4     NO, FREEMAIN                  @D64ADKH 09099000
*                                                                       09100000
GMFM_COMMON_9  DS  0H            PROCESS GETMAIN REQUEST       @D64ADKH 09101000
*                                                                       09102000
*SGLINK  GETVISMR,INPUT=(R6:LINK,RA,RC-RF),OUTPUT=(RF),        @D64ADKH*09103000
               NOMODR=(RA,RD)                                  @D64ADKH 09104000
         ST    RE,SVER08             SAVE BASE                 @D64ADKH 09105000
         L     RE,AMBASE             GET GETVIS BASE           @D64ADKH 09106000
         BAL   R6,GETVISMR-GETVIS(RE)  CALL GETVIS             @D64ADKH 09107000
         L     RE,SVER08             RESTORE BASE              @D64ADKH 09108000
         B     EXIT_CODE             CHECK RESULT              @D64ADKH 09109000
*                                                                       09110000
GMFM_COMMON_4  DS  0H            FREEMAIN REQUEST              @D64ADKH 09111000
*                                                                       09112000
*SGLINK  FREEVSM0,INPUT=(R6:LINK,RA,RC-RF),OUTPUT=(RF),                *09113000
               NOMODR=(RA,RD)                                           09114000
         ST    RE,SVER08         SAVE BASE                     @D64ADKH 09115000
         L     RE,AMBASE                                       @D64ADKH 09116000
         BAL   R6,FREEVSM0-GETVIS(RE)                          @D64ADKH 09117000
         L     RE,SVER08         RESTORE BASE                  @D64ADKH 09118000
*                                                                       09119000
EXIT_CODE  DS  0H                                              @D64ADKH 09120000
*                                                                       09121000
         LTR   RC,RC                STOP PROCESSING            @D64ADKH 09122000
*                                   RC=0: ERROR DUR. GETSTYPE  @D64ADKH 09123000
         BZ    GMFM_MAPRC           YES, MAP RETCODE TO ABEND  @D64ADKH 09124000
         TM    GMFMFLGS,GM          GETMAIN REQUEST            @D64ADKH 09125000
         BZ    GMFM_FREE            NO, FREEMAIN               @D64ADKH 09126000
         L     RF,SVER0F            GET RETURN CODE            @D64ADKH 09127000
         LTR   RF,RF                EVERYTHING WORKED          @D64ADKH 09128000
         BNZ   GM_BAD_RC            NO                         @D64ADKH 09129000
         SPACE                                                          09130000
*     GET NEXT REQUEST IF IT IS A LIST REQUEST                          09131000
*SGLINK  OUTPUT,INPUT=(R8,RC,RD,RE:LINK,RF),                   @D64ADKH*09132000
               OUTPUT=(RF),                                    @D64ADKH*09133000
               NOMODR=(RA-RD)                                  @D64ADKH 09134000
         SGAMSUBR SUBROUT=IJBSSM2,                             @D64ADKH*09135000
               LINK=(FUNCTION,SM2OUT),                         @D64ADKH*09136000
               SUBROUC=GMFMENTR,                               @D64ADKH*09137000
               CBASE=OWN                                       @D64ADKH 09138000
         LTR   RF,RF                IS IT A LIST REQUEST       @D64ADKH 09139000
         BZ    GMFM_RETURN          NO, DONE                   @D64ADKH 09140000
         MVC   SVER0F,SVER03        GET OPTIONS FOR NEXT REQ.  @D64ADKH 09141000
         LA    RF,0                                            @D64ADKH 09142000
         B     GMFM_COMMON_9        PROCESS NEXT REQUEST       @D64ADKH 09143000
*                                                                       09144000
GM_BAD_RC  DS  0H                   EVALUATE RETURN CODE       @D64ADKH 09145000
*                                                                       09146000
.* POSSIBLE RETURN CODES                                                09147000
.* RETURN CODES FROM GETVIS PROCESSING                                  09148000
.* X'08' NEGATVIE LENGTH                                                09149000
.* X'0C' REQUEST EXCEEDS AREA OR NOT ENOUGH STORAGE AVAILABLE           09150000
.* X'20' PFIX FAILURE                                                   09151000
.* OTHER RETURN CODES                                                   09152000
.* X'1C' GETVIS FOR SPLE FAILED                                         09153000
.*       INVALID REQUEST AFTER ANALYZE                                  09154000
         LA    RF,12                                           @D64ADKH 09155000
         CL    RF,SVER0F            RETCODE <=12               @D64ADKH 09156000
         BNL   GM_CHECK_REQST       YES (SVER0F=8 OR X'0C')    @D64ADKH 09157000
         LA    RF,32                PFIX RETURN CODE           @D64ADKH 09158000
         CL    RF,SVER0F            PFIX FAILED                @D64ADKH 09159000
         BNE   GMFM_RETURN          NO, INVALID REQUEST        @D64ADKH 09160000
*                                                                       09161000
GM_CHECK_REQST  DS  0H              NOT ENOUGH GETVIS OR PFIX  @D64ADKH 09162000
*                                   FAILED                              09163000
         TM    GMFMFLGS,LIST        LIST REQUEST               @D64ADKH 09164000
         BZ    GM_CHECK_VAR         NO                         @D64ADKH 09165000
         LH    RF,GMFMSPNM+6        FIRST REQUEST FAILED AND.. @D64ADKH 09166000
         LTR   RF,RF                .. NO STORAGE ASSIGNED ..  @D64ADKH 09167000
         BZ    GMFM_RETURN          .. TO SUBPOOL              @D64ADKH 09168000
         MVC   SVER0E,SVER0F        SAVE RETURN CODE           @D64ADKH 09169000
         NI    SVER03+D3,X'FF'-GVSPID  RESET SUBPOOL REQUEST.. @D64ADKH 09170000
*                                   ..ONLY AREAS ARE FREED     @D64ADKH 09171000
GM_UNDO_LST  DS  0H                                            @D64ADKH 09172000
*SGLINK  FREELST,INPUT=(R8,RC,RD,RE:LINK,RF),                  @D64ADKH*09173000
               OUTPUT=(RF),                                    @D64ADKH*09174000
               NOMODR=(RA-RD)                                  @D64ADKH 09175000
         SGAMSUBR SUBROUT=IJBSSM2,                             @D64ADKH*09176000
               LINK=(FUNCTION,SM2FRE),                         @D64ADKH*09177000
               SUBROUC=GMFMENTR,                               @D64ADKH*09178000
               CBASE=OWN                                       @D64ADKH 09179000
         LTR   RF,RF                ALL LIST ELEMENTS FREED?   @D64ADKH 09180000
         BZ    GM_END_UNDO          YES                        @D64ADKH 09181000
         LA    RF,0                                            @D64ADKH 09182000
         MVC   SVER0F,SVER03        SET OPTIONS                @D64ADKH 09183000
*SGLINK  FREEVSM0,INPUT=(R6:LINK,RA,RC-RF),OUTPUT=(RF),        @D64ADKH*09184000
               NOMODR=(RA,RD)                                  @D64ADKH 09185000
         ST    RE,SVER08           SAVE BASE                   @D64ADKH 09186000
         L     RE,AMBASE                                       @D64ADKH 09187000
         BAL   R6,FREEVSM0-GETVIS(RE)                          @D64ADKH 09188000
         L     RE,SVER08           RESTORE BASE                @D64ADKH 09189000
         AIF   (NOT &BGDEBUG).UNDO_OK                          @D52VDMZ 09190000
         LTR   RF,RF              FREEVIS OK?                  @D52VDMZ 09191000
         BZ    GM_UNDO_LST        YES                          @D52VDMZ 09192000
         BAL   R5,SYSERROR        NO, SHOULD NOT OCCUR         @D52VDMZ 09193000
.UNDO_OK ANOP                                                  @D64ADKH 09194000
         B     GM_UNDO_LST                                     @D64ADKH 09195000
GM_END_UNDO  DS  0H                                            @D64ADKH 09196000
         MVC   SVER0F,SVER0E      RESTORE GETVIS RETURN CODE   @D64ADKH 09197000
         B     GMFM_RETURN                                     @D64ADKH 09198000
GM_CHECK_VAR  DS  0H                                           @D64ADKH 09199000
         TM    GMFMFLGS,VAR       VARIABLE REQUEST             @D64ADKH 09200000
         BZ    GMFM_RETURN        NO, DONE                     @D64ADKH 09201000
         LA    RF,12              FOR SVER0F<12 (I.E.=8, NEG.. @D64ADMZ 09202000
         CL    RF,SVER0F          LENGTH) DO NOT TRY MIN       @D64ADMZ 09203000
         BH    GMFM_RETURN        NEG. LENGTH                  @D64ADKH 09204000
* GETMIN PROVIDES MINIMUM REQUEST IN SVER00                             09205000
*SGLINK  GETMIN,INPUT=(R8,RC,RD,RE:LINK,RF),                   @D64ADKH*09206000
               OUTPUT=(RF),                                    @D64ADKH*09207000
               NOMODR=(RA-RD)                                  @D64ADKH 09208000
         SGAMSUBR SUBROUT=IJBSSM2,                             @D64ADKH*09209000
               LINK=(FUNCTION,SM2MIN),                         @D64ADKH*09210000
               SUBROUC=GMFMENTR,                               @D64ADKH*09211000
               CBASE=OWN                                       @D64ADKH 09212000
         LTR   RF,RF             MINIMUM REQUEST ALREADY DONE  @D64ADKH 09213000
         BNZ   GMFM_RETURN       YES, ALL DONE                 @D64ADKH 09214000
         LA    RF,32             PFIX RETURN CODE              @D64ADKH 09215000
         CL    RF,SVER0F         WAS IT PFIX FAILURE           @D64ADKH 09216000
* INSERT ONLY INSTRUCTIONS THAT DO NOT MODIFY CONDITION CODE            09217000
         MVC   SVER0F,SVER03     GET OPTIONS                   @D64ADKH 09218000
         LA    RF,0                                            @D64ADKH 09219000
         BE    GMFM_COMMON_9     TRY MIN REQUEST               @D64ADKH 09220000
         SPACE                                                          09221000
* NOT ENOUGH GETVIS AVAILABLE                                           09222000
         L     R0,SVER00         GET MINIMUM LENGTH            @D64ADMZ 09223000
         LTR   R0,R0             IS IT NEGATIVE                @D64ADMZ 09224000
         BNM   GM_CHECK_CONT     NO, CONTINUE                           09225000
         LA    RF,8              SET RETURN CODE ...           @D64ADMZ 09226000
         ST    RF,SVER0F         ... NEG. LENGTH               @D64ADMZ 09227000
         B     GMFM_RETURN                                     @D64ADMZ 09228000
GM_CHECK_CONT  DS   0H                                         @D64ADMZ 09229000
*   MAXGAP=MAX(MAXGAP,MAXGAP_BDY,MAXGAP_ABV)                            09230000
         SPACE                                                          09231000
         CLC   MAXGAP,MAXGAP_BDY   MAXGAP>=MAXGAP_BDY          @D64ADMZ 09232000
         BNL   GM_CHECK_VAR_0      YES                         @D64ADMZ 09233000
         MVC   MAXGAP,MAXGAP_BDY   MAXGAP=MAX(MAXGAP,MAXGAP_BDY@D64ADMZ 09234000
GM_CHECK_VAR_0 DS  0H                                          @D64ADMZ 09235000
         CLC   MAXGAP,MAXGAP_ABV   MAXGAP>=MAXGAP_ABV          @D64ADMZ 09236000
         BNL   GM_CHECK_VAR_05     YES                         @D64ADMZ 09237000
         MVC   MAXGAP,MAXGAP_ABV   MAXGAP=MAX(MAXGAP,MAXGAP_ABV@D64ADMZ 09238000
GM_CHECK_VAR_05 DS  0H                                         @D64ADMZ 09239000
         L     R0,MAXGAP           NO OF FREE PAGES ..         @D64ADMZ 09240000
         SLL   R0,PNSHIFT          .. * PAGESIZE               @D64ADMZ 09241000
         ST    R0,MAXGAP           MAX FREE SPACE IN BYTES     @D64ADMZ 09242000
         CLC   SVER00,MAXGAP       MIN > MAXGAP                @D64ADMZ 09243000
         BH    GM_CHECK_VAR_1      YES                         @D64ADMZ 09244000
* MIN <= MAXGAP, TRY MAXGAP REQUEST                                     09245000
         MVC   SVER00,MAXGAP       MAXGAP REQUEST MUST WORK    @D64ADMZ 09246000
         B     GMFM_COMMON_9       TRY MAXGAP REQUEST          @D64ADMZ 09247000
GM_CHECK_VAR_1 DS  0H                                          @D64ADMZ 09248000
* MAXGAP < MIN                                                          09249000
*  MAXIMUM FREE SPACE IS MAXGAP + 2 PAGES - 2 UNITS                     09250000
*   MIN <= MAXGAP + 2 PAGES - 2 UNITS => TRY MIN                        09251000
*   MIN >  MAXGAP + 2 PAGES - 2 UNITS => SET AS NOT FOUND               09252000
         LA    R0,VBYTBI           ALLOC. UNIT FOR PARTITION   @D64ADMZ 09253000
         LTR   RB,RB               PARTITION REQUEST           @D64ADMZ 09254000
         BZ    GM_CHECK_VAR_2      YES                         @D64ADMZ 09255000
         LA    R0,VBYTSV           ALLOC. UNIT FOR SVA/SPACE   @D64ADMZ 09256000
GM_CHECK_VAR_2 DS  0H                                          @D64ADMZ 09257000
         SLL   R0,2                2* ALLOCATION UNIT          @D64ADMZ 09258000
         L     R1,PAGESIZE                                     @D64ADMZ 09259000
         SLL   R1,2                2 * PAGESIZE                @D64ADMZ 09260000
         SR    R1,R0               2*PAGESIZE - 2*ALLOC UNIT   @D64ADMZ 09261000
         A     R1,MAXGAP                                       @D64ADMZ 09262000
         CL    R1,SVER00           MIN<=MAXGAP + 2 PAGES -     @D64ADMZ 09263000
*                                  2 * ALLOCATION UNIT         @D64ADMZ 09264000
         BNL   GMFM_COMMON_9       TRY MINIMUM                 @D64ADMZ 09265000
         LA    RF,12               SET RETURN CODE ..          @D64ADKH 09266000
         ST    RF,SVER0F           .. NO GETVIS AVAILABLE'     @D64ADKH 09267000
         B     GMFM_RETURN                                     @D64ADKH 09268000
GMFM_FREE  DS  0H                  FREEMAIN REQUEST            @D64ADKH 09269000
         L     RF,SVER0F           GET RC FROM FREEVIS         @D64ADKH 09270000
         LTR   RF,RF               FREEVIS WORKED              @D64ADKH 09271000
         BNZ   GMFM_RETURN         NO                          @D64ADKH 09272000
         TM    GMFMFLGS,SPREL      IS IT SUBPOOL RELEASE       @D64ADKH 09273000
         BO    FM_RELSP            YES                         @D64ADKH 09274000
*SGLINK  OUTPUT,INPUT=(R8,RC,RD,RE:LINK,RF),                   @D64ADKH*09275000
               OUTPUT=(RF),                                    @D64ADKH*09276000
               NOMODR=(RA-RD)                                  @D64ADKH 09277000
         SGAMSUBR SUBROUT=IJBSSM2,                             @D64ADKH*09278000
               LINK=(FUNCTION,SM2OUT),                         @D64ADKH*09279000
               SUBROUC=GMFMENTR,                               @D64ADKH*09280000
               CBASE=OWN                                       @D64ADKH 09281000
         LTR   RF,RF               LIST REQUEST                @D64ADKH 09282000
         BZ    GMFM_RETURN         NO                          @D64ADKH 09283000
         LA    RF,0                                            @D64ADKH 09284000
         MVC   SVER0F,SVER03       GET OPTIONS FOR NEXT LIST ELEMENT    09285000
*                                                              @D64ADKH 09286000
         B     GMFM_COMMON_4       FREEVIS NEXT AREA           @D64ADKH 09287000
FM_RELSP   DS  0H                  SUBPOOL RELEASE             @D64ADKH 09288000
*SGLINK  UPDATE,INPUT=(R8,RC-RF),                              @D64ADKH*09289000
               NOMODR=(RA-RD)                                  @D64ADKH 09290000
         SGAMSUBR SUBROUT=IJBSSM2,                             @D64ADKH*09291000
               LINK=(FUNCTION,SM2UPD),                         @D64ADKH*09292000
               SUBROUC=GMFMENTR,                               @D64ADKH*09293000
               CBASE=OWN                                       @D64ADKH 09294000
*SGLINK  LOCATE_NXT,INPUT=(R8,RC-RF),OUTPUT=(RF),              @D64ADKH*09295000
               NOMODR=(RA-RD)                                  @D64ADKH 09296000
         SGAMSUBR SUBROUT=IJBSSM2,                             @D64ADKH*09297000
               LINK=(FUNCTION,SM2NXT),                         @D64ADKH*09298000
               SUBROUC=GMFMENTR,                               @D64ADKH*09299000
               CBASE=OWN                                       @D64ADKH 09300000
         LTR   RF,RF                                           @D64ADKH 09301000
         BZ    GMFM_RETURN                                     @D64ADKH 09302000
         LA    RF,0                                            @D64ADKH 09303000
         MVC   SVER0F,SVER03                                   @D64ADKH 09304000
         B     GMFM_COMMON_4                                   @D64ADKH 09305000
*                                                                       09306000
GMFM_RETURN  DS  0H               REQUEST FAILED               @D64ADKH 09307000
*                                                                       09308000
         L     R5,SPIDSAV         SUBPOOL ...                  @D64ADKH 09309000
         LTR   R5,R5              .. ACTIVATED                 @D64ADKH 09310000
         BZ    GMFM_SUBPINT_OK    NO                           @D64ADKH 09311000
         USING SUBPINT,R5                                      @D64ADKH 09312000
         NI    SPITFLAG,X'FF'-SPCREATE                         @D64ADKH 09313000
         DROP  R5                                              @D64ADKH 09314000
         SPACE                                                          09315000
*  COPY SUBPOOL INDEX TABLE ENTRY FOR MVS SUBPOOL IN SPLE               09316000
*SGLINK  UPDATE,INPUT=(R8,RC-RF),                              @D64ADKH*09317000
               NOMODR=(R5,RA-RD,RF)                            @D64ADKH 09318000
         SGAMSUBR SUBROUT=IJBSSM2,                             @D64ADKH*09319000
               LINK=(FUNCTION,SM2UPD),                         @D64ADKH*09320000
               SUBROUC=GMFMENTR,                               @D64ADKH*09321000
               CBASE=OWN                                       @D64ADKH 09322000
         LA    R1,0                                            @D64ADKH 09323000
         LA    RF,0                                            @D64ADKH 09324000
*SGLINK  FVSBPOOL,INPUT=(R1,R5,R7:LINK,RA,RB,RC,RD,RF),OUTPUT=(RF),    *09325000
               NOMODR=(R6,RD),AMODE=31,NOMODS=(SAVR3RD8)                09326000
         SGAMSUBR SUBROUT=FVSBPOOL,                            @D64ADKH*09327000
               INPUT=(R1,R5,RA,RB,RC,RD,RE,RF),                @D64ADMZ*09328000
               NOMOD=(R6,RD),                                  @D64ADKH*09329000
               LINK=(R7),                                      @D64ADKH*09330000
               NOMODS=(SAVR3RD8),                              @D64ADKH*09331000
               CBASE=OWN,         INITIALIZE GETVIS AREA       @D64ADKH*09332000
               SUBROUC=GMFMENTR                                @D64ADKH 09333000
GMFM_SUBPINT_OK  DS  0H                                        @D64ADKH 09334000
         L     R0,SVER02       GET TYPE OR REQUEST             @D64ADKH 09335000
         L     R1,SVER0F       GET RETURN CODE                 @D64ADKH 09336000
         L     R6,SVER05       GET RETURN ADDRESS              @D64ADKH 09337000
         L     RD,SVER04       RD = ADDR(USER SAVE AREA)       @D64ADKH 09338000
         SPACE                                                          09339000
GMFM_MAPRC DS  0H                                              @D64ADKH 09340000
         SPACE                                                          09341000
*SGLINK  MAPRC,INPUT=(R0,R1,R8:LINK,RC-RF),OUTPUT=(R3,RF),     @D64ADKH*09342000
               NOMODR=(R6,RA-RD)                               @D64ADKH 09343000
         SGAMSUBR SUBROUT=IJBSSM2,                             @D64ADKH*09344000
               LINK=(FUNCTION,SM2MAP),                         @D64ADKH*09345000
               SUBROUC=GMFMENTR,                               @D64ADKH*09346000
               CBASE=OWN                                       @D64ADKH 09347000
         LTR   RC,RC              NO GATE CLOSED UP TO NOW     @D64ADKH 09348000
         BZ    GMFM_DONE          YES                          @D64ADKH 09349000
         TM    GMFMFLGS,PFIXPEND  GETMAIN WITH PFIX            @D64ADKH 09350000
         BZ    GMFM_OPEN_GATE     NO, CONSIDER ONLY GET. GATE  @D64ADKH 09351000
         LR    R0,R6              REGISTERS ARE DESTROYED..    @D64ADKH 09352000
         LR    R1,RF              REGISTERS ARE DESTROYED..    @D64ADKH 09353000
         LR    R2,RE              REGISTERS ARE DESTROYED..    @D64ADKH 09354000
         L     R6,DISPAD                                       @D64ADKH 09355000
         L     R5,ASRQTAB         OPEN PFIX GATE               @D61RDKH 09356000
         LA    R5,SRQSPFIX-SRQTAB(,R5) PTR TO RSRCE DESCRIPTOR @D61RDKH 09357000
         USING DISP,R6                                         @D64ADKH 09358000
         BAL   RF,RPOST           POST ALL WAITERS             @D64ADKH 09359000
*SGLINK  RPOST,INPUT=(R5,R6,RF),WORK=(R5,RE)                   @D64ADKH 09360000
         DROP  R6                 RELEASE DISP BASE            @D64ADKH 09361000
         LR    RE,R2              RESTORE BASE                 @D64ADKH 09362000
         LR    R6,R0              RESTORE ..                   @D64ADKH 09363000
         LR    RF,R1              RESTORE ..                   @D64ADKH 09364000
GMFM_OPEN_GATE  DS  0H            OPEN GETVIS GATE             @D64ADKH 09365000
         LA    R5,0                                            @D64ADKH 09366000
         ST    R5,GMFMFLGS                                     @D64ADKH 09367000
         STH   R5,GMFMSPNM+6                                   @D64ADKH 09368000
         L     R5,GVFVGATE        GET GETVIS GATE              @D64ADKH 09369000
         LTR   R5,R5              IS GATE TO BE OPENED         @D64ADKH 09370000
         BNM   GMFM_DONE          NO                           @D64ADKH 09371000
         LA    R5,0(R5)           CLEAR 'OPEN GATE' INDICATION @D64ADKH 09372000
         ST    R5,GVFVGATE        ?????????                    @D64ADKH 09373000
         LR    R0,R6              REGISTERS ARE DESTROYED..    @D64ADKH 09374000
         LR    R1,RF              REGISTERS ARE DESTROYED..    @D64ADKH 09375000
         LR    R2,RE              REGISTERS ARE DESTROYED..    @D64ADKH 09376000
         L     R6,DISPAD                                       @D64ADKH 09377000
         USING DISP,R6                                         @D64ADKH 09378000
         BAL   RF,RPOST           POST ALL WAITERS             @D64ADKH 09379000
*SGLINK  RPOST,INPUT=(R5,R6,RF),WORK=(R5,RE)                   @D64ADKH 09380000
         DROP  R6                 RELEASE DISP BASE            @D64ADKH 09381000
         LR    RE,R2              RESTORE BASE                 @D64ADKH 09382000
         LR    R6,R0              RESTORE ..                   @D64ADKH 09383000
         LR    RF,R1              RESTORE ..                   @D64ADKH 09384000
         TM    TCBGRFLG,TCBSETLR  SETLOCK RELEASE TO BE DONE   @D67FDMZ 09385000
         BZ    GMFM_DONE          NO                           @D67FDMZ 09386000
         NI    TCBGRFLG,X'FF'-TCBSETLR RESET LOCK INDICATION   @D67FDMZ 09387000
         LR    R0,RF              SAVE GETMAIN/FREEMAIN RETC   @D67FDMZ 09388000
         LR    R1,RD              SAVE SAVE AREA ADDRESS       @D67FDMZ 09389000
         L     R2,TCBATCBE        GET TCB EXTENSION            @D67FDMZ 09390000
         TM    TCBXSAUS-TCBXADR(R2),TCBXXSAU   SAVE AREA USED  @D67FDMZ 09391000
         BZ    GMFM_DONE1         NO, TAKE IT                  @D67FDMZ 09392000
         BAL   R5,SYSERROR        YES, MUST NOT OCCUR          @D67FDMZ 09393000
GMFM_DONE1 DS  0H                                              @D67FDMZ 09394000
         OI    TCBXSAUS-TCBXADR(R2),TCBXXSAU SAVE AREA IN USE  @D67FDMZ 09395000
         LA    RD,TCBXXSA-TCBXADR(,R2)   GET SAVE AREA ADDR    @D67FDMZ 09396000
*        SETLOCK RELEASE,TYPE=LOCAL,REGS=SAVE                  @D67FDMZ 09397000
         SETLOCK RELEASE,TYPE=LOCAL,REGS=SAVE                  @D67FDMZ 09398000
         NI    TCBXSAUS-TCBXADR(R2),X'FF'-TCBXXSAU FREE        @D67FDMZ 09399000
         LR    RD,R1              GET ORIGINAL SAVE AREA ADDR  @D67FDMZ 09400000
         LR    R2,RF              SAVE SETLOCK RETURN CODE     @D67FDMZ 09401000
         LR    RF,R0              GET ORIGINAL RETURN CODE     @D67FDMZ 09402000
         LTR   R2,R2              SETLOCK SUCCESSFUL?          @D67FDMZ 09403000
         BZ    GMFM_DONE          YES                          @D67FDMZ 09404000
         BAL   R5,SYSERROR        NO, MUST NOT OCCUR           @D67FDMZ 09405000
GMFM_DONE  DS  0H                                              @D64ADKH 09406000
         LTR   RF,RF              CALLER TO BE ABENDED         @D64ADKH 09407000
         BNZ   GMFM_ABEND         YES                          @D64ADKH 09408000
* RF = 0 : CASE A) NO ERROR OCCURED                                     09409000
*          CASE B) CONDITIONAL REQUEST AND ERROR ALREADY STORED         09410000
*          IN USER'S SVER0F                                             09411000
* R3 : OFFSET IN GMFM_MACNAMES TO FAILING MACRO NAME. SET BY MAPRC      09412000
         CLM   R6,M7,DISPAD+D1                                 @D64ADKH 09413000
         USING DISP,R6                                         @D64ADKH 09414000
         BE    DISPMVS            GOTO DISP FOR MVS SERVICES   @D64ADKH 09415000
         DROP  R6                                              @D64ADKH 09416000
*        AMODESW  RETURN,REG=(R6)                              @D64ADKH 09417000
         AMODESW  RETURN,REG=(R6)                              @D64ADKH 09418000
GMFM_ABEND  DS  0H                ABEND CALLER                 @D64ADKH 09419000
         LA    R2,0(,R6)          CLEAR MODE BIT IN RET. ADDR  @D64ADMZ 09420000
         CL    R2,ALOADRET        IF CALLED BY LOAD THEN DO NOT@D64ADMZ 09421000
         BNE   GMFM_ABEND_1       CANCEL, CANCEL DONE BY LOAD  @D64ADMZ 09422000
         ST    RF,SVER0F          PASS RETURN CODE TO LOAD     @D64ADMZ 09423000
*        AMODESW  RETURN,REG=(R6)                              @D64ADKH 09424000
         AMODESW  RETURN,REG=(R6)                              @D64ADKH 09425000
GMFM_ABEND_1 DS 0H                                             @D64ADMZ 09426000
         L     R2,TCBATCBE        GET ADDR OF TCB EXTENSION    @D64ADMZ 09427000
         USING TCBXADR,R2                                      @D64ADMZ 09428000
         TM    TCBXSAUS,TCBXXSAU  SAVE AREA USED               @D64ADMZ 09429000
         BZ    GMFM_ABEND_0       NO, TAKE IT                  @D64ADMZ 09430000
         BAL   R5,SYSERROR        YES, MUST NOT OCCUR          @D64ADMZ 09431000
GMFM_ABEND_0 DS 0H                                             @D64ADMZ 09432000
         OI    TCBXSAUS,TCBXXSAU  SAVE AREA IS USED            @D64ADMZ 09433000
         XC    TCBXXSA,TCBXXSA    CLEAR WORK AREA              @D64ADMZ 09434000
         LA    R1,TCBXXSA         POINT TO ERROR MSG TEXT      @D64ADOW 09435000
         O     R1,BIT0OMSK        ... INDICATE AREA IN TCBX    @D64ADOW 09436000
         USING MAPDMPIF,R1                                     @D64ADOW 09437000
         LA    R0,L'CANC48FX+8    GET LENGTH OF ADDITIONAL INFO@D64ADOW 09438000
         O     R0,BIT0OMSK        ... INDICATE AREA IN TCBX    @D64ADOW 09439000
         ST    R0,CANC48LN        ... TO MSG AREA              @D64ADOW 09440000
         STH   RF,CANC48RC+2      STORE REASON CODE            @D64ADKH 09441000
         SRL   RF,16              REMOVE REASON CODE           @DY44889 09442000
         SLL   RF,12              00XXX000 SYSTEM COMPL. CODE  @DY44889 09443000
         ST    RF,CANC48AB        IN CORRECT POSITION          @DY44889 09444000
         AR    RE,R3              ADD OFFSET TO FAILING MACRO  @D64ADKH 09445000
         MVC   CANC48MN(8),GMFM_MACNAMES  MACRO NAME           @D64ADKH 09446000
         OI    CANC48FL,C48VALRS+C48VALMC INDICATE REASON CODE AND ..  *09447000
                                  MACRO NAME PROVIDED          @D64ADMZ 09448000
         SPACE                                                          09449000
         DROP  R1                 RELEASE MAPDMPIF             @D64ADKH 09450000
         DROP  R2                 RELEASE TCBXADR              @D64ADMZ 09451000
         L     R6,DISPAD                                       @D64ADKH 09452000
         USING DISP,R6                                         @D64ADKH 09453000
         L     R6,ADISPSER        BASE OF DISPSERV             @D64ADKH 09454000
         LA    RB,ERR48E          CANCEL EXIT NUMBER           @D64ADKH 09455000
         LA    R0,4(,0)           FUNCTION CODE FOR CANCEL     @D64ADKH 09456000
         SPACE                                                          09457000
         BASSM R7,R6               =========> CANCEL           @D64ADKH 09458000
         DROP  R6                                              @D64ADKH 09459000
STORAGE_PR  DS  0H                                             @D64ADKH 09460000
         L     R6,DISPAD                                       @D64ADKH 09461000
         USING DISP,R6                                         @D64ADKH 09462000
         L     R6,ADISPSER        BASE OF DISPSERV             @D64ADKH 09463000
         DROP  R6                                              @D64ADKH 09464000
         MVC   ERARF(3*4),SVER0F                               @D64ADKH 09465000
         LA    R0,12(,0)          FUNCTION CODE FOR CANCEL     @D64ADKH 09466000
         LA    R1,0                                            @D64ADKH 09467000
*        AMODESW CALL,REGS=(R7,R6)                             @D64ADKH 09468000
         AMODESW CALL,REGS=(R7,R6) =========> GET USER STATE   @D64ADKH 09469000
GMSPLEOPTS  DS  0F        OPTIONS FOR SPLE REQUEST             @D64ADKH 09470000
         DC    X'00'                                           @D64ADKH 09471000
         DC    X'00'                                           @D64ADKH 09472000
         DC    X'20'      SPACE=YES                            @D64ADKH 09473000
         DC    X'04'      SVA=YES                              @D64ADKH 09474000
GMFM_MACNAMES  DS   0H                                         @D64ADKH 09475000
         DC    CL8'GETMAIN'                                    @D64ADKH 09476000
         DC    CL8'FREEMAIN'                                   @D64ADKH 09477000
         DC    CL8'STORAGE'                                    @D64ADKH 09478000
ALOADRET DC    A(XLODGM_RET)      RET.ADDR WHEN CALLED DUR.LOAD@D64ADMZ 09479000
         DROP  RA,RD,RE,RC                                     @D64ADKH 09480000
         EJECT                                                 @D14CDJB 09481000
************************************************************** @D379DFG 09482000
*                                                            * @D379DFG 09483000
*  INTERNAL ROUTINES FOR SYSTEM GETVIS/FREEVIS               * @D379DFG 09484000
*   THESE ROUTINES MAY BE ENTERED IN BOTH 24 AND 31 BIT AMODE* @D52VDMZ 09485000
*   THEY CALL THE GETVIS/FREEVIS MAIN ROUTINES WHICH ARE     * @D52VDMZ 09486000
*   EXECUTING IN AMODE 31. THEREFORE THE FOLLOWING LINKAGE   * @D52VDMZ 09487000
*   CONVENTION HAS TO BE USED:                               * @D52VDMZ 09488000
*     AMODESW CALL,ADDRESS=GETVISMR/FREEVISMR,REGS=(R6)      * @D52VDMZ 09489000
*   THE GETVIS/FREEVIS MAIN ROUTINES WILL RETURN WITH        * @D52VDMZ 09490000
*     AMODESW RETURN,REG=(R6)                                * @D52VDMZ 09491000
*   REQUESTS CAN BE DONE FOR SVA, SPACE OR PMR SPACE.        * @D52VDMZ 09492000
*   SPECIAL HANDLING IS DONE FOR PMR SPACE:                  * @D52VDMZ 09493000
*   A) NO GATING NECESSARY (IS CALLED BY GATED SERVICE)      * @D52VDMZ 09494000
*   B) FOR THE PMR SPACE ONLY THE SCB EXISTS. THEREFORE ALL  * @D52VDMZ 09495000
*      SERVICES THAT REQUIRE OTHER CONTROL BLOCKS (E.G       * @D52VDMZ 09496000
*      LOC=RES HANDLING IN TCB) ARE NOT ALLOWED.             * @D52VDMZ 09497000
*                                                            * @D379DFG 09498000
************************************************************** @D379DFG 09499000
         SPACE 1                                               @D37CDFG 09500000
         USING SGETVIS,RE                                      @D67FDMZ 09501000
         USING SVEARA,RD                                       @D51IDKH 09502000
         USING TCBADR,RA                                       @D67FDMZ 09503000
SGETVIS  DS    0H                 ENTRY POINT FOR INTERN. CALL @D14CDJB 09504000
*SGLINK  SGETVIS,S                                                      09505000
         L     RE,ASGETVIS        GET BASE REGISTER            @D67FDMZ 09506000
         L     R2,SVER00          RESET 'NO PAGE BDY CROSSING..@D52VDMZ 09507000
         C     R2,PAGESIZE        ..ALLOWED' FOR  ..           @D52VDMZ 09508000
         BNH   SGETVIS0           ... REQUESTS > PAGESIZE      @D52VDMZ 09509000
         NI    SVER0F+D3,XFF-SGVNPGX                           @D52VDMZ 09510000
SGETVIS0 DS    0H                                              @D52VDMZ 09511000
         LA    R3,GETVISID        SET GETVIS INDICATOR         @D51IDKH 09512000
         BAL   R2,SVISINIT        SET GATE AND INIT REGISTERS  @D14CDJB 09513000
         LA    RF,0                                            @D64ADKH 09514000
         LTR   RC,RC             GETVIS AREA ALREADY AVAILABLE @D64ADKH 09515000
         BZ    SGETVIS1          NO. MIGHT BE SET DURING GTVSINIT. NO   09516000
*                                SPECIAL RLOCK HANDLING THEN   @D61ADMZ 09517000
         USING ANCHTAB,RC                                      @D64ADKH 09518000
         OI    GVFVFLGS,GVFVBR   BRANCH ENTRY, NEEDED F. PFIX  @D64ADKH 09519000
         DROP  RC                                              @D64ADKH 09520000
SGETVIS1 DS    0H                                                       09521000
         L     RE,AGETVMR        ENTRY POINT                   @D67FDMZ 09522000
*SGLINK  GETVISMR,INPUT=(R6:LINK,RA,RC-RF),OUTPUT=(RF),                *09523000
               NOMODR=(RA)                                              09524000
*        BASSM R6,RE                                           @D67FDMZ 09525000
         BASSM R6,RE                                           @D67FDMZ 09526000
         L     RE,ASGETVIS       RELOAD OWN BASE               @D67FDMZ 09527000
         B     SVISRETN           EXIT ROUTINE                 @D37CDFG 09528000
         SPACE 1                                               @D37CDFG 09529000
SFREEVIS DS    0H                 ENTRY POINT FOR INTERN. CALL @D14CDJB 09530000
         L     RE,ASGETVIS        GET BASE REGISTER            @D67FDMZ 09531000
         LA    R3,FREEVSID        SET FREEVIS INDICATOR        @D51IDKH 09532000
         BAL   R2,SVISINIT        GATE AND INIT REGISTERS      @D37CDFG 09533000
         LA    RF,0                                            @D64ADKH 09534000
         LTR   RC,RC              GETVIS AREA AVAILABLE        @D64ADKH 09535000
         BZ    SFREEVS1           NO. RETCODE SET IN FREEVSMR  @D64ADKH 09536000
         USING ANCHTAB,RC                                      @D64ADKH 09537000
         OI    GVFVFLGS,GVFVBR    BRANCH ENTRY, NEEDED F. PFIX @D64ADKH 09538000
SFREEVS1 DS    0H                                              @D64ADKH 09539000
         L     RE,AFREVMR        ENTRY POINT                   @D67FDMZ 09540000
*SGLINK  FREEVSMR,INPUT=(R6:LINK,RA,RC-RF),OUTPUT=(RF),                *09541000
               NOMODR=(RA)                                              09542000
*        BASSM R6,RE                                           @D67FDMZ 09543000
         BASSM R6,RE                                           @D67FDMZ 09544000
         L     RE,ASGETVIS       RELOAD OWN BASE               @D67FDMZ 09545000
         SPACE 1                                               @D37CDFG 09546000
SVISRETN DS    0H                                              @D37CDFG 09547000
         NI    GVFVFLGS,X'FF'-GVFVBR   RESET BRANCH ENTRY      @D64ADKH 09548000
         DROP  RC                                              @D64ADKH 09549000
         TM    TCBGRFLG,TCBGPMSP  PAGE MANAGER SPACE REQUEST   @D52VDMZ 09550000
         BZ    SVISRET0           NO                           @D52VDMZ 09551000
         L     R7,SVISRTPS        RESTORE RETURN ADDRESS       @D52VDMZ 09552000
         B     SVISRETX           GOTO EXIT PROCESSING         @D52VDMZ 09553000
SVISRET0 L     R6,DISPAD          RESTORE DISPATCHER ADDRESS   @D37CDFG 09554000
         USING DISP,R6                                         @D14CDJB 09555000
         TM    TCBGRFLG,TCBGSPCE  SPACE REQUEST                @D52VDMZ 09556000
         BZ    SVISRET1           NO, MUST BE SVA OR SVAPFIX   @D52VDMZ 09557000
         L     R5,PIBPTR2         GET PIB2 PTR                 @D51IDMZ 09558000
         USING PIB2ADR,R5                                      @D51IDMZ 09559000
         L     R5,PIBPCB                                       @D51IDKH 09560000
         USING PCBADR,R5                                       @D51IDKH 09561000
         L     R7,PCBSGRAD        LOAD RETURN ADDRESS          @D51IDMZ 09562000
         B     SVISRETX                                        @D51IDKH 09563000
         DROP  R5                                              @D51IDKH 09564000
SVISRET1 DS    0H                                              @D51IDKH 09565000
         L     R7,SVISRETA        GET RETURN ADDR FOR SVA REQ. @D52VDMZ 09566000
         TM    TCBGRFLG,TCBGSVA                                @D52VDMZ 09567000
         BO    SVISRETX                                        @D64ADKH 09568000
         L     R7,SVISRETP                                     @D51IDMZ 09569000
***************************************************************         09570000
*  COMMON EXIT PROCESSING                                     *         09571000
***************************************************************         09572000
SVISRETX DS    0H                                              @D52VDMZ 09573000
         MVI   TCBGRFLG,X00       CLEAR REQUEST BYTE           @D52VDMZ 09574000
         AMODESW RETURN,REG=(R7)  RETURN TO CALLER, SWITCH ... @D64ADKH 09575000
         DROP  R6                                              @D14CDJB 09576000
         SPACE 2                                               @D14CDJB 09577000
***************************************************************@D149DJB 09578000
*                                                             *@D149DJB 09579000
*  COMMON SUBROUTINE FOR INTERNAL GETVIS/FREEVIS              *@D149DJB 09580000
*                                                             *@D149DJB 09581000
***************************************************************@D149DJB 09582000
         SPACE 2                                               @D14CDJB 09583000
SVISINIT DS    0H                                              @D51IDKH 09584000
         L     RA,TCBPTR          GET CURRENT TCB POINTER      @D52VDMZ 09585000
***************************************************************@D52VDMZ 09586000
*  CLEAR FIRST BYTE/BIT OF THE RETURN ADDRESS DEPENDING ON THE*@D52VDMZ 09587000
*  THE CALLER'S AMODE. THE RETURN ADDRESS IS USED LATERON TO  *@D52VDMZ 09588000
*  DETERMINE THE LOCATION (RMODE) OF THE CALLER(NOT PMR SPACE)*@D52VDMZ 09589000
***************************************************************@D52VDMZ 09590000
         LA    R7,0(,R7)          CORRECT RETURN ADDRESSS      @D52VDMZ 09591000
         LR    RB,R1              SAVE R1                      @D52VDMZ 09592000
*        AMODESW QRY              GET CALLER'S AMODE           @D52VDMZ 09593000
         AMODESW QRY              GET CALLER'S AMODE           @D52VDMZ 09594000
         LTR   R1,R1              AMODE 24 ?                   @D52VDMZ 09595000
         BZ    SVISIN05           YES                          @D52VDMZ 09596000
         OI    TCBIEXFL,TCBIEXAM  INDICATE AMODE 31            @D52VDMZ 09597000
         O     R7,BIT0OMSK        REMEMBER AMODE               @D64ADKH 09598000
SVISIN05 DS    0H                                              @D52VDMZ 09599000
         LR    R1,RB              RESTORE R1                   @D52VDMZ 09600000
         CLM   R7,7,ADDRMSK+1     RETURN ADDRESS BELOW 16 MB   @D52VDMZ 09601000
         BNH   SVISIN08           YES                          @D52VDMZ 09602000
         OI    TCBIEXFL,TCBIEXRM  INDICATE RMODE 31            @D52VDMZ 09603000
SVISIN08 DS    0H                 RMODE 24                     @D52VDMZ 09604000
.* SAME OPTION FOR GETVIS AND FREEVIS                                   09605000
         TM    SVER0F+D2,GVFVPMSP PMR SPACE REQUEST            @D52VDMZ 09606000
         BO    SVISIN85           YES,SKIP MOST OF OTHER PROC. @D52VDMZ 09607000
         LA    R2,0(R2)           CLEAR HIGH ORDER BYTE/BIT..  @D64ADKH 09608000
*                                 OF RETURN ADDR BECAUSE SWITCH@D64ADKH 09609000
*        AMODESW SET,AMODE=31,WR=(RB)  SWITCH TO AMODE 31      @D64ADKH 09610000
         AMODESW SET,AMODE=31,WR=(RB)                          @D64ADKH 09611000
         LA    RB,FREEVSID        FREEVIS INDICATOR            @D51IDMZ 09612000
         CLR   R3,RB              IS IT FREEVIS REQUEST        @D51IDMZ 09613000
         BE    SVISIN07           YES, CHECK ONLY GETVIS GATE  @D64ADKH 09614000
.* DISTINCTION BETWEEN GETVIS AND FREEVIS NECESSARY, BECAUSE GVPFIX AND 09615000
.* FREEVIS ROUTED SET THE SAME OPTION                                   09616000
         LA    R5,0               RUN AS GETVIS                @D64ADMZ 09617000
         TM    SVER0F+D3,GVPFIX   GETVIS PFIX REQUEST ?        @D64ADKH 09618000
         BZ    SVISIN09_1         NO                           @D64ADKH 09619000
         L     RB,SVER00          GET LENGTH OF REQUEST        @D64ADMZ 09620000
         LTR   RB,RB              LENGTH > 0                   @D64ADMZ 09621000
         BP    SVISIN09_1         YES                          @D64ADMZ 09622000
         NI    SVER0F+D3,X'FF'-GVPFIX RESET PFIX INDICATION    @D52VDMZ 09623000
         B     SVISIN09_1          DO GATING                   @D64ADMZ 09624000
SVISIN07 DS    0H                 FREEVIS REQUEST              @D64ADKH 09625000
         LA    R5,0                RUN AS FREEVIS              @D64ADMZ 09626000
         TM    SVER0F+D1,FVROUTED  ROUTED REQUEST              @D64ADMZ 09627000
         BZ    SVISIN09_1          NO                                   09628000
         LA    R5,1                RUN AS FREEMAIN             @D64ADMZ 09629000
         SPACE                                                          09630000
* SFREEVIS ROUTED MUST RUN AS FREEMAIN REQUEST (R5=1)                   09631000
* REASON: DURING FREEVIS ROUTED PROCESSING, THE INTERNAL SAVE AREA      09632000
* GMFMWRK1 IS USED. THIS AREA IS ALSO USED BY GETMAIN/FREEMAIN          09633000
* PROCESSING. IN CASE THE GETVIS GATE IS OPENED DURING PFIX OF A        09634000
* GETMAIN REQUEST ANOTHER TASK MIGHT OBTAIN THE SYSTEM GETVIS GATE      09635000
* DURING SFREEVIS ROUTED PROCESSING AND DESTROY THE WORK AREA THEN.     09636000
* THIS CAN NOT HAPPEN IF THE ROUTED REQUEST RUNS AS FREEMAIN, SINCE     09637000
* ONLY ONE GETMAIN/FREEMAIN AT A TIME IS ALLOWED. SO THE ROUTED         09638000
* REQUEST WOULD NOT GET THE GATE.                                       09639000
         SPACE                                                          09640000
SVISIN09_1 DS  0H                                              @D64ADMZ 09641000
         LA    R9,0                                            @D64ADKH 09642000
*SGLINK  GVFVGATING,INPUT=(R5,R8:LINK,R9,RA,RD),OUTPUT=(RC),           *09643000
               AMODE=31,NOMODR=(R0-R3,R6,R7,RA,RD,RF)                   09644000
         SGAMSUBR SUBROUT=GVFVGATS,                            @D64ADKH*09645000
               INPUT=(R5,R9,RA,RD),                            @D64ADMZ*09646000
               NOMOD=(R0,R1,R2,R3,R6,R7,RA,RD,RE,RF),          @D64ADKH*09647000
               OUTPUT=(R9,RC),                                 @D64ADMZ*09648000
               LINK=(R8),         SET STORAGE KEY TO ZERO      @D64ADKH*09649000
               CBASE=OWN,                                      @D67FDMZ*09650000
               SUBROUC=SGETSFR                                 @D67FDMZ 09651000
         TM    SVER0F+D3,SVAIND    SVA REQUEST ?               @D64ADKH 09652000
         BO    SVISIN10           YES                          @D64ADKH 09653000
         L     RB,PIBPTR2                                      @D51IDKH 09654000
         USING PIB2ADR,RB                                      @D51IDKH 09655000
         L     RB,PIBPCB                                       @D51IDMZ 09656000
         OI    TCBGRFLG,TCBGSPCE  INDICATE SPACE REQUEST       @D52VDMZ 09657000
         USING PCBADR,RB                                       @D64ADKH 09658000
         ST    R7,PCBSGRAD        SAVE RETURN ADDRESS          @D51IDMZ 09659000
         DROP  RB                                              @D64ADKH 09660000
         B     SVISIN90                                        @D64ADKH 09661000
SVISIN10 DS    0H                                              @D51IDKH 09662000
.* AGAIN DISTINCTION BETWEEN GETVIS AND FREEVIS NECESSARY               09663000
         LA    RB,FREEVSID        FREEVIS INDICATOR            @D64ADMZ 09664000
         CLR   R3,RB              IS IT FREEVIS REQUEST        @D64ADMZ 09665000
         BE    SVISIN10_1         YES                          @D64ADMZ 09666000
         TM    SVER0F+D3,GVPFIX   GETVIS PFIX REQUEST          @D64ADKH 09667000
         BO    SVISIN11           YES                          @D64ADKH 09668000
SVISIN10_1 DS  0H                                              @D64ADMZ 09669000
         OI    TCBGRFLG,TCBGSVA   INDICATE SVA REQUEST         @D52VDMZ 09670000
         ST    R7,SVISRETA        SAVE RETURN ADDRESS          @D51IDMZ 09671000
         B     SVISIN90           COMMON PATH FOR SPACE/SVA    @D51IDMZ 09672000
SVISIN11 DS    0H                                              @D64ADKH 09673000
         OI    TCBGRFLG,TCBGSVAP  INDICATE PFIX REQUEST        @D64ADKH 09674000
         ST    R7,SVISRETP        SAVE RETURN ADDRESS          @D64ADKH 09675000
         B     SVISIN90                                        @D64ADKH 09676000
*******************************************************************     09677000
*  COMMON SUBROUTINE FOR INTERNAL GETVIS/FREEVIS PMR SPACE REQUEST*     09678000
*******************************************************************     09679000
SVISIN85 DS    0H                                              @D52VDMZ 09680000
         LA    RC,0                                            @D64ADKH 09681000
         ST    R7,SVISRTPS        SAVE RETURN ADDRESS          @D52VDMZ 09682000
         OI    TCBGRFLG,TCBGPMSP  INDICATE PMR SPACE REQUEST   @D52VDMZ 09683000
***************************************************************         09684000
*  COMMON EXIT FOR ALL REQUESTS                               *         09685000
***************************************************************         09686000
SVISIN90 DS    0H                                              @D51IDMZ 09687000
         STC   R3,GFDBGINF        STORE REQUEST INDICATOR      @D51IDMZ 09688000
         STM   RF,R1,GFDBGINF+D4  STORE INPUT REGISTERS        @D51IDMZ 09689000
         ST    R7,GFDBGIN1        STORE RETURN ADDRESS         @D64ADMZ 09690000
         DEBUG USERDATA,XXDBGMC,GFDBGINF,GFDBGIN1              @D64ADMZ 09691000
         BR    R2                 RETURN                       @D37CDFG 09692000
         SPACE 1                                               @D51IDMZ 09693000
AGETVMR  DC    A(GETVISMR+X'80000000') ENTRY OF GETVIS ROUT.   @D67FDMZ 09694000
AFREVMR  DC    A(FREEVSMR+X'80000000') ENTRY OF FREEVIS ROUT.  @D67FDMZ 09695000
SVISRETA DC    F'0'               SAVED RETURN ADDRESS         @D37CDFG 09696000
SVISRETP DC    F'0'               SAVED RETURN ADDR FOR PFIX   @D51IDMZ 09697000
SVISRTPS DC    F'0'               SAVED RET. ADDR FOR PMR SP.  @D52VDMZ 09698000
GFDBGINF DC    CL16'XVIS'         AREA FOR DEBUG INFORMATION   @D14ZDJB 09699000
GFDBGIN1 DC    XL16'00'           AREA FOR DEBUG INFORMATION   @D64ADMZ 09700000
         DROP  RA                 RELEASE TCB                  @D67FDMZ 09701000
         DROP  RD                                              @D51IDKH 09702000
         DROP  RE                 RELEASE BASE                 @D67FDMZ 09703000
         SPACE 2                                               @D14CDJB 09704000
***************************************************************         09705000
*                                                                       09706000
*  DISCARD_MVS                                                          09707000
*                                                                       09708000
*     SUBROUTINE TO DISCARD THE MVS SUBPOOLS                            09709000
*                                                                       09710000
*        CALLED BY FVROUTED AND FVALL                                   09711000
*                                                                       09712000
*        INPUT                                                          09713000
*            R2 = BEGIN ADDR OF SPLE CHAIN                              09714000
*                 ADDR(TCBSPL) OR ADDR(TCBSPL)                          09715000
*            RC = PTR TO CI                                             09716000
*            GMFMFLG2.LSQA  FREEVIS LSQA (SPACE) SUBPOOLS AND           09717000
*                           CORRESPONDING SPLES                         09718000
*                           (IN SVA FOR STATIC PARTITIONS)              09719000
*                           FREEVIS SPLES IN SPACE GETVIS               09720000
*                           (IN SVA FOR STATIC PARTITIONS)              09721000
*            GMFMFLG2.LSQA NOT SET                                      09722000
*              GMFMFLG2.FSPLE SET                                       09723000
*                 REMOVE SPLES IN PARTITION GETVIS CI FROM SPL          09724000
*              GMFMFLG2.FSPLE NOT SET                                   09725000
*                           FREEVIS TASK RELATED PRIVATE STORAGE        09726000
*                           (PARTITION SUBPOOLS)                        09727000
*                           FREEVIS TASK RELATED LSQA STORAGE           09728000
*                           (LSQA SUBPOOLS)                             09729000
*                           FREEVIS TASK RELATED SPLES IN LSQA          09730000
*                           (ONLY NECESSARY IF PART.CI AND/OF SPACE.CI  09731000
*                            NOT SUFFICIENT FOR SPLES)                  09732000
*            SVER0F.GVFVSPIN  SPACE GATE ALREADY CLOSED                 09733000
*                             (SYSTEM GETVIS FOR STATIC PARTITION)      09734000
*                             AND SPACE (SVA) CI SET UP CORRECTLY       09735000
*        OUTPUT                                                         09736000
*            NONE                                                       09737000
*                                                                       09738000
*        WORK                                                           09739000
*            R3,R4                                                      09740000
*                                                                       09741000
***************************************************************         09742000
         AGO    .CREATE_03                                     @D64ADKH 09743000
.FVDISCRD ANOP                                                 @D64ADKH 09744000
.*             0123456789ABCDEF                                @D149DJB 09745000
&INPREG  SETC '0010000000000000'                               @D64ADKH 09746000
&OUTREG  SETC '0000000000000000'                               @D64ADKH 09747000
&WRKREG  SETC '0000000000000000'                               @D64ADKH 09748000
&NMDREG  SETC '0000000000000000'                               @D64ADKH 09749000
&LINKR   SETC 'R7'                                             @D64ADKH 09750000
&TBASE   SETC 'OWN'                                            @D64ADKH 09751000
.*EXCLSYMS=()                                                           09752000
         AGO    .TESTALL                                                09753000
.CREATE_03 ANOP                                                @D64ADKH 09754000
***************************************************************         09755000
         SPACE  3                                              @D64ADKH 09756000
         USING FV_DISCARD,RE                                   @D64ADKH 09757000
         USING SVEARA,RD                                       @D64ADKH 09758000
         USING ANCHTAB,RC                                      @D64ADKH 09759000
FV_DISCARD  DS  0H                                             @D64ADKH 09760000
*SGLINK  FV_DISCARD,S,INPUT=(R2,R7:LINK,RC,RD),OUTPUT=(RF),    @D64ADKH*09761000
                WORK=(R0-R2,RE,RF),                            @D64ADKH*09762000
                SUBROUT=(DSC_LSQA:IGN(R3-RC),DISCARD,          @D64ADKH*09763000
                FVSBPOOL:IGN(R3-RC))                           @D64ADKH 09764000
         TM    GMFMFLG2,LSQA     FREEVIS LSQA SUBPOOL AND SPLE @D64ADKH 09765000
         BO    DISCARD_LSQA      YES                           @D64ADKH 09766000
         L     R0,SVER0F         SAVE OPTIONS                  @D64ADKH 09767000
         LR    R1,RD             SAVE ADDR(SAVE AREA)          @D64ADKH 09768000
         LA    RD,GMFMWRK1    SET NEW SAVE AREA (IN PART CI)   @D64ADKH 09769000
         ST    R1,SVER0D      SAVE ORIGINAL SAVE AREA PTR      @D64ADKH 09770000
         ST    R0,SVER0F      SAVE ORIGINAL OPTIONS            @D64ADKH 09771000
         STM   R3,R8,SVER03                                    @D64ADKH 09772000
         STM   R9,RC,SVER09                                    @D64ADKH 09773000
         LR    R6,R2                                           @D64ADKH 09774000
         L     R2,0(,R6)      ADDR OF FIRST SPLE               @D64ADKH 09775000
         ST    R2,SPITMVSP    SAVE IT                          @D64ADKH 09776000
         TM    GMFMFLG2,FSPLE                                  @D64ADKH 09777000
*SGLINK  DSC_SPLE,S,INPUT=(R2,R7:LINK,RC,RD),OUTPUT=(RF),      @D64ADKH*09778000
                WORK=(R0-R1,RE,RF),SUBROUT=(DISCARD)           @D64ADKH 09779000
         BO    DISCARD_SPLE                                    @D64ADKH 09780000
         SPACE                                                          09781000
* FREEVIS TASK RELATED PRIVATE SUBPOOLS                                 09782000
         SPACE                                                          09783000
         BAL   R3,DISCARD_SUBPOOL                              @D64ADKH 09784000
         LR    R2,R6                                           @D64ADKH 09785000
         SPACE                                                          09786000
* FREEVIS TASK RELATED LSQA SUBPOOLS                                    09787000
         SPACE                                                          09788000
         BAL   R7,DISCARD_LSQA                                 @D64ADKH 09789000
         SPACE                                                          09790000
         LM    R3,R8,SVER03                                    @D64ADKH 09791000
         LM    R9,RD,SVER09                                    @D64ADKH 09792000
         BR    R7                                              @D64ADKH 09793000
         SPACE                                                          09794000
DISCARD_LSQA DS  0H                                            @D64ADKH 09795000
         SPACE                                                          09796000
*  FREEVIS LSQA SUBPOOLS AND SPLES                                      09797000
         SPACE                                                          09798000
*SGLINK  DSC_LSQA,S,INPUT=(R2,R7:LINK,RC,RD),OUTPUT=(RF),      @D64ADKH*09799000
                WORK=(R0-R5,R9,RB,RE,RF),                      @D64ADKH*09800000
                SUBROUT=(GVFVGATING:IGN(R3-RC),                        *09801000
                FVSBPOOL:IGN(R3-RC),FREEVSM0:IGN(R3-RC),               *09802000
                GTVSINI1:IGN(R3-RC),DISCARD)                            09803000
         L     R0,SVER0F                                       @D64ADKH 09804000
         TM    SVER0F+D2,GVFVSPIN    GATE ALREADY CLOSED       @D64ADKH 09805000
         BO    SPACE_SWITCHED        YES                       @D64ADKH 09806000
         OI    SVER0F+D2,GVFVSPIN    NOW WE WORK FOR SPACE     @D64ADKH 09807000
         LR    R3,RC                 SAVE PTR TO PART. CI      @D64ADKH 09808000
* SPLES ARE FREED IN SVA OR SPACE AREA. ONLY ONE GETMAIN/FREEMAIN       09809000
* REQUEST AT A TIME IS ALLOWED SINCE SAVE AREA GMFMWRK1 WITHIN CI IS    09810000
* USED. (GETVIS GATE MIGHT BE OPENED DURING PFIX PROCESSING SO SAVE     09811000
* AREA MIGHT BE DESTROYED BY A PARALLEL REQUEST)                        09812000
         LA    R9,0                                            @D64ADKH 09813000
         LA    R5,1        MUST RUN AS FREEMAIN REQUEST        @D64ADKH 09814000
*SGLINK  GVFVGATING,INPUT=(R5,R8:LINK,R9,RA,RD),OUTPUT=(R9,RC),        *09815000
               AMODE=31,NOMODR=(R0-R3,R6-R8,RA,RD,RF)                   09816000
         SGAMSUBR SUBROUT=GVFVGATS,                            @D64ADKH*09817000
               INPUT=(R5,R9,RA,RD),                            @D64ADMZ*09818000
               NOMOD=(R0,R1,R2,R3,R6,R7,RA,RD,RE,RF),          @D64ADKH*09819000
               OUTPUT=(R9,RC),                                 @D64ADMZ*09820000
               LINK=(R8),         SET STORAGE KEY TO ZERO      @D64ADKH*09821000
               CBASE=OWN,                                      @D64ADKH*09822000
               SUBROUC=FVDISCRD                                @D64ADKH 09823000
* NOW RC POINTS TO SPACE GETVIS CI (SVA FOR STATIC PART.)               09824000
         NI    SVER0F+D2,X'FF'-GVFVSPIN                        @D64ADKH 09825000
         OI    GMFMFLG2,SWITCHED   INDICATE NEW CI WAS SET     @D64ADKH 09826000
         OI    GMFMFLG2,LSQA       FREEVIS LSQA STORAGE        @D64ADKH 09827000
         LA    R0,0                                            @D64ADKH 09828000
         SPACE                                                          09829000
SPACE_SWITCHED  DS  0H                                         @D64ADKH 09830000
*SGLINK  DSC_LSQA_NS,S,INPUT=(R2,R7:LINK,RC,RD),OUTPUT=(RF),   @D64ADKH*09831000
                WORK=(R0-R2,RF),                               @D64ADKH*09832000
                SUBROUT=(FVSBPOOL,FREEVSM0,DISCARD)            @D64ADKH 09833000
         LR    R1,RD              SAVE PTR TO SAVE AREA        @D64ADKH 09834000
         LA    RD,GMFMWRK1        USE INTERNAL AREA FOR FREEV. @D64ADMZ 09835000
         ST    R1,SVER0D          SAVE R1 ..                   @D64ADKH 09836000
         ST    R0,SVER0F          .. R0..                      @D64ADKH 09837000
         STM   R3,R8,SVER03       .. R3-R8..                   @D64ADKH 09838000
         STM   R9,RC,SVER09       .. R9-RC                     @D64ADKH 09839000
         LR    R6,R2              SAVE PTR TO SPLE             @D64ADKH 09840000
         TM    GMFMFLG2,SWITCHED  WAS GATE CLOSED AND CI SET ON@D64ADKH 09841000
*                                 ENTRY TO FV_DISCARD          @D64ADKH 09842000
         BZ    SPACE_ACTIVE       YES                          @D64ADKH 09843000
         OI    SVER0F+D2,GVFVSPIN                              @D64ADKH 09844000
         OI    SVER0F+D3,FVSPID                                @D64ADKH 09845000
         LA    RB,1               IDENTIFY CALLER AS FREEVIS   @D64ADKH 09846000
*SGLINK  GTVSINI1,INPUT=(R7:LINK,RB-RD,RF),OUTPUT=(RB,RC,RF),          *09847000
               NOMODR=(R6,RA,RD),AMODE=31                               09848000
         SGAMSUBR SUBROUT=GTVSINI1,                            @D64ADKH*09849000
               INPUT=(RB,RD,RE,RF),                            @D64ADKH*09850000
               OUTPUT=(RB,RC,RF),                              @D64ADKH*09851000
               NOMOD=(R6,RA,RD),                               @D64ADKH*09852000
               IGN=(R3,R8),                                    @D64ADKH*09853000
               LINK=(R7),                                      @D64ADKH*09854000
               CBASE=OWN,         INITIALIZE GETVIS AREA       @D64ADKH*09855000
               SUBROUC=FVDISCRD                                @D64ADKH 09856000
         SPACE                                                          09857000
SPACE_ACTIVE  DS  0H                                           @D64ADKH 09858000
         SPACE                                                          09859000
*  FREEVIS SUBPOOLS                                                     09860000
*  IF THE CORRESPONDING SPLE IS IN THE GETVIS CI, IT IS REMOVED FROM    09861000
*  THE CHAIN.                                                           09862000
*  OTHERWISE (IF IT IS THE SPACE GETVIS AREA(SVA), IT IS REMOVED        09863000
*  SEPARATELY)                                                          09864000
         SPACE                                                          09865000
         L     R2,0(,R6)                                       @D64ADKH 09866000
         ST    R2,SPITMVSP                                     @D64ADKH 09867000
         BAL   R3,DISCARD_SUBPOOL   FREEVIS SUBPOOLS           @D64ADKH 09868000
         ST    RF,SVER0F                                       @D64ADKH 09869000
*  FREEVIS SPLES                                                        09870000
         OI    SVER0F+D2,GVFVSPIN                              @D64ADKH 09871000
         OI    GMFMFLG2,FSPLE       INDICATOR FOR FREEVIS SPLE @D64ADKH 09872000
         OI    GMFMFLGS,GMFM_SYSTEM  DO NOT OPEN GATE ON ..    @D64ADKH 09873000
*                                   .. FREEVIS EXIT            @D64ADKH 09874000
         L     R2,0(,R6)                                       @D64ADKH 09875000
         ST    R2,SPITMVSP                                     @D64ADKH 09876000
DISCARD_SPLE  DS  0H                                           @D64ADKH 09877000
*SGLINK  DISCARD,INPUT=(R6,R8,RC-RF),OUTPUT=(RF),              @D64ADKH*09878000
                NOMODR=(R6,RA-RC,RD)                           @D64ADKH 09879000
         SGAMSUBR SUBROUT=IJBSSM2,                             @D64ADKH*09880000
               LINK=(FUNCTION,SM2DIS),                         @D64ADKH*09881000
               SUBROUC=FVDISCRD,                               @D64ADKH*09882000
               CBASE=OWN                                       @D64ADKH 09883000
         LTR   RF,RF             SPLES TO BE FREED ?           @D64ADKH 09884000
         BZ    DISCARD_DONE      NO, ALL DONE                  @D64ADKH 09885000
         ST    R6,GMFMWRK1_EXT    SVER02 CAN'T BE USED         @D64ADMZ 09886000
         ST    RE,SVER0E                                       @D64ADKH 09887000
         L     RE,AMBASE          BASE OF FREEVIS MAIN PATH    @D64ADKH 09888000
         L     R6,AFREEVIS-GETVIS(RE)                          @D64ADKH 09889000
         LA    RF,0                                            @D64ADKH 09890000
*SGLINK FREEVSM0,AMODE=31,                                     @D64ADKH*09891000
               INPUT=(R6,RA,RC-RF),                            @D64ADKH*09892000
               OUTPUT=(RF),                                    @D64ADKH*09893000
               NOMODR=(RA,RD)                                           09894000
         AMODESW CALL,AMODE=31,REGS=(R6,R6)                    @D64ADKH 09895000
         L     R6,GMFMWRK1_EXT         RELOAD                  @D64ADMZ 09896000
         L     RE,SVER0E               RELOAD FREEVIS ALL BASE @D64ADKH 09897000
         BALR  R5,0                                            @D64ADKH 09898000
         LTR   RF,RF                                           @D64ADKH 09899000
         BNZ   SYSERROR                                        @D64ADKH 09900000
         OI    SVER0F+D2,GVFVSPIN                              @D64ADKH 09901000
         B     DISCARD_SPLE                                    @D64ADKH 09902000
DISCARD_DONE  DS  0H                                           @D64ADKH 09903000
         LM    R3,R8,SVER03                                    @D64ADKH 09904000
         LM    R9,RD,SVER09                                    @D64ADKH 09905000
         TM    GMFMFLG2,SWITCHED   WAS GATE CLOSED AND CI SET..@D64ADKH 09906000
*                                  .. IN FV_DISCARD ROUT?      @D64ADKH 09907000
         ST    RF,GMFMFLGS                                     @D64ADKH 09908000
         BZR   R7                  NO,GATE HANDLED OUTSIDE .   @D64ADKH 09909000
* GATE WAS CLOSED IN FV_DISCARD. OPEN GATE AND SET PTR TO CI (RC)       09910000
* AS IT WAS ON ENTRY TO FV_DISCARD                                      09911000
         LR    R1,R5                                           @D64ADKH 09912000
         L     R5,GVFVGATE        OPEN SPACE GATE              @D64ADKH 09913000
*                                 (SVA FOR STATIC PART.)       @D64ADKH 09914000
         LA    R5,0(R5)                                        @D64ADKH 09915000
         ST    R5,GVFVGATE                                     @D64ADKH 09916000
         LR    RC,R3              SET ORIGINAL CI (PART.CI)    @D64ADKH 09917000
         LR    R0,R6              REGISTERS ARE DESTROYED..    @D64ADKH 09918000
         LR    R2,RE              REGISTERS ARE DESTROYED..    @D64ADKH 09919000
         L     R6,DISPAD                                       @D64ADKH 09920000
         USING DISP,R6                                         @D64ADKH 09921000
         BAL   RF,RPOST           POST ALL WAITERS             @D64ADKH 09922000
*SGLINK  RPOST,INPUT=(R5,R6,RF),WORK=(R5,RE)                   @D64ADKH 09923000
         DROP  R6                 RELEASE DISP BASE            @D64ADKH 09924000
         LR    RE,R2              RESTORE BASE                 @D64ADKH 09925000
         LR    R6,R0              RESTORE ..                   @D64ADKH 09926000
         LR    R5,R1              RESTORE ..                   @D64ADKH 09927000
         LA    RF,0                                            @D64ADKH 09928000
         BR    R7                                              @D64ADKH 09929000
DISCARD_SUBPOOL  DS  0H                                        @D64ADKH 09930000
         ST    R3,SAVR2ND6                                     @D64ADKH 09931000
         LA    R5,SUBPINTL                                     @D64ADKH 09932000
         MH    R5,MXSUBPLH                                     @D64ADKH 09933000
         LA    R5,SUBPINTL(R5)                                 @D64ADKH 09934000
         A     R5,BSUBPIND                                     @D64ADKH 09935000
         ST    R5,SPIDSAV                                      @D64ADKH 09936000
REPEAT_DISCARD  DS  0H                                         @D64ADKH 09937000
*SGLINK  DISCARD,INPUT=(R6,R8,RC-RF),OUTPUT=(RF),              @D64ADKH*09938000
                NOMODR=(R3,R6,RA-RC,RD)                        @D64ADKH 09939000
         SGAMSUBR SUBROUT=IJBSSM2,                             @D64ADKH*09940000
               LINK=(FUNCTION,SM2DIS),                         @D64ADKH*09941000
               SUBROUC=FVDISCRD,                               @D64ADKH*09942000
               CBASE=OWN                                       @D64ADKH 09943000
         LTR   RF,RF                                           @D64ADKH 09944000
         BZ    END_DISCARD                                     @D64ADKH 09945000
         LA    RF,0                                            @D64ADKH 09946000
         LA    R1,GMFMSPNM                                     @D64ADKH 09947000
         L     R5,SPIDSAV                                      @D64ADKH 09948000
*SGLINK  FVSBPOOL,INPUT=(R1,R5,R7:LINK,RA,RB,RC,RD,RF),OUTPUT=(RF),    *09949000
               NOMODR=(R6,RA,RD),AMODE=31,NOMODS=(SAVR2ND6)             09950000
         SGAMSUBR SUBROUT=FVSBPOOL, YES, FREE IT               @D64ADKH*09951000
               INPUT=(R1,R5,RA,RB,RC,RD,RE,RF),                @D64ADMZ*09952000
               NOMOD=(R6,RA,RD),                               @D64ADKH*09953000
               LINK=(R7),                                      @D64ADKH*09954000
               CBASE=OWN,         FREE TOTAL SUBPOOL           @D64ADKH*09955000
               NOMODS=(SAVR2ND6),                              @D64ADKH*09956000
               SUBROUC=FVDISCRD                                @D64ADKH 09957000
         AIF   (NOT &BGDEBUG).DSC_NDBG2                        @D64ADKH 09958000
         BALR  R5,0                                            @D64ADKH 09959000
         LTR   RF,RF                                           @D64ADKH 09960000
         BNZ   SYSERROR                                        @D64ADKH 09961000
.DSC_NDBG2  ANOP                                               @D64ADKH 09962000
         B     REPEAT_DISCARD                                  @D64ADKH 09963000
END_DISCARD  DS  0H                                            @D64ADKH 09964000
         ST    RF,SPIDSAV                                      @D64ADKH 09965000
         L     R3,SAVR2ND6                                     @D64ADKH 09966000
         BR    R3                                              @D64ADKH 09967000
         DROP  RD,RE,RC                                        @D64ADKH 09968000
         AGO   .MACEND                                         @D64ADKH 09969000
.**************************************************************@D149DJB 09970000
.*   BUILD UP SEVERAL VARIABLES FOR INPUT REGISTER CHECKING    @D149DJB 09971000
.**************************************************************@D149DJB 09972000
.TESTALL ANOP                                                  @D14ZDJB 09973000
.**************************************************************@D52VDMZ 09974000
.*   CREATE SGLINK CALL                                        @D52VDMZ 09975000
.**************************************************************@D52VDMZ 09976000
         AGO   .GVSKSG2                                        @D52VDMZ 09977000
         SGLINK &SUBROUT,AMODE=31,                             @D52VDMZ*09978000
               INPUT=&INPUT,                                   @D52VDMZ*09979000
               OUTPUT=&OUTPUT,                                 @D52VDMZ*09980000
               NOMODR=&NOMOD,                                  @D52VDMZ*09981000
               NOMODS=&NOMODS                                  @D52VDMZ 09982000
.**************************************************************@D52VDMZ 09983000
.GVSKSG2 ANOP                                                  @D52VDMZ 09984000
         AIF   ('&LINK(1)' EQ 'INLINE').CHKINP                 @D14ZDJB 09985000
         AIF   ('&LINK(1)' EQ 'FUNCTION').CHKINP               @D64ADKH 09986000
         AIF   ('&LINK(1)' EQ '&LINKR').CHKINP                 @D14ZDJB 09987000
         MNOTE  8,'LINK REGISTER MUST BE &LINKR'               @D14ZDJB 09988000
.CHKINP  ANOP                                                  @D14ZDJB 09989000
&I       SETA  1                                               @D14ZDJB 09990000
         AIF   (T'&INPUT EQ 'O').CHKNOIN                       @D14ZDJB 09991000
&SETUP   SETC  '&INPREG'                                       @D14ZDJB 09992000
&KEYW    SETC  'INPUT'                                         @D14ZDJB 09993000
&ENTR    SETA  (N'&INPUT)                                      @D14ZDJB 09994000
&M       SETA  1                                               @D14ZDJB 09995000
.INPLOOP ANOP                                                  @D14ZDJB 09996000
&TSTREG(&M)  SETC  '&INPUT(&M)'                                @D14ZDJB 09997000
&M       SETA  &M+1                                            @D14ZDJB 09998000
         AIF   (&M LE &ENTR).INPLOOP                           @D14ZDJB 09999000
         AGO   .TSTREG                                         @D14ZDJB 10000000
.CHKNOIN ANOP                                                  @D14ZDJB 10001000
         AIF   ('&INPREG' EQ '0000000000000000').SETOUT        @D14ZDJB 10002000
         MNOTE 8,'REQUIRED INPUT REGISTERS ARE MISSING'        @D14ZDJB 10003000
.**************************************************************@D149DJB 10004000
.*   BUILD UP SEVERAL VARIABLES FOR OUTPUT REGISTER CHECKING   @D149DJB 10005000
.**************************************************************@D149DJB 10006000
.SETOUT  ANOP                                                  @D14ZDJB 10007000
&I       SETA  (&I+1)                                          @D14ZDJB 10008000
         AIF   (T'&OUTPUT EQ 'O').CHKNOOT                      @D14ZDJB 10009000
&SETUP   SETC  '&OUTREG'                                       @D14ZDJB 10010000
&KEYW    SETC  'OUTPUT'                                        @D14ZDJB 10011000
&ENTR    SETA  (N'&OUTPUT)                                     @D14ZDJB 10012000
&M       SETA  1                                               @D14ZDJB 10013000
.OUTLOOP ANOP                                                  @D14ZDJB 10014000
&TSTREG(&M)  SETC  '&OUTPUT(&M)'                               @D14ZDJB 10015000
&M       SETA  &M+1                                            @D14ZDJB 10016000
         AIF   (&M LE &ENTR).OUTLOOP                           @D14ZDJB 10017000
         AGO   .TSTREG                                         @D14ZDJB 10018000
.CHKNOOT ANOP                                                  @D14ZDJB 10019000
         AIF   ('&OUTREG' EQ '0000000000000000').SETNMD        @D14ZDJB 10020000
         MNOTE 8,'REQUIRED OUTPUT REGISTERS ARE MISSING'       @D14ZDJB 10021000
.**************************************************************@D149DJB 10022000
.*   BUILD UP SEVERAL VARIABLES FOR WORK REGISTER CHECKING     @D149DJB 10023000
.**************************************************************@D149DJB 10024000
.SETNMD  ANOP                                                  @D14ZDJB 10025000
&I       SETA  (&I+1)                                          @D14ZDJB 10026000
         AIF   (T'&NOMOD EQ 'O').CHKNONM                       @D14ZDJB 10027000
&SETUP   SETC  '&NMDREG'                                       @D14ZDJB 10028000
&KEYW    SETC  'NOMOD'                                         @D14ZDJB 10029000
&ENTR    SETA  (N'&NOMOD)                                      @D14ZDJB 10030000
&M       SETA  1                                               @D14ZDJB 10031000
.NMDLOOP ANOP                                                  @D14ZDJB 10032000
&TSTREG(&M)  SETC  '&NOMOD(&M)'                                @D14ZDJB 10033000
&M       SETA  &M+1                                            @D14ZDJB 10034000
         AIF   (&M LE &ENTR).NMDLOOP                           @D14ZDJB 10035000
         AGO   .TSTREG                                         @D14ZDJB 10036000
.CHKNONM ANOP                                                  @D14ZDJB 10037000
.*       MNOTE 4,'MAY ALL REGISTERS BE DESTROYED ?'            @D64ADKH 10038000
         AGO   .GENCOD1                                        @D14ZDJB 10039000
.**************************************************************@D149DJB 10040000
.*   NOW CHECK REGISTER CONTENTS                               @D149DJB 10041000
.**************************************************************@D149DJB 10042000
.TSTREG  ANOP                                                  @D14ZDJB 10043000
&L       SETA  1                                               @D14ZDJB 10044000
.LPSBEG  ANOP                                                  @D14ZDJB 10045000
&RWORK   SETC  '&TSTREG(&L)'                                   @D14ZDJB 10046000
.**************************************************************@D149DJB 10047000
.*   NOW CHECK FOR VALID REGISTER SYMBOLS                      @D149DJB 10048000
.**************************************************************@D149DJB 10049000
&M       SETA  1                                               @D14ZDJB 10050000
&N       SETA  1                                               @D14ZDJB 10051000
.LPS050  AIF   ('R0R1R2R3R4R5R6R7R8R9RARBRCRDRERF'(&N,2) EQ            *10052000
               '&RWORK').LPSFND                                @D14ZDJB 10053000
&N       SETA  &N+2                                            @D14ZDJB 10054000
&M       SETA  &M+1                                            @D14ZDJB 10055000
         AIF   (&N LT 32).LPS050                               @D14ZDJB 10056000
         MNOTE 8,'&RWORK IS AN INVALID &KEYW.-REGISTER SYMBOL' @D14ZDJB 10057000
         AGO   .LPSREG1                                        @D14ZDJB 10058000
.**************************************************************@D149DJB 10059000
.*   NOW CHECK FOR VALID REGISTER SPECIFICATION                @D149DJB 10060000
.**************************************************************@D149DJB 10061000
.LPSFND  ANOP                                                  @D14ZDJB 10062000
         AIF   ('&SETUP'(&M,1) NE '0').LPSREG                  @D14ZDJB 10063000
         AIF   (&I GT 2).ERRNF                                 @D14ZDJB 10064000
         MNOTE 8,'&RWORK IS NOT AN &KEYW.-REGISTER'            @D14ZDJB 10065000
         AGO   .LPSREG1                                        @D14ZDJB 10066000
.ERRNF   ANOP                                                  @D14ZDJB 10067000
         MNOTE 8,'REGISTER &RWORK WILL BE MODIFIED'            @D14ZDJB 10068000
.LPSREG  ANOP                                                  @D14ZDJB 10069000
&C       SETC  ''                                              @D14ZDJB 10070000
&D       SETC  ''                                              @D14ZDJB 10071000
         AIF   (&M EQ 1).MEQ1                                  @D14ZDJB 10072000
&C       SETC  '&SETUP'(1,&M-1)                                @D14ZDJB 10073000
         AIF   (&M EQ 16).MEQ16                                @D14ZDJB 10074000
.MEQ1    ANOP                                                  @D14ZDJB 10075000
&D       SETC  '&SETUP'(&M+1,16)                               @D14ZDJB 10076000
.MEQ16   ANOP                                                  @D14ZDJB 10077000
&SETUP   SETC  '&C'.'0'.'&D'                                   @D14ZDJB 10078000
.LPSREG1 ANOP                                                  @D14ZDJB 10079000
&L       SETA  &L+1                                            @D14ZDJB 10080000
         AIF   (&L LE &ENTR).LPSBEG                            @D14ZDJB 10081000
.**************************************************************@D149DJB 10082000
.*   NOW CHECK FOR MISSING REGISTERS                           @D149DJB 10083000
.**************************************************************@D149DJB 10084000
         AIF   (&I EQ 3).GENCOD1                               @D14ZDJB 10085000
&L       SETA  0                                               @D14ZDJB 10086000
&N       SETA  0                                               @D14ZDJB 10087000
.LPERR   ANOP                                                  @D14ZDJB 10088000
&N       SETA  &N+1                                            @D14ZDJB 10089000
         AIF   ('&SETUP'(&N,1) NE '1').LPERR1                  @D14ZDJB 10090000
&C       SETC  '0123456789ABCDEF'(&N,1)                        @D14ZDJB 10091000
         MNOTE 8,'&KEYW.-REGISTER R&C IS MISSING'              @D14ZDJB 10092000
.LPERR1  ANOP                                                  @D14ZDJB 10093000
         AIF   (&N LT 16).LPERR                                @D14ZDJB 10094000
         AIF   (&I EQ 1).SETOUT                                @D14ZDJB 10095000
         AIF   (&I EQ 2).SETNMD                                @D14ZDJB 10096000
.GENCOD1 ANOP                                                  @D14ZDJB 10097000
         AIF   ('&LINK(1)' EQ 'INLINE').INLIGN                 @D52VDKH 10098000
         AIF   ('&TBASE' NE 'MODULE').C_CBASE                  @D64ADKH 10099000
&KSUBR   SETA  K'&SUBROUT                                      @D64ADKH 10100000
         AIF   (&KSUBR LE 7).C_NXT1                            @D64ADKH 10101000
&EC      SETC  '&SUBROUT'(1,7)                                 @D64ADKH 10102000
         AGO   .C_NXT2                                         @D64ADKH 10103000
.C_NXT1  ANOP                                                  @D64ADKH 10104000
&EC      SETC  '&SUBROUT'                                      @D64ADKH 10105000
.C_NXT2  ANOP                                                  @D64ADKH 10106000
         LA    RF,&LINK(2)                                     @D64ADKH 10107000
         L     R8,ASVASVDL                                     @D64ADKH 10108000
         L     R8,A&EC-SVASVDL(,R8)                            @D64ADKH 10109000
         BALR  RE,R8                                           @D64ADKH 10110000
         L     RE,AMBASE                                       @D61RDKH 10111000
.C_CBASE ANOP                                                  @D64ADKH 10112000
         AIF   ('&CBASE' EQ 'AMBASE').CAMB                     @D51IDMZ 10113000
         AIF   ('&CBASE' EQ 'GVSUBR').CGVSUB                   @D51IDMZ 10114000
.* CALLING ROUTINE HAS ITS OWN BASE                            @D51IDMZ 10115000
         AIF   ('&TBASE' EQ 'AMBASE').TAMB0                    @D51IDMZ 10116000
         AIF   ('&TBASE' EQ 'GVSUBR').TGVSUB2                  @D51IDMZ 10117000
&KSUBR   SETA  K'&SUBROUC                                      @D51IDMZ 10118000
         AIF   (&KSUBR LE 7).SUBRA2                            @D52VDKH 10119000
&E       SETC  '&SUBROUC'(1,7)                                 @D52VDKH 10120000
         AGO   .SUBRA3                                         @D52VDKH 10121000
.SUBRA2  ANOP                                                  @D52VDKH 10122000
&E       SETC  '&SUBROUC'                                      @D52VDKH 10123000
.SUBRA3  ANOP                                                  @D52VDKH 10124000
&KSUBR   SETA  K'&SUBROUT                                      @D52VDKH 10125000
         AIF   (&KSUBR LE 7).SUBRA4                            @D52VDKH 10126000
&EC      SETC  '&SUBROUT'(1,7)                                 @D52VDKH 10127000
         AGO   .SUBRA5                                         @D52VDKH 10128000
.SUBRA4  ANOP                                                  @D52VDKH 10129000
&EC      SETC  '&SUBROUT'                                      @D52VDKH 10130000
.SUBRA5  ANOP                                                  @D52VDKH 10131000
         AIF   ('&TBASE' EQ 'MODULE').TMODULE1                 @D64ADKH 10132000
         L     RE,AMBASE          MAIN PATH BASE REGISTER      @D52VDKH 10133000
         L     RE,A&EC-GETVIS(RE)                              @D52VDKH 10134000
         BALR  &LINKR,RE                    EXECUTE SUBROUTINE @D52VDKH 10135000
         L     RE,AMBASE          MAIN PATH BASE REGISTER      @D52VDKH 10136000
.TMODULE1 ANOP                                                 @D64ADKH 10137000
         L     RE,A&E-GETVIS(RE)                               @D52VDKH 10138000
         MEXIT                                                 @D52VDKH 10139000
.TAMB0   ANOP                                                  @D51IDMZ 10140000
&KSUBR   SETA  K'&SUBROUC                                      @D51IDMZ 10141000
         AIF   (&KSUBR LE 7).SUBRA0                            @D51IDMZ 10142000
&E       SETC  '&SUBROUC'(1,7)                                 @D51IDMZ 10143000
         AGO   .SUBRA1                                         @D51IDMZ 10144000
.SUBRA0  ANOP                                                  @D51IDMZ 10145000
&E       SETC  '&SUBROUC'                                      @D51IDMZ 10146000
.SUBRA1  ANOP                                                  @D51IDMZ 10147000
         L     RE,AMBASE          MAIN PATH BASE REGISTER      @D218DKH 10148000
         BAL   &LINKR,&SUBROUT-GETVIS(RE)   EXECUTE SUBROUTINE @D218DKH 10149000
         L     RE,AMBASE          MAIN PATH BASE REGISTER      @D218DKH 10150000
         L     RE,A&E-GETVIS(RE)                               @D51IDMZ 10151000
         MEXIT                                                 @D51IDMZ 10152000
.TGVSUB2 ANOP                                                  @D51IDMZ 10153000
&KSUBR   SETA  K'&SUBROUC                                      @D51IDMZ 10154000
         AIF   (&KSUBR LE 7).SUBRB0                            @D51IDMZ 10155000
&E       SETC  '&SUBROUC'(1,7)                                 @D51IDMZ 10156000
         AGO   .SUBRB1                                         @D51IDMZ 10157000
.SUBRB0  ANOP                                                  @D51IDMZ 10158000
&E       SETC  '&SUBROUC'                                      @D51IDMZ 10159000
.SUBRB1  ANOP                                                  @D51IDMZ 10160000
         L     RE,AMBASE          MAIN PATH BASE REGISTER      @D218DKH 10161000
         L     RE,AGVFVSUB-GETVIS(RE) LOAD SECOND BASE REGISTER@D218DKH 10162000
         BAL   &LINKR,&SUBROUT-GVFVSUBR(RE) EXECUTE SUBROUTINE @D218DKH 10163000
         L     RE,AMBASE          MAIN PATH BASE REGISTER      @D51IDMZ 10164000
         L     RE,A&E-GETVIS(RE)            RESTORE OWN BASE   @D51IDMZ 10165000
         MEXIT                                                 @D51IDMZ 10166000
.* CALLING ROUTINE HAS ITS OWN BASE                            @D51IDMZ 10167000
.CGVSUB  ANOP                                                  @D51IDMZ 10168000
         AIF   ('&TBASE' EQ 'AMBASE').TGVSUB0                  @D51IDMZ 10169000
         AIF   ('&TBASE' EQ 'GVSUBR').TGVSUB1                  @D51IDMZ 10170000
.*  THE CALLED ROUTINE HAS ITS OWN BASE REGISTER               @D51IDMZ 10171000
         AIF   ('&TBASE' EQ 'MODULE').TMODULE2                 @D64ADKH 10172000
&E       SETC  '&SUBROUT'(1,7)                                 @D51IDMZ 10173000
         L     RE,AMBASE                                       @D51IDMZ 10174000
         L     RE,A&E-GETVIS(RE)                               @D51IDMZ 10175000
         BALR  &LINKR,RE                                       @D51IDMZ 10176000
         L     RE,AMBASE                                       @D51IDMZ 10177000
.TMODULE2 ANOP                                                 @D64ADKH 10178000
         L     RE,AGVFVSUB-GETVIS(RE)     RELOAD BASE REG      @D218DKH 10179000
         MEXIT                                                 @D218DKH 10180000
.TGVSUB0 ANOP                                                  @D51IDMZ 10181000
         L     RE,AMBASE          COMMON SUBROUTINE BASE REG.  @D218DKH 10182000
         BAL   &LINKR,&SUBROUT-GETVIS(RE)   EXECUTE SUBROUTINE @D218DKH 10183000
         L     RE,AGVFVSUB-GETVIS(RE)     RELOAD BASE REG      @D218DKH 10184000
         MEXIT                                                 @D218DKH 10185000
.TGVSUB1 ANOP                                                  @D51IDMZ 10186000
         BAL   &LINKR,&SUBROUT                                 @D14ZDJB 10187000
         MEXIT                                                 @D218DKH 10188000
.CAMB    ANOP                                                  @D51IDMZ 10189000
         AIF   ('&TBASE' EQ 'AMBASE').TAMB                     @D51IDMZ 10190000
         AIF   ('&TBASE' EQ 'GVSUBR').TGVSUB                   @D51IDMZ 10191000
.* CALLED ROUTINE HAS ITS OWN BASE                             @D51IDMZ 10192000
         AIF   ('&TBASE' EQ 'MODULE').TMODULE3                 @D64ADKH 10193000
&E       SETC  '&SUBROUT'(1,7)                                 @D51IDMZ 10194000
         L     RE,A&E-GETVIS(RE)                               @D51IDMZ 10195000
         BALR  &LINKR,RE                                       @D51IDMZ 10196000
         L     RE,AMBASE                                       @D51IDMZ 10197000
.TMODULE3 ANOP                                                 @D64ADKH 10198000
         MEXIT                                                 @D218DKH 10199000
.TAMB    ANOP                                                  @D51IDMZ 10200000
         BAL   &LINKR,&SUBROUT                                 @D14ZDJB 10201000
         MEXIT                                                 @D218DKH 10202000
.TGVSUB  ANOP                                                  @D51IDMZ 10203000
         L     RE,AGVFVSUB        COMMON SUBROUTINE BASE REG.  @D14ZDJB 10204000
         BAL   &LINKR,&SUBROUT-GVFVSUBR(RE) EXECUTE SUBROUTINE @D218DKH 10205000
         L     RE,AMBASE            RELOAD BASE REG            @D218DKH 10206000
         MEXIT                                                 @D52VDKH 10207000
.INLIGN  ANOP                                                  @D51IDMZ 10208000
         AIF   ('&SUBROUT' EQ 'GVFVMIR1').MIR1GEN              @D52VDKH 10209000
         AIF   ('&SUBROUT' EQ 'GVFVMIR2').MIR2GEN              @D52VDKH 10210000
.MACEND  ANOP                                                  @D14ZDJB 10211000
         MEND                                                  @D14ZDJB 10212000
