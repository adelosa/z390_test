         MACRO                                                          00050000
         SGSLDUP &TAB=NO,&DSECT=NO,&ROUT=,&IAREA=NO                     00100000
         GBLB  &BGFBA              FBA DEVICES                 @D36SDVB 00150000
         GBLB  &BGDEBUG                                        @D36SDVB 00200000
         GBLB  &SGSLDUP                                        @D37ZDVB 00250000
         GBLB  &SGAFCH                                         @D14ZDVB 00300000
         GBLB  &SGBFCH                                         @D14ZDVB 00350000
         GBLB  &SGDFCH                                                  00400000
         GBLB  &SGHFCH                                         @D14ZDVB 00450000
         GBLB  &SGSER                                          @D14CDVB 00500000
         GBLB  &BG370                                          @D36SDVB 00550000
         GBLB  &BGVM               VMLE                        @D36SDVB 00600000
         GBLA  &LBR0SCO            USED TO GENERATE / SUPPRESS @D14CDHD*00650000
                                   THE GENERATION OF THE DSECT         *00700000
                                   SYSCOM IN THE MACRO INLMLAMB         00750000
         LCLA  &COUNT              NUMBER OF SLDQUE ENTRIES    @D36SDVB 00800000
         ACTR  2000                UPPER LIMIT FOR ASS. LOOPS  @D14CDHD 00850000
*--------------------------------------------------------------@D369DVB 00900000
*                                                              @D369DVB 00950000
.*       IBM DISK OPERATING SYSTEM                             @D369DVB 01000000
*        SUPERVISOR - SGSLDUP- 5686-032-06                     @D52VDMZ 01050001
.*                                                             @D369DVB 01100000
*        LICENSED MATERIALS - PROPERTY OF IBM                  @D369DVB 01150001
*        THIS MACRO IS "RESTRICTED MATERIALS OF IBM"           @D31UDMZ 01200001
*        5686-032 (C) COPYRIGHT IBM CORP. 1977, 1994           @D61ADAP 01250001
*        SEE COPYRIGHT INSTRUCTIONS                            @D52VDMZ 01300001
*                                                              @D369DVB 01400000
*--------------------------------------------------------------@D369DVB 01450000
.* /* START OF SPECIFICATIONS ***************************************** 01500000
.*                                                                      01550000
.*01* MODULE NAME = SGSLDUP                                             01600000
.*                                                                      01650000
.*01* MODULE TYPE = SUPERVISOR GENERATION MACRO                         01700000
.*                                                                      01750000
.*01* DESCRIPTIVE NAME = SLD UPDATE ROUTINES FOR SHARED DASD SUPPORT    01800000
.*                                                                      01850000
.*01* CHANGE ACTIVITY = AS FOLLOWS                                      01900000
.*              DASD SHARING SUPPORT                           @D36SDVB 01950000
.*              NLIB SUPPORT                                   @D14CDVB 02000000
.*              SOFTWARE RE-IPL                                @D31QDHB 02050000
.*                                                                      02100000
.* A000000-999999                                              @D36SDVB 02150000
.*** END OF SPECIFICATIONS *******************************************/ 02200000
.*                                                             @D369DVB 02250000
         AIF   (NOT &BGDEBUG OR NOT &SGSLDUP).NOPRINT          @D37ZDVB 02300000
         PRINT GEN                                             @D37ZDVB 02350000
.NOPRINT ANOP                                                  @D37ZDVB 02400000
&COUNT   SETA  10                                              @D36SDVB 02450000
&LBR0SCO SETA  1                       SUPPRESS GENERATION OF  @D14CDHD*02500000
                                       DSECT SYSCOM IN INLMLAMB         02550000
         AIF   ('&TAB' EQ 'NO').NOTAB                          @D36SDVB 02600000
 TITLE 'DOS SUPERVISOR      SGSLDUP    CONTROL TABLES         ** 09/05/*02650000
               83 **'                                          @D14CDVB 02700000
         SPACE 1                                                        02750000
*-------------------------------------------------------------*@D14CDVB 02800000
         SPACE 1                                                        02850000
*-------------------------------------------------------------*@D14CDVB 02900000
         SPACE 1                                                        02950000
UPSLDSAV DS    CL72                SAVE AREA OF UPDSLD         @D14CDHD 03000000
SLDQUE   DS    0F                                              @D36SDVB 03050000
SLDACT   DC    A(0)                PTR TO ACTIVE SLDQUE ELEMENT@D36SDVB 03100000
SLDFREE  DC    A(SLDQUEBG)         PTR TO FIRST FREE ELEMENT   @D36SDVB 03150000
SLDQBEG  DC    A(SLDQUEBG)         PTR TO BEGIN OF SLDQUE      @D36SDVB 03200000
SLDQEND  DC    A(SLDQUEND)         PTR TO END OF SLDQUE        @D36SDVB 03250000
SLDQUEBG DS    0F                                              @D36SDVB 03300000
.SLDQ000 ANOP                                                  @D36SDVB 03350000
         DC    A(*+20),A(0),A(0),A(0),A(0) SLD QUEUE ELEMENT   @D14CDHD 03400000
&COUNT   SETA  &COUNT-1                                        @D36SDVB 03450000
         AIF   (&COUNT NE 0).SLDQ000                           @D36SDVB 03500000
         DC    A(0),A(0),A(0),A(0),A(0)   LAST ENTRY           @D14CDHD 03550000
SLDQUEND EQU   *                                               @D36SDVB 03600000
SLDERCNT DC    H'0'                LIBRARY FAILURE             @D36SDVB 03650000
         DC    H'0'                FREEVIS FAILURE             @D14CDVB 03700000
         DC    H'0'                LOCK FAILURE                @D14CDVB 03750000
         DC    H'0'                UNLOCK FAILURE              @D14CDVB 03800000
SLDERRST DC    F'0'                                            @D14CDVB 03850000
MULTFLAG DC    X'00'             INDICATES REQUESTOR           @D14CDHD 03900000
MULTON   EQU   X'01'             REQ. IS MULTIPHS              @D14CDHD 03950000
SLDFLAG  DS    X                                               @D14CDHD 04000000
SLDIND   EQU   X'01'             INDICATES IF SET, THAT THE    @D14CDHD*04050000
                                 DIR. BLOCK WAS FOUND BY SLD CHECK      04100000
SLDBACKL EQU   X'02'             INDICATES IF SET, THAT THE    @D14CDHD*04150000
                                 SLD HAS BACK LEVEL STATE               04200000
SLD1BLCK EQU   X'04'             INDICATES IF SET, THAT AT     @D14CDHD*04250000
                                 LEAST 1 DIR. BLOCK WAS ALREADY READ IN 04300000
SLDGREAT EQU   X'08'             INDICATES IF SET, THAT NO     @D14CDHD 04350000
*                                SEARCH ITEM (TYPE OR PHASE             04400000
*                                NAME) < SEARCH ARGUMENT IN THE         04450000
*                                LB; MIGTH BE EMPTY LB;                 04500000
         SPACE 1                                               @D36SDVB 04550000
*-------------------------------------------------------------*@D369DVB 04600000
         SPACE 1                                               @D36SDVB 04650000
*                                                              @D14CDHD 04700000
* CATCH COUNTERS FOR SLD UPDATE                                @D14CDHD 04750000
*                                                              @D14CDHD 04800000
         SPACE 1                                               @D36SDVB 04850000
SLDUPDC  DC    F'0'         COUNTS ALL SLD UPDATES             @D14CDHD 04900000
         SPACE 1                                               @D36SDVB 04950000
*-------------------------------------------------------------*@D369DVB 05000000
         SPACE 1                                               @D36SDVB 05050000
         INLMLAMB MF=MAP                                       @D14CDHD 05100000
         INLMLRPL MF=MAP                                       @D14CDHD 05150000
LAMBAREA DS    CL(LAMBLNG)                                     @D14CDHD 05200000
ALAMB    DC    A(LAMBAREA)                                     @D14CDHD 05250000
MSGAREA  DS    CL(121)                                         @D14CDHD 05300000
LRPLAREA DS    CL(LRPLLNG)                                     @D14CDHD 05350000
         SPACE 1                                               @D36SDVB 05400000
*-------------------------------------------------------------*@D369DVB 05450000
         SPACE 1                                               @D36SDVB 05500000
SUBLDSC  DS    CL(SLXELEN)       LIBRARY DESCRIPTOR            @D14CDHD 05550000
         SPACE 1                                               @D36SDVB 05600000
*-------------------------------------------------------------*@D369DVB 05650000
         SPACE 1                                               @D36SDVB 05700000
WAREA    DS    CL(RESNLEN)       INPUT OF INLMRESN             @D14CDHD 05750000
         SPACE 1                                               @D36SDVB 05800000
*-------------------------------------------------------------*@D369DVB 05850000
         SPACE 1                                               @D36SDVB 05900000
*--------------------------------------------------------------@D369DVB 05950000
         SPACE 1                                                        06000000
         AIF (NOT &BGDEBUG OR &SGAFCH OR NOT &SGSLDUP).PRTGEN0 @D14CDVB 06050000
         PRINT  NOGEN                                          @D37ZDVB 06100000
.PRTGEN0 ANOP                                                  @D37ZDVB 06150000
.NOTAB   AIF   ('&IAREA' EQ 'NO').UINP90                       @D36SDVB 06200000
         AIF   ( NOT &BG370).UINP45                            @D14CDVB 06250000
         ORG  SYSS00+((*+MAXLENLB-1-SYSS00)/MAXLENLB)*MAXLENLB @D14CDVB 06300000
.UINP45  ANOP                                                  @D14CDVB 06350000
SLDINP   DS    0D                                              @D14CDVB 06400000
         ORG   *+MAXLENLB+500                                  @D14CDHD 06450000
LENSLDBF EQU   *-SLDINP                                        @D14CDHD 06500000
         DC    XL1'0'                                          @D14CDVB 06550000
.UINP50  AIF   (NOT &BGDEBUG OR NOT &SGSLDUP).PRTGEN1          @D37ZDVB 06600000
         PRINT  NOGEN                                          @D37ZDVB 06650000
.PRTGEN1 ANOP                                                  @D37ZDVB 06700000
         SPACE 1                                               @D369DVB 06750000
*--------------------------------------------------------------@D369DVB 06800000
.UINP90  AIF   ('&ROUT' NE 'SLDIO' ).NOSLDIO                   @D14CDVB 06850000
 TITLE 'DOS SUPERVISOR      SGSLDUP(SLDIO)      SLD I/O       ** 02/04/*06900000
               81 **'                                          @D14CDVB 06950000
*-------------------------------------------------------------*@D149DVB 07000000
         AIF (NOT &BGDEBUG OR &SGDFCH OR NOT &SGSLDUP).PRTGEN2 @D14CDVB 07050000
         PRINT  NOGEN                                          @D37ZDVB 07100000
.PRTGEN2 ANOP                                                  @D37ZDVB 07150000
         AIF  (NOT &SGDFCH).NOSLDIO                            @D14CDVB 07200000
 TITLE 'DOS SUPERVISOR    SGDFCH    FETCH OVERALL LOGIC     '  @D14CDVB 07250000
.NOSLDIO AIF   ('&ROUT' NE 'ENQSLD').NOENQR                    @D36SDVB 07300000
 TITLE 'DOS SUPERVISOR      SGSLDUP(ENQSLD)     SLD UPDATE    ** 12/07/*07350000
               83 **'                                          @D14CDVB 07400000
*--------------------------------------------------------------@D369DVB 07450000
*     ROUTINE NAME: ENQSLD                                     @D369DVB 07500000
*     MODULE:       SGDFCH                                     @D369DVB 07550000
*     FUNCTION:     ENQUEUES REQUEST FOR UPDATING SLD INTO     @D369DVB 07600000
*                   THE SLDQUE.                                @D369DVB 07650000
*                   ACTIVATES THE SERVICE TASK IF NOT ALREADY  @D369DVB 07700000
*                   ACTIVE.                                    @D369DVB 07750000
*     CALLER:       SCANDIR (SGDFCH) / MULTIPHS (SGBFCH)       @D14CDHD 07800000
*     OPERATION:    SET 'SLD IN BACK LEVEL STATE' FLAG;        @D14CDHD 07850000
*                   DRPLADA = 0;                               @D14CDHD 07900000
*                   IF REQUEST IS FOR PARTITION CHAIN          @D14CDHD 07950000
*                      OR  SLD UPDATE IN PROCESS               @D14CDHD 08000000
*                      OR  NO SLD SPACE AVAILABLE              @D14CDHD 08050000
*                      OR  ERROR INDICATION SET                @D14CDHD 08100000
*                      THEN  RETURN;                           @D14CDHD 08150000
*                     IF  LIB=SYSLIB                           @D149DVB 08200000
*                         THEN PREPARE PSEUDE LOT-ENTRY        @D369DVB 08250000
*                     IF  REQUEST FOR SLD UPDATE IS ALREADY    @D14CDHD 08300000
*                         ENQUED                               @D369DVB 08350000
*                         THEN RETURN                          @D149DVB 08400000
*                     ENQUEUE REQUEST ELEMENT IN SLDQUE        @D149DVB 08450000
*                     CALL SERACT                              @D149DVB 08500000
*                     SET SERFLGPR=SERUPSLD                    @D149DVB 08550001
*                   ENDDO                                      @D149DVB 08600000
*                   END;                                       @D149DVB 08650000
*     INPUT:        --> REFERENCED DATA                        @D369DVB 08700000
*     OUTPUT:       ENTRY IN SLDQUE                            @D149DVB 08750000
*     CALLING SEQUENCE:                                        @D149DVB 08800000
*                   BAL  LINK1,ENQSLD                          @D149DVB 08850000
*                   B    AAAA         NORMAL RETURN            @D149DVB 08900000
*     RETURN CODES: NONE                                       @D369DVB 08950000
*     CALLED ROUTINE: SERACT                                   @D369DVB 09000000
*     RETURN:       CALLER                                     @D369DVB 09050000
*     ERROR EXITS:  NONE                                       @D369DVB 09100000
*     REFERENCED DATA: LOT (READ, EXTERNAL)                    @D149DVB 09150000
*                   FCHWORK (READ)                             @D149DVB 09200000
*-------------------------------------------------------------*@D369DVB 09250000
         SPACE 1                                                        09300000
         USING DFCB,RB             FETCH DATA AREA             @D14CDVB 09350000
         USING TCBADR,RA           TCB_FETCHWORK               @D14CDVB 09400000
ENQSLD   DS    0H                                              @D36SDVB 09450000
         STM   R1,RF,PSAVAR        SAVE ALL REG.               @D14CDHD 09500000
         BALR  R9,0                ESTABLISH BASE              @D14CDHD 09550000
         USING *,R9                                            @D14CDHD 09600000
         LA    R9,0(,R9)           AVOID PROBL. WITH AMODE=31  @D52VDMZ 09625001
         OI    SLDFLAG,SLDBACKL    INDICATE BACK LEVEL SLD     @D14CDHD 09650000
         L     R5,SLDUPDC                                      @D14CDHD 09700000
         LA    R5,1(R5)                                        @D14CDHD 09750000
         ST    R5,SLDUPDC                                      @D14CDHD 09800000
         USING DRPL,R1                                         @D14CDHD 09850000
         SR    R5,R5                                           @D14CDHD 09900000
         ST    R5,DRPLADA          RESET DRPLADA               @D14CDHD 09950000
         DROP  R1                                              @D14CDHD 10000000
         AGO   .NOGEN00                                        @D21ZDVB 10050000
         L     R5,DS1STCHN         ADDR (ACTUAL CHAIN ENTRY )  @D14CDVB 10100000
         USING DSRCHN,R5                                       @D36SDVB 10150000
         CLI   DSRCHID3,SCDLPRT    REQUEST FOR PARTITION CHAIN         *10200000
                                      OR IJSYSRES.SYSLIIB      @D14CDVB 10250000
         DROP  R5                                              @D36SDVB 10300000
         BH    ESLDSAV                                         @D14CDHD 10350000
.NOGEN00 ANOP                                                  @D21ZDVB 10400000
         L     R4,DFWKASLB         ADDR (SUBLIB_DEF_TAB)       @D14CDVB 10450000
         USING INLCSDTE,R4                                     @D14CDVB 10500000
         TM    SDTEFLAG,SDTENOAC+SDTEINCX SLD UPDATE IN PROCESS...     *10550000
                                   ...OR NO SLD SPACE          @D14CDVB 10600000
         BNZ   ESLDSAV                                         @D14CDHD 10650000
         TM    SDTESTAT,SDTELBER+SDTEITER  ERROR INDICATION    @D14CDVB 10700000
         BNZ   ESLDSAV             YES --> (RETURN WITHOUT ANY @D14CDHD*10750000
                                            ENQUEUING)         @D36SDVB 10800000
         DROP  R4                                              @D14CDVB 10850000
*--------------------------------------------------------------@D36SDVB 10900000
.*DEL    L     R4,DFWK2NDL         PROVIDE SECOND LEVEL CHAIN  @D14CDVB 10950000
         LA    R1,SLDQUE           POINT TO SLDQUE             @D36SDVB 11000000
         USING SLDQUE,R1                                       @D36SDVB 11050000
         L     R2,SLDFREE          FREE ELEMENT PTR            @D36SDVB 11100000
         LTR   R2,R2               ANY                         @D36SDVB 11150000
         BZ    ESLDSAV             NO ---> (RETURN WITHOUT REQUESTING  *11200000
                                            ANY WORK TO DO)    @D14CDHD 11250000
.*DEL    LTR   R4,R4               REQUEST FOR SYSLIB          @D14CDVB 11300000
.*DEL    BNZ   ESLD020             NO --->                     @D36SDVB 11350000
ESLD020  L     R3,SLDACT           ACTIVE QUEUE PTR            @D36SDVB 11400000
         SLR   R5,R5                                           @D36SDVB 11450000
ESLD030  LTR   R3,R3                                           @D36SDVB 11500000
         BZ    ESLD060             NO ACTIVE ENTRY --->        @D36SDVB 11550000
         USING SLDQUENT,R3                                     @D36SDVB 11600000
         L     R0,SLDSDT           CHECK IF SUBLIBRARY ALREADY @D14CDVB 11650000
         C     R0,DFWKASLB             ENQUEUED                @D14CDVB 11700000
         BE    ESLDSAV             YES --> (RETURN WITHOUT ANY @D14CDHD*11750000
                                            ENQUEUING)         @D36SDVB 11800000
         LR    R5,R3               SAVE ADDRESS OF QUEUE ELEM. @D36SDVB 11850000
         L     R3,SLDQPTR          PTR TO NEXT SLDQUE ELEMENT  @D36SDVB 11900000
         B     ESLD030                                         @D36SDVB 11950000
*-------------------------------------------------------------*@D369DVB 12000000
ESLD060  LR    R3,R2               NEXT FREE SLDQUEUE ENTRY    @D36SDVB 12050000
         L     R2,SLDQPTR          NEW FREE ELEMENT            @D36SDVB 12100000
         ST    R2,SLDFREE              INTO FREE QUEUE HEADER  @D36SDVB 12150000
         SLR   R0,R0                                           @D36SDVB 12200000
         ST    R0,SLDQPTR          INDICATE LAST ELEMENT IN ACTIVE     *12250000
                                       QUEUE                   @D36SDVB 12300000
         CLR   R5,R0               FIRST ACTIVE QUEUE ELEMENT  @D36SDVB 12350000
         BNE   ESLD070             NO  -->                     @D36SDVB 12400000
         LA    R5,SLDACT                                       @D36SDVB 12450000
ESLD070  ST    R3,SLDQPTR-SLDQUENT(R5) QUEUE ELEMENT AS LAST ONE IN THE*12500000
                                   ACTIVE QUEUE INCL. SLDACT   @D36SDVB 12550000
         ST    R4,SLDLOTE          PROVIDE PTR TO ORIGINAL LOT @D36SDVB 12600000
         L     R0,DFWKASLB         @SUBLIB_DEF_TAB             @D14CDHD 12650000
         ST    R0,SLDSDT                                       @D14CDHD 12700000
         L     R4,DFWKALIB         @LIB_DEF_TAB                @D14CDHD 12750000
         USING INLCLDTE,R4                                     @D14CDHD 12800000
         CLI   LDTENTID,C'C'       IF LDTENTID='C'             @D14CDHD 12850000
         BNE   ESLD075                                         @D14CDHD 12900000
         ST    R4,SLDLDTCE         THEN SLDLDTCE=@LIB_DEF_TAB  @D14CDHD 12950000
         SR    R0,R0                                           @D14CDHD 13000000
         ST    R0,SLDLDTPE              SLDLDTPE=0             @D14CDHD 13050000
         B     SLDCONT                                         @D14CDHD 13100000
*                                                              @D14CDHD 13150000
ESLD075  CLI   LDTENTID,C'P'       IF LDTENTID='P'             @D14CDHD 13200000
*        BNE   SLDERR                                          @D14CDHD 13250000
         L     R0,LDTEPADR                                     @D14CDHD 13300000
         ST    R0,SLDLDTCE         THEN SLDLDTCE=@C-ENTRY      @D14CDHD 13350000
         ST    R4,SLDLDTPE              SLDLDTPE=@LIB_DEF_TAB  @D14CDHD 13400000
*-------------------------------------------------------------*@D36SDVB 13450000
SLDCONT  L     R4,ASVTTIB          ADDR (SERVICE_TASK_TAB)     @D14CDVB 13500000
         L     R6,DISPAD                                       @D36SDVB 13550000
         USING DISP,R6                                         @D36SDVB 13600000
         USING TIBADR,R4                                       @D14CDVB 13650000
         CLI   TIBRQID,SYSBND      SERVICE TASK ACTIVE         @D14CDVB 13700000
         BNE   ESLD080             YES --->                    @D36SDVB 13750000
         L     R8,ASVTTIB      FOR POST SVT, R8=DISPAD IS ALR. @D14BDBC 13800000
         BAL   RF,POST-DISP(R6)    POST SVT                    @D14BDBC 13850000
*SGLINK POST,INPUT=(R6,R8,RF),WORK=(RE)                        @D14BDBC 13900000
ESLD080  L     R4,BASESERI         BASE FOR SERVICE TASK       @D36SDVB 13950000
         OI    SERFLGPR-SGSERI(R4),SERUPSLD SET SDL  WORK-TO-DO        *14000001
                                          INDICATION           @D36SDVB 14050000
         DROP  R1,R3,R4,R6                                     @D36SDVB 14100000
ESLDSAV  LM    R1,RF,PSAVAR        RELOAD REGISTERS            @D14CDHD 14150000
         BR    LINK3               RETURN                      @D14CDHD 14200000
*-------------------------------------------------------------*@D369DVB 14250000
     AIF (NOT &BGDEBUG OR     &SGBFCH OR NOT &SGSLDUP).PRTGEN7 @D14CDVB 14300000
         PRINT  NOGEN                                          @D37ZDVB 14350000
.PRTGEN7 ANOP                                                  @D37ZDVB 14400000
.NOENQR  ANOP                                                  @D36SDVB 14450000
         AIF   ('&ROUT' NE 'UPDSLD').NOUPDR                    @D36SDVB 14500000
  TITLE  'DOS SUPERVISOR       SGSLDUP(UPDSLD)      SLD UPDATE   ** 07/*14550000
               22/81 **'                                       @D14CDVB 14600000
*--------------------------------------------------------------@D369DVB 14650000
*     ROUTINE NAME: UPDSLD                                     @D369DVB 14700000
*     MODULE:       SGSER                                      @D369DVB 14750000
*     FUNCTION:     UPDATES SLD OF REQUESTED CIL               @D369DVB 14800000
*     CALLER:       SERTASK                                    @D369DVB 14850000
*     OPERATION:    LOCK LCTABLES                              @D149DVB 14900000
*                   IF  SUCCESSFULL                            @D149DVB 14950000
*                   THEN DO WHILE ACTIVE SLDQUE ¬EOL           @D149DVB 15000000
*                     SLDQ_ELEM := GETNEXT (SLDQUE)            @D149DVB 15050000
*                     GET_SLD_SPACE                            @D149DVB 15100000
*                     IF SLD_SPACE = ¬ EOS   /END OF SPACE /   @D149DVB 15150000
*                     THEN LOCK (SUBLIBRARY)                   @D149DVB 15200000
*                       IF LOCK SUCCESSFULL                    @D369DVB 15250000
*                         THEN FIND (SUBLIB_INDEX_ENTRY)       @D149DVB 15300000
*                           UPDATE (SUBLIB_DEF_TAB(SDTEXRBA,   @D149DVB 15350000
*                                                  SDTEXLEV)   @D149DVB 15400000
*                           FIND (PHASE_SUBLIBRARY)            @D149DVB 15450000
*                           ENQUEUE (SLD,SLD_SPACE)            @D149DVB 15500000
*                           DO WHILE ¬ END_OF_DIRECTORY        @D149DVB 15550000
*                              SLD_ENTRY := GETNEXT (SLD)      @D149DVB 15600000
*                              GETNEXT (DIRECTORY_LB)          @D149DVB 15650000
*                              SLD_ENTRY := HIGH_PHASE(LB)_RBA @D14CDVB 15700000
*                           ENDDO                              @D149DVB 15750000
*                           FREE_SPACE (OLD SLD_SPACE)         @D149DVB 15800000
*                         UNLOCK SUBLIBRARY                    @D149DVB 15850000
*                       ELSE FREE_SPACE (SLD_SPACE)            @D149DVB 15900000
*                       ENDIF                                  @D149DVB 15950000
*                     DEQUEUE REQUEST (SLDQUEUE ENTRY)         @D149DVB 16000000
*                   ELSE                                       @D149DVB 16050000
*                   ENDIF                                      @D149DVB 16100000
*                   RESET SERFLGPR(SERUPSLD)                   @D369DVB 16150001
*                   UNLOCK CLDTABL                             @D369DVB 16200000
*                   END;                                       @D149DVB 16250000
*     INPUT:        SLDQUE                                     @D369DVB 16300000
*     OUTPUT:       UPDATED SLD                                @D369DVB 16350000
*     RETURN CODES: NONE                                       @D369DVB 16400000
*     CALLED ROUTINE:                                          @D149DVB 16450000
*     RETURN:       SERTASK                                    @D369DVB 16500000
*     ERROR EXITS:  HARDWAIT X'FF6' IN DEBUG MODE              @D149DVB 16550000
*     REFERENCED DATA:                                         @D369DVB 16600000
*                   LIBRARY_DEFINITION_TABLE, EXTENT_DEF_TAB,  @D149DVB 16650000
*                   DEVICE_DEF_TAB (READ,EXTERNAL)             @D149DVB 16700000
*                   SUBLIB_DEF_TAB, SLD, TFIXIDEN (UPDATE,EXT) @D149DVB 16750000
*-------------------------------------------------------------*@D369DVB 16800000
         SPACE 1                                                        16850000
*-------------------------------------------------------------*@D14CDVB 16900000
*     ACTIVATE SERVICE TASK  AND LOCK LIBRARIAN_CONTROL_TABLES*@D14CDVB 16950000
*-------------------------------------------------------------*@D14CDVB 17000000
         SPACE 1                                                        17050000
UPDSLD   DS    0H                  ENTRY POINT                 @D36SDVB 17100000
         LR    R9,RF               LOAD BASE REGISTER          @D14CDHD 17150000
         USING UPDSLD,R9           ESTABLISH BASE REGISTER     @D14CDHD 17200000
         LA    R4,ARTID            OWNER OF SVT TASK IS AR     @D36SDVB 17250000
* SGSETUP SWOWNER,STASK=SVT,WR1=R4,WR2=R3,OPTION=SETOWNER      @D149DBC 17300000
  SGSETUP SWOWNER,STASK=SVT,WR1=R4,WR2=R3,OPTION=SETOWNER      @D149DBC 17350000
         L     RB,AFCHDAT          PTR TO FETCH DATA SECTION   @D36SDVB 17400000
         L     RA,TCBPTR           ADDR OF SERVICE TASK TCB    @D14CDVB 17450000
         USING DFCB,RB             PROVIDE ADDRESSIBILITY      @D36SDVB 17500000
         USING TCBADR,RA                                       @D14CDVB 17550000
         LA    RD,UPSLDSAV         SAVE AREA ADDRESS           @D14CDVB 17600000
         SR    RE,RE               CLEAR REG. E                @D14CDHD 17650000
         SPACE 1                                                        17700000
*-------------------------------------------------------------*@D14CDVB 17750000
*                                                              @D14CDHD 17800000
* BUILD INTERFACE TABLES TO LIBRARIAN                          @D14CDHD 17850000
*                                                              @D14CDHD 17900000
         SPACE 1                                               @D14CDHD 17950000
*        INLMLAMB MF=GEN,                                      @D14CDHD 18000000
*              AREA=LAMBAREA,                                  @D14CDHD 18050000
*              SBUFADR=SLDINP,                                 @D14CDHD 18100000
*              SBUFLEN=LENSLDBF,                               @D14CDHD 18150000
*              GETVIS=SYSTEM,                                  @D14CDHD 18200000
*              LOCK=RETURN,                                    @D14CDHD 18250000
*              LSTAREA=MSGAREA,                                @D14CDHD 18300000
*              LSTLEN=121                                      @D14CDHD 18350000
*                                                                       18400000
*        INLMLRPL MF=GEN,                                      @D14CDHD 18450000
*              AREA=LRPLAREA,                                  @D14CDHD 18500000
*              LAMB=LAMBAREA,                                  @D14CDHD 18550000
*              PBUFADR=SLDINP,                                 @D14CDHD 18600000
*              PBUFLEN=LENSLDBF,                               @D14CDHD 18650000
*              ARG=SUBLDSC                                     @D14CDHD 18700000
*                                                                       18750000
         INLMLAMB MF=GEN,                                      @D14CDHD*18800000
               AREA=LAMBAREA,                                  @D14CDHD*18850000
               SBUFADR=SLDINP,                                 @D14CDHD*18900000
               SBUFLEN=LENSLDBF,                               @D14CDHD*18950000
               GETVIS=SYSTEM,                                  @D14CDHD*19000000
               LOCK=RETURN,                                    @D14CDHD*19050000
               LSTAREA=MSGAREA,                                @D14CDHD*19100000
               LSTLEN=121                                      @D14CDHD 19150000
*                                                                       19200000
         INLMLRPL MF=GEN,                                      @D14CDHD*19250000
               AREA=LRPLAREA,                                  @D14CDHD*19300000
               LAMB=LAMBAREA,                                  @D14CDHD*19350000
               PBUFADR=SLDINP,                                 @D14CDHD*19400000
               PBUFLEN=LENSLDBF,                               @D14CDHD*19450000
               ARG=SUBLDSC                                     @D14CDHD 19500000
*                                                                       19550000
UPSLD010 L     R4,SLDACT                                       @D14CDHD 19600000
         LTR   R4,R4               NO ACTIVE ENTRY IN SLDQUE?  @D14CDHD 19650000
         AIF   (NOT &BGDEBUG).FDEBG30                          @D14CDHD 19700000
         BZ    UPDHARDW            YES --->  HARDWAIT IF DEBUG @D14CDHD 19750000
         AGO   .FDEBG40                                        @D14CDHD 19800000
.FDEBG30 ANOP                                                  @D14CDHD 19850000
         BZ    UPDEXT              YES --->  EXIT SLDUPD       @D14CDHD 19900000
.FDEBG40 ANOP                                                  @D14CDHD 19950000
         USING SLDQUENT,R4                                     @D14CDHD 20000000
         LA    R1,LRPLAREA       @LRPL                         @D14CDHD 20050000
         USING INLCLRPL,R1                                     @D14CDHD 20100000
         LA    R2,SUBLDSC        @SUBLIB DESCRIPTOR            @D14CDHD 20150000
         ST    R2,LRPLSLXE                                     @D14CDHD 20200000
         DROP  R1                                              @D14CDHD 20250000
*        INLMSCON RPL=LRPLAREA,    CONNECT  SUBLIB             @D14CDHD*20300000
               LIBINFO=SLACTIFO                                         20350000
         INLMSCON RPL=LRPLAREA,    CONNECT  SUBLIB             @D14CDHD*20400000
               LIBINFO=SLACTIFO                                         20450000
*                                                              @D14CDHD 20500000
*  RETURN CODES OF INLMSCON:                                   @D14CDHD 20550000
*        0:  OK                                                @D14CDHD 20600000
*        4:  SUBLIB ALREADY CONNECTED                          @D14CDHD 20650000
*        8:  SUBLIB DOES NOT EXIST                             @D14CDHD 20700000
*       12:  ?                                                 @D14CDHD 20750000
*       16:  F. EX. SYSTEM GETVIS SPACE EXHAUSTED              @D14CDHD 20800000
*       20:  INTERNAL ERROR                                    @D14CDHD 20850000
*                                                              @D14CDHD 20900000
         LTR   RF,RF             TEST INLMSCON RETURN CODE     @D14CDHD 20950000
         BZ    UPDGRES           IF ZERO, CONTINUE             @D14CDHD 21000000
         LA    RE,FCONID         INDICATE ERROR AFTER INLMSCON @D14CDHD 21050000
         B     UPDATERR          BRANCH TO ERROR HANDLING ROUT.@D14CDHD 21100000
         SPACE 1                                               @D14CDHD 21150000
*                                                              @D14CDHD 21200000
*  GET RESOURCE NAME                                           @D14CDHD 21250000
*                                                              @D14CDHD 21300000
         SPACE 1                                               @D14CDHD 21350000
UPDGRES  SR    R2,R2                                           @D14CDHD 21400000
         L     R3,SLDSDT           @SUBLIB_DEF_TAB             @D14CDHD 21450000
         USING INLCSDTE,R3                                     @D14CDHD 21500000
         INLMRESN AREA=WAREA,                                  @D14CDHD*21550000
               LAMBAD=ALAMB,                                   @D14CDHD*21600000
               LDTEAD=SLDLDTCE,                                @D14CDHD*21650000
               PRBN=SDTEDRBP,                                  @D14CDHD*21700000
               RESARG=ARESAREA                                 @D14CDHD 21750000
         DROP  R3,R4                                           @D14CDHD 21800000
         SPACE 1                                                        21850000
*                                                              @D14CDHD 21900000
*  RETURN CODES OF INLMRESN:                                   @D14CDHD 21950000
*        0:  OK                                                @D14CDHD 22000000
*       12:  EXTENT NOT AVAILABLE --> WRONG INPUT LB#          @D14CDHD 22050000
*       16:  INTERNAL ERROR                                    @D14CDHD 22100000
*       20:  INTERNAL ERROR                                    @D14CDHD 22150000
*                                                              @D14CDHD 22200000
         SPACE 1                                                        22250000
         LTR   RF,RF             TEST INLMRESN RETURN CODE     @D14CDHD 22300000
         BZ    UPDLOCK           IF ZERO, CONTINUE             @D14CDHD 22350000
         LA    RE,FRESID         INDICATE ERROR AFTER LOCK     @D14CDHD 22400000
         B     UPDATERR          BRANCH TO ERROR HANDLING ROUT.@D14CDHD 22450000
*                                                              @D14CDHD 22500000
UPDLOCK  LA    R2,RESAREA                                      @D14CDHD 22550000
         USING INLCRESN,R2                                     @D14CDHD 22600000
         MVC   CLIBRES+4(12),RESNAME   MOVE RES. NAME INTO DTL @D14CDHD 22650000
         LA    R1,CLIBRES                                      @D14CDHD 22700000
*        LOCK  (1),FAIL=RETURN                                 @D14CDHD 22750000
         LOCK  (1),FAIL=RETURN                                 @D14CDHD 22800000
         LTR   RF,RF             TEST LOCK RETURN CODE         @D14CDHD 22850000
         BZ    UPDMACRO          IF ZERO, CONTINUE             @D14CDHD 22900000
         LA    RE,FLOCKID        INDICATE ERROR AFTER LOCK     @D14CDHD 22950000
         B     UPDATERR          BRANCH TO ERROR HANDLING ROUT.@D14CDHD 23000000
         SPACE 1                                                        23050000
*                                                              @D14CDHD 23100000
*        INLMSLD  RPL=LRPLAREA   BUILD SLD                     @D14CDHD 23150000
UPDMACRO INLMSLD  RPL=LRPLAREA   BUILD SLD                     @D14CDHD 23200000
*                                                              @D14CDHD 23250000
*  RETURN CODES OF INLMSLD:                                    @D14CDHD 23300000
*        0:  OK                                                @D14CDHD 23350000
*       16:  GETVIS ERROR - NO SLD BUILD                       @D14CDHD 23400000
*       20:  INTERNAL ERROR                                    @D14CDHD 23450000
*                                                              @D14CDHD 23500000
         LTR   RF,RF             TEST INLMSLD RETURN CODE      @D14CDHD 23550000
         BZ    UPDUNL            IF ZERO, CONTINUE             @D14CDHD 23600000
         LA    RE,FSLDUPID       INDICATE ERROR AFTER INLMSLD  @D14CDHD 23650000
         B     UPDATERR          BRANCH TO ERROR HANDLING ROUT.@D14CDHD 23700000
         SPACE 1                                               @D14CDHD 23750000
*                                                              @D14CDHD 23800000
*  UNLOCK SUBLIBRARY                                           @D14CDHD 23850000
*                                                              @D14CDHD 23900000
         SPACE 1                                               @D14CDHD 23950000
UPDUNL   LA    R1,CLIBRES                                      @D14CDHD 24000000
*        UNLOCK (1)                                            @D14CDHD 24050000
         UNLOCK (1)                                            @D14CDHD 24100000
         LTR   RF,RF             TEST UNLOCK RETURN CODE       @D14CDHD 24150000
         BZ    UPDDIS            IF ZERO, CONTINUE             @D14CDHD 24200000
         LA    RE,FUNLID         INDICATE ERROR AFTER UNLOCK   @D14CDHD 24250000
         B     UPDATERR          BRANCH TO ERROR HANDLING ROUT.@D14CDHD 24300000
*        INLMLDIS  RPL=LRPLAREA  DISCONNECT SUBLIB             @D14CDHD 24350000
UPDDIS   INLMLDIS  RPL=LRPLAREA  DISCONNECT SUBLIB             @D14CDHD 24400000
*                                                              @D14CDHD 24450000
*  RETURN CODES OF INLMLDIS:                                   @D14CDHD 24500000
*        0:  OK                                                @D14CDHD 24550000
*        4:  SUBLIB WAS NOT CONNECTED                          @D14CDHD 24600000
*       16:  ?                                                 @D14CDHD 24650000
*       20:  INTERNAL ERROR                                    @D14CDHD 24700000
*                                                              @D14CDHD 24750000
         LTR   RF,RF             TEST INLMDIS RETURN CODE      @D14CDHD 24800000
         BZ    DEQSLD            IF ZERO, CONTINUE             @D14CDHD 24850000
         LA    RE,FDISCID        INDICATE ERROR AFTER INLMDIS  @D14CDHD 24900000
         B     UPDATERR          BRANCH TO ERROR HANDLING ROUT.@D14CDHD 24950000
*-------------------------------------------------------------*@D149DVB 25000000
*     DEQUEUE SLDQUE ENTRY                                    *@D14CDVB 25050000
*-------------------------------------------------------------*@D149DVB 25100000
         SPACE 1                                               @D14CDHD 25150000
*                                                              @D14CDHD 25200000
* IF ANY ERROR OCCURRED, THEN UNLOCK AND DISCONNECT SUBLIB     @D14CDHD 25250000
* AND DEQUEUE SLD ENTRY                                        @D14CDHD 25300000
*                                                              @D14CDHD 25350000
         SPACE 1                                               @D14CDHD 25400000
DEQERR   LA    R1,CLIBRES                                      @D14CDHD 25450000
*        UNLOCK (1)                                            @D14CDHD 25500000
         UNLOCK (1)                                            @D14CDHD 25550000
*        INLMLDIS  RPL=LRPLAREA  DISCONNECT SUBLIB             @D14CDHD 25600000
         INLMLDIS  RPL=LRPLAREA  DISCONNECT SUBLIB             @D14CDHD 25650000
         SPACE 1                                                        25700000
DEQSLD   DS    0H                                              @D36SDVB 25750000
*        CRSECT END=UPSLDEXT                                   @D14ZDVB 25800000
         CRSECT END=UPSLDEXT                                   @D36SDVB 25850000
         L     R2,SLDACT           GET CURRENT ELEMENT         @D36SDVB 25900000
         USING SLDQUENT,R2                                     @D36SDVB 25950000
         L     R0,SLDQPTR          NEXT ELEMENT IN             @D36SDVB 26000000
         ST    R0,SLDACT                ACTIVE QUEUE           @D36SDVB 26050000
         L     R1,SLDFREE          CHAIN ELEMENT IN FREE       @D36SDVB 26100000
         ST    R1,SLDQPTR                QUEUE                 @D36SDVB 26150000
         ST    R2,SLDFREE                                      @D36SDVB 26200000
         DROP  R2                                              @D36SDVB 26250000
         LTR   R0,R0                                           @D36SDVB 26300000
         BNZ   UPSLD010            MORE WORK TO DO             @D36SDVB 26350000
         SPACE 1                                                        26400000
*-------------------------------------------------------------*@D149DVB 26450000
*   ==========> THE NEXT TWO INSTRUCTIONS MUST BE BEFORE THE   @D14CDVB 26500000
*               SVC IN ORDER TO UPDATE SAVE AREA (SVT_TASK)    @D14CDVB 26550000
*               FOR CORRECT RE_ACTIVATION                      @D14CDVB 26600000
UPDEXT   L     R6,DISPAD           PROVIDE ADDR(DISPATCHER)    @D14CDVB 26650000
         L     RD,ASERTASK         RESET BASE                  @D14CDVB 26700000
         SVC   33                  DUMMY SVC TO STORE RD INTO  @D14CDHD*26750000
                                   THE SAVE AREA                        26800000
*        CRSECT END=UPSLDEXT                                   @D14ZDVB 26850000
RESTSLD  CRSECT END=UPSLDEXT                                   @D36SDVB 26900000
         L     RC,BASESERI         BASE TO SERVICE TASK INIT.  @D36SDVB 26950000
         NI    SERFLGPR-SGSERI(RC),XFF-SERUPSLD RESET SWITCH           *27000001
                                   INDICATING MORE SLD UPDATE  @D36SDVB 27050000
         USING SERTASK,RD          RE-ESTABLISH BASE           @D36SDVB 27100000
         B     SERTASK1            =====>       CHECK IF MORE WORK FOR *27150000
                                   SERVICE TASK                @D149DVB 27200000
         DROP  RD                                              @D14CDVB 27250000
UPSLDEXT EQU   *                                               @D14CDVB 27300000
         SPACE 2                                               @D14CDVB 27350000
*-------------------------------------------------------------*@D369DVB 27400000
*     ERROR EXIT ROUTINE                                      *@D149DVB 27450000
*-------------------------------------------------------------*@D369DVB 27500000
         SPACE 1                                               @D14CDVB 27550000
         USING UPDSLD,R9           RE-ESTABLISH BASE           @D36SDVB 27600000
UPDATERR DS    0H                                              @D14CDVB 27650000
         STH   RF,SLDERRST+2      STATUS INFO  (AS PASSED BY ...       *27700000
                                  ... SERVICES                 @D14CDVB 27750000
         STC   RE,SLDERRST        SERVICE_ID INTO STATUS INFO  @D14CDVB 27800000
         LH    R0,SLDERCNT(RE)    UPDATE...                    @D14CDVB 27850000
         AH    R0,H1              ...  ERROR...                @D14CDVB 27900000
         STH   R0,SLDERCNT(RE)    ...     COUNTER              @D14CDVB 27950000
         SPACE 1                                               @D14CDVB 28000000
         B     DEQERR                                          @D14CDHD 28050000
*                                                              @D14CDHD 28100000
UPDHARDW MVI   HWIDBYTE,HWCILUPD  INDICATE HW CODE             @D14CDVB 28150000
         L     R6,DISPAD                                       @D14CDVB 28200000
         MVI IJBHWORG,HWORG176    UNIQUE HARD WAIT ORIGINNATOR @D31QDHB 28250000
         B     HARDWAIT           =====>                       @D14CDVB 28300000
         EJECT                                                 @D149DVB 28350000
         LTORG                                                 @D66ODUL 28360001
*--------------------------------------------------------------@D369DVB 28400000
         SPACE 2                                               @D369DVB 28450000
    AIF (NOT &BGDEBUG OR  NOT &SGSLDUP).PRTGEN9                @D14CDVB 28500000
         PRINT  NOGEN                                          @D37ZDVB 28550000
.PRTGEN9 ANOP                                                  @D37ZDVB 28600000
.NOUPDR  ANOP                                                  @D36SDVB 28650000
         AIF   ('&DSECT' EQ 'NO').NODSECT                      @D36SDVB 28700000
*-------------------------------------------------------------*@D369DVB 28750000
         SPACE 1                                               @D14CDVB 28800000
.* SERUPSLD EQU   X'08'            SLD UPDATE SERVICE REQUEST  @D36SDVB 28850001
*                                                              @D14CDHD 28900000
FLOCKID  EQU   0                   LOCK_SERVICE ID             @D14CDVB 28950000
FUNLID   EQU   1                   UNLOCK_SERVICE ID           @D14CDVB 29000000
FRESID   EQU   2                   ID OF INLMRESN              @D14CDHD 29050000
FCONID   EQU   3                   ID OF INLMSCON              @D14CDHD 29100000
FSLDUPID EQU   4                   ID OF INLMSLD               @D14CDHD 29150000
FDISCID  EQU   5                   ID OF INLMDIS               @D14CDHD 29200000
*                                                              @D14CDHD 29250000
         SPACE 1                                               @D14CDVB 29300000
*-------------------------------------------------------------*@D369DVB 29350000
         SPACE 1                                               @D14CDVB 29400000
         INLCLACB                                              @D14CDHD 29450000
         INLCSACB                                              @D14CDHD 29500000
         INLCRESN                  DSECT OF RESOURCE NAME      @D14CDHD 29550000
         SPACE 1                                               @D14CDVB 29600000
*-------------------------------------------------------------*@D369DVB 29650000
         SPACE 1                                               @D14CDVB 29700000
SLDQUENT DSECT                                                 @D36SDVB 29750000
SLDQPTR  DS    A(0)                PTR TO NEXT QUEUED ELEMENT  @D36SDVB 29800000
SLDLOTE  DS    A(0)                POINTER TO LOT ENTRY        @D36SDHD 29850000
SLACTIFO EQU   SLDLOTE             START OF PAR. LIST FOR CONN.@D14CDHD 29900000
SLDLDTCE DS    A(0)                PTR TO LDT-C-ENTRY          @D36SDHD 29950000
*                                  = @LIB_DEF_TAB              @D14CDHD 30000000
*                                    IF LDTENTID = 'C'         @D14CDHD 30050000
*                                  = LDTEPADR (@C-ENTRY)       @D14CDHD 30100000
*                                    IF LDTENTID = 'P'         @D14CDHD 30150000
SLDLDTPE DS    A(0)                PTR TO LDT-P-ENTRY          @D36SDHD 30200000
*                                  = 0 IF LDTENTID = 'C'       @D14CDHD 30250000
*                                  = @LIB_DEF_TAB              @D14CDHD 30300000
*                                    IF LDTENTID = 'P'         @D14CDHD 30350000
SLDSDT   DS    A(0)                @SUBLIB_DEF_TAB             @D36SDHD 30400000
*-------------------------------------------------------------*@D369DVB 30450000
    AIF (NOT &BGDEBUG OR     &SGHFCH  OR NOT &SGSLDUP).PRTGENA @D14CDVB 30500000
         PRINT  NOGEN                                          @D14CDVB 30550000
.PRTGENA ANOP                                                  @D14ZDVB 30600000
.NODSECT ANOP                                                  @D36SDVB 30650000
         MEND                                                  @D36SDVB 30700000
