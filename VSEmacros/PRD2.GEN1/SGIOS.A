         MACRO                                                          00001000
         SGIOS                                                          00002000
         GBLA  &AG1          NUMBER OF I/O DEVICES             @D51GDAP 00003000
         GBLB  &BGDEBUG      DEBUGGING SERVICES                @D349DAP 00004000
         GBLB  &SGIOS        SGIOS PRINT CONTROL SWITCH        @D37DDAP 00005000
         GBLB  &VSE270       VERSION 2.7 SWITCH                @D27ADAP 00008000
         GBLB  &VSE280       VERSION 2.8 SWITCH                @DSCSI   00009000
         GBLB  &VSE410       VERSION CONTROL SWITCH            @D41ADAP 00009200
         GBLB  &TEST         TEST SWITCH                       @VTAPE   00009400
         GBLB  &VTAM31       VTAM-31 SWITCH                    @DY46396 00009790
         LCLB  &VSEMSG       MSG-STACK PROCESSING              @D25IDAP 00010000
&VSEMSG  SETB  1             ACTIVATE MSG STACK PROCESSING     @D66ADAP 00011000
         TITLE 'VSE SUPERVISOR     SGIOS     I/O PROCESSING SVC-S     ' 00012000
***************************************************************@D319DAP 00013000
*                                                              @D319DAP 00014000
*        LICENSED MATERIALS-PROPERTY OF IBM                    @D319DAP 00015000
*        THIS MACRO IS "RESTRICTED MATERIALS OF IBM"           @D319DAP 00016000
         AIF   (&VSE410).Y410000                                        00016700
*        5686-CF7 (C) COPYRIGHT IBM CORP 1977, 2005            @D319DAP 00017490
         AGO   .N410000                                                 00017590
.Y410000 ANOP                                                           00017690
*        5686-CF8 (C) COPYRIGHT IBM CORP 1977, 2005            @D319DAP 00017790
.N410000 ANOP                                                           00017890
*        SEE COPYRIGHT INSTRUCTIONS                            @D319DAP 00018000
*                                                              @D319DAP 00019000
***************************************************************@D319DAP 00020000
.* /* START OF SPECIFICATIONS ***************************************** 00021000
.*                                                                      00022000
.*01* MODULE-TYPE = SUPERVISOR GENERATION MACRO                         00023000
.*                                                                      00024000
.*01* DESCRIPTIVE NAME = I/O SUPERVISOR ROUTINES                        00025000
.*                                                                      00026000
.*01* NOTES = CHANGE ACTIVITY                                           00027000
.*    NEW MODULE - FIRST RELEASE 34                            @D34RDFG 00028000
.*    NEW SUBTASKING                                                    00029000
.*    PREVENT DATA TO BE READ FROM SYSRDR INSTEAD OF SYSIPT    @DA33344 00030000
.*    SOFTWAIT, MIH REQUEST WAS NOT STARTED                    @DA33656 00031000
.*    MSG4B44I ON RESET POLL WITH BTAM-CICS                    @DA33742 00032000
.*    SOFTWAIT ON SHUTD REPLY FOR NCCF                         @DA33986 00033000
.*    POWER JECL STMTS ARE NOT BEING PASSED TO POWER WHEN      @DA34616 00034000
.*       WRITTEN TO CONSOLE FOR WRITER-ONLY PARTITION          @DA34616 00035000
.*    SOFTWAIT AFTER SVC03, WHEN SYST I/O ACT FOR ENDING TASK  @DA34593 00036000
.*    STORAGE OVERLAY WHEN SVC0 FOR IGNLUB, WITH APPENDAGE ROUT@DA34451 00037000
.*    SVC76 VM-VSE INTERFACE CHANGED                           @DA35277 00038000
.*    NO ALTERNATE PATH SWITCHING OLTEP I/O REQUESTS           @DA35517 00039000
.*    DSK HQ REQUEST NOT PROPERLY QUEUED IN CASE OF MULTIPLE   @DA35838 00040000
.*    I/O ERRORS                                               @DA35838 00041000
.*    SOFT WAIT POWER QUEIESCE, PREREQ FOR POWER APAR DY35567  @DA35866 00042000
.*    SPE NEW FUNCTION, SUPPORT FOR D/T9370                    @D21ODAP 00043000
.*    DISABLED LOOP WHEN TERMINATOR CANCELED VIA PFLUSH WHILE  @DA36602 00044000
.*       SYSTEM TASK I/O REQUEST IS ACTIVE FOR TERMINATING TASK@DA36602 00045000
.*    UNATTENDED NODE SUPPORT                                  @D41XXAP 00046000
.*    ESA SUPPORT                                              @D51GDTP 00047000
.*    MORE DEVICES SUPPORT                                     @D51ODGL 00048000
.*    BTAM PARTITION IS SVC03 BOUND                            @DA39966 00049000
.*    HW FFB DUE TO SVC 3 NOT WAITING IF POST AT CE            @DA40222 00050000
.*    ALLOW 'CANCEL CUU' INSTEAD OF 'RC' FOR AR                @DA40195 00051000
.*    ACCEPT DEF.EXT OR RDC AS FIRST CCW FOR ANY DASD DEVICE   @DA40598 00052000
.*    INCREASED NUMBER OF RESERVED CHANQ ENTRIES               @DA41015 00053000
.*    PERMIT SVC03 TO BE ISSUED BY JOB CONTROL                 @DA41104 00054000
.*    DONT RESET PUB-BUSY IN CASE HDV/HSCH WAS ISSUED          @DA41121 00055000
.*    SVC27 (RESET POLL) CAUSES HANG IF RUNNING MODE=ESA       @DA40670 00056000
.*    SVC03 WRONG TID COMPARE; SVC25 WRONG CHANQ FOR OLTEP     @DA41253 00057000
.*    HARDWAIT FFF AFTER SVC 25, CCB NOT ADDRESSABLE           @DA41318 00058000
.*    HW FF5: CONSOLE I/O NOT COMPLETED AFTER END-OF-TASK      @DA41739 00059000
.*    ALLOW ATTENTION TASK TO USE SVC-15                       @DA41765 00060000
.*    ENSURE PROPER DEVICE RESTART IN CASE OF CANCEL CUU       @DA41772 00061000
.*    VIRTUAL DISK SUPPORT                                     @D52HDMK 00062000
.*    ACTION MSG FROM TAPE MANAGER NOT HIGHLIGHTED.            @DA41421 00063000
.*    USER SENSE AREA NOT VALIDATED                            @DA42602 00064000
.*    NO SENSE VALIDATION FOR EXCP REAL REQUESTS               @DA42683 00065000
.*    CHANQ CORRUPTION WHEN RESERVED CHANQ ENTRY IS MODIFIED   @DA42992 00066000
.*    ALLOW ICKDSF TO USE SYSFILE SUPPORT                      @DA43137 00067000
.*    SET TIME INTERVAL FOR SNS-REQUEST WHEN ENQUEUED          @DA43408 00068000
.*    NEW CONSOLE SUPPORT                                      @D61CSAP 00069000
.*    AUTOMATIC TAPE LIBRARY SUPPORT                           @D61ADRP 00070000
.*    QUEUE SVC-15 REQUESTS BEFORE SYSTEM TASK SVC-0 REQUESTS  @DA43415 00071000
.*    PROBP127 PROGRAM CHECK IN BTMOD CAUSED BY SVC25 ROUTINE           00072000
.*    USE SPECIAL GATE FOR VIRTUAL DISK BOUND                  @DA43510 00073000
.*    PREVENT PERMANENT SRQVDS-BOUND CONDITION                 @DA43697 00074000
.*    SET VTAM RESVCIO WHEN DISCONNECTED SYSLOG STILL IN USE   @DA43858 00075000
.*    PREVENT UNCONDITIONAL RESERVE TO BE ISSUED               @DA43914 00076000
.*    PREVENT HWFED DUE TO R7 NOT CONTAINING A CCW ADDRESS     @DA43979 00077000
.*    OSA SUPPORT                                              @DA44442 00078000
.*    PROVIDE FOR CANCEL CUU,FORCE COMMAND                     @DA44442 00079000
.*    PREVENT STORAGE OVERLAY AFTER CANCEL OF VTAM             @DA44364 00080000
.*    PREVENT H/W IN CASE OF ERP ACTIVE ON SVC-25 AND DEBUG ON @DA44462 00081000
.*    USE GETVIS,SPACE=YES FOR EXTENT SVC (SVC-104)            @DA44498 00082000
.*    ENSURE TASK TO BE SET SPOOL-BOUND WHEN RUNNING TURBO     @DA44547 00083000
.*    PROVIDE TD TUNING SWITCH ADDRESS IN RESIDENT CODE        @DA44616 00084000
.*    PROVIDE SPLEVEL INFORMATION                              @DA44634 00085000
.*    FORCE RESVCIO FOR ALL USER TASKS IF PMR IS CHANQ-BOUND   @DA44680 00086000
.*    REMOVE  RESET OF TLMECBSV IN SVC-03 ROUTINE              @DA44841 00087000
.*    BYPASS SVC-03 WAIT IF SVT IS SERVICING AR                @DA44841 00088000
.*    PREVENT HANG ON SVC-25 ATTEMPT WHEN STATUS PENDING/BUSY  @DA44841 00089000
.*    ALLOW ANY HEAD-QUEUE REQUEST TO SUPERCEEDE A QEDERR ENTRY@DA44841 00090000
.*    PREVENT PMR TO BE SET RESVC                              @DA44841 00091000
.*    DONT SET AR TASK SVC-3 BOUND IF SVT IS SERVICING AR      $DA45062 00092000
.*    PROVIDE INTERFACE FOR FLASH COPY FOR VSAM                @D25IDAP 00093000
.*    CORRECT THE BRANCH MASK FOR THE FORMAT-1 CCW             @DY45299 00094000
.*    FREE ALL EXTENT ENTRIES IN SPXTNT-SUBPOOL AT EOJ-TIME    @DY45385 00095000
.*    SET TASK CHQBND IN SVC-25 ROUTINE IF 2NDARY STATUS MISSNG@DY45385 00096000
.*    OVERLAY OF TIBSTATE AND TIBRQID DURING SVC-3 PROCESSING  @DY45AOM 00097000
.*    ALLOW TCP/IP TRACE FOR SERVER-TASK WHEN ACTIVE FOR SYSLOG@DY45789 00098000
.*    HARDWAIT FD0 ERR33 IF LOCK FILE ON FBA                   @DY46053 00099000
.*    HARDWAIT IF FORMAT-1 CCW AND DASD FILE PROTECT           @DY46203 00100000
.*    LOAD PIBPTR IN SVC03 ROUTINE (VENDOR REQUEST)            @DY46299 00100690
.*    BTAM WAITS AFTER A HALTIO, ADDITIONAL DE NECESSARY       @DY46541 00100790
.*    HARDWAIT IN GETPUB ROUTINE WITH BAD CCB FOR SVC25 SVC27  @DY46548 00100890
.*    HARDWAIT FEC SVT TASK DUE TO RQTE OVERLAY                @DY46496 00100940
.*                                                                      00101000
.**** END OF SPECIFICATIONS ***************************************** / 00102000
         SPACE 3                                                        00103000
         AIF   (NOT &SGIOS).NPRT010                                     00104000
         PRINT GEN                                             @D37DDAP 00105000
.NPRT010 ANOP                                                  @D37DDAP 00106000
         DC    C'SGIOS   '                                     @D14BDAP 00107000
         DC    C'DY46496 '        CHANGE ACTIVITY CODE         @DY46496 00108950
         USING SGIOS,RD           COMMON BASE FOR SGIOS        @D34RDFG 00109000
         USING DISP,R6            DISPATCHER BASE ADDR.        @D35EDAP 00110000
         USING TIBADR,R8          TIB BASE                     @D369DAP 00111000
         USING TCBADR,RA          TCB POINTER                  @D369DAP 00112000
         USING SVEARA,RB          SAVE AREA BASE               @D369DAP 00113000
SGIOS    L     RB,PIBPTR2         ADDRESS OF PIB               @D51GDAP 00114000
         USING PIB2ADR,RB         PIB2 BASE POINTER            @D36IDAP 00115000
         L     RB,PIBPCB          PCB BASE ADDRESS             @D51GDAP 00116000
         USING PCBADR,RB          PCB BASE POINTER             @D51GDAP 00117000
         L     RB,PCEPIB          PIB BASE ADDRESS             @D51GDAP 00118000
         USING PIBADR,RB          PIB BASE POINTER             @D51GDAP 00119000
         BR    RC                      ======================> @D34RDFG 00121000
AATTTAB  DC    0F'0'                                           @D61CDAP 00122000
CQEINUSE DC    A(0)               IN USE CHANQ ENTRIES         @D61CDAP 00123000
CQEHIGH  DC    A(0)               HIGH WATER MARK              @D61CDAP 00124000
CQDEVHI  DC    A(0)               HIGHEST DEVICE QUEUE MARK    @DAOM    00125000
CQDEVHIU DC    A(0)               HIGHEST DEVICE QUEUE UNIT    @DAOM    00126000
*                                 EXIT TO SVC 00                        00127000
*                                 EXIT TO SVC 03                        00128000
*                                 EXIT TO SVC 15,76                     00129000
*                                 EXIT TO SVC 25,27                     00130000
*                                 EXIT TO SVC 49                        00131000
*                                 EXIT TO SVC 53                        00132000
*                                 EXIT TO SVC 73                        00133000
*                                 EXIT TO SVC 103                       00134000
*                                 EXIT TO SVC 104                       00135000
         DROP  R8                 RELEASE TIB BASE POINTER     @D369DAP 00136000
         DROP  RA                 RELEASE TCB BASE POINTER     @D369DAP 00137000
         DROP  RB                 RELEASE PIB  BASE POINTER    @D369DAP 00138000
         DROP  R6                 RELEASE DISP BASE POINTER    @D369DAP 00139000
         DROP  RD                 RELEASE SGIOS BASE POINTER   @D369DAP 00140000
         TITLE 'VSE SUPERVISOR     SGIOS     I/O IGNORE PROCESSING    ' 00141000
.********************************************************************** 00142000
.*                                                                      00143000
.* FUNCTION-                                                            00144000
.*           SIMULATE SUCCESSFUL I/O OPERATION                          00145000
.* ENTRY POINT-                                                         00146000
.*           IGNLUB                                                     00147000
.* INPUT-                                                               00148000
.*           R1= ADDR OF INPUT CCB                                      00149000
.*           R3= ADDR OF PUB                                            00150000
.*           R6= ADDR OF DISPATCHER                                     00151000
.*           RA= ADDR OF TCB OF REQUESTOR                               00152000
.*           RB= ADDR OF PIB OF REQUESTOR                               00153000
.* OUTPUT-                                                              00154000
.*           USERS CCB IS UPDATED                                       00155000
.* LOGIC-                                                               00156000
.* SUB ROUTINES-                                                        00157000
.*           USERS APPENDAGE ROUTINE                                    00158000
.* EXITS-                                                               00159000
.*           TO DISPATCHER                                              00160000
.********************************************************************** 00161000
         USING SGIOS,RD           SGIOS BASE REGISTER          @D369DAP 00162000
         USING DISP,R6            DISP BASE REGISTER           @D369DAP 00163000
         USING CCBADR,R1          CCB POINTER                  @D34RDFG 00164000
         USING PUBADR,R3          PUB POINTER                  @D14BDAP 00165000
         USING TCBADR,RA          TCB POINTER                  @D36IDAP 00166000
         USING PIBADR,RB          PIB BASE POINTER             @D36IDAP 00167000
IGNLUB   NI    CCBCOM1,CLRCOM1    RESET PIOCS COMMUNIC. BITS   @D149DAP 00168000
         NI    CCBCOM2,CLRCOM2    RESET PIOCS COMMUNIC. BITS   @D149DAP 00169000
         XC    CCBSTA(2),CCBSTA   CLEAR STATUS BYTES IN CCB    @D14BDAP 00170000
         L     R8,CCBCCW          GET CCW ADDRESS              @D14BDAP 00171000
         LA    R8,8(,R8)          POINT BEHIND CCW             @D14BDAP 00172000
         ST    R8,CSW             UPDATE CSW IN LOW CORE       @D14BDAP 00173000
         MVI   DEVSTA,CHANEND+DEVEND  INDICATE ENDING STATUS   @D14BDAP 00174000
         MVI   CHNSTA,ZERO        CLEAR CHANNEL STATUS         @D14BDAP 00175000
         TM    PIBPUBAS,APPEN     IS APPENDAGE EXIT ALLOWED    @D51IDAP 00176000
         BNO   IGNPOST            NO                           @D149DAP 00177000
         TM    CCBBY3,APPEN       APPENDAGE ROUTINE PRESENT    @D149DAP 00178000
         BNO   IGNPOST            NO                           @D35ZDAP 00179000
         CLI   SVCIC,X'00'        IS REQUEST AN SVC 0          @DM06977 00180000
         BNE   IGNPST10           NO,                          @D149DAP 00181000
         TM    CCBCLS,BTAM        IS THIS A BTAM REQUEST       @D14BDAP 00182000
         BNO   IGNAPP             NO                           @D14BDAP 00183000
         L     RE,APMGMDAT        PAGE MANAGER DATA AREA BASE  @D35EDAP 00184000
         USING PMGMDATA,RE        PAGE MANAGER BASE POINTER    @D35EDAP 00185000
         L     R5,ASVPFREE        ADDRESS OF PFREE ROUTINE     @D35EDAP 00186000
         DROP  RE                 RELEASE PAGE MANAGER BASE    @DM06977 00187000
IGNAPP   L     R9,AINTER          GET BASE ADDRESS OF IOINTER  @D35IDAP 00188000
         USING INTRTN,R9          MAKE IOINTER ADDRESSABLE     @D35IDAP 00189000
         SLR   R0,R0              ENTERED FOR INTERRUPT        @D14CDAP 00190000
         SLR   R4,R4              NO CHANQ ENTRY AVAILABLE     @DA34451 00191000
.* N O T E:                                                             00192000
.*       IN CASE OF ASSGN,IGN APPENDAGE NEEDS 00FE IN REG 3    @D3CADAP 00193000
.*                                                                      00194000
         DROP  RD                 RELEASE SGIOS BASE           @D62OSAP 00195000
         L     RD,AGOAPPND        APPENDAGE ROUTINE ADDRESS    @D62OSAP 00196000
         BALR  RF,RD              EXECUTE USERS APPENDAGE      @D62OSAP 00197000
*SGLINK  GOAPPND,INPUT=(R0,R1,R3,R4,R9,RF),WORK=(R7,R8)        @D149DFG 00198000
         DROP  R9                 RELEASE IOINTER BASE         @D35IDAP 00199000
         L     RD,IOSBASE         RESTORE SGIOS BASE POINTER   @D21SAAP 00200000
         USING SGIOS,RD           SGIOS BASE POINTER           @D369DAP 00201000
         B     IGNPST10           DONT UPDATE CCSW ADDRESS     @D14BDAP 00202000
IGNPOST  L     R8,CSW             GET ADDRESS OF CSW           @D14BDAP 00203000
         TM    CCBBY3,CCWABOVE    CCW ABOVE THE LINE           @D68ADAP 00204000
         BZ    IGNPST05           NO,                          @D66ADAP 00205000
         LA    R8,8               OFFSET OF FAILING CCW        @D66ADAP 00206000
IGNPST05 STCM  R8,7,CCBCSWW       SAVE ADDRESS IN CCB          @D14BDAP 00207000
IGNPST10 MVC   CCBSTA,DEVSTA      COPY STATUS TO USERS CCB     @D149DAP 00208000
         OI    CCBCOM1,TRABIT     POST TRAFIC BIT              @D14BDAP 00209000
         TM    CCBBY3,IORBEXT     IS AN EXTENSION PRESENT      @D35EDEP 00210000
         BZ    IGNEXIT            NO, DONT NEED TO POST ECB    @D149DAP 00211000
         TM    CCBCLS,CCBIORB     IS THIS AN IORB              @D35IDAP 00212000
         BZ    IGNEXIT            NO, MUST BE CCB WITH SENSE   @D149DAP 00213000
.*                                                             @D35IDAP 00214000
.*       THE FOLLOWING CODE MUST BE USED IF MORE THAN          @D35IDAP 00215000
.*       ONE IORB EXTENTION IS USED.                           @D35IDAP 00216000
.*       R0    MUST CONTAIN THE EXTENTION ID WHICH WILL        @D35IDAP 00217000
.*             BE USED AS SEARCH ID                            @D35IDAP 00218000
.*       R7    LINK REGISTER                                   @D35IDAP 00219000
.*       R8    WILL CONTAIN ADRRES OF ID FIELD IN IORB         @D35IDAP 00220000
.*             OR ZERO IF GIVEN ID WAS NOT FOUND IN CHAIN      @D35IDAP 00221000
.*                                                             @D35IDAP 00222000
         AGO   .SKIP010                                        @D35IDAP 00223000
         SLR   R0,R0              ECB-EXTENSION ID             @D35EDEP 00224000
         BAL   R7,IGNLEXTS        FIND ECB EXTENSION IF ANY    @D35EDEP 00225000
         LTR   R8,R8              ONE FOUND                    @D35EDEP 00226000
         BZ    IGNEXIT            NO,                          @D149DAP 00227000
.SKIP010 ANOP                                                  @D35IDAP 00228000
         L     R8,IORBEID         GET ECB ADDRESS              @D35EDEP 00229000
         OI    2(R8),TRABIT       POST ECB EXTENSION           @D35EDEP 00230000
IGNEXIT  BR    R6                      ====================>>> @D369DAP 00231000
.*                                                             @D35IDAP 00232000
.*       THE FOLLOWING ROUTINE SHOULD BE ACTIVATED IF MORE     @D35IDAP 00233000
.*       IORB EXTENTIONS ARE REQUESTED.                        @D35IDAP 00234000
.*                                                             @D35IDAP 00235000
         AGO   .SKIP020                                        @D35IDAP 00236000
         SPACE 2                                                        00237000
IGNLEXTS LA    R8,IORBEVAR        POINT AT FIRST EXTENSION              00238000
IGNLEX10 TM    0(R8),X'80'        IS THIS THE LAST ONE?                 00239000
         BZ    IGNLEX20           NO, R0 IS OK                          00240000
         AH    R0,H128            YES, ACCOUNT FOR FLAG BIT             00241000
IGNLEX20 CLM   R0,1,0(R8)         IS THIS THE EXTENSION NEEDED          00242000
         BER   R7                 YES, ======================>          00243000
         TM    0(R8),X'80'        END OF LIST                           00244000
         BO    IGNLEX30           YES, RETURN                           00245000
         LA    R8,4(R8)           NO, LOOK AT NEXT                      00246000
         B     IGNLEX10           CONTINUE SEARCH                       00247000
IGNLEX30 SLR   R8,R8              SET RETURN CODE- NOT FOUND            00248000
         BR    R7                      ======================>          00249000
.SKIP020 ANOP                                                  @D35IDAP 00250000
         DROP  R1                 RELEASE CCB BASE             @D36IDAP 00251000
         DROP  R3                 RELEASE PUB BASE             @D14BDAP 00252000
         DROP  RA                 RELEASE TCB BASE             @D36IDAP 00253000
         DROP  RB                 RELEASE PIB BASE             @D36IDAP 00254000
         DROP  R6                 RELEASE DISP BASE            @D36IDAP 00255000
         DROP  RD                 RELEASE SGIOS BASE           @D36IDAP 00256000
         TITLE 'VSE SUPERVISOR     SGIOS     LUB / PUB ALLOCATION     ' 00257000
.********************************************************************** 00258000
.*                                                                      00259000
.* FUNCTION-                                                            00260000
.*           VALIDATE USERS PARAMETERS AND ALLOCATE A PUB.              00261000
.* ENTRY POINT-                                                         00262000
.*           GETPUB    FROM SVC0,15,25,27,35,36,76                      00263000
.*           GETPV100  FROM SVC103                                      00264490
.* INPUT-                                                               00265000
.*           R1= ADDR OF CCB                                            00266000
.*           RB= ADDR OF PIB OF REQUESTOR                               00267000
.*           RE= LINK REGISTER                                          00268000
.* OUTPUT-                                                              00269000
.*           R5=                                                        00270000
.*              BYTE 0 STORAGE PROTECTION KEY                           00271000
.*              BYTE 1 PROCESSING FLAGS                                 00272000
.*              BYTE 2 LUB INDEX WITHIN PARTION LUB TABLE               00273000
.*           R3= ADDR OF PUB                                            00274000
.* REGS USED-                                                           00275000
.*           R8= SUBRTN LINKAGE                                         00276000
.*           R2= SUBRTN PARM REG, WORK REG TO CALC PUB ADDR.            00277000
.*           R9= ADDR OF PART. COMM REGION                              00278000
.* LOGIC-                                                               00279000
.* SUB ROUTINES-                                                        00280000
.*           VALID- TO CHECK CCB/IORB ADDRESS                           00281000
.* EXITS NORMAL-                                                        00282000
.*               TO CALLER (RE) IF LOGICAL UNIT IS ASSIGNED             00283000
.*               TO IGNLUB IF LOGICAL UNIT IS ASSIGNED 'IGNORE'         00284000
.*       ERROR-                                                         00285000
.*               ERROR 21 - IF EXCP REAL REQUEST BUT NOT SUPPORTED      00286000
.*               ERROR 25 - IF CCW NOT FIXED WITH EXCP REAL             00287000
.*               ERROR 26 - IF LOGICAL UNIT IS UNASSIGNED               00288000
.*               ERROR 27 - IF LOGICAL UNIT IS NOT VALID                00289000
.********************************************************************** 00290000
         USING SGIOS,RD           COMMON BASE FOR SGIOS        @D36IDAP 00291000
         USING DISP,R6            DISPATCHER BASE ADDR.        @D36IDAP 00292000
         USING CCBADR,R1          CCB BASE POINTER                      00293000
         USING TCBADR,RA          TCB BASE POINTER             @D14BDAP 00294000
         USING PIBADR,RB          PIB BASE POINTER                      00295000
GETPUB   EQU   *                  ENTERED BY SVC 0,15,25,27,35,36       00296000
         SLR   R5,R5              CLEAR PARM PASSING REG.      @D35IDEP 00297000
         CLC   TID,IORQ4AR        REQUEST FROM SYSTEM TASK     @D66ADAP 00298000
         BNL   PCKEXCRT           NO, DO VALIDATION            @D36IDAP 00299000
GETPUB10 SLR   R3,R3              CLEAR REGISTER(FOR LUB ID)            00300000
         SLR   R2,R2              INDICATE NO LUB FOUND        @D36IDAP 00301490
         L     R9,CRADDR          ADDRESS OF PARTITION COMREG  @D14CDAP 00302000
         USING COMREG,R9          COMREG BASE POINTER          @D14CDAP 00303000
         IC    R3,CCBLNO          PICK UP INDEX FROM CCB       @D36IDAP 00304000
         ICM   R5,CHQMLUB,X255    INVALIDATE LUB INDEX         @D36IDAP 00305000
         TM    CCBCLS,CCBPHYAD    IS PHYSICAL ADDRESSING USED  @D34SDEP 00306000
         BZ    GETPUB15           NO, LOGICAL ASSIGNMENT       @D21ODAP 00307000
         ICM   R3,3,CCBCLS        GET UNIT INFORMATION         @D21ODAP 00308000
         N     R3,PHYADMSK        TURN OFF UNUSED BITS         @D21ODAP 00309000
         B     GETPUBAD           CALCULATE PUB ADDRESS        @D21ODAP 00310000
.*                                                                      00311000
.* CALCULATE LUB ENTRY NUMBER WITHIN PARTITIONS LUB TABLE               00312000
.*                                                                      00313000
GETPUB15 DS    0H'0'              CHECK FRO PROGR./SYST UNIT   @D68ADAP 00314290
         AIF   (NOT &VSE410).N410020                                    00314310
         ICM   R3,3,CCBCLS        HIGH ORDER PROGR. UNIT BITS  @D41ADAP 00314330
         N     R3,PHYADMSK        INVALIDATE UNUSED PART       @D41ADAP 00314350
         C     R3,F256            IS THIS A SYSTEM LOGICAL UNIT@D41ADAP 00314370
         BL    GETPUB20           YES,                         @D41ADAP 00314390
         S     R3,F256            PROGRAMMER LUB NUMBER        @D41ADAP 00314410
         CLM   R3,1,PIBLUBNO      IS IT A VALID LUB NO.        @D41ADAP 00314430
         AGO   .Y410020                                        @D41ADAP 00314450
.N410020 ANOP                                                           00314470
         TM    CCBCLS,ONE         PROGRAMMER OR SYSTEM UNIT             00314580
         BZ    GETPUB20           SYSTEM UNIT                  @D36IDAP 00315000
         CLC   CCBLNO,PIBLUBNO    IS LUB DEFINED               @D36IDAP 00316000
.Y410020 ANOP                                                           00316500
         BNL   ERR27              NO,  ====================>>> @D36IDAP 00317000
         AH    R3,SYSLUBNO        ADD NUMBER OF SYSTEM LUBS    @D36IDAP 00318000
         B     GETPUB30           CALCULATE LUB ENTRY          @D36IDAP 00319000
GETPUB20 CLI   CCBLNO,LUBNO       VALID LUB NUMBER             @D36IDAP 00320000
         BNL   ERR27              NO,  ====================>>> @D35IDEP 00321000
         ICM   R5,CHQMLUB,CCBLNO  SAVE SYSTEM LUB ENTRY NO.    @D36IDAP 00322000
.*                                                                      00323000
.* RETRIEVE PUB INDEX FROM LUB TABLE                                    00324000
.*                                                                      00325000
GETPUB30 LR    R2,R3              COPY LUB NUMBER                       00326000
         AR    R2,R2              OFFSET WITHIN LUB TABLE               00327000
         L     R3,PCBPTR          PCB ADDRESS                  @D51GDAP 00328000
         USING PCBADR,R3          PCB BASE POINTER             @D51GDAP 00329000
         A     R2,PCEALUB         ADD ADDRESS OF PARTITION LUB @D51DGAP 00330000
         DROP  R3                 RELEASE PCB BASE POINTER     @D51GDAP 00331000
         SLR   R3,R3              CLEAR PUB POINTER            @D36IDAP 00332000
         ICM   R3,2,1(R2)         GET PUB INDEX HIGH ORDER BYTE@D51GDAP 00333000
         BNM   GETPUB40           THIS IS A 2 BYTE INDEX       @D51GDAP 00334000
         SLR   R3,R3              CLEAR PUB POINTER            @D51GDAP 00335000
         IC    R3,0(,R2)          GET THE PUB INDEX            @D51GDAP 00336000
         CH    R3,LUBIGN          LUB IS ASSIGNED              @D369DAP 00337000
         BE    IGNLUB             ,IGN ====================>>>          00338000
         BH    ERR26              ,UA  ====================>>>          00339000
GETPUB40 IC    R3,0(,R2)          COMPLETE THE PUB INDEX       @D51GDAP 00340000
         SPACE 3                                               @D36IDAP 00341000
.*                                                                      00342000
.*       CALCULATE PUB ADDRESS                                          00343000
.*                                                                      00344000
GETPUBAD DS    0H'0'              GET PUB/PUBX ADDRESS         @D68ADAP 00345190
         LR    R2,R3              COPY PUB INDEX               @D68ADAP 00345380
         SLL   R3,PUBSLEN         CALCULATE PUB DISPLACEMENT   @D51ODGL 00345570
         AH    R3,YPUBTAB         ADD ADDRESS OF PUB TABLE              00346000
         USING PUBADR,R3          PUB BASE POINTER             @D36IDAP 00347000
         SLL   R2,2               MULTIPLY BY FOUR             @D68ADAP 00347200
         A     R2,APBXAREA        ADDRESS OF PUB EXTENTION     @D68ADAP 00347400
         L     R2,0(R2)           GET PUBX POINTER             @D68ADAP 00347600
         USING PBXADR,R2          PUBX BASE POINTER            @D68ADAP 00347800
         TM    CCBCLS,CCBPHYAD    PHYSICAL ADDRESSING          @D14BDAP 00348000
         BZ    GETPUBA5           NO,                          @D14BDAP 00349000
         CLI   PUBDEVTY,TQDIO     IS THIS AN OSAX DEVICE       @D66ADAP 00351000
         BER   RE                 YES, ======================> @D66ADAP 00352000
         CLI   PUBDEVTY,TOSA      IS THIS AN OSA DEVICE        @D62OSAP 00354000
         BNE   GETPUBA3           NO,                          @D62OSAP 00355000
         CLI   PUBOPTN,PUBOPOFE   IS IT THE OSA FE PORT        @D62OSAP 00356000
         BER   RE                 YES, ======================> @D28ADAP 00357000
GETPUBA3 L     R7,TIBPTR          GET TIB ADDRESS              @D14BDAP 00358000
         USING TIBADR,R7          TIB BASE POINTER             @D14BDAP 00359000
         TM    TIBFLAG1,SYSACT+EOTACT PHYSICAL ADDRESSING O.K. @D14BDAP 00360000
         BNZ   GETPUBA5           YES,                         @D51GDAP 00361000
         L     R7,PCBPTR          POINT TO CURRENT PCB         @D51GDAP 00362000
         USING PCBADR,R7                                       @D51GDAP 00363000
         TM    PCBSSFLG-PCBADR(R7),VTAM  REQ.FROM VTAM PART.   @D51GDAP 00364000
         BO    GETPUBA5           YES,                         @D51GDAP 00365000
         TM    SYSFLAG2,IPLBIT    IS IPL IN PROGRESS           @D51GDAP 00366000
         BZ    ERR21              NO,  ====================>>> @D51GDAP 00367000
         DROP  R7                 RELEASE PCB BASE POINTER     @D51GDAP 00368000
GETPUBA5 TM    PBXFLAG,PBXTAPE    IS THIS A TAPE DEVICE        @D68ADAP 00369490
         BZ    GETPUBA6           NO                           @D68ADAP 00370090
         OC    PBXSIMAD,PBXSIMAD  IS THIS A VIRTUAL TAPE       @D68ADAP 00370120
         BZ    GETPUBA6           NO,                          @D68ADAP 00370150
         L     R7,IJBSPAVT        SUPVR ADDRESS VECTOR TABLE   @D68ADAP 00370180
         USING SUPAVT,R7          SUPAVT BASE POINTER          @D68ADAP 00370210
         L     R7,ASUPAVTE        ADDRESS OF SUPAVTEX          @D68ADAP 00370240
         USING SUPAVTEX,R7        SUPAVTEX BASE POINTER        @D68ADAP 00370270
         ICM   R7,15,AVTAPANC     COMMUNICATION AREA PRESENT   @D68ADAP 00370300
         BZ    GETPUBA6           NO, PROCEED MAIN PATH        @D68ADAP 00370330
         USING VTAPHDR,R7         VTAPE HEADER BASE POINTER    @D68ADAP 00370360
         TM    VTAPHFLG,VTAPTBND  DO WE HAVE TO WAIT FOR TIMER @D68ADAP 00370390
         BO    RESVCIO            YES, =====================>> @D68ADAP 00370420
*SGLINK  RESVCIO,INPUT=R6                                      @D68ADAP 00370450
         L     R7,TIBPTR          GET TIB ADDRESS              @D68ADAP 00370480
         USING TIBADR,R7          TIB BASE POINTER             @D68ADAP 00370510
         TM    TIBFLAG4,TIBGEXAC  IS AN EXIT ALREADY ACTIVE    @D68ADAP 00370540
         BO    RESVCIO            YES, =====================>> @D68ADAP 00370570
*SGLINK  RESVCIO,INPUT=R6                                      @D68ADAP 00370600
         DROP  R7                 RELEASE TIBADR BASE          @D68ADAP 00370630
GETPUBA6 CLC   PUBCHANN(2),SYSOCDEV IS IT THE OPERATOR CONSOLE @D14BDAP 00370690
         BNER  RE                 NO,  ======================>          00371000
         TM    CCBCLS,CCBPHYAD    PHYSICAL ADDRESSING          @D61CSAP 00372000
         BZ    GETPUBA7           NO,                          @D61CSAP 00373000
         CLC   TID,IORQ4SNS       IS THIS A SNS-TASK REQUEST   @D66ADAP 00374000
         BER   RE                 YES, ======================> @D61CSAP 00375000
         CLC   TID,IORQ4CST       IS THIS A CST-TASK REQUEST   @D66ADAP 00376000
         BER   RE                 YES, ======================> @D61CSAP 00377000
         B     ERR21              NO,  ====================>>> @DA44069 00378000
GETPUBA7 ICM   R5,CHQMLUB,XCHQLOG MAKE THIS A SYSLOG REQUEST   @DA41211 00379000
         TM    SYSFLAG5,X'10'     IS ATTN PROCESSING ACTIVE    @D52VDAP 00380000
         BZR   RE                 NO,  ======================> @D61NDAP 00381000
         AIF   (&AG1 LE 254).LOD0005                           @D51ODGL 00382000
         CLI   PUBCHQPH,ZERO      IS THIS ENTRY ZERO           @D52VDAP 00383000
         BNER  RE                 NO,  ======================> @D61NDAP 00384000
.LOD0005 ANOP                                                  @D52VDAP 00385000
         CLI   PUBCHQPT,ZERO      IS THIS ENTRY ZERO           @D52VDAP 00386000
         BNER  RE                 NO,  ======================> @D61NDAP 00387000
         B     RESVCIO            YES  ====================>>> @D31YDAP 00388000
*SGLINK  RESVCIO,INPUT=R6                                      @DA44841 00389000
         DROP  R2                 RELEASE PUBX BASE            @D68ADAP 00389500
         DROP  R3                 RELEASE PUB BASE             @D36IDAP 00390000
         DROP  R9                 RELEASE COMREG BASE          @D149DAP 00391000
         TITLE 'VSE SUPERVISOR     SGIOS     VALIDATION OF CCB/IORB   ' 00392000
PCKEXCRT LA    R2,15(,R1)         POINT R2 TO LAST BYTE OF CCB @D66APAP 00393000
         TM    CCBCLS,CCBIORB     IS THIS THE IORB INTERFACE   @D35EDEP 00394000
PCKEXCP8 EQU   *                  PAGE OR SEGMENT TRANSL ==>>> @DY46548 00394500
         BZ    GETPV010           NO, CONTINUE ON MAINLINE     @D35EDEP 00395000
         LA    R2,IORBLNG-1(R1)   IORB BASIC LENGTH            @D35EDEP 00396000
         TM    CCBBY3,IORBEXT     IS AN EXTENSION PRESENT      @D35EDEP 00397000
         BZ    GETPV010           NO, VALIDATE IORB LENGTH     @D35EDEP 00398000
.*                                                             @D35IDAP 00399000
.*       ADDITIONAL EXTENSIONS MAY BE ADDED TO THE IORB.       @D35IDAP 00400000
.*       ANY OF THESE EXTENSIONS MUST BE FOUR BYTES IN LENGTH  @D35IDAP 00401000
.*       AND THE FIRST BYTE (BIT 1-6) MUST UNIQUELY IDENTIFY   @D35IDAP 00402000
.*       THE EXTENTION. THE REMAINING THREE BYTES MAY BE USED  @D35IDAP 00403000
.*       AS PARAMETER BYTES. THE EXTENSION-ID MUST BE IN       @D35IDAP 00404000
.*       ASCENDING ORDER AND THE LAST EXTENTION-ID IN THE      @D35IDAP 00405000
.*       CHAIN MUST HAVE THE HIGH ORDER BIT (BIT 0) ON.        @D35IDAP 00406000
.*                                                             @D35IDAP 00407000
.*       EXTENTION-ID (USED SO FAR)   NXXXXXXX                 @D35IDAP 00408000
.*                                     0000000 = ECB           @D35IDAP 00409000
.*                                                             @D35IDAP 00410000
         LR    R3,R1              SAVE POINTER                 @D35EDEP 00411000
         L     R1,IORBEID         GET ECB ADDRESS              @D35IDAP 00412000
PCKEXCP2 EQU   *                  ERR25 ===================>>> @D35IDAP 00413000
         LTR   R1,R1              IS THIS THE ONLY EXTENTION   @D35IDAP 00414000
         BNM   ERR21              NO,  ====================>>> @D35IDAP 00415000
         LA    R2,3(R1)           POINT TO LAST BYTE           @D35EDEP 00416000
         BAL   R8,VALID           VALIDATE EXTENTION  =====>>> @D35EDEP 00417000
*SGLINK  VALID,INPUT=(R1,R2,R6,R8),OUTPUT=R5,WORK=R2           @D369DAP 00418000
         LR    R1,R3              RESTORE ADDR OF IORB         @D35EDEP 00419000
         LA    R2,IORBLNG+3(,R1)  VALIDATE WHOLE IORB          @D35EDEP 00420000
GETPV010 DS    0H'0'                                           @D66ADAP 00421000
         C     R1,AAROUTCB        IS THIS THE MSG-WRITER CCB   @D66ADAP 00423000
         BE    GETPUB10           YES, LET IT GO               @D66ADAP 00424000
         TM    CCBCLS,CCBPHYAD+XCPR COULD THIS BE QDIO         @D66ADAP 00425000
         BO    GETPUB10           YES,                         @D66ADAP 00426000
GETPV020 DS    0H'0'                                           @D66ADAP 00427000
         BAL   R8,VALID           VALIDATE CCB        =====>>> @D35IDEP 00429000
*SGLINK  VALID,INPUT=(R1,R2,R6,R8),OUTPUT=R5,WORK=R2           @D369DAP 00430000
GETPV100 EQU   *                  ENTRY POINT FROM SVC103      @D36IDAP 00431490
         L     R7,CCBCCW          LOAD ADDRESS OF CCW                   00432000
         LA    R7,0(,R7)          CLEAR HIGH ORDER BYTE/BIT    @D21ODAP 00433000
         USING CCWADR,R7          VIRTUAL CCW BASE             @D36IDAP 00434000
         SLL   R5,24              SHIFT KEY TO PROPER POSITION @D66ADAP 00435000
         AIF   (NOT &VSE410).N410040                                    00436190
         TM    CCBBY3,IDAWFMT2    FORMAT-2 IDAWS               @D61ADAP 00436380
         BZ    GETPV120           NO                           @D61ADAP 00436570
         TM    CCBBY3,CCBCCWF1    FORMAT1 CCW                  @D61ADAP 00436760
         BZ    ERR21              NO,  ====================>>> @D61ADAP 00436950
.N410040 ANOP                                                           00437140
GETPV120 TM    CCBBY3,CCWABOVE    SPECIAL ACTION REQUIRED      @D68ADAP 00437330
         BO    GETPV140           YES,                         @D68ADAP 00437520
         TM    CCBCLS,XCPR+BTAM+CCBCOPY SPECIAL ACT.           @D68ADAP 00438000
         BZ    GETPV160           NO,                          @D51GDAP 00439590
GETPV140 TM    CCBCLS,CCBCOPY     ANY INVALID BIT SET          @D66ADAP 00440180
         BNZ   ERR27              YES, ====================>>> @D369DAP 00441000
         TM    CCBCLS,XCPR        EXCP-REAL REQUEST            @DM01357 00442000
         BZ    GETPV160           NO,                          @D51GDAP 00443490
         TM    CCBCLS,BTAM        BTAM REQUEST                 @D369DAP 00444000
         BO    ERR21              YES, ====================>>> @D51GDAP 00445000
         TM    CCBBY3,CCBCCWF1    FORMAT1 CCW                  @DAOM    00446000
         BZ    GETPUB10           NO,                          @DAOM    00447000
         TM    CCBCOM1,OWNUCRT    USER OWN ERROR ROUTINE       @DAOM    00452000
         BZ    ERR21              NO,  ====================>>> @DAOM    00453000
         B     GETPUB10           FIND LUB AND PUB ADDRESS     @DAOM    00454000
GETPV160 CLC   CCWCODE(1),CCWLNG+1 VALIDATE 1ST CCW                     00456490
PCKEXCP3 EQU   *                  ERR25 ===================>>>          00457000
         B     GETPUB10           FIND LUB AND PUB ADDRESS     @D36IDAP 00458000
PCKEXCP4 EQU   *                  ERR25 ===================>>> @D35EDEP 00459000
PCKEXCP5 EQU   *                  ERR25 ===================>>> @D51GDPS 00460000
PCKEXCP6 EQU   *                  ERR25 ===================>>> @D66ADAP 00461000
PCKEXCP7 EQU   *                  ERR25 ===================>>> @D66ADAP 00462000
PCKCBF1  EQU   *                  ERR25 ===================>>>          00463000
PCKCBF2  EQU   *                  ERR25 ===================>>>          00464000
IORQ4SNS EQU   SNSTIDH            SNS TASK ID                  @D66ADAP 00487000
IORQ4DSK EQU   DSKTIDH            DSK TASK ID                  @D66ADAP 00488000
IORQ4RAS EQU   RASTIDH            RAS TASK ID                  @D66ADAP 00489000
IORQ4PMR EQU   PMRTIDH            PMR TASK ID                  @D66ADAP 00490000
IORQ4ERP EQU   ERPTIDH            ERP TASK ID                  @D66ADAP 00491000
IORQ4LCK EQU   LCKTIDH            LCK TASK ID                  @D66ADAP 00492000
IORQ4SVT EQU   SVTTIDH            SVT TASK ID                  @D66ADAP 00493000
IORQ4CST EQU   CSTTIDH            CST TASK ID                  @D66ADAP 00494000
IORQ4AR  EQU   ARTIDH             AR  TASK ID                  @D66ADAP 00495000
IORQ4BG  EQU   BGTIDH             BG  TASK ID                  @D66ADAP 00496000
AAROUTCB DC    A(AROUTCCB)        SYSLOG CCB                            00497000
         DROP  R7                 RELEASE CCWADR BASE          @D36IDAP 00499490
         DROP  RA                 RELEASE TCB BASE             @D14BDAP 00500000
         DROP  RB                 RELEASE PIB BASE             @D36IDAP 00501000
         DROP  R1                 RELEASE CCB BASE             @D36IDAP 00502000
         DROP  R6                 RELEASE DISP BASE            @D36IDAP 00503000
         DROP  RD                 RELEASE SGIOS BASE           @D36IDAP 00504000
         TITLE 'VSE SUPERVISOR     SGIOS     POWER INTERCEPT ROUTINE  ' 00505000
         USING SGIOS,RD           COMMON BASE FOR SGIOS        @D36IDAP 00506000
         USING DISP,R6            DISPATCHER BASE ADDR.        @D36IDAP 00507000
         USING PUBADR,R3          PUB BASE POINTER             @D369DAP 00508000
         USING CCBADR,R1          CCB BASE POINTER             @D14BDAP 00509000
         USING TCBADR,RA          TCB BASE POINTER             @D14BDAP 00510000
         USING PBXADR,R2          PUBX BASE POINTER            @DA44364 00511000
         USING COMREG,R9          COMREG BASE POINTER          @D27CODE 00512000
SVC0POW  EQU   *                                               @D14BDAP 00513000
         CLC   PUBCHANN(2),SYSOCDEV  IS THIS OPERATOR CONSOLE  @D27CODE 00514000
         BNE   SVC0PW05           NO, JOIN MAIN LINE           @D27CODE 00515000
         TM    JCSW5,JCLACTIV     IS JCL ACTIVE                @D27CODE 00516000
         BZR   RE                 NO,  ======================> @D27CODE 00517000
SVC0PW05 CLM   R1,8,H0            IS CCB BELOW 16M BOUNDARY    @DAOM    00518000
         BNE   ERR21              NO,  ====================>>> @DAOM    00519000
         TM    CCBBY3,CCWABOVE    IS THIS A 31-BIT CCW         @D68ADAP 00520000
         BO    ERR21              YES, ====================>>> @DAOM    00521000
         CLC   PUBCHANN(2),SYSOCDEV  IS THIS OPERATOR CONSOLE  @D14BDAP 00522000
         BE    SVC0PW10           YES, LET POWER INSPECT MSG   @D14BDAP 00523000
         CLI   PUBDEVTY,T3540     IS DEVICE A DISKETTE         @D14BDAP 00524000
         BE    SVC0PW10           YES, HAVE TO CHECK           @D14BDAP 00525000
         CLI   PUBDEVTY,TAPES     IS DEVICE UNIT RECORD TYPE   @D14BDAP 00526000
         BNLR  RE                 NO,  ======================> @D14BDAP 00527000
SVC0PW10 TM    PBXFLAG,PBXUR+PBXSLOG UNIT RECORD OR SYSLOG     @D14BDAP 00528000
         BZR   RE                 NO,  ======================> @D14BDAP 00529000
         L     RF,PBXUSOFF        OFFSET OF USAGE COUNT FIELD  @D14BDAP 00530000
         L     R7,PCBPTR          ADDRESS OF PCB               @D14BDAP 00531000
         USING PCBADR,R7          PCB BASE POINTER             @D14BDAP 00532000
         A     RF,PCBCNT          ADDRESS OF USAGE COUNT FIELD @D14BDAP 00533000
         USING DVCUSCNT,RF        DEVICE USAGE BASE POINTER    @D14BDAP 00534000
         TM    DVCLUFLG,DVCPWRSP  IS THIS A SPOOLED DEVICE     @D14BDAP 00535000
         BZR   RE                 NO,  ======================> @D14BDAP 00536000
         TM    IJBFLG08,IJBDEBUG  IS DEBUG ACTIVE              @D66ADAP 00538000
         BO    SVC0PW20           YES,                         @D66ADAP 00539000
         TM    PBXFLAG,PBXSLOG    SYSLOG DEVICE                @DY45789 00540000
         BO    SVC0PW20           YES,                         @DY45789 00541000
         L     RF,AVTAPPAR        GET VTAPPARM BASE ADDRESS    @D66ADAP 00542000
         CLC   4(2,RF),TID        IS THIS THE SERVER PARTITION @D66ADAP 00543000
         BNE   SVC0PW20           NO,                          @D66ADAP 00544000
         B     IGNLUB             YES, ======================> @D66ADAP 00545000
AVTAPPAR DC    A(VTAPPARM)        VTAP-ANCHOR TABLE            @D66ADAP 00546000
         DROP  R7                 RELEASE PCB BASE POINTER     @DA44364 00548000
         DROP  R9                 RELEASE COMREG BASE          @D27CODE 00549000
         SPACE 3                                               @D369DAP 00550000
*        ROUTINE ALSO ENTERED HERE FROM SVC-03                 @D51GDAP 00551000
         SPACE 2                                               @D51GDAP 00552000
SVC0PW20 DS    0H'0'                                                    00553000
         STM   RA,R8,SVCSV3+4     SAVE SUPERVISOR REGISTERS    @D14BDAP 00554000
         MVI   RID+1,SYSTEMID     INDICATE SYSTEM RUNNING      @DA44364 00555000
         SGSETUP SETLCTL,NEXTSCB=CURRENT,OPTION=POWER,WR1=8,WR2=15      00556000
         L     RF,APOWTB          ADDRESS POWER TABLE          @D30EULR 00557000
         USING PADS,RF            DECLARE ADDRESSABILITY       @D30EULR 00558000
         LH    R0,TID             GET REQUESTOR ID             @D36IDAP 00559000
         L     RF,CA00            ADDRESS SVC 0 ROUTINE        @D30EULR 00560000
         DROP  RF                 RELEASE COMMON ADDRESS BLOCK @D51KDAP 00561000
         BALR  R8,RF              ENTER SVC 0 POWER APPENDAGE  @D30EULR 00562000
*SGLINK  CA00,INPUT=(R0,R1,R3,R8,RF),OUTPUT=RF,WORK=R9                  00563000
         USING *,R8               EXIT VECTOR BASE POINTER     @DA29183 00564000
SVC0PW30 SGSETUP SETLCTL,NEXTSCB=CURRENT,OPTION=OWNER,WR1=10,WR2=15     00565000
         MVI   RID+1,REENTRID     INDICATE USER RUNNING        @DA44364 00566000
         L     RA,TCBPTR          RELOAD TCB BASE ADDRESS      @D14BDAP 00567000
         LM    RA,RE,SVCSV3+4     RESTORE SUPERVISOR REGISTERS @D14BDAP 00568000
         LM    R0,R7,SVCSV3+28    RESTORE SUPERVISOR REGISTERS @D51GDAP 00569000
         CLM   R1,8,H3+1          ENTERED FROM SVC3            @D51GDAP 00570000
         BER   RE                 YES, ======================> @DA44364 00571000
         L     R9,CRADDR          ADDRESS OF PARTITION COMREG  @D14BDAP 00572000
         AIF   (NOT &BGDEBUG).NMC010                           @D14BDAP 00573000
         TM    IJBFLG08,IJBDEBUG  IS DEBUG ACTIVE              @DAOM065 00573300
         BZ    SVC0PW40           NO,                          @DAOM065 00573600
         CH    RF,H12             IS RETURN CODE CORRECT       @D14BDAP 00574000
         BNH   SVC0PW40           YES,                         @D14BDAP 00575000
         MVI   IJBHWORG,HWORG092  HARD WAIT ID (POWER SVC0)    @D31QDHB 00576000
         BAL   R5,SYSERROR        FORCE HARD WAIT (RF=INVALID) @D14BDAP 00577000
SVC0PW40 EQU   *                                               @D14BDAP 00578000
.NMC010  ANOP                                                  @D14BDAP 00579000
         USING PCBADR,R7          PCB BASE POINTER             @DA44364 00580000
         B     SVC0PW50-SVC0PW30(RF,R8) TAKE SPECIFIED RETURN  @D14BDAP 00581000
SVC0PW50 B     SVC0PW70        0  TASK HAS TO WAIT             @DA44364 00582000
         B     0(,RE)          4  GOON ======================> @D14BDAP 00583000
         B     SVC0PW60        8  POWER WILL HANDLE THIS I/O   @D14BDAP 00584000
         B     IGNLUB         12  POWER WANTS TO IGNORE I/O    @DA28687 00585000
         DROP  R8                 RELEASE EXIT VECTOR BASE     @DA29183 00586000
SVC0PW60 LA    RE,UNPOST          SET EXIT ADDRESS             @DA44547 00587000
         L     RF,PBXUSOFF        OFFSET OF USAGE FIELD        @DA26180 00588000
         A     RF,PCBCNT          ADDRESS OF USAGE FIELD       @DA26180 00589000
         USING DVCUSCNT,RF        DEVICE USAGE FIELD BASE      @DA26180 00590000
         MVC   DVCPWRTD(2),TID    TID OF SPOOL OWNER           @D51GDAP 00591000
         DROP  RF                 RELEASE DEVICE USAGE FIELD   @DA26180 00592000
         TM    SUPVFLAG,JAACT     IS SIO TO BE ACCOUNTED       @D14CDFG 00593000
         BZ    SVC0PW65           NO,                          @DA44547 00594000
         L     RF,PBXJAOFF        OFFSET OF SIO COUNT FIELD    @D14BDAP 00595000
         A     RF,PCBCNT          ADDRESS OF SIO COUNT FIELD   @D14BDAP 00596000
         L     R8,0(RF)           GET OLD SIO COUNT            @D14BDAP 00597000
         LA    R8,1(,R8)          INCREASE SIO COUNT           @D14BDAP 00598000
         ST    R8,0(RF)           STORE NEW SIO COUNT          @D14BDAP 00599000
SVC0PW65 TM    SUPFLAG,TDACT      ARE WE RUNNING TURBO         @DA44547 00600000
         BO    SVC0PW80           YES, SET TASK SPOOL BOUND    @DA44547 00601000
         BR    R6                 NO,  ====================>>> @DA44547 00602000
SVC0PW70 LA    RE,RESVCX          SET EXIT ADDRESS             @DA44547 00603000
SVC0PW80 OI    PCBFLAG,PWSRVFLG   INDICATE TASK IS WAITING     @DA44364 00604000
         LH    R1,PIK             GET PARTITION INDICATOR      @D14BDAP 00605000
         L     R5,ASRQTAB         RESOURCE TABLE BASE ADDRESS  @D61MPAP 00606000
         LA    R5,SRQPWSRV-SRQTAB(,R5) SPOOL I/O BOUND         @D61MPAP 00607000
         BALR  RF,RE              EXIT TO RESVCX OR,  =====>>> @D14BDAP 00608000
*SGLINK  RESVCX INPUT=(R5,R6),WORK=(R8,RF)                              00609000
*                                 EXIT TO         UNPOST       @DA44547 00610000
*SGLINK  UNPOST,INPUT=(R5,R6,RF),WORK=(R5,RE)                  @DA44547 00611000
.*                                                             @DA44547 00612000
.* WATCH OUT   UNPOST DOES RESET THE HIGH ORDER BYTE OF R1     @DA44547 00613000
.*                                                             @DA44547 00614000
         BR    R6                      ====================>>> @DA44547 00615000
         DROP  R1                 RELEASE CCB BASE             @D14CDFG 00616000
         DROP  R2                 RELEASE PUBX BASE            @D14BDAP 00617000
         DROP  R3                 RELEASE PUB BASE             @D369DAP 00618000
         DROP  R7                 RELEASE PCB BASE POINTER     @D14BDAP 00619000
         DROP  RA                 RELEASE TCB BASE POINTER     @D14BDAP 00620000
         DROP  R6                 RELEASE DISP BASE            @D369DAP 00621000
         DROP  RD                 RELEASE SGIOS BASE           @D369DAP 00622000
         TITLE 'VSE SUPERVISOR     SGIOS     VALIDATION OF SEEK FIELD ' 00623000
         USING SGIOS,RD           COMMON BASE FOR SGIOS        @D36IDAG 00624000
         USING DISP,R6            DISPATCHER BASE ADDR.        @D36IDAP 00625000
         USING CCBADR,R1          CCB BASE POINTER                      00626000
         USING CCWADR,R7          CCW BASE                     @D36IDAP 00627000
*        USING ARGLEN,RC          ARGUMENT LENGTH              @D149DAP 00628000
SVC0DFP  SLR   R8,R8              ADDR. OF SEEK/DEF EXNT FIELD @DA24456 00629000
         SLR   R0,R0              SET OFFSET POINTER TO ZERO   @DA24456 00630490
         ICM   R8,7,CCWBUF+1      ADDR. OF SEEK/DEF EXNT FIELD @DA24456 00631000
         TM    CCBBY3,CCBCCWF1    FORMAT 1 CCW                 @D52VDAP 00632000
         BZ    SVC0FP20           NO,                          @D52VDAP 00633290
         ICM   R8,15,CCWBUF1      ARGUMENT ADDRESS PRESENT     @DY46325 00633580
         BZ    SVC0FP80           NO, STRANGE                  @DY46325 00633870
         TM    CCBCLS,XCPR        IS THIS AN EXCP-REAL REQUEST @DY46325 00634160
         BNO   SVC0FP80           NO, CAN USE IT FOR ADDRESSING@DY46325 00634450
         LA    R8,CCWTOT          POINT TO FIRST CCW  (SEEK)   @DY46325 00634740
         DROP  R7                 RELEASE CCWADR BASE          @DY46325 00635030
         BAL   R7,GETDADRF1       CALCULATE VIRTUAL EQUIVALENT @DY46325 00635320
         B     SVC0FP60           JOIN MAIN PATH               @DY46325 00635610
         USING CCWADR,R7          CCW BASE                     @DY46325 00635900
SVC0FP20 LTR   R8,R8              IS ADDRESS PRESENT           @D51GDAP 00636190
         BZ    SVC0FP80           NO, STRANGE                  @D14BDAP 00636480
         TM    CCBCLS,XCPR        IS THIS AN EXCP-REAL REQUEST @D369DAP 00637000
         BNO   SVC0FP80           NO, CAN USE IT FOR ADDRESSING@D35CDEP 00638490
         LA    R8,CCWTOT          PROVIDE REAL CCW ADDRESS     @DA24456 00639000
         DROP  R7                 RELEASE CCWADR BASE          @D36IDAP 00640590
SVC0FP40 BAL   R7,GETDADR         CALCULATE VIRTUAL EQUIVALENT @DA24456 00641180
*SGLINK  GETDADR,INPUT=(R0,R6,R7,R8),OUTPUT=RF                 @DA24456 00642000
SVC0FP60 LTR   R8,RF              WAS REAL ADDR VALID          @D35CDEP 00643490
         BZ    ERR25C             NO,  ====================>>> @D35CDEP 00644000
SVC0FP80 AR    RC,R8              END OF SEEK/DEF EXNT FIELD   @DA24456 00645490
         C     RC,EOVSADR         IS ADDRESS WITHIN STORAGE    @D35EDEP 00646000
         BH    ERR25C             NO,  ====================>>> @D35IDEP 00647000
*        DROP  RC                 RELEASE ARGUMENT LENGTH BASE @D36IDAP 00648000
         SLR   RC,RC              CLEAR REGISTER               @D35EDAP 00649000
         IC    RC,CCBLNO          LUB NUMBER                   @D36IDAP 00650000
         AIF   (NOT &VSE410).N410060                                    00650100
         ICM   RC,3,CCBCLS        GET LUB NUMBER               @D41ADAP 00650200
         N     RC,PHYADMSK        LEAVE RELEVANT DATA ONLY     @D41ADAP 00650300
         C     RC,F256            IS THIS A SYSTEM UNIT        @D41ADAP 00650400
         BL    SVC0FPA0           YES,                         @D41ADAP 00650500
         S     RC,F256            REAL UNIT LUB NUMBER         @D41ADAP 00650600
         AGO   .Y410060                                        @D41ADAP 00650700
.N410060 ANOP                                                           00650800
         TM    CCBCLS,ONE         IS IT A SYSTEM UNIT          @D36IDAP 00651000
         BZ    SVC0FPA0           YES, CALCULATE LUB OFFSET    @D36IDAP 00652290
.Y410060 ANOP                                                           00652580
         AH    RC,SYSLUBNO        ADD NUMBER OF SYSTEM LUBS    @D36IDAP 00653000
SVC0FPA0 AR    RC,RC              OFFSET OF LUB WITHIN TABLE   @D33RDAP 00654490
         CLM   R8,8,H0            ARGUMENT IS A 24-BIT ADDRESS @DY46203 00655000
         BER   RE                 YES, ======================> @DY46203 00656000
.*       RETURN IN 24-BIT MODE TO CALLER                                00657580
         ICM   RE,8,H0            SET OFF UNUSED RETURN INFO...@DY46203 00657670
         AMODESW RETURN,AMODE=31  RETRN======================> @DY46203 00658000
         DROP  R1                 RELEASE CCB BASE             @D36IDAP 00659000
         DROP  R6                 RELEASE DISP BASE            @D36IDAP 00660000
         DROP  RD                 RELEASE SGIOS BASE           @D36IDAP 00661000
         SPACE 3                                                        00662000
REQIDMSK DC    X'00'              MASK FOR KEY0 TEST           @D36IDAP 00663000
X255     DC    X'FF'              FOR GETPUB PROCESSING        @D35IDEP 00664000
XCHQLOG  DC    AL1(SYSLOG)        SYSLOG ID                    @D37CDAP 00665000
EXTWRK   DC    X'00'              WORK FIELD FOR SVC104        @D369DAP 00666000
XCHQDSDF DC    AL1(CHQDASFP)      SET FILE MASK NEEDED         @D35IDEP 00667000
XCHQFILE DC    AL1(CHQFILE)       SYSFIL SUPPORT NEEDED        @D35IDEP 00668000
XCHQSFFB DC    AL1(CHQSFFBA)      FBA SYSTEM FILE SUPPORT      @D35DDEP 00669000
         TITLE 'VSE SUPERVISOR     SGIOS    VALIDATE SVC 0/15 REQUEST ' 00670000
*********************************************************************** 00671000
*                                                                     * 00672000
* SVC 0: EXECUTE THE CHANNEL PROGRAM (EXCP)                           * 00673000
*                                                                     * 00674000
*********************************************************************** 00675000
         SPACE 3                                                        00676000
         USING SGIOS,RD           SGIOS BASE POINTER           @D369DAP 00677000
         USING DISP,R6            DISP BASE POINTER            @D369DAP 00678000
         USING TIBADR,R8          TIB BASE POINTER             @D369DAP 00679000
         USING TCBADR,RA          TCB BASE POINTER             @D369DAP 00680000
         USING PIBADR,RB          PIB BASE POINTER             @D369DAP 00681000
         USING CCBADR,R1          CCB BASE POINTER             @D369DAP 00682000
SVC00    DS    0H                 ENTRY POINT OF SVC00         @D51ODGL 00683000
         AIF   (&AG1 LE 254).LOD0000                           @D51ODGL 00684000
         CLI   CHQFLPTR+1,NOTQUED IS CHANNEL QUEUE FULL        @D51ODGL 00685000
.LOD0000 AIF   (&AG1 GT 254).LOD0001                           @D51ODGL 00686000
         CLI   FLPTR,NOTQUED      IS CHANNEL QUEUE FULL        @D51ODGL 00687000
.LOD0001 ANOP                                                  @D51ODGL 00688000
         BE    RESVCIO            YES, ====================>>> @D36IDAP 00689000
*SGLINK  RESVCIO,INPUT=R6                                      @D369DAP 00690000
         DROP  R8                 RELEASE TIB POINTER          @D36IDAP 00691000
         TM    TCBEXFLG,TCBEXAM   31 BIT MODE                  @D52VDAP 00692000
         BZ    SVC00000           NO,                          @D52VDAP 00693000
         N     R1,BIT0OFF         SET 31-BIT OFF               31BITDAP 00694000
         CLM   R1,8,H0            IS CCB BELOW 16M BOUNDARY    @D52VDAP 00695000
         BE    SVC00005           YES,                         31BITDAP 00696000
         AMODESW SET,AMODE=31,WR=(RE) GO INTO 31-BIT MODE      31BITDAP 00697000
         TM    CCBBY3,CCBCCWF1    FORMAT1 CCW                  31BITDAP 00698000
PCKEXCP0 EQU   *                  ERR25====================>>>          00699000
         BZ    ERR21              NO,  ====================>>> @DY45299 00700000
SVC00000 LA    R1,0(,R1)          CLEAR HIGH ORDER BYTE/BIT    @D51GDAP 00701000
SVC00005 CLC   CCBCNT(1),CCBCNT+15 VALIDATE WHOLE CCB          @D66ADAP 00702000
PCKEXCP1 EQU   *                  ERR25====================>>> @D35EDEP 00703000
         BAL   RE,GETPUB          ALLOCATE PUB ENTRY  =====>>> @D369DAP 00704000
*SGLINK  GETPUB,INPUT=(R1,R6,RB,RD,RE),OUTPUT=(R3,R5,R9),              *00705000
               WORK=(R2,R7,R8)                                 @D149DAP 00706000
         USING PUBADR,R3          PUB BASE                     @D36IDAP 00707000
         USING COMREG,R9          COMREG BASE POINTER          @D14CDAP 00708000
SVC00010 NI    CCBCOM1,CLRCOM1    CLEAR COMMUNICATION BYTE 1   @D30EULR 00709000
         NI    CCBCOM2,CLRCOM2    CLEAR COMMUNICATION BYTE 2   @D30EULR 00710000
         XC    CCBSTA(2),CCBSTA   CLEAR STATUS BYTES           @D30EULR 00711000
         LR    R2,R3              COPY PUB POINTER             @D52HDAP 00712000
         SH    R2,YPUBTAB         OFFSET OF PUB                @D52HDAP 00713000
         SRL   R2,1               OFFSET OF PUBX ADDRESS       @D52HDAP 00714000
         A     R2,APBXAREA        ADDRESS OF PUBX ADDRESS      @D52HDAP 00715000
         L     R2,0(,R2)          ADDRESS OF PUBX ENTRY        @D52HDAP 00716000
         USING PBXADR,R2          PUBX BASE POINTER            @D52HDAP 00717000
         CLC   TID,IORQ4AR        REQ. FROM SYST.-TASK OR ATTN.@D66ADAP 00718000
         BNH   SVC00020           YES, DONT ALLOW INTERCEPTION @D36IDAP 00719000
         CH    R3,IJBLPBDV        IS BUFFER LOAD IN PROCESS    @DA29533 00720000
         BE    RESVCIO            YES, ====================>>> @DA29533 00721000
*SGLINK  RESVCIO,INPUT=R6                                      @DA29533 00722000
*                                      WAIT FOR $$BATTF4       @DA29533 00723000
*                                               $$BATTF5 OR    @DA29533 00724000
*                                               $$BATTU2       @DA29533 00725000
         TM    POWFLG1,POWUPART   POWER CONTROLLED PARTITION   @D14CDFG 00726000
         BZ    SVC00020           NO, SKIP POWER APPENDAGE     @D14CDFG 00727000
         BAL   RE,SVC0POW              ====================>>> @D369DAP 00728000
         DROP  R2                 RELEASE PUBX BASE            @D52HDAP 00729000
SVC00020 CLC   PUBCHANN(2),SYSOCDEV OPERATOR CONSOLE I/O       @D31ZDAP 00730000
         BNE   SVC00030           NO,                          @D31ZDAP 00731000
         CLC   TID,IORQ4SNS       REQ. FROM SNS-TASK           @D66ADAP 00732000
         BE    SVC0GETQ           YES, ======================> @D52VDAP 00733000
         AIF   (NOT &VSEMSG).NMSG010                           @D66ADAP 00734000
         L     RF,PCBPTR          GET PCB ADDRESS              @D66ADAP 00735000
         USING PCBADR,RF          PCB BASE ADDRESS             @D66ADAP 00736000
         ICM   RE,15,PCBOCPTR     DOES OC-EXIT EXIST           @D66ADAP 00737000
         BNZ   CHK4REPL           YES,                         @D66ADAP 00738000
         DROP  RF                 RELEASE PCBADR BASE          @D66ADAP 00739000
.NMSG010 ANOP                                                  @D66ADAP 00740000
         DROP  R9                 RELEASE COMREG BASE          @D61CSAP 00741000
SVC00025 TM    CCBBY3,CCWABOVE    IS THIS A 31-BIT CCW         @D68ADAP 00742000
         NOP   ERR21              YES, ====================>>> @DAOM    00743000
         TM    CCBCLS,CCBPHYAD    PHYSICAL ADDRESSING          @D61CSAP 00744000
         BO    SVC0TRNS           YES, ======================> @D61CSAP 00745000
         L     RD,DOCBASE         GET CONSOLE BASE ADDRESS     @D61CSAP 00746000
         USING SGDOC,RD           CONSOLE SUPPORT BASE POINTER @D61CSAP 00747000
         BAL   RE,DOCSVC0         DONE ====================>>> @D61CSAP 00748000
*SGLINK  DOCSVC0,INPUT=(R1,R3),WORK=(R0,R2,R9,RC,RF)           @D61CSAP 00749000
.*                                                                      00750000
.*       NO RETURN IS EXPECTED                                          00751000
.*                                                                      00752000
         L     RD,IOSBASE         RESTORE SGIOS BASE POINTER   @D61SAAP 00753000
         USING SGIOS,RD           SGIOS BASE POINTER           @D369DAP 00754000
         BAL   R5,SYSERROR             ====================>>> @D61CSAP 00755000
SVC00030 L     R7,CCBCCW          GET ADDR OF 1ST CCW          @DA43979 00756000
         LA    R7,0(,R7)          CLEAR HIGH ORDER BYTE/BIT    @DA43979 00757000
         TM    CCBCLS,XCPR        IS CCW ADDR. A REAL ADDRESS  @DA43979 00758000
         BZ    SVC00035           NO, CAN USE IT FOR ADDRESSING@DA43979 00759000
         LR    R9,R7              COPY REAL CCW ADDRESS        @DA43979 00760000
         AMODESW CALL,ADDRESS=VIRTAD,REGS=R6                   @DA43979 00761000
*SGLINK  VIRTAD,INPUT=(R6,R9),OUTPUT=RF,WORK=R9                @DA43979 00762000
         L     R6,DISPAD          RESTORE DISP BASE ADDRESS    @DA43979 00763000
         LTR   R7,RF              WAS VIRTUAL ADDRESS VALID    @DA43979 00764000
         BZ    ERR25C             NO,  ====================>>> @DA43979 00765000
         USING CCWADR,R7          VIRTUAL CCW BASE             @DA43979 00766000
*        USING CCWREAL,R9         REAL CCW ADDRESS             @D66ADAP 00767000
SVC00035 LA    RF,SVC0TRNS        PROVIDE CONTINUATION ADDRESS @DA43914 00768000
         CLC   TID,IORQ4AR        IS IT SYSTEM TASK REQUEST    @D66ADAP 00769000
         BL    SVC00040           YES,                         @DA43914 00770000
         BER   RF                 AR,  ======================> @DA43914 00771000
         LA    RF,SVC00045        NEW CONTINUATION ADDRESS     @DA43914 00772000
SVC00040 CLI   CCWCODE,URES       UNCONDITIONAL RESERVE REQUEST@DA43914 00773000
         BNER  RF                 NO,                          @DA43914 00774000
         TM    PUBDEVTY,DASD      IS DEVICE DASD               @DA43914 00775000
         BMR   RF                 NO,                          @DA43914 00776000
         TM    PUBDEVTY,TFBA      SURE ITS A DASD              @DA43914 00777000
         BMR   RF                 NO,                          @DA43914 00778000
         TM    PUBDEVTY,X'F0'     SURE ITS A DASD              @DA43914 00779000
         BM    ERR33              YES, ====================>>> @DA43914 00780000
         BR    RF                 NO,                          @DA43914 00781000
*                                 SVC0TRNS IF SYSTEM TASK      @DA43914 00782000
*                                 SVC00045 FOR OTHER REQUESTS  @DA43914 00783000
.********************************************************************** 00784000
.*                                                                      00785000
.* FUNCTION- CHECK FOR SPECIAL DASD PROCESSING- NEED FOR SYSFIL IS      00786000
.*           DETECTED NOW AND DASD EXTENT CHECKING ALSO DONE.           00787000
.* INPUT-    R1= ADDR OF INPUT CCB, FOR LUB NO.                         00788000
.*           R7= ADDR OF CCW FOR COMMAND CODE & SEEK FIELD ADDR.        00789000
.*           R3= ADDR OF PUB FOR REQUESTED DEVICE(DEVICE TYPE)          00790000
.*           RA= ADDR OF TCB FOR SYSRES-WRITE FLAG                      00791000
.*           EOCADDR FOR 370 ADDR VALIDATION                            00792000
.*           PIB ALSO HAS OFFSET TO PARTITION LUBS                      00793000
.*           PARTION COMM REGION FOR ADDR OF PARTITION LUBS             00794000
.* OUTPUT-   R5 BYTE 1 CONTAINS CHQPROC PROCESSING FLAGS                00795000
.*           RF IS PASSED THRU UNCHANGED                                00796000
.* REGS USED-R8= ADDR OF SEEK FIELD                                     00797000
.*           RF= SUBRTN WORK REG                                        00798000
.*           R4= SUBRTN LINKAGE                                         00799000
.*           R7= SUBRTN WORK REG                                        00800000
.*           RE= SUBRTN WORK REG                                        00801000
.* SUB ROUTINES-FBA SYSFIL SUPPORT                                      00802000
.*       CKD DASD EXTENT CHECKING                                       00803000
.*       FBA DASD EXTENT CHECKING                                       00804000
.* EXITS NORMAL- SVC0TRNS TO NEXT SEQUENTIAL FUNCTION                   00805000
.*       ERROR - ERROR 42 - EXTENTS DONT MATCH                          00806000
.*               ERROR 33 - 1ST CCW IS NOT A LONG SEEK                  00807000
.********************************************************************** 00808000
SVC00045 TM    CCBCLS,CCBPHYAD    IS THIS PHYSICAL ADDRESSING  @DA43914 00809000
         BO    SVC0TRNS           YES, ======================> @D14BDAP 00810000
         AIF   (&VSE410).Y410080                                        00810500
         TM    CCBBY3,OLTP        IS THIS OLTEP REQUEST        @DA20919 00811000
         BO    SVC0TRNS           YES, ======================> @DA20919 00812000
.Y410080 ANOP                                                           00812500
         CLM   R5,8,H0            IS IT A KEY-0 REQUEST        @D66ADAP 00813000
         BNH   SVC00150           YES, NO SYSFIL NOR DASDFP    @D35IDAP 00814000
         CLI   PUBDEVTY,T3540     IS THIS A DISKETTE           @D37BDAP 00815000
         BE    SVC00050           YES                          @D37BDAP 00816000
         TM    PUBDEVTY,DASD      IS DEVICE DASD               @D37BDAP 00817000
         BNO   SVC00150           NO, DEVICE NOT SUPPORTED     @D37BDAP 00818000
         TM    PUBDEVTY,XF0-DASD  IS DEVICE REALLY A DASD      @DA25228 00819000
         BNZ   SVC00150           NO, ITS NOT                  @D37BDAP 00820000
SVC00050 TM    CCBCLS,ONE         IS THIS A PROGR.LOG. UNIT    @D14BDAP 00821000
         BO    SVC00100           YES, CANT BE A SYSFIL REQUEST@D35IDEP 00822000
         CLI   CCBLNO,SYSLST      IS IT SYSFILE SUPPORTED UNIT @DL39R01 00823000
         BH    SVC00100           NO, CHECK FOR DASD FILE PROT @D35IDEP 00824000
         CLI   PUBDEVTY,T3540     IS THIS A DISKETTE           @DA24865 00825000
         BE    SVC00060           YES                          @DA24865 00826000
         CLI   CCWCODE,SEEK       IS FIRST CCW A LONG SEEK     @D37BDAP 00827000
         BE    SVC00060           YES, TEST CHAINING           @DM03198 00828000
         CLI   CCWCODE,RECAL      IS IT A RECALIBRATE          @DM03198 00829000
         BNE   ERR33              NO,  ====================>>> @DM03198 00830000
SVC00060 TM    CCBBY3,CCBCCWF1    FORMAT1 CCW                  @D52VDAP 00831000
         BO    SVC00090           YES, CHECK CHAINING BITS     @D52VDAP 00832000
         TM    CCWCHAIN,CC+DC     IS COMMAND CHAINED           @D52VDAP 00833000
         BZ    SVC0TRNS           NO,  ======================> @D35IDEP 00834000
SVC00070 TM    CCBCLS,CCBIORB     IS THIS AN IORB              @D14CDAP 00835000
         BZ    SVC00080           NO, NORMAL SYSFIL REQUEST    @D14CDAP 00836000
         TM    IORBREQ,IORBSFNU   IS DIB TO BE UPDATED         @D14CDAP 00837000
         BZ    SVC00080           YES, DO NORMAL PROCESSING    @D14CDAP 00838000
         ICM   R5,CHQMLUB,X255    DONT TREAT AS SYSTEM REQUEST TD14CDAP 00839000
         B     SVC0TRNS                ======================> @D14CDAP 00840000
SVC00080 ICM   R5,CHQMPROC,XCHQFILE SET SYSFIL-NEEDED-FLAG     @D14CDAP 00841000
         B     SVC0TRNS                ======================> @D35IDEP 00842000
         SPACE 1                                                        00843000
SVC00090 TM    CCWFLAG1,CC+DC     IS COMMAND CHAINED           @D52VDAP 00844000
         BZ    SVC0TRNS           NO,  ======================> @D52VDAP 00845000
         B     SVC00070                                        @D52VDAP 00846000
         TITLE 'VSE SUPERVISOR     SGIOS     VALIDATE CKD CHAN.PROGRAM' 00847000
SVC00100 CLI   PUBDEVTY,T3540     IS THIS A DISKETTE           @D37BDAP 00848000
         BE    SVC0TRNS           YES, ======================> @D37BDAP 00849000
         TM    TCBFLAGS,SYSRESW   IS WRITE ON SYSRES ALLOWED   @D36IDAP 00850000
         BO    SVC0TRNS           YES, ======================>          00851000
         L     RF,PCBPTR          PCB POINTER                  @DA43137 00852000
         USING PCBADR,RF          PCB BASE POINTER             @DA43137 00853000
         TM    PCBSSFL1,ICKDSF    IS DSF ACTIVE                @DA43137 00854000
         BO    SVC0TRNS           YES, ======================> @DA43137 00855000
         DROP  RF                 RELEASE PCB BASE POINTER     @DA43137 00856000
         CLI   CCWCODE,SEEK       CHAIN STARTS WITH A LONG-SEEK         00857000
         BE    SVC00120           YES, THAT'S WHAT WE EXPECT   @DM03198 00858000
         CLI   CCWCODE,RECAL      IS IT A RECALIBRATE          @DM03198 00859000
         BE    SVC0TRNS           YES, ======================> @DM03198 00860000
         TM    CCWCODE,X'0B'      IS THIS SOME KIND OF SENSE   @D35DDAP 00861000
         BNZ   SVC00200           NO, CHECK FOR ECKD COMMANDS  @D34BDOW 00862000
         TM    CCBBY3,CCBCCWF1    FORMAT1 CCW                  @D52VDAP 00863000
         BO    SVC00105           YES,                         @D52VDAP 00864000
         TM    CCWCHAIN,CC+DC     COMMAND-OR DATA CHAINING     @D369DAP 00865000
         B     SVC00110                                        @D51GDAP 00866000
SVC00105 TM    CCWFLAG1,CC+DC     COMMAND-OR DATA CHAINING     @D52VDAP 00867000
SVC00110 BZ    SVC0TRNS           NO,  ======================> @D369DAP 00868000
         B     ERR33              YES, ====================>>> @D35DDEP 00869000
SVC00120 EQU   *                                               @D35IDEP 00870000
         L     R2,CRADDR          ADDRESS OF COMREG            @D14BDAP 00871000
         USING COMREG,R2          COMREG BASE POINTER          @D14BDAP 00872000
         TM    LTACT,X'20'        USER WANTS FILE PROTECTION   @D14BDAP 00873000
         BZ    SVC0TRNS           NO,  ======================> @D14BDAP 00874000
         TM    CCBBY3,CCBCCWF1    FORMAT1 CCW                  @D52VDAP 00875000
         BO    SVC00140           YES,                         @D52VDAP 00876000
         TM    CCWCHAIN,CC+DC     STAND ALONE SEEK             @D35IDEP 00877000
         BZ    SVC0TRNS           YES, ======================> @D369DAP 00878000
SVC00130 ICM   R5,CHQMPROC,XCHQDSDF SET FILE-MASK-NEEDED FLAG  @D35IDEP 00879000
         LA    RC,5               LENGTH OF SEEK ARGUMENT      @D369DAP 00880000
         BAL   RE,SVC0DFP                             =====>>> @D35DDEP 00881000
*SGLINK  SVC0DFP,INPUT=(R1,R6,R7,RC,RD,RE),OUTPUT=(R8,RC),             *00882000
               WORK=(R0,R7,RF)                                 @DA24456 00883000
         DROP  R7                 RELEASE VIRTUAL CCWADR BASE  @D66ADAP 00884290
.*       SVC0DFP MAY HAVE SWITCHED INTO 31-BIT MODE                     00884580
         L     RE,2(R8)           GET HIGH CCHH OR BLKNO       @DA24456 00885000
         LR    RF,RE              GET LOW  CCHH OR BLKNO       @D14BDAP 00886000
         BAL   R7,EXTSIO00        CHECK EXTENT BLOCKS          @D14BDAP 00887000
*SGLINK  EXTSIO00,INPUT=(R1,R7,RC,RD,RE,RF),OUTPUT=(R0,R9,RC),WORK=R8   00888000
         LTR   R0,R0              MATCH FOUND                  @D35DDEP 00889000
         BZ    ERR42              NO,  ====================>>> @D35DDEP 00890000
         STC   R0,CCBSTA1         SAVE PROTECTION MASK         @D14BDAP 00891000
         B     SVC0TRNS                ======================> @D14BDAP 00892000
         SPACE 1                                                        00893000
         USING CCWADR,R7          VIRTUAL CCW BASE             @D66ADAP 00894000
SVC00140 TM    CCWFLAG1,CC+DC     COMMAND-OR DATA CHAINING     @D52VDAP 00895000
         BZ    SVC0TRNS           NO,  ======================> @D369DAP 00896000
         B     SVC00130                                        @D51GDAP 00897000
         DROP  R7                 RELEASE VIRTUAL CCWADR BASE  @D66ADAP 00898490
         DROP  R2                 RELEASE COMREG BASE          @D14BDAP 00899000
.********************************************************************** 00900000
.*                                                                      00901000
.* FUNCTION- DASD FILE PROTECTION FOR FBA                               00902000
.* ENTRY POINT- SVC00150                                                00903000
.* INPUTS-   R1= ADDR OF CCB/IORB                                       00904000
.*           R3= ADDR OF PUB FOR THIS REQUEST                           00905000
.*           R7= ADDR OF 1ST CCW FOR REQUEST                            00906000
.*           R5= REQUEST ID,LUB ID                                      00907000
.*           RA= ADDR OF TCB                                            00908000
.* OUTPUT-   R5= UPDATED PROCESSING FLAG                                00909000
.* REGS USED-R7= SUBRTN LINKAGE (EXTSIO00)                              00910000
.*           RE= SUBRTN LINKAGE (SVC0DFP)                               00911000
.*           R2= LENGTH OF A DEFINE EXTENT FIELD                        00912000
.*           RF= VIRTUAL ADDRESS OF DEFINE EXTENT FIELD                 00913000
.*           R9= ADDRESS OF EXTENT ENTRY                                00914000
.*                                                                      00915000
.* SUB ROUTINES-                                                        00916000
.*       EXTSIO00- CHECK FBA EXTENTS                                    00917000
.*       SVC0DFP - CALCULATE VIRTUAL ADDRESS OF DEFINE EXTENT           00918000
.* EXITS NORMAL- SVC0TRNS                                               00919000
.*       ERROR - ERR33- INVALID CCW OP CODE                             00920000
.*       ERROR - ERR42- NO MATCHING EXTENTS                             00921000
.********************************************************************** 00922000
         TITLE 'VSE SUPERVISOR     SGIOS     VALIDATE FBA CHAN.PROGRAM' 00923000
         USING CCWADR,R7          VIRTUAL CCW BASE             @D36IDAP 00924000
SVC00150 DC    0H'0'                                           @D35IDEP 00925000
         L     RF,PCBPTR          PCB POINTER                  @DA43137 00926000
         USING PCBADR,RF          PCB BASE POINTER             @DA43137 00927000
         CLI   PUBDEVTY,TFBA      IS DEVICE A FBA TYPE         @D35DDEP 00928000
         BNE   SVC0TRNS           NO,  ======================> @D149DAP 00929000
         CLI   CCWCODE,DX         IS THIS A DEFINE EXTENT      @D35DDEP 00930000
         BE    SVC00170           YES,                         @D35DDEP 00931000
         TM    CCWCODE,X'0B'      IS THIS SOME KIND OF SENSE   @DA43137 00932000
         BZ    SVC001A0           YES, TEST FOR CHAINING       @D51GDAP 00933000
SVC00160 TM    PCBSSFL1,ICKDSF    IS DSF ACTIVE                @DA43137 00934000
         BO    SVC0TRNS           YES, ======================> @DA43137 00935000
         AIF   (NOT &VSE280).N280020                           @DSCSI   00936000
         TM    SYSFLAG2,IPLBIT    IS IPL IN PROGRESS           @DSCSI   00937000
         BO    SVC0TRNS           YES,                         @DSCSI   00938000
.N280020 ANOP                                                  @DSCSI   00939000
         B     ERR33              NO,  ====================>>> @D35DDAP 00940000
SVC00170 TM    CCBCLS,CCBIORB     IS THIS AN IORB              @D35DDEP 00941000
         BZ    SVC00180           NO, CANT BE FBA SYFILE       @D35DDEP 00942000
         TM    IORBREQ,IORBSF     SYSTEM FILE ON FBA           @D35DDEP 00943000
         BZ    SVC00180           NO, CHECK EXTENTS            @D35DDEP 00944000
         ICM   R5,CHQMPROC,XCHQSFFB SET SPECIAL PROCESSING     @D35DDEP 00945000
         B     SVC0TRNS                ======================> @D35DDEP 00946000
SVC00180 TM    PCBSSFL1,ICKDSF    IS DSF ACTIVE                @DA43137 00947000
         BO    SVC0TRNS           YES, ======================> @DA43137 00948000
         DROP  RF                 RELEASE PCB BASE POINTER     @DA43137 00949000
         LA    RC,FBADEXLT        LENGTH OF DEFINE EXTENT FLD  @D35DDEP 00950000
         BAL   RE,SVC0DFP                             =====>>> @D35DDEP 00951000
*SGLINK  SVC0DFP,INPUT=(R1,R6,R7,RC,RD,RE),OUTPUT=(R8,RC),             *00952000
               WORK=(R0,R7,RF)                                 @DA24456 00953000
         DROP  R7                 RELEASE CCWADR BASE          @D36IDAP 00954290
.*       SVC0DFP MAY HAVE SWITCHED INTO 31-BIT MODE                     00954580
         L     R2,CRADDR          ADDRESS OF COMREG            @D14BDAP 00955000
         USING COMREG,R2          COMREG BASE POINTER          @D14BDAP 00956000
         TM    LTACT,X'20'        USER WANTS FILE PROTECTION   @D14BDAP 00957000
         BZ    SVC0TRNS           NO,  ======================> @D14BDAP 00958000
         CLM   R5,8,REQIDMSK      IS IT A KEY-ZERO REQUEST     @D66ADAP 00959000
         BNH   SVC0TRNS           YES, ======================> @D35DDEP 00960000
         TM    TCBFLAGS,SYSRESW   IS WRITE ON SYSRES ALLOWED   @D36IDAP 00961000
         BO    SVC0TRNS           YES, ======================> @D35DDEP 00962000
         DROP  R2                 RELEASE COMREG BASE POINTER  @D14BDAP 00963000
SVC00190 LR    R2,R8              COPY ARGUMENT ADDRESS POINTER@D14BDAP 00964000
         L     RE,12(,R8)         LOGICAL HIGH EXTENT BLOCK    @D14BDAP 00965000
         S     RE,8(,R8)          DISPL. TO HIGH EXTENT BLOCK  @D14BDAP 00966000
         L     RF,4(,R8)          ABSOLUTE LOW EXTENT BLOCK    @D14BDAP 00967000
         AR    RE,RF              ABSOLUTE HIGH EXTENT BLOCK   @D35DDEP 00968000
         BAL   R7,EXTSIO00        CHECK EXTENT BLOCKS          @D14BDAP 00969000
*SGLINK  EXTSIO00,INPUT=(R1,R7,RC,RD,RE,RF),OUTPUT=(R9,RC),WORK=R8      00970000
         LTR   R0,R0              MATCH FOUND                  @D14BDAP 00971000
         BZ    ERR42              NO,  ====================>>> @D14BDAP 00972000
         CH    R0,H64             IS FILE WRITE PROTECTED      @D14BDAP 00973000
         BL    SVC0TRNS           NO,  ======================> @D14BDAP 00974000
         CLI   0(R2),X'40'        DID USER INHIBIT ALL WRITES  @D14BDAP 00975000
         BNE   ERR33              NO,  ====================>>> @D14BDAP 00976000
         B     SVC0TRNS                ======================> @D14BDAP 00977000
         SPACE 1                                               @D52VDAP 00978000
         USING CCWADR,R7          VIRTUAL CCW BASE             @D66ADAP 00979000
SVC001A0 DS    0H'0'              AUTHORIZE CCW OP-CODE        @DSCSI   00980000
         AIF   (NOT &VSE280).N280040                           @DSCSI   00981000
         CLI   CCWCODE,X'94'      IS THIS DEVICE RELEASE       @DSCSI   00982000
         BE    SVC00160           YES, TREAT AS ERROR FOR NOW  @DSCSI   00983000
         CLI   CCWCODE,X'B4'      IS IT A DEVICE RESERVE       @DSCSI   00984000
         BE    SVC00160           YES, TREAT AS ERROR FOR NOW  @DSCSI   00985000
         CLI   CCWCODE,X'14'      IS IT AN UNCOND. RESERVE     @DSCSI   00986000
         BE    SVC00160           YES, TREAT AS ERROR FOR NOW  @DSCSI   00987000
.N280040 ANOP                                                  @DSCSI   00988000
         TM    CCBBY3,CCBCCWF1    FORMAT1 CCW                  @D52VDAP 00989000
         BO    SVC001B0           YES,                         @D52VDAP 00990000
         TM    CCWCHAIN,CC+DC     COMMAND OR DATA CHAINING     @D52VDAP 00991000
         B     SVC001C0                                        @D52VDAP 00992000
SVC001B0 TM    CCWFLAG1,CC+DC     COMMAND OR DATA CHAINING     @D52VDAP 00993000
SVC001C0 BNZ   SVC00160           COMMAND OR DATA CHAINED CCW  @DA43137 00994000
         B     SVC0TRNS           NO,  ======================> @D52VDAP 00995000
         DROP  R7                 RELEASE CCWADR BASE          @D66ADAP 00996490
         TITLE 'VSE SUPERVISOR     SGIOS     VALIDATE ECKD    COMMANDS' 00997000
         USING CCWADR,R7          CCW BASE                     @D14BDAP 00998000
SVC00200 CLI   CCWCODE,DX         IS THIS A DEFINE EXTENT      @DA40598 00999000
         BNE   ERR33              NO,  ====================>>> @D14BDAP 01000000
         L     R2,CRADDR          ADDRESS OF COMREG            @D14BDAP 01001000
         USING COMREG,R2          COMREG BASE POINTER          @D14BDAP 01002000
         TM    LTACT,X'20'        USER WANTS FILE PROTECTION   @D14BDAP 01003000
         BZ    SVC0TRNS           NO,  ======================> @D14BDAP 01004000
         DROP  R2                 RELEASE COMREG BASE          @D14BDAP 01005000
         LA    RC,FBADEXLT        LENGTH OF DEFINE EXTENT FLD  @D14BDAP 01006000
         BAL   RE,SVC0DFP                             =====>>> @D14BDAP 01007000
*SGLINK  SVC0DFP,INPUT=(R1,R6,R7,RC,RD,RE),OUTPUT=(R8,RC),             *01008000
               WORK=(R0,R7,RF)                                 @D14BDAP 01009000
         DROP  R7                 RELEASE CCWADR BASE          @D66ADAP 01009300
.*       SVC0DFP MAY HAVE SWITCHED INTO 31-BIT MODE                     01009600
         LR    R2,R8              COPY ARGUMENT ADDRESS POINTER@D14BDAP 01010000
         L     RE,12(R8)          LOGICAL HIGH EXTENT          @D14BDAP 01011000
         L     RF,8(R8)           LOGICAL LOW EXTENT           @D14BDAP 01012000
         BAL   R7,EXTSIO00        CHECK EXTENT BLOCKS          @D14BDAP 01013000
*SGLINK  EXTSIO00,INPUT=(R1,R7,RC,RD,RE,RF),OUTPUT=(R9,RC),WORK=R8      01014000
         LTR   R0,R0              MATCH FOUND                  @D14BDAP 01016000
         BZ    ERR42              NO,  ====================>>> @D14BDAP 01017000
         CH    R0,H64             IS FILE WRITE PROTECTED      @D14BDAP 01018000
         BL    SVC0TRNS           NO,  ======================> @D14BDAP 01019000
         CLI   0(R2),X'40'        DID USER INHIBIT ALL WRITES  @D14BDAP 01020000
         BNE   ERR33              NO,  ====================>>> @D14BDAP 01021000
*        B     SVC0TRNS                ======================> @D14BDAP 01022000
         TITLE 'VSE SUPERVISOR     SGIOS     TRANSLATE SVC 0 REQUEST  ' 01023000
SVC0TRNS SLR   RF,RF              CLEAR FIXLIST INDICATOR      @D52VDMK 01024000
         AMODESW SET,AMODE=24,WR=(R9) BACK INTO 24-BIT MODE    @D63XXAP 01025000
         L     R9,ACCWT           SET BASE REGISTER FOR CCWT RTN.       01026000
         USING CCWTADR,R9                                               01027000
         AIF   (NOT &VSE270).N270020                                    01028000
         BAS   R8,CCWTRANS        DO CCW TRANSLATION  =====>>> @D270    01029000
*SGLINK  CCWTRANS,INPUT=(R1,R3,R8,R9,RA,RB),OUTPUT=R1          @D270    01030000
         LA    R8,SVC0GETQ        GET 24-BIT ADDRESS           @D270    01031000
         BSM   0,R8               SWITCH BACK INTO 24-BIT MODE @D270    01032000
         AGO   .Y270020                                        @D270    01033000
.N270020 ANOP                                                  @D270    01034000
         BAL   R8,CCWTRANS        DO CCW TRANSLATION  =====>>>          01035000
*SGLINK  CCWTRANS,INPUT=(R1,R3,R8,R9,RA,RB),OUTPUT=R1          @D369DAP 01036000
         DROP  R9                 RELEASE CCWT BASE            @D35IDEP 01037000
.Y270020 ANOP                                                  @D270    01038000
*        B     SVC0GETQ                                        @D51GDAP 01039000
         TITLE 'VSE SUPERVISOR     SGIOS     ALLOCATE A CHANQ ENTRY   ' 01040000
.**************************************************************@D35IDEP 01041000
.*                                                             @D35IDEP 01042000
.* FUNCTION- FIND AND DEQUEUE A FREE CHANQ ELEMENT FOR THIS    @D35IDEP 01043000
.*           REQUEST.                                          @D35IDEP 01044000
.* INPUT-    SELECT FIELD FOR REQUESTOR ID.                    @D35IDEP 01045000
.*           FLPTR- CHANQ FREE LIST POINTER                    @D35IDEP 01046000
.*           CHQFLPTR- RESPECTIVELY FOR MORE DEVICES           @D51ODGL 01047000
.*           HQUPRI- HQ PRIORITY AND CONTROL INDEX TABLE       @D35IDEP 01048000
.*           HQUCNTL- CONTROL TABLE WITH TYPE AND INDEX TO     @D35IDEP 01049000
.*             RESERVED CHANQ ELEMENT                          @D35IDEP 01050000
.* OUTPUT-   R4= ADDR OF CHANQ ELEMENT                         @D35IDEP 01051000
.*           RC= INDEX OF CHANQ ELEMENT                        @D35IDEP 01052000
.*           R7= PRIORITY OF REQUESTOR (IF SYSTEM TASK)        @D35IDEP 01053000
.*           CHANQ ELE- REQUEST TYPE IS SAVED HERE             @D35IDEP 01054000
.*           HQUCNTL- RESERVED FLAG AND TYPE FLAGS ARE RESET   @D35IDEP 01055000
.* REGS USED-R8= ADDR OF CONTROL FIELD FOR THIS SYSTEM TASK    @D35IDEP 01056000
.*           R0= WORK REG TO DEQUEUE ELE FROM FREE LIST        @D35IDEP 01057000
.*                                                             @D35IDEP 01058000
.**************************************************************@D35IDEP 01059000
SVC0GETQ SLR   RC,RC             CLEAR WORK REG FOR FLPTR      @D35IDEP 01060000
         LA    R8,HQUCNTL        ACCESS TASKS CONTROL FLAGS    @D21ODAP 01061000
         LH    R7,TID            GET TASK ID                   @D66ADAP 01062000
         CLC   TID,IORQ4AR       IS REQUESTOR A SYSTEM TASK    @D66ADAP 01063000
         BNH   SVC0GQ10          YES, TID IS O.K.              @DA41765 01064000
         L     R9,PCBPTR         ADDRESS OF PCB                @D51IDAP 01065000
         USING PCBADR,R9         PCB BASE POINTER              @D51IDAP 01066000
         SLR   R7,R7             CLEAR REGISTER                @D66ADAP 01067000
         IC    R7,PCEKEY         GET STORAGE KEY               @D51IDAP 01068000
         SRL   R7,4              GET STORAGE KEY IN BITS 28-31 @D51GDAP 01069000
         LA    R7,HQUPPRI-HQUPRI(R7) ADD SYSTEM TASK ENTRIES   @D51GDAP 01070000
         DROP  R9                RELEASE PCB BASE POINTER      @D51IDAP 01071000
         IC    R7,HQUPRI(R7)     GET TASK ALLOCATED PRIORITY   @D21ODAP 01072000
         USING HQUCNTLD,R8       ADDRESS CONTROL FLAG          @DA37115 01073000
         B     SVC0GQ20          GET NORMAL CHANQ ENTRY        @D21ODAP 01074000
SVC0GQ10 IC    R7,HQUPRI(R7)     GET TASK ALLOCATED PRIORITY   @D21ODAP 01075000
         LA    R8,HQUCNTL(R7)    ACCESS TASKS HQ CONTROL FLAGS @D35IDEP 01076000
         TM    HQUCNTLF,HQURES   IS RESERVED ENTRY AVAILABLE   @D35IDEP 01077000
         BZ    SVC0GQ20          NO, GET A NORMAL ENTRY        @D14BDAP 01078000
         NI    HQUCNTLF,XFF-HQURES RESERVE NO LONGER AVAILABLE @D35IDEP 01079000
         IC    RC,HQUCNTLF       PICK CONTROL BYTE             @D14BDAP 01080000
         SRL   RC,HQURIND        GET RESERVED ELEMENT INDEX    @D14BDAP 01081000
         SLL   RC,CHQSLEN        CONVERT TO DISPLACEMENT       @D14BDAP 01082000
         A     RC,AHQRESCH       ADD ADDRESS OF FIRST RESERVED @D14BDAP 01083000
         LR    R4,RC             COPY ADDRESS                  @D35IDEP 01084000
         SL    RC,ACHANQ         OFFSET WITHIN CHANQ           @D14BDAP 01085000
         ICM   RC,8,H0           CLEAR HIGH ORDER BYTE         @D68REEF 01086000
         SRL   RC,CHQSLEN        GET CHANQ ENTRY NUMBER        @D14BDAP 01087000
         B     SVC0SETQ               =======================> @D35IDEP 01088000
SVC0GQ20 DS    0H                                              @D51ODGL 01089000
         AIF   (&AG1 LE 254).LOD0010                           @D51ODGL 01090000
         CLI   CHQFLPTR+1,NOTQUED   CHANQ ENTRY AVAILABLE?     @D51ODGL 01091000
.LOD0010 AIF   (&AG1 GT 254).LOD0011                           @D51ODGL 01092000
         CLI   FLPTR,NOTQUED     IS CHANQ ENTRY AVAILABLE      @D51ODGL 01093000
.LOD0011 ANOP                                                  @D51ODGL 01094000
         BNE   SVC0GQ30          YES,                          @DA30431 01095000
         LR    R0,R5             SAVE REQUEST INFORMATION      @DA30431 01096000
         L     R5,ASRQTAB        RESOURCE TABLE BASE POINTER   @D61NDAP 01097000
         LA    R5,SRQCHQ-SRQTAB(,R5) RESOURCE QUEUE (CHANQ)    @DA30431 01098000
         BAL   RC,RWAIT               =====================>>> @DA30431 01099000
*SGLINK  RWAIT,INPUT=(R5,RC)                                   @DA30431 01100000
         LR    R5,R0             RESTORE PARAMETER REGISTER    @DA30431 01101000
         B     SVC0GETQ          TRY TO GET CHANQ ENTRY NOW    @DA30431 01102000
SVC0GQ30 DS    0H                                              @D51ODGL 01103000
         AIF   (&AG1 LE 254).LOD0020                           @D51ODGL 01104000
         LH    RC,CHQFLPTR       GET INDEX TO NEXT NORMAL FREE @D51ODGL 01105000
.LOD0020 AIF   (&AG1 GT 254).LOD0021                           @D51ODGL 01106000
         IC    RC,FLPTR          GET INDEX TO NEXT NORMAL FREE @D51ODGL 01107000
.LOD0021 ANOP                                                  @D51ODGL 01108000
         LR    R4,RC             COPY CHANQ ENTRY NUMBER       @D149DAP 01109000
         SLL   R4,CHQSLEN        GET DISPLACEMENT              @D35IDEP 01110000
         A     R4,ACHANQ         GET ADDRESS                   @D35IDEP 01111000
         ICM   R4,8,H0           CLEAR HIGH ORDER BYTE         @D68REEF 01112000
         USING CHQADR,R4         CHANQ BASE POINTER            @D35IDEP 01113000
         SLR   R0,R0             CLEAR FOR INSERT              @D51ODGL 01114000
         IC    R0,CHQCHNLO       GET CURRENT CHAIN POINTER     @D51ODGL 01115000
         AIF   (&AG1 LE 254).LOD0030                           @D51ODGL 01116000
         ICM   R0,2,CHQCHNHI     GET HIGH BYTE OF POINTER      @D51ODGL 01117000
.LOD0030 AIF   (&AG1 GT 254).LOD0031                           @D51ODGL 01118000
         STC   R0,FLPTR          MAINTAIN OLD FREELIST POINTER @D51ODGL 01119000
.LOD0031 ANOP                                                  @D51ODGL 01120000
         STH   R0,CHQFLPTR       MAKE IT THE NEXT FREE POINTER @D51ODGL 01121000
         C     R0,CQEHIGH        HIGHER THAN HIGH WATER MARK   @D61CDAP 01122000
         BNH   SVC0GQ40          NO,                           @D61CDAP 01123000
         ST    R0,CQEHIGH        SET NEW HIGH WATER MARK       @D61CDAP 01124000
SVC0GQ40 L     RE,CQEINUSE       GET CHANQ IN USE COUNTER      @D61CDAP 01125000
         LA    RE,1(,RE)         INCREASE BY 1                 @D61CDAP 01126000
         ST    RE,CQEINUSE       SAVE UPDATED VALUE            @D61CDAP 01127000
*        B     SVC0SETQ               =======================> @D149DAP 01128000
         TITLE 'VSE SUPERVISOR     SGIOS     FILL CHANNEL QUEUE ENTRY ' 01129000
.********************************************************************** 01130000
.*                                                                      01131000
.* FUNCTION- FILL CHANQ ELEMENT WITH REQUIRED DATA                      01132000
.* ENTRY POINT- FALL INTO FROM SVC0GETQ ROUTINE                         01133000
.* INPUTS-   R1= ADDR OF CCB/IORB                                       01134000
.*           R3= ADDR OF PUB FOR THIS REQUEST                           01135000
.*           R4= ADDR OF CHANQ TO BE FILLED                             01136000
.*           R5= REQUEST ID,PROCESSING FLAGS,LUB ID                     01137000
.*           R7= REQUEST PRIORITY NUMBER                                01138000
.*           R8= ADDRESS OF RELEVANT REQUEST PRIORITY TABLE ENTRY       01139000
.*           RC= CHANQ ENTRY NUMBER OF ENTRY TO BE FILLED               01140000
.*           RF= ADDR OF PAGE MGR. FIXLIST OR 0 IF NONE                 01141000
.* OUTPUT-   ALL FIELDS OF CHANQ ELE ARE FILLED                         01142000
.*           RID IS SET TO SYSTEMID- NO PAGE FAULTS ALLOWED             01143000
.* REGS USED RE= SUBRTN LINKAGE                                         01144000
.*           R5= COMM REGION ADDR                                       01145000
.*           R8= OUTPUT FROM RMSGETP2                                   01146000
.*           R0= WORK REG FOR MOVING 1 BYTE FIELDS                      01147000
.*                                                                      01148000
.* SUB ROUTINES-                                                        01149000
.*       RMSGETP2- ACCESS PUB2 RELATED TO THIS PUB                      01150000
.* EXITS NORMAL- TO NEXT SEQUENTIAL ROUTINE                             01151000
.********************************************************************** 01152000
SVC0SETQ XC    CHQCLR,CHQCLR     CLEAR DYNAMIC FIELDS          @D35IDEP 01153000
         MVI   CHQFLG1,CHQFSIO1  RESTRICT I/O TO PRIMARY PATH  @D21ODAP 01154000
         STCK  X'D8'             GET TIME STAMP                @DTIMING 01155000
         ICM   RE,15,X'DA'       GET RESOLUTION BYTES          @DTIMING 01156000
         SRL   RE,3              ADJUST TO 128 MICRO SECONDS   @DTIMING 01157000
         ST    RE,CHQCCBB3+1     SAVE ENQUEUING TIME           @DTIMING 01158000
         TM    HQUCNTLF,HQUHQ    IS THIS A HEAD QUEUE ENTRY    @D14BDAP 01159000
         BZ    SVC0SQ10          NO,                           @D14BDAP 01160000
         OI    CHQFLG1,CHQHQA    INDICATE THIS IS AN SVC-0F    @D14BDAP 01161000
         NI    HQUCNTLF,XFF-HQUHQ TURN OFF REQUEST FLAG        @D14BDAP 01162000
         DROP  R8                RELEASE PRIORITY TABLE BASE   @D14BDAP 01163000
SVC0SQ10 MVI   CHQCCSIO,ZERO     CLEAR SIO FLAG BYTE           @D37BDAP 01164000
         MVI   CHQCHNLO,XFF      SET END OF CHAIN CODE         @D51ODGL 01165000
         AIF   (&AG1 LE 254).LOD0300                           @D51ODGL 01166000
         MVI   CHQCHNHI,XFF      SET HIGH BYTE                 @D51ODGL 01167000
.LOD0300 ANOP                                                  @D51ODGL 01168000
         STCM  R5,8,CHQCAWKY     STORAGE PROTECTION KEY        @D66ADAP 01169000
         STCM  R5,7,CHQIDS       STORE CHANQ INFORMATION       @D66ADAP 01170000
         LA    R8,TID            POINT TO TASK-ID              @D66ADAP 01171000
         MVC   CHQTID,0(R8)      PROVIDE TASK-ID               @D66ADAP 01175000
         TM    CCBCLS,BTAM       IS THIS A BTAM REQUEST        @D61NDAP 01176000
         BZ    SVC0SQ40          NO                            @D51GDAP 01177000
         OI    CHQGRP,CHQGRBTM   INDICATE BTAM REQUEST         @D51GDAP 01178000
SVC0SQ40 L     R8,TIBPTR         ADDRESS OF TIB                @D61NDAP 01179000
         USING TIBADR,R8         TIB BASE POINTER              @D14BDAP 01180000
         TM    TIBFLAG1,PRIVILEG PRIVILEGED STATE              @D14BDAP 01181000
         BZ    SVC0SQ45          NO,                           @D14BDAP 01182490
         MVI   CHQCAWKY,ZERO     SET PROTECTION KEY TO ZERO    @D14BDAP 01183000
SVC0SQ45 STCM  R1,7,CHQCCBAD+1   SAVE CCB ADDR. IN CHANQ       @D51ODGL 01184000
         IC    R0,CCBCOM1        SAVE COMMUNICATION BYTE1      @D35IDEP 01185000
         STC   R0,CHQCCBB1       INTO CHANNEL QUEUE ENTRY      @D35IDEP 01186000
         IC    R0,CCBCOM2        SAVE COMMUNICATION BYTE2      @D35IDEP 01187000
         STC   R0,CHQCCBB2       INTO CHANNEL QUEUE ENTRY      @D35IDEP 01188000
         IC    R0,CCBBY3         SAVE COMMUNICATION BYTE3      @D35IDEP 01189000
         STC   R0,CHQCCBB3       INTO CHANNEL QUEUE ENTRY      @D35IDEP 01190000
         SGVSEPT PROBE=5,SAVE=NO ALLOW PERFORMANCE INTERCEPT   @D51GDAP 01191000
*SGLINK  SGVSEPT,INPUT=(RE,RF)                                 @D51GDAP 01192000
.* SHOULD HAVE NO MORE PAGE FAULTS FROM NOW ON                          01193000
         LR    R0,R3             COPY PUB POINTER              @D35ZDAP 01194000
         SH    R0,YPUBTAB        OFFSET WITHIN PUB TABLE       @D35ZDAP 01195000
         SRL   R0,THREE          PUB ENTRY NUMBER              @D35ZDAP 01196000
         STH   R0,CHQPUBHI       SAVE IT IN CHANQ ENTRY        @D51ODGL 01197000
         MVI   RID+D1,SYSTEMID   INDICATE SYSTEM IS RUNNING             01198000
         MVZ   DEVZON,PUBDEVTY   SET UP DEVICE TYPE ZONE                01199000
.* SET DEVICE TYPE CODES IN CHANQ ENTRY FOR LOGICAL PROCESSING          01200000
         CLI   PUBDEVTY,TFBA     FBA DEVICE GROUP              @D35DDEP 01201000
         BNE   SVC0SQ50          HIGH, CHECK FOR OTHER TYPES   @D26IDAP 01202000
         OI    CHQDEV,CHQFBA     SET PROPER DEVICE GROUP       @D35DDEP 01203000
SVC0SQ50 LR    R5,R0             GET PUB INDEX                 @D26IDAP 01204000
         SLL   R5,2              OFFSET WITHIN PBXAREA         @D52HDAP 01205000
         A     R5,APBXAREA       ADDRESS OF PUBX ADDRESS       @D52HDAP 01206000
         L     R9,0(,R5)         ADDRESS OF PUBX ENTRY         @DSCSI   01207000
         USING PBXADR,R9         PUBX BASE POINTER             @DSCSI   01208000
         ICM   R5,15,PBXSIMAD    SIMULATION PROGRAM ACTIVE     @D52HDAP 01209000
         BZ    SVC0SQ60          NO,                           @D26IDAP 01210000
         AIF   (NOT &VSE280).N280060                           @DSCSI   01211000
         TM    PBXFLAG,PBXDASD+PBXSCSI IS THIS A SCSI DEVICE   @DSCSI   01212000
         BO    SVC0SQ60          YES,                          @DSCSI   01213000
.N280060 ANOP                                                  @DSCSI   01214000
         AIF   (NOT &TEST).NTST020                             @D311    01214200
         TM    PBXFLAG,PBXTAPE   IS THIS A VTAPE DEVICE        @VTAPE   01214400
         BO    SVC0SQ80          YES,                          @VTAPE   01214690
.NTST020 ANOP                                                  @VTAPE   01214800
         DROP  R9                RELEASE PUBX BASE POINTER     @DSCSI   01215000
.*                                                                      01215100
.*       USER TASK MUST NOW BE UNPOSTED TO PREVENT THIS TASK            01215200
.*       FROM OCCUPYING THE 2ND SAVE AREA WHICH WE NEED AT              01215300
.*       THE TIME WHEN THE SCHEDULER IS HANDLING THIS REQUEST           01215400
.*                                                                      01215500
         LR    R9,R1             SAVE CCB POINTER              @DA43697 01216000
         LR    R1,R4             FORCE CONDITIONAL POSTING     @DA43697 01217000
         LA    R1,0(,R1)         CLEAR HIGH ORDER BYTE         @DA43697 01218000
         L     R5,ASRQTAB        RESOURCE QUEUE TABLE BASE     @D61MPAP 01219000
         LA    R5,SRQVDS-SRQTAB(,R5) WAIT QUEUE                @DA43510 01220000
         BAL   RF,UNPOST         UNPOST USER TASK              @D52HDAP 01221000
*SGLINK  UNPOST,INPUT=(R5,R6,RF),WORK=(R5,RE)                  @D52HDAP 01222000
         LR    R1,R9             RESTORE CCB POINTER           @DA43697 01223000
         CLI   PUBDEVTY,TFBA     FBA DEVICE GROUP              @DSCSI   01224000
         BE    SVC0SQD0          YES, SKIP FBA SYSFIL CODE     @D66ADAP 01225000
SVC0SQ60 CLI   PUBDEVTY,TFBA     FBA DEVICE GROUP              @D26IDAP 01226000
         BNE   SVC0SQ65          HIGH, CHECK FOR OTHER TYPES   @D26IDAP 01227000
         TM    CHQPROC,CHQSFFBA  SVC103 REQUEST-FBA SYSFIL     @D35DDEP 01228000
         BZ    SVC0SQD0          NO, CONTINUE PROCESSING       @D36IDAP 01229000
         L     R5,ASRQTAB        RESOURCE QUEUE TABLE BASE     @D61MPAP 01230000
         LA    R5,SRQSFIL-SRQTAB(,R5) SYSFILE BOUND QUEUE      @D61MPAP 01231000
         BAL   RF,UNPOST         DONT LET USER GET CONTROL     @D36IDAP 01232000
*SGLINK  UNPOST,INPUT=(R5,R6,RF),WORK=(R5,RE)                  @D369DAP 01233000
         B     SVC0SQD0          END OF ROUTINE                @D35DDEP 01234000
         DROP  R8                RELEASE TIB BASE POINTER      @DA43697 01235000
SVC0SQ65 CLI   PUBDEVTY,T3540    DISKETTE                      @D35IDEP 01236000
         BE    SVC0SQ70          YES, TREAT AS CKD-DASD        @D35IDEP 01237000
         CLI   PUBDEVTY,TCKD     IS THIS A CKD TYPE DEVICE     @D61NDAP 01238000
         BL    SVC0SQ80          NO, CERTAINLY NOT             @D61NDAP 01239000
         CLI   PUBDEVTY,TECKD    IS IT REALLY A DASD           @D61NDAP 01240000
         BH    SVC0SQA0          NO,                           @D61NDAP 01241000
SVC0SQ70 OI    CHQDEV,CHQDASD    SET PROPER DEVICE GROUP       @D35IDEP 01242000
         B     SVC0SQD0          TO END OF ROUTINE             @D35IDEP 01243000
SVC0SQ80 CLI   PUBDEVTY,TAPES    IS THIS A TAPE DEVICE         @D61NDAP 01244000
         BL    SVC0SQ90          NO, MUST THUS BE UNIT RECORD  @D61NDAP 01245000
         OI    CHQDEV,CHQTAPE    SET PROPER DEVICE GROUP       @D35IDEP 01246000
         B     SVC0SQD0                                        @D35IDEP 01247000
SVC0SQ90 OI    CHQDEV,CHQURC     SET PROPER DEVICE GROUP       @D35IDEP 01248000
         B     SVC0SQD0                                        @D35IDEP 01249000
SVC0SQA0 CLI   PUBDEVTY,TTP      TP DEVICE GROUP               @D61NDAP 01250000
         BL    SVC0SQD0          NO, CANT BE CRT DEVICE        @D35IDEP 01251000
         CLI   PUBDEVTY,T2260    CRT                           @D35IDEP 01252000
         BE    SVC0SQB0          YES, SET DEVICE GROUP         @D35IDEP 01253000
         CLI   PUBDEVTY,T3277    CRT                           @D35IDEP 01254000
         BNE   SVC0SQC0          CHECK FOR OTHER TP DEVICES    @D35IDEP 01255000
SVC0SQB0 OI    CHQDEV,CHQCRT     CRT DEVICE GROUP              @D35IDEP 01256000
SVC0SQC0 CLI   PUBDEVTY,TCTCA    HIGH END OF TP DEVICES        @D61NDAP 01257000
         BH    SVC0SQD0          NO LOGICAL PROCESSING NEEDED  @D35IDEP 01258000
         OI    CHQDEV,CHQTP      TP DEVICE GROUP               @D35IDEP 01259000
SVC0SQD0 MVI   CHQERRCT,ZERO     RESET ERROR RETRY COUNTER     @D35IDAP 01260000
         BAL   RE,RMSGETP2       GET PUB2 ADDRESS              @D35IDAP 01261000
*SGLINK  RMSGETP2,INPUT=(R3,R6,RE),OUTPUT=R8,WORK=RB           @D369DAP 01262000
         USING PUB2ADR,R8        PUB2 BASE POINTER             @D35IDEP 01263000
         L     RB,PIBPTR2        ADDRESS OF PIB                @D51GDAP 01264000
         USING PIB2ADR,RB        PIB2 BASE POINTER             @D51GDAP 01265000
         L     RB,PIBPCB         PCB BASE ADDRESS              @D51GDAP 01266000
         USING PCBADR,RB         PCB BASE POINTER              @D51GDAP 01267000
         L     RB,PCEPIB         PIB BASE ADDRESS              @D51GDAP 01268000
         USING PIBADR,RB         PIB BASE POINTER              @D51IDAP 01269000
         TM    CHQCCBB3,ERRTIN   IS THIS ERP REQUEST           @DA00214 01270000
         BO    SVC0SQE0          YES , DO NOT COUNT USAGE      @DA00214 01271000
         ICM   RE,M7,P2USAGE     GET OLD USAGE                 @DA00214 01272000
         LA    RE,D1(RE)         UPDATE USAGE                  @DA00214 01273000
         STCM  RE,M7,P2USAGE     STORE UPDATED USAGE           @DA00214 01274000
         DROP  R8                RELEASE PUB2 BASE POINTER     @D35IDEP 01275000
.*                                                             @D35IDAP 01276000
.*       CHECK WHETHER APPENDAGE IS SPECIFIED AND ALLOWED      @D35IDAP 01277000
.*                                                             @D35IDAP 01278000
SVC0SQE0 CLC   CHQTID,IORQ4AR    IS THIS A SYSTEM OR AR REQUEST@D66ADAP 01279000
         BNH   SVC0ENQQ          YES, COULD USE APPENDAGE      @DAOM    01280000
         TM    CHQCCBB3,APPEN    IS APPENDAGE ROUTINE PRESENT  @D35IDAP 01281000
         BZ    SVC0ENQQ          NO                            @D35IDAP 01282000
         TM    PIBPUBAS,APPEN    IS CHANNEL APPENDAGE ALLOWED  @D51IDAP 01283000
         BO    SVC0ENQQ          NO, IGNORE APPENDAGE REQUEST  @D35ZDAP 01284000
         NI    CHQCCBB3,XFF-APPEN DONT ALLOW APPENDAGE EXIT    @D35IDAP 01285000
         B     SVC0ENQQ          GET REQUEST NOW ENQUEUED      @D21ODAP 01286000
         TITLE 'VSE SUPERVISOR     SGIOS     ENQUEUE CHANQ ENTRY      ' 01287000
.**************************************************************@D35IDEP 01288000
.*                                                             @D35IDEP 01289000
.* FUNCTION- ADD AN I/O REQUEST TO THE REQUEST QUEUE (CHANQ)   @D35IDEP 01290000
.*           OF THE GIVEN PUB (REPRESENTING A DEVICE).         @D35IDEP 01291000
.* INPUT-    REG4= ADDRESS OF CHANQ ENTRY TO BE ENQUEUED       @D35IDEP 01292000
.*           REGC= CHANQ INDEX OF TO-BE-ENQUEUED               @D35IDEP 01293000
.*           REG7= PRIORITY OF TO-BE-ENQUEUED                  @D21ODAP 01294000
.*           REG3= ADDRESS OF PUB                              @D35IDEP 01295000
.* OUTPUT-   REQUEST WILL BE ENQUEUED DUE TO ITS PRIORITY      @D35IDEP 01296000
.*           PUB STATUS IS SAVED IN CURRENT 1ST CHANQ ENTRY    @D35IDEP 01297000
.*                                                                      01298000
.* REGS USED-REG9= ADDR OF CURRENT ELE IN CHANQ BEING SEARCHED          01299000
.*           REG8= INDEX OF CURRENT ELEMENT                             01300000
.*           REGE= PRIORITY OF CURRENT ELEMENT                          01301000
.*           REGF= ADDR OF PREVIOUS ELEMENT IN CHAIN                    01302000
.*           REG5= ADDR OF NEXT ELE WHEN STATUS NEEDS SAVING            01303000
.* EXITS-    DISPATCHER IF REQUEST IS NOT QUEUED FIRST                  01304000
.*           INITRG- IF REQUEST SHOULD BE STARTED NOW                   01305000
.*                                                                      01306000
.**************************************************************         01307000
SVC0ENQQ CLC   CHQTID,IORQ4SNS    WAS THIS A SNS REQUEST       @D66ADAP 01308000
         BNE   SVC0EQ05           NO                           @DA43408 01309000
         L     R8,AMISINTA        LOAD MIH BASE                @DA43408 01310000
         USING MISINTAT,R8        SGMIH BASE POINTER           @DA43408 01311000
         MVC   MIHACTSV(8),MIHCACTO SAVE ACTIVE OLD TIME STAMP @DA43408 01312000
         STCK  MIHCACTO           SET SNS START TIME FOR MIH   @DA43408 01313000
         DROP  R8                 DROP MIH BASE                @DA43408 01314000
SVC0EQ05 SLR   R8,R8              CLEAR CHANQ NEXT INDEX       @D35IDEP 01315000
         SLR   RE,RE              CLEAR NEXT PRIORITY REGISTER @D35IDEP 01316000
         SLR   R9,R9              CLEAR CHANQ LAST POINTER     @D51ODGL 01317000
         IC    R8,PUBCHQPT        CHANQ INDEX LOW              @D51ODGL 01318000
         AIF   (&AG1 LE 254).LOD0040                           @D51ODGL 01319000
         ICM   R8,2,PUBCHQPH      CHANQ INDEX HIGH             @D51ODGL 01320000
.LOD0040 ANOP                                                  @D51ODGL 01321000
         CLI   PUBCHQPT,NOTQUED   IS A REQUEST QUEUED TO PUB   @D51ODGL 01322000
         BNE   SVC0EQ20           YES, MORE CHECKING REQUIRED  @D51ODGL 01323000
         STC   RC,PUBCHQPT        QUEUE IT TO PUB              @D51ODGL 01324000
         AIF   (&AG1 LE 254).LOD0045                           @D51ODGL 01325000
         STCM  RC,2,PUBCHQPH      WITH LOW AND HIGH BYTE       @D51ODGL 01326000
.LOD0045 ANOP                                                  @D51ODGL 01327000
         SLR   R5,R5              INDICATE NOT HEADQUEUED      @D51ODGL 01328000
         B     SVC0EQ90           SKIP PRIORITY CHECK          @D51ODGL 01329000
         SPACE 2                                               @D62NDAP 01330000
         DROP  R4                 RELEASE TO-BE-ENQUEUED BASE  @D35IDEP 01331000
         USING CHQADR,R9          NEXT-IN-CHAIN BASE POINTER   @D369DAP 01332000
SVC0EQ10 CLI   0(R9),NOTQUED      END OF CHAIN                 @D51ODGL 01333000
         BNE   SVC0EQ15           NO, KEEP GOING               @D51ODGL 01334000
         STC   RC,CHQCHNLO        INSERT LOW CHAINING BYTE     @D51ODGL 01335000
         AIF   (&AG1 LE 254).LOD0310                           @D51ODGL 01336000
         STCM  RC,2,CHQCHNHI      AND HIGH BYTE                @D51ODGL 01337000
.LOD0310 ANOP                                                  @D51ODGL 01338000
         BR    R6                 DONE ====================>>> @D51ODGL 01339000
SVC0EQ15 IC    R8,CHQCHNLO        GET INDEX OF NEXT-IN-CHAIN   @D51ODGL 01340000
         AIF   (&AG1 LE 254).LOD0320                           @D51ODGL 01341000
         ICM   R8,2,CHQCHNHI      TAKE HIGH BYTE OF POINTER    @D51ODGL 01342000
.LOD0320 ANOP                                                  @D51ODGL 01343000
         SPACE 2                                               @D62NDAP 01344000
SVC0EQ20 LR    RF,R9              SAVE LAST-IN-CHAIN ADDRESS   @D51ODGL 01345000
         LR    R9,R8              NEXT-IN-CHAIN ENTRY NUMBER   @D369DAP 01346000
         SLL   R9,CHQSLEN         OFFSET OF NEXT-IN-CHAIN      @D369DAP 01347000
         A     R9,ACHANQ          ADDRESS OF NEXT-IN-CHAIN     @D369DAP 01348000
         ICM   R9,8,H0            CLEAR HIGH ORDER BYTE        @D68REEF 01349000
         SLR   RE,RE              CLEAR REGISTER               @D66ADAP 01350000
         ICM   RE,3,CHQTID        GET ITS TASK ID              @D66ADAP 01351000
         CH    RE,IJBHSTID        IS THIS A SYSTEM TASK REQUEST@D51IDAP 01355000
         BH    SVC0EQ50           NO, GET ITS STORAGE KEY      @D51IDAP 01356000
         LTR   RF,RF              IS THIS THE FIRST IN CHAIN   @DA44841 01357000
         BNZ   SVC0EQ25           NO,                          @DA44841 01358000
         TM    PUBCSFLG,QEDERR    IS ERP IN PROCESS            @DA44841 01359000
         BZ    SVC0EQ25           NO, NORMAL ENQUEUING         @DA44841 01360000
         TM    CHQFLG1-CHQADR(R4),CHQHQA IS TO-BE-ENQUEUED A HQ@DA44841 01361000
         BO    SVC0EQ60           YES, QUEUE THIS ONE AHEAD    @DA44841 01362000
.*                                                             @D61NDAP 01363000
.*       COMPARE NEXT/FIRST IN CHAIN AND TO-BE-ENQUEUED PRTY   @D61NDAP 01364000
.*                                                             @D61NDAP 01365000
SVC0EQ25 IC    RE,HQUPRI(RE)      GET ITS I/O PRIORITY NUMBER  @D21ODAP 01366000
         CLR   R7,RE              IS TO-BE-ENQUEUED HIGHER PRTY@D21ODAP 01367000
         BL    SVC0EQ30           YES                          @DA43415 01368000
         TM    CHQFLG1-CHQADR(R4),CHQHQA IS TO-BE-ENQUEUED A HQ@DA43415 01369000
         BNO   SVC0EQ10           NO, FIND NEXT CHAIN ENTRY    @DA43415 01370000
         TM    CHQFLG1-CHQADR(R9),CHQHQA IS NEXT-IN-CHAIN HQ   @DA43415 01371000
         BO    SVC0EQ10           YES, FIND NEXT CHAIN ENTRY   @DA43415 01372000
SVC0EQ30 TM    CHQFLG1-CHQADR(R4),CHQHQA IS TO-BE-ENQUEUED A HQ@D21ODAP 01373000
         BO    SVC0EQ35           YES, NEED ADDITIONAL CHECKS  @D21ODAP 01374000
         CLI   CHQCCSIO-CHQADR(R9),ZERO REQUEST ALREADY STARTED@D21ODAP 01375000
         BE    SVC0EQ60           NO, TRY TO ENQUEUE BEFORE    @D21ODAP 01376000
         B     SVC0EQ10           YES, DONT QUEUE BEFORE       @D21ODAP 01377000
.*                                                             @D61NDAP 01378000
.*       HIGHER PRIORITY HEAD QUEUE REQUEST TO BE ENQUEUED     @D61NDAP 01379000
.*       OR LOWER PRIORITY HEAD QUEUE TO BE QUEUED BEFORE SVC-0@D61NDAP 01380000
.*                                                             @D61NDAP 01381000
SVC0EQ35 TM    PUBCSFLG,DEVBSY    IS DEVICE GATED              @D35IDEP 01382000
         BZ    SVC0EQ60           NO, ADD TO-BE-ENQUEUED BEFORE@D14CDOW 01383000
         TM    PUBCSFLG,QEDERR    IS ERP IN PROCESS            @D35IDEP 01384000
         BO    SVC0EQ60           YES, ADD TO-BE-ENQUEUE BEFORE@D14CDOW 01385000
         TM    CHQCCSIO,CHQCCACT  IS I/O REQUEST REALLY ACTIVE @D369DAP 01386000
         BZ    SVC0EQ60           NO,  ADD TO-BE-ENQUEUE BEFORE@D61NDAP 01387000
SVC0EQ40 LTR   RF,RF              IS THIS THE ACTIVE ENTRY     @D51ODGL 01388000
         BZ    SVC0EQ10           YES, WE NEED TO ENQUEUE AFTER@D51ODGL 01389000
         B     SVC0EQ60           NO, ADD TO-BE-ENQUEUED BEFORE@D61NDAP 01390000
.*                                                             @D61NDAP 01391000
.*       NON SYSTEM TASK REQUEST IS NEXT/FIRST IN CHAIN        @D61NDAP 01392000
.*                                                             @D61NDAP 01393000
SVC0EQ50 SLL   RE,2               MULTIPLY WITH 4              @D66ADAP 01394000
         AL    RE,ATIBATAB        ADDRESS OF ADDRESS OF TIB    @D66ADAP 01395000
         L     RE,0(,RE)          ADDRESS OF TIB               @D66ADAP 01396000
         L     RE,TIBPCB-TIBADR(RE) GET PCB ADDRESS            @D51IDAP 01397000
         USING PCBADR,RE          PCB BASE POINTER             @D51GDAP 01398000
         IC    RE,PCEKEY          GET STORAGE KEY              @D51IDAP 01399000
         DROP  RE                 RELEASE PCB BASE             @D51GDAP 01400000
         SRL   RE,4               LEAVE ZONE PORTION ONLY      @D51IDAP 01401000
         N     RE,F15             SET UNUSED BITS TO ZERO      @D51GDAP 01402000
         LA    RE,HQUPPRI-HQUPRI(RE) ADD SYSTEM TASK ENTRIES   @D51GDAP 01403000
         B     SVC0EQ25           RE POINTS TO PRIORITY        @D21ODAP 01404000
.*                                                             @D61NDAP 01405000
.*       HIGHER PRIORITY HEAD QUEUE REQUEST TO BE ENQUEUED     @D61NDAP 01406000
.*                                                             @D61NDAP 01407000
.*       RF IS EITHER ZERO (CHANQ ENTRY IS TO BE QUEUED TO PUB)@D51ODGL 01408000
.*          OR IT POINTS TO THE PRECEEDING CHANQ ENTRY         @D51ODGL 01409000
.*                                                             @D51ODGL 01410000
SVC0EQ60 LR    R5,R9              SAVE ADDR OF NEXT-IN-CHAIN   @D35IDEP 01411000
         LTR   RF,RF              REQUEST TO BE QUEUED TO PUB  @D51ODGL 01412000
         BNZ   SVC0EQ70           NO,                          @D51ODGL 01413000
         STC   RC,PUBCHQPT        MODIFY PUBCHQPT              @D51ODGL 01414000
         AIF   (&AG1 LE 254).LOD0060                           @D51ODGL 01415000
         STCM  RC,2,PUBCHQPH      SAVE HIGH BYTE CHANQ INDEX   @D51ODGL 01416000
.LOD0060 ANOP                                                  @D51ODGL 01417000
         DROP  R9                 DROP NEXT-IN-CHAIN BASE      @D51ODGL 01418000
         USING CHQADR,R4          TO-BE-ENQUEUED BASE          @D51ODGL 01419000
         STC   R8,CHQCHNLO        SAVE NEXT IN CHAIN INDEX     @D51ODGL 01420000
         AIF   (&AG1 LE 254).LOD0330                           @D51ODGL 01421000
         STCM  R8,2,CHQCHNHI      SAVE HIGH BYTE CHANQ INDEX   @D51ODGL 01422000
.LOD0330 ANOP                                                  @D51ODGL 01423000
         B     SVC0EQ90           JOIN MAIN PATH               @D51ODGL 01424000
SVC0EQ70 STC   RC,CHQCHNLO-CHQADR(,RF) STORE LOW CHANQ INDEX   @D51ODGL 01425000
         STC   R8,CHQCHNLO        STORE LOW CHANQ INDEX        @D51ODGL 01426000
         AIF   (&AG1 LE 254).LOD0340                           @D51ODGL 01427000
         STCM  RC,2,CHQCHNHI-CHQADR(RF) STORE HIGH CHANQ INDEX @D51ODGL 01428000
         STCM  R8,2,CHQCHNHI      STORE HIGH CHANQ INDEX       @D51ODGL 01429000
.LOD0340 ANOP                                                  @D51ODGL 01430000
         BR    R6                 DONE ====================>>> @D51ODGL 01431000
SVC0EQ90 SGSETUP UPDTIME,NEXTPCB=ASYSPCB,WR1=R8,WR2=RB,WR3=RC,         *01432000
               OPTION=OWNER                                             01433000
*        B     SVC0TFCS                ======================> @D51ODGL 01434000
         SPACE 2                                                        01435000
         DROP  RA                 RELEASE TCB POINTER          @D36IDAP 01436000
         DROP  RB                 RELEASE PIB POINTER          @D36IDAP 01437000
         TITLE 'VSE SUPERVISOR     SGIOS     TEST AND SAVE PUB FLAGS  ' 01438000
SVC0TFCS LTR   R5,R5              WAS REQUEST CHAINED AHEAD    @D21ODAP 01439000
         BZ    SVC0TF20           NO, START THE I/O REQUEST    @D35IDAP 01440000
         TM    CHQFLG1,CHQHQA     IS THIS A HEAD QUEUE REQUEST @D51ODAP 01441000
         BZ    SVC0REND           NO, DONT CHANGE PUB BITS     @D51ODAP 01442000
         TM    PUBCSFLG,DEVBSY    SAVE BUSY STATUS             @D35IDEP 01443000
         BZ    SVC0TF10           NO, CHECK FOR OTHER STATUS   @D35IDEP 01444000
         DROP  R4                 RELEASE TO-BE-ENQUEUED BASE  @D35IDEP 01445000
         USING CHQADR,R5          NEXT CHANQ-ENTRY BASE        @D35IDEP 01446000
         OI    CHQFLG1,CHQCSBSY   SAVE THAT BIT                @D35IDEP 01447000
SVC0TF10 TM    PUBCSFLG,QEDERR    SAVE QUEUED-IN-ERROR STATUS? @D35IDEP 01448000
         BZ    SVC0TF20           NO, CHECK OTHER STATUS       @D35IDEP 01449000
         OI    CHQFLG1,CHQCSQED   SAVE THAT BIT                @D35IDEP 01450000
         DROP  R5                 RELEASE NEXT CHANQ-ENTRY BASE@D35IDEP 01451000
         USING CHQADR,R4          REESTABLISH NORMAL USING     @D35IDEP 01452000
SVC0TF20 TM    CHQFLG1,CHQHQA     IS THIS A HEAD QUEUE REQUEST @D35IDAP 01453000
         BZ    SVC0REND           NO, THEN TRY TO START I/O    @D35IDAP 01454000
         NI    PUBCSFLG,XFF-DEVBSY-QEDERR-OPINTV RESET GATES   @D14CDAP 01455000
         DROP  ,                                                        01456090
         EJECT ,                                                        01456180
         USING SYSS00,R0          LOW CORE BASE POINTER                 01456270
         USING CCBADR,R1          CCB BASE POINTER                      01456360
         USING PUBADR,R3          PUB BASE POINTER                      01456450
         USING CHQADR,R4          CHANQ BASE POINTER                    01456540
         USING DISP,R6            DISP BASE POINTER                     01456630
         USING SGIOS,RD           SGIOS BASE POINTER           @D369DAP 01456720
SVC0REND TM    PUBCSFLG,OPINTV    IS DEVICE READY              @DA44462 01457000
         BOR   R6                 NO,  ====================>>> @DA44462 01458000
         LR    R5,R6              COPY EXIT POINTER                     01459000
         L     RA,PIBPTR2         ADDRESS OF PIB2              @D51GDAP 01466000
         USING PIB2ADR,RA         PIB2 BASE POINTER            @D51GDAP 01467000
         L     RA,PIBPCB          PCB BASE ADDRESS             @D51GDAP 01468000
         USING PCBADR,RA          PCB BASE POINTER             @D51GDAP 01469000
         L     RA,PCEPIB          PIB BASE ADDRESS             @D51GDAP 01470000
         DROP  RA                 RELEASE PCB BASE POINTER     @D51GDAP 01471000
         L     RD,INITBASE        SCHEDULER BASE ADDRESS       @D35IDAP 01472000
         USING SGSCHED,RD         MAKE SCHEDULER ADDRESSABLE   @D35IDAP 01473000
         B     INITEXCP                =====================>> @D35IDAP 01474000
         DROP  RD                 RELEASE SGSCHED BASE         @D21ODAP 01475000
         DROP  R4                 RELEASE CHANNEL QUEUE BASE   @D36IDAP 01476000
         DROP  R6                 RELEASE DISP BASE            @D36IDAP 01477000
         AIF   (NOT &VSEMSG).NMSG020                           @D66ADAP 01479000
         EJECT ,                                                        01480000
         USING PCBADR,RF          PCB BASE ADDRESS             @DAOM    01481000
         USING EXITBLK,RE         EXITBLK BASE POINTER         @DAOM    01482000
         USING SGIOS,RD           COMMON BASE FOR SGIOS        @DAOM    01483000
         USING TCBADR,RA          TCB BASE POINTER             $DAOM    01484000
         USING COMREG,R9          COMREG BASE POINTER          @DAOM    01485000
         USING DISP,R6            DISP BASE POINTER            @DAOM    01486000
CHK4REPL DS    0H'0'              MSG DATA STACK PROCESSING    @DAOM    01487000
         ICM   R9,15,SYSCENT+2    MSG COMMAND DATA PENDING     @DAOM    01488000
         DROP  R9                 RELEASE COMREG BASE          @DAOM    01489000
         BZ    SVC00025           NO,                          @DAOM    01490000
         LA    R0,16              SET RETURN CODE FAIL         @DAOM    01491000
         AMODESW SET,AMODE=31,WR=(R7) EXITBLK MAY BE ABOVE     @DAOM    01492000
         ICM   R7,15,EXITADR      OC EXIT AVAILABLE AND ACTIVE @DAOM    01493000
         BZ    CHK4FREE           NO, FREE THE STORAGE         @DAOM    01494000
         TM    EXITFLG1,EXOCPARM+EXOCSAV SPECIAL INTERFACE     @DAOM    01495000
         BNZ   CHK4FREE           YES,                         @DAOM    01496000
         TM    CCBCLS,XCPR        IS THIS AN EXCP-REAL REQUEST @DAOM    01497000
         BO    CHK4FREE           YES, DON'T HANDLE            @DAOM    01498000
         L     R7,CCBCCW          GET CCW ADDRESS              @DAOM    01499000
         LA    R7,0(,R7)          RESET HIGH ORDER BIT/BYTE    @DAOM    01500000
         CLI   0(R7),X'0A'        IS THIS A READ COMMAND       @DAOM    01501000
         BNE   CHK4RXIT           NO,                          @DAOM    01502000
         TM    4(R7),CC+DC        ANY CHAINING                 @DAOM    01503000
         BNZ   CHK4FREE           YES,                         @DAOM    01504000
         SLR   R0,R0              INDICATE SUCCESSFULL         @DAOM    01505000
         LH    R4,6(,R7)          GET READ LENGTH              @DAOM    01506000
         SH    R4,0(,R9)          RESIDUAL COUNT               @DAOM    01507000
         BZ    CHK4R060           IS ZERO                      @DAOM    01508000
         BP    CHK4R040           DOES EXIST                   @DAOM    01509000
         SLR   R4,R4              SET RESIDUAL COUNT TO ZERO   @DAOM    01510000
CHK4R040 OI    CCBSTA2,X'40'      INCORRECT LENGTH             @DAOM    01511000
CHK4R060 STH   R4,CCBCNT          SAVE RESIDUAL COUNT          @DAOM    01512000
         MVI   CCBSTA1,CHANEND+DEVEND SET ENDING STATUS        @DAOM    01513000
         LTR   R4,R4              LESS DATA REQUESTED          @DAOM    01514000
         BZ    CHK4R080           YES,                         @DAOM    01515000
         LH    R4,0(,R9)          USE WHAT WE GOT              @DAOM    01516000
         B     CHK4R0A0           JOIN MAIN PATH               @DAOM    01517000
CHK4R080 LH    R4,6(,R7)          GET CCW BYTE COUNT           @DAOM    01518000
CHK4R0A0 BCTR  R4,0               ADJUST FOR EXECUTE           @DAOM    01519000
         SLR   R8,R8              CLEAR REGISTER               @DAOM    01520000
         ICM   R8,7,1(R7)         GET I/O AREA ADDRESS         @DAOM    01521000
         EX    R4,CHK4RMVC        MOVE THE DATA                @DAOM    01522000
         OI    CCBCOM1,TRABIT     POST USERS CCB               @DAOM    01523000
         TM    CCBBY3,APPEN       IS APPENDAGE PRESENT         @DAOM    01524000
         BO    CHK4R0C0           YES,                         $DAOM    01525000
         LA    R8,8(,R7)          LAST CCW+8 ADDRESS           @DAOM    01526000
         STCM  R8,7,CCBBY3+1      SAVE ADDRESS                 @DAOM    01527000
CHK4R0C0 LR    R8,R0              SAVE COMPLETION CODE         @DAOM    01528000
CHK4FREE LH    R0,0(R9)           LENGTH OF GETVIS AREA        @DAOM    01529000
         AH    R0,H2              ACCOUNT FOR LENGTH FIELD     @DAOM    01530000
         SFREEVIS LENGTH=(0),ADDRESS=(9)                       @DAOM    01531000
         DROP  RF                 RELEASE PCB     BASE         @DAOM    01532000
         L     R9,CRADDR          ADDRESS OF PARTITION COMREG  @D14CDAP 01533000
         USING COMREG,R9          COMREG BASE POINTER          @D14CDAP 01534000
         LTR   RF,RF              DID FREEVIS WORK OK                   01535000
         BNZ   CHK4FR10           NO,                          @DAOM    01536000
         STCM  RF,15,SYSCENT+2    CLEAR GETVIS POINTER         @DAOM    01537000
CHK4FR10 LTR   R8,R8              DID MSG INTERCEPT WORK OK    @DAOM    01538000
         BZR   R6                 YES, ====================>>> @DAOM    01539000
         DROP  R9                 RELEASE COMREG BASE          @DAOM    01540000
         SPACE 2                                               @DAOM    01541000
CHK4RXIT DS    0H'0'              RETURN TO MAIN LINE          @DAOM    01542000
         AMODESW SET,AMODE=24,WR=(R9) GET BACK INTO 24-BIT     @DAOM    01543000
         B     SVC00025           RETURN TO MAIN LINE          @DAOM    01544000
         SPACE 1                                               @DAOM    01545000
CHK4RMVC MVC   0(0,R8),2(R9)      MOVE DATE TO USERS AREA      @DAOM    01546000
         DROP  RE                 RELEASE EXITBLK BASE         @DAOM    01547000
         DROP  RD                 RELEASE SGIOS   BASE         @DAOM    01548000
         DROP  RA                 RELEASE TCB     BASE         @DAOM    01549000
         DROP  R6                 RELEASE DISP    BASE         @DAOM    01550000
.NMSG020 ANOP                                                  @D66ADAP 01551000
         DROP  R1                 RELEASE CCB BASE             @D36IDAP 01552000
         DROP  R3                 RELEASE PUB BASE             @D36IDAP 01553000
         SPACE 3                                                        01554000
HQUPRI   DC    XL16'00010203050F0B07080F09060C0F0F0D'          @DY46073 01555000
         DC    XL16'0F0F040A0F0F0F0F0F0F0F0F0F0F0F0F'          @D21ODAP 01556000
HQUPPRI  DC    XL16'202F2F2F2F2F2F2F2F2F2F2F2F2F2F2F'          @D21ODAP 01557000
HQUCNTL  DC    XL16'00081828880058384800000068780000'          @D61NDAP 01558000
         DC    XL16'00000000000000000000000000000000'          @DA41015 01559000
         DC    XL16'00000000000000000000000000000000'          @DA41765 01560000
         SPACE 3                                                        01561000
HQUCNTLD DSECT ,                  HEAD QUEUE CONTROL DSECT     @D35IDEP 01562000
HQUCNTLF DS    X                  HEAD QUEUE CONTROL FLAG      @D35IDEP 01563000
HQURIND  EQU   4                  4 BITS ARE RESERVED INDEX    @D35IDEP 01564000
HQURES   EQU   X'08'              TASK HAS RESERVED CHANQ ENTRY@D35IDEP 01565000
HQUHQ    EQU   X'04'              SVC15 INDICATOR              @D369DAP 01566000
&SYSECT  CSECT ,                                               @D369DAP 01567000
         TITLE 'VSE SUPERVISOR     SGIOS    CHECK EXTENT LIMIT ROUTINE' 01568000
.********************************************************************** 01569000
.*                                                                      01570000
.* FUNCTION- CHECK IF THE SEEK ARGUMENT PROVIDED BY THE USER            01571000
.*           IS COVERED BY AN EXTENT ENTRY FOR THIS LOGICAL UNIT        01572000
.* ENTRY POINT- EXTSIO00 FROM SVC00                                     01573000
.* INPUT-    RE= LOW EXTENT LIMIT                                       01574000
.*           RF= HIGH EXTENT LIMIT                                      01575000
.* OUTPUT-   R9= ADDRESS OF FOUND EXTENT ENTRY                          01576000
.* REGS USED-                                                           01577000
.*           R8= SUBRTN LINKAGE (TO EXTBLK00,EXTBLK50)                  01578000
.*                                                             @D51GDAP 01579000
.*           RE= WORK REGISTER                                          01580000
.*           RF= WORK REGISTER                                          01581000
.********************************************************************** 01582000
         USING SGIOS,RD           SGIOS BASE POINTER                    01583000
         USING DISP,R6            DISP BASE POINTER            @D35DDJO 01584000
EXTSIO00 EQU   *                  DASDFP EXTENT BLOCK CHECK    @D14BDAP 01585000
         ST    RB,EXTSIOSV        SAVE REGISTER                @D51GDAP 01586000
         L     RB,ASVC104         GET SVC104 BASE ADDRESS      @D51GDAP 01587000
         USING SVC104,RB          SVC104 BASE POINTER          @D51GDAP 01588000
         SLR   R0,R0              CLEAR WORK REGISTER          @D14BDAP 01589000
         BAL   R8,EXTBLK00        FIND 1ST EXTENT BLOCK        @D14BDAP 01590000
*SGLINK  EXTBLK00,INPUT=(R8,RB,RC,RD),OUTPUT=(R9,RC)           @D51GDAP 01591000
EXTSIO10 LTR   R9,R9              END OF CHAIN                 @D14BDAP 01592000
         BZ    EXTSIOEX           YES,                         @D51GDAP 01593000
         USING EXBLK,R9           EXTENT ENTRY BASE            @D14BDAP 01594000
         CL    RF,EXBLOW          IS SPECIFIED EXTENT LOWER    @DAOM095 01595490
         BL    EXTSIO20           YES, FIND ANOTHER ENTRY      @D14BDAP 01596000
         CL    RE,EXBHI           IS SPECIFIED EXTENT HIGHER   @DAOM095 01597490
         BNH   EXTSIO30           NO, GOT A MATCHING ENTRY     @D14BDAP 01598000
EXTSIO20 BAL   R8,EXTBLK50        LOOK AT NEXT EXTENT BLOCK    @D14BDAP 01599000
*SGLINK  EXTBLK50,INPUT=(R8,R9,RD),OUTPUT=(R9,RC)              @D369DAP 01600490
         B     EXTSIO10           LOOP CONTROL                 @D14BDAP 01601000
         SPACE 1                                               @D14BDAP 01602000
EXTSIO30 LA    R8,16              SFM INHIBIT LONG SEEK        @D14BDAP 01603000
         CLI   EXBHI+2,XFF        IS TRACK PROTECTION REQUIRED @D14BDAP 01604000
         BE    EXTSIO40           NO, JUST CYLINDER PROTECTION @D14BDAP 01605000
         LA    R8,24              SFM INHIBIT ANY SEEK         @D14BDAP 01606000
EXTSIO40 LR    R0,R8              SAVE FILE MASK               @D14BDAP 01607000
         TM    EXBFLG,EXBREAD     IS THIS EXTENT READ ONLY     @D14BDAP 01608000
         BZ    EXTSIOEX           NO,                          @D51GDAP 01609000
         LA    R8,64(,R8)         SFM INHIBIT ALL WRITE        @D14BDAP 01610000
         LR    R0,R8              SAVE FILE MASK IN R0         @D14BDAP 01611000
         B     EXTSIO20           FIND ANOTHER EXTENT ENTRY    @D14BDAP 01612000
EXTSIOEX L     RB,EXTSIOSV        RESTORE REGISTER CONTENTS    @D51GDAP 01613000
         DROP  RB                 RELEASE SVC104 BASE POINTER  @D51GDAP 01614000
         BR    R7                      =====================>> @D51GDAP 01615000
EXTSIOSV DC    F'0'               REGISTER SAVE AREA           @D51GDAP 01616000
ASVC104  DC    A(SVC104)          SVC104 BASE POINTER          @D51GDAP 01617000
ASVC103  DC    A(SVC103)          SVC103 BASE POINTER          @D52HDAP 01618000
         DROP  R9                 RELEASE EXTENT ENTRY BASE    @D14BDAP 01619000
         SPACE 3                                               @D51GDAP 01620000
         DROP  R6                 DISPATCHER BASE              @D36IDAP 01621000
         DROP  RD                 RELEASE SGIOS BASE           @D36IDAP 01622000
         TITLE 'VSE SUPERVISOR     SGIOS     FBA SYSFIL PROCESSING    ' 01623000
************************************************************            01624000
*                                                                       01625000
*   SVC 103: I/O REQUESTS FOR SYSTEM FILES ON FBA DEVICES               01626000
*                                                                       01627000
*************************************************************           01628000
*                                                                       01629000
         SPACE 2                                                        01630000
.********************************************************************** 01631000
.*                                                                      01632000
.* FUNCTION- PERFORM I/O FOR SYSTEM FILES ON FBA DEVICES.               01633000
.* ENTRY POINTS- SVC103 FROM ENTSVC                                     01634000
.*               SV103RET FROM DISPATCHER WHEN IOINTER HAS POSTED       01635000
.*               THE BIT CMOVECCB IN TIBFLAG .                          01636000
.* INPUT-    R1= ADDR OF INPUT CCB                                      01637000
.*           R6= ADDRESS OF DISPATCHER ROUTINE                          01638000
.*           RA= ADDR OF TCB OF REQUESTOR.                              01639000
.* OUTPUT-   COMM BYTES,STATUS AND TRAFFIC BIT IN CCB ARE SET.          01640000
.*           DATA IS MOVED BETWEEN USER I/O AREA AND DATA BUFFER.       01641000
.* LOGIC-                                                               01642000
.* SUB ROUTINES-                                                        01643000
.*       GETPUB - VALIDATE CCB ADDRESS, GET PUB ADDRESS                 01644000
.*       GETPV100 - GET PUB ADDRESS                                     01645490
.*       VALID -  VALIDATE USERS I/O AREA                               01646000
.*       DIBENTRY - FIND APPROPRIATE DIB                                01647000
.*       MODULE $IJBFBA - BLOCKING/DEBLOCKING ROUTINE IN SVA.           01648000
.* EXITS NORMAL- DISPATCHER IF PROCESSING SUCCESSFUL                    01649000
.*               SVC00010 - PERFORM SVC0 PROCESSING                     01650000
.*               RESVCX - REISSUE SVC 103 IF DIB IN USE                 01651000
.*               UNWTDQ2 - WAKE UP TASKS WAITING FOR THIS DIB           01652000
.* ERROR EXITS-  ERR0F - INVALID DISK ADDRESS                           01653000
.*               ERR1A - I/O ERROR                                      01654000
.*               ERR21 - ILLEGAL SVC                                    01655000
.********************************************************************** 01656000
         USING SGIOS,RD           SGIOS BASE POINTER                    01657000
         USING SVC103,RC          SVC103 BASE POINTER          @D52HDAP 01658000
         USING DISP,R6            DISP BASE POINTER            @D35DDJO 01659000
         USING TIBADR,R8          TIB BASE POINTER             @D36IDAP 01660000
         USING TCBADR,RA          TCB BASE POINTER             @D36IDAP 01661000
         USING PIBADR,RB          PIB BASE POINTER             @D36IDAP 01662000
         USING CCBADR,R1          CCB BASE                     @D36IDAP 01663000
SVC103   BAL   RE,GETPUB          ALLOCATE PUB ENTRY  =====>>> @D35DDJO 01664000
*SGLINK  GETPUB,INPUT=(R1,R6,RB,RD,RE),OUTPUT=(R3,R5),                 *01665000
               WORK=(R2,R7,R8,R9)                              @D369DAP 01666000
         DROP  R8                 RELEASE TIB POINTER          @D36IDAP 01667000
         USING PUBADR,R3          PUB BASE                     @D36IDAP 01668000
         TM    CCBBY3,CCBCCWF1    FORMAT1 CCW                  @D52VDAP 01669000
         BO    ERR21              YES, ====================>>> @D52VDAP 01670000
         L     R7,CCBCCW          LOAD ADDRESS OF CCW          @D36IDAP 01671000
         LA    R7,0(,R7)          CLEAR HIGH ORDER BYTE        @D21ODAP 01672000
         USING CCWADR,R7          CCW BASE                     @D36IDAP 01673000
         CLI   PUBDEVTY,TFBA      CORRECT PUB                  @D35DDJO 01674000
         BNE   ERR21              NO,  ====================>>> @D35DDJO 01675000
*                                                                       01676000
*   CHECK FOR READING PAST /&                                           01677000
*                                                                       01678000
         TM    CCBCLS,ONE         PROGRAMMER LOGIC UNIT        @D14BDAP 01679000
         BO    ERR21              YES, ====================>>> @D35DDJO 01680000
         CLI   CCBLNO,SYSIPT      READ REQUEST                 @D35DDJO 01681000
         BH    SVC103C            NO, DON' TEST                @D35DDJO 01682000
         TM    PIBFLG2,JOBDUN     /& ENCOUNTERED               @D51IDAP 01683000
         BO    ERR0F              YES, ====================>>> @D35DDJO 01684000
SVC103C  LR    R9,R1              SAVE CCB POINTER             @D35DDJO 01685000
         L     R1,CCWBUF          I/O AREA START ADDRESS       @D35DDJO 01686000
         LR    R2,R1              COPY START ADDRESS           @D35DDJO 01687000
         SLR   R8,R8              CLEAR R8                     @D35DDAP 01688000
         ICM   R8,3,CCWLNG        INSERT CCW COUNT             @D35DDAP 01689000
         AR    R2,R8              ADD LENTH OF I/O AREA        @D35DDAP 01690000
         BCTR  R2,R0              LAST BYTE OF I/O AREA                 01691000
         DROP  R7                 RELEASE CCW BASE             @D36IDAP 01692000
         BAL   R8,VALID           VALIDATE I/O AREA   =====>>> @D35DDJO 01693000
*SGLINK  VALID,INPUT=(R1,R2,R6,R8),OUTPUT=R5,WORK=R2           @D369DAP 01694000
         LR    R1,R9              RESTORE CCB POINTER          @D35DDJO 01695000
         L     RF,CRADDR          SET UP COMREG FOR DIBENTRY   @D35DDJO 01696000
         L     RD,INITBASE        SGSCHED BASE                 @D35DDJO 01697000
         USING SGSCHED,RD                                      @D35DDJO 01698000
         BAL   R8,DIBENTRY        RETURN DIB ADDRESS IN R5     @D35DDJO 01699000
*SGLINK  DIBENTRY,INPUT=(R1,R8,RD,RF),OUTPUT=R5                @D369DAP 01700000
         USING DIBFBA,R5          ADDRESS FBA DISK INFO BLOCK  @D35DDJO 01701000
         L     RD,IOSBASE         RESTORE BASE OF SGIOS        @D35DDJO 01702000
         USING SGIOS,RD                                        @D35DDJO 01703000
         OC    ULPBN(4),ULPBN     HAS DIB BEEN INITIALIZED     @DA30447 01704000
         BZ    ERR35              NO, ASSUME JCL OPEN FAILURE  @DA30447 01705000
         CLI   CCBLNO,SYSIPT      SYSIN REQUEST                @D35DDJO 01706000
         BH    SVC103D            NO                           @D35DDJO 01707000
         TM    DIBFLAGS,EOXT      INVALID DISK ADDRESS         @D35DDJO 01708000
         BO    ERR0F              YES, ====================>>> @D35DDJO 01709000
SVC103D  TM    DIBFLAGS,DIBFGATE  DIB ALREADY IN USE           @D35DDJO 01710000
         BNO   SVC103A            NO, CONTINUE                 @D35DDJO 01711000
         LR    R1,R5              PASS DIB POINTER             @D36IDAP 01712000
         DROP  R5                 RELEASE FBA DIB BASE POINTER @D37DDAP 01713000
         L     R5,ASRQTAB         RESOURCE QUEUE TABLE ADDRESS @D61MPAP 01714000
         LA    R5,SRQDIB-SRQTAB(,R5) DIB BOUND                 @D61MPAP 01715000
         B     RESVCX                  ====================>>> @D36IDAP 01716000
*SGLINK  RESVCX INPUT=(R5,R6),WORK=(R8,RF)                              01717000
         USING DIBFBA,R5          ADDRESS FBA DISK INFO BLOCK  @D37DDAP 01718000
SVC103A  OI    DIBFLAGS,DIBFGATE  SET DIB IN USE               @D35DDJO 01719000
         LA    R0,1               FIRST TIME INDICATION        @D35DDJO 01720000
SVC103B  L     RF,ASVASVDL        SVA SUPERVISOR DIRECTORY     @D14BDFG 01721000
         L     RF,AIJBFBA-SVASVDL(RF)  GET/PUT ROUTINE IN SVA  @D14BDFG 01722000
         LR    RD,RC              SAVE SVC-103 BASE            @D52VDAP 01723000
         BALR  RE,RF              SVC 103 EXTENSION IN SVA     @D35DDJO 01724000
*SGLINK  IJBFBA,INPUT=(R0,R1,R3,R5,RE,RF),                             *01725000
               WORK=(R2,R3,R4,R6,R7,R8,R9,RA,RC),OUTPUT=RF     @D52HDAP 01726000
         DROP  R6                 DROP DISPATCHER BASE         @D36IDAP 01727000
         DROP  R3                 RELEASE PUB POINTER          @D36IDAP 01728000
         DROP  RA                 DROP TCB BASE                @D36IDAP 01729000
         LR    RC,RD              RESTORE SVC-103 BASE POINTER @D52HDAP 01730000
         L     RD,IOSBASE         RESTORE GENERAL BASE POINTER @D52HDAP 01731000
         L     R6,DISPAD          RESTORE DISPATCHER ADDRESS   @D52HDAP 01732000
         USING DISP,R6            DISPATCHER BASE POINTER      @D52HDAP 01733000
         B     SVC103BV(RF)       TAKE SPECIFIED EXIT          @D52VDAP 01734000
SVC103BV B     SV103ERR         0 ERROR CONDITION              @D35DDJO 01735000
         B     SV103IO          4 I/O REQUIRED                 @D35DDJO 01736000
         B     SV103NRM         8 ALL DONE                     @D35DDJO 01737000
*                                                                       01738000
SV103NRM LR    R7,R6              COPY EXIT ADDRESS            @D36IDAP 01739000
SV103N1  NI    DIBFLAGS,XFF-DIBFGATE                           @D35DDJO 01740000
         LR    R1,R5              GET DIB POINTER              @D36IDAP 01741000
         DROP  R5                 RELEASE FBA DIB BASE POINTER @D37DDAP 01742000
         L     R5,ASRQTAB         RESOURCE TABLE ADDRESS       @D61MPAP 01743000
         LA    R5,SRQDIB-SRQTAB(,R5) DIB RESOURCE QUEUE        @D61MPAP 01744000
         BAL   RF,RPOST           POST TASKS WAITING FOR DIB   @D36IDAP 01745000
*SGLINK  RPOST,INPUT=(R5,R6,RF),WORK=(R5,RE)                   @D369DAP 01746000
         BR    R7                      ====================>>> @D36IDAP 01747000
*                                                                       01748000
SV103ERR BAL   R7,SV103N1         OPEN GATE, ACTIVATE WAITERS  @D35DDJO 01749000
         B     ERR21                   ====================>>> @D35DDJO 01750000
         SPACE 3                                                        01751000
         USING DIBFBA,R5          DIB BASE POINTER             @D36IDAP 01752000
SV103IO  L     R4,PDIBX           POINTER TO DIB EXTENSION     @D35DDJO 01753000
         USING DIBX,R4            DIB EXTENTION BASE POINTER   @D35DDJO 01754000
         MVC   CCBLNO-CCBADR(1,R4),CCBLNO COPY LNO             @DA33344 01755000
         LA    R1,DIBXIORB        IORB ADDRESS                 @D35DDJO 01756000
         OI    IORBREQ,IORBSF     INDICATE FBA SYSFIL REQUEST  @D35DDJO 01757000
         DROP  R4                 RELEASE DIB EXTENTION BASE   @D35DDJO 01758000
         L     RA,TCBPTR          RESTORE TCB POINTER          @D36IDAP 01759000
         USING TCBADR,RA          TCB BASE POINTER             @D369DAP 01760000
         DROP  R5                 RELEASE DIB POINTER          @D36IDAP 01761000
         SLR   R5,R5              KEY = 0 (IN SVA)             @D35DDJO 01762000
         BAL   RE,GETPV100        GET PUB ADDRESS     =====>>> @D35DDJO 01763590
*SGLINK  GETPV100,INPUT=(R1,R5,R6,RB,RD,RE),OUTPUT=(R3,R5,R7),         *01764180
               WORK=(R2,R9)                                    @D369DAP 01765000
         B     SVC00010                ======================> @D35DDJO 01766000
         DROP  RA                 RELEASE TCB POINTER          @D36IDAP 01767000
         DROP  RB                 RELEASE PIB POINTER          @D36IDAP 01768000
         DROP  RC                 RELEASE SVC103 BASE POINTER  @D52HDAP 01769000
         TITLE 'VSE SUPERVISOR     SGIOS    FBA SYSFIL POST PROCESSING' 01770000
*                                                                       01771000
*   RETURN POINT FROM DISPATCHER WHEN I/O IS COMPLETED                  01772000
*                                                                       01773000
         USING TCBADR,RA          TCB BASE POINTER             @D369DAP 01774000
SV103RET L     R8,TCBSAVE         PARTITION/TASK SAVE AREA     @D36IDAP 01775000
         USING SVEARA,R8                                       @D35DDJO 01776000
         L     R1,SVER01          USER U/R CCB                 @D35DDJO 01777000
         DROP  R8                                              @D35DDJO 01778000
         L     RF,CRADDR          PARTITION COMREG             @D35DDJO 01779000
         L     RD,INITBASE        SGSCHED BASE                 @D35DDJO 01780000
         USING SGSCHED,RD                                      @D35DDJO 01781000
         BAL   R8,DIBENTRY        FIND APPROPRIATE DIB         @D35DDJO 01782000
*SGLINK  DIBENTRY,INPUT=(R1,R8,RD,RF),OUTPUT=R5                @D369DAP 01783000
         USING DIBFBA,R5          DIB BASE POINTER             @D36IDAP 01784000
         LA    R0,2               2 ND TIME SWITCH FOR IJBFBA  @D35DDJO 01785000
         L     RF,ASVASVDL        SVA SUPERVISOR DIRECTORY     @D14BDFG 01786000
         L     RF,AIJBFBA-SVASVDL(RF)  GET/PUT ROUTINE IN SVA  @D14BDFG 01787000
         BALR  RE,RF              GO TO IJBFBA IN SVA          @D35DDJO 01788000
*SGLINK  IJBFBA,INPUT=(R0,R1,R3,R5,RE,RF),                             *01789000
               WORK=(R2,R3,R4,R6,R7,R8,R9,RA,RC),OUTPUT=RF     @D52HDAP 01790000
         DROP  R6                                                       01791000
         DROP  RA                 RELEASE TCB BASE POINTER     @D369DAP 01792000
         L     RD,IOSBASE         RESTORE GENERAL BASE POINTER @D52HDAP 01793000
         USING SGIOS,RD                                        @D35DDJO 01794000
         L     RC,ASVC103         RESTORE SVC103 ADDRESS       @D52VDAP 01795000
         USING SVC103,RC          SVC103 BASE POINTER          @D52VDAP 01796000
         L     R6,DISPAD          RESTORE DISPATCHER ADDRESS   @D52HDAP 01797000
         USING DISP,R6            DISPATCHER BASE POINTER      @D52HDAP 01798000
         B     SVC103PP(RF)       TAKE SPECIFIED EXIT          @D52VDAP 01799000
SVC103PP B     SV103ER3           ERROR RETURN                 @D35DDJO 01800000
         B     SV103ER3           I/O REQUIRED - NOT POSSIBLE  @D35DDJO 01801000
         B     SV103NRM           NORMAL RETURN                @D35DDJO 01802000
         DROP  R5                                              @D35DDJO 01803000
SV103ER3 BAL   R7,SV103N1         OPEN GATE, ACTIVATE WAITERS  @D35DDJO 01804000
         LA    RB,IOERR           FORCE I/O ERROR EXIT (ERR1A) @DA28721 01805000
         B     ERRNN                   ====================>>> @DA28721 01806000
         DROP  R1                 RELEASE CCB BASE             @D36IDAP 01807000
         DROP  RC                 RELEASE SVC-103 BASE         @D52HDAP 01808000
         DROP  RD                 RELEASE SGIOS GENERAL BASE   @D52HDAP 01809000
         DROP  R6                 RELEASE DISPATCHER BASE      @D35DDJO 01810000
         TITLE 'VSE SUPERVISOR     SGIOS     SVC104 VALIDATE PARAMETER' 01811000
.********************************************************************** 01812000
.*                                                                      01813000
.* FUNCTION    MAINTAIN EXTENT INFORMATION                              01814000
.*                                                                      01815000
.* ENTRY POINT SVC104 FROM SVC INTERRUPT HANDLER                        01816000
.*                                                                      01817000
.* INPUTS      R01      ADDRESS OF INPUT PARM LIST                      01818000
.*                                                                      01819000
.* OUTPUT      R15      RETURN CODE                                     01820000
.*                                                                      01821000
.* SUB ROUTINES                                                         01822000
.*       CALCPUB   TO ACCESS LUB AND PUB OF THE GIVEN LOGICAL UNIT.     01823000
.*       EXTADD00  ADD AN EXTENT ENTRY                                  01824000
.*       EXTDEA00  DELETE ALL EXTENT ENTRIES                            01825000
.*       EXTDEL00  DELETE A DEFINED EXTENT ENTRY                        01826000
.*       EXTCHK00  FIND A DEFINED EXTENT ENTRY                          01827000
.*                                                                      01828000
.* EXITS NORMAL    TO DISPATCHER (RF IN USERS SAVE AREA CONTAINS RC)    01829000
.*       ERROR     TO ERR25C IF AN INPUT ADDRESS IS INVALID             01830000
.********************************************************************** 01831000
         USING SGIOS,RD           SGIOS BASE POINTER           @D369DAP 01832000
         USING DISP,R6            DISP BASE POINTER            @D369DAP 01833000
         USING TIBADR,R8          TIB BASE POINTER             @D369DAP 01834000
         USING TCBADR,RA          TCB BASE POINTER             @D369DAP 01835000
         USING PIBADR,RB          PIB BASE POINTER             @D369DAP 01836000
         USING EXTADR,R1          EXTENT MACRO PARM LIST       @D35DDEP 01837000
SVC104   SLR   R0,R0              INDICATE NO ERROR            @D14BDAP 01838000
         LR    RB,RC              COPY SVC BASE POINTER        @D51GDAP 01839000
         USING SVC104,RB          SVC104 BASE POINTER          @D51GDAP 01840000
         L     R5,CRADDR          COMREG BASE ADDRESS          @D14BDAP 01841000
         USING COMREG,R5          COMREG BASE POINTER          @D14BDAP 01842000
         TM    LTACT,X'20'        USER WANTS FILE PROTECTION   @D14BDAP 01843000
         BZ    SVC104EX           NO, RETURN TO USER           @D14BDAP 01844000
         MVI   EXTWRK,ZERO        CLEAR WORK FIELD             @D37BDAP 01845000
         L     R3,EOVSADR         GET END OF VIRTUAL STORAGE   @D35DDEP 01846000
         LA    R4,EXTHI-1-EXTADR(R1) CHECK REQUIRED PARM LIST  @D14BDAP 01847000
         CR    R4,R3              PAST END OF VIRTUAL STORAGE  @D35DDEP 01848000
         BH    ERR25C             YES, ====================>>> @D35DDEP 01849000
         TM    EXTFLG,EXTDELA+EXTDELJC DELETE ALL REQUEST      @D14BDAP 01850000
         BNZ   EXTENT10           YES, DONT CHECK REST OF LIST @D14BDAP 01851000
         LA    R4,EXTLEN-1(R1)    CHECK EXTENT FIELDS ALSO     @D14BDAP 01852000
         CR    R4,R3              PAST END OF VIRTUAL STORAGE  @D35DDEP 01853000
         BH    ERR25C             YES, ====================>>> @D35DDEP 01854000
         L     RE,EXTHI           HIGH EXTENT LIMIT            @D369DAP 01855000
         LA    R4,3(RE)           EXTENT IS 4 BYTES            @D35DDEP 01856000
         CR    R4,R3              PAST END OF VIRTUAL STORAGE  @D35DDEP 01857000
         BH    ERR25C             YES, ====================>>> @D35DDEP 01858000
         L     RE,0(,RE)          HIGH CCHH OR BLKNO           @D14BDAP 01859490
         L     RF,EXTLOW          LOW EXTENT LIMIT             @D369DAP 01860000
         LA    R4,3(RF)           EXTENT IS 4 BYTES            @D35DDEP 01861000
         CR    R4,R3              PAST END OF VIRTUAL STORAGE  @D35DDEP 01862000
         BH    ERR25C             YES, ====================>>> @D35DDEP 01863000
         L     RF,0(,RF)          LOW  CCHH OR BLKNO           @D14BDAP 01864490
EXTENT10 L     R2,EXTLNO-1        LOGICAL UNIT ID              @D14BDAP 01865000
         LA    R4,1(R2)           UNIT ID IS TWO BYTES         @D369DAP 01866000
         CR    R4,R3              VALIDATE LNO ADDRESS         @D35DDEP 01867000
         BH    ERR25C                  ====================>>> @D35DDEP 01868000
         IC    R1,EXTFLG          SAVE OPTION FLAGS            @D35DDEP 01869000
         DROP  R1                 NO LONGER NEED PARM LIST     @D35DDEP 01870000
         DROP  R5                 RELEASE COMREG BASE POINTER  @D14BDAP 01871000
         L     R5,ASRQTAB         RESOURCE DESCRIPTOR ADDRESS  @D61MPAP 01872000
         LA    R5,SRQEXNT-SRQTAB(,R5) EXTENT BOUND             @D61MPAP 01873000
         USING RQADR,R5           RESOURCE DESCRIPTOR BASE     @D61MPAP 01874000
         TM    RSCDESC,FREEBIT    ROUTINE IN USE               @D61MPAP 01875000
         BZ    RESVCX             YES, ====================>>> @DY45385 01876000
*SGLINK  RESVCX INPUT=(R5,R6),WORK=(R8,RF)                     @DY45385 01877000
         L     R5,CRADDR          RESTORE COMREG BASE ADDRESS  @DY45385 01878000
         USING COMREG,R5          COMREG BASE POINTER          @DY45385 01879000
         TITLE 'VSE SUPERVISOR     SGIOS     SVC104 EXTENT INTERFACE '  01880000
*        USING INPUT,R1           R1 CONTAINS FUNCTION CODE    @D14BDAP 01881000
*        USING LNOPTR,R2          POINTER TO LNO FIELD         @D14BDAP 01882000
         USING COMREG,R5          COMREG BASE POINTER          @D14BDAP 01883000
*        USING EXTLOW,RF          POINTER TO LOW  CCHH OR BLKNO@D14BDAP 01884000
*        USING EXTHIGH,RE         POINTER TO HIGH CCHH OR BLKNO@D14BDAP 01885000
EXTENT20 MVI   RID+1,EXNTBND      INDICATE PAGE FAULT IN SVC104@D36IDAP 01886000
         SLR   R3,R3              CLEAR REGISTER               @D25IDAP 01889000
         ICM   R3,B'0011',0(R2)   GET LNO INFORMATION          @D25IDAP 01890000
         L     RC,BASESERI        SGSERI BASE ADDRESS          @D35CDFG 01890300
         USING SGSERI,RC          SGSERI BASE POINTER          @D35CDFG 01890600
         BAL   R7,CALCPUB         GET PUB AND LUB ADDRESS      @D35DDEP 01891000
*SGLINK  CALCPUB,INPUT=(R3,R6,R7,RC),OUTPUT=(R3,R4),WORK=R8    @D25IDAP 01892000
         DROP  RC                 RELEASE SGSERI BASE          @D35CDFG 01893000
         DROP  R8                 RELEASE TIB BASE             @D369DAP 01894000
         B     EXTRC004         0 ERROR RETURN                 @D149DAP 01895000
         LTR   R3,R3            4 NORMAL RETURN                @D149DAP 01896000
         BP    EXTENT30           DEVICE IS ASSIGNED           @D149DAP 01897000
         LA    R0,EXTNOTAS        INDICATE NO PUB ASSIGNED     @D149DAP 01898000
         USING PUBADR,R3          PUB BASE                     @D14BDAP 01899000
EXTENT30 STC   R1,EXTWRK          SAVE FUNCTION CODE           @D149DAP 01900000
         LR    RC,R4              COPY LUB ADDRESS             @D149DAP 01901000
         L     R8,PCBPTR          PCB ADDRESS                  @D51GDAP 01902000
         USING PCBADR,R8          PCB BASE POINTER             @D51GDAP 01903000
         S     RC,PCEALUB         SUBTRACT LUB ADDRESS         @D51DGAP 01904000
         DROP  R8                 RELEASE PCB BASE POINTER     @D51GDAP 01905000
         TM    EXTWRK,EXTDELJC    JOB CONTROL DELETE REQUEST   @D37BDAP 01906000
         BZ    EXTENT40           NO,                          @D149DAP 01907000
         TM    JCSW5,JCLACTIV     IS THIS A JCL-REQUEST        @D37BDAP 01908000
         BZ    EXTRC016           BAD INPUT PARAMETER          @D37BDAP 01909000
         SLR   R0,R0              ENFORCE ALL EXTENTS DELETION @D149DAP 01910000
         DROP  R5                 RELEASE COMREG BASE          @D35DDEP 01911000
EXTENT40 LTR   R0,R0              DID WE GET AN ERROR SO FAR   @D149DAP 01912000
         BNZ   EXTRC004           YES, TAKE EXIT               @D37BDAP 01913000
         CLI   PUBDEVTY,TFBA      IS IT FBA                    @D35DDEP 01914000
         BE    EXTENT60           YES, SKIP CKD CODE           @D149DAP 01915000
         TM    PUBDEVTY,DASD      DEVICE IS A CKD DEVICE       @D35DDEP 01916000
         BNO   EXTENT50           NO, CHECK IF JCL REQUEST     @D149DAP 01917000
         TM    PUBDEVTY,X'F0'-DASD REALLY CKD DASD             @D35DDEP 01918000
         BNZ   EXTENT50           NO, CERTAINLY NOT            @D149DAP 01919000
         TM    EXTWRK,EXTTRK      IS TRACK PROTECTION REQUIRED @D14BDAP 01920000
         BO    EXTENT60           YES,                         @D14BDAP 01921000
         ICM   RE,3,ADDRMASK+2    SET HEAD-NO. TO FFFF         @D14BDAP 01922000
         ICM   RF,3,F0            CLEAR HH PORTION LOW  LIMIT  @D14BDAP 01923000
         B     EXTENT60                                        @D14BDAP 01924000
         DROP  R3                 RELEASE PUB BASE POINTER     @D35DDEP 01925000
EXTENT50 TM    EXTWRK,EXTDELJC    IS THIS A JCL REQUEST        @D37BDAP 01926000
         BO    EXTDEA00           YES, PROCESS NEXT LUB IF ANY @D37BDAP 01927000
         B     EXTRC004           NO, TREAT AS NOT ASSIGNED    @D37BDAP 01928000
EXTENT60 TM    EXTWRK,EXTADD      ADD FUNCTION NEEDED          @D14BDAP 01929000
         BO    EXTADD00           YES, DO IT                   @D35DDEP 01930000
         TM    EXTWRK,EXTDEL      DELETE AN EXTENT NEEDED      @D35DDEP 01931000
         BO    EXTDEL00           YES, DO IT                   @D35DDEP 01932000
         TM    EXTWRK,EXTDELA     DELETE ALL FUNCTION NEEDED   @D35DDEP 01933000
         BO    EXTDEA00           YES, DO IT                   @D35DDEP 01934000
         TM    EXTWRK,EXTCHK      CHECK EXTENT FUNCTION NEEDED @D35DDEP 01935000
         BO    EXTCHK00           YES, DO IT                   @D35DDEP 01936000
         TM    EXTWRK,EXTDELJC    DELETE FOR ALL UNITS         @D37BDAP 01937000
         BO    EXTDEA00           YES, DO IT                   @D37BDAP 01938000
EXTRC016 LA    R0,EXTBPL          INDICATE INCORRECT PARAMETER @D35DDEP 01939000
         B     SVC104EX           EXIT                         @D35DDEP 01940000
EXTRC012 LA    R0,EXTNSPAC        NO SPACE AVAILABLE           @D35DDEP 01941000
         B     SVC104EX           RETURN TO USER               @D35DDEP 01942000
EXTRC008 LA    R0,EXTNMTCH        NO MATCHING EXTENT           @D35DDEP 01943000
         B     SVC104EX           RETURN TO USER               @D35DDEP 01944000
EXTRC004 LA    R0,EXTNOTAS        INVALID LNO SPECIFICATION    @D35DDEP 01945000
         B     SVC104EX           EXIT                         @D35DDEP 01946000
EXTRC000 SLR   R0,R0              INDICATE NO ERROR FOUND      @D35DDEP 01947000
SVC104EX L     R8,TCBSAVE         HAVE TO FILL RETURN CODE     @D36IDAP 01948000
         USING SVEARA,R8          USER SAVE AREA               @D35DDEP 01949000
         ST    R0,SVER0F          SET REG 15 OF USER           @D35DDEP 01950000
         DROP  R8                 RELEASE SAVE AREA BASE       @D35DDEP 01951000
         BR    R6                      ====================>>> @D35DDEP 01952000
         SPACE 2                                               @D35CDFG 01953000
EXTENTID DC    C'SPXTNT',XL2'00'  EXTENT SUB-POOL ID           @D14BDAP 01954000
         TITLE 'VSE SUPERVISOR     SGIOS     SVC104 ADD EXTENT ENTRY  ' 01955000
*        USING INPUT,R1           SUBFUNCTION INDICATOR                 01956000
*        USING PUBADR,R3          PUB BASE POINTER                      01957000
*        USING LUBADR,R4          LUB BASE POINTER                      01958000
*        USING INPUT,RC           LUB OFFSET                            01959000
*        USING EXTHIGH,RE         EXTENT HIGH CCHH OR BLKNO             01960000
*        USING EXTLOW,RF          EXTENT LOW  CCHH OR BLKNO             01961000
EXTADD00 EQU   *                                               @D35DDEP 01962000
.********************************************************************** 01963000
.*                                                                      01964000
.* FUNCTION- ADD AN EXTENT ENTRY FOR A GIVEN LOGICAL UNIT               01965000
.*                                                                      01966000
.* ENTRY POINT- EXTADD00 FROM EXTENT60                                  01967000
.*                                                                      01968000
.* INPUT-    RE= HIGH EXTENT IN CCHH OR BLK-NO                          01969000
.*           RF= LOW EXTENT IN CCHH OR BLK-NO                           01970000
.*           RC= OFFSET WITHIN LUB TABLE                                01971000
.*                                                                      01972000
.* OUTPUT-   RF= RETURN CODE                                            01973000
.*                                                                      01974000
.* REGS USED-R3= ADDR OF EXTENT ENTRY                                   01975000
.*           R8= SUBRTN LINKAGE (TO EXTBLK00,EXTBLK50)                  01976000
.*           R9= ADDR OF CURRENT EXTENT ENTRY IN CHAIN                  01977000
.*           RC= ADDR OF PREVIOUS EXTENT ENTRY IN CHAIN                 01978000
.*                                                                      01979000
.* SUB ROUTINES-                                                        01980000
.*       EXTBLK00- FIND 1ST EXTENT BLOCK                                01981000
.*       EXTBLK50- FIND NEXT EXTENT BLOCK                               01982000
.*                                                                      01983000
.* EXITS - TO SVC104EX                                                  01984000
.*                                                                      01985000
.********************************************************************** 01986000
         BAL   R7,EXTBCH00        TEST FOR MATCHING ENTRY      @D14BDAP 01987000
*SGLINK  EXTBCH00,INPUT=(R7,RC,RD,RE,RF),OUTPUT=(R9,RC),WORK=R8         01988490
EXTADD10 LTR   R1,R9              WAS MATCHING ENTRY FOUND     @D14BDAP 01989000
         BZ    EXTADD50           NO, ADD A NEW ONE            @D149DAP 01990000
         USING EXBLK,R1           CURRENT EXTENT ENTRY BASE    @D14BDAP 01991000
         TM    EXBFLG,EXBREAD     IS EXTENT FOR READ ONLY      @D14BDAP 01992000
         BZ    EXTADD30           NO, MUST BE A WRITE EXTENT   @D14BDAP 01993000
         TM    EXTWRK,EXTREAD     EXTENT INFORMATION FOR READ  @D14BDAP 01994000
         BO    EXTADD40           YES,                         @D14BDAP 01995000
EXTADD20 BAL   R7,EXTBCH20        POINT TO NEXT EXTENT ENTRY   @D14BDAP 01996000
*SGLINK  EXTBCH20,INPUT=(R7,RC,RD,RE,RF),OUTPUT=(R9,RC),WORK=R8         01997490
         B     EXTADD10           CHECK FOR MATCHING ENTRY     @D14BDAP 01998000
EXTADD30 TM    EXTWRK,EXTREAD     DOES USER ALLOW READ ONLY    @D14BDAP 01999000
         BO    EXTADD20           YES, FIND APPROPRIATE ENTRY  @D14BDAP 02000000
EXTADD40 LH    R8,EXBCOUNT        GET CURRENT USAGE COUNTER    @D14BDAP 02001000
         AH    R8,H1              ADD 1                        @D14BDAP 02002000
         BO    EXTRC012           OVERFLOW OCCURED             @D14BDAP 02003000
         STH   R8,EXBCOUNT        SAVE UPDATED COUNT           @D14BDAP 02004000
         B     SVC104EX           RETURN TO USER               @D14BDAP 02005000
         DROP  R1                 RELEASE EXTENT ENTRY BASE    @D14BDAP 02006000
EXTADD50 LR    R2,RF              SAVE LOW EXTENT LIMIT        @D14BDAP 02007000
         LA    R0,16              LENGTH OF GETVIS ENTRY       @D14BDAP 02008000
         LA    R1,EXTENTID        ADDRESS OF SPID              @D14BDAP 02009000
         L     R8,PCBPTR          PCB ADDRESS                  @DA44498 02010000
         USING PCBADR,R8          PCB BASE POINTER             @DA44498 02011000
         TM    PCEFLAG,PCEDYNP    IS THIS DYNAMIC PARTITION    @DA44498 02012000
         BO    EXTADDDP           YES, USE SPACE GETVIS        @DA44498 02013000
         SPACE 3                                                        02014000
         SGETVIS LENGTH=(0),SPID=(1),ADDRESS=(1)               @DA44498 02015000
         B     EXTADTRC           JOIN MAIN PATH               @DA44498 02016000
         SPACE 3                                                        02017000
EXTADDDP SGETVIS LENGTH=(0),SPID=(1),ADDRESS=(1),SPACE=YES     @DA44498 02018000
         SPACE 3                                                        02019000
         DROP  R8                 RELEASE PCB BASE             @DA44498 02020000
EXTADTRC LTR   R0,RF              RESTORE RETURN CODE TO ZERO  @D14BDAP 02021000
         BNZ   EXTRC012           NO, INDICATE RUN OUT OF SPACE@D14BDAP 02022000
         USING EXBLK,R1           CURRENT EXTENT BLOCK         @D14BDAP 02023000
         LR    RF,R2              RESTORE LOW EXTENT LIMIT     @D14BDAP 02024000
         ST    RE,EXBHI           SAVE HIGH EXTENT LIMIT       @D14BDAP 02025000
         ST    RF,EXBLOW          SAVE LOW  EXTENT LIMIT       @D14BDAP 02026000
         DROP  R1                 NEW EXTENT BLOCK COMPLETE    @D14BDAP 02027000
         USING EXBLK,RC           LAST EXTENT ENTRY BASE       @D14BDAP 02028000
         STCM  R1,7,EXBNXT        CHAIN NEW ENTRY TO LAST ONE  @D149DAP 02029000
         B     EXTADD40           UPDATE USAGE COUNT           @D14BDAP 02030000
         DROP  RC                 RELEASE EXTENT BLOCK BASE    @D37DDAP 02031000
         TITLE 'VSE SUPERVISOR     SGIOS    SVC104 DELETE EXTENT ENTRY' 02032000
.********************************************************************** 02033000
.*                                                                      02034000
.* FUNCTION- DELETE THE SPECIFIED EXTENT ENTRY FROM THE CHAIN           02035000
.*                                                                      02036000
.* ENTRY POINT- EXTDEL00 FROM EXTENT60                                  02037000
.* INPUT-    RE= ADDR OF HIGH EXTENT IN CCHH OR BLK-NO                  02038000
.*           RF= ADDR OF LOW EXTENT IN CCHH OR BLK-NO                   02039000
.*           RC= OFFSET WITHIN LUB TABLE                                02040000
.*                                                                      02041000
.* OUTPUT-   RF= RETURN CODE                                            02042000
.* REGS USED-R7= SUBRTN LINKAGE (TO EXTBCH00)                           02043000
.*           R8= SUBRTN LINKAGE (TO EXTBLK00,EXTBLK50)                  02044000
.*           R9= ADDRESS OF EXTENT ENTRY FOUND IN CHAIN                 02045000
.*                                                                      02046000
.* SUB ROUTINES-                                                        02047000
.*       EXTBCH00- CHECK EXTENTS SUBROUTINE                             02048000
.*                                                                      02049000
.* EXITS - TO SVC104EX                                                  02050000
.*                                                                      02051000
.********************************************************************** 02052000
EXTDEL00 BAL   R7,EXTBCH00        SEE IF EXTENT IN LISTS       @D35DDEP 02053000
*SGLINK  EXTBCH00,INPUT=(R7,RC,RD,RE,RF),OUTPUT=(R9,RC),WORK=R8         02054000
         LTR   R1,R9              MATCHING EXTENT              @D35DDEP 02055000
         BZ    EXTRC008           NO, SET ERROR CODE           @D35DDEP 02056000
         USING EXBLK,R1           EXTENT ENTRY BASE            @D14BDAP 02057000
         LH    R7,EXBCOUNT        GET CURRENT USAGE COUNT      @D14BDAP 02058000
         BCT   R7,EXTDEL10        DECREMENT USAGE COUNT        @D14BDAP 02059000
         BAL   R7,EXTDEQ00        DEQ THE BLOCK                @D35DDEP 02060000
*SGLINK  EXTDEQ00,INPUT=(R9,RC,RD),WORK=R3                     @D369DAP 02061000
         B     SVC104EX           RETURN TO USER               @D35DDEP 02062000
EXTDEL10 STH   R7,EXBCOUNT        RESTORE DECREMENTED COUNT    @D14BDAP 02063000
         B     SVC104EX           RETURN TO USER               @D14BDAP 02064000
         DROP  R1                 RELEASE EXTENT BASE POINTER  @D14BDAP 02065000
         SPACE 2                                                        02066000
.********************************************************************** 02067000
.*                                                                      02068000
.* FUNCTION- DELETE ALL EXTENT ENTRIES FOR A SPECIFIED UNIT             02069000
.*                                                                      02070000
.* ENTRY POINT- EXTDEA00 FROM EXTENT60                                  02071000
.* INPUT-    RC= OFFSET WITHIN LUB TABLE                                02072000
.*           R4= ADDRESS OF LUB                                         02073000
.*                                                                      02074000
.* OUTPUT-   EXTENT ENTRIES ARE RELEASED                                02075000
.*           LUB AND LUB2 ARE SET TO NO EXTENTS IF APPLICABLE           02076000
.*                                                                      02077000
.* REGS USED-R7= SUBRTN LINKAGE (TO EXTBCH00)                           02078000
.*           R8= SUBRTN LINKAGE (TO EXTBLK)                             02079000
.*           R9= ADDRESS OF EXTENT ENTRY IN CHAIN                       02080000
.*           RC= ADDRESS OF PREVIOUS EXTENT ENTRY                       02081000
.*                                                                      02082000
.* SUB ROUTINES-                                                        02083000
.*       EXTBCH00- DOES ACTUAL SEARCH                                   02084000
.*                                                                      02085000
.* EXITS - TO SVC104EX                                                  02086000
.*                                                                      02087000
.********************************************************************** 02088000
EXTDEA00 EQU   *                                               @D35DDEP 02089000
         BAL   R8,EXTBLK00        GET 1ST EXTENT ENTRY         @D35DDEP 02090000
*SGLINK  EXTBLK00,INPUT=(R8,RC,RD),OUTPUT=(R9,RC)              @D369DAP 02091000
EXTDEA10 LTR   R9,R9              WAS EXTENT ENTRY FOUND       @D35DDEP 02092000
         BZ    EXTDEA20           NO, END OF CHAIN             @D37DDAP 02093000
         BAL   R7,EXTDEQ00        YES, GET ENTRY DEQUEUED      @D369DAP 02094000
*SGLINK  EXTDEQ00,INPUT=(R9,RC,RD),WORK=R3                     @D369DAP 02095000
         LR    R9,RC              INVALIDATE DEQUEUED ENTRY    @D35DDEP 02096000
         BAL   R8,EXTBLK50        FIND NEXT EXTENT ENTRY       @D35DDEP 02097000
*SGLINK  EXTBLK50,INPUT=(R8,R9,RD),OUTPUT=(R9,RC)              @D369DAP 02098000
         B     EXTDEA10           TEST IF THIS WAS THE LAST ONE@D35DDEP 02099000
EXTDEA20 TM    EXTWRK,EXTDELJC    DELETE FOR ALL UNITS         @D37BDAP 02100000
         BZ    SVC104EX           NO, WHOLE CHAIN DELETED      @D37BDAP 02101000
         SLR   R3,R3              CLEAR REGISTER               @D25IDAP 02102000
         ICM   R3,B'0011',0(R2)   SAVE LNO FOR CALCPUB         @D25IDAP 02103000
         LA    R9,1(,R3)          UPDATE TO NEXT LOGICAL UNIT  @D37BDAP 02104000
         STH   R9,0(,R2)          STORE UPDATED UNIT ADDRESS   @D37BDAP 02105000
         SLR   R0,R0              INDICATE NO ERROR            @D37BDAP 02106000
         L     RC,BASESERI        SGSERI BASE ADDRESS          @D37BDAP 02107000
         USING SGSERI,RC          SGSERI BASE POINTER          @D37BDAP 02108000
         BAL   R7,CALCPUB         GET PUB AND LUB ADDRESS      @D37BDAP 02109000
*SGLINK  CALCPUB,INPUT=(R3,R6,R7,RC),OUTPUT=(R3,R4),WORK=R8    @D25IDAP 02110000
         DROP  RC                 RELEASE SGSERI BASE          @D37BDAP 02111000
         B     EXTRC000         0 ERROR EXIT ALL WORK IS DONE  @D37BDAP 02112000
         LR    RC,R4            4 COPY LUB ADDRESS             @D37BDAP 02113000
         L     R8,PCBPTR          PCB ADDRESS                  @D51GDAP 02114000
         USING PCBADR,R8          PCB BASE POINTER             @D51GDAP 02115000
         S     RC,PCEALUB         SUBTRACT LUB ADDRESS         @D51DGAP 02116000
         DROP  R8                 RELEASE PCB BASE POINTER     @D51GDAP 02117000
         B     EXTENT40           PROCESS NEXT LOGICAL UNIT    @D149DAP 02118000
         SPACE 5                                                        02119000
.********************************************************************** 02120000
.*                                                                      02121000
.* FUNCTION- DEQUEUE AN EXTENT ENTRY FROM EXTENT CHAIN                  02122000
.*                                                                      02123000
.* ENTRY POINT- EXTDEQ00 (FROM EXTDEL,EXTDEA)                           02124000
.*                                                                      02125000
.* INPUT-    R9= ADDRESS OF EXTENT ENTRY TO BE DEQUEUED                 02126000
.*           RC= ADDRESS OF PREVIOUS EXTENT ENTRY IN CHAIN              02127000
.*           R7= RETURN REGISTER TO CALLER                              02128000
.*                                                                      02129000
.* OUTPUT-   R9= ADDRESS OF EXTENT ENTRY                                02130000
.*           RC= ADDRESS OF PREVIOUS EXTENT ENTRY                       02131000
.*                                                                      02132000
.* EXITS - USING R7 TO CALLER                                           02133000
.********************************************************************** 02134000
EXTDEQ00 EQU   *                  DEQ AN EXTENT BLOCK          @D35DDEP 02135000
         MVC   EXBNXT-EXBLK(,RC),EXBNXT-EXBLK(R9) DELETE ENTRY @D14BDAP 02136000
         LA    R0,16              LENGTH OF EXTENT ENTRY       @D14BDAP 02137000
         SPACE 3                                                        02138000
         L     R8,PCBPTR          PCB ADDRESS                  @DA44634 02139000
         USING PCBADR,R8          PCB BASE POINTER             @DA44634 02140000
         TM    PCEFLAG,PCEDYNP    IS THIS DYNAMIC PARTITION    @DA44634 02141000
         BO    EXTDEQ10           YES, USE SPACE GETVIS        @DA44634 02142000
         SPACE 3                                                        02143000
         SFREEVIS LENGTH=(0),ADDRESS=(9)                       @DA44634 02144000
         B     EXTDEQRC           JOIN MAIN PATH               @DA44634 02145000
         SPACE 3                                                        02146000
EXTDEQ10 SFREEVIS LENGTH=(0),ADDRESS=(9),SPACE=YES             @DA44634 02147000
         DROP  R8                 RELEASE PCB BASE             @DA44634 02148000
         SPACE 3                                                        02149000
EXTDEQRC SLR   R0,R0              RESTORE RETURNCODE TO ZERO   @DA44634 02150000
         AIF   (NOT &BGDEBUG).NMC040                           @D14BDAP 02151000
         TM    IJBFLG08,IJBDEBUG  IS DEBUG ACTIVE              @DAOM065 02151300
         BZR   R7                 NO,                          @DAOM065 02151600
         LTR   RF,RF              DID SFREEVIS WORK PROPERLY   @D14BDOW 02152000
         BZR   R7                 YES, ======================> @D14BDAP 02153490
         MVI   IJBHWORG,HWORG100  HARD WAIT ID (EXTENT SVC)    @D31QDHB 02154000
         BAL   R5,SYSERROR        INDICATE SYSTEM ERROR        @D14BDAP 02155000
         AGO   .NMC04A                                                  02156000
.NMC040  ANOP                                                           02157000
         BR    R7                      ======================> @D35DDEP 02158000
.NMC04A  ANOP                                                           02159000
         TITLE 'VSE SUPERVISOR     SGIOS    SVC104  CHECK EXTENT ENTRY' 02160000
.********************************************************************** 02161000
.*                                                                      02162000
.* FUNCTION- CHECK IF THE GIVEN EXTENTS ARE IN THE EXTENT BLOCKS FOR    02163000
.*           THE GIVEN LOGICAL UNIT FOR ISSUEING PARTITION.             02164000
.* ENTRY POINT- EXTCHK00 FROM EXTENT60                                  02165000
.* INPUT-    RE= ADDR OF HIGH EXTENT IN CCHH OR NNNN FORMAT             02166000
.*           RF= ADDR OF LOW EXTENT IN CCHH OR NNNN FORMAT              02167000
.*           RC= DISPL. TO LUB FOR THIS LNO                             02168000
.*           CRADDR FOR ADDR OF LUB2 TABLE FOR THIS PARTITION           02169000
.* OUTPUT-   RETURN CODE IS SET IN USERS REG. 15                        02170000
.* REGS USED-R7= SUBRTN LINKAGE (TO EXTBCH00)                           02171000
.*           R8= SUBRTN LINKAGE (TO EXTBLK00,EXTBLK50)                  02172000
.*           R9= ADDR OF FOUND EXTENT BLOCK                             02173000
.*                                                                      02174000
.* SUB ROUTINES-                                                        02175000
.*       EXTBCH00- DOES ACTUAL SEARCH                                   02176000
.* EXITS - TO SVC104EX FOR NORMAL EXIT FROM CHECK FUNCTION              02177000
.********************************************************************** 02178000
EXTCHK00 EQU   *                  CHECK-EXTENT FUNCTION        @D14BDAP 02179000
         BAL   R7,EXTBCH00        CHECK EXTENT BLOCKS          @D35DDEP 02180000
*SGLINK  EXTBCH00,INPUT=(R7,RC,RD,RE,RF),OUTPUT=(R9,RC),WORK=R8         02181000
         LTR   R9,R9              WAS AN EXTENT FOUND          @D35DDEP 02182000
         BZ    EXTRC008           NO, INDICATE NO MATCHING ONE @D369DAP 02183000
         B     SVC104EX           YES, OK RETURN TO USER       @D35DDEP 02184000
         TITLE 'VSE SUPERVISOR     SGIOS     EXTENT SVC SUBROUTINES   ' 02185000
.********************************************************************** 02186000
.*                                                                      02187000
.* FUNCTION- EXTENT BLOCK CHAINING ROUTINES                             02188000
.* ENTRY POINT- EXTBLK00 TO ACCESS 1ST BLOCK                            02189000
.*              EXTBLK50 TO ACCESS NEXT BLOCK IN CHAIN                  02190000
.* INPUT-    RC= DISPLACEMENT TO LUB ENTRY FOR THIS LNO(EXTBLK00)       02191000
.*           R9= ADDR OF PREVIOUSLY FOUND EXTENT BLOCK(EXTBLK50)        02192000
.*           R8= RETURN REGISTER TO CALLER                              02193000
.*           CRADDR  ADDR OF USERS PARTITION COMM. REGION               02194000
.* OUTPUT-   R9= ADDR OF FOUND BLOCK OR 0 IF NONE FOUND                 02195000
.*           RC= ADDR OF LUB2 ENTRY(00) OR SAVED INPUT BLOCK(50)        02196000
.*                                                                      02197000
.*                                                                      02198000
.* EXITS -   VIA R8 TO CALLER                                           02199000
.********************************************************************** 02200000
*SGLINK  EXTBLK00,INPUT=(R8,RC,RD),OUTPUT=(R9,RC)              @D369DAP 02200500
EXTBLK00 EQU   *                  ACCESS 1ST EXTENT BLOCK      @D35DDEP 02201000
         L     R9,CRADDR          ADDRESS OF USERS COMREG      @D35DDEP 02202590
         USING COMREG,R9          COMREG BASE POINTER          @D35DDEP 02203180
         AR    RC,RC              CALCULATE OFFSET WITHIN      @D37BDAP 02204000
         AR    RC,RC              LUB EXTENTION TABLE (8-BYTE) @D37BDAP 02205000
         A     RC,LUBEXT          ADD LUB EXTENTION TABLE ADDR @D37BDAP 02206000
         USING LUBX,RC            LUB EXTENTION BASE POINTER   @D37BDAP 02207000
         LA    RC,LUBXEPT         LAST EXTENT ENTRY POINTER    @D37BDAP 02208000
         LR    R9,RC              CURRENT EXTENT ENTRY POINTER @D37BDAP 02209000
         DROP  RC                 RELEASE LUB EXTENTION BASE   @D37BDAP 02210000
         USING EXBLK,R9           CURRENT EXTENT BLOCK         @D35DDEP 02211000
EXTBLK10 L     R9,EXBNXT-1        NEXT EXTENT ENTRY ADDRESS    @D37BDAP 02212590
         ICM   R9,8,H0            CLEAR HIGH ORDER BYTE (FLAG) @DY46203 02213180
         BR    R8                      ======================> @D37BDAP 02214000
         DROP  R9                 RELEASE EXTENT ENTRY BASE    @D14BDAP 02215000
*SGLINK  EXTBLK50,INPUT=(R8,R9,RD),OUTPUT=(R9,RC)              @D369DAP 02215500
EXTBLK50 LR    RC,R9              SAVE CURRENT ADDR            @D35DDEP 02216000
         B     EXTBLK10           SEARCH FOR AN EXTENT BLOCK   @D35DDEP 02217000
         SPACE 5                                                        02218000
.********************************************************************** 02219000
.*                                                                      02220000
.* FUNCTION- CHECK IF THE GIVEN EXTENTS ARE IN THE EXTENT BLOCKS FOR    02221000
.*           THE GIVEN LOGICAL UNIT FOR ISSUEING PARTITION.             02222000
.* ENTRY POINT- EXTBCH00 FROM SVC00,EXTCHK,EXTDEL                       02223000
.* INPUT-    RE= ADDR OF HIGH EXTENT                                    02224000
.*           RF= ADDR OF LOW EXTENT                                     02225000
.*           R7= RETURN REGISTER                                        02226000
.* OUTPUT-   RETURN CODE IS SET IN USERS REG. 15                        02227000
.* REGS USED-                                                           02228000
.*           R8= SUBRTN LINKAGE (TO EXTBLK00,EXTBLK50)                  02229000
.*           R9= ADDR OF FOUND EXTENT ENTRY                             02230000
.*                                                                      02231000
.* EXITS -   VIA R8 TO CALLER                                           02232000
.********************************************************************** 02233000
*SGLINK  EXTBCH00,INPUT=(R7,RC,RD,RE,RF),OUTPUT=(R9,RC),WORK=R8         02233500
EXTBCH00 EQU   *                  DASDFP EXTENT BLOCK CHECK    @D35DDEP 02234000
         BAL   R8,EXTBLK00        FIND 1ST EXTENT BLOCK        @D14BDAP 02235000
*SGLINK  EXTBLK00,INPUT=(R8,RC,RD),OUTPUT=(R9,RC)              @D369DAP 02236000
EXTBCH10 LTR   R9,R9              END OF CHAIN                 @D35DDEP 02237000
         BZR   R7                 YES, ======================> @D35DDEP 02238000
         USING EXBLK,R9           CURRENT EXTENT BLOCK         @D14BDAP 02239000
         CL    RF,EXBLOW          DOES LOW EXTENT MATCH        @DAOM095 02240490
         BNE   EXTBCH20           CHECK FOR EXACT MATCH        @D14BDAP 02241000
         CL    RE,EXBHI           DOES HIGH EXTENT MATCH       @DAOM095 02242490
         BER   R7                 YES, ======================> @D14BDAP 02243000
*SGLINK  EXTBCH20,INPUT=(R7,RC,RD,RE,RF),OUTPUT=(R9,RC),WORK=R8         02243500
EXTBCH20 BAL   R8,EXTBLK50        LOOK AT NEXT EXTENT BLOCK    @D14BDAP 02244000
*SGLINK  EXTBLK50,INPUT=(R8,R9,RD),OUTPUT=(R9,RC)              @D369DAP 02245000
         B     EXTBCH10           LOOP CONTROL                 @D35DDEP 02246000
         DROP  R9                 RELEASE EXTENT ENTRY BASE    @D14BDAP 02247000
         SPACE 3                                               @D14BDAP 02248000
         DROP  RA                 RELEASE TCB POINTER          @D36IDAP 02249000
         DROP  RB                 RELEASE SVC104 BASE POINTER  @D51GDAP 02250000
         DROP  R6                 RELEASE DISP BASE            @D35EDAP 02251000
         DROP  RD                 RELEASE SGIOS BASE           @D35EDAP 02252000
         TITLE 'VSE SUPERVISOR     SGIOS     SVC 15 (HEAD QUEUE)      ' 02253000
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *@DM01647 02254000
*                                                              @DM01647 02255000
*        EXECUTE SYSTEM TASK EXCP (SYSIO)                      @DM01647 02256000
*                                                              @DM01647 02257000
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *@DM01647 02258000
         SPACE 1                                               @DM01647 02259000
         USING SGIOS,RD           SGIOS BASE POINTER           @D36IDAP 02260000
         USING DISP,R6            DISPATCHER BASE              @D36IDAP 02261000
         USING TIBADR,R8          TIB BASE POINTER             @D36IDAP 02262000
         USING TCBADR,RA          TCB BASE                     @D36IDAP 02263000
         USING PIBADR,RB          PIB BASE                     @D36IDAP 02264000
         USING CCBADR,R1          CCB BASE                     @D36IDAP 02265000
.**************************************************************@D35IDEP 02266000
.*                                                             @D35IDEP 02267000
.* FUNCTION- VALIDITY CHECK AND SET-UP HEAD QUEUE I/O REQUEST  @D35IDEP 02268000
.*           INORDER THAT SYSTEM TASK I/O IS STARTED IN A      @D35IDEP 02269000
.*           PRIORITY MANNER (NOTE SVC0 I/O IS FIFO).          @D35IDEP 02270000
.* INPUT-    ENTRY SVC 76 : RF ADDRESS OF CCB                  @DA35277 02271000
.*           ENTRY SVC 15 : R1 ADDRESS OF CCB                  @DA35277 02272000
.*           SELECT FIELD FOR SYSTEM TASK ID                   @D35IDEP 02273000
.*           FLPTR- CHANQ FREE LIST POINTER                    @D35IDEP 02274000
.*           CHQFLPTR- RESPECTIVELY FOR MORE DEVICES           @D51ODGL 02275000
.*           HQUPRI- SVC15 PRIORITY TABLE (ALSO INDEXS HQUCNTL)@D35IDEP 02276000
.*           HQUCNTL- CONTROL TABLE WITH TYPE AND RESERVED     @D35IDEP 02277000
.*                    FLAGS AND INDEX TO RESERVED CHANQ ENTRY  @D35IDEP 02278000
.* OUTPUT-   R1 : CCB ADDRESS                                  @D35IDEP 02279000
.*           OUTPUT OF GETPUB SUBROUTINE                       @D35IDEP 02280000
.*           HQUCNTL CONTAINS REQUEST TYPE INFO                @D35IDEP 02281000
.* REGS USED-R7 : PRIORITY OF REQUEST                          @D35IDEP 02282000
.*           RF : CONTROL ELEMENT ADDRESS                      @D35IDEP 02283000
.* EXITS-    RESVCX   - NO CHANNEL QUEUE ENTRY AVAILABLE       @D369DAP 02284000
.*           SVC00010 - MAIN PATH.                             @D369DAP 02285000
.*                                                             @D35IDEP 02286000
.**************************************************************@D35IDEP 02287000
SVC76    EQU   *                                               @DA35277 02288000
         LR    R1,RF              PROVIDE CCB ADRESS IN REG 1  @DA35277 02289000
         LA    RC,SVC15-SVC76(,RC) ADJUST ROUTINE BASE ADDRESS @D21ODAP 02290000
         USING SVC15,RC           SVC15 BASE POINTER           @D21ODAP 02291000
SVC15    LA    R1,0(,R1)          INDICATE SIMPLE SYST.I/O REQ @DA35277 02292000
         CLC   TID,IORQ4AR        IS IT A SYSTEM TASK REQ.     @D66ADAP 02293000
         BH    ERR21              NO,  ====================>>> @DA41765 02294000
         SLR   R7,R7              CLEAR REGISTER               @D66ADAP 02295000
         IC    R7,TID+1           GET SYSTEM TASK ID           @D66ADAP 02296000
         IC    R7,HQUPRI(R7)      INDEX INTO PRIORITY TABLE    @D35IDEP 02297000
         LA    RF,HQUCNTL(R7)     INDEX INTO CONTROL TABLE     @D52VDAP 02298000
         USING HQUCNTLD,RF        ADDRESS CONTROL BYTE         @D52VDAP 02299000
         TM    HQUCNTLF,HQURES    IS A RESERVED ENTRY AVAILABLE@D35IDEP 02300000
         BO    SVC15010           YES, HAVE A CHANQ ENTRY      @D35IDEP 02301000
         AIF   (&AG1 LE 254).LOD0200                           @D51ODGL 02302000
         CLI   CHQFLPTR+1,NOTQUED IS CHANNEL QUEUE FULL        @D51ODGL 02303000
.LOD0200 AIF   (&AG1 GT 254).LOD0201                           @D51ODGL 02304000
         CLI   FLPTR,NOTQUED      IS CHANNEL QUEUE FULL        @D51ODGL 02305000
.LOD0201 ANOP                                                  @D51ODGL 02306000
         BE    RESVCIO            YES, ====================>>> @D36IDAP 02307000
*SGLINK  RESVCIO,INPUT=R6                                      @D369DAP 02308000
         DROP  R8                 RELEASE TIB BASE             @DA41765 02309000
SVC15010 BAL   RE,GETPUB          ALLOCATE PUB ENTRY  =====>>> @D34EDAP 02310000
*SGLINK  GETPUB,INPUT=(R1,R6,RB,RD,RE),OUTPUT=(R3,R5),                 *02311000
               WORK=(R2,R7,R8,R9)                              @D369DAP 02312000
         USING PUBADR,R3          PUB BASE                     @D36IDAP 02313000
         OI    HQUCNTLF,HQUHQ     INDICATE A HQ REQUEST        @D31YDAP 02314000
         B     SVC00010                ======================> @D30EULR 02315000
         SPACE 1                                                        02316000
         DROP  R1                 RELEASE CCB BASE             @D36IDAP 02317000
         DROP  R3                 RELEASE PUB BASE             @D36IDAP 02318000
         DROP  RA                 RELEASE TCB BASE             @D36IDAP 02319000
         DROP  RB                 RELEASE PIB BASE             @D36IDAP 02320000
         DROP  R6                 RELEASE DISPATCHER BASE      @D36IDAP 02321000
         DROP  RC                 RELEASE SVC15 BASE           @D21ODAP 02322000
         DROP  RD                 RELEASE SGIOS BASE           @D36IDAP 02323000
         DROP  RF                 RELEASE HQUCNTLF BASE        @D52VDAP 02324000
         TITLE 'VSE SUPERVISOR     SGIOS     OLTEP HALT DEVICE ROUTINE' 02325000
         USING SGIOS,RD           SGIOS BASE POINTER           @D21ODAP 02326000
         USING SVC27,RC           SCV27/25 BASE                @D21ODAP 02327000
         USING DISP,R6            DISPATCHER BASE              @D36IDAP 02328000
         USING TIBADR,R8          TIB BASE POINTER             @D36IDAP 02329000
         USING TCBADR,RA          TCB BASE POINTER             @D36IDAP 02330000
         USING PIBADR,RB          PIB BASE POINTER             @D36IDAP 02331000
SVC27    DS    0H'0'              HALT I/O BUT DON'T DEQUEUE            02332000
SVC25    DS    0H'0'              HALT I/O AND EVENT. DEQUEUE  @D61VTAP 02333000
         SLR   RE,RE              CLEAR REGISTER               @D66ADAP 02334000
         BCTR  RE,0               FORCE FFFFFFFF               @D66ADAP 02335000
         CLR   RE,R1              NEW INTERFACE                @D66ADAP 02336000
         BE    SVC25NEW           YES, ======================> @D66ADAP 02337000
         USING CCBADR,R1          CCB BASE POINTER             @D36IDAP 02338000
         SLR   R0,R0              INDICATE OLD SVC25 INTERFACE @D66ADAP 02339000
         CLR   R0,R1              IS CCB ADDRESS VALID         @D28ADAP 02340000
         BE    ERR21              NO,  ====================>>> @D28ADAP 02341000
         TM    TCBEXFLG,TCBEXAM   31 BIT MODE                  @D61VTAP 02342000
         BZ    SVC25000           NO,                          @D61VTAP 02343000
         CLM   R1,8,H0            IS CCB BELOW 16M BOUNDARY    @D61VTAP 02344000
         BNE   ERR45              NO,  ====================>>> @D61VTAP 02345000
SVC25000 LA    R1,0(,R1)          ENSURE 24-BIT ADDRESS        @D28ADAP 02346000
         ST    R1,BTSAV+4         SAVE USERS REGISTER          @DY46396 02347680
         BAL   RE,GETPUB          ALLOCATE PUB ENTRY  =====>>> @DA33742 02348000
*SGLINK  GETPUB,INPUT=(R1,R6,RB,RD,RE),OUTPUT=(R3,R5),                 *02349000
               WORK=(R2,R7,R8,R9)                              @D369DAP 02350000
         DROP  R8                 RELEASE TIB POINTER          @D36IDAP 02351000
         DROP  R1                 RELEASE CCBADR BASE          @D66ADAP 02352000
         USING PUBADR,R3          PUB BASE                     @D36IDAP 02353000
S#25ISOK LH    R2,PUBCHANN        LOAD CHANNEL AND UNIT        @DA27283 02354000
         STH   R2,CHNADR          SET CUU ADDRESS IN LOW CORE  @D51GDAP 02355000
         BAL   R7,SVC25SUB        LOCATE CHANQ ENTRY           @DA27283 02356000
         LTR   R4,R9              DID WE FIND THE RIGHT CCB    @DA27283 02357000
         BNZ   SVC25010           YES,                         @D61NDAP 02358000
         LTR   R0,R0              IS THIS THE NEW INTERFACE    @D66ADAP 02359000
         BNZ   SVC25HDV           YES, ======================> @D66ADAP 02360000
         USING CCBADR,R1          CCBADR BASE POINTER          @D66ADAP 02361000
         ICM   R7,15,CCBCCW       COULD THIS BE LAN-RES REQUEST@D61NDAP 02362000
         BNZ   SVC25TST           NO,  ======================> @DA41121 02363000
         TM    CCBCLS,BTAM        DID BTAM REQUEST THIS SVC    @D61NDAP 02364000
         BO    SVC25TST           YES, ======================> @D61NDAP 02365000
         LR    RF,R1              COPY CCB ADDRESS             @D61ADAP 02366000
         B     SVC25HDV                ======================> @D61NDAP 02367000
.*                                                             @D51ODGL 02368000
SVC25010 LTR   RE,RE              IS IT FIRST IN CHAIN         @D61NDAP 02369000
         BZ    SVC25HDV           YES, ======================> @D51ODGL 02370000
         TM    IJBOLTEP,OLTAC     IS OLTEP ACTIVE              @D359DAP 02371000
         BZ    SVC25HDV           NO,  ======================> @D149DAP 02372000
         CLC   OLTPIK,PIK         IS THIS THE OLTEP PARTITION  @DA41253 02373000
         BNE   SVC25HDV           NO,  ======================> @D149DAP 02374000
         MVC   CHQCHNLO-CHQADR(1,RE),CHQCHNLO-CHQADR(R9)       @D51OGDL 02375000
         AIF   (&AG1 LE 254).LOD0090                           @D51ODGL 02376000
         MVC   CHQCHNHI-CHQADR(1,RE),CHQCHNHI-CHQADR(R9)       @D51ODGL 02377000
         MVC   CHQCHNLO-CHQADR(1,R9),CHQFLPTR+1                @D51ODGL 02378000
         MVC   CHQCHNHI-CHQADR(1,R9),CHQFLPTR                  @D51ODGL 02379000
.LOD0090 AIF   (&AG1 GT 254).LOD0091                           @D51ODGL 02380000
         MVC   CHQCHNLO-CHQADR(1,R9),FLPTR                     @D51ODGL 02381000
         STC   R8,FLPTR           UPDATE OLD FREELIST POINTER  @D51ODGL 02382000
.LOD0091 ANOP                                                  @D51ODGL 02383000
         STH   R8,CHQFLPTR        UPDATE FREE LIST POINTER     @D51ODGL 02384000
         ICM   R8,15,CQEINUSE     CHANQ ENTIRES IN USE COUNTER @D61NDAP 02385000
         BZR   R6                 IS 0 ====================>>> @D61NDAP 02386000
         BCTR  R8,0               SUBTRACT 1                   @D61NDAP 02387000
         ST    R8,CQEINUSE        STORE NEW VALUE              @D61NDAP 02388000
         BR    R6                 EXIT ====================>>> @D14BDAP 02389000
         DROP  R1                 RELEASE CCBADR BASE          @D66ADAP 02390000
         SPACE 1                                                        02391000
.*                                                                      02392000
.*       NEW SVC25 INTERFACE USED BY QDIO SUPPORT                       02393000
.*                                                                      02394000
* INPUT: R1=FFFFFFFF                                                    02395000
*        R0=FUNCTION-CODE         01=HALT  SUB-CHANNEL                  02396000
*                                 02=CLEAR SUB-CHANNEL                  02397000
*        R2=PUB-INDEX                                                   02398000
*                                                                       02399000
SVC25NEW DS    0H'0'              SVC25 NEW INTERFACE          @D66ADAP 02400000
         LA    RF,S#25MXFC        GET MAX. FUNCTION CODE + 1   @D66ADAP 02401000
         CLR   R0,RF              IS FUNCTION CODE VALID       @D66ADAP 02402000
         BNL   ERR21              NO,  ====================>>> @D66ADAP 02403000
         SLR   R3,R3              CLEAR REGISTER               @D66ADAP 02404000
         ICM   R3,3,IJBNDEV       GET NUMBER OF PUB ENTRIES    @D66ADAP 02405000
         BCTR  R3,0               HIGHEST PUB INDEX            @D66ADAP 02406000
         CLR   R3,R2              USER SPECIFIED INDEX VALID   @D66ADAP 02407000
         BL    ERR21              NO,  ====================>>> @D66ADAP 02408000
         LR    R3,R2              COPY PUB INDEX               @D66ADAP 02409000
         SLL   R3,PUBSLEN         MULTIPLY WITH 8              @D66ADAP 02410000
         AH    R3,YPUBTAB         PUB ADDRESS                  @D66ADAP 02411000
         USING PUBADR,R3          PUB BASE POINTER             @D66ADAP 02412000
         AIF   (NOT &BGDEBUG).NDBG020                          @D66ADAP 02413000
         CLI   PUBDEVTY,TQDIO     IS THIS A QDIO DEVICE        @D66ADAP 02414000
         BNE   ERR21              NO,  ====================>>> @D66ADAP 02415000
.NDBG020 ANOP                                                  @D66ADAP 02416000
         LR    RF,R0              COPY FUNCTION CODE           @D66ADAP 02417000
         SLL   RF,2               MULTIPLY WITH FOUR           @D66ADAP 02418000
         L     RF,S#25FCTB(RF)    GET ROUTINE ADDRESS          @D66ADAP 02419000
         BR    RF                 GO,  ======================> @D66ADAP 02420000
S#25FCTB DC    A(ERR21)         0 INVALID FUNCTION CODE        @D66ADAP 02421000
         DC    A(S#25ISOK)      1 HALT   SUBCHANNEL            @D66ADAP 02422000
         DC    A(S#25ISOK)      2 CLEAR  SUBCHANNEL            @D66ADAP 02423000
S#25MXFC EQU   (*-S#25FCTB)/L'S#25FCTB MAX. FUNCTION CODE      @D66ADAP 02424000
.*                                                             @D66ADAP 02425000
.*                                                             @D51ODGL 02426000
.*    LOOP TO SEE, IF CCB IS CHAINED TO A PUB                  @D51ODGL 02427000
.*                                                             @D51ODGL 02428000
         SPACE 5                                               @D14BDAP 02429000
SVC25SUB DS    0H'0'              FIND PROPER REQUEST IN CHANQ @D66ADAP 02430000
         LTR   R0,R0              NEW INTERFACE                @D66ADAP 02431000
         BNZ   SVC25S00           LEAVE R1 UNCHANGED           @D66ADAP 02432000
         LA    R1,0(,R1)          CLEAR HIGH ORDER BYTE        @D14BDAP 02433000
SVC25S00 SLR   R8,R8              CLEAR WORK REGISTER          @D66ADAP 02434000
         SLR   R9,R9              CLEAR CHANQ CHAIN POINTER    @D51ODGL 02435000
         SLR   RE,RE              INDICATE FIRST IN CHAIN      @D61ADAP 02436000
         CLI   PUBCHQPT,XFF       ANY REQUEST QUEUED TO PUB    @D51ODGL 02437000
         BER   R7                 NO,  ======================> @D51ODGL 02438000
         IC    R8,PUBCHQPT-PUBADR(R3)   GET CHANQ INDEX        @D51ODGL 02439000
         AIF   (&AG1 LE 254).LOD0050                           @D51ODGL 02440000
         ICM   R8,2,PUBCHQPH-PUBADR(R3) GET CHANQ HIGH-INDEX   @D51ODGL 02441000
.LOD0050 ANOP                                                  @D51ODGL 02442000
         B     SVC25S20           FIRST PATH THROUGH           @D51ODGL 02443000
         USING CHQADR,R9          NEXT CHANQ ENTRY BASE POINTER@D14BDAP 02444000
SVC25S10 IC    R8,CHQCHNLO        GET NEXT IN CHAIN INDEX      @D51ODGL 02445000
         AIF   (&AG1 LE 254).LOD0350                           @D51ODGL 02446000
         ICM   R8,2,CHQCHNHI      GET NEXT IN CHAIN HIGH-INDEX @D51ODGL 02447000
.LOD0350 ANOP                                                  @D51ODGL 02448000
         CLM   R8,1,XFFFF         END OF CHAIN                 @D51ODGL 02449000
         BE    SVC25SEX           YES, DID NOT FIND PROPER CCB @D14BDAP 02450000
SVC25S20 LR    RE,R9              SAVE LAST CHAIN ENTRY ADDRESS@D51ODGL 02451000
         LR    R9,R8              NEXT-IN-CHAIN ENTRY NUMBER   @D14BDAP 02452000
         SLL   R9,CHQSLEN         MULTIPLY WITH ENTRY LENGTH   @D14BDAP 02453000
         A     R9,ACHANQ          NEXT CHANQ ENTRY ADDRESS     @D14BDAP 02454000
         ICM   R9,8,H0            CLEAR HIGH ORDER BYTE        @D68REEF 02455000
         L     RF,PCBPTR          POINT TO CURRENT PCB         @D51ODAP 02456000
         USING PCBADR,RF          PCB BASE POINTER             @D51ODAP 02457000
         TM    PCBSSFLG-PCBADR(RF),VTAM REQUEST FROM VTAM      @D51ODAP 02458000
         BZ    SVC25S30           NO, WE NEED A CCB MATCH      @D51ODAP 02459000
         DROP  RF                 RELEASE PCB BASE POINTER     @D51ODAP 02460000
         LR    RF,R1              ACCEPT THE GIVEN CCB         @D51ODAP 02461000
         BR    R7                     =======================> @D51ODAP 02462000
SVC25S30 L     RF,CHQCCBAD        GET CCB ADDRESS              @D14BDAP 02463000
         ICM   RF,8,H0            CLEAR HIGH ORDER BYTE        @D68REEF 02464000
         LTR   RF,RF              IS CCB AVAILABLE             @D14BDAP 02465000
         BZ    SVC25S10           NO, CHECK NEXT CHANQ ENTRY   @D14BDAP 02466000
         SLR   R5,R5              CLEAR R5                     @DA41318 02467000
         ICM   R5,3,CHQTID        GET CHQTID (ASSUME 2-BYTE)   @D66ADAP 02468000
         SLL   R5,2               MULTIPLY WITH 4              @DA41318 02472000
         AL    R5,ATIBATAB        ADDRESS OF ADDRESS OF TIB    @D66ADAP 02473000
         L     R5,0(,R5)          ADDRESS OF TIB               @D66ADAP 02474000
         ICM   R5,15,TIBSCB-TIBADR(R5) SHARED SPACE            @DA41318 02475000
         BZ    SVC25S40           YES                          @DA41318 02476000
         C     R5,SCBPTR          SAME SPACE                   @DA41318 02477000
         BNE   SVC25S10           NO, CHECK NEXT CHANQ ENTRY   @DA41318 02478000
SVC25S40 TM    CCBCLS-CCBADR(RF),CCBCOPY IS THIS A COPIED CCB  @D14BDAP 02479000
         BNO   SVC25S50           NO, ITS AN EXCP-REAL REQUEST @D14BDAP 02480000
         ICM   RF,7,CCBVA+1-CCBADR(RF) GET VIRTUAL CCB ADDR    @D14BDAP 02481490
SVC25S50 CR    RF,R1              IS THIS THE REQUESTED CCB    @D14BDAP 02482000
         BER   R7                 YES, ======================> @D66ADAP 02483000
         LTR   R0,R0              IS THIS THE OLD INTERFACE    @D66ADAP 02484000
         BZ    SVC25S10           YES, KEEP GOING              @D66ADAP 02485000
         LR    R1,RF              COPY CCB ADDRESS TO R1       @D66ADAP 02487000
         BR    R7                      ======================> @D66ADAP 02488000
SVC25SEX SLR   R9,R9              INDICATE NO MATCH FOUND      @D14BDAP 02494000
         SLR   RE,RE              TREAT AS FIRST IN CHAIN      @D61NDAP 02495000
         BR    R7                      ======================> @D14BDAP 02496000
         DROP  R9                 RELEASE CHANQ BASE           @D14BDAP 02497000
.*                                                             @D51ODGL 02498000
.*                                                             @D51ODGL 02499000
.*                                                             @D51ODGL 02500000
.*                                                             @D51ODGL 02501000
         TITLE 'VSE SUPERVISOR     SGIOS     HALT DEVICE ROUTINE      ' 02502000
.*                                                             @D51ODGL 02503000
         USING CHQADR,R4          CHANNEL-QUEUE BASE                    02504000
SVC25HDV L     R9,AINTER          SET BASE FOR I/O INTERRUPT            02505000
         USING INTRTN,R9          IOINTER BASE POINTER         @D34ADAP 02506000
         LTR   R1,R1              DID USER PASS A CCB          @D66ADAP 02507000
         BM    SVC25H30           NO, IT WAS THE NEW INTERFACE @D66ADAP 02508000
         USING CCBADR,R1          CCB BASE POINTER             @D66ADAP 02509000
         TM    CCBCLS,BTAM        DID BTAM REQUEST THIS SVC    @DA27283 02510000
         BNO   SVC25H10           NO, NORMAL PROCESSING        @D14BDAP 02511000
         CLI   BTSAV+4,SPECHIO    DID BTAM REQUEST RESET POLL  @DY46396 02512680
         BE    SVC25BNO           YES, RESET POLLING LOOP      @D14BDAP 02513000
SVC25H10 XC    CSW(8),CSW         CLEAR CSW IN LOW CORE        @D14BDAP 02514000
         LTR   RE,RE              WAS TO BE HALTED 1ST IN CHAIN@D61NDAP 02515000
         BZ    SVC25H20           YES,                         @D61NDAP 02516000
         CLC   CHQTID-CHQADR(,RE),IORQ4ERP IS PREVIOUS AN ERP  @TEST    02517000
         BE    RESVCIO            YES, ====================>>> @DA45383 02518000
*SGLINK  RESVCIO,INPUT=R6                                      @DY45383 02519000
         OC    CHQCCBAD+1-CHQADR(3,RE),CHQCCBAD+1-CHQADR(RE)   @DY45383 02520000
         BNZ   SVC25H15           CCB IS STILL AVAILABLE       @DY45383 02521000
         TM    CHQCSW+4-CHQADR(RE),DEVEND+UNITCK ENDING STATUS @DY45383 02522000
         BZ    RESVCIO            NO,  ====================>>> @DY45383 02523000
*SGLINK  RESVCIO,INPUT=R6                                      @DY45383 02524000
.*                                                             @D51ODGL 02525000
.*    IN DEBUG CASE FORCE HARD WAIT, IF CHANQ NOT 1ST IN CHAIN @D51ODGL 02526000
.*                                                             @D51ODGL 02527000
SVC25H15 TM    IJBFLG08,IJBDEBUG  IS DEBUG ACTIVE              @D61NDAP 02528000
         BZ    ERR21              NO,  ====================>>> @D61NDAP 02529000
         MVI   IJBHWORG,HWORG104  HARD WAIT ID  (SVC25 ERROR)  @D51ODGL 02530000
         BAL   R5,SYSERROR        FORCE HARD WAIT              @D14BDAP 02531000
SVC25H20 TM    PUBCSFLG,QEDERR    ERP IN PROCESS               @D51ODGL 02532000
         BO    RESVCIO            YES, ====================>>> @D68ADAP 02533000
*SGLINK  RESVCIO INPUT=R6                                      @D68ADAP 02534000
         NI    CCBCOM1-CCBADR(RF),CLRCOM1 CLEAR COMM. BYTES    @D14BDAP 02535000
         NI    CCBCOM2-CCBADR(RF),CLRCOM2 CLEAR COMM. BYTES    @D14BDAP 02536000
         DROP  R1                 RELEASE CCBADR BASE          @D66ADAP 02537000
SVC25H30 BAL   RE,GETPUBX         GET PUBX ADDRESS             @D51GDAP 02538000
*SGLINK  GETPUBX,INPUT=(R3,R9,RE),OUTPUT=R2                    @D51GDAP 02539000
         USING PBXADR,R2          PUBX BASE POINTER            @D51GDAP 02540000
         MVC   XASUBSC1,PBXSCH    SET SUBCHANNEL ID            @D51GDAP 02541000
         DROP  R2                 RELEASE PUBX BASE            @D51GDAP 02542000
         LR    R2,R1              SAVE R1 CONTENTS             @D51GDAP 02543000
         L     R1,XASUBSCH        GET XA SUBCHANNEL PARAMETER  @D51GDAP 02544000
         STM   R1,R3,SVC25CON+4   SAVE INFO FOR DEBUG          @D61NDAP 02545000
         C     R0,F1              IS THIS A HSCH REQUEST       @D66ADAP 02547000
         BNH   SVC25H40           YES,                         @D66ADAP 02548000
SVC25CLR MVI   SVC25CON,C'C'      INDICATE CSCH                @D66ADAP 02549000
         CSCH                     CLEAR SUBCHANNEL             @D66ADAP 02550000
         B     SVC25H50           JOIN MAIN LINE               @D66ADAP 02551000
SVC25H40 MVI   SVC25CON,C'H'      INDICATE HSCH                @D66ADAP 02553000
         HSCH                     HALT SUBCHANNEL              @D51GDAP 02554000
SVC25H50 DEBUG USERDATA,XXDBGMC,SVC25CON MAKE DEBUG ENTRY      @D28ADAP 02555000
         BC    6,RESVCIO               ====================>>> @D28ADAP 02556000
*SGLINK  RESVCIO INPUT=R6                                      @D28ADAP 02557000
.*       WE NEED TO CHECK FOR COMPLETION CODE, OTHERWISE A              02558000
.*       REQUEST WILL BE DEQUEUED AND THE RESOURCES (COPY-BLOCKS)       02559000
.*       FREED AND REUSED OTHERWISE, WHILE THE I/O IS STILL IN          02560000
.*       PROGRESS (FROM THE CHANNEL VIEW).                              02561000
.*       SKIP TSCH FOR BTAM                                    @DY46541 02561500
         AIF   (NOT &VSE280).N280080                           @D28ADAP 02562000
         LTR   R2,R2              DID USER PASS A CCB?         @DY46541 02563090
         BM    SVC25W1            NO, IT WAS THE NEW INTERFACE @DY46541 02563180
         USING CCBADR,R2          CCB BASE POINTER             @DY46541 02563270
         TM    CCBCLS,BTAM        DID BTAM REQUEST THIS SVC?   @DY46541 02563360
         BO    SVC25MCL           YES, SKIP TSCH               @DY46541 02563450
         DROP  R2                 DROP CCB                     @DY46541 02563540
SVC25W1  STCK  SVC25TIM           SAVE START TIME              @D28ADAP 02563630
         L     RE,SVC25TIM        GET START TIME               @D28ADAP 02564000
         AL    RE,F4              ADD AT LEAST 3 SECONDS       @D28ADAP 02565000
         ST    RE,SVC25TIM        SAVE UPPER TOD LIMIT         @D28ADAP 02566000
SVC25WAIT  DS  0H'0'              WAIT FOR STATUS PENDING      @D28ADAP 02567000
         L     RE,IRB$            ADDRESS OF IRB               @D28ADAP 02568000
         USING IRB,RE             IRB BASE POINTER             @D28ADAP 02569000
         TSCH  IRB                WAIT FOR STATUS PENDING      @D28ADAP 02570000
         BNM   SVC25MCL           STATUS IS PENDING            @D28ADAP 02571000
         DROP  RE                 RELEASE IRB BASE             @D28ADAP 02572000
         STCK  SVC25TOD           GET CURRENT TOD              @D28ADAP 02573000
         CLC   SVC25TIM(4),SVC25TOD TIME LIMIT EXPIRED         @D28ADAP 02574000
         BH    SVC25WAIT          TIME NOT YET EXPIRED         @D28ADAP 02575000
         CLI   SVC25CON,C'C'      DID WE ATTEMPT A CSCH        @D28ADAP 02576000
         BNE   SVC25CLR           NO, THEN TRY IT NOW          @D28ADAP 02577000
.N280080 ANOP                                                  @D28ADAP 02578000
SVC25MCL LR    R1,R2              RESTORE R1 CONTENTS          @D51GDAP 02579000
.*       DONT CONFUSE ERP IN CASE DEVICE NOT OPERATIONAL       @D14BDAP 02580000
SVC25TST L     R9,AINTER          SET BASE FOR I/O INTERRUPT            02581000
         CLI   SVCIC,HIO          WAS IT AN SVC 25             @D36IDAP 02582000
         BNE   SVC27EXT           NO, IT WAS AN SVC27          @D14CDAP 02583000
         LTR   R0,R0              NEW INTERFACE                @D66ADAP 02585000
         BNZ   SVC25DEQ           YES,                         @D66ADAP 02586000
         BAL   RE,GETPUBX         GET PUBX ADDRESS             @D51GDAP 02588000
*SGLINK  GETPUBX,INPUT=(R3,R9,RE),OUTPUT=R2                    @D51GDAP 02589000
         USING PBXADR,R2          PUBX BASE POINTER            @D51GDAP 02590000
         LH    RF,PBXVTMCQ        GET CHANQ CHAIN POINTER      @D61POAP 02591000
         LTR   R7,RF              DID WE SAVE ANYTHING         @D51GDAP 02592000
         BZ    SVC25DEQ           NO,                          @D51GDAP 02593000
         DROP  R4                 RELEASE CURRENT CHANQ BASE   @D51GDAP 02594000
         XC    PBXVTMCQ(2),PBXVTMCQ CLEAR SAVED ENTRY NUMBER   @D61POAP 02595000
         SLL   RF,CHQSLEN         MULTIPLY WITH ENTRY LENGTH   @D51GDAP 02596000
         A     RF,ACHANQ          ADDRESS OF CHANQ ENTRY       @D51GDAP 02597000
         ICM   RF,8,H0            CLEAR HIGH ORDER BYTE        @D68REEF 02598000
         USING CHQADR,RF          CHANQ BASE POINTER           @D51GDAP 02599000
         XC    CHQCCBAD(32),CHQCCBAD CLEAR THE ENTRY           @D51GDAP 02600000
         AIF   (&AG1 LE 254).NMDV040                           @D51ODAP 02601000
         LH    RE,CHQFLPTR        GET FREE LIST POINTER        @D51GDAP 02602000
         STCM  RE,2,CHQCHNHI      SET CHAIN POINTER HIGH BYTE  @D51GDAP 02603000
         AGO   .YMDV040                                        @D51GDAP 02604000
.NMDV040 IC    RE,FLPTR           GET FREE LIST POINTER        @D51GDAP 02605000
         STC   R7,FLPTR           MAKE THIS THE NEXT FREE ENTRY@D51GDAP 02606000
.YMDV040 STC   RE,CHQCHAIN        SET CHAIN POINTER LOW BYTE   @D51GDAP 02607000
         STH   R7,CHQFLPTR        UPDATE 2 BYTE FREELIST PTR   @D51ODGL 02608000
         ICM   RE,15,CQEINUSE     CHANQ ENTIRES IN USE COUNTER @D61NDAP 02609000
         BZ    SVC25DEQ           IS 0                         @D61NDAP 02610000
         BCTR  RE,0               SUBTRACT 1                   @D61NDAP 02611000
         ST    RE,CQEINUSE        STORE NEW VALUE              @D61NDAP 02612000
         DROP  RF                 RELEASE CHANQ BASE POINTER   @D51GDAP 02613000
         DROP  R2                 RELEASE PUBX BASE POINTER    @D51GDAP 02614000
         USING CHQADR,R4          PERMANENT CHANQ BASE POINTER @D51GDAP 02615000
SVC25DEQ LTR   R4,R4              DOES CHANQ ENTRY EXIST       @D51GDAP 02616000
         BZR   R6                 NO,  ====================>>> @D51GDAP 02617000
         LA    RE,PSTRESET        ADJUST EXIT ADDRESS          @D14CDAP 02618000
         LTR   R1,R1              CCB ADDRESS AVAILABLE        @DA32599 02619000
         BP    SVC25DQN           YES, NORMAL DEQUEUE          @D66ADAP 02620000
         LA    RE,DEQUNCON        SET UP UNCOND DEQUEUE EXIT   @DA32599 02621000
         NI    PUBCSFLG,XFF-DEVBSY RESET PUB BUSY BIT          @DA41121 02622000
SVC25DQN OI    CHQPROC,CHQDQUNC   FORCE DEQUEUING OF CHANQ     @D369DAP 02623000
         NI    CHQGRP,XFF-CHQGRVTM  RESET VTAM OWNED DEVICE    @D14CDFG 02624000
SVC25EXT BAL   RF,INTERTRN        SET UP CCT POINTER CORRECTLY @D35IDAP 02625000
         BAL   R7,CQDSP           SET UP I/O REGISTER          @D14CDAP 02626000
*SGLINK  CQDSP,INPUT=(R3,R6,R7),OUTPUT=(R1,R4,RA),WORK=R0      @D369DAP 02627000
         BR    RE                      =====================>> @D14CDAP 02628000
SVC27EXT LA    RE,INITRG          PROVIDE FOR SCHEDULER EXIT   @D51GDAP 02629000
         B     SVC25EXT           GO TO SCHEDULER              @D51GDAP 02630000
SVC25TIM DC    D'0'               HSCH START TIME              @D28ADAP 02631000
SVC25TOD DC    D'0'               CURRENT TIME STAMP           @D28ADAP 02632000
SVC25CON DC    CL4'HSCH'          CONSTANT INDICATES HSCH      @DA43858 02633000
         DC    3F'0'              CONSTANTS FOR DEBUG          @D61NDAP 02634000
         DROP  R4                 RELEASE CHANNEL QUEUE BASE   @D36IDAP 02635000
         DROP  R9                 RELEASE IOINTER BASE         @D36IDAP 02636000
         DROP  RA                 RELEASE TCB BASE             @D149DAP 02637000
         DROP  RB                 RELEASE PIB BASE             @D149DAP 02638000
         TITLE 'VSE SUPERVISOR     SGIOS     BTAM RESET POLL ROUTINE  ' 02639000
         USING CCBADR,R1          CCB BASE POINTER             @D14BDAP 02640000
         USING CHQADR,R4          CHANQ BASE POINTER                    02641000
         USING INTRTN,R9          IOINTER BASE POINTER         @DA41121 02642000
SVC25BNO DS    0H'0'              RESET POLL ENTRY POINT       @DA40670 02643000
         BAL   RE,GETPUBX         GET PUBX ADDRESS             @DA40670 02644000
*SGLINK  GETPUBX,INPUT=(R3,R9,RE),OUTPUT=R2                    @DA40670 02645000
         USING PBXADR,R2          PUBX BASE POINTER            @DA40670 02646000
         ICM   2,3,PBXSCH         GET SUBCHANNEL NUMBER        @DA40670 02647000
         ICM   R2,12,H0           CLEAR UNUSED BYTES           @DA40670 02648000
         DROP  R2                 RELEASE PUBX BASE POINTER    @DA40670 02649000
         DROP  R9                 RELEASE IOINTER BASE         @DA40670 02650000
         L     R9,CHQCCBAD        GET REAL CCB ADDRESS         @D14BDAP 02651000
         ICM   R9,8,H0            CLEAR HIGH ORDER BYTE        @D68REEF 02652000
         L     R9,CCBCCW-CCBADR(R9) GET REAL CCW ADDRESS       @D14BDAP 02653000
         ICM   R9,8,H0            CLEAR HIGH-ORDER BYTE        @D68REEF 02654000
         L     R7,CCBCCW          GET VIRTUAL CCW ADDRESS      @D14BDAP 02655000
         ICM   R7,8,H0            CLEAR HIGH-ORDER BYTE        @D68REEF 02656000
         LA    RF,40(R1)          ADDRESS OF 1ST CCW IN LCB    @D14BDAP 02657000
         CR    R7,RF              DOES CCB POINT TO 1ST CCW    @D14BDAP 02658000
         BE    SVC25B20           YES, READY FOR RESETPOLL     @D14BDAP 02659000
         LA    RF,8(RF)           ADDRESS OF 2ND CCW IN LCB    @D14BDAP 02660000
         CR    R7,RF              DOES CCB POINT TO 2ND CCW    @D14BDAP 02661000
         BNER  R6                 NO,  ====================>>> @D14BDAP 02662000
         SH    R9,H8              FORCE R9 TO POINT TO 1ST CCW @D149DAP 02663000
SVC25B20 MVI   23(R9),1           PROVIDE A VALID BYTE COUNT   @D14BDAP 02664000
         MVI   47(R9),1           PROVIDE A VALID BYTE COUNT   @D14BDAP 02665000
         MVI   16(R9),NOP         CHANGE TIC COMMAND TO NOOP   @D14BDAP 02666000
         MVI   40(R9),NOP         CHANGE TIC COMMAND TO NOOP   @D14BDAP 02667000
         TM    SUPFLAG,VMSYS      RUNNING UNDER VM ?           @D14CDJB 02668000
         BZR   R6                 NO,  ====================>>> @D14CDJB 02669000
         TM    SYSFLAG4,VMBTAM    VM BTAM CHANGE ENABLED       @D34NEG1 02670000
         BZR   R6                 NO,  ====================>>> @D34NEG1 02671000
         CLM   R8,M1,PUBCHQPT     IS BTAM THE FIRST REQUEST    @D14BDAP 02672000
         BNER  R6                 NO,  ====================>>> @D14BDAP 02673000
         AIF   (&AG1 LE 254).LOD00E0                           @D51ODGL 02674000
         CLM   R8,2,PUBCHQPH      IS HIGH ALSO EQUAL           @D51ODGL 02675000
         BNER  R6                 NO,  ====================>>> @D51ODGL 02676000
.LOD00E0 ANOP                                                  @D51ODGL 02677000
SVC25B22 DS    0H                                              @D51ODGL 02678000
.*                                                             @D1414AP 02679000
.*       VM ASSUMES R2 TO CONTAIN CUU ADDRESS      IN MODE=370 @D14BDAP 02680000
.*       VM ASSUMES R2 TO CONTAIN SUBCHANNEL NO.   IN MODE=ESA @DA40670 02681000
.*       AND RE TO POINT TO CCW WHICH WAS MODIFIED             @D14BDAP 02682000
.*                                                             @D14XXAP 02683000
         LA    RE,16(R9)          POINT TO FIRST TIC           @D14BDAP 02684000
         DC    X'83E20028'        MODIFY VM COPY OF TIC        @D34NEG1 02685000
         BNZR  R6                 CE/DE====================>>> @D34NEG1 02686000
         LA    RE,40(R9)          POINT TO SECOND TIC          @D14BDAP 02687000
         DC    X'83E20028'        MODIFY VM COPY OF TIC        @D34NEG1 02688000
         BR    R6                      ====================>>>          02689000
         SPACE 1                                                        02690000
         DROP  R1                 RELEASE CCB BASE POINTER     @D14BDAP 02691000
         DROP  R4                 RELEASE CHANQ BASE           @D14BDAP 02692000
         DROP  R3                 RELEASE PUB BASE                      02693000
         DROP  RC                 RELEASE SVC27/25 BASE        @D21ODAP 02694000
         DROP  RD                 RELEASE SGIOS BASE                    02695000
         DROP  R6                 RELEASE DISPATCHER BASE      @D36IDAP 02696000
         TITLE 'VSE SUPERVISOR     SGIOS     SVC 49 (VTAM)           '  02697000
.*                                                             @DL28101 02698000
.*   SVC49 IS USED BY VTAM TO START OR HALT I/O OPERATIONS     @DL28101 02699590
.*         WHICH ARE ALREADY ENQUEUED IN THE CHANQ             @DL28101 02700180
.*                                                                      02701000
.*   INPUT:                                                             02702000
.*       R1 =  POINTER TO VTAM CCB                                      02703000
.*                                                             @DL28101 02704000
         USING SGIOS,RD           SGIOS BASE POINTER           @D21ODAP 02705000
         USING SVC49,RC           SVC49 BASE                   @D14CDOW 02706000
           USING DISP,R6          DISP BASE POINTER            @D369DAP 02707690
           USING TIBADR,R8        TIB BASE POINTER             @D36IDAP 02708380
           USING TCBADR,RA        TCB BASE POINTER             @D36IDAP 02709070
           USING PIBADR,RB        PIB BASE POINTER             @D36IDAP 02709760
           USING CCBADR,R1        CCB BASE POINTER             @D369DAP 02710450
SVC49      TM    VTAMFLG,VTAMK0   VTAM KEY ZERO REQUEST        @D14CDAP 02711140
           BZ    ERR21            NO,  ====================>>> @D14CDFG 02711830
           TM    TCBEXFLG,TCBEXAM 31 BIT MODE                  @D61VTAP 02712520
           BZ    SVC49040         NO,                          @D61VTAP 02713210
           L     R3,ASVC4900      CONTINUATION ADDRESS         @DY46396 02714390
           BSM   0,R3             GET INTO 31-BIT MODE         @DY46396 02714880
ASVC4900   DC    A(SVC49000+X'80000000') 31-BIT CONT. ADDR.    @DY46396 02715370
SVC49000   TM    CCBBY3,CCBCCWF1+CCWABOVE BUFFER IN 31-BIT AREA@DY46396 02715860
           BO    SVC49040         YES, PROCEED MAIN PATH       @DY46396 02716350
SVC49020   CLM   R1,8,H0          IS CCB BELOW 16M BOUNDARY    @D61VTAP 02717350
           BNE   ERR45            NO,  ====================>>> @D61VTAP 02718040
SVC49040   SLR   R3,R3            CLEAR PUB POINTER            @D35ZDAP 02718730
           LA    R1,0(,R1)        CLEAR HIGH ORDER BYTE/BIT    @D66ADAP 02719420
           AIF   (&AG1 GT 254).LOD0100                         @D51ODGL 02720110
           IC    R3,CCBLNO        GET PUB ENTRY NUMBER         @D35ZDAP 02720800
.LOD0100   AIF   (&AG1 LE 254).LOD0101                         @D51ODGL 02721490
           ICM   R3,3,CCBCLS      GET PUB ENTRY NUMBER AND     @D51ODGL 02722180
           N     R3,PHYADMSK      TURN OFF UNUSED BITS         @D51ODGL 02722870
.LOD0101   ANOP                                                @D51ODGL 02723560
           SLL   R3,PUBSLEN       MULTIPLY BY PUB ENTRY LENGTH @D51ODGL 02724250
           AH    R3,YPUBTAB       ADDRESS OF TP-PUB            @D35ZDAP 02724940
           USING PUBADR,R3        PUB BASE POINTER             @D35ZDAP 02725630
           L     R7,CCBCCW        ADDRESS OF CCW OR ZERO       @D35ZDAP 02726320
           LA    R7,ZERO(,R7)     CLEAR UNUSED BYTE/BIT        @D35ZDAP 02727010
           LA    R9,SVC49060      24-BIT MODE ADDRESS          @DY46396 02728190
           BSM   0,R9             RETURN TO 24-BIT MODE        @DY46396 02728680
SVC49060   LTR   RE,R7            SAVE AND TEST CCW ADDRESS    @DY46396 02729170
           BNZ   SVC49100         CCW IS PRESENT, START DEVICE @D35ZDAP 02729770
.*         DEVICE MUST BE HALTED ONLY                          @DY46396 02730750
           TM    PUBCSFLG,QEDERR  ERP IN PROCESS               @D21IDAP 02731150
           BO    RESVC            YES, ====================>>> @D21IDAP 02731840
*SGLINK    RESVC,INPUT=R6         WAIT FOR ERP TO COMPLETE     @D21IDAP 02732530
           OI    PUBCSFLG,DEVBSY  SET DEVICE BUSY              @D35ZDAP 02733220
           L     R9,AINTER        SET BASE FOR I/O INTERRUPT   @D51GDAP 02733910
           USING INTRTN,R9        MAKE IOINTER ADDRESSABLE     @D34ADAP 02734600
           BAL   RE,GETPUBX       GET PUBX ADDRESS             @D51GDAP 02735290
*SGLINK    GETPUBX,INPUT=(R3,R9,RE),OUTPUT=R2                  @D51GDAP 02735980
           USING PBXADR,R2        PUBX BASE POINTER            @D51GDAP 02736670
           MVC   XASUBSC1,PBXSCH  SET SUBCHANNEL ID            @D51GDAP 02737360
           DROP  R2               RELEASE PUBX BASE            @D51GDAP 02738050
           LR    R2,R1            SAVE CCB ADDRESS             @D51GDAP 02738740
           L     R1,XASUBSCH      GET XA SUBCHANNEL PARAMETER  @D51GDAP 02739430
           STM   R1,R3,SVC49CON+4 SAVE INFO FOR DEBUG          @DA43858 02740120
           HSCH                   HALT SUBCHANNEL              @D51GDAP 02740810
           LR    R1,R2            RESTORE CCB ADDRESS          @D51GDAP 02741500
           DEBUG USERDATA,XXDBGMC,SVC49CON MAKE DEBUG ENTRY    @DA43858 02742190
           BR    R6                    ====================>>> @D36IDAP 02742880
           DROP  R9               RELEASE IOINTER BASE         @DY46396 02743860
           DROP  RA               RELEASE TCB BASE             @D14CDAP 02744260
.*         DEVICE MUST BE STARTED                              @DVATM31 02744950
SVC49100   DS    0H'0'            GET VTAM I/O STARTED         @DY46396 02746030
           LR    R8,R1            SAVE USERS CCB ADDRESS       @DY46396 02746420
           BAL   R7,CQDSP         SET UP I/O REGISTERS         @D14CDFG 02747020
*SGLINK    CQDSP,INPUT=(R3,R6,R7),OUTPUT=(R1,R4,RA),WORK=R0    @D369DAP 02747710
           LR    R7,RE            RESTORE VTAM REAL CCW ADDR.  @DY46396 02748690
           LTR   R4,R4            IS CHANQ ENTRY PRESENT       @D37BDAP 02749090
           BZ    ERR21            NO,  ====================>>> @D37BDAP 02749780
           USING CHQADR,R4                                     @D14CDAP 02750470
           AIF   (NOT &BGDEBUG).SKIPV10                        @D14CDFG 02751160
           TM    IJBFLG08,IJBDEBUG IS DEBUG ACTIVE             @DAOM065 02751850
           BZ    SVC49120         NO,                          @DAOM065 02752540
           L     R9,IJBTCAVT      POINT TO INTERFACE TABLE     @D14CDFG 02753230
           USING ISTAVT,R9        VTAM INTERFACE TABLE BASE    @D14CDFG 02753920
           LH    R9,ISTVTTIK      GET VTAM TASK-ID             @D66ADAP 02754610
           DROP  R9               RELEASE VTAM-VECT.TABL. BASE @D14CDFG 02755300
           SLR   RE,RE            CLEAR REGISTER               @D66ADAP 02755990
           ICM   RE,3,CHQTID      GET CHQTID                   @D66ADAP 02756680
           CLR   RE,R9            REQUEST OWNER VTAMRP         @D14CDFG 02757370
           BNE   ERR21            NO,  ====================>>> @D14CDFG 02758060
.SKIPV10   ANOP                                                @D14CDFG 02758750
SVC49120   NI    CHQFLG1,XFF-CHQDIDJA ENSURE JOB ACCOUNTING    @DA27131 02759440
           OI    CHQFLG1,CHQFSIO1 RESTRICT TO PRIMARY PATH     @D21ODAP 02760130
           NI    PUBCSFLG,XFF-DEVBSY RESET BUSY BIT IN PUB     @D14CDFG 02760820
           STCK  X'D8'            GET TIME STAMP               @DTIMING 02761510
           ICM   RE,15,X'DA'      GET RESOLUTION BYTES         @DTIMING 02762200
           SRL   RE,3             ADJUST TO 128 MICRO SECONDS  @DTIMING 02762890
           ST    RE,CHQCCBB3+1    SAVE NEW ENQUEUNG TIME       @DTIMING 02763580
           TM    CCBCLS,CCBCOPY   IS THIS A COPIED CCB         @DY46396 02764660
           BZ    SVC49XIT         NO, ASSUME OLD INTERFACE     @DY46396 02765050
           AIF   (NOT &VTAM31).NV31020                         @DY46396 02765440
           CLM   R8,15,CCBVA      DOES IT MATCH USERS ADDRESS  @DY46396 02765830
           BNE   ERR21            NO,   =====================> @DY46396 02766220
           LR    RE,R8            PRESERVE VTAM-CCB ADDRESS    @DY46396 02766610
           LR    R9,R7            COPY REAL CCW ADDRESS        @DY46396 02767000
           AMODESW CALL,ADDRESS=VIRTAD,REGS=R6                 @DY46396 02767390
*SGLINK    VIRTAD,INPUT=(R6,R9),OUTPUT=RF,WORK=R9              @DY46396 02767780
           L     R6,DISPAD        RESTORE DISP BASE ADDRESS    @DY46396 02768170
           LTR   RF,RF            WAS ADDRESS VALID            @DY46396 02768560
           BZ    ERR21            NO,   =====================> @DY46396 02768950
           L     R9,AINTER        SET BASE FOR I/O INTERRUPT   @DY46396 02769340
           USING INTRTN,R9        MAKE IOINTER ADDRESSABLE     @DY46396 02769730
           ST    RF,VTM31SAV      SAVE VTAM-REAL-CCW ADDRESS   @DY46396 02770120
           ST    R8,VTM31SAV+4    SAVE VTAM CCB ADDRESS        @DY46396 02770510
           DROP  R9               RELEASE IOINTER BASE         @DY46396 02770900
           L     R9,ACCWT         SET BASE REGISTER FOR CCWT RT@DY46396 02771290
           USING CCWTADR,R9       CCWTADR BASE                 @DY46396 02771680
           OC    CCBCCW(4),CCBCCW DOES OLD CCW COPY CHAIN EXIST@DY46396 02772070
           BZ    SVC49160         NO, NOTHING TO FREE          @DY46396 02772460
           BAS   R8,CCWVFREE      FREE CCW COPY BLOCKS         @DY46396 02772850
*SGLINK    CCWVFREE,INPUT=(R1,R3,R8,R9),WORK=R9                @DY46396 02773240
           DROP  R9               RELEASE CCWTADR BASE         @DY46396 02773630
SVC49160   DS    0H'0'            TRANSLATE THE NEW CHAIN      @DY46396 02774020
           ST    R7,CCBCCW        STORE NEW VTAM-REAL IN COPY  @DY46396 02774410
           MVC   CCBBY3(1),CCBBY3-CCBADR(RE) COPY USER BITS    @DY46396 02774800
           L     R9,ACCWT         SET BASE REGISTER FOR CCWT RT@DY46396 02775190
           USING CCWTADR,R9       CCWTADR BASE                 @DY46396 02775580
           BAS   R8,CCWVTRAN      TRANSLATE THE NEW CCW CHAIN  @DY46396 02775970
*SGLINK    CCWVTRAN,INPUT=(R1,R3,R8,R9),OUTPUT=R1              @DY46396 02776360
           DROP  R9               RELEASE CCWTADR BASE         @DY46396 02776750
.NV31020   ANOP                                                @DY46396 02777140
SVC49XIT   B     SVC0REND              ======================> @DM01249 02779450
SVC49CON   DS    0F'0'            CONSTANT INDICATES HSCH      @DA43858 02780140
           DC    CL4'HSCH'        CONSTANT INDICATES HSCH      @DA43858 02780830
           DC    3F'0'            CONSTANTS FOR DEBUG          @DA43858 02781520
           DROP  R1               RELEASE CCB BASE             @D369DAP 02782210
           DROP  R3               RELEASE PUB BASE             @D369DAP 02782900
           DROP  R4               RELEASE CHANQ BASE           @D14CDAP 02783590
           DROP  R8               RELEASE TIB BASE             @D369DAP 02784280
           DROP  RB               RELEASE PIB BASE             @D36IDAP 02784970
           DROP  R6               RELEASE DISP BASE            @D369DAP 02785660
           DROP  RC               RELEASE SVC BASE             @D14CDOW 02786350
           DROP  RD               RELEASE SGIOS BASE           @D369DAP 02787040
         TITLE 'VSE SUPERVISOR    SGIOS      VTAM SERVICE ROUTINES    ' 02789000
************************************************************** @D149DFG 02790000
* SVC 53 ROUTINE                                               @D149DFG 02791000
*                                                              @D149DFG 02792000
* PROVIDES SPECIAL PURPOSE FUNCTIONS FOR VTAM                  @D149DFG 02793000
*                                                              @D149DFG 02794000
* INPUT:  R0,R1                                                @D149DFG 02795000
*         R1 POINTS TO A 1 BYTE FUNCTION CODE (00,04,08,ETC.)  @D149DFG 02796000
*                                                              @D149DFG 02797000
* OUTPUT: RETURN CODE IN REG.15                                @D149DFG 02798000
*                                                              @D149DFG 02799000
* FUNCTIONS:                                                   @D149DFG 02800000
*                                                              @D149DFG 02801000
*         FC = 00  CURRENT TASK OBTAINS PSW KEY 0 AND          @DL28101 02802000
*                  IS FLAGGED AS EXECUTING VTAM CODE.          @D149DFG 02803000
*                  RETURN CODES: NONE                          @D149DFG 02804000
*                                                              @D149DFG 02805000
*         FC = 40  THE DISPATCHER EXIT TO CALL THE VTAM        @DA36477 02806000
*                  APPENDAGE ROUTINE ISTAPCKU IS SET           @DA36477 02807000
*                                                              @D149DFG 02808000
*         FC = 44  THE THREE BYTES FOLLOWING THE FUNCTION CODE @DA36477 02809000
*                  ARE ASSUMED TO POINT TO A CCB CONTAINING    @D149DFG 02810000
*                  A PUB INDEX IN BYTES 6-7, BITS 5-15.        @D149DFG 02811000
*                  A CHANNEL QUEUE ENTRY IS ENQUEUED ON THE    @D149DFG 02812000
*                  PUB AND INITIALIZED WITH THE CCB POINTER    @D149DFG 02813000
*                  AND WITH THE VTAMRP TASK AS OWNER.          @D149DFG 02814000
*                  THE CHQ ENTRY IS FLAGGED AS VTAM ATTENTION  @D149DFG 02815000
*                  ENTRY, TO PREVENT DEQUEUING.                @D149DFG 02816000
*                  RETURN CODES:  0 SUCCESSFUL                 @D149DFG 02817000
*                                 4 NO CHQ ENTRY AVAILABLE     @D149DFG 02818000
*                                 8 CHQ ENTRY ALREADY ENQUEUED @D149DFG 02819000
*                                                              @D149DFG 02820000
*         FC = 48  MAKE SUPERVISOR PROVISIONS TO INACTIVATE    @D51GDAP 02821000
*                  CHANNEL END APPENDAGE PROCESSING WHILE      @D51GDAP 02822000
*                  DUMP/LOAD PROCESSING IS ONGOING             @D51GDAP 02823000
*                  RETURN CODES:  0 SUCCESSFUL                 @D51GDAP 02824000
*                                 4 NO CHQ ENTRY AVAILABLE     @D51GDAP 02825000
*                                                              @D51GDAP 02826000
*         FC = 4C  MAKE SUPERVISOR PROVISIONS TO REACTIVATE    @D51G4AP 02827000
*                  CHANNEL END APPENDAGE PROCESSING SINCE      @D51GDAP 02828000
*                  DUMP/LOAD PROCESSING HAS TERMINATED         @D51GDAP 02829000
*                  RETURN CODES:  0 SUCCESSFUL                 @D51GDAP 02830000
*                                 4 NO CHQ ENTRY AVAILABLE     @D51GDAP 02831000
*                                                              @D51GDAP 02832000
*         FC = OTHER  CONTROL IS PASSED TO THE VTAM            @D149DFG 02833490
*                     APPENDAGE ROUTINE.                       @D149DFG 02834000
*                                                              @DA36477 02835000
************************************************************** @D149DFG 02836000
         USING SGIOS,RD           COMMON BASE FOR SGIOS        @D36IDAP 02837000
         USING SVC53,RC           SVC53 BASE POINTER           @D21KDAP 02838000
         USING DISP,R6            DISP BASE POINTER            @D369DAP 02839000
         USING TIBADR,R8          TIB BASE POINTER             @D369DAP 02840000
         USING TCBADR,RA          TCB BASE POINTER             @D369DAP 02841000
         USING PIBADR,RB          PIB BASE POINTER             @D369DAP 02842000
SVC53    DS    0H                                              @D35EDEM 02843000
         LA    R7,SVC53RET        SET UP TEMP BASE             @D61PDAP 02844000
         L     R9,IJBTCAVT        POINT TO VTAM VECTORTAB      @D35EDEM 02845000
         USING ISTAVT,R9          VTAM VECTOR TABLE BASE       @D35EDEM 02846000
         LA    RF,SVC53KY0        GET CONTINUATION ADDRESS     @D61PDAP 02847000
         TM    TCBEXFLG,TCBEXAM   31 BIT MODE                  @D61VTAP 02848000
         BZ    SVC53000           NO,                          @D61VTAP 02849000
         L     R5,ASVC5300        GET CONTINUATION ADDRESS     @DY46396 02850380
         BSM   0,R5               GET INTO 31-BIT ADDR.MODE    @DY46396 02850570
ASVC5300 DC    A(SVC53000+X'80000000') 31-BIT ADDRESS          @DY46396 02850760
SVC53000 CLI   0(R1),X'00'        KEY0 MODE ONLY REQD          @DL28101 02851000
PCKSVC53 EQU   *                                               @DL29H00 02852000
         BE    SVC53EXT           YES                          @D61PDAP 02853000
         CLI   0(R1),VTFCAREQ     ISTAPCKU ACTIVATION REQ.     @D51GDAP 02854000
         BE    SVC53VT            YES,                         @DA36477 02855000
         TM    IJBTCAVT,IJBTCACT  VTAM ACTIVE                  @DL28101 02856000
         BZ    ERR21              NO,  ====================>>> @DL28101 02857000
         CLI   0(R1),VTFCDEVA     SPECIAL REQUEST              @D14CDFG 02858000
         BL    SVC53ANY           NO, IT IS A VTAM REQUEST     @D51GDAP 02859000
         CLI   0(R1),VTFCEDMP     SURE ITS NOT SOMTHING SPECIAL@D51GDAP 02860000
         BNH   SVC53CCB           NO, IT IS SPECIAL            @D51GDAP 02861000
SVC53ANY L     R8,ISTAS53         ADDRESS OF ISTINCBS          @D61PDAP 02862000
         DROP  R8                 RELEASE TIB BASE             @D51GDAP 02863000
         LTR   R8,R8              IS INITIALIZATION DONE       @DL28101 02864000
         BZ    ERR21              NO,  ====================>>> @DL28101 02865000
         AMODESW CALL,REGS=(R7,R8) SET PROPER ADDRESSING MODE  @D61PDAP 02866000
*SGLINK  ISTINCBS,INPUT=(R7,R8),WORK=(R0,R1,R2,R3,R4,R5,R8,R9,RB,RC,   *02867590
               RD,RE,RF)                                                02868180
         USING SVC53RET,R7        ESTABLISH TEMP BASE          @D61PDAP 02869000
         DROP  RD                 RELEASE SGIOS BASE           @D61PDAP 02870000
         DROP  RC                 RELEASE SVC53 BASE           @D61PDAP 02871000
         DROP  R9                 RELEASE ISTAVT BASE          @D61PDAP 02872000
         DROP  RB                 RELEASE PIB BASE             @D61PDAP 02873000
SVC53RET B     SVC53RC0         0 NORMAL SVC53 RETURN          @D61PDAP 02874000
         B     SVC53RC4         4 ERROR EXIT                   @D61PDAP 02875000
         B     SVC53RC8         8 REQUEST SUPERVISOR/KEY0 STATE@D61PDAP 02876000
SVC53RC0 LR    RF,R6              NORMAL RETURN ADDRESS        @D61PDAP 02877000
         B     SVC53EXT                                        @D61PDAP 02878000
SVC53RC4 LA    RF,ERR21           ERROR RETURN ADDRESS         @D61PDAP 02879000
         B     SVC53EXT                                        @D61PDAP 02880000
SVC53RC8 LA    RF,SVC53KY0        SUPERVISOR STATE REQUEST     @D61PDAP 02881000
SVC53EXT AMODESW SET,AMODE=24,WR=(RB)                          @D61PDAP 02882000
         BR    RF                       ===================>>> @D61PDAP 02883000
         DROP  R7                 RELEASE TEMP BASE            @D61PDAP 02884000
SVC53KY0 L     RB,TCBSAVE         RESTORE SAVE AREA POINTER    @D14CDFG 02885000
         USING SVEARA,RB          ADDR.SAVE AREA               @D36IDFG 02886000
         NI    SVEPSW+1,X'0F'     SET PROTECTION  KEY 0        @D14CDFG 02887000
         OI    VTAMFLG,VTAMK0     KEY0/SUPSTATE REQUIRED       @D36IDFG 02888000
         BR    R6                       ===================>>> @D61PDAP 02889000
         DROP  RB                 RELEASE SAVE AREA BASE       @D51GDAP 02890000
         TITLE 'VSE SUPERVISOR    SGIOS      ALLOCATE CHANQ ENTRY     ' 02891000
         USING SGIOS,RD           COMMON BASE FOR SGIOS        @D61PDAP 02892000
         USING SVC53,RC           SVC53 BASE POINTER           @D61PDAP 02893000
         USING TIBADR,R8          TIB BASE POINTER             @D61PDAP 02894000
         USING PIBADR,RB          PIB BASE POINTER             @D61PDAP 02895000
SVC53CCB DS    0H'0'              ALLOCATE CHANQ ENTRY         @D61PDAP 02896490
         L     R5,PCBPTR          POINT TO CURRENT PCB         @D14CDFG 02897000
         USING PCBADR,R5                                       @D14CDFG 02898000
         TM    PCBSSFLG-PCBADR(R5),VTAM  REQ.FROM VTAM PART.   @D14CDFG 02899000
         BZ    ERR21              NO,  ====================>>> @D14CDFG 02900000
         LA    RF,SVC53C30        24-BIT CONTINUATION ADDRESS  @DY46396 02901280
         LR    R7,R1              USE R7 AS PARMLIST POINTER   @DY46396 02901370
         TM    TCBEXFLG,TCBEXAM   31 BIT MODE                  @DY46396 02901460
         BZ    SVC53C20           NO, OLD INTERFACE            @DY46396 02901550
         AIF   (NOT &VTAM31).NV31040                           @DY46396 02901640
         L     RF,ASVC53C0        GET 31-BIT ADDRESS           @DY46396 02901730
         BSM   0,RF               SWITCH TO 31-BIT MODE        @DY46396 02901820
ASVC53C0 DC    A(SVC53C00+X'80000000') 31-BIT MODE CONT.ADDR.  @DY46396 02901910
*HERE WE NEED TO TEST FOR VTAM-31 CAPABILITY                   @DY46396 02902000
*        VTAM CCB IS STILL LOCATED IN 24-BIT AREA              @DY46396 02902090
SVC53C00 LA    RF,SVC53C30        24-BIT CONTINUATION ADDRESS  @DY46396 02902180
         TM    IJBFLG0A,X'02'     VTAM-31 I/O                  @DY46396 02902270
         BZ    SVC53C20           NO,                          @DY46396 02902360
         SLR   R1,R1              CLEAR REGISTER               @DY46396 02902450
         ICM   R1,7,1(R7)         GET CCB POINTER              @DY46396 02902540
         B     SVC53C40           PROCEED MAIN PATH            @DY46396 02902630
.NV31040 ANOP                                                           02904230
SVC53C20 BSM   0,RF               GET BACK INTO 24-BIT MODE    @DY46396 02904510
SVC53C30 L     R1,0(,R7)          GET CCB POINTER FROM PARMLIST@DY46396 02904600
         LA    R1,0(,R1)          CLEAR FUNCTION BYTE          @DY46396 02904690
         USING CCBADR,R1          ADDRESS IS VALID             @D51GDAP 02904990
SVC53C40 SLR   R3,R3              CLEAR PUB POINTER            @D51GDAP 02905180
         SLR   RF,RF              SET RETURN CODE  00 FOR NOW  @DY46396 02906160
         ICM   R3,3,CCBCLS        GET PUB INDEX FROM CCB       @D51GDAP 02907000
         N     R3,PHYADMSK        LEAVE RELEVANT BITS ONLY     @D51GDAP 02908000
         LR    R0,R3              SAVE INDEX FOR LATER USE     @D51GDAP 02909490
         SLL   R3,3               MULTIPLY BY PUB LENGTH       @D51GDAP 02910000
         AH    R3,YPUBTAB         PUB ADDRESS                  @D51GDAP 02911000
         USING PUBADR,R3          PUB BASE POINTER             @D14CDFG 02912000
         L     R9,AINTER          SET BASE FOR I/O INTERRUPT   @D51GDAP 02913000
         USING INTRTN,R9          MAKE IOINTER ADDRESSABLE     @D34ADAP 02914000
         BAL   RE,GETPUBX         GET PUBX ADDRESS             @D51GDAP 02915000
*SGLINK  GETPUBX,INPUT=(R3,R9,RE),OUTPUT=R2                    @D51GDAP 02916000
         USING PBXADR,R2          PUBX BASE POINTER            @D51GDAP 02917000
         L     R9,IJBTCAVT        POINT TO VTAM VECTORTAB      @D35EDEM 02918000
         USING ISTAVT,R9          ISTAVT TABLE BASE POINTER    @D35EDEM 02919000
         CLI   0(R7),VTFCDEVA     DEVICE ACTIVATION REQ.       @DY46396 02920980
         BE    SVC53C60           YES, SET UP CHANQ ENTRY      @D14CDFG 02921380
         CLI   0(R7),VTFCSDMP     INITIATION OF DUMP/LOAD      @DY46396 02922460
         BE    SVC53DMP           YES,                         @D51GDAP 02923000
         CLI   0(R7),VTFCEDMP     TERMINATION OF LOAD/DUMP     @DY46396 02924680
         BE    SVC53FIN           YES,                         @D51GDAP 02925000
         B     SVC53R08           SYSTEM ERROR                 @D51GDAP 02926000
SVC53C60 CLI   PUBCHQPT,NOTQUED   CHANQ ENTRY ALREADY ENQUEUED @D14CDFG 02927590
         BE    SVC53C80           NO, ENQUEUE ONE              @DA43858 02928180
         CLC   PUBCHANN(2),IJBOWSAV IS THIS THE DISC. CONSOLE  @DA43858 02929000
         BNE   SVC53R08           YES, RETURN CODE 8           @D14CDFG 02930490
         B     RESVCIO                 ====================>>> @DA43858 02931000
*SGLINK  RESVCIO,INPUT=R6                                      @D369DAP 02932000
SVC53C80 DS    0H'0'              ENQUEUE VTAM CHANQ ENTRY              02933490
         AIF   (&AG1 LE 254).NMDV050                           @D51GDAP 02934000
         CLI   CHQFLPTR+1,NOTQUED CHANQ ENTRY AVAILABLE        @D51ODGL 02935000
         BE    SVC53R04           NO,                          @D51GDAP 02936000
         LH    R4,CHQFLPTR        GET NEXT FREE ENTRY NUMBER   @D51GDAP 02937000
         STCM  R4,2,PUBCHQPH      SAVE CHANQ NUMBER HIGH VALUE @D51GDAP 02938000
         AGO   .YMDV050                                        @D51GDAP 02939000
.NMDV050 CLI   FLPTR,XFF          CHANQ ENTRY AVAILABLE        @D14CDFG 02940000
         BE    SVC53R04           NO,                          @D14CDFG 02941000
         SLR   R4,R4              INITIALIZE FOR INSERT        @D14CDFG 02942000
         IC    R4,FLPTR           GET INDEX OF FIRST ENTRY     @D14CDFG 02943000
.YMDV050 STC   R4,PUBCHQPT        ENQUEUE ON PUB               @D14CDFG 02944000
         C     R4,CQEHIGH         HIGHER THAN HIGH WATER MARK  @D61CDAP 02945000
         BNH   SVC53CA0           NO,                          @D61CDAP 02946490
         ST    R4,CQEHIGH         SET NEW HIGH WATER MARK      @D61CDAP 02947000
SVC53CA0 SLL   R4,CHQSLEN         OFFSET IN CHANQ TABLE        @D14CDFG 02948490
         A     R4,ACHANQ          ADDRESS OF CHQ ENTRY         @D14CDFG 02949000
         ICM   R4,8,H0            CLEAR HIGH ORDER BYTE        @D68REEF 02950000
         USING CHQADR,R4          CHANQ BASE POINTER           @D14CDFG 02951490
         AIF   (&AG1 LE 254).NMDV060                           @D51ODAP 02952000
         MVC   CHQFLPTR(1),CHQCHNHI DEQUEUE FROM FREE LIST     @D51ODAP 02953000
         MVC   CHQFLPTR+1(1),CHQCHNLO QUEUE                    @D51ODAP 02954490
         AGO   .YMDV060                                        @D51GDAP 02955000
.NMDV060 MVC   FLPTR,CHQCHAIN     DEQUEUE FROM FREE LIST       @D14CDFG 02956000
.YMDV060 L     RB,CQEINUSE        CHANQ ENTIRES IN USE COUNTER @D61NDAP 02957000
         DROP  RB                 RELEASE PIB BASE             @D61CDAP 02958000
         LA    RB,1(,RB)          ADD 1                        @D61NDAP 02959000
         ST    RB,CQEINUSE        STORE NEW VALUE              @D61NDAP 02960000
         XC    CHQADR(CHQLEN),CHQADR CLEAR WHOLE CHANQ ENTRY   @D14CDFG 02961090
           AIF   (NOT &VTAM31).NV31060                                  02961180
           TM    IJBFLG0A,X'02'   VTAM-31 I/O                  @DY46396 02961340
           BO    SVC53CB0         YES,                         @DY46396 02961410
           TM    CCBBY3,CCBCCWF1+CCWABOVE VTAM-31 REQUEST      @DY46396 02961480
           BZ    SVC53CC0         NO,                          @DY46396 02961550
           DROP  R9               RELEASE ISTAVT BASE          @DY46396 02961620
SVC53CB0   L     R9,ACCWT         SET BASE REGISTER FOR CCWT RT@DY46396 02961690
           USING CCWTADR,R9       CCWTADR BASE                 @DY46396 02961760
           BAS   R8,CCBVTRAN      CREATE A COPIED CCB          @DY46396 02961830
*SGLINK    CCBVTRAN,INPUT=(R1,R3,R8,R9),OUTPUT=R1              @DY46396 02961900
           L     R9,IJBTCAVT      RESTORE VTAM-VECTOR-TAB. ADDR@DY46396 02961970
           USING ISTAVT,R9        VTAM VECTOR TABLE BASE       @DY46396 02962040
.NV31060   ANOP                                                         02962260
           LA    R8,SVC53CC0      LOAD 24 BIT ADDRESS          @DY46396 02962400
           BSM   0,R8             PROCEED IN 24-BIT MODE       @DY46396 02962450
SVC53CC0 ST    R1,CHQCCBAD        SAVE COPIED CCB ADDRESS      @D51GDAP 02962530
         MVI   CHQCHAIN,XFF       SET END OF CHAIN             @D51GDAP 02963000
         MVI   CHQCHNHI,XFF       SET END OF CHAIN HIGH BYTE   @D51ODAP 02964000
         MVC   CHQTID,ISTVTTIK    SET REQUEST OWNER            @D66ADAP 02967000
         MVC   CHQCAWKY(1),PCEKEY SET STORAGE KEY              @DY46396 02970990
         MVI   CHQSLUB,XFF        INDICATE NON-SYSTEM REQUEST  @D51GDAP 02973000
         MVC   CHQCCBB1(2),CCBCOM1 COPY COMM. BYTES 1 AND 2    @D14CDFG 02974000
         OI    CHQCCBB1,POSTDE    FORCE POST AT DEVICE END     @D14CDFG 02975000
         MVC   CHQCCBB3,CCBBY3    COPY COMM. BYTE 3            @D14CDFG 02976000
         STH   R0,CHQPUBHI        SAVE PUB NUMBER              @D51GDAP 02977000
         OI    CHQFLG1,CHQFSIO1   USE PRIMARY PATH ONLY        @D51GDAP 02978000
         OI    CHQGRP,CHQGRVTM    INDICATE VTAM ENTRY          @D14CDFG 02979000
         OI    CHQDEV,CHQTP       INDICATE TP DEVICE           @D14CDFG 02980000
         OI    PUBCSFLG,DEVBSY    GATE DEVICE FOR NORMAL I/O   @D14CDFG 02982000
         B     SVC53R00           EXIT WITH RETURN CODE 0      @D14CDFG 02983000
         DROP  R4                 RELEASE CHANQ BASE           @D51GDAP 02984000
         TITLE 'VSE SUPERVISOR    SGIOS     VTAM  DUMP/LOAD INITIATION' 02986000
SVC53DMP DS    0H'0'              MAKE PROVISIONS FOR LOAD/DUMP@D51GDAP 02987000
         SLR   R4,R4              CLEAR REGISTER               @D51GDAP 02988000
         SLR   R0,R0              CLEAR REGISTER               @D51GDAP 02989000
         CLI   PUBCHQPT,NOTQUED   IS A REQUEST QUEUED          @D51GDAP 02990000
         BE    SVC53D20           NO,                          @D52VDAP 02991000
         TM    PUBCSFLG,QEDERR    IS ERP ONGOING               @D51GDAP 02992000
         BO    RESVC              YES, ====================>>> @D51GDAP 02993490
*SGLINK  RESVC,INPUT=R6                                        @D369DAP 02994000
         IC    R4,PUBCHQPT        GET CURRENT CHANQ POINTER    @D51GDAP 02995000
         AIF   (&AG1 LE 254).NMDV070                           @D51ODAP 02996000
         ICM   R4,2,PUBCHQPH      GET HIGH ORDER INDEX         @D51ODAP 02997000
.NMDV070 LR    R0,R4              SAVE CHANQ INDEX             @D51GDAP 02998000
SVC53D10 SLL   R4,CHQSLEN         OFFSET IN CHQ TABLE          @D51ODAP 02999000
         A     R4,ACHANQ          ADDRESS OF CHQ ENTRY         @D51GDAP 03000000
         ICM   R4,8,H0            CLEAR HIGH ORDER BYTE        @D68REEF 03001000
         USING CHQADR,R4                                       @D51GDAP 03002000
         TM    CHQGRP,CHQGRVTM    IS IT A VTAM REQUEST         @D51GDAP 03003000
         BNO   ERR21              NO,  ====================>>> @D51GDAP 03004000
         CLI   CHQCHAIN,NOTQUED   MORE THAN ONE REQUEST        @D51GDAP 03005000
         BNE   ERR21              YES, ====================>>> @D51GDAP 03006000
SVC53D20 CLC   PBXVTMCQ(2),H0     DID WE SAVE AN ENTRY         @D61POAP 03007000
         BNE   ERR21              YES, ====================>>> @D51GDAP 03008000
         STH   R0,PBXVTMCQ        SAVE CURRENT CHANQ ENTRY NO. @D61POAP 03009490
         LTR   R4,R4              WAS ENTRY ENQUEUED           @D52VDAP 03010000
         BZ    SVC53DXT           NO,                          @D52VDAP 03011000
         AIF   (&AG1 LE 254).NMDV080                           @D51ODAP 03012000
         MVI   PUBCHQPH,XFF       DEQUEUE CHANQ ENTRY FROM PUB @D51ODAP 03013000
.NMDV080 MVI   PUBCHQPT,XFF       DEQUEUE CHANQ ENTRY FROM PUB @D51GDAP 03014000
         TM    PUBCSFLG,DEVBSY    WAS DEVICE BUSY              @D51GDEP 03015000
         BZ    SVC53DXT           NO,                          @D51GDEP 03016000
         OI    CHQFLG1,CHQCSBSY   SAVE BUSY STATUS             @D51GDEP 03017000
         NI    PUBCSFLG,XFF-DEVBSY RESET IT IN THE PUB         @D51GDFG 03018000
SVC53DXT B     SVC53R00                                        @D51GDAP 03019000
         DROP  R4                 RELEASE CHANQ BASE           @D51GDAP 03020000
         TITLE 'VSE SUPERVISOR    SGIOS     VTAM DUMP/LOAD TERMINATION' 03021000
SVC53FIN DS    0H'0'              TERMINATE LOAD/DUMP PROC.    @D51GDAP 03022000
         TM    PUBCSFLG,QEDERR    IS ERP ONGOING               @D51GDAP 03023000
         BO    RESVC              YES, ====================>>> @D51GDAP 03024490
*SGLINK  RESVC,INPUT=R6                                        @D369DAP 03025000
         LH    R4,PBXVTMCQ        GET CHANQ CHAIN POINTER      @D61POAP 03026000
         LTR   R4,R4              DID WE SAVE ANYTHING         @D51GDAP 03027000
         BZ    ERR21              NO,  ====================>>> @D51GDAP 03028000
         XC    PBXVTMCQ(2),PBXVTMCQ CLEAR SAVED ENTRY NUMBER   @D61POAP 03029000
         AIF   (&AG1 LE 254).NMDV090                           @D51ODAP 03030000
         STCM  R4,2,PUBCHQPH      SET  HIGH INDEX BYTE         @D51GDAP 03031000
.NMDV090 STC   R4,PUBCHQPT        SET CHANQ INDEX              @D51GDAP 03032000
         SLL   R4,CHQSLEN         OFFSET IN CHANQ TABLE        @D51ODAP 03033000
         A     R4,ACHANQ          ADDRESS OF NEXT CHANQ ENTRY  @D51GDAP 03034000
         ICM   R4,8,H0            CLEAR HIGH ORDER BYTE        @D68REEF 03035000
         USING CHQADR,R4          CHANQ BASE POINTER           @D51GDAP 03036000
         TM    CHQFLG1,CHQCSBSY   SAVE BUSY STATUS             @D51GDEP 03037000
         BZ    SVC53FXT           NO,                          @D51GDEP 03038000
         OI    PUBCSFLG,DEVBSY    WAS DEVICE BUSY              @D51GDEP 03039000
         NI    CHQFLG1,XFF-CHQCSBSY RESET BIT IN CHANQ         @D51GDFG 03040000
SVC53FXT B     SVC53R00                                        @D51GDAP 03041000
         SPACE 1                                               @D51GDAP 03042000
         DROP  R1                 RELEASE CCB BASE POINTER     @DY46396 03043680
         DROP  R2                 RELEASE PUBX BASE POINTER    @D51GDAP 03044000
         DROP  R3                 RELEASE PUB BASE POINTER     @D14CDFG 03046000
         DROP  R4                 RELEASE CHANQ BASE           @D14CDFG 03046500
         DROP  R5                 RELEASE PCB BASE POINTER     @D51GDAP 03047000
SVC53R08 LA    RF,4(RF)           CHQ ALREADY ENQUEUED         @D14CDFG 03048000
SVC53R04 LA    RF,4(RF)           NO CHQ ENTRY AVAILABLE       @D14CDFG 03049000
SVC53R00 L     RB,TCBSAVE         RESTORE SAVE AREA POINTER    @D14CDFG 03050000
         USING SVEARA,RB          ADDR.SAVE AREA               @D36IDFG 03051000
         ST    RF,SVER0F                                       @D14CDFG 03052000
         BR    R6                 EXIT ====================>>> @D14CDFG 03053000
         DROP  RB                 RELEASE SVEARA BASE          @D51GDAP 03054000
         DROP  R9                 RELEASE ISTAVT BASE          @DY46396 03054690
         SPACE 2                                               @DA36477 03055000
************************************************************** @DA36477 03056000
*   INLINE CODE TO SUPPORT SVC 53 FUNCTION CODE X'40':         @DA36477 03057000
*     THE DISPATCHER EXIT TO CALL THE ISTAPCKU ROUTINE         @DA36477 03058000
*     HAS TO BE SET.                                           @DA36477 03059000
************************************************************** @DA36477 03060000
         SPACE 1                                               @DA36477 03061000
         USING PIBADR,RB          PIB BASE POINTER             @D51GDAP 03062000
SVC53VT  DS    0H                                              @DA36477 03063000
         AMODESW SET,AMODE=24,WR=(R5)                          @D61PDAP 03064000
         OI    TIBFLAG3,VTACTCKU  SET ISTAPCKU TO BE ACTIVATED @DA36477 03065000
         OI    TIBFLAG,APSEXFLG   SET VTAM DISPATCHER EXIT     @DA36477 03066000
         BR    R6                 EXIT ====================>>> @DA36477 03067000
         DROP  R6                 RELEASE DISP BASE POINTER    @D51GDAP 03068000
         DROP  R8                 RELEASE TIB BASE POINTER     @D51GDAP 03069000
         DROP  RA                 RELEASE TCB BASE POINTER     @D36IDFR 03070000
         DROP  RB                 RELEASE PIB BASE             @D36IDFR 03071000
         DROP  RC                 RELEASE SVC53 BASE           @D51GDAP 03072000
         DROP  RD                 RELEASE SGIOS BASE           @D51GDAP 03073000
* FOLLOWING FC STILL TO BE DEFINED                             @D14CDFG 03074000
VTFCAREQ EQU   X'40'              FC FOR INITIATE ISTAPCKU EXIT@D51GDAP 03075000
VTFCDEVA EQU   X'44'              FC FOR DEVICE ACTIVATION     @D51GDAP 03076000
VTFCSDMP EQU   X'48'              FC FOR START DUMP PROCESS    @D51GDAP 03077000
VTFCEDMP EQU   X'4C'              FC FOR TERMINATE DUMP PROCESS@D51GDAP 03078000
         TITLE 'VSE SUPERVISOR     SGIOS     ALLOW CHANNEL END APPEND.' 03079000
         USING SVC73,RC           SVC73 BASE POINTER           @D21KDAP 03080000
         USING DISP,R6            DISP BASE POINTER            @D369DAP 03081000
         USING TIBADR,R8          TIB BASE POINTER             @D369DAP 03082000
         USING TCBADR,RA          TCB BASE POINTER             @D369DAP 03083000
         USING PIBADR,RB          PIB BASE POINTER             @D369DAP 03084000
SVC73    OI    PIBPUBAS,APPEN     VALIDATE APPENDAGE EXIT      @D51IDAP 03085000
         BR    R6                      ====================>>> @D35ZDAP 03086000
         DROP  R8                 DROP TIB BASE                         03087000
         DROP  RA                 DROP TCB BASE                         03088000
         DROP  RB                 DROP PIB BASE                         03089000
         DROP  R6                 DROP DISPATCHER BASE                  03090000
         DROP  RC                 DROP SVC73 BASE                       03091000
         TITLE 'VSE SUPERVISOR     SGIOS     SVC-03 PROCESSING        ' 03092000
.*                                                                    * 03093000
.*                                                                    * 03094000
.*       FUNCTION:                                                    * 03095000
.*                                                                    * 03096000
.*       THE SVC03 SERVES DIFFERENT FUNCTIONS:                        * 03097000
.*            1. RESET OSA-DEVICE ATTENTION EXIT IF ENTERED FROM EOT  * 03098000
.*            2. QUIESCE I/O OPERATIONS          IF ENTERED FROM EOT  * 03099000
.*            3. GENERAL PURPOSE SVC FOR I/O RELATED PROCESSING       * 03100000
.*                 FC=0 SIMULATE INTERRUPT                            * 03101000
.*                 FC=1 ESTABLISH VIRTUAL DEVICE EXIT                 * 03102000
.*                 FC=2 REMOVE    VIRTUAL DEVICE EXIT                 * 03103000
.*                 FC=3 ISPF QUIESCE I/O                              * 03104000
.*                 FC=4 JCL QUIESCE I/O                               * 03105000
.*                 FC=5 FORCE DEVICE VERIFIATION TO BE INITIATED      * 03106000
.*                 FC=6 OSA DEVICE SUPPORT                            * 03107000
.*                 FC=7 ESTABLISH FLASH-COPY INTERFACE                * 03108000
.*                 FC=8 OSAX DEVICE SUPPORT                           * 03109000
.*            4. GENERAL PURPOSE SVC FOR AR SPECIAL SERVICES          * 03110000
.*                 FC=0 SIMULATE ATTENTION INTERRUPT                  * 03111000
.*                 FC=1 READY DEVICE                                  * 03112000
.*                 FC=2 CANCEL CUU                                    * 03113000
.*                 FC=3 READY ALL DEVICES ON CHANNEL                  * 03114000
.*                                                                    * 03115000
.*       EXIT TO : DISPATCHER/CANCEL EXIT,RESVC,ERR19 OR ERR21        * 03116000
.*                                                                    * 03117000
.*       INPUT PARAMETER:                                             * 03118000
.*          R0 : PARAMETER REGISTER                                   * 03119000
.*          R1 : FUNCTION CODE                                        * 03120000
.*                                                                    * 03121000
.*       OUTPUT PARAMETER:                                            * 03122000
.*          R0 : POINTER TO PUB THAT DID HAVE I/O REQUEST QUEUED      * 03123000
.*                                                                    * 03124000
.********************************************************************** 03125000
         USING SGIOS,RD          SGIOS BASE POINTER            @D51GDAP 03126000
         USING SVC03,RC          SVC03 BASE POINTER                     03127000
         USING DISP,R6           DISPATCHER BASE POINTER                03128000
         USING TIBADR,R8         TIB BASE POINTER                       03129000
         USING TCBADR,RA         TCB BASE POINTER                       03130000
         USING PIBADR,RB         PIB BASE POINTER                       03131000
SVC03    DS    0H'0'             ENTRY POINT IF ENTERED VIA SVC         03132000
         DROP  RB                RELEASE PIB BASE POINTER      @D369DAP 03133000
         TM    TIBFLAG1,EOTACT   REQUEST FROM $IJBSEOT         @D36BDAP 03134000
         BZ    SVC03GEN          NO, GENERAL USE SVC           @D61ADRP 03135000
         L     R5,TCBPTR         TCB  BASE ADDRESS             @D66ODAP 03136000
         USING TCBADR,R5         TCB BASE POINTER              @D66ODAP 03137000
         LA    R5,SVCWORKB       ADDR OF TASK WORK-AREA        @D66ODAP 03138000
         DROP  R5                RELEASE TCB BASE              @D66ODAP 03139000
         CLR   R5,R0             IS THIS THE QDIO REQUEST      @D66ODAP 03140000
         BE    SVC03GEN          YES, SPECIAL PROCESSING       @D66ODAP 03141000
.*                                                             @D61ADRP 03142000
.*  SCAN PUBX TO CLEAR PENDING ATTENTION EXIT FOR OSA DEVICES  @D62OSAP 03143000
.*                                                             @D61ADRP 03144000
         L     R5,APBXAREA       ADDRESS OF PBXAREA            @D61ADRP 03145000
         S     R5,F4             ADJUST FOR NEXT INSTRUCTION   @D61ADRP 03146000
         LH    R2,YPUBTAB        GET PUB POINTER               @D62OSAP 03147000
         S     R2,F8             ADJUST FOR NEXT INSTRUCTION   @D61ADRP 03148000
SVC03OXP LA    R5,4(,R5)         POINT TO FIRST/NEXT PUBX ADDR.@D61ADRP 03149000
         LA    R2,8(,R2)         POINT TO FIRST/NEXT PUB  ADDR.@D62OSAP 03150000
         USING PUBADR,R2         PUB  BASE POINTER             @D62OSAP 03151000
         ICM   R4,15,0(R5)       GET NEXT PUBX ADDRESS         @D61ADRP 03152000
         BNP   SVC03SVC          DONE =======================> @D61ADRP 03153000
         USING PBXADR,R4         PUBX BASE POINTER             @D61ADRP 03154000
         CLI   PUBDEVTY,TOSA     IS THIS AN OSA DEVICE         @D62OSAP 03155000
         BNE   SVC03QXP          NO,                           @DA44841 03156000
         CLI   PUBOPTN,PUBOPOFE  SURE IT IS THE OSA FE PORT    @D62OSAP 03157000
         BNE   SVC03OXP          NO,                           @DA44841 03158000
         CLC   PBXATTIB(4),TIBPTR IS THIS ALSO THE ISSUER      @D62OSAP 03159000
         BNE   SVC03OXP          NO,                           @DA44841 03160000
         XC    PBXATTIB,PBXATTIB RESET ATTENTION OWNER INFO    @D62OSAP 03161000
         XC    PBXATECB,PBXATECB RESET ATTENTION EXIT ECB      @D62OSAP 03162000
         B     SVC03OXP          NO,                           @DA44841 03163000
.*                                                             @D61ADRP 03164000
.*  SCAN PUBX TO CLEAR PENDING ATTENTION EXIT FOR QDIO DEVICES @D66ADAP 03165000
.*                                                             @D61ADRP 03166000
SVC03QXP DC    0H'0'                                                    03167000
         NOP   SVC03OXP                                                 03168000
         CLI   PUBDEVTY,TQDIO    IS THIS AN OSA EXPRESS DEVICE @D66ADAP 03169000
         BNE   SVC03OXP          NO,                           @D66ADAP 03170000
         CLC   PBXATTIB(4),TIBPTR IS THIS ALSO THE ISSUER      @D66ADAP 03171000
         BNE   SVC03OXP          NO,                           @D66ADAP 03172000
         SLR   R1,R1             CLEAR REGISTER                @D66ADAP 03173000
         STCM  R1,15,PBXATTIB    RESET EXIT OWNER INFORMATION  @D66ADAP 03174000
         STCM  R1,15,PBXCEAPP    SET/RESET APPEND ADDRESSS     @D66ADAP 03175000
         B     SVC03OXP          CHECK NEXT DEVICE             @D66ADAP 03176000
         EJECT ,                                                        03177000
.*                                                                      03178000
.*       VALIDATE FUNCTIONAL CALL                                       03179000
.*                                                                      03180000
SVC03GEN CLC   TID,IORQ4AR       REQUEST FROM ATTENTION        @D66ADAP 03181000
         BE    SVC03ATN          YES, EXECUTE ITS FUNCTION     @D66ADAP 03182000
         C     R1,SVC03MFC       IS THIS A VALID CALL          @D62OSAP 03183000
         BNL   ERR21             NO,  =====================>>> @D21ODAP 03184000
         L     RB,PIBPTR2        ADDRESS OF PIB                @DY46299 03184100
         USING PIB2ADR,RB        PIB2 BASE POINTER             @DY46299 03184200
         L     RB,PIBPCB         PCB BASE ADDRESS              @DY46299 03184300
         USING PCBADR,RB         PCB BASE POINTER              @DY46299 03184400
         L     RB,PCEPIB         PIB BASE ADDRESS              @DY46299 03184500
         USING PIBADR,RB         PIB BASE POINTER              @DY46299 03184600
         LR    R7,R1             COPY FUNCTION CODE            @D52HDAP 03185000
         SLL   R7,2              MULTIPLY WITH FOUR            @D52HDAP 03186000
         L     R7,SVC03FTB(R7)   GET ROUTINE ADDRESS           @D66ADAP 03187000
         BASSM R7,R7             EXECUTE ROUTINE IN PROPER MODE@D66ADAP 03188000
         DROP  RB                RELEASE PIBADR BASE                    03188500
         DC    0F'0'                                                    03189000
SVC03FTB DC    A(SVC03FD)        FC=0 FORCE REQUEST DEQUEUING  @D3CDDAP 03190000
*        OR,                          SIMULATE ATTENTION       @DSCSI   03191000
         DC    A(SVC03DS+X'80000000') FC=1 ESTABLISH VIRT.DEV. @D3CDDAP 03192000
         DC    A(SVC03DT)        FC=2 TERMINATE VIRT.DEV.      @D3CDDAP 03193000
         DC    A(SVC03ISP)       FC=3 QUIESCE I/O PROCESSING   @D52VDAP 03194000
         DC    A(SVC03JCL)       FC=4 QUIESCE I/O PROCESSING   @D52HDAP 03195000
         DC    A(SVC03RAS)       FC=5 FORCE PATH VERIFICATION  @D62TAAP 03196000
         DC    A(SVC03OSA+X'80000000') FC=6 OSA PROCESSING     @D62OSAP 03197000
         DC    A(SVC03CPY+X'80000000') FC=7 FLASH COPY         @D66ADAP 03198000
         DC    A(SVC03OSX+X'80000000') FC=8 OSAX PROCESSING    @D66ADAP 03200000
         AIF   (NOT &VSE280).N280100                           @D68ADAP 03202000
         DC    A(SVC03MSG+X'80000000') FC=9 MSG  PROCESSING    @D68ADAP 03203000
.N280100 ANOP                                                  @D25IDAP 03204000
         DS    0F'0'                                           @D62OSAP 03205000
SVC03MFC DC    AL4((*-SVC03FTB)/L'SVC03FTB) MAX. FUNCTION CODE @D66ADAP 03206000
SVC03JCL L     R7,CRADDR         ADDRESS OF COMREG             @D52HDAP 03207000
         USING COMREG,R7         COMREG BASE POINTER           @D52HDAP 03208000
         TM    JCSW5,JCLACTIV    IS JCL ACTIVE                 @D52HDAP 03209000
         BO    SVC03SVC          YES, OK                       @D52HDAP 03210000
         B     ERR21                  =====================>>> @D52HDAP 03211000
         DROP  R7                RELEASE COMREG POINTER        @DA41104 03212000
         SPACE 3                                               @D52VDAP 03213000
SVC03ISP TM    TCBFLAG3,ISPFMT   IS IT ISPF                    @D3CDDAP 03214490
         BNO   ERR21             NO,  =====================>>> @D3CDDAP 03215000
         TM    TCBABEX,EXITACT   FROM AB EXIT ROUTINE          @DA44364 03217000
         BNO   ERR21             NO,  =====================>>> @D3CDDAP 03222000
         TITLE 'VSE SUPERVISOR     SGIOS     QUIESCE I/O PROCESSING   ' 03223000
*********************************************************************** 03224000
*                                                                     * 03225000
*        QUIESCE I/O PROCESSING                                       * 03226000
*                                                                     * 03227000
*********************************************************************** 03228000
         SPACE 3                                                        03229000
*SGLINK  SVC03SVC,INPUT=(R6,R7,R8,RA,RC,RD),WORK=(R1,R2,R3,R4,R5,RE,RF) 03230000
SVC03SVC MVI   SVC03PRC,SVCISSVC INDICATE SVC03 REQUEST        @D51GDAP 03231000
         LR    R7,R6             FORCE RETURN TO DISPATCHER    @D14CDAP 03232000
         LTR   R3,R0             INITIAL CALL                  @D369DAP 03233000
         BNZ   SVC03LOP          NO,  CONTINUE WITH GIVEN PUB  @D369DAP 03234000
.*                                                             @D51ODGL 03235000
.*       RE-ENQUEUE ENTRIES (USED BY OLTEP) BACK TO CHANQ      @D51ODGL 03236000
.*                                                             @D51ODGL 03237000
         SPACE 1                                               @D51ODGL 03238000
         L     R4,ACHANQ          POINT TO 1ST CHANQ ENTRY     @D51ODGL 03239000
         ICM   R4,8,H0            CLEAR HIGH ORDER BYTE        @D68REEF 03240000
         USING CHQADR,R4                                       @D51ODGL 03241000
         SLR   R2,R2              CLEAR CHANQ INDEX COUNTER    @D51ODGL 03242000
         SLR   R5,R5              CLEAR REGISTER               @DAOM085 03243290
         ICM   R5,3,LTHIDQ        NO. OF CHANQ ENTRIES         @D51ODGL 03243580
         SLL   R5,CHQSLEN         MULTIPLY WITH ENTRY LENGTH   @D51ODGL 03244000
         AR    R5,R4              END OF CHANQ ENTRY ADDRESS+1 @D51ODGL 03245000
         BAL   R3,SVC03CHQ        LOOP WHILE CHANQ ENTRIES LEFT@D51ODGL 03246000
         LA    R4,CHQLEN(R4)      POINT TO NEXT CHANQ ENTRY    @D51ODGL 03247000
         LA    R2,1(R2)           TAKE NEXT CHANQ INDEX        @D51ODGL 03248000
         CR    R4,R5              REACHED END OF CHANQ QUEUE   @D51ODGL 03249000
         BNL   SVC03QIO           YES, ======================> @DA44993 03250000
SVC03CHQ CLM   R2,1,CHQCHNLO      OLTEP ENTRY                  @D51ODGL 03251000
         BNER  R3                 NO, CHECK NEXT ENTRY         @D51ODGL 03252000
         CLM   R2,2,CHQCHNHI      OLTEP ENTRY                  @D51ODGL 03253000
         BNER  R3                 NO, CHECK NEXT ENTRY         @D51ODGL 03254000
         LA    RE,TID             POINT TO TID                 @D66ADAP 03255000
         CLC   CHQTID,0(RE)       IS THIS THE RIGHT REQUESTOR  @D66ADAP 03259000
         BNER  R3                 NO, CHECK NEXT ENTRY         @D51ODGL 03260000
         AIF   (&AG1 LE 254).LOD0220                           @D51ODGL 03261000
         MVC   CHQCHNLO(1),CHQFLPTR+1  CHAIN FREELIST TO ENTRY @D51ODGL 03262000
         MVC   CHQCHNHI(1),CHQFLPTR    ALSO WITH HIGH BYTE     @D51ODGL 03263000
         AGO   .LOD0221                                                 03264000
.LOD0220 ANOP                                                  @D51ODGL 03265000
         MVC   CHQCHAIN(1),FLPTR  UPDATE CHANQ CHAIN POINTER   @D51ODGL 03266000
         STC   R2,FLPTR           UPDATE FREELIST POINTER      @D51ODGL 03267000
.LOD0221 ANOP                                                  @D51ODGL 03268000
         STH   R2,CHQFLPTR        CHAIN ENTRY TO FREELIST      @D51ODGL 03269000
         ICM   RE,15,CQEINUSE     CHANQ ENTRIES IN USE COUNTER @D61NDAP 03270000
         BZR   R3                 IS 0, CHECK NEXT ENTRY       @D61NDAP 03271000
         BCTR  RE,0               SUBTRACT 1                   @D61NDAP 03272000
         ST    RE,CQEINUSE        STORE NEW VALUE              @D61NDAP 03273000
         BR    R3                 CHECK NEXT ENTRY             @D51ODGL 03274000
         DROP  R4                 RELEASE CHANNEL QUEUE BASE   @D51ODGL 03275000
*                                                                       03276000
.*                                                                      03277000
.*       TERMINATOR REQUESTS LTA I/O REQUESTS TO BE QUIESCED            03278000
.*                                                                      03279000
         SPACE 1                                               @D51GDAP 03280000
*SGLINK  SVC03LTA,INPUT=(R6,R7,R8,RA,RC,RD),WORK=(R1,R2,R3,R4,R5,RE,RF) 03281000
SVC03LTA MVI   SVC03PRC,SVCISLTA TERMINATOR QUISCE LTA REQUEST @D51GDAP 03282000
         B     SVC03QIO                                        @D51GDAP 03283000
         SPACE 1                                               @D51GDAP 03284000
*SGLINK  SVC03EOT,INPUT=(R6,R7,R8,RA,RC,RD),WORK=(R1,R2,R3,R4,R5,RE,RF) 03285000
SVC03EOT MVI   SVC03PRC,SVCISEOT INDICATE EOT REQUEST          @D51GDAP 03286490
         L     R5,PCBPTR         PCB BASE ADDRESS              @D51GDAP 03287000
         USING PCBADR,R5         PCB BASE POINTER              @D51GDAP 03288000
         TM    PCBSSFLG,VTAM     IS VTAM TERMINATING           @D51GDAP 03289000
         BZ    SVC03QIO          NO,                           @D51GDAP 03290000
         DROP  R5                RELEASE PCB BASE POINTER      @D51GDAP 03291000
         LH    R3,YPUBTAB        POINTER TO PUB TABLE          @D51GDAP 03292000
         USING PUBADR,R3         PUB BASE POINTER              @D51GDAP 03293000
         L     R5,APBXAREA       PUBX ADDRESS VECTOR TABLE     @D51GDAP 03294000
         SLR   R1,R1             CLEAR REGISTER                @D51GDAP 03295000
SVC03E10 CLI   PUBCHANN,XFF      WAS THIS THE LAST PUB         @D51GDAP 03296000
         BE    SVC03QIO          YES,                          @D51GDAP 03297000
         L     R2,0(R5)          GET PUBX POINTER              @D51GDAP 03298000
         USING PBXADR,R2         PUBX BASE POINTER             @D51GDAP 03299000
         LA    R5,4(,R5)         ADVANCE PUBX ADDRESS POINTER  @D51GDAP 03300000
         LA    R3,NEXTPUB        ADVANCE PUB POINTER           @D51GDAP 03301000
         ICM   R1,3,PBXVTMCQ     GET CHANQ INDEX               @D61POAP 03302000
         BZ    SVC03E10          NONE WAS PRESENT              @D51GDAP 03303000
         XC    PBXVTMCQ(2),PBXVTMCQ RESET SAVED CHANQ INDEX    @D61POAP 03304000
         LR    R4,R1             COPY CHANQ ENTRY NUMBER       @D51GDAP 03305000
         SLL   R4,CHQSLEN        MULTIPLY WITH ENTRY LENGTH    @D51GDAP 03306000
         A     R4,ACHANQ         ADDRESS OF CHANQ ENTRY        @D51GDAP 03307000
         ICM   R4,8,H0           CLEAR HIGH ORDER BYTE         @D68REEF 03308000
         USING CHQADR,R4         PUB BASE POINTER              @D51GDAP 03309000
         XC    CHQCCBAD+1(31),CHQCCBAD+1 CLEAR CHANQ ENTRY     @D51ODGL 03310000
         AIF   (&AG1 LE 254).NMDV0A0                           @D51GDAP 03311000
         MVC   CHQCHNHI(1),CHQFLPTR ENQUEUE TO FREE CHAIN      @D51GDAP 03312000
         MVC   CHQCHNLO(1),CHQFLPTR+1 ENQUEUE WHOLE ENTRY      @D51GDAP 03313000
         AGO   .YMDV0A0                                        @D51GDAP 03314000
.NMDV0A0 MVC   CHQCHAIN(1),FLPTR ENQUEUE TO FREE LIST          @D51GDAP 03315000
         STC   R1,FLPTR          SAVE NEW FREE ENTRY           @D51ODGL 03316000
.YMDV0A0 ANOP                                                  @D51ODGL 03317000
         STH   R1,CHQFLPTR       SAVE NEW FREE ENTRY           @D51ODGL 03318000
         ICM   R2,15,CQEINUSE    CHANQ ENTIRES IN USE COUNTER  @D61NDAP 03319000
         BZ    SVC03E10          IS 0                          @D61NDAP 03320000
         BCTR  R2,0              SUBTRACT 1                    @D61NDAP 03321000
         ST    R2,CQEINUSE       STORE NEW VALUE               @D61NDAP 03322000
         B     SVC03E10          PROCESS NEXT PUB              @D51GDAP 03323000
         DROP  R4                RELEASE CHANQ POINTER         @D51GDAP 03324000
         DROP  R2                RELEASE PBXADR                @DA44364 03325000
         SPACE 1                                               @D51GDAP 03326000
SVC03QIO SLR   R2,R2             CLEAR REGISTER                @D61SAAP 03327000
         IC    R2,SVC03PRC       SAVE PROCESSING FLAG          @D61SAAP 03328000
         L     RD,DOCBASE        CONSOLE SUPPORT BASE ADDRESS  @D61CSAP 03329000
         USING SGDOC,RD          SGDOC BASE POINTER            @D61CSAP 03330000
         BAL   RE,DOCSVC3        NOTIFY SGDOC ABOUT CANCELATION@D61CSAP 03331000
*SGLINK  DOCSVC3,WORK=(R0,R1,R3,R4,R5,R8,R9,RA,RB,RE,RF)       @D61CSAP 03332000
         L     RD,IOSBASE        RESTORE COMMON BASE POINTER   @D61CSAP 03333000
         USING SGIOS,RD          COMMON SGIOS BASE POINTER     @D61SAAP 03334000
         L     R8,TIBPTR         RESTORE TIB BASE POINTER      @D61CSAP 03335000
         L     RA,TCBPTR         RESTORE TCB BASE POINTER      @D61CSAP 03336000
         STC   R2,SVC03PRC       RESTORE PROCESSING FLAG       @D61CSAP 03337000
SVC03Q10 LH    R3,YPUBTAB        POINTER TO PUB TABLE          @D369DAP 03338000
         USING PUBADR,R3         PUB BASE POINTER              @D369DAP 03339000
SVC03LOP L     R2,AERBLOC        ADDRESS OF ERROR BLOCK        @D61GDAP 03340000
         USING ERBLOC,R2         ERROR BLOCK BASE POINTER      @D61GDAP 03341000
         TM    ERQFLG1,OCCUP     IS ERBLOC ENTRY ACTIVE        @D61GDAP 03342000
         BZ    SVC03010          NO,                           @D61GDAP 03343000
         CLI   ERQMSG1,RMSAE     IS THIS AN ALTERNATE ENTRY    @D61GDAP 03344000
         BNE   SVC03010          NO,                           @D61GDAP 03345000
         CLC   TIBPTR(4),ERQSEK1 RECORDING ACTIVE FOR OUR TASK @D61GDAP 03346000
         BNE   SVC03010          NO,                           @D61GDAP 03347000
         L     R5,ASRQTAB        RESOURCE DESCRIPTOR ADDRESS   @DY45AOM 03348000
         LA    R5,SRQSV3-SRQTAB(,R5) SVC-03 BOUND              @DY45AOM 03349000
         B     SVCX3ALL          YES,                          @D61GDAP 03350000
         DROP  R2                RELEASE ERBLOC BASE           @D61GDAP 03351000
SVC03010 BAL   RF,SVC03015       SET UP PUB LOOP POINTER       @D369DAP 03352000
         LA    R3,NEXTPUB        POINT TO NEXT PUB ENTRY       @D369DAP 03353000
SVC03015 CLI   PUBCHANN,X'FF'    END OF PUB TABLE REACHED      @D369DAP 03354000
         BER   R7                YES, =====================>>> @D369DAP 03355000
         LR    R2,R3             COPY PUB POINTER              @DA44364 03356000
         SH    R2,YPUBTAB        OFFSET OF PUB                 @DA44364 03357000
         SRL   R2,1              OFFSET OF PUBX ADDRESS        @DA44364 03358000
         A     R2,APBXAREA       ADDRESS OF PUBX ADDRESS       @DA44364 03359000
         L     R2,0(,R2)         ADDRESS OF PUBX ENTRY         @DA44364 03360000
         USING PBXADR,R2         PUBX BASE POINTER             @DA44364 03361000
         TM    PBXFLAG,PBXUR+PBXSLOG IS THIS A SHARABLE DEVICE @DA26180 03362000
         BZ    SVC03020          NO, CANNOT BE SPOOLED         @DA26180 03363000
         L     RE,PBXUSOFF       OFFSET OF USAGE FIELD         @DA26180 03364000
         L     R4,PCBPTR         ADDRESS OF PCB                @D52HDAP 03365000
         USING PCBADR,R4         PCB BASE POINTER              @D52HDAP 03366000
         A     RE,PCBCNT         ADDRESS OF USAGE FIELD        @DA26180 03367000
         DROP  R4                RELEASE PCB BASE              @D52HDAP 03368000
         USING DVCUSCNT,RE       DEVICE USAGE BASE POINTER     @DA26180 03369000
         TM    DVCLUFLG,DVCPWRSP POWER SPOOLED DEVICE          @DA26180 03370000
         BZ    SVC03020          NO,                           @DA26180 03371000
         CLC   DVCPWRTD,TID      REQUEST PENDING FOR THIS TASK @DA26180 03372000
         BNE   SVC03020          NO,                           @D51GDAP 03373000
         CLI   SVC03PRC,SVCISLTA LTA TO BE QUIESCED            @D51GDAP 03374000
         BNE   SVC03PWR          NO, THEN WE HAVE TO WAIT      @D51GDAP 03375000
         CLC   DVCPWRTD,LTID     DOES REQUESTOR OWN LTA        @D51GDAP 03376000
         BE    SVC03PWR          YES, WAIT UNTIL COMPLETE      @DA29183 03377000
         DROP  RE                RELEASE DEVICE USAGE BASE     @DA26180 03378000
SVC03020 DS    0H'0'             CHECK IF TLS IS ACTIVE        @D369DAP 03379000
         AIF   (NOT &VSE280).N280120                           @D68ADAP 03380000
         TM    PBXFLAG,PBXTAPE   IS THIS A TAPE DEVICE         @D68ADAP 03382000
         BZ    SVC03030          NO, DONT CARE                 @D68ADAP 03383000
         L     RE,PBXAOMMS       IS CONTROL INFORMATION PRESENT@D68ADAP 03384000
         N     RE,BIT0OFF        RESET ATTENTION PENDING       @D68ADAP 03385000
         BZ    SVC03030          NO, NO CONTROL BLOCK PRESENT  @D68ADAP 03386000
         L     RE,ASVC3A20       LOAD 31-BIT ADDRESS           @D68ADAP 03387000
         BASSM RE,RE             GET INTO 31-BIT MODE          @D68ADAP 03388000
ASVC3A20 DC    A(SVC03A20+X'80000000')                         @D68ADAP 03389000
SVC03A20 L     RE,PBXAOMMS       GET CHAIN BEGIN ADDRESS       @D68ADAP 03390000
SVC03B20 LTR   RE,RE             IS CONTROL BLOCK PRESENT      @D68ADAP 03391000
         BZ    SVC03D20          NO, WE ARE DONE               @D68ADAP 03392000
         USING AO$MAP,RE         PLF MAPPING                   @D68ADAP 03393000
         CLC   AO$TID,TID        ACTIVE FOR TERMINATING TASK   @D68ADAP 03394000
         BE    SVC03C20          YES, HAVE TO WAIT             @D68ADAP 03395000
         ICM   RE,15,AO$FORWD    GET NEXT CONTROL BLOCK ADDRESS@D68ADAP 03396000
         B     SVC03B20          CHECK IF ONE EXISTS           @D68ADAP 03397000
SVC03C20 DS    0H'0'                                           @D68ADAP 03398090
         LA    RE,0(,RF)         EXIT IS BACK TO LOOP          @D68PGA  03398180
         CLI   SVC03PRC,SVCISSVC WAS THIS THE QUIESCE SVC      @D68PGA  03398270
         BNE   SVC03E20          NO, SVC03 WILL DO THE WAIT    @D68PGA  03398360
         L     R5,ASRQTAB        RESOURCE DESCRIPTOR ADDRESS   @D68ADAP 03398450
         LA    R5,SRQSV3-SRQTAB(,R5) SVC-03 BOUND              @D68ADAP 03399000
         LA    RE,SVCX3SC3       WAIT CHAIN                    @D68ADAP 03400000
         B     SVC03E20          WAIT                          @D68ADAP 03401000
         DROP  RE                RELEASE PLF MAPPING BASE      @D68ADAP 03402000
SVC03D20 LA    RE,SVC03030       LOAD CONTINUATION ADDRESS     @D68ADAP 03403000
SVC03E20 BSM   0,RE              PROCEED IN 24-BIT MODE        @D68ADAP 03404000
.N280120 ANOP                                                  @D68ADAP 03405000
SVC03030 CLI   PUBCHQPT,NOTQUED  REQUEST QUEUED TO PUB         @D369DAP 03406000
         BER   RF                NO,  =======================> @D369DAP 03407000
         OC    PBXSIMAD(4),PBXSIMAD  IS SIMULATION ACTIVE      @D52HDAP 03408000
         BZ    SVC03035          NO,                           @D52HDAP 03409000
         CLI   SVC03PRC,SVCISEOT DO WE WANT TO WAIT            @D52HDAP 03410000
         BER   RF                NO,  =======================> @D52HDAP 03411000
SVC03035 SR    R5,R5             RESET REGISTER                @D369DAP 03412000
         IC    R5,PUBCHQPT       NUMBER OF CHAN.QUEUE ENTRY    @D369DAP 03413000
         AIF   (&AG1 LE 254).LOD0110                           @D51ODGL 03414000
         ICM   R5,2,PUBCHQPH     AND HIGH BYTE OF THIS INDEX   @D51ODGL 03415000
.LOD0110 ANOP                                                  @D51ODGL 03416000
         BAL   RE,SVC03050       SET CHANQ-CHAIN LOOP POINTER  @D369DAP 03417000
         USING CHQADR,R4         CHANNEL QUEUE BASE POINTER    @D369DAP 03418000
SVC03040 CLI   CHQCHNLO,NOTQUED  IS THIS THE LAST CHAIN ENTRY  @D51ODGL 03419000
         BER   RF                YES, POINT TO NEXT PUB        @D369DAP 03420000
         SR    R5,R5             RESET REGISTER                @D369DAP 03421000
         IC    R5,CHQCHNLO       INSERT NUMBER OF NEXT ENTRY   @D51ODGL 03422000
         AIF   (&AG1 LE 254).LOD0120                           @D51ODGL 03423000
         ICM   R5,2,CHQCHNHI     INSERT HIGH PART OF IT        @D51ODGL 03424000
.LOD0120 ANOP                                                  @D51ODGL 03425000
SVC03050 SLL   R5,CHQSLEN        OFFSET IN CHANQ TABLE         @D369DAP 03426000
         A     R5,ACHANQ         ADDRESS OF CHANQ ENTRY        @DA44364 03427000
         ICM   R5,8,H0           CLEAR HIGH ORDER BYTE         @D68REEF 03428000
         LA    R4,0(,R5)         PROVIDE CHANQ ADDRESS         @DA44364 03429000
         SLR   R0,R0             CLEAR REGISTER                @D66ADAP 03430000
         ICM   R0,3,CHQTID       GET TASK ID (2 BYTES FOR NOW) @D66ADAP 03431000
         L     R5,ASRQTAB        RESOURCE DESCRIPTOR ADDRESS   @D61MPAP 03435000
         LA    R5,SRQWAIT-SRQTAB(,R5) I/O WAIT QUEUE           @D61MPAP 03436000
         CH    R0,TID            REQUEST ISSUED BY CURR.TASK   @D66ADAP 03437000
         BE    SVC03060          YES, GOTO QUIESCE             @D14BDAP 03438000
         CH    R0,IORQ4AR        IS IT A SYSTEM TASK REQUEST   @D66ADAP 03439000
         BNLR  RE                NO, CHECK NEXT CHANQ ENTRY    @D369DAP 03440000
.*       TEST IF SYSTEM TASK IS ACTIVE FOR TERMINATING TASK    @D369DAP 03441000
         L     R5,ASRQTAB         RESOURCE DESCRIPTOR ADDRESS  @D61MPAP 03442000
         LA    R5,SRQSV3-SRQTAB(,R5) SVC-03 BOUND              @D61MPAP 03443000
         LR    R1,R0             COPY TASK ID                  @D66ADAP 03444000
         SLL   R1,2              MULTIPLY WITH FOUR            @D66ADAP 03445000
         A     R1,ATIBATAB       ADDRESS OF TIB ADDRESS        @D66ADAP 03446000
         L     R1,0(,R1)         SYSTEM TASKS TIB ADDRESS      @D66ADAP 03447000
         CLC   TID,TIBRTID-TIBADR(R1) ACTIVE FOR USER          @D66ADAP 03448000
         BNER  RE                NO, CHECK NEXT CHANQ ENTRY    @D369DAP 03449000
         CLC   TIBRTID-TIBADR(,R1),IORQ4AR ACTIVE FOR ATTENT.  @D66ADAP 03450000
         BNE   SVC03060          NO, NOT THIS TIME             @DA44841 03451000
         CH    R0,IORQ4SVT       IS THIS THE SERVICE TASK      $D66ADAP 03452000
         BER   RE                YES, NO NEED TO WAIT          @DA44841 03453000
SVC03060 L     R1,CHQCCBAD       LOAD CCB POINTER              @D14BDAP 03454000
         ICM   R1,8,H0           RESET CHAIN BYTE              @D68REEF 03455000
         LTR   R1,R1             HAS TASK ALREADY BEEN POSTED  @D369DAP 03456000
         BZ    SVC03065          YES,                          @DA40222 03457000
         CLI   SVC03PRC,SVCISLTA IS LTA TO BE QUIESCED         @D51GDAP 03458000
         BNE   SVC03070          NO,                           @D51GDAP 03459000
         CLI   CHQCAWKY,ZERO     COULD THIS BE AN LTA REQUEST  @D36BDAP 03460000
         BNER  RE                NO, CHECK NEXT CHANQ ENTRY    @D369DAP 03461000
         B     SVCX3LTA          PROVIDE FOR WAIT              @D51GDAP 03462000
SVC03065 CLC   CHQTID,IORQ4AR    SYSTEM TASK REQUEST           @DA42992 03463000
         BNHR  RE                YES, CHECK NEXT CHANQ ENTRY   @DA42992 03464000
         LA    R5,ARTID          AR TASK-ID                    @D66CDAP 03465000
         STH   R5,CHQTID         AR IS NOW REQUEST OWNER       @D66CDAP 03467000
         BR    RE                     CHECK NEXT CHANQ ENTRY   @DA40222 03472000
         AIF   (NOT &VSE410).N410100                                    03472200
SVC03070 TM    CHQCCBB3,APPEN    IS THIS SUBSYTEM REQUEST      @D41ADAP 03472400
         AGO   .Y410100                                                 03472600
.N410100 ANOP                                                           03472800
SVC03070 TM    CHQCCBB3,APPEN+OLTP IS THIS SUBSYTEM REQUEST    @D51GDAP 03473000
.Y410100 ANOP                                                           03473500
         BZ    SVCX3ALL          NO,                           @D51GDAP 03474000
         CLI   SVC03PRC,SVCISEOT IS THIS EOT REQUEST           @DA39966 03475000
         BER   RE                YES, CHECK NEXT CHANQ ENTRY   @DA39966 03476000
         TM    CHQCCSIO,CHQCCACT IS SIO IN PROGRESS            @D51GDAP 03477000
         BO    SVCX3ALL          YES, HAVE TO WAIT             @D51GDAP 03478000
         LR    RE,R4             COPY CHANQ ENTRY ADDRESS      @D51GDAP 03479000
         L     RF,ACHANQ         GET CHANQ ADDRESS             @DA44364 03480000
         ICM   RF,8,H0           CLEAR HIGH ORDER BYTE         @D68REEF 03481000
         SLR   RE,RF             CHANQ ENTRY OFFSET            @DA44364 03482000
         SRL   RE,CHQSLEN        OUR ENTRY INDEX               @D51GDAP 03483000
         SR    RF,RF             CLEAR FOR INSERT              @D51ODGL 03484000
         IC    RF,CHQCHNLO       NEXT IN CHAIN POINTER         @D51ODGL 03485000
         AIF   (&AG1 LE 254).LOD0210                           @D51ODGL 03486000
         ICM   RF,2,CHQCHNHI     LOW AND HIGH ORDER BYTE       @D51ODGL 03487000
.LOD0210 ANOP                                                  @D51ODGL 03488000
         CLM   RE,1,PUBCHQPT     IS OUR REQUEST FIRST          @D51GDAP 03489000
         BNE   SVC03090          NO,                           @D51GDAP 03490000
         AIF   (&AG1 LE 254).LOD0130                           @D51ODGL 03491000
         CLM   RE,2,PUBCHQPH     IS IT REALLY FIRST            @D51ODGL 03492000
         BNE   SVC03090          NO,                           @D51ODGL 03493000
.LOD0130 ANOP                                                  @D51ODGL 03494000
         STC   RF,PUBCHQPT       QUEUE NEXT REQUEST TO PUB     @D51GDAP 03495000
         AIF   (&AG1 LE 254).LOD0140                           @D51ODGL 03496000
         STCM  RF,2,PUBCHQPH     INCLUDING HIGH ORDER BYTE     @D51ODGL 03497000
.LOD0140 ANOP                                                  @D51ODGL 03498000
         NI    PUBCSFLG,XFF-DEVBSY-QEDERR FREE THE DEVICE      @D51GDAP 03499000
SVC03080 DS    0H                                              @D51ODGL 03500000
         AIF   (&AG1 LE 254).LOD0150                           @D51ODGL 03501000
         MVC   CHQCHNLO(1),CHQFLPTR+1  PLACE IT IN FREE CHAIN  @D51ODGL 03502000
         MVC   CHQCHNHI(1),CHQFLPTR                            @D51ODGL 03503000
.LOD0150 AIF   (&AG1 GT 254).LOD0151                           @D51ODGL 03504000
         MVC   CHQCHAIN(1),FLPTR PLACE IT IN FREE CHAIN        @D51ODGL 03505000
         STC   RE,FLPTR          UPDATE OLD FREELIST POINTER   @D51ODGL 03506000
.LOD0151 ANOP                                                  @D51ODGL 03507000
         STH   RE,CHQFLPTR       OLD ENTRY NOW FIRST FREE      @D51ODGL 03508000
         ICM   R5,15,CQEINUSE    CHANQ ENTIRES IN USE COUNTER  @D61NDAP 03509000
         BZ    SVC03LOP          IS 0                          @D61NDAP 03510000
         BCTR  R5,0              SUBTRACT 1                    @D61NDAP 03511000
         ST    R5,CQEINUSE       STORE NEW VALUE               @D61NDAP 03512000
         B     SVC03LOP          RESUME PROCESS                @D51GDAP 03513000
SVC03090 SLR   R5,R5             CLEAR R5                      @D51GDAP 03514000
         IC    R5,PUBCHQPT       GET FIRST ENTRY ADDRESS       @D51GDAP 03515000
         AIF   (&AG1 LE 254).LOD0160                           @D51ODGL 03516000
         ICM   R5,2,PUBCHQPH     INCLUDING HIGH BYTE           @D51ODGL 03517000
.LOD0160 ANOP                                                  @D51ODGL 03518000
SVC030A0 SLL   R5,CHQSLEN        MULTIPLY WITH ENTRY LENGTH    @D51GDAP 03519000
         A     R5,ACHANQ         CHANQ ENTRY ADDRESS           @D51GDAP 03520000
         ICM   R5,8,H0           CLEAR HIGH ORDER BYTE         @D68REEF 03521000
         CLM   RE,1,CHQCHNLO-CHQADR(R5) POINTING TO OUR ENTRY  @D51ODGL 03522000
         AIF   (&AG1 LE 254).LOD0170                           @D51ODGL 03523000
         BNE   SVC030A2          NO..                          @D51ODGL 03524000
         CLM   RE,2,CHQCHNHI-CHQADR(R5) REALLY TO OUR ENTRY?   @D51ODGL 03525000
.LOD0170 ANOP                                                  @D51ODGL 03526000
         BE    SVC030B0          YES,                          @D51GDAP 03527000
SVC030A2 DS    0H                                              @D51ODGL 03528000
         SLR   R5,R5             CLEAR REGISTER                @D51GDAP 03529000
         IC    R5,CHQCHNLO-CHQADR(R5) GET NEXT ENTRY INDEX     @D51ODGL 03530000
         AIF   (&AG1 LE 254).LOD0180                           @D51ODGL 03531000
         ICM   R5,2,CHQCHNHI-CHQADR(R5) INCLUDING HIGH BYTE    @D51ODGL 03532000
.LOD0180 ANOP                                                  @D51ODGL 03533000
         B     SVC030A0                                        @D51GDAP 03534000
SVC030B0 STC   RF,CHQCHNLO-CHQADR(R5) POINT NEXT TO PREVIOUS   @D51ODGL 03535000
         AIF   (&AG1 LE 254).LOD0190                           @D51ODGL 03536000
         STCM  RF,2,CHQCHNHI-CHQADR(R5) INCLUDING HIGH BYTE    @D51ODGL 03537000
.LOD0190 ANOP                                                  @D51ODGL 03538000
         B     SVC03080                                        @D51GDAP 03539000
         SPACE 1                                               @D51GDAP 03540000
SVCX3ALL CLI   SVC03PRC,SVCISEOT IS THIS END OF TASK REQUEST   @D51GDAP 03541000
         BL    SVCX3SC3          THIS IS AN SVC03 REQUEST      @D51GDAP 03542000
         BE    SVCX3EOT          THIS WAS AN EOT REQUEST       @D51GDAP 03543000
SVCX3LTA BAL   RF,UNPOST         WAIT UNTIL LTA REQUEST COMPL. @D51GDAP 03544000
*SGLINK  UNPOST,INPUT=(R5,R6,RF),WORK=(R5,RE)                  @D51GDAP 03545000
         BR    R6                     =====================>>> @D35DDEP 03546000
         DROP  R2                RELEASE PUBX BASE POINTER     @DA44364 03547000
SVCX3EOT LH    R2,SVC03PRC       SAVE PROCESSING FLAGS         @D51GDAP 03548000
         LR    RF,RC             SAVE BASE REGISTER            @D51GDAP 03549000
         BAL   RC,RWAIT          SAVE STATUS AND WAIT FOR I/O  @D36BDAP 03550000
*SGLINK  RWAIT,INPUT=(R5,RC)                                   @DA30431 03551000
         LR    RC,RF             RESTORE BASE REGISTER         @D51GDAP 03552000
         STH   R2,SVC03PRC       SET  PROCESSING FLAGS         @D51GDAP 03553000
         B     SVC03LOP          CONTINUE PROCESS              @D51GDAP 03554000
         DROP  R4                RELEASE CHANQ BASE POINTER    @D14BDAP 03555000
SVCX3SC3 L     RB,TCBSAVE        ADDRESS OF SAVE AREA          @D36IDAP 03556000
         USING SVEARA,RB         SAVE AREA BASE POINTER        @D369DAP 03557000
         ST    R3,SVER00         SAVE IT FOR NEXT TIME         @D51GDAP 03558000
         B     RESVCX                 =====================>>> @D51GDAP 03559000
*SGLINK  RESVCX INPUT=(R5,R6),WORK=(R8,RF)                     @D66ADAP 03560000
         DROP  RB                RELEASE SAVE AREA POINTER     @D369DAP 03561000
SVC03PRC DC    XL2'00'           PROCESSING FLAG               @D51GDAP 03562000
SVCISSVC EQU   X'00'             SVC 03 REQUEST                @D51GDAP 03563000
SVCISEOT EQU   X'01'             QUIESCE EOJ REQUEST           @D51GDAP 03564000
SVCISLTA EQU   X'02'             QUIESCE LTA REQUEST           @D51GDAP 03565000
         SPACE 3                                               @D14BDAP 03566000
         USING PBXADR,R2         PUBX BASE POINTER             @DA44364 03567000
SVC03PWR LR    R5,RF             SAVE OUTER LOOP LINK REGISTER @DA35866 03568000
         LR    R4,R9             SAVE R9 CONTENTS              @D51GDAP 03569000
         ICM   R1,8,H3+1         INDICATE QUIESCE              @DA29183 03570000
         BAL   RE,SVC0PW20       EXECUTE POWER INTERCEPT       @D51GDAP 03571000
         LR    R9,R4             RESTORE R9 CONTENTS           @D51GDAP 03572000
         L     R8,SVCSV3+60      RELOAD TIB BASE POINTER       @D51GDAP 03573000
         AIF   (NOT &BGDEBUG).NMC0X0                           @D14BDAP 03574000
         TM    IJBFLG08,IJBDEBUG IS DEBUG ACTIVE               @DAOM065 03574300
         BZ    SVC03P10          NO,                           @DAOM065 03574600
         CH    RF,H12            IS RETURN CODE CORRECT        @D14BDAP 03575000
         BNH   SVC03P10          YES,                          @D14BDAP 03576000
         MVI   IJBHWORG,HWORG108 HARD WAIT ID (POWER SVC3)     @D31QDAP 03577000
         BAL   R5,SYSERROR       FORCE HARD WAIT (RF=INVALID)  @D14BDAP 03578000
.NMC0X0  ANOP                                                  @D14BDAP 03579000
SVC03P10 DS    0H'0'                                           @D14BDAP 03580000
         B     SVC03P20(RF)       TAKE SPECIFIED RETURN        @D14BDAP 03581000
SVC03P20 B     SVC03P40           0     TASK HAS TO WAIT       @DA35866 03582000
         B     SVC03P30           4     PROCEED NORMAL         @DA35866 03583000
         MVI   IJBHWORG,HWORG108  8     SET HARD WAIT CODE     @D31QDAP 03584000
         MVI   IJBHWORG,HWORG108 12     SET HARD WAIT CODE     @D31QDAP 03585000
         BAL   R5,SYSERROR              UNEXPECTED RETURN CODE @DA35866 03586000
SVC03P30 LR    RF,R5              RESTORE LINK REGISTER        @DA35866 03587000
         B     SVC03020                ======================> @DA35866 03588000
SVC03P40 L     R5,ASRQTAB         RESOURCE DESCRIPTOR ADDRESS  @D61MPAP 03589000
         LA    R5,SRQWAIT-SRQTAB(,R5) I/O WAIT QUEUE           @D61MPAP 03590000
         B     SVCX3ALL                ======================> @DA35866 03591000
         DROP  R2                RELEASE PUBX BASE POINTER     @DA44364 03592000
         AGO   .SKIP050                                        @D51GDAP 03593000
         TITLE 'VSE SUPERVISOR     SGIOS     TEST FOR ERP RECORDING   ' 03594000
*********************************************************************** 03595000
*                                                                     * 03596000
*        WAIT FOR COMPLETION OF RECORDING                             * 03597000
*                                                                     * 03598000
*********************************************************************** 03599000
         SPACE 3                                                        03600000
SVC03W44 L     RF,AERBLOC        ADDRESS OF ERROR BLOCK        @D51GDAP 03601000
         USING ERBLOC,RF         ERROR BLOCK BASE POINTER      @D51GDAP 03602000
         L     R2,ERPERCHN       ADDRESS OF WAIT CHAIN         @D51GDAP 03603000
         CLI   ERQMSG1,RMSAE     IS THIS AN ALTERNATE ENTRY    @D51GDAP 03604000
         BNE   SVC03010          NO,                           @D51GDAP 03605000
         CLC   TIBPTR(4),ERQSEK1 RECORDING ACTIVE FOR OUR TASK @D51GDAP 03606000
         BE    SVCX3ALL          YES, =======================> @D51GDAP 03607000
         B     SVC03010          NO,                           @D51GDAP 03608000
         DROP  RF                RELEASE ERBLOC BASE           @D51GDAP 03609000
         BNE   SVC03W10          NO, CHECK WAIT CHAIN          @D51GDAP 03610000
         CLC   TIBPTR(4),ERQSEK1 RECORDING ACTIVE FOR OUR TASK @D51GDAP 03611000
         BE    SVCX3ALL          YES, =======================> @D51GDAP 03612000
         DROP  RF                RELEASE ERBLOC BASE           @D51GDAP 03613000
         USING ERBLKADR,R2       ERROR ENTRY BASE              @DA26063 03614000
SVC03W10 BAL   RF,SVC03W20       INITIALIZE LINK REGISTER      @DA26063 03615000
         L     R2,ERBLKPTR       GET NEXT ENTRY ADDRESS        @DA26063 03616000
SVC03W20 LTR   R2,R2             EMPTY OR END OF CHAIN         @DA26063 03617000
         BZ    SVC03010          YES, =======================> @DA26063 03618000
         CLI   ERQAEMSG,RMSAE    IS THIS AN ALTERNATE ENTRY    @DA26063 03619000
         BNER  RF                NO, CHECK NEXT WAITER         @DA26063 03620000
         CLC   TIBPTR(4),ERQAETIB IS THIS ENTRY FOR OUR TASK   @DA26063 03621000
         BNER  RF                NO, CHECK NEXT ENTRY          @DA26063 03622000
         B     SVCX3ALL               =======================> @DA26063 03623000
         DROP  R2                RELEASE ERROR BLOCK BASE      @DA26063 03624000
.SKIP050 ANOP                                                  @D51GDAP 03625000
         TITLE 'VSE SUPERVISOR     SGIOS     FORCE DEQUEUE ROUTINE    ' 03626000
*********************************************************************** 03627000
*                                                                     * 03628000
*        DEQUEUE CHANNEL QUEUE ENTRY                                  * 03629000
*                                                                     * 03630000
*********************************************************************** 03631000
         SPACE 3                                               @D369DAP 03632000
SVC03FD  DS    0H'0'                                           @D37ADAP 03633000
         LH    R3,YPUBTAB        BEGIN OF PUB TABLE            @D37ADAP 03634000
         USING PUBTAB,R3         PUB TABLE BASE POINTER        @D37ADAP 03635000
         CR    R0,R3             DID USER PASS A PUB ADDRESS   @D37ADAP 03636000
         BL    ERR21             NO,  =====================>>> @D37ADAP 03637000
         LA    R3,&AG1           NUMBER OF PUB ENTRIES         @D51ODGL 03638000
         SLL   R3,PUBSLEN        MULTIPLY WIRH ENTRY LENGTH    @D51ODGL 03639000
         AH    R3,YPUBTAB        PUB ADDRESS                   @D51ODGL 03640000
         DROP  R3                RELEASE PUBTAB BASE POINTER   @D37ADAP 03641000
         CR    R0,R3             IS ADDRESS WITHIN TABLE       @D37ADAP 03642000
         BNL   ERR21             NO,  =====================>>> @D37ADAP 03643000
         LR    R3,R0             COPY PUB ADDRESS              @D37ADAP 03644000
         USING PUBADR,R3         PUB BASE POINTER              @D37ADAP 03645000
         XC    CSW(8),CSW        CLEAR CSW IN LOW CORE         @DY46037 03646000
         CLI   PUBCHQPT,NOTQUED  IS REQUEST QUEUED             @DSCSI   03647000
         BNE   SVC03F05          YES, CHECK IF CONSOLE         @DSCSI   03648000
         MVI   DEVSTA,ATTENT     SIMULATE ATTENTION            @DY46037 03649000
         B     SVC03F20          JOIN MAIN PATH                @DSCSI   03650000
SVC03F05 CLC   PUBCHANN(2),SYSOCDEV IS THIS THE SYSTEM CONSOLE @DSCSI   03651000
         BER   R6                YES, =====================>>> @DSCSI   03652000
         AIF   (NOT &VSE280).N280140                           @DSCSI   03653000
         CLI   PUBDEVTY,TQDIO    IS THIS QDIO DEVICE           @DSCSI   03654000
         BNE   SVC03F10          NO,                           @DSCSI   03655000
         CLI   PUBOPTN,PUBOPFCP  IS THIS THE FCP ADAPTER       @DSCSI   03656000
         BNE   SVC03F10          NO, PROCEED MAIN LINE         @DSCSI   03657000
         MVI   CHNSTA,PCI        SIMULATE ATTENTION            @DSCSI   03658000
         B     SVC03F20          YES, LET IT GO                @DSCSI   03659000
.N280140 ANOP                                                           03660000
SVC03F10 TM    PUBCSFLG,OPINTV   IS INTERVENTION REQUIRED      @D36CDAP 03661000
         BZ    ERR21             NO,  =====================>>> @D36CDAP 03662000
         NI    PUBCSFLG,XFF-OPINTV-DEVBSY-PUBLOBSY RESET BITS  @D36CDAP 03663000
         BAL   R7,CQDSP          SET UP I/O POINTERS           @D36CDAP 03664000
*SGLINK  CQDSP,INPUT=(R3,R6,R7),OUTPUT=(R1,R4,RA),WORK=R0      @D36CDAP 03665000
         USING CHQADR,R4         CHANQ BASE POINTER            @D37BDAP 03666000
         USING PIBADR,RA         PIB BASE POINTER              @D37BDAP 03667000
         USING CCBADR,R1         CCB BASE POINTER              @D37BDAP 03668000
         MVI   CHQCCSIO,CHQCCACT+CHQCCRUN          SIMULATION  @D37DDAP 03669000
         MVI   CHQCSW+4,UNITEXCP+CHANEND+DEVEND    X'0D00'     @D36CDAP 03670000
         L     R7,CCBCCW         ADDRESS OF CCW                @D36CDAP 03671000
         LA    R7,8(R7)          POINT BEHIND 1ST CCW          @D36CDAP 03672000
         STCM  R7,7,CHQCSW+1     AND SAVE IT IN CHANQ          @D36CDAP 03673000
         MVC   CSW(8),CHQCSW     SET UP CSW IN LOW CORE        @D36CDAP 03674000
SVC03F20 MVC   CHNADR(2),PUBCHANN SET UP CUU IN LOW CORE       @D36CDAP 03675000
         ST    R3,INTPARM        SAVE INTERRUPT PARAMETER      @D28ADAP 03676000
         L     R9,AINTER         ADDRESS OF IOINTER            @D36CDAP 03677000
         BR    R9                     ======================>> @D36CDAP 03678000
         DROP  R1                RELEASE CCB BASE POINTER      @D36CDAP 03679000
         DROP  R3                RELEASE PUB BASE POINTER      @D37BDAP 03680000
         DROP  RA                RELEASE PIB BASE POINTER      @D36CDAP 03681000
         DROP  R4                RELEASE CHANQ BASE POINTER    @D36CDAP 03682000
         TITLE 'VSE SUPERVISOR     SGIOS     INITIATE AOM PROCESSING  ' 03683000
*********************************************************************** 03684000
*                                                                     * 03685000
*        ACTIVATE SGSER TO GET AOM PROCESSING INITIATED               * 03686000
*                                                                     * 03687000
*********************************************************************** 03688000
         SPACE 1                                               @D62TAAP 03689000
         USING TCBADR,RA         TCB BASE POINTER              @D25IDAP 03690000
         USING TIBADR,R8         TIB BASE POINTER              @D25IDAP 03691000
SVC03RAS CLC   TID,IORQ4RAS      IS RAS REQUESTING THE SERVICE @D66ADAP 03692000
         BNE   ERR21             NO,  =====================>>> @D62TAAP 03693000
         LTR   R3,R0             GET PUB ADDRESS               @D62TAAP 03694000
         BZ    ERR21                  =====================>>> @D62TAAP 03695000
         USING PUBTAB,R3         PUB TABLE BASE POINTER        @D62TAAP 03696000
         LR    R2,R0             COPY PUB POINTER              @D62TAAP 03697000
         SH    R2,YPUBTAB        OFFSET IN PUB TABLE           @D62TAAP 03698000
         SRL   R2,PUBSLEN-PBXISLEN OFFSET IN PUBX ADDRESS TABLE@D62TAAP 03699000
         A     R2,APBXAREA       ADDRESS OF PUBX ADDRESS       @D62TAAP 03700000
         L     R2,0(,R2)         ADDRESS OF PUBX ENTRY         @D62TAAP 03701000
         USING PBXADR,R2         PUBX     BASE POINTER         @D62TAAP 03702000
         CLI   PBXRCDCC,XFF      DOES DEVICE SUPPORT RCD       @D62TAAP 03703000
         BE    SVC03RDP          NO, JUST SIMULATE "READY"     @D62TAAP 03704000
         TM    PBXFLAG,PBXDASD+PBXTAPE IS THIS DASD OR TAPE    @D62TAAP 03705000
         BZ    SVC03RDP          NO,                           @D62TAAP 03706000
         MVC   PBXATTNR(1),PBXPAM PROCESS ALL PATHES           @D62TAAP 03707000
         AIF   (NOT &VSE270).N270040                           @DAOM    03708000
         L     RD,SVC3AAOM       AOM-ACTIVATION ROUTINE BASE   @DAOM    03709000
         BASSM RE,RD             ACTIVATE AOM TASK             @DAOM    03710000
*SGLINK  AOMACTIV INPUT=(R2,R3,R6,RD,RE)                       @DAOM    03711000
         BR    R6                     =====================>>> @DAOM    03712000
SVC3AAOM DC    A(AOMACTIV+X'80000000')                         @DAOM    03713000
         AGO   .Y270040                                        @DAOM    03714000
.N270040 ANOP                                                  @DAOM    03715000
         LR    R9,RC             SAVE SVC-03 BASE              @D62TAAP 03716000
         L     RC,BASESERI       GET SGSERI BASE ADDRESS       @D62TAAP 03717000
         USING SGSERI,RC         SGSERI BASE POINTER           @D62TAAP 03718000
         BAL   RE,SERADDQR       ACTIVATE AOM PROCESSING       @D62TAAP 03719000
*SGLINK  SERADD,INPUT=(R3,R6,RC,RE),WORK=(R7,R8,RF)            @D62TAAP 03720000
         DROP  R8                RELEASE TIB BASE              @D25IDAP 03721000
         LR    RC,R9             RESTORE SVC-03 BASE ADDRESS   @D62TAAP 03722000
         USING SVC03,RC          SVC-03 BASE POINTER           @D62TAAP 03723000
         B     SVC03RDP          SIMULATE READY                @D62TAAP 03724000
.Y270040 ANOP                                                           03725000
         DROP  R3                RELEASE PUB    BASE POINTER   @D62TDAP 03726000
         DROP  R2                RELEASE PUBX   BASE POINTER   @D62TDAP 03727000
         DROP  RA                RELEASE TCB BASE              @D25IDAP 03728000
         EJECT                                                 @D62TAAP 03729000
         TITLE 'VSE SUPERVISOR     SGIOS     INITIATE AOM PROCESSING  ' 03730000
*********************************************************************** 03731000
*                                                                     * 03732000
*        ACTIVATE SGSER TO GET SNAP/FLASH PROCESSING INITIATED        * 03733000
*                                                                     * 03734000
*********************************************************************** 03735000
         SPACE 3                                               @D25IDAP 03736000
         USING TCBADR,RA         TCB BASE POINTER              @D25IDAP 03737000
         USING TIBADR,R8         TIB BASE POINTER              @D25IDAP 03738000
SVC03CPY DC    0H'0'             INITIALYZE SNAP/FLASH PROCESS.@D25IDAP 03739000
         LR    R1,R0             COPY PARAMETER ADDRESS        @D25IDAP 03740000
         USING SNPLIST,R1        SNPLIST BASE POINTER          @D25IDAP 03741000
         OC    SNPCOUNT(SNPUPARM-SNPCOUNT),SNPCOUNT VALIDATE   @D66ADAP 03742000
SVC3PCK1 EQU   *                                               @D25IDAP 03743000
         LH    R2,SNPCOUNT       NUMBER OF PARM ENTRIES        @D25IDAP 03744000
         SLL   R2,3              MULTIPLY WITH ENTRY LENGTH    @D25IDAP 03745000
         CLI   SNPLEVEL,SNPLEV#1 IS THIS LEVEL-1 PARM-LIST     @D66ADAP 03746000
         BL    SVC3CP10          NO, ITS LEVEL-0               @D66ADAP 03747000
         BH    ERR21                  =====================>>> @D66ADAP 03748000
         SLL   R2,1              DOUBLE THE PARM LEVEL-0 LENGTH@D66ADAP 03749000
SVC3CP10 LA    R2,SNPHDRLN(,R2)  ADD HEADER LENGTH             @D66ADAP 03750000
         BCTR  R2,0              LAST BYTE OFFSET              @D25IDAP 03751000
         LA    R2,0(R1,R2)       LAST BYTE ADDRESS             @D25IDAP 03752000
         DROP  R8                RELEASE TIB BASE              @D25IDAP 03753000
         BAL   R8,VALIDSVA       VALIDATE PARAMETER =======>>> @D25IDAP 03754000
*SGLINK  VALIDSVA,INPUT=(R1,R2,R6,R8),WORK=(R2,R5)             @D25IDAP 03755000
         LR    R9,RC             SAVE SVC-03 BASE              @D25IDAP 03756000
         L     RC,BASESERI       GET SGSERI BASE ADDRESS       @D25IDAP 03757000
         USING SGSERI,RC         SGSERI BASE POINTER           @D25IDAP 03758000
         BAL   RE,SERIXCPY       BUILD FLASHCOPY REQUEST ENTRY @D25IDAP 03759000
*SGLINK  SERIXCPY,INPUT=(R1,R6,RC,RE),WORK=(R0,R2,R3,R4,R5,R7,R8,RF)    03760000
         LR    RC,R9             RESTORE SVC-03 BASE ADDRESS   @D25IDAP 03761000
         USING SVC03,RC          SVC-03 BASE POINTER           @D25IDAP 03762000
         BR    R6                     =====================>>> @D25IDAP 03763000
         DROP  R1                RELEASE SNPLIST BASE          @D52IDAP 03764000
         DROP  RA                RELEASE TCB BASE              @D52IDAP 03765000
         SPACE 3                                                        03766000
SNPLIST  DSECT                                                 @D25IDAP 03767000
SNPID    DS    CL4                EYE-CATCHER                  @D25IDAP 03768000
SNPCOUNT DS    H                  NUMBER OF LIST ENTRIES       @D25IDAP 03769000
SNPFLAG  DS    XL1                PARAMETER FLAG BYTE          @D25IDAP 03770000
SNPPRMT  EQU   X'80'              USER REQUESTED PROMPT        @D25IDAP 03771000
SNPRVOL1 EQU   X'40'              RESTORE ALL GIVEN VOLIDS     @D66ADAP 03772000
*        EQU   X'20'              RESERVED                     @D25IDAP 03773000
*        EQU   X'10'              RESERVED                     @D25IDAP 03774000
*        EQU   X'08'              RESERVED                     @D25IDAP 03775000
*        EQU   X'04'              RESERVED                     @D25IDAP 03776000
*        EQU   X'02'              RESERVED                     @D25IDAP 03777000
*        EQU   X'01'              RESERVED                     @D25IDAP 03778000
SNPLEVEL DS    XL1                PARAMETER LIST LEVEL         @D66ADAP 03779000
SNPLEV#1 EQU   1                  LEVEL-1 PARAMETER LIST       @D66ADAP 03780000
SNPHDRLN EQU   *-SNPID            LENGTH OF HEADER BLOCK       @D66ADAP 03781000
         SPACE 1                                                        03782000
SNPVFLAG DS    XL1                VOLUME FLAG                  @D25IDAP 03783000
SNPSVIND EQU   X'80'              DEVICE IS A SOURCE VOLUME    @D25IDAP 03784000
SNPTVIND EQU   X'40'              DEVCIE IS A TARGET VOLUME    @D25IDAP 03785000
*        EQU   X'20'              RESERVED                     @D25IDAP 03786000
*        EQU   X'10'              RESERVED                     @D25IDAP 03787000
SNPVOLDN EQU   X'08'              VOLUME MUST BE DVCDN         @D66ADAP 03788000
SNPNEWV1 EQU   X'04'              REPLACE VOL1 LABEL           @D66ADAP 03789000
*BIT 6-7 VOLUME IDENTIFICATION CODE                            @D66ADAP 03790000
SNPCUUID EQU   X'02'              CUU ADDRESS GIVEN            @D66ADAP 03791000
SNPLNOID EQU   X'01'              LOGICAL UNIT GIVEN           @D66ADAP 03792000
SNPNOVOL EQU   X'03'              BOTH BITS OFF VOLID GIVEN    @D66ADAP 03793000
         DS    XL1                RESERVED                     @D25IDAP 03794000
SNPVOLID DS    CL6                DEVICE IDENTIFICATION FIELD  @D25IDAP 03795000
SNPENTLN EQU   *-SNPVFLAG                                               03796000
*        VERSION-1 EXTENTION                                   @D66ADAP 03797000
         ORG   *-6                                             @D66ADAP 03798000
SNPDEVID DS    XL2                DEVICE IDENTIFIER            @D66ADAP 03799000
SNPUPUBA DS    XL4                RELATED PUB ADDRESS          @D66ADAP 03800000
SNPUPARM DS    XL8                USER SUPPLIED PARAMETER      @D66ADAP 03801000
&SYSECT  CSECT                                                 @D25IDAP 03802000
         EJECT ,                                               @D25IDAP 03803000
*********************************************************************** 03804000
*                                                                     * 03805000
*        INDUCE READY INTERRUPT   (DEVICE END)                        * 03806000
*                                                                     * 03807000
*********************************************************************** 03808000
         SPACE 3                                               @D369DAP 03809000
         USING TCBADR,RA         TCB BASE POINTER              @D21ODAP 03810000
         USING TIBADR,R8         TIB BASE POINTER              @D62TAAP 03811000
SVC03ATN LA    R7,SVC03MAX       1ST INVALID FUNCTION CODE     @DY46037 03812000
         CLR   R1,R7             IS FUNCTION CODE VALID        @DY46037 03813000
         BNL   ERR21             NO,  =====================>>> @DY46037 03814000
         LR    R3,R0             COPY PUB POINTER              @D21ODAP 03815000
         USING PUBADR,R3         PUB BASE POINTER              @D37ADAP 03816000
         LR    R7,R1             COPY FUNCTION CODE            @D21ODAP 03817000
         SLL   R7,2              MULTIPLY WITH FOUR            @D21ODAP 03818000
         L     R7,SVC03VEC(R7)   GET ROUTINE ADDRESS           @DAOM063 03819000
         BASSM R7,R7             EXECUTE ROUTINE IN PROPER MODE@D66ADAP 03820000
         DC    0F'0'                                                    03821000
SVC03VEC DC    A(SVC03FD)      0 SIMULATE ATTENTION OR PCI     @DAOM063 03822000
         DC    A(SVC03DS+X'80000000') 0 ESTABLISH VIRT.DEV.    @DAOM063 03823000
         DC    A(SVC03DT)      2 TERMINATE VIRT.DEV.           @DAOM063 03824000
         DC    A(SVC03RDP)     3 READY DEVICE                  @DAOM063 03825000
         DC    A(ERR19)        4 CANCEL CUU                    @DAOM063 03826000
         DC    A(SVC03RCH)     5 READY ALL DEVICES ON CHANNEL  @DAOM063 03827000
SVC03MAX EQU   (*-SVC03VEC)/4    FIRST INVALID FUNCTION CODE   @DY46037 03828000
         DROP  R3                RELEASE PUB BASE POINTER      @D21ODAP 03829000
         SPACE 3                                                        03830000
SVC03RCH DS    0H'0'             SIMULATE INTERRUPT            @D37ADAP 03831000
         LTR   R3,R0             ENTERED AFTER RESVC           @D21ODAP 03832000
         BNZ   SVC03RLP          YES, PROCESS NEXT PUB         @D21ODAP 03833000
         LH    R3,YPUBTAB        ADDRESS OF FIRST PUB          @D21ODAP 03834000
         USING PUBADR,R3         PUB BASE POINTER              @D37BDAP 03835000
SVC03RLP LA    R0,NEXTPUB        ADDRESS OF NEXT PUB TO PROCESS@D21ODAP 03836000
         CLM   R2,1,PUBCHANN     IS THIS AN AFFECTED PUB       @D21ODAP 03837000
         BE    SVC03RDO          YES,                          @D21ODAP 03838000
         BLR   R6                     =====================>>> @D21ODAP 03839000
         LA    R3,NEXTPUB        ADVANCE TO NEXT PUB           @D21ODAP 03840000
         B     SVC03RLP          PROCESS NEXT PUB              @D21ODAP 03841000
SVC03RDO L     RB,TCBSAVE        ADDRESS OF SAVE AREA          @D21ODAP 03842000
         USING SVEARA,RB         SAVE AREA BASE POINTER        @D21ODAP 03843000
         ST    R0,SVER00         SAVE IT FOR NEXT TIME         @D21ODAP 03844000
         OI    TIBFLAG,RETRYSVC  ENSURE RESVCX EXIT IF NOT LTA @D21ODAP 03845000
         DROP  R8                RELEASE TIB BASE POINTER      @D62TAAP 03846000
         DROP  RB                RELEASE TCB BASE POINTER      @D21ODAP 03847000
         SPACE 1                                               @D21ODAP 03848000
SVC03RDP LH    R5,PUBCHANN       GET CUU ADDRESS IN REGISTER R5@D21ODAP 03849000
         CLI   PUBCHQPT,XFF      IS A REQUEST QUEUED TO PUB    @D37ADAP 03850000
         BE    SVC03R30          NO,                           @D37ADAP 03851000
         SLR   R4,R4             CLEAR CHANQ POINTER           @D37ADAP 03852000
         IC    R4,PUBCHQPT       GET CHANQ ENTRY NUMBER        @D37ADAP 03853000
         AIF   (&AG1 LE 254).LOD01A0                           @D51ODGL 03854000
         ICM   R4,2,PUBCHQPH     INSERT HIGH ORDER BYTE        @D51ODGL 03855000
.LOD01A0 ANOP                                                  @D51ODGL 03856000
         SLL   R4,CHQSLEN        MULTIPLY WITH ENTRY LENGTH    @D37ADAP 03857000
         A     R4,ACHANQ         ADDRESS OF CHANQ ENTRY        @D37ADAP 03858000
         ICM   R4,8,H0           CLEAR HIGH ORDER BYTE         @D68REEF 03859000
         USING CHQADR,R4         CHANQ BASE POINTER            @D37ADAP 03860000
         TM    CHQCCSIO,CHQCCACT WAS REQUEST ALREADY STARTED   @D37ADAP 03861000
         BO    SVC03R60          YES  =====================>>> @D61NDAP 03862000
SVC03R30 XC    CSW(8),CSW        CLEAR CSW                     @D37ADAP 03863000
         MVI   DEVSTA,DEVEND     INDICATE DEVICE END           @D37ADAP 03864000
SVC03R50 STH   R5,CHNADR         SET UP DEVICE ADDRESS         @D21ODAP 03865000
         ST    R3,INTPARM        SET INTERRUPT PARAMETER       @D68ADAP 03866000
         NI    PUBJCFLG,XFF-PUBPPD MAKE DEVICE ACCESSABLE      @D61NDAP 03867000
         MVI   RID+D1,DISPID     DONT OVERWRITE SAVE AREA      @D37ADAP 03868000
         NI    IOOPSW+1,XFF-WAITBIT ENSURE OVERHEAD ACCOUNTING @D37ADAP 03869000
         LPSW  IONPSW                 =====================>>> @D37ADAP 03870000
         SPACE 1                                                        03871000
SVC03R60 NI    PUBJCFLG,XFF-PUBPPD RESET PRIMARY DOWN          @D61NDAP 03872000
         NI    PUBCSFLG,XFF-OPINTV RESET SCHEDULER BITS        @D21ODAP 03873000
         BR    R6                     =====================>>> @D21ODAP 03874000
         SPACE 3                                                        03875000
         DROP  R3                RELEASE PUB BASE POINTER      @D36CDAP 03876000
         DROP  R4                RELEASE CHANQ BASE            @D37ADAP 03877000
         DROP  RA                RELEASE TCB BASE POINTER      @D21ODAP 03878000
         DROP  R6                RELEASE DISP BASE POINTER     @D36CDAP 03879000
         DROP  RC                RELEASE SVC03 BASE POINTER    @D36CDAP 03880000
         EJECT                                                 @D52HDMK 03881000
         TITLE 'VSE SUPERVISOR     SGIOS     DEVSIM PROCESSING        ' 03882000
*********************************************************************** 03883000
*                                                                     * 03884000
*        ESTABLISH DEVICE SIMULATOR                                   * 03885000
*                                                                     * 03886000
*********************************************************************** 03887000
SVC03PAR DSECT ,                  DSECT FOR ESTABLISH PARMS    @D52HDMK 03888000
SVC03ROU DS    AL4                SIMULATION ROUTINE ADDRESS   @D52HDMK 03889000
SVC03SAV DS    AL4                SAVE AREA ADDRESS            @D52HDMK 03890000
SVC03UNT DS    H                  CUU ADDRESS                  @D52HDMK 03891000
SVC03F4L EQU   *-SVC03ROU         LENGTH OF PARAMETER LIST     @D52HDMK 03892000
SVC03SAL EQU   16*4               LENGTH OF SAVE AREA          @DA44442 03893000
&SYSECT  CSECT ,                                               @D52HDMK 03894000
         USING DISP,R6            DISPATCHER BASE POINTER      @D52HDMK 03895000
         USING TIBADR,R8          TIB BASE POINTER             @D52HDMK 03896000
         USING TCBADR,RA          TCB BASE POINTER             @D52HDMK 03897000
         USING PIBADR,RB          PIB BASE POINTER             @D52HDMK 03898000
         USING SVC03,RC           SVC03 BASE POINTER           @D52HDMK 03899000
         USING SGIOS,RD           SGIOS BASE POINTER           @D52HDMK 03900000
         USING SVC03PAR,R7        USER PARMS BASE ADDRESS      @D52HDMK 03901000
SVC03DS  DS    0H'0'                                           @D52VDAP 03902000
         TM    TCBEXFLG,TCBEXAM+TCBEXRM IN 31 BIT MODE         @D52VDAP 03903000
         BNZ   SVC03DS2           NO,                          @D52VDAP 03904000
         CLM   R0,8,H0            IS PARAMETER BELOW 16MEG     @D52VDAP 03905000
         BNE   ERR25              NO,  ====================>>> @D52HDMK 03906000
SVC03DS2 LR    R4,R1              SAVE FUNCTION CODE           @D52HDMK 03907000
         LR    R1,R0              BASE REGISTER FOR PARMLIST   @D52HDMK 03908000
         LR    R7,R0              SAVE BASE ADDRESS            @D52HDMK 03909000
         LA    R2,SVC03F4L-1(R1)  END ADDRESS OF PARMLIST      @D52HDMK 03910000
         DROP  R8                 RELEASE TIB BASE             @DAOM    03911000
         BAL   R8,VALIDSVA        VALIDATE PARAMETER ======>>> @D52HDMK 03912000
*SGLINK  VALIDSVA,INPUT=(R1,R2,R6,R8),WORK=(R2,R5)             @D52HDMK 03913000
         L     R1,SVC03SAV        SIMULATION SAVE AREA ADDRESS @D52HDMK 03914000
         LA    R2,SVC03SAL-1(R1)  END ADDRESS OF SAVEAREA      @D52HDMK 03915000
         BAL   R8,VALIDSVA        VALIDATE SAVE AREA           @D52HDMK 03916000
*SGLINK  VALIDSVA,INPUT=(R1,R2,R6,R8),WORK=(R2,R5)             @D52HDMK 03917000
         LH    R0,SVC03UNT        GET CUU                      @D52HDMK 03918000
         LR    R1,R4              FUNCTION CODE                @D52HDMK 03919000
*********************************************************************** 03920000
*                                                                     * 03921000
*        DEFINE/DELETE DEVICE SIMULATOR COMMON CODE                   * 03922000
*        R0 : CUU                                                     * 03923000
*        R1 : FUNCTION CODE                                           * 03924000
*                                                                     * 03925000
*********************************************************************** 03926000
SVC03DT  L     R3,APBXAREA        ADDRESS OF PUBX ADDRESS TABLE@D52HDAP 03927000
         SLR   RF,RF              SET RETURN CODE TO ZERO      @D52HDAP 03928000
SVC03DTA ICM   R2,15,0(R3)        GET PUBX ADDRESS             @D52HDMK 03929000
         BM    SVC3RC08           NOT FOUND TAKE EXIT WITH RC=8@D52HDAP 03930000
         USING PBXADR,R2          PUBX BASE POINTER            @D52HDMK 03931000
         CH    R0,PBXCUU          MATCHING CUU FOR THIS PUBX   @D52HDMK 03932000
         BE    SVC03DTB           YES, UPDATE FIELDS           @D52HDMK 03933000
         LA    R3,4(,R3)          NO, BUMP TO NEXT PUBX        @D52HDMK 03934000
         B     SVC03DTA           CONTINUE SEARCH              @D52HDMK 03935000
SVC03DTB S     R3,APBXAREA        OFFSET IN PUBX TABLE         @D52HDAP 03936000
         SLL   R3,1               OFFSET IN PUBTAB             @D52HDAP 03937000
         AH    R3,YPUBTAB         PUB ADDRESS                  @D52HDAP 03938000
         USING PUBADR,R3          PUB BASE POINTER             @D52HDAP 03939000
         TM    PBXFLAG,PBXTAPE    IS THIS A VIRTUAL TAPE       @DY46003 03940000
         BO    SVC03DTC           YES, SKIP STATUS CHECKS      @DY46003 03941000
         AIF   (NOT &VSE280).N280160                           @DSCSI   03942000
         TM    PBXFLAG,PBXSCSI    IS THIS A SCSI DEVICE        @DSCSI   03943000
         BO    SVC3RC12           YES,                         @DSCSI   03944000
.N280160 ANOP                                                  @DSCSI   03945000
         TM    PUBJCFLG,X'F8'     IS DEVICE DOWN               @D52HDAP 03946000
         BNZ   SVC3RC12           NO,                          @D52HDAP 03947000
         CLI   PUBCHQPT,XFF       IS A REQUEST QUEUED          @DY45003 03948000
         BNE   SVC3RC04           YES,                         @DY45003 03949000
SVC03DTC C     R1,F2              DEVSIM TO BE TERMINATED      @D52HDMK 03950000
         BE    SVC03DTD           YES, CLEAR FIELDS            @D52HDMK 03951000
         MVC   PBXSIMAD,SVC03ROU  COPY ROUTINE ADDR AND        @D52HDMK 03952000
         MVC   PBXSIMID,SVC03SAV  COPY SAVE AREA ADDRESS       @D52HDMK 03953000
         DROP  R7                 USER PARMS BASE ADDRESS      @D52HDMK 03954000
         LA    R7,SVC3EXNI        POINT TO DISABLE INSTRUCTION @DY46003 03955000
         TM    PBXFLAG,PBXFBAVD   IS THIS A VIRTUAL DISK       @D52HDAP 03956000
         BZ    SVC03DTX           NO,                          @D52VDAP 03957000
         MVI   PUBOPTN,XFF        RESET BLOCK HOLD INDICATOR   @D52HDAP 03958000
         B     SVC03DTX           SAVE RETURN CODE             @D52HDMK 03959000
SVC03DTD DS    0H'0'              SIMULATION STOP PROCESSING   @DY45003 03960000
         XC    PBXSIMAD,PBXSIMAD  CLEAR ROUTINE ADDR AND       @D52HDMK 03961000
         XC    PBXSIMID,PBXSIMID  CLEAR SAVE AREA ADDRESS      @D52HDMK 03962000
         OI    PBXFLAG3,PBXF3INS  FORCE INSTALL PROCESSING     @DAOM093 03963000
         LA    R7,SVC3EXOI        POINT TO ENABLE INSTRUCTION  @DY46003 03964000
         TM    PBXFLAG,PBXFBAVD   IS THIS A VIRTUAL DISK       @D52HDAP 03965000
         BZ    SVC03DTX           NO,                          @D52VDAP 03966000
         MVI   PUBOPTN,PUBOPTVD   INDICATE INOPERATIVE VDISK   @D52HDAP 03967000
*        XC    PBXVCTE,PBXVCTE    FORCE NEW CHARACTERISTICS    @TEST    03968000
         OI    PBXFLAG2,PBXNOSIO  FORCE NEW CHARACTERISTICS    @TEST    03969000
SVC03DTX DS    0H'0'              EN/DISABLE DEVICE NOW        @D27ADAP 03970000
         LH    R1,PBXSCH          GET SUBCHANNEL NUMBER        @D27ADAP 03972000
         CH    R1,XFFFF           DOES THIS SUBCHANNEL EXIST   @D27ADAP 03973000
         BE    SVC3DTXX           NO,                          @D27ADAP 03974000
         ICM   R1,12,H1           GET CORRECT ID               @D27ADAP 03975000
         L     R4,SCHIB$          ADDRESS OF SCHIB             @D27ADAP 03976000
         USING SCHIB,R4           SCHIB BASE POINTER           @D27ADAP 03977000
         STSCH SCHIB              GET SUBCHANNEL INFORMATION   @D27ADAP 03978000
         BO    SVC3DTXX           NOT OPERATIONAL              @D27ADAP 03979000
         TM    SCHFLGS,SCHV       IS DEVICE NUMBER VALID       @D27ADAP 03980000
         BZ    SVC3DTXX           NO,                          @D27ADAP 03981000
         EX    0,0(,R7)           EN/DISABLE DEVICE            @D27ADAP 03982000
         MSCH  SCHIB              DISABLE SUBCHANNEL           @D27ADAP 03983000
         BC    9,SVC3DTXX         WE DID IT                    @D27ADAP 03984000
         B     SVC3RC16           DEVICE IN IMPROPER STATE     @D27ADAP 03985000
         SPACE 1                                               @D27ADAP 03986000
SVC3EXOI OI    SCHFLGS,SCHE       ENABLE  DEVICE               @D27ADAP 03987000
SVC3EXNI NI    SCHFLGS,XFF-SCHE   DISABLE DEVICE               @D27ADAP 03988000
         DROP  R4                 RELEASE SCHIB BASE           @D27ADAP 03989000
         DROP  R2                 RELEASE PUBX BASE            @D52HDMK 03991000
         DROP  R3                 RELEASE PUB  BASE            @D52HDAP 03992000
SVC3DTXX L     R8,TCBSAVE         SAVEAREA ADDRESS             @D52HDMK 03993000
         USING SVEARA,R8                                       @D52HDMK 03994000
         ST    RF,SVER0F          STORE RETURN CODE            @D52HDMK 03995000
         BR    R6                     =====================>>> @D52HDMK 03996000
SVC3RC16 LA    RF,4(,RF)          DEVICE IN IMPROPER STATE     @D27ADAP 03997000
SVC3RC12 LA    RF,4(,RF)          DEVICE IS NOT DVCDN          @D52HDAP 03998000
SVC3RC08 LA    RF,4(,RF)          DEVICE NOT FOUND             @D52HDAP 03999000
SVC3RC04 LA    RF,4(,RF)          REQUEST QUEUED TO PUB        @D52HDAP 04000000
         B     SVC3DTXX           PASS BACK RETURN CODE        @D52VDAP 04001000
         DROP  R6                 RELEASE DISP BASE POINTER    @D52HDMK 04002000
         DROP  R8                 RELEASE SAVEAREA POINTER     @D52HDMK 04003000
         DROP  RA                 RELEASE TCB BASE POINTER     @D52HDMK 04004000
         DROP  RB                 RELEASE PIB BASE POINTER     @D52HDMK 04005000
         DROP  RC                 RELEASE SVC03 BASE POINTER   @D52HDMK 04006000
         DROP  RD                 RELEASE SGIOS BASE POINTER   @D52HDMK 04007000
         SPACE 3                                               @D62OSAP 04008000
         TITLE 'VSE SUPERVISOR     SGIOS     OSA SUPPORT PROCESSING   ' 04009000
         USING DISP,R6           DISPATCHER BASE POINTER       @D62OSAP 04010000
         USING TIBADR,R8         TIB BASE POINTER              @D62OSAP 04011000
         USING TCBADR,RA         TCB BASE POINTER              @D62OSAP 04012000
         USING PIBADR,RB         PIB BASE POINTER              @D62OSAP 04013000
         USING SVC03,RC          SVC03 BASE POINTER            @D62OSAP 04014000
         USING SGIOS,RD          SGIOS BASE POINTER            @D62OSAP 04015000
SVC03OSA DS    0H'0'             OSA SUPPORT INTERFACE         @D62OSAP 04016000
         TM    TCBEXFLG,TCBEXAM  31 BIT MODE                   @D66ADAP 04017000
         BO    SVC03O10          NO,                           @D66ADAP 04018000
         CLM   R0,8,H0           IS PARM-LIST ADDRESS CORRECT  @D66ADAP 04019000
         BNE   ERR25             NO,  ====================>>>  @D66ADAP 04020000
         DROP  R8                RELEASE TIB BASE              @D66ADAP 04021000
SVC03O10 LR    R4,R0             SAVE PARM-LIST POINTER        @D62OSAP 04022000
         LR    R1,R0             POINTER TO PARAMETER LIST     @D62OSAP 04023000
         LA    R2,5(R1)          LAST BYTE OF PARM-LIST        @D62OSAP 04024000
         BAL   R8,VALIDSVA       VALIDATE ECB        ======>>> @D62OSAP 04025000
*SGLINK  VALID,INPUT=(R1,R2,R6,R8),WORK=(R2,R5)                @D62OSAP 04026000
         L     R1,0(,R1)         GET ECB ADDRESS               @D62OSAP 04027000
         LTR   R1,R1             USER WANT TO RESET EXIT       @D62OSAP 04028000
         BZ    SVC03O20          YES,                          @DA44442 04029000
         BNP   ERR21             NO,  =====================>>> @D62OSAP 04030000
         LA    R2,3(R1)          POINT TO LAST BYTE OF ECB     @D62OSAP 04031000
         BAL   R8,VALIDSVA       VALIDATE ECB        ======>>> @D62OSAP 04032000
*SGLINK  VALID,INPUT=(R1,R2,R6,R8),WORK=(R2,R5)                @D62OSAP 04033000
SVC03O20 SLR   R2,R2             CLEAR REGISTER                @D62OSAP 04034000
         ICM   R2,3,4(R4)        GET CUU ADDRESS               @D62OSAP 04035000
         LH    R3,YPUBTAB        VALID PUB ENTRY               @D62OSAP 04036000
         USING PUBADR,R3         PUB BASE POINTER              @D62OSAP 04037000
SVC03O30 CH    R2,PUBCHANN       IS THIS THE WANTED PUB        @D62OSAP 04038000
         BE    SVC03O40          YES,                          @D62OSAP 04039000
         LA    R3,NEXTPUB        ADVANCE TO NEXT PUB           @D62OSAP 04040000
         CLI   PUBCHANN,XFF      END OF PUB TABLE              @D62OSAP 04041000
         BNE   SVC03O30          NO,                           @D62OSAP 04042000
         B     ERR21             YES, =====================>>> @D62OSAP 04043000
SVC03O40 CLI   PUBDEVTY,T3277    IS THIS A 3277 DEVICE         @DIPL    04044000
         BE    SVC03O50          YES,                          @DIPL    04045000
         CLI   PUBDEVTY,TOSA     IS THIS AN OSA DEVICE         @D62OSAP 04046000
         BNE   ERR21             NO,  =====================>>> @D62OSAP 04047000
         CLI   PUBOPTN,PUBOPOFE  SURE IT IS THE OSA FE PORT    @D62OSAP 04048000
         BNE   ERR21             NO,  =====================>>> @D62OSAP 04049000
SVC03O50 L     R9,AINTER         SET BASE FOR I/O INTERRUPT    @D62OSAP 04050000
         USING INTRTN,R9         MAKE IOINTER ADDRESSABLE      @D62OSAP 04051000
         BAL   RE,GETPUBX        GET PUBX ADDRESS              @D62OSAP 04052000
*SGLINK  GETPUBX,INPUT=(R3,R9,RE),OUTPUT=R2                    @D62OSAP 04053000
         USING PBXADR,R2         PUBX BASE POINTER             @D62OSAP 04054000
         LTR   R1,R1             IS EXIT TO BE REMOVED         @D62OSAP 04055000
         BNZ   SVC03O60          NO, WE WANT TO SET EXIT       @D62OSAP 04056000
         CLC   PBXATTIB(4),TIBPTR IS THIS ALSO THE ISSUER      @D62OSAP 04057000
         BNE   ERR21             NO,  =====================>>> @D62OSAP 04058000
         STCM  R1,15,PBXATTIB    RESET EXIT OWNER INFORMATION  @D62OSAP 04059000
         STCM  R1,15,PBXATECB    RESET ATTENTION EXIT ECB      @D62OSAP 04060000
         BR    R6                     =====================>>> @D62OSAP 04061000
SVC03O60 MVC   PBXATTIB(4),TIBPTR SAVE TIB POINTER             @D62OSAP 04062000
         STCM  R1,15,PBXATECB    SET   ATTENTION EXIT ECB      @D62OSAP 04063000
         BR    R6                     =====================>>> @D62OSAP 04064000
         DROP  R2                RELEASE PUBX BASE POINTER     @D62OSAP 04065000
         DROP  R9                RELEASE IOINTER BASE          @D62OSAP 04066000
         DROP  R3                RELEASE PUB BASE POINTER      @D62OSAP 04067000
         DROP  R6                RELEASE DISP BASE POINTER     @D62OSAP 04068000
         DROP  RA                RELEASE TCB BASE POINTER      @D62OSAP 04069000
         DROP  RB                RELEASE PIB BASE POINTER      @D62OSAP 04070000
         DROP  RC                RELEASE SVC03 BASE POINTER    @D62OSAP 04071000
         DROP  RD                RELEASE SGIOS BASE POINTER    @D62OSAP 04072000
         TITLE 'VSE SUPERVISOR     SGIOS     OSAX SUPPORT PROCESSING  ' 04074000
         USING DISP,R6           DISPATCHER BASE POINTER       @D66ADAP 04075000
         USING TIBADR,R8         TIB BASE POINTER              @D66ADAP 04076000
         USING TCBADR,RA         TCB BASE POINTER              @D66ADAP 04077000
         USING PIBADR,RB         PIB BASE POINTER              @D66ADAP 04078000
         USING SVC03,RC          SVC03 BASE POINTER            @D66ADAP 04079000
         USING SGIOS,RD          SGIOS BASE POINTER            @D66ADAP 04080000
SVC03OSX DS    0H'0'             OSAX SUPPORT INTERFACE        @D66ADAP 04081000
         TM    TCBEXFLG,TCBEXAM  31 BIT MODE                   @D66ADAP 04082000
         BO    SVC03X00          YES,                          @D66ADAP 04083000
         CLM   R0,8,H0           IS PARM-LIST ADDRESS CORRECT  @D66ADAP 04084000
         BNE   ERR25             NO,  ====================>>>  @D66ADAP 04085000
         DROP  R8                RELEASE TIB BASE              @D66ADAP 04086000
SVC03X00 LR    R4,R0             SAVE PARM-LIST POINTER        @D66ADAP 04087000
         LR    R1,R0             POINTER TO PARAMETER LIST     @D66ADAP 04088000
         LA    R2,7(R1)          LAST BYTE OF PARM-LIST        @D66ADAP 04089000
         BAL   R8,VALIDSVA       VALIDATE PARMLIST   ======>>> @D66ADAP 04090000
*SGLINK  VALID,INPUT=(R1,R2,R6,R8),WORK=(R2,R5)                @D66ADAP 04091000
         L     R1,0(,R1)         GET APPENDAGE ADDRESS         @D66ADAP 04092000
         SLR   R2,R2             CLEAR REGISTER                @D66ADAP 04093000
         ICM   R2,3,4(R4)        GET CUU ADDRESS               @D66ADAP 04094000
         LH    R3,YPUBTAB        VALID PUB ENTRY               @D66ADAP 04095000
         USING PUBADR,R3         PUB BASE POINTER              @D66ADAP 04096000
SVC03X10 CH    R2,PUBCHANN       IS THIS THE WANTED PUB        @D66ADAP 04097000
         BE    SVC03X20          YES,                          @D66ADAP 04098000
         LA    R3,NEXTPUB        ADVANCE TO NEXT PUB           @D66ADAP 04099000
         CLI   PUBCHANN,XFF      END OF PUB TABLE              @D66ADAP 04100000
         BNE   SVC03X10          NO,                           @D66ADAP 04101000
         B     ERR21             YES, =====================>>> @D66ADAP 04102000
SVC03X20 CLI   PUBDEVTY,TQDIO    IS THIS AN OSA EXPRESS DEVICE @D66ADAP 04103000
         BNE   ERR21             NO,  =====================>>> @D66ADAP 04104000
         LR    R5,R3             SAVE READ-DEVICE PUB          @D66ADAP 04105000
         L     R9,AINTER         SET BASE FOR I/O INTERRUPT    @D66ADAP 04106000
         USING INTRTN,R9         MAKE IOINTER ADDRESSABLE      @D66ADAP 04107000
         BAL   RE,GETPUBX        GET PUBX ADDRESS              @D66ADAP 04108000
*SGLINK  GETPUBX,INPUT=(R3,R9,RE),OUTPUT=R2                    @D66ADAP 04109000
         USING PBXADR,R2         PUBX BASE POINTER             @D66ADAP 04110000
SVC03X50 LTR   R1,R1             IS APPENDAGE TO BE REMOVED    @D66ADAP 04111000
         BNZ   SVC03X70          NO, WE NEED TO SET IT         @D66ADAP 04112000
         OC    PBXATTIB(4),PBXATTIB IS APPENDAGE ACTIVE        @D66ADAP 04113000
         BZR   R6                NO,  =====================>>> @D66ADAP 04114000
         CLC   PBXATTIB(4),TIBPTR IS THIS ALSO THE ISSUER      @D66ADAP 04115000
         BNE   ERR21             NO,  =====================>>> @D66ADAP 04116000
         STCM  R1,15,PBXATTIB    RESET EXIT OWNER INFORMATION  @D66ADAP 04117000
         B     SVC03X80          CONTINUE MAIN LINE            @D66ADAP 04118000
SVC03X70 MVC   PBXATTIB(4),TIBPTR SAVE TIB POINTER             @D66ADAP 04119000
         OI    PIBPUBAS,APPEN    ALLOW APPENDAGE USAGE         @D66ADAP 04120000
SVC03X80 STCM  R1,15,PBXCEAPP    SET/RESET APPEND ADDRESSS     @D66ADAP 04121000
         BR    R6                     =====================>>> @D66ADAP 04122000
         DROP  R2                RELEASE PUBX BASE POINTER     @D66ADAP 04123000
         DROP  R9                RELEASE IOINTER BASE          @D66ADAP 04124000
         DROP  R3                RELEASE PUB BASE POINTER      @D66ADAP 04125000
         DROP  R6                RELEASE DISP BASE POINTER     @D66ADAP 04126000
         DROP  RA                RELEASE TCB BASE POINTER      @D66ADAP 04127000
         DROP  RB                RELEASE PIB BASE POINTER      @D66ADAP 04128000
         DROP  RC                RELEASE SVC03 BASE POINTER    @D66ADAP 04129000
         DROP  RD                RELEASE SGIOS BASE POINTER    @D66ADAP 04130000
         AIF   (NOT &VSE280).N280180                           @D68ADAP 04132000
         TITLE 'VSE SUPERVISOR     SGIOS     MSG  SUPPORT PROCESSING  ' 04133000
.*                                                             @D68ADAP 04134000
.*   MESSAGE PROCESSING ROUTINE                                @D68ADAP 04135000
.*   CALLING SEQUENCE:                                         @D68ADAP 04136000
.*   R1=PARMLIST ---> AL4(MSG),AL2(MLEN),AL4(REPLY),AL2(RLEN),AL4(ECB)  04137000
.*                                                             @D68ADAP 04138000
           USING DISP,R6         DISPATCHER BASE POINTER       @D68ADAP 04139000
           USING TIBADR,R8       TIB BASE POINTER              @D68ADAP 04140000
           USING TCBADR,RA       TCB BASE POINTER              @D68ADAP 04141000
           USING PIBADR,RB       PIB BASE POINTER              @D68ADAP 04142000
           USING SVC03,RC        SVC03 BASE POINTER            @D68ADAP 04143000
           USING SGIOS,RD        SGIOS BASE POINTER            @D68ADAP 04144000
SVC03MSG   DS    0H'0'           MESSAGE PROCESSING            @D68ADAP 04145000
           MVI   SV03CCW2+0,X'03' MAKE SECOND CCW A NOP                 04146000
           MVI   SV03CCW2+1,X'20' RESET CHAINING BYTE                   04147000
           DROP  R8              RELEASE TIB BASE                       04148000
           LA    R2,15(R1)       LOAD END ADDRESS                       04149000
           BAL   R8,VALIDSVA     VALIDATE PARAMETER =======>>> @D25IDAP 04150000
*SGLINK    VALIDSVA,INPUT=(R1,R2,R6,R8),WORK=(R2,R5)           @D25IDAP 04151000
           LR    R3,R1           SAVE PARAMETER LIST ADDRESS            04152000
           L     R1,0(,R3)       GET MESSAGE ADDRESS                    04153000
           LH    R2,4(,R3)       GET LENGTH OF MESSAGE                  04154000
           BCTR  R2,0            LENGTH OF MESSAGE                      04155000
           LA    R2,0(R1,R2)     LAST BYTE OF MESSAGE                   04156000
           BAL   R8,VALIDSVA     VALIDATE PARAMETER =======>>> @D25IDAP 04157000
*SGLINK    VALIDSVA,INPUT=(R1,R2,R6,R8),WORK=(R2,R5)           @D25IDAP 04158000
           LA    R4,0(,R1)       SAVE MESSAGE ADDRESS                   04159000
           ICM   R1,15,0(R3)     GET REPLY ADDRESS                      04160000
           BNZ   SVC03MSG80      REPLY IS REQUIRED             @D68ADAP 04161000
           OC    6(10,R1),0(R1)  IS PARM LIST OK                        04162000
           BNZ   ERR21           NO,  =======================>          04163000
SVC03GOMSG DS    0H'0'           NOW GET THE I/O STARTED                04164000
           ST    R4,SV03CCW1+4   SAVE MESSAGE ADDRESS                   04165000
           MVC   SV03CCW1+2(2),4(R3) SAVE MESSAGE LENGTH                04166000
           LA    R1,SV03CCB1     GET CCB ADDRESS                        04167000
           L     R8,TIBPTR       RESTORE TIB POINTER                    04168000
           USING TIBADR,R8       TIB BASE POINTER              @D68ADAP 04169000
           B     SVC00           GET  =======================>          04170000
           SPACE 1                                                      04171000
SV03CCB1   CCB   SYSLOG,SV03CCW1,X'0400',CCW=FORMAT1                    04172000
SV03CCW1   CCW1  X'09',*,60,0    CCW CHAIN                              04173000
SV03CCW2   CCW1  X'03',*,20,0    CCW CHAIN                              04174000
SV03CCWR   CCW1  X'0A',*,20,0    READ CCW                               04175000
SVC03MSG80 DS    0H'0'           MESSAGE PROCESSING            @D68ADAP 04176000
           DROP  R6              RELEASE DISP BASE POINTER     @D68ADAP 04177000
           DROP  R8              RELEASE TIB  BASE POINTER     @D68ADAP 04178000
           DROP  RA              RELEASE TCB BASE POINTER      @D68ADAP 04179000
           DROP  RB              RELEASE PIB BASE POINTER      @D68ADAP 04180000
           DROP  RC              RELEASE SVC03 BASE POINTER    @D68ADAP 04181000
           DROP  RD              RELEASE SGIOS BASE POINTER    @D68ADAP 04182000
.N280180 ANOP                                                  @D68ADAP 04183000
         EJECT ,                                               @D61BDAP 04184000
         MAPARCOM                                              @D61BDAP 04185000
.*                                                                      04186000
.*NOTE   THIS SAME APPENDAGE IS USED IN IJBAR AND IJBBRSUP              04187000
.*                                                                      04188000
ARCMDVSM EQU   X'40'             VSAM ACCESS IN PROCESS        @D61CDAP 04189000
CMDAVAIL EQU   X'10'             COMMAND AVAILABLE             DELETE   04190000
ARECBATT DS    F                 ATTENTION ECB                 @D61CDAP 04191000
ARECBSUB DS    F                 SUBSYSTEM ECB                 @D61CDAP 04192000
ARECBSRV DS    F                 SERVICE   ECB                 @D61CDAP 04193000
ARECBTIM DS    F                 TIMER     ECB                 @D61CDAP 04194000
ARECBRSV DS    F                 RESERVED  ECB                 @D61CDAP 04195000
ARECBLAD DS    F                 ADDRESS   OF ECB LIST         @D61CDAP 04196000
ARSUPNM  DS    CL8               SUPERVISOR NAME               @D61CDAP 04197000
ARASINM  DS    CL8               IPL-PROC NAME                 @D61CDAP 04198000
ARJCLNM  DS    CL8               JCL-PROC NAME                 @D61CDAP 04199000
ARCHLEN  DS    F                 MONITOR BUFFER LENGTH         @D61NDAP 04200000
ARVSELVL DS    F                 ADDRESS OF REFRESH LEVEL INFO @D61NDAP 04201000
ARMONSWT DS    F                 ADDRESS OF TD SWITCHES   INFO @D61NDAP 04202000
         DS    F                 RESERVED                      @DA44841 04203000
RCPU0ID  DS    CL8               REAL CPUID                    @DA44841 04204000
ARVSEID  DS    CL8               VSE-MACHINE ID                @DAOM    04205000
ARTLSTAB DS    F                 TLS CONTROL TABLE ADDRESS     @DAOM    04206000
         DS    9F                RESERVED                      @DAOM    04207000
&SYSECT  CSECT ,                                               @D61CDAP 04208000
ARDOCCOM DS    0F'0'             ATTENTION BUFFER              @D61CDAP 04209000
         DC    XL(ARCCBL)'00'    FIRST PART OF ATTENTION BUFFER@D61CDAP 04210000
ARBUFFAR DC    XL(ARCMCBL)'00'   BUFFER PREFIX                 @D61CDAP 04211000
         ORG   ARBUFFAR+ARCOMAND-ARBUFFER                      @D61CDAP 04212000
         DC    CL(L'ARCOMAND)' ' COMMAND BUFFER                @D61CDAP 04213000
         ORG   ,                                               @D61CDAP 04214000
ARATTECB DC    A(0)              ATTENTION ECB                 @D61CDAP 04215000
ARSUBECB DC    A(0)              SUBSYSTEM ECB                 @D61CDAP 04216000
ARSRVECB DC    A(0)              SERVICE   ECB                 @D61CDAP 04217000
ARTIMECB DC    A(0)              TIMER     ECB                 @D61CDAP 04218000
ARRSVECB DC    A(0)              RESERVED  ECB                 @D61CDAP 04219000
AARECBLS DC    A(ARECBLST)       ADDRESS OF ECB LIST           @D61CDAP 04220000
ATTSUPNM DC    CL8' '            SUPERVISOR NAME               @D61CDAP 04221000
ATTASINM DC    CL8' '            ASI-PROC NAME                 @D61CDAP 04222000
ATTJCLNM DC    CL8' '            JCL-PROC NAME                 @D61CDAP 04223000
ATTCHLEN DC    A(0)              CHSS MONITORING BUFFER LENGTH @D61NDAP 04224000
ATTLEVEL DC    A(ARVSENAM)       ADDRESS OF VSE GLOBAL INFO    @DA44634 04225000
ATDMONSW DC    A(0)              ADDRESS OF TD TUNING SWITCHES @DA44616 04226000
         DC    A(0)              RESERVED                      @DA44616 04227000
ATTRPUID DC    CL8' '            REAL CPUID                    @D61CDAP 04228000
ATTVSEID DC    CL8'NATIVE'       VSE-MACHINE ID                @DAOM    04229000
         AIF   (NOT &VSE270).N270060                                    04230000
ATTTLSTB DC    A(TLSGLOBAL)      AOM CONTROL TABLE             @DAOM    04231000
         AGO   .Y270060                                                 04232000
.N270060 ANOP                                                           04233000
         DC    A(0)              RESERVED                      @DAOM    04234000
.Y270060 ANOP                                                           04235000
         DC    9A(0)             RESERVED                      @DAOM    04236000
         SPACE 2                                               @D61NDAP 04237000
ARVSENAM DC    CL8' '            SYSTEM NAME       FROM SPLEVEL@DA44634 04238000
ARRFREID DC    CL10' '           VSE REFRESH LEVEL FROM SPLEVEL@DY45988 04239000
ARRFRDAT DC    CL10' '           REFRESH DATE      FROM SPLEVEL@DA44634 04240000
         SPACE 2                                               @D61NDAP 04241000
ARECBLST DC    A(ARATTECB),A(ARSUBECB),A(ARSRVECB)             @D61BDAP 04242000
         DC    A(ARTIMECB),A(ARRSVECB)                         @D61BDAP 04243000
         DC    XL1'80',AL3(*)    ECB LIST END INDICATOR        @D61BDAP 04244000
         TITLE 'VSE SUPERVISOR     INITIALIZE ATTENTION ROUTINE '       04245000
*********************************************************************** 04246000
*                                                                     * 04247000
*        ACTIVATE ATTENTION TASK                                      * 04248000
*                                                                     * 04249000
*********************************************************************** 04250000
*SGLINK  ATTNINT,S,INPUT=(R0,R6,R8,RD),OUTPUT=(R0)             @D149DIS 04251000
         USING DISP,R6                                         @DA40195 04252000
         USING ATTNINT,RD         SUBROUTINE BASE POINTER      @D61NDAP 04253000
ATTNINT  STM   R1,RF,ATTNSR01     SAVE CALLERS REGISTERS       @D61NDAP 04254000
         L     R7,AARBUFAR        ATTENTION BUFFER ADDRESS     @DA40195 04255000
         USING ARBUFFER,R7        ATTENTION BUFFER BASE        @DA40195 04256000
         L     R8,AARTIB          AR TIB ADDRESS               @DA40195 04257000
         USING TIBADR,R8          AR-TIB BASE POINTER          @DA40195 04258000
         MVI   ARECBATT+2,TRABIT  POST ATTENTION ECB           @D61BDAP 04259000
         BAL   RF,IOPOST1         POST ATTENTION ROUTINE       @D61BDAP 04260000
*SGLINK  POST,INPUT=(R6,R8,RF),WORK=RE                                  04261000
ATTNRETN LM    R1,RF,ATTNSR01     RELOAD REGISTERS             @D61CDAP 04262000
         BR    R8                      ====================>>> @DA40195 04263000
         SPACE 2                                               @D51ADIS 04264000
         DROP  R6                 RELEASE DISPATCHER BASE      @D51GDPS 04265000
         DROP  R7                 ELEASE ARBUFFER BASE         @D61CDAP 04266000
         DROP  RD                 RELEASE OLD BASE             @D61CDAP 04267000
         TITLE 'VSE SUPERVISOR     SGIOS       AR CANCEL PROCESSING   ' 04268000
         SPACE 2                                                        04269000
         USING ATTNRCAN,RF        CANCEL PROCESSING BASE       @D61CDAP 04270000
ATTNRCAN STM   R0,RF,ATTNSR00     SAVE REGISTERES              @D61CDAP 04271000
         AMODESW SET,AMODE=31,WR=(R5)                          @D61CDAP 04272000
         CH    R0,H8              AT LEAST 8 BYTES INPUT       @D61CDAP 04273000
         BL    ATTCA000           NO ERROR                     @D61CDAP 04274000
         CLC   0(L'ATTCNCAN,R1),ATTCNCAN IS THIS CANCEL        @D61CDAP 04275000
         BE    ATTCA010           YES                          @D61CDAP 04276000
ATTCA000 DS    0H'0'                                           @DA44462 04277000
         AIF   (NOT &BGDEBUG).NDBG010                          @D61CDAP 04278000
         TM    IJBFLG08,IJBDEBUG  IS DEBUG ACTIVE              @DAOM065 04278300
         BZ    ATTNCRC4           NO,                          @DAOM065 04278600
         BAL   R5,SYSERROR        H/W IF ERROR                 @D61CDAP 04279000
.NDBG010 ANOP                                                  @D61CDAP 04280000
ATTNCRC4 LM    R0,RF,ATTNSR00     RESTORE REGISTERS            @D61CDAP 04281000
         LA    RF,4               INDICATE TO BE PASSED TO AR  @D61CDAP 04282000
         DROP  RF                 RELEASE ATTNRCAN BASE        @D61CDAP 04283000
         AMODESW RETURN           RETURN===================>>> @D61CDAP 04284000
ATTCNFOR DC    C',FORCE '         CONSTANT                     @DA44442 04285000
ATTCNCAN DC    C'CANCEL '                                      @D61CDAP 04286000
ATTCNAR  DC    C'AR '                                          @D61CDAP 04287000
         DS    0H'0'                                           @D61CDAP 04288000
         USING ATTNRCAN,RF        CANCEL PROCESSING BASE       @D61CDAP 04289000
ATTCA010 DS    0H'0'              CANCEL COMMAND PROCESSING    @DAOM    04290000
         LA    R2,L'ATTCNCAN      LENGTH OF COMMAND            @DAOM    04291000
         SR    R0,R2              REMAINING BYTES              @DAOM    04292000
         LA    R1,L'ATTCNCAN-1(,R1) POINT PAST COMMAND         @DAOM    04293000
ATTCA015 LA    R1,1(,R1)          NEXT CHARACTER POSITION      @DAOM    04294000
         CLI   0(R1),C' '         IS THIS A BLANK              @DAOM    04295000
         BNE   ATTCA020           NO,                          @DAOM    04296000
         BCT   R0,ATTCA015        SKIP THE BLANK CHARACTER     @DAOM    04297000
         B     ATTNCRC4           PASS COMMAND TO ATTENTION    @DAOM    04298000
ATTCA020 CLC   0(L'ATTCNLCK,R1),ATTCNLCK IS IT LOCK            @DAOM    04299000
         BE    ATTCNLCK           YES, LOCK COMMAND CANCEL     @DAOM    04300000
         L     R6,DISPAD          LOAD DISPATCHER BASE         @D61CDAP 04301000
         USING DISP,R6            DISPATCHER BASE POINTER      @D61CDAP 04302000
         L     R8,AARTIB          AR TIB ADDRESS               @D61CDAP 04303000
         USING TIBADR,R8          AR-TIB BASE POINTER          @D61CDAP 04304000
         L     R7,AARBUFAR        ATTENTION BUFFER ADDRESS     @D61CDAP 04305000
         USING ARBUFFER,R7        ATTENTION BUFFER BASE        @D61CDAP 04306000
         XC    ATTNINP,ATTNINP    INDICATE NO CUU GIVEN        @D61CDAP 04307000
         TM    TIBFLAG,RETRYSVC   AR-TASK SET RESVC            @D61CDAP 04308000
         BZ    ATTCA025           NO,                          @D61CDAP 04309000
         L     RE,TIBTCB          GET TCB ADDRESS              @D61CDAP 04310000
         USING TCBADR,RE          TCB BASE POINTER             @D61CDAP 04311000
         CLI   SVCIC,X'1D'        IS THIS THE WAITM            @D61CDAP 04312000
         BE    ATTNCRC4           YES, LET ATTENTION PROCESS   @D61CDAP 04313000
ATTCA025 L     RE,TIBSTATE        GET TIB STATE (CCB ADDRESS)  @D61CDAP 04314000
         DROP  R8                 RELEASE TIB BASE             @D61CDAP 04315000
         DROP  RE                 RELEASE TCB BASE             @D61CDAP 04316000
ATTCA030 CLC   0(L'ATTCNAR,R1),ATTCNAR  IS AR TO BE CANCELED   @D61CDAP 04317490
         BNE   ATTCCUU            NO, ASSUME CANCEL CUU        @D61CDAP 04318000
         TM    ARCMDFLG,ARCMDVSM  VSAM ACCESS IN PROCESS       @D61CDAP 04319000
         BZ    ATTCA035           NO,                          @D61CDAP 04320000
         OI    ARCMDFLG,ARCMDCAN  INDICATE DELAYED CANCEL      @D61CDAP 04321000
         B     ATTNCRC4                                        @D61CDAP 04322000
ATTCA035 L     R8,AARTIB          AR TIB ADDRESS               @D61CDAP 04323000
         USING TIBADR,R8          TIB BASE POINTER             @D61CDAP 04324000
         CLI   TIBRQID,WAITBND    IS AR I/O BOUND              @D61CDAP 04325000
         BE    ATTCC025           YES, CANCEL I/O OPERATION    @D61CDAP 04326000
         CLI   TIBRQID,AVRBND     IS AR SVT-TASK BOUND         @D61CDAP 04327000
         BE    ATTCA100           YES, CANCEL SVT REQUEST      @D61CDAP 04328490
ATTCA040 L     R7,AARBUFAR        ATTENTION BUFFER ADDRESS     @DA44462 04329000
         L     R8,AARTIB          AR TIB ADDRESS               @D61CDAP 04330000
         OI    TIBFLAG,FETCHEOJ   INDICATE EOJ IN PROCESS      @D61CDAP 04331000
         TM    TIBCNCL,XFF        CANCEL ALREADY IN PROCESS    @D61CDAP 04332000
         BNZ   ATTCA050           YES                          @D61CDAP 04333000
         MVI   TIBCNCL,X'24'      INDICATE CANCELED BY OPERATOR@D61CDAP 04334000
         L     RD,TIBTCB                                       @D67BDOW 04335000
         NI    TCBRFLAG-TCBADR(RD),XFF-TCBRCVAL NO REASON CODE @D67BDOW 04336000
         B     ATTCA060                                        @D61CDAP 04337000
ATTCA050 MVI   TIBCNCL2,X'24'     INDICATE CANCELED BY OPERATOR@D61CDAP 04338000
ATTCA060 LR    RD,RF              SAVE BASE REGISTER           @D61CDAP 04339000
         MVI   ARCOMAND,C' '       CLEAR FIRST BUFFER BYTE     @DA44462 04340000
         MVC   ARCOMAND+1(L'ARCOMAND-1),ARCOMAND CLEAR BUFFER  @DA44462 04341000
         BAL   RF,SETREADY        POST AR TASK                 @D61CDAP 04342000
*SGLINK  SETREADY,INPUT=(R6,R8,RF),WORK=RE                     @D61CDAP 04343000
         LR    RF,RD              RESTORE BASE POINTER         @D61CDAP 04344000
ATTNCRC0 LM    R0,RE,ATTNSR00     RESTORE REGISTERS            @D61CDAP 04345000
         DROP  RF                 RELEASE ATTNRCAN BASE        @D61CDAP 04346000
         SLR   RF,RF              INDICATE COMMAND PROCESSED   @D61CDAP 04347000
         AMODESW RETURN           RETURN===================>>> @D61CDAP 04348000
         SPACE 1                                                        04349000
         USING ATTNRCAN,RF        CANCEL PROCESSING BASE       @D61CDAP 04350000
ATTCA100 DS    0H'0'              AR IS SERVICE TASK BOUND     @D61NDAP 04351000
         LR    R1,RE              SAVE TIB STATE               @D61NDAP 04352000
         L     R5,ASRQTAB         RESOURCE TABLE ADDRESS       @D61MPAP 04353000
         LA    R5,SRQAVR-SRQTAB(,R5) AVR RESOURCE QUEUE        @D61MPAP 04354000
         LR    RD,RF              SAVE BASE REGISTER           @D61CDAP 04355000
         BAL   RF,RPOST           POST AR TASK READY           @D36IDAP 04356000
*SGLINK  RPOST,INPUT=(R5,R6,RF),WORK=(R5,RE)                   @D369DAP 04357000
         LR    RF,RD              RESTORE BASE REGISTER        @D61NDAP 04358000
         L     RD,BASESERI        SGSERI BASE ADDRESS          @D61NDAP 04359000
         USING SGSERI,RD          SGSERI BASE POINTER          @D61NDAP 04360000
         LA    R5,RQTCNT          NO. OF RQT ENTRIES           @D61NDAP 04361000
         L     RE,ATTRQTAB        ADDRESS OF RQT ENTRY         @DBOC    04362000
         USING RQTE,RE            RQT ENTRY BASE               @D61NDAP 04363000
         DROP  RD                 RELEASE SGSERI BASE          @D61NDAP 04364000
         LA    RD,ARTID           GET AR TASK ID               @D61NDAP 04365000
ATTCA110 CLI   RQTFLG,ZERO        IS ENTRY IN USE              @DBOC    04366000
         BNE   ATTCA130           YES                          @D61NDAP 04367000
.*       OLD CODE                                                       04368490
*TTCA110 TM    RQTFLG,RQTINUSE    IS ENTRY IN USE              @DBOC    04369000
*        BO    ATTCA130           YES                          @DBOC    04370000
ATTCA120 LA    RE,RQTEND(,RE)     POINT TO NEXT RQT ENTRY      @D61NDAP 04371000
         BCT   R5,ATTCA110        PROCESS NEXT RQT ENTRY       @D61NDAP 04372000
         B     ATTCA040           VERY STRANGE                 @D61NDAP 04373000
ATTCA130 CH    RD,RQTTID          IS THIS RQT USED BY AR       @D61NDAP 04374000
         BNE   ATTCA120           NO, KEEP GOING               @D61NDAP 04375000
         NI    RQTFLG,XFF-RQTSET15 RESET RETURN CODE WANTED    @DY46496 04376990
         B     ATTCA040           CANCEL AR NOW                @D61NDAP 04378000
ATTRQTAB DC    A(RQTTAB)          RQTTAB ADDRESS                        04379000
         DROP  RE                 RELEASE RQT ENTRY BASE       @D61NDAP 04380000
         DROP  RF                 RELEASE ATTNRCAN BASE        @D61NDAP 04381000
         SPACE 3                                               @D61CDAP 04382000
         USING ATTNRCAN,RF        ARCANCEL BASE POINTER        @DAOM    04383000
ATTCNLCK DS    0F'0'              LOCK COMMAND TO BE CANCELED  @DAOM    04384000
         L     R2,AHEXPRFL        GET ADDRESS OF FLAG BYTE     @DAOM    04385000
         OI    0(R2),HEXSTPCN     STOP CONSOLE OUTPUT          @DAOM    04386000
         B     ATTNCRC0           WE ARE DONE                  @DAOM    04387000
AHEXPRFL DC    A(HEXPRFLG)        CONSOLE FLAG                 @DAOM    04388000
         DROP  RF                 RELEASE ATTNRCAN BASE        @DAOM    04389000
         SPACE 3                                               @D61CDAP 04390000
         USING ATTNRCAN,RF        ARCANCEL BASE POINTER        @D61CDAP 04391000
ATTCCUU  CLI   TIBRQID,WAITBND    IS AR I/O BOUND              @D61CDAP 04392000
         BNE   ATTNCRC4           NO, PASS TO ATTENTION        @D61CDAP 04393000
         LTR   RE,RE              DO WE HAVE CCB ADDRESS       @D61CDAP 04394000
         BZ    ATTCA040           NO, VERY STRANGE             @D61CDAP 04395000
         USING CCBADR,RE          CCB BASE POINTER             @D61CDAP 04396000
         CLI   3(R1),C' '         DID USER GIVE THREE CHARACTER@D61CDAP 04397000
         BE    ATTCC000           YES,                         @DA44442 04398000
         CLC   3(L'ATTCNFOR,R1),ATTCNFOR CANCEL FORCE          @DA44442 04399000
         BNE   ATTNCRC4           NO, PASS TO ATTENTION        @D61CDAP 04400000
         OI    ATTNINP+3,X'80'    INDICATE CANCEL,FORCE        @DA44442 04401000
ATTCC000 MVC   ATTNINP(3),0(R1)   SAVE CUU DATA                @DA44442 04402000
         LA    R2,3               SET LOOP COUNT               @D61CDAP 04403000
         BCTR  R1,0               ADJUST INPUT POINTER         @D61CDAP 04404000
ATTCC010 LA    R3,0(R2,R1)        POINT TO LAST DIGIT          @D61CDAP 04405000
         TM    0(R3),X'F0'        IS THIS A DIGIT              @D61CDAP 04406000
         BO    ATTCC020           YES                          @D61CDAP 04407000
         IC    R4,0(,R3)          GET CHARACTER                @D61CDAP 04408000
         LA    R4,9(,R4)          MAKE IT THE PROPER DIGIT     @D61CDAP 04409000
         STC   R4,ATTNINP-1(R2)   AND STORE IT BACK            @D61CDAP 04410000
ATTCC020 BCT   R2,ATTCC010        PROCESS NEXT INPUT BYTE      @D61CDAP 04411000
         LA    R1,1(,R1)          RE-ADJUST INPUT POINTER      @D61CDAP 04412000
         PACK  ATTNCUU(3),ATTNINP(4)  PACKED FORMAT            @D61CDAP 04413000
ATTCC025 ICM   R2,3,CCBCLS        GET LNO/PNO VALUE            @D61CDAP 04414000
         N     R2,PHYADMSK        CLEAR UNUSED BITS            @D61CDAP 04415000
         LR    R3,R2              SAVE PUB INDEX               @D61CDAP 04416000
         TM    CCBCLS,CCBPHYAD    PHYSICAL ADDRESSING          @D61CDAP 04417000
         BO    ATTCC050           YES, THAT IS THE PUB INDEX   @D61CDAP 04418000
         TM    CCBCLS,ONE         PROGRAMMER OR SYSTEM UNIT    @D61CDAP 04419000
         BZ    ATTCC030           SYSTEM UNIT                  @D61CDAP 04420000
         AH    R2,SYSLUBNO        ADD NUMBER OF SYSTEM LUBS    @D61CDAP 04421000
ATTCC030 AR    R2,R2              OFFSET WITHIN LUB TABLE      @D61CDAP 04422000
         L     R4,ASYSPCB         SYSTEM PCB ADDRESS           @D61CDAP 04423000
         USING PCBADR,R4          PCB BASE POINTER             @D61CDAP 04424000
         A     R2,PCEALUB         ADD ADDRESS OF PARTITION LUB @D61CDAP 04425000
         DROP  R4                 RELEASE PCB BASE POINTER     @D61CDAP 04426000
         ICM   R3,2,ONE(R2)       GET PUB INDEX HIGH ORDER BYTE@D61CDAP 04427000
         BNM   ATTCC040           THIS IS A 2 BYTE INDEX       @D61CDAP 04428000
         SLR   R3,R3              CLEAR PUB POINTER            @D61CDAP 04429000
ATTCC040 IC    R3,ZERO(R2)        GET THE PUB INDEX            @D61CDAP 04430000
ATTCC050 SLL   R3,PUBSLEN         CALCULATE PUB DISPLACEMENT   @D61CDAP 04431000
         AH    R3,YPUBTAB         ADD ADDRESS OF PUB TABLE     @D61CDAP 04432000
         USING PUBADR,R3          PUB BASE POINTER             @D61CDAP 04433000
         OC    ATTNINP,ATTNINP    WAS THIS A CANCEL CUU        @D61CDAP 04434000
         BZ    ATTCC055           NO, IT WAS CANCEL AR         @D61CDAP 04435000
         CLC   PUBCHANN(2),ATTNCUU AR WORKS WITH SPECIFIED PUB @D61CDAP 04436000
         BNE   ATTNCRC4           NO, LET IJBAR PROCESS THIS   @D61CDAP 04437000
         DROP  R8                 RELEASE TIB BASE             @D61CDAP 04438000
ATTCC055 STH   R3,ARECBATT        SAVE PUB ADDRESS             @D61CDAP 04439000
         CLI   PUBCHQPT,XFF       ANYTHING CHAINED TO PUB      @D61CDAP 04440000
         BE    ATTCA040           NO, NO NEED TO DEQUEUE       @D61CDAP 04441000
         SLR   R8,R8              CLEAR CHANQ CHAIN POINTER    @D61CDAP 04442000
         SLR   R9,R9              CLEAR REGISTER               @D61CDAP 04443000
         IC    R8,PUBCHQPT-PUBADR(R3) GET CHANQ INDEX          @D61CDAP 04444000
         AIF   (&AG1 LE 254).NOMP010                           @D61CDAP 04445000
         ICM   R8,2,PUBCHQPH-PUBADR(R3) GET CHANQ HIGH INDEX   @D61CDAP 04446000
.NOMP010 ANOP                                                  @D61CDAP 04447000
         B     ATTCC070                                        @D61CDAP 04448000
         DROP  R7                 RELEASE ARBUFFER ADDRESS     @D61CDAP 04449000
         DROP  RE                 RELEASE CCB BASE             @D61CDAP 04450000
         USING CHQADR,R9          CHANQ BASE POINTER           @D61CDAP 04451000
ATTCC060 IC    R8,CHQCHNLO        GET CHANQ INDEX              @D61CDAP 04452000
         AIF   (&AG1 LE 254).NOMP020                           @D61CDAP 04453000
         ICM   R8,2,CHQCHNHI      GET CHANQ INDEX HIGH         @D61CDAP 04454000
.NOMP020 ANOP                                                  @D61CDAP 04455000
         CLM   R8,1,XFFFF         WAS THIS THE LAST ENTRY      @D61CDAP 04456000
         BE    ATTCA040           YES, NO NEED TO DEQUEUE      @D61CDAP 04457000
ATTCC070 LR    R7,R9              SAVE LAST CHAIN ENTRY ADDRESS@D61CDAP 04458000
         LR    R9,R8              NEXT-IN-CHAIN ENTRY NUMBER   @D61CDAP 04459000
         SLL   R9,CHQSLEN         MULTIPLY WITH ENTRY LENGTH   @D61CDAP 04460000
         A     R9,ACHANQ          NEXT CHANQ ENTRY ADDRESS     @D61CDAP 04461000
         ICM   R9,8,H0            CLEAR UNUSED BYTE            @D61CDAP 04462000
ATTCC080 L     R1,CHQCCBAD        GET CCB ADDRESS              @D61CDAP 04463000
         ICM   R1,8,H0            CLEAR HIGH ORDER BYTE        @D61CDAP 04464000
         CLC   CHQTID,IORQ4AR     IS THIS ATTENTION REQUEST    @D66ADAP 04465000
         BNE   ATTCC060           NO, CHECK NEXT CHANQ ENTRY   @D61CDAP 04466000
         LTR   R7,R7              IS AR THE FIRST IN CHAIN     @D61CDAP 04467000
         BNZ   ATTCC090           NO,                          @D61CDAP 04468000
         TM    PUBCSFLG,OPINTV    OPERATOR INTERVENTION REQ'D  @D61CDAP 04469000
         BO    ATTCC085           YES,                         @DA44442 04470000
         TM    ATTNINP+3,X'80'    WAS THIS CANCEL FORCE        @DA44442 04471000
         BZ    ATTCA040           NO, WE HAVE TO WAIT (SVC-03) @DA44442 04472000
         TM    CHQCCSIO,CHQCCACT  HAS DEVICE BEEN STARTED      @DA44442 04473000
         BO    ATTCA040           YES,                         @DA44442 04474000
ATTCC085 MVC   PUBCHQPT(1),CHQCHNLO CHAIN NEXT REQUEST TO PUB  @DA44442 04475000
         AIF   (&AG1 LE 254).NOMP030                           @D61CDAP 04476000
         MVC   PUBCHQPH(1),CHQCHNHI INCLUDING HIGH ORDER BYTE  @D61CDAP 04477000
         LH    R7,CHQFLPTR        GET CURRENT FREELIST POINTER @D61CDAP 04478000
         STCM  R7,2,CHQCHNHI      STORE HIGH INDEX BYTE        @D61CDAP 04479000
         AGO   .YMP030                                         @D61CDAP 04480000
.NOMP030 ANOP                                                  @D61CDAP 04481000
         IC    R7,FLPTR           GET CURRENT FREELIST POINTER @D61CDAP 04482000
         STC   R8,FLPTR           MAKE OURS THE NEXT FREE ENTRY@D61CDAP 04483000
.YMP030  ANOP                                                  @D61CDAP 04484000
         STC   R7,CHQCHNLO        POINT TO NEXT FREE ENTRY     @D61CDAP 04485000
         B     ATTCC0A0                                        @D61CDAP 04486000
ATTCC090 DS    0H'0'                                           @D61CDAP 04487000
         L     RD,AARBUFAR        ARBUFFER BASE ADDRESS        @D61CDAP 04488000
         USING ARBUFFER,RD        ATTENTION BUFFER BASE        @D61CDAP 04489000
         XC    ARECBATT(2),ARECBATT CLEAR PUB POINTER          @D61CDAP 04490000
         MVC   CHQCHNLO-CHQADR(1,R7),CHQCHNLO DEQUEUE OUR REQ. @D61CDAP 04491000
         AIF   (&AG1 LE 254).NOMP040                           @D61CDAP 04492000
         MVC   CHQCHNHI-CHQADR(1,R7),CHQCHNHI MAINTAIN HIGH    @D61CDAP 04493000
         MVC   CHQCHNLO(1),CHQFLPTR+1 LET OUR POINT TO OLD     @D61CDAP 04494000
         MVC   CHQCHNHI(1),CHQFLPTR FIRST FREE ENTRY           @D61CDAP 04495000
         AGO   .YMP040                                         @D61CDAP 04496000
.NOMP040 ANOP                                                  @D61CDAP 04497000
         MVC   CHQCHNLO-CHQADR(1,R9),FLPTR                     @D61CDAP 04498000
         STC   R8,FLPTR           UPDATE OLD FREELIST POINTER  @D61CDAP 04499000
.YMP040  ANOP                                                  @D61CDAP 04500000
ATTCC0A0 STH   R8,CHQFLPTR        UPDATE FREE LIST POINTER     @D61CDAP 04501000
         TM    ATTNINP+3,X'80'    WAS THIS CANCEL FORCE        @DA44442 04502000
         BZ    ATTCC0B0           NO,                          @DA44442 04503000
         NI    PUBCSFLG,XFF-QEDERR-DEVBSY RESET GATING BITS    @DA44442 04504000
ATTCC0B0 L     RD,IOSBASE         SGIOS BASE ADDRESS           @DA44442 04505000
         USING SGIOS,RD           SGIOS BASE POINTER           @D61CDAP 04506000
         SLR   R8,R8              CLEAR REGISTER               @D61CDAP 04507000
         STCM  R8,7,CHQCCBAD+1    CLEAR CCB POINTER            @D61CDAP 04508000
         STCM  R8,7,CHQCCBB1      CLEAR COMMUNICATION BYTES    @D61CDAP 04509000
         ICM   R8,15,CQEINUSE     CHANQ ENTRIES IN USE COUNTER @D61CDAP 04510000
         BZ    ATTCA040           IS 0                         @D61CDAP 04511000
         BCTR  R8,0               SUBTRACT 1                   @D61CDAP 04512000
         ST    R8,CQEINUSE        STORE NEW VALUE              @D61CDAP 04513000
         B     ATTCA040                                        @D61CDAP 04514000
         DROP  RD                 RELEASE SGIOS BASE           @D61CDAP 04515000
         DROP  R9                 RELEASE CHANQ BASE           @D61CDAP 04516000
         DROP  R3                 RELEASE PUB BASE             @D61CDAP 04517000
         DROP  RF                 RELEASE ATTNRCAN BASE        @D61CDAP 04518000
         SPACE 3                                                        04519000
ATTNINP  DC    A(0)               SAVE INPUT DATA              @D61CDAP 04520000
ATTNCUU  DC    A(0)               WORK AREA                    @DA40195 04521000
         SPACE                                                          04522000
ATTNSR00 DC    F'0'                                            @D61CDAP 04523000
ATTNSR01 DC    F'0'                                            @DA40195 04524000
ATTNSR02 DC    F'0'                                            @DA40195 04525000
ATTNSR03 DC    F'0'                                            @DA40195 04526000
ATTNSR04 DC    F'0'                                            @DA40195 04527000
ATTNSR05 DC    F'0'                                            @DA40195 04528000
ATTNSR06 DC    F'0'                                            @DA40195 04529000
ATTNSR07 DC    F'0'                                            @DA40195 04530000
ATTNSR08 DC    F'0'                                            @DA40195 04531000
ATTNSR09 DC    F'0'                                            @DA40195 04532000
ATTNSR10 DC    F'0'                                            @DA40195 04533000
ATTNSR11 DC    F'0'                                            @DA40195 04534000
ATTNSR12 DC    F'0'                                            @DA40195 04535000
ATTNSR13 DC    F'0'                                            @DA40195 04536000
ATTNSR14 DC    F'0'                                            @DA40195 04537000
ATTNSR15 DC    F'0'                                            @DA40195 04538000
         DROP  R6                 RELEASE DISPATCHER BASE      @DA40195 04539000
         TITLE 'VSE SUPERVISOR     IJBAR ACTIVATION / TERMINATION     ' 04540000
***************************************************************@D52VDAP 04541000
*  ATTENTION ROUTINE, ABNORMAL TERMINATION PROCESS             @D52VDAP 04542000
***************************************************************@D52VDAP 04543000
         SPACE 1                                               @D52VDAP 04544000
*SGLINK  ARSTADR,INPUT=(R6,R8,RA,RC)                           @D31YDAP 04545000
         USING DISP,R6             DISPATCHER BASE POINTER     @D52VDAP 04546000
ARERRAD  DS    0H'0'               EARLY TERMINATION EXIT      @D61CDAP 04547000
         BALR  RC,0                SET BASE REGISTER           @D61CDAP 04548000
         USING ARSTADR,RC          ROUTINE BASE POINTER        @D52VDAP 04549000
ARSTADR  AMODESW SET,AMODE=24,WR=(RD) INTO 24 BIT ADDR MODE    @D52VDAP 04550000
         L     R8,TIBPTR           GET TIB POINTER             @D61MPAP 04551000
         USING TIBADR,R8           TIB BASE POINTER            @D52VDAP 04552000
         L     RA,TCBPTR           GET TIB POINTER             @D61MPAP 04553000
         USING TCBADR,RA           TCB BASE POINTER            @D52VDAP 04554000
         MVI   RID+1,USERTID       SET RID TO USER             @D52VDAP 04555000
         NI    TIBFLAG1,XFF-EOTACT RESET TERMINATOR ACTIVE BIT @D61CDAP 04556000
         MVI   TIBCNCL,ZERO        RESET CANCEL CODE           @D61CDAP 04557000
         L     RD,AIJBAR           RESTORE BASE POINTER        @D52VDAP 04558000
         ICM   RB,15,TCBARSAV      ACCESS REGISTER SUPPORTED   @D52VDAP 04559000
         BZ    ARSTA020            NO,                         @D52VDAP 04560000
         SAC   0                   RESET ACC REGISTER MODE     @D52VDAP 04561000
ARSTA020 L     RB,AARBUFAR         POINT TO ATTENTION BUFFER   @D52VDAP 04562000
         USING ARBUFFER,RB         ARBUFFER BASE POINTER       @D52VDAP 04563000
         MVI   ARCOMAND,C' '       CLEAR FIRST BUFFER BYTE     @D61BDAP 04564000
         MVC   ARCOMAND+1(L'ARCOMAND-1),ARCOMAND CLEAR BUFFER  @D61BDAP 04565000
         MVI   ARCMDFLG,ZERO       CLEAR CONTROL BYTE          @D52VDAP 04566000
         MVI   ARECBATT+2,X'C0'    INDICATE ATTENTION CANCELED @D61CDAP 04567000
         L     R1,ARECBLAD         ADDRESS OF ECB LIST         @D61CDAP 04568000
         SLR   RE,RE               FORCE NEW REGISTER SET UP   @D61CDAP 04569000
         DROP  RB                  RELEASE ARBUFFER BASE       @D52VDAP 04570000
         EJECT ,                                                        04571000
***************************************************************@D52VDAP 04572000
*  ATTENTION ROUTINE, ACTIVATION                               @D52VDAP 04573000
***************************************************************@D52VDAP 04574000
         SPACE 1                                               @D52VDAP 04575000
         CNOP  2,4                                                      04576000
ARINSEL  BALR  RC,0                SET UP BASE POINTER         @D61CDAP 04577000
         USING *,RC                ARINSEL BASE POINTER        @D61CDAP 04578000
         B     ARINS010            BRANCH AROUND CONSTANTS     @D61CDAP 04579000
         DC    A(ARCOMTAB)         ADDRESS OF PARM LIST        @D61NDAP 04580000
AIJBAR   DC    A(0)                ADDRESS OF IJBAR MODULE     @D61CDAP 04581000
ARINS010 L     RB,AARBUFAR         POINT TO ATTENTION BUFFER   @D61CDAP 04582000
         L     R1,ASVASVDL         POINT TO SVA DIRECTORY LIST @D61CDAP 04583000
         CLC   AIJBAR(4),AARSVA-SVASVDL(R1) NEW PHASE LOADED   @D61CDAP 04584000
         BER   RD                  NO,  ===================>>> @D61CDAP 04585000
         SLR   RE,RE               INDICATE  INITIAL CALL      @D61CDAP 04586000
         L     RD,AARSVA-SVASVDL(R1) BASE ADDRESS OF IJBAR     @D61CDAP 04587000
         ST    RD,AIJBAR                                       @D61CDAP 04588000
         BR    RD                  IJBAR===================>>> @D52VDAP 04589000
         SPACE 2                                               @D52VDAP 04590000
         DROP  R6                  RELEASE DISP BASE POINTER   @D52VDAP 04591000
         DROP  R8                  RELEASE TIB  BASE POINTER   @D52VDAP 04592000
         DROP  RA                  RELEASE TCB BASE POINTER    @D52VDAP 04593000
         DROP  RC                  RELEASE ARINSEL BASE POINTER@D61CDAP 04594000
VTAPPARM DS    0D'0'                                                    04595000
.*       SEE   VTAPHDR MAPPING IN MAPTACN                      @D66ADAP 04596490
         DC    XL(VTAPHLEN)'00'                                         04596980
         ORG   VTAPPARM+VTAARSUP-VTAPHDR OVERLAY                        04597470
         DC    A(ARCOMTAB)         AR-SUP COMMUNICATION AREA   @D66ADAP 04598000
         ORG   ,                   RESTORE LOCATION COUNTER             04598500
         AIF   (NOT &SGIOS).NPRT020                            @D37DDAP 04599000
         PRINT NOGEN                                           @D37DDAP 04600000
.NPRT020 ANOP                                                  @D37DDAP 04601000
         TITLE 'VSE SUPERVISOR     SGSCHED     CHANNEL SCHEDULER      ' 04602000
         SGSCHED                                                        04603000
         TITLE 'VSE SUPERVISOR     IOINTER     I/O INTERRUPT HANDLER  ' 04604000
         IOINTER                                                        04605000
         TITLE 'VSE SUPERVISOR     SGDSK       DISK ERROR RECOVERY    ' 04606000
         SGDSK                                                          04607000
         TITLE 'VSE SUPERVISOR     SGSERI      RESIDENT SERVICE TASK  ' 04608000
         SGSERI                                                         04609000
         MEND                                                           04610000
