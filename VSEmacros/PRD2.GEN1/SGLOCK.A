         MACRO                                                          00001000
         SGLOCK                                                         00002000
******************************************************                  00003000
*                                                    *                  00004000
*   LICENSED MATERIALS - PROPERTY OF IBM             *                  00005000
*   THIS MACRO IS "RESTRICTED MATERIALS OF IBM"      *                  00006000
*   5686-CF7 (C) COPYRIGHT IBM CORP. 1979, 2004      *         @68JMJS  00007000
*   SEE COPYRIGHT INSTRUCTIONS                       *                  00008000
*                                                    *                  00009000
******************************************************                  00010000
.*                                                                      00011000
.* /* START OF SPECIFICATIONS *********************************         00012000
.*                                                                      00013000
.*01* MODULE-TYPE = SUPERVISOR GENERATION MACRO                         00014000
.*                                                                      00015000
.*01* DESCRIPTIVE NAME = LOCK MANAGER ROUTINES                          00016000
.*                                                                      00017000
.*01* CHANGE ACTIVITY  = AS FOLLOWS                                     00018000
.*       SOFTWAIT DUE TO INCORRECT DTL ADDRESSING              @DA37112 00019000
.*       MORE PARTITIONS                                       @D51IDMK 00020000
.*       INTERFACE TO DEADLOCK CHECK                           @D51IDMK 00021000
.*       NEW LOCK REQUEST FAIL=WAITECB (CICS PARTITION WAIT)   @D51UDMK 00022000
.*       RESET DISK WHILE WORKING ON EXTERNAL LOCK FILE        @D51UDMK 00023000
.*       UNRESOLVED SYMBOLS WITH DASDSHR=NO                    @DY40726 00024000
.*       SET RETURN CODE IF RESOURCE NOT FOUND OR INCONSISTENT @DY40755 00025000
.*       DEADLOCK CHECK, IF LCK TASK NOT WAITING ON LOCK FILE  @DY40761 00026000
.*       MSGIPK156 FOR SYMBOL DISEX1 WITH DASDSHR=NO           @DY40814 00027000
.*       DTL NOT POSTED WITH FAIL=WAITECB                      @DY41492 00028000
.*       WAITFFF IF LOCKTAB ENTRY HAS NO OWNER AND UNLOCK ALL  @DY41518 00029000
.*       LOCK COUNTERS / SGCOV STATEMENTS                      @D52XDMK 00030000
.*       ECKD SUPPORT                                          @DA42402 00031000
.*       UNLOCK PROBLEMS                                       @DY42602 00032000
.*       RETRY MECHANISM FOR EXTERNAL LOCKS                    @DA42992 00033000
.*       IO COUNTERS                                           @D61NDMK 00034000
.*       MP                                                    @D61MKMK 00035000
.*       BUSY TIME DURING DLF PROC / INCONSISTENT REQUESTS     @D61NDMK 00036000
.*       NO TCBWAREA UPDATE IF FAIL=WAITECB                    @DA43446 00037000
.*       MORE INFO IF ERROR ON LOCK FILE                       @D61NDMK 00038000
.*       RWAIT FOR DEADLOCKCHECK                               @D61NDMK 00039000
.*       PRINT LOCKTABLE / TRACE UNSUCCESSFUL LOCKS            @DY43697 00040000
.*       DEADLOCKCHECK: WAIT FOR GATE MOVED TO SVC 2           @DY43802 00041000
.*       UNLOCK ALL SYSID: RESERVE/RELEASE FOR CHANGED BLOCKS  @DY43802 00042000
.*       LOOP IN DLF UNLOCK ALL SYSID AND MSG0T10E             @DY43824 00043000
.*       DTL POINTER LOST WHEN DISK RESET                      @DY43896 00044000
.*       HARDWAIT FED AFTER 0T01E PROGRAM CHECK IN LCKWRITE    @DY43896 00045000
.*       31 BIT                                                @D63ADMK 00046000
.*       HARDWAIT DUE TO 24-BIT MODE PSW                       @DY44679 00047000
.*       HARDWAIT FFF: REGISTERS SCREWED UP AFTER IJBEQDQ      @DY45266 00048000
.*       HARDWAIT FFF IF $IJBEQDQ IS NOT LOADED                @DY45385 00049000
.*       HARDWAIT FED WRONG SPACE AFTER TIMER EXPIRATION       @DY45580 00050000
.*       RETRY I/O OPERATION IN CASE OF RESET NOTIFICATION     @DY45712 00051000
.*       MORE THAN 255 TASKS                                   @D66ODOW 00052000
.*       INCLUDE THE DTL IN A LOCK TRACE                       @DY45715 00053000
.*       LOCK TRACE EXTERNAL GENERIC                           @DY45736 00054000
.*       LOCK TRACE DOES SHOW THE WRONG DTL ADDRESS            @DY45817 00055000
.*       HARDWAIT FEC AFTER LOCK TIMER AND USEDND NOT FREE     @DY45937 00056000
.*       HARDWAIT FFF WHEN LOCK TRACE IS ACTIVE                @DY45980 00057000
.*       RC=4 INSTEAD OF RC=28                                 @DY45915 00058000
.*       SDAID HOOK                                            @D68JMJS 00059000
.*       SSCI SUPPORT                                          @D68DDMZ 00060000
.*       MSG0T04I LOOP AND MSG0T01E                            @DY46189 00060500
.*                                                                      00061000
.**** END OF SPECIFICATIIONS *********************************/         00062000
         GBLA  &AGTASK              NUMBER OF SUBTASKS         @D36SDJO 00063000
         GBLA  &NPART               NUMBER OF MAIN TASKS       @D36SDJO 00064000
         GBLB  &BGDEBUG               GENERATE DEBUG OPTION    @D37ZDOW 00065000
         GBLB  &BGDSHR              DASD SHARING               @D36SDJO 00066000
         GBLA  &NRESSAV             NUMBER OF NAMED RESOURCES  @D35CDFG 00067000
         GBLB  &BGFBA                 FBA DISKS SUPPORTED      @D36SDJO 00068000
         GBLB  &BG31                  RPS=YES                  @D36SDJO 00069000
         GBLB  &SGLOCK        COMPONENT NAME FOR PRINT OPTION  @D37ZDOW 00070000
         LCLA  &NLOKOWN             NUMBER OF LOCK OWNERS      @D36SDJO 00071000
         LCLA  &X                                              @D356DJO 00072000
         LCLA  &T                                              @D356DJO 00073000
         LCLA  &NTASK               NUMBER OF TASKS            @D36SDJO 00074000
&NLOKOWN SETA  &NRESSAV*3           NUMBER OF OWNER ELEMENTS   @D356DJO 00075000
&NTASK   SETA  &AGTASK+&NPART+1     +1  FOR SERVICE TASK       @D36SDJO 00076000
         AIF   (NOT &BGDEBUG OR NOT &SGLOCK).NOPRINT           @D37ZDOW 00077000
         PRINT GEN                                             @D37ZDOW 00078000
.NOPRINT ANOP                                                  @D37ZDOW 00079000
         EJECT ,                                               @D149DIS 00080000
         SPACE 2                                               @D149DIS 00081000
***************************************************************@D149DIS 00082000
*                                                                       00083000
*                                                                       00084000
*        L O C K   M A N A G E R    ( S V C 1 1 0 ) .                   00085000
*                                                                       00086000
*                                                                       00087000
*                                                                       00088000
*        L O C K   FUNCTION.                                            00089000
*                                                                       00090000
*        LOCK A RESOURCE AGAINST CONCURRENT USE BY                      00091000
*        DIFFERENT TASKS.                                               00092000
*                                                                       00093000
*                                                                       00094000
*        U N L O C K   FUNCTION.                                        00095000
*                                                                       00096000
*        GIVE UP CONTROL OVER A LOCKED RESOURCE.                        00097000
*                                                                       00098000
*                                                                       00099000
*        DASD SHARING EXTENSIONS.                              @D36SDJO 00100000
*                                                                       00101000
*        THE LOCK MANAGER ALLOWS LOCKING WITHIN A DOS/VSE               00102000
*        SYSTEM AND ACROSS SYSTEMS.                                     00103000
*                                                                       00104000
*        A LOCK COMMUNICATION FILE ON A SHARED DISK IS                  00105000
*        USED TO MONITOR THE CROSS-SYSTEM LOCK ACTIONS.                 00106000
*                                                                       00107000
*                                                                       00108000
*        NOTE:                                                          00109000
*        THE SVC 110 IS USED BOTH FOR LOCK AND UNLOCK.                  00110000
*        THE CONTENTS OF REGISTER 0 IS USED TO DIFFERENTIATE            00111000
*        BETWEEN BOTH FUNCTIONS.                                        00112000
*                                                                       00113000
*        FOR COMPATIBILITY REASONS THE LOCK MANAGER PROCESSES           00114000
*        THE SVC 63 (USE) AND SVC 64 (RELEASE), TOO.                    00115000
*                                                                       00116000
*        LCK SYSTEM TASK:                                               00117000
*        WHENEVER SVC SERVICES ARE REQUIRED WITHIN                      00118000
*        SVC110 PROCESSING, THE LCK SYSTEM TASK IS ACTIVATED.           00119000
*        WITH 'SGSETUP OPTION=DIRECT' THE SVC ROUTINE                   00120000
*        CHANGES ITS STATUS DIRECTLY INTO SYSTEM TASK STATUS.           00121000
*                                                                       00122000
***************************************************************@D149DIS 00123000
         EJECT                                                 @D149DIS 00124000
         SPACE 2                                               @D149DIS 00125000
***************************************************************@D149DIS 00126000
*                                                                       00127000
*                                                                       00128000
*        REGISTER USAGE:                                                00129000
*           R0 - ADDRESS OF RESOURCE NAME (USE/RELEASE ONLY)            00130000
*           R0 - PARAMETER REGISTER (LOCK/UNLOCK ONLY)                  00131000
*           R1 - ADDRESS OF PARAMETER LIST(USE/RELEASE)                 00132000
*           R1 - ADDRESS OF DTL CONTROL BLOCK.                          00133000
*           R2 - ADDRESS OF LOCKED/UNLOCKED LOCKTAB ENTRY               00134000
*           R3 - PARAMETER LIST (USE/RELEASE ONLY)                      00135000
*           R4 - WORK REGISTER                                          00136000
*           R5 - WORK REGISTER                                          00137000
*           R6 - ADDRESS OF DISPATCHER                                  00138000
*           R7 - WORK REGISTER                                          00139000
*           R8 - WORK REGISTER + SUBROUTINE LINKAGE(VALIDSVA)           00140000
*           R9 - WORK REGISTER                                          00141000
*           RA - ADDRESS OF REQUESTING TASK'S TCB.                      00142000
*           RB - SECOND BASE REGISTER OF SGLOCK                         00143000
*           RC - ADDRESS OF RESOURCE OWNER ELEMENT             @D356DJO 00144000
*           RD - LOCK MANAGER BASE REGISTER                             00145000
*           RE - ADDRESS OF LOCKTAB ENTRY                               00146000
*           RF - SUBROUTINE LINKAGE                                     00147000
*                                                                       00148000
*        ATTRIBUTES:  GATED, PAGABLE,SERIALLY REUSABLE         @D36SDJO 00149000
*                                                                       00150000
*                                                                       00151000
***************************************************************@D149DIS 00152000
         EJECT                                                          00153000
         SPACE 2                                               @D149DIS 00154000
***************************************************************@D149DIS 00155000
*  DUMMY SECTIONS FOR THE LOCK MANAGER ROUTINES.                        00156000
*                                                              @D36SDJO 00157000
***************************************************************@D149DIS 00158000
         SPACE 2                                               @D149DIS 00159000
         MAPDTL DSECT=YES                                      @D51IDMK 00160000
         EJECT                                                 @D51IDMK 00161000
         SPACE 2                                               @D51IDMK 00162000
         LOCKADR DSECT=YES                                     @D51IDMK 00163000
         EJECT                                                 @D51IDMK 00164000
         SPACE 2                                               @D51IDMK 00165000
         LOKOADR DSECT=YES                                     @D51IDMK 00166000
         EJECT                                                 @D51IDMK 00167000
         SPACE 2                                               @D51IDMK 00168000
&SYSECT  CSECT                                                 @D36SDJO 00169000
         DC    CL8'SGLOCK '                                    @D66ODOW 00170000
         DC    CL8'DY45926 '     LAST APAR FIXED               @DY45915 00171000
         DC    CL10'11/16/2001'                                @DY45752 00172000
         SPACE 1                                                        00173000
         ENTRY SGLOCK                                          @D36SDJO 00174000
SGLOCK   DS    0H                                              @DA33192 00175000
         LA    RB,X'FFF'(RD)    ** LOAD  RD + X'1000'          @D36SDJO 00176000
         LA    RB,1(RB)         ** INTO SECOND BASE REG  RB    @D36SDJO 00177000
         USING SGLOCK,RD,RB                                    @D63ADMK 00178000
         AMODESW SET,AMODE=31,WR=(R14) AMODE 31                @D63ADMK 00179000
         BR    RC                 BRANCH TO SVC ROUTINE        @D356DJO 00180000
         SPACE 1                                               @D149DIS 00181000
***************************************************************@D149DIS 00182000
* PERMANENT USINGS FOR SGLOCK                                  @D149DIS 00183000
***************************************************************@D149DIS 00184000
         USING MAPDTL,R1                                       @D356DJO 00185000
         USING LOCKADR,R2                                      @D356DJO 00186000
         USING DISP,R6                                         @D35EDJO 00187000
         USING TCBADR,RA                                       @D356DJO 00188000
         USING LOKOADR,RC                                      @D356DJO 00189000
         SPACE 3                                                        00190000
***************************************************************@D149DIS 00191000
*   CHECK AND VALIDATE THE DTL                                 @D36SDJO 00192000
***************************************************************@D149DIS 00193000
SVC110   BAL   RF,LOKGATE2    TEST/SET LOCK/UNLOCK GATE        @D356DJO 00194000
         STC   R0,LOCKPARM    LOCK/UNLOCK PARAMETERS           @D356DJO 00195000
.**************************************************************@D52QDMK 00196000
.*  IF UNLOCK ALL THEN THERE IS NO DTL TO CHECK                @D52QDMK 00197000
.**************************************************************@D52QDMK 00198000
         TM    LOCKPARM,WAITEFLG+UNLSYS+UNLALL+UNLEOJ PRINT?   @DY43697 00199000
         BO    SVC110PR       YES, PRINT LOCKTAB               @DY43697 00200000
         TM    LOCKPARM,UNLALL  UNLOCK ALL                     @D356DJO 00201000
         BO    SVC110T        YES, NO DTL AVAILABLE            @D356DJO 00202000
         AIF   (NOT &BGDSHR).CSYSID                            @D36SDJO 00203000
.**************************************************************@D52QDMK 00204000
.*  IF UNLOCK SYSID THEN THERE IS NO DTL TO CHECK              @D52QDMK 00205000
.**************************************************************@D52QDMK 00206000
         TM    LOCKPARM,UNLSYS  UNLOCK JC=SYSID                @D36SDJO 00207000
         BO    SVC110W          YES,                           @D36SDJO 00208000
.CSYSID  ANOP                                                  @D36SDJO 00209000
.**************************************************************@D52QDMK 00210000
.*  VALIDATE OLD DTL LENGHT (X'16)                             @D52QDMK 00211000
.**************************************************************@D52QDMK 00212000
         LA    R2,DTLLENTO-1(,R1) START OF DTL IN R1           @D51UDMK 00213000
         BAL   R8,VALIDSVA        SIZE OF LENGTH FILED IN R2   @D51UDMK 00214000
         MVC   TRCRESN,DTLNAME    SAVE RESOURCE NAME FOR TRACE @D52XDMK 00215000
         ST    R1,SV110S1         SAVE DTL POINTER             @D52QDMK 00216000
         MVC   TRCFLG1(2),DTLFLG1 SAVE DTL FLAGS FOR TRACING   @D52XDMK 00217000
*SGLINK VALIDSVA,INPUT=(R1,R2,R6,R8),WORK=(R2,R5,R8)           @D52XDMK 00218000
.**************************************************************@D52QDMK 00219000
.*  IF THE DTL LENGTH IS NEW THEN VALIDATE LENGHT (X'1E)       @D52QDMK 00220000
.**************************************************************@D52QDMK 00221000
         CLC   DTLLENG(2),DTLLENGN IS THIS A NEW DTL           @D51UDMK 00222000
         BNE   SVC1100          NO, CHECK FOR OLD DTL          @D52QDMK 00223000
         LA    R2,DTLLENTN-1(,R1) START OF DTL IN R1           @D51UDMK 00224000
         BAL   R8,VALIDSVA        END OF DTL IN R2             @D51UDMK 00225000
*SGLINK VALIDSVA,INPUT=(R1,R2,R6,R8),WORK=(R2,R5,R8)           @D52XDMK 00226000
.**************************************************************@D52QDMK 00227000
.*  CLEAR ECB IN DTL                                           @D52QDMK 00228000
.**************************************************************@D52QDMK 00229000
         TM    LOCKPARM,WAITEFLG OPTION WAITECB ?              @DY42602 00230000
         BNO   SVC110AA          NO DON'T CLEAR DTLECB         @DY42602 00231000
         XC    DTLECB(4),DTLECB CLEAR DTLECB                   @DY42602 00232000
         B     SVC110AA         CONTINUE                       @D52QDMK 00233000
.**************************************************************@D52QDMK 00234000
.*  ENSURE THAT WAITECB IS ONLY WITH NEW DTL FORMAT            @D52QDMK 00235000
.**************************************************************@D52QDMK 00236000
SVC1100  TM    LOCKPARM,WAITEFLG OPTION WAITECB ONLY WITH      @D52QDMK 00237000
         BO    SVC110A           NEW DTL FORMATS               @D52QDMK 00238000
.**************************************************************@D52QDMK 00239000
.*  IF THE DTL LENGTH IS OLD THEN CONTINUE WITH SVC            @D52QDMK 00240000
.**************************************************************@D52QDMK 00241000
         CLC   DTLLENG(2),DTLLENGO IS THIS A OLD DTL           @D51UDMK 00242000
         BNE   SVC110A          NO, DTL FORMAT ERROR           @D36SDJO 00243000
***************************************************************@D149DIS 00244000
*   CHECK FOR CORRECT LOCKOPT SPECIFICATION.                            00245000
***************************************************************@D149DIS 00246000
.**************************************************************@D52QDMK 00247000
.*  VALID OPTIONS ARE 1, 2, 4 AND EXCLUSIVE                    @D52QDMK 00248000
.**************************************************************@D52QDMK 00249000
SVC110AA TM    DTLFLG1,XFF-DTLEXC-DTLOPT1-DTLOPT2-DTLOPT4      @D36SDJO 00250000
         BNZ   SVC110A           ERROR IF RESERVED BITS ON     @D36SDJO 00251000
         MVN   LOKOWORK,DTLFLG1  LOCKOPT SPECIFICATION         @D356DJO 00252000
         CLI   LOKOWORK,DTLOPT4  LOCKOPT=4                     @D36SDJO 00253000
         BH    SVC110A           INVALID LOCKOPT IF GREATER 4  @D36SDJO 00254000
         BE    SVC110B           LOCKOPT=4 IS O.K.             @D36SDJO 00255000
         TM    LOKOWORK,DTLOPT1+DTLOPT2   LOCKOPT=1 OR 2       @D356DJO 00256000
         BM    SVC110B            YES, CONTINUE                @D356DJO 00257000
SVC110A  TM    LOCKPARM,LOCKSVC  LOCK OR UNLOCK                @D356DJO 00258000
         BO    SVC110B2          LOCK                          @D356DJO 00259000
***************************************************************@D149DIS 00260000
*   DTL FORMAT ERROR ON UNLOCK REQUEST  (EXIT WITH R.C.= 8)             00261000
***************************************************************@D149DIS 00262000
SVC110A1 LA    R4,8               RETURN CODE = 8              @D36SDJO 00263000
         SGCOV D52XDMK2                                        @D52XDMK 00264000
         B     SVC64N2                                         @D36SDJO 00265000
         SPACE 2                                               @D149DIS 00266000
.**************************************************************@D52QDMK 00267000
.*  IF OWNER = PARTITION THEN RESET LCKUTID TO MAINTASK TID    @D52QDMK 00268000
.**************************************************************@D52QDMK 00269000
SVC110B  L     R8,TIBPTR          TIB ADDR                     @D14CDIS 00270000
         ST    R8,SV110S8         SAVE FOR EXT DEADLOCK TEST   @D52QDMK 00271000
         USING TIBADR,R8                                       @D14CDIS 00272000
         TM    DTLFLG2,DTLPART    OWNER =PARTITION             @D356DJO 00273000
         BNO   SVC110B1           NO                           @D356DJO 00274000
         TM    TIBFLAG2,ICCFPP    REQ FROM ICCF INTERACT PART? @D36ZDUL 00275000
         BO    SVC110B1           YES - USE TASK ID, NOT PART  @D36ZDUL 00276000
         L     R5,PIBPTR2         ** CALCULATE THE             @D51IDMK 00277000
         USING PIB2ADR,R5         ** TASK IDENTIFICATION       @D51IDMK 00278000
         MVC   LCKUTID(2),PIBMTID ** OF MAIN TASK              @D36SDJO 00279000
         DROP  R5                 **                           @D36SDJO 00280000
SVC110B1 TM    LOCKPARM,LOCKSVC  LOCK OR UNLOCK                @D356DJO 00281000
         BNO   SVC64C            UNLOCK                        @D356DJO 00282000
***************************************************************@D149DIS 00283000
*   DTL FORMAT CHECK.                                          @D356DJO 00284000
*   IF OWNER =PARTITION IS SPECIFIED, FAIL=RETURN IS REQUIRED  @D356DJO 00285000
***************************************************************@D149DIS 00286000
         TM    DTLFLG2,DTLPART    OWNER =PARTITION             @D356DJO 00287000
         BNO   SVC110C            NO                           @D356DJO 00288000
         TM    LOCKPARM,WAITUFLG+WAITCFLG+WAITEFLG WAIT/WAITC/ @D51UDMK 00289000
*                                                  WAITECB     @D51UDMK 00290000
         BZ    SVC110C            NO, FAIL=RETURN IS O.K.      @D356DJO 00291000
***************************************************************@D149DIS 00292000
*   DTL FORMAT ERROR ON LOCK REQUEST  (EXIT WITH R.C.=20)               00293000
***************************************************************@D149DIS 00294000
SVC110B2 LA    R4,ERRDTLFO       RETURN CODE                   @D356DJO 00295000
         SGCOV D52XDMK2                                        @D52XDMK 00296000
         B     SVC63N2                                         @D356DJO 00297000
         SPACE 2                                               @D149DIS 00298000
***************************************************************@D149DIS 00299000
*   CHECK AUTHORIZATION FOR KEEP=YES.                          @D36SDJO 00300000
*   KEEP=YES MUST NOT BE ISSUED BY SUBTASK.                    @D36SDJO 00301000
***************************************************************@D149DIS 00302000
SVC110C  CLC   LCKUTID(2),IJBHMTID MAIN TASK                   @D51IDMK 00303000
         BNH   SVC63C             YES,  SCAN LOCKTAB           @D356DJO 00304000
         TM    DTLFLG2,DTLKEEP    KEEP = YES                   @D356DJO 00305000
         BNO   SVC63C             NO, SCAN LOCKTAB             @D356DJO 00306000
         B     SVC63N1            ERROR                        @D356DJO 00307000
         DROP  R8                                              @D14CDIS 00308000
         EJECT                                                          00309000
         SPACE 2                                               @D149DIS 00310000
***************************************************************@D149DIS 00311000
*                                                                       00312000
*                                                                       00313000
*                                                                       00314000
*        L O C K  RESOURCE                                              00315000
*                                                                       00316000
*        FUNCTION:                                                      00317000
*                                                                       00318000
*        (1) CHECK AND VALIDATE DTL.                                    00319000
*        (2) SCAN LOCKTAB. CHECK WHETHER THE REQUESTED RESOURCE         00320000
*            IS ALREADY LOCKED BY ANOTHER TASK OF OWN SYSTEM.           00321000
*            IF THE RESOURCE-NAME IS NOT YET CONTAINED IN THE           00322000
*            LOCKTAB, GO TO (4).                                        00323000
*        (3) SCAN CHAIN OF OWNER ELEMENTS. IF THE LOCK STATUS           00324000
*            DOES NOT ALLOW TO LOCK THE RESOURCE ANOTHER                00325000
*            TIMES,  GO TO (15).                                        00326000
*            ELSE GO TO (6) (LOCK=EXT) OR TO (14) (LOCK=INT).           00327000
*        (4) IF VOLID IS SPECIFIED SCAN VCTE TABLE                      00328000
*              IF THE SPECIFIED VOLID IS ON A SHARED SPINDEL,           00329000
*              THEN GO TO (6), ELSE GO TO (14)                          00330000
*        (5) IF SCOPE=INT, GO TO (14).                                  00331000
*                                                                       00332000
*        (6) SGSETUP. CHANGE TASK STATUS FROM USER TASK                 00333000
*            TO SYSTEM TASK. THE STEPS (7) TO (12) ARE                  00334000
*            EXECUTED AS LCK SYSTEM TASK.                               00335000
*        (7) HASHING. MAP RESOURCE NAME INTO DISK ADDRESS.              00336000
*        (8) RESERVE DISK DRIVE. READ A DISK BLOCK FROM                 00337000
*            EXTERNAL LOCK FILE. (SVC 0).                               00338000
*        (9) SCAN DISK BLOCK. IF REQUESTED RESOURCE IS LOCKED           00339000
*            BY ANOTHER SYSTEM, THEN ISSUE SETIME REQUEST               00340000
*            (SVC10), RELEASE DISK DRIVE, DEACTIVATE                    00341000
*            LCK SYSTEM TASK AND GO TO (15).                            00342000
*        (10) MOVE RESOURCE NAME INTO DISK BLOCK.                       00343000
*        (11) WRITE BACK DISK BLOCK. (SVC 0).                           00344000
*        (12) RELEASE DISK DRIVE (SVC 0).                      @D36SDJO 00345000
*        (13) DEACTIVATE LCK SYSTEM TASK.RETURN TO USER        @D36SDJO 00346000
*             TASK STATUS.                                              00347000
*        (14) UPDATE SUPERVISOR TABLE LOCKTAB,                 @D36SDJO 00348000
*             SET RETURN CODE=ZERO AND                         @D36SDJO 00349000
*             EXIT TO DISPATCHER.                                       00350000
*                                                              @D36SDJO 00351000
*        (15) PROCESS RETURN CODES DIFFERENT FROM ZERO.                 00352000
*             EXIT TO DISPATCHER (FAIL=RETURN) OR                       00353000
*             TO RESVCX (FAIL=WAIT) OR                                  00354000
*             TO ERR21 (CANCEL CONDITION).                              00355000
*                                                              @D36SDJO 00356000
*                                                              @D36SDJO 00357000
***************************************************************@D149DIS 00358000
         EJECT                                                 @D149DIS 00359000
         SPACE 2                                               @D149DIS 00360000
***************************************************************@D149DIS 00361000
*                                                              @D36SDJO 00362000
*        ENTRY POINTS: SVC63  FROM USE SVC.                             00363000
*                     SVC63C FROM  SVC110 (LOCK SVC).                   00364000
*                                                              @D356DJO 00365000
*                                                              @D356DJO 00366000
*        INPUT:     R1 CONTAINS THE ADDRESS OF A DTL.                   00367000
*        (LOCK)     R0 CONTAINS SOME PARAMETER FLAGS.          @D356DJO 00368000
*                   (STORED TO FIELD LOCKPARM).                @D356DJO 00369000
*                                                              @D356DJO 00370000
*        INPUT:     R1 POINTS TO A PARAMETER LIST OF           @D356DJO 00371000
*        (USE)      THE FORMAT DESCRIBED BY DSECT 'USEPARM';   @D356DJO 00372000
*                   R0 POINTS TO AN 8-BYTE NAME FIELD.         @D356DJO 00373000
*                                                                       00374000
*                                                                       00375000
*        OUTPUT:    R15 CONTAINS A RETURN CODE (0 - 36)                 00376000
*        (LOCK)     ALL OTHER REGISTERS REMAIN UNCHANGED.      @D356DJO 00377000
*                                                              @D356DJO 00378000
*        OUTPUT:    R0 CONTAINS A RETURN CODE (0 - 16)                  00379000
*         (USE)     ALL OTHER REGISTERS REMAIN UNCHANGED.               00380000
*                                                                       00381000
*        RETURN CODES:                                                  00382000
*        (LOCK)                                                         00383000
*                   0  REQUEST EXECUTED SUCCESSFULLY           @D356DJO 00384000
*                   4  RESOURCE OWNED BY OTHER TASK                     00385000
ERRINTSP EQU        8  LOCKTAB SPACE EXHAUSTED                          00386000
ERRINCON EQU       12  RESOURCE REQUEST INCONSISTENT WITH               00387000
*                      PRESENT LOCK STATUS                              00388000
ERRDELO1 EQU       16  DEADLOCK                                         00389000
ERRDTLFO EQU       20  DTL FORMAT ERROR                                 00390000
ERRDELO2 EQU       24  ALREADY LOCKED BY ISSUING TASK (DEAD LOCK)       00391000
ERREXTSP EQU       28  SPACE EXHAUSTED ON EXTERNAL LOCK FILE            00392000
ERRNOVOL EQU       32  VOLUME NOT MOUNTED                               00393000
ERREXTIO EQU       36  IRRECOVERABLE ERROR ON EXT.FILE                  00394000
*                                                                       00395000
*        RETURN CODES:                                                  00396000
*        (USE)                                                          00397000
*                   0  REQUEST EXECUTED SUCCESSFULLY           @D356DJO 00398000
*                   4  RESOURCE OWNED BY OTHER TASK                     00399000
*                      OR LOCKTAB SPACE EXHAUSTED                       00400000
*                   8  RESOURCE OWNED BY REQUESTING                     00401000
*                      TASK, SAME SHARE OPTION                          00402000
*                  12  RESOURCE OWNED BY REQUESTING                     00403000
*                      TASK, DIFFERENT SHARE OPTION                     00404000
*                  16  DEADLOCK                                         00405000
*                                                                       00406000
*        EXITS:        TO DISPATCHER (ADDRESS IN R6)                    00407000
*                      TO RESVCX  IF LOCK MANAGER IN USE OR             00408000
*                                 OR RESOURCE ALREADY LOCKED.           00409000
*                      TO ERR1E - I/O ERROR ON LOCK FILE                00410000
*                      TO ERR21 - INVALID PARAMETER LIST FORMAT         00411000
*                      TO ERR25 - INVALID PARAMETER LIST LIMITS         00412000
*                      TO ERR2E - POSSIBLE DEADLOCK                     00413000
*                                                                       00414000
***************************************************************@D149DIS 00415000
         EJECT                                                          00416000
         SPACE 2                                               @D149DIS 00417000
***************************************************************@D149DIS 00418000
SVC63    LR    R3,R1              SAVE USER PARAMETER REG      @D356DJO 00419000
         BAL   RF,LOCKGATE        TEST/SET LOCK/UNLOCK GATE    @D356DJO 00420000
*                                 VALIDATE REG 1 PARMS         @D356DJO 00421000
         MVI   LOCKPARM,LOCKSVC   LOCK/USE FLAG                @D356DJO 00422000
         USING USEPARM,R3                                      @D356DJO 00423000
         TM    USEFLAGS,USEW      FAIL=WAIT                    @D356DJO 00424000
         DROP  R3                                              @D356DJO 00425000
         BNO   SVC63A             BRANCH IF NO                 @D356DJO 00426000
         OI    LOCKPARM,WAITUFLG  INDICATE FAIL=WAIT           @D356DJO 00427000
SVC63A   BAL   RF,SV6364EM        TRANSLATE USE INTO LOCK REQ. @D356DJO 00428000
         SPACE 1                                                        00429000
***************************************************************@D52QDMK 00430000
*   LOCK ENTRY POINT:                                          @D52QDMK 00431000
*   TRY TO FIND RESOURCE NAME IN LOCKTAB                       @D52QDMK 00432000
*                                                              @D52QDMK 00433000
.*  RETURN (0): RESOURCE NAME NOT IN LOCKTAB                   @D52QDMK 00434000
.*              BUT CAN BE IN EXTERNAL LOCKFILE                @D52QDMK 00435000
.*              IN THIS CASE A FREE LOCKTAB ENTRY IS ALLOCATED @D52QDMK 00436000
.*              R7=0: NO SPACE AVAILABLE                       @D52QDMK 00437000
.*  RETURN (4): RESOURCE NAME FOUND, BUT DTL AND LOCKTAB ENTRY @D52QDMK 00438000
.*              HAVE DIFFERENT OPTIONS (OWNER = PARTITION)     @D52QDMK 00439000
.*  RETURN (8): RESOURCE NAME FOUND AND OWNER OPTIONS ARE EQUAL@D52QDMK 00440000
***************************************************************@D52QDMK 00441000
SVC63C   BAL   RF,SV6364R        FIND RESOURCE NAME IN LOCKTAB @D356DJO 00442000
*SGLINK  SV6364R,INPUT=(R1,RF),OUTPUT=(R2,R7),WORK=(R8,R9)     @D36SDJO 00443000
         B     SVC63H             RESOURCE NAME NOT FOUND      @D356DJO 00444000
         B     SVC63N1            FOUND, BUT INCONSISTENT      @D36SDJO 00445000
         DROP  R6                                              @D52QDMK 00446000
         SPACE 2                                               @D149DIS 00447000
.**************************************************************@D52QDMK 00448000
.*  ENTRY POINT SVC63C1: 1) LOCK SVC AND RESOURCE NAME FOUND   @D52QDMK 00449000
.*                       2) DO INTERNAL LOCK SVC FOR A REQUEST @D52QDMK 00450000
.*                          ELEMENT (FROM ROUTINE SVC110ZF)    @D52QDMK 00451000
.*                                                             @D52QDMK 00452000
.*  LAYOUT OF LOCKTAB ENTRY:                                   @D52QDMK 00453000
.*  IF FROM 1) THEN OWNER ELEMENTS MUST EXIST                  @D52QDMK 00454000
.*  IF FROM 2) THEN OWNER ELEMENTS MAY BE THERE OR NOT         @D52QDMK 00455000
.**************************************************************@D52QDMK 00456000
SVC63C1  L     RC,LOCKCHN          GET OWNER ELEMENT           @D51UDMK 00457000
         LTR   RC,RC               NO OWNER BUT REQUESTOR(EXT. @D52QDMK 00458000
         BZ    SVC63H1             LOCK AND RESOURCE NOT FREE) @D52QDMK 00459000
***************************************************************@D149DIS 00460000
*                                                                       00461000
*   TEST IF REQUESTED RESOURCE CAN BE ALLOCATED.                        00462000
*   CHECK WHETHER LOCK REQUEST IS CONSISTENT WITH LOCK STATUS.          00463000
*                                                                       00464000
***************************************************************@D149DIS 00465000
.**************************************************************@D52QDMK 00466000
.*  PROCESS LOCK REQUEST WITH  LOCKOPTION 1                    @D52QDMK 00467000
.*  IF LOCK STATUS = E1 THEN FOR ALL REQUESTS NO ALLOCATION    @D52QDMK 00468000
.**************************************************************@D52QDMK 00469000
         MVC   TRCOTID,LOKOTID     SAVE OWNERS ID FOR TRACE    @D52QDMK 00470000
         TM    LOCKFLG2,LOCKEXT    EXTERNAL RESOURCE ?         @D61NDMK 00471000
         BZ    SVC63C2             YES, WAIT                   @D61NDMK 00472000
         TM    DTLFLG2,DTLVOL+DTLEXTR    EXTERNAL LOCKING      @D61NDMK 00473000
         BZ    SVC63N              NO, INCONSISTENT REQUEST    @D61NDMK 00474000
SVC63C2  CLI   LOCKFLG1,LOCKEXC+DTLOPT1  LOCK STATUS = E1      @D61NDMK 00475000
         BE    SVC63F              YES, WAIT                   @D356DJO 00476000
         TM    DTLFLG1,DTLOPT1     LOCKOPT=1                   @D356DJO 00477000
         BNO   SVC63D              NO, TEST FOR LOCKOPT=2      @D356DJO 00478000
.**************************************************************@D52QDMK 00479000
.*  IF REQUEST = E1 THEN NO ALLOCATION                         @D52QDMK 00480000
.**************************************************************@D52QDMK 00481000
         TM    DTLFLG1,DTLEXC      E 1 REQUEST                 @D356DJO 00482000
         BO    SVC63F              YES, WAIT                   @D356DJO 00483000
.**************************************************************@D52QDMK 00484000
.*  IF LOCK STATUS = S1 THEN ALLOCATE IF REQUEST = S1          @D52QDMK 00485000
.*                      ELSE LOCKOPTIONS ARE INCONSISTENT      @D52QDMK 00486000
.**************************************************************@D52QDMK 00487000
         TM    LOCKFLG1,DTLOPT1    LOCK STATUS IS LOCKOPT1     @D356DJO 00488000
         BNO   SVC63N              NO, INCONSISTENT REQUEST    @D356DJO 00489000
         B     SVC63E              GET THE RESOURCE            @D356DJO 00490000
         SPACE 2                                               @D149DIS 00491000
.**************************************************************@D52QDMK 00492000
.*  PROCESS LOCK REQUEST WITH  LOCKOPTION 2                    @D52QDMK 00493000
.**************************************************************@D52QDMK 00494000
SVC63D   TM    DTLFLG1,DTLOPT2     LOCKOPT=2                   @D36SDJO 00495000
         BNO   SVC63D5             NO, MUST BE FOUR            @D36SDJO 00496000
.**************************************************************@D52QDMK 00497000
.*  IF LOCK STATUS ¬= 2 THEN LOCKOPTIONS ARE INCONSISTENT      @D52QDMK 00498000
.**************************************************************@D52QDMK 00499000
         TM    LOCKFLG1,DTLOPT2    LOCKOPT 2 STATUS            @D356DJO 00500000
         BNO   SVC63N              NO, INCONSISTENT REQUEST    @D356DJO 00501000
.**************************************************************@D52QDMK 00502000
.*  IF REQUEST = S2 THEN ALLOCATE ALWAYS (WITH STATUS E2 OR S2)@D52QDMK 00503000
.**************************************************************@D52QDMK 00504000
         TM    DTLFLG1,DTLEXC      EXCLUSIVE REQ               @D356DJO 00505000
         BNO   SVC63E              NO, GET THE RESOURCE        @D356DJO 00506000
.**************************************************************@D52QDMK 00507000
.*  IF REQUEST = E2 AND LOCK STATUS = E2 THEN DO NOT ALLOCATE  @D52QDMK 00508000
.**************************************************************@D52QDMK 00509000
         TM    LOCKFLG1,LOCKEXC    EXCLUSIVELY LOCKED          @D356DJO 00510000
         BO    SVC63F              YES, WAIT                   @D356DJO 00511000
.**************************************************************@D52QDMK 00512000
.*  IF REQUEST = E2 AND LOCK STATUS = S2 THEN ALLOCATE         @D52QDMK 00513000
.*  LOCK STATUS WILL CHANGE FROM S2 TO E2                      @D52QDMK 00514000
.**************************************************************@D52QDMK 00515000
         AIF   (NOT &BGDSHR).DTLOPT2                           @D36SDJO 00516000
         OI    DSHRFLG,LCKREQ      LOCKING STATUS CHANGES      @D36SDJO 00517000
.DTLOPT2 ANOP                                                  @D36SDJO 00518000
         B     SVC63E              GET THE RESOURCE            @D36SDJO 00519000
         SPACE 2                                               @D149DIS 00520000
.**************************************************************@D52QDMK 00521000
.*  PROCESS LOCK REQUEST WITH  LOCKOPTION 4                    @D52QDMK 00522000
.*  IF LOCK STATUS ¬= 4 THEN LOCKOPTIONS ARE INCONSISTENT      @D52QDMK 00523000
.**************************************************************@D52QDMK 00524000
SVC63D5  TM    LOCKFLG1,DTLOPT4    LOCKOPT 4 STATUS            @D36SDJO 00525000
         BNO   SVC63N              NO, INCONSISTENT REQUEST    @D36SDJO 00526000
         AIF   (NOT &BGDSHR).DTLOPT4                           @D36SDJO 00527000
.**************************************************************@D52QDMK 00528000
.*  IF LOCK STATUS = E4 THEN ALLOCATE ALWAYS                   @D52QDMK 00529000
.**************************************************************@D52QDMK 00530000
         TM    LOCKFLG1,LOCKEXC    EXCLUSIVELY LOCKED          @D36SDJO 00531000
         BO    SVC63E              YES, ANYBODY MAY GET IT     @D36SDJO 00532000
.**************************************************************@D52QDMK 00533000
.*  IF LOCK STATUS = S4 AND REQUEST = S4 THEN ALLOCATE ALWAYS  @D52QDMK 00534000
.**************************************************************@D52QDMK 00535000
         TM    DTLFLG1,DTLEXC      EXCLUSIVE REQ               @D36SDJO 00536000
         BNO   SVC63E              NO, GET THE RESOURCE        @D36SDJO 00537000
.**************************************************************@D52QDMK 00538000
.*  IF LOCK STATUS = S4 AND REQUEST = E4 THEN ALLOCATE ALWAYS  @D52QDMK 00539000
.*  LOCK STATUS WILL CHANGE FROM S4 TO E4                      @D52QDMK 00540000
.**************************************************************@D52QDMK 00541000
         OI    DSHRFLG,LCKREQ      LOCKING STATUS CHANGES      @D36SDJO 00542000
.DTLOPT4 ANOP                                                  @D36SDJO 00543000
         EJECT                                                 @D149DIS 00544000
         SPACE 2                                               @D149DIS 00545000
***************************************************************@D149DIS 00546000
*                                                              @D356DJO 00547000
*   SCAN ALL OWNER ELEMENTS OF THIS RESOURCE.                  @D356DJO 00548000
*                                                              @D356DJO 00549000
*   IF THE RESOURCE IS ALREADY OWNED BY THIS TASK,             @D356DJO 00550000
*   THE USE COUNT IS INCREASED BY ONE.                                  00551000
*   IF IT IS NOT YET OWNED BY THIS TASK,                                00552000
*   A NEW OWNER ELEMENT IS ADDED TO THE LOCKTAB ENTRY.                  00553000
*                                                              @D356DJO 00554000
***************************************************************@D149DIS 00555000
SVC63E   L     RC,LOCKCHN         GET FIRST OWNER ELEMENT      @D356DJO 00556000
         LH    R5,LCKUTID         CURRENT TASK ID              @D356DJO 00557000
SVC63E1  CH    R5,LOKOTID         OWNED BY SAME TASK/PARTITION @DA27378 00558000
         BE    SVC63E5            YES, INCREASE COUNTERS       @D356DJO 00559000
         LR    RE,RC              LAST BUT ONE  ELEMENT        @D356DJO 00560000
         L     RC,LOKOCHN         POINT TO NEXT OWNER ELEMENT  @D356DJO 00561000
         LTR   RC,RC              ELEMENT AVAILABLE            @D356DJO 00562000
         BNE   SVC63E1            YES, CHECK NEXT IN CHAIN     @D356DJO 00563000
         LR    RC,RE              BACK TO LAST ELEMENT         @D356DJO 00564000
         L     R5,LOKOFRL         FREE LIST POINTER            @D356DJO 00565000
         LTR   R5,R5              FREE ELEMENT AVAILABLE       @D356DJO 00566000
         BNZ   SVC63E2            YES CONTINUE                 @D37CDOW 00567000
         BAL   R8,SV6364OE        TRY TO GET NEW OWNER ELEMENTS@D37CDOW 00568000
SVC63E2  EQU   *                                               @D37CDOW 00569000
         AIF   (NOT &BGDSHR).SHRLCK1                           @D36SDJO 00570000
         BAL   R8,DSHRLCK1        INITIALIZE SYSTEM TASK       @D36SDJO 00571000
*SGLINK  DSHRLCK1,INPUT=(R2,R8),WORK=(R0,R3,R4,R5,RF)          @D36SDJO 00572000
         SPACE 2                                               @D149DIS 00573000
***************************************************************@D149DIS 00574000
*   READ AND UPDATE EXTERNAL FILE                              @D36SDJO 00575000
***************************************************************@D149DIS 00576000
         L     R5,LOKOFRL         FREELIST POINTER             @D36SDJO 00577000
.SHRLCK1 ANOP                                                  @D36SDJO 00578000
*                                                              @D356DJO 00579000
.**************************************************************@D52QDMK 00580000
.*  QUEUE OWNER ELEMENT TO END OF OWNER LIST                   @D52QDMK 00581000
.**************************************************************@D52QDMK 00582000
         ST    R5,LOKOCHN         CHAIN FREE ELEMENT TO RES.   @D356DJO 00583000
         LR    RC,R5              POINT TO NEW LAST ELEMENT    @D356DJO 00584000
         B     SVC63I             INITIALIZE NEW OWNER ELEM.   @D356DJO 00585000
         SPACE 2                                               @D149DIS 00586000
***************************************************************@D149DIS 00587000
*   RESOURCE IS ALREADY OWNED BY ISSUING TASK/PARTITION.       @D356DJO 00588000
*   INCREASE USE COUNT IN CASE OF LOCK SVC                     @D52QDMK 00589000
*   IF USE SVC THEN GIVE ONLY RETURN CODE                      @D52QDMK 00590000
*   R4 = WORKREGISTER                                          @D52QDMK 00591000
***************************************************************@D149DIS 00592000
SVC63E5  TM    LOCKPARM,NEWLOCK   LOCK REQUEST                 @D356DJO 00593000
         BNO   SVC63G2            NO, GIVE USE RETURN CODES    @D356DJO 00594000
         TM    DTLFLG1,DTLEXC     EXCLUSIVE REQUEST            @D356DJO 00595000
         BNO   SVC63E7            NO                           @D356DJO 00596000
.**************************************************************@D52QDMK 00597000
.*  UPDATE COUNTER FOR EXCLUSIVE USAGE AND SET EXCLUSIVE LOCK  @D52QDMK 00598000
.*  IN LOCKTAB ENTRY AND OWNER ELEMENT                         @D52QDMK 00599000
.*  ONLY 16 EXCLUSIVE LOCKS FOR THE SAME TASK ID ARE ALLOWED   @D52QDMK 00600000
.*  IF COUNTER EXCEEDS THEN IT'S INCONSISTENT REQUEST          @D52QDMK 00601000
.**************************************************************@D52QDMK 00602000
         TM    LOKOCNTE,16        MORE THAN 16*256 EXCL LOCKS  @D36SDJO 00603000
         BO    SVC63N             YES, ILLEGAL SVC             @D36SDJO 00604000
         AIF   (NOT &BGDSHR).SHRLCK2                           @D36SDJO 00605000
         BAL   R8,DSHRLCK1        INITIALIZE SYSTEM TASK       @D36SDJO 00606000
*SGLINK  DSHRLCK1,INPUT=(R2,R8),WORK=(R0,R3,R4,R5,RF)          @D36SDJO 00607000
.**************************************************************@D52QDMK 00608000
.*  READ AND UPDATE EXTERNAL FILE                              @D52QDMK 00609000
.**************************************************************@D52QDMK 00610000
.SHRLCK2 ANOP                                                  @D36SDJO 00611000
         LH    R4,LOKOCNTE        EXCLUSIVE USERS              @D36SDJO 00612000
         LA    R4,1(R4)           ADD ONE                      @D36SDJO 00613000
         STH   R4,LOKOCNTE        UPDATE USE COUNT             @D36SDJO 00614000
         LH    R4,LOCKCNTE        TOTAL NUMBER OF EXC USERS    @D36SDJO 00615000
         LA    R4,1(R4)           ADD ONE                      @D36SDJO 00616000
         STH   R4,LOCKCNTE        UPDATE                       @D36SDJO 00617000
         OI    LOCKFLG1,LOCKEXC   SET EXC FLAG IN RESOURCE     @D356DJO 00618000
         OI    LOKOFLG,LOKOEXC    AND OWNER ELEMENT            @D356DJO 00619000
         B     SVC63K             GIVE R.C. = 0                @D356DJO 00620000
.**************************************************************@D52QDMK 00621000
.*  UPDATE COUNTER FOR SHARED USAGE                            @D52QDMK 00622000
.*  IN LOCKTAB ENTRY AND OWNER ELEMENT                         @D52QDMK 00623000
.*  ONLY 16 SHARED LOCKS FOR THE SAME TASK ID ARE ALLOWED      @D52QDMK 00624000
.*  IF COUNTER EXCEEDS THEN IT'S INCONSISTENT REQUEST          @D52QDMK 00625000
.**************************************************************@D52QDMK 00626000
SVC63E7  TM    LOKOCNTS,16        MORE THAN 16*256 LOCKS       @D356DJO 00627000
         BO    SVC63N             YES, ILLEGAL USAGE           @D356DJO 00628000
         LH    R4,LOKOCNTS        NUMBER OF SHARED OWNERS      @D356DJO 00629000
         LA    R4,1(R4)           INCREMENT BY ONE             @D356DJO 00630000
         STH   R4,LOKOCNTS        STORE BACK                   @D356DJO 00631000
         B     SVC63K             STORE R.C. = 0               @D356DJO 00632000
         EJECT                                                 @D149DIS 00633000
         SPACE 2                                               @D149DIS 00634000
***************************************************************@D149DIS 00635000
*   - CHECK FOR DEADLOCKS                                               00636000
*   TEST WHETHER WAITING FOR THE REQUESTED                              00637000
*   RESOURCE MAY CAUSE DEAD LOCK.                                       00638000
*                                                              @D356DJO 00639000
*   THIS CHECK IS CALLED IN THE FOLLOWING CASES:               @D52QDMK 00640000
*   - LOCK STATUS = E1 AND REQUEST = ANY                       @D52QDMK 00641000
*   - LOCK STATUS = E2 AND REQUEST = E2                        @D52QDMK 00642000
*   - DEADLOCK CHECK ROUTINE:                                  @D52QDMK 00643000
*     ACTUAL TID: DUMMY REQUEST = E1                           @D52QDMK 00644000
*     COMPARED TID: STATUS = WAITING FOR LOCKED RESOURCE       @D52QDMK 00645000
*     ENTRY R2: RESOURCE ON WHICH COMPARED TID IS WAITING)     @D52QDMK 00646000
*                                                              @D52QDMK 00647000
*   R4: CONTAINS RETURN CODE IF DEADLOCK                       @D52QDMK 00648000
*   R5: TID                                                    @D52QDMK 00649000
*   R7, R8,R9 ARE USED TO SCAN THE DEAD LOCK TEST TABLE        @D356DJO 00650000
*   R7: POINTER TO RESOURCE WHICH IS CHECKED                   @D356DJO 00651000
*   R8: POINTER TO NEXT FREE PLACE IN DLTT                     @D356DJO 00652000
*   R9: COMPARE REGISTER TO FIND DUPLICATE ENTRIES IN DLTT     @D356DJO 00653000
*   RC: POINTER TO OWNER/REQUEST ELEMENT                       @D52QDMK 00654000
*                                                              @D356DJO 00655000
***************************************************************@D149DIS 00656000
         SPACE 1                                               @D356DJO 00657000
SVC63F   EQU   *                                               @DA25110 00658000
         L     RC,LOCKCHN         POINT TO FIRST OWNER         @D356DJO 00659000
.**************************************************************@D52QDMK 00660000
.*  CHECK FIRST IF IT'S DEPENDENT OF MYSELF (LABELS SVC63F0.)  @D52QDMK 00661000
.**************************************************************@D52QDMK 00662000
SVC63F01 CLC   LCKUTID,LOKOTID    LOCKED BY MYSELF             @DA27378 00663000
         BNE   SVC63F05           NO,TRY NEXT RESOURCE         @D36SDJO 00664000
.**************************************************************@D52QDMK 00665000
.*  IF LOCKED BY MYSELF THEN IT'S A DEADLOCK, IF               @D52QDMK 00666000
.*  - REQUEST = E1                                             @D52QDMK 00667000
.*  - LOCK STATUS = E1                                         @D52QDMK 00668000
.*  - LOCK STATUS = E2 (WE ENTER HERE ONLY IF REQUEST WAS E2)  @D52QDMK 00669000
.**************************************************************@D52QDMK 00670000
         CLI   DTLFLG1,DTLOPT1+DTLEXC  E1 REQUESTED            @D36SDJO 00671000
         BE    SVC63F03           YES, CAN'T NEVER GET IT      @D36SDJO 00672000
         CLI   LOCKFLG1,DTLOPT1+DTLEXC  E1 LOCKED BY MYSELF    @D36SDJO 00673000
         BE    SVC63F03           YES, CANT NEVER GET IT       @D36SDJO 00674000
         CLI   LOCKFLG1,LOCKEXC+DTLOPT2 E2 LOCKED BY MYSELF    @D36SDJO 00675000
         BNE   SVC63F06           NO, NOT DEPENDENT ON MYSELF  @D36SDJO 00676000
SVC63F03 TM    LOCKPARM,NEWLOCK   LOCK SVC  (SVC110)           @D36SDJO 00677000
         BNO   SVC63G2            NO, GIVE USE RETURN CODE     @D36SDJO 00678000
.**************************************************************@D52QDMK 00679000
.*  SETUP RC 'ALREADY LOCKED BY ISSUING TASK'                  @D52QDMK 00680000
.**************************************************************@D52QDMK 00681000
         LA    R4,ERRDELO2        RETURN CODE (DEAD LOCK)      @D36SDJO 00682000
         SGCOV D52XDMK2                                        @D52XDMK 00683000
         CLC   DTLLENG(2),DTLLENGO IS THIS A OLD DTL           @D52XDMK 00684000
         BE    SVC63G4            YES, RETURN ERROR            @D52XDMK 00685000
         MVC   DTLECB3,LOCKFLG1   LOCK STATUS INTO ECB         @D52XDMK 00686000
         B     SVC63G4            RETURN ERROR INFORMATION     @D36SDJO 00687000
         SPACE 2                                               @D149DIS 00688000
.**************************************************************@D52QDMK 00689000
.*  LOOP THRU OWNER ELEMENTS                                   @D52QDMK 00690000
.**************************************************************@D52QDMK 00691000
SVC63F05 DS    0H                                              @D52QDMK 00692000
         L     RC,LOKOCHN         POINT TO NEXT OWNER ELEMENT  @D36SDJO 00693000
         LTR   RC,RC              END OF OWNER CHAIN           @D36SDJO 00694000
         BNZ   SVC63F01           NO,TRY NEXT OWNER            @D36SDJO 00695000
.**************************************************************@D52QDMK 00696000
.*  IF A REQUEST ELEMENT OF MYSELF EXISTS IT'S A DEADLOCK, IF  @D52QDMK 00697000
.*  - DTLADR IN REQUEST ELEMENT = DTLADR OF LOCK SVC           @D52QDMK 00698000
.**************************************************************@D52QDMK 00699000
SVC63F06 DS    0H                                              @D51UDMK 00700000
         L     RC,LOCKRQC         POINT TO FIRST REQUESTOR     @D51UDMK 00701000
SVC63F0X LTR   RC,RC              END OF REQUESTOR CHAIN       @D51UDMK 00702000
         BZ    SVC63F07           YES                          @D51UDMK 00703000
         CLC   LCKUTID,LOKOTID    REQUESTED BY MYSELF          @D51UDMK 00704000
         BNE   SVC63F0Y           NO, CONTINUE                 @D51UDMK 00705000
         CL    R1,LOKODTL         REQUESTED BY MYSELF          @D51UDMK 00706000
         BE    SVC63F03           YES, ERROR                   @D51UDMK 00707000
.**************************************************************@D52QDMK 00708000
.*  LOOP THRU REQUEST ELEMENTS                                 @D52QDMK 00709000
.**************************************************************@D52QDMK 00710000
SVC63F0Y L     RC,LOKOCHN         POINT TO NEXT REQUESTOR EL   @D51UDMK 00711000
         B     SVC63F0X           GO AND CHECK                 @D51UDMK 00712000
.**************************************************************@D52QDMK 00713000
.*  IF OWNER = PARTITION A DEADLOCK CANNOT BE PREDICTED        @D52QDMK 00714000
.*  EACH SUBTASK OF THE PARTITION CAN LOCK/UNLOCK RESOURCES    @D52QDMK 00715000
.**************************************************************@D52QDMK 00716000
SVC63F07 EQU   *                                               @DA25110 00717000
         TM    DTLFLG2,DTLPART    OWNER = PARTITION            @DA25110 00718000
         BO    SVC63M             YES, SKIP DEAD LOCK TEST     @DA25110 00719000
.**************************************************************@D52QDMK 00720000
.*  PREPARE FOR CYCLIC WAITING CHECK                           @D52QDMK 00721000
.**************************************************************@D52QDMK 00722000
         L     R7,ADLTT           DEAD LOCK TEST TABLE         @DY43802 00723000
         LR    R8,R7              NEXT FREE PLACE IN DELOTET   @DY43802 00724000
         BCTR  R7,0               DEAD LOCK TEST TABLE -1      @DY43802 00725000
         BCTR  R7,0               DEAD LOCK TEST TABLE -2      @DY43802 00726000
         LR    RE,R2              REQUESTED RESOURCE           @D356DJO 00727000
         DROP  R2                                              @D356DJO 00728000
         USING LOCKADR,RE                                      @D356DJO 00729000
         MVI   REQWORK,ZERO            *  SET E1REQ BIT, IF    @D356DJO 00730000
         TM    DTLFLG1,DTLEXC+DTLOPT1  *  LOCKOPT=1 AND        @D36SDJO 00731000
         BNO   SVC63F1                 *  CONTROL=E            @D36SDJO 00732000
         OI    REQWORK,E1REQ      LOCKOPT=1 AND CONTROL=E      @D36SDJO 00733000
.**************************************************************@D52QDMK 00734000
.*  CYCLIC WAITING CHECK:                                      @D52QDMK 00735000
.*  IF WE FIND A CYCLE WHERE WE FINALLY WAIT FOR A RESOURCE    @D52QDMK 00736000
.*  OWNED BY MYSELF TO BECOME FREE THEN WE CANNOT PUT THE      @D52QDMK 00737000
.*  ACTUAL TASK INTO WAIT                                      @D52QDMK 00738000
.**************************************************************@D52QDMK 00739000
.**************************************************************@D52QDMK 00740000
.*  1) GET THE FIRST OWNER OF RESOURCE                         @D52QDMK 00741000
.**************************************************************@D52QDMK 00742000
SVC63F1  L     RC,LOCKCHN         POINT TO FIRST OWNER         @D356DJO 00743000
SVC63F2  LTR   RC,RC              OWNER AVAILABLE              @D356DJO 00744000
.**************************************************************@D52QDMK 00745000
.*  2) IF END OF OWNER CHAIN REACHED, THEN TAKE NEXT RESOURCE  @D52QDMK 00746000
.**************************************************************@D52QDMK 00747000
         BE    SVC63F8            NO, CHECK NEXT DLTT ENTRY    @D356DJO 00748000
         TM    LOKOFLG,LOKOEXC    EXCLUSIVE OWNER              @D356DJO 00749000
         BNO   SVC63F7            NO, CHECK WHETHER WAITER     @D356DJO 00750000
.**************************************************************@D52QDMK 00751000
.*  3) IF EXCLUSIVELY OWNED THEN CHECK IF TIDS ARE MATCHING    @D52QDMK 00752000
.*     IF TIDS ARE EQUAL THEN DEADLOCK                         @D52QDMK 00753000
.**************************************************************@D52QDMK 00754000
SVC63F3  LH    R5,LOKOTID         TID OF OWNING TASK           @DA27378 00755000
         TM    SERVFLG,NOUSER     IS LOCK FOR REQUEST ELEMENT? @D52QDMK 00756000
         BO    SVC63FX            DON'T USE LOW CORE TID       @D52QDMK 00757000
         CH    R5,TID             COMPARE WITH ACTUAL TASK     @D36SDJO 00758000
         BE    SVC63G             YES, DEAD LOCK               @D36SDJO 00759000
         B     SVC63FY            CONTINUE TO GET OWNING TASK  @D52QDMK 00760000
SVC63FX  CH    R5,LCKUTID         COMPARE WITH ACTUAL TASK     @D52QDMK 00761000
         BE    SVC63G             YES, DEAD LOCK               @D52QDMK 00762000
.**************************************************************@D52QDMK 00763000
.*  4) TIDS DO NOT MATCH:                                      @D52QDMK 00764000
.*     CHECK IF OWNING TASK IS WAITING ON LOCKED RESOURCE      @D52QDMK 00765000
.**************************************************************@D52QDMK 00766000
SVC63FY  SLL   R5,2               MULTIPLY WITH 4              @D66ODOW 00767000
         AL    R5,ATIBATAB        ADDR WITHIN TIBATAB          @D66ODOW 00768000
         L     R5,0(,R5)          TIBPTR OF OWNING TASK        @D66ODOW 00769000
         USING TIBADR,R5                                       @D36SDJO 00770000
         CLI   TIBRQID,RURBND     IS OWNING TASK WAITING       @D14BDFR 00771000
         DROP  R5                                              @D14BDFR 00772000
         LH    R5,LOKOTID         RELOAD TID                   @DA27378 00773000
.**************************************************************@D52QDMK 00774000
.*  5) IF OWNER IS NOT WAITING ON LOCKED RESOURCE              @D52QDMK 00775000
.*     THEN CONTINUE WITH NEXT OWNER                           @D52QDMK 00776000
.**************************************************************@D52QDMK 00777000
         BNE   SVC63F6            NOT RESOURCE BOUND           @D356DJO 00778000
.**************************************************************@D52QDMK 00779000
.*  6) SCAN DEADLOCK TEST TABLE FOR THIS TID                   @D52QDMK 00780000
.*     IF TID IS NOT ALREADY THERE THEN INSERT IT              @D52QDMK 00781000
.**************************************************************@D52QDMK 00782000
         L     R9,ADLTT           SCAN DELOTET                 @DY43802 00783000
SVC63F4  CR    R9,R8              ALL DLTT ENTRIES CHECKED     @D356DJO 00784000
         BE    SVC63F5            YES, MOVE RESOURCE INTO DLTT @D356DJO 00785000
         CLC   LOKOTID,0(R9)      TASK ALREADY IN DLTT         @DA27378 00786000
         BE    SVC63F6            YES, NEED NOT TO ENTER       @D356DJO 00787000
         LA    R9,2(R9)           NEXT DLTT ENTRY              @D356DJO 00788000
         B     SVC63F4            YES, CHECK                   @D356DJO 00789000
         SPACE 2                                               @D149DIS 00790000
.**************************************************************@D52QDMK 00791000
.*  7) PUT TID IN DEADLOCK TEST TABLE                          @D52QDMK 00792000
.**************************************************************@D52QDMK 00793000
SVC63F5  STH   R5,0(R9)           MOVE ID OF DEPENDEND TASK    @D356DJO 00794000
         LA    R8,2(R8)           NEXT FREE PLACE IN DLTT      @D36SDJO 00795000
.**************************************************************@D52QDMK 00796000
.*  8) CONTINUE WITH NEXT OWNER IN OWNERCHAIN                  @D52QDMK 00797000
.**************************************************************@D52QDMK 00798000
SVC63F6  L     RC,LOKOCHN         POINT TO NEXT OWNER          @D356DJO 00799000
         B     SVC63F2            CHECK NEXT OWNER             @D356DJO 00800000
         SPACE 2                                               @D149DIS 00801000
.**************************************************************@D52QDMK 00802000
.*  9) WE ENTER HERE IF OWNER HAS NO EXCLUSIVE LOCK            @D52QDMK 00803000
.*     REQUEST MUST BE: E1 OR E2                               @D52QDMK 00804000
.*     LOCK STATUS CAN BE: S1 OR E2                            @D52QDMK 00805000
.*     (E1 WOULD HAVE ONLY 1 EXCLUSIVE OWNER)                  @D52QDMK 00806000
.*     (S2, E4 AND S4 DO NOT LEAD TO WAIT)                     @D52QDMK 00807000
.**************************************************************@D52QDMK 00808000
.**************************************************************@D52QDMK 00809000
.* 10) IF LOCK STATUS IS S1 THEN CHECK ALL OWNERS              @D52QDMK 00810000
.*     (ALL SHARED OWNERS MUST BE ABLE TO UNLOCK FIRST)        @D52QDMK 00811000
.**************************************************************@D52QDMK 00812000
SVC63F7  CLI   LOCKFLG1,LOCKEXC+DTLOPT2                        @D36SDJO 00813000
         BNE   SVC63F3            NOT LOCKED EXCL LOCKOPT2     @D356DJO 00814000
.**************************************************************@D52QDMK 00815000
.* 11) IF LOCK STATUS OF THAT RESOURCE = E2 AND REQUEST = E1   @D52QDMK 00816000
.*     THEN CHECK ALSO SHARED OWNERS                           @D52QDMK 00817000
.*     (LOCK STATUS AND REQUEST ARE NOT INCONSISTENT BECAUSE   @D52QDMK 00818000
.*      WE ARE LOOPING THRU SEVERAL LOCKTAB ENTRIES)           @D52QDMK 00819000
.**************************************************************@D52QDMK 00820000
         TM    REQWORK,E1REQ      REQUESTOR E1                          00821000
         BO    SVC63F3            YES, CHECK ALL OWNERS        @D356DJO 00822000
.**************************************************************@D52QDMK 00823000
.* 12) IF REQUEST = E2 THEN DEADLOCK DEPENDS NOT ON            @D52QDMK 00824000
.*     SHARED OWNERS -> TRY NEXT OWNER IN OWNER CHAIN          @D52QDMK 00825000
.**************************************************************@D52QDMK 00826000
         B     SVC63F6            TRY NEXT OWNER               @D36SDJO 00827000
.**************************************************************@D52QDMK 00828000
.* 13) IF ALL ENTRIES OF DEADLOCK TEST TABLE ARE CHECKED       @D52QDMK 00829000
.*     THEN LEAVE THE LOOP                                     @D52QDMK 00830000
.**************************************************************@D52QDMK 00831000
SVC63F8  LA    R7,2(R7)           NEXT ENTRY IN DLTT           @D356DJO 00832000
         CR    R7,R8              ALL ENTRIES CHECKED          @D356DJO 00833000
         BE    SVC63M             YES, O.K.                    @D356DJO 00834000
.**************************************************************@D52QDMK 00835000
.* 14) GET TID OF NEXT DEADLOCK TEST TABLE ENTRY               @D52QDMK 00836000
.*     GET POINTER TO LOCKTAB ENTRY FROM TIBSTATE (R5)         @D52QDMK 00837000
.*     GET POINTER TO LOCKTAB ENTRY FROM TIBSTATE (RE)         @D52QDMK 00838000
.*     GET THE REQUEST STATUS: IF BIT 7 IS 1 THEN EXCLUSIVE    @D52QDMK 00839000
.*                             IF BIT 7 IS 0 THEN SHARED       @D52QDMK 00840000
.*                             OTHER BITS ARE DON'T CARE       @D52QDMK 00841000
.**************************************************************@D52QDMK 00842000
         LH    R5,0(,R7)          TID                          @D66ODOW 00843000
         SLL   R5,2               MULTIPLY WITH 4              @D66ODOW 00844000
         AL    R5,ATIBATAB        ADDR WITHIN TIBATAB          @D66ODOW 00845000
         L     R5,0(,R5)          TIBPTR                       @D66ODOW 00846000
         USING TIBADR,R5                                       @D356DJO 00847000
         L     RE,TIBSTATE        RESOURCE WAITED UPON         @D37CDOW 00848000
         N     RE,E1TBSMSK        CLEAR POSSIBLE E1REQ FLAG    @DA27378 00849000
.**************************************************************@D52QDMK 00850000
.* 15) IF TASK IS WAITING FOR LOCKTAB ENTRIES TO BECOME FREE   @D52QDMK 00851000
.*     THEN IT'S NO CANDIDATE FOR DEADLOCK                     @D52QDMK 00852000
.**************************************************************@D52QDMK 00853000
         CL    RE,ALOKTABA        WAITING ON DUMMY RESOURCE    @DA27378 00854000
         BL    SVC63F8            YES, TRY NEXT DLTT ENTRY     @DA27378 00855000
         MVC   REQWORK,TIBSTATE+3 REQUEST STATUS OF TASK       @DA27378 00856000
         DROP  R5                                              @D36SDJO 00857000
         DROP  RE                                              @D356DJO 00858000
         USING LOCKADR,R2                                      @D356DJO 00859000
         B     SVC63F1            LOOP AROUND                  @D356DJO 00860000
         SPACE 2                                               @D149DIS 00861000
.**************************************************************@D52QDMK 00862000
.*  SET RETURNCODE TO 'DEADLOCK'                               @D52QDMK 00863000
.*     THEN IT'S NO CANDIDATE FOR DEADLOCK                     @D52QDMK 00864000
.**************************************************************@D52QDMK 00865000
SVC63G   LA    R4,ERRDELO1        NO.. SET RC:=16(DEADLOCK)    @D356DJO 00866000
         SGCOV D52XDMK2                                        @D52XDMK 00867000
         TM    LOCKPARM,NEWLOCK   NEW LOCK SVC                 @D356DJO 00868000
         BO    SVC63G4            YES                          @D356DJO 00869000
***************************************************************@D149DIS 00870000
*   HERE THE ERROR CONDITIONS FOR USE SVC ARE PROCESSED.       @D356DJO 00871000
***************************************************************@D149DIS 00872000
SVC63G1  L     R8,TCBSAVE         ADDRESS USER SAVE AREA       @D356DJO 00873000
         USING SVEARA,R8                                       @D35EDJO 00874000
         ST    R4,SVER00 .        STORE RETURN CODE IN R0               00875000
         BAL   R14,SV6364CN       UPDATE                       @D52XDMK 00876000
.**************************************************************@D52QDMK 00877000
.*  IF OPTION FAIL=WAIT THEN CANCEL USER TASK                  @D52QDMK 00878000
.*                      ELSE RETURN TO USER                    @D52QDMK 00879000
.**************************************************************@D52QDMK 00880000
         TM    LOCKPARM,WAITUFLG  FAIL=WAIT                             00881000
         USING DISP,R6                                         @D52QDMK 00882000
         BO    ERR2E              YES                          @D356DJO 00883000
         DROP  R8                                              @D35EDJO 00884000
         BR    R6                 GO TO TASK SELECTION                  00885000
         DROP  R6                                              @D52QDMK 00886000
         SPACE 1                                                        00887000
.**************************************************************@D52QDMK 00888000
.*  ENTRY POINT FOR USE SVC IN CASE OF                         @D52QDMK 00889000
.*  RESOURCE IS ALREADY OWNED BY ISSUING TASK/PARTITION        @D52QDMK 00890000
.**************************************************************@D52QDMK 00891000
SVC63G2  LA    R4,8               RETURN CODE =8 OR 12         @D356DJO 00892000
         CLC   DTLFLG1,LOCKFLG1   SAME CONTROL                 @D356DJO 00893000
         BE    SVC63G1            YES, R.C.=8                  @D356DJO 00894000
         LA    R4,4(R4)           NO, R.C.=12                  @D356DJO 00895000
         B     SVC63G1                                         @D356DJO 00896000
         SPACE 2                                               @D149DIS 00897000
***************************************************************@D149DIS 00898000
*  HERE THE RETURN CODES 16 AND 24 FOR LOCK SVC ARE PROCESSED. @D36SDJO 00899000
***************************************************************@D149DIS 00900000
SVC63G4  TM    LOCKPARM,NEWLOCK+LOCKSVC+CHECKFLG               @D51IDMK 00901000
         BOR   R6                 YES, EXIT TO CHECK ROUTINE   @D51IDMK 00902000
         L     R8,TCBSAVE         SAVE AREA ADDRESS            @D356DJO 00903000
         USING SVEARA,R8                                       @D356DJO 00904000
.**************************************************************@D52QDMK 00905000
.* IF IT'S A LOCK FOR A REQUEST ELEMENT                        @D52QDMK 00906000
.* THEN UPDATE ONLY THE RETURN CODE FIELD IN THE DTL           @D52QDMK 00907000
.* (THE DTL MUST HAVE LENGTH X'1E FOR THIS TYPE OF REQUEST)    @D52QDMK 00908000
.**************************************************************@D52QDMK 00909000
         TM    SERVFLG,NOUSER     IS LOCK FOR REQ. ELEMENT ?   @D52QDMK 00910000
         BO    SVC63G5            UPDATE ONLY RC IN DTL        @D51UDMK 00911000
         ST    R4,SVER0F          RETURN CODE IN RF (LOCK)     @D356DJO 00912000
         DROP  R8                                              @D356DJO 00913000
         CLC   DTLLENG(2),DTLLENGO OLD DTL?                    @D52QDMK 00914000
         BZ    SVC63G6            YES                          @D52QDMK 00915000
.**************************************************************@D52QDMK 00916000
.* UPDATE OF THE RETURN CODE IN THE DTL IS ONLY ALLOWED FOR    @D52QDMK 00917000
.* NEW DTL FORMATS (X'1E)                                      @D52QDMK 00918000
.**************************************************************@D52QDMK 00919000
SVC63G5  STC   R4,DTLRC           RETURN CODE IN DTL(LOCK)     @D52QDMK 00920000
SVC63G6  BAL   R14,SV6364CN       UPDATE                       @DY43697 00921000
         TM    LOCKPARM,WAITUFLG  FAIL=WAIT                    @D52XDMK 00922000
         BNOR  R6                 NO, EXIT TO DISP OR SVC110ZG @D52QDMK 00923000
         USING DISP,R6                                         @D52QDMK 00924000
         B     ERR2E                                           @D356DJO 00925000
         DROP  R6                                              @D52QDMK 00926000
         EJECT                                                 @D149DIS 00927000
         SPACE 2                                               @D149DIS 00928000
***************************************************************@D149DIS 00929000
*   THIS ROUTINE IS ENTERED, WHEN THE REQUESTED RESOURCE       @D356DJO 00930000
*   HAS NOT BEEN FOUND IN THE LOCKTAB.                         @D356DJO 00931000
*                                                              @D356DJO 00932000
***************************************************************@D149DIS 00933000
SVC63H   LTR   R2,R7              FREE ENTRY FOUND IN USED PART@D52QDMK 00934000
         BZ    SVC63L1            FAIL=WAIT DO DEADLOCK-DETECT @D37CDOW 00935000
.**************************************************************@D52QDMK 00936000
.* ENTRY POINT FROM SVC63C1 IN CASE OF LOCK FOR REQUEST ELEMENT@D52QDMK 00937000
.* AND NO OWNER FOR THIS RESOURCE                              @D52QDMK 00938000
.* GET A FREE OWNER ELEMENT                                    @D52QDMK 00939000
.**************************************************************@D52QDMK 00940000
SVC63H1  L     RC,LOKOFRL         GET ONE FREE ELEMENT         @D51UDMK 00941000
         LTR   RC,RC              DO WE GET ONE                @D356DJO 00942000
         BNZ   SVC63H3            YES CONTINUE                 @D37CDOW 00943000
         BAL   R8,SV6364OE        GET NEW OWNER ELEMENTS       @D37CDOW 00944000
         LR    RC,R5              DO ADDR TO CORRECT REG       @D37CDOW 00945000
SVC63H3  EQU   *                                               @D37CDOW 00946000
         AIF   (NOT &BGDSHR).SHRLCK4                           @D36SDJO 00947000
.**************************************************************@D52QDMK 00948000
.* THIS SECTION IS FOR DASDSHR=YES                             @D52QDMK 00949000
.* THE RESOURCE CAN BE ALLOCATED WITHIN THIS SYSTEM            @D52QDMK 00950000
.* CHECK THE EXTERNAL LOCK FILE IF THE RESOURCE IS NOT USED    @D52QDMK 00951000
.* BY ANOTHER SYSTEM                                           @D52QDMK 00952000
.**************************************************************@D52QDMK 00953000
.**************************************************************@D52QDMK 00954000
.* IF NO EXTERNAL LOCKING IS SPECIFIED THEN TREAT INTERNALLY   @D52QDMK 00955000
.* EXTERNAL LOCKING: SCOPE = EXT OR VOLID = XXXXXX             @D52QDMK 00956000
.**************************************************************@D52QDMK 00957000
         TM    DTLFLG2,DTLVOL+DTLEXTR    EXTERNAL LOCKING      @D36SDJO 00958000
         BZ    LCKM19             NO,DONT ACTIVATE SYSTEM TASK @D36SDJO 00959000
         TM    DLFFLG1,DLFINT     EXTERNAL FILE INITIALIZED    @D36SDJO 00960000
         BNO   LCKM19             NO, PROCESS LOCK INTERNALLY  @D36SDJO 00961000
LCKM01   TM    DTLFLG2,DTLVOL     VOLID SPECIFIED              @D36SDJO 00962000
         BNO   LCKM06             NO                           @D36SDJO 00963000
.**************************************************************@D52QDMK 00964000
.* CASE: VOLID IS SPECIFIED                                    @D52QDMK 00965000
.* SCAN VCT ENTRIES FOR THIS VOLID                             @D52QDMK 00966000
.* IF VOLID IS FOUND AND DASD IS SHARED THEN ACCESS LOCK FILE  @D52QDMK 00967000
.* IF DASD NOT SHARED THE PROCESS INTERNALLY                   @D52QDMK 00968000
.* IF VOLID NOT FOUND THEN SET RETURNCODE 'VOLUME NOT MOUNTED' @D52QDMK 00969000
.**************************************************************@D52QDMK 00970000
         L     R3,BASESERI        BASE REG OF GETVCE ROUTINE   @D36SDJO 00971000
         USING SGSERI,R3                                       @D36SDJO 00972000
         L     R4,AAVRTAB         AVR TABLE ADDRESS            @D36SDJO 00973000
         USING VCTEADR,R4         VCTE BASE POINTER            @D36SDJO 00974000
         LH    R5,AVRCOUNT        NUMBER OF ENTRIES IN VCTE TAB@D36SDJO 00975000
LCKM02   TM    VCTAFLG,VCTAFOP+VCTARDY OPERATIONAL+READY       @D36SDJO 00976000
         BNO   LCKM04             NO, PROCESS NEXT ENTRY       @D36SDJO 00977000
         CLC   VCTAVOL1,DTLVOLID  DO VOLIDS MATCH              @D36SDJO 00978000
         BNE   LCKM04             NO, PROCESS NEXT ENTRY       @D36SDJO 00979000
         TM    VCTAFLAG,VCTASHR   SHARED DASD                  @D36SDJO 00980000
         BO    LCKM06             YES, PROCESS EXTERNAL        @D36SDJO 00981000
         B     LCKM19             NO, PROCESS INTERNAL         @D36SDJO 00982000
         SPACE 2                                               @D149DIS 00983000
.**************************************************************@D52QDMK 00984000
.* PROCEED TO NEXT VCT ENTRY                                   @D52QDMK 00985000
.**************************************************************@D52QDMK 00986000
LCKM04   AH    R4,VCTELEN         NEXT ENTRY                   @D36SDJO 00987000
         BCT   R5,LCKM02          LOOP AROUND                  @D36SDJO 00988000
         LA    R4,ERRNOVOL        RETURN VOLID NOT FOUND       @D36SDJO 00989000
         SGCOV D52XDMK2                                        @D52XDMK 00990000
         B     SVC63N2            RETURN CODE TO USER          @D36SDJO 00991000
         DROP  R3                 RELEASE SGSERI BASE          @D36SDJO 00992000
         DROP  R4                 RELEASE VCTE BASE POINTER    @D36SDJO 00993000
         SPACE 2                                               @D149DIS 00994000
.**************************************************************@D52QDMK 00995000
.* ENTRY POINT FOR ACCESS TO LOCK FILE                         @D52QDMK 00996000
.* ACTIVATE SYSTEM TASK                                        @D52QDMK 00997000
.* RETRUN (0) = ACTIVATION UNSUCCESSFUL                        @D52QDMK 00998000
.* RETRUN (4) = ACTIVATION DONE                                @D52QDMK 00999000
.**************************************************************@D52QDMK 01000000
LCKM06   BAL   RF,LCKACT          ACTIVATE SYSTEM TASK         @D36SDJO 01001000
         B     SVC63P2            I/O ERROR ON EXT. FILE       @D36SDJO 01002000
         LA    R3,DTLNAME         POINT TO RESOURCE NAME       @D36SDJO 01003000
.**************************************************************@D52QDMK 01004000
.* CALCULATE THE DISK BLOCK NUMBER FOR READ LOCK FILE          @D52QDMK 01005000
.**************************************************************@D52QDMK 01006000
         BAL   RF,LCKHASH         CALCULATE DISK BLOCK NUMBER  @D36SDJO 01007000
*SGLINK  LCKHASH,INPUT=(R3,RF),WORK=(R3,R4,R5),OUTPUT=R9       @D36SDJO 01008000
.**************************************************************@D52QDMK 01009000
.* READ DISK BLOCK                                             @D52QDMK 01010000
.* RETRUN (0) = BLOCK NOT FOUND                                @D52QDMK 01011000
.* RETRUN (4) = BLOCK FOUND, CAN CHECK IT NOW                  @D52QDMK 01012000
.**************************************************************@D52QDMK 01013000
         BAL   RF,LCKGET          READ DISK BLOCK              @D36SDJO 01014000
*SGLINK  LCKGET,INPUT=(R9,RF),WORK=(R0,R3,R5,R7,RE),OUTPUT=R4           01015000
         B     LCKM23             I/O ERROR OR DESTROYED FILE  @D36SDJO 01016000
         LA    R3,DTLNAME         POINT TO RESOURCE NAME       @D36SDJO 01017000
.**************************************************************@D52QDMK 01018000
.* SCAN THE DISK BLOCK FOR RESOURCE NAME                       @D52QDMK 01019000
.* RETRUN (0) = BLOCK HAS NOT LOCK FILE FORMAT                 @D52QDMK 01020000
.* RETRUN (4) = RESOURCE NAME FOUND                            @D52QDMK 01021000
.* RETRUN (8) = RESOURCE NAME NOT FOUND                        @D52QDMK 01022000
.**************************************************************@D52QDMK 01023000
         BAL   RF,LCKSCAN         FIND LOCK ENTRY IN BLOCK     @D36SDJO 01024000
*SGLINK  LCKSCAN,INPUT=(R3,R4,RF),WORK=(R5),OUTPUT=(R4)                 01025000
         B     LCKM23             DESTROYED EXTERNAL FILE      @D36SDJO 01026000
         B     LCKM30             NAME FOUND IN EXT FILE       @D36SDJO 01027000
         L     R4,DLFAREA         I/O AREA ADDRESS             @D36SDJO 01028000
.**************************************************************@D52QDMK 01029000
.* IF NO SPACE ON DISKBLOCK THEN                               @D52QDMK 01030000
.* IF FAIL=WAIT THEN TRY TO WAIT FOR FREE BLOCK SPACE          @D52QDMK 01031000
.* ELSE SET RETURNCODE 'SPACE EXHAUSTED ON EXTERNAL  LOCK FILE'@D52QDMK 01032000
.**************************************************************@D52QDMK 01033000
         LH    R5,2(R4)           NUMBER OF ACTIVE ENTRIES     @D36SDJO 01034000
         CH    R5,DLFNENT         MAXIMUM NUMBER EXCEEDED      @D36SDJO 01035000
         BL    LCKM09             NO, ENTER THIS ONE           @D36SDJO 01036000
         TM    LOCKPARM,WAITUFLG  FAIL=WAIT                    @D36SDJO 01037000
         BO    LCKDL1             YES, CHECK FOR DEAD LOCK     @D36SDJO 01038000
         SGCOV D52XDMK2                                        @D52XDMK 01039000
         BAL   RF,LCKDEACT        DEACTIVATE SYSTEM TASK       @DY45915 01040000
         LA    R4,ERREXTSP        R.C. FOR EXTERNAL SPACE      @D36SDJO 01041000
         B     SVC63M1            RETURN TO USER               @DY45915 01042000
         EJECT                                                 @D149DIS 01043000
         SPACE 2                                               @D149DIS 01044000
***************************************************************@D149DIS 01045000
*   THIS PART ONLY FOR FAIL=WAIT:                              @D52QDMK 01046000
*   CHECK FOR DEAD LOCK (WHEN EXTERNAL SPACE IS EXHAUSTED).    @D36SDJO 01047000
*   IF ALL RESOURCES OF THIS BLOCK ARE OWNED BY THE ISSUING    @D36SDJO 01048000
*   TASK OR BY A RESOURCE-BOUND TASK OF THIS CPU,              @D36SDJO 01049000
*   A DEAD LOCK IS DETECTED.                                   @D36SDJO 01050000
*   NOTE THAT ONLY THOSE DEAD LOCKS ARE DETECTED, WHICH ARE             01051000
*   CAUSED BY ACTIONS OF ONE SYSTEM.                                    01052000
***************************************************************@D149DIS 01053000
LCKDL1   L     R2,ALOKTABA        START OF LOCKTAB             @D36SDJO 01054000
         XC    LCKCNT,LCKCNT      CLEAR COUNT FIELD            @D36SDJO 01055000
         ST    R9,SAVEHASH        SAVE BLOCK NUMBER FROM HASH  @D36SDJO 01056000
LCKDL2   TM    LOCKFLG2,LOCKUSED+LOCKEXT   EXTERNAL LOCK       @D36SDJO 01057000
         BNO   LCKDL7             NO, TRY NEXT                 @D36SDJO 01058000
         LA    R3,LOCKRESN        RESOURCE NAME FOR HASHING    @D36SDJO 01059000
         BAL   RF,LCKHASH         FIND BLOCK NUMBER            @D36SDJO 01060000
         C     R9,SAVEHASH        SAME BLOCK                   @D36SDJO 01061000
         BNE   LCKDL7             NO, TRY NEXT RESOURCE        @D36SDJO 01062000
         L     RC,LOCKCHN         POINT TO OWNER ELEMENTS      @D36SDJO 01063000
LCKDL3   LTR   RC,RC              ALL OWNERS CHECKED           @D36SDJO 01064000
         BZ    LCKM07             YES, RES. WILL BECOME FREE   @D36SDJO 01065000
         LH    R5,LOKOTID         TID OF OWNING TASK           @DA27378 01066000
         SLL   R5,2               MULTIPLY WITH 4              @D66ODOW 01067000
         AL    R5,ATIBATAB        ADDR WITHIN TIBATAB          @D66ODOW 01068000
         L     R5,0(,R5)          TIBPTR                       @D66ODOW 01069000
         USING TIBADR,R5                                       @D36IDJO 01070000
         CLI   TIBRQID,RURBND     IS OWNING TASK WAITING       @D14BDFR 01071000
         LH    R5,LOKOTID         TID OF OWNING TASK           @DA27378 01072000
         DROP  R5                                              @D36SDJO 01073000
         BE    LCKDL6             YES                          @D36SDJO 01074000
         CH    R5,LCKUTID         IS RESOURCE OWNED BY ME      @D36SDJO 01075000
         BE    LCKDL6             YES, TRY NEXT ENTRY          @D36SDJO 01076000
         L     RC,LOKOCHN         NEXT OWNER ELEMENT           @D36SDJO 01077000
         B     LCKDL3             LOOP AROUND                  @D36SDJO 01078000
LCKDL6   LH    R5,LCKCNT          * COUNT ALL RESOURCES WHICH  @D36SDJO 01079000
         LA    R5,1(R5)           * ARE OWNED BY ME OR WHOSE   @D36SDJO 01080000
         STH   R5,LCKCNT          * OWNER IS RESOURCE BOUND    @D36SDJO 01081000
LCKDL7   L     R2,LOCKPTR         NEXT LOCKTAB ENTRY           @D14CDOW 01082000
         LTR   R2,R2              END OF LOCKTAB               @D37CDOW 01083000
         BNZ   LCKDL2             NO                           @D37CDOW 01084000
         LH    R5,LCKCNT          NUMBER OF 'BOUND' ENTRIES    @D36SDJO 01085000
         CH    R5,DLFNENT         MAX.NUMBER OF ENTRIES/BLOCK  @D36SDJO 01086000
         BL    LCKM07             NO DEAD LOCK DETECTED        @D36SDJO 01087000
.**************************************************************@D52QDMK 01088000
.* IN CASE OF DEADLOCK DEACTIVATE SYSTEM TASK AND SET          @D52QDMK 01089000
.* RETURN CODE 'DEADLOCK'                                      @D52QDMK 01090000
***************************************************************@D52QDMK 01091000
         BAL   RF,LCKDEACT        RETURN TO USER TASK STATUS   @D36SDJO 01092000
         B     SVC63G             DEAD LOCK                    @D36SDJO 01093000
         EJECT                                                 @D149DIS 01094000
         SPACE 2                                               @D149DIS 01095000
***************************************************************@D149DIS 01096000
*   END OF DEAD LOCK TEST                                      @D36SDJO 01097000
*   SET-UP A TIME INTERVAL FOR RE-ISSUING OF SVC               @D36SDJO 01098000
***************************************************************@D149DIS 01099000
LCKM07   L     R3,ALCKTIB         TIB POINTER OF SYSTEM TASK   @D36SDJO 01100000
         ICM   R4,B'1111',TIBITCHN-TIBADR(R3) TIMER SET FOR LCK@D64ADOW 01101000
         BNZ   LCKM075            YES, NO NEED TO SETIME       @D52QDMK 01102000
***************************************************************@D149DIS 01103000
*        SETIME ONE SECOND                                     @D36SDJO 01104000
***************************************************************@D149DIS 01105000
         LR    R4,R1              SAVE DTL POINTER             @D52QDMK 01106000
         LA    R1,300             LOAD  300*(2**8)             @D36SDJO 01107000
         SLL   R1,8               INTO REGISTER 1              @D36SDJO 01108000
         SVC   10                 SETIME                       @D36SDJO 01109000
         LR    R1,R4              RESTORE DTL POINTER          @D52QDMK 01110000
LCKM075  BAL   RF,LCKDLC          CALL EXTERNAL DEADLOCKCHECK  @D52QDMK 01111000
*SGLINK LCKDLC,INPUT=(RC,RF),WORK=(R0,R3,R4,R5,R7,R9,RE)       @D52QDMK 01112000
.**************************************************************@D52QDMK 01113000
.*  MARK 'TIMER SET'                                           @D52QDMK 01114000
.*  DEACTIVATE SYSTEM TASK                                     @D52QDMK 01115000
.*  SET TASK TO 'RESOURCE BOUND' ON TIBSTATE '0000000C'        @D52QDMK 01116000
.*  GO TO RESVC                                                @D52QDMK 01117000
.**************************************************************@D52QDMK 01118000
         USING MAPDTL,R1                                       @D52QDMK 01119000
LCKM08   OI    DSHRFLG,LCKTIM     TIMER SET FLAG               @D36SDJO 01120000
         BAL   RF,LCKDEACT        DEACTIVATE SYSTEM TASK       @D36SDJO 01121000
         LA    R1,DISEX1          WAIT FOR EXTERNALLY LOCKED   @D36SDJO 01122000
         B     SVC63X             WAIT WITHOUT DEAD LOCK TEST  @DA27378 01123000
         EJECT                                                 @D149DIS 01124000
         SPACE 2                                               @D149DIS 01125000
***************************************************************@D149DIS 01126000
*   INSERT NEW ENTRY INTO EXTERNAL BLOCK                       @D36SDJO 01127000
*   INCREASE COUNTER FOR NUMBER OF ENTRIES                     @D52QDMK 01128000
*   WRITE RESOURCE NAME AND DTLFLG1 INTO OUR CPUFIELD          @D52QDMK 01129000
***************************************************************@D149DIS 01130000
LCKM09   LA    R5,1(R5)           N = N+1                      @D36SDJO 01131000
         STH   R5,2(R4)           UPDATE NUMBER OF ENTRIES     @D36SDJO 01132000
         BCTR  R5,0               N+1 -> N                     @D36SDJO 01133000
         MH    R5,DLFLENT         LENGTH OF ONE ENTRY          @D36SDJO 01134000
         LA    R5,4(R4,R5)        FIRST FREE LOCATION          @D36SDJO 01135000
         MVC   0(L'LOCKRESN,R5),DTLNAME MOVE RESOURCE NAME     @D36SDJO 01136000
         LH    RF,DLFNCPUS        NUMBER OF CPU FIELDS         @D36SDJO 01137000
         BCTR  RF,0               SUBTRACT ONE FOR EXECUTE     @D36SDJO 01138000
         EX    RF,LCKCLEAR        CLEAR CPU FIELDS             @D36SDJO 01139000
         AH    R5,DLFINDEX        OUR CPU                      @D36SDJO 01140000
LCKM11   MVC   L'LOCKRESN(1,R5),DTLFLG1    CNTRL FLAGS         @D36SDJO 01141000
.**************************************************************@D52QDMK 01142000
.*  WRITE DISK BLOCK BACK TO LOCK FILE                         @D52QDMK 01143000
.*  RETURN (0) = WRITE WAS NOT SUCCESSFUL                      @D52QDMK 01144000
.*  RETURN (4) = WRITE DONE                                    @D52QDMK 01145000
.**************************************************************@D52QDMK 01146000
LCKM16   BAL   RF,LCKPUT          WRITE BACK DISK BLOCK        @D36SDJO 01147000
*SGLINK  LCKPUT,INPUT=(RF),WORK=(R3)                           @D36SDJO 01148000
         B     LCKM23             IRRECOVERABLE I/O ERROR      @D36SDJO 01149000
.**************************************************************@D52QDMK 01150000
.*  CHECK FOR EXTERNAL DEADLOCK SITUATION:                     @D52QDMK 01151000
.*  CLEAR BUFFER                                               @D52QDMK 01152000
.**************************************************************@D52QDMK 01153000
         TM    LOCKPARM,WAITEFLG  IF WAITECB THEN              @DA43446 01154000
         BO    LCKM17             NO TCBWAREA UPDATE           @DA43446 01155000
         XC    TCBWAREA(BUFSLOT+1),TCBWAREA  GIVE UP THIS ENTRY@D52QDMK 01156000
LCKM17   BAL   RF,LCKDEACT        DEACTIVATE SYSTEM TASK       @D52QDMK 01157000
         OI    LOCKFLG2,LOCKEXT   SET EXTERNAL FLAG            @D36SDJO 01158000
LCKM19   EQU   *                                               @D36SDJO 01159000
.SHRLCK4 ANOP                                                  @D36SDJO 01160000
***************************************************************@D149DIS 01161000
*   ENTER NEW ENTRY INTO LOCKTAB                               @D36SDJO 01162000
*   - RESOURCE NAME                                            @D52QDMK 01163000
*   - LOCKOPTIONS                                              @D52QDMK 01164000
*   - USED ENTRY                                               @D52QDMK 01165000
*   - POINTER TO NEW OWNER ELEMENT                             @D52QDMK 01166000
*  (- OWNER = PARTITION)                                       @D52QDMK 01167000
***************************************************************@D149DIS 01168000
         MVC   LOCKRESN,DTLNAME   PUT NAME PARAM INTO LOCKTAB           01169000
         MVC   LOCKFLG1,DTLFLG1   LOCKOPT+ EXC FLAG            @D356DJO 01170000
         OI    LOCKFLG2,LOCKUSED  SET IN USE,                  @D356DJO 01171000
         ST    RC,LOCKCHN         AND CHAIN IT TO RESOURCE     @D356DJO 01172000
         TM    DTLFLG2,DTLPART    OWNER=PARTITION              @D36SDJO 01173000
         BNO   SVC63I             NO                           @D36SDJO 01174000
         OI    LOCKFLG2,LOCKPART  FLAG OWNERSHIP               @D36SDJO 01175000
         EJECT                                                          01176000
***************************************************************@D149DIS 01177000
*   INITIALIZE NEW OWNER ELEMENT                               @D356DJO 01178000
*   - CLEAR OWNER ELEMENT FORWARD POINTER                      @D52QDMK 01179000
*   - TID FROM LCKUTID                                         @D52QDMK 01180000
*   - EXCLUSIVE / SHARED OPTION                                @D52QDMK 01181000
*   - EXCLUSIVE / SHARED COUNTER = 1                           @D52QDMK 01182000
*  (- KEEP = YES)                                              @D52QDMK 01183000
*   UPDATE LOCKTAB ENTRY                                       @D52QDMK 01184000
*   - EXCLUSIVE COUNTER + 1                                    @D52QDMK 01185000
*   - EXCLUSIVE / SHARED OPTION                                @D52QDMK 01186000
***************************************************************@D149DIS 01187000
SVC63I   MVC   LOKOFRL,LOKOCHN    UPDATE FREE POINTER          @D356DJO 01188000
         XC    LOKOCHN,LOKOCHN    THIS ELEMENT IS LAST         @D356DJO 01189000
         MVC   LOKOTID(2),LCKUTID OWNER OF THIS ELEMENT        @DA27378 01190000
SVC63I1  TM    DTLFLG1,DTLEXC     EXCLUSIVE CONTROL REQ.       @D356DJO 01191000
         BNO   SVC63I4            NO, SHARED CONTROL           @D356DJO 01192000
         MVI   LOKOCNTE+1,1       ONE EXCLUSIVE USER           @D36SDJO 01193000
         LH    R4,LOCKCNTE        TOTAL NUMBER OF EXCL USERS   @D36SDJO 01194000
         LA    R4,1(R4)           ADD ONE                      @D36SDJO 01195000
         STH   R4,LOCKCNTE        UPDATE                       @D36SDJO 01196000
         OI    LOKOFLG,LOKOEXC    FLAG OWNER ELEMENT           @D356DJO 01197000
         OI    LOCKFLG1,LOCKEXC   SUMMARY CONTROL BYTE         @D356DJO 01198000
         B     SVC63I5                                         @D356DJO 01199000
SVC63I4  MVI   LOKOCNTS+1,1       ONE SHARED USER              @D356DJO 01200000
SVC63I5  TM    DTLFLG2,DTLKEEP    KEEP=YES                     @D356DJO 01201000
         BNO   SVC63K             NO                           @D356DJO 01202000
         OI    LOKOFLG,LOKOKEEP   SET KEEP FLAG ON             @D356DJO 01203000
.**************************************************************@D52QDMK 01204000
.*  SET RETURNCODE 'SUCCESSFUL' AND RETURN TO USER             @D52QDMK 01205000
.**************************************************************@D52QDMK 01206000
SVC63K   XR    R4,R4              RETURN CODE EQUAL ZERO       @D356DJO 01207000
         L     R8,TCBSAVE         ADDRESS USER SAVE AREA       @D36SDJO 01208000
         TM    LOCKPARM,NEWLOCK   SVC 110 (LOCK)               @D356DJO 01209000
         BNO   SVC63M3           STORE RETURN CODE IN R0 (USE)          01210000
         B     SVC63M4            YES                          @D356DJO 01211000
         EJECT                                                 @D149DIS 01212000
         SPACE 2                                               @D149DIS 01213000
.**************************************************************@D52QDMK 01214000
.*  IF FAIL=WAIT IS SPECIFIED THEN WE TRY TO WAIT FOR SPACE    @D52QDMK 01215000
.*  TO BECOME FREE. A DEADLOCK TEST IS PREFORMED.              @D52QDMK 01216000
.*  ELSE RETURNCODE 'LOCKTAB SPACE EXHAUSTED' IS SET AND       @D52QDMK 01217000
.*  CONTROL IS PASSED BACK TO THE USER.                        @D52QDMK 01218000
.**************************************************************@D52QDMK 01219000
SVC63L   L     R2,ALOCKELM        WAIT FOR FREE OWNER ELEMENT  @D356DJO 01220000
         B     SVC63L2                                         @D356DJO 01221000
SVC63L1  L     R2,ALOCKSPC        WAIT FOR LOCKTAB SPACE       @D356DJO 01222000
SVC63L2  LA    R4,ERRINTSP        SET RC:=8                    @D36SDJO 01223000
         SGCOV D52XDMK2                                        @D52XDMK 01224000
         TM    LOCKPARM,WAITUFLG   FAIL=WAIT                   @D356DJO 01225000
         BO    SVC63Q             YES, TEST FOR DEAD LOCK               01226000
         B     SVC63M2                                                  01227000
.**************************************************************@D52QDMK 01228000
.*  ENTRY FOR RETURNCODE 4 'RESOURCE OWNED BY OTHER TASK'      @D52QDMK 01229000
.**************************************************************@D52QDMK 01230000
SVC63M   LA    R4,4               SET R.C. = 4                 @D356DJO 01231000
         SGCOV D52XDMK2                                        @D52XDMK 01232000
.**************************************************************@D52QDMK 01233000
.*  IF CALLER WAS DEADLOCKCHECK THEN DON'T UPDATE SAVEAREA     @D52QDMK 01234000
.**************************************************************@D52QDMK 01235000
SVC63M1  TM    LOCKPARM,NEWLOCK+LOCKSVC+CHECKFLG               @DY45915 01236000
         BOR   R6                 YES, EXIT TO CHECK ROUTINE   @D51IDMK 01237000
.**************************************************************@D52QDMK 01238000
.*  IF FAIL=WAIT OR FAIL=WAITC THEN CHECK IF WAITING DOES NOT  @D52QDMK 01239000
.*  LEAD TO DEADLOCK                                           @D52QDMK 01240000
.**************************************************************@D52QDMK 01241000
         TM    LOCKPARM,WAITUFLG+WAITCFLG          WAIT/WAITC/          01242000
         BNZ   SVC63Q             YES, TEST FOR DEAD LOCK      @D36SDJO 01243000
.**************************************************************@D52QDMK 01244000
.*  IF FAIL=WAITECB THEN ALLOCATE THE REQUEST ELEMENT AND      @D52QDMK 01245000
.*  RETURN TO USER                                             @D52QDMK 01246000
.**************************************************************@D52QDMK 01247000
         TM    LOCKPARM,WAITEFLG                   WAITECB     @D51UDMK 01248000
         BNZ   SVC63Y             YES, ALLOCATE REQUEST ELEMENT@D51UDMK 01249000
.**************************************************************@D52QDMK 01250000
.*  ENTRY FOR RETURNCODE 8 'LOCKTAB SPACE EXHAUSTED'           @D52QDMK 01251000
.*  ENTRY FOR RETURNCODE 4 IN CASE OF FAIL=WAITECB             @D52QDMK 01252000
.**************************************************************@D52QDMK 01253000
SVC63M2  L     R8,TCBSAVE         ADDRESS USER SAVE AREA       @D36SDJO 01254000
         USING SVEARA,R8                                       @D356DJO 01255000
         TM    LOCKPARM,NEWLOCK   NEW LOCK SVC                 @D356DJO 01256000
         BO    SVC63M4            YES                          @D356DJO 01257000
         LA    R4,4                                            @D356DJO 01258000
         SGCOV D52XDMK2                                        @D52XDMK 01259000
.**************************************************************@D52QDMK 01260000
.*  ENTRY FOR RETURNCODE 0 'SUCCESSFUL' SVC63 USE              @D52QDMK 01261000
.**************************************************************@D52QDMK 01262000
SVC63M3  ST    R4,SVER00          RETURN CODE IN R0 (USE)      @D36SDJO 01263000
         BAL   R14,SV6364CN       UPDATE                       @D52XDMK 01264000
         BR    R6                 EXIT TO DISP OR SVC110ZG     @D52QDMK 01265000
.**************************************************************@D52QDMK 01266000
.*  ENTRY FOR RETURNCODE 0 'SUCCESSFUL' SVC110 LOCK            @D52QDMK 01267000
.**************************************************************@D52QDMK 01268000
.**************************************************************@D52QDMK 01269000
.* IF IT'S A LOCK FOR A REQUEST ELEMENT                        @D52QDMK 01270000
.* THEN UPDATE ONLY THE RETURN CODE FIELD IN THE DTL           @D52QDMK 01271000
.* (THE DTL MUST HAVE LENGTH X'1E FOR THIS TYPE OF REQUEST)    @D52QDMK 01272000
.**************************************************************@D52QDMK 01273000
SVC63M4  DS    0H                                              @D356DJO 01274000
         TM    SERVFLG,NOUSER     IS LOCK FOR REQ. ELEMENT?    @D52QDMK 01275000
         BO    SVC63M5            UPDATE ONLY RC IN DTL        @D51UDMK 01276000
         ST    R4,SVER0F          RETURN CODE IN R15 (LOCK)    @D356DJO 01277000
.**************************************************************@D52QDMK 01278000
.* UPDATE OF THE RETURN CODE IN THE DTL IS ONLY ALLOWED FOR    @D52QDMK 01279000
.* NEW DTL FORMATS (X'1E)                                      @D52QDMK 01280000
.**************************************************************@D52QDMK 01281000
         CLC   DTLLENG(2),DTLLENGO OLD DTL?                    @D52QDMK 01282000
         BZ    SVC63M6            YES                          @D52QDMK 01283000
SVC63M5  STC   R4,DTLRC           RETURN CODE IN DTL(LOCK)     @D52QDMK 01284000
         DROP  R8                                              @D356DJO 01285000
SVC63M6  BAL   R14,SV6364CN       UPDATE                       @DY43697 01286000
         BR    R6                 EXIT TO DISP OR SVC110ZG     @D52QDMK 01287000
         EJECT                                                 @D149DIS 01288000
         SPACE 2                                               @D149DIS 01289000
***************************************************************@D149DIS 01290000
*   ENTER HERE WHEN LOCKING REQUEST IS INCONSISTENT            @D356DJO 01291000
*   WITH LOCKING STATUS OF THE RESOURCE.                       @D356DJO 01292000
*                                                              @D356DJO 01293000
*   WHEN FAIL=RETURN OR FAIL=WAITC IS SPECIFIED,                        01294000
*   CONTROL IS RETURNED TO THE USER (R.C.=12).                          01295000
*   WHEN FAIL=WAIT IS SPECIFIED OR IF THE SVC63 IS                      01296000
*   AN OLD USE REQUEST, THE TASK IS CANCELED.                  @D356DJO 01297000
***************************************************************@D149DIS 01298000
SVC63N   TM    LOCKPARM,NEWLOCK NEW OR OLD SVC                 @D356DJO 01299000
         USING DISP,R6                                         @D52QDMK 01300000
         BNO   ERR21          CANCEL IF OLD USE SVC            @D356DJO 01301000
         DROP  R6                                              @D52QDMK 01302000
.**************************************************************@D52QDMK 01303000
.*  ENTRY FOR RETURNCODE 12 'INCONSISTENT REQUEST'             @D52QDMK 01304000
.**************************************************************@D52QDMK 01305000
SVC63N1  LA    R4,ERRINCON    RETURN CODE                      @D356DJO 01306000
         SGCOV D52XDMK2                                        @D52XDMK 01307000
.**************************************************************@D52QDMK 01308000
.*  ENTRY FOR RETURNCODE 32 'VOLUME NOT MOUNTED'               @D52QDMK 01309000
.**************************************************************@D52QDMK 01310000
SVC63N2  L     R8,TCBSAVE     SAVE AREA ADDRESS                @D356DJO 01311000
         USING SVEARA,R8                                       @D356DJO 01312000
         TM    SERVFLG,NOUSER     IS LOCK FOR REQ. ELEMENT?    @D52QDMK 01313000
         BO    SVC63N5            UPDATE ONLY RC IN DTL        @D51UDMK 01314000
         ST    R4,SVER0F      STORE RETURN CODE                @D356DJO 01315000
.**************************************************************@D52QDMK 01316000
.* UPDATE OF THE RETURN CODE IN THE DTL IS ONLY ALLOWED FOR    @D52QDMK 01317000
.* NEW DTL FORMATS (X'1E)                                      @D52QDMK 01318000
.**************************************************************@D52QDMK 01319000
         CLC   DTLLENG(2),DTLLENGO OLD DTL?                    @D52QDMK 01320000
         BZ    SVC63N6            YES                          @D52QDMK 01321000
.**************************************************************@D52QDMK 01322000
.* UPDATE OF THE RETURN CODE IN THE DTL IS ONLY ALLOWED FOR    @D52QDMK 01323000
.* NEW DTL FORMATS (X'1E)                                      @D52QDMK 01324000
.**************************************************************@D52QDMK 01325000
SVC63N5  STC   R4,DTLRC           RETURN CODE IN DTL(LOCK)     @D52QDMK 01326000
         DROP  R8                                              @D356DJO 01327000
SVC63N6  BAL   R14,SV6364CN       UPDATE                       @DY43697 01328000
         TM    LOCKPARM,WAITUFLG  FAIL=WAIT                    @D52XDMK 01329000
         BNOR  R6             NO,  EXIT TO DISP OR SVC110ZG    @D52QDMK 01330000
         USING DISP,R6                                         @D52QDMK 01331000
         B     ERR21          CANCEL                           @D356DJO 01332000
         DROP  R6                                              @D52QDMK 01333000
         EJECT                                                 @D149DIS 01334000
         SPACE 2                                               @D149DIS 01335000
***************************************************************@D149DIS 01336000
*   CHECK FOR DEAD LOCKS IF SUPERVISOR SPACE IS EXHAUSTED.              01337000
*   HERE TWO DIFFERENT CONDITIONS ARE HANDLED:                 @D356DJO 01338000
*   (1) WAITING FOR A FREE OWNER ELEMENT                       @D356DJO 01339000
*   (2) WAITING FOR FREE LOCKTAB SPACE                         @D356DJO 01340000
*                                                              @D356DJO 01341000
***************************************************************@D149DIS 01342000
         SPACE 2                                               @D356DJO 01343000
***************************************************************@D149DIS 01344000
*   WAITING FOR AN OWNER ELEMENT TO BECOME FREE.                        01345000
*                                                              @D356DJO 01346000
*   SETTING A TASK INTO WAIT STATE FOR A FREE OWNER ELEMENT    @D356DJO 01347000
*   IS POSSIBLE, IF AT LEAST ONE ELEMENT IS FOUND              @D356DJO 01348000
*   WHOSE OWNING TASK IS NOT RESOURCE BOUND.                   @D356DJO 01349000
***************************************************************@D149DIS 01350000
         DROP  R2                                              @D356DJO 01351000
         USING LOCKADR,RE                                      @D356DJO 01352000
SVC63Q   L     RE,ALOCKELM        DUMMY ENTRY FOR ELEMENTS     @D356DJO 01353000
         TM    LOCKFLG2,LOCKWAIT  WAITING FOR OWNER ELEMENTS   @D356DJO 01354000
         BO    SVC63Q1            YES, CHECK FOR D.L.          @D356DJO 01355000
         CR    R2,RE              THIS TASK WAITING FOR ELEM   @D356DJO 01356000
         BNE   SVC63R             NO, CHECK OTHER TYPE OF D.L. @D356DJO 01357000
SVC63Q1  L     RE,ALOKTABA        START OF LOCKTAB             @D356DJO 01358000
SVC63Q2  TM    LOCKFLG2,LOCKUSED  VALID ENTRY                  @D356DJO 01359000
         BNO   SVC63Q6            NO, TRY NEXT                 @D356DJO 01360000
         L     RC,LOCKCHN         OWNER ELEMENT                @D356DJO 01361000
SVC63Q3  LTR   RC,RC              ALL OWNERS CHECKED           @D356DJO 01362000
         BZ    SVC63Q6            YES, TRY NEXT RESOURCE       @D356DJO 01363000
         LH    R5,LOKOTID         TID OF OWNING TASK           @DA27378 01364000
         SLL   R5,2               MULTIPLY WITH 4              @D66ODOW 01365000
         AL    R5,ATIBATAB        ADDR WITHIN TIBATAB          @D66ODOW 01366000
         L     R5,0(,R5)          TIBPTR                       @D66ODOW 01367000
         USING TIBADR,R5                                       @D36IDJO 01368000
         CLI   TIBRQID,RURBND     IS OWNING TASK WAITING       @D14BDFR 01369000
         LH    R5,LOKOTID         TID OF OWNING TASK           @DA27378 01370000
         BNE   SVC63Q7            NO, CHECK FOR SAME TASK      @D14BDIS 01371000
         DROP  R5                                              @D356DJO 01372000
SVC63Q4  L     RC,LOKOCHN         CHECK NEXT OWNER             @D356DJO 01373000
         B     SVC63Q3                                         @D356DJO 01374000
SVC63Q6  L     RE,LOCKPTR         NEXT LOCKTAB ENTRY           @D37CDOW 01375000
         LTR   RE,RE              DID WE GOT ONE               @D37CDOW 01376000
         BNZ   SVC63Q2            YES, TRY IT                  @D37CDOW 01377000
         B     SVC63G             R.C. = 16 (DEAD LOCK)                 01378000
SVC63Q7  CLC   LOKOTID(2),TID     SAME TASK                    @DA27378 01379000
         BE    SVC63Q4            YES                          @D356DJO 01380000
         EJECT                                                 @D149DIS 01381000
         SPACE 2                                               @D356DJO 01382000
***************************************************************@D149DIS 01383000
*   WAITING FOR LOCKTAB SPACE TO BECOME FREE.                  @D356DJO 01384000
*                                                              @D356DJO 01385000
*   WAITING FOR LOCKTAB SPACE IS POSSIBLE,                     @D356DJO 01386000
*   IF THERE IS AT LEAST ONE LOCKTAB ENTRY,                    @D356DJO 01387000
*   WHOSE OWNERS ARE ALL RUNNING (NO OWNER IS RESOURCE BOUND). @D356DJO 01388000
***************************************************************@D149DIS 01389000
SVC63R   L     RE,ALOCKSPC        DUMMY ENTRY FOR SPACE        @D356DJO 01390000
         TM    LOCKFLG2,LOCKWAIT  SOMEONE WAITING FOR SPACE    @D356DJO 01391000
         BO    SVC63R2            YES, CHECK FOR D.L.          @D356DJO 01392000
         CR    R2,RE              THIS TASK WAITG FOR SPACE    @D356DJO 01393000
         BNE   SVC63W             NO, ALL O.K.                 @D356DJO 01394000
SVC63R2  L     RE,ALOKTABA        YES.. SET UP LOOP INDEX               01395000
SVC63T   L     RC,LOCKCHN         GET OWNER CHAIN              @D356DJO 01396000
SVC63U   LTR   RC,RC              ALL OWNERS CHECKED                    01397000
         BZ    SVC63W             YES,THIS ENTRY WILL BECOME   @D356DJO 01398000
*                                 AVAILABLE ONE DAY            @D356DJO 01399000
         LH    R5,LOKOTID         TID OF OWNING TASK           @DA27378 01400000
         SLL   R5,2               MULTIPLY WITH 4              @D66ODOW 01401000
         AL    R5,ATIBATAB        ADDR WITHIN TIBATAB          @D66ODOW 01402000
         L     R5,0(,R5)          TIB POINTER                  @D66ODOW 01403000
         USING TIBADR,R5                                       @D36IDJO 01404000
         CLI   TIBRQID,RURBND     IS OWNING TASK WAITING       @D366DFR 01405000
         LH    R5,LOKOTID         TID OF OWNING TASK           @DA27378 01406000
         DROP  R5                                              @D36SDJO 01407000
         BE    SVC63V             YES                          @D356DJO 01408000
         CH    R5,TID             IS RESOURCE OWNED BY ME      @D36SDJO 01409000
         BE    SVC63V             YES, TRY NEXT ENTRY          @D36SDJO 01410000
         L     RC,LOKOCHN         NEXT OWNER ELEMENT           @D356DJO 01411000
         B     SVC63U                                          @D356DJO 01412000
SVC63V   L     RE,LOCKPTR         ADDRESS NEXT LOCKTAB ENTRY   @D37CDOW 01413000
         LTR   RE,RE              END OF LOCKTAB REACHED       @D37CDOW 01414000
         BNZ   SVC63T           NO, PROCESS THIS LOCKTAB ENTRY @D37CDOW 01415000
         B     SVC63G           YES,POSSIBLE DEADLOCK(R.C.=16) @D356DJO 01416000
         DROP  RE                                              @D356DJO 01417000
         EJECT                                                 @D149DIS 01418000
         SPACE 2                                               @D149DIS 01419000
         USING LOCKADR,R2                                      @D356DJO 01420000
***************************************************************@D149DIS 01421000
*   PREPARE WAIT INFORMATION IN TASK INFORMATION BLOCK                  01422000
*   REQUEST INFO IS SAVED IN TIBSTATE                          @D36SDJO 01423000
*   BYTE  0  QUEUE IDENTIFICATION                              @D36SDJO 01424000
*   BYTE  1 - 3  LOCKTAB ENTRY                                 @D37CDOW 01425000
*   BYTE 0, BIT 0  B'1' IF E1 REQUEST (FOR NON-DUMMY RESOURCE) @D37CDOW 01426000
***************************************************************@D149DIS 01427000
SVC63W   TM    DTLFLG1,DTLOPT1+DTLEXC LOCKOPT=1 AND CONTROL=E  @D36IDJO 01428000
         LA    R1,0(,R2)          TIBSTATE --> LOCKTAB ADDR    @DA37112 01429000
         BNO   SVC63X             NO                           @D36SDJO 01430000
         C     R1,ALOKTABA        DUMMY RESOURCE               @DA27378 01431000
         BL    SVC63X             YES                          @D36SDJO 01432000
         O     R1,E1REQMSK        SAVE FOR DEAD LOCK TEST      @DA27378 01433000
         OI    LOCKFLG2,LOCKWTE1  SET SOME TASK WAITING E1     @D52QDMK 01434000
         B     SVC63X1            CONTINUE                     @D52QDMK 01435000
SVC63X   EQU   *                                               @DA27378 01436000
         USING DISP,R6                                         @D52QDMK 01437000
*                                                                       01438000
         OI    LOCKFLG2,LOCKWAIT  SET 'SOME TASK WAITING' FLAG @D52QDMK 01439000
SVC63X1  L     R8,TIBPTR          TIB ADDRESS                  @D36SDJO 01440000
         USING TIBADR,R8                                       @D36SDJO 01441000
         TM    TIBFLAG,ROLLOUT    DOES ICCF CONTROL WANT TO    @D36GDJO 01442000
         BZ    NOPP               BE POSTED,    BRANCH IF NO   @D35ZDUL 01443000
         DROP  R8                                              @D36SDJO 01444000
         L     R9,IJBETSS         ICCF VECTOR TABLE            @D36GDUL 01445000
         USING DTSVECDS,R9                                     @D35ZDUL 01446000
         OI    DTSECB+D2,TRABIT   POST ICCF HIGH TASK ECB      @D35ZDUL 01447000
         MVI   DTSECB+D3,XFF      INDICATE USE REQUEST WAITS   @D35ZDUL 01448000
         LH    R8,DTSHTID         GET TIK OF ICCF HIGH PR TASK @D36GDJO 01449000
         BAL   RF,IOPOST0         POST HIGH PRIORITY TASK      @D36GDJO 01450000
*SGLINK  IOPOST0,INPUT=(R6,R8,RF),WORK=(R8,RE)                 @D149DIS 01451000
         DROP  R9                 DROP VECTOR TABLE ADDRESS    @D35ZDUL 01452000
.**************************************************************@D52QDMK 01453000
.* IF TIMER FOR SYSTEM TASK RETRY IS SET THEN GOTO RESVC       @D52QDMK 01454000
.*                                       ELSE GOTO RESVCX      @D52QDMK 01455000
.**************************************************************@D52QDMK 01456000
NOPP     EQU   *                                               @D35ZDUL 01457000
         LA    R4,4               RESOURCE NOT FREE            @D52QDMK 01458000
         BAL   R14,SV6364CN       UPDATE                       @D52XDMK 01459000
         L     R5,ASRQTAB                                      @D61MPMK 01460000
         LA    R5,SRQRUR-SRQTAB(,R5)                           @D61MPMK 01461000
         AIF   (NOT &BGDSHR).SV63X                             @D36SDJO 01462000
         TM    DSHRFLG,LCKTIM     REQUEST FOR EXTERNAL LOCK    @D36SDJO 01463000
         BNO   RESVCX             NO, RESVC AND WAIT           @D36SDJO 01464000
         NI    DSHRFLG,XFF-LCKTIM RESET EXTERNAL FLAG          @D36SDJO 01465000
         L     R3,ALCKTIB         TIB POINTER OF SYSTEM TASK   @D36SDJO 01466000
         ICM   R4,B'1111',TIBITCHN-TIBADR(R3) TIMER SET FOR LCK@D64ADOW 01467000
         BZ    RESVC              NO,RESVC WITHOUT WAIT        @D36SDJO 01468000
SVC63X5  EQU   *                                               @D36SDJO 01469000
.SV63X   ANOP                                                  @D36SDJO 01470000
         B     RESVCX             RE-EXECUTE SVC               @D36IDJO 01471000
*SGLINK  RESVCX,INPUT=(R5,R6),WORK=(R8,RF)                     @D149DIS 01472000
         DROP  R6                                              @D52QDMK 01473000
         EJECT                                                 @D36IDJO 01474000
         SPACE 2                                               @D149DIS 01475000
***************************************************************@D51UDMK 01476000
*   ALLOCATE A NEW REQUEST ELEMENT,                            @D51UDMK 01477000
*   INITIALIZE                                                 @D51UDMK 01478000
*   INSERT TID                                                 @D52QDMK 01479000
*   FILL WITH ECB ADDRESS                                      @D52QDMK 01480000
*   SAVE LOCKPARM, LOKOWORK, REQWORK AND UNLCKFLG              @D52QDMK 01481000
*   THE REQUEST ELEMENT HAS THE SAME SIZE AS THE OWNER ELEMENT @D52QDMK 01482000
***************************************************************@D51UDMK 01483000
SVC63Y   L     R5,LOKOFRL         FREE LIST POINTER            @D51UDMK 01484000
         LTR   R5,R5              FREE ELEMENT AVAILABLE       @D51UDMK 01485000
         BNZ   SVC63Y2            YES CONTINUE                 @D51UDMK 01486000
         BAL   R8,SV6364OE        TRY TO GET NEW OWNER ELEMENTS@D51UDMK 01487000
SVC63Y2  EQU   *                                               @D51UDMK 01488000
         L     RC,LOCKRQC         GET FIRST REQUEST ELEMENT    @D51UDMK 01489000
         LTR   RC,RC              ELEMENT AVAILABLE ?          @D51UDMK 01490000
         BNE   SVC63Y4            YES, TRY NEXT ONE            @D52QDMK 01491000
         ST    R5,LOCKRQC         CHAIN FREE ELEMENT TO RES.   @D52QDMK 01492000
         B     SVC63Y6            INITIALIZE                   @D52QDMK 01493000
         SPACE                                                          01494000
SVC63Y4  LR    RE,RC              LAST BUT ONE ELEMENT         @D52QDMK 01495000
         L     RC,LOKOCHN         NEXT ELEMENT                 @D52QDMK 01496000
         LTR   RC,RC              ELEMENT AVAILABLE ?          @D52QDMK 01497000
         BNE   SVC63Y4            YES, TRY NEXT ONE            @D52QDMK 01498000
         LR    RC,RE              LAST ELEMENT FOUND           @D52QDMK 01499000
         ST    R5,LOKOCHN         CHAIN FREE ELEMENT TO RES.   @D52QDMK 01500000
***************************************************************@D51UDMK 01501000
*   INITIALIZE NEW REQUEST ELEMENT                             @D51UDMK 01502000
***************************************************************@D51UDMK 01503000
SVC63Y6  LR    RC,R5              POINT TO NEW LAST ELEMENT    @D52QDMK 01504000
         MVC   LOKOFRL,LOKOCHN    UPDATE FREE POINTER          @D52QDMK 01505000
         XC    LOKOCHN,LOKOCHN    THIS ELEMENT IS LAST         @D51UDMK 01506000
         MVC   LOKOTID(2),LCKUTID OWNER OF THIS ELEMENT        @D51UDMK 01507000
         L     R1,SV110S1         GET DTL POINTER BACK         @D52QDMK 01508000
         ST    R1,LOKODTL         COPY DTL ADDRESS             @D51UDMK 01509000
         MVC   DTLLOCKP(4),LOCKPARM COPY LOCKPARM FOR LATER USE@D52QDMK 01510000
         LA    R4,4               RETURN CODE 4                @D51UDMK 01511000
         SGCOV D52XDMK2                                        @D52XDMK 01512000
         B     SVC63M2            RETURN TO DISP OR SVC110ZG   @D52QDMK 01513000
         EJECT                                                 @D51UDMK 01514000
         SPACE 2                                               @D51UDMK 01515000
*--------------------------------------------------------------         01516000
*                                                                       01517000
*   L O C K / U N L O C K  -  COMMON SUBROUTINES.                       01518000
*                                                                       01519000
*---------------------------------------------------------------        01520000
         AIF   (NOT &BGDSHR).DSHRSUB                           @D36SDJO 01521000
         SPACE 2                                               @D149DIS 01522000
.**************************************************************@D52QDMK 01523000
.*  READ AND UPDATE EXTERNAL FILE                              @D52QDMK 01524000
.*  IF LOCK IS INTERNAL OR EXTERNAL FILE IS NOT ACCESSIBLE     @D52QDMK 01525000
.*  THEN TREAT INTERNALLY                                      @D52QDMK 01526000
.**************************************************************@D52QDMK 01527000
*SGLINK  DSHRLCK1,S,INPUT=(R2,R8),WORK=(R0,R3,R4,R5,RF)        @D149DIS 01528000
DSHRLCK1 TM    DSHRFLG,LCKREQ      DOES LOCKING CONTROL CHANGE @D36SDJO 01529000
         BNOR  R8                  NO,                         @D36SDJO 01530000
         TM    LOCKFLG2,LOCKEXT    LOCK ON EXTERNAL FILE       @D36SDJO 01531000
         BNOR  R8                  NO, RETURN                  @D36SDJO 01532000
         TM    DLFFLG1,DLFINT     DASD SHR SUPPORT ACTIVE      @D36SDJO 01533000
         BNOR  R8                 NO, PROCESS INTERNAL         @D36SDJO 01534000
         SPACE 2                                               @D149DIS 01535000
***************************************************************@D149DIS 01536000
*   ENTER HERE IF REQUEST IS FOR E2/E4 AND STATUS IS S2/S4              01537000
***************************************************************@D149DIS 01538000
.**************************************************************@D52QDMK 01539000
.* ENTRY POINT FOR ACCESS TO LOCK FILE                         @D52QDMK 01540000
.* ACTIVATE SYSTEM TASK                                        @D52QDMK 01541000
.* RETRUN (0) = ACTIVATION UNSUCCESSFUL                        @D52QDMK 01542000
.* RETRUN (4) = ACTIVATION DONE                                @D52QDMK 01543000
.**************************************************************@D52QDMK 01544000
LCKM21   BAL   RF,LCKACT           ACTIVATE SYSTEM TASK        @D36SDJO 01545000
         B     SVC63P2            I/O ERROR ON EXT. FILE       @D36SDJO 01546000
         LA    R3,LOCKRESN        RESOURCE NAME                @D36SDJO 01547000
.**************************************************************@D52QDMK 01548000
.* CALCULATE THE DISK BLOCK NUMBER FOR READ LOCK FILE          @D52QDMK 01549000
.**************************************************************@D52QDMK 01550000
         BAL   RF,LCKHASH         CALCULATE DISK BLOCK NUMBER  @D36SDJO 01551000
*SGLINK  LCKHASH,INPUT=(R3,RF),WORK=(R3,R4,R5),OUTPUT=R9       @D36SDJO 01552000
.**************************************************************@D52QDMK 01553000
.* READ DISK BLOCK                                             @D52QDMK 01554000
.* RETRUN (0) = BLOCK NOT FOUND                                @D52QDMK 01555000
.* RETRUN (4) = BLOCK FOUND, CAN CHECK IT NOW                  @D52QDMK 01556000
.**************************************************************@D52QDMK 01557000
         BAL   RF,LCKGET          READ DISK BLOCK              @D36SDJO 01558000
*SGLINK  LCKGET,INPUT=(R9,RF),WORK=(R0,R3,R5,R7,RE),OUTPUT=R4           01559000
         B     LCKM23             I/O ERROR OR DESTROYED FILE  @D36SDJO 01560000
         LA    R3,LOCKRESN        RESOURCE NAME FOR HASHING    @D36SDJO 01561000
.**************************************************************@D52QDMK 01562000
.* SCAN THE DISK BLOCK FOR RESOURCE NAME                       @D52QDMK 01563000
.* RETRUN (0) = BLOCK HAS NOT LOCK FILE FORMAT                 @D52QDMK 01564000
.* RETRUN (4) = RESOURCE NAME FOUND                            @D52QDMK 01565000
.* RETRUN (8) = RESOURCE NAME NOT FOUND                        @D52QDMK 01566000
.**************************************************************@D52QDMK 01567000
         BAL   RF,LCKSCAN                                      @D36SDJO 01568000
*SGLINK  LCKSCAN,INPUT=(R3,R4,RF),WORK=(R5),OUTPUT=(R4)                 01569000
         B     LCKM23             DESTROYED EXTERNAL FILE      @D36SDJO 01570000
         B     LCKM25             RESOURCE NAME FOUND          @D36SDJO 01571000
.**************************************************************@D52QDMK 01572000
.* ENTRY POINT: READ CANNOT BE PERFORMED                       @D52QDMK 01573000
.* SET RETURN CODE 'IRRECOVERABLE ERROR ON EXT. FILE'          @D52QDMK 01574000
.**************************************************************@D52QDMK 01575000
LCKM23   OI    DLFFLG1,DSHRDOWN+DSDWNMSG DASD SHARING DOWN     @D36SDJO 01576000
         BAL   RF,LCKDEACT        RETURN TO USER TASK          @D36SDJO 01577000
SVC63P2  LA    R4,ERREXTIO        RETURN CODE                  @D36SDJO 01578000
         SGCOV D52XDMK2                                        @D52XDMK 01579000
.**************************************************************@D52QDMK 01580000
.* IF FAIL=WAIT THEN CANCEL USER                               @D52QDMK 01581000
.**************************************************************@D52QDMK 01582000
         TM    LOCKPARM,WAITUFLG  FAIL=WAIT                    @D36SDJO 01583000
         USING DISP,R6                                         @D52QDMK 01584000
         BO    ERR1E              CANCEL (ERROR ON LOCK FILE)  @D36SDJO 01585000
         DROP  R6                                              @D52QDMK 01586000
         B     SVC63N2                                         @D36SDJO 01587000
         SPACE 2                                               @D149DIS 01588000
.**************************************************************@D52QDMK 01589000
.* ENTRY POINT: RESOURCE NAME FOUND                            @D52QDMK 01590000
.**************************************************************@D52QDMK 01591000
LCKM25   EQU   *                                               @D36SDJO 01592000
         LH    R3,DLFNCPUS        NUMBER OF CPUS               @D36SDJO 01593000
         LR    R0,R4              SAVE FOR LATER UPDATE        @D36SDJO 01594000
LCKM26   CLI   L'LOCKRESN(R4),ZERO  LOCKED BY THAT CPU         @D36SDJO 01595000
         BE    LCKM27             NO, TRY NEXT CPU             @D36SDJO 01596000
.**************************************************************@D52QDMK 01597000
.* THIS CPU HOLDS THE LOCK                                     @D52QDMK 01598000
.* IF REQUEST=E AND LOCK STATUS=E THEN WAIT                    @D52QDMK 01599000
.**************************************************************@D52QDMK 01600000
         CLC   DTLFLG1,L'LOCKRESN(R4) SAME EXCL.LOCKING STATUS @D36SDJO 01601000
         BE    LCKM28             YES, WAIT                    @D36SDJO 01602000
.**************************************************************@D52QDMK 01603000
.* CHECK IF OPTIONS ARE EQUAL (1,2,4)                          @D52QDMK 01604000
.* IF NOT THEN IT'S AN INCONSISTENT REQUEST                    @D52QDMK 01605000
.**************************************************************@D52QDMK 01606000
         MVN   LOKOWORK,DTLFLG1   MOVE LOCKOPT SPECIFICATION   @D36SDJO 01607000
         CLC   LOKOWORK,L'LOCKRESN(R4)  SAME LOCKOPT SPECIFIC. @D36SDJO 01608000
         BNE   LCKM35             NO, INCONSISTENT REQUEST     @D36SDJO 01609000
.**************************************************************@D52QDMK 01610000
.* LOOP THRU CPU SLOTS                                         @D52QDMK 01611000
.**************************************************************@D52QDMK 01612000
LCKM27   LA    R4,1(R4)           NEXT CPU FIELD               @D36SDJO 01613000
         BCT   R3,LCKM26          LOOP THROUGH CPU FIELDS      @D36SDJO 01614000
.**************************************************************@D52QDMK 01615000
.* INSERT THE SLOT INFORMATION                                 @D52QDMK 01616000
.**************************************************************@D52QDMK 01617000
         LR    R4,R0              FIRST CPU POSITION           @D36SDJO 01618000
         AH    R4,DLFINDEX        POINT TO OWN LOCATION        @D36SDJO 01619000
         MVC   L'LOCKRESN(1,R4),DTLFLG1  MOVE NEW LOCKING ST.           01620000
.**************************************************************@D52QDMK 01621000
.*  WRITE DISK BLOCK BACK TO LOCK FILE                         @D52QDMK 01622000
.*  RETURN (0) = WRITE WAS NOT SUCCESSFUL                      @D52QDMK 01623000
.*  RETURN (4) = WRITE DONE                                    @D52QDMK 01624000
.**************************************************************@D52QDMK 01625000
         BAL   RF,LCKPUT          WRITE BACK DISK BLOCK        @D36SDJO 01626000
*SGLINK  LCKPUT,INPUT=(RF),WORK=(R3)                           @D36SDJO 01627000
         B     LCKM23             IRRECOVERABLE I/O ERROR      @D36SDJO 01628000
.**************************************************************@D52QDMK 01629000
.*  CHECK FOR EXTERNAL DEADLOCK SITUATION:                     @D52QDMK 01630000
.*  CLEAR BUFFER                                               @D52QDMK 01631000
.**************************************************************@D52QDMK 01632000
         TM    LOCKPARM,WAITEFLG  IF WAITECB THEN              @DA43446 01633000
         BO    LCKM271            NO TCBWAREA UPDATE           @DA43446 01634000
         XC    TCBWAREA(BUFSLOT+1),TCBWAREA  GIVE UP THIS ENTRY@D52QDMK 01635000
***************************************************************@D149DIS 01636000
*   DEACTIVATE SYSTEM TASK                                     @D36SDJO 01637000
***************************************************************@D149DIS 01638000
LCKM271  BAL   RF,LCKDEACT        DEACTIVATE SYSTEM TASK       @D52QDMK 01639000
         BR    R8                                              @D36SDJO 01640000
         SPACE 2                                               @D149DIS 01641000
.**************************************************************@D52QDMK 01642000
.* ENTRY POINT: WE WANT TO WAIT UNTIL THE RESOURCE BECOMES FREE@D52QDMK 01643000
.**************************************************************@D52QDMK 01644000
LCKM28   LH    R4,DLFNCPUS        NUMBER OF CPUS               @D52QDMK 01645000
         SR    R4,R3              SLOT OF RESOURCE OWNER       @D52QDMK 01646000
         STC   R4,BUFROSLT        SAVE FOR MESSAGE             @D52QDMK 01647000
         LA    R4,4               RETURN CODE 'NOT AVAILABLE'  @D52QDMK 01648000
         SGCOV D52XDMK2                                        @D52XDMK 01649000
         L     R8,SV110S8         GET BACK USER'S TIB          @D52QDMK 01650000
         TM    SERVFLG,NOUSER     IS LOCK FOR REQ. ELEMENT?    @D52QDMK 01651000
         BZ    LCKM281            NO, CHECK FAIL OPTION        @D52QDMK 01652000
.**************************************************************@D52QDMK 01653000
.*IF LCK SYSTEM TASK RUNS FOR REALLOCATION THEN DO:            @D52QDMK 01654000
.*INDICATE THAT TIMER HAS TO BE STARTED                        @D52QDMK 01655000
.*QUEUE THIS LOCKTAB ENTRY TO SPECIAL QUEUE                    @D52QDMK 01656000
.*ALLOCATE REQUEST ELEMENT                                     @D52QDMK 01657000
.*SETUP RETURNCODE AND BRANCH TO R6 (PROCESS NEXT LOCKTAB ENTRY)D52QDMK 01658000
.**************************************************************@D52QDMK 01659000
         OI    SERVFLG,SETTIM     TIMER HAS TO BE SET FOR RETRY@D52QDMK 01660000
         BAL   RF,SVC6364Q        CHAIN LOCKTAB ENTRY          @D52QDMK 01661000
         LH    R5,TIBRTID-TIBADR(,R8) TID OF SERVICE OWNER     @D52QDMK 01662000
         SLL   R5,2               MULTIPLY WITH 4              @D66ODOW 01663000
         AL    R5,ATIBATAB        ADDR WITHIN TIBATAB          @D66ODOW 01664000
         L     R5,0(,R5)          TIB POINTER                  @D66ODOW 01665000
         CLI   TIBRQID-TIBADR(R5),WAITBND USER WAITING?        @D52QDMK 01666000
         BNE   LCKM280            NO, CANNOT UPDATE FIELDS     @D52QDMK 01667000
         BAL   RF,LCKDLC          CALL EXTERNAL DEADLOCKCHECK  @D52QDMK 01668000
*SGLINK LCKDLC,INPUT=(R1,RC,RF),WORK=(R0,R3,R4,R5,R7,R9,RE)    @D52QDMK 01669000
LCKM280  B     SVC63Y             ALLOCATE REQUESTOR + RETURN  @D52QDMK 01670000
LCKM281  TM    LOCKPARM,WAITEFLG  WAITECB                      @D52QDMK 01671000
         BZ    LCKM283            NO, CHECK OTHER FAIL OPTIONS @D52QDMK 01672000
.**************************************************************@D52QDMK 01673000
.*IF USER RUNS WITH WAITECB, THEN INSTEAD OF WAIT FOR EXTERNAL @D52QDMK 01674000
.*RESOURCE DO:                                                 @D52QDMK 01675000
.*INDICATE THAT TIMER HAS TO BE STARTED                        @D52QDMK 01676000
.*DEACTIVATE SYSTEM TASK                                       @D52QDMK 01677000
.*QUEUE THIS LOCKTAB ENTRY TO SPECIAL QUEUE                    @D52QDMK 01678000
.*ALLOCATE REQUEST ELEMENT                                     @D52QDMK 01679000
.*SETUP RETURNCODE AND BRANCH TO R6                            @D52QDMK 01680000
.**************************************************************@D52QDMK 01681000
         OI    SERVFLG,SETTIM     TIMER HAS TO BE SET FOR RETRY@D52QDMK 01682000
         OI    SERVFLG,NOINT      ONLY REALLOCATION FOR EXT RES@D52QDMK 01683000
*SGLINK LCKDLC,INPUT=(R1,RC,RF),WORK=(R0,R3,R4,R5,R7,R9,RE)    @D52QDMK 01684000
LCKM282  BAL   RF,LCKDEACT        DEACTIVATE SYSTEM TASK       @D52QDMK 01685000
         BAL   RF,SVC6364Q        CHAIN LOCKTAB ENTRY          @D52QDMK 01686000
         B     SVC63Y             ALLOCATE REQUESTOR + RETURN  @D52QDMK 01687000
.**************************************************************@D52QDMK 01688000
.*HANDLE WAIT, WAITC, WAITR                                    @D52QDMK 01689000
.**************************************************************@D52QDMK 01690000
LCKM283  TM    LOCKPARM,WAITUFLG+WAITCFLG          WAIT/WAITC  @D52QDMK 01691000
         BNZ   LCKM07             YES, SET TIMER ON            @D36SDJO 01692000
.**************************************************************@D52QDMK 01693000
.* DEACTIVATE SYSTEM TASK AND RETURN TO USER                   @D52QDMK 01694000
.* (ALSO ENTERED IF NO SPACE ON DISK BLOCK LCKM06 ...)         @D52QDMK 01695000
.**************************************************************@D52QDMK 01696000
LCKM29   BAL   RF,LCKDEACT        DEACTIVATE SYSTEM TASK       @D36SDJO 01697000
         B     SVC63M             RETURN TO USER               @D52QDMK 01698000
         EJECT                                                 @D149DIS 01699000
         SPACE 2                                               @D149DIS 01700000
***************************************************************@D149DIS 01701000
*   ENTER HERE IF RESOURCE IS NOT IN LOCKTAB,                  @D36SDJO 01702000
*   BUT IS LOCKED BY OTHER SYSTEM                              @D36SDJO 01703000
***************************************************************@D149DIS 01704000
LCKM30   LH    R3,DLFNCPUS         NUMBER OF CPUS              @D36SDJO 01705000
         LR    R5,R4               FOUND ENTRY ADDRESS         @D36SDJO 01706000
         AH    R5,DLFINDEX         * CPU'S SLOT                @D36SDJO 01707000
.**************************************************************@D52QDMK 01708000
.* IF THIS SYSTEM IS OWNER THEN 'IRRECOVERABLE IO ERROR'       @D52QDMK 01709000
.**************************************************************@D52QDMK 01710000
         CLI   L'LOCKRESN(R5),ZERO ALREADY LOCKED BY ME        @D36SDJO 01711000
         BNE   LCKM23              YES, ERROR                  @D36SDJO 01712000
.**************************************************************@D52QDMK 01713000
.* REALLY LOCKED BY OTHER SYSTEM                               @D52QDMK 01714000
.**************************************************************@D52QDMK 01715000
LCKM32   CLI   L'LOCKRESN(R4),ZERO ALREADY LOCKED BY THAT CPU  @D36SDJO 01716000
         BE    LCKM42              NO, TRY NEXT CPU            @D36SDJO 01717000
.**************************************************************@D52QDMK 01718000
.* THIS CPU HOLDS THE LOCK                                     @D52QDMK 01719000
.* IF REQUEST=E AND LOCK STATUS=E THEN WAIT                    @D52QDMK 01720000
.* IF REQUEST=E1 THEN WAIT                                     @D52QDMK 01721000
.* IF REQUEST AND LOCK STATUS ARE INCONSISTENT THEN REJECT     @D52QDMK 01722000
.**************************************************************@D52QDMK 01723000
         CLI   L'LOCKRESN(R4),DTLOPT1+DTLEXC                   @D36SDJO 01724000
         BE    LCKM36              WAIT IF EXCL+OPT1 LOCKED    @D36SDJO 01725000
         CLI   DTLFLG1,DTLOPT1+DTLEXC                          @D36SDJO 01726000
         BE    LCKM36              WAIT IF EXC+OPT1 REQUESTED  @D36SDJO 01727000
         MVC   LOKOWORK,DTLFLG1    REQUESTED LOCKOPT           @D36SDJO 01728000
         OC    LOKOWORK,L'LOCKRESN(R4) LOCKING STATUS          @D36SDJO 01729000
         NI    LOKOWORK,X'0F'      CLEAR EXCL.FLAG(IF ON)      @D36SDJO 01730000
         CLI   LOKOWORK,DTLOPT4    * THE REQUEST IS CONSISTENT @D36SDJO 01731000
         BH    LCKM35              * WITH LOCKING STATUS, IF   @D36SDJO 01732000
         CLI   LOKOWORK,DTLOPT1+DTLOPT2   * LOKOWORK CONTAINS  @D36SDJO 01733000
         BE    LCKM35              * 4,2,OR 1 (NO MIX)         @D36SDJO 01734000
         TM    DTLFLG1,DTLEXC      EXCLUSIVE REQUEST           @D36SDJO 01735000
         BNO   LCKM42              NO, MAY GET THE RESOURCE    @D36SDJO 01736000
         TM    L'LOCKRESN(R4),DTLEXC  EXCLUSIVELY LOCKED       @D36SDJO 01737000
         BO    LCKM36              YES, WAIT                   @D36SDJO 01738000
.**************************************************************@D52QDMK 01739000
.* LOOP THRU CPU SLOTS                                         @D52QDMK 01740000
.**************************************************************@D52QDMK 01741000
LCKM42   LA    R4,1(R4)            POINT TO NEXT CPU SLOT      @D36SDJO 01742000
         BCT   R3,LCKM32           LOOP THRU CPUS              @D36SDJO 01743000
         B     LCKM11                                          @D36SDJO 01744000
.**************************************************************@D52QDMK 01745000
.* ENTRY POINT: INCONSISTENT REQUEST                           @D52QDMK 01746000
.**************************************************************@D52QDMK 01747000
LCKM35   BAL   RF,LCKDEACT         RETURN TO USER TASK         @D36SDJO 01748000
         B     SVC63N1             INCONSISTENT REQUEST        @D36SDJO 01749000
.**************************************************************@D52QDMK 01750000
.* ENTRY POINT: LET'S WAIT UNTIL SYSTEM UNLOCKS THE RESOURCE   @D52QDMK 01751000
.**************************************************************@D52QDMK 01752000
LCKM36   TM    LOCKPARM,WAITEFLG                   WAITECB     @D51UDMK 01753000
         BZ    LCKM28              NO, WAIT                    @D51UDMK 01754000
.**************************************************************@D51UDMK 01755000
.*  IN CASE OF FAIL=WAITECB ALLOCATE A LOCKTAB ENTRY           @D52QDMK 01756000
.*  TO BE ABLE TO CHAIN THE REQUEST ELEMENT                    @D52QDMK 01757000
.**************************************************************@D51UDMK 01758000
         MVC   LOCKRESN,DTLNAME   PUT NAME PARAM INTO LOCKTAB  @D51UDMK 01759000
         MVC   LOCKFLG1,DTLFLG1   LOCKOPT+ EXC FLAG            @D51UDMK 01760000
         OI    LOCKFLG2,LOCKUSED  SET IN USE,                  @D51UDMK 01761000
         TM    DTLFLG2,DTLPART    OWNER=PARTITION              @D51UDMK 01762000
         BNO   LCKM37             NO                           @D51UDMK 01763000
         OI    LOCKFLG2,LOCKPART  FLAG OWNERSHIP               @D51UDMK 01764000
LCKM37   B     LCKM28                                          @D52QDMK 01765000
         EJECT                                                 @D51UDMK 01766000
         SPACE 2                                               @D51UDMK 01767000
***************************************************************@D149DIS 01768000
*   SET USER TASK IN WAIT AND ACTIVATE LOCK SYSTEM TASK.       @D36SDJO 01769000
*   THIS ROUTINE DOES NOT CHANGE ANY REGISTER.                 @D36SDJO 01770000
*   IF LCK SYSTEM TASK IS REALLOCATING FOR A REQUESTOR THEN    @D52QDMK 01771000
*   ACTIVATION IS NOT PERFORMED                                @D52QDMK 01772000
***************************************************************@D149DIS 01773000
LCKACT   TM    SERVFLG,NOACDEAC   LOCK FOR REQUEST ELEMENT?    @D52QDMK 01774000
         BO    4(RF)              YES, DON'T ACTIVATE          @D52QDMK 01775000
         STM   R5,R6,LCKSAV5       SAVE REGISTER               @D52QDMK 01776000
         L     R6,DISPAD                                       @D51UDMK 01777000
         USING DISP,R6                                         @D52QDMK 01778000
         STM   RE,RF,LCKSAVEF      SAVE REGISTER               @D51UDMK 01779000
         TM    DLFFLG1,DSHRDOWN    I/O ERROR ON EXT FILE       @D36SDJO 01780000
         BOR   RF                  YES, RETURN ERROR           @D36SDJO 01781000
         TM    DLFFLG1,DLFACT      I/O AREA RE-ALLOCATED       @D36SDJO 01782000
         BO    LCKACT2             NO, PROCEED NORMALLY        @D36SDJO 01783000
.**************************************************************@D52QDMK 01784000
.*  REALLOCATION OF I/O AREA                                   @D52QDMK 01785000
.**************************************************************@D52QDMK 01786000
         OI    DLFFLG1,DLFACT                                  @D36SDJO 01787000
         L     R5,DLFAREA          NEW I/O AREA ADDRESS        @D36SDJO 01788000
         L     RE,ADLFCCB          I/O CONTROL BLOCKS          @D36SDJO 01789000
         USING DLFCCBR,RE                                      @D36SDJO 01790000
         STCM  R5,7,DLFCCW3+1      UPDATE READ CCW             @D36SDJO 01791000
         STCM  R5,7,DLFCCW5+1      UPDATE READ CCW             @D36SDJO 01792000
         STCM  R5,7,DLFECW3+1      UPDATE READ CCW             @DA42402 01793000
         STCM  R5,7,DLFECW5+1      UPDATE WRITE CCW            @DA42402 01794000
         AIF   (NOT &BGFBA).LCKACT3                            @D36SDJO 01795000
         STCM  R5,7,DLFFCW3+1      UPDATE READ CCW             @D36SDJO 01796000
         STCM  R5,7,DLFFCW5+1      UPDATE READ CCW             @D36SDJO 01797000
.LCKACT3 ANOP                                                  @D36SDJO 01798000
         DROP  RE                                              @D36SDJO 01799000
.**************************************************************@D52QDMK 01800000
.*  CLOSE SVC110 GATE FOR EXTERNAL LOCK FILE OPERATIONS        @D52QDMK 01801000
.*  UNPOST USER TASK                                           @D52QDMK 01802000
.*  SET USER TASK TO'LCK SYSTEM TASK BOUND'                    @D52QDMK 01803000
.**************************************************************@D52QDMK 01804000
LCKACT2  L     R5,ASRQTAB                                      @D61MPMK 01805000
         MVC   RBUSE-SRQTAB(2,R5),TID CLOSE GATE,IDENT OWNER   @D66ODOW 01806000
         TM    SERVFLG,NOUSER     LOCK FOR REQUEST ELEMENT?    @D52QDMK 01807000
         BO    LCKACT3            YES, DONT UNPOST             @D52QDMK 01808000
         L     R5,ASRQTAB                                      @D61MPMK 01809000
         LA    R5,SRQLCK-SRQTAB(,R5)                           @D61MPMK 01810000
         BAL   RF,UNPOST           SET USER TASK IN WAIT       @D36SDJO 01811000
*SGLINK  UNPOST,INPUT=(R5,R6,RF),WORK=(R5,RE)                  @D36SDJO 01812000
.**************************************************************@D52QDMK 01813000
.*  FIRST MAKE SURE THAT SYSTEM TASK IS NOT RURBOUND           @D52QDMK 01814000
.*  THEREFORE POST LCK TASK IF TIBRQID = 8B                    @D52QDMK 01815000
.*  AND DEACTIVATE SYSTEM TASK (OTHERWISE HW IN ACTIVATE)      @D52QDMK 01816000
.**************************************************************@D52QDMK 01817000
LCKACT3  L     R5,ALCKTIB         TIB POINTER OF SYSTEM TASK   @D52QDMK 01818000
         CLI   TIBRQID-TIBADR(R5),RURBND IS LCK TASK ON TIMER  @D52QDMK 01819000
         BNE   LCKACTS            NO, DO SETUP                 @D52QDMK 01820000
         ST    R1,LCKSAV1         SAVE DTL POINTER             @D52QDMK 01821000
         LA    R1,DISEX1+1              USE DISEX+1 AND        @DY46189 01822290
         ST    R1,TIBSTATE-TIBADR(,R5)  POST LOCK TASK ONLY    @DY46189 01822580
         L     R5,ASRQTAB                                      @D61MPMK 01823000
         LA    R5,SRQRUR-SRQTAB(,R5)                           @D61MPMK 01824000
         BAL   RF,RPOST           POST TASKS WAIT FOR EXT LOCK @D52QDMK 01825000
         L     R5,ALCKTIB         TIB POINTER OF SYSTEM TASK   @D52QDMK 01826000
         MVI   TIBRQID-TIBADR(R5),SYSBND DEACTIVATE LCK TASK   @D52QDMK 01827000
         L     R1,LCKSAV1         GET DTL POINTER BACK         @D52QDMK 01828000
.**************************************************************@D52QDMK 01829000
.*  DISABLE EXTRENAL INTERRUPT  AND                            @D52QDMK 01830000
.*  ACTIVATE LCK SYSTEM TASK                                   @D52QDMK 01831000
.**************************************************************@D52QDMK 01832000
LCKACTS  DS    0H                                              @D52QDMK 01833000
         TM    SERVFLG,NOUSER     IF REALLOCATION START        @D61NDMK 01834000
         BO    LCKACTS1           THEN USE OPTION SYSOWNER     @D61NDMK 01835000
        SGSETUP ACTIVATE,STASK=LCK,WR1=R5,WR2=RE,OPTION=DIRECT @D52QDMK 01836000
         B     LCKACTE            CONTINUE                     @D61NDMK 01837000
LCKACTS1 SGSETUP ACTIVATE,STASK=LCK,WR1=R5,WR2=RE,OPTION=SYSOWNER 1NDMK 01838000
LCKACTE  LM    RE,RF,LCKSAVEF      RESTORE REG 14 AND 15       @D51UDMK 01839000
         DROP  R6                                              @D52QDMK 01840000
         LM    R5,R6,LCKSAV5       RESTORE REGISTER            @D52QDMK 01841000
         OI    DSHRFLG,LCKSYS      SYSTEM TASK ACTIVE          @D36SDJO 01842000
         B     4(RF)               RETURN  TO CALLER           @D36SDJO 01843000
         EJECT                                                 @D149DIS 01844000
         SPACE 2                                               @D149DIS 01845000
***************************************************************@D149DIS 01846000
*   SET SYSTEM TASK IN WAIT STATE AND ACTIVATE USER TASK       @D36SDJO 01847000
*   THIS ROUTINE DOES NOT CHANGE ANY REGISTER                  @D36SDJO 01848000
*   IF LCK SYSTEM TASK IS REALLOCATING FOR A REQUESTOR THEN    @D52QDMK 01849000
*   DEACTIVATION IS NOT PERFORMED                              @D52QDMK 01850000
***************************************************************@D149DIS 01851000
LCKDEACT TM    SERVFLG,NOACDEAC   LOCK FOR REQUEST ELEMENT?    @D52QDMK 01852000
         BOR   RF                 YES, DON'T DEACTIVATE        @D52QDMK 01853000
         STM   RE,RF,LCKSAVEF      SAVE REGISTERS              @D52QDMK 01854000
         ST    R8,LCKSAV8                                      @D36SDJO 01855000
         STM   R5,R6,LCKSAV5                                   @D52QDMK 01856000
         L     R6,DISPAD                                       @D51UDMK 01857000
         USING DISP,R6                                         @D52QDMK 01858000
         LR    R8,R1               SAVE DTL ADDRESS            @D36SDJO 01859000
         L     RF,ADLFCCB          I/O CONTROL BLOCKS          @D36SDJO 01860000
         USING DLFCCBR,RF                                      @D36SDJO 01861000
***************************************************************@D149DIS 01862000
*   RELEASE DISK UNIT (IF STILL RESERVED)                      @D36SDJO 01863000
***************************************************************@D149DIS 01864000
         NI    PUBDLF,XFF-X'80'    RESET DEVICE RESET BIT      @DY45712 01865000
         TM    DSHRFLG,LCKRESVD    DISK UNIT STILL RESERVED    @D36SDJO 01866000
         BNO   LCKDEAC1            NO                          @D36SDJO 01867000
         NI    DSHRFLG,XFF-LCKRESVD INDICATE DEVICE RELEASED   @D36SDJO 01868000
LCKDEAC0 LA    R1,DLFCCBS          RELEASE DISK UNIT           @D36SDJO 01869000
         SVC   15                  EXECUTE SENSE I/O           @D66ADAP 01870000
         WAIT  (1)                                             @D36SDJO 01871000
         TM    PUBDLF,X'80'        HAD DEVICE BEEN RESET       @DY45712 01872000
         BZ    LCKDEAC1            NO, PROCEED                 @DY45712 01873000
         NI    PUBDLF,XFF-X'80'    RESET DEVICE RESET BIT      @DY45712 01874000
         B     LCKDEAC0            TRY AGAIN                   @DY45712 01875000
LCKDEAC1 TM    DLFFLG1,DSDWNMSG    CONSOLE MSG TO BE PRINTED   @D36SDJO 01876000
         BNO   LCKDEAC2            NO                          @D36SDJO 01877000
.**************************************************************@D52QDMK 01878000
.*  WRITE 'ERROR ON LOCKFILE' MESSAGE                          @D52QDMK 01879000
.**************************************************************@D52QDMK 01880000
         NI    DLFFLG1,XFF-DSDWNMSG RESET MSG BIT              @D36SDJO 01881000
         LA    R1,DLFCCBC          CCB FOR CONSOLE WRITE       @D36SDJO 01882000
         SVC   15                  WRITE ERROR MESSAGE         @D37CDOW 01883000
         WAIT  (1)                                             @D36SDJO 01884000
         DROP  RF                                              @D36SDJO 01885000
         L     R15,ALCKWRIT        ADDITIONAL ERROR ...        @D61NDMK 01886000
         BALR  R4,R15              ... INFO                    @D61NDMK 01887000
.**************************************************************@D52QDMK 01888000
.*  GET REQUESTOR'S (USER'S) TID AND DEACTIVATE SYSTEM TASK    @D52QDMK 01889000
.**************************************************************@D52QDMK 01890000
LCKDEAC2 LR    R1,R8               RESTORE DTL ADDRESS         @D36SDJO 01891000
         L     R8,TCBSAVE          USER SAVE AREA              @D36SDJO 01892000
         CLC   0(1,R8),LCKDACTE    FIX TCBSAVE AND DEACT ROUT. @D36SDJO 01893000
         CLC   SVUOLDLN(1,R8),LCKDACTE FIX TCBSAVE             @D52QDMK 01894000
         L     RF,TIBPTR           TIB OF SYSTEM TASK          @D52QDMK 01895000
         USING TIBADR,RF                                       @D14NDFG 01896000
         LH    R8,TIBRTID          REMEMBER REQUESTOR TID      @D61NDIS 01897000
         DROP  RF                                              @D14NDFG 01898000
         TM    SERVFLG,SETTIM      IS A TIMER SET FOR LCK TASK @D52QDMK 01899000
         BZ    LCKDEAC6            NO, CONTINUE                @D52QDMK 01900000
.**************************************************************@D52QDMK 01901000
.*  LCK SYSTEM TASK HAS A TIMER REQUEST SET (SERVFLAG):        @D52QDMK 01902000
.*  (CASE: IT IS A LOCK REQUEST WITH WAITECB AND USER OR       @D52QDMK 01903000
.*   A LOCK REQUEST NOT WITH WAITECB AND A TIMER IS PENDING)   @D52QDMK 01904000
.*  THEN PUT SYSTEM TASK TO TIMER QUEUE                        @D52QDMK 01905000
.**************************************************************@D52QDMK 01906000
         ST    R1,LCKSAV1         SAVE DTL POINTER             @D52QDMK 01907000
         L     R3,ALCKTIB         TIB POINTER OF SYSTEM TASK   @D52QDMK 01908000
         USING TIBADR,R3           TIB ADDRESSABILITY          @D52QDMK 01909000
         ICM   R4,B'1111',TIBITCHN-TIBADR(R3) TIMER SET FOR LCK@D64ADOW 01910000
         BNZ   LCKDEAC3           YES, NO NEED TO SETIME       @D52QDMK 01911000
.**************************************************************@D52QDMK 01912000
.*       SETIME ONE SECOND                                     @D52QDMK 01913000
.**************************************************************@D52QDMK 01914000
         LA    R1,300             LOAD  300*(2**8)             @D52QDMK 01915000
         SLL   R1,8               INTO REGISTER 1              @D52QDMK 01916000
         SVC   10                 SETIME                       @D52QDMK 01917000
.**************************************************************@D52QDMK 01918000
.*       PUT LCK TASK INTO TIMER QUEUE                         @D52QDMK 01919000
.*       AND PROVIDE CORRECT PSW                               @D52QDMK 01920000
.**************************************************************@D52QDMK 01921000
LCKDEAC3 OI    DSHRFLG,LCKTIM     TIMER SET FLAG               @D52QDMK 01922000
         LA    R1,DISEX1          LOAD EXTERNAL LOCK INDICATOR @D52QDMK 01923000
         L     R5,ASRQTAB                                      @D61MPMK 01924000
         LA    R5,SRQRUR-SRQTAB(,R5)                           @D61MPMK 01925000
         BAL   RF,UNPOST           SET LCK TASK IN WAIT        @D52QDMK 01926000
*SGLINK  UNPOST,INPUT=(R5,R6,RF),WORK=(R5,RE)                  @D52QDMK 01927000
         L     R1,LCKSAV1         GET DTL POINTER BACK         @D52QDMK 01928000
         USING TIBADR,R3           TIB ADDRESSABILITY          @D52QDMK 01929000
         L     R3,TIBTCB           GET LCK TCB ADDRESS         @D52QDMK 01930000
         DROP  R3                  TIB ADDRESSABILITY          @D52QDMK 01931000
         L     R3,TCBSAVE-TCBADR(,R3) LCK TASK SAVE AREA       @D52QDMK 01932000
         USING SVEARA,R3           SAVE AREA ADDRESSABILITY    @D52QDMK 01933000
         LA    R5,SVC110Z1         CONTINUE HERE WITH TIMER    @D52QDMK 01934000
         ST    R5,SVEPSW2          LCK TASK SAVE AREA          @D52QDMK 01935000
         OI    SVEPSW2,SVEPAM31    31-BIT PSW                  @DY44679 01936000
         DROP  R3                  SAVE AREA ADDRESSABILITY    @D52QDMK 01937000
         B     LCKDEAC7            SETUP USER NOW              @D52QDMK 01938000
.**************************************************************@D52QDMK 01939000
.*  THERE IS NO TIMER SET FOR SYTEM TASK RETRIES:              @D52QDMK 01940000
.*  IF LCK SYSTEM TASK HAS FINISHED REALLOCATION FOR REQUEST   @D52QDMK 01941000
.*  ELEMENTS THEN THERE IS NO USER 'LCK SYSTEM TASK BOUND'     @D52QDMK 01942000
.*  TO BE POSTED                                               @D52QDMK 01943000
.*  IF A TASK IS 'LCK SYSTEM TASK BOUND' THEN POST IT          @D52QDMK 01944000
.**************************************************************@D52QDMK 01945000
LCKDEAC6 BAL   RF,SYSDEACT         DEACTIVATE LCK-SYSTEM TASK  @D52QDMK 01946000
*SGLINK  SYSDEACT,INPUT=(R6,RF),WORK=(R5,RE)                   @D14BDOW 01947000
LCKDEAC7 TM    SERVFLG,NOUSER      LOCK FOR REQUEST ELEMENT?   @D52QDMK 01948000
         BO    LCKDEAC8            YES, DONT SETUP USER        @D52QDMK 01949000
         SGSETUP ACTIVATE,STASK=LCK,WR1=R8,WR2=RF,OPTION=USER  @D61NDIS 01950000
         L     R8,TIBPTR           TIB OF REQUESTOR            @D61NDIS 01951000
*        BAL   RF,POST             POST USER TASK              @D61NDMK 01952000
*SGLINK  POST,INPUT=(R6,R8,RF),WORK=RE                         @D149DIS 01953000
         MVI   RID+D1,USEBND     SET RID TO SVC110 GATE        @D356DJO 01954000
.**************************************************************@D52QDMK 01955000
.*  POST ALL TASKS WAITING FOR SVC110 GATE                     @D52QDMK 01956000
.**************************************************************@D52QDMK 01957000
LCKDEAC8 NI    DSHRFLG,XFF-LCKSYS  USER TASK ACTIVE            @D52QDMK 01958000
         TM    SERVFLG,NOPOST      TIMER EXPIRATION?           @D52QDMK 01959000
         BO    LCKDEAC9            YES, DONT POST SVC110 GATE  @D52QDMK 01960000
         L     R5,ASRQTAB                                      @D61MPMK 01961000
         LA    R5,SRQUSE-SRQTAB(,R5)                           @D61MPMK 01962000
         BAL   RF,RPOST          POST WAITERS READY TO RUN     @D36SDJO 01963000
LCKDEAC9 LM    RE,RF,LCKSAVEF    RESTORE REGISTERS             @D52QDMK 01964000
         L     R8,LCKSAV8        RESTORE R8                    @D36SDJO 01965000
         DROP  R6                                              @D52QDMK 01966000
         LM    R5,R6,LCKSAV5     RESTORE REGISTERS             @D52QDMK 01967000
*CKDACTE STOSM PSWMASK,ENEXTRN     OPEN TIMER INTERRUPTS       @D52QDMK 01968000
LCKDACTE BR    RF                                              @D52QDMK 01969000
         EJECT                                                 @D149DIS 01970000
         SPACE 2                                               @D149DIS 01971000
***************************************************************@D149DIS 01972000
*   LCKHASH SUBROUTINE.                                        @D36SDJO 01973000
*   MAP RESOURCE NAME INTO DISK BLOCK NUMBER                   @D36SDJO 01974000
***************************************************************@D149DIS 01975000
*SGLINK  LCKHASH,S,INPUT=(R3,RF),WORK=(R3,R4,R5),OUTPUT=R9     @D149DIS 01976000
LCKHASH  SR    R4,R4                                           @D36SDJO 01977000
         L     R5,0(R3)          RESOURCE-NAME                 @D36SDJO 01978000
         X     R5,4(R3)          RESOURCE NAME+4               @D36SDJO 01979000
         X     R5,8(R3)          RESOURCE NAME+8               @D36SDJO 01980000
         LH    R3,DLFNBLK        NUMBER OF PHYSICAL BLOCKS     @D36SDJO 01981000
         DR    R4,R3             GET RELATIVE DISK ADDRESS     @D36SDJO 01982000
         LR    R9,R4             SAVE REMAINDER                @D36SDJO 01983000
         LA    R9,1(R9)          ADD ONE FOR HEADER RECORD     @D36SDJO 01984000
         STH   R9,DLFHBLK        SAVE BLOCK NUMBER FOR RAS     @D36SDJO 01985000
         BR    RF                RETURN TO CALLER              @D36SDJO 01986000
         EJECT                                                 @D149DIS 01987000
         SPACE 2                                               @D149DIS 01988000
***************************************************************@D149DIS 01989000
*   LCKSCAN SUBROUTINE.                                        @D36SDJO 01990000
*   SCAN DISK BLOCK FOR SPECIFIED RESOURCE NAME                @D36SDJO 01991000
***************************************************************@D149DIS 01992000
*SGLINK  LCKSCAN,S,INPUT=(R3,R4,RF),WORK=(R5),OUTPUT=(R4)      @D149DIS 01993000
LCKSCAN  CLC   0(2,R4),DLFCHAR   CORRECT DATA BLOCK            @D36SDJO 01994000
         BNER  RF                NOT CORRECT, FILE DAMAGED     @D36SDJO 01995000
         LH    R5,2(R4)          NUMBER OF ENTRIES IN BLOCK    @D36SDJO 01996000
         LTR   R5,R5             BLOCK EMPTY                   @D35SDJO 01997000
         BE    8(RF)             RETURN NOT FOUND              @D36SDJO 01998000
         BLR   RF                ERROR, FILE DESTROYED         @D36SDJO 01999000
         CH    R5,DLFNENT        HIGHER THAN MAXIMUM NUMBER    @D36SDJO 02000000
         BHR   RF                YES, ERROR IN EXTERNAL FILE   @D36SDJO 02001000
         LA    R4,D4(R4)         FIRST ENTRY                   @D36SDJO 02002000
LCKSCAN3 CLC   0(L'LOCKRESN,R4),0(R3) COMPARE RESOURCE NAMES   @D36SDJO 02003000
         BE    4(RF)             FOUND                         @D36SDJO 02004000
         AH    R4,DLFLENT        NEXT ENTRY                    @D36SDJO 02005000
         BCT   R5,LCKSCAN3       LOOP AROUND                   @D36SDJO 02006000
         B     8(RF)             RETURN NOT FOUND              @D36SDJO 02007000
         EJECT                                                 @D149DIS 02008000
         SPACE 2                                               @D149DIS 02009000
***************************************************************@D149DIS 02010000
*   WRITE BACK DISK BLOCK TO EXTERNAL FILE                     @D36SDJO 02011000
***************************************************************@D149DIS 02012000
*SGLINK  LCKPUT,S,INPUT=(RF),WORK=(R3)                         @D149DIS 02013000
LCKPUT   LR    R3,R1             SAVE DTL ADDRESS              @D36SDJO 02014000
         DROP  R1                                              @D14CDOW 02015000
         L     R1,ADLFCCB        BASE OF CCB/CCW AREA          @D36SDJO 02016000
         USING DLFCCBR,R1                                      @D36SDJO 02017000
         MVI   DLFEEXT,X'00'     WRITEMASK:PREMIT EX HA,R0     @DA42402 02018000
         MVI   DLFELR,X'01'      WRITEOPERATION,COUNT ORIENT   @DA42402 02019000
         LA    R1,DLFCCBW        WRITE CCB                     @D36SDJO 02020000
         DROP  R1                                              @D36SDJO 02021000
         TM    PUBDLF,X'80'      HAS DEVICE BEEN RESET         @DY45712 02022000
         BZ    LCKPUT10          NO, CONTINUE PUT              @D52QDMK 02023000
LCKPUT05 NI    PUBDLF,XFF-X'80'  INDICATE DEVICE RELEASED      @DY45712 02024000
         L     R15,DISKRR15      GET RETURN REG OF LAST GET    @D52QDMK 02025000
         LA    R9,4              SUBTRACT 4                    @D52QDMK 02026000
         SR    R15,R9            SUBTRACT 4                    @D52QDMK 02027000
         LH    R9,DLFHBLK        GET DISK BLOCK NUMBER FOR GET @D52QDMK 02028000
         LR    R1,R3             RESTORE DTL ADDRESS           @DY43896 02029000
         BR    RF                AND REINVOKE LAST GET         @D52QDMK 02030000
LCKPUT10 SVC   15                WRITE DISK BLOCK              @D37CDOW 02031000
         WAIT  (1)                                             @D36SDJO 02032000
         TM    PUBDLF,X'80'      HAS DEVICE BEEN RESET         @DY45712 02033000
         BO    LCKPUT05          YES, REPEAT IT ALL            @DY45712 02034000
         L     R4,IOPUT          GET IOPUT COUNTER             @D61NDMK 02035000
         AL    R4,F1             INCREMENT                     @D61NDMK 02036000
         BC    5,*+6             IF NOT MAXIMUM REACHED        @D61NDMK 02037000
         BCTR  R4,0              LEAVE MAX VALUE               @D61NDMK 02038000
         ST    R4,IOPUT          UPDATE COUNTER                @D61NDMK 02039000
         USING CCBADR,R1                                       @D36SDJO 02040000
         TM    CCBCOM1,DISERR    IRRECOVERABLE I/O ERROR       @D36SDJO 02041000
         LR    R1,R3             RESTORE DTL ADDRESS           @D36SDJO 02042000
         BOR   RF                RETURN I/O ERROR              @D36SDJO 02043000
         TM    DLFFLG1,DLFCHAIN  WRITE CHAINED TO RELEASE      @D36SDJO 02044000
         BNO   4(RF)             NO, RELEASE STILL REQUIRED    @D36SDJO 02045000
         NI    DSHRFLG,XFF-LCKRESVD  DISK IS RELEASED          @D36SDJO 02046000
         B     4(RF)             RETURN TO CALLER              @D36SDJO 02047000
         DROP  R1                                              @D36SDJO 02048000
         EJECT                                                 @D149DIS 02049000
         SPACE 2                                               @D149DIS 02050000
***************************************************************@D149DIS 02051000
*   LCKGET SUBROUTINE:                                         @D36SDJO 02052000
*   UPDATE CCW AND I/O PARAMETER FIELDS AND                    @D36SDJO 02053000
*   READ ONE DISK RECORD FROM EXTERNAL FILE.                   @D36SDJO 02054000
*   INPUT: R9 CONTAINS RELATIVE BLOCK NUMBER                   @D36SDJO 02055000
*          0 (HEADER BLOCK),   1 TILL N (DATA BLOCKS)          @D36SDJO 02056000
*   OUTPUT: R4 CONTAINS ADDRESS OF I/O AREA                    @D36SDJO 02057000
***************************************************************@D149DIS 02058000
         USING DLFCCBR,RE                                      @D36SDJO 02059000
*SGLINK LCKGET,S,INPUT=(R9,RF),WORK=(R0,R3,R5,R7,RE),OUTPUT=R4 @D149DIS 02060000
LCKGET   L     RE,ADLFCCB I/O CONTROL BLOCK BASE                        02061000
         AIF   (NOT &BGFBA).LCKGET1                            @D37ZDOW 02062000
         CLI   DLFDEVT,DLFFBA    EXTERNAL FILE ON FBA          @D36SDJO 02063000
         BNE   LCKGET10                                        @D36SDJO 02064000
.LCKGET1 ANOP                                                  @D36SDJO 02065000
         AIF   (NOT &BGFBA).LCKGET2                            @D36SDJO 02066000
         ST    R9,DLFLOCR+4      UPDATE READ PARAMETER         @D36SDJO 02067000
         ST    R9,DLFLOCW+4      UPDATE WRITE PARAMETER        @D36SDJO 02068000
         B     LCKGET40                                        @D36SDJO 02069000
LCKGET10 EQU   *                                               @D36SDJO 02070000
.LCKGET2 ANOP                                                  @D36SDJO 02071000
         LR    R5,R9             SAVE BLOCK NUMBER (1,2,,,N)   @D36SDJO 02072000
         SR    R4,R4             EVEN REGISTER FOR DIVIDE      @D36SDJO 02073000
         LH    R3,DLFREC#        RECORDS PER TRACK             @D36SDJO 02074000
         DR    R4,R3             TRACKS IN R5, REC IN R4       @D36SDJO 02075000
         LA    R4,1(R4)          CKD STARTS WITH RECORD 1      @D36SDJO 02076000
         STC   R4,DLFSEEK+6      RECORD NUMBER = R             @D36SDJO 02077000
         STC   R4,DLFESEAR+4     RECORD NUMBER = R             @DA42402 02078000
         SR    R4,R4             EVEN REGISTER FOR DIVIDE      @D36SDJO 02079000
         LH    R3,DLFTRCK#       TRACKS PER CYLINDER           @D36SDJO 02080000
         DR    R4,R3             TRACKS IN R4, CYL IN R5       @D36SDJO 02081000
         STH   R4,DLFSEEK+4      HEAD NUMBER  = HH             @D36SDJO 02082000
         STH   R4,DLFEBEXT+2     HEAD NUMBER  = HH             @DA42402 02083000
         STH   R4,DLFEEEXT+2     HEAD NUMBER  = HH             @DA42402 02084000
         STH   R4,DLFESEEK+2     HEAD NUMBER  = HH             @DA42402 02085000
         STH   R4,DLFESEAR+2     HEAD NUMBER  = HH             @DA42402 02086000
         AH    R5,DLFCYL         ADD CYLINDER START ADDRESS    @D36SDJO 02087000
         STH   R5,DLFSEEK+2      CYLINDER NUMBER               @D36SDJO 02088000
         STH   R5,DLFEBEXT       CYLINDER NUMBER = CC          @DA42402 02089000
         STH   R5,DLFEEEXT       CYLINDER NUMBER = CC          @DA42402 02090000
         STH   R5,DLFESEEK       CYLINDER NUMBER = CC          @DA42402 02091000
         STH   R5,DLFESEAR       CYLINDER NUMBER = CC          @DA42402 02092000
         AIF   (NOT &BG31).LCKGET3                             @D36SDJO 02093000
         CLI   DLFDEVT,DLFRPS    EXTERNAL FILE ON RPS DEV.     @D36SDJO 02094000
         BL    LCKGET40          NO                            @DA42402 02095000
         LR    R5,R1             SAVE DTL ADDRESS              @D36SDJO 02096000
         LH    R1,DLFCCBR+CCBCLS-CCBADR TAKE PUB INDEX FROM    @DA42402 02097000
         N     R1,PHYADMSK              CCB                    @DA42402 02098000
         SR    R0,R0                                           @D36SDJO 02099000
         ICM   R0,M12,DLFLBLK    RECORD LENGTH ON DISK         @D36SDJO 02100000
         IC    R0,DLFSEEK+6      RECORD NUMBER                 @D36SDJO 02101000
         ST    RD,LCKSAVRD       SAVE BASE REGISTER OF CODE    @DA42402 02102000
         ST    R6,LCKSAVR6       SAVE WORK REGISTER FOR LINK   @DA42402 02103000
         L     RD,ARPSR          OBTAIN BASE OF SECTOR CODE    @DA42402 02104000
         USING SVC75,RD          DECLARE SECTOR CALC BASE      @DA42402 02105000
         LA    R4,STARSECT       ROUTINE ADDRESS               @D63ADMK 02106000
         BASR  R6,R4             CALCULATE SECTOR NUMBER       @D63ADMK 02107000
*SGLINK  STARSECT,INPUT=(R0,R1,R6,RD),OUTPUT=R0                @DA42402 02108000
         USING *,R6              TEMPORARY USING FOR RESTORE   @DA42402 02109000
         L     RD,LCKSAVRD       OF REGISTER RD                @DA42402 02110000
         L     R6,LCKSAVR6       AND OF REGISTER R6            @DA42402 02111000
         DROP  R6                                              @DA42402 02112000
         USING SGLOCK,RD         RETURN TO OLD BASE            @DA42402 02113000
         B     LCKGET30          BRANCH OVER SAVE AREA         @DA42402 02114000
LCKSAVRD DC    A(0)              SAVE AREA FOR REGISTER RD     @DA42402 02115000
LCKSAVR6 DC    A(0)              SAVE AREA FOR REGISTER R6     @DA42402 02116000
LCKGET30 LR    R1,R5             RESTORE DTL ADDRESS           @DA42402 02117000
         STC   R0,DLFSEEK+7      STORE SECTOR VALUE            @D36SDJO 02118000
         STC   R0,DLFESECT       STORE SECTOR VALUE            @DA42402 02119000
         MVI   DLFEEXT,X'40'     READMASK:INHIBIT ALL WRITES   @DA42402 02120000
         MVI   DLFELR,X'16'      READOPERATION,COUNT ORIENT    @DA42402 02121000
.LCKGET3 ANOP                                                  @D36SDJO 02122000
LCKGET40 OI    DSHRFLG,LCKRESVD  DISK DRIVE RESERVED           @D36SDJO 02123000
         ST    R15,DISKRR15      SAVE RETURN ADDRESS           @D52QDMK 02124000
         LR    R5,R1                                                    02125000
         LA    R1,DLFCCBR        READ  CCB                     @D36SDJO 02126000
LCKGET50 NI    PUBDLF,XFF-X'80'  RESET DEVICE RESET BIT        @DY45712 02127000
         SVC   15                READ  DISK BLOCK              @D37CDOW 02128000
         WAIT  (1)                                             @D36SDJO 02129000
         TM    PUBDLF,X'80'      HAS DEVICE RESET BEEN RESET   @DY45712 02130000
         BO    LCKGET50          YES, REPEAT THE READ          @DY45712 02131000
         L     R4,IOGET          GET IOGET COUNTER             @D61NDMK 02132000
         AL    R4,F1             INCREMENT                     @D61NDMK 02133000
         BC    5,*+6             IF NOT MAXIMUM REACHED        @D61NDMK 02134000
         BCTR  R4,0              LEAVE MAX VALUE               @D61NDMK 02135000
         ST    R4,IOGET          UPDATE COUNTER                @D61NDMK 02136000
         USING CCBADR,R1                                       @D36SDJO 02137000
         TM    CCBCOM1,DISERR    IRRECOVERABLE I/O ERROR       @D36SDJO 02138000
         DROP  R1                                              @D36SDJO 02139000
         LR    R1,R5             RESTORE DTL ADDRESS           @D36SDJO 02140000
         BOR   RF                YES, STOP DSHR SUPPORT        @D36SDJO 02141000
         L     R4,DLFAREA        I/O AREA                      @D36SDJO 02142000
         B     4(RF)             RETURN TO CALLER              @D36SDJO 02143000
         DROP  RE                                              @D36SDJO 02144000
         EJECT                                                 @D149DIS 02145000
         SPACE 2                                               @D52QDMK 02146000
.**************************************************************@D52QDMK 02147000
.*  L C K D L C                                                @D52QDMK 02148000
.*  CHECK FOR EXTERNAL DEADLOCK SITUATION:                     @D52QDMK 02149000
.*  IF BUFFER EMPTY (RESOURCE NAME NOT STORED) THEN            @D52QDMK 02150000
.*    STORE RESOURCE NAME AND CLEAR RETRY COUNTER              @D52QDMK 02151000
.*  ELSE                                                       @D52QDMK 02152000
.*    INCREMENT COUNT FIELD                                    @D52QDMK 02153000
.*    IF LIMIT IS HIT THEN                                     @D52QDMK 02154000
.*      WRITE MESSAGE                                          @D52QDMK 02155000
.*    END                                                      @D52QDMK 02156000
.*  END                                                        @D52QDMK 02157000
.*  INPUT REGISTER R1 = DTL ADDRESS                            @D52QDMK 02158000
.*                 RC = TCB ADDRESS                            @D52QDMK 02159000
.*                 RF = RETURN ADDRESS                         @D52QDMK 02160000
.*  WORK REGISTER: R0, R3, R4, R5, R7, R9, RE                  @D52QDMK 02161000
.**************************************************************@D52QDMK 02162000
*SGLINK LCKDLC,S,INPUT=(R1,RC,RF),WORK=(R0,R3,R4,R5,R7,R9,RE)  @D52QDMK 02163000
         USING MAPDTL,R1                                       @D52QDMK 02164000
LCKDLC   CLC   TCBWAREA+BUFRESN(12),DTLNAME NAME ALREADY STORED@D52QDMK 02165000
         BNE   LCKDLC1            NO, CLEAR AND STORE          @D52QDMK 02166000
         CLC   TCBWAREA+BUFSLOT(1),BUFROSLT SAME SLOT?         @D52QDMK 02167000
         BE    LCKDLC2            YES, INCREMENT COUNTER       @D52QDMK 02168000
LCKDLC1  XC    TCBWAREA+BUFCOUNT(2),TCBWAREA+BUFCOUNT CLEAR CNT@D52QDMK 02169000
         MVC   TCBWAREA+BUFRESN(12),DTLNAME  STORE RESOURCE NAM@D52QDMK 02170000
LCKDLC2  LH    R4,TCBWAREA+BUFCOUNT                            @D52QDMK 02171000
         LA    R4,1(R4)           INCREMENT RETRY COUNTER      @D52QDMK 02172000
         STH   R4,TCBWAREA+BUFCOUNT                            @D52QDMK 02173000
         MVC   TCBWAREA+BUFSLOT(1),BUFROSLT OWNER'S SLOT       @D52QDMK 02174000
         CH    R4,BUFCNMAX        LIMIT HIT?                   @D52QDMK 02175000
         BNER  RF                 NO, RETURN                   @D52QDMK 02176000
.**************************************************************@D52QDMK 02177000
.*  GET HEADER BLOCK                                           @D52QDMK 02178000
.*  EXTRACT OWNER'S CPUID                                      @D52QDMK 02179000
.*  SETUP MESSAGE TO OPERATOR                                  @D52QDMK 02180000
.**************************************************************@D52QDMK 02181000
LCKDLC3  ST    R1,LCKSAV1         SAVE DTL POINTER             @D52QDMK 02182000
         DROP  R1                                              @D52QDMK 02183000
         L     R1,ADLFCCB        BASE OF CCB/CCW AREA          @D52QDMK 02184000
         USING DLFCCBR,R1                                      @D52QDMK 02185000
         MVC   DLFRESN(12),TCBWAREA+BUFRESN STORE RESOURCE NAME@D52QDMK 02186000
         SLR   R9,R9             CLEAR                         @D52QDMK 02187000
.**************************************************************@D52QDMK 02188000
.* READ DISK BLOCK                                             @D52QDMK 02189000
.* RETRUN (0) = BLOCK NOT FOUND                                @D52QDMK 02190000
.* RETRUN (4) = BLOCK FOUND, CAN CHECK IT NOW                  @D52QDMK 02191000
.**************************************************************@D52QDMK 02192000
         ST    RF,LCKSAVEF+4     SAVE RETRUN ADDRESS           @D52QDMK 02193000
         BAL   RF,LCKGET         GET HEADER                    @D52QDMK 02194000
*SGLINK  LCKGET,INPUT=(R9,RF),WORK=(R0,R3,R5,R7,RE),OUTPUT=R4           02195000
         B     LCKM23            I/O ERROR OR DESTROYED FILE   @D52QDMK 02196000
         L     RF,LCKSAVEF+4     GET RETURN ADDRESS BACK       @D52QDMK 02197000
         SLR   R5,R5             CLEAR                         @D52QDMK 02198000
         IC    R5,BUFROSLT       GET OWNER'S SLOT              @D52QDMK 02199000
         SLL   R5,3              TIMES 8 FOR OFFSET            @D52QDMK 02200000
         AR    R4,R5             PREPARE FOR OWNING CPU        @D52QDMK 02201000
         L     R1,ADLFCCB        BASE OF CCB/CCW AREA          @D52QDMK 02202000
         MVC   TCBWAREA+BUFCPUID(15),LFCPUID(R4)               @D52QDMK 02203000
         UNPK  DLFCPUID(9),LFCPUID(5,R4)                       @D52QDMK 02204000
         UNPK  DLFCPUID+8(9),LFCPUID+4(5,R4)                   @D52QDMK 02205000
         L     R4,DLFTRT                                       @D52QDMK 02206000
         TR    DLFCPUID(16),0(R4)                              @D52QDMK 02207000
         LA    R1,DLFCCBD        OWNER MESSAGE CCB             @D52QDMK 02208000
         DROP  R1                                              @D52QDMK 02209000
         SVC   15                WRITE MESSAGE                 @D52QDMK 02210000
         WAIT  (1)                                             @D52QDMK 02211000
         L     R1,LCKSAV1        RESTORE DTL POINTER           @D52QDMK 02212000
         BR    RF                RETURN                        @D52QDMK 02213000
         EJECT                                                 @D68DDMZ 02214000
         SPACE 2                                               @D68DDMZ 02215000
***************************************************************@D68DDMZ 02216000
*   A RESERVE MIGHT BE LEFT OVER FROM PREVIOUS IPL.            @D68DDMZ 02217000
*   THEREFORE WE DO UNCONDITIONALLY A RELEASE                  @D68DDMZ 02218000
***************************************************************@D68DDMZ 02219000
*SGLINK  LCKREL,S,INPUT=(R8),WORK=(R1)                         @D68DDMZ 02220000
LCKREL   DS    0H                                              @D68DDMZ 02221000
         L     R1,ADLFCCB        BASE OF CCB/CCW AREA          @D68DDMZ 02222000
         USING DLFCCBR,R1                                      @D68DDMZ 02223000
         LA    R1,DLFCCBS        RELEASE DISK UNIT             @D68DDMZ 02224000
         DROP  R1                DROP CCB/CCW AREA             @D68DDMZ 02225000
         SVC   15                EXECUTE RELEASE               @D68DDMZ 02226000
         WAIT  (1)                                             @D68DDMZ 02227000
         USING CCBADR,R1                                       @D68DDMZ 02228000
         TM    CCBCOM1,DISERR    IRRECOVERABLE I/O ERROR       @D68DDMZ 02229000
         BOR   R8                RETURN I/O ERROR              @D68DDMZ 02230000
         B     4(R8)             RELEASE COMPLETED             @D68DDMZ 02231000
         DROP  R1                RELEASE CCB                   @D68DDMZ 02232000
         EJECT                                                 @D149DIS 02233000
         SPACE 2                                               @D149DIS 02234000
.DSHRSUB ANOP                                                  @D36SDJO 02235000
         EJECT                                                 @D52QDMK 02236000
         SPACE 2                                               @D149DIS 02237000
***************************************************************@D51IDMK 02238000
*                                                                       02239000
*   S G L O C K C K .                                                   02240000
*                                                                       02241000
*                                                                       02242000
*   DO DEADLOCKCHECK FOR 2 TASK ID'S                                    02243000
*   THE ACTUAL RUNNING TASK IS CHECKED AGAINST THE TID IN R9            02244000
*                                                                       02245000
*   ENTRY POINT:   SGLOCKCK WITH PARAMETER TASK ID IN R9                02246000
*                                                                       02247000
*   INPUT:         R9 CONTAINS TASK ID OF DEADLOCK CANDIDATE,           02248000
*                  R6 CONTAINS DISPATCHER ADDRESS,                      02249000
*                 R14 CONTAINS RETURN ADDRESS                           02250000
*                                                                       02251000
*   EXITS:         TO R6 IN CASE OF LOCKGATE NOTFREE (RESVCX)           02252000
*                  TO R14 AFTER DEADLOCK CHECK                          02253000
*                                                                       02254000
*   REGS CHANGED:  R15 - RETURNCODE: 0 = NO DEADLOCK                    02255000
*                                    4 = DEADLOCK                       02256000
*                                                                       02257000
*   THIS ROUTINE MUST ME CALLED IN 31 BIT MODE                          02258000
*                                                                       02259000
***************************************************************@D51IDMK 02260000
         SPACE 1                                               @D51IDMK 02261000
         DROP  R13,R11                                         @D52QDMK 02262000
         USING DISP,R6                                         @D52QDMK 02263000
SGLOCKCK DS    0H                                              @D51IDMK 02264000
         L     R15,LOCKBASE                                    @D....MK 02265000
         USING SGLOCK,R15                                               02266000
.**************************************************************@D52QDMK 02267000
.*  SVC110 GATE IS ALREADY CLOSED BY SVC 2 CODE                @DY43802 02268000
.*  SAVE CALLER'S REGISTERS AND SETUP ADDRESSABILITY           @D52QDMK 02269000
.**************************************************************@D52QDMK 02270000
         STM   R14,R13,LCKSAV                                  @D51IDMK 02271000
         DROP  R15                                                      02272000
         LR    R13,R15                                         @D51IDMK 02273000
         LA    R11,X'FFF'(R15)                                 @D51IDMK 02274000
         LA    RB,1(RB)                                        @D51UDMK 02275000
         USING SGLOCK,R13,R11                                           02276000
.**************************************************************@D52QDMK 02277000
.*  SET RETRUN CODE + DUMMY RESOURCE NAME                      @D52QDMK 02278000
.**************************************************************@D52QDMK 02279000
         LA    R4,4               DEFAULT RETURN CODE          @D51IDMK 02280000
         LR    R0,R4              DEFAULT RETURN CODE          @D51IDMK 02281000
         LA    R1,SGLOCKC1        DTL POINTER                  @D52QDMK 02282000
         L     R2,ALOKTABA        DEFAULT FOR DUMMY ENTRIES    @D52QDMK 02283000
         MVI   LOCKPARM,NEWLOCK+LOCKSVC+CHECKFLG               @D52QDMK 02284000
.**************************************************************@D52QDMK 02285000
.*  CHECK IF TASK IN R9 IS 'WAITING FOR LOCKED RESOURCE'       @D52QDMK 02286000
.*  IF NOT OR IF TIBSTATE INDICATES 'WAITING FOR EXTERNAL      @D52QDMK 02287000
.*  LOCKFILE OPERATIONS' THEN NO DEADLOCK IS POSSIBLE          @D52QDMK 02288000
.**************************************************************@D52QDMK 02289000
         SLL   R9,2               MULTIPLY WITH 4              @D66ODOW 02290000
         AL    R9,ATIBATAB        ADDR WITHIN TIBATAB          @D66ODOW 02291000
         L     R9,0(,R9)          TIBPTR OF OWNING TASK        @D66ODOW 02292000
         USING TIBADR,R9                                       @D51IDMK 02293000
         CLI   TIBRQID,RURBND     IS OWNING TASK WAITING       @D51IDMK 02294000
         BNE   SGLOCKC2           NOT RESOURCE BOUND           @D51IDMK 02295000
         AIF   (NOT &BGDSHR).NOEX1                             @DY40814 02296000
*                                                              @DY40761 02297000
* CHECK IF THE SYSTEM LOCK TASK IS WAITING FOR THE LOCK FILE   @DY40761 02298000
*                                                              @DY40761 02299000
         LA    R3,DISEX1          LOAD EXTERNAL LOCK INDICATOR @D52QDMK 02300000
         C     R3,TIBSTATE        LCK WAITING ON LOCK FILE ?   @D52QDMK 02301000
         BE    SGLOCKC2           YES, NO DEADLOCK CHECK       @DY40761 02302000
.NOEX1   ANOP                                                  @DY40814 02303000
         MVC   LCKUTID(2),TID                                  @D51IDMK 02304000
         L     R5,ASRQTAB                                      @D61MPMK 02305000
         NC    RBUSE-SRQTAB(2,R5),FREEVAL  SETUP               @D66ODOW 02306000
         OC    RBUSE-SRQTAB(2,R5),LCKUTID  ..... OWNER         @D66ODOW 02307000
         L     R2,TIBSTATE        RESOURCE WAITED UPON         @D51IDMK 02308000
         N     R2,E1TBSMSK        CLEAR POSSIBLE E1REQ FLAG    @D51IDMK 02309000
         DROP  R9                                              @D51IDMK 02310000
         LA    R6,SGLOCKC2                                     @D51IDMK 02311000
***************************************************************@D51IDMK 02312000
*        R1    POINTS TO THE DUMMY DTL FOR DEADLOCK CHECK               02313000
*        R2    POINTS TO LOCKADR (RESOURCE ON WHICH TASK (R9)           02314000
*              IS WAITING)                                              02315000
*        R6    POINTS TO THE RETURN ADDRESS                             02316000
*        LOCKPARM  CONTAINS SPECIAL INDICATION FOR DEADLOCK             02317000
*                  CHECK ONLY                                           02318000
***************************************************************@D51IDMK 02319000
         B     SVC63F                                          @D51IDMK 02320000
LCKSAV   DC    16F'0'  TO CONTAIN ALL REGS                     @D51IDMK 02321000
SGLOCKC1 DTL   NAME=DEADLOCKCHEC,CONTROL=E,LOCKOPT=1           @D51IDMK 02322000
.**************************************************************@D52QDMK 02323000
.*  IF RETURNCODE HAS NOT CHANGED THEN NO DEADLOCK WAS DETECTED@D52QDMK 02324000
.**************************************************************@D52QDMK 02325000
SGLOCKC2 L     R6,DISPAD         GET DISPATCHER ADDRESS BACK   @DY42602 02326000
         CLR   R4,R0              RETURN CODE                  @D52QDMK 02327000
         BNZ   SGLOCKC4                                        @D51IDMK 02328000
.**************************************************************@D52QDMK 02329000
.*  RETURNCODE = 0: NO DEADLOCK                                @D52QDMK 02330000
.**************************************************************@D52QDMK 02331000
         SLR   R0,R0                                           @DY42602 02332000
SGLOCKC4 LR    R4,R0             SAVE THIS RETURN CODE         @DY42602 02333000
         BAL   R14,SV6364CN      UPDATE                        @D52XDMK 02334000
         LR    R15,R0            GET RETURNCODE BACK           @D52QDMK 02335000
         L     R14,LCKSAV                                      @D51IDMK 02336000
         LM    R0,R13,LCKSAV+8                                 @D51IDMK 02337000
         BSM   0,R14                                           @D64ADMK 02338000
         DROP  R6                                              @D52QDMK 02339000
         EJECT                                                          02340000
***************************************************************@D149DIS 02341000
*                                                                       02342000
*   L O C K G A T E .                                          @D356DJO 02343000
*                                                              @D356DJO 02344000
*   SET SVC63/64 GATE.                                         @D356DJO 02345000
*   VALIDATE PARAMETER LIST LIMITS AND FORMAT.                 @D356DJO 02346000
*                                                                       02347000
*   ENTRY POINT:   LOCKGATE (WITH PARAMETER VALIDATION),                02348000
*                  LOKGATE2 (WITHOUT PARAMETER VALIDATION)     @D356DJO 02349000
*                                                                       02350000
*   INPUT:         RF CONTAINS RETURN ADDRESS,                          02351000
*                  REGISTER 1 POINTS TO A PARAMETER FIELD               02352000
*                  (USE/RELEASE ONLY).                                  02353000
*                                                                       02354000
*   SUBROUTINES:   VALIDSVA                                             02355000
*                                                                       02356000
*   EXITS:         TO ADDRESS IN RF - NORMAL CASE                       02357000
*                  TO RESVCX - LOCKTAB IN USE BY ANOTHER TASK           02358000
*                  TO ERR25 - INVALID PARAMETER LIST LIMITS             02359000
*                                                                       02360000
*   REGS CHANGED:  R2,R5,R8 (BY SUBROUTINE VALIDSVA)           @D356DJO 02361000
*                                                                       02362000
***************************************************************@D149DIS 02363000
         SPACE 1                                                        02364000
***************************************************************@D149DIS 02365000
*   VALIDATE PARAMETER LIST LIMITS                                      02366000
***************************************************************@D149DIS 02367000
         USING DISP,R6                                         @D52QDMK 02368000
LOCKGATE DS    0H                                              @D63ADMK 02369000
         ICM   R1,8,F0            TAKE 3 BYTE ADDRESS          @D63ADMK 02370000
         LA    R2,3(R1)           END ADDRESS OF PARAMETER     @D63ADMK 02371000
         BAL   R8,VALIDSVA .      VALIDATE 4-BYTE PARM FIELD   @D356DJO 02372000
*SGLINK VALIDSVA,INPUT=(R1,R2,R6,R8),WORK=(R2,R5,R8)           @D52XDMK 02373000
         B     LOKGATE3           CONTINUE                     @D63ADMK 02374000
LOKGATE2 DS    0H                                              @D52QDMK 02375000
         L     R5,TCBSAVE                                      @D63ADMK 02376000
         TM    SVEPSW2-SVEARA(R5),SVEPAM31 IS USER IN AMODE 31 @D63ADMK 02377000
         BO    LOKGATE3           YES                          @D63ADMK 02378000
         ICM   R1,8,F0            NO, TAKE 3 BYTE ADDRESS      @D63ADMK 02379000
LOKGATE3 DS    0H                                              @D63ADMK 02380000
         MVI   RID+D1,USEBND      INDICATE RESOURCE TO BE USED @D356DJO 02381000
         L     R5,ASRQTAB                                      @D61MPMK 02382000
         LA    R5,SRQUSE-SRQTAB(,R5)                           @D61MPMK 02383000
         TM    RBUSE-SRQUSE(R5),FREEBIT RESOURCE AVAILABLE ?   @D66ODOW 02384000
         BO    LOKGATED           RETURN IF YES                @D66ODOW 02385000
         B     RESVCX             RE-ISSUE SVC                 @D356DJO 02386000
LOKGATED XC    LOCKPARM(PARMEND-LOCKPARM),LOCKPARM CLEAR       @D36SDJO 02387000
*                                 LOCK/UNLOCK WORK FIELDS      @D36SDJO 02388000
         MVC   LCKUTID(2),TID     SAVE TID OF USER TASK        @D36SDJO 02389000
         BR    RF                                              @D356DJO 02390000
         DROP  R6                                              @D52QDMK 02391000
         EJECT                                                 @D149DIS 02392000
         SPACE 2                                               @D149DIS 02393000
***************************************************************@D52XDMK 02394000
*   STATISTICS COUNTER ROUTINE                                 @D52XDMK 02395000
*   UPDATE COUNTERS FOR LOCK/UNLOCK RETURN CODES               @D52XDMK 02396000
*   AND EXTERNAL/INTERNAL REQUESTS                             @D52XDMK 02397000
*                                                              @D52XDMK 02398000
*   INPUT:   R1  DTL ADDRESS                                   @D52XDMK 02399000
*            R4  SVC RETURN CODE FOR USER                      @D52XDMK 02400000
*            R5  COUNTER BASE ADDRESS                          @D52XDMK 02401000
*            R14 RETURN ADDRESS                                @D52XDMK 02402000
*                                                              @D52XDMK 02403000
*   REGISTERS                                                  @D52XDMK 02404000
*   CHANGED:     R4,R5                                         @D52XDMK 02405000
*                                                              @D52XDMK 02406000
*   OUTPUT:  NONE                                              @D52XDMK 02407000
*                                                              @D52XDMK 02408000
***************************************************************@D52XDMK 02409000
         USING MAPDTL,R1                                       @D52XDMK 02410000
SV6364CN STM   RC,RF,SV110SCF     SAVE REGISTER                @DY43697 02411000
         BAL   RF,SVC110TR        WRITE TRACE ENTRY            @D52QDMK 02412000
         LA    RF,DISEX1         EXTERNAL LOCK INDICATION      @DY45715 02413000
         CR    RF,R1             WAIT FOR EXTERNAL LOCK?       @DY45715 02414000
         BE    SV6364CW          YES, DON'T TRACE AGAIN        @DY45715 02415000
         SLR   R5,R5             PREPARE FOR IC                @D68JMJS 02416000
         TM    LOCKPARM,LOCKSVC  LOCK?                         @D68JMJS 02417000
         BNO   SV6364CP          NO,                           @D68JMJS 02418000
         TM    LOCKFLG2,LOCKEXT  EXTERNAL SET IN LOCK TABLE?   @D68JMJS 02419000
         BNO   SV6364CP          NO,                           @D68JMJS 02420000
         OI    SDAIDP,SDAIDPEX   SET INDICATOR FOR SDAID       @D68JMJS 02421000
SV6364CP ICM   R5,3,SDAIDP       SDAIDP AND LOCKPARM IN R5     @D68JMJS 02422000
* R1=DTL, R2=LOCKTAB, R4=RC, R5=SDAIDP AND LOCKPARM            @D68JMJS 02423000
         MC    $MCLOCK,$MCSDAID   PASS CONTROL TO SDAID        @D68JMJS 02424000
         MVI   SDAIDP,ZERO        RESET SDAID FLAG             @D68JMJS 02425000
         TM    LCKTRCPR,LCKTRON    TRACE ON?                   @DY43697 02426000
         BZ    SV6364CW            NO                          @DY43697 02427000
         CH    R4,H0             ZERO RETURN CODE?             @DY43697 02428000
         BE    SV6364CW          YES, DON'T TRACE              @DY43697 02429000
         LR    R5,R4             SAVE                          @DY43697 02430000
         BAL   RF,LCKACT          ACTIVATE SYSTEM TASK         @DY43697 02431000
         B     SV6364CU           IF ERROR THEN EXIT           @DY43697 02432000
         L     R15,ALCKWRIT        PRINT TO                    @DY43697 02433000
         USING LCKWRITE,R15                                    @DY43697 02434000
         BAL   R4,LCKPRT30         ... CONSOLE                 @DY43697 02435000
         DROP  R15                                             @DY43697 02436000
         BAL   RF,LCKDEACT        DEACTIVATE SYSTEM TASK       @DY43697 02437000
SV6364CU LR    R4,R5             RESTORE                       @DY43697 02438000
SV6364CW L     RC,ASVC110C        GET BASE FOR COUNTERS        @DY43697 02439000
         USING SVC110IN,RC        GET BASE FOR COUNTERS        @DY43697 02440000
         LA    R5,LOCKRC00        ASSUME LOCK/USE              @DY43697 02441000
         TM    LOCKPARM,NEWLOCK+LOCKSVC+CHECKFLG               @DY43697 02442000
         BNO   SV6364CX                                        @DY43697 02443000
         LA    R5,DEADRC00        IT'S DEADLOCKCHECK           @DY43697 02444000
         B     SV6364CY                                        @DY43697 02445000
SV6364CX TM    LOCKPARM,LOCKSVC                                @DY43697 02446000
         BO    SV6364CY                                        @DY43697 02447000
         LA    R5,ULOCKRC0        IT'S UNLOCK/RELEASE          @DY43697 02448000
SV6364CY AR    R5,R4              GET COUNTER OFFSET           @DY43697 02449000
         TM    LOCKPARM,LOCKSVC   LOCK OR UNLOCK               @D61NDMK 02450000
         BZ    SV6364C0           UNLOCK                       @D61NDMK 02451000
         TM    LOCKPARM,CHECKFLG  DEADLOCKCHECK?               @D61NDMK 02452000
         BO    SV6364C0           YES                          @D61NDMK 02453000
         AR    R5,R4              GET COUNTER OFFSET FOR LOCK  @D61NDMK 02454000
         TM    DTLFLG2,DTLVOL+DTLEXTR    EXTERNAL LOCKING      @D61NDMK 02455000
         BZ    SV6364C0           NO, UPDATE INTERNAL COUNTER  @D61NDMK 02456000
         LA    R5,4(,R5)          GET COUNTER OFFSET FOR EXT   @D61NDMK 02457000
SV6364C0 L     R4,0(,R5)          GET RC COUNTER               @D61NDMK 02458000
         AL    R4,F1              INCREMENT                    @D52XDMK 02459000
         BC    5,*+6              IF NOT MAXIMUM REACHED       @D52XDMK 02460000
         BCTR  R4,0               LEAVE MAX VALUE              @D52XDMK 02461000
         ST    R4,0(,R5)          UPDATE COUNTER               @D52XDMK 02462000
         TM    LOCKPARM,LOCKSVC   LOCK OR UNLOCK               @D52XDMK 02463000
         BZ    SV6364C2           UNLOCK                       @D52XDMK 02464000
         TM    LOCKPARM,CHECKFLG  DEADLOCKCHECK?               @D52XDMK 02465000
         BO    SV6364C2           YES                          @D52XDMK 02466000
         TM    DTLFLG2,DTLVOL+DTLEXTR    EXTERNAL LOCKING      @D52XDMK 02467000
         BZ    SV6364C1           NO, UPDATE INTERNAL COUNTER  @D52XDMK 02468000
         L     R4,SVC110EX        GET COUNTER ADDRESS          @D52XDMK 02469000
         AL    R4,F1              INCREMENT                    @D52XDMK 02470000
         BC    5,*+6              IF NOT MAXIMUM REACHED       @D52XDMK 02471000
         BCTR  R4,0               LEAVE MAX VALUE              @D52XDMK 02472000
         ST    R4,SVC110EX        UPDATE COUNTER               @D52XDMK 02473000
         B     SV6364C2                                        @D52XDMK 02474000
SV6364C1 L     R4,SVC110IN        GET COUNTER ADDRESS          @D52XDMK 02475000
         AL    R4,F1              INCREMENT                    @D52XDMK 02476000
         BC    5,*+6              IF NOT MAXIMUM REACHED       @D52XDMK 02477000
         BCTR  R4,0               LEAVE MAX VALUE              @D52XDMK 02478000
         ST    R4,SVC110IN        UPDATE COUNTER               @D52XDMK 02479000
         DROP  RC                 GET BASE FOR COUNTERS        @DY43697 02480000
SV6364C2 LM    RC,RF,SV110SCF     RELOAD REGISTERS             @DY43697 02481000
         BR    R14                                             @D52XDMK 02482000
         DROP  R1                                              @D52XDMK 02483000
         EJECT                                                 @D52XDMK 02484000
         SPACE 2                                               @D52XDMK 02485000
***************************************************************@D149DIS 02486000
*   EMULATION SUBROUTINE.                                      @D356DJO 02487000
*   TRANSLATE OLD USE/RELEASE SVC INTO LOCK/UNLOCK SVC.        @D356DJO 02488000
*   BUILD DUMMY DTL AND LOAD ITS ADDRESS INTO REGISTER 1.      @D356DJO 02489000
*   VALIDATE 8-BYTE RESOURCE NAME (TYPE 3 RESOURCE)            @D356DJO 02490000
*                                                              @D356DJO 02491000
*   INPUT:   R3  PARAMETER LIST ADDRESS                                 02492000
*            R0  ADDRESS OF 8-BYTE RESOURCE NAME FIELD         @D356DJO 02493000
*                                                              @D356DJO 02494000
*   REGISTERS    R1 WORK REGISTER                              @D356DJO 02495000
*   CHANGED:     R2, R5, R8 (BY SUBROUTINE VALIDSVA).          @D356DJO 02496000
*                                                              @D356DJO 02497000
*   OUTPUT:  R1  ADDRESS OF DUMMY DTL                          @D356DJO 02498000
*                                                              @D356DJO 02499000
***************************************************************@D149DIS 02500000
         USING USEPARM,R3                                      @D356DJO 02501000
         USING MAPDTL,R1                                       @D36SDJO 02502000
         USING DISP,R6                                         @D52QDMK 02503000
SV6364EM CLI   USELISTL,ZERO      YES.. MORE THAN ONE OPERD             02504000
         BNE   ERR21              YES.. CANCEL(ILLEGAL SVC)             02505000
         CLI   USERESCD,X'E0'     NAMED RESOURCE REQ.                   02506000
         BNE   ERR21              NO..                         @D36SDJO 02507000
***************************************************************@D149DIS 02508000
*   - VALIDATE NAME FIELD LIMITS                                        02509000
***************************************************************@D149DIS 02510000
         LR    R1,R0              FIRST BYTE OF NAME FIELD              02511000
         LA    R2,7(R1)           AND LAST BYTE                @D356DJO 02512000
         BAL   R8,VALIDSVA         VALIDATE NAME FIELD                  02513000
*SGLINK VALIDSVA,INPUT=(R1,R2,R6,R8),WORK=(R2,R5,R8)           @D52XDMK 02514000
         LR    R2,R1              ADDRESS OF NAME FIELD        @D356DJO 02515000
         LA    R1,DUMMYDTL                                     @D356DJO 02516000
         AGO   .SV63EMU                                        @D36SDJO 02517000
         B     SV6364E4                                        @D356DJO 02518000
SV6364E2 LA    R1,DUMMYDTL        WHERE TO BUILD DTL           @D356DJO 02519000
         CLI   USERESCD,X'80'     TYPE 1 RESOURCE              @D356DJO 02520000
         BNE   SV6364E3           NO, SHOULD BY TYPE 2         @D356DJO 02521000
         LA    R2,TYP1RUR         SYSPL                        @D356DJO 02522000
         B     SV6364E4                                        @D356DJO 02523000
SV6364E3 CLI   USERESCD,X'C0'     TYPE 2 RESOURCE              @D356DJO 02524000
         BNE   ERR21              NO, ERROR                    @D356DJO 02525000
         SR    R2,R2                                           @D356DJO 02526000
         IC    R2,USERESCD+1      RESOURCE NUMBER              @D356DJO 02527000
         AR    R2,R2              * MULTIPLY BY                @D356DJO 02528000
         AR    R2,R2              * NAME LENGTH                @D356DJO 02529000
         AR    R2,R2              * =8                         @D356DJO 02530000
         A     R2,ATYP2RUR        FIRST TYPE TWO NAME          @D356DJO 02531000
.SV63EMU ANOP                                                  @D36SDJO 02532000
SV6364E4 MVC   DTLNAME(8),0(R2)   MOVE RESOURCE NAME           @D356DJO 02533000
         MVI   DTLFLG1,DTLOPT1    LOCKOPT=1                    @D356DJO 02534000
         MVI   DTLFLG2,ZERO       CLEAR OTHER FLAGS            @D356DJO 02535000
         MVC   TRCRESN,DTLNAME    SAVE RESOURCE NAME FOR TRACE @D52XDMK 02536000
         ST    R1,SV110S1         SAVE DTL POINTER             @D52QDMK 02537000
         MVC   TRCFLG1(2),DTLFLG1 SAVE DTL FLAGS FOR TRACING   @D52XDMK 02538000
         TM    USEFLAGS,USES      SHARE OPTION                 @D356DJO 02539000
         BOR   RF                 YES                          @D356DJO 02540000
         OI    DTLFLG1,DTLEXC     CONTROL=E                    @D356DJO 02541000
         MVC   TRCFLG1(2),DTLFLG1 SAVE DTL FLAGS FOR TRACING   @D52XDMK 02542000
         BR    RF                 RETURN TO CALLER             @D356DJO 02543000
         DROP  R3                                                       02544000
         DROP  R6                                              @D52QDMK 02545000
         EJECT                                                 @D149DIS 02546000
         SPACE 2                                               @D149DIS 02547000
***************************************************************@D149DIS 02548000
*                                                                       02549000
*   SCAN LOCKTAB FOR A RESOURCE NAME                                    02550000
*   WHICH EQUALS THE RESOURCE NAME IN THE DTL.                 @D356DJO 02551000
*   ADDITIONAL FUNCTION: FIND FREE PLACE IN LOCKTAB.           @D356DJO 02552000
*                                                                       02553000
*   ENTRY POINTS:  SV6364R                                     @D356DJO 02554000
*                                                                       02555000
*   INPUT:         RF CONTAINS RETURN ADDRESS,                          02556000
*                  R1 CONTAINS ADDRESS OF DTL,                 @D356DJO 02557000
*                                                                       02558000
*   OUTPUT:        R2 CONTAINS ADDRESS OF LOCKTAB ENTRY        @D356DJO 02559000
*                  R7 CONTAINS ZERO OR ADDRESS OF FIRST FREE ENTRY      02560000
*                                                                       02561000
*   EXIT:          IF LOCKTAB ENTRY FOUND: TO ADDRESS IN RF+4  @D356DJO 02562000
*                  IF LOCKTAB ENTRY NOT FOUND: TO ADDRESS IN RF         02563000
*                                                                       02564000
*   SUBROUTINES:   NONE                                                 02565000
*                                                                       02566000
*   REGS CHANGED:  R2,R7,R8,R9                                          02567000
*                                                                       02568000
***************************************************************@D149DIS 02569000
         SPACE 1                                                        02570000
***************************************************************@D149DIS 02571000
*   - SEARCH POOL FOR THIS RESOURCE NAME                                02572000
***************************************************************@D149DIS 02573000
*SGLINK  SV6364R,S,INPUT=(R1,RF),OUTPUT=(R2,R7),WORK=(R8,R9)   @D149DIS 02574000
SV6364R  L     R14,ASV6364T        ADDITIONAL PROTECTION       @DY43697 02575000
         BALR  R12,R14             ... MECHANISM               @DY43697 02576000
         SR    R7,R7              NO FREE TABLE ENTRY FOUND    @D356DJO 02577000
         L     R2,ALOKTABA        FIRST LOCKTAB ENTRY          @D37CDOW 02578000
SV6364R2 TM    LOCKFLG2,LOCKUSED  ENTRY IN USE                 @D356DJO 02579000
         BO    SV6364R6           YES, TEST RESOURCE NAME      @D356DJO 02580000
         LTR   R7,R7              ALREADY FREE SLOT FOUND      @D37CDOW 02581000
         BNZ   SV6364R4                                        @D37CDOW 02582000
         LR    R7,R2              SAVE ADDRESS OF FREE SLOT    @D356DJO 02583000
SV6364R4 ST    R2,LASTLOCK        SAVE LAST LOCKTAB PTR        @D14BDIS 02584000
         L     R2,LOCKPTR         POINT TO NEXT TABLE ENTRY    @D37CDOW 02585000
         LTR   R2,R2              IS THIS LAST ENTRY           @D37CDOW 02586000
         BNZ   SV6364R2           NO PROCESS IT                @D37CDOW 02587000
         LTR   R7,R7              UNUSED ENTRY FOUND           @D37CDOW 02588000
         BNZR  RF                 YES RETURN                   @D37CDOW 02589000
         STM   RF,R1,SV110SAV     SAVE WORKREG                 @D37CDOW 02590000
         LA    R0,SV63VISL        GETVIS STORAGE FOR ONE ENTRY @D149DIS 02591000
         LA    R1,LOCKPLID        CORRECT POOL-ID              @D37CDOW 02592000
***************************************************************@D149DIS 02593000
* ALLOCATE GETVIS SPACE FOR ONE LOCKTAB ENTRY                  @D149DIS 02594000
***************************************************************@D149DIS 02595000
         SGETVIS LENGTH=(0),SPID=(1),LOC=ANY                   @D64ADMK 02596000
         LTR   RF,RF              STORAGE AVAILABLE            @D37CDOW 02597000
         BNZ   SV6364R7           RETURN WITH CLEAR REG 7      @D37CDOW 02598000
         L     RF,LASTLOCK        ADDR OF FREE LOCKTAB ENTRY   @D37CDOW 02599000
         LR    R7,R1                                           @D37CDOW 02600000
         ST    R7,LOCKPTR-LOCKADR(RF) CHAIN ENTRIES TO LOCKTAB @D37CDOW 02601000
         ST    RF,LOCKBPTR-LOCKADR(R7) STORE BACKWARD PTR      @D14BDIS 02602000
SV6364R7 EQU   *                                               @D37CDOW 02603000
         LM    RF,R1,SV110SAV     RELOAD REGISTERS             @D37CDOW 02604000
         BR    RF                 RETURN NOT FOUND             @D356DJO 02605000
SV6364R6 CLC   LOCKRESN,DTLNAME   COMPARE RESOURCE NAMES       @D356DJO 02606000
         BNE   SV6364R4           POINT TO NEXT ENTRY          @D356DJO 02607000
         TM    DTLFLG2,DTLPART    OWNER=PARTITION              @D36SDJO 02608000
         BO    SV6364R8           YES                          @D36SDJO 02609000
         TM    LOCKFLG2,LOCKPART  LOCKED FOR PARTITION         @D36SDJO 02610000
         BNO   8(RF)              NO, O.K.                     @D36SDJO 02611000
         B     4(RF)              NAME FOUND, BUT INCONSISTENT @D356DJO 02612000
SV6364R8 TM    LOCKFLG2,LOCKPART  OWNER=PARTITION              @D36SDJO 02613000
         BO    8(RF)              YES, O.K.                    @D36SDJO 02614000
         B     4(RF)              NO, INCONSISTENT             @D36SDJO 02615000
         EJECT                                                 @D149DIS 02616000
         SPACE 2                                               @D149DIS 02617000
***************************************************************@D149DIS 02618000
*                                                                       02619000
*   ISSUE SGETVIS TO GET NEW STORAGE FOR OWNER ELEMENTS                 02620000
*                                                                       02621000
*   ENTRY POINTS:  SV6364OE                                             02622000
*                                                                       02623000
*   INPUT:         R8 CONTAINS RETURN ADDRESS                           02624000
*                                                                       02625000
*   OUTPUT:        R5 CONTAINS ADDR OF FREE OWNER ELEMENT               02626000
*                                                                       02627000
*   EXIT:          TO ADDR IN R8 IF SPACE AVAILABLE                     02628000
*                  TO SVC63L IF NO MORE GETVIS SPACE AVAILABLE          02629000
*                                                                       02630000
***************************************************************@D149DIS 02631000
         SPACE 1                                                        02632000
SV6364OE EQU   *                                               @D37CDOW 02633000
         STM   RF,R1,SV110SAV                                  @D14BDIS 02634000
         LA    R0,SV63VISL        GETVIS STORAGE FOR TWO ELEM. @D37CDOW 02635000
         LA    R1,LOCKPLID                                     @D37CDOW 02636000
***************************************************************@D149DIS 02637000
* ALLOCATE GETVIS SPACE FOR TWO OWNER ELEMENTS                 @D149DIS 02638000
***************************************************************@D149DIS 02639000
         SGETVIS LENGTH=(0),SPID=(1),LOC=ANY                   @D64ADMK 02640000
         LTR   RF,RF              STORAGE AVAILABLE            @D37CDOW 02641000
         BNZ   SV6364SA           GO TO DEADLOCK DETECTION     @D14BDIS 02642000
         LR    R5,R1              ADDR OF FREE OWNER ELEMENT   @D37CDOW 02643000
         ST    R5,LOKOFRL         NEW FREELIST POINTER         @D37CDOW 02644000
         LA    R1,LOKOLEN(R1)     FORMAT GETVIS SPACE          @D14BDIS 02645000
         ST    R1,LOKOCHN-LOKOADR(,R5) STORE FORWARD PTR       @DA24190 02646000
         LM    RF,R1,SV110SAV                                  @D37CDOW 02647000
         BR    R8                                              @D37CDOW 02648000
SV6364SA LM    RF,R1,SV110SAV                                  @D14BDIS 02649000
         B     SVC63L                                          @D14BDIS 02650000
         EJECT                                                          02651000
***************************************************************@D51IDMK 02652000
*                                                                       02653000
*   S V C 6 3 6 4 Q                                                     02654000
*                                                                       02655000
*                                                                       02656000
*   CHAIN LOCKTAB ENTRY AT END OF SPECIAL QUEUE.                        02657000
*   THIS QUEUE CONTAINS ALL LOCKTAB ENTRIES WHICH HAVE REQUEST ELEMENTS 02658000
*   CHAINED. THE NEXT UNLOCK WILL TRY TO DO REALLOCATION OF THOSE       02659000
*   RESOURCES.                                                          02660000
*   ENTRY POINT:   SVC6364Q WITH PARAMETER LOCKTAB PTR IN R2            02661000
*                                                                       02662000
*   INPUT:         R2 CONTAINS LOCKTAB PTR OF THIS RESOURCE             02663000
*                  R15 CONTAINS RETURN ADDRESS                          02664000
*                                                                       02665000
*   EXITS:         TO R15                                               02666000
*                                                                       02667000
*   REGS CHANGED:  WORKREGISTERS R7, R9, R12                            02668000
*                                                                       02669000
***************************************************************@D51UDMK 02670000
         SPACE 1                                               @D51UDMK 02671000
SVC6364Q L     RC,RQBASPTR        GET HEAD OF SPECIAL QUEUE    @D52QDMK 02672000
         LTR   RC,RC              IS SPECIAL QUEUE EMPTY       @D52QDMK 02673000
         BNZ   SV6364Q2           NO, CHECK IF ALREADY IN QUEUE@D52QDMK 02674000
.**************************************************************@D52QDMK 02675000
.*IF SPECIAL QUEUE IS EMPTY THEN CREATE A FIRST ENTRY          @D52QDMK 02676000
.*OTHER CHANGES NOT NECESSARY                                  @D52QDMK 02677000
.**************************************************************@D52QDMK 02678000
         ST    R2,RQBASPTR        UPDATE FIRST ELEMENT POINTER @D52QDMK 02679000
         ST    R2,RQENDPTR        UPDATE LAST ELEMENT POINTER  @D52QDMK 02680000
         B     SV6364Q8           GO TO RETURN                 @D52QDMK 02681000
.**************************************************************@D52QDMK 02682000
.*CHECK IF THIS ENTRY IS ALREADY IN SPECIAL QUEUE              @D52QDMK 02683000
.*IF YES, THEN DO NOTHING                                      @D52QDMK 02684000
.*IF NO, THEN QUEUE TO THE END                                 @D52QDMK 02685000
.**************************************************************@D52QDMK 02686000
SV6364Q2 CR    RC,R2              IS LOCKTAB ENTRY IN SP. QUEUE@D52QDMK 02687000
         BE    SV6364Q8           YES, GO TO RETURN            @D52QDMK 02688000
         C     RC,RQENDPTR        END OF SPECIAL QUEUE?        @D52QDMK 02689000
         BE    SV6364Q4           YES,AND NOT FOUND -> QUEUE IN@D52QDMK 02690000
         L     RC,LOCKPTR-LOCKADR(,RC) GET NEXT QUEUE ENRTY    @D52QDMK 02691000
         B     SV6364Q2           GO AND CHECK NEXT ENTRY      @D52QDMK 02692000
.**************************************************************@D52QDMK 02693000
.*TAKE LOCKTAB ENTRY OUT OF ACTUAL POSITION AND QUEUE          @D52QDMK 02694000
.*IT AT THE END OF THE SPECIAL QUEUE                           @D52QDMK 02695000
.*RC IS NOW RQENDPTR                                           @D52QDMK 02696000
.*TO REACH HERE WE MUST HAVE AT LEAST 2 LOCKTAB ENTRIES CHAINED@D52QDMK 02697000
.*AND THE SPECIAL QUEUE IS ALREADY NOT EMPTY                   @D52QDMK 02698000
.*1.     : QUEUE OUT OF ACTUAL POSITION                        @D52QDMK 02699000
.**************************************************************@D52QDMK 02700000
SV6364Q4 L     R9,LOCKPTR         GET FWD LOCKTAB ENTRY        @D52QDMK 02701000
         L     R7,LOCKBPTR        GET BWD LOCKTAB ENTRY        @D52QDMK 02702000
.**************************************************************@D52QDMK 02703000
.*1.1.   : MODIFY THE FWD LOCKTAB ENTRY                        @D52QDMK 02704000
.**************************************************************@D52QDMK 02705000
         LTR   R9,R9              IS THERE A FWD LOCKTAB ENTRY?@D52QDMK 02706000
         BZ    SV6364Q5           NO, GO AND UPDATE BWD ELEMENT@D52QDMK 02707000
         ST    R7,LOCKBPTR-LOCKADR(,R9) NEW BWD PTR            @D52QDMK 02708000
         LTR   R7,R7              IS THERE A BWD LOCKTAB ENTRY?@D52QDMK 02709000
         BNZ   SV6364Q5           YES,GO AND UPDATE BWD ELEMENT@D52QDMK 02710000
         ST    R9,ALOKTABA        NEW HEAD OF LOCKTAB          @D52QDMK 02711000
         B     SV6364Q6           SKIP UPDATE OF BWD ELEMENT   @D52QDMK 02712000
.**************************************************************@D52QDMK 02713000
.*1.2.   : MODIFY THE BWD LOCKTAB ENTRY                        @D52QDMK 02714000
.**************************************************************@D52QDMK 02715000
SV6364Q5 ST    R9,LOCKPTR-LOCKADR(,R7) NEW FWD PTR             @D52QDMK 02716000
.**************************************************************@D52QDMK 02717000
.*2.     : QUEUE TO END OF SPECIAL QUEUE                       @D52QDMK 02718000
.*R7 AND R9 CAN BE REUSED                                      @D52QDMK 02719000
.*RC STILL POINTS TO THE LAST ELEMENT IN THE SPECIAL QUEUE     @D52QDMK 02720000
.**************************************************************@D52QDMK 02721000
SV6364Q6 L     R9,LOCKPTR-LOCKADR(,RC) GET FWD LOCKTAB ENTRY   @D52QDMK 02722000
*                                 BEHIND SPECIAL QUEUE         @D52QDMK 02723000
         LTR   R9,R9              IS THERE A FWD LOCKTAB ENTRY?@D52QDMK 02724000
         BZ    SV6364Q7           NO, GO AND UPDATE ACT ELEMENT@D52QDMK 02725000
.**************************************************************@D52QDMK 02726000
.*2.1.   : MODIFY THE SPECIAL QUEUE FWD LOCKTAB ENTRY          @D52QDMK 02727000
.**************************************************************@D52QDMK 02728000
         ST    R2,LOCKBPTR-LOCKADR(,R9) NEW BWD PTR            @D52QDMK 02729000
.**************************************************************@D52QDMK 02730000
.*2.2.   : MODIFY THE ACTUAL LOCKTAB ENTRY                     @D52QDMK 02731000
.**************************************************************@D52QDMK 02732000
SV6364Q7 ST    R9,LOCKPTR         NEW FWD PTR                  @D52QDMK 02733000
         ST    RC,LOCKBPTR        NEW BWD PTR                  @D52QDMK 02734000
         ST    R2,RQENDPTR        NEW SPECIAL QUEUE END PTR    @D52QDMK 02735000
.**************************************************************@D52QDMK 02736000
.*2.3.   : MODIFY THE OLD SPECIAL QUEUE END LOCKTAB ENTRY      @D52QDMK 02737000
.**************************************************************@D52QDMK 02738000
         ST    R2,LOCKPTR-LOCKADR(,RC) NEW FWD PTR             @D52QDMK 02739000
SV6364Q8 BR    RF                 RETURN                       @D51UDMK 02740000
         EJECT                                                          02741000
*--------------------------------------------------------------         02742000
*                                                                       02743000
*    U N L O C K   RESOURCE .                                           02744000
*                                                                       02745000
*   ENTRY POINTS:  SVC64  FROM  RELEASE SVC.                            02746000
*                  SVC64C FROM UNLOCK SVC (SVC110).            @D356DJO 02747000
*                  SVC110T  FROM UNLOCK ALL SVC (SVC110)                02748000
*                  SVC110W  FROM UNLOCK JC=SYSID (SVC110)               02749000
*                                                                       02750000
*    INPUT:         R1 POINTS TO A PARAMETER LIST OF                    02751000
*    (RELEASE)      THE FORMAT DESCRIBED BY DSECT 'USEPARM'.            02752000
*                   R0 POINTS TO AN 8-BYTE NAME FIELD                   02753000
*                                                                       02754000
*    INPUT:         R1 CONTAINS THE ADDRESS OF A DTL.                   02755000
*    (UNLOCK)       R0 CONTAINS SOME PARAMETER FLAGS.                   02756000
*                                                                       02757000
*    OUTPUT:        IF NO ERROR IS FOUND -                              02758000
*                   PROPERLY UPDATED LOCKTAB,                           02759000
*                   TASKS WAITING FOR ONE OF THE RELEASED               02760000
*                   RESOURCES ARE MADE READY.                           02761000
*                                                                       02762000
*        SUBROUTINES:   LOCKGATE, VALIDSVA, SV6364R, SV6364EM. @D356DJO 02763000
*                                                                       02764000
*     RETURN CODE:                                             @D356DJO 02765000
*     FOR RELEASE REQUESTS NO RETURN CODE IS PROVIDED.         @D356DJO 02766000
*     IF NO RESOURCE HAS BEEN RELEASED, BYTE ZERO OF REGISTER1 @D356DJO 02767000
*     CONTAINS THE FLAG X'01' (RESOURCE NOT FOUND)             @D356DJO 02768000
*                                                                       02769000
*     FOR UNLOCK REQUESTS THE FOLLOWING RETURN CODES ARE       @D356DJO 02770000
*     PROVIDED:                                                @D356DJO 02771000
*     R.C. = 0     REQUEST EXECUTED SUCCESSFULLY               @D356DJO 02772000
*          = 4     RESOURCE IS NOT LOCKED FOR THE              @D356DJO 02773000
*                  ISSUING TASK/PARTITION                      @D356DJO 02774000
*          = 8     DTL FORMAT ERROR.                           @D356DJO 02775000
*                                                              @D356DJO 02776000
*                                                                       02777000
*     FOR 'UNLOCK ALL' NO RETURN CODES ARE PROVIDED.                    02778000
*     (REGISTER 15 REMAINS UNCHANGED).                                  02779000
*                                                                       02780000
*     EXITS:         TO ADDRESS IN R6 - NORMAL CASE                     02781000
*                    TO ERR25 - INVALID PARAMETER LIST LIMITS           02782000
*                    TO ERR21 - INVALID PARM LIST FORMAT   OR           02783000
*                               INVALID RESOURCE CODE                   02784000
*                                                                       02785000
*--------------------------------------------------------------         02786000
         EJECT                                                          02787000
***************************************************************@D52QDMK 02788000
*   ENTRY POINT FOR RELEASE REQUESTS                           @D52QDMK 02789000
***************************************************************@D52QDMK 02790000
         USING DISP,R6                                         @D52QDMK 02791000
         USING LOKOADR,R12                                     @DY43697 02792000
SVC64    LTR   R1,R1              OLD RELEASE ALL REQUEST      @D356DJO 02793000
         BNP   ERR21              YES                          @D356DJO 02794000
         LR    R3,R1              SAVE PARAMETER REGISTER      @D356DJO 02795000
         BAL   RF,LOCKGATE        TEST/SET LOCK/UNLOCK GATE    @D356DJO 02796000
*                                 VALIDATE REGISTER 1 PARMS    @D356DJO 02797000
*        MVI   LOCKPARM,ZERO      CLEAR PARAMETER FIELD        @D356DJO 02798000
         BAL   RF,SV6364EM        TRANSLATE RELEASE INTO UNLOCK@D356DJO 02799000
         USING USEPARM,R3                                      @D356DJO 02800000
         TM    USEFLAGS,USES      SHARED CONTROL               @D356DJO 02801000
         DROP  R3                                              @D356DJO 02802000
         BNO   SVC64C             NO CONTROL AT ALL            @D356DJO 02803000
         OI    DTLFLG2,DTLREDC    REDUCED CONTROL              @D356DJO 02804000
***************************************************************@D149DIS 02805000
*   ENTRY POINT FOR UNLOCK REQUESTS                            @D52QDMK 02806000
*   SCAN LOCKTAB TO FIND PERTINENT ENTRY                       @D356DJO 02807000
***************************************************************@D149DIS 02808000
SVC64C   BAL   RF,SV6364R         FIND ENTRY IN LOCKTAB        @D356DJO 02809000
*SGLINK  SV6364R,INPUT=(R1,RF),OUTPUT=(R2,R7),WORK=(R8,R9)     @D36SDJO 02810000
         B     SVC64P             RESOURCE CODE NOT FOUND               02811000
         B     SVC64P             FOUND BUT INCONSISTENT       @D36SDJO 02812000
         SPACE 2                                               @D149DIS 02813000
.**************************************************************@D149DIS 02814000
.*  ENTRY POINT FOR UNLOCK ALL LOOP                            @D52QDMK 02815000
.*  SCAN OWNER CHAIN TO FIND THIS TASKS ENTRY                  @D356DJO 02816000
.*  SET DEFAULT RETURNCODE TO 'RESOURCE NAME NOT FOUND'        @D52QDMK 02817000
.**************************************************************@D149DIS 02818000
SVC64C2  LH    R5,LCKUTID         TASK  ID                     @D356DJO 02819000
         LA    R4,4               RETURN CODE = 4              @D51UDMK 02820000
         L     RC,LOCKRQC         FIRST REQUEST ELEMENT        @D51UDMK 02821000
         LA    R7,LOCKRQC         SAVE PRECEEDING POINTER      @D51UDMK 02822000
.**************************************************************@D52QDMK 02823000
.*  CHECK IF TASK HAS A REQUEST ELEMENT QUEUED TO LOCKTAB ENTRY@D52QDMK 02824000
.*  THE TASK CAN BE MULTIPLE REQUESTOR OF THE SAME RESOURCE    @D52QDMK 02825000
.*  IF UNLOCK ALL IS SPECIFIED THEN REMOVE ALL REQUEST ELEMENTS@D52QDMK 02826000
.*  OF THIS TASK, ELSE REMOVE ONLY THE REQUEST ELEMENT WITH    @D52QDMK 02827000
.*  MATCHING DTL ADDRESS                                       @D52QDMK 02828000
.**************************************************************@D52QDMK 02829000
SVC64C3  LTR   RC,RC              REQUEST ELEMENT AVAILABLE?   @D52QDMK 02830000
         BZ    SVC64C6            NO, CHECK OWNERS             @D51UDMK 02831000
         CH    R5,LOKOTID         THIS TASK REQUESTOR?         @D52QDMK 02832000
         BNE   SVC64C4            NO                           @D51UDMK 02833000
         TM    LOCKPARM,UNLALL    UNLOCK ALL?                  @D51UDMK 02834000
         BO    SVC64C5            YES,FREE REQUEST ELEMENT     @D51UDMK 02835000
         CL    R1,LOKODTL         SAME DTL?                    @D51UDMK 02836000
         BE    SVC64C5            YES,FREE REQUEST ELEMENT     @D51UDMK 02837000
SVC64C4  LR    R7,RC              PRECEEDING REQUEST ELEMENT   @D51UDMK 02838000
         L     RC,LOKOCHN         NEXT REQUEST ELEMENT         @D51UDMK 02839000
         B     SVC64C3            LOOP THRU REQ. ELEMENTS      @D52QDMK 02840000
.**************************************************************@D52QDMK 02841000
.*  FREE REQUEST ELEMENT                                       @D52QDMK 02842000
.*  R4 = 0 INDICATES THAT A REQUEST ELEMENT HAS BEEN FREED     @D52QDMK 02843000
.*  IF UNLOCK ALL IS SPECIFIED THEN FREEVIS THE ENTRY          @D52QDMK 02844000
.*  IF ITS NOT A PERMANENT ENTRY                               @D52QDMK 02845000
.**************************************************************@D52QDMK 02846000
SVC64C5  LA    R4,0               RETURN CODE = 0              @D51UDMK 02847000
         MVC   0(4,R7),LOKOCHN    CHAIN TO PRECEEDING ELEMENT  @D52QDMK 02848000
         TM    LOCKPARM,UNLALL    UNLOCK ALL?                  @D51UDMK 02849000
         BNO   SVC64IC            NO, DON'T FREEVIS THE ELEMENT@D51UDMK 02850000
         CLM   RC,M7,LOKPERM+1    PERMANENT ELEMENT ?          @D51UDMK 02851000
         BNH   SVC64IC            YES,DON'T FREEVIS THE ENTRY  @D51UDMK 02852000
         STM   RF,R1,SV110SAV     SAVE WORK REGISTERS          @D51UDMK 02853000
         LA    R0,LOKOLEN         LENGTH OF ELEMENT FOR FREEVIS@D51UDMK 02854000
         LR    R1,RC              PTR. TO ELEMENT FOR FREEVIS  @D51UDMK 02855000
         SFREEVIS ADDRESS=(1),LENGTH=(0),SAVE=SVCSV3-16        @D51UDMK 02856000
         AIF (NOT &BGDEBUG).NODBF05                            @D51UDMK 02857000
         LTR   RF,RF              ERROR IN FREEVIS ROUTINE ?   @D51UDMK 02858000
         BZ    SVC64CRS           NO, RESTORE REGISTERS        @D51UDMK 02859000
         MVI   IJBHWORG,HWORG152  UNIQUE HARD WAIT ORIGINATOR  @D51UDMK 02860000
         BAL   R5,SYSERROR        HARDWAIT, WRONG PARAM.LIST   @D51UDMK 02861000
.**************************************************************@D52QDMK 02862000
.*  CONTINUE FROM FREEVIS                                      @D52QDMK 02863000
.**************************************************************@D52QDMK 02864000
SVC64CRS DS    0H                                              @D51UDMK 02865000
.NODBF05 ANOP                                                  @D51UDMK 02866000
         LM    RF,R1,SV110SAV     RESTORE WORK REGISTERS       @D51UDMK 02867000
         B     SVC64CCR           CHECK SPECIAL QUEUE ENTRIES  @D52QDMK 02868000
***************************************************************@D51UDMK 02869000
* CLEAR REQU. ELEMENT AND INSERT IT ON TOP OF FREE ELEMENT LIST@D51UDMK 02870000
***************************************************************@D51UDMK 02871000
SVC64IC  XC    LOKOTID(LOKOLEN-4),LOKOTID  CLEAR OUT           @D51UDMK 02872000
         L     R9,LOKOFRL       * INSERT NO-LONGER USED        @D52QDMK 02873000
         ST    RC,LOKOFRL       * ELEMENT AT TOP OF            @D52QDMK 02874000
         ST    R9,LOKOCHN       * FREE ELEMENT LIST            @D52QDMK 02875000
SVC64CCR LR    RC,R7            GET THE LAST REQUESTOR BACK    @D52QDMK 02876000
*                               FOR BRANCH TO SVC64C4          @D52QDMK 02877000
         L     R3,LOCKRQC       GET RQCPTR                     @D52QDMK 02878000
         LTR   R3,R3            STILL ONE REQUESTOR QUEUED     @D52QDMK 02879000
         BNZ   SVC64CPS         YES, DON'T QUEUE OUT THIS      @D52QDMK 02880000
*                               LOCKTAB ENTRY FROM SPECIAL QUEU@D52QDMK 02881000
.**************************************************************@D52QDMK 02882000
.*  LOCKTAB ENTRY HAS NO MORE REQUESTORS                       @D52QDMK 02883000
.*  TRY TO GET THIS ENTRY OUT OF SPECIAL QUEUE                 @D52QDMK 02884000
.**************************************************************@D52QDMK 02885000
         BAL   RF,SVC110UC      QUEUE OUT OF SPECIAL QUEUE     @D52QDMK 02886000
         LH    R5,LCKUTID       RESTORE TASK ID FOR LOOP       @DY42602 02887000
***************************************************************@D51UDMK 02888000
*   ACTIVATE ALL TASKS WAITING FOR OWNER/REQUEST ELEMENT       @D51UDMK 02889000
***************************************************************@D51UDMK 02890000
SVC64CPS L     R3,ALOCKELM        DUMMY RES. FOR REQUEST ELEM. @D51UDMK 02891000
         TM    LOCKFLG2-LOCKADR(R3),LOCKWAIT   BRANCH IF       @D51UDMK 02892000
         BNO   SVC64C4            NOBODY IS WAITING FOR R.E.   @D52QDMK 02893000
         NI    LOCKFLG2-LOCKADR(R3),XFF-LOCKWAIT               @D51UDMK 02894000
         LR    R9,R1              SAVE R1                      @D51UDMK 02895000
         LR    R1,R3              A(LOCKELEM)                  @D51UDMK 02896000
         L     R5,ASRQTAB                                      @D61MPMK 02897000
         LA    R5,SRQRUR-SRQTAB(,R5)                           @D61MPMK 02898000
         BAL   RF,RPOST           *  FOR OWNER/REQUEST ELEM.   @D51UDMK 02899000
         LH    R5,LCKUTID       RESTORE TASK ID FOR LOOP       @DY42602 02900000
         LR    R1,R9              RESTORE R1                   @D51UDMK 02901000
         B     SVC64C4            NEXT ELEMENT                 @D52QDMK 02902000
.**************************************************************@D52QDMK 02903000
.*  ENTRY CONDITIONS HERE:                                     @D52QDMK 02904000
.*  - UNLOCK ALL                                               @D52QDMK 02905000
.*  - SINGLE UNLOCK AND NO REQUEST ELEMENT FREED               @D52QDMK 02906000
.**************************************************************@D52QDMK 02907000
SVC64C6  L     RC,LOCKCHN         FIRST OWNER ELEMENT          @D356DJO 02908000
         LA    R7,LOCKCHN         SAVE PRECEEDING POINTER      @D356DJO 02909000
.**************************************************************@D52QDMK 02910000
.*  IF LOCKTAB HAS NO OWNER THEN CONTINUE ONLY IF UNLOCK ALL   @D52QDMK 02911000
.**************************************************************@D52QDMK 02912000
         LTR   RC,RC              NULL POINTER?                @DY41518 02913000
         BZ    SVC64CX            YES, DON'T CHECK OWNERS      @DY41518 02914000
         MVC   TRCOTID,LOKOTID     SAVE OWNERS ID FOR TRACE    @D52QDMK 02915000
         TM    LOCKPARM,UNLALL    UNLOCK ALL?                  @D51UDMK 02916000
         BO    SVC64C9            YES, CHECK OWNER ELEMENTS    @D51UDMK 02917000
.**************************************************************@D52QDMK 02918000
.*  IN NORMAL UNLOCK WE CAN'T HAVE SAME TASK OWNER & REQUESTOR @D52QDMK 02919000
.**************************************************************@D52QDMK 02920000
         LTR   R4,R4              ANY REQUEST ELEMENT FREED?   @D51UDMK 02921000
         BZ    SVC64N2            YES, DON'T CHECK OWNERS      @D52QDMK 02922000
.**************************************************************@D52QDMK 02923000
.*  CHECK IF TASK HAS OWNER ELEMENT(S) QUEUED TO LOCKTAB ENTRY @D52QDMK 02924000
.**************************************************************@D52QDMK 02925000
SVC64C9  CH    R5,LOKOTID         THIS TASK OWNER?             @DA27378 02926000
         BE    SVC64D             YES                          @D356DJO 02927000
         LR    R7,RC              PRECEEDING OWNER ELEMENT     @D356DJO 02928000
         L     RC,LOKOCHN         NEXT OWNER ELEMENT           @D356DJO 02929000
         LTR   RC,RC              OWNER ELEMENT AVAILABLE      @D356DJO 02930000
         BNE   SVC64C9            YES,LOOP THRU OWNER ELEMENTS @D356DJO 02931000
.**************************************************************@D52QDMK 02932000
.*  ENTRY CONDITIONS HERE:                                     @D52QDMK 02933000
.*  - NO OWNER ELEMENTS QUEUED TO LOCKTAB ENTRY                @D52QDMK 02934000
.*  IF IT'S A SINGLE UNLOCK THEN SET RETURNCODE 'NOT FOUND'    @D52QDMK 02935000
.*  THIS CLC CAN ONLY BE TRUE IF BOTH POINTERS ARE ZERO        @D52QDMK 02936000
.**************************************************************@D52QDMK 02937000
SVC64CX  CLC   LOCKCHN(4),LOCKRQC ANY MORE OWNERS OR REQUESTORS@DY41518 02938000
         BE    SVC64CA            NO - FREE LOCKTAB ENTRY      @D52QDMK 02939000
         TM    LOCKPARM,UNLALL    UNLOCK ALL                   @D356DJO 02940000
         BO    SVC110T4           YES,TRY NEXT LOCKTAB ENTRY   @D356DJO 02941000
SVC64P   DS    0H                                              @D51UDMK 02942000
         LA    R4,4               SET RETURN CODE              @DY40755 02943000
         SGCOV D52XDMK2                                        @D52XDMK 02944000
         B     SVC64N2                                                  02945000
.**************************************************************@D52QDMK 02946000
.*  WE HAVE NO OWNER AND NO REQUESTOR. FREE LOCKTAB ENTRY      @D52QDMK 02947000
.**************************************************************@D52QDMK 02948000
SVC64CA  OI    UNLCKFLG,FREELE    FREE LOCKTAB ENTRY           @D51UDMK 02949000
         B     SVC64H                                          @D51UDMK 02950000
         SPACE 2                                               @D149DIS 02951000
***************************************************************@D149DIS 02952000
*   OWNER ELEMENT FOUND.                                       @D52QDMK 02953000
*   EXECUTE UNLOCK REQUEST.                                    @D356DJO 02954000
***************************************************************@D149DIS 02955000
SVC64D   TM    LOCKPARM,UNLALL    UNLOCK ALL                   @D356DJO 02956000
         BNO   SVC64D2            NO                           @D356DJO 02957000
.**************************************************************@D52QDMK 02958000
.*  PROCESS UNLOCK ALL / EOJ CASES                             @D52QDMK 02959000
.*  IF ALL AND LOCK STATUS KEEP=YES THEN DON'T UNLOCK          @D52QDMK 02960000
.*  ELSE (EOJ/ALL) PROCEED                                     @D52QDMK 02961000
.**************************************************************@D52QDMK 02962000
         MVI   UNLCKFLG,ZERO      CLEAR FUNCTION BYTE          @D356DJO 02963000
         TM    LOCKPARM,UNLEOJ    END OF JOB PROCESSING        @D356DJO 02964000
         BO    SVC64D1            YES, REMOVE OWNER ELEMENT    @D36SDJO 02965000
         TM    LOKOFLG,LOKOKEEP   KEEP UNTIL EOJ               @D36SDJO 02966000
         BO    SVC64K             YES, DON'T UNLOCK            @D14CDIS 02967000
         SPACE 2                                               @D149DIS 02968000
***************************************************************@D149DIS 02969000
*   PROCESS UNLOCK REQUESTS                                    @D356DJO 02970000
*   INDICATE FREE OWNER ELEMENT                                @D52QDMK 02971000
*   DECREMENT LOCKTAB EXCLUSIVE COUNTER                        @D52QDMK 02972000
*   IF COUNTER GETS 0 THEN REMOVE EXCLUSIVE INDICATION         @D52QDMK 02973000
*   AND SET WAKEUP FOR POSSIBLE WAITERS                        @D52QDMK 02974000
*   CONTINUE WITH SVC64F - REMOVE ONWNER ELEMENT               @D52QDMK 02975000
***************************************************************@D149DIS 02976000
SVC64D1  OI    UNLCKFLG,FREEOE    REMOVE ENTRY FROM QUEUE      @D356DJO 02977000
         LH    R4,LOCKCNTE        TOTAL EXCL. OWNERS           @D36SDJO 02978000
         SH    R4,LOKOCNTE        EXCL.COUNT BY THIS TASK      @D36SDJO 02979000
         STH   R4,LOCKCNTE        AND STORE BACK TO LOCKTAB    @D36SDJO 02980000
         BNZ   SVC64F             BRANCH IF STILL POSITIVE     @D36SDJO 02981000
         NI    LOCKFLG1,XFF-LOCKEXC  RESET EXCLUSIVE FLAG      @D356DJO 02982000
         OI    UNLCKFLG,WAKEUP    ACTIVATE WAITING TASKS       @D356DJO 02983000
         B     SVC64F                                          @D356DJO 02984000
.**************************************************************@D52QDMK 02985000
.*  PROCESS SINGLE UNLOCK REQUEST                              @D52QDMK 02986000
.**************************************************************@D52QDMK 02987000
SVC64D2  TM    DTLFLG2,DTLREDC    REDUCE SHARE CONTROL         @D356DJO 02988000
         BNO   SVC64E             NO,                          @D356DJO 02989000
.**************************************************************@D52QDMK 02990000
.*  CASE: REDUCE ONLY LOCK CONTROL BUT DON'T UNLOCK RESOURCE   @D52QDMK 02991000
.*  THIS IS ONLY POSSIBLE IF LOCK STATUS = E1                  @D52QDMK 02992000
.*  IF OTHER LOCK STATUS THEN 'FORMAT ERROR ON UNLOCK REQUEST' @D52QDMK 02993000
.**************************************************************@D52QDMK 02994000
         TM    LOCKFLG1,LOCKEXC+DTLOPT1       E1 LOCK                   02995000
         BNO   SVC110A1           NO , RETURN CODE = 8         @D356DJO 02996000
.**************************************************************@D52QDMK 02997000
.*  SET WAKEUP FOR POSSIBLE WAITERS                            @D52QDMK 02998000
.*  IF REQUEST = S THEN CLEAR EXCLUSIVE COUNTERS IN OWNER      @D52QDMK 02999000
.*  ELEMENT AND LOCKTAB ENTRY. INCREMENT SHARED COUNTER        @D52QDMK 03000000
.*  CONTINUE WITH SVC64G3 - CHECK FOR EXTERNAL FILE UPDATE     @D52QDMK 03001000
.**************************************************************@D52QDMK 03002000
         MVC   LOCKFLG1(1),DTLFLG1 MOVE LOCKOPT+EXC FLAG       @D356DJO 03003000
         MVI   UNLCKFLG,WAKEUP    ACTIVATE WAITING TASKS       @D356DJO 03004000
         TM    DTLFLG1,DTLEXC     EXC CONTROL                  @D356DJO 03005000
         BO    SVC64G3            YES                          @D356DJO 03006000
         MVI   LOKOCNTS+1,1       ONE SHARED USER              @D356DJO 03007000
         MVI   LOKOCNTE+1,0       NO EXCLUSIVE USER            @D356DJO 03008000
         NI    LOKOFLG,XFF-LOKOEXC  RESET TO SHARED            @D356DJO 03009000
         SR    R4,R4                                           @D36SDJO 03010000
         STH   R4,LOCKCNTE        NO EXCLUSIVE USERS AT ALL    @D36SDJO 03011000
         B     SVC64G3            DONT REMOVE FROM QUEUE       @D356DJO 03012000
         SPACE 2                                               @D149DIS 03013000
.**************************************************************@D52QDMK 03014000
.*  SINGLE UNLOCK AND NO REDUCED CONTROL                       @D52QDMK 03015000
.**************************************************************@D52QDMK 03016000
SVC64E   TM    LOKOFLG,LOKOEXC    EXCLUSIVELY LOCKED           @D356DJO 03017000
         BNO   SVC64E2            NO, PROCESS SHARED           @D356DJO 03018000
         LH    R4,LOKOCNTS        NUMBER OF SHARED USERS       @D36SDJO 03019000
         LTR   R4,R4              IS USE COUNT EQUAL ZERO               03020000
         BZ    SVC64E1            YES, UNLOCK FROM EXCL.CNTL   @D356DJO 03021000
***************************************************************@D149DIS 03022000
*   WHEN THE RESOURCE IS BOTH LOCKED EXCLUSIVELY AND SHARED    @D356DJO 03023000
*   THE DTL IS TESTED TO FIND OUT, WHICH TYPE OF LOCKING       @D356DJO 03024000
*   SHOULD BE RESET.                                           @D356DJO 03025000
***************************************************************@D149DIS 03026000
         TM    DTLFLG1,DTLEXC    EXCLUSIVE FLAG IN DTL         @D36SDJO 03027000
         BNO   SVC64E2           NO, RESET SHARED LOCK         @D356DJO 03028000
*                                                              @D36SDJO 03029000
.**************************************************************@D52QDMK 03030000
.*  LOCK STATUS = E AND REQUEST = E                            @D52QDMK 03031000
.*  DECREMENT EXCLUSIVE COUNTER IN OWNER ELEMENT               @D52QDMK 03032000
.*  IF EXCLUSIVE COUNTER = 0 THEN RESET EXCLUSIVE FLAG IN OE   @D52QDMK 03033000
.*  IF EXCLUSIVE COUNTER = 0 AND SHARED COUNTER = 0 THEN       @D52QDMK 03034000
.*     INDICATE FREE OWNER ELEMENT                             @D52QDMK 03035000
.**************************************************************@D52QDMK 03036000
SVC64E1  LH    R4,LOKOCNTE        # OF EXCL USERS              @D36SDJO 03037000
         BCTR  R4,0               SUBTRACT ONE                 @D36SDJO 03038000
         STH   R4,LOKOCNTE        UPDATE COUNT IN OWNER EL.    @D36SDJO 03039000
         LTR   R4,R4              STILL LOCKED EXCLUSIVELY     @D36SDJO 03040000
         BNE   SVC64E1B           YES                          @D36SDJO 03041000
         NI    LOKOFLG,XFF-LOKOEXC RESET EXC FLAG IN OWNER EL. @D356DJO 03042000
         LH    R4,LOKOCNTS        NUMBER OF SHARED USERS       @D36SDJO 03043000
         LTR   R4,R4              STILL SHARED USED            @D36SDJO 03044000
         BNZ   SVC64E1B           YES, LEAVE OWNER EL. IN Q    @D36SDJO 03045000
         OI    UNLCKFLG,FREEOE    REMOVE OWNER ELEMENT         @D36SDJO 03046000
.**************************************************************@D52QDMK 03047000
.*  DECREMENT EXCLUSIVE COUNTER IN LOCKTAB ENTRY               @D52QDMK 03048000
.*  IF EXCLUSIVE COUNTER = 0 THEN RESET EXCLUSIVE FLAG IN LE   @D52QDMK 03049000
.*     SET WAKEUP FOR POSSIBLE WAITERS                         @D52QDMK 03050000
.*  CONTINUE WITH SVC64F - REMOVE ONWNER ELEMENT               @D52QDMK 03051000
.**************************************************************@D52QDMK 03052000
SVC64E1B LH    R4,LOCKCNTE        TOTAL NUMBER OF EXCL. REQ.   @D36SDJO 03053000
         BCTR  R4,0               SUBTRACT ONE                 @D36SDJO 03054000
         STH   R4,LOCKCNTE        AND STORE BACK TO LOCKTAB    @D36SDJO 03055000
         LTR   R4,R4              STILL LOCKED EXCLUSIVELY     @D36SDJO 03056000
         BNE   SVC64F             YES                          @D36SDJO 03057000
         NI    LOCKFLG1,XFF-LOCKEXC AND IN LOCKTAB ENTRY       @D356DJO 03058000
         OI    UNLCKFLG,WAKEUP    ACTIVATE WAITING TASKS       @D356DJO 03059000
         B     SVC64F                                          @D356DJO 03060000
.**************************************************************@D52QDMK 03061000
.*  LOCK STATUS = ANY AND REQUEST = S                          @D52QDMK 03062000
.*  DECREMENT SHARED COUNTER IN OWNER ELEMENT                  @D52QDMK 03063000
.*  IF SHARED COUNTER = 0 AND THIS TASK IS NOT EXCLUSIVE OWNER @D52QDMK 03064000
.*  THEN OWNER ELEMENT CAN BE FREED                            @D52QDMK 03065000
.**************************************************************@D52QDMK 03066000
SVC64E2  LH    R4,LOKOCNTS        NUMBER OF SHARED USERS       @D36SDJO 03067000
         BCTR  R4,0               DECREASE BY ONE                       03068000
         STH   R4,LOKOCNTS        AND STORE BACK TO OWN.EL.    @D356DJO 03069000
         LTR   R4,R4              TEST REMAINING USE COUNT     @D356DJO 03070000
         BH    SVC64F             STILL POSITIVE               @D356DJO 03071000
         TM    LOKOFLG,LOKOEXC    STILL EXCLUSIVELY LOCKED     @D356DJO 03072000
         BO    SVC64F             YES, KEEP OWNER ELEMENT      @D356DJO 03073000
         OI    UNLCKFLG,FREEOE    REMOVE OWNER ELEMENT         @D356DJO 03074000
.**************************************************************@D52QDMK 03075000
.*  CHECK IF OWNER ELEMENT CAN BE REMOVED FROM RESOURCE        @D52QDMK 03076000
.**************************************************************@D52QDMK 03077000
SVC64F   TM    UNLCKFLG,FREEOE    REMOVE OWNER ELEMENT         @D356DJO 03078000
         BNO   SVC64G2            NO, STILL LOCKED             @D356DJO 03079000
***************************************************************@D52QDMK 03080000
*   REMOVE OWNER ELEMENT FROM RESOURCE                         @D356DJO 03081000
*   FREE OWNER ELEMENT                                         @D52QDMK 03082000
*   IF UNLOCK ALL IS SPECIFIED THEN FREEVIS THE ENTRY          @D52QDMK 03083000
*   IF ITS NOT A PERMANENT ENTRY                               @D52QDMK 03084000
***************************************************************@D52QDMK 03085000
         MVC   0(4,R7),LOKOCHN    CHAIN TO PRECEEDING ELEMENT  @D14BDIS 03086000
         TM    LOCKPARM,UNLALL    UNLOCK ALL REQUEST ?         @D14BDIS 03087000
         BNO   SVC64IF            NO, DON'T FREEVIS THE ELEMENT@D14BDIS 03088000
         CLM   RC,M7,LOKPERM+1    PERMANENT OWNER ELEMENT ?    @D14BDIS 03089000
         BNH   SVC64IF            YES,DON'T FREEVIS THE ENTRY  @D14BDIS 03090000
         STM   RF,R1,SV110SAV     SAVE WORK REGISTERS          @D14BDIS 03091000
         LA    R0,LOKOLEN         LENGTH OF ELEMENT FOR FREEVIS@D14BDIS 03092000
         LR    R1,RC              PTR. TO ELEMENT FOR FREEVIS  @D14BDIS 03093000
         SFREEVIS ADDRESS=(1),LENGTH=(0),SAVE=SVCSV3-16        @D14BDIS 03094000
         AIF (NOT &BGDEBUG).NODBF10                            @D14BDIS 03095000
         LTR   RF,RF              ERROR IN FREEVIS ROUTINE ?   @D14BDIS 03096000
         BZ    SVC64RST           NO, RESTORE REGISTERS        @D14BDIS 03097000
         MVI   IJBHWORG,HWORG152  UNIQUE HARD WAIT ORIGINATOR  @D31QDHB 03098000
         BAL   R5,SYSERROR        HARDWAIT, WRONG PARAM.LIST   @D14BDIS 03099000
.**************************************************************@D52QDMK 03100000
.*  CONTINUE FROM FREEVIS                                      @D52QDMK 03101000
.**************************************************************@D52QDMK 03102000
SVC64RST DS    0H                                              @D14BDIS 03103000
.NODBF10 ANOP                                                  @D14BDIS 03104000
         LM    RF,R1,SV110SAV     RESTORE WORK REGISTERS       @D14BDIS 03105000
         B     SVC64PST           POST WAITING TASKS           @D14BDIS 03106000
***************************************************************@D149DIS 03107000
* CLEAR OWNER ELEMENT AND INSERT IT ON TOP OF FREE ELEMENT LIST@D356DJO 03108000
***************************************************************@D149DIS 03109000
SVC64IF  XC    LOKOTID(LOKOLEN-4),LOKOTID  CLEAR OUT           @D14BDIS 03110000
         L     R7,LOKOFRL       * INSERT NO-LONGER USED        @D356DJO 03111000
         ST    RC,LOKOFRL       * ELEMENT AT TOP OF            @D356DJO 03112000
         ST    R7,LOKOCHN       * FREE ELEMENT LIST            @D356DJO 03113000
         TM    LOCKFLG2,LOCKEXT   LOCK ENTRY ON EXTERNAL FILE  @D68JMJS 03114000
         BNO   SVC64PST           NO, DO NOT SET THE FLAG      @D68JMJS 03115000
         OI    SDAIDP,SDAIDPEX    INDICATE EXTERNAL FOR SDAID  @D68JMJS 03116000
***************************************************************@D149DIS 03117000
*   ACTIVATE ALL TASKS WAITING FOR A FREE OWNER ELEMENT        @D356DJO 03118000
***************************************************************@D149DIS 03119000
SVC64PST L     R3,ALOCKELM        DUMMY RES. FOR OWNER ELEM.   @D14BDIS 03120000
         TM    LOCKFLG2-LOCKADR(R3),LOCKWAIT   BRANCH IF       @D356DJO 03121000
         BNO   SVC64G             NOBODY IS WAITING FOR O.E.   @D356DJO 03122000
         NI    LOCKFLG2-LOCKADR(R3),XFF-LOCKWAIT               @D356DJO 03123000
         LR    R9,R1              SAVE R1                      @D356DJO 03124000
         LR    R1,R3              A(LOCKELEM)                  @D36SDJO 03125000
         L     R5,ASRQTAB                                      @D61MPMK 03126000
         LA    R5,SRQRUR-SRQTAB(,R5)                           @D61MPMK 03127000
         BAL   RF,RPOST           *  FOR OWNER ELEMENTS        @D356DJO 03128000
         LR    R1,R9              RESTORE DTL ADDRESS                   03129000
***************************************************************@D149DIS 03130000
*   CHECK IF REQUESTING TASK WAS ONLY OWNER                             03131000
*   OF UNLOCKED RESOURCE.                                      @D356DJO 03132000
***************************************************************@D149DIS 03133000
SVC64G   L     RC,LOCKCHN         POINTER TO OWNER ELEMENTS    @D356DJO 03134000
         LTR   RC,RC              OWNERS AVAILABLE             @D356DJO 03135000
         BNZ   SVC64G2          YES, DONT CLEAR LOCKTAB ENTRY  @D356DJO 03136000
         OI    UNLCKFLG,WAKEUP+FREELE+WAKEUPE1                 @D356DJO 03137000
.**************************************************************@D52QDMK 03138000
.*  ENTRY POINT IF OWNERS ARE STILL THERE                      @D52QDMK 03139000
.**************************************************************@D52QDMK 03140000
SVC64G2  TM    UNLCKFLG,WAKEUP    DOES LOCK STATUS CHANGE      @D356DJO 03141000
         BNO   SVC64H             ACTIVATION NOT REQUIRED      @D356DJO 03142000
.**************************************************************@D52QDMK 03143000
.*  CHECK IF UPDATE OF LOCKFILE IS NECESSARY                   @D52QDMK 03144000
.**************************************************************@D52QDMK 03145000
SVC64G3  EQU   *                                               @D36SDJO 03146000
         AIF   (NOT &BGDSHR).SV110G1                           @D36SDJO 03147000
         TM    LOCKFLG2,LOCKEXT   LOCK ENTRY ON EXTERNAL FILE  @D36SDJO 03148000
         BNO   SVC110L            NO, PROCESS INTERNAL         @D36SDJO 03149000
***************************************************************@D149DIS 03150000
*   UPDATE THE EXTERNAL FILE IF THE LOCKING STATUS HAS CHANGED @D356DJO 03151000
*   IN CASE OF UNLOCK ALL SYSTEM TASK CAN ALREADY BE ACTIVE    @D52QDMK 03152000
***************************************************************@D149DIS 03153000
         TM    DSHRFLG,LCKSYS     SYS.TASK ACTIVE (UNLOCK ALL) @D36SDJO 03154000
         BO    SVC110H            YES, DONT ACTIVATE           @D36SDJO 03155000
.**************************************************************@D52QDMK 03156000
.* ACTIVATE SYSTEM TASK                                        @D52QDMK 03157000
.* RETRUN (0) = ACTIVATION UNSUCCESSFUL                        @D52QDMK 03158000
.* RETRUN (4) = ACTIVATION DONE                                @D52QDMK 03159000
.**************************************************************@D52QDMK 03160000
         BAL   RF,LCKACT          ACTIVATE SYSTEM TASK         @D36SDJO 03161000
         B     SVC110L            I/O ERROR ON EXT FILE        @D36SDJO 03162000
         EJECT                                                 @D149DIS 03163000
         SPACE 2                                               @D149DIS 03164000
***************************************************************@D149DIS 03165000
SVC110H  EQU   *                                               @D36SDJO 03166000
         LA    R3,LOCKRESN        RESOURCE NAME FOR HASHING    @D36SDJO 03167000
.**************************************************************@D52QDMK 03168000
.* CALCULATE THE DISK BLOCK NUMBER FOR READ LOCK FILE          @D52QDMK 03169000
.**************************************************************@D52QDMK 03170000
         BAL   RF,LCKHASH         CALCULATE DISK ADDRESS       @D36SDJO 03171000
*SGLINK  LCKHASH,INPUT=(R3,RF),WORK=(R3,R4,R5),OUTPUT=R9       @D36SDJO 03172000
.**************************************************************@D52QDMK 03173000
.* READ DISK BLOCK                                             @D52QDMK 03174000
.* RETRUN (0) = BLOCK NOT FOUND                                @D52QDMK 03175000
.* RETRUN (4) = BLOCK FOUND, CAN CHECK IT NOW                  @D52QDMK 03176000
.**************************************************************@D52QDMK 03177000
         BAL   RF,LCKGET          GET DISK BLOCK               @D36SDJO 03178000
*SGLINK  LCKGET,INPUT=(R9,RF),WORK=(R0,R3,R5,R7,RE),OUTPUT=R4           03179000
         B     SVC110I4           I/O ERROR OR FILE DESTROYED  @D36SDJO 03180000
         LA    R3,LOCKRESN        RESOURCE NAME FOR SEARCHING  @D36SDJO 03181000
.**************************************************************@D52QDMK 03182000
.* SCAN THE DISK BLOCK FOR RESOURCE NAME                       @D52QDMK 03183000
.* RETRUN (0) = BLOCK HAS NOT LOCK FILE FORMAT                 @D52QDMK 03184000
.* RETRUN (4) = RESOURCE NAME FOUND                            @D52QDMK 03185000
.* RETRUN (8) = RESOURCE NAME NOT FOUND                        @D52QDMK 03186000
.**************************************************************@D52QDMK 03187000
         BAL   RF,LCKSCAN         SCAN EXTERNAL BLOCK          @D36SDJO 03188000
*SGLINK  LCKSCAN,INPUT=(R3,R4,RF),WORK=(R5),OUTPUT=(R4)                 03189000
         B     SVC110I4           FILE DESTROYED               @D36SDJO 03190000
         B     SVC110I            RESOURCE NAME FOUND          @D36SDJO 03191000
SVC110I4 OI    DLFFLG1,DSHRDOWN+DSDWNMSG DASD SHARING DOWN     @D36SDJO 03192000
         B     SVC110L                                         @D36SDJO 03193000
.**************************************************************@D52QDMK 03194000
.* MODIFY EXTERNAL FILE RESOURCE ENTRY                         @D52QDMK 03195000
.**************************************************************@D52QDMK 03196000
SVC110I  AH    R4,DLFINDEX        POINT TO MY CPU              @D36SDJO 03197000
         TM    UNLCKFLG,FREELE    GIVE UP LOCKTAB ENTRY        @D36SDJO 03198000
.**************************************************************@D52QDMK 03199000
.* CASE: THIS CPU DOESN'T NEED RESOURCE ANYMORE                @D52QDMK 03200000
.**************************************************************@D52QDMK 03201000
         BNO   SVC110I5           NO                           @D36SDJO 03202000
         MVI   L'LOCKRESN(R4),ZERO CLEAR LOCK ENTRY            @D36SDJO 03203000
         SH    R4,DLFINDEX        PONT BACK TO FIRST SLOT      @D36SDJO 03204000
         LH    R3,DLFNCPUS        NUMBER OF CPU'S              @D36SDJO 03205000
         BCTR  R3,0               SUBTRACT ONE  FOR EXECUTE    @D36SDJO 03206000
         EX    R3,LCKTST          ALL CPU FIELDS ZERO          @D36SDJO 03207000
         BNZ   SVC110K            NO,LEAVE IN QUEUE            @D36SDJO 03208000
         L     R5,DLFAREA         I/O AREA                     @D36SDJO 03209000
         LH    R3,2(R5)           NUMBER OF ENTRIES            @D36SDJO 03210000
         BCTR  R3,0               SUBTRACT ONE                 @D36SDJO 03211000
         STH   R3,2(R5)           STORE BACK                   @D36SDJO 03212000
         MH    R3,DLFLENT         ENTRY LENGTH                 @D36SDJO 03213000
         LA    R3,4(R3,R5)        POINT TO LAST ENTRY          @D36SDJO 03214000
         LH    R5,DLFLENT         ENTRY LENGTH                 @D36SDJO 03215000
         BCTR  R5,0               LENGTH-1 FOR EXECUTE INSTR.  @D36SDJO 03216000
         EX    R5,LCKSHIFT        MOVE LAST TO FREE POSITION   @D36SDJO 03217000
         B     SVC110K            WRITE RECORD TO EXT.FILE     @D36SDJO 03218000
.**************************************************************@D52QDMK 03219000
.* CASE: THIS CPU KEEPS THE RESOURCE WITH NEW LOCK STATUS      @D52QDMK 03220000
.**************************************************************@D52QDMK 03221000
SVC110I5 EQU   *                                               @D36SDJO 03222000
         MVC   L'LOCKRESN(1,R4),LOCKFLG1  MOVE LOCK STATUS     @D36SDJO 03223000
.**************************************************************@D52QDMK 03224000
.*  WRITE DISK BLOCK BACK TO LOCK FILE                         @D52QDMK 03225000
.*  RETURN (0) = WRITE WAS NOT SUCCESSFUL                      @D52QDMK 03226000
.*  RETURN (4) = WRITE DONE                                    @D52QDMK 03227000
.**************************************************************@D52QDMK 03228000
SVC110K  BAL   RF,LCKPUT          WRITE BACK TO EXTERNAL FILE  @D36SDJO 03229000
*SGLINK  LCKPUT,INPUT=(RF),WORK=(R3)                           @D36SDJO 03230000
         B     SVC110I4           IRRECOVERABLE I/O ERROR      @D36SDJO 03231000
         SPACE 2                                               @D149DIS 03232000
.**************************************************************@D52QDMK 03233000
.* PROCEED HERE AFTER UPDATE OR IN CASE OF INTERNAL UNLOCK     @D52QDMK 03234000
.**************************************************************@D52QDMK 03235000
SVC110L  DS    0H                 CONTINUE NORMALLY            @D51UDMK 03236000
.SV110G1 ANOP                                                  @D36SDJO 03237000
***************************************************************@D51UDMK 03238000
*   CHECK IF REQUEST ELEMENTS ARE QUEUED                       @D52QDMK 03239000
***************************************************************@D51UDMK 03240000
         L     RC,LOCKRQC         SOME REQUEST ELEMENTS QUEUED?@D52QDMK 03241000
         LTR   RC,RC              SOME REQUEST ELEMENTS QUEUED?@D52QDMK 03242000
         BZ    SVC64G6            NO                           @D52QDMK 03243000
***************************************************************@D51UDMK 03244000
*   DON'T FREE RESOURCE                                        @D51UDMK 03245000
*   CHAIN LOCKTAB ENTRY TO SPECIAL QUEUE                       @D51UDMK 03246000
***************************************************************@D51UDMK 03247000
         NI    UNLCKFLG,XFF-FREELE DON'T FREE LOCKTAB ENTRY    @D51UDMK 03248000
         BAL   RF,SVC6364Q        CHAIN LOCKTAB ENTRY          @D51UDMK 03249000
***************************************************************@D149DIS 03250000
*   ACTIVATE ALL TASKS WAITING FOR THIS RESOURCE               @D356DJO 03251000
***************************************************************@D149DIS 03252000
SVC64G6  LR    R9,R1              SAVE DTL ADDRESS             @D52QDMK 03253000
         LR    R1,R2              LOCKTAB ENTRY ADDRESS        @D36SDJO 03254000
         TM    LOCKFLG2,LOCKWAIT  SOME TASK WAITING            @D52QDMK 03255000
         BNO   SVC64G7            NO.                          @D52QDMK 03256000
         NI    LOCKFLG2,XFF-LOCKWAIT  RESET WAIT FLAG          @D356DJO 03257000
.**************************************************************@D52QDMK 03258000
.* POST SHARED WAITERS                                         @D52QDMK 03259000
.**************************************************************@D52QDMK 03260000
         L     R5,ASRQTAB                                      @D61MPMK 03261000
         LA    R5,SRQRUR-SRQTAB(,R5)                           @D61MPMK 03262000
         BAL   RF,RPOST           POST TASKS WAITING FOR RES.  @D36SDJO 03263000
SVC64G7  TM    LOCKFLG2,LOCKWTE1  SOME TASK WAITING WITH E1    @D52QDMK 03264000
         BNO   SVC64G8            NO.                          @D52QDMK 03265000
         TM    UNLCKFLG,WAKEUPE1  IS REQUESTOR TYPE E1         @D36SDJO 03266000
         BNO   SVC64G8            NO                           @D36SDJO 03267000
.**************************************************************@D52QDMK 03268000
.* POST EXCLUSIVE WAITERS                                      @D52QDMK 03269000
.**************************************************************@D52QDMK 03270000
         O     R1,E1REQMSK        SET E1 FLAG ON               @D36SDJO 03271000
         L     R5,ASRQTAB                                      @D61MPMK 03272000
         LA    R5,SRQRUR-SRQTAB(,R5)                           @D61MPMK 03273000
         BAL   RF,RPOST           * WAITING WITH CONTROL=E     @D36SDJO 03274000
SVC64G8  LR    R1,R9              RESTORE DTL ADDRESS          @D356DJO 03275000
         EJECT                                                 @D149DIS 03276000
         SPACE 2                                               @D149DIS 03277000
***************************************************************@D149DIS 03278000
*   WHEN LAST OWNER OF THIS RESOURCE HAS BEEN DELETED,         @D356DJO 03279000
*   THE LOCKTAB ENTRY IS CLEARED TO ZEROS.                     @D356DJO 03280000
*   IF UNLOCK ALL IS SPECIFIED THEN FREEVIS THE ENTRY          @D52QDMK 03281000
*   IF ITS NOT A PERMANENT ENTRY                               @D52QDMK 03282000
***************************************************************@D149DIS 03283000
SVC64H   TM    UNLCKFLG,FREELE    * CAN LOCKTAB ENTRY BE       @D356DJO 03284000
         BNO   SVC64K             * DELETED                    @D356DJO 03285000
         TM    LOCKPARM,UNLALL    UNLOCK ALL REQUEST ?         @D14BDIS 03286000
         BNO   SVC64IL            NO, DON'T FREEVIS THE ENTRY  @D14BDIS 03287000
         CLM   R2,M7,LOKPERM+1    PERMANENT LOCKTAB ENTRY ?    @D14BDIS 03288000
         BNH   SVC64IL            YES,DON'T FREEVIS THE ENTRY  @D14BDIS 03289000
         STM   RF,R1,SV110SAV     SAVE WORK REGISTERS          @D14BDIS 03290000
***************************************************************@D149DIS 03291000
*   REMOVE LOCKTAB ENTRY FROM CHAIN                            @D149DIS 03292000
***************************************************************@D149DIS 03293000
         L     RF,LOCKBPTR        BACKWARD POINTER             @D14BDIS 03294000
         L     R1,LOCKPTR         FORWARD POINTER              @D14BDIS 03295000
         LTR   RF,RF              IS THIS THE FIRST ENTRY      @D52QDMK 03296000
         BZ    SVC64H1            YES UPDATE HEAD OF LOCKTAB   @D52QDMK 03297000
         ST    R1,LOCKPTR-LOCKADR(RF)  CLOSE FORWARD CHAIN     @D14BDIS 03298000
         B     SVC64H2            CONTINUE                     @D52QDMK 03299000
SVC64H1  ST    R1,ALOKTABA        NEW HEAD OF LOCKTAB CHAIN    @D52QDMK 03300000
SVC64H2  LTR   R1,R1              LAST LOCKTAB ENTRY ?         @D52QDMK 03301000
         BZ    SVC64FR            YES, DON'T STORE BACKW.PTR.  @D14BDIS 03302000
         ST    RF,LOCKBPTR-LOCKADR(R1) CLOSE BACKWARD CHAIN    @D14BDIS 03303000
***************************************************************@D149DIS 03304000
*   FREE LOCKTAB ENTRY                                         @D149DIS 03305000
***************************************************************@D149DIS 03306000
SVC64FR  LA    R0,LOCKLEN         LENGTH OF LOCKTAB FOR FREEVIS@D14BDIS 03307000
         LR    R1,R2              PTR. TO LOCKTAB FOR FREEVIS  @D14BDIS 03308000
         LR    R2,RF              POINT TO ELEMENT BEFORE      @D14BDIS 03309000
         SFREEVIS ADDRESS=(1),LENGTH=(0),SAVE=SVCSV3-16        @D14BDIS 03310000
         AIF (NOT &BGDEBUG).NODBF11                            @D14BDIS 03311000
         LTR   RF,RF              ERROR IN FREEVIS ROUTINE ?   @D14BDIS 03312000
         BZ    SVC64RSL           NO, RESTORE REGISTERS        @D14BDIS 03313000
         MVI   IJBHWORG,HWORG156  UNIQUE HARD WAIT ORIGINATOR  @D31QDHB 03314000
         BAL   R5,SYSERROR        HARDWAIT, WRONG PARAM.LIST   @D14BDIS 03315000
.**************************************************************@D52QDMK 03316000
.*  CONTINUE FROM FREEVIS                                      @D52QDMK 03317000
.**************************************************************@D52QDMK 03318000
.NODBF11 ANOP                                                  @D14BDIS 03319000
SVC64RSL LM    RF,R1,SV110SAV     RESTORE WORK REGISTERS       @D14BDIS 03320000
         B     SVC64WLT           POST WAITING TASKS           @D14BDIS 03321000
SVC64IL  XC    0(LOCKLEN-8,R2),0(R2) ERASE LOCKTAB ENTRY       @D14BDIS 03322000
*                              *** DON'T ERASE FORW.+ BACKW.PTR@D149DIS 03323000
***************************************************************@D149DIS 03324000
*   - TEST IF SOMEONE IS WAITING FOR EMPTY LOCKTAB SPACE                03325000
***************************************************************@D149DIS 03326000
SVC64WLT L     R3,ALOCKSPC      DUMMY ENTRY FOR LOCKTAB SPACE  @D14BDIS 03327000
         TM    LOCKFLG2-LOCKADR(R3),LOCKWAIT SOMEBODY WAITING  @D36SDJO 03328000
         BZ    SVC64K             NO..                                  03329000
         NI    LOCKFLG2-LOCKADR(R3),XFF-LOCKWAIT RESET WAIT FLG         03330000
***************************************************************@D149DIS 03331000
*  ACTIVATE ALL TASKS WAITING FOR LOCKTAB SPACE                @D356DJO 03332000
***************************************************************@D149DIS 03333000
         LR    R9,R1              SAVE DTL ADDRESS             @D356DJO 03334000
         L     R1,ALOCKSPC        DUMMY ENTRY LOCKTAB SPACE    @D36SDJO 03335000
         L     R5,ASRQTAB                                      @D61MPMK 03336000
         LA    R5,SRQRUR-SRQTAB(,R5)                           @D61MPMK 03337000
         BAL   RF,RPOST           POST TASKS WAITING FOR SPACE @D356DJO 03338000
         LR    R1,R9              RESTORE DTL ADDRESS          @D356DJO 03339000
         EJECT                                                 @D149DIS 03340000
         SPACE 2                                               @D149DIS 03341000
***************************************************************@D149DIS 03342000
*   PROCESSING OF ONE LOCKTAB ENTRY IS COMPLETED                        03343000
*   IF UNLOCK ALL IS SPECIFIED, PROCESS NEXT LOCKTAB ENTRY     @D356DJO 03344000
***************************************************************@D149DIS 03345000
SVC64K   TM    LOCKPARM,UNLALL    UNLOCK ALL REQUEST ?         @D356DJO 03346000
         BO    SVC110T4           YES, LOOP THRU LOCKTAB       @D356DJO 03347000
         AIF   (NOT &BGDSHR).SV64K                             @D36SDJO 03348000
         TM    DSHRFLG,LCKSYS     IS SYSTEM TASK ACTIVE        @D36SDJO 03349000
         BNO   SVC64N             NO                           @D36SDJO 03350000
.**************************************************************@D52QDMK 03351000
.*  DEACTIVATE SYSTEM TASK                                     @D52QDMK 03352000
.**************************************************************@D52QDMK 03353000
         BAL   RF,LCKDEACT        DEACTIVATE                   @D36SDJO 03354000
.SV64K   ANOP                                                  @D36SDJO 03355000
         SPACE 4                                               @D149DIS 03356000
***************************************************************@D149DIS 03357000
*                                                              @D356DJO 03358000
*   PROVIDE RETURN CODE                                        @D356DJO 03359000
*                                                              @D356DJO 03360000
***************************************************************@D149DIS 03361000
.**************************************************************@D52QDMK 03362000
.*  ENTRY POINT FOR 'SUCCESSFUL' PROCESSING                    @D52QDMK 03363000
.**************************************************************@D52QDMK 03364000
SVC64N   EQU   *                                               @DY40726 03365000
         SR    R4,R4              R.C. = 0                     @D356DJO 03366000
         TM    LOCKPARM,UNLALL+UNLEOJ UNLOCK ALL OR EOJ?       @D52QDMK 03367000
         BNZ   SVC64N1            YES, CHECK SPECIAL QUEUE     @D52QDMK 03368000
         TM    UNLCKFLG,FREELE    * WAS LOCKTAB ENTRY          @D52QDMK 03369000
         BO    SVC64N2            * DELETED                    @D52QDMK 03370000
         L     RC,LOCKRQC         GET REQUESTOR ADDRESS        @D52QDMK 03371000
         LTR   RC,RC              REQUESTOR(S) THERE?          @D52QDMK 03372000
         BZ    SVC64N2            NO, DON'T DO REALLOCATION    @D52QDMK 03373000
SVC64N1  L     R8,RQBASPTR        FIRST QUEUE ENTRY            @D52QDMK 03374000
         LTR   R8,R8              EMPTY?                       @D52QDMK 03375000
         BZ    SVC64N2            YES                          @D52QDMK 03376000
.**************************************************************@D52QDMK 03377000
.*  PREPARE FOR REALLOCATION FOR REQUESTORS                    @D52QDMK 03378000
.*  INDICATE THAT THE ENTIRE SPECIAL QUEUE HAS TO BE PROCESSED @D52QDMK 03379000
.**************************************************************@D52QDMK 03380000
         DROP  R6                                              @D52QDMK 03381000
         LA    R6,SVC110ZA        TRY TO LOCK FOR REQUESTORS   @D52QDMK 03382000
         NI    SERVFLG,XFF-NOINT  REALLOCATION FOR ALL ENTRIES @D52QDMK 03383000
.**************************************************************@D52QDMK 03384000
.*  ENTRY POINT FOR 'UNSUCCESSFUL' PROCESSING                  @D52QDMK 03385000
.**************************************************************@D52QDMK 03386000
SVC64N2  L     R8,TCBSAVE         SAVE AREA ADDRESS            @D51UDMK 03387000
         TM    LOCKPARM,NEWLOCK   UNLOCK SVC                   @D356DJO 03388000
         BNO   SVC64N4            NO, NO R.C. ON RELEASE       @D356DJO 03389000
         USING SVEARA,R8                                       @D356DJO 03390000
.**************************************************************@D52QDMK 03391000
.*  UNLOCK REQUEST RETURNCODE PROCESSING:                      @D52QDMK 03392000
.*  IF UNLOCK ALL/EOJ/SYS OR OLD DTL FORMAT THEN THE           @D52QDMK 03393000
.*  RETURN CODE IN THE DTL CAN'T BE UPDATED                    @D52QDMK 03394000
.**************************************************************@D52QDMK 03395000
         ST    R4,SVER0F          RET.CODE IN RF               @D356DJO 03396000
         TM    LOCKPARM,UNLALL+UNLEOJ+UNLSYS IN THOSE CASES    @D51UDMK 03397000
         BNZ   SVC64N5            NO DTL AVALABLE              @D51UDMK 03398000
         CLC   DTLLENG(2),DTLLENGO OLD DTL?                    @DY40585 03399000
         BZ    SVC64N5            YES                          @DY40585 03400000
         STC   R4,DTLRC           RETURN CODE IN DTL(LOCK)     @DY40585 03401000
SVC64N5  BAL   R14,SV6364CN       UPDATE                       @DY43697 03402000
         L     R14,TIBPTR         CALLED BY END OF TASK        @D....MK 03403000
         TM    TIBFLAG1-TIBADR(R14),EOTACT CALLED BY EOT       @D....MK 03404000
         BZR   R6                 NO, EXIT TO DISP OR SVC110ZA @D....MK 03405000
         STM   R9,R8,LCKSAV       KEEP REGISTERS               @DY45266 03406000
         SLR   R0,R0              FUNCTION CODE                @D....MK 03407000
         IC    R0,LOCKPARM        FUNCTION CODE                @D....MK 03408000
         L     R14,ASVASVDL       GET MVS ENQ/DEQ ADDRESS      @DY45385 03409000
         L     R14,AIJBEQDQ-SVASVDL(R14)                       @DY45385 03410000
         LTR   R14,R14            MODULE LOADED?               @DY45385 03411000
         BZ    SVC64N51           NO, EXIT VIA LM TO DISP OR SV@DY45266 03412000
         LR    R11,R14            CALL IJBEQDQ VIA R11         @DY45385 03413000
*        AMODESW CALL,REGS=(R6,RB) CALL $IJBEQDQ               @D....MK 03414000
         AMODESW CALL,REGS=(R6,RB) CALL $IJBEQDQ               @D....MK 03415000
SVC64N51 L     R13,LOCKBASE       SAVE AREA ADDRESSABILITY     @DY45266 03416000
         LM    R9,R8,LCKSAV       GET REGISTER BACK            @DY45266 03417000
         BR    R6                 EXIT TO DISP OR SVC110ZA     @DY45266 03418000
.**************************************************************@D52QDMK 03419000
.*  RELEASE REQUEST RETURNCODE PROCESSING:                     @D52QDMK 03420000
.*  IF RC=0 THEN DON'T GIVE RETURN CODE                        @D52QDMK 03421000
.*  ELSE GIVE RETRUN CODE '1' (NO RESOURCE RELEASED)           @D52QDMK 03422000
.**************************************************************@D52QDMK 03423000
SVC64N4  LTR   R4,R4              RETURN CODE ZERO             @D356DJO 03424000
         BH    SVC64N6            NO                           @D356DJO 03425000
         TM    DTLFLG2,DTLREDC    REDUCE LOCK CONTROL          @D356DJO 03426000
         BO    SVC64N6            YES                          @D52XDMK 03427000
         BAL   R14,SV6364CN       UPDATE                       @D52XDMK 03428000
         BR    R6                 NO, EXIT TO DISP OR SVC110ZA @D52XDMK 03429000
SVC64N6  MVI   SVER01,1           NO RESOURCE RELEASED         @D356DJO 03430000
         BAL   R14,SV6364CN       UPDATE                       @D52XDMK 03431000
         BR    R6                 EXIT TO DISP OR SVC110ZA     @D52QDMK 03432000
         DROP  R8                                              @D356DJO 03433000
         EJECT                                                 @D149DIS 03434000
         SPACE 2                                               @D149DIS 03435000
***************************************************************@D149DIS 03436000
*                                                              @D356DJO 03437000
*   PROCESS UNLOCK ALL REQUEST                                 @D356DJO 03438000
*                                                              @D356DJO 03439000
***************************************************************@D149DIS 03440000
         SPACE 1                                               @D356DJO 03441000
         USING DISP,R6                                         @D52QDMK 03442000
SVC110T  TM    LOCKPARM,UNLEOJ    UNLOCK ALL JC=EOJ            @D36SDJO 03443000
         BNO   SVC110T1           NO, EOJ-STEP REQUEST         @D36SDJO 03444000
.**************************************************************@D52QDMK 03445000
.*  UNLOCK ALL/EOJ IS ONLY ALLOWED FOR KEY0 TASKS              @D52QDMK 03446000
.**************************************************************@D52QDMK 03447000
         L     RF,TCBSAVE         USER SAVE AREA ADDRESS       @D36SDJO 03448000
         USING SVEARA,RF                                       @D36SDJO 03449000
         TM    SVEPSW+1,KEY0      PSW KEY ZERO                 @D36SDJO 03450000
         DROP  RF                                              @D36SDJO 03451000
         BNZ   ERR21              NO, ILLEGAL REQUEST          @D36SDJO 03452000
.**************************************************************@D52QDMK 03453000
.*  UNLOCK ALL GET POINTER TO FIRST ENTRY                      @D52QDMK 03454000
.**************************************************************@D52QDMK 03455000
SVC110T1 L     R14,ASV6364T        ADDITIONAL PROTECTION       @DY43697 03456000
         BALR  R12,R14             ... MECHANISM               @DY43697 03457000
         L     R2,ALOKTABA        LOCKTAB ENTRY FOR UNLOCK ALL @D61NDMK 03458000
.**************************************************************@D52QDMK 03459000
.*  CHECK FOR EXTERNAL DEADLOCK SITUATION:                     @D52QDMK 03460000
.*  CLEAR BUFFER                                               @D52QDMK 03461000
.**************************************************************@D52QDMK 03462000
         XC    TCBWAREA(BUFSLOT+1),TCBWAREA  GIVE UP THIS ENTRY@D52QDMK 03463000
.**************************************************************@D52QDMK 03464000
.*  LOOP THRU ALL LOCKTAB ENTRIES                              @D52QDMK 03465000
.*  - SAVE FORWARD POINTER BECAUSE THE CAHINING CAN CHANGE IN  @D52QDMK 03466000
.*    UNLOCK PROCESSING WITH REQUEST ELEMENTS                  @D52QDMK 03467000
.*  - IF ENTRY IS NOT USED THEN PROCEED TO NEXT ONE            @D52QDMK 03468000
.*  - IF UNLOCK EOJ THEN UNLOCK THE ENTRY                      @D52QDMK 03469000
.*    ELSE IF EOT PROCESSING IS ACTIVE THEN UNLOCK THE ENTRY   @D52QDMK 03470000
.*    ELSE PROCESS ENTRY ONLY IF NOT OPTION OWNER=PARTITION    @D52QDMK 03471000
.**************************************************************@D52QDMK 03472000
SVC110T2 MVC   NLOCKPTR,LOCKPTR   SAVE FORWARD POINTER         @D52QDMK 03473000
         TM    LOCKFLG2,LOCKUSED  VALID ENTRY                  @D36SDJO 03474000
         BZ    SVC110T4           NO, LOCK FOR NEXT ENTRY      @D14CDFG 03475000
         CLC   TID,ARTIDH         IS IT SYSTEM PARTITION       @D66ODOW 03476000
         BE    SVC110T3           YES, DON'T UNLOCK OWN=PART   @D61NDMK 03477000
         MVC   TRCRESN,LOCKRESN   SAVE RESOURCE NAME FOR TRACE @D52XDMK 03478000
         TM    LOCKPARM,UNLEOJ    UNLOCK ALL JC=EOJ            @DA32213 03479000
         BO    SVC64C2            IF YES, PROCESS THIS ENTRY   @DA32213 03480000
         L     R8,TIBPTR          TIB OF CURRENT TASK          @D14CDFG 03481000
         USING TIBADR,R8                                       @D14CDFG 03482000
         AIF   (NOT &BGDSHR).DSHRNST GO IF NO DASD SHARING     @DA32213 03483000
         LH    R8,TIBRTID         CALCULATE TIB OF ....        @DA32213 03484000
         SLL   R8,2               ..... SERVICE                @D66ODOW 03485000
         AL    R8,ATIBATAB        ..... OWNER                  @D66ODOW 03486000
         L     R8,0(,R8)          LOCK MANAGER MAY BE ACTIVE   @D66ODOW 03487000
.DSHRNST ANOP                                                  @DA32213 03488000
         TM    TIBFLAG1,EOTACT    CALLED BY END OF TASK        @D14CDFG 03489000
         BO    SVC64C2            IF YES, PROCESS THIS ENTRY   @D14CDFG 03490000
         DROP  R8                                              @D14CDFG 03491000
SVC110T3 TM    LOCKFLG2,LOCKPART  LOCKED FOR PARTITION         @D61NDMK 03492000
         BZ    SVC64C2            NO, PROCESS THIS ENTRY       @D14CDFG 03493000
.**************************************************************@D52QDMK 03494000
.*  ENTRY FROM UNLOCK RESOURCE PROCESSING                      @D52QDMK 03495000
.*  - GET NEXT LOCKTAB ENTRY (FROM SAVED POINTER)              @D52QDMK 03496000
.*  - IF END NOT REACHED GO BACK TO UNLOCK LOOP ELSE EXIT      @D52QDMK 03497000
.**************************************************************@D52QDMK 03498000
SVC110T4 L     R2,NLOCKPTR        NEXT ENTRY                   @D52QDMK 03499000
         LTR   R2,R2              ALL ENTRIES PROCESSED        @D37CDOW 03500000
         BNZ   SVC110T2           LOOP AROUND                  @D37CDOW 03501000
         AIF   (&BGDSHR).SV110U1                               @D36SDJO 03502000
         B     SVC64N             SET RC = 0                   @D51UDMK 03503000
         AGO   .CSYSID2                                        @D37CDOW 03504000
.SV110U1 ANOP                                                  @D36SDJO 03505000
         TM    DSHRFLG,LCKSYS     IS EXTERNAL DISK RESERVED    @D36SDJO 03506000
         BNO   SVC64N             NO, SET RC = 0               @D51UDMK 03507000
***************************************************************@D149DIS 03508000
*   RELEASE DISK AND RESET SYSTEM TASK                         @D36SDJO 03509000
***************************************************************@D149DIS 03510000
         BAL   RF,LCKDEACT        DEACTIVATE SYSTEM TASK       @D36SDJO 03511000
         B     SVC64N             SET RC = 0                   @D51UDMK 03512000
         DROP  R6                                              @D52QDMK 03513000
         EJECT                                                 @D149DIS 03514000
         SPACE 2                                               @D149DIS 03515000
***************************************************************@D51IDMK 03516000
*                                                                       03517000
*   S V C 1 1 0 U C                                                     03518000
*                                                                       03519000
*                                                                       03520000
*   UNCHAIN LOCKTAB ENTRY FROM SPECIAL QUEUE.                           03521000
*   THE SPECIFIED LOCKTAB ENTRY IS PLACED DIRECTLY BEHIND THE LAST      03522000
*   RESOURCES.                                                          03523000
*   ENTRY POINT:   SVC110UC WITH PARAMETER LOCKTAB PTR IN R2            03524000
*                                                                       03525000
*   INPUT:         R2 CONTAINS LOCKTAB PTR OF THIS RESOURCE             03526000
*                  R15 CONTAINS RETURN ADDRESS                          03527000
*                                                                       03528000
*   EXITS:         TO R15                                               03529000
*                                                                       03530000
*   REGS CHANGED:  WORKREGISTERS R3, R5, R7, R9                         03531000
*                                                                       03532000
***************************************************************@D51UDMK 03533000
         SPACE 1                                               @D51UDMK 03534000
SVC110UC L     R5,RQBASPTR        GET HEAD OF SPECIAL QUEUE    @D52QDMK 03535000
         LTR   R5,R5              IS SPECIAL QUEUE EMPTY       @D52QDMK 03536000
         BZ    SVC110U9           YES, GO TO RETURN            @D52QDMK 03537000
.**************************************************************@D52QDMK 03538000
.*CHECK IF THIS ENTRY IS ALREADY IN SPECIAL QUEUE              @D52QDMK 03539000
.*IF NO, THEN DO NOTHING                                       @D52QDMK 03540000
.*IF YES, THEN QUEUE BEHIND THE END OF THE SPECIAL QUEUE       @D52QDMK 03541000
.**************************************************************@D52QDMK 03542000
SVC110U2 CR    R5,R2              IS LOCKTAB ENTRY IN SP. QUEUE@D52QDMK 03543000
         BE    SVC110U4           YES, GO TO QUEUE OUT         @D52QDMK 03544000
         C     R5,RQENDPTR        END OF SPECIAL QUEUE?        @D52QDMK 03545000
         BE    SVC110U9           YES,AND NOT FOUND -> RETURN  @D52QDMK 03546000
         L     R5,LOCKPTR-LOCKADR(,R5) GET NEXT QUEUE ENRTY    @D52QDMK 03547000
         B     SVC110U2           GO AND CHECK NEXT ENTRY      @D52QDMK 03548000
.**************************************************************@D52QDMK 03549000
.*UNCHAIN THIS LOCKTAB ENRTY FROM SPECIAL QUEUE                @D52QDMK 03550000
.**************************************************************@D52QDMK 03551000
SVC110U4 L     R3,RQBASPTR        GET HEAD OF SPECIAL QUEUE    @D52QDMK 03552000
         L     R5,RQENDPTR        GET END OF SPECIAL QUEUE     @D52QDMK 03553000
.**************************************************************@D52QDMK 03554000
.*1.     : CHECK FOR SPECIAL CASES                             @D52QDMK 03555000
.**************************************************************@D52QDMK 03556000
         CR    R3,R5              ONLY ONE ENTRY?              @D52QDMK 03557000
         BNE   SVC110U5           NO, CHECK FOR FIRST,LAST     @D52QDMK 03558000
.**************************************************************@D52QDMK 03559000
.*1.1    : THIS ENTRY WAS THE ONLY ONE                         @D52QDMK 03560000
.*         DELETE THE SPECIAL QUEUE - NO FURTHER CHANGES       @D52QDMK 03561000
.**************************************************************@D52QDMK 03562000
         SLR   R3,R3              CLEAR FOR SPECIAL QUEUE EMPTY@D52QDMK 03563000
         ST    R3,RQBASPTR        CLEAR SPECIAL QUEUE HEAD     @D52QDMK 03564000
         ST    R3,RQENDPTR        CLEAR SPECIAL QUEUE END      @D52QDMK 03565000
         B     SVC110U9           GO TO RETURN                 @D52QDMK 03566000
.**************************************************************@D52QDMK 03567000
.*TO REACH HERE WE MUST HAVE SEVERAL LOCKTAB ENTRIES           @D52QDMK 03568000
.**************************************************************@D52QDMK 03569000
SVC110U5 L     R7,LOCKBPTR        GET BWD LOCKTAB ENTRY        @D52QDMK 03570000
         L     R9,LOCKPTR         GET FWD LOCKTAB ENTRY        @D52QDMK 03571000
         CR    R3,R2              IS ENTRY THE FIRST IN SP Q.  @D52QDMK 03572000
         BNE   SVC110U6           NO, CHECK FOR LAST           @D52QDMK 03573000
.**************************************************************@D52QDMK 03574000
.*1.2    : THIS ENTRY IS THE FIRST IN THE SPECIAL QUEUE        @D52QDMK 03575000
.*         MAKE NEXT ELEMENT THE FIRST ONE                     @D52QDMK 03576000
.**************************************************************@D52QDMK 03577000
         ST    R9,RQBASPTR        NEW SPECIAL QUEUE HEAD       @D52QDMK 03578000
         B     SVC110U9           RETURN                       @D52QDMK 03579000
SVC110U6 CR    R5,R2              IS ENTRY THE LAST IN SP Q.   @D52QDMK 03580000
         BNE   SVC110U7           NO, MUST BE SOMEWHERE ELSE   @D52QDMK 03581000
.**************************************************************@D52QDMK 03582000
.*1.2    : THIS ENTRY IS THE LAST IN THE SPECIAL QUEUE         @D52QDMK 03583000
.*         MAKE PREVIOUS ELEMENT THE LAST ONE                  @D52QDMK 03584000
.**************************************************************@D52QDMK 03585000
         ST    R7,RQENDPTR        NEW SPECIAL QUEUE END        @D52QDMK 03586000
         B     SVC110U9           RETURN                       @D52QDMK 03587000
.**************************************************************@D52QDMK 03588000
.*2.     : NOW WE ARE IN THE MIDDLE OF THE QUEUE               @D52QDMK 03589000
.*         DO REAL UNCHAIN                                     @D52QDMK 03590000
.*         R5 IS RQENDPTR                                      @D52QDMK 03591000
.*         R7 IS BWD LOCKTAB ENTRY                             @D52QDMK 03592000
.*         R9 IS FWD LOCKTAB ENTRY                             @D52QDMK 03593000
.**************************************************************@D52QDMK 03594000
SVC110U7 L     R3,LOCKPTR-LOCKADR(,R5) LOCKTAB ENTRY BEHIND    @D52QDMK 03595000
*                                 SPECIAL QUEUE                @D52QDMK 03596000
.**************************************************************@D52QDMK 03597000
.*2.1.   : MODIFY FWD LOCKTAB ENTRY                            @D52QDMK 03598000
.**************************************************************@D52QDMK 03599000
         ST    R7,LOCKBPTR-LOCKADR(,R9) NEW BWD PTR            @D52QDMK 03600000
.**************************************************************@D52QDMK 03601000
.*2.2.   : MODIFY BWD LOCKTAB ENTRY                            @D52QDMK 03602000
.**************************************************************@D52QDMK 03603000
         ST    R9,LOCKPTR-LOCKADR(,R7) NEW FWD PTR             @D52QDMK 03604000
         LTR   R3,R3              IS THERE SUCH A LOCKTAB ENTRY@D52QDMK 03605000
         BZ    SVC110U8           NO, UPDATE ACTUAL ELEMENT    @D52QDMK 03606000
.**************************************************************@D52QDMK 03607000
.*2.3.   : MODIFY FIRST ELEMENT BEHIND SPECIAL QUEUE           @D52QDMK 03608000
.**************************************************************@D52QDMK 03609000
         ST    R2,LOCKBPTR-LOCKADR(,R3) NEW BWD PTR            @D52QDMK 03610000
.**************************************************************@D52QDMK 03611000
.*2.3.   : MODIFY ACTUAL ELEMENT                               @D52QDMK 03612000
.**************************************************************@D52QDMK 03613000
SVC110U8 ST    R3,LOCKPTR         NEW FWD PTR                  @D52QDMK 03614000
         ST    R5,LOCKBPTR        NEW BWD PTR                  @D52QDMK 03615000
.**************************************************************@D52QDMK 03616000
.*2.4.   : MODIFY LAST LOCKTAB ENTRY IN SPECIAL QUEUE          @D52QDMK 03617000
.**************************************************************@D52QDMK 03618000
         ST    R2,LOCKPTR-LOCKADR(,R5) NEW FWD PTR             @D52QDMK 03619000
SVC110U9 BR    R15                RETURN                       @D51UDMK 03620000
         EJECT                                                          03621000
***************************************************************@D149DIS 03622000
*                                                              @D36SDJO 03623000
*   PROCESS UNLOCK JC=SYSID MACRO                              @D36SDJO 03624000
*   UNLOCK ALL LOCKS HELD BY A SPECIFIED CPU                   @D36SDJO 03625000
*                                                              @D36SDJO 03626000
*   REGISTER USAGE: R1 ADDRESS OF SYSID FIELD (INPUT)          @D36SDJO 03627000
*                   R2 SYSID SLOT NUMBER IN LOCK ENTRY         @D36SDJO 03628000
*                   R9 BLOCK NUMBER IN EXTERNAL DATA FILE      @D36SDJO 03629000
*                   R3,R4,R5,R8,RC,RF WORK REGISTERS           @D36SDJO 03630000
*                                                              @D36SDJO 03631000
*   RETURN CODES:   0   SUCCESSFUL REQUEST                     @D36SDJO 03632000
*                   4   CPU-ID NOT FOUND                       @D36SDJO 03633000
*                   8   EXTERNAL FILE DAMAGED (BY PREV.REQ.)   @D36SDJO 03634000
*                  12   IRRECOV. I/O ERROR ON EXTERNAL FILE    @D36SDJO 03635000
*                                                              @D36SDJO 03636000
***************************************************************@D149DIS 03637000
         SPACE 2                                               @D36SDJO 03638000
         USING DISP,R6                                         @D52QDMK 03639000
.**************************************************************@D52QDMK 03640000
.*   ALLOW ONLY IPL AND AR TO EXECUTE THIS SERVICE             @D52QDMK 03641000
.*   IPL CAN CLEAN ONLY LOCK FILE ENTRIES FOR THE OWN SYSTEM   @D52QDMK 03642000
.*   AR CAN CLEAN LOCK FILE ENTRIES FOR ALL SYSTEMS SHARING    @D52QDMK 03643000
.*   THE LOCK FILE                                             @D52QDMK 03644000
.**************************************************************@D52QDMK 03645000
SVC110W  TM    SYSFLAG2,IPLBIT    IS REQUEST FROM IPL          @D36SDJO 03646000
         BO    SVC110W0           YES, NO SYSID CHECK          @D36SDJO 03647000
         LA    R2,D5(R1)          LENGTH OF CPUID FIELD        @D36SDJO 03648000
         BAL   R8,VALIDSVA        VALIDATE CPU-ID FIELD        @D36SDJO 03649000
*SGLINK VALIDSVA,INPUT=(R1,R2,R6,R8),WORK=(R2,R5,R8)           @D52XDMK 03650000
         CLC   TID,ARTIDH         IS IT ATTENTION              @D66ODOW 03651000
         BNE   ERR21              NO, CANCEL                   @D36SDJO 03652000
***************************************************************@D149DIS 03653000
*   WHEN THIS ROUTINE IS ENTERED FROM ATTENTION                @D36SDJO 03654000
*   THE HEADER RECORD IS READ TO DETERMINE THE CPU INDEX       @D36SDJO 03655000
*   (I.E. THE LOCK FILE SLOT NUMBER).                          @D36SDJO 03656000
*   WHEN IT IS ENTERED FROM IPL,                                        03657000
*   THEN DLFINDEX IS USED AS CPU INDEX.                        @D36SDJO 03658000
***************************************************************@D149DIS 03659000
.**************************************************************@D52QDMK 03660000
.* ACTIVATE SYSTEM TASK                                        @D52QDMK 03661000
.* RETRUN (0) = ACTIVATION UNSUCCESSFUL                        @D52QDMK 03662000
.* RETRUN (4) = ACTIVATION DONE                                @D52QDMK 03663000
.**************************************************************@D52QDMK 03664000
SVC110W0 BAL   RF,LCKACT          ACTIVATE SYSTEM TASK         @D36SDJO 03665000
         B     SVC110X7           EXTERNAL FILE DAMAGED        @D36SDJO 03666000
.**************************************************************@D52QDMK 03667000
.* THE NORMAL CCW CHAIN FOR ACCESSING THE LOCK FILE IS         @D52QDMK 03668000
.* CKD: SEEK -SEARCH - TIC - WRITE - RELEASE NO CHANGE         @DY43802 03669000
.* ECKD:DEFINE EXTENT - LOCATE RECORD - WRITE  NO CHANGE       @D52QDMK 03670000
.**************************************************************@D52QDMK 03671000
         L     RF,ADLFCCB         I/O CONTROL BLOCKS OF DSHR   @D36SDJO 03672000
         USING DLFCCBR,RF                                      @D36SDJO 03673000
         DROP  RF                                              @D36SDJO 03674000
         SR    R9,R9              POINT TO HEADER RECORD       @D36SDJO 03675000
.**************************************************************@D52QDMK 03676000
.* IF CALLER=IPL THEN TAKE DLFINDEX (OWN CPU SLOT)             @D52QDMK 03677000
.**************************************************************@D52QDMK 03678000
         TM    SYSFLAG2,IPLBIT    IS IT IPL                    @D36SDJO 03679000
         BNO   SVC110W2           NO, READ HEADER RECORD       @D36SDJO 03680000
         CLI   DLFDEVT,DLFFBA     EXTERNAL FILE ON FBA         @D68DDMZ 03681000
         BNE   SVC110W1           NO                           @D68DDMZ 03682000
         BAL   R8,LCKREL          DO A RELEASE                 @D68DDMZ 03683000
*SGLINK  LCKREL,INPUT=(R8).WORK=(R1),OUTPUT=(NONE)             @D68DDMZ 03684000
         B     SVC110X8           IRRECOVERABLE IO ERROR       @D68DDMZ 03685000
SVC110W1 DS    0H                                              @D68DDMZ 03686000
         LH    R2,DLFINDEX        MY CPUID                     @D36SDJO 03687000
         B     SVC110W5           DONT READ HEADER RECORD      @DY43802 03688000
.**************************************************************@D52QDMK 03689000
.* IF CALLER=AR THEN GET THE HEADER AND CALCULATE THE CPU SLOT @D52QDMK 03690000
.**************************************************************@D52QDMK 03691000
SVC110W2 BAL   R8,SVC110Z         READ RECORD FROM EXT.FILE    @D36SDJO 03692000
*SGLINK  SVC110Z,INPUT=(R7,R8,R9),WORK=(R0,R3,R5,RE,RF),OUTPUT=R4       03693000
         SR    R2,R2                                           @D36SDJO 03694000
         LA    R8,DLFCPUS-DLFADR(R4) CPU FIELDS                @D36SDJO 03695000
SVC110W3 TM    DLFCPUF1(R8),DLFCPUUS THIS SLOT USED            @D36SDJO 03696000
         BNO   SVC110W4          NO, TEST NEXT                 @D36SDJO 03697000
         CLC   2(6,R8),0(R1)     COMPARE CPU IDS               @D36SDJO 03698000
         BE    SVC110W5          BRANCH IF CPUID FOUND         @DY43802 03699000
SVC110W4 LA    R2,1(R2)          INCREASE SLOT NUMBER          @D36SDJO 03700000
         LA    R8,8(R8)          POINT TO NEXT CPU FIELD       @D36SDJO 03701000
         CH    R2,DLFNCPUS       END OF CPU FIELDS             @D36SDJO 03702000
         BL    SVC110W3          NO, TRY NEXT FIELD            @D36SDJO 03703000
.**************************************************************@D52QDMK 03704000
.* IF END OF HEADER INFORMATION FOUND AND CPU ID DID NOT MATCH @D52QDMK 03705000
.* THEN DEACTIVATE SYSTEM TASK AND RETURN 'CPU NOT FOUND'      @D52QDMK 03706000
.**************************************************************@D52QDMK 03707000
         BAL   RF,LCKDEACT       ERROR                         @D36SDJO 03708000
         LA    R4,4               RETURN CPU NOT FOUND         @D36SDJO 03709000
         SGCOV D52XDMK2                                        @D52XDMK 03710000
         B     SVC64N2            TO USER TASK                 @D36SDJO 03711000
         SPACE 2                                               @D149DIS 03712000
.**************************************************************@DY43802 03713000
.*  ENTRY: CPU SLOT KNOWN                                      @DY43802 03714000
.*  ISSUE LCKGET WITHOUT RESERVE AS DEFAULT                    @DY43802 03715000
.*  IF THIS CPU IS OWNER THEN REPEAT LCKGET WITH RESERVE       @DY43802 03716000
.**************************************************************@DY43802 03717000
SVC110W5 L     RF,ADLFCCB         I/O CONTROL BLOCKS FOR DSHR  @DY43802 03718000
         USING DLFCCBR,RF                                      @DY43802 03719000
         LA    R1,DLFCCBR         READ CCB                     @DY43802 03720000
         DROP  RF                                              @DY43802 03721000
         L     R15,8(,R1)         FIRST CCW (RESERVE)          @DY43802 03722000
         STCM  R15,7,LCKREAD1+1   SAVE FOR LATER USE           @DY43802 03723000
         LA    R15,8(,R15)        NEXT CCW (SEEK, DEF EXT)     @DY43802 03724000
         STCM  R15,7,9(R1)        STORE NEW START OF CHN PROG  @DY43802 03725000
         STCM  R15,7,LCKREAD2+1   SAVE FOR LATER USE           @DY43802 03726000
***************************************************************@D149DIS 03727000
*   SCAN ALL DATA BLOCKS FOR LOCKS HELD BY SPECIFIED SYSTEM    @D36SDJO 03728000
*   UNTIL END REACHED                                          @D52QDMK 03729000
***************************************************************@D149DIS 03730000
SVC110W6 LA    R9,1(R9)           NEXT BLOCK                   @D36SDJO 03731000
         CH    R9,DLFNBLK         LAST BLOCK                   @D36SDJO 03732000
         BH    SVC110Y            YES                          @D36SDJO 03733000
.**************************************************************@D52QDMK 03734000
.* GET NEXT DISK BLOCK                                         @D52QDMK 03735000
.**************************************************************@D52QDMK 03736000
         BAL   R8,SVC110Z         GET DISK BLOCK               @D36SDJO 03737000
*SGLINK  SVC110Z,INPUT=(R7,R8,R9),WORK=(R0,R3,R5,RE,RF),OUTPUT=R4       03738000
.**************************************************************@D52QDMK 03739000
.* READ NUMBER OF ENTRIES                                      @D52QDMK 03740000
.* IF NUMBER=0 THEN CONTINUE WITH NEXT BLOCK                   @D52QDMK 03741000
.* IF NUMBER>MAX THEN DISK BLOCK IS DESTROYED: STOP PROCESSING @D52QDMK 03742000
.**************************************************************@D52QDMK 03743000
         LR    R5,R4              SAVE START ADDR OF BLOCK     @D36SDJO 03744000
         LH    R3,2(R4)            NUMBER OF ENTRIES IN BLOCK  @D36SDJO 03745000
         LTR   R3,R3               BLOCK EMPTY                 @D36SDJO 03746000
         BZ    SVC110W6            YES, TRY NEXT               @D36SDJO 03747000
         CH    R3,DLFNENT          COMPARE WITH MAX VALUE      @D36SDJO 03748000
         BH    SVC110X6            ERROR IN EXT FILE           @D36SDJO 03749000
         LA    R4,4(R4)            FIRST LOCK ENTRY            @D36SDJO 03750000
         BCTR  R3,0                N-1                         @D36SDJO 03751000
         MH    R3,DLFLENT          LENGTH OF ONE ENTRY         @D36SDJO 03752000
         AR    R3,R4               POINT TO LAST USED POSITION @D36SDJO 03753000
         LH    RC,DLFLENT          LOCK ENTRY LENGTH           @D36SDJO 03754000
.**************************************************************@D52QDMK 03755000
.* DO FOR ALL LOCK ENTIES                                      @D52QDMK 03756000
.* IF LOCK ENTRY IS LOCKED BY THIS SLOT THEN FREE IT           @D52QDMK 03757000
.* IF THIS SLOT WAS THE ONLY OWNER OF THE ENTRY THEN MARK THE  @D52QDMK 03758000
.* ENTIRE ENTRY AS FREE                                        @D52QDMK 03759000
.**************************************************************@D52QDMK 03760000
SVC110X1 CR    R4,R3               ALL ENTRIES PROCESSED       @D36SDJO 03761000
         BH    SVC110X5            YES                         @D36SDJO 03762000
*        LR    R0,R4               SAVE POSITION IN BLOCK      @D36SDJO 03763000
         AR    R4,R2               ADD CPU NUMBER              @D36SDJO 03764000
         CLI   L'LOCKRESN(R4),ZERO IS LOCKING FIELD ZERO       @D36SDJO 03765000
         BE    SVC110X3            YES, NOT LOCKED BY ME       @D36SDJO 03766000
         TM    SERVFLG,LCKOWN      OWNERSHIP SET?              @DY43802 03767000
         BO    SVC110X2            YES CONTINUE UNLOCK         @DY43802 03768000
         OI    SERVFLG,LCKOWN      SET OWNERSHIP               @DY43802 03769000
         L     RF,ADLFCCB          I/O CONTROL BLOCKS FOR DSHR @DY43802 03770000
         USING DLFCCBR,RF                                      @DY43802 03771000
         LA    R1,DLFCCBR          READ CCB                    @DY43802 03772000
         DROP  RF                                              @DY43802 03773000
         MVC   9(3,R1),LCKREAD1+1  START NEXT TIME WITH 1ST CCW@DY43802 03774000
         BCTR  R9,0                SET R9 TO GET SAME BLOCK    @DY43802 03775000
         B     SVC110W6            GET WITH RESERVE FOR UPDATE @DY43802 03776000
SVC110X2 MVI   L'LOCKRESN(R4),ZERO UNLOCK THIS RESOURCE        @DY43824 03777000
         OI    UNLCKFLG,BLKMODF    MODIFY FLAG                 @D36SDJO 03778000
         SR    R4,R2               BACK TO FIRST CPU FIELD     @D36SDJO 03779000
         LH    R8,DLFNCPUS         # OF CPUS                   @D36SDJO 03780000
         BCTR  R8,0                SUBTRACT ONE FOR EXECUTE    @D36SDJO 03781000
         EX    R8,LCKTST           ALL CPU-FIELDS ZERO         @D36SDJO 03782000
         BNZ   SVC110X4            NO,DONT REMOVE THIS ENTRY   @DA24161 03783000
         LH    R8,2(R5)            NUMBER OF ENTRIES IN BLOCK  @D36SDJO 03784000
         BCTR  R8,0                # OF ENTRIES MINUS 1        @D36SDJO 03785000
         STH   R8,2(R5)            STORE IN BLOCK              @D36SDJO 03786000
         LR    R8,RC               ENTRY LENGTH                @D36SDJO 03787000
         BCTR  R8,0                -1 FOR EXECUTE              @D36SDJO 03788000
         EX    R8,LCKSHIFT         SHIFT LAST TO FREE          @D36SDJO 03789000
         SR    R3,RC               REDUCE LAST USED            @D36SDJO 03790000
         B     SVC110X1                                        @D36SDJO 03791000
         SPACE 2                                               @D149DIS 03792000
.**************************************************************@D52QDMK 03793000
.* REPOSTION POINTERS AND CONTINUE WITH NEXT ENTRY             @D52QDMK 03794000
.**************************************************************@D52QDMK 03795000
SVC110X3 SR    R4,R2               BACK TO FIRST CPU FIELD     @D36SDJO 03796000
SVC110X4 EQU   *                                               @DA24161 03797000
         AR    R4,RC               NEXT LOCK ENTRY             @D36SDJO 03798000
         B     SVC110X1            PROCESS IT                  @D36SDJO 03799000
.**************************************************************@D52QDMK 03800000
.* ENTER HERE IF THE ENTIRE DISK BLOCK IS PROCESSED            @D52QDMK 03801000
.* IF THE CONTENTS HAVE CHANGED THEN WRITE BACK THIS BLOCK     @D52QDMK 03802000
.**************************************************************@D52QDMK 03803000
SVC110X5 TM    UNLCKFLG,BLKMODF   THIS BLOCK MODIFIED          @D36SDJO 03804000
         BO    SVC110XX           YES                          @D61NDMK 03805000
         B     SVC110W6           NEXT BLOCK                   @D61NDMK 03806000
SVC110XX NI    UNLCKFLG,XFF-BLKMODF RESET MODIFY FLAG          @D61NDMK 03807000
         NI    SERVFLG,XFF-LCKOWN RESET OWNERSHIP              @DY43824 03808000
         L     RF,ADLFCCB         I/O CONTROL BLOCKS FOR DSHR  @DY43824 03809000
         USING DLFCCBR,RF                                      @DY43824 03810000
         LA    R1,DLFCCBR         READ CCB                     @DY43824 03811000
         DROP  RF                                              @DY43824 03812000
         MVC   9(3,R1),LCKREAD2+1 START NEXT TIME WITH 2ND CCW@DY43824  03813000
.**************************************************************@D52QDMK 03814000
.*  WRITE DISK BLOCK BACK TO LOCK FILE                         @D52QDMK 03815000
.*  RETURN (0) = WRITE WAS NOT SUCCESSFUL                      @D52QDMK 03816000
.*  RETURN (4) = WRITE DONE                                    @D52QDMK 03817000
.**************************************************************@D52QDMK 03818000
         BAL   RF,LCKPUT          WRITE BACK DISK BLOCK        @D36SDJO 03819000
*SGLINK  LCKPUT,INPUT=(RF),WORK=(R3)                           @D36SDJO 03820000
         B     SVC110X8           IRRECOVERABLE I/O ERROR      @D36SDJO 03821000
         CLI   DLFDEVT,DLFECKD    LOCK FILE ON ECKD            @D61NDMK 03822000
         BE    SVC110XY           YES, RELEASE                 @D61NDMK 03823000
         CLI   DLFDEVT,DLFFBA     LOCK FILE ON FBA             @D61NDMK 03824000
         BNE   SVC110W6           NO, MUST BE CKD              @D61NDMK 03825000
SVC110XY L     RF,ADLFCCB         I/O CONTROL BLOCKS FOR DSHR  @D61NDMK 03826000
         USING DLFCCBR,RF                                      @D61NDMK 03827000
         LA    R1,DLFCCBS         RELEASE DISK UNIT            @D61NDMK 03828000
         DROP  RF                                              @D61NDMK 03829000
         SVC   15                 EXECUTE RELEASE              @D61NDMK 03830000
         WAIT  (1)                                             @D61NDMK 03831000
         B     SVC110W6           NEXT BLOCK                   @D61NDMK 03832000
         SPACE 2                                               @D149DIS 03833000
.**************************************************************@D52QDMK 03834000
.*  ERROR EXIT IF I/O WAS NOT SUCCESSFUL                       @D52QDMK 03835000
.**************************************************************@D52QDMK 03836000
SVC110X8 OI    DLFFLG1,DSHRDOWN                                @D36SDJO 03837000
         BAL   RF,LCKDEACT        DEACTIVATE SYSTEM TASK       @D36SDJO 03838000
SVC110X9 LA    R4,12              I/O ERROR ON FORCEREL        @D36SDJO 03839000
         SGCOV D52XDMK2                                        @D52XDMK 03840000
         B     SVC64N2                                         @D36SDJO 03841000
         EJECT                                                 @D149DIS 03842000
         SPACE 2                                               @D149DIS 03843000
***************************************************************@D149DIS 03844000
*   ALL DATA BLOCKS ARE PROCESSED                              @D36SDJO 03845000
*   IF REQUEST IS FROM ATTENTION THEN CLEAR THE CPU FIELD IN   @D52QDMK 03846000
*   THE HEADER AND UPDATE THE HEADER BLOCK                     @D52QDMK 03847000
***************************************************************@D149DIS 03848000
SVC110Y  L     RF,ADLFCCB          I/O CONTROL BLOCKS FOR DSHR @DY43824 03849000
         USING DLFCCBR,RF                                      @DY43824 03850000
         LA    R1,DLFCCBR          READ CCB                    @DY43824 03851000
         DROP  RF                                              @DY43824 03852000
         MVC   9(3,R1),LCKREAD1+1  START NEXT TIME WITH 1ST CCW@DY43824 03853000
         TM    SYSFLAG2,IPLBIT    IPL IN PROGRESS              @DY43824 03854000
         BO    SVC110Y2           YES, DONT UPDATE HEADER      @D36SDJO 03855000
         SR    R9,R9              POINT TO HEADER RECORD       @D36SDJO 03856000
.**************************************************************@D52QDMK 03857000
.*  GET HEADER RECORD FOR UPDATE                               @D52QDMK 03858000
.**************************************************************@D52QDMK 03859000
         BAL   R8,SVC110Z         READ HEADER RECORD           @D36SDJO 03860000
*SGLINK  SVC110Z,INPUT=(R7,R8,R9),WORK=(R0,R3,R5,RE,RF),OUTPUT=R4       03861000
         LA    R4,DLFCPUS-DLFADR(R4)  POINT TO FIRST CPU FIELD @D36SDJO 03862000
         AR    R2,R2              **  MULTIPLY                 @D36SDJO 03863000
         AR    R2,R2              **  CPU NUMBER               @D36SDJO 03864000
         AR    R2,R2              **  BY EIGHT                 @D36SDJO 03865000
         AR    R4,R2              FIND CPU SLOT                @D36SDJO 03866000
         XC    0(8,R4),0(R4)      CLEAR CPU ID FIELD           @D36SDJO 03867000
.**************************************************************@D52QDMK 03868000
.*  WRITE DISK BLOCK BACK TO LOCK FILE                         @D52QDMK 03869000
.*  RETURN (0) = WRITE WAS NOT SUCCESSFUL                      @D52QDMK 03870000
.*  RETURN (4) = WRITE DONE                                    @D52QDMK 03871000
.**************************************************************@D52QDMK 03872000
         BAL   RF,LCKPUT          WRITE BACK DISK BLOCK        @D36SDJO 03873000
*SGLINK  LCKPUT,INPUT=(RF),WORK=(R3)                           @D36SDJO 03874000
         B     SVC110X6           I/O ERROR                    @D36SDJO 03875000
SVC110Y2 EQU   *                                               @D36SDJO 03876000
         AIF   (NOT &BGFBA).SV110Y1                            @D36SDJO 03877000
         CLI   DLFDEVT,DLFFBA     LOCK FILE ON FBA             @D36SDJO 03878000
         BE    SVC110Y3           YES                          @D36SDJO 03879000
.SV110Y1 ANOP                                                  @D36SDJO 03880000
.**************************************************************@D52QDMK 03881000
.* REPAIR THE CCW CHAIN:                                       @D52QDMK 03882000
.* CKD: SEEK -SEARCH - TIC - WRITE                             @D52QDMK 03883000
.*      CHAIN THE RELEASE COMMAND TO IT                        @D52QDMK 03884000
.* ECKD:DEFINE EXTENT - LOCATE RECORD - WRITE  NO CHANGE       @D52QDMK 03885000
.**************************************************************@D52QDMK 03886000
         CLI   DLFDEVT,DLFECKD    LOCK FILE ON ECKD            @DA42402 03887000
         BE    SVC110Y3           YES                          @DA42402 03888000
         L     RF,ADLFCCB         I/O CONTROL BLOCKS FOR DSHR  @D36SDJO 03889000
         USING DLFCCBR,RF                                      @D36SDJO 03890000
         OI    DLFCCW5+4,CC       COMMAND CHAINING             @D36SDJO 03891000
         OI    DLFFLG1,DLFCHAIN   CHAINING FLAG                @D36SDJO 03892000
         DROP  RF                                              @D36SDJO 03893000
.**************************************************************@D52QDMK 03894000
.* DEACTIVATE SYSTEM TASK                                      @D52QDMK 03895000
.**************************************************************@D52QDMK 03896000
SVC110Y3 BAL   RF,LCKDEACT        DEACTIVATE SYSTEM TASK       @D36SDJO 03897000
         B     SVC64N             SET R.C. = 0                 @D36SDJO 03898000
         EJECT                                                 @D149DIS 03899000
         SPACE 2                                               @D149DIS 03900000
***************************************************************@D149DIS 03901000
*   READ ROUTINE                                               @D36SDJO 03902000
*   READ A RECORD FROM EXTERNAL FILE AND CHECK IT              @D36SDJO 03903000
***************************************************************@D149DIS 03904000
*SGLINK  SVC110Z,S,INPUT=(R7,R8,R9),WORK=(R0,R3,R5,RE,RF),OUTPUT=R4     03905000
.**************************************************************@D52QDMK 03906000
.* READ DISK BLOCK                                             @D52QDMK 03907000
.* RETRUN (0) = BLOCK NOT FOUND                                @D52QDMK 03908000
.* RETRUN (4) = BLOCK FOUND, CAN CHECK IT NOW                  @D52QDMK 03909000
.**************************************************************@D52QDMK 03910000
SVC110Z  BAL   RF,LCKGET          READ RECORD FROM EXT.FILE    @D36SDJO 03911000
*SGLINK  LCKGET,INPUT=(R9,RF),WORK=(R0,R3,R5,R7,RE),OUTPUT=R4           03912000
         B     SVC110X8           IRRECOVERABLE I/O ERROR      @D36SDJO 03913000
         CLC   0(2,R4),DLFCHAR    CORRECT BLOCK                @D36SDJO 03914000
         BER   R8                 YES, RETURN TO CALLER        @D36SDJO 03915000
.**************************************************************@D52QDMK 03916000
.*  ERROR EXIT IF I/O WAS NOT SUCCESSFUL                       @D52QDMK 03917000
.**************************************************************@D52QDMK 03918000
SVC110X6 OI    DLFFLG1,DSHRDOWN                                @D36SDJO 03919000
.**************************************************************@D52QDMK 03920000
.* DEACTIVATE SYSTEM TASK                                      @D52QDMK 03921000
.**************************************************************@D52QDMK 03922000
         BAL   RF,LCKDEACT        DEACTIVATE SYSTEM TASK       @D36SDJO 03923000
SVC110X7 LA    R4,8               EXTERNAL FILE DAMAGED        @D36SDJO 03924000
         SGCOV D52XDMK2                                        @D52XDMK 03925000
         B     SVC64N2                                         @D36SDJO 03926000
         DROP  R6                                              @D52QDMK 03927000
         EJECT                                                 @D51UDMK 03928000
***************************************************************@DY40726 03929000
*  THE FOLLOWING INSTRUCTIONS ARE USED IN EXECUTE INSTRUCTIONS @DY40726 03930000
***************************************************************@DY40726 03931000
LCKSHIFT MVC   0(0,R4),0(R3)      SHIFT LAST TO FREE ENTRY     @DY40726 03932000
LCKCLEAR XC    L'LOCKRESN(0,R5),L'LOCKRESN(R5)  CLEAR TO ZERO  @DY40726 03933000
LCKTST   OC    L'LOCKRESN(0,R4),L'LOCKRESN(R4)  TEST FOR ZERO  @DY40726 03934000
*                                                              @DY40726 03935000
.CSYSID2 ANOP                                                  @DY40726 03936000
***************************************************************@D51UDMK 03937000
*   PROCESS LOCKS FOR QUEUED REQUEST ELEMENTS                  @D51UDMK 03938000
***************************************************************@D51UDMK 03939000
SVC110ZA OI    SERVFLG,NOUSER     DON'T UNPOST CALLER          @D52QDMK 03940000
         BAL   RF,LCKACT          ACTIVATE SYSTEM TASK         @D52QDMK 03941000
         B     SVC110ZV           I/O ERROR ON EXT. FILE       @D52QDMK 03942000
SVC110ZB L     R14,ASV6364T        ADDITIONAL PROTECTION       @DY43697 03943000
         BALR  R12,R14             ... MECHANISM               @DY43697 03944000
         L     RA,TCBPTR          SET CURRENT TCB              @DY45580 03945000
         L     R2,RQBASPTR        REQUEST ELEMENTS TO PROCESS? @D61NDMK 03946000
         LTR   R2,R2                                           @D52QDMK 03947000
         BZ    SVC110ZV           NO                           @D52QDMK 03948000
         MVC   RQENDSAV(4),RQENDPTR SAVE END PTR               @D51UDMK 03949000
***************************************************************@D51UDMK 03950000
*   COUNT REQUEST ELEMENTS                                     @D51UDMK 03951000
***************************************************************@D51UDMK 03952000
SVC110ZC SLR   R3,R3              CLEAR COUNT REGISTER         @D51UDMK 03953000
         L     R7,LOCKRQC         FIRST ELEMENT                @D51UDMK 03954000
         LR    RC,R7              FIRST ELEMENT                @D51UDMK 03955000
SVC110ZD LA    R3,1(R3)           INCREMENT                    @D51UDMK 03956000
         L     R7,LOKOCHN-LOKOADR(,R7) NEXT ELEMENT            @D51UDMK 03957000
         LTR   R7,R7              NULL POINTER?                @D51UDMK 03958000
         BNZ   SVC110ZD           NO                           @D51UDMK 03959000
***************************************************************@D51UDMK 03960000
*   LOCK RESOURCE FOR THIS TASK                                @D51UDMK 03961000
***************************************************************@D51UDMK 03962000
SVC110ZE ST    R3,RQCOUNT         NUMBER OF REQ ELEMENTS       @D51UDMK 03963000
         MVC   LOCKRQC(4),LOKOCHN NEXT REQUESTOR IN QUEUE      @D51UDMK 03964000
***************************************************************@D51UDMK 03965000
*   SWITCH SPACE TO ACCESS DTL                                 @D51UDMK 03966000
*   RC POINTS TO ACTUAL REQUEST ELEMENT                        @D52QDMK 03967000
***************************************************************@D51UDMK 03968000
         LH    R4,LOKOTID         TID OF REQUESTOR             @D52QDMK 03969000
         STH   R4,LCKUTID         STORE TID FOR LOCK SVC       @D52QDMK 03970000
         SGSETUP SWOWNER,STASK=LCK,WR1=(R4),WR2=(R8),OPTION=SETOWNER MK 03971000
         L     R5,ASRQTAB                                      @D61MPMK 03972000
         NC    RBUSE-SRQTAB(2,R5),FREEVAL  SETUP               @D66ODOW 03973000
         OC    RBUSE-SRQTAB(2,R5),LCKUTID  ... RESOURCE OWNER  @D66ODOW 03974000
         L     R1,LOKODTL         POINT TO REQUESTOR'S DTL     @D52QDMK 03975000
         MVC   LOCKPARM(4),DTLLOCKP LOCKPARM OF REQUESTOR      @D52QDMK 03976000
         XC    LCKCNT(PARMEND-LCKCNT),LCKCNT CLEAR TRC FIELDS  @D52QDMK 03977000
         MVC   TRCRESN,DTLNAME    SAVE RESOURCE NAME FOR TRACE @D52QDMK 03978000
         ST    R1,SV110S1         SAVE DTL POINTER             @D52QDMK 03979000
         MVC   TRCFLG1(2),DTLFLG1 SAVE DTL FLAGS FOR TRACING   @D52QDMK 03980000
         TM    SERVFLG,NOINT      REALLOCATION FOR ALL ENTRIES @D52QDMK 03981000
         BZ    SVC110ZF           YES                          @D52QDMK 03982000
         TM    DTLFLG2,DTLVOL+DTLEXTR    EXTERNAL LOCKING      @D52QDMK 03983000
         BNZ   SVC110ZF           YES, DO REALLOCATION         @D52QDMK 03984000
         L     R9,LOCKPTR         GET NEXT LOCKTAB ENTRY       @D52QDMK 03985000
         B     SVC110ZS           SKIP THIS ENTRY              @D52QDMK 03986000
SVC110ZF OI    SERVFLG,NOACDEAC   DISABLE ACT/DEACT            @D52QDMK 03987000
***************************************************************@D51UDMK 03988000
* CLEAR REQU. ELEMENT AND INSERT IT ON TOP OF FREE ELEMENT LIST@D51UDMK 03989000
***************************************************************@D51UDMK 03990000
         XC    LOKOCHN(LOKOLEN),LOKOCHN  CLEAR OUT ELEMENT     @D51UDMK 03991000
         L     R7,LOKOFRL       * INSERT NO-LONGER USED        @D51UDMK 03992000
         ST    RC,LOKOFRL       * ELEMENT AT TOP OF            @D51UDMK 03993000
         ST    R7,LOKOCHN       * FREE ELEMENT LIST            @D51UDMK 03994000
         LA    R6,SVC110ZG        CONITNUE THERE AFTER LOCK    @D51UDMK 03995000
         L     R8,ALCKTIB         GET LCK TIB                  @D51UDMK 03996000
         LH    RA,TIBRTID-TIBADR(,R8) TID OF SERVICE OWNER     @D52QDMK 03997000
         SLL   RA,2               MULTIPLY WITH 4              @D66ODOW 03998000
         AL    RA,ATIBATAB        ADDR WITHIN TIBATAB          @D66ODOW 03999000
         L     RA,0(,RA)          TIBPTR OF OWNING TASK        @D66ODOW 04000000
         L     RA,TIBTCB-TIBADR(,RA) TCB OF SERVICE OWNER      @D52QDMK 04001000
         ST    R8,SV110S8         SAVE TIB FOR EXTERNAL DLCK   @D52QDMK 04002000
         B     SVC63C1            LOCK RESOURCE FOR REQUESTOR  @D51UDMK 04003000
SVC110ZG DS    0H                                              @D51UDMK 04004000
***************************************************************@D51UDMK 04005000
*   CHECK RETURN CODE                                          @D51UDMK 04006000
***************************************************************@D51UDMK 04007000
         CLI   DTLRC,4            POST NECESSARY?              @DY41492 04008000
         BE    SVC110ZH           NO, FORGET IT                @DY41492 04009000
***************************************************************@D51UDMK 04010000
*   POST ECB                                                   @D51UDMK 04011000
***************************************************************@D51UDMK 04012000
         OI    DTLPOST,TRABIT     POST THE ECB                 @D51UDMK 04013000
***************************************************************@D51UDMK 04014000
*   POST WAITING TASK                                          @D51UDMK 04015000
*   IN SOME CASES THE TASK CAN WAIT ON THIS ECB                @D51UDMK 04016000
***************************************************************@D51UDMK 04017000
         LH    R8,LCKUTID         TID OF CURRENT TASK          @D51UDMK 04018000
         L     R6,DISPAD                                       @D51UDMK 04019000
         USING DISP,R6                                         @D52QDMK 04020000
         BAL   RF,IOPOST0          POST USER TASK              @D51UDMK 04021000
         DROP  R6                                              @D52QDMK 04022000
*SGLINK  IOPOST0,INPUT=(R6,R8,RF),WORK=(R8,RE)                 @D51UDMK 04023000
SVC110ZH L     R3,RQCOUNT         GET ACTUAL COUNTER VALUE     @D51UDMK 04024000
         L     RC,LOCKRQC         GET NEXT REQUEST ELEMENT     @D51UDMK 04025000
         BCT   R3,SVC110ZE        PROCESS NEXT REQUESTOR       @D52QDMK 04026000
         SPACE                                                          04027000
.**************************************************************@D52QDMK 04028000
.*  PROCEED TO NEXT LOCKTAB ENTRY                              @D52QDMK 04029000
.**************************************************************@D52QDMK 04030000
SVC110ZK L     R9,LOCKPTR         GET NEXT LOCKTAB ENTRY       @D52QDMK 04031000
         L     R15,LOCKRQC        GET REQUEST ELEMENT          @D52QDMK 04032000
         LTR   R15,R15            IS STILL A REQUESTOR QUEUED? @D52QDMK 04033000
         BNZ   SVC110ZS           YES, DON'T UNCHAIN           @D52QDMK 04034000
.**************************************************************@D52QDMK 04035000
.*  UNCHAIN THIS LOCKTAB ENTRY FROM SPECIAL QUEUE              @D52QDMK 04036000
.**************************************************************@D52QDMK 04037000
         BAL   R15,SVC110UC                                    @D51UDMK 04038000
***************************************************************@D51UDMK 04039000
*   LOOP FOR ALL RESOURCES IN QUEUE                            @D51UDMK 04040000
***************************************************************@D51UDMK 04041000
SVC110ZS L     RC,RQBASPTR        GET FIRST ENTRY              @D52QDMK 04042000
         LTR   RC,RC              NOW EMPTY QUEUE?             @D52QDMK 04043000
         BZ    SVC110ZV           YES, DON'T RETRY             @D52QDMK 04044000
         C     R2,RQENDSAV        COMPARE WITH LAST ENTRY      @D52QDMK 04045000
         BZ    SVC110ZV           END REACHED                  @DA42992 04046000
         LR    R2,R9              GET NEXT RESOURCE            @D51UDMK 04047000
         B     SVC110ZC           LOOP WITH NEXT RESOURCE      @D51UDMK 04048000
***************************************************************@D51UDMK 04049000
*   RETURN TO DISPATCHER                                       @D51UDMK 04050000
***************************************************************@D51UDMK 04051000
SVC110ZV DS    0H                                              @D52QDMK 04052000
         NI    SERVFLG,XFF-NOACDEAC DO DEACTIVATION WITHOUT POSTD52QDMK 04053000
         BAL   RF,LCKDEACT        DEACTIVATE                   @D52QDMK 04054000
         NI    SERVFLG,XFF-NOUSER CLEAN SERVFLG                @D52QDMK 04055000
         NI    SERVFLG,XFF-NOPOST CLEAN SERVFLG                @D52QDMK 04056000
         L     R3,ALCKTIB         TIB POINTER OF SYSTEM TASK   @D52QDMK 04057000
         USING TIBADR,R3           TIB ADDRESSABILITY          @D52QDMK 04058000
         L     R3,TIBTCB           GET LCK TCB ADDRESS         @D52QDMK 04059000
         DROP  R3                  TIB ADDRESSABILITY          @D52QDMK 04060000
         L     R3,TCBSAVE-TCBADR(,R3) LCK TASK SAVE AREA       @D52QDMK 04061000
         USING SVEARA,R3           SAVE AREA ADDRESSABILITY    @D52QDMK 04062000
         LA    R5,SVC110Z1         CONTINUE HERE WITH TIMER    @D52QDMK 04063000
         ST    R5,SVEPSW2          LCK TASK SAVE AREA          @D52QDMK 04064000
         OI    SVEPSW2,SVEPAM31    31-BIT PSW                  @DY44679 04065000
         L     R6,DISPAD                                       @D52QDMK 04066000
         USING DISP,R6                                         @D52QDMK 04067000
SVC110ZX BR    R6                                              @D52QDMK 04068000
         DROP  R6                                              @D52QDMK 04069000
         DROP  RA                 TCBPTR OF USER TASK          @D52QDMK 04070000
***************************************************************@D52QDMK 04071000
*        ENTRY POINT FOR TIMER EXPIRATION                      @D52QDMK 04072000
***************************************************************@D52QDMK 04073000
SVC110Z1 NI    SERVFLG,XFF-SETTIM CLEAN SERVFLG                @D52QDMK 04074000
         NI    DSHRFLG,XFF-LCKTIM TIMER SET FLAG               @D52QDMK 04075000
         OI    SERVFLG,NOUSER+NOACDEAC NO (UN)POST/(DE)ACTIVATE@D52QDMK 04076000
         L     R5,ASRQTAB                                      @D61MPMK 04077000
         TM    RBUSE-SRQTAB(R5),FREEBIT         SVC GATE FREE? @D66ODOW 04078000
         BO    SVC110Z2           YES, CONTINUE                @D66ODOW 04079000
         OI    SERVFLG,NOPOST+SETTIM   NO POST OF SVC110 GATE  @D52QDMK 04080000
*                                 TIMER HAS TO BE SET FOR RETRY@DA42992 04081000
         L     RA,TCBPTR          SET CURRENT TCB              @DY45937 04082000
         B     SVC110ZV           START TIMER                  @DA42992 04083000
SVC110Z2 DS    0H                                              @D66ODOW 04084000
         NI    RBUSE-SRQTAB(R5),NFREEMSK    CLOSE LCK MGR GATE @D66ODOW 04085000
SVC110Z3 B     SVC110ZB           REPEAT REALLOCATION          @D52QDMK 04086000
         EJECT                                                          04087000
***************************************************************@D52QDMK 04088000
*                                                                       04089000
*   S V C 1 1 0 T R                                                     04090000
*                                                                       04091000
*                                                                       04092000
*   TRACE LOCKMANAGER ACTIVITIES                                        04093000
*   THE FOLLOWING INFORMATION IS STORED INTO THE 40 ENTRY TRACE AREA:   04094000
*F :- LCKUTID / TID / LOCKPARM / 1 BYTE RETURN CODE                     04095000
*F :- R1 (DTL POINTER)                                                  04096000
*F :- DTLFLAG1 / DTLFLAG2/ SERVFLG / OWNER TID (IF ANYONE QUEUED)       04097000
*F :- LOKOWORK / REQWORK / UNLCKFLG / DSHRFLG                           04098000
*3F:- RESOURCE NAME (12 BYTES)                                          04099000
*F :- POINTER TO CURRENT LOCKTAB ENTRY                                  04100000
*8F:- CURRENT LOCKTAB ENTRY                                             04101000
*   ENTRY POINT:   SVC110TR WITHOUT PARAMETERS                          04102000
*                                                                       04103000
*   INPUT:         AS DESCRIBED                                         04104000
*                  R15 CONTAINS RETURN ADDRESS                          04105000
*                                                                       04106000
*   EXITS:         TO R15                                               04107000
*                                                                       04108000
*   REGS CHANGED:  NONE                                                 04109000
*                                                                       04110000
***************************************************************@D52QDMK 04111000
         SPACE 1                                               @D52QDMK 04112000
SVC110TR L     RE,SVC11TRC       GET CURRENT POINTER           @D52QDMK 04113000
         MVC   0(2,RE),LCKUTID   SAVE LCKUTID                  @D66ODOW 04114000
         MVC   2(2,RE),TID       SAVE LOW CORE TID             @D66ODOW 04115000
         MVC   4(1,RE),LOCKPARM  SAVE LOCKPARM                 @D66ODOW 04116000
         STC   R4,5(,RE)         SAVE RETURN CODE              @D66ODOW 04117000
         XC    6(2,RE),6(RE)                                   @D66ODOW 04118000
         MVC   8(4,RE),SV110S1   SAVE DTLPOINTER               @DY45817 04119000
         MVC   12(2,RE),TRCFLG1  SAVE DTL FLAGS                @D66ODOW 04120000
         MVC   14(1,RE),SERVFLG  SAVE SERVFLG                  @D66ODOW 04121000
         XC    15(1,RE),15(RE)                                 @D66ODOW 04122000
         MVC   16(2,RE),TRCOTID  SAVE OWNER TID                @D66ODOW 04123000
         XC    18(2,RE),18(RE)                                 @D66ODOW 04124000
         MVC   20(4,RE),LOKOWORK SAVE LOKOWORK/                @D66ODOW 04125000
***                              .../REQWORK/UNLCKFLG/DSHRFLG           04126000
         MVC   24(L'LOCKRESN,RE),TRCRESN  SAVE RESOURCE NAME   @D66ODOW 04127000
         ST    R2,36(,RE)        LOCKTAB ENTRY                 @D66ODOW 04128000
         XC    40(8,RE),40(RE)                                 @D66ODOW 04129000
         MVC   48(LOCKLEN,RE),LOCKCHN SAVE CURRENT LOCKTAB ENTR@D66ODOW 04130000
         DEBUG LOCK,LOCK                                       @D61NDMK 04131000
         LA    RE,80(,RE)        NEXT SLOT                     @D66ODOW 04132000
         C     RE,SVC11TRE       COMPARE WITH END              @D52QDMK 04133000
         BNP   SVC110TC          IF LOWER THEN CONTINUE        @D52QDMK 04134000
         L     RE,SVC11TRS       WRAP                          @D52QDMK 04135000
SVC110TC ST    RE,SVC11TRC       UPDATE CURRENT ADDRESS        @D52QDMK 04136000
         LR    R7,R0             SAVE DEADLOCKCHECK RETURNCODE @DY43697 04137000
         LA    R0,1              PROTECT                       @DY43697 04138000
         L     R14,ASV6364T        ADDITIONAL PROTECTION       @DY43697 04139000
         USING SV6364T,R14                                     @DY43697 04140000
         BAL   R12,SV6364TP        ... MECHANISM               @DY43697 04141000
         DROP  R14                                             @DY43697 04142000
         LR    R0,R7             SAVE DEADLOCKCHECK RETURNCODE @DY43697 04143000
         BR    RF                RETURN                        @D52QDMK 04144000
         SPACE 3                                               @D356DJO 04145000
         DROP  R1                                              @D36SDJO 04146000
         DROP  RC                 LOKOADR,RC                   @D356DJO 04147000
         EJECT                                                 @D61NDMK 04148000
************************************************************** @DY43697 04149000
SVC110PR TM    LOCKPARM,LCKTRON   ACTIVATE TRACE?              @DY43697 04150000
         BNO   SVC110P1           NO                           @DY43697 04151000
         OI    LCKTRCPR,LCKTRON   INDICATE TRACE MODE          @DY43697 04152000
SVC110P1 BAL   RF,LCKACT          ACTIVATE SYSTEM TASK         @DY43697 04153000
         B     SVC110PE           IF ERROR THEN EXIT           @DY43697 04154000
         L     R15,ALCKWRIT        CALL PRINT ...              @DY43697 04155000
         USING LCKWRITE,R15                                    @DY43697 04156000
         BAL   R4,LCKPRINT         ... ROUTINE                 @DY43697 04157000
         DROP  R15                                             @DY43697 04158000
         BAL   RF,LCKDEACT        DEACTIVATE SYSTEM TASK       @DY43697 04159000
SVC110PE BR    R6                 EXIT                         @DY43697 04160000
         EJECT                                                 @D356DJO 04161000
*--------------------------------------------------------------         04162000
*                                                                       04163000
*        WORK FIELDS AND CONSTANTS                                      04164000
*                                                                       04165000
*--------------------------------------------------------------         04166000
         SPACE 1                                                        04167000
LCKUTID  DC    H'0'                TID OF USER TASK            @D36SDJO 04168000
***************************************************************@D149DIS 04169000
*  IF OWNER=PARTITION IS SPECIFIED, LCKUTID CONTAINS           @D36SDJO 04170000
*  THE TASK ID OF THE MAIN TASK OF THE PARTITION.              @D36SDJO 04171000
*  WHEN SYSTEM TASK IS RUNNING, LCKUTID CONTAINS STILL THE     @D36SDJO 04172000
*  TASK ID OF THE USER TASK.                                   @D36SDJO 04173000
***************************************************************@D149DIS 04174000
         SPACE 2                                                        04175000
LOCKPLID  DC    C'ILCKSP'      SUBPOOL-ID FOR LOCK             @D51IDMK 04176000
          DC    X'0000'        BELONGS TO PREVIOUS DEFINITION  @D14CDIS 04177000
ALOKTABA  DC    A(LOKTABA)    POOL OF LOCKTAB  SPACE           @D356DJO 04178000
ALOCKELM  DC    A(LOCKELEM)   DUMMY RES. FOR OWNER ELEMENT     @D356DJO 04179000
ALOCKSPC  DC    A(LOCKSPCE)   DUMMY RESOURCE FOR LOCKTAB SPACE @D356DJO 04180000
LASTLOCK  DC    A(0)          SAVE AREA FOR LAST LOCKTAB ENTRY @D149DIS 04181000
LOKOFRL   DC    A(LOKOWN)     OWNER ELEMENT FREELIST POINTER   @D356DJO 04182000
SV110SAV  DC    4F'0'         SAVE AREA FOR R15 TO R2          @D37CDOW 04183000
SV63VISL  EQU   LOCKLEN       NUMBER OF BYTES FOR GETVIS       @D14BDIS 04184000
SV110SCF  DC    4F'0'   TO CONTAIN REGS C AND D (NOT LCK TASK) @DY43697 04185000
SV110S1   DC    F'0'    TO CONTAIN REGISTER 1   (NOT LCK TASK) @D52QDMK 04186000
SV110S8   DC    F'0'    TO CONTAIN REGISTER 8   (NOT LCK TASK) @D52QDMK 04187000
          AIF   (NOT &BGDSHR).NODUM3                           @D36SDJO 04188000
ADLFCCB   DC    A(DLFCCBR)   BASE OF I/O CONTROL BLOCKS        @D36SDJO 04189000
LCKSAVEF  DC    2F'0'   TO CONTAIN REGS E AND F                @D51UDMK 04190000
LCKSAV1   DC    F'0'    TO CONTAIN REGISTER 1                  @D36SDJO 04191000
LCKSAV5   DC    F'0'    TO CONTAIN REGISTER 5                  @D36SDJO 04192000
LCKSAV6   DC    F'0'    TO CONTAIN REGISTER 6                  @D51UDMK 04193000
LCKSAV8   DC    F'0'    TO CONTAIN REGISTER 8                  @D36SDJO 04194000
LCKREAD1  DC    F'0'    TO CONTAIN ADDRESS OF RESERVE CCW      @DY43802 04195000
LCKREAD2  DC    F'0'    TO CONTAIN ADDRESS OF SEEK/DEFEXT CCW  @DY43802 04196000
SAVEHASH  DC    F'0'    BLOCK NUMBER IN EXTERNAL FILE          @D36SDJO 04197000
.NODUM3   ANOP                                                 @D36SDJO 04198000
E1REQ     EQU   X'01'          REQUESTOR IS LOCKOPT1+EXC       @DA27378 04199000
E1REQMSK  DC    A(E1REQ)       TIBSTATE FLAG FOR E1 REQUESTOR  @DA27378 04200000
E1TBSMSK  DC    A(-1-E1REQ)    TIBSTATE MASK TO CLEAR E1REQ FLG@DA27378 04201000
         EJECT                                                 @D149DIS 04202000
          SPACE 2                                                       04203000
***************************************************************@D149DIS 04204000
*   F L A G S                                                  @D356DJO 04205000
***************************************************************@D149DIS 04206000
*   THE FIELD LOCKPARM CONTAINS THE USER PARAMETER             @D356DJO 04207000
*   WHICH HAVE BEEN PASSED BY THE SVC110 VIA REGISTER 0.       @D356DJO 04208000
*   WHEN OLD USE/RELEASE REQUESTS ARE ENCOUTERED,              @D356DJO 04209000
*   THE FIELD LOCKPARM IS BUILT DUE TO REGISTER 1 PARAMETERS.  @D356DJO 04210000
***************************************************************@D149DIS 04211000
          SPACE 2                                                       04212000
SDAIDP   DC    XL1'0'                                          @D68JMJS 04213000
SDAIDPEX EQU   X'01'    B'1' IF REQUEST IS EXTERNAL            @D68JMJS 04214000
LOCKPARM DC    XL1'0'   LOCK/UNLOCK PARAMETERS (R0)            @D356DJO 04215000
NEWLOCK  EQU   X'01'    B'1' IF LOCK/UNLOCK (SVC110)           @D356DJO 04216000
LOCKSVC  EQU   X'02'    B'1' IF LOCK (SVC110) OR USE(SVC63)    @D356DJO 04217000
WAITUFLG EQU   X'04'    B'1' IF FAIL=WAIT (UNCONDITIONAL)      @D356DJO 04218000
WAITCFLG EQU   X'08'    B'1' IF FAIL=WAITC (CONDITIONAL)       @D356DJO 04219000
UNLEOJ   EQU   X'10'    B'1' IF REQUEST FROM EOJ ROUTINE                04220000
UNLALL   EQU   X'20'    B'1' IF UNLOCK ALL IS SPECIFIED                 04221000
UNLSYS   EQU   X'40'    B'1' IF UNLOCK JC=SYSID IS SPECIFIED   @D36SDJO 04222000
CHECKFLG EQU   X'40'    IF EXTERNAL DEADLOCK CHECK IS ACTIVE   @D51IDMK 04223000
WAITEFLG EQU   X'80'    B'1' IF FAIL=REQUEST AND QUEUE TIL FREE@D51UDMK 04224000
*                                                              @D356DJO 04225000
LOKOWORK DC    XL1'0'   WORKAREA TO COMPARE CTL INFO           @D356DJO 04226000
*                                                              @D356DJO 04227000
REQWORK  DC    XL1'0'   WORK FLAG FOR DEADLOCK TEST            @DA27378 04228000
*                                                              @D356DJO 04229000
UNLCKFLG DC    XL1'0'   FLAG FOR UNLOCK SVC        (UNLOCK)    @D356DJO 04230000
WAKEUP   EQU   1        ACTIVATE WAITING TASKS                 @D356DJO 04231000
FREEOE   EQU   2        GIVE UP AN OWNER ELEMENT               @D356DJO 04232000
FREELE   EQU   4        GIVE UP AN LOCKTAB ENTRY               @D36SDJO 04233000
WAKEUPE1 EQU   8        ACTIVATE E1 REQUESTORS                 @D36SDJO 04234000
BLKMODF  EQU   X'10'    EXTERNAL BLOCK MODIFIED (WRITE BACK)   @D36SDJO 04235000
*                                                              @D356DJO 04236000
DSHRFLG  DC    XL1'00'  FLAG BYTE FOR LCK SYSTEM TASK          @D36SDJO 04237000
LCKSYS   EQU   X'80'    SYSTEM TASK IS ACTIVE                  @D36SDJO 04238000
LCKTIM   EQU   X'40'    TIMER REQUEST IS ALREADY SET           @D36SDJO 04239000
LCKREQ   EQU   X'20'    UPDATE ON EXT FILE REQUIRED            @D36SDJO 04240000
LCKRESVD EQU   X'10'    DISK DRIVE RESERVED (LOCK FILE)        @D36SDJO 04241000
*                                                              @D356DJO 04242000
LCKCNT   DC    H'0'     COUNT LOCKED TASKS                     @D36SDJO 04243000
TRCOTID  DC    H'0'     FIRST OWNERS TID FOR TRACE             @D52QDMK 04244000
TRCRESN  DC    CL12' '  RESOURCE NAME FOR TRACING              @D52QDMK 04245000
TRCFLG1  DC    X'0'     USER'S DTL OPTION BYTE FOR TRACING     @D52QDMK 04246000
TRCFLG2  DC    X'0'     USER'S DTL OPTION BYTE 2 FOR TRACING   @D52QDMK 04247000
PARMEND  EQU   *                                               @D36SDJO 04248000
SERVFLG  DC    XL1'00'  INDICATES WAITING REQUEST ELEMENTS     @D52QDMK 04249000
NOUSER   EQU   1        DO NOT UNPOST OR SETUP USER TASK       @D52QDMK 04250000
*                       DO NOT UPDATE USER'S SAVE AREA         @D52QDMK 04251000
NOACDEAC EQU   2        DO NOT ACTIVATE OR DEACTIVATE LCK TASK @D52QDMK 04252000
NOINT    EQU   4        DO NOT ALLOCATE INTERNAL RESOURCES     @D52QDMK 04253000
NOPOST   EQU   8        DO NOT POST SVC110 GATE                @D52QDMK 04254000
LCKOWN   EQU   X'40'    THIS SYSTEM OWNS RES IN THIS DISK BLOCK@DY43802 04255000
SETTIM   EQU   X'80'    A TIMER FOR LOCKFILE RETRY HAS TO BE SETD52QDMK 04256000
*                                                              @D356DJO 04257000
DISKRR15 DC    A(0)     SAVE REGISTER 15 FOR DISK RESET        @D52QDMK 04258000
*                                                              @D52QDMK 04259000
LOCKPSAV DC    XL4'0'   LOCK/UNLOCK PARAMETERS SAVE CONTAINS   @D51UDMK 04260000
*                       LOCKPARM, LOKOWORK, REQWORK, UNLCKFLG  @D51UDMK 04261000
RQBASPTR DC    A(0)     PROCESS THIS QUEUE WITH LOCKTAB ENTRIES@D51UDMK 04262000
*                       AND REQUEST ELEMENTS AFTER UNLOCK      @D51UDMK 04263000
RQENDPTR DC    A(0)     END OF LOCKTAB QUEUE                   @D51UDMK 04264000
RQENDSAV DC    A(0)     SAVE PREVIOUS END PTR                  @D51UDMK 04265000
RQCOUNT  DC    F'0'     COUNTS REQUEST ELEMENTS PER RESOURCE   @D51UDMK 04266000
NLOCKPTR DC    F'0'     SAVE FOR LOCKTAB FWD PTR (UNLOCK ALL)  @D52QDMK 04267000
IOGET    DC    A(0)     READ I/O'S TO LOCKFILE                 @D61NDMK 04268000
IOPUT    DC    A(0)     WRITE I/O'S TO LOCKFILE                @D61NDMK 04269000
***************************************************************@D52QDMK 04270000
*   BUFFER FOR EXTERNAL DEADLOCK DETECTION                     @D52QDMK 04271000
*   THE BUFFER IS STORED IN THE TCB'S WORK AREA OF EACH TASK   @D52QDMK 04272000
***************************************************************@D52QDMK 04273000
BUFCNMAX DC    H'600'   LIMIT FOR RETRIES IS 10 MINUTES        @D52QDMK 04274000
BUFROSLT DC    X'0'     SLOT OF RESOURCE OWNER                 @D52QDMK 04275000
BUFCOUNT EQU   0        RETRY COUNTER                          @D52QDMK 04276000
BUFRESN  EQU   2        RESOURCE NAME                          @D52QDMK 04277000
BUFCPUID EQU   14       CPUID FIELD OF OWNER                   @D52QDMK 04278000
BUFSLOT  EQU   20       SLOT OF OWNER                          @D52QDMK 04279000
LFCPUID  EQU   X'14'    OFFSET OF CPUID FIELDS IN HEADER       @D52QDMK 04280000
*                                                                       04281000
LCKTRCPR DC    X'00'    LCK TRACE MODE RECOGNITION             @DY43697 04282000
*LCKTRON EQU   3        LCK TRACE MODE ACTIVATED               @DY43697 04283000
*ELSE                   DEACTIVATED                            @DY43697 04284000
         EJECT                                                 @D149DIS 04285000
         SPACE 4                                               @D149DIS 04286000
***************************************************************@D149DIS 04287000
*   DUMMY DTL TO BE USED WITH USE/RELEASE REQUESTS.            @D356DJO 04288000
***************************************************************@D149DIS 04289000
         DS    0H                                              @DY42602 04290000
DUMMYDTL DS    0CL16' '                                        @DY42602 04291000
DTLLENGO DC    H'22'    LENGTH FIELD OLD DTL                   @D51UDMK 04292000
         DC    CL14' '  REST OF DTL                            @D36SDJO 04293000
DTLLENGN DC    H'30'    LENGTH FIELD NEW DTL                   @D51UDMK 04294000
DTLLENTO EQU   22       OLD DTL LENGTH                         @D51UDMK 04295000
DTLLENTN EQU   30       NEW DTL LENGTH                         @D51UDMK 04296000
         AIF   (NOT &BGDSHR).DLFTABE                           @D36SDJO 04297000
         EJECT                                                 @D149DIS 04298000
         SPACE 2                                               @D149DIS 04299000
***************************************************************@D149DIS 04300000
*                                                              @D356DJO 04301000
*   SVR/IPL INTERFACE TABLE                                    @D356DJO 04302000
*                                                                       04303000
***************************************************************@D149DIS 04304000
DLFTABLE DC    0F'0'                                                    04305000
         MAPDLF  DSECT=NO                                      @D36SDJO 04306000
.DLFTABE ANOP                                                  @D36SDJO 04307000
         SPACE 4                                               @D149DIS 04308000
***************************************************************@D149DIS 04309000
*   DEAD LOCK TEST TABLE                                       @D356DJO 04310000
***************************************************************@D149DIS 04311000
         EJECT                                                 @D149DIS 04312000
         SPACE 3                                               @D356DJO 04313000
*--------------------------------------------------------------         04314000
*                                                                       04315000
*        L O C K T A B L E                                              04316000
*        TABLE OF LOCKED RESOURCES                                      04317000
*                                                                       04318000
*--------------------------------------------------------------         04319000
*                                                                       04320000
*   LOCKTAB DISPLACEMENTS FOR DUMMY RESOURCES                  @D36SDJO 04321000
***************************************************************@D149DIS 04322000
DISSPCE  EQU   8       WAITING FOR LOCKTAB SPACE               @D36SDJO 04323000
DISELEM  EQU   10      WAITING FOR OWNER ELEMENT               @D36SDJO 04324000
         AIF   (NOT &BGDSHR).NODUM                             @D36SDJO 04325000
DISEX1   EQU   12      WAITING FOR EXTERNALLY LOCKED           @D36SDJO 04326000
*                      RESOURCE OR EXTERNAL SPACE              @D36SDJO 04327000
.NODUM   ANOP                                                  @D36SDJO 04328000
*                                                              @D36SDJO 04329000
         DS    0F     FOURCE FULLWORD BOUNDARY FOR LOCKTAB-DEF @D37CDOW 04330000
LOCKTAB  EQU   *-(LOCKFLG1-LOCKADR)-DISSPCE                    @D36SDJO 04331000
LOCKSPCE EQU   LOCKTAB+DISSPCE                                 @D36SDJO 04332000
         DC    H'0'   DUMMY ENTRY FOR  LOCKTAB SPACE           @D36SDJO 04333000
LOCKELEM EQU   LOCKTAB+DISELEM                                 @D36SDJO 04334000
         DC    H'0'   DUMMY ENTRY FOR  OWNER ELEMENTS          @D36SDJO 04335000
         EJECT                                                 @D149DIS 04336000
         SPACE 2                                               @D356DJO 04337000
***************************************************************@D149DIS 04338000
*  PERMANENT LOCKTAB POOL                                      @D149DIS 04339000
***************************************************************@D149DIS 04340000
LOKTABA  EQU   *                  LOCKTAB POOL                 @D37CDOW 04341000
LOCKENT1 DC    XL(LOCKLEN-8)'00'  LOCKTAB ENTRY 1              @D14BDIS 04342000
         DC    A(LOCKENT2)        ADDR OF NEXT LOCKTAB ENTRY   @D14BDIS 04343000
         DC    A(0)               END OF BACKWARD CHAIN        @D14BDIS 04344000
LOCKENT2 DC    XL(LOCKLEN-8)'00'  LOCKTAB ENTRY 2              @D14BDIS 04345000
         DC    A(LOCKENT3)        ADDR OF NEXT LOCKTAB ENTRY   @D14BDIS 04346000
         DC    A(LOCKENT1)        ADDR OF LAST LOCKTAB ENTRY   @D14BDIS 04347000
LOCKENT3 DC    XL(LOCKLEN-8)'00'  LOCKTAB ENTRY 3              @D14BDIS 04348000
         DC    A(LOCKENT4)        ADDR OF NEXT LOCKTAB ENTRY   @D14BDIS 04349000
         DC    A(LOCKENT2)        ADDR OF LAST LOCKTAB ENTRY   @D14BDIS 04350000
LOCKENT4 DC    XL(LOCKLEN-8)'00'  LAST  LOCKTAB ENTRY          @D14BDIS 04351000
         DC    A(0)               END OF LOCKTAB               @D37CDOW 04352000
         DC    A(LOCKENT3)        ADDR OF LAST LOCKTAB ENTRY   @D14BDIS 04353000
LOKTABE  DS    0X                 END OF LOCKTAB               @D37CDOW 04354000
         SPACE 2                                               @D149DIS 04355000
***************************************************************@D149DIS 04356000
*  PERMANENT OWNER ELEMENT POOL                                @D149DIS 04357000
***************************************************************@D149DIS 04358000
LOKOWN   DS    0F                 OWNER ELEMENT POOL           @D356DJO 04359000
         DC    A(*+LOKOLEN),3F'0'  OWNER ELEMENT               @D14BDIS 04360000
         DC    A(*+LOKOLEN),3F'0'  OWNER ELEMENT               @D14BDIS 04361000
         DC    A(*+LOKOLEN),3F'0'  OWNER ELEMENT               @D14BDIS 04362000
         DC    A(*+LOKOLEN),3F'0'  OWNER ELEMENT               @D14BDIS 04363000
         DC    A(*+LOKOLEN),3F'0'  OWNER ELEMENT               @D14BDIS 04364000
         DC    A(*+LOKOLEN),3F'0'  OWNER ELEMENT               @D14BDIS 04365000
         DC    F'0'               END OF CHAIN INDICATOR       @D356DJO 04366000
         DC    3F'0'              LAST OWNER ELEMENT           @D14BDIS 04367000
LOKPERM  DC    A(*)               END OF PERMANENT ENTRIES     @D14BDIS 04368000
*                                                              @D356DJO 04369000
ALCKWRIT DC    A(LCKWRITE)        DUMP ROUTINE                 @D61NDMK 04370000
ASV6364T DC    A(SV6364T)         PROT ROUTINE                 @DY43697 04371000
ASVC110C DC    A(SVC110IN)        COUNTERS                     @DY43697 04372000
ADLTT    DC    A(DLTT)            DEADLOCK TEST TABLE          @DY43802 04373000
         DS    0D                                              @D52QDMK 04374000
SVC11TLC DC    CL4'LCKT'      HEADER FOR TRACE ENTRIES         @D61NDMK 04375000
SVC11TRS DC    A(SVC110TB)    TRACE BUFFER START ADDRESS       @D52QDMK 04376000
SVC11TRE DC    A(SVC110TT-1)  TRACE BUFFER END ADDRESS         @D52QDMK 04377000
SVC11TRC DC    A(SVC110TB)    TRACE BUFFER CURRENT ADDRESS     @D52QDMK 04378000
SVC110TB DC    640F'0'        TRACE BUFFER                     @D52QDMK 04379000
SVC110TT DC    A(*)           END OF TRACE BUFFER              @D52QDMK 04380000
DLTT     DC    &NTASK.XL2'0'                                   @DY43802 04381000
LOCKCNTS DC    CL8'COUNTERS'                                   @DY43697 04382000
SVC110IN DC    A(0)     INTERNAL LOCKING COUNTER               @DY43697 04383000
SVC110EX DC    A(0)     EXTERNAL LOCKING COUNTER               @DY43697 04384000
LOCKRC00 DC    A(0)     LOCK COUNTER FOR RC = 0                @DY43697 04385000
ELCKRC00 DC    A(0)     LOCK COUNTER FOR RC = 0                @DY43697 04386000
LOCKRC04 DC    A(0)     LOCK COUNTER FOR RC = 4                @DY43697 04387000
ELCKRC04 DC    A(0)     LOCK COUNTER FOR RC = 4                @DY43697 04388000
LOCKRC08 DC    A(0)     LOCK COUNTER FOR RC = 8                @DY43697 04389000
ELCKRC08 DC    A(0)     LOCK COUNTER FOR RC = 8                @DY43697 04390000
LOCKRC0C DC    A(0)     LOCK COUNTER FOR RC = 12               @DY43697 04391000
ELCKRC0C DC    A(0)     LOCK COUNTER FOR RC = 12               @DY43697 04392000
LOCKRC10 DC    A(0)     LOCK COUNTER FOR RC = 16               @DY43697 04393000
ELCKRC10 DC    A(0)     LOCK COUNTER FOR RC = 16               @DY43697 04394000
LOCKRC14 DC    A(0)     LOCK COUNTER FOR RC = 20               @DY43697 04395000
ELCKRC14 DC    A(0)     LOCK COUNTER FOR RC = 20               @DY43697 04396000
LOCKRC18 DC    A(0)     LOCK COUNTER FOR RC = 24               @DY43697 04397000
ELCKRC18 DC    A(0)     LOCK COUNTER FOR RC = 24               @DY43697 04398000
LOCKRC1C DC    A(0)     LOCK COUNTER FOR RC = 28               @DY43697 04399000
ELCKRC1C DC    A(0)     LOCK COUNTER FOR RC = 28               @DY43697 04400000
LOCKRC20 DC    A(0)     LOCK COUNTER FOR RC = 32               @DY43697 04401000
ELCKRC20 DC    A(0)     LOCK COUNTER FOR RC = 32               @DY43697 04402000
LOCKRC24 DC    A(0)     LOCK COUNTER FOR RC = 36               @DY43697 04403000
ELCKRC24 DC    A(0)     LOCK COUNTER FOR RC = 36               @DY43697 04404000
ULOCKRC0 DC    A(0)     UNLOCK COUNTER FOR RC = 0              @DY43697 04405000
ULOCKRC4 DC    A(0)     UNLOCK COUNTER FOR RC = 4              @DY43697 04406000
ULOCKRC8 DC    A(0)     UNLOCK COUNTER FOR RC = 8              @DY43697 04407000
ULOCKRCC DC    A(0)     UNLOCK COUNTER FOR RC = 12             @DY43697 04408000
DEADRC00 DC    A(0)     DEADLOCKCHECK WITH RC = 0              @DY43697 04409000
DEADRC04 DC    A(0)     DEADLOCKCHECK WITH RC = 4              @DY43697 04410000
***************************************************************@D61NDMK 04411000
*        WRITE LOCKMANAGER DATA IN CASE OF SEVERE ERROR        @D61NDMK 04412000
*        CALLED BY R15                                         @D61NDMK 04413000
*        RETURNS TO R4                                         @D61NDMK 04414000
***************************************************************@D61NDMK 04415000
         ENTRY LCKWRITE                                        @D61NDMK 04416000
         USING LCKWRITE,R15       SUBROUTINE BASE POINTER      @D61NDMK 04417000
         USING LOCKADR,R2         LOCKTAB ENTRY                @D61NDMK 04418000
LCKWRITE DS    0H             ERROR DATA WRITER                @D61NDMK 04419000
         STM   R2,R5,LCKWRSAV     SAVE REGISTER CONTENTS       @D61NDMK 04420000
         MVC   LCKDATA,TID    COLLECT CURRENT INFO             @D61NDMK 04421000
         MVC   LCKDATA+2,LCKUTID                               @D61NDMK 04422000
         MVC   LCKDATA+4(PARMEND-LOCKPARM),LOCKPARM            @D61NDMK 04423000
* LOCK MANAGER DATA                                            @D61NDMK 04424000
         MVC   LCKGEMS1(L'LCKGEMS1),LCKGEMS2 HEADER            @D61NDMK 04425000
         LA    R5,LCKDATAL    LCK DATA LENGTH                  @D61NDMK 04426000
         LA    R3,LCKDATA     TOTAL                            @D61NDMK 04427000
         BAL   R14,HEXPRINT   WRITE THIS BUFFER                @D61NDMK 04428000
* LOCKTAB ENTRY                                                @D61NDMK 04429000
         MVC   LCKGEMS1(L'LCKGEMS1),LCKGEMS3 HEADER            @D61NDMK 04430000
         LA    R5,LOCKLEN     LOCKTAB ENTRY LENGTH             @D61NDMK 04431000
         LR    R3,R2          LOCKTAB ENTRY                    @D61NDMK 04432000
         BAL   R14,HEXPRINT   WRITE THIS BUFFER                @D61NDMK 04433000
LCKWRI1  L     R5,LOCKCHN     OWNER ELEMENT POINTER            @D61NDMK 04434000
LCKWRI2  LTR   R5,R5          OWNER ELEMENT AVAILABLE          @D61NDMK 04435000
         BZ    LCKWRI3        NO                               @D61NDMK 04436000
* OWNER ELEMENT                                                @D61NDMK 04437000
         MVC   LCKGEMS1(L'LCKGEMS1),LCKGEMS4 HEADER            @D61NDMK 04438000
         LR    R3,R5          THIS OWNER                       @D61NDMK 04439000
         LA    R5,LOKOLEN     OWNER ELEMENT LENGTH             @D61NDMK 04440000
         BAL   R14,HEXPRINT   WRITE THIS BUFFER                @D61NDMK 04441000
         L     R5,LOKOCHN-LOKOADR(,R3) NEXT OWNER              @DY43896 04442000
         B     LCKWRI2        LOOP                             @D61NDMK 04443000
LCKWRI3  L     R5,LOCKRQC     REQUEST ELEMENT POINTER          @D61NDMK 04444000
LCKWRI4  LTR   R5,R5          REQUEST ELEMENT AVAILABLE        @D61NDMK 04445000
         BZ    LCKWRI5        NO                               @D61NDMK 04446000
* REQUEST ELEMENT                                              @D61NDMK 04447000
         MVC   LCKGEMS1(L'LCKGEMS1),LCKGEMS5 HEADER            @D61NDMK 04448000
         LR    R3,R5          THIS REQUESTOR                   @D61NDMK 04449000
         LA    R5,LOKOLEN     OWNER ELEMENT LENGTH             @D61NDMK 04450000
         BAL   R14,HEXPRINT   WRITE THIS BUFFER                @D61NDMK 04451000
         L     R5,LOKOCHN-LOKOADR(,R3) NEXT REQUESTOR          @DY43896 04452000
         B     LCKWRI4        LOOP                             @D61NDMK 04453000
* I/O AREA                                                     @D61NDMK 04454000
LCKWRI5  MVC   LCKGEMS1(L'LCKGEMS1),LCKGEMS6 HEADER            @D61NDMK 04455000
         L     R3,DLFAREA     DLF AREA                         @D61NDMK 04456000
         LA    R5,512         LENGTH                           @D61NDMK 04457000
         BAL   R14,HEXPRINT   WRITE THIS BUFFER                @D61NDMK 04458000
* TRACE AREA                                                   @D61NDMK 04459000
         MVC   LCKGEMS1(L'LCKGEMS1),LCKGEMS7 HEADER            @D61NDMK 04460000
         LA    R5,SVC110TB-SVC11TLC HEADER LENGTH              @D61NDMK 04461000
         LA    R3,SVC11TLC    TRACE AREA                       @D61NDMK 04462000
         BAL   R14,HEXPRINT   WRITE THIS BUFFER                @D61NDMK 04463000
         LA    R5,SVC110TT-SVC110TB AREA LENGTH                @D61NDMK 04464000
         LA    R3,SVC110TB    TRACE AREA                       @D61NDMK 04465000
         BAL   R14,HEXPRINT   WRITE THIS BUFFER                @D61NDMK 04466000
         LM    R2,R5,LCKWRSAV  RESTORE REGISTER CONTENTS       @D61NDMK 04467000
         BR    R4             RETURN TO CALLER                 @D61NDMK 04468000
LCKWRSAV DC    4F'0'          SAVE THOSE REGS                  @D61NDMK 04469000
         USING LOKOADR,R12        OWNER ELEMENT                @D61NDMK 04470000
LCKPRINT DS    0H             LOCKTABLE WRITER                 @DY43697 04471000
         STM   R2,R5,LCKWRSAV SAVE                             @DY43697 04472000
         TM    LOCKPARM,LCKTRON IS IT TRACE ACTIVATION?        @DY43697 04473000
         BO    LCKPRT40       YES, DON'T PRINT NOW             @DY43697 04474000
         TM    LOCKPARM,LCKTROFF IS IT TRACE DEACTIVATION?     @DY43697 04475000
         BO    LCKPRT41       YES, DON'T PRINT NOW             @DY43697 04476000
         L     R2,ALOKTABA    GET ANCHOR                       @DY43697 04477000
LCKPRT1  LTR   R2,R2          ENTRY AVAILABLE?                 @DY43697 04478000
         BZ    LCKPRTEX       NO , END OF PRINTOUT             @DY43697 04479000
         TM    LOCKFLG2,LOCKUSED  VALID ENTRY                  @DY43697 04480000
         BNO   LCKPRT22           NO, TRY NEXT                 @DY43697 04481000
         TM    LOCKPARM,LCKPIK PRINT FOR SPEC TASKS?           @DY43697 04482000
         BZ    LCKPRT5        NO                               @DY43697 04483000
         L     R12,LOCKCHN    OWNER ELEMENT POINTER            @DY43697 04484000
LCKPRT2  LTR   R12,12         OWNER ELEMENT AVAILABLE?         @DY43697 04485000
         BZ    LCKPRT22       NO, LOOP TO NEXT ENTRY           @DY43697 04486000
         LH    R4,LOKOTID     GET OWNER'S TID                  @DY43697 04487000
         SLL   R4,2           MULTIPLY WITH 4                  @D66ODOW 04488000
         AL    R4,ATIBATAB    ADDR WITHIN TIBATAB              @D66ODOW 04489000
         L     R4,0(,R4)      TIBPTR OF OWNING TASK            @D66ODOW 04490000
         USING TIBADR,R4                                       @DY43697 04491000
         CLC   TIBPIK,0(R1)   IS IT THIS PARTITION?            @DY43697 04492000
         DROP  R4                                              @DY43697 04493000
         BE    LCKPRT5        YES                              @DY43697 04494000
LCKPRT4  L     R12,LOKOCHN    NEXT OWNER                       @DY43697 04495000
         B     LCKPRT2        LOOP                             @DY43697 04496000
LCKPRT5  TM    LOCKPARM,LCKTRS COMPARE WITH THIS RESOURCE?     @DY43697 04497000
         BZ    LCKPRT9        NO                               @DY43697 04498000
         LH    R3,2(,R1)      GET NUMBER OF BYTES              @DY43697 04499000
         LTR   R3,R3          NO NUMBERS?                      @DY43697 04500000
         BZ    LCKPRT9        DON'T CHECK                      @DY43697 04501000
         BCTR  R3,0           PREP FOR EX                      @DY43697 04502000
         EX    R3,LCKCOMP     SHOULD THIS ONE BE PRINTED?      @DY43697 04503000
         BE    LCKPRT9        YES                              @DY43697 04504000
         B     LCKPRT22       NO, LOOP TO NEXT ENTRY           @DY43697 04505000
LCKCOMP  CLC   LOCKRESN(0),4(R1)                               @DY43697 04506000
* LOCKTAB ENTRY                                                @DY43697 04507000
LCKPRT9  MVC   LCKGEMS1(L'LCKGEMS1),LCKGEMS3 HEADER            @DY43697 04508000
         LA    R5,LOCKLEN     LOCKTAB ENTRY LENGTH             @DY43697 04509000
         LR    R3,R2          LOCKTAB ENTRY                    @DY43697 04510000
         BAL   R14,HEXPRINT   WRITE THIS BUFFER                @DY43697 04511000
LCKPRT10 L     R12,LOCKCHN    OWNER ELEMENT POINTER            @DY43697 04512000
LCKPRT11 LTR   R12,12         OWNER ELEMENT AVAILABLE          @DY43697 04513000
         BZ    LCKPRT20       NO                               @DY43697 04514000
* OWNER ELEMENT                                                @DY43697 04515000
         MVC   LCKGEMS1(L'LCKGEMS1),LCKGEMS4 HEADER            @DY43697 04516000
         LR    R3,R12         THIS OWNER                       @DY43697 04517000
         LA    R5,LOKOLEN     OWNER ELEMENT LENGTH             @DY43697 04518000
         BAL   R14,HEXPRINT   WRITE THIS BUFFER                @DY43697 04519000
         L     R12,LOKOCHN    NEXT OWNER                       @DY43697 04520000
         B     LCKPRT11       LOOP                             @DY43697 04521000
LCKPRT20 L     R12,LOCKRQC    REQUEST ELEMENT POINTER          @DY43697 04522000
LCKPRT21 LTR   R12,R12        REQUEST ELEMENT AVAILABLE        @DY43697 04523000
         BZ    LCKPRT22       NO, LOOP TO NEXT LOCKTAB ENTRY   @DY43697 04524000
* REQUEST ELEMENT                                              @DY43697 04525000
         MVC   LCKGEMS1(L'LCKGEMS1),LCKGEMS5 HEADER            @DY43697 04526000
         LR    R3,R12         THIS REQUESTOR                   @DY43697 04527000
         LA    R5,LOKOLEN     OWNER ELEMENT LENGTH             @DY43697 04528000
         BAL   R14,HEXPRINT   WRITE THIS BUFFER                @DY43697 04529000
         L     R12,LOKOCHN    NEXT REQUESTOR                   @DY43697 04530000
         B     LCKPRT21       LOOP                             @DY43697 04531000
LCKPRT22 TM    LOCKPARM,WAITEFLG+UNLSYS+UNLALL+UNLEOJ PRINT?   @DY43697 04532000
         BNO   LCKPRTEX       NO, IT'S TRACE                   @DY43697 04533000
         L     R2,LOCKPTR     NEXT ENTRY                       @DY43697 04534000
         B     LCKPRT1        NEXT ENTRY                       @DY43697 04535000
LCKPRT30 STM   R2,R5,LCKWRSAV SAVE                             @DY43697 04536000
         LH    R3,LCKTRINF    GET PIK                          @DY45715 04537000
         LTR   R3,R3          PARTITION SPECIFIED?             @DY45715 04538000
         BZ    LCKPRT31       NO                               @DY45715 04539000
         L     R3,TIBPTR      GET CURRENT TIB                  @DY43697 04540000
         USING TIBADR,R3                                       @DY43697 04541000
         CLC   TIBPIK,LCKTRINF IS IT THIS PARTITION?           @DY43697 04542000
         DROP  R3                                              @DY43697 04543000
         BNE   LCKPRTEX       NO, RETURN                       @DY43697 04544000
LCKPRT31 LH    R3,LCKTRINF+2  GET NUMBER OF BYTES              @DY45715 04545000
         LTR   R3,R3          NO NUMBERS?                      @DY43697 04546000
         BZ    LCKPRT32       DON'T CHECK                      @DY45715 04547000
         BCTR  R3,0           PREP FOR EX                      @DY43697 04548000
         LA    R14,LCKTRINF   GET ADDRESS OF COMP STRING       @DY45980 04549000
         EX    R3,LCKTRCOM    SHOULD THIS ONE BE PRINTED?      @DY45736 04550000
         BE    LCKPRT32       YES                              @DY45715 04551000
         B     LCKPRTEX       RETURN                           @DY43697 04552000
LCKPRT32 MVC   LCKGEMS1,LCKGEMS8      DTL HEADER               @DY45715 04553000
         L     R3,SV110S1     DTL ADDRESS                      @DY45817 04554000
         LA    R5,DTLLEN      LENGTH OF DTL                    @DY45715 04555000
         BAL   R14,HEXPRINT   PRINT THE DTL                    @DY45715 04556000
         LTR   R2,R2          LOCKTAB ENTRY AVAILABLE?         @DY43697 04557000
         BZ    LCKPRTEX       NO , END OF PRINTOUT             @DY43697 04558000
         B     LCKPRT9        PRINT THE LOCKTAB ENTRY          @DY45715 04559000
LCKPRT40 MVC   LCKTRINF(16),0(R1) SAVE TRACE CRITERIA          @DY43697 04560000
         B     LCKPRTEX       RETURN                           @DY43697 04561000
LCKPRT41 XC    LCKTRINF(16),LCKTRINF CLEAR TRACE CRITERIA      @DY43697 04562000
         NI    LCKTRCPR,XFF-LCKTRON    TRACE OFF               @DY45715 04563000
LCKPRTEX LM    R2,R5,LCKWRSAV SAVE                             @DY43697 04564000
         BR    R4             EXIT                             @DY43697 04565000
LCKTRCOM CLC   TRCRESN(0),4(R14)                               @DY45980 04566000
LCKTRINF DC    4F'0'          TRACE PARMLIST FROM USER         @DY43697 04567000
LCKPIK   EQU   1              LOCKPARM PRINT THIS PARTITION    @DY43697 04568000
LCKTRS   EQU   2              LOCKPARM PRINT THESE RESOURCES   @DY43697 04569000
LCKTRON  EQU   4              LOCKPARM TRACE ON                @DY43697 04570000
LCKTROFF EQU   8              LOCKPARM TRACE OFF               @DY43697 04571000
         DROP  R12                                             @DY43697 04572000
************************************************************** @D61NDMK 04573000
*        HEXADECIMAL PRINT SUBROUTINE                        * @D61NDMK 04574000
************************************************************** @D61NDMK 04575000
*        USING INPUT,R5           NO. OF LINES TO BE PRINTED   @D61NDMK 04576000
*        USING INPUT,R3           TO BE PRINTED AREA POINTER   @D61NDMK 04577000
HEXPRINT DS    0H'0'                                           @D61NDMK 04578000
         STM   RE,R5,HEXPRSAV     SAVE REGISTER CONTENTS       @DY45715 04579000
         NI    HEXPRFLG,XFF-HEXSTPCN RESET CONSOLE STOP BIT    @DAOM    04580000
         SLR   R2,R2          DEFAULT                          @D61NDMK 04581000
         LR    R1,R3          COPY START ADDRESS               @DY45715 04582000
         SLL   R1,28          TAKE LAST                        @DY45715 04583000
         SRL   R1,28            NIBBLE                         @DY45715 04584000
         AR    R5,R1          ACCOUNT FOR THE BOUNDARY         @DY45715 04585000
         LR    R1,R5          LCK DATA LENGTH                  @D61NDMK 04586000
         SRL   R1,4           FIND OUT IF MULTIPLE OF 16       @D61NDMK 04587000
         SLL   R1,4                                            @D61NDMK 04588000
         CR    R5,R1                                           @D61NDMK 04589000
         BE    HEXPRT05       YES                              @D61NDMK 04590000
         LA    R2,1           NO, MUST ADD 1 MORE              @D61NDMK 04591000
HEXPRT05 SRL   R5,4           NUMBER OF LINES                  @D61NDMK 04592000
         AR    R5,R2          ADJUST                           @D61NDMK 04593000
         MVI   LCKHXCCW,X'09'     RESTORE COMMAND CODE         @D61NDMK 04594000
         SRL   R3,4               FORCE 16 BYTE BOUNDARY       @DY45715 04595000
         SLL   R3,4                                            @DY45715 04596000
         MVI   LCKHXCL1+4,X'60'   SET CC FLAG IN CCW           @D61NDMK 04597000
         MVI   LCKHXCL2+4,X'60'   SET CC FLAG IN CCW           @D61NDMK 04598000
         MVI   LCKHXCL3+4,X'60'   SET CC FLAG IN CCW           @D61NDMK 04599000
HEXPR010 LR    R4,R5              COPY LINE=CCW COUNTER        @D61NDMK 04600000
         CH    R4,H3              MORE THAN THREE LINES        @D61NDMK 04601000
         BNH   HEXPR020           NO                           @D61NDMK 04602000
         LA    R4,4               RESTRICT TO FOUR LINES       @D61NDMK 04603000
HEXPR020 SLR   R5,R4              ADJUST SIO COUNTER           @D61NDMK 04604000
         LR    R1,R4              COPY LINE COUNTER            @D61NDMK 04605000
         SLL   R1,3               MULTIPLY WITH CCW LENGTH     @D61NDMK 04606000
         LA    R1,LCKHXCCW(R1)    LAST CCW TO EXECUTE          @D61NDMK 04607000
         MVI   4(R1),X'20'        UNCHAIN LAST CCW             @D61NDMK 04608000
         LA    R1,LCKHXM1                                      @D61NDMK 04609000
         USING LCKHXMS,R1         MESSAGE TEXT BASE POINTER    @D61NDMK 04610000
HEXPR030 ST    R3,LCKLOWRK        SAVE LOCATION COUNTER        @D61NDMK 04611000
         UNPK  LCKHXVA+1(9),LCKLOWRK(5) TRANSLATE TO PRINTABLE @D61NDMK 04612000
         TR    LCKHXVA+1(8),TRTABLE MAKE IT HEX VALUE          @D61NDMK 04613000
         MVI   LCKHXVA+9,C' '     RESET UNUSED BYTE            @D61NDMK 04614000
         MVI   LCKHXVA,C'V'       INDICATE VIRTUAL ADDRESS     @D61NDMK 04615000
HEXPR050 LRA   R2,0(,R3)          GET REAL ADDRESS             @DY45715 04616000
         BC    8,HEXPR060         LRA CC ADDRESS AVAILABLE     @DY45715 04617000
         BC    5,HEXPR055         ADDRESS NOT AVAILABLE        @DY45715 04618000
         STNSM PSWMASK,X'FF'-SMDAT  REAL MODE                  @DY45715 04619000
         TM    PTESTAT-PTE(R2),PTEINVAD INVALID PAGE?          @DY45817 04620000
         STOSM PSWMASK,SMDAT        BACK TO VIRTUAL            @DY45715 04621000
         BO    HEXPR055             YES, SKIP PAGE FAULT       @DY45715 04622000
         CLI   0(R3),0            FORCE PAGE FAULT NOW         @D61NDMK 04623000
         B     HEXPR050           TRY AGAIN                    @DY45715 04624000
HEXPR055 MVI   LCKHX11,C'N'       ADDRESS NOT AVAILABLE        @DY45715 04625000
         MVC   LCKHX11+1(34),LCKHX11  NOT AVAIL                @DY45715 04626000
         MVC   LCKCHR11(16),LCKHXBLA    BLANK THE CHARS        @DY45715 04627000
         MVC   LCKHXRA,LCKHXBLA         BLANK THE R-ADDR       @DY45715 04628000
         B     HEXPR090           CONTINUE WITH THE NEXT LINE  @DY45817 04629000
HEXPR060 ST    R2,LCKLOWRK        SAVE LOCATION COUNTER        @DY45817 04630000
         MVI   LCKHXRA,C'R'       SET REAL ADDRESS INDICATOR   @D61NDMK 04631000
         UNPK  LCKHXRA+1(9),LCKLOWRK(5) TRANSLATE TO PRINTABLE @D61NDMK 04632000
         TR    LCKHXRA+1(8),TRTABLE MAKE IT HEX VALUE          @D61NDMK 04633000
         MVI   LCKHXRA+9,C' '     CLEAR UNUSED BYTE            @D61NDMK 04634000
HEXPR070 UNPK  LCKHX11(9),0(5,R3) TRANSLATE TO PRINTABLE       @D61NDMK 04635000
         TR    LCKHX11(8),TRTABLE MAKE IT HEX VALUE            @D61NDMK 04636000
         MVI   LCKHX11+8,C' '     INSERT A BLANK               @D61NDMK 04637000
         UNPK  LCKHX12(9),4(5,R3) TRANSLATE TO PRINTABLE       @D61NDMK 04638000
         TR    LCKHX12(8),TRTABLE MAKE IT HEX VALUE            @D61NDMK 04639000
         MVI   LCKHX12+8,C' '     INSERT A BLANK               @D61NDMK 04640000
         UNPK  LCKHX13(9),8(5,R3) TRANSLATE TO PRINTABLE       @D61NDMK 04641000
         TR    LCKHX13(8),TRTABLE MAKE IT HEX VALUE            @D61NDMK 04642000
         MVI   LCKHX13+8,C' '     INSERT A BLANK               @D61NDMK 04643000
         MVC   WORKFLD(4),12(R3)  PREVENT ADDRESSING EXCEPTION @D61NDMK 04644000
         UNPK  LCKHX14(9),WORKFLD(5) TRANSLATE TO PRINTABLE    @D61NDMK 04645000
         TR    LCKHX14(8),TRTABLE MAKE IT HEX VALUE            @D61NDMK 04646000
         MVI   LCKHX14+8,C' '     INSERT A BLANK               @D61NDMK 04647000
         MVC   LCKCHR11(16),0(R3) SAVE CHARACTER NOTATION      @D61NDMK 04648000
         LA    RE,LCKCHR11-1      ADJUST FOR LA INSTRUCTION    @D61NDMK 04649000
         LA    R0,16              SET LOOP COUNT               @DY45715 04650000
HEXPR080 LA    RE,1(,RE)          ADVANCE TO NEXT BYTE         @D61NDMK 04651000
         CLI   0(RE),C' '         IS VALUE SMALLER X'40'       @D61NDMK 04652000
         BNL   HEXPR081           NO,                          @DY45715 04653000
         MVI   0(RE),C' '         MAKE IT A BLANK              @D61NDMK 04654000
HEXPR081 BCT   R0,HEXPR080        MORE BYTES TO PROCESS        @DY45715 04655000
         L     R2,HEXPRSAV+(16-RE+R3)*4  GET START ADDR AGAIN  @DY45715 04656000
         SR    R2,R3              SUBTRACT CURRENT ADDR        @DY45715 04657000
         BNP   HEXPR090           NO NEED TO SUPPRESS          @DY45715 04658000
         LA    RE,LCKCHR11        GET CHAR START ADDRESS       @DY45715 04659000
         LR    R0,R2              COPY LENGTH                  @DY45715 04660000
         BCTR  R2,0               MINUS 1 FOR EXECUTE          @DY45715 04661000
         EX    R2,HEXPRMV2        SUPPRESS CHAR NOTATION       @DY45715 04662000
         LA    RE,LCKHX11         GET HEX START ADDRESS        @DY45715 04663000
         SLL   R0,1               MULTIPLY WITH 2              @DY45715 04664000
         LR    R2,R0              COPY LENGTH                  @DY45715 04665000
         SRL   R0,3               DIVIDE BY 8                  @DY45715 04666000
         AR    R2,R0              ADD NUMBER OF BLANKS         @DY45715 04667000
         BCTR  R2,0               MINUS 1 FOR EXECUTE          @DY45715 04668000
         EX    R2,HEXPRMV1        SUPPRESS HEX NOTATION        @DY45715 04669000
HEXPR090 LA    R3,16(,R3)         ADJUST AREA POINTER          @DY45715 04670000
         LA    R1,L'LCKHXM1+L'LCKCHR1(,R1)                     @D61NDMK 04671000
         BCT   R4,HEXPR030        CHECK IF ALL DONE            @D61NDMK 04672000
         LTR   R5,R5              END REACHED?                 @DY45715 04673000
         BNZ   HEXPR100           NO                           @DY45715 04674000
         L     R2,HEXPRSAV+(16-RE+R3)*4  GET START ADDR AGAIN  @DY45715 04675000
         A     R2,HEXPRSAV+(16-RE+R5)*4  ADD LENGTH            @DY45715 04676000
         SR    R3,R2                     NEED TO SUPPRESS?     @DY45715 04677000
         BNP   HEXPR100                  NO                    @DY45715 04678000
         LA    RE,L'LCKHXM1+L'LCKCHR1    LENGTH OF ENTRY       @DY45715 04679000
         SR    R1,RE                     GET PREVIOUS ENTRY    @DY45715 04680000
         LA    RE,LCKCHR11+16            END OF CHAR AREA      @DY45715 04681000
         SR    RE,R3                     START ADDR TO SUPPR.  @DY45715 04682000
         LR    R0,R3              COPY LENGTH                  @DY45715 04683000
         BCTR  R3,0               MINUS 1 FOR EXECUTE          @DY45715 04684000
         EX    R3,HEXPRMV2        SUPPRESS CHAR NOTATION       @DY45715 04685000
         SLL   R0,1               MULTIPLY WITH 2              @DY45715 04686000
         LR    R3,R0              COPY BYTE COUNT              @DY45715 04687000
         SRL   R3,3               DIVIDE BY 8                  @DY45715 04688000
         AR    R3,R0              ADD NUMBER OF BLANKS         @DY45715 04689000
         LA    RE,LCKHX14+8       END OF HEX AREA              @DY45715 04690000
         SR    RE,R3              START ADDR TO SUPPRESS       @DY45715 04691000
         EX    R3,HEXPRMV2        SUPPRESS HEX NOTATION        @DY45715 04692000
         DROP  R1                 RELEASE MESSAGE TEXT BASE    @D61NDMK 04693000
HEXPR100 LA    R1,LCKHXCCB        POINT TO CCB                 @D61NDMK 04694000
         USING CCBADR,R1          CCB BASE POINTER             @D61NDMK 04695000
         EXCP  (1)                WRITE MESSAGE                @D61NDMK 04696000
         WAIT  (1)                WAIT FOR COMPLETION          @D61NDMK 04697000
         TM    CCBCOM1,DISERR     I/O ERROR                    @D61NDMK 04698000
         BO    HEXPREXT           YES,                         @D61NDMK 04699000
         TM    HEXPRFLG,HEXSTPCN  CONSOLE NEEDS TO BE STOPPED  @DAOM    04700000
         BO    HEXPREXT           YES,                         @DAOM    04701000
         LTR   R5,R5              MORE SIO'S TO BE ISSUED      @D61NDMK 04702000
         BZ    HEXPREXT           NO,                          @D61NDMK 04703000
         MVI   LCKHXCCW,X'03'     PREVENT PRINTING OF HEADER   @D61NDMK 04704000
         B     HEXPR010           RETURN                       @D61NDMK 04705000
         DROP  R1                 RELEASE CCB    BASE          @D61NDMK 04706000
HEXPREXT LM    RE,R5,HEXPRSAV     SAVE REGISTER CONTENTS       @DY45715 04707000
         BR    RE                 RETRN======================> @D61NDMK 04708000
HEXPRMV1 MVC   0(0,RE),LCKHXDOT   ERASE WITH DOTS              @DY45715 04709000
HEXPRMV2 MVC   0(0,RE),LCKHXBLA   ERASE WITH BLANKS            @DY45715 04710000
HEXPRFLG DC    X'00'                                           @DAOM    04711000
HEXSTPCN EQU   X'80'              STOP CONSOLE OUTPUT          @DAOM    04712000
HEXPRFL1 DC    X'00'              RESERVED                     @DAOM    04713000
HEXPRSAV DC    8F'0'              SAVE AREA REG14 TO REG5      @DY45715 04714000
HEXR1SAV DC    1F'0'              SAVE AREA REG1               @D61NDMK 04715000
         SPACE 3                                               @D61NDMK 04716000
LCKHXCCB CCB   SYSLOG,LCKHXCCW,X'0400'                         @D61NDMK 04717000
LCKHXCCW CCW   X'09',LCKGEMS1,X'60',L'LCKGEMS1                 @D61NDMK 04718000
LCKHXCL1 CCW   X'09',LCKHXM1,X'60',L'LCKHXM1+L'LCKCHR1         @D61NDMK 04719000
LCKHXCL2 CCW   X'09',LCKHXM2,X'60',L'LCKHXM2+L'LCKCHR2         @D61NDMK 04720000
LCKHXCL3 CCW   X'09',LCKHXM3,X'60',L'LCKHXM3+L'LCKCHR3         @D61NDMK 04721000
LCKHXCL4 CCW   X'09',LCKHXM4,X'20',L'LCKHXM4+L'LCKCHR4         @D61NDMK 04722000
         SPACE 3                                               @D61NDMK 04723000
LCKGEMS2 DC    CL27'LOCK MANAGER EMERGENCY DATA'               @D61NDMK 04724000
LCKGEMS3 DC    CL27'LOCKTAB ENTRY'                             @D61NDMK 04725000
LCKGEMS4 DC    CL27'OWNER ELEMENT'                             @DY43697 04726000
LCKGEMS5 DC    CL27'REQUEST ELEMENT'                           @DY43697 04727000
LCKGEMS6 DC    CL27'LOCK FILE DISK BLOCK'                      @D61NDMK 04728000
LCKGEMS7 DC    CL27'LOCK MANAGER TRACE AREA'                   @D61NDMK 04729000
LCKGEMS8 DC    CL27'DTL'                                       @DY45715 04730000
LCKGEMS1 DC    CL27'TO BE FILLED BY CALLER'                    @D61NDMK 04731000
LCKGEMST EQU   LCKGEMS1+2                                      @D61NDMK 04732000
LCKHXDOT DC    CL36'........ ........ ........ ........ '      @DY45715 04733000
LCKHXBLA DC    CL36' '                                         @DY45715 04734000
LCKHXM1  DC    C' ADDRESS   ........ ........ ........ ........' 61NDMK 04735000
LCKCHR1  DC    C' *................*           '               @D61NDMK 04736000
LCKHXM1R EQU   LCKCHR1+23                                      @D61NDMK 04737000
LCKHXM2  DC    C'           ........ ........ ........ ........' 61NDMK 04738000
LCKCHR2  DC    C' *................*           '               @D61NDMK 04739000
LCKHXM3  DC    C'           ........ ........ ........ ........' 61NDMK 04740000
LCKCHR3  DC    C' *................*           '               @D61NDMK 04741000
LCKHXM4  DC    C'           ........ ........ ........ ........' 61NDMK 04742000
LCKCHR4  DC    C' *................*           '               @D61NDMK 04743000
LCKHXEND EQU   *                                               @D61NDMK 04744000
LCKDATA  DC    F'0'                LOCK MANAGER INTERNAL DATA  @D61NDMK 04745000
         DC    XL(PARMEND-LOCKPARM)'00'        INTERNAL DATA   @D61NDMK 04746000
LCKDATAL EQU   *-LCKDATA           LENGTH OF THIS BLOCK        @D61NDMK 04747000
LCKLOWRK DC    F'0'               MATCH ADDRESS (LEFT ADJUST)  @D61NDMK 04748000
WORKFLD  DC    16C' '             WORK AREA                    @D61NDMK 04749000
TRCHARAC DC    XL1'00',C'0123456789ABCDEF' PRINTABLE CHARACTERS@D61NDMK 04750000
TRTABLE  EQU   TRCHARAC+1-240     BEGIN OF TRANSLATE TABLE     @D61NDMK 04751000
         DROP  R15                RELEASE SUBROUTINE BASE      @D61NDMK 04752000
         USING SV6364T,R14        SUBROUTINE BASE              @DY43697 04753000
         DC    CL4'TTAB'                                       @DY43697 04754000
SV6364T  SLR   R0,R0             UNPROTECT                     @DY43697 04755000
SV6364TP SLR   R9,R9                                           @DY43697 04756000
         BR    R12                                             @DY43697 04757000
*        SLR   R3,R3                                           @DY43697 04758000
*        STM   R4,R7,TSAVR47                                   @DY43697 04759000
*        MVC   TLASTPRM,LOCKPARM                               @DY43697 04760000
*        XC    TADDRESS(TADDREND-TADDRESS),TADDRESS            @DY43697 04761000
*        L     R2,ALOKTABA                                     @DY43697 04762000
*V6364T1 L     R7,LOCKPTR                                      @DY43697 04763000
*V6364TU CLM   R7,M7,LOKPERM+1    PERMANENT ELEMENT ?          @DY43697 04764000
*        BNH   SV6364TX           YES,DON'T PROTECT/UNPROTECT  @DY43697 04765000
*        SRL   R7,12              PAGE BOUNDARY                @DY43697 04766000
*        SLL   R7,12              PAGE BOUNDARY                @DY43697 04767000
*        LA    R4,TADDRESS        GET FIRST PAGE ADDRESS       @DY43697 04768000
*V6364TA CLC   0(4,R4),TZERO      FREE ENTRY?                  @DY43697 04769000
*        BE    SV6364TD           YES                          @DY43697 04770000
*        C     R7,0(,R4)          SAME ADDRESS?                @DY43697 04771000
*        BE    SV6364TX           YES, DON'T STORE             @DY43697 04772000
*        LA    R4,4(,R4)          NEXT ADDRESS                 @DY43697 04773000
*        B     SV6364TA           LOOP                         @DY43697 04774000
*V6364TD ST    R7,0(,R4)          STORE THIS PAGE ADDRESS      @DY43697 04775000
*V6364TX L     R7,LOCKPTR         GET ORIGINAL BACK            @DY43697 04776000
*        L     R5,LOCKBPTR                                     @DY43697 04777000
*        CR    R9,R5              BACKWARD POINTER             @DY43697 04778000
*        BNE   SV6364TT                                        @DY43697 04779000
*V6364T2 TM    LOCKFLG2,LOCKUSED                               @DY43697 04780000
*        BO    SV6364T3                                        @DY43697 04781000
*        CLC   TZERO(L'TZERO),LOCKCHN UNUSED ENTRY             @DY43697 04782000
*        BNE   SV6364TT                                        @DY43697 04783000
*        B     SV6364T8                                        @DY43697 04784000
*V6364T3 CLC   LOCKCHN,LOCKRQC    OWNER/REQUESTOR              @DY43697 04785000
*        BE    SV6364TT                                        @DY43697 04786000
*        L     R5,LOCKCHN                                      @DY43697 04787000
*V6364T5 LTR   R5,R5                                           @DY43697 04788000
*        BZ    SV6364T6                                        @DY43697 04789000
*        L     R5,LOKOCHN-LOKOADR(,R5)  CHECK ADDRESSABILITY   @DY43697 04790000
*        B     SV6364T5                                        @DY43697 04791000
*V6364T6 L     R5,LOCKRQC                                      @DY43697 04792000
*V6364T7 LTR   R5,R5                                           @DY43697 04793000
*        BZ    SV6364T8                                        @DY43697 04794000
*        L     R5,LOKOCHN-LOKOADR(,R5)  CHECK ADDRESSABILITY   @DY43697 04795000
*        B     SV6364T7                                        @DY43697 04796000
*V6364T8 LR    R9,R2                                           @DY43697 04797000
*        LTR   R2,R7                                           @DY43697 04798000
*        BNZ   SV6364T1                                        @DY43697 04799000
*        TM    TLASTPRM,X'F0'                                  @DY43697 04800000
*        BNZ   SV6364T9                                        @DY43697 04801000
*        C     R3,TLASTCNT        -1                           @DY43697 04802000
*        BE    SV6364T9                                        @DY43697 04803000
*        LA    R4,1(,R3)                                       @DY43697 04804000
*        C     R4,TLASTCNT        EQUAL                        @DY43697 04805000
*        BE    SV6364T9                                        @DY43697 04806000
*        LA    R4,1(,R3)                                       @DY43697 04807000
*        C     R4,TLASTCNT        +1                           @DY43697 04808000
*        BNE   SV6364TT                                        @DY43697 04809000
*V6364T9 LA    R3,1(,R3)                                       @DY43697 04810000
*        ST    R3,TLASTCNT                                     @DY43697 04811000
*        LA    R9,TADDRESS                                     @DY43697 04812000
*V6364TY L     R3,0(,R9)                                       @DY43697 04813000
*        LTR   R3,R3                                           @DY43697 04814000
*        BE    SV6364TZ                                        @DY43697 04815000
*-------------------------------------------------------------*@DY43697 04816000
*      PBITFUNC- ROUTINE                                       @DY43697 04817000
*        GET ADDRESS OF PTE BELONGING TO VIRTUELL ADDRESS      @DY43697 04818000
*        AND SETS P-BIT ON OR OFF, DEPENDING ON R0             @DY43697 04819000
*        INPUT:                                                @DY43697 04820000
*           R0 - 0 SET P-BIT OFF                               @DY43697 04821000
*                #0 SET P-BIT ON                               @DY43697 04822000
*           R3 - VIRTUAL ADDRESS                               @DY43697 04823000
*        OUTPUT:                                               @DY43697 04824000
*           P-BIT SET ON OR OFF                                @DY43697 04825000
*        WORK REGISTER:                                        @DY43697 04826000
*           R4, R5, R7, R3                                     @DY43697 04827000
*-------------------------------------------------------------*@DY43697 04828000
*        SPACE 1                                               @DY43697 04829000
*BITFUNC DS    0H                 ENTRY POINT                  @DY43697 04830000
*        L     R7,APMGMDAT        GET BASE OF PMR DATA AREA    @DY43697 04831000
*        USING PMGMDATA,R7                                     @DY43697 04832000
*        N     R3,EPADRMSK        SET ADDRESS ON PAGE BOUNDARY @DY43697 04833000
*        L     R4,SCBPTR          GET ACTUAL SCB               @DY43697 04834000
*  GET SCB BELONGING TO R3, AND EPA                            @DY43697 04835000
*        L     R5,IJBSMCOM        STOR. MANAGMNT COMM. AREA    @DY43697 04836000
*        USING SMCOM,R5                                        @DY43697 04837000
*        C     R3,SMCPRPBG        ADDR IN PRIVATE AREA         @DY43697 04838000
*        BL    PBITF1             NO, GET ADDR OF SHARED SCB   @DY43697 04839000
*        C     R3,SMCPRPND        REALLY IN PRIVATE AREA       @DY43697 04840000
*        BNH   PBITF2             YES, ======> RETURN          @DY43697 04841000
* ADDRESS IS IN 31-BIT SHARED AREA                             @DY43697 04842000
*        S     R3,SMCSVA31        GET EPA FOR                  @DY43697 04843000
*        A     R3,SMCPRPBG        .... SHARED AREA             @DY43697 04844000
*BITF1   DS    0H                 ADDR IN SHARED-24, EPA=ADDR  @DY43697 04845000
*        L     R4,ASCBATAB                                     @DY43697 04846000
*        USING SCBATAB,R4                                      @DY43697 04847000
*        L     R4,ASCBS           GET ADDR OF SHARED SCB       @DY43697 04848000
*        DROP  R4                 DROP BASE FOR SCBATAB        @DY43697 04849000
*        B     PBITF3             SKIP PRIV AREA               @DY43697 04850000
*BITF2   DS    0H                 ADDR IN PRIVATE AREA         @DY43697 04851000
*        S     R3,SMCPRPBG        NO, GET EPA FOR PRIV. AREA   @DY43697 04852000
*BITF3   SRL   R3,PTSHIFT         GET OFFSET IN PT             @DY43697 04853000
*        USING SCBADR,R4                                       @DY43697 04854000
*        L     R5,SCBAPMRA        GET SCB OF PMRAS             @DY43697 04855000
*   SWITCH TO PMR ADDRESS SPACE                                @DY43697 04856000
*        SGSETUP SETSCB,NEXTSCB=R5,OPTION=SAVE,WR1=R1,WR2=R2   @DY43697 04857000
*        SGSETUP SETSCB,NEXTSCB=R5,OPTION=SAVE,WR1=R1,WR2=R2   @DY43697 04858000
*        LR    R5,R3                                           @DY43697 04859000
*        SRL   R5,SNSHIFT-PTSHIFT GET SEG #                    @DY43697 04860000
*        SLL   R5,SNSTESH          X SEG LENGTH                @DY43697 04861000
*        AL    R5,SCBVSTO         ADDRESS OF RELATED STE       @DY43697 04862000
*        USING STE,R5                                          @DY43697 04863000
*        TM    STEFLG,STEINV      SEGMENT ENTRY INVALID        @DY43697 04864000
*        BZ    PBITVR3            NO, CONTINUE                 @DY43697 04865000
*        SR    R3,R3              YES,                         @DY43697 04866000
*        BCTR  R3,0               INDICATE ERROR               @DY43697 04867000
*        B     PBITEXIT           ======> RETURN               @DY43697 04868000
*        DROP  R5                 DROP BASE FOR STE            @DY43697 04869000
*BITVR3  AL    R3,SCBAPT          ADDRESS OF PAGE TABLE ENTRY  @DY43697 04870000
*        USING PTE,R3             * IN PMRAS                   @DY43697 04871000
*        LTR   R0,R0              P-BIT TO BE SET OFF ?        @DY43697 04872000
*        BNZ   PBITON             YES, BRANCH                  @DY43697 04873000
*                                 NO,                          @DY43697 04874000
*        NI    PTESTAT,XFF-X'02'  SET P-BIT OFF                @DY43697 04875000
*        B     PBITEXIT                                        @DY43697 04876000
*BITON   OI    PTESTAT,X'02'      SET P-BIT ON                 @DY43697 04877000
*BITEXIT DS    0H                                              @DY43697 04878000
*    SWITCH BACK TO ORIGINAL ADDRESS SPACE                     @DY43697 04879000
*        SGSETUP RESETSCB,WR1=R1,WR2=R2                        @DY43697 04880000
*        SGSETUP RESETSCB,WR1=R1,WR2=R2                        @DY43697 04881000
*        DROP  R4                 DROP BASE FOR SCB            @DY43697 04882000
*        DROP  R7                 DROP BASE FOR PMGMDATA       @DY43697 04883000
*        DROP  R3                 DROP BASE FOR PTE            @DY43697 04884000
*        LA    R9,4(,R9)                                       @DY43697 04885000
*        B     SV6364TY           LOOP                         @DY43697 04886000
*V6364TZ LM    R4,R7,TSAVR47                                   @DY43697 04887000
*        PTLB                                                  @DY43697 04888000
*        BR    R12                                             @DY43697 04889000
*SV364TT BAL   R5,SYSERROR                                     @DY43697 04890000
*LASTCNT DC    F'0'                                            @DY43697 04891000
*SAVR47  DC    4F'0'                                           @DY43697 04892000
*LASTPRM DC    X'FF'                                           @DY43697 04893000
*ZERO    DC    XL24'0'                                         @DY43697 04894000
*ADDRESS DC    64F'0'                                          @DY43697 04895000
*ADDREND DC    F'0'                                            @DY43697 04896000
         DROP  R14                                             @DY43697 04897000
LCKHXMS  DSECT                                                 @D61NDMK 04898000
LCKHXVA  DC    C'V00000000'        ADDRESS PART                @D61NDMK 04899000
         DC    C'  '               SEPERATOR                   @D61NDMK 04900000
LCKHX11  DC    C'         '        1ST FULLWORD                @D61NDMK 04901000
LCKHX12  DC    C'         '        2ND FULLWORD                @D61NDMK 04902000
LCKHX13  DC    C'         '        3RD FULLWORD                @D61NDMK 04903000
LCKHX14  DC    C'         '        4TH FULLWORD                @D61NDMK 04904000
         DC    C'*'                SEPERATOR                   @D61NDMK 04905000
LCKCHR11 DC    C'................*  '                          @D61NDMK 04906000
LCKHXRA  DC    C'R00000000'        ADDRESS PART                @D61NDMK 04907000
&SYSECT  CSECT                                                 @D36SDJO 04908000
         AIF   (NOT &BGDEBUG OR NOT &SGLOCK).PRINT             @D37ZDOW 04909000
         PRINT NOGEN                                           @D37ZDOW 04910000
.PRINT   ANOP                                                  @D37ZDOW 04911000
         MEND                                                           04912000
