         MACRO                                                          00001001
         SGPMR                                                          00002001
         GBLB  &SGPMR             PRINT REQUIRED                        00003001
         GBLB  &LOLEV1            TEMP. PMR STATISTICS         @D52VDRP 00004001
         ACTR  500                                             @D14BDRP 00005001
.************************************************************* @D35NDRP 00006001
*                                                            * @D35NDRP 00007001
.*       IBM DISK OPERATING SYSTEM                           * @D35NDRP 00008001
*        SUPERVISOR - SGPMR - 5686-066                       * @D31UDRP 00009001
**************************************************************          00010001
*                                                            * @D35NDRP 00011001
*        LICENSED MATERIALS - PROPERTY OF IBM                * @D31UDRP 00012001
*        THIS MACRO IS "RESTRICTED MATERIALS OF IBM"         * @D31UDRP 00013001
*        5686-066 (C) COPYRIGHT IBM CORP. 1977, 2001         *          00014002
*        SEE COPYRIGHT INSTRUCTIONS                          * @D31UDRP 00015001
*                                                            * @D35NDRP 00016001
************************************************************** @D35NDRP 00017001
         AIF   (NOT &SGPMR).NOPRT10                                     00018001
         PRINT GEN                                                      00019001
.NOPRT10 ANOP                                                           00020001
         TITLE 'VSE/AF SUPERVISOR     SGPMR     PAGE MANAGER (ENQUEUE R*00021001
               OUTINE FOR PAGE-IN REQ.)'                       @D14ZDRP 00022001
         SPACE 2                                                        00023001
* /* START OF SPECIFICATIONS ****************************************** 00024001
*                                                                       00025001
*01* MODULE NAME = SGPMR                                                00026001
*                                                                       00027001
*01* MODULE TYPE = SUPERVISOR GENERATION MACRO                          00028001
*                                                                       00029001
*01* DESCRIPTIVE NAME = PAGE MANAGEMENT ROUTINES AND SERVICES           00030001
*                                                                       00031001
*01* CHANGE ACTIVITY = AS FOLLOWS                                       00032001
*    CHANGE DESCRIPTION                                                 00033001
*       NEW MACRO -- FIRST RELEASE 35                                   00034001
*       E - SUPPORT                                            @D35EDRP 00035001
*       FBA - SUPPORT                                          @D35DDRP 00036001
*       /370 - SUPPORT                                         @D35CDAA 00037001
*                                                              @D35CDRP 00038001
*       MULTI EXTENT PDS                                       @D35MDAA 00039001
*       VIO SUPPORT                                            @D14BDRP 00040001
*       16 MB REAL STORAGE FOR /370                            @D14ADVB 00041001
*       VAE SUPPORT (MULTIPLE VIRTUAL ADDRESS SPACES           @D14NDFG 00042001
*       4 K PAGESIZE FOR 370 AND VM MODE                       @DA33314 00043001
*       VIO POST : POST ALSO POWER MASTER ECB                  @DA35279 00044001
*       VIO ENQUEUE : TEST IF PMR ACTIVE IN E MODE             @DA35279 00045001
*       DEACTIVATING OF PARTIONS WAS NOT DONE CORRECTLY        @DA35397 00046001
*       PTE UPDATE AFTER IPTE                                  @DA35476 00047001
*       PHO INTERFACE CHANGE                                   @DA35398 00048001
*       PMR PERFORMANCE IMPROVEMENT WITH 4K PAGES              @DA35638 00049001
*       MORE ADDRESS SPACES  (SPE DY37265)                     @D218DKH 00050001
*       SOFTWARE RE-IPL                                        @D31QDHB 00051001
*       CHECK FOR INCORRECT LENGTH IN PAGE I/O                 @DA39188 00052001
*       NEW SYSTEM LAYOUT                                      @D51GDRP 00053001
*       31-BIT REAL AND XA I/O SUPPORT                         @D51GDTP 00054001
*       MORE PARTITION SUPPORT                                 @D51IDIS 00055001
*       ACCESS REGISTER SUPPORT                                @D51KDTP 00056001
*       HARDWAIT FF9, DUE TO UNCOND. PAGE-OUT IS DONE          @DA40640 00057001
*       AFTER INVPAGE OCCURED.                                 @DA40640 00058001
*       STORAGE FOR DYN.PARTITIONS OF CLASS R IS NOT RETURNED  @DA40317 00059001
*       ISSUE ISKEAHEAD OF 'DIAGNOSE 10' INSTEAD THEREAFTER    @DA41877 00060001
*       31 BIT ENABLING                                        @D52VDVB 00061001
*       FF1 PAGE-OUT ACTIVE/NO FREE FRAME                      @KX40135 00062001
*       DATA SPACE SUPPORT                                     @D52GDWL 00063001
*       LOOP DURING VIO-CLOSE, IF PAGEFAULT PENDING FOR        @KX40145 00064001
*        ACTUAL VIO PAGE.                                      @KX40145 00065001
*       DEVPDASA/DEVPDASB HAVE TO BE FULLW.        @D52VDRP    @KY30015 00066001
*       PTENASS CHECKED WITHOUT PTEIBIT            @D51GDRP    @KX40523 00067001
*       WRAP-AROUND, SEARCHING IN PDAS             @D52VDRP    @KX40510 00068001
*       UNPRED. RESULTS, IF PARAMETERLIST DESTROYED            @KX40685 00069001
*       DURING PROCESSING                          @D35EDRP    @KX40685 00070001
*       INVALID RC FOR PAGEIN, DUE TO R8 DESTROYED @D52VDVB    @KX40712 00071001
*       1ST PAGE OF PRIV. AREA NOT HANDLED BY PHO  @D52VDRP    @KY30133 00072001
*       I/O ERROR HANDLING BLOCKED PAGING                      @0000036 00073001
*       SOFT WAIT AFTER I/O ERROR HANDLING                     @KD40018 00074001
*        FOR BLOCKED PAGE I/O                      @0000036    @KD40018 00075001
*       HARDWAIT FF1 IN PDASFIND FOR DATA-SPACE SEGMENT-TABLE  @KX40737 00076001
*        FOR MORE THAN 2GB-16M.                    @D52GDWL    @KX40737 00077001
*       PFTEFLG3.POSLISON FOR PERFORMANCE          @D52VDVB    @KX41010 00078001
*       DELETE IORE OF UNC PAGE-OUT WITH PGDELO    @D400018    @KX41325 00079001
*       USE DATASPACE TOKEN IN PHO-INTERFACE       @D52GDWL    @KX41342 00080001
*       ALET ADDR NOT VALIDATED IN PAGESTAT        @D52GDWL    @KX41349 00081001
*       PAGE SELECTION CONSIDERS SMALL PAGE POOL   @D52VDVB    @KD40096 00082001
*       DELETE IORE IN PGQO OF NO PAGES AFFECTED   @D52VDVB    @KD40234 00083001
*       BITS IN RTAB, RTABX NOT SET CORRECTLY      @D52VDRP    @KD40310 00084001
*       CONSIDER PENDING PAGE-OUT IN DRAPDEQ                   @KD40353 00085001
*       CONSIDER PTEPDS FOR BLOCKED PAGEIN         @D52VDVB    @KD40354 00086001
*       POSLBITS MUST NOT BE RESET AT EOC          @D52VDVB    @KD40356 00087001
*       RESTRUCTURE OF PMR                                     @D52VDRP 00088001
*       HARDWAIT FF1 WITH BLOCKED PAGE I/O AND EOC             @DA42913 00089001
*       NON-PDS SYSTEM                                         @D61BDRP 00090001
*       PERFORMANCE IMPROVEMENTS PAGE-OUT                      @D61NDVB 00091001
*       PMR ERRONEOUSLY POSTED IF CHANNEL QUEUE BOUND          @DA42992 00092001
*       MULTI-PROCESSOR SUPPORT (TURBO DISPATCHER)             @D61RDRP 00093001
*       SUPPORT OF LARGE DISKS                                 @D61ADRP 00094001
*       FREE UP IPL CONSOLE STORAGE                            @D61CDRP 00095001
*       IN MP ENV. IPTE MUST BE DONE BEFORE PAGES/FRAMES CAN   @KXA1851 00096001
*       ... CON BE INSPECTED/CLEARED                           @KXA1851 00097001
*       DEACT/REACT OF DYNAMIC PARTITIONS                      @DY43697 00098001
*       PHO ACTIVE AND PAGE FAULT IN DATA SPACE                @DY43775 00099001
*       HANDLE CURSELCT AND I-BIT PROPERLY                     @DY44117 00100001
*       MODIFY PTE AFTER IPTE INSTRUCTION                      @DY44241 00101001
*       REMOVE FAST-CCW-TRANSLATION                            @D64YDOW 00102001
*       MORE THAN 255 TASKS                                    @D66CDOW 00102101
* A000000-999999                                               @D35EDRP 00102201
**** END OF SPECIFICATIONS *******************************************/ 00102301
         SPACE 2                                                        00102401
PMRADR   DS    0D                                              @D14BDVB 00102501
         DC    CL8'SGPMR'                                               00102601
         DC    CL10'09/29/2000' LAST DEVELOPMENT / APAR                 00102701
         SPACE 2                                                        00102801
*-------------------------------------------------------------*@D149DVB 00102901
*        ROUTINE PROLOGUE                                      @D149DVB 00103001
*        ROUTINE NAME: ENQUI                                   @D149DVB 00104001
*        MACRO:        SGPMR                                   @D149DVB 00105001
*        FUNCTION:  ENQUEUES THE PAGE FAULT INTO THE QUEUE PGQUI        00106001
*                   WHICH IS SERVED PBY THE PAGE MANAGER TASK  @D149DVB 00107001
*        CALLED BY: PFFLIH   AT ENQUI WITH AMODE(31),DATON     @D149DVB 00108001
*                   TFIX    )                                  @D149DVB 00109001
*                   PFIX    ) VIA GENPGQE WITH AMODE(31),DATON @D529DRP 00110001
*                   PAGE_IN )    AT ENTRY ENQUIX               @D149DVB 00111001
*                   PMR      AT ENQUI2ND WITH AMODE(31),DATON  @D529DRP 00112001
*                   VIOPOINT AT ENQUVIO  WITH AMODE(31),DATON  @D529DRP 00113001
*        CALLED ROUTINES:                                      @D529DRP 00114001
*                   CHKVPOOL WITH AMODE(31),DATON              @D529DRP 00115001
*                   ENQENTR  WITH AMODE(31),DATON              @D529DRP 00116001
*                   EPACNVRT WITH AMODE(31),DATON              @D529DRP 00117001
*                   UNPOST   WITH AMODE(31),DATON              @D529DRP 00118001
*                   PHO-APP  WITH AMODE(24),DATON              @D529DRP 00119001
*        ENTRY POINT:  ENQUI                                   @D149DVB 00120001
*                      ENQUIX                                  @DA35398 00121001
*                      ENQUI2ND                                @D149DVB 00122001
*                      ENQVIO                                  @D149DVB 00123001
*        EXIT :     DISPATCHER WITH AMODE(24),DATON            @D149DVB 00124001
*                   ERR25      WITH AMODE(24),DATON            @D529DRP 00125001
*                   ERR2A      WITH AMODE(24),DATON            @D529DRP 00126001
*                   PMR2ND    ...PAGE FAULT HANDLING WITH I/O  @D149DVB 00127001
*                   PMRUSER   ...TRY PAGE FAULT HANDLING       @D149DVB 00128001
*                                WITHOUT I/O                   @D149DVB 00129001
*                     WITH AMODE(31),DATON                     @D529DRP 00130001
*        ERROR EXIT: -                                         @D149DVB 00131001
*        INPUT: IF ENTERED IN ENQUI / ENQUI2ND / ENQUIX        @DA35398 00132001
*                   TRADR: PAGE FAULT ADDR IN LOW STORAGE      @D149DVB 00133001
*                   R4  :  SCB ADDRESS                         @D149DVB 00134001
*                   R8  :  ADDR PAGE MANAGEMENT DATA AREA      @D149DVB 00135001
*                   GENPGADR: IF CALLED FOR XMMOVE             @DY44889 00136001
*               IF ENTERED ENQVIO                              @D149DVB 00137001
*                   R6  :  ADDRESS (DISPATCHER)                @D149DVB 00138001
*                   R8  :  ADDR PAGE MANAGEMENT DATA AREA      @D149DVB 00139001
*                   RB  :  ADDRESS (PCB)                       @D149DVB 00140001
*                   RC  :  ADDR (VIOTIB)                       @D149DVB 00141001
*                   RD  :  PAGE FAULT ADDR ON PAGE BOUNDARY    @D149DVB 00142001
*        OUTPUT:                                               @D149DVB 00143001
*                   TIB(REQUESTOR) WITH TIBSTATE = PAGE_FAULT_ADDR      00144001
*                       IN PGQUI                               @D149DVB 00145001
*                                                              @D149DVB 00146001
*        OPERATION:                                            @D149DVB 00147001
*                                                              @D149DVB 00148001
*        ENQUI :                                               @D149DVB 00149001
*        IF PAGE(TRADDR) IN VPOOL /* BELONGS PAGE TO VPOOL   */@D149DVB 00150001
*           THEN DO                                            @D149DVB 00151001
*           GET_VTAB(TRADDR)      /*   VIOTAB ENTRY          */@D149DVB 00152001
*           IF VTAB.VTOWNER ¬= PIK OR VTAB.VTUSCNT = 0         @D149DVB 00153001
*              THEN GOTO ERR25    /*  INVALID  ADDRESS       */@D149DVB 00154001
*           IF VTAB.VTPAGERR = ON /*   PAGE IN ERROR         */@D149DVB 00155001
*              THEN GOTO ERR2A    /*   I/O ERROR ON PDS      */@D149DVB 00156001
*           END                                                @D149DVB 00157001
*        IF PCB.SUPPRPFH = OFF    /*PARTITION NOT DEACTIVATED*/@D149DVB 00158001
*           THEN DO                                            @D149DVB 00159001
*           IORE.TIBSTATE := ADDR(PAGE_FAULT) /* ADDR(P_F)   */@D149DVB 00160001
*           EXIT PMRUSER          /* TRY PAGE FAULT HANDLING */@D149DVB 00161001
*           END                   /*     WITHOUT I/O         */@D149DVB 00162001
*        ENQUI2ND :  /* E.P. IF P_F HANDLING REQUIRES I/O    */@D149DVB 00163001
*        IF PAGE(TRADDR) IN VPOOL /*  PAGE BELONGS TO VIOPOOL*/@D149DVB 00164001
*           THEN INCREASE VTAB.VTPFCNT /*   #(PENDING P_F)   */@D149DVB 00165001
*        TRADDR := (TRADDR/PAGESIZE)*PAGESIZE                  @D149DVB 00166001
*        IF TRADDR.USERPF = ON    /*     USER PAGE FAULT     */@D149DVB 00167001
*             & IORE.LTAOWNER+PRIVILEG=OFF /*LTA NOT OCCUPIED*/@D149DVB 00168001
*             & IORE.SEIZEBIT = OFF /*   SYSTEM NOT SEIZED   */@D149DVB 00169001
*           THEN DO                                            @D149DVB 00170001
*           IF IORE.PHOACT = ON     /*  PHO ACTIVE FOR TASK  */@D149DVB 00171001
*                 & TCB.VTAM = OFF  /*  VTAM NOT ACTIVE      */@D149DVB 00172001
*              THEN DO                                       */@D149DVB 00173001
*              GET_PHOTIB (PCB)     /*     PHO TIB           */@D149DVB 00174001
*              SAVE_STATUS                                     @D149DVB 00175001
*              RID := PFARID                                   @D149DVB 00176001
*              CALL PFAPPENDAGE (PHOTIB) /*CALL PHO APPENDAGE*/@D149DVB 00177001
*              RESET STATUS                                    @D149DVB 00178001
*              RID := SYSTEMRID                                @D149DVB 00179001
*              IF PAGE_FAULT HANDLED   /*    VIA BRANCHTAB   */@D149DVB 00180001
*                 THEN GOTO ENQUVIO                            @D149DVB 00181001
*              END                                             @D149DVB 00182001
*           END                                                @D149DVB 00183001
*        CALL UNPOST(SRQPMR)           /*   MAKE TASK UNREADY*/@D149DVB 00184001
*        ENQUVIO:                      /*   E.P. VIO         */@D149DVB 00185001
*        CALL ENQENTR                  /*   ENQUEUE ON DEVCB */@D149DVB 00186001
*        IF DEVCB.DEVSTAT = ON         /*  REQUEST IN PROCESS*/@D149DVB 00187001
*             OR PCB.SUPPRPFH = ON     /*PARTITION NOT ACTIVE*/@D149DVB 00188001
*           THEN RETURN (DISPATCHER)                           @D149DVB 00189001
*        ACTIVATE (PMR,OWNER=SYSTEM    /* ACTIVATE PMR TASK  */@D149DVB 00190001
*        EXIT PMR2ND                   /*  GOTO PMR ROUTINE  */@D149DVB 00191001
*        END (ENQUI) ;                                         @D149DVB 00192001
*-------------------------------------------------------------*@D149DVB 00193001
*        INTERNAL REGISTER USAGE                                        00194001
*              R0 - WORK REGISTER                                       00195001
*              R1 - WORK REGISTER                                       00196001
*              R2 - WORK REGISTER                                       00197001
*              R4 - WORK REGISTER                                       00198001
*              R5 - WORK REGISTER                                       00199001
*              R6 - BASE ADDR OF DISP.                                  00200001
*              R7 - WORK REGISTER                              @D369DRP 00201001
*              R9 - BASE ADDR OF CODE AREA                              00202001
*              RA - WORK REGISTER                                       00203001
*              RB - ADDR OF PCB TO WHICH THE PAGE-FAULT BELONGS@D369DRP 00204001
*              RC - ADDR OF TIB OF REQUESTOR                            00205001
*              RD - WORK REGISTER                                       00206001
*              RE - WORK REGISTER                                       00207001
*              RF - WORK REGISTER                                       00208001
*                                                                       00209001
*         TID/PIK TASK IDENTIFICATION                                   00210001
         SPACE 2                                                        00211001
         USING PMGMDATA,R8        SET BASE FOR DATA AREA                00212001
*SGLINK  ENQUI,S,INPUT=(R8:APMGMDAT),AMODE=31                           00213001
ENQUI    L     R4,SCBPTR          GET CURRENT SCB              @DA35398 00214001
*SGLINK  ENQUIX,S,INPUT=(R4:SCB,R8:APMGMDAT),AMODE=31                   00215001
ENQUIX   L     RD,TRADDR          GET PAGE FAULT ADDRESS AND USER      *00216001
                                  ... PAGE FAULT INDICATION    @DA35398 00217001
         L     R9,APMRADR         GET BASE FOR CODE AREA       @DA35398 00218001
         USING PMRADR,R9          SET BASE FOR CODE AREA                00219001
         L     R6,DISPAD          GET ADDRESS OF DISPATCHER    @D61RDRP 00220001
         USING DISP,R6            SET DISPATCHER ADDRESSABLE            00221001
         AIF   (NOT &LOLEV1).NOLOL1                                     00222001
         L     R5,PFCTR           S                                     00223001
         LA    R5,1(R5)           S    INCREASE NUMBER OF               00224001
         ST    R5,PFCTR           S    PAGE-FAULTS BY 1                 00225001
.NOLOL1  ANOP                                                           00226001
         LR    R7,RD              SAVE PAGE FAULT ...          @DA35398 00227001
         N     R7,PMPAGMSK        ... ADDRESS FOR              @D52GDWL 00228001
         ST    R7,PHOPGADR        ... FOR PHO HANDLING         @DA35398 00229001
         BAL   RE,EPACNVRT        CONVERT PAGE FAULT TO EPA    @DA35398 00230001
*SGLINK  EPACNVRT,INPUT=(R4,R8,RD,RE),WORK=(R5),OUTPUT=(RD)             00231001
         ST    RD,TRADDR          ... AND STORE IT             @DA35398 00232001
         LR    R1,RD                                           @DA35398 00233001
         L     R4,GENPGADR        GET CORRECT SCB ADDR         @D51GDRP 00234001
         ST    R4,PMRSCB          SET SCB ADDR FOR CHKVPOOL    @D52VDRP 00235001
         LR    R5,R1                                           @D52VDRP 00236001
         BAL   RA,CHKVPOOL        CHECK FOR VPOOL, SET PFVTABE @D52VDRP 00237001
*SGLINK  CHKVPOOL,INPUT=(R5,RA),OUTPUT=(R5),WORK=(R5)          @D52VDRP 00238001
         B     ENQUI1             BRANCH, PAGE NOT IN VPOOL    @D52VDRP 00239001
* ---->  B     ENQUI0             PAGE IN VPOOL                @D52VDRP 00240001
ENQUI0   DS    0H                                              @D52VDRP 00241001
         USING VTABE,R5                                        @D14BDRP 00242001
         TM    VTUSCNT,XFF        PAGE VALID                   @D14BDRP 00243001
         BNM   ERR25              NO. CANCEL USER              @D64ADOW 00244001
         CLC   VTOWNER,PIK        REQUESTED BY OWNING PARTITION@D14BDRP 00245001
         BNE   ERR25              NO, CANCEL USER              @D64ADOW 00246001
         TM    VTFLG,VTPAGERR     PAGE IN ERROR                @D14BDRP 00247001
         BNZ   ERR2A              YES, CANCEL                  @D64ADOW 00248001
         DROP  R5                 FORGET BASE FOR VTABE        @D14BDRP 00249001
ENQUI1   DS    0H                                              @D52VDRP 00250001
         L     RC,TIBPTR          TIB OF CURRENT TASK          @D36IDRP 00251001
         USING TIBADR,RC                                       @D36IDFR 00252001
         ST    R1,TIBSTATE        SET PAGE-FAULT EPA IN TIB    @D14BDRP 00253001
         L     RA,GENPGADR        GET SCB BELONGING TO EPA     @D52VDRP 00254001
         ST    RA,TIBPFSCB        *   AND SAVE IT IN TIB       @D52VDRP 00255001
         TM    PMRFLAG,PMRIOWT    WAITING ON PAGE-OUT COMPLETE @KX40135 00256001
         BO    ENQUI2             YES, EQUEUE REQUEST          @KX40135 00257001
         L     RB,PCBPTR                                       @D14BDRP 00258001
         USING PCBADR,RB                                       @D14BDRP 00259001
         L     RB,PCBACPCB        GET PCB OF CORRESP. CLASS    @D51IDRP 00260001
*                                 PARTITION/CLASS DEACTIVATED  @D51IDRP 00261001
         TM    PCBFLAG,SUPPRPFH+SUPPFTPI                       @DY43864 00262001
         BNZ   ENQUI2             YES, ENQUEUE REQUEST         @DY43864 00263001
         TM    PMRFLAG,VIOCLREQ   REQUEST FROM VIOCLOSE        @KX40145 00264001
         BO    ENQUI2             YES, ENQUEUE REQUEST         @KX40145 00265001
         DROP  RB                                              @D14BDRP 00266001
         L     RA,PMRDBGEN        INDICATE ENQUEU DEBUG ENTRY  @D51GDRP 00267001
         DEBUG ALLREGS,XXDBGMC    * CREATE DEBUG ENTRY         @D61NDRP 00268001
         SLR   RA,RA              RESET EYECATCHER             @KD40295 00269001
         MVI   PGQTYP,ZERO        RESET PMR INDICATIONS        @D14BDRP 00270001
         B     PMRUSER            SEE WHETHER PAGE-FAULT               *00271001
                                  HANDL. POSSIBLE WITHOUT I/O  @D14BDRP 00272001
         SPACE 2                                                        00273001
*   ENTRY POINT IF PAGE-FAULT HANDL. IS NOT POSS. WITHOUT I/O  @D14BDRP 00274001
ENQUI2ND DS    0H                                              @D52VDRP 00275001
         SGCOV SGPMR,MC=0                                      @D52VDVB 00276001
         L     R6,DISPAD          GET BASE OF DISPATCHER       @D61RDRP 00277001
*    SWITCH BACK TO USER SPACE                                          00278001
*        SGSETUP RESETSCB,WR1=R4,WR2=R5                        @D52VDRP 00279001
         SGSETUP RESETSCB,WR1=R4,WR2=R5                        @D52VDRP 00280001
*  ENTRY IF PARTITION/CLASS IS DEACTIVATED AND USER PAGE-FAULT @D519DRP 00281001
ENQUI2   L     RC,TIBPTR          TIB OF CURRENT TASK          @D36IDRP 00282001
         NI    PMRFLAG,XFF-VIOCLREQ RESET VIOCLOSE INDICATION  @KX40145 00283001
*        GENSERV TEST,FIELD=PFVTABE,REG=(R5),BC=BNP,LAB=ENQUI2A        *00284001
                                  VPOOL PAGE AFFECTED          @D52VDVB 00285001
         GENSERV TEST,FIELD=PFVTABE,REG=(R5),BC=BNP,LAB=ENQUI2A        *00286001
                                  VPOOL PAGE AFFECTED          @D52VDVB 00287001
         USING VTABE,R5                                        @D14BDRP 00288001
*        GENSERV INC,FIELD=VTPFCNT,REG=(R0) INCREASE PF COUNTER@D52VDVB 00289001
         GENSERV INC,FIELD=VTPFCNT,REG=(R0)                    @D52VDVB 00290001
         DROP  R5                                              @D14BDRP 00291001
ENQUI2A  TM    PHOPGADR,USERPF    IS IT USER PAGE-FAULT        @DA35398 00292001
         BNO   SYSPFLT            NO, BRANCH                   @D36IDRP 00293001
         NI    PHOPGADR,XFF-USERPF                             @DA35398 00294001
*   IF PAGEFAULT IN PRIVILEGED RTN OR IF TASK OWNS LTA         @D369DRP 00295001
*         HANDLE AS SYSTEM PF                                  @D369DRP 00296001
         TM    TIBFLAG1,PRIVILEG+LTAOWNER                      @D36IDRP 00297001
         BNZ   SYSPFLT            BRANCH, SYSTEM PAGE-FAULT    @D36IDFR 00298001
*        IF TASK HAS SEIZED THE SYSTEM, HANDLE AS SYSTEM PF    @D369DRP 00299001
         TM    TIBFLAG3,SEIZEBIT                               @D36IDRP 00300001
         BNZ   SYSPFLT            BRANCH, SYSTEM PAGE-FAULT    @D36IDFR 00301001
         L     RB,PCBPTR          GET USER PCB ADDR            @D36IDRP 00302001
         AIF   (NOT &LOLEV1).NOLOL12                                    00303001
         L     R5,UPFCTR          S INCREASE NUMBER OF                  00304001
         LA    R5,1(R5)           S    USER PAGE-FAULTS                 00305001
         ST    R5,UPFCTR          S    REQ. ENQUE BY 1                  00306001
.NOLOL12 ANOP                                                           00307001
         TM    TIBFLAG1,PHOACT    PHO ACTIVE FOR TASK          @D36IDRP 00308001
         BNO   ENQUIN             NO, BRANCH                   @D36IDRP 00309001
         DROP  RC                 FORGET BASE FOR TIB          @D36IDRP 00310001
*                                                                       00311001
*        INTERNAL REGISTER USAGE IN PHO SUPPORT                         00312001
*              R4 - ADDR OF SCB                                @D52GDWL 00313001
*              R5 - WORK REGISTER                                       00314001
*              R7 - LINK REGISTER TO PHO-APPENDAGE             @D369DRP 00315001
*              RB - ADDR OF USER PCB                           @D369DRP 00316001
*              RC - ADDR OF PHOTIB                             @D369DRP 00317001
*              RD - WORK REGISTER                                       00318001
*                                                                       00319001
         L     R5,TCBPTR          GET ADDR OF TCB              @D14BDRP 00320001
         USING TCBADR,R5                                       @D36IDRP 00321001
         TM    TCBEXFLG,TCBEXHPS  PAGE FAULT IN X-MEM-MODE     @D64ADOW 00322001
***                               ...I.E. ¬(HASN=PASN=SASN)             00323001
         BNO   ENQUIN             YES, SKIP PHO EXIT --->      @D64ADOW 00324001
         TM    VTAMFLG,VTURX+VTAPP IF EITHER A VTAM                     00325001
*              AP OR USER EXIT IS RUNNING THEN                          00326001
         BNZ   ENQUIN             AVOID PHO EXIT               @D36IDFR 00327001
         DROP  R5                 FORGET BASE FOR TCB          @D36IDRP 00328001
         SPACE 1                                               @D149DVB 00329001
*-------------------------------------------------------------*@D149DVB 00330001
*    EXIT PHO APPENDAGE ROUTINE                               *@D149DVB 00331001
*           R7    RETURN REGISTER                             *@D149DVB 00332001
*           R8    ENTRY POINT OF PHO ROUTINE                  *@D149DVB 00333001
*       OLD R13 INTERFACE:                                    *@D52GDWL 00334001
*           R13   PAGE FAULT INFORMATION AS USED BY SYSTEM    *@D149DVB 00335001
*       NEW INTERFACE VIA 4 FULLWORD STORAGE AREA:            *@D52GDWL 00336001
*           1. FULLWORD  -  PAGE FAULT ADDRESS                *@D52GDWL 00337001
*           NEXT EIGHT BYTES:                                 *@KX41342 00338001
*            IF PAGEFAULT BELONGS TO DATA SPACE:              *@KX41342 00339001
*               8 BYTE DATASPACE TOKEN I.E.                   *@KX41342 00340001
*                 BYTE 0-1: 1ST PART OF SCB ADDRESS           *@KX41342 00341001
*                 BYTE 6-7: 2ND PART OF SCB ADDRESS           *@KX41342 00342001
*            IF PAGEFAULT BELONGS TO ADDRESS SPACE:           *@KX41342 00343001
*               BYTE 0-1: 1ST PART OF SCB ADDRESS             *@KX41342 00344001
*               BYTE 2-5: PHO TIB ADDRESS                     *@KX41342 00345001
*               BYTE 6-7: 2ND PART OF SCB ADDRESS             *@KX41342 00346001
*           4. FULLWORD  -  RESERVED (SET TO BINARY ZERO)     *@D52GDWL 00347001
*-------------------------------------------------------------*@D149DVB 00348001
         USING PCBADR,RB                                       @D36IDFR 00349001
         L     RC,PCBAPHOT        LOAD PTR.TO PHO ENTRY        @D51IDRP 00350001
         USING TIBADR,RC                                       @D36IDFR 00351001
         L     RD,PHOPGADR        LOAD PAGE FAULT ADDRESS      @DA35398 00352001
         L     R4,GENPGADR        ADDR OF SCB BELONGING TO PF  @D52GDWL 00353001
         USING SCBADR,R4          R4 IS BASE FOR SCB OF PF     @D52GDWL 00354001
         ICM   R5,15,TIBPFARA     AREA SPECIFIED FOR SETPFA?   @D52GDWL 00355001
         BZ    ENQPHO01           NO,  R13 INTERFACE           @D52GDWL 00356001
         USING PFAAREA,R5         SET BASE FOR SETPFA AREA     @D52GDWL 00357001
         ST    RD,PFAADR          STORE ADDR OF PF IN AREA     @D52GDWL 00358001
         XC    PFARES,PFARES      CLEAR RESERVED FIELD         @KX41342 00359001
         TM    SCBFLG,SCBDSP      PF RELATED TO A DATA SPACE?  @D52GDWL 00360001
         BZ    ENQPHO00           NO                           @D52GDWL 00361001
         TM    TIBFLAG4,TIBPFDSP  PHO EXIT TO BE ACTIVATED     @D52GDWL 00362001
*                                 FOR DATA SPACES?             @D52GDWL 00363001
         BZ    ENQPHSY5           NO,  SKIP PHO EXIT STUFF     @DY43775 00364001
         SGCOV SGPMRD,MC=0        DATA SPACE COVERAGE          @D52GDWL 00365001
         MVC   PFASTKN(8),DSCBSTKN SET TOKEN OF DATA SPACE     @KX41342 00366001
         B     ENQPHO03           -----> INVOKE PHO APPENDAGE  @KX41342 00367001
ENQPHO00 STCM  R4,12,PFASCB1      STORE 1ST PART OF SCB ADDR   @KX41342 00368001
         STCM  R4,3,PFASCB2       STORE 1ST PART OF SCB ADDR   @KX41342 00369001
         STCM  RC,15,PFATIB       A(TIB) - ARBITRARY VALUE ... @D52GDWL 00370001
*                                 ...TO FORM A SECRETIVE TOKEN @D52GDWL 00371001
         B     ENQPHO03           -----> INVOKE PHO APPENDAGE  @D52GDWL 00372001
         DROP  R5                 RELEASE AREA                 @D52GDWL 00373001
ENQPHO01 DS    0H                 THE OLD R13 INTERFACE IS USED@D52GDWL 00374001
         TM    SCBFLG,SCBDSP      PF RELATED TO A DATA SPACE?  @D52GDWL 00375001
         BO    ENQPHSY5           YES, NO PHO                  @DY43775 00376001
         LA    R0,255             IF THE CURRENT SPACE NUMBER..@D52GDWL 00377001
         CH    R0,SCBSPN          ... IS LARGER THAN THE OLD   @D52GDWL 00378001
         BL    ENQPHSY5           ... MAXIMUM, DON'T ACTIV. PHO@DY43775 00379001
         IC    RD,SCBSPN+1        INSERT SPACE NUMBER          @D52GDWL 00380001
         ST    RD,PHOPGADR        SAVE USER PF INFORMATION     @D52GDWL 00381001
         DROP  R4                 RELEASE SCB BASE             @D52GDWL 00382001
ENQPHO03 STM   R9,RC,PMRSLEV0+OFR9 SAVE REGISTERS USED BY ENQUI@D52VDVB 00383001
         L     R8,TIBPFAPP        GET ADDR OF PAGE FAULT APPEND@D36IDRP 00384001
         DROP  R8                 DROP BASE FOR DATA AREA      @D52VDRP 00385001
         MVI   RID+D1,PFARID      SET RID FOR PHO APPENDAGE             00386001
         DROP  R9                 DROP BASE FOR CODE           @D52VDRP 00387001
*                                 ROUTINE                               00388001
*        AMODESW CALL,REGS=(R7,R8) TRANSFER CONTROL TO ENTRY A OF THE  *00389001
                 PAGE FAULT APPENDAGE ROUTINE IN AMODE(24)     @D52VDRP 00390001
         AMODESW CALL,REGS=(R7,R8)                             @D52VDRP 00391001
         SPACE 1                                                        00392001
*-------------------------------------------------------------*@D149DVB 00393001
*    RETURN FROM PAGE FAULT APPENDAGE WITH REGISTER 7 AND     *@D149DVB 00394001
*           OFFSET 0   WHEN APPENDAGE HAS ACCEPTED PAGE FAULT *@D149DVB 00395001
*           OFFSET 4   IF PAGE FAULT MUST BE HANDLED BY SYSTEM*@D149DVB 00396001
*-------------------------------------------------------------*@D149DVB 00397001
         B     ENQPHEXT-*(R7)                                  @D14BDVB 00398001
* ---->  B     ENQPHSYS                                        @D14BDVB 00399001
ENQPHSYS MVI   RID+D1,SYSTEMID    RESET RID                    @D14BDVB 00400001
         L     R8,APMGMDAT        RESTORE BASE OF PMR DATA     @D14BDVB 00401001
         USING PMGMDATA,R8        SET BASE FOR DATA AREA       @D52VDRP 00402001
         LM    R9,RB,PMRSLEV0+OFR9                             @D52VDVB 00403001
         USING PMRADR,R9          SET BASE FOR CODE AREA       @D52VDRP 00404001
*        AMODESW SET,AMODE=31,WR=(R6)                          @D52VDRP 00405001
         AMODESW SET,AMODE=31,WR=(R6)                          @D52VDRP 00406001
ENQPHSY5 DS    0H                                              @DY43775 00407001
         L     R6,DISPAD          BASE ADDR OF DISPATCHER      @D14BDVB 00408001
         L     RC,TIBPTR          ADDR ACTIVE TIB              @D14BDVB 00409001
         B     ENQUIN             --->                         @D14BDVB 00410001
         SPACE 1                                               @D149DVB 00411001
         DROP  R8,R9              DROP BASE FOR DATA, CODE     @D52VDRP 00412001
ENQPHEXT MVI   RID+D1,SYSTEMID    RESET RID                    @D36IDRP 00413001
         L     R8,APMGMDAT        RESTORE BASE OF PMR DATA              00414001
         USING PMGMDATA,R8        SET BASE FOR DATA AREA       @D52VDRP 00415001
         LM    R9,RC,PMRSLEV0+OFR9                             @D52VDVB 00416001
         USING PMRADR,R9          SET BASE FOR CODE AREA       @D52VDRP 00417001
*        AMODESW SET,AMODE=31,WR=(R6) SET 31 BIT ADDRESSING MOD@D52VDRP 00418001
         AMODESW SET,AMODE=31,WR=(R6)                          @D52VDRP 00419001
         L     R6,DISPAD          RESTOR R6, MAY BE DESTROYED  @D36IDRP 00420001
         TM    TIBFLAG1,PHOREQ    PHO-REQUEST OF TASK IN PGQUI @D36IDRP 00421001
         BNZ   ENQEXTDI           YES, RETURN TO DISPATCHER    @D52VDRP 00422001
         OI    TIBFLAG1,PHOREQ    INDICATE PHO-REQ. ENQUEUED   @D36IDRP 00423001
         MVC   TIBPFSCB,GENPGADR  PROVIDE SCB ADDR BEL. TO EPA @D52VDRP 00424001
         MVC   TIBUSPHO(4),PHOPGADR SAVE EXTERNAL PF INFO.     @D52GDWL 00425001
         B     UPDEOPQ            ENQUEUE REQ. DON'T UNPOST    @D36IDRP 00426001
         DROP  RB,RC              FORGET BASE FOR PCB, PHOTIB  @D36IDRP 00427001
         SPACE 1                                                        00428001
*     RC POINTS TO TIB OF CURRENT TASK                         @D369DRP 00429001
*     RB POINTS TO PCB TO WHICH THE PAGE-FAULT BELONGS         @D369DRP 00430001
SYSPFLT  L     RB,ASYSPCB         GET SYSTEM PCB ADDR          @D36IDRP 00431001
ENQUIN   L     R5,ASRQTAB         GET ADDR OF ...              @D61RDRP 00432001
         LA    R5,SRQPMR-SRQTAB(,R5) ... RESOURCE QUEUE        @D61RDRP 00433001
         BAL   RF,UNPOST          MAKE TASK UNREADY            @D36IDFG 00434001
*SGLINK  UNPOST,INPUT=(R5,R6,RF),WORK=(R5,RE)                  @D369DRP 00435001
UPDEOPQ  L     RD,TRADDR          GET EPA OF PAGE FAULT        @D36IDFR 00436001
*     ENTRY ENQUVIO                                                     00437001
*        INPUT:                                                         00438001
*         R6 - BASE ADDR OF DISP.                                       00439001
*         R8 - ADDR OF PAGE-MANAGEMENT DATA AREA                        00440001
*         R9 - BASE ADDR OF CODE AREA                                   00441001
*         RB - ADDR OF PCB OF PART. OWNING THE VIO-STORAGE              00442001
*         RC - ADDR OF VIOTIB                                           00443001
*         RD - PAGE-ADDR TO BE HANDLED ON PAGE-BOUNDARY                 00444001
         AIF   (NOT &LOLEV1).NOLOL13                           @D52VDRP 00445001
         B     ENQUVIO1           SKIP COUNTING                @D52VDRP 00446001
.NOLOL13 ANOP                                                  @D52VDRP 00447001
ENQUVIO  DS    0H                                              @D14BDRP 00448001
         AIF   (NOT &LOLEV1).NOLOL14                           @D52VDRP 00449001
* COUNT VIO REQUESTS AS PAGE-FAULTS                            @D52VDRP 00450001
*        GENSERV INC,FIELD=PFCTR,REG=(R0)                      @D52VDVB 00451001
         GENSERV INC,FIELD=PFCTR,REG=(R0)                      @D52VDVB 00452001
* COUNT VIO REQUESTS AS PAGE-FAULTS, REQUIRING ENQUE           @D52VDRP 00453001
*        GENSERV INC,FIELD=UPFCTR,REG=(R0)                     @D52VDVB 00454001
         GENSERV INC,FIELD=UPFCTR,REG=(R0)                     @D52VDVB 00455001
ENQUVIO1 DS    0H                                              @D52VDRP 00456001
.NOLOL14 ANOP                                                  @D52VDRP 00457001
         USING PCBADR,RB          SET BASE FOR PCB             @D51IDRP 00458001
         L     RE,PCBACPCB        GET CLASS PCB FOR ENQENTR RTN@D51IDRP 00459001
         DROP  RB                                              @D51IDRP 00460001
         L     R9,APMRSERV        GET BASE ...                 @D52VDVB 00461001
         USING PMRSERV,R9         ... FOR SERVICES             @D52VDVB 00462001
*SGLINK  ENQENTR,INPUT=(R7,R9,RC,RD,RE),WORK=(R3-R5,RD),               *00463001
               OUTPUT=(RB),NOMODR=(RE-R2,R6-RA,RC),AMODE=31 DATON       00464001
         BAL   R7,ENQENTR         ENQUEUE TIB FOR CORR. DEVICE @D14BDRP 00465001
         L     R9,APMRADR         RESET BASE                   @D52VDVB 00466001
         USING PMRADR,R9                                       @D52VDVB 00467001
         L     RA,PMRDBGEN        INDICATE ENQUEU DEBUG ENTRY  @D52VDRP 00468001
         DEBUG ALLREGS,XXDBGMC    * CREATE DEBUG ENTRY         @D61NDRP 00469001
         SLR   RA,RA              RESET EYECATCHER             @KD40295 00470001
         USING PCBADR,RE          SET BASE FOR CLASS-PCB       @D36IDRP 00471001
         USING DEVCB,RB                                        @D14BDRP 00472001
*  SEE WHETHER PMR-TASK HAS TO BE ACTIVATED                    @D369DRP 00473001
         TM    DEVSTAT,XFF        REQUEST IN PROCESS ON DEVICE @D14BDRP 00474001
         BNZ   ENQEXTDI           YES, RETURN TO DISPATCHER    @D52VDRP 00475001
         TM    PCBFLAG,SUPPRPFH+SUPPFTPI PARTITION/CLASS DEACT @DY43697 00476001
         BNZ   ENQEXTDE           YES, SET EMPTY AGAIN AND RETURN TO   *00477001
                                  DISPATCHER                   @DY43697 00478001
         L     RA,APMRTIB                                      @DA42992 00479001
         USING TIBADR,RA                                       @DA42992 00480001
         CLI   TIBRQID,WAITBND     CAN PMR BE ACTIVATED        @DA42992 00481001
         BE    PMRACT              YES, ACTIVATE PMR           @DA42992 00482001
         CLI   TIBRQID,SYSBND      CAN PMR BE ACTIVATED        @DA42992 00483001
         BNE   ENQEXTDI            NO, RETURN TO DISPATCHER    @DA42992 00484001
         DROP  RA                  DROP BASE FOR TIBADR        @DA42992 00485001
         SPACE 1                                                        00486001
*        ACTIVATE PMR-TASK, SET SYSTEM AS OWNER                @D149DRP 00487001
         SPACE 1                                                        00488001
PMRACT   DS 0H                                                 @DA42992 00489001
         ST    RE,DEVPCB          ADDR(CURRENT CLASS-PCB)      @DA35279 00490001
         DROP  RE                 FORGET BASE FOR CLASS-PCB    @D14BDRP 00491001
*     SGSETUP ACTIVATE,STASK=PMR,WR1=RA,WR2=R7,OPTION=SYSOWNER @D529DRP 00492001
         SGSETUP ACTIVATE,STASK=PMR,WR1=RA,WR2=R7,                     *00493001
               OPTION=SYSOWNER                                 @D52VDRP 00494001
         B     PMR2ND             ==========> EXIT PMR MAIN    @D365DRP 00495001
         SPACE 1                                               @D52VDVB 00496001
ENQEXTDE MVI   DEVSTAT,DEVEMPTY  INDICATE DEVICE EMPTY         @D61RDRP 00497001
ENQEXTDI DS    0H                                              @D52VDRP 00498001
*        AMODESW RETURN,REG=(R6)  ==========> RETURN TO DISP.  @D52VDRP 00499001
         AMODESW RETURN,REG=(R6)                               @D52VDRP 00500001
         DROP  RB                 RESET ADDRESS. TO DEVCB      @D14BDRP 00501001
         DROP  R6                 RESET ADDRESS. TO DISPATCH   @D36IDRP 00502001
*     END OF ENQUI ROUTINE                                              00503001
         TITLE 'VSE/AF SUPERVISOR     SGPMR     PAGE MANAGER (PMR-TASK)*00504001
               '                                               @D14ZDRP 00505001
*-------------------------------------------------------------*@D149DVB 00506001
*        ROUTINE PROLOGUE                                      @D149DVB 00507001
*        ROUTINE NAME: PMR (MAIN ROUTINE OF PMR-TASK)          @D149DVB 00508001
*        MACRO:        SGPMR                                   @D149DVB 00509001
*        FUNCTION: PROCESSES THE PAGE-REQUEST-QUEUE-ENTRIES.   @D149DVB 00510001
*                  ENSURES THAT A PAGE REQUESTED BY AN ENTRY   @D149DVB 00511001
*                  IS IN STORAGE  AND ADDRESSABLE FOR          @D149DVB 00512001
*                  FOR PAGE-IN REQUESTS, AND ON PDS            @D149DVB 00513001
*                  FOR PAGE-OUT REQUESTS.                      @D149DVB 00514001
*        CALLED BY: SGPLLEV  AT PMR      WITH AMODE(31),DATON  @D529DRP 00515001
*                   ENQUI    AT PMRUSER AND PMR2ND             @D529DRP 00516001
*                                        WITH AMODE(31),DATON  @D529DRP 00517001
*                   TPOUT    AT PMR      WITH AMODE(31),DATON  @D529DRP 00518001
*        CALLED ROUTINES:                                      @D529DRP 00519001
*              CHKVPOOL WITH AMODE(31)                         @D529DRP 00520001
*              SELECTPG WITH AMODE(31),DATOFF                  @D529DRP 00521001
*              TRTTABB  WITH AMODE(31),DATOFF                  @D529DRP 00522001
*              CPGIN    WITH AMODE(31),DATON                   @D529DRP 00523001
*              UNPOST   WITH AMODE(31),DATON                   @D529DRP 00524001
*        ENTRY POINTS:                                         @D149DVB 00525001
*              PMR                                             @D149DVB 00526001
*              PMR2ND                                          @D149DVB 00527001
*              PMRUSER                                         @D529DRP 00528001
*        EXIT TO:                                              @D529DRP 00529001
*              ENQUI2ND         WITH AMODE(31),DATON           @D529DRP 00530001
*              REACTIME         WITH AMODE(24),DATON           @D529DRP 00531001
*                                                              @D149DVB 00532001
*        INPUT: PAGE-REQUEST-ELEMENT = TIB WITH                @D149DVB 00533001
*                TIBSTATE =  PAGE-FAULT EPA  ON PAGE BOUNDARY, @D149DVB 00534001
*                            FOR PAGE-IN REQUEST               @D149DVB 00535001
*                TIBSTATE =  PFTE ADDR, FOR PAGE-OUT REQUEST   @D149DVB 00536001
*               R8 - ADDR OF PAGE-MANAGEMENT DATA-AREA         @D149DVB 00537001
*               R9 - ADDR OF CODE AREA (BASE REGISTER)         @D149DVB 00538001
*             IF CALLED VIA 2ND ENTRY-POINT PMR2ND (FROM ENQUI)@D149DVB 00539001
*               RB - ADDR OF ACTIVE DEVCB                      @D149DVB 00540001
*               RC - ADDR OF TIB OF TASK FOR WHICH THE PAGE-   @D149DVB 00541001
*                    FAULT HAS TO BE HANDLED                   @D149DVB 00542001
*        OUTPUT: PAGE-STATE OF REQUESTED PAGE IS ADDRESSABLE   @D149DVB 00543001
*                    FOR PAGE_IN REQUEST                       @D149DVB 00544001
*                COPY ON PAGE-DATA-SET FOR PAGE_OUT REQUEST    @D149DVB 00545001
*        EXIT NORMAL: RETURN TO DISPATCHER AFTER PMR-TASK      @D149DVB 00546001
*                     IS SET WAITING FOR WORK                  @D149DVB 00547001
*                CONDITION: NO MORE WORK TO DO                 @D149DVB 00548001
*        EXIT ERROR:   -                                       @D149DVB 00549001
*        RETURN CODE:  -                                       @D149DVB 00550001
*-------------------------------------------------------------*@D149DVB 00551001
*    OPERATION:                                                @D149DVB 00552001
*                                                              @D149DVB 00553001
*    PMR:                                                      @D149DVB 00554001
*    ADDR_DEVCB                       /*ADDRESS OF 1ST DEVCB */@D149DVB 00555001
*    PMRIOEND:                                                 @D149DVB 00556001
*    UNTIL DEVCB = <>  DO             /* LAST DEVCB PROCESSED*/@D149DVB 00557001
*      IF DEVCB.DEVEMPTY = ON         /* PAGE FAULT REQ ENQ  */@D149DVB 00558001
*        THEN GOTO PMRLOOP2           /* NO                  */@D529DVB 00559001
*      IF DEVCB.DEVSTRT+DEVPGWO¬= OFF /* DEVICE FREE         */@D149DVB 00560001
*        THEN GOTO PMRLOOP1           /* NO                  */@D529DVB 00561001
*      GET HIGHEST PRIORITY PAGE I/O ON DEVCB                  @D529DVB 00562001
*      IF (* NO REQUEST PENDING *)                             @D529DVB 00563001
*        THEN GOTO PMRLOOP2           /* YES                 */@D529DVB 00564001
*      IF IORE.PGQTYP = PGO | PMRFLAG ¬= PMRIOWT               @D529DVB 00565001
*        THEN GOTO PMR2ND             /* HANDLE REQUEST      */@D529DVB 00566001
*        ELSE GOTO PMRLOOP2                                    @D529DVB 00567001
*    PMRLOOP1:                                                 @D529DVB 00568001
*      IF DEVCCB.CCBCOM1 = TRABIT     /* I/O COMPLETE PENDING*/@D529DVB 00569001
*        THEN GOTO PMRIOCMP           /* YES                 */@D529DVB 00570001
*    PMRLOOP2:                                                 @D529DVB 00571001
*      GET NEXT DEVCB                                          @D529DVB 00572001
*    END-DO-UNTIL                                              @D529DVB 00573001
*    IF TIMER(REACTIVATION) POSTED                             @D149DVB 00574001
*      THEN EXIT REACTIME             /* EXIT TO REACTIVATION*/@D149DVB 00575001
*      ELSE DO                                                 @D149DVB 00576001
*        CALL UNPOST (SRQWAIT)        /* PMRTASK WAIT BND    */@D149DVB 00577001
*        EXIT DISPATCHER                                       @D149DVB 00578001
*      END                                                     @D149DVB 00579001
*                                                              @D149DVB 00580001
*    PMRIOCMP:                                                 @D149DVB 00581001
*    CALL RPOST (DEVCB,SRQPGIO)       /*POST PAGE I/O WAIT Q */@D529DVB 00582001
*    IORE = DEVCB.DEVACT              /* GET CURRENT IORE    */@D529DVB 00583001
*    DEVCB.DEVSTAT.DEVSTRT = OFF      /* RESET REQ-STARTED   */@D529DVB 00584001
*    SWITCH TO RELATED PMR-ADDRESS SPACE                       @D529DVB 00585001
*    CALL PMRIOVIO                    /* PROCESS VIO -IF ANY */@D529DVB 00586001
*    CALL PMRIOERR                    /* PROCESS I/O ERROR   */@D529DVB 00587001
*                                     /* - IF ANY            */@D529DVB 00588001
*    IF IORE.PGQTYP=PGO               /* PAGE-OUT COMPLETED  */@D529DVB 00589001
*      THEN DO                                                 @D529DVB 00590001
*        CALL PGOCOMPL(IORE,DEVCB)                             @D529DVB 00591001
*        GOTO PMRIOEND           /*HANDLE NEXT REQ ON DEVICE */@D529DVB 00592001
*      END                       /*  IDENTIFIED BY DEVCB     */@D529DVB 00593001
*      ELSE DO                                                 @D529DVB 00594001
*        CALL PGICOMPL(IORE,DEVCB)                             @D529DVB 00595001
*        IF BLOCKED PAGE-IN                                    @D529DVB 00596001
*          THEN GOTO PMRIOEND    /*HANDLE NEXT REQ ON DEVICE */@D529DVB 00597001
*          ELSE GOTO PAGERDIO    /*COMPLETE PAGE-FAULT HANDLG*/@D529DVB 00598001
*      END                                                     @D529DVB 00599001
*                                                              @D529DVB 00600001
*    PMR2ND:                                                   @D149DVB 00601001
*    SET UP INFO FOR CURRENT IORE                              @D529DVB 00602001
*    SWITCH TO RELATED PMR-ADDRESS SPACE                       @D529DVB 00603001
*    IF IORE.PGQTYP=PGO               /* PAGE-OUT REQUEST    */@D529DVB 00604001
*      THEN DO                                                 @D529DVB 00605001
*        CALL PGOUTSIO(IORE,DEVCB)    /* SET UP PAGE-OUT     */@D529DVB 00606001
*        IF PSEUDO REQUEST                                     @D529DVB 00607001
*          THEN GOTO PMRIOEND    /*HANDLE NEXT REQ ON DEVICE */@D529DVB 00608001
*          ELSE                       /* SCHEDULE SVC 15     */@D529DVB 00609001
*      END                                                     @D529DVB 00610001
*      ELSE DO                                                 @D529DVB 00611001
*        IF UNBLOCKED PAGE-IN         /*PAGE FAULT PROCESSING*/@D529DVB 00612001
*        THEN DO                                               @D529DVB 00613001
*          GET EPA                    /* AFFECTED EPA        */@D149DVB 00614001
*          IF (* PAGE ADDRESSABLE OR VSE-INVALID *)            @D149DVB 00615001
*            THEN GOTO PMR100         /* YES, DEQUEUE REQUEST*/@D149DVB 00616001
*          IF (* ERRONEOUS PAGE *)                             @D149DVB 00617001
*            THEN GOTO PMR200         /* YES, SPECIAL HANDLNG*/@D149DVB 00618001
*          IF (* VALID_COPY ON PDS & PAGE FAULT UNDER USER *)  @D149DVB 00619001
*            THEN EXIT ENQUI2ND  /*EXIT: HANDLE I/O UNDER PMR*/@D149DVB 00620001
*          CALL SELECTPG (FRAME,PFTE,DEVCB)                    @D149DVB 00621001
*            SELECT                                            @D529DVB 00622001
*              WHEN (* HANDLE FIRST OTHER REQ *) GOTO PMRIOEND @D529DVB 00623001
*              WHEN (* PAGE I/O REQUIRED *) EXIT ENQUI2ND      @D529DVB 00624001
*              OTHERWISE              /*HANDLE SELECTED FRAME*/@D529DVB 00625001
*            END SELECT                                        @D529DVB 00626001
*        END;                                                  @D52VDVB 00627001
*        CALL PGINSIO(IORE,DEVCB,FRAME,PFTE)                   @D52VDVB 00628001
*        IF (* NO VALID COPY ON PDS *)                         @D529DVB 00629001
*          THEN GOTO PAGERDIO /*COMPLETE PAGE-FAULT HANDLING */@D529DVB 00630001
*      END                                                     @D529DVB 00631001
*    SVC-15 (DEVCB.DEVCCB)                                     @D529DVB 00632001
*    IF DEVCB.CCBCOM1 = TRABIT        /*I/O ALREADY COMPLETE */@D529DVB 00633001
*      THEN GOTO PMRIOCMP             /* YES,  HANDLE IT     */@D529DVB 00634001
*    GET NEXT DEVCB                                            @D149DVB 00635001
*    GOTO PMRIOEND                    /* HANDLE NEXT DEVICE  */@D149DVB 00636001
*                                                              @D149DVB 00637001
*    PAGERDIO:                                                 @D529DVB 00638001
*    CALL MAKEADDR(PAGE,FRAME)                                 @D529DVB 00639001
*    IF (* RUNNING UNDER USER *)                               @D529DVB 00640001
*      THEN DO                                                 @D529DVB 00641001
*        SWITCH BACK TO USER ADDRESS SPACE                     @D529DVB 00642001
*        EXIT DISP                    /* RETURN TO DISPATCHER*/@D149DVB 00643001
*      END                                                     @D149DVB 00644001
*    PMR100:                                                   @D529DVB 00645001
*    CALL DEQUI(IORE,DEVCB)    /* DEQUEUE REQUEST FROM DEVCB */@D529DVB 00646001
*    GOTO PMRIOEND                                             @D529DVB 00647001
*                                                              @D529DVB 00648001
*    PMR200:                                                   @D529DVB 00649001
*    IF (* RUNNING UNDER USER *)                               @D529DVB 00650001
*      THEN SELECT                                             @D529DVB 00651001
*        WHEN PAGE IN VSDISK (& DATASPACE) DO                  @D529DVB 00652001
*            MODIFY PSW TO VDSISK-SERVICE ERROR ROUTINE        @D529DVB 00653001
*            EXIT DISPATCHER                                   @D529DVB 00654001
*          END                                                 @D529DVB 00655001
*        WHEN PAGE IN DATASPACE & ¬EOT ACTIVE                  @D529DVB 00656001
*           | USER-PAGE-FAULT & ¬EOT ACTIVE & ¬SAVE AREA AFFEC @D529DVB 00657001
*           | AR-PAGE-FAULT & ¬EOT ACTIVE                      @D529DVB 00658001
*          CANCEL VIA EXIT ERR2A                               @D529DVB 00659001
*        OTHERWISE EXIT FF9                                    @D529DVB 00660001
*      END SELECT                                              @D529DVB 00661001
*      ELSE GOTO PMR100                                        @D529DVB 00662001
*   END (PMR) ;                                                @D149DVB 00663001
*-------------------------------------------------------------*@D149DVB 00664001
*        EXTERNAL REFERENCES                                   @D149DVB 00665001
*         ROUTINES= SELECTPG  TO SELECT A PAGE FOR REPLACEMENT @D149DVB 00666001
*                   PAGERD    TO READ A PAGE FROM PDS          @D149DVB 00667001
*                   CPGIN     TO COUNT PAGINS FOR LOAD LEVELLING        00668001
*                   TRTABB    TO TEST REENTRY BIT              @D149DVB 00669001
*         DATA= PAGE-STATE(READ,WRITE)                         @D149DVB 00670001
*               PAGE-REQUEST ELEMENT (READ,WRITE)              @D149DVB 00671001
*               PFTE(WRITE)     PAGE FRAME TABLE ENTRY         @D149DVB 00672001
*               PSQ(READ,WRITE) PAGE SELECTION QUEUE           @D149DVB 00673001
*        MACROS= INSBOT - INSERT PFTE ON BOTTOM OF PSQ         @D149DVB 00674001
*                                                              @D149DVB 00675001
*-------------------------------------------------------------*@D149DVB 00676001
*    INTERNAL REGISTER USAGE:                                  @D149DVB 00677001
*        R1 - ADDR OF PAGE TO BE HANDLED                       @D149DVB 00678001
*        R2 - ADDR OF PTE BELONGING TO R1                      @D149DVB 00679001
*        R3 - WORK REGISTER                                    @D149DVB 00680001
*        R4 - WORK REGISTER                                    @D149DVB 00681001
*        R5 - WORK REGISTER                                    @D149DVB 00682001
*        R6 - ADDR OF DISPATCHER/ WORK REGISTER                @D52VDVB 00683001
*        R7 - LINK REGISTER TO 2ND LEVEL                       @D149DVB 00684001
*        R8 - BASE REGISTER FOR DATA-AREA                      @D149DVB 00685001
*        R9 - BASE REGISTER FOR CODE                           @D149DVB 00686001
*        RA - LINK REGISTER TO 1ST LEVEL                       @D149DVB 00687001
*        RB - WORK REGISTER/ ADDR OF ACTIVE DEVCB              @D149DVB 00688001
*        RC - ADDR OF PFTE WHICH BELONGS TO R1                 @D149DVB 00689001
*        RE - ADDR OF CORRESPONDING PF                         @D149DVB 00690001
*                                                              @D149DVB 00691001
*        ONLY R8 AND R9 HAVE TO BE SET ON ENTRANCE TO PMR      @D52VDVB 00692001
*-------------------------------------------------------------*@D149DVB 00693001
         SPACE 1                                               @D14BDVB 00694001
*    GET 1ST DEVICE WITH REQUEST ENQUEUED                      @D14BDRP 00695001
         SPACE 1                                               @D14BDVB 00696001
PMR      L     RB,ADEVCB          GET ADDR OF 1ST DEVCB        @D14BDRP 00697001
         USING DEVCB,RB                                        @D14BDRP 00698001
         SPACE 1                                               @D14BDVB 00699001
*   CONTINUE SCAN WITH SAME DEVICE                             @D14BDRP 00700001
         SPACE 1                                               @D14BDVB 00701001
PMRIOEND LH    R4,DEVCBNUM        GET LOOP COUNTER             @D14BDRP 00702001
PMRLOOP  TM    DEVSTAT,DEVEMPTY   REQ. ENQUEUED ON THIS DEVICE @D14BDRP 00703001
         BO    PMRLOOP2           NO,  CHECK NEXT DEVICE       @D52VDRP 00704001
         TM    DEVSTAT,DEVSTRT    DEVICE FREE ?                @D61NDVB 00705001
         BO    PMRLOOP1           NO,  ---------->CHECK FURTHER@D61NDVB 00706001
         TM    DEVSTAT,DEVPGWO    WAITING FOR PAGEOUT          @D61NDVB 00707001
         BZ    PMRLOOP0           NO,  ---------->HANDLE DEVICE@D61NDVB 00708001
         SPACE 1                                               @D61NDVB 00709001
*   CHECK WHETHER UNCOND PAGE-OUT IS PENDING                   @D61NDVB 00710001
         SPACE 1                                               @D61NDVB 00711001
         LA    R5,PFRQBEG-TIBCHAIN+TIBADR GET ADDR OF PGQSYS   @D61NDVB 00712001
         USING TIBADR,R5                                       @D61NDVB 00713001
         L     R5,TIBCHAIN        FIRST IORE OF PGQSYS IF ANY  @D61NDVB 00714001
         LTR   R5,R5              PGQSYS EMPTY                 @D61NDVB 00715001
         BZ    PMRCNT0            YES, ---------->             @D61NDVB 00716001
         TM    PGQTYP,PGO         IORE FOR PAGE-OUT            @D61NDVB 00717001
         BO    PMRLOOP0           YES, ----------> HANDLE IORE @D61NDVB 00718001
         SPACE 1                                               @D61NDVB 00719001
PMRCNT0  DS    0H                                              @D61NDVB 00720001
*   CHECK WHETHER PRE-PAGE-OUT CAN BE HANDLED                  @D61NDVB 00721001
         LA    R5,PORQBEG-TIBCHAIN+TIBADR GET ADDR OF PGQO     @D61NDVB 00722001
         L     R5,TIBCHAIN        FIRST IORE OF PGQO IF ANY    @D61NDVB 00723001
         LTR   R5,R5              PGQO EMPTY                   @D61NDVB 00724001
         BZ    PMRLOOP1           YES, ---------->             @D61NDVB 00725001
         LA    R1,PGTPCB          ADDR OF PSEUDO PCB           @D61NDVB 00726001
         B     PMRCNT2            ----------> HANDLE PREPAGEOUT@D61NDVB 00727001
         DROP  R5                                              @D61NDVB 00728001
         SPACE 1                                               @D61NDVB 00729001
*     GET HIGHEST PRIORITY PARTITION /CLASS WITH PAGE FAULT             00730001
*     PENDING AND NOT DEACTIVATED                                       00731001
PMRLOOP0 DS    0H                                              @D61RDRP 00732001
         L     R1,DEVCBMSK        GET DEVICE MASK              @D14BDRP 00733001
*        DISPMAC FUNC=PFQUERY,INP1=(R1)                                 00734001
*              RETURNS IN R1 ADDR(PCB) WITH PF PENDING         @D61RDVB 00735001
         DISPMAC FUNC=PFQUERY,INP1=(R1)                                 00736001
         LTR   R1,R1              ANY PF TO BE HANDLED         @D61RDVB 00737001
         BNZ   PMRCNT2            YES, ---------->             @D61RDVB 00738001
         TM    IJBFLG08,IJBDEBUG  IS DEBUG ACTIVE              @D61RDRP 00739001
         BZ    PMRCHK3            NO, SKIP DEBUG CODE          @D61RDRP 00740001
*                                 YES, CHECK WHETHER DEVICE IS REALY   *00741001
                                  ... FREE                     @D61RDRP 00742001
         LA    R1,PFRQBEG         GET BEGIN OF AREA TO CHECK   @D61RDRP 00743001
         LA    R3,PORQBEG         GET END OF AREA TO CHECK     @D61RDRP 00744001
PMRCHKNQ ICM   R6,15,0(R1)        IS QUEUE FREE                @D61RDRP 00745001
         BZ    PMRCHK2            YES, OK                      @D61RDRP 00746001
         L     R6,TIBPCB-TIBADR(R6) GET PART. PCB              @D61RDRP 00747001
         L     R6,PCBACPCB-PCBADR(R6) GET CLASS PCB            @D61RDRP 00748001
         TM    PCBFLAG-PCBADR(R6),SUPPRPFH+SUPPFTPI            @DY43697 00749001
*                                 PARTITION/CLASS DEACTIVATED  @DY43697 00750001
         BNZ   PMRCHK2            YES, OK                      @DY43697 00751001
*                     NO, CHECK FOR DEACTIVATED BY TPIN        @D61RDRP 00752001
         AGO   .NOTPIN                                         @D61RDVB 00753001
         LA    R5,TPPCBSAV        GET LIST OF CLASS PCBS       @D61RDRP 00754001
PMRCHKLP ICM   RF,15,0(R5)        GET ADDR OF CLASS PCB        @D61RDRP 00755001
         BZ    PMRCHKHW           BRANCH IF END OF LIST REACHED@D61RDRP 00756001
         CR    R6,RF              CLASS DEACTIVATED            @D61RDRP 00757001
         BE    PMRCHK2            YES, OK                      @D61RDRP 00758001
         LA    R5,4(,R5)          POINT TO NEXT ENTRY IN LIST  @D61RDRP 00759001
         B     PMRCHKLP           CHECK NEXT ENTRY             @D61RDRP 00760001
.NOTPIN  ANOP                                                  @D61RDVB 00761001
PMRCHKHW BAL   R5,PMRHWERR        ---------> ERROR             @D61RDRP 00762001
PMRCHK2  CR    R1,R3              ALL ENTRIES CHECKED          @D61RDRP 00763001
         BNL   PMRCHK3            YES, CONTINUE                @D61RDRP 00764001
         LA    R1,L'PFRQBEG+L'PFRQEND(,R1) GET NEXT ENTRY ...  @D61RDRP 00765001
         B     PMRCHKNQ           ... AND CHECK IT             @D61RDRP 00766001
PMRCHK3  MVI   DEVSTAT,DEVEMPTY   IND. NO REQ. TO BE HANDLED   @D14BDRP 00767001
         B     PMRLOOP2           ----------> TEST NEXT DEVICE @D52VDRP 00768001
         SPACE 1                                               @D36IDRP 00769001
PMRCNT2  DS    0H                                              @D14BDRP 00770001
         LR    R5,R1              SAVE PART PCB FOR PFUPD SERV.@D61RDRP 00771001
         USING PCBADR,R1          SET BASE FOR PCB             @D61RDVB 00772001
         L     R1,PCBACPCB        GET CLASS PCB                @D61RDVB 00773001
PMRCNT3  DS    0H                                              @D61NDVB 00774001
         LH    R2,PCBID           GET ID FOR THIS PART./CLASS  @D51IDRP 00775001
         SLL   R2,3               OFFSET IN REQ. QUEUE HEADER  @D51IDRP 00776001
PMRHANDL ST    R1,DEVPCB          SAVE ADDR OF ACTUAL CLASS-PCB@D14BDRP 00777001
         DROP  R1                 FORGET BASE FOR CLASS-PCB    @D51IDRP 00778001
         L     RC,PFRQBEG(R2)     FIRST QUEUE ENTRY            @D14BDRP 00779001
         LTR   RC,RC              QUEUE EMPTY                  @D14BDRP 00780001
         BNZ   PMRHAND1           NO, O.K.                     @D14BDRP 00781001
.* IN CASE OF TURBO DISPATCHER, WE HAVE TO INFORM IT NOW THAT  @D61RDRP 00782001
.* NOTHING IS QUEUED FOR THIS PARTITION, ONLY POSSIBLE FOR     @D61RDRP 00783001
.* DYNAMIC PARTITIONS.                                         @D61RDRP 00784001
         L     R1,DEVCBMSK        GET DEVICE MASK              @D61RDRP 00785001
         SLR   R3,R3              IND. DEQUEUE REQUEST         @D61RDRP 00786001
*        DISPMAC FUNC=PFUPD,INP1=(R1),INP2=(R3),INP3=(R5)      @D61RDRP 00787001
         DISPMAC FUNC=PFUPD,INP1=(R1),INP2=(R3),INP3=(R5)      @D61RDRP 00788001
         B     PMRLOOP0           ----> CHECK FOR NEXT REQUEST ON      *00789001
                                  ... SAME DEVICE              @D61RDRP 00790001
PMRHW01  BAL   R5,PMRHWERR        -----> ERROR                 @D14BDRP 00791001
PMRHAND1 EQU   *                                               @D14BDRP 00792001
         USING TIBADR,RC                                       @D36IDRP 00793001
         TM    PGQTYP,PGO         PAGE-OUT REQUEST             @KX40135 00794001
         BO    PMR2ND             YES, ---------> HANDLE IT    @KX40135 00795001
         TM    PMRFLAG,PMRIOWT    WAITING ON PAGE-OUT COMPLETE @KX40135 00796001
         BO    PMRLOOP2           YES, ----------> TEST NEXT DEVICE    *00797001
                                  ... DO NOT HANDLE PAGE-IN    @D52VDRP 00798001
         B     PMR2ND             NO, HANDLE PAGE-IN REQUEST   @D52VDRP 00799001
         SPACE 2                                                        00800001
PMRLOOP1 TM    DEVCCB+CCBCOM1-CCBADR,TRABIT I/O COMPLETE       @D52VDRP 00801001
         BO    PMRIOCMP           YES, HANDLE COMPL. I/O REQ.  @D52VDRP 00802001
         SPACE 1                                               @D14ZDVB 00803001
PMRLOOP2 L     RB,DEVCBNXT        GET ADDR OF NEXT DEVCB       @D52VDRP 00804001
         BCT   R4,PMRLOOP         TEST NEXT DEVICE             @D14BDRP 00805001
         SPACE 1                                               @D14BDVB 00806001
         TM    REACTECB+CCBCOM1-CCBADR,TRABIT   TIMER FOR ...          *00807001
                                  ...REACTIVATION POSTED       @DA26818 00808001
         BO    PMRREACT           YES --->                     @DA26818 00809001
         SPACE 1                                                        00810001
*   DEACTIVATE PMR TASK NOTHING TO DO                          @D14ZDVB 00811001
         SPACE 1                                                        00812001
         L     R6,DISPAD                                       @D52VDVB 00813001
         USING DISP,R6                                         @D36IDRP 00814001
         L     R5,ASRQTAB         GET ADDRESS OF ...           @D61RDRP 00815001
         LA    R5,SRQWAIT-SRQTAB(,R5) ... RESOURCE QUEUE       @D61RDRP 00816001
*SGLINK  UNPOST,INPUT=(R5,R6,RF),WORK=(R5,RE)                  @D149DVB 00817001
         BAL   RF,UNPOST          SET PMR WAIT BND             @D14BDRP 00818001
*        AMODESW RETURN,REG=(R6)  ==========> RETURN TO DISP.  @D52VDRP 00819001
         AMODESW RETURN,REG=(R6)  ==========> RETURN TO DISP.  @D52VDRP 00820001
         DROP  R6                 DROP BASE FOR DISP           @D52VDVB 00821001
         SPACE 1                                               @DA26818 00822001
PMRREACT L     RF,ALOLEV          BASE OF LOAD LEVELER         @DA26818 00823001
         USING LOLEV,RF           ADDRESSABILITY               @DA26818 00824001
*        AMODESW BRANCH,AMODE=24,ADDRESS=REACTIME,REG=(R7)              00825001
*                TEST IF REACTIVATION IS POSSIBLE BY LOAD LEVELER       00826001
*                RETURN TO LABEL PMR  ==========>              @D52VDRP 00827001
         AMODESW BRANCH,AMODE=24,ADDRESS=REACTIME,REG=(R7)              00828001
         DROP  RF                                              @DA26818 00829001
         SPACE 2                                                        00830001
*   HANDLING OF COMPLETED PAGE I/O REQUEST                              00831001
         SPACE 1                                                        00832001
PMRIOCMP DS    0H                                              @D52VDVB 00833001
         LR    R1,RB              GET DEVCB OF ACTUAL DEVICE   @D52VDRP 00834001
         L     R5,ASRQTAB         GET ADDRESS OF ...           @D61RDRP 00835001
         LA    R5,SRQPGIO-SRQTAB(,R5) ... RESOURCE QUEUE       @D61RDRP 00836001
         L     R6,DISPAD          GET BASE FOR RPOST           @D52VDRP 00837001
         USING DISP,R6                                         @D52VDRP 00838001
         BAL   RF,RPOST           POST TASKS WAITING FOR I/O   @D52VDRP 00839001
*SGLINK  RPOST,INPUT=(R1,R5,R6,RF),WORK=(R5,RE)                @D529DRP 00840001
         DROP  R6                 DROP BASE FOR DISP           @D52VDRP 00841001
         ST    RB,PFDEVCB         SAVE ADDR OF ACTUAL DEVICE   @D14BDRP 00842001
         L     RC,DEVACT          GET ACTIVE QUEUE ENTRY       @D14BDRP 00843001
         USING TIBADR,RC                                       @D14BDRP 00844001
         NI    DEVSTAT,XFF-DEVSTRT RESET REQ. STARTED IND.     @D14BDRP 00845001
         ST    RC,PFPGQE          SAVE ADDRESS OF REQ.ELEMENT  @D14NDFG 00846001
         L     R2,TIBPFSCB        GET SCB                      @D52VDRP 00847001
         ST    R2,PFSCB           SAVE IT FOR LATER USE        @D52VDRP 00848001
         USING SCBADR,R2                                       @D52VDRP 00849001
         MVC   APT,SCBAPT         SET ACTUAL PAGE TABLE ADDR   @D52VDRP 00850001
         L     R2,SCBAPMRA        GET SCB FOR PT AND PTAS      @D52VDRP 00851001
         DROP  R2                 DROP BASE FOR SCB            @D52VDRP 00852001
*    SWITCH TO PMR ADDRESS SPACE                               @D52VDRP 00853001
*        SGSETUP SETSCB,NEXTSCB=R2,OPTION=SAVE,WR1=R4,WR2=R5   @D52VDRP 00854001
         SGSETUP SETSCB,NEXTSCB=R2,OPTION=SAVE,WR1=R4,WR2=R5   @D52VDRP 00855001
         L     RA,PMRDBGIO        INDICATE I/O COMPL DEBUG ENTR@D51GDRP 00856001
         DEBUG ALLREGS,XXDBGMC    * CREATE DEBUG ENTRY         @D61NDRP 00857001
         SLR   RA,RA              RESET EYECATCHER             @KD40295 00858001
*SGLINK  PMRIOVIO,INPUT=(R7,R8,R9,RC),WORK=(R4,R5,RA),AMODE=31 DATON    00859001
         BAL   R7,PMRIOVIO        SET PFVTABE                  @D52GDRP 00860001
         L     R7,APMRIOER        GET ENTRY POINT OF PMRIOERR  @0000036 00861001
*SGLINK  PMRIOERR,INPUT=(R7,R8,RB,RC),NOMODR=(R7-RF),AMODE=31 DATON     00862001
         BALR  R7,R7              CHECH  ON I/O ERROR          @0000036 00863001
         XC    DEVACT,DEVACT      RESET ACTIVE REQUEST ENTRY   @D14BDRP 00864001
         SPACE 1                                               @D52VDVB 00865001
         TM    PGQTYP,PGO         IS IT READ REQUEST           @D52VDRP 00866001
         BZ    PMRPGICP           YES, ---------->             @D52VDRP 00867001
         L     R7,APGOCPLT        GET ENTRY POINT OF PGOCOMPL  @D52VDVB 00868001
*SGLINK  PGOCOMPL,INPUT=(R7,R8,RB,RC),OUTPUT=(RB),NOMODR=(R8-RF),      *00869001
               AMODE=31 DATON                                           00870001
         BALR  R7,R7              HANDLE PAGEOUT COMPLETE      @D52VDVB 00871001
         B     PMRIOEND           -----------> HANDLE REQUEST ON       *00872001
                                  ... DEVICE SPECIFIED BY RB   @D52VDVB 00873001
         SPACE 1                                               @D52VDVB 00874001
PMRPGICP DS    0H                                              @D52VDVB 00875001
         L     R7,APGICPLT        GET ENTRY POINT OF PGICOMPL  @D52VDVB 00876001
*SGLINK  PGICOMPL,INPUT=(R7,R8,RB),OUTPUT=(R1,R2,RC,RE),AMODE=31,      *00877001
               NOMODR=(R7-RB,RD,RF) DATON                               00878001
         BALR  R7,R7              HANDLE PAGE IN COMPLETE      @D52VDVB 00879001
PMRIOCBG DS    0H                                              @D52VDVB 00880001
PMRIOCBL B     PMRIOEND           BLOCKED PAGE IN                      *00881001
                                  ----------> HANDLE NEXT REQ. @D52VDVB 00882001
PMRIOCDO B     PAGERDIO           NORMAL PAGE FAULT                    *00883001
                                  ----------> DEQUEUE REQUEST  @D52VDVB 00884001
         SPACE 2                                                        00885001
PMR2ND   ST    RB,PFDEVCB         SAVE ADDR OF ACTUAL DEVICE   @D14BDRP 00886001
         L     RA,PMRDBGHD        IND. HANDLE NEW REQUEST      @D51GDRP 00887001
         DEBUG ALLREGS,XXDBGMC    * CREATE DEBUG ENTRY         @D61NDRP 00888001
         SLR   RA,RA              RESET EYECATCHER             @KD40295 00889001
PMRUSER  DS    0H                                              @D14BDRP 00890001
         MVI   PFVTABE,XFF        INDICATE NO VPOOL PAGE       @D52GDRP 00891001
         ST    RC,PFPGQE          SAVE ADDR OF REQ. ELEMENT    @D14BDRP 00892001
         L     R1,TIBPFSCB        GET SCB                      @D52VDRP 00893001
         ST    R1,PFSCB           SAVE IT FOR LATER USE        @D52VDRP 00894001
         ST    R1,PMRSCB          SET IT FOR CHKVPOOL          @D52VDRP 00895001
         USING SCBADR,R1                                       @D52VDRP 00896001
         MVC   APT,SCBAPT         SET ACTUAL PAGE TABLE ADDR   @D52VDRP 00897001
         L     R1,SCBAPMRA        GET SCB FOR PT AND PTAS      @D52VDRP 00898001
         DROP  R1                 DROP BASE FOR SCB            @D52VDRP 00899001
*    SWITCH TO PMR ADDRESS SPACE                               @D52VDRP 00900001
*        SGSETUP SETSCB,NEXTSCB=R1,OPTION=SAVE,WR1=R4,WR2=R5   @D52VDRP 00901001
         SGSETUP SETSCB,NEXTSCB=R1,OPTION=SAVE,WR1=R4,WR2=R5   @D52VDRP 00902001
         TM    PGQTYP,PGO         PAGE-OUT REQUEST             @D14BDRP 00903001
         BZ    PMR010             NO ---------->               @D52VDRP 00904001
*SGLINK  PGOUTSIO,INPUT=(R8,RA,RB,RC),NOMODR=(R8-RF)                    00905001
         L     R7,APGOSIO         ENTRY POINT FOR PGOUTSIO     @D52VDVB 00906001
         BALR  R7,R7              HANDLE PAGE OUT REQUEST      @D52VDVB 00907001
         B     PMRIOEND           PSEUDO ENTRY ONLY, ------->  @D52VDVB 00908001
         B     PAGEIO             START I/O  YES, ---------->  @D52VDVB 00909001
         SPACE 2                                               @D52VDVB 00910001
PMR010   DS    0H                                              @D52VDVB 00911001
         TM    PGQTYP,PGBLK       BLOCKED PAGE-IN              @D52VDVB 00912001
         BO    PMR050             YES,--------->               @D52VDVB 00913001
         DROP  RB                 FORGET BASE FOR DEVCB        @D14BDRP 00914001
         L     R1,TIBSTATE        GET EPA TO BE READ           @D36IDFR 00915001
         ST    R1,PAGEADDR        STORE EPA FOR DEQ.ROUT.      @D36IDFR 00916001
         LR    R5,R1              INPUT FOR CHKVPOOL           @D52VDRP 00917001
         BAL   RA,CHKVPOOL        CHECK FOR VPOOL, SET PFVTABE @D52VDRP 00918001
*SGLINK  CHKVPOOL,INPUT=(R5,RA),OUTPUT=(R5),WORK=(R5)          @D52VDRP 00919001
         NOP   PMR020             PAGE NOT IN VPOOL            @D52VDRP 00920001
* ---->  B     PMR020             PAGE IN VPOOL                @D52VDRP 00921001
PMR020   LR    R2,R1                                           @D35CDAA 00922001
         SRL   R2,PTSHIFT         OFFSET IN PT                 @D35CDAA 00923001
         A     R2,APT             ADDRESS OF PTE               @D35CDAA 00924001
         USING PTE,R2             SET BASE FOR PTE             @D35CDAA 00925001
         TM    PTESTAT,PTEIBIT    PAGE = ADDRESSABLE           @D14ADVB 00926001
         BZ    PMR100             ----------> YES, EXIT DEQUI  @D52VDRP 00927001
         TM    PTESTAT,PTEINVAD   PAGE = INVALID               @D14ADVB 00928001
         BO    PMR100             ----------> YES, EXIT DEQUI  @D52VDVB 00929001
         TM    PTESTAT,PTEERR     ERRONEOUS PAGE               @D52GDRP 00930001
         BO    PMR200             YES, DO SPECIAL HANDLING     @D52GDRP 00931001
         TM    PTESTAT,PTEPGCO    PAGE = CONNECTED             @D14ADVB 00932001
         BZ    PMR021             NO   --->                    @D14BDRP 00933001
         CLC   TID,PMRTIDH        RUNNING UNDER USER           @D66CDOW 00934001
         BNE   ENQUI2ND           ----------> YES, ENQUEUE REQUEST     *00935001
                                              FOR PMR          @D14BDRP 00936001
         B     PMR100             ----------> NO,  EXIT DEQUI  @DA42913 00937001
.*    POSSIBLE IF PAGE FAULT IS PENDING FOR PAGE ALREADY       @DA42913 00938001
.*    CONNECTED TO FRAME BY PAGE-IN TASK                       @DA42913 00939001
.*    EITHER PAGE FAULT IS IN THE SYSTEMQUEUE                  @DA42913 00940001
.*    OR PAGE FAULT IS IN USER QUEUE AND EOC CONDITION DURING  @DA42913 00941001
.*                                BLOCKED PAGE-IN              @DA42913 00942001
PMR021   DS    0H                                              @D14BDRP 00943001
         TM    PTESTAT2,PTEPDS    VALID COPY ON PDS            @D14ADVB 00944001
         BZ    PMR030             NO, BRANCH                   @D35CDAA 00945001
         CLC   TID,PMRTIDH        UNDER CONTROL OF USER        @D66CDOW 00946001
         BNE   ENQUI2ND           ---------> YES, ENQ REQ  PMR @D14BDRP 00947001
         TM    SUPFLAG,KLLEDBT    BATCH DEACTIVATED            @D35CDAA 00948001
         BO    PMR040             YES BYPASS LL                @D35CDAA 00949001
         TM    PGQTYP,PGNCNT      COUNTING ALREADY DONE        @D14BDRP 00950001
         BO    PMR040             YES, DON'T COUNT AGAIN       @D14BDRP 00951001
         DROP  RC                 FORGET BASE FOR TIB          @D36IDRP 00952001
         L     R9,APMRSERV        GET BASE OF ....             @D52VDVB 00953001
         USING PMRSERV,R9         ... OF SERVICE ROUTINES      @D52VDVB 00954001
         BAL   R7,CPGIN           COUNT PAGE-IN FOR DEACTIV./  @D35CDAA 00955001
*                                 REACTIVATION                 @D35CDAA 00956001
         USING PMRADR,R9          ... OF MAIN LOOP             @D52VDVB 00957001
PMR030   DS    0H                                              @D52VDRP 00958001
         L     R9,APMRSERV        GET BASE OF ....             @D52VDVB 00959001
         USING PMRSERV,R9         ... OF SERVICE ROUTINES      @D52VDVB 00960001
         BAL   R7,TRTABB          TEST RTAB-BIT                @D35CDAA 00961001
         L     R9,APMRADR         GET BASE OF ....             @D52VDVB 00962001
         USING PMRADR,R9          ... OF MAIN LOOP             @D52VDVB 00963001
PMR040   DS    0H                 ENTER REAL MODE              @D52VDRP 00964001
*SGLINK  SELECTPG,INPUT=(R7:LINK,R8:APMGMDA,R9:BASE),                  *00965001
               WORK=(R0,R3,R4,R5,RA),                                  *00966001
               OUTPUT=(RB:DEVCB,RC:PFTE,RE:PF)                 @D52VDVB 00967001
         BAL   R7,SELECTPG        SELECT A FREE PFTE           @D35CDAA 00968001
         USING DEVCB,RB                                        @D52VDVB 00969001
PMRSELBG DS    0H                                              @D52VDVB 00970001
PMRSELIO B     PMRIOEND           HANDLE FIRST OTHER REQ.      @D52VDRP 00971001
PMRSELI2 B     ENQUI2ND           ENQUEUE REQUEST              @D52VDVB 00972001
PMRSELND DS    0H                 PROCESS SELECTED FRAME       @D52VDVB 00973001
*------> B     *                                               @D52VDVB 00974001
         SPACE 1                                               @D52VDVB 00975001
PMR050   DS    0H                                              @D52VDRP 00976001
         L     R7,APGINSIO        PREPARE PAGE IN,             @D52VDVB 00977001
         BALR  R7,R7              *  IF REQUIRED               @D52VDVB 00978001
*SGLINK  PGINSIO,INPUT=(R7,R8,R9,RB,RC,RE),NOMODR=(R7-RF),             *00979001
               AMODE=31 DATON                                           00980001
PMRGTPBG B     PAGERDIO           NO COPY ON PDS ---------->   @D52VDVB 00981001
*----->  B     PAGEIO             COPY ON PAGE DATA SET        @D52VDVB 00982001
PAGEIO   DS    0H                                              @D14BDRP 00983001
         LA    R1,DEVCCB          GET ADDR OF CCB              @D14BDRP 00984001
         OI    DEVSTAT,DEVSTRT    INDICATE REQ. STARTED        @D61NDVB 00985001
         L     R5,PFPGQE          * SET ACTUAL REQ. ELEMENT    @D14BDRP 00986001
         ST    R5,DEVACT          * FOR POST I/O PROCESSING    @D14BDRP 00987001
         SVC   15                 READ/WRITE                            00988001
*-------------------------------------------------------------*@D52VDVB 00989001
*   A T T E N T I O N:  A T  T H I S  P O I N T  T H E  P M R *@D149DVB 00990001
*           T A S K  I S  D I S P A T C H E D  A F T E R      *@D149DVB 00991001
*           A N Y  P O S T I N G                              *@D149DVB 00992001
*-------------------------------------------------------------*@D52VDVB 00993001
         USING CCBADR,R1                                       @D14BDRP 00994001
         TM    CCBCOM1,TRABIT     I/O ALREADY COMPLETED        @D14BDRP 00995001
         BO    PMRIOCMP           ==========> YES, HANDLE REQ  @D14BDRP 00996001
         SPACE 1                                               @D14BDVB 00997001
*   CONTINUE SCAN WITH NEXT DEVICE                             @D14BDRP 00998001
         SPACE 1                                               @D14BDVB 00999001
         L     RB,DEVCBNXT        GET ADDR OF NEXT DEVICE BLOCK@D14BDRP 01000001
         B     PMRIOEND           ==========> HANDLE NEXT DEVCB@D14BDRP 01001001
         DROP  R1                                              @D14BDRP 01002001
         DROP  RB                 DROP BASE FOR DEVCB          @D14BDRP 01003001
         SPACE 1                                               @D14BDRP 01004001
*-------------------------------------------------------------*@D52VDVB 01005001
*    DO FINAL ACTIONS FOR PAGE-FAULT HANDLING, AFTER COMPLETED @D149DRP 01006001
*    PAGE-IN REQUEST  OR IMMEDIATELY IF NO PAGE-IN IS NEEDED   @D149DRP 01007001
*    (FRAME WAS ALREADY CLEARED DURING INVALIDATION)           @D149DRP 01008001
*        CALLED BY: PMR AT PAGERDIO WITH AMODE(31),DATON       @D529DRP 01009001
*        CALLED ROUTINES:                                      @D529DRP 01010001
*              MAKEADDR WITH AMODE(31),DATON                   @D529DRP 01011001
*        ENTRY POINT:                                          @D529DRP 01012001
*              PAGERDIO                                        @D529DRP 01013001
*       R1 - ADDR OF PAGE TO BE MADE ADDRESSABLE               @D149DRP 01014001
*       R2 - ADDR OF PAGE TABLE ENTRY (PTE)                    @D149DRP 01015001
*       RC - ADDR OF PAGE FRAME TABLE ENTRY (PFTE)             @D149DRP 01016001
*       RE - ADDR OF PAGE FRAME                                @D149DRP 01017001
*-------------------------------------------------------------*@D52VDVB 01018001
         SPACE 1                                                        01019001
PAGERDIO DS    0H                                              @D14ADVB 01020001
         L     R9,APMRSERV        GET BASE OF ....             @D52VDVB 01021001
         USING PMRSERV,R9         ... OF SERVICE ROUTINES      @D52VDVB 01022001
         BAL   RA,MAKEADDR        MAKE PAGE ADDRESSABLE        @D52VDVB 01023001
*SGLINK  MAKEADDR,INPUT=(R2,R8,R9,RA,RC,RE),NOMODR=(R6-R3),            *01024001
               AMODE=31 DATON                                           01025001
         L     R9,APMRADR         GET BASE OF ....             @D52VDVB 01026001
         USING PMRADR,R9          ... OF MAIN LOOP             @D52VDVB 01027001
         CLC   TID,PMRTIDH        UNDER CONTROL OF USER        @D66CDOW 01028001
         BE    PMR120             NO,  ----------> DEQUEUE     @D52VDVB 01029001
*                                 YES, NO DEQUEUING TO BE DONE @D52VDVB 01030001
         AIF   (NOT &LOLEV1).NOLOL15                           @D14BDRP 01031001
*        GENSERV INC,FIELD=PFUCTR,REG=(R0)                     @D52VDVB 01032001
         GENSERV INC,FIELD=PFUCTR,REG=(R0)                     @D52VDVB 01033001
.NOLOL15 ANOP                                                  @D14BDRP 01034001
*    SWITCH BACK TO USER SPACE                                          01035001
*        SGSETUP RESETSCB,WR1=R4,WR2=R5                        @D52VDRP 01036001
         SGSETUP RESETSCB,WR1=R4,WR2=R5                        @D52VDRP 01037001
         L     R6,DISPAD          BASE OF DISPATCHER           @D52VDRP 01038001
*        AMODESW RETURN,REG=(R6)  ==========> YES, EXIT DISP.  @D52VDRP 01039001
         AMODESW RETURN,REG=(R6)  ==========> YES, EXIT DISP.  @D52VDRP 01040001
         SPACE 2                                               @D52VDVB 01041001
PMR100   DS    0H                                              @D52VDVB 01042001
         SLR   RC,RC              INDICATE; DO NOT POST PFTE   @D52VDVB 01043001
         CLC   TID,PMRTIDH        UNDER CONTROL OF PMR         @D66CDOW 01044001
         BE    PMR120             YES, ---------->             @D52VDVB 01045001
         BAL   R5,PMRHWERR        NO , ==========> ERROR COND. @D52VDVB 01046001
PMR120   DS    0H                                              @D52VDVB 01047001
*SGLINK  DEQUI,INPUT=(R7,R8,R9,RC),WORK=(R0-R6,RD-RF),                 *01048001
               OUTPUT=(RB)                                     @D52VDVB 01049001
         BAL   R7,DEQUI           DEQUEUE PAGE FAULT           @D52VDVB 01050001
         B     PMRIOEND           ---------->                  @D52VDVB 01051001
         SPACE 3                                                        01052001
*-------------------------------------------------------------*@D52VDVB 01053001
*  DO SPECIAL HANDLING FOR ERRONEOUS PAGE                      @D52GDRP 01054001
*  INPUT :                                                     @D52GDRP 01055001
*         RC - IORE (ADDR OF TIB)                              @D52GDRP 01056001
*-------------------------------------------------------------*@D52VDVB 01057001
         SPACE 1                                                        01058001
         USING TIBADR,RC                                       @KY30163 01059001
PMR200   DS    0H                                              @D52GDRP 01060001
         CLC   TID,PMRTIDH        RUNNING UNDER PMR            @D66CDOW 01061001
         BE    PMR100             YES, ------> EXIT DEQUI      @D52GDRP 01062001
         L     R6,DISPAD          BASE OF DISPATCHER           @D52GDRP 01063001
         USING DISP,R6                                         @D52GDRP 01064001
*   SWITCH BACK TO USER SPACE                                  @D52GDRP 01065001
*        SGSETUP RESETSCB,WR1=R4,WR2=R5                        @D52GDRP 01066001
         SGSETUP RESETSCB,WR1=R4,WR2=R5                        @D52GDRP 01067001
         L     RE,TIBTCB          ADDR OF TCB                  @D52GDWL 01068001
         USING TCBADR,RE                                       @D52GDRP 01069001
         L     RA,PFSCB           ADDR OF SCB                  @D52GDWL 01070001
         USING SCBADR,RA          SET BASE FOR SCB             @D52GDRP 01071001
         TM    SCBFLG,SCBDSP      DATA SPACE INVOLVED?         @D52GDWL 01072001
         BZ    PMR210             NO, BRANCH                   @D52GDRP 01073001
         TM    DSCBFLGS,DSCBVDSK  DATA SPACE FOR VIRTUAL DISK? @D52GDWL 01074001
         BZ    PMR214             NO, TRY TO CANCEL USER       @D52GDRP 01075001
         DROP  RA                 DROP BASE FOR SCBADR         @D52GDRP 01076001
         CLI   TCBRID,REENTRID    IS IT VDISK SERVICE          @D52GDRP 01077001
         BNE   PMR214             NO, TRY TO CANCEL USER       @D52GDRP 01078001
         L     RA,TCBSAV2         LOAD ADDR OF SAVE AREA       @D52GDWL 01079001
         USING SVEARA,RA          SET BASE FOR SAVE AREA       @D52GDWL 01080001
         NC    SVEPSW2,BIT0OMSK   MODIFY PSW WITH ADDR OF...   @D52GDWL 01081001
         OC    SVEPSW2,SVER06     ...VDISK ERROR ROUTINE IN R6 @D52GDWL 01082001
         SGCOV SGPMRDS,MC=0       DATA SPACE COVERAGE          @D52GDWL 01083001
         DROP  RA                 DROP BASE FOR SVEARA         @D52GDRP 01084001
*        AMODESW RETURN,REG=(R6)  ==========> EXIT DISPATCHER  @D52GDRP 01085001
         AMODESW RETURN,REG=(R6)  ==========> EXIT DISPATCHER  @D52GDRP 01086001
PMR210   DS    0H                                              @D52GDRP 01087001
         TM    PHOPGADR,USERPF    IS IT USER PAGE FAULT        @D52GDWL 01088001
         BO    PMR212             YES, --->                    @D64ADOW 01089001
         CLC   TID(2),ARTIDH      IS IT ATTENTION              @D52GDRP 01090001
         BE    ERR2A              YES, CANCEL IT               @D64ADOW 01091001
         B     PMR215             NO, HARDWAIT                 @D64ADOW 01092001
PMR212   L     R5,PHOPGADR        GET PAGE-FAULT ADDR ON PAGE..@D52GDRP 01093001
         N     R5,PADDRMSK        ... BOUNDARY, USER IND. OFF  @D52GDRP 01094001
         L     R4,TCBSAVE         GET END ADDR OF ...          @D52GDRP 01095001
         LA    R4,SVEEND-SVEARA(,R4) ... SAVE AREA +1          @D52GDRP 01096001
         CR    R4,R5              SAVE AREA IN ERRONEOUS PAGE  @D52GDRP 01097001
         BNH   PMR214             NO, BRANCH                   @D52GDRP 01098001
         AL    R5,PMPGSIZE        GET NEXT PAGE ADDR           @D52GDRP 01099001
         CL    R5,TCBSAVE         SAVE AREA IN ERRONEOUS PAGE  @D52GDRP 01100001
         BH    PMR215             YES, ------> HARD WAIT       @D52GDRP 01101001
PMR214   TM    TIBFLAG1,EOTINPR   END OF TASK IN PROCESS       @D52GDRP 01102001
         BZ    ERR2A              NO, CANCEL USER              @D64ADOW 01103001
*        BNZ   PMR215             YES, -----> HARDWAIT FF9     @D52GDRP 01104001
PMR215   BAL   R5,PAGHWTF9        =========> HARD WAIT FF9     @D52GDRP 01105001
         DROP  R6                 DROP BASE FOR DISP           @D52GDRP 01106001
         DROP  RC                 DROP BASE FOR TIBADR         @D52GDRP 01107001
         DROP  RE                 DROP BASE FOR TCBADR         @D52GDRP 01108001
         SPACE 2                                                        01109001
*    SET PFVTABE                                               @D52VDRP 01110001
*SGLINK  PMRIOVIO,S,INPUT=(R7,R8,R9,RC),WORK=(R4,R5,RA),AMODE=31 DATON  01111001
PMRIOVIO DS    0H                                              @D52VDVB 01112001
         USING TIBADR,RC                                       @D52GDRP 01113001
         MVI   PFVTABE,XFF        INDICATE NO VPOOL REQUEST    @D52GDRP 01114001
         TM    PGQTYP,PGBLK       BLOCKED PAGE I/O             @0000036 01115001
         BO    PMRIOVEX           YES, --------->              @0000036 01116001
         L     R4,TIBSTATE        ADDR(PFTE) FOR UNBL PGOUT    @D52VDVB 01117001
         TM    PGQTYP,PGO         PAGE-OUT                     @0000036 01118001
         BO    PMRIOV10           YES ---------->              @0000036 01119001
         L     R4,PGINF           ADDR(PFTE) FOR UNBL PGIN     @0000036 01120001
PMRIOV10 DS    0H                                              @0000036 01121001
*        AMODESW SET,DAT=OFF      SWITCH IN REAL MODE          @0000036 01122001
         AMODESW SET,DAT=OFF      SWITCH IN REAL MODE          @0000036 01123001
         USING PFTE,R4                                         @0000036 01124001
         SLR   R5,R5              GET ...                      @D52VDRP 01125001
         ICM   R5,M7,PFTEEPA#     ... EPA NUMBER               @D52VDRP 01126001
         SLL   R5,PNSHIFT         CONVERT TO EPA               @D52VDRP 01127001
         TM    S370FLG,PFTEBLK    ONLY BLOCK CONNECTED TO FRAME@D52VDRP 01128001
         BO    PMRIOVEX           YES, BRANCH                  @D52VDRP 01129001
         MVC   PMRSCB,PFTESCB     PROVIDE RELATED SCB ADDR     @D52VDRP 01130001
         BAL   RA,CHKVPOOL        CHECK FOR VPOOL, SET PFVTABE @D52VDRP 01131001
         DROP  R4                 DROP BASE FOR PFTE (REAL)    @D52VDRP 01132001
*SGLINK  CHKVPOOL,INPUT=(R5,RA),OUTPUT=(R5)                    @D52VDRP 01133001
         NOP   PMRIOVEX           PAGE NOT IN VPOOL            @D52VDRP 01134001
* ---->  B     PMRIOVEX           PAGE IN VPOOL                @D52VDRP 01135001
PMRIOVEX DS    0H                                              @D52VDRP 01136001
*        AMODESW SET,DAT=ON       SWITCH IN VIRTUAL MODE       @0000036 01137001
         AMODESW SET,DAT=ON       SWITCH IN VIRTUAL MODE       @0000036 01138001
         BR    R7                 ==========>    EXIT PMRIOVIO @D52VDVB 01139001
         DROP  RC                 DROP BASE FOR TIBADR         @D52GDRP 01140001
         EJECT                                                 @D149DVB 01141001
*-------------------------------------------------------------*@D149DVB 01142001
*        ROUTINE PROLOGUE                                      @D149DVB 01143001
*        ROUTINE NAME: DEQUI                                   @D149DVB 01144001
*        MACRO:        SGPMR                                   @D149DVB 01145001
*        FUNCTION:  DEQUEUES THE PAGE FAULT REQUEST FROM PGQUI @D149DVB 01146001
*                   AND SETS THE ASSOCIATED TASK DISPATCHABLE. @D149DVB 01147001
*        CALLED BY:                                            @D149DVB 01148001
*              PMR      AMODE(31),DATON                        @D529DRP 01149001
*        CALLED ROUTINES:                                      @D529DRP 01150001
*              POSTENT WITH AMODE(31),DATON                    @D529DRP 01151001
*              RPOST   WITH AMODE(31),DATON                    @D529DRP 01152001
*        ENTRY POINT:                                          @D149DVB 01153001
*                   DEQUI                                      @D149DVB 01154001
*        EXIT :                                                @D149DVB 01155001
*                   RETURN TO CALLER                           @D529DVB 01156001
*        ERROR EXIT: -                                         @D149DVB 01157001
*        INPUT:                                                @D149DVB 01158001
*                   R7  :  RETURN ADDRESS                      @D529DVB 01159001
*                   R8  :  ADDR PAGE MANAGEMENT DATA AREA      @D149DVB 01160001
*                   R9  :  BASE OF CODE                        @D529DVB 01161001
*                   RC  :  ADDRESS (PFTE BELONGING TO HANDLED PAGE)     01162001
*        OUTPUT:                                               @D149DVB 01163001
*                   RB  :  ADDRESS (DEVCB)                     @D59VDVB 01164001
*-------------------------------------------------------------*@D149DVB 01165001
*        OPERATION:                                            @D149DVB 01166001
*                                                              @D149DVB 01167001
*        IF TIDBYTE ¬= PMRTID     /*PAGEFAULT USER CONTROLLED*/@D149DVB 01168001
*         THEN RETURN WITH OFFSET 4                            @D149DVB 01169001
*         ELSE DO                                              @D149DVB 01170001
*           CALL RPOST(PFTE,SRQGIO) /*  POST WAITING TASKS   */@D149DVB 01171001
*           GET_ADDR(DEVCB)       /*    DEVCB ADDRESS        */@D149DVB 01172001
*           GET_ADDR(CLASS-PCB)   /*    CLASS-PCB ADDRESS    */@D149DVB 01173001
*           GET_ADDR(PAGE)        /*  ADDR OF HANDLED PAGE   */@D149DVB 01174001
*           IF PAGE_FAULT IN VPOOL /* BELONGS PAGE TO VPOOL  */@D149DVB 01175001
*             THEN GET_VTAB(PAGE_FAULT)  /*   VIOTAB ENTRY   */@D149DVB 01176001
*           DO WHILE PCB = USERPCB OR PCB = SYSTEMPCB        */@D149DVB 01177001
*             PF_ID := PCB.ID                                  @D149DVB 01178001
*             GET_TIB :=(PF_ID)   /*FIRST ELEMENT IN QUEUE   */@D149DVB 01179001
*             UNTIL TIB = 0 DO         /* ALL ELEMENTS PROC. */@D149DVB 01180001
*               TIB := IORE.TIBCHAIN                           @D149DVB 01181001
*               IF IORE.TIBSTATE=PAGE  /*WAITING ON THIS PAGE*/@D149DVB 01182001
*                  THEN DO                                     @D149DVB 01183001
*                    IF PAGE_FAULT IN VPOOL                    @D149DVB 01184001
*                       THEN DECREASE VTAB.VTPFCNT             @D149DVB 01185001
*                    CALL POSTENT(PREV.TIB,TIB,DEVCB,PAGE)   */@D149DVB 01186001
*                  END                                       */@D149DVB 01187001
*             END                      /*    DO UNTIL        */@D149DVB 01188001
*             IF PCB = SYSTEMPCB & PIK ¬= ATTNPIK              @D149DVB 01189001
*               THEN GET_PCB (PIK)     /*CLASS-PCB ADDR, PAGE*/@D149DVB 01190001
*                                      /* -FAULT BELONGS TO  */@D149DVB 01191001
*               ELSE PCB = NIL                                 @D149DVB 01192001
*           END                                                @D149DVB 01193001
*           RETURN WITH OFFSET 0       /* RETURN TO PMR LOOP */@D149DVB 01194001
*         END_IF                                               @D149DVB 01195001
*        END (DEQUI) ;                                         @D149DVB 01196001
*-------------------------------------------------------------*@D149DVB 01197001
*        INTERNAL REGISTER USAGE                                        01198001
*         R0 - WORK REGISTER                                   @D149DRP 01199001
*         R1 - WORK REGISTER                                   @D149DRP 01200001
*         R2 - ADDR OF NEXT TIB OR ZERO                        @D149DRP 01201001
*         R3 - ADDR OF PREVIOUS TIB IN CHAIN                   @D369DRP 01202001
*         R4 - WORK REGISTER                                   @D369DRP 01203001
*         R5 - WORK REGISTER                                   @D369DRP 01204001
*         R6 - ADDR OF DISP                                             01205001
*         R7 - LINK REGISTER                                   @D369DRP 01206001
*         RB - ADDR OF ACTUAL DEVCB                            @D149DRP 01207001
*         RC - ADDR OF CURRENT TIB IN CHAIN                    @D369DRP 01208001
*         RD - ADDR OF PAGE HANDLED                            @D369DRP 01209001
*         RE - WORK REGISTER                                   @D369DRP 01210001
*         RF - WORK REGISTER                                   @D369DRP 01211001
*                                                                       01212001
         SPACE 2                                                        01213001
*SGLINK  DEQUI,S,INPUT=(R7,R8,R9,RC),WORK=(R0-R6,RD-RF),               *01214001
               OUTPUT=(RB)                                     @D52VDVB 01215001
DEQUI    DS    0H                                              @D52VDVB 01216001
         STM   R7,RA,PMRSLEV0+OFR7                             @D52VDVB 01217001
         L     R6,DISPAD                                       @D52VDVB 01218001
         USING DISP,R6            SET DISPATCHER ADDRESSABLE   @D36IDFR 01219001
         LTR   R1,RC              GET PFTE ADDR TO BE POSTED   @D52VDVB 01220001
         BZ    DEQUI000           NO POST AT ALL, ---------->  @D52VDVB 01221001
         L     R5,ASRQTAB         GET ADDRESS OF ...           @D61RDRP 01222001
         LA    R5,SRQPGIO-SRQTAB(,R5) ... RESOURCE QUEUE       @D61RDRP 01223001
         BAL   RF,RPOST           POST TASKS WAITING FOR PFTE  @D36IDRP 01224001
*SGLINK  RPOST,INPUT=(R1,R5,R6,RF),WORK=(R5,RE)                @D369DRP 01225001
DEQUI000 DS    0H                                              @D52VDVB 01226001
         L     RB,PFDEVCB         GET DEVCB OF ACTUAL DEVICE   @D14BDRP 01227001
         USING DEVCB,RB                                        @D14BDRP 01228001
         L     R4,DEVPCB          GET ADDR OF ACTUAL CLASS-PCB @D14BDRP 01229001
         L     RD,PAGEADDR        LOAD EPA JUST READ           @D36IDFR 01230001
         B     DEQUI010                                        @D52VDVB 01231001
         SPACE 1                                               @D52VDVB 01232001
DEQUI005 DS    0H                                              @D52VDVB 01233001
*        GENSERV GETPCB,PIK=(R4),PCB=(R5) GET ADDR OF PCB IN R5@D61RDVB 01234001
         GENSERV GETPCB,PIK=(R4),PCB=(R5) GET ADDR OF PCB IN R5@D61RDVB 01235001
         USING PCBADR,R5                                       @D61RDVB 01236001
         L     R4,PCBACPCB        GET ADDR OF CLASS-PCB        @D51IDRP 01237001
         DROP  R5                                              @D61RDVB 01238001
DEQUI010 ST    R4,PFPCB           SAVE CLASS-PCB FOR POSTENT-RT@D52VDVB 01239001
         USING PCBADR,R4          SET BASE FOR CLASS-PCB       @D51IDRP 01240001
         LH    R4,PCBID           GET OFFSET                   @D51IDRP 01241001
         DROP  R4                                              @D51IDRP 01242001
         SLL   R4,3                          IN REQ. QUEUE     @D51IDRP 01243001
         LA    RC,PFRQBEG+TIBADR-TIBCHAIN(R4) 1ST ENTRY OF Q.  @D14BDRP 01244001
         USING TIBADR,RC                                       @D36IDFR 01245001
DEQUI020 LR    R3,RC              SETUP FOR DELENTR ROUTINE    @D36IDFR 01246001
         L     R2,TIBCHAIN        POINT TO NEXT ENTRY          @D14BDRP 01247001
DEQUI030 LTR   RC,R2              ALL ENTRIES PROCESSED?       @D14BDRP 01248001
         BZ    DEQUI050           YES,EXIT FROM LOOP           @D36IDFR 01249001
         C     RD,TIBSTATE        WAITING FOR THIS PAGE?       @D36IDFR 01250001
         BNE   DEQUI020           NO,GOTO TEST NEXT ENTRY      @D36IDFR 01251001
         CLC   TIBPFSCB,PFSCB     IS IT SAME SPACE             @D52VDRP 01252001
         BNE   DEQUI020           NO, GOTO TEST NEXT ENTRY     @D52VDRP 01253001
         LH    R4,TIBRPIK                                      @D14BDRP 01254001
         STH   R4,PARTPIK         SAVE PIK OF REQ. PARTITION   @D14BDRP 01255001
*    GENSERV   TEST,FIELD=PFVTABE,REG=(R4),BC=BNP,LAB=DEQUI040 @D52VDVB 01256001
     GENSERV   TEST,FIELD=PFVTABE,REG=(R4),BC=BNP,LAB=DEQUI040 @D52VDVB 01257001
         USING VTABE,R4                                        @D14BDRP 01258001
*        GENSERV DEC,FIELD=VTPFCNT,REG=(R0)                    @D52VDVB 01259001
         GENSERV DEC,FIELD=VTPFCNT,REG=(R0)                    @D52VDVB 01260001
         DROP  R4                                              @D14BDRP 01261001
DEQUI040 BAL   R7,POSTENT         POST REQUESTING TASK                  01262001
*SGLINK  POSTENT,INPUT=(R3,R6,R7,R8,R9,RB,RC),WORK=(R4,R5,RA,RD-RF),   *01263001
               OUTPUT=(R2)                                     @D52VDVB 01264001
         B     DEQUI030                                        @D36IDFR 01265001
         SPACE 1                                               @D14BDVB 01266001
DEQUI050 DS    0H                                              @D14BDRP 01267001
*    GENSERV   COMP,FIELD=ASYSPCB,REG=(R4),BC=BNE,LAB=DEQUIEXT,        *01268001
               COMPF=PFPCB                                     @D52VDVB 01269001
     GENSERV   COMP,FIELD=ASYSPCB,REG=(R4),BC=BNE,LAB=DEQUIEXT,        *01270001
               COMPF=PFPCB                                     @D52VDVB 01271001
*     GET REQ OF PARTITION TO WHICH PAGE-FAULT BELONGS         @D369DRP 01272001
*     GENSERV  TEST,FIELD=PARTPIK,REG=(R4),BC=BNZ,LAB=DEQUI005 @D52VDVB 01273001
      GENSERV  TEST,FIELD=PARTPIK,REG=(R4),BC=BNZ,LAB=DEQUI005 @D52VDVB 01274001
DEQUIEXT DS    0H                                              @D52VDRP 01275001
         LM    R7,RA,PMRSLEV0+OFR7 PROVIDE SAVED REGISTERS     @D52VDVB 01276001
         BR    R7                 ==========> EXIT DEQUI       @D52VDVB 01277001
         SPACE 1                                               @D52VDVB 01278001
         DROP  R6                 FORGET BASE OF DISPATCHER    @D36IDRP 01279001
         DROP  RB                 FORGET BASE FOR DEVCB        @D36IDRP 01280001
         DROP  RC                 FORGET BASE FOR TIB          @D36IDRP 01281001
         EJECT                                                          01282001
*-------------------------------------------------------------*@D149DVB 01283001
*        ROUTINE PROLOGUE                                      @D149DVB 01284001
*        ROUTINE NAME: POSTENT                                 @D149DVB 01285001
*        MACRO:        SGPMR                                   @D149DVB 01286001
*        FUNCTION: POSTS REQUESTING TASK, DOES PHO ACTIONS - IF@D149DVB 01287001
*                  NECESSARY - AND DELETES TIB FROM PGQUI      @D149DVB 01288001
*        CALLED BY:                                            @D149DVB 01289001
*              DEQUI WITH AMODE(31),DATON                      @D529DRP 01290001
*        CALLED ROUTINES:                                      @D529DRP 01291001
*              DELENTR,ENQENTR,EPACNVR2,RESPHO,IOPOST0,POST    @D529DRP 01292001
*                     WITH AMODE(31),DATON                     @D529DRP 01293001
*              PCGENENT, PHO-APP WITH AMODE(24),DATON          @D529DRP 01294001
*        ENTRY POINT: POSTENT                                  @D149DVB 01295001
*        EXIT :    RETURN TO CALLER WITH MODE OF CALLER        @D149DVB 01296001
*        ERROR EXIT: ERR2C WITH AMODE(24),DATON                @D149DVB 01297001
*        INPUT:                                                @D149DVB 01298001
*                  R3 - ADDR OF PREVIOUS TIB IN CHAIN          @D149DVB 01299001
*                  R6 - ADDR (DISPATCHER)                      @D149DVB 01300001
*                  R7 - RETURN ADDRESS                         @D149DVB 01301001
*                   R8  :  ADDR PAGE MANAGEMENT DATA AREA      @D149DVB 01302001
*                   R9  :  BASE OF CODE                        @D529DVB 01303001
*                  RB - ADDR OF DEVICE CONTROL BLOCK           @D149DVB 01304001
*                  RC - ADDR (TIB) BELONGING TO HANDLED PAGE-FAULT      01305001
*        OUTPUT:                                               @D149DVB 01306001
*                  R2 - ADDR OF NEXT TIB                       @D149DVB 01307001
*                       ... OR ZERO IF LAST TIB WAS DELETED    @D149DVB 01308001
*        REGISTERS PASSED: R3,R6,RB                            @D149DVB 01309001
*-------------------------------------------------------------*@D149DVB 01310001
*        OPERATION:                                            @D149DVB 01311001
*                                                              @D149DVB 01312001
*        SELECT (* TIB-TYPE *)                                 @D149DVB 01313001
*          WHEN (* VIO-REQ  *) DO                              @D149DVB 01314001
*            POST VIORB                                        @D149DVB 01315001
*            IF (*ERRONEOUS PAGE *) THEN SET APPROBRIATE INDIC.@D149DVB 01316001
*            IF ASYNCHR VIO-REQ                                @D149DVB 01317001
*              THEN DO                                         @D149DVB 01318001
*                IF REQUESTOR = POWER                          @D149DVB 01319001
*                  THEN POST POWER-S MAIN ECB                  @D149DVB 01320001
*                CALL IOPOST0(TIB(VIO-TASK))                   @D149DVB 01321001
*              END                                             @D149DVB 01322001
*              ELSE CALL POST(TIB(VIO-TASK))                   @D149DVB 01323001
*            CALL DELENTR(IORE,DEVCB)                          @D149DVB 01324001
*          END                                                 @D149DVB 01325001
*          WHEN (* PHO-REQ  *) DO                              @D149DVB 01326001
*            IF (* RESPHO WITH I/O ACTIVE *)                   @D149DVB 01327001
*              THEN DO                                         @D149DVB 01328001
*                CALL POST(TIB(PHO-TASK))                      @D149DVB 01329001
*                CALL DELENTR(IORE,DEVCB)                      @D149DVB 01330001
*              END                                             @D149DVB 01331001
*              ELSE DO                                         @D149DVB 01332001
*                CALL IOPOST0(PHO-TASK)                        @D149DVB 01333001
*                SETUP  PMR_TASK (OWNER=PHOTASK)               @D149DVB 01334001
*                RID := PFARID                                 @D149DVB 01335001
*                CALL PHO_APPENDAGE(PAGE FAULT ADDRESS)        @D149DVB 01336001
*                /* RUNS IN AMODE=24 IN USER ADDRESS SPACE   */@D529DVB 01337001
*                RID := USERID                                 @D149DVB 01338001
*                IF (* MORE PAGE FAULT TO BE PROCESSED *)      @D149DVB 01339001
*                  THEN DO                                     @D149DVB 01340001
*                    VERIFY(SCB,SPACE-NR,PAGEFAULT)            @D529DVB 01341001
*                    CALL EPACNVR2(PAGE-FAULT-ADDRESS,EPA)     @D529DVB 01342001
*                  END                                         @D149DVB 01343001
*                CALL DELENTR(IORE,DEVCB)                      @D149DVB 01344001
*                IF (* MORE PAGE FAULT TO BE PROCESSED *)      @D149DVB 01345001
*                  THEN CALL ENQUENTR(EPA,SCB)                 @D149DVB 01346001
*                SETUP  PMR_TASK (OWNER=SYSTEM)                @D149DVB 01347001
*                /* RUNS IN AMODE=31 IN PMR ADDRESS SPACE    */@D529DVB 01348001
*              END                                             @D149DVB 01349001
*          END                                                 @D149DVB 01350001
*          OTHERWISE DO                                        @D149DVB 01351001
*            CALL POST(TIB(PF-TASK))                           @D149DVB 01352001
*            CALL DELENTR(IORE,DEVCB)                          @D149DVB 01353001
*          END                                                 @D149DVB 01354001
*        END-SELECT                                            @D149DVB 01355001
*        END(POSTENT)                                          @D149DVB 01356001
*-------------------------------------------------------------*@D149DVB 01357001
*        INTERNAL REGISTER USAGE                                        01358001
*         R2 - WORK REGISTER                                   @D149DRP 01359001
*         R3 - ADDR OF PREVIOUS TIB IN CHAIN                   @D369DRP 01360001
*         R4 - WORK REGISTER                                   @D369DRP 01361001
*         R5 - WORK REGISTER                                   @D369DRP 01362001
*         R6 - ADDR OF DISP.                                            01363001
*         R7 - RETURN ADDR                                     @D369DRP 01364001
*         RA - LINK REGISTER TO NEXT LEVEL                     @D369DRP 01365001
*         RB - ADDR OF ACTUAL DEVICE CONTROL BLOCK             @D14BDRP 01366001
*         RC - ADDR OF CURRENT TIB IN CHAIN, BELONGING TO      @D369DRP 01367001
*              HANDLED PAGE-FAULT                              @D369DRP 01368001
*         RD - ADDR OF PAGE HANDLED                            @D369DRP 01369001
*         RE - WORK REGISTER                                   @D149DRP 01370001
*         RF - WORK REGISTER                                   @D149DRP 01371001
*                                                                       01372001
         SPACE 1                                                        01373001
         USING DISP,R6                                         @D52VDVB 01374001
         USING TIBADR,RC                                       @D36IDFR 01375001
POSTENT  DS    0H                                              @D36IDFG 01376001
*SGLINK  POSTENT,S,INPUT=(R3,R6,R7,R8,R9,RB,RC),WORK=(R4,R5,RA,RD-RF), *01377001
               OUTPUT=(R2)                                     @D52VDVB 01378001
.*  INPUT FOR THE FOLLOWING SDAID MONITOR CALL:                @D149DRP 01379001
.*      RC - ADDR OF TIB BELONGING TO HANDLED PAGE-FAULT       @D149DRP 01380001
.*      RD - ADDR OF HANDLED PAGE (NOW IN STORAGE)             @D149DRP 01381001
.*       MC    $TRPAG2,$MCSDAID   PAGEHDL EVENT SDAID                   01382001
         TM    TIBFLAG1,PHOIND    IF NOT A PHO/VIO TIB         @D36IDRP 01383001
         BZ    POSTTSK            BRANCH                       @D36IDFR 01384001
         TM    TIBFLAG1,VIOREQ    IS IT REQ. FROM VIOPOINT     @D14BDRP 01385001
         BZ    POSTPHO            NO, BRANCH                   @D14BDRP 01386001
         LR    R5,RC                                           @D14BDRP 01387001
         SH    R5,VIOTIBOF        GET ADDR OF VIOTAB-ENTRY     @D14BDRP 01388001
         USING VIOTABE,R5                                      @D14BDRP 01389001
         OI    VIORBCM1,VIORBTRB  POST VIORB                   @D14BDRP 01390001
         L     R4,VTABEACT        GET ACTIVE VTAB ENTRY OF PAGE@D52GDRP 01391001
         USING VTABE,R4                                        @D52GDRP 01392001
         TM    VTFLG,VTPAGERR     ERRONEOUS PAGE               @D52GDRP 01393001
         BNO   POSTVIO1           NO, BRANCH                   @D52GDRP 01394001
         DROP  R4                 DROP BASE FOR VTABE          @D52GDRP 01395001
         MVI   VIORBRTC,VIORBERR  INDICATE PAGE I/O ERROR OCC. @D14BDRP 01396001
POSTVIO1 LH    R8,TIBRTID         GET TID OF VIO-TASK          @D14BDRP 01397001
         DROP  R8                 FORGET BASE FOR DATA AREA    @D36IDRP 01398001
         TM    VIOFLAG,ASYNCH     IS IT ASYNCHR. REQ.          @D14BDRP 01399001
         BNO   POSTVIO2           NO,  POST TASK FROM PAGE BND @D14BDRP 01400001
         L     RF,APOWTB          ADDRESS TO POWER COMM. AREA  @DA35279 01401001
         LTR   RF,RF              POWER ACTIVE ?               @DA35279 01402001
         BZ    PSTVIO1A           NO  ===>                     @DA35279 01403001
         USING PADS,RF                                         @DA35279 01404001
         CH    R8,CATI            POWER OWNER OF THIS REQUEST? @DA35279 01405001
         BNE   PSTVIO1A           NO  ===>                     @DA35279 01406001
         OI    PAEB+2,TRABIT      POST POWER MASTER ECB        @DA35279 01407001
         DROP  RF                                              @DA35279 01408001
PSTVIO1A EQU   *                                               @DA35279 01409001
         BAL   RF,IOPOST0         READY TASK IF I/O BOUND      @D14BDRP 01410001
*SGLINK  IOPOST0,INPUT=(R6,R8,RF),WORK=(R8,RE)                 @D14BDRP 01411001
         B     POSTDEL            DELETE VIOTIB FROM QUEUE     @D14BDRP 01412001
POSTVIO2 SLL   R8,2                                            @D66CDOW 01413001
         AL    R8,ATIBATAB                                     @D66CDOW 01414001
         L     R8,0(,R8)          GET TIB OF VIO TASK          @D66CDOW 01415001
         B     POSTTSK1           POST TASK                    @D14BDRP 01416001
         DROP  R5                 FORGET BASE FOR VIOTABE      @D14BDRP 01417001
         SPACE 1                                                        01418001
         USING PMGMDATA,R8                                     @D14BDRP 01419001
POSTPHO  STM   R3,RC,PMRSLEV1     SAVE REGS USED BY PHO        @D52VDVB 01420001
         LH    R8,TIBRTID         GET TID OF PHO-TASK          @D14BDRP 01421001
         DROP  R8                 DROP BASE FOR DATA AREA      @D14BDRP 01422001
         TM    TIBFLAG1,PHOREQ    NORMAL REQUEST               @KY30133 01423001
         BO    POSTPHO1           YES, BRANCH                  @KY30133 01424001
*    NO, RESPHO WITH I/O ACTIVE, POST TASK OWNING PHO          @KY30133 01425001
         MVC   TIBRTID,H0         COMPLETE RESPHO FUNCTION     @D66CDOW 01426001
         SLL   R8,2                                            @D66CDOW 01427001
         AL    R8,ATIBATAB                                     @D66CDOW 01428001
         L     R8,0(,R8)          GET TIB OF PHO TASK          @D66CDOW 01429001
         BAL   RF,POST            SET PHO TASK DISPATCHABLE    @KY30133 01430001
*SGLINK  POST,INPUT=(R6,R8,RF),WORK=(RE)                       @KY30133 01431001
         B     POSTDEL            DELETE PHO TIB AND RETURN    @KY30133 01432001
POSTPHO1 LR    R4,R8              SAVE TID FOR SGSETUP         @D14BDRP 01433001
         BAL   RF,IOPOST0         POST TASK IF I/O BOUND       @D36IDRP 01434001
*SGLINK  IOPOST0,INPUT=(R6,R8,RF),WORK=(R8,RE)                 @D369DRP 01435001
*     SET PHO-TASK AS OWNER                                    @D149DRP 01436001
         SGSETUP SWOWNER,STASK=PMR,WR1=R4,WR2=R5,                      *01437001
               OPTION=SETOWNER                                 @D14BDRP 01438001
         L     R8,TIBPFAPP        GET ADDR OF APPENDAGE RTN    @D36IDRP 01439001
         L     RD,TIBUSPHO        PHO EXTERNAL FORMAT OF               *01440001
                                  .... PAGE FAULT ADDRESS      @DA35398 01441001
         ICM   R4,15,TIBPFARA     AREA SPECIFIED IN SETPFA?    @D52GDWL 01442001
         BZ    PHONOA             NO, OLD R13 INTERFACE        @D52GDWL 01443001
         USING PFAAREA,R4         SET BASE FOR SETPFA AREA     @D52GDWL 01444001
         ST    RD,PFAADR          STORE ADDR OF PF IN AREA     @D52GDWL 01445001
         XC    PFARES,PFARES      CLEAR RESERVED FIELD         @KX41342 01446001
         L     R5,TIBPFSCB        ADDR OF SCB BELONGING TO PF  @D52GDWL 01447001
         USING SCBADR,R5                                       @KX41342 01448001
         TM    SCBFLG,SCBDSP      PF RELATED TO A DATA SPACE   @KX41342 01449001
         BZ    POSTPHO2           NO ---- >                    @KX41342 01450001
         MVC   PFASTKN(8),DSCBSTKN SET TOKEN OF DATA SPACE     @KX41342 01451001
         B     PHONOA             -----> INVOKE PHO APPENDAGE  @KX41342 01452001
POSTPHO2 STCM  R5,12,PFASCB1      STORE 1ST PART OF SCB ADDR   @KX41342 01453001
         STCM  R5,3,PFASCB2       STORE 2ND PART OF SCB ADDR   @KX41342 01454001
         STCM  RC,15,PFATIB       A(TIB) - ARBITRARY VALUE ... @D52GDWL 01455001
*                                 ...TO FORM A SECRETIVE TOKEN @D52GDWL 01456001
         DROP  R4                 RELEASE AREA                 @D52GDWL 01457001
         DROP  R5                 DROP BASE FOR SCBADR         @KX41342 01458001
PHONOA   MVI   RID+D1,PFARID      SET RID FOR PHO APPENDAGE             01459001
*                                 ROUTINE                               01460001
         DROP  R9                 DROP BASE FOR CODE           @D52VDRP 01461001
*        AMODESW CALL,AMODE=24,ADDRESS=D4(R8),REGS=(R7,R7)     @D52VDRP 01462001
*                                 PAGE FAULT APPENDAGE ROUTINE @D52VDRP 01463001
         AMODESW CALL,AMODE=24,ADDRESS=D4(R8),REGS=(R7,R7)     @D52VDRP 01464001
*                                                              @D52GDWL 01465001
*        RETURN FROM PAGE FAULT APPENDIX ROUTINE               @D52GDWL 01466001
*                                                              @D52GDWL 01467001
PHOCHK1  DS    0H                                              @D52GDWL 01468001
         L     R8,APMGMDAT        RESTORE BASE REGISTER FOR DATA        01469001
         USING PMGMDATA,R8        RESET BASE FOR DATA AREA     @D36IDRP 01470001
         LM    R3,RC,PMRSLEV1     RESET REGISTERS USED BY PHO  @D52VDVB 01471001
         USING PMRADR,R9          RESET BASE FOR CODE AREA     @D52VDRP 01472001
*        AMODESW SET,AMODE=31,WR=(R4)   SET 31 BIT MODE        @D52VDRP 01473001
         AMODESW SET,AMODE=31,WR=(R4)                          @D52VDRP 01474001
         ICM   R5,15,TIBPFARA     AREA SPECIFIED IN SETPFA?    @D52GDWL 01475001
         BZ    PHOOLD             NO, OLD R13 INTERFACE        @D52GDWL 01476001
         SLR   RD,RD              INDICATE NO PF ...           @KY30133 01477001
         ST    RD,PGINF           ...            TO BE HANDLED @KY30133 01478001
         USING PFAAREA,R5         SET BASE FOR SETPFA AREA     @D52GDWL 01479001
         OC    0(L'PFAENT,R5),0(R5) TEST IF A PF ENTRY IS RET. @KX41342 01480001
         MVI   RID+D1,USERTID     RESET RID, IN CASE OF BRANCH @D52GDWL 01481001
         BZ    PHOADOK            NO ---->                     @D52GDWL 01482001
         MVI   RID+D1,PFARID      RESET RID FOR FURTHER CHECK  @D52GDWL 01483001
         MVI   PGINF,X'FF'        INDICATE PF TO BE HANDLED    @KY30133 01484001
         L     RD,PFAADR          RETURNED ADDR OF PF          @D52GDWL 01485001
         ICM   R4,12,PFASCB1      GET 1ST PART OF SCB ADRR     @KX41342 01486001
         ICM   R4,3,PFASCB2       GET 2ND PART OF SCB ADRR     @KX41342 01487001
         DROP  R5                 RELEASE AREA                 @D52GDWL 01488001
         LA    RE,SCBLNG-1(R4)    LAST BYTE OF SCB             @D52GDWL 01489001
*                                                              @D52GDWL 01490001
         L     R5,IJBSMCOM        SM COMMUNIC. AREA            @D52GDWL 01491001
         USING SMCOM,R5           SET BASE FOR SM COMM. AREA   @D52GDWL 01492001
         C     RE,SMCSUPND        IS ADDR IN SUPERVISOR AREA   @D52GDWL 01493001
         BNH   PHOOK              YES, ADDRESS SEEMS O.K.      @D52GDWL 01494001
         C     R4,SMCSVA          IS ADDR IN SVA24 ?           @D52GDWL 01495001
         BNH   INVPAR             NO, ADDRESS INVALID          @D52GDWL 01496001
         C     RE,SMCESVA         REALLY IN SVA24 ?            @D52GDWL 01497001
         BNH   PHOOK              YES                          @D52GDWL 01498001
         C     R4,SMCSVA31        IS ADDR IN SVA31 ?           @D52GDWL 01499001
         BNH   INVPAR             NO, ADDRESS INVALID          @D52GDWL 01500001
         C     RE,SMCESV31        REALLY IN SVA31 ?            @D52GDWL 01501001
         BH    INVPAR             NO, ADDRESS INVALID          @D52GDWL 01502001
         DROP  R5                 RELEASE SM COMM AREA         @D52GDWL 01503001
         USING SCBADR,R4          R4 IS BASE FOR SCB           @D52GDWL 01504001
         LR    R5,R4              CHECK IF SCB DOES ...        @D52GDWL 01505001
         N     R5,PMPTEMSK        ... NOT                      @D52GDWL 01506001
         AL    R5,PAGESIZE        ... CROSS                    @D52GDWL 01507001
         CR    RE,R5              ... A PAGE BOUNDARY          @D52GDWL 01508001
         BH    INVPAR             RETURNED SCB ADDR INVALID    @D52GDWL 01509001
PHOOK    DS    0H                                              @D52VDRP 01510001
         CLC   SCBEYEC,EYESCB     EYECATCHER O.K.?             @D52GDWL 01511001
         BNE   INVPAR             NO, CANCEL                   @D52GDWL 01512001
PHOCHK2  DS    0H                 THE RETURNED SCB ADDR IS O.K.@D52GDWL 01513001
         MVI   RID+D1,USERTID     RESET RID                             01514001
         ST    RD,TIBUSPHO        STORE RETURNED PF ADDR IN TIB@D52GDWL 01515001
         TM    SCBFLG,SCBDSP      PF RELATED TO A DATA SPACE?  @D52GDWL 01516001
         BZ    PHOAD1             NO                           @D52GDWL 01517001
         L     R5,SCBCUSZ         SIZE OF DATA SPACE IN K      @D52GDWL 01518001
         SLL   R5,10              SIZE OF DATA SPACE IN BYTES  @D52GDWL 01519001
         BCTR  R5,0               HIGHEST DATA SPACE ADDRESS   @D52GDWL 01520001
         CR    RD,R5              ADDRESS WITHIN DATA SPACE?   @D52GDWL 01521001
         BH    INVPAR             NO, GO RESET PHO CAPABILITY  @D52GDWL 01522001
         DROP  R4                 RELEASE SCB                  @D52GDWL 01523001
         SGCOV SGPMRD,MC=1        DATA SPACE COVERAGE          @D52GDWL 01524001
         B     PHOAD1                                          @D52GDWL 01525001
*                                                              @D52GDWL 01526001
PHOOLD   MVI   RID+D1,USERTID     RESET RID                    @D52GDWL 01527001
         ST    RD,TIBUSPHO        SAVE PHO EXTERNAL FORMAT OF          *01528001
                                  .... PAGE FAULT ADDRESS      @KY30133 01529001
         ST    RD,PGINF           SET IND. FOR NEW REQUEST     @KY30133 01530001
         LTR   RD,RD              IF NO OTHER PAGE FAULT TO BE          01531001
         BZ    PHOADOK            PROC. FOR THAT TASK, BRANCH  @D36IDFR 01532001
         L     R4,F255                                         @DA35398 01533001
         NR    R4,RD              GET SPACE NUMBER             @DA35398 01534001
         L     R5,ASIDSTR                                      @D218DKH 01535001
         USING SIDSTR,R5                                       @D218DKH 01536001
         CLM   R4,1,SIDM3         CHECK IF SPACE NR VALID      @D218DKH 01537001
         DROP  R5                                              @D218DKH 01538001
         BH    INVPAR             NO ----->  ERROR             @DA35398 01539001
         ALR   R4,R4                                           @DA35398 01540001
         ALR   R4,R4              OFFSET OF RELATED SCB ...    @DA35398 01541001
         LA    R4,SCBATABP-SCBATAB(,R4)  ... IN SCBATAB        @D51IDRP 01542001
         AL    R4,ASCBATAB        POINT TO SCB ADDR IN SCBATAB @D51IDRP 01543001
         L     R4,0(,R4)          GET ADDRESS OF SCB           @DA35398 01544001
         LTR   R4,R4              SCB AVAILABLE                @D52VDRP 01545001
         BZ    INVPAR             NO, CANCEL PHO OWNER         @D52VDRP 01546001
         USING SCBADR,R4                                       @D51GDRP 01547001
PHOAD1   CLC   SCBVSTO,F0         ADDRESS/DATA SPACE AVAILABLE?@D51GDRP 01548001
         BE    INVPAR             NO, CANCEL PHO OWNER         @D51GDRP 01549001
         ST    R4,TIBPFSCB        SET SCB BELONGING TO EPA     @D52VDRP 01550001
*   CHECK WHETHER PAGE BELONGS TO VALID SEGMENT                @D52VDRP 01551001
         LR    R5,RD                                           @D52VDRP 01552001
         N     R5,EPADRMSK        GET ..                       @D52VDRP 01553001
         SRL   R5,SNSHIFT         .. SEGMENT INDEX             @D52VDRP 01554001
         C     R5,PMSEG#          IS SEGMENT INDEX VALID       @D52VDRP 01555001
         BNL   INVPAR             NO, CANCEL PHO OWNER         @D52VDRP 01556001
         SLL   R5,SNSTESH         GET OFFSET IN SEGMENT TABLE  @D52VDRP 01557001
         L     RE,SCBRSTO         GET REAL                     @D52VDRP 01558001
         N     RE,PMCR1MSK        ... ADDRESS                  @D52VDRP 01559001
         AR    R5,RE              ... OF STE                   @D52VDRP 01560001
*        AMODESW SET,DAT=OFF      ENTER REAL MODE              @D52VDRP 01561001
         AMODESW SET,DAT=OFF      ENTER REAL MODE              @D52VDRP 01562001
         USING STE,R5                                          @D52VDRP 01563001
         TM    STEFLG,STEINV      SEGMENT ENTRY INVALID        @D52VDRP 01564001
*        AMODESW SET,DAT=ON       . ENTER VIRTUAL MODE AGAIN   @D52VDRP 01565001
         AMODESW SET,DAT=ON       . ENTER VIRTUAL MODE AGAIN   @D52VDRP 01566001
         BO    INVPAR             YES, CANCEL PHO OWNER        @D52VDRP 01567001
         DROP  R5                 DROP BASE FOR STE            @D52VDRP 01568001
         BAL   RE,EPACNVR2        CONVERT PAGE FAULT ADDRESS ....      *01569001
                                  .... INTO EPA FORMAT         @D51KDRP 01570001
*SGLINK  EPACNVR2,INPUT=(R4,R8,RD,RE),WORK=(R5),OUTPUT=(RD)    @D51GDRP 01571001
         DROP  R4                 DROP SCBADR BASE             @D51GDRP 01572001
PHOADOK  DS    0H                                              @D52VDVB 01573001
         L     R9,APMRSERV        GET BASE ...                 @D52VDVB 01574001
         USING PMRSERV,R9         ... FOR SERVICES             @D52VDVB 01575001
*SGLINK  DELENTR,INPUT=(R3,R8,RA,RB,RC),WORK=(R4,R5),OUTPUT=(R2),      *01576001
               NOMODR=(R6-R1,R3),AMODE=31 DATON                         01577001
         BAL   RA,DELENTR         DELETE PHOTIB FROM DEV. QUEUE@D14BDRP 01578001
         L     R9,APMRADR         RESET BASE                   @D52VDVB 01579001
         USING PMRADR,R9                                       @D52VDVB 01580001
         ICM   RA,15,PGINF        OTHER PAGE-FAULT TO BE PROC. @KY30133 01581001
         BNZ   PHOADOK1           YES, BRANCH                  @D14NDFG 01582001
         NI    TIBFLAG1,XFF-PHOREQ IND. NO PHO REQUEST IN QUEUE@D36IDRP 01583001
         B     PHOADOK2           SKIP ENQUEUEING              @D14NDFG 01584001
         SPACE 1                                                        01585001
PHOADOK1 L     RE,PFPCB           GET CLASS-PCB ADDR FOR ENQENT@D14NDFG 01586001
         L     R9,APMRSERV        GET BASE ...                 @D52VDVB 01587001
         USING PMRSERV,R9         ... FOR SERVICES             @D52VDVB 01588001
*SGLINK  ENQENTR,INPUT=(R7,R9,RC,RD,RE),WORK=(R3-R5,RD),               *01589001
               NOMODR=(RE-R2,R6-RA,RC),AMODE=31,OUTPUT=(RB) DATON       01590001
         BAL   R7,ENQENTR         ENQUEUE TIB FOR CORR. DEVICE @D14BDRP 01591001
         L     R9,APMRADR         RESET BASE                   @D52VDVB 01592001
         USING PMRADR,R9                                       @D52VDVB 01593001
PHOADOK2 LM    R3,RB,PMRSLEV1     RESTORE REGISTERS            @D52VDVB 01594001
*     RESET SYSTEM AS OWNER                                    @D149DRP 01595001
*     SGSETUP SWOWNER,STASK=PMR,WR1=R4,WR2=R5,OPTION=SYSOWNER  @D52VDVB 01596001
         SGSETUP SWOWNER,STASK=PMR,WR1=R4,WR2=R5,                      *01597001
               OPTION=SYSOWNER                                 @D14BDRP 01598001
         L     RD,PAGEADDR        LOAD EPA JUST READ           @D36IDFR 01599001
         BR    R7                 ==========>  EXIT POSTENT    @D149DVB 01600001
         SPACE 2                                                        01601001
INVPAR   LR    R2,RD              SAVE PF INFO                 @D52GDWL 01602001
         SR    RD,RD              INPUT FOR RESPHO             @D52GDWL 01603001
         L     R7,ARESPHO                                      @D52GDWL 01604001
*        AMODESW CALL,REGS=(R7,R7)  RESET PHO CAPABILITY       @D52GDWL 01605001
         AMODESW CALL,REGS=(R7,R7)  RESET PHO CAPABILITY       @D52GDWL 01606001
         B     INVPAR10           OFFSET 0 FROM RESPHO         @D52GDWL 01607001
         BAL   R5,PMRHWERR        OFFSET 4 FROM RESPHO         @D52GDWL 01608001
INVPAR10 LR    RD,R2              RELOAD PF INFO               @D52GDWL 01609001
         STM   R9,RD,ERA          SAVE REGISTERS FOR PCGENENT  @D36IDRP 01610001
         L     RD,AFLIH           GET BASE FOR PCGENENT        @D36IDRP 01611001
         USING FLIH,RD                                         @D36IDRP 01612001
*        AMODESW CALL,AMODE=24,ADDRESS=PCGENENT,REGS=(R9,R9)   @D52VDRP 01613001
         AMODESW CALL,AMODE=24,ADDRESS=PCGENENT,REGS=(R9,R9)   @D52VDRP 01614001
*SGLINK  PCGENENT,INPUT=(R9,RD),OUTPUT=(R6,RA),WORK=(RB,RC)    @D369DRP 01615001
         DROP  RD                                              @D36IDRP 01616001
*        AMODESW BRANCH,AMODE=24,ADDRESS=ERR2C,REG=(RB)                *01617001
                                  INV. PARAMETER PASSED BY PHO @D52VDRP 01618001
         AMODESW BRANCH,AMODE=24,ADDRESS=ERR2C,REG=(RB)        @D52VDRP 01619001
         SPACE 2                                                        01620001
POSTTSK  LR    R8,RC              GET TIB POINTER OF REQUESTOR @D36IDRP 01621001
POSTTSK1 BAL   RF,POST            SET TASK DISPATCHABLE        @D36IDFG 01622001
*SGLINK  POST,INPUT=(R6,R8,RF),WORK=(RE)                       @D369DRP 01623001
POSTDEL  L     R8,APMGMDAT        RESTORE BASE OF PMR DATA     @D36IDRP 01624001
         L     R9,APMRSERV        GET BASE ...                 @D52VDVB 01625001
         USING PMRSERV,R9         ... FOR SERVICES             @D52VDVB 01626001
*SGLINK  DELENTR,INPUT=(R3,R8,RA,RB,RC),WORK=(R4,R5),OUTPUT=(R2),      *01627001
               NOMODR=(R6-R1,R3),AMODE=31 DATON                         01628001
         BAL   RA,DELENTR         DELETE TIB FROM DEV. QUEUE   @D14BDRP 01629001
         L     R9,APMRADR         RESET BASE                   @D52VDVB 01630001
         USING PMRADR,R9                                       @D52VDVB 01631001
         BR    R7                 ==========>                  @D149DVB 01632001
         DROP  R6,RC              FORGET BASE FOR DISP, TIB    @D36IDRP 01633001
         SPACE 1                                               @D14ZDVB 01634001
*-------------------------------------------------------------*@D149DVB 01635001
         TITLE 'VSE/AF SUPERVISOR     SGPMR     PAGE MANAGER (PMR-TASK,*01636001
                SELECTPG ROUTINE)'                             @D14ZDRP 01637001
*-------------------------------------------------------------*         01638001
*        ROUTINE PROLOGUE                                               01639001
*        ROUTINE NAME= SELECTPG                                         01640001
*        MACRO=        SGPMR                                            01641001
*        FUNCTION= FREES ONE PAGE FRAME. IF THE 1ST P ENTRIES IN PSQ    01642001
*                  WITH R-BIT ZERO DON'T HAVE THE C-BIT ZERO TOO,       01643001
*                  PRE-PAGE-OUT IS INITIATED SO THAT Q ENTRIES GET THE  01644001
*                  STATE (0,0)  (P<Q).                                  01645001
*        CALLED BY: PMR WITH AMODE(31),DATON                            01646001
*        CALLED ROUTINES:                                      @D529DRP 01647001
*              ENQUOBLK,ENQUOUNC,PAGDISCA,PMRREMOV,PMRINSBT,   @D529DRP 01648001
*              SCDELPGO,SRTABB   WITH AMODE(31),DATOFF         @D529DRP 01649001
*        ENTRY POINT:  SELECTPG                                @D529DRP 01650001
*        EXIT:                                                 @D529DRP 01651001
*              CALLER WITH AMODE(31),DATON                     @D529DRP 01652001
*        ENTRY CONDITION: NONE                                          01653001
*        INPUT:                                                         01654001
*                  R7  - RETURN ADDRESS                                 01655001
*                  R8  - PAGEMANAGER DATA SECTION                       01656001
*                  R9  - BASE REGISTER OF PMR MAIN ROUTINE     @D529DVB 01657001
*                  PSQ - PAGE SELECTION QUEUE ( PFTES )                 01658001
*                  IPFQ- INVALID PAGE FRAME QUEUE                       01659001
*        OUTPUT:                                                        01660001
*                  RB  - ADDR(DEVCB)                                    01661001
*                  RC  - ADDR(SELECTED PFTE)                            01662001
*                  PE  - ADDR(PAGE FRAME)                               01663001
*---------------------------------------------------------------------* 01664001
*    OPERATION:                                                         01665001
*                                                                       01666001
*       IF IPFQ ¬= <>                                                   01667001
*        THEN DO                                                        01668001
*           REMOVE FIRST PFTE FROM IPFQ                                 01669001
*           RETURN (OFFSET 8,DEVCB)                                     01670001
*          END                                                          01671001
*       SELECTION ALGORITHM:                                            01672001
*        SCNSEL = MIN(SCANCUR,NPSQE/2) /*   DEPTH  OF SCAN           */ 01673001
*        RESET LOCAL VARIABLES (SELCTFLG,CNT1,PSQPTR)                   01674001
*        PFTE = HEAD(PSQ)          /* GET FIRST PFTE                 */ 01675001
*        IF TIDBYTE ¬= PMRTID      /* PAGE FAULT HANDL. DONE BY USER */ 01676001
*          THEN DO                                                      01677001
*           IF PFTE->PF.R_BIT=ON | PFTE->PF.C_BIT=ON | PFTE.POABIT=ON   01678001
*              THEN                         /*ENQUEUE REQUEST FOR PMR*/ 01679001
*                 RETURN(OFFSET 4,DEVCB)                                01680001
*              ELSE DO                                                  01681001
*                PSQRPTR = ADDR(PFTE) /* CURRENT PFTE REPLACABLE     */ 01682001
*                SELCTFLG = REPLFND + NEWSTRT                           01683001
*              END                                                      01684001
*          END                                                          01685001
*        DO WHILE CNT1 < SCANSEL AND TAIL(PSQ) = <>                     01686001
*           PFTE = HEAD(PSQ)        /*  GET NEXT PFTE FROM PSQ       */ 01687001
*           RESET REF_BIT (PFTE->PF)                                    01688001
*           SELECT (PFTE->PF.REF_BIT,PFTE->PF.C_BIT CONDITION BEFORE    01689001
*                           RESET_REF_BIT)                              01690001
*             WHEN (1,0) DO                                             01691001
*               IF PFTE.POABIT = ON                                     01692001
*                 THEN GOTO SELECT55                                    01693001
*                 ELSE GOTO SELECT20                                    01694001
*             END                                                       01695001
*             WHEN (1,1) DO                                             01696001
*        SELECT20:                                                      01697001
*               CALL SCDELPGO             /*RESET POSL RECLAIMED PAGE*/ 01698001
*               PSQ = TAIL(PSQ) || HEAD (PSQ) /*  PFTE AT END OF PSQ */ 01699001
*               GOTO SELECT65                                           01700001
*             END                                                       01701001
*             WHEN (0,1) DO                                             01702001
*               IF PFTE.POABIT = OFF                                    01703001
*                 THEN DO                                               01704001
*                   IF IF SELCTFLG /= NEWSTRT                           01705001
*                     THEN SELCTFLG = NEWSTRT                           01706001
*                   PSQRPTR = ADDR(PFTE) /*CURRENT PFTE IS REPLACABLE*/ 01707001
*                   CALL ENQUOBL(PFTE)   /* ENQ. PFTE FOR PREPAGEOUT */ 01708001
*                 END                                                   01709001
*             END                                                       01710001
*             WHEN (0,0) DO                                             01711001
*        SELECT40:                                                      01712001
*               IF SELCTFLG ¬= NEWSTART+REPLFND                         01713001
*                 THEN DO                                               01714001
*                  IF SELCTFLG /= NEWSTART & SELCTFLG /= REPLFND        01715001
*                    THEN SELCTFLG = NEWSTRT                            01716001
*                  IF PFTE.POABIT = OFF                                 01717001
*                    THEN DO                                            01718001
*                      PSQRPTR = ADDR(PFTE) /*CURRENT PFTE REPLACABLE*/ 01719001
*                      SELCTFLG = REPLFND                               01720001
*                    END                                                01721001
*                 END                                                   01722001
*             END                                                       01723001
*           END SELECT;                                                 01724001
*        SELECT55: INCREASE CNT1                                        01725001
*        SELECT60: GET_NEXT(PFTE,PSQ) /* CONSIDER NEXT PFTE          */ 01726001
*        SELECT65:                                                      01727001
*        END DO-WHILE                                                   01728001
*       REPLACEMENT ALGORITHM:                                          01729001
*        IF PSQRPTR = 0                                              */ 01730001
*          THEN DO                    /* WAIT ON PAGE-OUT COMPLETE   */ 01731001
*            PMRFLAG=PMRIOWT          /* WAIT ON PAGE-OUT COMPLETE   */ 01732001
*            RETURN(OFFSET 0,DEVCB)                                     01733001
*          END                                                          01734001
*          ELSE DO                                                      01735001
*           PSQ = PSQ - PSQRPTR->PFTE /* REMOVE PFTE FROM PSQ        */ 01736001
*           IF PFTE NOT BLOCK_CONNECTED                                 01737001
*             THEN SET BIT IN RTAB                                      01738001
*           IF SELCTFLG=REPLFND       /*  (0,0) ENTRY FOUND          */ 01739001
*             THEN DO                                                   01740001
*                CALL PAGDISCA(PFTE)  /*  DISCONNECT RELATED PAGE    */ 01741001
*                RETURN(OFFSET 8,DEVCB)                                 01742001
*             END                                                       01743001
*             ELSE DO                                                   01744001
*                CALL ENQUOUNC(PFTE)                                    01745001
*                RETURN(OFFSET 0,DEVCB)                                 01746001
*             END                                                       01747001
*          END                                                          01748001
*---------------------------------------------------------------------* 01749001
*                                                                       01750001
*        REGISTERS PASSED: R1,R2,R6                            @D369DRP 01751001
*                                                                       01752001
*        INTERNAL USAGE OF REGISTERS                                    01753001
*              R3 - ADDR OF PTE BELONGING TO RD                @D35CDAA 01754001
*              R4 - WORK REGISTER                              @D369DRP 01755001
*              R5 - WORKREGISTER                                        01756001
*              R7 - RETURN ADDR                                         01757001
*              RA - LINK REGISTER TO 2ND LEVEL                          01758001
*              RB - ADDR OF PSQ-HEADER                                  01759001
*              RC - ADDR OF PFTE UNDER INVESTIGATION                    01760001
*              RD - ADDR OF PAGE BELONGING TO RC                        01761001
*              RE - ADDR OF CORRESPONDING PF                   @D35CDAA 01762001
*-------------------------------------------------------------*         01763001
         SPACE 1                                                        01764001
*SGLINK  SELECTPG,S,INPUT=(R7:LINK,R8:APMGMDA,R9:BASE),                *01765001
               WORK=(R0,R3,R4,R5,RA),                                  *01766001
               OUTPUT=(RB:DEVCB,RC:PFTE,RE:PF)                 @D52VDVB 01767001
SELECTPG DS    0H                                              @D14NDVB 01768001
*        AMODESW SET,DAT=OFF      ENTER REAL MODE              @D52VDRP 01769001
         AMODESW SET,DAT=OFF      ENTER REAL MODE              @D52VDRP 01770001
         L     RE,IPFQPTR         GET ADDR OF IPF-QUEUE                 01771001
         USING PFTE,RE                                                  01772001
         L     RC,PFTEFPTR        GET 1ST IPFQ-ENTRY                    01773001
         C     RC,IPFQPTR         IPFQ EMPTY                   @D35CDAA 01774001
         DROP  RE                                                       01775001
         BE    SELECT00           YES, BRANCH                  @D35CDAA 01776001
         LR    RE,RC                                                    01777001
         S     RE,APFT            OFFSET IN PFT                @D35CDAA 01778001
         SLL   RE,PFSHIFT         RE= ADDR OF PF               @D35CDAA 01779001
         BAL   RA,PMRREMOV        REMOVE PFTE FROM IPFQ        @D35CDAA 01780001
         LA    R7,PMRSELND-PMRSELBG(,R7)                       @D52VDVB 01781001
         B     SELECTEX           ---------->                  @D52VDVB 01782001
         SPACE 1                                                        01783001
SELECT00 DS    0H                                              @D35CDAA 01784001
         TM    IJBFLG08,IJBNOPDS  SYSTEM WITH PDS              @D61BDRP 01785001
         BZ    SELECT0A           YES, ALL O.K.                @D61BDRP 01786001
         BAL   R5,PMRHWERR        NO, HARDWAIT                 @D61BDRP 01787001
SELECT0A DS    0H                                              @D61BDRP 01788001
         SPACE 1                                                        01789001
*    DETERMNINE ACTUAL SEARCHING DEPTH                         @KD40096 01790001
         SPACE 1                                                        01791001
*      GENSERV GETF,FIELD=SCANCUR,REG=(R0)                     @KD40096 01792001
       GENSERV GETF,FIELD=SCANCUR,REG=(R0)                     @KD40096 01793001
*      GENSERV GETF,FIELD=NPSQE,REG=(RC)                       @KD40096 01794001
       GENSERV GETF,FIELD=NPSQE,REG=(RC)                       @KD40096 01795001
         SRL   RC,1               NPSQE/2                      @KD40096 01796001
         CLR   R0,RC              SCANCUR <= NPSQE/2           @KD40096 01797001
         BNH   SELECT0B           YES ---------->              @KD40096 01798001
         LR    R0,RC              SEARCHING DEPTH NPSQE/2      @KD40096 01799001
SELECT0B DS    0H                                              @KD40096 01800001
*      GENSERV PUTF,FIELD=SCANSEL,REG=(R0)                     @KD40096 01801001
       GENSERV PUTF,FIELD=SCANSEL,REG=(R0)                     @KD40096 01802001
         SPACE 1                                                        01803001
         SLR   R0,R0                                           @D51GDRP 01804001
         ST    R0,CNT1            RESET CNT1                   @D51GDRP 01805001
         ST    R0,PSQRPTR         RESET PSQRPTR                @D52VDVB 01806001
         MVI   SELCTFLG,X00       INITIALIZE SELCTFLG          @D14NDVB 01807001
         L     RB,PSQPTR          GET ADDR OF PSQ-HEADER                01808001
         LR    RC,RB                                                    01809001
         USING PFTE,RC                                                  01810001
         L     RC,PFTEFPTR        GET 1ST  PSQ-ENTRY                    01811001
         CLC   TID,PMRTIDH        UNDER CONTROL OF USER        @D66CDOW 01812001
         AIF   (NOT &LOLEV1).NOLOL2A                           @D52VDVB 01813001
         BE    SELECT05           NO, DO NORMAL PAGE SELECTION @D52VDVB 01814001
         AGO   .NOLOL2B                                        @D52VDVB 01815001
.NOLOL2A ANOP                                                  @D52VDVB 01816001
         BE    SELECT12           NO, DO NORMAL PAGE SELECTION @KXA1851 01817001
.NOLOL2B ANOP                                                  @D52VDVB 01818001
         SPACE 1                                                        01819001
*    TRY TO HANDLE PAGE FAULT WITHOUT I/O                               01820001
         SPACE 1                                                        01821001
         LR    RE,RC              GET PFTE ADDRESS             @D35CDAA 01822001
         S     RE,APFT            OFFSET IN PFT                @D35CDAA 01823001
         SLL   RE,PFSHIFT         RE= PAGEFRAME ADDRESS        @D35CDAA 01824001
         L     R9,APMRSERV        GET BASE ADDR FOR SUBRTN     @KXA1851 01825001
         USING PMRSERV,R9         SET BASE FOR SUBROUTINE      @KXA1851 01826001
         BAL   RA,PAGIPTE         SET PAGE TO DISCONNECTED     @KXA1851 01827001
*SGLINK  PAGIPTE,INPUT=(R8,R9,RA,RC),WORK=(R4,R5,RF),                  *01828001
               AMODE=31 DATOFF                                          01829001
         L     R9,APMRADR         RESTORE BASE FOR CODE AREA   @KXA1851 01830001
         USING PMRADR,R9          RESET BASE FOR CODE AREA     @KXA1851 01831001
         ISKE  R5,RE              INSERT STORAGE KEY EXTENDED  @D51GDTP 01832001
         N     R5,RCBITON         ARE R- AND C-BIT OFF         @D14BDRP 01833001
         BNZ   SELECT01           NO,  ---------->             @D52VDRP 01834001
         TM    PFTEFLG,POABIT     PAGE-OUT ACTIVE              @D14BDRP 01835001
         BZ    SELECT45           NO , ---------->             @D52VDRP 01836001
SELECT01 DS    0H                 1ST OF PSQ IS NOT AVAILABLE FOR      *01837001
                                  ...PAGE REPLACEMENT          @D52VDVB 01838001
         L     R9,APMRSERV        GET BASE ADDR FOR SUBRTN     @KXA1851 01839001
         USING PMRSERV,R9         SET BASE FOR SUBROUTINE      @KXA1851 01840001
         BAL   RA,PAGADDR         UNSELECTED PAGE ADDRESSABLE  @KXA1851 01841001
*SGLINK  PAGADDR,INPUT=(R8,R9,RA),WORK=(R4,R5)                         *01842001
               AMODE=31 DATOFF                                          01843001
         L     R9,APMRADR         RESTORE BASE FOR CODE AREA   @KXA1851 01844001
         USING PMRADR,R9          RESET BASE FOR CODE AREA     @KXA1851 01845001
         LA    R7,PMRSELI2-PMRSELBG(,R7)                       @D52VDRP 01846001
         B     SELECTEX           ---------->                  @D52VDVB 01847001
         SPACE 1                                                        01848001
*-------------------------------------------------------------*         01849001
*              SCAN OF PSQ                                    *         01850001
*-------------------------------------------------------------*         01851001
         AIF   (NOT &LOLEV1).NOLOL21                                    01852001
SELECT05 DS    0H                                              @D14BDRP 01853001
         L     R5,PSELCTR         S                                     01854001
         LA    R5,1(R5)           S   COUNT NUMBER OF PAGE-             01855001
         ST    R5,PSELCTR         S   SELECTIONS                        01856001
         CLC   NPSQE,SWCON        S                                     01857001
         BH    SELECT07           S                                     01858001
         L     R5,NPSELLOW        S   COUNT NUMBER OF TIMES             01859001
         LA    R5,1(R5)           S   PAGE-POOL IS NOT GREATER          01860001
         ST    R5,NPSELLOW        S   THAN SWCON                        01861001
SELECT07 DS    0H                                                       01862001
         B     SELECT12                                                 01863001
.NOLOL21 ANOP                                                           01864001
SELECT10 DS    0H                                              @D35CDAA 01865001
         L     R9,APMRSERV        GET BASE ADDR FOR SUBRTN     @KXA1851 01866001
         USING PMRSERV,R9         SET BASE FOR SUBROUTINE      @KXA1851 01867001
         BAL   RA,PAGADDR         UNSELECTED PAGE ADDRESSABLE  @KXA1851 01868001
*SGLINK  PAGADDR,INPUT=(R8,R9,RA),WORK=(R4,R5)                         *01869001
               AMODE=31 DATOFF                                          01870001
         L     R9,APMRADR         RESTORE BASE FOR CODE AREA   @KXA1851 01871001
         USING PMRADR,R9          RESET BASE FOR CODE AREA     @KXA1851 01872001
SELECT12 DS    0H                                              @KXA1851 01873001
         LR    RE,RC              GET PFTE ADDRESS             @D35CDAA 01874001
         S     RE,APFT            OFFSET IN PFT                @D35CDAA 01875001
         SLL   RE,PFSHIFT         RE= PAGEFRAME ADDRESS        @D35CDAA 01876001
         L     R9,APMRSERV        GET BASE ADDR FOR SUBRTN     @KXA1851 01877001
         USING PMRSERV,R9         SET BASE FOR SUBROUTINE      @KXA1851 01878001
         BAL   RA,PAGIPTE         SET PAGE TO DISCONNECTED     @KXA1851 01879001
*SGLINK  PAGIPTE,INPUT=(R8,R9,RA,RC),WORK=(R4,R5,RF),                  *01880001
               AMODE=31 DATOFF                                          01881001
         L     R9,APMRADR         RESTORE BASE FOR CODE AREA   @KXA1851 01882001
         USING PMRADR,R9          RESET BASE FOR CODE AREA     @KXA1851 01883001
         RRBE  0,RE               RESET REFERENCE BIT - TEST RC@D51GDTP 01884001
         BC    8,SELECT40         BRANCH IF R=0,C=0 BEFORE              01885001
         BC    4,SELECT30         BRANCH IF R=0,C=1 BEFORE              01886001
         BC    1,SELECT20         BRANCH IF R=1,C=1 BEFORE              01887001
* -----> BC    2,SELECT15         BRANCH IF R=1,C=0 BEFORE     @D52VDVB 01888001
*                                                                       01889001
*        HANDLING OF R=1, C=0                                           01890001
*                                                                       01891001
SELECT15 DS    0H                                              @DA35638 01892001
         TM    PFTEFLG,POABIT     PAGE-OUT ACTIVE FOR THIS PFTE         01893001
         BO    SELECT55           YES,                                 *01894001
                                  DON'T USE IT FOR REPLACEMENT @D52VDVB 01895001
SELECT20 DS    0H                                                       01896001
*        HANDLING OF R=1                                                01897001
         AIF   (NOT &LOLEV1).NOLOL3                                     01898001
         TM    PFTEFLG3,RCLBIT     S    IS THIS RECLAIMING              01899001
         BZ    SELECT22            S    NO, BRANCH                      01900001
         L     R5,RECLAIM          S    INCREASE RECLAIM-COUNT          01901001
         LA    R5,1(R5)            S    BY 1                            01902001
         ST    R5,RECLAIM          S                                    01903001
         NI    PFTEFLG3,XFF-RCLBIT S    SET RECLAIM OFF                 01904001
SELECT22 DS    0H                  S                                    01905001
.NOLOL3  ANOP                                                           01906001
*     RESET POSLSTATE OF RECLAIMED PAGE RESPECTIVELY           @D52VDVB 01907001
*     AND - IF NECESSARY DELETE IORE FROM PGQO                 @KD40234 01908001
         L     RA,ASCNPGQO                                     @KD40234 01909001
         BALR  RA,RA              GET ADDRESS OF POSLSTATE     @D52VDVB 01910001
*SGLINK SCDELPGO,INPUT=(R8,RA,RC),NOMODR=(R0-RF),AMODE=31 DATOFF        01911001
         L     R0,PFTEFPTR        NEXT PFTE TO BE HANDLED               01912001
         BAL   RA,PMRREMOV        REMOVE OLD PFTE FROM PSQ              01913001
         BAL   RA,PMRINSBT        INSERT OLD PFTE ON BOTTOM OF PSQ      01914001
         LR    RC,R0              GET ADDR OF NEXT PFTE TO BE HANDL.    01915001
         B     SELECT65           BRANCH TO TEST FOR END OF SCAN        01916001
*                                                                       01917001
*        HANDLING OF R=0, C=1                                           01918001
*                                                                       01919001
SELECT30 DS    0H                                                       01920001
         TM    PFTEFLG,POABIT     PRE-PAGE-OUT STILL ACTIVE    @D52VDVB 01921001
         BO    SELECT60           YES, --------->  DON'T USE PFTE      *01922001
                                  ... FOR REPLACEMENT          @KX40135 01923001
         TM    SELCTFLG,NEWSTRT   NEW START OF PSQ ALREADY FOUND        01924001
         BO    SELECT35           YES, BRANCH                           01925001
         OI    SELCTFLG,NEWSTRT                                @D52VDVB 01926001
         OI    PFTEFLG3,CURSELCT  CURRENT SELECTION            @KXA1851 01927001
         ST    RC,PSQRPTR         SAVE ADDR(PFTE) TO BE REPLACED       *01928001
                                  ... COUNT IT AS (0,0)        @D52VDVB 01929001
SELECT35 DS    0H                                              @D52VDVB 01930001
         TM    PFTEFLG3,POSLISON  POSL.PSLSTATE SET FOR PAGE   @KX41010 01931001
         BO    SELECT55           YES, ---------->             @KX41010 01932001
         STM   R0,RF,PMRSVDBG     SAVE ALL REGISTERS           @KD40295 01933001
         LM    R0,R7,PFTEPNR      GET PFTE IN REGISTERS 0-7    @KD40295 01934001
         L     RF,PMRDCBON        INDICATE CHANGE BIT ON       @KD40295 01935001
         DEBUG ALLREGS,XXDBGMC    * CREATE DEBUG ENTRY         @KD40295 01936001
         LM    R0,RF,PMRSVDBG     RESTORE REGISTERS            @KD40295 01937001
         L     RA,AENQUOBL        GET ADDR OF ENQUOBLK RTN     @D61RDRP 01938001
         BALR  RA,RA              ENQUEUE PFTE IN PGQUO        @D52VDVB 01939001
*SGLINK  ENQUOBLK,INPUT=(R8,RA,RC),NOMODR=(R0-RF),                     *01940001
               AMODE=31 DATOFF                                 @D61RDRP 01941001
*    NOTE: R9 WILL BE SAVED AND RESTORED BY ENQUOBLK           @D61RDRP 01942001
         B     SELECT55           PGQUO ENTRY FREE             @D52VDVB 01943001
         B     SELECT70                                        @KXA1851 01944001
*                                                                       01945001
*        HANDLING OF R=0, C=0                                           01946001
*                                                                       01947001
SELECT40 TM    SELCTFLG,NEWSTRT   NEWSTART FOUND               @KXA1851 01948001
         BO    SELECT55           YES, BRANCH                           01949001
SELECT45 OI    SELCTFLG,NEWSTRT                                @D52VDVB 01950001
         OI    PFTEFLG3,CURSELCT  CURRENT SELECTION            @KXA1851 01951001
         ST    RC,PSQRPTR         SAVE ADDR OF SELECTED PFTE   @D52VDVB 01952001
         TM    PFTEFLG,POABIT     PAGE-OUT ACTIVE FOR THIS PFTE         01953001
         BO    SELECT55           YES, HANDLE AS (0,1) IN PGQO          01954001
         OI    SELCTFLG,REPLFND   INDICATE (0,0) ELEMENT FOUND          01955001
SELECT55 EQU   *                                                        01956001
         AIF   (NOT &LOLEV1).NOLOL4                                     01957001
         OI    PFTEFLG3,RCLBIT    S   INDICATE IN AVAILABLE STATE       01958001
.NOLOL4  ANOP                                                           01959001
*        CHECK FOR END OF SCAN                                          01960001
*      GENSERV INCOMP,FIELD=CNT1,REG=(R0),BC=BNL,LAB=SELECT70,         *01961001
               COMPF=SCANSEL                                   @D52VDVB 01962001
       GENSERV INCOMP,FIELD=CNT1,REG=(R0),BC=BNL,LAB=SELECT70,         *01963001
               COMPF=SCANSEL                                   @D52VDVB 01964001
SELECT60 L     RC,PFTEFPTR        GET NEXT ENTRY               @KX40135 01965001
SELECT65 CR    RC,RB              END OF PSQ REACHED           @D36ZDRP 01966001
         BNE   SELECT10           NO, CONTINUE WITH THIS ELEMENT        01967001
         SPACE 1                                                        01968001
*-------------------------------------------------------------*         01969001
*        END OF SCAN REACHED                                  *         01970001
*-------------------------------------------------------------*         01971001
SELECT70 DS    0H                                                       01972001
         L     R9,APMRSERV        GET BASE ADDR FOR SUBRTN     @KXA1851 01973001
         USING PMRSERV,R9         SET BASE FOR SUBROUTINE      @KXA1851 01974001
         BAL   RA,PAGADDR         UNSELECTED PAGE ADDRESSABLE  @KXA1851 01975001
*SGLINK  PAGADDR,INPUT=(R8,R9,RA),WORK=(R4,R5)                         *01976001
               AMODE=31 DATOFF                                          01977001
         L     R9,APMRADR         RESTORE BASE FOR CODE AREA   @KXA1851 01978001
         USING PMRADR,R9          RESET BASE FOR CODE AREA     @KXA1851 01979001
         L     RC,PSQRPTR         GET ADDR OF PFTE TO BE REPLACED       01980001
         LTR   RC,RC              PFTE AVAILABLE FOR REPLACEM. @D52VDVB 01981001
         BNZ   SELECT80           YES, ---------->             @D52VDVB 01982001
         OI    PMRFLAG,PMRIOWT    INDICATE WAITING ON PAGE-OUT @KX40135 01983001
         SGCOV SGPMRS,MC=0        *** SPECIAL ***              @D52VDVB 01984001
         LA    R7,PMRSELIO-PMRSELBG(,R7) RETURN: DEACTIVATE PMR@D52VDRP 01985001
         B     SELECTEX           ---------->                  @KX40135 01986001
SELECT80 DS    0H                                              @D52VDVB 01987001
         BAL   RA,PMRREMOV        REMOVE PFTE FROM PSQ                  01988001
         L     RD,PFTEPNR         CONVERT EPA-NR / BLOCK-NR             01989001
.*       N     RD,PAGNMASK        ... (CURRENTLY NO NEEDS)     @D14NDFG 01990001
         SLL   RD,PNSHIFT         ... TO EPA                   @D51GDRP 01991001
         LR    RE,RC              CALCULATE PF ADDR            @D35CDAA 01992001
         S     RE,APFT                                         @D35CDAA 01993001
         SLL   RE,PFSHIFT         RE= PAGE-FRAME-ADDRESS       @D35CDAA 01994001
         TM    S370FLG,PFTEBLK    ONLY BLOCK CONNECTED         @D14BDRP 01995001
         BO    SELECT85           YES, BRANCH                  @D14BDRP 01996001
         L     R9,APMRSERV        PROVIDE ...                  @D52VDVB 01997001
         USING PMRSERV,R9         .... ADDRESSABILITY          @D52VDVB 01998001
         BAL   RA,SRTABB          SET BIT IN RTAB                       01999001
         L     R9,APMRADR         RESET   ...                  @D52VDVB 02000001
         USING PMRADR,R9          .... ADDRESSABILITY          @D52VDVB 02001001
SELECT85 TM    SELCTFLG,REPLFND   (0,0) ENTRY FOUND                     02002001
         BNO   SELECT90           NO,  BRANCH                  @D14BDRP 02003001
         AIF   (NOT &LOLEV1).NOLOL51                           @D14BDRP 02004001
         NI    PFTEFLG3,XFF-RCLBIT-USPGBIT S RESET BITS FOR    @D14BDRP 02005001
*                                 RECLAIMING AND USELESS PG-OUT@D149DRP 02006001
.NOLOL51 ANOP                                                  @D14BDRP 02007001
         L     R9,APMRSERV        GET BASE ADDR FOR SUBRTN     @D51GDRP 02008001
         USING PMRSERV,R9         SET BASE FOR SUBROUTINE      @D51GDRP 02009001
         BAL   RA,PAGDISCA        SET PAGE TO DISCONNECTED     @D14BDRP 02010001
*SGLINK  PAGDISCA,INPUT=(R8,R9,RA,RC,RD,RE),WORK=(R4,R5,RF),           *02011001
               AMODE=31 DATOFF                                          02012001
         L     R9,APMRADR         RESTORE BASE FOR CODE AREA   @D51GDRP 02013001
         USING PMRADR,R9          RESET BASE FOR CODE AREA     @D51GDRP 02014001
         LA    R7,PMRSELND-PMRSELBG(,R7)  RETURN NORMAL        @D52VDVB 02015001
         B     SELECTEX           ---------->                  @D52VDVB 02016001
         SPACE 1                                               @D14NDVB 02017001
SELECT90 DS    0H                                              @D14BDRP 02018001
         AIF   (NOT &LOLEV1).NOLOL5                                     02019001
*        GENSERV INC,FIELD=POICTR,REG=(R0)                     @D52VDVB 02020001
         GENSERV INC,FIELD=POICTR,REG=(R0)                     @D52VDVB 02021001
.NOLOL5  ANOP                                                           02022001
         L     RA,AENQUOUN        GET ENTRY POINT ADDRESS      @D61RDRP 02023001
         BALR  RA,RA              REQUEST UNCOND. PAGE-OUT     @D61RDRP 02024001
*SGLINK  ENQUOUNC,INPUT=(R8,RA,RC,RD,RE),AMODE=31,                     *02025001
               NOMODR=(R3,R7-RA,RD-RF) DATOFF                           02026001
*    NOTE: R9 WILL BE SAVED AND RESTORED BY ENQUOUNC           @D61RDRP 02027001
*        AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @D52VDRP 02028001
         AMODESW SET,DAT=ON                                    @D52VDRP 02029001
         L     R5,PFPGQE          GET ACTUAL REQ. ELEMENT      @D14BDRP 02030001
         USING TIBADR,R5                                       @D14BDRP 02031001
         MVI   PGQTYP,PGNCNT      INDICATE NO COUNTING REQ.    @D14BDRP 02032001
         DROP  R5                                              @D14BDRP 02033001
         LA    R7,PMRSELIO-PMRSELBG(,R7) HANDLE OTHER REQ. 1ST @D52VDRP 02034001
         SPACE 1                                                        02035001
SELECTEX DS    0H                                              @D52VDVB 02036001
*        AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @D52VDRP 02037001
         AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @D52VDRP 02038001
         L     RB,PFDEVCB         GET ACTUAL DEVCB             @D52VDVB 02039001
         BR    R7                 ==========>   EXIT SELECTPG  @D52VDVB 02040001
         DROP  RC                 FORGET BASE FOR PFTE                  02041001
         DROP  R9                 DROP BASE FOR CODE AREA      @D61RDRP 02042001
         TITLE 'VSE/AF SUPERVISOR     SGPMR     PAGE MANAGER (ENQUEUE R*02043001
               OUTINE FOR PAGE-OUT)'                           @D52VDVB 02044001
*-------------------------------------------------------------*@D529DVB 02045001
*   SPECIAL SERVICES ROUTINES:                                 @D61RDRP 02046001
*     ENQUEUE ROUTINES FOR PAGEOUT                             @D61RDRP 02047001
*        MACRO:        SGPMR                                   @D61RDRP 02048001
*        BASE :        PMRSSRV                                 @D61RDRP 02049001
*        BASE ADDRESS: APMRSSRV                                @D61RDRP 02050001
*-------------------------------------------------------------*@D61RDRP 02051001
         SPACE 2                                                        02052001
PMRSSRV  DS    0H                 BASE ADDRESS OF SPECIAL PAGE-MANAGER *02053001
                                  SERVICE ROUTINES             @D61RDRP 02054001
         SPACE 1                                                        02055001
*-------------------------------------------------------------*@D529DVB 02056001
*        ROUTINE PROLOGUE                                      @D529DVB 02057001
*        ROUTINE NAME:  ENQUOBLK                               @D529DVB 02058001
*        MACRO:         SGPMR                                  @D529DVB 02059001
*        FUNCTION: VERIFIES WHETHER BLOCKED PRE-PAGE-OUT CAN   @D529DVB 02060001
*                  BE DONE FOR A PAGE SET WHERE THE PAGE P     @D529DVB 02061001
*                  BELONGS TO.                                 @D529DVB 02062001
*                  WHENEVER POSSIBLE IT INITIATES BLOCKED      @D529DVB 02063001
*                  PRE-PAGE-OUT                                @D529DVB 02064001
*        ENTRY POINT:                                          @D529DVB 02065001
*           ENQUOBLK CALLED BY SELECTPG WITH AMODE(31),DATOFF  @D529DVB 02066001
*        INPUT:                                                @D529DVB 02067001
*           R8 - ADDR OF PAGEMANAGEMENT DATA-AREA (PMGMDATA)   @D529DVB 02068001
*           RA - RETURN ADDR                                   @D529DVB 02069001
*           RC - ADDR(PFTE) OF PAGE TO BE CONSIDERED           @D529DVD 02070001
*        OUTPUT:                                               @D529DVB 02071001
*           POSL.POSLSTATE(PFTE(PAGE)) = ON                    @D52VDVB 02072001
*           ADDITIONAL, IF BLOCKED PRE-PAGE-OUT IS INITIATED:  @D52VDVB 02073001
*           BLOCKED PRE PAGE OUT POSSIBLE:                     @D529DVB 02074001
*             TIB/IORE (PFTE(PAGE)) IS ENQUEUED IN PGQUO       @D529DVB 02075001
*             PGQTYP  - (PGQO+PGBLK)                           @D529DVB 02076001
*             TIBSTATE- ADDR (POSL.POSLSTATE(PAGE))            @D529DVB 02077001
*                                                              @D529DVB 02078001
*        DATA= PGQUO(READ,WRITE)                               @D529DVB 02079001
*               PFTEFLG(WRITE)                                 @D529DVB 02080001
*                                                              @D529DVB 02081001
*        EXIT NORMAL:                                          @D529DVB 02082001
*           RETURN TO CALLER (31 BIT ADDRESSING MODE / DATOFF) @D529DVB 02083001
*           RETURN CODE IN RF;                                 @D529DVB 02084001
*           0 - NO PGQUO ENTRY FREE                            @D61RDRP 02085001
*           4 - PGQUO ENTRY FREE                               @D61RDRP 02086001
*                                                              @D529DVB 02087001
*        EXIT ERROR:                                           @D529DVB 02088001
*           N/A                                                @D529DVB 02089001
*-------------------------------------------------------------*@D529DVB 02090001
*        OPERATION:                                            @D529DVB 02091001
*          ENQUOBL (RC : IN ADDRESS(PFTE) )                    @D529DVB 02092001
*          CALL GETDVCB(PFTE) /* GET ADDR OF RELATED DEVCB   */@D529DVB 02093001
*          CALL PFTEPOSL(SET,PFTE) /*   POSLSTATE ON         */@D529DVB 02094001
*          IF PFTE = BLOCK_CONNECTED | PMR SAPCE | VPOOL       @D529DVB 02095001
*            THEN RETURN (OFFSET 4)                            @D52VDVB 02096001
*          IF BLOCKED PRE PAGE OUT POSSIBLE                    @D529DVB 02097001
*            THEN DO                                           @D529DVB 02098001
*              CALL SCNPGOBL(POSLSTATE,DEVCB,TIB)              @D529DVB 02099001
*              IF NOT YET ENQUEUED IN PGQUO                    @D529DVB 02100001
*                THEN DO                                       @D529DVB 02101001
*                   CALL GETPGQO                               @D529DVB 02102001
*                   IORE.PGQTYP = OR(PGO&PGBLK)                @D529DVB 02103001
*                   IORE.TIBSTATE = 0                          @D529DVB 02104001
*                   IORE.TIBAALU = ADDRESS(POSL.PSLSTATE)      @D529DVB 02105001
*                   CALL ENQENTR2(TIB,DVCB)                    @D529DVB 02106001
*                   /* ENQUEUE POSL INTO PGQUO               */@D529DVB 02107001
*                END                                           @D529DVB 02108001
*                ELSE                                          @D529DVB 02109001
*            END                                               @D529DVB 02110001
*          RETURN (OFFSET 0)                                   @D529DVB 02111001
*-------------------------------------------------------------*@D529DVB 02112001
*        INVARIANT REGISTERS: R0 - RE                          @D529DVB 02113001
*                                                              @D529DVB 02114001
*        INTERNAL USAGE OF REGISTERS                           @D529DVB 02115001
*              R0 - WORKREGISTER                               @D529DVB 02116001
*              R4 - WORKREGISTER                               @D529DVB 02117001
*              R5 - ADDR OF PAGE-OUT REQUEST ELEMENT (TIB)     @D529DVB 02118001
*              RA - RETURN ADDR                                @D529DVB 02119001
*              RB - ADDR OF DEVCB TO WHICH THE PAGE BELONGS    @D529DVB 02120001
*              RC - ADDR OF PFTE                               @D52VDVB 02121001
*              RD - WORK REGISTER                              @D52VDVB 02122001
*-------------------------------------------------------------*@D529DVB 02123001
         SPACE 1                                                        02124001
*SGLINK  ENQUOBLK,S,INPUT=(R8,RA,RC),NOMODR=(R0-RE),                   *02125001
               NOMODR=(R0-RF),AMODE=31 DATOFF                  @D61RDRP 02126001
ENQUOBLK DS    0H                                              @D52VDVB 02127001
         STM   R7,R6,PMRSLEV1+OFR7 SAVE CALLERS REGISTER       @D52VDVB 02128001
*     RC ADDRESSES PFTE                                        @D52VDVB 02129001
         USING PFTE,RC                                         @D52VDVB 02130001
         L     R9,APMRSERV        PROVIDE...                   @D52VDVB 02131001
         USING PMRSERV,R9         ... ADDRESSABILITY           @D52VDVB 02132001
         BAL   R4,GETDVCBF        GET CORRECT DEVICE CONTR. BL.@D52VDVB 02133001
*SGLINK  GETDVCBF,INPUT=(R4,R8,R9,RC),OUTPUT=(RB),AMODE=31,            *02134001
               NOMODR=(RC-R2,R4,R6-RA) DATOFF                           02135001
         L     R9,APMRSSRV        PROVIDE..                    @D61RDRP 02136001
         USING PMRSSRV,R9         ... ADDRESSABILITY FOR ENQUO @D61RDRP 02137001
         LA    R0,4(,0)           REQUEST: POSLSTATE = ON      @D52VDVB 02138001
         L     RA,APFTPOSL                                     @D52VDVB 02139001
*SGLINK  PFTEPOSL,INPUT=(R0,R8,RA,RC),OUTPUT=(R0,R4,R5,R6,R7),         *02140001
               NOMODR=(R1-R3,R8-RF),AMODE=31 ANY,DATOFF                 02141001
         BALR  RA,RA              SET POSLSTATE ON             @D52VDVB 02142001
.*    OUTPUT:                                                  @D52VDVB 02143001
.*              R4  =  OFFSET IN POSLSTATE                     @D52VDVB 02144001
.*              R5  =  CURRENT MASK OF PFTE                    @D52VDVB 02145001
.*              R6  =  CURRENT VALUE OF POSLSTATE              @D52VDVB 02146001
.*              R7  =  ADDR POSLSTATE                          @D52VDVB 02147001
.*                     :: 0 IF NO POSL AVAILABLE / USEABLE     @D52VDVB 02148001
.*                     ::-1 IF PMR ADDRESS SPAC                @D52VDVB 02149001
         LTR   R7,R7              BLOCK CONNECTED/PMR SP/VPOOL @D52VDVB 02150001
         BNP   ENQBLEX4           YES, ---------->                     *02151001
                                  ... NO POSL AVAILABLE        @D52VDVB 02152001
         SPACE 1                                                        02153001
*     CHECK WHETHER BLOCKED PRE-PAGE-OUT CAN BE INITIATED      @D52VDVB 02154001
*     POSLSTATE = INDEX IN PREPGOTB                            @D52VDVB 02155001
         SPACE 1                                               @D52VDVB 02156001
*        GENSERV  PGONT,PSLVAL=(R6),PGONT=(RD)                 @D52VDVB 02157001
         GENSERV  PGONT,PSLVAL=(R6),PGONT=(RD)                 @D52VDVB 02158001
         USING PREPGENT,RD                                     @D52VDVB 02159001
*                                 CURRENT BLOCKING FACTOR      @D52VDVB 02160001
         CLC   PREPGBLK,PPOBLCUR  ... AT LEAST SATISFIED       @D52VDVB 02161001
         BL    ENQBLEX4           NO, ---------->              @D52VDVB 02162001
         DROP  RD                                              @D52VDVB 02163001
         SPACE 1                                               @D52VDVB 02164001
*     CHECK WHETHER ALLOCATION UNIT ALREADY ENQUEUED IN PGQO   @D52VDVB 02165001
         SPACE 1                                               @D52VDVB 02166001
         L     R0,PFTESCB         RELATED SCB ADDR             @D52VDVB 02167001
         LR    RD,R5              SAVE MASK(POSLSTATE)         @D52VDVB 02168001
         BAL   R4,SCNPGOBL        ENQUEUED IN PAGE-OUT QUEUE   @D52VDVB 02169001
*SGLINK  SCNPGOBL,INPUT=(R0,R4,R7,R8,R9,RB),OUTPUT=(R3,R5),            *02170001
               NOMODR=(R4,R6-R2),AMODE=31 ANY                           02171001
         LTR   R5,R5              ALREADY ENQUEUED             @D52VDVB 02172001
         BNZ   ENQBLEX4           YES, ---------->             @D52VDVB 02173001
         SPACE 1                                               @D52VDVB 02174001
*     INITIATE BLOCKED PRE-PAGE-OUT                            @D52VDVB 02175001
         SPACE 1                                               @D52VDVB 02176001
         BAL   R4,GETPGQO         GET FREE PSEUDO TIB          @D52VDVB 02177001
*SGLINK  GETPGQO,INPUT=(R4,R6,R7,R8,R9,RC),OUTPUT=(R5),                *02178001
               NOMODR=(R1-R4,R6-RF),AMODE=31 DATOFF                     02179001
         B     ENQBLEX0           NO MORE FREE ENTRIES         @D52VDVB 02180001
*----->  B     ENQBL030           FREE ENTRY AVAILABLE         @D52VDVB 02181001
         USING TIBADR,R5                                       @D52VDVB 02182001
ENQBL030 DS    0H                                              @D52VDVB 02183001
         OI    PGQTYP,PGBLK       BLOCKED PRE-PAGE-OUT         @D52VDVB 02184001
         SLR   R0,R0                                           @D52VDVB 02185001
         ST    R0,TIBSTATE        RESET TIB STATE              @D52VDVB 02186001
         ST    R7,TIBAALU         PROVIDE ADDRESS OF POSLSTATE @D52VDVB 02187001
         SPACE 1                                               @D52VDVB 02188001
*     INITIATE  PRE-PAGE-OUT                                   @D52VDVB 02189001
         SPACE 1                                               @D52VDVB 02190001
         DROP  RC                                              @D52VDVB 02191001
         LR    RC,R5              GET ADDR OF TIB IN CORR.REG  @D52VDVB 02192001
         LA    RE,PGTPCB          GET PCB ADDR FOR PGQO        @D52VDVB 02193001
*        AMODESW SET,DAT=ON       SET DAT ON FOR ENQENTR2      @D61RDRP 02194001
         AMODESW SET,DAT=ON       SET DAT ON FOR ENQENTR2      @D61RDRP 02195001
         L     R9,APMRSERV        PROVIDE...                   @D52VDVB 02196001
         USING PMRSERV,R9         ... ADDRESSABILITY           @D52VDVB 02197001
*SGLINK  ENQENTR2,INPUT=(R7,R8,R9,RB,RC,RE),WORK=(R3-R5,RD),           *02198001
               NOMODR=(RE-R2,R6-RA,RC),AMODE=31 DATON                   02199001
         BAL   R7,ENQENTR2        ENQUEUE REQUEST              @D52VDVB 02200001
*        AMODESW SET,DAT=OFF      SET DAT OFF AGAIN            @D61RDRP 02201001
         AMODESW SET,DAT=OFF      SET DAT OFF AGAIN            @D61RDRP 02202001
         SPACE 1                                               @D52VDVB 02203001
ENQBLEX4 LM    R7,R6,PMRSLEV1+OFR7  RESET CALLERS REGISTER     @D52VDVB 02204001
         BR    RA                 ============> EXIT ENQUOBL   @D61RDRP 02205001
         SPACE 1                                                        02206001
ENQBLEX0 LM    R7,R6,PMRSLEV1+OFR7  RESET CALLERS REGISTER     @D52VDVB 02207001
         B     4(,RA)             ============> EXIT ENQUOBL   @KXA1851 02208001
         SPACE 2                                                        02209001
*-------------------------------------------------------------*@D529DVB 02210001
*        ROUTINE PROLOGUE                                      @D529DVB 02211001
*        ROUTINE NAME:  SCNPGOBL / SCNSYSBL                    @D529DVB 02212001
*        MACRO:         SGPMR                                  @D529DVB 02213001
*        FUNCTION: SEARCHES IN THE PGQUO / SYSTEM QUEUE OF     @D529DVB 02214001
*                  DEVCB WHETHER THE REQUEST IS ALREADY        @D529DVB 02215001
*                  ENQUEUED. .                                 @D529DVB 02216001
*                  RETURNS THE ADDRESS OF THE IORE (PSEUDO TIB)@D529DVB 02217001
*                  OR ZERO                                     @D529DVB 02218001
*        ENTRY POINT:                                          @D529DVB 02219001
*           SCNPGOBL AMODE (31) , ANY                          @D529DVB 02220001
*           SCNSYSBL AMODE (31) , DATON                        @D529DVB 02221001
*        INPUT:                                                @D529DVB 02222001
*           R0 - SCB ADDR                                      @D529DVB 02223001
*           R4 - RETURN ADDR                                   @D529DVB 02224001
*           R7 - ADDRESS OF ALLOCATION UNIT / 0                @D52VDVB 02225001
*           R8 - ADDR OF PAGEMANAGEMENT DATA-AREA (PMGMDATA)   @D529DVB 02226001
*           R9 - ADDR OF CODE-AREA (PMRSSRV)                   @D529DVB 02227001
*           RB - ADDR OF DEVBCB                                @D529DVB 02228001
*           RC - ADDR OF PFTE      (SCNSYSBL ONLY)             @D529DVB 02229001
*        OUTPUT:                                               @D529DVB 02230001
*           R3 - ADDR OF PREVIOUS TIB/IORE                     @D52VDVB 02231001
*           R5 - REQUESTED TIB/IORE                            @D52VDVB 02232001
*        INVARIANT REGISTERS: R0-R3,R6-RA,RC-RF                @D529DVB 02233001
*                                                              @D529DVB 02234001
*        INTERNAL USAGE OF REGISTERS                           @D529DVB 02235001
*              R5 - ADDR OF PAGE-OUT REQUEST ELEMENT (TIB)     @D529DVB 02236001
*              R7 - ADDR OF ALLOCATION UNIT IN POSLSTATE       @D529DVB 02237001
*-------------------------------------------------------------*@D529DVB 02238001
         SPACE 1                                                        02239001
         USING PMRSSRV,R9         RESET ADDRESSABILITY         @D61RDRP 02240001
*SGLINK  SCNSYSBL,S,INPUT=(R0,R4,R7,R8,R9,RB,RC),OUTPUT=(R3,R5),       *02241001
               NOMODR=(R4,R6-R2),AMODE=31 DATON                         02242001
         USING DEVCB,RB           ADDRESSABILITY FOR DEVCB     @D52VDVB 02243001
SCNSYSBL DS    0H                                              @D52VDVB 02244001
         LA    R5,PFRQBEG-TIBCHAIN+TIBADR GET PGQSYS           @D52VDVB 02245001
         B     SCNPG010                                        @D52VDVB 02246001
         SPACE 1                                               @D52VDVB 02247001
*SGLINK  SCNPGOBL,S,INPUT=(R0,R4,R7,R8,R9,RB),OUTPUT=(R3,R5),          *02248001
               NOMODR=(R4,R6-R2),AMODE=31 ANY                           02249001
SCNPGOBL DS    0H                                              @D52VDVB 02250001
         LA    R5,PORQBEG-TIBCHAIN+TIBADR GET PGQUO            @D52VDVB 02251001
         USING TIBADR,R5                                       @D52VDVB 02252001
SCNPG010 LR    R3,R5              SAVE ADDRESS OF PREVIOUS     @D52VDVB 02253001
         L     R5,TIBCHAIN        GET NEXT ENTRY               @D52VDVB 02254001
         LTR   R5,R5              LAST ENTRY                   @D52VDVB 02255001
         BZR   R4                 YES, ==========>  EXIT       @D52VDVB 02256001
         TM    PGQTYP,PGO         PAGE-OUT REQUEST AT ALL      @D52VDVB 02257001
         BZ    SCNPG010           NO, ----------> NEXT ENTRY   @D52VDVB 02258001
         TM    PGQTYP,PGBLK       BLOCKED PAGING               @D52VDVB 02259001
         BO    SCNPG020           YES, --------->              @D52VDVB 02260001
         CL    RC,TIBSTATE        PFTE FOUND IN PGQSYS         @D52VDVB 02261001
         BNE   SCNPG010           NO, ----------> NEXT ENTRY   @D52VDVB 02262001
         BR    R4                 YES,==========>   EXIT       @D52VDVB 02263001
SCNPG020 CL    R7,TIBAALU         ALLOC-UNIT ALREADY ...       @D52VDVB 02264001
         BNE   SCNPG010           ... ENQUEUED                 @D52VDVB 02265001
         CL    R0,TIBPFSCB        ... FOR SAME SCB             @D52VDVB 02266001
         BNE   SCNPG010           NO,-----------> NEXT ENTRY   @D52VDVB 02267001
         BR    R4                 YES,==========>   EXIT       @D52VDVB 02268001
         SPACE 1                                               @D52VDVB 02269001
         DROP  R5                                              @D52VDVB 02270001
         SPACE 1                                               @D52VDVB 02271001
         EJECT                                                 @D52VDVB 02272001
*-------------------------------------------------------------*@D149DVB 02273001
*        ROUTINE PROLOGUE                                      @D149DVB 02274001
*        ROUTINE NAME:  ENQUOUNC/ENQUOW                        @D149DVB 02275001
*        MACRO:         SGPMR                                  @D149DVB 02276001
*        FUNCTION: HANDLES REQUESTS TO SAVE A PAGE ONTO PDS.   @D149DVB 02277001
*                  PUTS A PAGE-OUT REQUEST IN PGQUO AND POSTS  @D149DVB 02278001
*                  PMR-TASK IF NECESSARY.                      @D149DVB 02279001
*                  IF ENTERED VIA ENQUOW THE PAGE IS ON PDS    @D149DVB 02280001
*                  AFTER RETURN FROM THIS ROUTINE.             @D149DVB 02281001
*        ENTRY POINTS:                                         @D149DVB 02282001
*           ENQUOUNC   CALLED BY SELECTPG WITH AMODE(31),DATOFF@D149DVB 02283001
*           ENQUOW     CALLED BY GETREAL  WITH AMODE(31),DATOFF@D149DVB 02284001
*        INPUT:                                                @D149DVB 02285001
*           R8 - ADDR OF PAGEMANAGEMENT DATA-AREA (PMGMDATA)   @D149DVB 02286001
*           RA - RETURN ADDR                                   @D149DVB 02287001
*           RC - ADDR(PFTE) OF PAGE TO BE PAGED-OUT            @D529DRP 02288001
*           RD - ADDR OF PAGE BELONGING TO RC                  @D149DVB 02289001
*           RE - ADDR OF PAGE-FRAME BELONGING TO RC,RD         @D149DVB 02290001
*        OUTPUT:                                               @D149DVB 02291001
*           PSEUDO-TIB REPRESENTING PAGE-OUT REQUEST ENQUEUED  @D149DVB 02292001
*                 IN PAGE-OUT QUEUE OR SYSTEM PAGEFAULT QUEUE  @D149DVB 02293001
*            PGQTYP   - (PGQO)                                 @D149DVB 02294001
*            TIBSTATE - ADDR (PFTE)                            @D149DVB 02295001
*                                                              @D149DVB 02296001
*        DATA= PGQUO(READ,WRITE)                               @D149DVB 02297001
*               PFTEFLG(WRITE)                                 @D149DVB 02298001
*                                                              @D149DVB 02299001
*        EXIT NORMAL:                                          @D149DVB 02300001
*          ENQUOW/ENQUOUNC:                                    @D529DVB 02301001
*                     PAGE-OUT WITH WAIT:     RETURN OFFSET 0  @D529DVB 02302001
*                     OTHERWISE :             RETURN OFFSET 4  @D529DVB 02303001
*         CONDITION: FUNCTION COMPLETED                        @D149DVB 02304001
*         OUTPUT: AS DESCRIBED ABOVE                           @D149DVB 02305001
*         RETURN CODE: NONE                                    @D149DVB 02306001
*                                                              @D149DVB 02307001
*        EXIT ERROR: IF ENTERED VIA ENQUO RETURN TO CALLER WITH@D149DVB 02308001
*                    OFFSET 0.                                 @D149DVB 02309001
*                    IN ALL OTHER CASES  NO ERROR EXIT.        @D149DVB 02310001
*         CONDITION: NO PSEUDO-TIB FOR PAGE-OUT AVAILABLE      @D149DVB 02311001
*         OUTPUT: NONE                                         @D149DVB 02312001
*         RETURN CODE: NONE                                    @D149DVB 02313001
*                                                              @D149DVB 02314001
*        CALLED ROUTINES:                                      @D149DVB 02315001
*              GETDVCBF, GETPGQO, PFTEPOSL, PAGEMUN            @D529DRP 02316001
*                                    WITH AMODE(31),DATOFF     @D529DRP 02317001
*              IOPOST1, SETUPSA, UNPOST WITH AMODE(31),DATON   @D529DRP 02318001
*              DISP                  WITH AMODE(24),DATON      @D529DRP 02319001
*-------------------------------------------------------------*@D149DVB 02320001
*        OPERATION:                                            @D149DVB 02321001
*                                                              @D149DVB 02322001
*      ENQUOW:                                                 @D149DVB 02323001
*          PGOFL.POSTRQ := ON            /* POSTING REQUIRED */@D149DVB 02324001
*                                        /* WAIT FOR PAGEOUT */@D149DVB 02325001
*      ENQUOUNC :                                              @D149DVB 02326001
*          CALL GETDVCBF (PFTE)          /* GET ACTUAL DEVCB */@D149DVB 02327001
*          PF.R-BIT := ON                /*SET RBIT IN PAGEFR*/@D149DVB 02328001
*                    /*THIS IS DONE FOR STAND-ALONE-DUMP ONLY*/@D149DVB 02329001
*          IF I/O RUNNING ON FRAME                             @KD40018 02330001
*            THEN DO                                           @KD40018 02331001
*               IORE = PFTE.PFTETIB                            @KD40018 02332001
*               IF IORE.TIBSTATE = 0 /* PRE-PAGE-OUT REQUEST */@KD40018 02333001
*                 THEN DO                                      @KD40018 02334001
*                    IORE.TIBSTATE = PFTE                      @KD40018 02335001
*                    GOTO ENQUOW15                             @KD40018 02336001
*            END                                               @KD40018 02337001
*          CALL PFTEPOSL(SET,PFTE)   /* SET POSL VALUE       */@D529DVB 02338001
*          CALL GETPGQO (PFTE)       /* GET FREE IORE        */@D149DVB 02339001
*          IF POSL AVAILABLE                                   @D52VDVB 02340001
*            THEN DO                                           @D52VDVB 02341001
*               TIBAALU = (* ADDR POSLVALUE *)                 @D52VDVB 02342001
*               TIBAPFT = (* ADDR PFTE      *)                 @D52VDVB 02343001
*            END                                               @D52VDVB 02344001
*          PFTEFLG = POEBIT                                    @D52VDVB 02345001
*          DEVCB.SYSQ = IORE || DEVCB.SYSQ                     @D52VDVB 02346001
*                           /* ENQUEUE REQUEST ON TOP OF SYSQ*/@D52VDVB 02347001
*          IF I/O RUNNING ON FRAME                             @KD40018 02348001
*            THEN IORE.PGQTYP = PGDELO   /* PSEUDO REQUEST   */@KD40018 02349001
*          ENQUOW15:                                           @KD40018 02350001
*          IF  PGOFL.POSTRQ = ON         /* ENTERD IN ENQUOW */@D149DVB 02351001
*            THEN DO                                           @D149DVB 02352001
*               IF DEVCB.DEVSTAT = XFF   /* DEVICE FREE      */@D149DVB 02353001
*                 THEN CALL POST(TIB=PMRTIB) /* POST PMR TASK*/@D149DVB 02354001
*               PGOFL := NIL                                   @D149DVB 02355001
*               CALL SETUPSA(ADDR=RET_ADDR) /* SAVE TSKSTUTUS*/@D149DVB 02356001
*               CALL PAGEMUN(PFTE,PAGE,P_FR) /*PAGE CONNECTED*/@D149DVB 02357001
*               CALL UNPOST(SRQPGIO,PFTE) /*WAIT FOR PAGE OUT*/@D149DVB 02358001
*               /* AFTER I/O COMPLETION TASK IS DISPATCHED   */@D149DVB 02359001
*               /* AT RETURN ADDR AS GIVEN BY SETUPSA ROUTINE*/@D149DVB 02360001
*               EXIT DISPATCHER          /* =====>DISP       */@D149DVB 02361001
*            END                                               @D149DVB 02362001
*            ELSE DO                                           @D149DVB 02363001
*               CALL PAGEMUN(PFTE,PAGE,P_FR) /*PAGE CONNECTED*/@D149DVB 02364001
*               IORE.PGINF := ADDR(DEVCB)                      @D149DVB 02365001
*               IORE.PGQTYP := PGOPIN     /* PAGE IN WAITING */@D149DVB 02366001
*               IF ADDR(DEVCB)/= PFDEVCB  /*PAGE OUT ON SAME */@D149DVB 02367001
*                                         /*DEVICE AS PAGE_FL*/@D149DVB 02368001
*                 THEN PFDEVCB->DEVCB.DEVSTAT := DEVPGWO       @D149DVB 02369001
*               RETURN                    /* =====> EXIT     */@D149DVB 02370001
*            END                                               @D149DVB 02371001
*          END (ENQUO);                                        @D149DVB 02372001
*-------------------------------------------------------------*@D149DVB 02373001
*        INVARIANT REGISTERS: R0, R3, R7 - RA, RC - RF         @D149DVB 02374001
*-------------------------------------------------------------*@D149DVB 02375001
*        INTERNAL USAGE OF REGISTERS                           @D149DVB 02376001
*              R3 - WORKREGISTER                               @D149DVB 02377001
*              R4 - WORKREGISTER                               @D149DVB 02378001
*              R5 - ADDR OF PAGE-OUT REQUEST ELEMENT (TIB)     @D149DVB 02379001
*              R6 - ADDR OF DISPATCHER                         @D149DVB 02380001
*              RA - RETURN ADDR                                @D149DVB 02381001
*              RB - ADDR OF DEVCB TO WHICH THE PAGE BELONGS    @D149DVB 02382001
*-------------------------------------------------------------*@D149DVB 02383001
         SPACE 1                                                        02384001
         USING PFTE,RC                                         @D14BDRP 02385001
*SGLINK  ENQUOW,S,INPUT=(R8:APMGMDAT,RA:LINK,RC:PFTE,RD:PAGE,RE:PF),   *02386001
               ,NOMODR=(R7-R3),AMODE=31 DATOFF                          02387001
ENQUOW   OI    PGOFL,POSTRQ       INDICATE POSTING REQUIRED    @D14BDRP 02388001
         SGCOV SGPMR,MC=1         COUNT ENQUOW REQUEST         @D52VDVB 02389001
         SPACE 1                                               @D14BDVB 02390001
*SGLINK  ENQUOUNC,S,                                                   *02391001
               INPUT=(R8:APMGMDAT,RA:LINK,RC:PFTE,RD:PAGE,RE:PF),      *02392001
               NOMODR=(R7-R3),AMODE=31 DATOFF                           02393001
ENQUOUNC DS    0H                                              @D14BDRP 02394001
         STM   R7,R3,PMRSLEV1+OFR7 SAVE CALLERS REGISTERS      @D52VDVB 02395001
.*    RC = ADDRESS OF CURRENT PFTE                             @D52VDVB 02396001
.*    RD = ADDRESS OF EPA / BLOCK                              @D52VDVB 02397001
.*    RE = ADDRESS OF FRAME BELONGING TO PFTE ADDRESSED VIA RC @D52VDVB 02398001
         L     R9,APMRSERV        PROVIDE...                   @D52VDVB 02399001
         USING PMRSERV,R9         ... ADDRESSABILITY           @D52VDVB 02400001
         BAL   R4,GETDVCBF        GET CORRECT DEVICE CONTR. BL.@D14BDRP 02401001
*SGLINK  GETDVCBF,INPUT=(R4,R8,R9,RC),OUTPUT=(RB),                     *02402001
               NOMODR=(RC-R2,R4,R6-RA),AMODE=ANY DATOFF                 02403001
         L     R9,APMRSSRV        PROVIDE...                   @D61RDRP 02404001
         USING PMRSSRV,R9         ... ADDRESSABILITY FOR ROUT. @D61RDRP 02405001
         USING DEVCB,RB                                                 02406001
         CLI   0(RE),0            REFERENCE THE PAGE           @D51GDTP 02407001
*                                  TO TURN REFERENCE BIT ON    @D51GDTP 02408001
.*                                THIS IS DONE ONLY FOR STAND ALONE     02409001
.*                                DUMP TO DETECT PAGE-OUT ACTIVE IF     02410001
.*                                PAGE IS ONLY CONNECTED                02411001
         LA    R0,4(,0)           FUNCTIONCODE: POSLSTATE=ON   @D52VDVB 02412001
         TM    PFTEFLG,POEBIT+POABIT PFTE USABLE AND I/O ACTIVE        *02413001
                                  .... (C-BIT = OFF )          @D52VDVB 02414001
         BZ    ENQUOW00           NO,  ----------->            @D52VDVB 02415001
         BO    ENQUOWOK           YES, ----------->            @D52VDVB 02416001
         BAL   R5,PMRHWERR        ONLY ENQUEUED ==========>    @D52VDVB 02417001
ENQUOWOK DS    0H                                              @D52VDVB 02418001
         SLR   R0,R0              FUNCTION CODE: GET POSLSTATE @D52VDVB 02419001
         L     R5,PFTETIB         IORE OF ACTIVE REQUEST       @KD40018 02420001
         USING TIBADR,R5          ADDRESSABILITY TO IORE       @KD40018 02421001
         L     R4,TIBSTATE                                     @KD40018 02422001
         LTR   R4,R4              ALREADY UNCOND. BLOCKED PGO  @KD40018 02423001
         BNZ   ENQUOW00           YES, ----------->    GET IORE        *02424001
                                  ... AND ENQUEUE IT IN PGQSYS @KD40018 02425001
         ST    RC,TIBSTATE        PROVIDE CURRENT PFTE AND DO UNCOND.  *02426001
                                  ... PAGE-OUT                 @KD40018 02427001
         DROP  R5                 RESET ADDRESSABILITY OF IORE @KD40018 02428001
         B     ENQUOW15           ---------------->            @KD40018 02429001
         SPACE 1                                               @D14BDRP 02430001
*     SET POSL -IF ANY - AND GET NEW IORE                               02431001
         SPACE 1                                               @D14BDVB 02432001
ENQUOW00 DS    0H                                              @D52VDVB 02433001
         L     RA,APFTPOSL                                     @D52VDVB 02434001
*SGLINK  PFTEPOSL,INPUT=(R0,R8,RA,RC),OUTPUT=(R0,R4,R5,R6,R7),         *02435001
               NOMODR=(R1-R3,R8-RF),AMODE=31 ANY,DATOFF                 02436001
         BALR  RA,RA              GET / SET POSLSTATE          @D52VDVB 02437001
.*    OUTPUT:   R5 AND R7 ARE USED                             @D52VDVB 02438001
         LR    R6,R5                                           @D52VDVB 02439001
         BAL   R4,GETPGQO2        GET FREE PSEUDO TIB          @D14BDRP 02440001
*SGLINK  GETPGQO,INPUT=(R4,R6,R7,R8,R9,RC),OUTPUT=(R5),                *02441001
               NOMODR=(R0-R2,R4,R6-RF),AMODE=31 DATOFF                  02442001
         BAL   R5,PMRHWERR        ==========>  NO IORE=HARDWAIT@D52VDVB 02443001
*----->  B     ENQUOW05           SUCCESSFULL RETURN           @D52VDVB 02444001
ENQUOW05 DS    0H                                              @D52VDVB 02445001
         LTR   R7,R7              POSL AVAILABLE               @D52VDVB 02446001
         BNP   ENQUOW10           NO,  ---------->             @D52VDVB 02447001
         USING TIBADR,R5                                       @D52VDVB 02448001
         ST    R7,TIBAALU         PROVIDE ADDRESS OF PSLSTATE  @D52VDVB 02449001
*        GENSERV  PGONT,PSLVAL=(R6),PGONT=(R3)                 @D52VDVB 02450001
         GENSERV  PGONT,PSLVAL=(R6),PGONT=(R3)                 @D52VDVB 02451001
         USING PREPGENT,R3                                     @D52VDVB 02452001
         L     R4,PREPGOFF        RELATED OFFSET IN TIBAPFT  =         *02453001
                = OFFSET IN ALLOCATION UNIT *10**(-PNSHIFT+2)  @D52VDVB 02454001
         DROP  R3                                              @D52VDVB 02455001
         ST    RC,TIBAPFT(R4)     PROVIDE ADDR OF CURRENT PFTE @D52VDVB 02456001
ENQUOW10 DS    0H                                              @D52VDVB 02457001
         OI    PFTEFLG,POEBIT     ENTRY QUEUED FOR PAGE-OUT             02458001
         ST    R5,PFTETIB         IORE IN PFTE                 @D52VDVB 02459001
         SPACE 1                                                        02460001
*      ENQUEUE PSEUDO-TIB ON TOP OF SYSTEM PAGE-FLT QUEUE      @D14BDRP 02461001
*      BEHIND STARTED REQUEST IF ANY                           @D14BDRP 02462001
.*       N O T E : PFTE IS ENQUEUED AT TOP OF SYSTEM QUEQUE    @D52VDVB 02463001
.*       CAUSED BY PREVIOUS PAGE OUT - ONLY OTHER PAGE OUT RE- @D52VDVB 02464001
.*       QUESTS MIGHT BE ENQUEUED BEFORE THE REQUEST           @D52VDVB 02465001
.*       NO PAGE-IN-S ARE ENQUEUED BEFORE                      @D52VDVB 02466001
         DROP  RC                                              @D52VDVB 02467001
*        AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @D52VDRP 02468001
         AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @D52VDRP 02469001
         LA    R3,PFRQBEG+TIBADR-TIBCHAIN  1ST ENTRY OF QUEUE  @D14BDRP 02470001
         L     R4,TIBCHAIN-TIBADR(R3) * QUEUE                  @D14BDRP 02471001
         LTR   R4,R4              * EMPTY                      @D14BDRP 02472001
         BZ    ENQUOW12           YES, BRANCH                  @D14BDRP 02473001
         C     R4,DEVACT          I/O IN PROCESS FOR 1ST ELEMNT@D14BDRP 02474001
         BNE   ENQUOW12           NO, BRANCH                   @D14BDRP 02475001
         LR    R3,R4              ENQUEUE AFTER 1ST ELEMENT    @D14BDRP 02476001
         L     R4,TIBCHAIN-TIBADR(R3) ENQUEUE                  @D14BDRP 02477001
ENQUOW12 ST    R5,TIBCHAIN-TIBADR(R3) ELEMENT                  @D14BDRP 02478001
         ST    R4,TIBCHAIN            AFTER ELEMENT POINTED TO @D14BDRP 02479001
*                                     BY R3                    @D14BDRP 02480001
         LTR   R4,R4              ENQUEUED AT THE END          @D14BDRP 02481001
         BNZ   ENQUOW13           NO, BRANCH                   @D14BDRP 02482001
         ST    R5,PFRQEND         SET ADDR OF LAST QUEUE ELEMNT@D14BDRP 02483001
ENQUOW13 DS    0H                                              @D61RDVB 02484001
         CLC   PFRQBEG,PFRQEND    WAS QUEUE EMPTY BEFORE       @D61RDRP 02485001
         BNE   ENQUOW14           NO, SKIP DISPMAC INVOCATION  @D61RDRP 02486001
         LR    R0,R5              SAVE ADDR IORE               @D61RDVB 02487001
         L     R5,ASYSPCB         GET ADDR SYS-PCB             @D61RDVB 02488001
         L     R1,DEVCBMSK        GET DEVICE MASK              @D61RDVB 02489001
         LA    R3,1(,0)           ENQUEUE REQUEST              @D61RDVB 02490001
*        DISPMAC FUNC=PFUPD,INP1=(R1),INP2=(R3),INP3=(R5)               02491001
         DISPMAC FUNC=PFUPD,INP1=(R1),INP2=(R3),INP3=(R5)               02492001
         LR    R5,R0              ADDR IORE                    @D61RDVB 02493001
ENQUOW14 DS    0H                                              @D61RDVB 02494001
         L     RC,TIBSTATE        GET ADDR OF PFTE             @D14BDRP 02495001
*        AMODESW SET,DAT=OFF      ENTER REAL MODE AGAIN        @D52VDRP 02496001
         AMODESW SET,DAT=OFF      ENTER REAL MODE AGAIN        @D52VDRP 02497001
         USING PFTE,RC                                         @D14BDRP 02498001
         TM    PFTEFLG,POEBIT+POABIT PFTE USABLE AND I/O ACTIVE@KD40018 02499001
         BNO   ENQUOW15           NO,  ----------->            @KD40018 02500001
         OI    PGQTYP,PGDELO      INDICATE I/O ALREADY RUNNING         *02501001
                                  ... IN OTHER UNCOND. PAGE-OUT@KD40018 02502001
         DROP  R5                 FORGET BASE FOR TIB          @D14BDRP 02503001
         SPACE 1                                               @D36IDRP 02504001
*     ENTRY IS (NOW) IN HIGHEST PRIORITY PAGE-FAULT QUEUE               02505001
*     OR PAGE OUT ALREADY ACTIVE                                        02506001
         SPACE 1                                               @D14BDVB 02507001
ENQUOW15 NI    DEVSTAT,XFF-DEVEMPTY IND. REQUEST QUEUED        @D14BDRP 02508001
         TM    PGOFL,POSTRQ       WAIT REQUESTED               @D14BDRP 02509001
         BO    ENQUOW17           YES, BRANCH                  @D14BDRP 02510001
         L     R9,APMRSERV        GET BASE ...                 @D51GDRP 02511001
         USING PMRSERV,R9         ....      OF SUBROUTINE      @D51GDRP 02512001
         BAL   RA,PAGEMUN         SET PAGE TO CONNECTED        @D14BDRP 02513001
*SGLINK  PAGEMUN,INPUT=(R9,RA,RC,RD,RE),WORK=(R4,R5)           @D14BDRP 02514001
         L     R9,APMRSSRV        RESTORE BASE FOR CODE AREA   @D61RDRP 02515001
         USING PMRSSRV,R9         RESET BASE FOR CODE AREA     @D61RDRP 02516001
         L     R4,PFDEVCB         GET ACTUAL DEVICE CONTR. BL. @D14BDRP 02517001
         CR    R4,RB              PAGE OUT ON SAME DEV AS PAGEF@D14BDRP 02518001
         BE    ENQUOEXT           YES, -------->               @D14BDRP 02519001
         SGCOV SGPMR,MC=2         COUNT WAITING ON OTHER DEVICE@D52VDVB 02520001
         ST    R4,PFTEDVCB        SET ADDR OF PAGE-FLT DEVCB   @D52VDVB 02521001
*                                 INDICATING PAGE-IN WAITING   @D14BDRP 02522001
         OI    DEVSTAT-DEVCB(R4),DEVPGWO IND. DEVICE WAITING   @D14BDRP 02523001
ENQUOEXT LM    R7,R3,PMRSLEV1+OFR7  RESTORE CALLERS REGISTERS  @D52VDVB 02524001
         BR    RA                 ==========>  EXIT ENQUOUNC   @D52VDVB 02525001
         DROP  RC                                              @D14BDRP 02526001
         SPACE 1                                                        02527001
*  CONTINUE HANDLING OF ENQUOW REQUEST                         @D52VDRP 02528001
*  SEE WHETHER PMR-TASK HAS TO BE ACTIVATED                    @D369DRP 02529001
         SPACE 1                                               @D14BDVB 02530001
ENQUOW17 DS    0H                                              @D52VDRP 02531001
*        AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @D52VDRP 02532001
         AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @D52VDRP 02533001
         TM    DEVSTAT,XFF        REQUEST IN PROCESS ON DEVICE @D14BDRP 02534001
         BNZ   ENQUOW18           YES, SKIP ACTIVATION         @D14BDRP 02535001
         L     R6,DISPAD                                       @D52VDVB 02536001
         USING DISP,R6                                                  02537001
         SPACE 1                                               @D36IDRP 02538001
*     POST PMR-TASK, DON'T SET OWNER                           @D14BDRP 02539001
         SPACE 1                                               @D149DVB 02540001
         L     R8,APMRTIB                                      @D14BDVB 02541001
*SGLINK  IOPOST1,INPUT=(R6,R8,RF),WORK=(RE)                    @D14BDVB 02542001
         BAL   RF,IOPOST1                                      @KD40355 02543001
         L     R8,APMGMDAT                                     @D14BDVB 02544001
ENQUOW18 MVI   PGOFL,ZERO         RESET PGOFL                  @D14BDRP 02545001
         DROP  RB                 DROP BASE FOR DEVCB          @D14BDRP 02546001
         LM    R7,R3,PMRSLEV1+OFR7 GET CURRENT REGS OUT OF SAVE@D14BDRP 02547001
         STM   R9,RD,ERA          SAVE REGISTERS FOR GENENT    @D14BDRP 02548001
         LR    RC,RA              RETURN TO CALLER AFTER POSTING       *02549001
                                  * EXIT VIA REGISTER RA       @D14BDRP 02550001
         L     RD,AFLIH                                        @D14BDRP 02551001
         USING FLIH,RD                                         @D14BDRP 02552001
         BAL   R9,SETUPSA         SAVE STATUS OF TASK          @D14BDRP 02553001
*SGLINK  SETUPSA,INPUT=(R9,RC,RD),WORK=(RB,RC),OUTPUT=(R6,RA)  @D14BDRP 02554001
         DROP  RD                 FORGET BASE FOR FILH         @D14BDRP 02555001
         LM    RC,RD,PMRSLEV1+OFR12  RESTORE REGISTERS         @D61BDRP 02556001
.*    RC = ADDRESS OF CURRENT PFTE                             @D52VDVB 02557001
.*    RD = ADDRESS OF EPA / BLOCK                              @D52VDVB 02558001
.*    RE = ADDRESS OF FRAME BELONGING TO PFTE ADDRESSED VIA RC @D52VDVB 02559001
         L     R9,APMRSERV        GET BASE FOR SUBROUTINE      @D51GDRP 02560001
         USING PMRSERV,R9         SET BASE FOR SUBROUTINE      @D51GDRP 02561001
*        AMODESW SET,DAT=OFF      ENTER REAL MODE              @D52VDRP 02562001
         AMODESW SET,DAT=OFF      ENTER REAL MODE              @D52VDRP 02563001
         BAL   RA,PAGEMUN         SET PAGE TO CONNECTED        @D14BDRP 02564001
*SGLINK  PAGEMUN,INPUT=(R9,RA,RC,RD,RE),WORK=(R4,R5)           @D14BDRP 02565001
*        AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @D52VDRP 02566001
         AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @D52VDRP 02567001
         DROP  R9                                              @D52VDVB 02568001
         LR    R1,RC              GET PFTE ADDR AS BOUND STATE @D36IDRP 02569001
         L     R5,ASRQTAB         GET ADDRESS OF ...           @D61RDRP 02570001
         LA    R5,SRQPGIO-SRQTAB(,R5) ... RESOURCE QUEUE       @D61RDRP 02571001
         BAL   RF,UNPOST          SET TASK IN WAIT FOR PAGE-OUT@D14BDRP 02572001
*SGLINK  UNPOST,INPUT=(R1,R5,R6,RF),WORK=(R5,RE)               @D369DRP 02573001
*        AMODESW RETURN,REG=(R6)  ==========> RETURN TO DISP.  @D52VDRP 02574001
         AMODESW RETURN,REG=(R6)  ==========> RETURN TO DISP.  @D52VDRP 02575001
         DROP  R6                 FORGET BASE FOR DISP         @D36IDRP 02576001
         EJECT                                                          02577001
*-------------------------------------------------------------*@D52VDVB 02578001
*   SUBROUTINE OF ENQUO/ENQUOUNC TO GET A FREE PSEUDO-TIB FOR  @D149DRP 02579001
*   A PAGE-OUT REQUEST AND TO SAVE THE PFTE ADDR IN TIBSTATE   @D149DRP 02580001
*        AMODE(31),DATOFF                                      @D529DRP 02581001
*     INPUT:                                                   @D149DRP 02582001
*       R4 - RETURN ADDR                                       @D149DRP 02583001
*       R6 - POSL.PSLSTATE AT ENQUEUE TIME                     @D529DRP 02584001
*       R7 - > 0 : ADDR(TIBAALU)                               @D529DRP 02585001
*            = 0 : VPOOL                                       @D526DVB 02586001
*            < 0 : PAGE MGR ADDRESS SPACE                      @D526DVB 02587001
*       RC - ADDR OF PFTE                                      @D149DRP 02588001
*     OUTPUT:                                                  @D149DRP 02589001
*       R5 - ADDR OF PSEUDO-TIB                                @D149DRP 02590001
*     WORKREGISTER: R0,R3                                      @D149DRP 02591001
*-------------------------------------------------------------*@D52VDVB 02592001
         SPACE 1                                               @D14BDRP 02593001
         USING PMRSSRV,R9                                      @D61RDRP 02594001
*SGLINK  GETPGQO,S,INPUT=(R4,R6,R7,R8,R9,RC),OUTPUT=(R5),              *02595001
               NOMODR=(R0-R2,R4,R6-RF),AMODE=31 DATOFF                  02596001
GETPGQO  DS    0H                                              @D52VDVB 02597001
         CLC   PGQOCNT,PGQOMIN    MORE ENTRIES AVAILABLE       @D52VDVB 02598001
         BNHR  R4                 NO, ===========>             @D52VDVB 02599001
GETPGQO2 L     R5,PGQOFREE        GET ADDR OF FREE ENTRY       @D14BDRP 02600001
         USING TIBADR,R5                                       @D14BDRP 02601001
         LTR   R5,R5              ANY FREE ENTRY AVAILABLE     @D52VDVB 02602001
         BNZ   GETPGQO3           YES, ---------->             @D52VDVB 02603001
         BAL   R5,PMRHWERR        NO,  ==========>  HW         @D52VDVB 02604001
GETPGQO3 CLI   PGOFLAG,X'80'      NOT DEQUEUED FROM FREE QUEUE @D52VDVB 02605001
         BNE   GETPGQO4           YES, ---------->             @D52VDVB 02606001
         BAL   R5,PMRHWERR        NO,  ==========>  HW         @D52VDVB 02607001
GETPGQO4 DS    0H                                              @D52VDVB 02608001
         XC    PGQTYP(TIBPOLNG-(PGQTYP-TIBADR)),PGQTYP         @D52VDVB 02609001
         LA    R3,PGTPCB          SET  PCB ADDR ...            @D61RDRP 02610001
         ST    R3,TIBPCB          IN PAGE-OUT TIB              @D61RDRP 02611001
         MVI   PGOFLAG,X'80'      IORE DEQUEUED FROM FREE QUEUE@D52VDVB 02612001
         L     R3,TIBCHAIN        UPDATE                                02613001
         ST    R3,PGQOFREE        ADDR OF FREE PGQUO ENTRY              02614001
         ST    RC,TIBSTATE        SAVE ADDR OF PFTE            @D14BDRP 02615001
         MVI   PGQTYP,PGO         INDICATE PAGE OUT REQUEST    @D52VDVB 02616001
         USING PFTE,RC                                         @D52VDRP 02617001
         MVC   TIBPFSCB,PFTESCB   SAVE SCB IN TIB              @D52VDRP 02618001
         LTR   R7,R7              POSL AVAILABLE               @D52VDVB 02619001
         BP    GETPGQO6           YES,---------->              @D52VDVB 02620001
*                                 VPOOL OR BLOCK-CONNECTED     @D52VDVB 02621001
         BZ    GETPGQO5           YES, --------->              @D52VDVB 02622001
         OI    PGQTYP,PGPMRSP     INDICATE PMR-ADDRESS-SPACE   @D52VDVB 02623001
         B     GETPGQO6           NO, ---------->              @D52VDVB 02624001
GETPGQO5 OI    PGQTYP,PGVIORQ     INDICATE VPOOL/BLOCK-CONNECT.@D52VDVB 02625001
GETPGQO6 STC   R6,PGOEQPSL        STORE CURRENT POSL VALUE     @D52VDVB 02626001
*        GENSERV DEC,FIELD=PGQOCNT,REG=(R3)                    @D52VDVB 02627001
         GENSERV DEC,FIELD=PGQOCNT,REG=(R3)                    @D52VDVB 02628001
         DROP  R5                 DROP BASE FOR IORE           @D52VDRP 02629001
         DROP  RC                 DROP BASE FOR PFTE           @D52VDRP 02630001
         B     4(,R4)             ==========>  EXIT GETPGQO    @D52VDVB 02631001
         DROP  R9                 DROP CURRENT BASE OF CODE    @D52VDVB 02632001
         TITLE ' VSE/AF SUPERVISOR         SGPMR    PAGE MANAGER       *02633001
                - I/O ROUTINES '                               @D52VDVB 02634001
*-------------------------------------------------------------*@D529DVB 02635001
*   GENERAL SERVICES ROUTINES:                                 @D529DVB 02636001
*        MACRO:        SGPMR                                   @D529DVB 02637001
*        BASE :        PMRIOMOD                                @D529DVB 02638001
*        BASE ADDRESS: APMRIORT                                @D529DVB 02639001
*-------------------------------------------------------------*@D529DVB 02640001
         SPACE 2                                                        02641001
PMRIOMOD DS    0H                 BASE ADDRESS OF PAGE MANAGER         *02642001
                                  I/O ROUTINES                 @D52VDVB 02643001
         SPACE 1                                               @0000036 02644001
*-------------------------------------------------------------*@D52VDVB 02645001
*        ROUTINE PROLOGUE                                      @D52VDVB 02646001
*        ROUTINE NAME: PGINSIO                                 @D52VDVB 02647001
*        MACRO:        SGPMR                                   @D52VDVB 02648001
*        FUNCTION:  PROCESSES PAGE READ IN REQUEST             @D52VDVB 02649001
*        CALLED BY:                                            @D52VDVB 02650001
*              PMRMAIN WITH AMODE(31),DATON                    @D529DRP 02651001
*        CALLED ROUTINES:                                      @D529DRP 02652001
*              PGISUBLK WITH AMODE(31),DATON                   @D529DRP 02653001
*              PGISBLCK WITH AMODE(31),DATON                   @D529DRP 02654001
*        CALLING SEQUENCE:                                     @D52VDVB 02655001
*              L    R7,APGINSIO                                @D52VDVB 02656001
*              BALR R7,R7                                      @D52VDVB 02657001
*              B    NO I/O         OFFSET 0                    @D52VDVB 02658001
*              B    I/O            OFFSET 4                    @D52VDVB 02659001
*        ENTRY POINTS:                                         @D52VDVB 02660001
*              PGINSIO                                         @D52VDVB 02661001
*        EXIT :     RETURN TO CALLER WITH AMODE(31),DATON      @D529DVB 02662001
*        ERROR EXIT: -                                         @D52VDVB 02663001
*        INPUT:                                                @D52VDVB 02664001
*                   R7  :  RETURN ADDRESS                      @D52VDVB 02665001
*                   R8  :  ADDR PAGE MANAGEMENT DATA AREA      @D52VDVB 02666001
*                   RB  :  ADDR DEVCB                          @D52VDVB 02667001
*                   RC  :  ADDR (PFTE)       - UNBLOCKED ONLY  @D52VDVB 02668001
*                   RE  :  ADDR (PAGE FRAME) - UNBLOCKED ONLY  @D52VDVB 02669001
*        OUTPUT:    -                                          @D52VDVB 02670001
*-------------------------------------------------------------*@D52VDVB 02671001
*     OPERATION:                                               @D52VDVB 02672001
*        PGINSIO:                                              @D52VDVB 02673001
*        ADDR_IORE(PFPGQE)        /* ACTUAL TIB ADDRESS      */@D52VDVB 02674001
*        IF UNBLOCKED PAGE-IN                                  @D52VDVB 02675001
*           THEN DO               /* PROCESS UNBLOCKED PAGEIN*/@D52VDVB 02676001
*            PFTE.PFTEEPA# = EPA/4K                            @D52VDVB 02677001
*            PFTE.PFTESCB  = PFSCB                             @D52VDVB 02678001
*            PFTE.PFTEFLG = PCBIT                              @D52VDVB 02679001
*            PFTE.S370FLG = CLEAR EXCEPT NFRP & PFTERES        @D52VDVB 02680001
*            CLEAR (PFTEPIK,FIXC)                              @D52VDVB 02681001
*            PTE.PTESTAT = PTEPGCO                             @D52VDVB 02682001
*            IF PTE.PTESTAT2=PDSBIT /* VALID COPY ON PDS     */@D52VDVB 02683001
*              THEN DO                                         @D52VDVB 02684001
*                CALL PGISUBLK    /* READ PAGE INTO FROM     */@D52VDVB 02685001
*                RETURN(OFF=4)    /* I/O HAS BEEN STARTED    */@D52VDVB 02686001
*              END                                             @D52VDVB 02687001
*              ELSE RETURN(OFF=0) /* NO I/O STARTED AT ALL   */@D52VDVB 02688001
*           END                                                @D52VDVB 02689001
*           ELSE DO               /* PROCESS BLOCKED PAGE-IN */@D52VDVB 02690001
*              CALL PGISBLCK      /* BLOCKED PAGE-IN         */@D52VDVB 02691001
*              RETURN(OFF=4)      /* I/O HAS BEEN STARTED    */@D52VDVB 02692001
*           END                                                @D52VDVB 02693001
*        END_IF                                                @D52VDVB 02694001
*        END (PGINSIO);                                        @D52VDVB 02695001
*------------------------------------------------------------* @D52VDVB 02696001
*SGLINK  PGINSIO,S,INPUT=(R7,R8,R9,RB,RC,RE),NOMODR=(R7-RF),           *02697001
               AMODE=31 DATON                                           02698001
PGINSIO  DS    0H                                              @D52VDVB 02699001
         STM   R7,RF,PMRSLEV0+OFR7                             @D52VDVB 02700001
         L     R9,APMRIORT        BASE OF I/O ROUTINES         @D52VDVB 02701001
         USING PMRIOMOD,R9        ... OF I/O ROUTINES          @D52VDVB 02702001
         L     R5,PFPGQE          GET TIB (CURRENT REQUEST QUEUE..     *02703001
                                  .. ELEMENT)                  @D52VDVB 02704001
         USING TIBADR,R5          SET BASE FOR TIB             @D52VDVB 02705001
         TM    PGQTYP,PGBLK       BLOCKED PAGE-IN              @D52VDVB 02706001
         BO    PGINS50            YES ---------->              @D52VDVB 02707001
         DROP  R5                                              @D52VDVB 02708001
         SPACE 1                                               @D52VDVB 02709001
*-------------------------------------------------------------*@D52VDVB 02710001
*     UNBLOCKED PAGE-IN                                        @D52VDVB 02711001
*-------------------------------------------------------------*@D52VDVB 02712001
         SPACE 1                                               @D52VDVB 02713001
*        AMODESW SET,DAT=OFF      ENTER REAL MODE              @D52VDRP 02714001
         AMODESW SET,DAT=OFF                            DATOFF @D52VDRP 02715001
         L     R5,PAGEADDR        GET EPA                      @D52VDVB 02716001
         LR    R2,R5                                           @D52VDVB 02717001
         SRL   R5,PNSHIFT         CONVERT TO EPANR             @D51GDRP 02718001
         USING PFTE,RC            SET BASE FOR PFTE            @D35CDAA 02719001
         ST    R5,PFTEPNR         CLEAR PFTEFLG, INIT EPA      @D51GDRP 02720001
         MVC   PFTESCB,PFSCB      SET SCB-ADDR IN PFTE         @D52VDRP 02721001
         NI    S370FLG,NFRP+PFTERES  RESET ALL EXCEPT THE TWO  @KY30163 02722001
         XC    FIXC,FIXC          CLEAR FIXCOUNTERS, LEAVE S370@DA33314 02723001
         XC    PFTEPIK,PFTEPIK    CLEAR PFTEPIK                @D52VDRP 02724001
         OI    PFTEFLG,PCBIT      IND. CONNECTED STATE         @D14ZDRP 02725001
         SRL   R2,PTSHIFT                                      @D52VDVB 02726001
         AL    R2,APT             ADDR OF PTE                  @D52VDVB 02727001
         DROP  RC                 DROP BASE FOR PFTE (REAL)    @D52VDRP 02728001
*    DROP OF RC SINCE WE ARE NOW VIRTUAL                       @D52VDRP 02729001
*        AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @D52VDRP 02730001
         AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @D52VDRP 02731001
         USING PTE,R2             BASE OF PTE                  @D52VDVB 02732001
         OI    PTESTAT,PTEPGCO    PTE = CONNECTED              @D14ADVB 02733001
*    SET PAGE-FRAME ADDR IN VTAB-ENTRY                         @D14BDRP 02734001
         ICM   R5,15,PFVTABE      PAGE BELONGS TO VPOOL        @D14BDRP 02735001
         BNP   PGINS20            NO  ---------->              @D52VDVB 02736001
         USING VTABE,R5           BASE OF VTABE                @D14BDRP 02737001
         LR    RA,RE              COPY REGISTER                @D51GDTP 02738001
         SRL   RA,PNSHIFT         GET NUMBER OUT OF ADDRESS    @D51GDTP 02739001
         STCM  RA,M7,VTFRAM       SET FRAME# IN VTABE          @D51GDTP 02740001
         DROP  R5                 DELETE BASE OF VTABE         @D14BDRP 02741001
PGINS20  SLR   R0,R0                                           @D52VDVB 02742001
         TM    PTESTAT2,PTEPDS    VALID COPY ON PDS            @D14ADVB 02743001
         BZ    PGINSEXT           NO, RETURN OFFSET 0          @D52VDVB 02744001
*SGLINK  PGISUBLK,INPUT=(R8,R9,RA,RB,RC,RE),NOMODR=(R7-RF),            *02745001
               AMODE=31 DATON                                           02746001
         BAL   RA,PGISUBLK                                     @D52VDVB 02747001
         B     PGINS80            ------------>                @D52VDVB 02748001
         DROP  R2                 DELETE BASE OF PTE           @D52VDVB 02749001
         SPACE 1                                               @D52VDVB 02750001
*-------------------------------------------------------------*@D52VDVB 02751001
*     BLOCKED PAGE-IN                                          @D52VDVB 02752001
*-------------------------------------------------------------*@D52VDVB 02753001
         SPACE 1                                               @D52VDVB 02754001
PGINS50  DS    0H                                              @D52VDVB 02755001
*SGLINK  PGISBLCK,INPUT=(R8,R9,RA,RB),NOMODR=(R7-RF),AMODE=31 DATON     02756001
         BAL   RA,PGISBLCK                                     @D52VDVB 02757001
         SPACE 1                                               @D52VDVB 02758001
*-------------------------------------------------------------*@D52VDVB 02759001
*     COMMON EXIT                                              @D52VDVB 02760001
*-------------------------------------------------------------*@D52VDVB 02761001
         SPACE 1                                               @D52VDVB 02762001
PGINS80  LA    R0,PAGEIO-PMRGTPBG(,0)                          @D52VDVB 02763001
PGINSEXT DS    0H                                              @D52VDVB 02764001
         LM    R7,RF,PMRSLEV0+OFR7 RESET CALLER'S REGISTERS    @D52VDVB 02765001
         ALR   R7,R0              CONSIDER RETURN OFFSET       @D52VDVB 02766001
         BR    R7                 ===========>  EXIT PGINSIO   @D52VDVB 02767001
         SPACE 1                                                        02768001
*-------------------------------------------------------------*@D52VDVB 02769001
         EJECT                                                 @D52VDVB 02770001
*-------------------------------------------------------------*@D52VDVB 02771001
*        ROUTINE PROLOGUE                                      @D52VDVB 02772001
*        ROUTINE NAME: PGISUBLK                                @D52VDVB 02773001
*        MACRO:        SGPMR                                   @D52VDVB 02774001
*        FUNCTION:  PREPARES READ FROM PDS INTO PAGEFRAME      @D52VDVB 02775001
*        CALLED BY:                                            @D52VDVB 02776001
*              PGINSIO WITH AMODE(31),DATON                    @D529DRP 02777001
*        CALLED ROUTINES:                                      @D529DRP 02778001
*              SEEKEXT  WITH AMODE(31),DATON                   @D529DRP 02779001
*              CCWADDRF WITH AMODE(31),DATON                   @D529DRP 02780001
*        ENTRY POINTS:                                         @D52VDVB 02781001
*              PGISUBLK                                        @D52VDVB 02782001
*        EXIT :     RETURN TO CALLER WITH AMODE(31),DATON      @D529DVB 02783001
*        ERROR EXIT: -                                         @D52VDVB 02784001
*        INPUT:     R8  :  ADDR PAGE MANAGEMENT DATA AREA      @D52VDVB 02785001
*                   R9  :  BASE OF I/O ROUTINES                @D52VDVB 02786001
*                   RA  :  RETURN REGISTER                     @D52VDVB 02787001
*                   RC  :  ADDRESS (PFTE BELONGING TO HANDLED PAGE)     02788001
*                   RE  :  ADDR (PAGE FRAME)                   @D52VDVB 02789001
*                   RB  :  ADDR (DEVCB)                        @D52VDVB 02790001
*-------------------------------------------------------------*@D52VDVB 02791001
*   OPERATION:                                                 @D52VDVB 02792001
*        EPA = PAGEADDR;              /* CURRENT EPA        */ @D52VDVB 02793001
*        CALL SEEKADDR(READ,1);       /* CCW PGM            */ @D52VDVB 02794001
*                            /*EOC CONDITION NOT APPLICABLE */ @D52VDVB 02795001
*        CALL CCWADDRF(READ,PFTE,F,DVCB);/*GENERATE READ CCW*/ @D52VDVB 02796001
*    END PGISUBLK;                                             @D52VDVB 02797001
*------------------------------------------------------------* @D52VDVB 02798001
         SPACE 1                                               @D14ADVB 02799001
*SGLINK  PGISUBLK,S,INPUT=(R8,R9,RA,RB,RC,RE),NOMODR=(R7-RF),          *02800001
               AMODE=31 DATON                                           02801001
PGISUBLK DS    0H                                              @D14ADVB 02802001
         STM   RA,RF,PMRSLEV1+OFR10                            @D52VDVB 02803001
         L     R4,PFPGQE          GET ACTUAL TIB ADDR          @D52VDRP 02804001
         USING TIBADR,R4          BASE OF TIB                  @D52VDRP 02805001
         ST    RC,PGINF           SET SELECTED PFTEADDR        @D52VDRP 02806001
         L     R5,TIBPFSCB        SCB WHERE PAGE I/O BELONGS TO@D52VDVB 02807001
         USING SCBADR,R5          BASE OF SCB                  @D52VDVB 02808001
*        GENSERV INC,FIELD=SCBPICNT,REG=(R0)                   @D52VDVB 02809001
         GENSERV INC,FIELD=SCBPICNT,REG=(R0)                   @D52VDVB 02810001
         DROP  R5                 DELETE BASE OF SCB           @D52VDVB 02811001
         LH    R5,TIBRTID         GET TID OF REQUESTOR         @D52VDVB 02812001
         SLL   R5,2                                            @D66CDOW 02813001
         AL    R5,ATIBATAB                                     @D66CDOW 02814001
         L     R5,0(,R5)          R5 = TIB ADDR OF REQUESTOR   @D66CDOW 02815001
         L     R5,TIBPCB-TIBADR(,R5) PCB OF REQUESTOR          @D52VDVB 02816001
         USING PCBADR,R5          BASE OF PCB                  @D52VDVB 02817001
*        GENSERV INC,FIELD=PCBPICNT,REG=(R0)                   @D52VDVB 02818001
         GENSERV INC,FIELD=PCBPICNT,REG=(R0)                   @D52VDVB 02819001
         DROP  R5                 DELETE BASE OF SCB           @D14BDRP 02820001
         DROP  R4                 DELETE BASE OF TIB           @D52VDVB 02821001
*        GENSERV INC,FIELD=PICTR,REG=(R0)                      @D52VDVB 02822001
         GENSERV INC,FIELD=PICTR,REG=(R0)                      @D52VDVB 02823001
*        GENSERV INC,FIELD=PGICNTAB,REG=(R0)                   @D61NDVB 02824001
         GENSERV INC,FIELD=PGICNTAB,REG=(R0)                   @D61NDVB 02825001
         L     R1,PAGEADDR        GET EPA                      @D52VDVB 02826001
         LA    R0,1(,0)                                        @D52VDVB 02827001
         BAL   RA,SEEKADR         PROVIDE SEEK ADDRESS         @D35ZDAA 02828001
*SGLINK  SEEKADR,INPUT=(R0,R1,R8,R9,RA,RB,RC,RE),OUTPUT=(R0),          *02829001
               NOMODR=(R1-RF),AMODE=31 DATON                            02830001
         BAL   RA,CCWADDRF        PROVIDE READ CCW             @D35ZDAA 02831001
*SGLINK  CCWADDRF,INPUT=(R0,R8,R9,RA,RC,RE),NOMODR=(R0-RF),            *02832001
               AMODE=31 ANY                                             02833001
         LM    RA,RF,PMRSLEV1+OFR10                            @D52VDVB 02834001
         BR    RA                 ==========>  EXIT PGISUBLK   @D52VDVB 02835001
         EJECT                                                 @D52VDVB 02836001
*-------------------------------------------------------------*@D52VDVB 02837001
*        ROUTINE PROLOGUE                                      @D52VDVB 02838001
*        ROUTINE NAME: PGISBLCK                                @D52VDVB 02839001
*        MACRO:        SGPMR                                   @D52VDVB 02840001
*        FUNCTION:  READS A SET OF PAGES FROM THE PDS INTO     @D52VDVB 02841001
*                   FRAMES                                     @D52VDVB 02842001
*        CALLED BY:                                            @D52VDVB 02843001
*              PGINSIO WITH AMODE(31),DATON                    @D52VDRP 02844001
*        CALLED ROUTINES:                                      @D52VDRP 02845001
*              SEEKEXT  WITH AMODE(31),DATON                   @D52VDRP 02846001
*              CCWADDRF WITH AMODE(31),DATON                   @D52VDRP 02847001
*              CCWADDRN WITH AMODE(31),DATON                   @D52VDRP 02848001
*        ENTRY POINTS:                                         @D52VDVB 02849001
*              PGISBLCK                                        @D52VDVB 02850001
*        EXIT :     RETURN TO CALLER WITH AMODE(31),DATON      @D52VDVB 02851001
*        ERROR EXIT: -                                         @D52VDVB 02852001
*        INPUT:     R8  :  ADDR PAGE MANAGEMENT DATA AREA      @D52VDVB 02853001
*                   R9  :  BASE OF I/O ROUTINES                @D52VDVB 02854001
*                   RA  :  RETURN REGISTER                     @D52VDVB 02855001
*                   RB  :  ADDR (DEVCB)                        @D52VDVB 02856001
*------------------------------------------------------------* @D52VDVB 02857001
*    OPERATION:                                                @D52VDVB 02858001
*        GET PSLSTATE(IORE)       /* BITMASK BLOCKED PAGEIN  */@D52VDVB 02859001
*        GET BLNR (PSLSTATE)      /* NUMBER OF BLOCKED PAGES */@D52VDVB 02860001
*        GET FIRST PFTE(IORE,PSLSTATE)                         @D52VDVB 02861001
*        GET EPA(PFTE)            /* GET RELATED EPA         */@D52VDVB 02862001
*        CALL SEEKADDR(BLNR,EPA)  /* GET DISK ADDRESS        */@D52VDVB 02863001
*        IF CKD_EOC                                            @D52VDVB 02864001
*            THEN DO                                           @D52VDVB 02865001
*              ADJUST PSLSTATE    /* FORCE READ FOR SECOND   */@D52VDVB 02866001
*                                 /* PART OF OF BLOCKED PAGES*/@D52VDVB 02867001
*              ADJUST DEVCPSL     /* CONSIDER BLOCKED PART   */@D52VDVB 02868001
*            END                                               @D52VDVB 02869001
*        DO WHILE BLNR > 0        /* GENERATE SEEK CCW-S     */@D52VDVB 02870001
*          IF DATA-SUPPRESS       /* DATA SUPPRESS NO POSSIBL*/@D52VDVB 02871001
*            THEN FRAME = LAST FRAME  /* FOR FIRST FRAME     */@D52VDVB 02872001
*            ELSE FRAME (PFTE)                                 @D52VDVB 02873001
*          CALL SEEKADDRF/N (READ,FRAME) /* GENERATE READ CCW*/@D52VDVB 02874001
*          PFTE = NEXT-SLOT                                    @D52VDVB 02875001
*          DECREASE BLNR                                       @D52VDVB 02876001
*        END-DO-WHILE                                          @D52VDVB 02877001
*        RETURN                                                @D52VDVB 02878001
*    END(PGISBLCK)                                             @D52VDVB 02879001
*------------------------------------------------------------* @D52VDVB 02880001
         SPACE 1                                               @D52VDVB 02881001
*SGLINK  PGISBLCK,S,INPUT=(R8,R9,RA,RB),NOMODR=(R7-RF),AMODE=31 DATON   02882001
PGISBLCK DS    0H                                              @D52VDVB 02883001
         STM   RA,RF,PMRSLEV1+OFR10                            @D52VDVB 02884001
         SGCOV SGPMR,MC=3                                      @D52VDVB 02885001
         L     RC,PFPGQE          CURRENT IORE ( PSEUDO TIB)   @D52VDVB 02886001
         USING TIBADR,RC          BASE OF TIB                  @D52VDVB 02887001
         L     R5,TIBPFSCB        SCB WHERE PAGE I/O BELONGS TO@D52VDVB 02888001
         USING SCBADR,R5          BASE OF SCB                  @D52VDVB 02889001
*        GENSERV INC,FIELD=SCBPICNT,REG=(R0)                   @D52VDVB 02890001
         GENSERV INC,FIELD=SCBPICNT,REG=(R0)                   @D52VDVB 02891001
         L     R5,TIBPCB          PCB WHERE PAGE I/O BELONGS TO@D52VDVB 02892001
         USING PCBADR,R5          BASE OF PCB / DELETE BASE SCB@D52VDVB 02893001
*        GENSERV INC,FIELD=PCBPICNT,REG=(R0)                   @D52VDVB 02894001
         GENSERV INC,FIELD=PCBPICNT,REG=(R0)                   @D52VDVB 02895001
         DROP  R5                 DELETE BASE OF SCB           @D52VDVB 02896001
*        GENSERV INC,FIELD=PICTR,REG=(R0)                      @D52VDVB 02897001
         GENSERV INC,FIELD=PICTR,REG=(R0)                      @D52VDVB 02898001
         L     R2,TIBAALU         ADDRESS OF PISLSTATE         @D52VDVB 02899001
         USING PSLSTATE,R2        BASE OF PSLSTATE             @D52VDVB 02900001
         SLR   R5,R5                                           @D52VDVB 02901001
         IC    R5,PSLSTATE        CURRENT PISL VALUE           @D52VDVB 02902001
         SLL   R5,PGIOFSH                                      @D52VDVB 02903001
         AL    R5,APGINTAB        CURRENT PGINENT              @D52VDVB 02904001
         USING PGINENT,R5         BASE OF PGINENT              @D52VDVB 02905001
         L     R3,PGINPFOF        RELATED OFFSET IN TIBAPFT    @D52VDVB 02906001
         LA    R3,TIBAPFT(R3)     ADDRESS OF FIRST PFTE-ADDRESS        *02907001
                                  ... TO BE HANDLED            @D52VDVB 02908001
         LH    R6,PGINBLK         NUMBER OF BLOCKED PAGES      @D52VDVB 02909001
*      GENSERV COUNT,BLVAL=(R6),WORKR=(RF),FIELD=PGICNTAB      @D61NDVB 02910001
       GENSERV COUNT,BLVAL=(R6),WORKR=(RF),FIELD=PGICNTAB      @D61NDVB 02911001
         IC    RF,PGINVAL         BLOCKING MASK                @D52VDVB 02912001
         STC   RF,PGOIOPSL        SAVE IT IN IORE              @D52VDVB 02913001
         DROP  R5                 DELETE BASE OF PGINENT       @D52VDVB 02914001
         SPACE 1                                               @D52VDVB 02915001
*        AMODESW SET,DAT=OFF      ENTER REAL MODE              @D52VDVB 02916001
         AMODESW SET,DAT=OFF      ENTER REAL MODE              @D52VDVB 02917001
         L     RE,0(,R3)         ADDRESS OF FIRST PFTE TO BE           *02918001
                                  ... HANDLED                  @D52VDVB 02919001
         USING PFTE,RE            BASE OF PFTE                 @D52VDVB 02920001
         L     R1,PFTEPNR         CONVERT EPA NR               @D52VDVB 02921001
.*       N     R1,PAGNMASK        ...  ( CURRENTLY NO NEEDS )  @D52VDVB 02922001
         SLL   R1,PNSHIFT         ...  TO EPA                  @D52VDVB 02923001
         DROP  RE                 DELETE BASE OF PFTE          @D52VDVB 02924001
*        AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @D52VDVB 02925001
         AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @D52VDVB 02926001
         LR    R0,R6                                           @D52VDVB 02927001
         BAL   RA,SEEKADR         GET SEEK ADDRESS             @D52VDVB 02928001
*SGLINK  SEEKADR,INPUT=(R0,R1,R8,R9,RA,RB,RC,RE),OUTPUT=(R0),          *02929001
               NOMODR=(R1-RF),AMODE=31 DATON                            02930001
         SPACE 1                                               @D52VDVB 02931001
         USING DEVCB,RB           BASE OF DEVCB                @D52VDVB 02932001
         STC   RF,DEVCPSL         CURRENT VALUE IN DEVCB       @D52VDVB 02933001
         LTR   R5,R0              ANY ADJUSTEMENTS FOR CKD-EOC @D52VDVB 02934001
         BZ    PGISBL40           NO, ---------->              @D52VDVB 02935001
         SPACE 1                                               @D52VDVB 02936001
*-------------------------------------------------------------*@D52VDVB 02937001
*     ADJUSTMENTS FOR CKD-EOC                                  @D52VDVB 02938001
*-------------------------------------------------------------*@D52VDVB 02939001
         SPACE 1                                               @D52VDVB 02940001
         SGCOV SGPMRS,MC=1        *** SPECIAL ***              @D52VDVB 02941001
         SLR   R6,R5              ADJUSTED NBR(CONTIGUOUS BLKS)@D52VDVB 02942001
         LR    R0,RF              BLOCKED PART OF PSLSTATE     @D52VDVB 02943001
         SLL   R0,0(R5)           ADJUST BLOCKED PART          @D52VDVB 02944001
         NR    R0,RF              ... TO BE PROCESSED          @D52VDVB 02945001
         STC   R0,DEVCPSL         PROVIDE IT IN DEVCB          @D52VDVB 02946001
         STC   R0,PGOCYPSL        SAVE IT IN IORE              @D52VDVB 02947001
         XR    RF,R0              VALUE OF NOT PROCESSED PART OF       *02948001
                                  ... CONTIGUOUS BLOCKS (EOC)  @D52VDVB 02949001
*                                 ADJUST PISLSTATE ACCORDINGLY @D52VDVB 02950001
         IC    R0,PSLSTATE        ... TO BLOCKED PART          @D52VDVB 02951001
         NR    R0,RF              ... CONSIDER PROCESSED PART          *02952001
                                  ... AND DETERMINE NEW PISL   @D52VDVB 02953001
         SPACE 1                                               @D52VDVB 02954001
*-------------------------------------------------------------*@D52VDVB 02955001
         SPACE 1                                               @D52VDVB 02956001
PGISBL40 DS    0H                                              @D52VDVB 02957001
         STC   R0,PSLSTATE        PROVIDE AFFECTED PISLSTATE   @D52VDVB 02958001
         DROP  R2                 RESET ADDR PISL.PSLSTATE     @D52VDVB 02959001
         LA    RF,CCWADDRF        EP TO GENERATE 1ST CCW       @D52VDVB 02960001
         SPACE 1                                               @D52VDVB 02961001
PGISBL50 DS    0H                                              @D52VDVB 02962001
         SLR   R0,R0              READ                         @D52VDVB 02963001
         LTR   RE,RE              ANY DATA SUPPRESSION         @D52VDVB 02964001
         BZ    PGISBL70           YES, ---------->             @KD40354 02965001
         LR    R5,RE                                           @DA42913 02966001
*        AMODESW SET,DAT=OFF      SWITCH IN REAL MODE          @KD40354 02967001
         AMODESW SET,DAT=OFF      SWITCH IN REAL MODE          @KD40354 02968001
         USING PFTE,RE            ADDRESS BASE OF PFTE         @KD40354 02969001
         L     RA,PFTEPNR         GET ...                      @KD40354 02970001
         N     RA,PAGNMASK        ... RELATED                  @KD40354 02971001
         SLL   RA,PNRPTOSH        ...                          @KD40354 02972001
         AL    RA,APT             ... PTE                      @KD40354 02973001
         DROP  RE                 DELETE BASE OF PFTE          @KD40354 02974001
*        AMODESW SET,DAT=ON       SWITCH IN VIRTUAL MODE       @KD40354 02975001
         AMODESW SET,DAT=ON       SWITCH IN VIRTUAL MODE       @KD40354 02976001
         USING PTE,RA             ADDRESS BASE OF PTE          @KD40354 02977001
         TM    PTESTAT2,PTEPDS    VALID COPY ON PDS            @KD40354 02978001
         BO    PGISBL80           YES, --------->              @KD40354 02979001
         DROP  RA                 DELETE BASE OF PTE           @KD40354 02980001
PGISBL70 DS    0H                                              @KD40354 02981001
         LR    RE,R5              PROVIDE LAST PFTE AS DUMMY   @D52VDVB 02982001
         BCTR  R0,0               READ, SUPPRESS DATA TRANSFER @D52VDVB 02983001
PGISBL80 DS    0H                                              @D52VDVB 02984001
         SL    RE,APFT            OFFSET IN PFT                @D52VDVB 02985001
         SLL   RE,PFSHIFT         REAL ADDRESS OF FRAME        @D52VDVB 02986001
*SGLINK  CCWADDRF,INPUT=(R0,R8,R9,RA,RE),NOMODR=(R0-RF),AMODE=31 ANY    02987001
         BALR  RA,RF              GENERATE FIRST CCW           @D52VDVB 02988001
*SGLINK  CCWADDRN,INPUT=(R0,R8,R9,RA,RC,RE),NOMODR=(R0-RF),AMODE=31 ANY 02989001
         LA    RF,CCWADDRN        ENTRY POINT TO GENERATE 2ND AND      *02990001
                                  AND FURTHER CCW-S            @D52VDVB 02991001
         LA    R3,4(,R3)          NEXT SLOT IN TIBAPFT         @D52VDVB 02992001
         L     RE,0(,R3)          ADDR OF NEXT PFTE            @D52VDVB 02993001
         BCT   R6,PGISBL50        EOL, NO ---------->          @D52VDVB 02994001
         SPACE 1                                               @D52VDVB 02995001
         LM    RA,RF,PMRSLEV1+OFR10                            @D52VDVB 02996001
         BR    RA                 ==========>  EXIT PGISBLCK   @D52VDVB 02997001
         SPACE 1                                                        02998001
         DROP  RB                 DELETE BASE OF DEVCB         @D52VDVB 02999001
         DROP  RC                 DELETE BASE OF TIB           @D52VDVB 03000001
         SPACE 1                                                        03001001
*-------------------------------------------------------------*@D52VDVB 03002001
         EJECT                                                 @D52VDVB 03003001
*-------------------------------------------------------------*@D149DVB 03004001
*        ROUTINE PROLOGUE                                      @D149DVB 03005001
*        ROUTINE NAME: SEEKADR                                 @D149DVB 03006001
*        MACRO:        SGPMR                                   @D149DVB 03007001
*        MODULE;       PMRIOMOD                                @D149DVB 03008001
*        FUNCTION:  SEARCHS EXTENT ON PDS AND PROVIDES         @D149DVB 03009001
*                   DISK ADDRESS                               @D149DVB 03010001
*        CALLED BY:                                            @D149DVB 03011001
*              PGISUBLK AT SEEKADR  WITH AMODE(31),DATON       @D529DVB 03012001
*              PGISBLCK AT SEEKADR  WITH AMODE(31),DATON       @D529DVB 03013001
*              PGOSUBLK AT SEEKADRF WITH AMODE(31),DATON       @D529DVB 03014001
*              PGOSBLCK AT SEEKADRF WITH AMODE(31),DATON       @D529DVB 03015001
*        CALLED ROUTINES:                                      @D529DRP 03016001
*              GETPDS   WITH AMODE(31),DATON                   @D529DRP 03017001
*              SCVRTBAL WITH AMODE(24),DATON                   @D529DRP 03018001
*        ENTRY POINT:                                          @D149DVB 03019001
*              SEEKADRF                                        @D149DVB 03020001
*              SEEKADR                                         @D149DVB 03021001
*        EXIT :  CALLER WITH AMODE(31),DATON                   @D149DVB 03022001
*        ERROR EXIT: -                                         @D149DVB 03023001
*        INPUT:                                                @D149DVB 03024001
*                   R0  :  NUMBER OF PAGES / FRAMES            @D529DVB 03025001
*                   R1  :  EPA                                 @D149DVB 03026001
*                   R2  :  ADDR (PFTE)     ... SEEKADRF        @D149DVB 03027001
*                   R8  :  ADDR PAGE MANAGEMENT DATA AREA      @D149DVB 03028001
*                   R9  :  BASE OF CODE (PMRIOMOD)             @D529DVB 03029001
*                   RA  :  RETURN REGISTER                     @D149DVB 03030001
*                   RB  :  ADDRESS OF DEVCB                    @D149DVB 03031001
*        OUTPUT:                                               @D529DVB 03032001
*                   R0  :  NUMBER OF PAGES NOT BE PROCESSED    @D529DVB 03033001
*                          DUE TO EOC CONDITION                @D529DVB 03034001
*-------------------------------------------------------------*@D149DVB 03035001
*    OPERATION:                                                @D149DVB 03036001
*        SEEKADRF :                                            @D149DVB 03037001
*        IF PFTE.PFTEBLK = ON     /* ONLY BLOCK CONNECTED    */@D149DVB 03038001
*           THEN DO                                            @D149DVB 03039001
*               BLKNR := BLKNR + VIOVPNF                       @D149DVB 03040001
*               GOTO SEEKA010                                */@D149DVB 03041001
*           ELSE                                               @D149DVB 03042001
*        SEEKADR:                                              @D149DVB 03043001
*        IF ADDR(PAGE) > VIOPEPA  /* PAGE BELONGS TO VIOPOOL */@D149DVB 03044001
*           THEN DO                                            @D149DVB 03045001
*               ADDR_VTAB(ADDR(PAGE) /*  GET ADDR (VTAB)     */@D149DVB 03046001
*               BLKNR := VTAB.VTBLKN /*  GET BLOCK NR        */@D149DVB 03047001
*               BLKNR := BLKNR + VIOVPNF                       @D149DVB 03048001
*           END                                                @D149DVB 03049001
*           ELSE BLKNR := PAGENR(PAGE)                         @D149DVB 03050001
*        END_IF                                                @D149DVB 03051001
*        SEEKA010:                                           */@D149DVB 03052001
*        ADDR_DPD (DEVCB)              /* 1ST DPD FOR DEVICE */@D149DVB 03053001
*        UNTIL BLKNR < DPD.DPDGUL DO                           @D149DVB 03054001
*              DPD := NEXT  (DPD)      /*  NEXT DPD ENTRY    */@D149DVB 03055001
*           END                                                @D149DVB 03056001
*        CCW.ADDR := ADDR(PAGEFRAME)                           @D149DVB 03057001
*        IF DEVCB.DEVSTAT = AVRFBA /*    FBA DEVICE          */@D149DVB 03058001
*           THEN DO                                            @D149DVB 03059001
*               DEF.EXT.ST :=  DPD LOWER LIMIT                 @D149DVB 03060001
*               DEF.EXT.UL :=  DPD LOGICAL END - 1             @D149DVB 03061001
*           /*  DEF.EXT.LL :=  0      PER DEFINITEM          */@D149DVB 03062001
*               LOC.BEG    :=  (BLKNR-DPDPGUL)*DPDBLKPG        @D149DVB 03063001
*           END                                                @D149DVB 03064001
*           ELSE DO                /*     CKD DEVICE         */@D149DVB 03065001
*               R := BLKNR MOD(DPDREC#)  + 1                   @D149DVB 03066001
*               TT := (BLKNR DIV(DPDREC#))MOD(DPDTRCK#)        @D149DVB 03067001
*               CC := (BLKNR DIV(DPDREC#))DIV(DPDTRCK#)        @D149DVB 03068001
*               IF RPS DEVICE                                  @D52VDVB 03069001
*                 THEN CALL SCVRTBAL /* PROVIDE SECTOR VALUE */@D52VDVB 03070001
*               IF ECKD DEVICE                                 @D52VDVB 03071001
*                 THEN PROVIDE DEFINE EXTENT DATA              @D52VDVB 03072001
*                 ELSE DO                                      @D52VDVB 03073001
*                    IF EOC CONDITION                          @D52VDVB 03074001
*                      THEN PROVIDE NR OF PAGES ON NEXT CYL    @D52VDVB 03075001
*                 END                                          @D52VDVB 03076001
*           END                                                @D149DVB 03077001
*        END_IF                                                @D149DVB 03078001
*        END (SEEKADR);                                        @D149DVB 03079001
*------------------------------------------------------------* @D149DVB 03080001
*        INVARIANT REGISTERS: R1-RA,RC-RF                      @D529DVB 03081001
*------------------------------------------------------------* @D149DVB 03082001
*        REGISTER USAGE                                                 03083001
*              R0 - WORKREGISTER                               @D52VDVB 03084001
*              R1 - WORK REGISTER  (RPS SUPPORT)               @D149DRP 03085001
*              R2 - ADDR OF DPDTAB-ENTRY                                03086001
*              R3 - WORK REGISTER                              @D369DRP 03087001
*              R4 - WORK REGISTER                              @D149DRP 03088001
*              R5 - RELATIVE PAGE NUMBER                                03089001
*              R7 - WORK REGISTER (RPS SUPPORT)                @D149DRP 03090001
*              RB - ADDR OF ACTUAL DEVCB                       @D149DRP 03091001
*              RC - WORK REGISTER                              @D149DRP 03092001
*-------------------------------------------------------------*@D149DVB 03093001
         SPACE 1                                                        03094001
*SGLINK  SEEKADRF,S,INPUT=(R0,R1,R2,R8,R9,RA),OUTPUT=(R0),             *03095001
               NOMODR=(R1-RF),AMODE=31 ANY,DATON                        03096001
SEEKADRF DS    0H                                              @D14BDRP 03097001
         STM   RA,R6,PMRSLEV2+OFR10                            @D52VDVB 03098001
*        AMODESW SET,DAT=OFF      ENTER REAL MODE              @D52VDRP 03099001
         AMODESW SET,DAT=OFF      ENTER REAL MODE              @D52VDRP 03100001
         USING PFTE,R2                                         @D14BDRP 03101001
         TM    S370FLG,PFTEBLK    ONLY BLOCK CONNECTED         @D14BDRP 03102001
*        AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @D52VDRP 03103001
         AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @D52VDRP 03104001
         DROP  R2                                              @D14BDRP 03105001
         BZ    SEEKA000           NO,  ---------->             @D51GDRP 03106001
         LR    R5,R1              GET ...                      @D52VDVB 03107001
         SRL   R5,PNSHIFT         ... RELATIVE BLOCK NUMBER    @D52VDVB 03108001
         A     R5,VIORECN1        GET REC# ON PDS              @D14BDRP 03109001
         B     SEEKA010           ---------->                  @D14BDRP 03110001
         SPACE 1                                               @D52VDVB 03111001
SEEKADR  DS    0H                                              @D52VDVB 03112001
*SGLINK  SEEKADR,S,INPUT=(R0,R1,R8,R9,RA,RB,RC,RE),OUTPUT=(R0),        *03113001
               NOMODR=(R1-RF),AMODE=31 DATON                            03114001
         STM   RA,R6,PMRSLEV2+OFR10                            @D52VDVB 03115001
SEEKA000 LR    R5,R1              GET EPA (INPUT FOR GETPDS)            03116001
         MVC   PMRSCB,PFSCB       PROVIDE SCB-ADDR FOR GETPDS  @D52VDRP 03117001
         L     R9,APMRSERV        GET ADDRESSABILITY           @D52VDVB 03118001
         USING PMRSERV,R9         ... TO SERVICE MODULE        @D52VDVB 03119001
         BAL   RB,GETPDS          GET RECORD NUMBER ON PDS     @D51GDRP 03120001
*SGLINK GETPDS,INPUT=(R5,R8,R9,RB),OUTPUT=(R5),NOMODR=(R6-R2,R4)        03121001
         L     R9,APMRIORT        RESET .....                  @D52VDVB 03122001
         USING PMRIOMOD,R9        ... ADDRESSABILITY IOMODULE  @D52VDVB 03123001
SEEKA010 DS    0H                                              @D14BDRP 03124001
         L     RB,PFDEVCB         GET ADDR OF ACTUAL DEVCB     @D14BDRP 03125001
         USING DEVCB,RB                                        @D14BDRP 03126001
         L     R2,DEVDPD          GET 1.ENTRY PDP-ENTRY FOR DEV@D35ZDAA 03127001
         SLR   R3,R3                                           @D61RDVB 03128001
         IC    R3,DEVEXT#         GET NO OF ENTR. TO BE SEARCH.@D61RDVB 03129001
         USING DPDENTR,R2         SET BASE FOR DPDTAB ENTRY    @D35ZDAA 03130001
         L     RC,DEVRELO         GET RELOC. VALUE OF 1ST EXT. @D14NDFG 03131001
*                        (I.E. UPPER LIMIT OF PREV. DPD-ENTRY) @D14BDRP 03132001
SEEKLOOP C     R5,DPDPGUL         IS PAGE#<=UPPER LIMIT        @D14NDFG 03133001
         BNH   ENDLOOP            ..YES, ENTRY IS FOUND        @D35MDAA 03134001
         L     RC,DPDPGUL         SAVE UPPER LIM. OF THIS ENTRY@D14NDFG 03135001
         LA    R2,DPDENTL(,R2)    GET NEXT ENTRY               @D14ZDVB 03136001
         BCT   R3,SEEKLOOP        CONTINUE SEARCHING           @D35MDAA 03137001
         STCM  R5,B'1111',*+8     SAVE REG 5                   @D64ADOW 03138001
         BAL   R5,PMRHWERR        HARDWAIT IF ENTRY NOT FOUND  @D35MDAA 03139001
         DC    X'00000000'                                     @D64ADOW 03140001
ENDLOOP  EQU   *                                               @D35MDAA 03141001
         SR    R5,RC              GET RELATIVE PAGE NUMBER ON  @D35MDAA 03142001
         BCTR  R5,0                THIS EXTENT                 @D35MDAA 03143001
         MVC   DEVCCB+CCBCLS-CCBADR(2),DPDPUB  MOVE PUB INDEX  @D14BDRP 03144001
         OI    DEVCCB+CCBCLS-CCBADR,CCBPHYAD+XCPR              @D51EDRP 03145001
         CLI   DPDDEVT,AVRFBA     IS PDS EXTENT ON FBA DEVICE? @D35ZDAA 03146001
         BNE   CKDA               ...NO, IT IS CKD/ECKD DEVICE @D35ZDAA 03147001
         SPACE 1                                               @D35ZDAA 03148001
*-------------------------------------------------------------*@D149DVB 03149001
*     PROVIDE FBA EXTENT / LOCATE INFORMATION                 *@D529DVB 03150001
*        INPUT                                                *@D529DVB 03151001
*              R2 - ADDR OF DPDTAB-ENTRY                      *@D522DVB 03152001
*              R5 - RELATIVE PAGENUMBER FOR EXTENT            *@D529DVB 03153001
*-------------------------------------------------------------*@D149DVB 03154001
         LA    R4,PDSEXT          GET ADDRESS OF DEF.EXT.AREA  @D14BDRP 03155001
         L     R3,DPDBLKLL        STORE BLOCK# OF LOWER LIMIT  @D35MDAA 03156001
         ST    R3,4(R4)            OF EXTENT IN DEFINE EXT.CCW @D14BDRP 03157001
         L     R3,DPDBLKU         STORE LOGICAL END ADDR ...   @DA28255 03158001
         BCTR  R3,0               ... OF EXTENT ...            @DA28255 03159001
         ST    R3,12(R4)          ... IN DEFINE EXT. CCW       @D14BDVB 03160001
         MH    R5,DPDBLKPG        PROVIDE RELATIVE BLOCK#      @D35ZDAA 03161001
         ST    R5,DEVRLDSP        ... IN LOCATE FIELD          @D14BDRP 03162001
         MH    R0,DPDBLKPG        PROVIDE NR OF FBA RECORDS    @D52VDVB 03163001
         STH   R0,DEVBLCNT        ... TO BE READ/WRITTEN       @D52VDVB 03164001
         B     SEEKEXIT           ---------->  RETURN          @D52VDVB 03165001
         SPACE 1                                               @D35ZDAA 03166001
*-------------------------------------------------------------*@D149DVB 03167001
*     PROVIDE CKD / ECKD DISK ADDRESS                                   03168001
*        CALCULATE HEAD#, CYLINDER# AND TRACK# FOR PAGE I/O             03169001
*        INPUT                                                          03170001
*              R2 - ADDR OF DPDTAB-ENTRY                                03171001
*              R5 - RELATIVE PAGENUMBER FOR EXTENT                      03172001
*-------------------------------------------------------------*@D149DVB 03173001
         SPACE 1                                               @D14ADVB 03174001
CKDA     LH    R3,DPDREC#         GET NUMBER OF RECORDS/TRACK  @D14ADVB 03175001
         SLR   R4,R4              ZERO FOR DIVIDE              @D14ADVB 03176001
         DR    R4,R3              R5=RT,R4=REST                         03177001
         A     R5,DPDRTLL         DPDRTLL+RT                            03178001
         LA    R4,1(,R4)          CONSIDER RECORD 0  ... REC # @D14ADVB 03179001
         STC   R4,DEVSRR          ===<  RECORD VALUE           @D14ADVB 03180001
         SLR   R3,R3              GET NUMBER OF ...            @D61ADRP 03181001
         ICM   R3,3,DPDTRCK#      ... TRACKS / CYL             @D61ADRP 03182001
         SLR   R4,R4              CALCULATE CC AND HH          @D14ADVB 03183001
         DR    R4,R3              R4=HH,R5=CC                           03184001
         STH   R4,DEVSRHH               ===<  HEAD VALUE       @D14ADVB 03185001
         STH   R5,DEVSRCC               ===< CYLINDER VALUE    @D14ADVB 03186001
         SPACE 1                                               @D35ZDAA 03187001
         CLI   DPDDEVT,AVRCKD     IS IT CKD-DEVICE?            @D52VDVB 03188001
         BE    SEEKA070           ---------->  YES, EXIT       @D52VDRP 03189001
         SPACE 1                                               @D35ZDAA 03190001
*-------------------------------------------------------------*@D149DVB 03191001
*     PROVIDE SECTOR VALUE FOR RPS DEVICES                              03192001
*        INPUT                                                          03193001
*               R2 - ADDR OF DPDTAB-ENTRY                               03194001
*-------------------------------------------------------------*@D149DVB 03195001
         SPACE 1                                                        03196001
         L     R1,IJBARPSR        GET ADRESS OF SCVRT                   03197001
         ICM   R1,M8,DPDDEVC      GET DEVICE TYPE              @D35ZDAA 03198001
         SR    R0,R0              ZERO REG ZERO                         03199001
         ICM   R0,M12,CKDRW+D6    GET REC LENGTH                        03200001
         IC    R0,DEVSRR          GET REC NUMBER                        03201001
         L     R7,ASCVRTBA        GET ADDRESS OF SECT CONV RTN @D36ZDRP 03202001
*        AMODESW CALL,REGS=(R7,R7) GO GET SECTOR NUMBER        @D52VDRP 03203001
         AMODESW CALL,REGS=(R7,R7) GO GET SECTOR NUMBER        @D52VDRP 03204001
*SGLINK  SCVRTBAL,INPUT=(R0,R1,R7),OUTPUT=(R0)                 @D369DRP 03205001
         STC   R0,DEVLCSEC        STORE SECT VAL               @D51EDRP 03206001
         CLI   DPDDEVT,AVRECKD    IS IT ECKD DEVICE            @D51EDRP 03207001
         BE    SEEKA100           YES, ---------->             @D52VDRP 03208001
         SPACE 1                                               @D52VDVB 03209001
*-------------------------------------------------------------*@D52VDVB 03210001
*    CHECK FOR CKD-EOC CONDITION                               @D52VDVB 03211001
*-------------------------------------------------------------*@D52VDVB 03212001
.*   ALGORITHM ASSUMES THAT THE NUMBER OF CONTIGUOUS BLOCKS    @D52VDVB 03213001
.*   IS SMALLER THAN THE CYLINDER CAPACITY                     @D52VDVB 03214001
.*------------------------------------------------------------*@D52VDVB 03215001
         SPACE 1                                               @D52VDVB 03216001
SEEKA070 DS    0H                                              @D52VDVB 03217001
         L     R0,PMRSLEV2+OFR0                                @D52VDVB 03218001
         CL    R0,F1              NBR(CONTIGUOUS BLOCKS) = 1   @D52VDVB 03219001
         BE    SEEKEXIT           YES, --------->              @D52VDVB 03220001
         LH    R1,DEVSRHH         HH VALUE                     @D52VDVB 03221001
         SLR   R3,R3                                           @D52VDVB 03222001
         IC    R3,DEVSRR          R VALUE                      @D52VDVB 03223001
         BCTR  R3,0               BLOCK WILL BE WRITTEN ON THIS        *03224001
                                  ... RECORD NUMBER            @D52VDVB 03225001
         ALR   R3,R0              R = R+NBR(CONTIGUOUS BLKS)-1 @D52VDVB 03226001
SEEKA080 CH    R3,DPDREC#         R ON SAME TRACK              @D52VDVB 03227001
         BNH   SEEKA090           YES,---------->              @D52VDVB 03228001
         SH    R3,DPDREC#         R = R - RECORD/TRACK         @D52VDVB 03229001
         LA    R1,1(,R1)          HH = HH+1                    @D52VDVB 03230001
         B     SEEKA080                                        @D52VDVB 03231001
SEEKA090 CLM   R1,3,DPDTRCK#      HH ON SAME CYLINDER          @D61ADRP 03232001
         BL    SEEKEXIT           YES,---------->              @D52VDVB 03233001
         ST    R3,PMRSLEV2+OFR0   NUMBER OF PAGES ON NEXT CYL. @D52VDVB 03234001
         B     SEEKXXIT           ---------->                  @D52VDVB 03235001
         SPACE 1                                               @D52VDVB 03236001
*-------------------------------------------------------------*@D52VDVB 03237001
*    HANDLE ECKD DEVICE                                        @D52VDVB 03238001
*-------------------------------------------------------------*@D52VDVB 03239001
         SPACE 1                                               @D52VDVB 03240001
SEEKA100 DS    0H                                              @D52VDVB 03241001
         L     R7,DPDXNTLL        SET LOWER EXTENT LIMIT       @D51EDRP 03242001
         ST    R7,PDSEXT+8         ... IN DEFINE EXTENT AREA   @D51EDRP 03243001
         L     R7,DPDXNTUL        SET UPPER EXTENT LIMIT       @D51EDRP 03244001
         ST    R7,PDSEXT+12        ... IN DEFINE EXTENT AREA   @D51EDRP 03245001
         L     R7,DEVSRCH         SET SEEK ADDR (CCHH)         @D51EDRP 03246001
         ST    R7,DEVLCSAD         IN LOCATE FIELD             @D51EDRP 03247001
         L     R0,PMRSLEV2+OFR0                                @D52VDVB 03248001
         STC   R0,DEVLCCNT        NUMBER OF READ/WRITE CCW-S   @D52VDVB 03249001
         DROP  R2                 FORGET BASE FOR DPDENTRY     @D35ZDAA 03250001
         SPACE 1                                               @D52VDVB 03251001
*------------------------------------------------------------* @D529DVB 03252001
SEEKEXIT DS    0H                                              @D52VDVB 03253001
         XC    PMRSLEV2+OFR0(4),PMRSLEV2+OFR0 FORCE R0 = 0 ...         *03254001
                                  ... AT RETURN                @D52VDVB 03255001
SEEKXXIT LM    RA,R6,PMRSLEV2+OFR10                            @D52VDVB 03256001
         BR    RA                 ===========>  RETURN         @D14ADVB 03257001
         SPACE 1                                               @D52VDVB 03258001
         DROP  RB                 FORGET BASE FOR DEVCB        @D14BDRP 03259001
         EJECT                                                 @D52VDVB 03260001
*------------------------------------------------------------* @D529DVB 03261001
*        ROUTINE PROLOGUE                                      @D529DVB 03262001
*        ROUTINE NAME: CCWADDR                                 @D529DVB 03263001
*        MACRO:        SGPMR                                   @D529DVB 03264001
*        FUNCTION:  INITIALIZES THE CCW-S IN THE CURRENT DEVCB @D529DVB 03265001
*                   DISK ADDRESS                               @D529DVB 03266001
*        CALLED BY:                                            @D529DVB 03267001
*              PGISBLCK, PGISUBLK,                             @D529DVB 03268001
*              PGOSBLCK, PGOSUBLK    WITH AMODE(31),ANY        @D529DVB 03269001
*        CALLED ROUTINES: -                                    @D529DRP 03270001
*        ENTRY POINT:                                          @D529DVB 03271001
*              CCWADDRF :  FIRST CCW TO BE HANDLED             @D529DVB 03272001
*              CCWADDRN :  NEXT  CCW TO BE HANDLED             @D529DVB 03273001
*        EXIT :  CALLER WITH AMODE(31),DATON                   @D529DVB 03274001
*        ERROR EXIT: -                                         @D529DVB 03275001
*        INPUT:                                                @D529DVB 03276001
*                   R0  :  = 0 READ                            @D529DVB 03277001
*                       :  > 0 WRITE                           @D529DVB 03278001
*                       :  < 0 READ, SUPPRESS DATA TRANSFER    @D529DVB 03279001
*                   R8  :  ADDR PAGE MANAGEMENT DATA AREA      @D529DVB 03280001
*                   R9  :  BASE OF CODE (PMRIOMOD)             @D529DVB 03281001
*                   RA  :  RETURN REGISTER                     @D529DVB 03282001
*                   RB  :  ADDRESS OF CURRENT DEVCB            @D529DVB 03283001
*                   RE  :  ADDRESS OF CURRENT FRAME            @D529DVB 03284001
*        OUTPUT:                                               @D529DVB 03285001
*                   -                                          @D529DVB 03286001
*------------------------------------------------------------* @D529DVB 03287001
         SPACE 1                                               @D52VDVB 03288001
CCWADDRN DS    0H                                              @D52VDVB 03289001
*SGLINK  CCWADDRN,S,INPUT=(R0,R8,R9,RA,RB,RE),NOMODR=(R0-RF),          *03290001
               AMODE=31 ANY                                             03291001
         USING DEVCB,RB                                        @D52VDVB 03292001
         STM   R1,R6,PMRSLEV3+OFR1 SAVE REGISTERS              @D52VDVB 03293001
         SLR   R3,R3                                           @D52VDVB 03294001
         L     R4,PMRSACCW        PREVIOUS CCW ADDRESS         @D52VDVB 03295001
         LA    R5,8(,R4)          CURRENT CCW ADDRESS READ     @D52VDVB 03296001
         CLI   DEVCBTYP,AVRECKD   ECKD DEVICE                  @D52VDVB 03297001
         BE    CCWAD020           YES, ---------->             @D52VDVB 03298001
         CLI   DEVCBTYP,AVRFBA    FBA  DEVICE                  @D52VDVB 03299001
         BE    CCWAD020           YES, ---------->             @D52VDVB 03300001
         LTR   R0,R0              READ REQUEST                 @D52VDVB 03301001
         BNP   CCWAD020           YES , --------->             @D52VDVB 03302001
*     SPECIAL ACTIONS FOR CKD OPERATION                        @D52VDVB 03303001
         L     R1,DEVDPD          1ST DPD ENTRY                @D52VDVB 03304001
         USING DPDENTR,R1                                      @D52VDVB 03305001
         LA    R5,16(,R5)         CURRENT CCW ADDRESS WRITE    @D52VDVB 03306001
         L     R6,PMRSASRC        ADDRESS OF PREVIOUS SEARCH           *03307001
                                  ... ARGUMENTS                @D52VDVB 03308001
         LH    R2,DEVSRHH-DEVSRCH(,R6) HH VALUE                @D52VDVB 03309001
         SLR   R3,R3                                           @D52VDVB 03310001
         IC    R3,DEVSRR-DEVSRCH(,R6)  R  VALUE                @D52VDVB 03311001
         LA    R3,1(,R3)          R = R+1                      @D52VDVB 03312001
         CH    R3,DPDREC#         R ON SAME TRACK              @D52VDVB 03313001
         BNH   CCWAD010           YES ---------->              @D52VDVB 03314001
         LA    R3,1(,0)           R = 1                        @D52VDVB 03315001
         LA    R2,1(,R2)          HH = HH+1                    @D52VDVB 03316001
         CLM   R2,3,DPDTRCK#      HH ON SAME CYLINDER          @D61ADRP 03317001
         BL    CCWAD010           YES, --------->              @D52VDVB 03318001
         DROP  R1                                              @D52VDVB 03319001
         BAL   R5,PMRHWERR        ==============> HW           @D52VDVB 03320001
CCWAD010 LH    R1,DEVSRCC-DEVSRCH(,R6)                         @D52VDVB 03321001
         LA    R6,6(,R6)          ADDRESS OF CURRENT SEARCH            *03322001
                                  ... ARGUMENTS                @D52VDVB 03323001
         STH   R1,DEVSRCC-DEVSRCH(,R6) CC VALUE                @D52VDVB 03324001
         STH   R2,DEVSRHH-DEVSRCH(,R6) HH VALUE                @D52VDVB 03325001
         STC   R3,DEVSRR-DEVSRCH(,R6)  R  VALUE                @D52VDVB 03326001
         ST    R6,PMRSASRC        SAVE ADDRESS                 @D52VDVB 03327001
         SPACE 1                                               @D52VDVB 03328001
CCWAD020 DS    0H                                              @D52VDVB 03329001
         USING CCWADR,R4          R4 ADDRESSES PREVIOUS CCW    @D52VDVB 03330001
         IC    R3,DEVCBTYP        DEVICE TYP                   @D52VDVB 03331001
*                                  = OFFSET IN CHAIN INDICATION        *03332001
                                   TABLE                       @D52VDVB 03333001
         IC    R3,CCWCHTAB(R3)    CHAINING INDICATION          @D52VDVB 03334001
         EX    R3,CCWCHOI         IN PREVIOUS CCW              @D52VDVB 03335001
         LR    R4,R5              BUMP TO CURRENT CCW          @D52VDVB 03336001
         ST    R4,PMRSACCW                                     @D52VDVB 03337001
         L     R5,PMRSAIDL                                     @D52VDVB 03338001
         LA    R5,8(,R5)          BUMP TO CURRENT IDAL         @D52VDVB 03339001
         ST    R5,PMRSAIDL                                     @D52VDVB 03340001
         B     CCWAD100           ---------->                  @D52VDVB 03341001
         SPACE 1                                               @D52VDVB 03342001
CCWADDRF DS    0H                                              @D52VDVB 03343001
*SGLINK  CCWADDRF,S,INPUT=(R0,R8,R9,RA,RB,RE),NOMODR=(R0-RF),          *03344001
               AMODE=31 ANY                                             03345001
         STM   R1,R6,PMRSLEV3+OFR1 SAVE REGISTERS              @D52VDVB 03346001
         LA    R4,DEVSRCH         ADDRESS OF CURRENT SEARCH    @D52VDVB 03347001
         ST    R4,PMRSASRC                                     @D52VDVB 03348001
         LA    R4,DEVGIDAL        ADDRESS OF CURRENT IDAL      @D52VDVB 03349001
         ST    R4,PMRSAIDL                                     @D52VDVB 03350001
         LA    R4,CKDGENRD        READ CCW REAQUEST            @D52VDVB 03351001
         ST    R4,PMRSACCW        ADDRESS OF CURRENT READ/             *03352001
                                  ... WRITE CCW                @D52VDVB 03353001
         CLI   DEVCBTYP,AVRFBA    IS IT FBA DEVICE             @D14BDRP 03354001
         BNE   CCWAD050           NO, ---------->              @D52VDVB 03355001
         SPACE 1                                               @D52VDVB 03356001
*     INITIALIZE FBA                                           @D52VDVB 03357001
         SPACE 1                                               @D52VDVB 03358001
         LTR   R0,R0              READ REQUEST                 @D52VDVB 03359001
         BNP   CCWAD040           YES, ---------->             @D52VDVB 03360001
         MVI   DEVLCOP,WRITE      SET WRITE OPCODE IN LOC. INF.@D14BDRP 03361001
         MVI   PDSEXT,X'C0'       ALLOW ALL WRITE OPERATIONS   @D14BDRP 03362001
         B     CCWAD100           ---------->                  @D52VDVB 03363001
CCWAD040 DS    0H                                              @D14BDRP 03364001
         MVI   DEVLCOP,RDDATA     SET READ OPCODE IN LOC. INFO @D14BDRP 03365001
         MVI   PDSEXT,INHWRITE    INHIBIT ALL WRITE OPERATIONS @D14BDRP 03366001
         B     CCWAD100           ---------->                  @D52VDVB 03367001
         SPACE 1                                               @D52VDVB 03368001
CCWAD050 DS    0H                                              @D52VDVB 03369001
         CLI   DEVCBTYP,AVRECKD   IS IT ECKD DEVICE            @D51EDRP 03370001
         BE    CCWAD080           YES,----------->             @D51EDRP 03371001
         SPACE 1                                               @D52VDVB 03372001
*     INITIALIZE CKD                                           @D52VDVB 03373001
         SPACE 1                                               @D52VDVB 03374001
         LA    R4,CKDGENRD        ADDRESS OF FIRST READ  CCW   @D52VDVB 03375001
         LTR   R0,R0              READ REQUEST                 @D52VDVB 03376001
         BNP   CCWAD060           YES, ---------->             @D52VDVB 03377001
         LA    R4,CKDGENWR        ADDRESS OF FIRST WRITE CCW   @D52VDVB 03378001
CCWAD060 DS    0H                                              @D52VDVB 03379001
         ST    R4,PMRSACCW        SAVE ADDRESS AND CONNECT     @D52VDVB 03380001
         STCM  R4,M7,CKDEOC+1     ... SEEK-SEARCH-TIC WITH             *03381001
                                  ... READ / WRITE             @D52VDVB 03382001
         B     CCWAD100                                        @D52VDVB 03383001
         SPACE 1                                               @D52VDVB 03384001
*     INITIALIZE CCW FOR ECKD                                  @D52VDVB 03385001
         SPACE 1                                               @D52VDVB 03386001
CCWAD080 DS    0H                                              @D52VDVB 03387001
         LTR   R0,R0              READ REQUEST                 @D52VDVB 03388001
         BNP   CCWAD090           YES, ---------->             @D52VDVB 03389001
         MVI   DEVLCOP,WRITE      SET WRITE OPCODE IN LOC. INF.@D14BDRP 03390001
         MVI   PDSEXT,X'C0'       ALLOW ALL WRITE OPERATIONS   @D14BDRP 03391001
         B     CCWAD100                                        @D14BDRP 03392001
CCWAD090 DS    0H                                              @D14BDRP 03393001
         MVI   DEVLCOP,X'16'      SET READ OPCODE IN LOC. INFO @D51EDRP 03394001
         MVI   PDSEXT,X00         INHIBIT   WRITE OPERATIONS   @D52VDVB 03395001
         SPACE 1                                               @D51EDRP 03396001
*     PROVIDE FRAME ADDRESS IN READ/WRITE CCW                  @D52VDVB 03397001
         SPACE 1                                               @D52VDVB 03398001
CCWAD100 NI    CCWFLGS(R4),XFF-DC-CC-SKIP RESET SKIP DATA, COMMAND AND *03399001
                                  DATA CHAINING IN CURRENT CCW @D52VDVB 03400001
         LTR   R0,R0              SUPPRESS DATA TRANSFER       @D52VDVB 03401001
         BNM   CCWAD105           NO  ---------->              @D52VDVB 03402001
         OI    CCWFLGS(R4),SKIP   INDICATE SKIP DATA TRANSFER  @D52VDVB 03403001
CCWAD105 L     R5,PMRSAIDL        CURRENT IDAL ADDRESS         @D52VDVB 03404001
         LR    R3,RE              COPY REGISTER                @D51GDTP 03405001
         A     R3,F2048           BUMP BY 2K                   @D51GDTP 03406001
         ST    RE,0(,R5)          SET UP ADDRESS IN IDAL       @D51GDTP 03407001
         ST    R3,4(,R5)           ...                         @D51GDTP 03408001
         SPACE 1                                               @D51EDRP 03409001
*     PROVIDE OPERATION CODE                                   @D52VDVB 03410001
         SPACE 1                                               @D52VDVB 03411001
         CLI   DEVCBTYP,AVRFBA    IS IT FBA DEVICE             @D14BDRP 03412001
         BNE   CCWAD120           NO, ---------->              @D52VDVB 03413001
*     FBA                                                      @D52VDVB 03414001
         LTR   R0,R0              READ REQUEST                 @D52VDVB 03415001
         BNP   CCWAD110           YES, ---------->             @D52VDVB 03416001
         MVI   CCWBUF,FBAWRITE    SET WRITE OPCODE IN CCW      @D14BDRP 03417001
         B     CCWADEXT           ---------->                  @D52VDVB 03418001
CCWAD110 MVI   CCWBUF,FBAREAD     SET READ OPCODE IN CCW       @D52VDVB 03419001
         B     CCWADEXT           ---------->                  @D52VDVB 03420001
*                                                              @D52VDVB 03421001
CCWAD120 DS    0H                                              @D52VDVB 03422001
         CLI   DEVCBTYP,AVRECKD   IS IT ECKD DEVICE            @D52VDVB 03423001
         BNE   CCWADEXT           NO,  ----------> ALL DONE    @D52VDVB 03424001
*     ECKD                                                     @D52VDVB 03425001
         LTR   R0,R0              READ REQUEST                 @D52VDVB 03426001
         BNP   CCWAD150           YES, ---------->             @D52VDVB 03427001
         MVI   CCWBUF,WDATA+MULTITRK WRITE DATA MULTITRACK     @D52VDVB 03428001
         B     CCWADEXT           ---------->                  @D52VDVB 03429001
CCWAD150 MVI   CCWBUF,READDATA    READ-DATA MULTITRACK         @D52VDVB 03430001
         SPACE 1                                               @D52VDVB 03431001
CCWADEXT LM    R1,R6,PMRSLEV3+OFR1 RESET REGISTERS             @D52VDVB 03432001
         BR    RA                 ===========>   CCWADDR*      @D52VDVB 03433001
         SPACE 1                                               @D52VDVB 03434001
CCWCHOI  OI    CCWFLGS(R4),0                                   @D52VDVB 03435001
CCWCHTAB DC    AL1(0)                                          @D52VDVB 03436001
         DC    AL1(DC)            FBA = DATA CHAINING          @D52VDVB 03437001
         DC    AL1(CC)            CKD = COMMAND CHAINING       @D52VDVB 03438001
         DC    AL1(CC)            RPS = COMMAND CHAINING       @D52VDVB 03439001
         DC    AL1(CC)            ECKD= COMMAND CHAINING       @D52VDVB 03440001
         DROP  R4                                              @D52VDVB 03441001
         DROP  RB                                              @D52VDVB 03442001
*------------------------------------------------------------* @D529DVB 03443001
         EJECT                                                 @D52VDVB 03444001
*-------------------------------------------------------------*@D149DVB 03445001
*        ROUTINE PROLOGUE                                      @D149DVB 03446001
*        ROUTINE NAME:  PGOUTSIO                               @D149DVB 03447001
*        MACRO:         SGPMR                                  @D149DVB 03448001
*        FUNCTION: PROCESSES THE PGQUO-ENTRIES.                @D149DVB 03449001
*                  WRITES PAGE(S) INDICATED BY PGQUO-ENTRY     @D529DVB 03450001
*        CALLED BY:  PMR WITH AMODE(31),DATON                  @D529DRP 03451001
*        ENTRY POINT:                                          @D149DVB 03452001
*               PGOUTSIO-IF A PAGE-OUT REQUEST IS FOUND TO BE  @D149DVB 03453001
*                        HANDLED ON ACTUAL DEVICE              @D149DVB 03454001
*        CALLED ROUTINE:                                       @D149DVB 03455001
*               PGOSUBLK                      AMODE(31),DATOFF @D529DRP 03456001
*               PGQPFTE, PGOSBLCK, PFTEPOSL   AMODE(31),DATON  @D529DVB 03457001
*        INPUT:                                                @D149DVB 03458001
*               R8 - ADDR OF PAGEMANAGEMENT DATA-AREA          @D149DVB 03459001
*               RA - RETURN ADDRESS                            @D149DVB 03460001
*               RB - ADDR DEVCB TO WHICH THE PAGE-OUT REQ.     @D149DVB 03461001
*                    IS QUEUED                                 @D149DVB 03462001
*               RC - ADDR OF IORE (PSEUDO TIB)                 @D529DVB 03463001
*        OUTPUT:                                               @D149DVB 03464001
*               PTE.PTESTAT = PTEPDS  PDSBIT ON                @D149DVB 03465001
*        EXIT:  RETURN TO CALLER WITH AMODE(31),DATON          @D529DRP 03466001
*                    OFFSET 0 -  NO I/O REQUIRED               @D529DVB 03467001
*                    OFFSET 4 -  I/O REQUIRED                  @D529DRP 03468001
*        RETURN CODE: NONE                                     @D149DVB 03469001
*        EXIT ERROR:  NONE                                     @D149DVB 03470001
*        EXTERNAL REFERENCES:                                  @D149DVB 03471001
*               PGQUO(READ,WRITE)                              @D149DVB 03472001
*               PFTE(READ,WRITE)                               @D149DVB 03473001
*               PAGE-STATE(READ,WRITE)                         @D149DVB 03474001
*-------------------------------------------------------------*@D149DVB 03475001
*    OPERATION:                                                @D149DVB 03476001
*      IF IORE.PGQTYP = PGDELO                                 @D52VDVB 03477001
*        THEN GOTO PGOSIONO;                                 */@D52VDVB 03478001
*        ELSE DO;                                              @D52VDVB 03479001
*        IF IORE.PGQTYP = PGOBLK  /*   ?? PRE PAGE-OUT ??    */@D52VDVB 03480001
*          THEN DO;                                            @D52VDVB 03481001
*            IF (* BLOCKING FACTOR STILL SUFFICIENT *)         @D52VDVB 03482001
*              THEN DO;           /*      PRE-PAGE-OUT       */@D52VDVB 03483001
*                 CALL PGOQPFTE;                               @D52VDVB 03484001
*                 CALL PGOSBLCK;                               @D52VDVB 03485001
*              END;                                            @D52VDVB 03486001
*              ELSE GOTO PGOSIONO;                             @D52VDVB 03487001
*                                 /*POSLSTATE UNCHANGED      */@D52VDVB 03488001
*          END;                                                @D52VDVB 03489001
*          ELSE DO;               /* UNCONDITIONAL PAGE-OUT  */@D52VDVB 03490001
*            PFI = IORE.TIBSTATE;                              @D52VDVB 03491001
*            IF IORE.PGQTYP /= (PGVIORQ | PGPMRSP )            @D52VDVB 03492001
*              THEN DO;                                        @D52VDVB 03493001
*               IF IORE.PGQTYP /= PGIOERR                      @D52VDVB 03494001
*               THEN DO;                                       @D52VDVB 03495001
*                 CALL PFTEPOSL   /* GET CURRENT POSLSTATE   */@D52VDVB 03496001
*                 /* BLOCKED PAGE-OUT WHENEVER POSSIBLE      */@D52VDVB 03497001
*                 QB=(* PSLSTATE(UNC PAGEOUT)X(POSL.PSLSTATE*) @D52VDVB 03498001
*                 /* COMBINATION OF UNC. AND PRE-PAGE-OUT    */@D52VDVB 03499001
*                 IF (* QB = BLOCKED PAGE-OUT *)               @D52VDVB 03500001
*                   THEN DO;                                   @D52VDVB 03501001
*                     CALL PGOQCHCK;                           @D52VDVB 03502001
*                     /*INTERRELATIONS TO OTHER PENDING REQ-S*/@D52VDVB 03503001
*                     IORE.PQTYP = OR(PGBLK,IORE.PGQTYP);      @D52VDVB 03504001
*                                 /*  BLOCKED PAGE-OUT         @D52VDVB 03505001
*                     CALL PGOQPFTE;                         */@D52VDVB 03506001
*                     CALL PGOSBLCK;                           @D52VDVB 03507001
*                     IF (* CKD EOC *)                         @D52VDVB 03508001
*                       THEN DO;                               @D52VDVB 03509001
*                         QB = UNBLOCKED PAGE-OUT;             @D52VDVB 03510001
*                         IORE.PGQTYP = RESET(PGBLK);          @D52VDVB 03511001
*                         CALL PGOQPFTE;                       @D52VDVB 03512001
*                       END;                                   @D52VDVB 03513001
*                   END;                                       @D52VDVB 03514001
*               END;                                           @D52VDVB 03515001
*               IF IORE.PGQTYP=NOT(PGBLK) | IORE.PGQTYP=PIOERR @D52VDVB 03516001
*                   THEN DO;      /* DO UNBLOCKED PAGE-OUT     @D52VDVB 03517001
*                     CALL PFTEPOSL;                           @D52VDVB 03518001
*                     CALL PGOSUBLK;                           @D52VDVB 03519001
*                     IF (* NOT PAGEOUT *) THEN GOTO PGOSIONO; @D52VDVB 03520001
*                   END;                                       @D52VDVB 03521001
*              END;                                            @D52VDVB 03522001
*              ELSE DO;       /* PGVIORQ OR PAGE-MGR-SPACE   */@D52VDVB 03523001
*                CALL PGOSUBLK;                                @D52VDVB 03524001
*                IF (* NOT PAGEOUT *) THEN GOTO PGOSIONO;      @D52VDVB 03525001
*              END;                                            @D52VDVB 03526001
*          END;                                                @D52VDVB 03527001
*          RETURN (RI=PAGEOUT STARTED);                        @D52VDVB 03528001
*                                                              @D52VDVB 03529001
*        PGOSIONO:                                             @D52VDVB 03530001
*          CALL DELPGQO;          /* DELETE IORE             */@D52VDVB 03531001
*          RETURN(RI=NO I/O);                                  @D52VDVB 03532001
*        END;                                                */@D52VDVB 03533001
*    END(PGOUTSIO);                                            @D52VDVB 03534001
*------------------------------------------------------------* @D149DVB 03535001
*        INTERNAL USAGE OF REGISTERS                           @D149DVB 03536001
*              R1 - ADDR OF PAGE TO BE HANDLED                 @D149DVB 03537001
*              R2 - ADDR OF PFTE CORRESP. TO R1                @D149DVB 03538001
*              R3 - ZERO OR ADDR OF DEVCB WAITING FOR PAGE-OUT @D149DVB 03539001
*              R4-R5,RD,RF WORKREGISTERS                       @D149DVB 03540001
*              R7 - LINK REGISTER TO 1ST LEVEL                 @D149DVB 03541001
*              R8 - ADDR OF PAGE-MANAGEMENT DATA AREA          @D149DVB 03542001
*              R9 - ADDR OF PMR CODE AREA                      @D149DVB 03543001
*              RA - LINK REGISTER TO 2ND LEVEL                 @D149DVB 03544001
*              RB - UNCHANGED (ADDR OF DEVCB)                  @D149DVB 03545001
*              RC - ADDR OF PAGE-OUT REQ. TIB                  @D149DVB 03546001
*              RE - LINK REGISTER TO 0TH LEVEL                 @D529DVB 03547001
*                 - ADDR OF PF CORRESP. TO RC  (/370-ONLY)     @D149DVB 03548001
*-------------------------------------------------------------*@D149DVB 03549001
         SPACE 1                                               @D149DVB 03550001
         USING TIBADR,RC          SET BASE FOR PAGE-OUT REQ.   @D14BDRP 03551001
         USING DEVCB,RB                                        @D52VDVB 03552001
*SGLINK  PGOUTSIO,S,INPUT=(R7,R8,RB,RC),NOMODR=(R7-RF)                  03553001
PGOUTSIO DS    0H                 START PAGE OUT               @D52VDVB 03554001
         STM   R7,RF,PMRSLEV0+OFR7  SAVE CALLER'S REGISTERS    @D52VDVB 03555001
         L     R9,APMRIORT        GET BASE                     @D52VDVB 03556001
         TM    PGQTYP,PGDELO      REQUEST DEACTIVATED          @D52VDVB 03557001
         BO    PGOSIONO           YES, ---------->             @D52VDVB 03558001
*        GENSERV INC,FIELD=POCTR,REG=(R0)                      @D52VDVB 03559001
         GENSERV INC,FIELD=POCTR,REG=(R0)                      @D52VDVB 03560001
         TM    PGQTYP,PGBLK+PGO   BLOCKED PAGE OUT             @D52VDVB 03561001
         BO    PGOSIO30           YES, ---------->             @D52VDVB 03562001
         SPACE 1                                               @D52VDVB 03563001
*-------------------------------------------------------------*@D52VDVB 03564001
*     PROCESS UNBLOCKED PAGE OUT                               @D52VDVB 03565001
*        CHECK WHETHER BLOCKED PAGE OUT CAN BE COMBINED        @D52VDVB 03566001
*        WITH THIS PAGE OUT REQUEST                            @D52VDVB 03567001
*        WHENEVER POSSIBLE, START BLOCKED PAGE OUT             @D52VDVB 03568001
*-------------------------------------------------------------*@D52VDVB 03569001
         SPACE 1                                               @D52VDVB 03570001
         L     R2,TIBSTATE        GET ADDR OF PFTE             @D14BDRP 03571001
*     PROVIDE RELATED ALLOCATION UNIT                          @D52VDVB 03572001
*     R2 ADDRESSES PFTE                                        @D52VDVB 03573001
*        GENSERV INC,FIELD=POCTRUNC,REG=(R0)                   @D52VDVB 03574001
         GENSERV INC,FIELD=POCTRUNC,REG=(R0)                   @D52VDVB 03575001
*        GENSERV INC,FIELD=CPGOTUNC,REG=(R0)                   @D52VDVB 03576001
         GENSERV INC,FIELD=CPGOTUNC,REG=(R0)                   @D52VDVB 03577001
         TM    PGQTYP,PGVIORQ+PGPMRSP         PMR-SPACE, VPOOL,        *03578001
                                  BLOCK-CONNECTED (NO POSL)    @D52VDVB 03579001
         BNZ   PGOSIO20           YES, ---------->             @D52VDVB 03580001
         TM    PGQTYP,PGIOERR     I/O ERR DURING BLOCKED PAGOUT@0000036 03581001
         BO    PGOSIO10           YES, ---------->             @0000036 03582001
         SLR   R0,R0              REQUEST: GET POSLSTATE       @D52VDVB 03583001
         LR    RC,R2              ADDR OF CURRENT PFTE         @D52VDVB 03584001
         DROP  RC                                              @D52VDVB 03585001
         L     RA,APFTPOSL                                     @D52VDVB 03586001
*SGLINK  PFTEPOSL,INPUT=(R0,R8,RA,RC),OUTPUT=(R0,R4,R5,R6,R7),         *03587001
               NOMODR=(R1-R3,R8-RF),AMODE=31 ANY,DATOFF                 03588001
         BALR  RA,RA              GET ADDRESS OF POSLSTATE     @D52VDVB 03589001
.*    OUTPUT:   R0  =  PREVIOUS VALUE OF POSLSTATE             @D52VDVB 03590001
.*              R4  =  OFFSET IN POSLSTATE                     @D52VDVB 03591001
.*              R5  =  MASK OF POSLSTATE                       @D52VDVB 03592001
.*              R6  =  CURRENT VALUE OF POSLSTATE              @D52VDVB 03593001
.*              R7  =  ADDRRESS  POSLSTATE                     @D52VDVB 03594001
*        AMODESW SET,DAT=ON                                    @D52VDVB 03595001
         AMODESW SET,DAT=ON                                    @D52VDVB 03596001
         ST    R5,PMRSLEV0+OFR5   POSLVALUE CORRESP TO PFTE    @D52VDVB 03597001
         L     RC,PMRSLEV0+OFR12  REESTABLISH ADDRESS OF IORE          *03598001
                                  / PSEUDO TIB                 @D52VDVB 03599001
         USING TIBADR,RC                                       @D52VDVB 03600001
         L     RD,UNCPGOAC        LIST OF OFFSETS IN UNCPGOTB  @D52VDVB 03601001
         SLR   R3,R3                                           @D52VDVB 03602001
         IC    R3,0(RD,R5)        RELATED OFFSET, ADDRESSED VIA        *03603001
                      ... LISTADDRES + OFFSET  (1 BYTE ENTRIES)@D52VDVB 03604001
         L     RD,UNCPGOTB(R3)    ADDRESS OF RELATED UNCPGO..  @D52VDVB 03605001
*                                 LENGTH OF ENTRY IS EQUAL     @D52VDVB 03606001
*                                 TO THAT ONE OF PSLSTATE      @D52VDVB 03607001
         ALR   RD,R6              ADDRESS OF COMBINED VALUE    @D52VDVB 03608001
*                                  (PAGE-OUT * PRE-PAGE-OUT)   @D52VDVB 03609001
*                                 INDEXED VIA VALUE(POSLSTATE) @D52VDVB 03610001
         USING PSLSTATE,RD        ADDRESSABILITY FOR GENSERV   @D52VDVB 03611001
*     GENSERV  TEST,FIELD=PSLSTATE,REG=(R6),BC=BZ,LAB=PGOSIO10 @D52VDVB 03612001
*              GOTO PGOSIO10 IF NO BLOCKED PAGE OUT POSSIBLE   @D52VDVB 03613001
.*             CONTINUE FOR BLOCKED PAGE-OUT                   @D52VDVB 03614001
.*             R6 = AFFECTED VALUE FOR BLOCKED PAGING          @D52VDVB 03615001
      GENSERV  TEST,FIELD=PSLSTATE,REG=(R6),BC=BZ,LAB=PGOSIO10 @D52VDVB 03616001
         DROP  RD                                              @D52VDVB 03617001
         SPACE 1                                               @D52VDVB 03618001
*-------------------------------------------------------------*@D52VDVB 03619001
*     PAGE-OUT COMBINED WITH PRE-PAGE-OUT                      @D52VDVB 03620001
*-------------------------------------------------------------*@D52VDVB 03621001
         SPACE 1                                               @D52VDVB 03622001
.*   IF THERE IS AN ENQUEUED PRE-PAGE-OUT REQUEST FOR THE SAME @D52VDVB 03623001
.*   ALLOCATION UNIT IT REMAINS ENQUEUED                       @D52VDVB 03624001
         SGCOV SGPMR,MC=4                                      @D52VDVB 03625001
*SGLINK  PGOQCHCK,INPUT=(R6,R7,R8,R9,RC),NOMODR=(R6-R4),AMODE=31 DATON  03626001
         BAL   R7,PGOQCHCK        VERIFY INTERRELATIONS TO OTHER       *03627001
                                  ... UNC. PAGE-OUT-REQ        @D52VDVB 03628001
         OI    PGQTYP,PGBLK       INDICATE BLOCKED PAGE OUT    @D52VDVB 03629001
         LR    R5,RC                                           @D52VDVB 03630001
         SLR   R0,R0              REQUEST = SET PFTE           @D52VDVB 03631001
         L     RA,APGOQPFT        PREPARE PFTE-S               @D52VDVB 03632001
*SGLINK  PGOQPFTE,INPUT=(R0,R5,R6,R8,RA),NOMODR=(R1-RF),AMODE=31 DATON  03633001
         BALR  RA,RA                                           @D52VDVB 03634001
         B     PGOSIOCX           BLOCKED NOT POSSIBLE         @KD40396 03635001
*                                    DUE TO PAGE INVALID       @KD40396 03636001
*------> B     PGOSIO00           BLOCKED POSSIBLE             @KD40396 03637001
         SPACE 1                                               @KD40396 03638001
PGOSIO00 DS    0H                                              @KD40396 03639001
         L     R5,PMRSLEV0+OFR5   POSLVALUE CORRESP TO PFTE    @D52VDVB 03640001
         BAL   R7,PGOSBLCK        HANDLE BLOCKED PAGE OUT      @D52VDVB 03641001
*SGLINK  PGOSBLCK,INPUT=(R5,R6,R7,R8,R9,RB,RC),NOMODR=(R6-RF),         *03642001
               AMODE=31 DATON                                           03643001
         B     PGOSIOCX           EOC FOUND                    @D52VDVB 03644001
         B     PGOSIOEX           PAGE OUT STARTED             @D52VDVB 03645001
         SPACE 1                                               @D52VDVB 03646001
*-------------------------------------------------------------*@D52VDVB 03647001
*     EOC CONDITION FOR BLOCKED UNCONDITIONAL PAGE-OUT         @D52VDVB 03648001
*-------------------------------------------------------------*@D52VDVB 03649001
         SPACE 1                                               @D52VDVB 03650001
PGOSIOCX DS    0H                 CKD-EOC PROCESSING           @D52VDVB 03651001
         SGCOV SGPMRS,MC=2        *** SPECIAL ***              @D52VDVB 03652001
         NI    PGQTYP,XFF-PGBLK   RESET BLOCKED PAGE OUT INDIC.@D52VDVB 03653001
         MVI   DEVCPSL,0          RESET VLAUE IN DEVCB         @D52VDVB 03654001
         LR    R5,RC                                           @D52VDVB 03655001
         LA    R0,12(,0)          SPECIAL RESET REQUEST        @D52VDVB 03656001
         L     RA,APGOQPFT                                     @D52VDVB 03657001
*SGLINK  PGOQPFTE,INPUT=(R0,R5,R6,R8,RA),NOMODR=(R1-RF),AMODE=31 DATON  03658001
         BALR  RA,RA                                           @D52VDVB 03659001
         L     R2,TIBSTATE        GET ADDR OF PFTE             @D14BDRP 03660001
         SPACE 1                                               @D52VDVB 03661001
*-------------------------------------------------------------*@D52VDVB 03662001
*     DO UNBLOCKED PAGE OUT                                    @D52VDVB 03663001
*-------------------------------------------------------------*@D52VDVB 03664001
         SPACE 1                                               @D52VDVB 03665001
PGOSIO10 DS    0H                                              @D52VDVB 03666001
PGOSIO20 DS    0H                                              @D52VDVB 03667001
*SGLINK  PGOSUBLK,INPUT=(R2,R7,R8,R9),OUTPUT=(R1,RE),                  *03668001
               NOMODR=(R2,R7-R9,RC),AMODE=31 DATOFF,DATON               03669001
         BAL   R7,PGOSUBLK        CALL PROCEDURE TO PROCESS UNBLOCKED  *03670001
                                  UNCONDITIONAL PAGE OUT       @D52VDVB 03671001
*                                 RETURNS IN VIRTUAL MODE      @D52VDVB 03672001
         B     PGOSIONO           PAGE-OUT NOT STARTED         @D52VDVB 03673001
         B     PGOSIOEX           PAGE OUT TO BE STARTED       @D52VDVB 03674001
         SPACE 1                                               @D52VDVB 03675001
*-------------------------------------------------------------*@D52VDVB 03676001
*     PROCESS BLOCKED PRE PAGE OUT                             @D52VDVB 03677001
*-------------------------------------------------------------*@D52VDVB 03678001
         SPACE 1                                               @D52VDVB 03679001
PGOSIO30 DS    0H                                              @D52VDVB 03680001
*        GENSERV INC,FIELD=POCTRPRE,REG=(R0)                   @D52VDVB 03681001
         GENSERV INC,FIELD=POCTRPRE,REG=(R0)                   @D52VDVB 03682001
*        GENSERV INC,FIELD=CPGOTPRE,REG=(R0)                   @D52VDVB 03683001
         GENSERV INC,FIELD=CPGOTPRE REG=(R0)                   @D52VDVB 03684001
*     GET ACCESS TO PREPGOTB ENTRY                             @D52VDVB 03685001
PGOSIO40 DS    0H                                              @D52VDVB 03686001
*     GENSERV  PGONT,IORE=(RC),PSLSTAT=(R7),PGONT=(R5),PSLVAL=(R6)      03687001
      GENSERV  PGONT,IORE=(RC),PSLSTAT=(R7),PGONT=(R5),PSLVAL=(R6)      03688001
         USING PREPGENT,R5                                     @D52VDVB 03689001
         LH    R0,PREPGBLK        CURRENT BLOCKING FACTOR      @D52VDVB 03690001
         CH    R0,PPOBLCUR        ... AT LEAST SATISFIED       @D52VDVB 03691001
         BL    PGOSIONO           NO, --------->               @D52VDVB 03692001
         SLR   R6,R6              AFFECTED                     @D52VDVB 03693001
         IC    R6,PREPGVAL        ... VALUE FOR BLOCKED PAGING @D52VDVB 03694001
         DROP  R5                                              @D52VDVB 03695001
         SPACE 1                                               @D52VDVB 03696001
         LR    R5,RC                                           @D52VDVB 03697001
         SLR   R0,R0              REQUEST TYPE = SET PGO-PFTE  @D52VDVB 03698001
         L     RA,APGOQPFT        PREPARE PFTE-S               @D52VDVB 03699001
*SGLINK  PGOQPFTE,INPUT=(R0,R5,R6,R8,RA),NOMODR=(R1-RF),AMODE=31 DATON  03700001
         BALR  RA,RA                                           @D52VDVB 03701001
         B     PGOSIO90           ADJUSTMENTS REQUIRED         @KD40396 03702001
*                                    DUE TO PAGE INVALID       @KD40396 03703001
*------> B     PGOSIO80           BLOCKED POSSIBLE             @KD40396 03704001
         SPACE 1                                               @D52VDVB 03705001
PGOSIO80 DS    0H                                              @KD40396 03706001
         SPACE 1                                               @D52VDVB 03707001
         SLR   R5,R5              NO UNC. PAGE-OUT MASK        @D52VDVB 03708001
         BAL   R7,PGOSBLCK        CALL PROCEDURE TO PROCESS BLOCKED    *03709001
                                  PRE-PAGE-OUT                 @D52VDVB 03710001
*SGLINK  PGOSBLCK,INPUT=(R5,R6,R7,R8,R9,RB,RC),NOMODR=(R6-RF),         *03711001
               AMODE=31 DATON                                           03712001
         B     PMRHWERR           ==========.    HARD WAIT     @D52VDVB 03713001
*------> B     PGOSIOEX           PAGE OUT TO BE STARTED       @D52VDVB 03714001
         SPACE 1                                               @D52VDVB 03715001
PGOSIOEX DS    0H                                              @D52VDVB 03716001
         LM    R7,RF,PMRSLEV0+OFR7  PROVIDE CALLER'S REGISTERS @D52VDVB 03717001
         B     4(,R7)             ==========>  EXIT  PGOUTSIO          *03718001
                                  PAGE OUT TO BE STARTED       @D52VDVB 03719001
*-------------------------------------------------------------*@D52VDVB 03720001
*    RESET TIB PFTE TABLE                                      @D52VDVB 03721001
*-------------------------------------------------------------*@D52VDVB 03722001
         SPACE 1                                               @D52VDVB 03723001
PGOSIO90 DS    0H                                              @KD40396 03724001
         LA    R0,8(,0)           REQUEST TYPE = RESET NORMAL  @KD40396 03725001
         L     RA,APGOQPFT        PREPARE PFTE-S               @KD40396 03726001
*SGLINK  PGOQPFTE,INPUT=(R0,R5,R6,R8,RA),NOMODR=(R1-RF),AMODE=31 DATON  03727001
         BALR  RA,RA                                           @KD40396 03728001
         B     PGOSIO40           RETRY WITH ADJUSTED POSL     @KD40396 03729001
         SPACE 1                                               @D52VDVB 03730001
*-------------------------------------------------------------*@D52VDVB 03731001
*    DEQUEUE IORE FROM PGQUO                                   @D52VDVB 03732001
*    POSLSTATE REMAINS UNCHANGED                               @D52VDVB 03733001
*-------------------------------------------------------------*@D52VDVB 03734001
         SPACE 1                                               @D52VDVB 03735001
PGOSIONO DS    0H                                              @D52VDVB 03736001
         SGCOV SGPMR,MC=5                                      @D52VDVB 03737001
*SGLINK  DELPGQO,INPUT=(R8,R9,RA,RB,RC),NOMODR=(R6-R1),AMODE=31 DATON   03738001
         BAL   RA,DELPGQO         DELETE IORE FROM PGQUO       @D52VDVB 03739001
         DROP  R9                                              @D52VDVB 03740001
         LM    R7,RF,PMRSLEV0+OFR7  PROVIDE CALLER'S REGISTERS @D52VDVB 03741001
         BR    R7                 ==========>  RETURN PGOUTSIO         *03742001
                                  PAGE OUT NOT STARTED         @D52VDVB 03743001
         DROP  RC                                              @D52VDVB 03744001
         EJECT                                                 @D52VDVB 03745001
*-------------------------------------------------------------*@D529DVB 03746001
*        ROUTINE PROLOGUE                                      @D529DVB 03747001
*        ROUTINE NAME:  PGOSUBLK                               @D529DVB 03748001
*        MACRO:         SGPMR                                  @D529DVB 03749001
*        FUNCTION: PROCESSES UNBLOCKED PAGE OUT                @D529DVB 03750001
*        CALLED BY:  PGOUT  AMODE(31),DATOFF                   @D529DRP 03751001
*        ENTRY POINT:                                          @D529DVB 03752001
*               PGOSUBLK                                       @D529DVB 03753001
*        CALLED ROUTINE:                                       @D529DVB 03754001
*        INPUT:                                                @D529DVB 03755001
*               R2 - ADDR OF PFTE                              @D52VDVB 03756001
*               R7 - RETURN ADDRESS                            @D529DVB 03757001
*               R8 - ADDR OF PAGEMANAGEMENT DATA-AREA          @D529DVB 03758001
*               R9 - BASE OF CODE                              @D529DVB 03759001
*               RC - ADDR OF IORE (PAGE-OUT)                   @D529DVB 03760001
*        OUTPUT:                                               @D529DVB 03761001
*               R1 - ADDRESS OF PAGE                           @D529DVB 03762001
*                           > 0 : PAGE OUT TO BE STARTED       @D52VDVB 03763001
*                           = 0 : NO PFTE ENQUEUED ....        @D529DVB 03764001
*                               ....R5 , RE AMBIGUOUS          @D529DVB 03765001
*                           < 0 : PT  NO LONGER VALID ....     @D52VDVB 03766001
*                    IF = 0 : NO PAGE TO BE WRITTEN ON PDS     @D529DVB 03767001
*                             R5, RE AMBIGUOUS                 @D529DVB 03768001
*               R5 - BLOCK NUMBER                              @D529DVB 03769001
*               RE - PAGE FRAME ADDRESS                        @D529DVB 03770001
*        EXIT:  RETURN TO CALLER AMODE(31), DATON              @D529DRP 03771001
*        RETURN CODE: NONE                                     @D529DVB 03772001
*        EXIT ERROR:  NONE                                     @D529DVB 03773001
*-------------------------------------------------------------*@D529DVB 03774001
*        OPERATION:                                            @D52VDVB 03775001
*          CALL PGOSPFTE(TIB,TIBSTATE(;                        @D529DVB 03776001
*          IF (*  PAGE-OUT *)                                  @D529DVB 03777001
*            THEN DO;                                          @D529DVB 03778001
*              CALL SEEKADRF(WRITE,1,DVCB,RI);                 @D529DVB 03779001
*              F = (* FRAME IDENTIFIED BY TIB.TIBSTATE *);     @D529DVB 03780001
*              CALL CCWADDRF(WRITE,TIB.TIBSTATE,F,DVCB);       @D529DVB 03781001
*              RETURN (RC=PAGEOUT);                            @D529DVB 03782001
*            END;                                              @D529DVB 03783001
*            ELSE                                              @D529DVB 03784001
*              RETURN (RC=NO-PAGEOUT);                         @D529DVB 03785001
*      END PGOSUBLK;                                           @D529DVB 03786001
*-------------------------------------------------------------*@D529DVB 03787001
         SPACE 1                                               @D52VDVB 03788001
         USING PMRIOMOD,R9                                     @D52VDVB 03789001
*SGLINK  PGOSUBLK,S,INPUT=(R2,R7,R8,R9),OUTPUT=(R1,RE),                *03790001
               NOMODR=(R2,R8,R9,RC),AMODE=31 DATOFF,DATON               03791001
PGOSUBLK DS    0H                 UNBLOCKED PAGE OUT           @D52VDVB 03792001
         ST    R7,PMRSLEV1+OFR7   SAVE RETURN REGISTER         @D52VDVB 03793001
*        GENSERV INC,FIELD=PGOCNTAB,REG=(R0)                   @D61NDVB 03794001
         GENSERV INC,FIELD=PGOCNTAB,REG=(R0)                   @D61NDVB 03795001
         SPACE 1                                               @D52VDVB 03796001
*SGLINK  PGOSPFTE,INPUT=(R2,R8,R9,RA,RC),OUTPUT=(R1,RE),               *03797001
               NOMODR=(R2-R3,R6-RC,RF),AMODE=31 DATON                   03798001
         BAL   RA,PGOSPFTE                                     @D52VDVB 03799001
         B     PGOSUN50           NO I/O ---------->           @D52VDVB 03800001
* -----> B     PGOSUN10           I/O    ---------->           @D52VDVB 03801001
PGOSUN10 DS    0H                                              @D52VDVB 03802001
*        WRITE PAGE SPECIFIED BY R1 ON PAGE DATA SET           @D529DVB 03803001
.*       REQUIRED DATA:                                        @D529DVB 03804001
.*             R1 - ADDR OF PAGE TO BE WRITTEN ON PDS          @D529DVB 03805001
.*             R2 - ADDR OF PFTE BELONGING TO PAGE             @D529DVB 03806001
.*             R5 - IF PFTEBLK ON, TOTAL RECORD NUMBER         @D149DRP 03807001
.*             RE - ADDR OF CORR. PAGEFRAME                    @D35CDAA 03808001
         LA    R0,1(,0)                                        @D52VDVB 03809001
*SGLINK  SEEKADRF,INPUT=(R0,R1,R2,R8,R9,RA),OUTPUT=(R0),               *03810001
               NOMODR=(R1-RF),AMODE=31 ANY,DATON                        03811001
         BAL   RA,SEEKADRF        PROVIDE SEEK / EXTENT - LOCATE       *03812001
                                  DATA                         @D52VDVB 03813001
         LA    R0,1(,R0)          INDICATE WRITE REQUEST       @D52VDVB 03814001
*SGLINK  CCWADDRF,INPUT=(R0,R8,R9,RA,RB,RE),NOMODR=(R0-RF),AMODE=31 ANY 03815001
         BAL   RA,CCWADDRF        BUILD WRITE CCW              @D52VDVB 03816001
         L     R7,PMRSLEV1+OFR7   GET RETURN REGISTER          @D52VDVB 03817001
         B     4(,R7)             ==========>    EXIT          @D52VDVB 03818001
         SPACE 1                                               @D52VDVB 03819001
PGOSUN50 L     R7,PMRSLEV1+OFR7   GET RETURN REGISTER          @D52VDVB 03820001
         BR    R7                 ==========>    EXIT          @D52VDVB 03821001
         SPACE 1                                               @D52VDVB 03822001
         EJECT                                                 @D52VDVB 03823001
*-------------------------------------------------------------*@D529DVB 03824001
*        ROUTINE PROLOGUE                                      @D529DVB 03825001
*        ROUTINE NAME:  PGOSBLCK                               @D529DVB 03826001
*        MACRO:         SGPMR                                  @D529DVB 03827001
*        FUNCTION: PROCESSES BLOCKED PAGE OUT .                @D529DVB 03828001
*        CALLED BY:  PGOUT  AMODE(31),DATON)                   @D529DRP 03829001
*        ENTRY POINT:                                          @D529DVB 03830001
*               PGOSBLCK                                       @D529DVB 03831001
*                        HANDLED ON ACTUAL DEVICE              @D529DVB 03832001
*        CALLED ROUTINE:                                       @D529DVB 03833001
*               SEEKADRF MODE(31) DATOFF                       @D529DVB 03834001
*               CCWADDRF, PGOSPFTE, PGOQPFTE MODE(31) DATON    @D529DVB 03835001
*        INPUT:                                                @D529DVB 03836001
*               R5 - VALUE OF POSL FOR UNC. PAGEOUT /          @D529DVB 03837001
*                    OTHERWISE 0                               @D529DVB 03838001
*               R6 - VALUE OF BLOCKED PART OF POSL STATE       @D529DVB 03839001
*               RA - RETURN ADDRESS                            @D529DVB 03840001
*               R8 - ADDR OF PAGEMANAGEMENT DATA-AREA          @D529DVB 03841001
*               R9 - BASE OF CODE                              @D529DVB 03842001
*               RB - ADDR DEVCB TO WHICH THE PAGE-OUT REQ.     @D529DVB 03843001
*                    IS QUEUED                                 @D529DVB 03844001
*               RC - ADDR OF PSEUDO-TIB REQ. PAGE-OUT          @D529DVB 03845001
*        OUTPUT:                                               @D529DVB 03846001
*               -                                              @D529DVB 03847001
*        EXIT:  RETURN TO CALLER                               @D529DRP 03848001
*               OFFSET   0    :   EOC , NOT FULLY BLOCKED      @D529DVB 03849001
*               OFFSET   4    :   OK                           @D529DVB 03850001
*        RETURN CODE: NONE                                     @D529DVB 03851001
*        EXIT ERROR:  HARDWAIT FF1                             @D529DVB 03852001
*        EXTERNAL REFERENCES:                                  @D529DVB 03853001
*               PGQO(READ,WRITE)                               @D529DVB 03854001
*               PFTE(READ,WRITE)                               @D529DVB 03855001
*               PAGE-STATE(READ,WRITE)                         @D529DVB 03856001
*-------------------------------------------------------------*@D529DVB 03857001
*      OPERATION:                                              @D529DVB 03858001
*             DVCB.DEVCPSL = (* BLOCKED PART OF Q *);          @D529DVB 03859001
*             N = (* NUMBER OF CONTIGUOUS BLOCKS *);           @D529DVB 03860001
*             CALL SEEKADRF(WRITE,N,DVCB);                     @D529DVB 03861001
*             IF CKD_EOC           /* END OF CYLINDER        */@D529DVB 03862001
*               THEN IF IORE.TIBSTATE /= 0 /* UNCOND PAGEOUT */@D529DVB 03863001
*                 THEN RETURN (CKD_EOC);                       @D529DVB 03864001
*                 ELSE;                                        @D529DVB 03865001
*               ELSE DO;                                       @D529DVB 03866001
*                 DVCB.DEVCPSL=(*BLOCKED PART ON CURRENT CYL*);@D529DVB 03867001
*                 CALL PGOQPFTE (DEL);    /* RESET PFTE-S    */@D529DVB 03868001
*               END;                                           @D529DVB 03869001
*             DO FOR ALL PFI IN IORE.TIBAPFT                   @D529DVB 03870001
*                                        /* BLOCKED PAGE OUT */@D529DVB 03871001
*               CALL PGOSPFTE(PFTE);     /* PROVIDE PFTE     */@D529DVB 03872001
*               F = (* FRAME IDENTIFIED BY PFI *);             @D529DVB 03873001
*               CALL CCWADDRF(WRITE);    /* GEN. WRITE CCW   */@D529DVB 03874001
*             END DO_FOR;                                      @D529DVB 03875001
*             Q  = Q - DVCB.DEVCBPSL     /*RESET POSL.PSLSTAT*/@D529DVB 03876001
*             RETURN (NOR CKD_EOC);                            @D529DVB 03877001
*      END PGOSBLCK;                                           @D529DVB 03878001
*-------------------------------------------------------------*@D529DVB 03879001
         SPACE 1                                               @D52VDVB 03880001
         USING PMRIOMOD,R9                                     @D52VDVB 03881001
         USING DEVCB,RB                                        @D52VDVB 03882001
PGOSBLCK DS    0H                 BLOCKED PAGE OUT             @D52VDVB 03883001
*SGLINK  PGOSBLCK,S,INPUT=(R5,R6,R7,R8,R9,RB,RC),NOMODR=(R0-RF),       *03884001
               AMODE=31 DATON                                           03885001
         STM   R7,R6,PMRSLEV1+OFR7 SAVE RETURN REGISTERS       @D52VDVB 03886001
         SGCOV SGPMR,MC=6                                      @D52VDVB 03887001
         USING TIBADR,RC                                       @D52VDVB 03888001
*        GENSERV  PGONT,PSLVAL=(R6),PGONT=(R5)                 @D52VDVB 03889001
         GENSERV  PGONT,PSLVAL=(R6),PGONT=(R5)                 @D52VDVB 03890001
         USING PREPGENT,R5                                     @D52VDVB 03891001
         STC   R6,PGOIOPSL        EFFECTIVE BLOCKING VALUE     @D52VDVB 03892001
         L     R3,PREPGOFF        RELATED OFFSET IN TIBAPFT =          *03893001
                = OFFSET IN ALLOCATION UNIT *10**(-PNSHIFT+2)  @D52VDVB 03894001
         LA    R3,TIBAPFT(R3)     ADDDRESS OF FIRST PFTE-ADDR          *03895001
                                  ... TO BE HANDLED            @D52VDVB 03896001
         LH    RF,PREPGBLK        NUMBER OF CONTIGUOUS BLOCKS  @D52VDVB 03897001
         DROP  R5                                              @D52VDVB 03898001
         SPACE 1                                               @D52VDVB 03899001
*-------------------------------------------------------------*@D52VDVB 03900001
*     INITIALIZE CCW PROGRAM AND CHECK FOR CKD-EOC             @D52VDVB 03901001
*-------------------------------------------------------------*@D52VDVB 03902001
         SPACE 1                                               @D52VDVB 03903001
         L     R2,0(,R3)          ADDRESS OF FIRST PFTE        @D52VDVB 03904001
*        AMODESW SET,DAT=OFF      ENTER REAL MODE              @D52VDVB 03905001
         AMODESW SET,DAT=OFF      ENTER REAL MODE              @D52VDVB 03906001
         USING PFTE,R2            ADDRESSABILITY TO PFTE       @D52VDVB 03907001
         L     R1,PFTEPNR         CONVERT EPA NR               @D52VDVB 03908001
.*       N     R1,PAGNMASK        ... ( CURRENTLY NO NEEDS)    @D52VDVB 03909001
         SLL   R1,PNSHIFT         ... TO EPA                   @D52VDVB 03910001
         DROP  R2                 RESET ADDRESSABILITY TO PFTE @D52VDVB 03911001
         LR    R0,RF              NUMBER OF CONTIGUOUS PAGES   @D52VDVB 03912001
*SGLINK  SEEKADRF,INPUT=(R0,R1,R2,R8,R9,RA),OUTPUT=(R0),               *03913001
               NOMODR=(R1-RF),AMODE=31 ANY,DATON                        03914001
         BAL   RA,SEEKADRF        PROVIDE SEEK / EXTENT - LOCATE       *03915001
                                  DATA                         @D52VDVB 03916001
         LTR   R5,R0              ANY ADJUSTEMENTS FOR CKD-EOC @D52VDVB 03917001
         BZ    PGOSB050           NO, ---------->              @D52VDVB 03918001
         SPACE 1                                               @D52VDVB 03919001
*-------------------------------------------------------------*@D52VDVB 03920001
*     ADJUSTMENTS FOR CKD-EOC                                  @D52VDVB 03921001
*-------------------------------------------------------------*@D52VDVB 03922001
         SPACE 1                                               @D52VDVB 03923001
         ICM   R0,M15,PMRSLEV1+OFR5 UNCONDITIONAL PAGE-OUT ...         *03924001
                                  ... REQUEST                  @D52VDVB 03925001
         BNZ   PGOSBEOC           YES ----------> RETURN               *03926001
                                  ... AND FORCE UNBL PAGE-OUT  @D52VDVB 03927001
         SGCOV SGPMRS,MC=3        *** SPECIAL ***              @D52VDVB 03928001
         SLR   RF,R5              ADJUSTED NBR(CONTIGUOUS BLKS)@D52VDVB 03929001
         LR    R4,R6              BLOCKED PART OF PSLSTATE     @D52VDVB 03930001
         SLL   R4,0(R5)           ADJUST BLOCKED PART          @D52VDVB 03931001
         NR    R4,R6              ...                          @D52VDVB 03932001
         STC   R4,PGOCYPSL        ... SAVE IT IN TRACE         @D52VDVB 03933001
         XR    R6,R4              VALUE OF NOT PROCESSED PART OF       *03934001
                                  ... CONTIGUOUS BLOCKS (EOC)  @D52VDVB 03935001
.*    R6 CONTAINS RESET MASK                                   @D52VDVB 03936001
         LA    R0,8(,0)           REQUEST TYPE = NORMAL RESET  @D52VDVB 03937001
         LR    R5,RC              ADDR OF IORE / PSEUDO TIB    @D52VDVB 03938001
         L     RA,APGOQPFT                                     @D52VDVB 03939001
*SGLINK  PGOQPFTE,INPUT=(R0,R5,R6,R8,RA),NOMODR=(R1-RF),AMODE=31 DATON  03940001
         BALR  RA,RA              RESET PFTE-S BELONGING TO PAGES      *03941001
                                  ... RESIDING ON OTHER CYLIND.@D52VDVB 03942001
         LR    R6,R4              ADJUSTED BLOCKED PART OF             *03943001
                                  ... POSLSTATE                @KD40356 03944001
         SPACE 1                                                        03945001
*-------------------------------------------------------------*@D52VDVB 03946001
*     SET UP CCW-S FOR CONTIGUOUS PAGES                        @D52VDVB 03947001
*-------------------------------------------------------------*@D52VDVB 03948001
         SPACE 1                                                        03949001
PGOSB050 DS    0H                                              @D52VDVB 03950001
         STC   R6,DEVCPSL         VALUE OF BLOCKED PART OF POSLSTATE   *03951001
                                  ... SAVED IN DEVCB           @D52VDVB 03952001
*      GENSERV COUNT,BLVAL=(RF),WORKR=(R4),FIELD=PGOCNTAB      @D61NDVB 03953001
       GENSERV COUNT,BLVAL=(RF),WORKR=(R4),FIELD=PGOCNTAB      @D61NDVB 03954001
         LR    R6,RF              ACTUAL NBR(CONTIGUOUS BLKS)  @D52VDVB 03955001
         LA    RF,CCWADDRF        EP TO GENERATE 1ST WRITE CCW @D52VDVB 03956001
         SPACE 1                                               @D52VDVB 03957001
PGOSB060 DS    0H                                              @D52VDVB 03958001
*SGLINK  PGOSPFTE,INPUT=(R2,R8,R9,RA,RC),OUTPUT=(R1,RE),               *03959001
               NOMODR=(R2-R3,R6-RC,RF),AMODE=31 DATON                   03960001
         BAL   RA,PGOSPFTE                                     @D52VDVB 03961001
         BAL   R5,PMRHWERR        NO I/O   ==========>  HW     @D52VDVB 03962001
* -----> B     PGOSB070           I/O, ---------->             @D52VDVB 03963001
PGOSB070 DS    0H                                              @D52VDVB 03964001
.*       REQUIRED DATA:                                        @D529DVB 03965001
.*             R2 - ADDR OF PFTE BELONGING TO PAGE             @D529DVB 03966001
.*             R5 - N.A.  -  NOT BLOCK CONNECTED FRAMES        @D149DRP 03967001
.*             RE - ADDR OF CORR. ,RFEFRAME                    @D35CDAA 03968001
         SPACE 1                                                        03969001
         LA    R0,1(,R0)          INDICATE WRITE REQUEST       @D52VDVB 03970001
*SGLINK  CCWADDRF,INPUT=(R0,R8,R9,RA,RB,RE),NOMODR=(R0-RF),            *03971001
               AMODE=31 ANY                                             03972001
         BALR  RA,RF              BUILD WRITE CCW              @D52VDVB 03973001
*SGLINK  CCWADDRN,INPUT=(R0,R8,R9,RA,RB,RE),NOMODR=(R0-RF),            *03974001
               AMODE=31 ANY                                             03975001
         LA    RF,CCWADDRN        EP TO GENERATE FURTHER CCW-S @D52VDVB 03976001
         LA    R3,4(,R3)          NEXT ADDRESS OF PFTE ADDR    @D52VDVB 03977001
         L     R2,0(,R3)          PROVIDE ADDRESS OF PFTE      @D52VDVB 03978001
         BCT   R6,PGOSB060        ITERATE ---------->          @D52VDVB 03979001
         SPACE 1                                               @D52VDVB 03980001
         LM    R7,R6,PMRSLEV1+OFR7 GET RETURN REGISTERS        @D52VDVB 03981001
         B     4(,R7)             ==========>    EXIT PGOSBLCK @D52VDVB 03982001
         SPACE 1                                               @D52VDVB 03983001
*-------------------------------------------------------------*@D52VDVB 03984001
*     CKD-EOC CONDITION FOR UNC. PAGE-OUT                      @D52VDVB 03985001
*-------------------------------------------------------------*@D52VDVB 03986001
         SPACE 1                                               @D52VDVB 03987001
PGOSBEOC DS    0H                                              @D52VDVB 03988001
         SGCOV SGPMRS,MC=4        *** SPECIAL ***              @D52VDVB 03989001
         LM    R7,R5,PMRSLEV1+OFR7 GET RETURN REGISTERS        @D52VDVB 03990001
         BR    R7                 ==========>    EXIT PGOSBLCK @D52VDVB 03991001
         SPACE 1                                               @D52VDVB 03992001
         DROP  RB                 DROP BASE FOR DEVCB          @D14BDRP 03993001
         DROP  RC                 DROP BASE FOR TIB            @D52VDRP 03994001
         EJECT                                                 @D52VDVB 03995001
*------------------------------------------------------------* @D529DVB 03996001
*        ROUTINE PROLOGUE                                      @D529DVB 03997001
*        ROUTINE NAME: PGOSPFTE                                @D529DVB 03998001
*        MACRO:        SGPMR                                   @D529DVB 03999001
*        MODULE;       PMRIOMOD                                @D529DVB 04000001
*        FUNCTION:  PROVIDES PAGE AND RELATED PAGE FRAME       @D529DVB 04001001
*        CALLED BY:                                            @D529DVB 04002001
*              PGOSUBLK AND PGOSBLCK   AMODE(31),DATON         @D529DVB 04003001
*        CALLED ROUTINES:                                      @D529DRP 04004001
*              DELPGQO  WITH AMODE(31),DATON                   @D529DRP 04005001
*        ENTRY POINT:                                          @D529DVB 04006001
*              PGOSPFTE                                        @D529DVB 04007001
*        EXIT :  CALLER WITH AMODE(31),DATON                   @D529DVB 04008001
*                   OFFSET 0  -  NO I/O REQUIRED               @D529DVB 04009001
*                   OFFSET 4  -  I/O                           @D529DVB 04010001
*        INPUT:                                                @D529DVB 04011001
*                   R2  :  ADDR (PFTE)                         @D529DVB 04012001
*                   RA  :  RETURN ADDRESS                      @D529DVB 04013001
*                   R8  :  ADDR PAGE MANAGEMENT DATA AREA      @D529DVB 04014001
*                   R9  :  BASE OF PMRIOMOD                    @D529DVB 04015001
*                   RC  :  ADDR (IORE)                         @D529DVB 04016001
*        OUTPUT: ONLY FOR RETURN WITH OFFSET 4                 @D529DVB 04017001
*                   R1  :  EPA OF RELATED PAGE                 @D529DVB 04018001
*                   RE  :  ADDR OF RELATED FRAME               @D529DVB 04019001
*-------------------------------------------------------------*@D529DVB 04020001
*    OPERATION:                                                @D529DVB 04021001
*      PF = (* FRAME IDENTIFIED BY PFTE *)                     @D529DVB 04022001
*      PF.C-BIT := OFF                 /*  CHANGE BIT = OFF  */@D149DVB 04023001
*      PF.R-BIT := ON                  /*  REFERENCE BIT ON  */@D149DVB 04024001
*                 /*R-BIT IS SET ON ONLY FOR STAND ALONE DUMP*/@D149DVB 04025001
*      IF PF.C-BIT ALREADY ON                                  @D149DVB 04026001
*        THEN DO                                               @D529DVB 04027001
*        IF PFTE IS BLOCK CONNECTED                            @D149DVB 04028001
*          THEN DO                                             @D149DVB 04029001
*               GET BLKTBE             /*  RELATED BLKTBE    */@D149DVB 04030001
*               BLKTBE.PDSBIT = ON                             @D149DVB 04031001
*          END                                                 @D149DVB 04032001
*          ELSE DO                                             @D149DVB 04033001
*               GET PTE                /*  RELATED PTE       */@D149DVB 04034001
*               PTE.PDSBIT = ON                                @D149DVB 04035001
*          END                                                 @D149DVB 04036001
*        PFTE.PFTEFLG=OR(POABIT+POEBIT)/* PAGE_OUT ACTIVE    */@D149DVB 04037001
*        RETURN (PAGEOUT);                                     @D52VDVB 04038001
*        END                                                   @D149DVB 04039001
*        ELSE DO                                               @D529DVB 04040001
*          IF PFTE.PGQTYP = ( PGMRSP | PGVIORQ )               @D529DVB 04041001
*            THEN DO;                                          @D529DVB 04042001
*              PFTE.PFTEFLG = RESET(POABIT+POEBIT)             @D529DVB 04043001
*              RETURN (NO-PAGEOUT);                            @D52VDVB 04044001
*            END;                                              @D52VDVB 04045001
*            ELSE EXIT HARDWAIT (FF1)                          @D529DVB 04046001
*        END                                                   @D149DVB 04047001
*      END (PGOSPFTE);                                         @D529DVB 04048001
*------------------------------------------------------------* @D529DVB 04049001
*        INVARIANT REGISTERS: R2-R3,R6-RC,RF                   @D529DVB 04050001
*------------------------------------------------------------* @D529DVB 04051001
*        REGISTER USAGE                                        @D529DVB 04052001
*              R0 - WORK REGISTER                              @D529DVB 04053001
*              R1 - ADDRESS OF RELATED PAGE                    @D529DVB 04054001
*              R2 - ADDR OF PFTE                               @D529DVB 04055001
*              R4 - WORK REGISTER                              @D529DVB 04056001
*              R5 - RELATIVE PAGE NUMBER                       @D529DVB 04057001
*              RA - LINK REGISTER                              @D529DVB 04058001
*              RB - ADDR OF ACTUAL DEVCB                       @D529DVB 04059001
*-------------------------------------------------------------*@D529DVB 04060001
         SPACE 1                                               @D52VDVB 04061001
         USING TIBADR,RC          ADDRESSABILITY TO IORE       @D52VDVB 04062001
PGOSPFTE DS    0H                                              @D52VDVB 04063001
*SGLINK  PGOSPFTE,S,INPUT=(R2,R8,R9,RA,RC),OUTPUT=(R1,RE),             *04064001
               NOMODR=(R2-R3,R6-RC,RF),AMODE=31 DATON                   04065001
*        AMODESW SET,DAT=OFF      ENTER REAL MODE              @D52VDVB 04066001
         AMODESW SET,DAT=OFF      ENTER REAL MODE              @D52VDVB 04067001
         USING PFTE,R2            SET BASE FOR PFTE                     04068001
         LR    RE,R2              GET PFTE-ADDR.               @D14BDRP 04069001
         S     RE,APFT            CALCULATE CORR. PF-ADDRESS   @D35CDAA 04070001
         SLL   RE,PFSHIFT         RE = PF-ADDRESS              @D35CDAA 04071001
         ISKE  R4,RE              GET STORAGE KEY              @D51GDTP 04072001
         LR    R5,R4              SAVE R/C BIT                 @D52VDVB 04073001
         N     R5,CBITMON         C-BIT = OFF                  @D52VDVB 04074001
         BZ    PGOSP090           YES, ---------->             @D52VDVB 04075001
         XR    R4,R5              SET C-BIT OFF                @D52VDVB 04076001
         O     R4,RBITMSK         SET R-BIT ON                 @D52VDVB 04077001
         SSKE  R4,RE              SET MODIFIED STORAGE KEY     @D51GDTP 04078001
         L     R1,PFTEPNR         GET PAGE/                    @D14BDRP 04079001
         N     R1,PAGNMASK                BLOCK NUMBER         @D14NDFG 04080001
         LR    R4,R1                                           @D35CDAA 04081001
         SLL   R1,PNSHIFT         CONVERT TO EXT. PAGE ADDR    @D51GDRP 04082001
         STM   RA,R6,PMRSLEV2+OFR10 SAVE REGISTERS                     *04083001
                                  INCL OUTPUT REGS R1 + RE     @D61NDVB 04084001
         TM    S370FLG,PFTEBLK    ONLY BLOCK CONNECTED         @D14BDRP 04085001
*        AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @D52VDRP 04086001
         AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @D52VDRP 04087001
         BZ    PGOSP030           NO, BRANCH                   @D14BDRP 04088001
         SLL   R4,BLKOSHFT        GET OFFSET IN BLOCK-TABLE    @D14BDRP 04089001
         A     R4,VIOBLKTB        GET ADDR OF BLKTAB-ENTRY     @D14BDRP 04090001
         USING BLKTBE,R4                                       @D14BDRP 04091001
         OI    BLKSTAT2,BLKPDS    INDICATE COPY ON EXT. STORAGE@D14BDRP 04092001
         DROP  R4                                              @D14BDRP 04093001
         B     PGOSP060                                        @D14BDRP 04094001
         SPACE 1                                               @D14BDVB 04095001
PGOSP030 SLL   R4,PNRPTOSH        CALCULATE PTE ADDR           @D51GDRP 04096001
         A     R4,APT                                          @D35CDAA 04097001
         DROP  R2                 DROP BASE FOR PFTE (REAL     @D52VDRP 04098001
* R2 HAS STILL TO CONTAIN PFTE ADDRESS                         @D52VDRP 04099001
*        AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @D52VDRP 04100001
         AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @D52VDRP 04101001
         USING PTE,R4             SET BASE FOR PTE             @D35CDAA 04102001
         OI    PTESTAT2,PTEPDS    INDICATE VALID COPY ON PDS   @D14ADVB 04103001
         DROP  R4                                              @D35CDAA 04104001
PGOSP060 DS    0H                                              @D14BDRP 04105001
*        AMODESW SET,DAT=OFF      ENTER REAL MODE AGAIN        @D52VDRP 04106001
         AMODESW SET,DAT=OFF      ENTER REAL MODE AGAIN        @D52VDRP 04107001
         USING PFTE,R2            SET BASE FOR PFTE (REAL)     @D52VDRP 04108001
         AIF   (NOT &LOLEV1).NOLOL6                                     04109001
         TM    PFTEFLG3,USPGBIT   S    ALREADY PAGED-OUT                04110001
         BZ    PGOSP070           S    NO, BRANCH                       04111001
*        GENSERV INC,FIELD=NULLPOUT,REG=(R0)                   @D52VDVB 04112001
         GENSERV INC,FIELD=NULLPOUT,REG=(R0)                   @D52VDVB 04113001
PGOSP070 OI    PFTEFLG3,USPGBIT   S                            @D52VDVB 04114001
.NOLOL6  ANOP                                                           04115001
         OI    PFTEFLG,POABIT+POEBIT PAGE-OUT ACTIVE           @D52VDVB 04116001
.*DEL    NI    PFTEFLG3,XFF-POSLISON RESET POSL.PSLSTATE INDIC.        *04117001
                                  ... IN ANY CASE              @KX41010 04118001
         LA    R0,8(,0)           REQ: RESET POSLSTATE         @D61NDVB 04119001
         LR    RC,R2              ADDR OF CURRENT PFTE         @D61NDVB 04120001
         L     RA,APFTPOSL                                     @D61NDVB 04121001
*SGLINK  PFTEPOSL,INPUT=(R0,R8,RA,RC),OUTPUT=(R0,R4,R5,R6,R7),         *04122001
               NOMODR=(R1-R3,R8-RF),AMODE=31 ANY,DATOFF                 04123001
         BALR  RA,RA              GET ADDRESS OF POSLSTATE     @D61NDVB 04124001
.*    OUTPUT NOT USED                                          @D61NDVB 04125001
         SPACE 1                                               @D61NDVB 04126001
*        AMODESW SET,DAT=ON       SET VIRTUAL MODE AGAIN       @D52VDVB 04127001
         AMODESW SET,DAT=ON       VIRTUAL MODE                 @D52VDVB 04128001
         LM    RA,R6,PMRSLEV2+OFR10 RESTORE REGISTERS          @D61NDVB 04129001
         B     4(,RA)             ==========>  EXIT  PGOSPFTE  @D52VDVB 04130001
         SPACE 1                                                        04131001
PGOSP090 DS    0H                                              @D52VDVB 04132001
         TM    PGQTYP,PGPMRSP+PGVIORQ  PMR-SPACE, VPOOL OR VIO         *04133001
                                  -CONNECTED                   @D52VDVB 04134001
         BZ    PGOSPERR           NO  ---------->              @D52VDVB 04135001
         NI    PFTEFLG,XFF-POEBIT-POABIT           RESET ...           *04136001
                                  ALL PAGEOUT FLAGS            @D52VDVB 04137001
*        AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @D52VDVB 04138001
         AMODESW SET,DAT=ON                                    @D52VDVB 04139001
         BR    RA                 ===========>   EXIT PGOSPFTE @D52VDVB 04140001
         SPACE 1                                               @D52VDVB 04141001
PGOSPERR DS    0H                                              @D52VDVB 04142001
         BAL   R5,PMRHWERR        =============>  HARD WAIT    @D52VDVB 04143001
         SPACE 1                                               @D52VDVB 04144001
         DROP  RC                 RESET ADDRESS IORE           @D52VDVB 04145001
         DROP  R2                 RESET ADDRESS PFTE           @D52VDVB 04146001
*-------------------------------------------------------------*@D52VDVB 04147001
         EJECT                                                 @D52VDVB 04148001
*------------------------------------------------------------* @D529DVB 04149001
*        ROUTINE PROLOGUE                                      @D529DVB 04150001
*        ROUTINE NAME: DELPGQO                                 @D529DVB 04151001
*        MACRO:        SGPMR                                   @D529DVB 04152001
*        MODULE;       PMRIOMOD                                @D529DVB 04153001
*        FUNCTION:  DELETES TIB(IORE) FROM DEVCB               @D529DVB 04154001
*        CALLED BY:                                            @D529DVB 04155001
*              PGOSUBLK, PGOUTSIO, PGOCOMPL AMODE(31),DATON    @D529DVB 04156001
*        CALLED ROUTINES:                                      @D529DRP 04157001
*              DELENTR  WITH AMODE(31),DATON                   @D529DRP 04158001
*        ENTRY POINT:                                          @D529DVB 04159001
*              DELPGQO                                         @D529DVB 04160001
*        EXIT :  CALLER WITH AMODE(31),DATON                   @D529DVB 04161001
*        INPUT:                                                @D529DVB 04162001
*                   R8  :  ADDR PAGE MANAGEMENT DATA AREA      @D529DVB 04163001
*                   R9  :  BASE OF PMRIOMOD                    @D529DVB 04164001
*                   RA  :  RETURN ADDRESS                      @D529DVB 04165001
*                   RB  :  ADDR (DEVCB)                        @D529DVB 04166001
*                   RC  :  ADDR (IORE)                         @D529DVB 04167001
*        OUTPUT: -                                             @D529DVB 04168001
*-------------------------------------------------------------*@D529DVB 04169001
*    OPERATION:                                                @D629DVB 04170001
*      CALL DELENTR(IORE,PCB)          /* DELETE IORE        */@D629DVB 04171001
*      IF TIBSTATE /= 0                /* UNCOND  PAGOUT     */@D629DVB 04172001
*      THEN DO;                                                @D629DVB 04173001
*      IF POSLSTATE = 0                /* NO PAGE-OUT AT ALL */@D629DVB 04174001
*        THEN DO;                                              @D629DVB 04175001
*        CALL SCNPGOBL(POSLSTATE,SCB)  /* SEARCH IORE IN PGQO*/@D629DVB 04176001
*        IF IORE FOUND                                         @D629DVB 04177001
*          THEN CALL DELENTR(IORE,PCB)                         @D629DVB 04178001
*        END-DO;                                               @D629DVB 04179001
*        IF BLOCKED-PAGEOUT                                    @D629DVB 04180001
*          THEN DO FOR ALL PFTE-S IN IORE.PFTE-LIST;           @D629DVB 04181001
*            CALL SCNSYSBL(PFTE,SCB)  /*SEARCH IORE IN PGQSYS*/@D629DVB 04182001
*            IF IORE FOUND & PGDELO=ON                         @D629DVB 04183001
*              THEN CALL DELENTR(IORE,PCB)                     @D629DVB 04184001
*          END-DO-FOR;                                         @D629DVB 04185001
*      END-DO;                                                 @D629DVB 04186001
*      END (DELPGQO);                                          @D629DVB 04187001
*-------------------------------------------------------------*@D529DVB 04188001
         SPACE 1                                               @D52VDVB 04189001
*SGLINK  DELPGQO,S,INPUT=(R8,R9,RA,RB,RC),NOMODR=(R6-R1),AMODE=31 DATON 04190001
DELPGQO  DS    0H                                              @D52VDVB 04191001
         STM   R7,R1,PMRSLEV3+OFR7                             @D52VDVB 04192001
         LR    RD,RC                                           @KX41325 04193001
         USING TIBADR,RD          ADDRESSABILITY TO IORE       @D52VDVB 04194001
         USING DEVCB,RB                                        @D52VDVB 04195001
         SPACE 1                                               @D52VDVB 04196001
*     DELETE CURRENT IORE FROM PGQSYS / PGQO                   @D52VDVB 04197001
         SPACE 1                                               @D52VDVB 04198001
         NI    PMRFLAG,XFF-PMRIOWT RESET WAITING ON PAGE-OUT   @KX40135 04199001
         L     R3,DEVPCB          GET A(ACTUAL CLASS-PCB)      @D14BDRP 04200001
         ST    R3,PFPCB           SAVE IT FOR DELENTR RTN      @D14BDRP 04201001
         USING PCBADR,R3          SET BASE FOR CLASS-PCB       @D51IDRP 04202001
         LH    R3,PCBID           GET OFFSET OF                @D51IDRP 04203001
         SLL   R3,3                  REQUEST QUEUE HEADER      @D51IDRP 04204001
         DROP  R3                                              @D51IDRP 04205001
         LA    R3,PFRQBEG+TIBADR-TIBCHAIN(R3)                  @D14BDRP 04206001
         L     R9,APMRSERV        ADDRESSABILITY               @D52VDVB 04207001
         USING PMRSERV,R9         ... TO SERVICE ROUTINES      @D52VDVB 04208001
         BAL   RA,DELENTR         DELETE ENTRY FROM QUEUE      @D14BDRP 04209001
*SGLINK  DELENTR,INPUT=(R3,R8,RA,RB,RC),WORK=(R4,R5),OUTPUT=(R2),      *04210001
               NOMODR=(R6-R1,R3),AMODE=31 DATON                         04211001
         L     R9,APMRIORT        ADDRESSABILITY               @KX41010 04212001
         USING PMRIOMOD,R9        ... TO I/O ROUTINES          @KX41010 04213001
         SLR   RF,RF                                           @KX41010 04214001
         CL    RF,TIBSTATE        UNCONDITIONAL PAGE-OUT       @KX41010 04215001
         BE    DELPGQ80           NO, ----------->             @KX41010 04216001
         SPACE 1                                               @KX41010 04217001
*     FOR UNCONDITIONAL PAGE-OUT DELETE ALREADY HANDLED        @KX41010 04218001
*     PREPAGE OUT ON PGQO AND UNCONDTIONAL PAGEOUT ON PGQSYS   @KX41010 04219001
         SPACE 1                                               @KX41010 04220001
         L     R7,TIBAALU         ADDR(POSL.PSLSTATE)          @KX41010 04221001
         CLR   R7,RF              VIO / PMR SPACE WITHOUT ANY POSL AND *04222001
                                  ...NO RELATED PGQO/PGQSYS REQ@KX41010 04223001
         BE    DELPGQ80           YES, ---------->             @KX41010 04224001
         USING PSLSTATE,R7                                     @KX41010 04225001
         IC    RF,PSLSTATE        CURRENT PSLSTATE             @KX41010 04226001
         LTR   RF,RF              MORE PRE-PAGE-OUT FOR                *04227001
                                  ... ALLOCATION  UNIT         @KX41010 04228001
         BNZ   DELPGQ20           YES, ---------->             @KX41010 04229001
         SPACE 1                                               @KX41010 04230001
*     DELETE RELATED IORE IN PGQO                              @KX41010 04231001
         SPACE 1                                               @KX41010 04232001
         L     R0,TIBPFSCB        RELATED SCB                  @KX41010 04233001
         L     R9,APMRSSRV        ADDRESSABLITIY               @D61RDRP 04234001
         USING PMRSSRV,R9         ... TO SPEC. SERV. ROUTINES  @D61RDRP 04235001
         BAL   R4,SCNPGOBL        FIND IORE(PSLSTATE) IN PGQO  @KX41010 04236001
*SGLINK  SCNPGOBL,INPUT=(R0,R4,R7,R8,R9,RB),OUTPUT=(R3,R5),            *04237001
               NOMODR=(R4,R6-R2),AMODE=31 ANY                           04238001
         L     R9,APMRIORT        ADDRESSABILITY               @KX41010 04239001
         USING PMRIOMOD,R9        ... TO I/O ROUTINES          @KX41010 04240001
         LTR   RC,R5              IORE IN PGQO FOUND           @KX41010 04241001
         BZ    DELPGQ20           NO,  ---------->             @KX41010 04242001
         LA    R4,PGTPCB          GET PCB ADDR FOR PGQO        @KX41010 04243001
         ST    R4,PFPCB           SAVE IT FOR DELENTR RTN      @KX41010 04244001
         L     R9,APMRSERV        ADDRESSABILITY               @KX41010 04245001
         USING PMRSERV,R9         ... TO SERVICE ROUTINES      @KX41010 04246001
         BAL   RA,DELENTR         DELETE PRE-PAGE-OUT IN PGQO  @KX41010 04247001
*SGLINK  DELENTR,INPUT=(R3,R8,RA,RB,RC),WORK=(R4,R5),OUTPUT=(R2),      *04248001
               NOMODR=(R6-R1,R3),AMODE=31 DATON                         04249001
         L     R9,APMRIORT        ADDRESSABILITY               @KX41010 04250001
         USING PMRIOMOD,R9        ... TO I/O ROUTINES          @KX41010 04251001
         SPACE 1                                               @KX41325 04252001
*     DELETE RELATED IORE(-S) ON PGQSYS                        @KX41325 04253001
         SPACE 1                                               @KX41325 04254001
DELPGQ20 DS    0H                                              @KX41325 04255001
         TM    PGQTYP,PGBLK       BLOCKED UNCOND PAGE-OUT      @KX41325 04256001
         BZ    DELPGQ80           NO,  ---------->             @KX41325 04257001
         LH    RF,PPOBLMAX        MAX BLOCKING VALUE           @KX41325 04258001
         LA    RE,TIBAPFT         ADDRESS OF PFTE ADDR LIST    @KX41325 04259001
         L     R4,ASYSPCB         PROVIDE ADDR SYSTEM PCB              *04260001
                                  ...ACCORDINGLY TO PGQSYS     @KX41325 04261001
         ST    R4,PFPCB           ...FOR DELENTR RTN           @KX41325 04262001
         L     R0,TIBPFSCB        RELATED SCB                  @KD40185 04263001
         DROP  RD                 RESET BASE FOR TIB           @KX41325 04264001
DELPGQ40 DS    0H                                              @KX41325 04265001
         L     RC,0(,RE)          GET ADDR OF NEXT PFTE        @KX41325 04266001
         LTR   RC,RC              AVAILABLE                    @KX41325 04267001
         BZ    DELPGQ60           NO,  ---------->             @KX41325 04268001
         L     R9,APMRSSRV        ADDRESSABLITIY               @D61RDRP 04269001
         USING PMRSSRV,R9         ... TO SPEC. SERVICE ROUT.   @D61RDRP 04270001
         BAL   R4,SCNSYSBL        FIND IORE(PFTE) IN PGQSYS    @KX41325 04271001
*SGLINK  SCNSYSBL,INPUT=(R0,R4,R7,R8,R9,RB,RC),OUTPUT=(R3,R5),         *04272001
               NOMODR=(R4,R6-R2),AMODE=31 DATON                         04273001
         L     R9,APMRIORT        ADDRESSABILITY               @KX41325 04274001
         USING PMRIOMOD,R9        ... TO I/O ROUTINES          @KX41325 04275001
         LTR   RC,R5              IORE IN PGSYS FOUND          @KX41325 04276001
         BZ    DELPGQ60           NO,  ---------->             @KX41325 04277001
         USING TIBADR,RC          ADDRESSABILITY TO IORE       @KX41325 04278001
         TM    PGQTYP,PGDELO      IORE TO BE DELETED           @KX41325 04279001
         BZ    DELPGQ60           NO,  ---------->             @KX41325 04280001
         DROP  RC                 RESET BASE FOR TIB           @KX41325 04281001
         L     R9,APMRSERV        ADDRESSABILITY               @KX41325 04282001
         USING PMRSERV,R9         ... TO SERVICE ROUTINES      @KX41325 04283001
         BAL   RA,DELENTR         DELETE PRE-PAGE-OUT IN PGQO  @KX41325 04284001
*SGLINK  DELENTR,INPUT=(R3,R8,RA,RB,RC),WORK=(R4,R5),OUTPUT=(R2),      *04285001
               NOMODR=(R6-R1,R3),AMODE=31  DATON                        04286001
         L     R9,APMRIORT        ADDRESSABILITY               @KX41325 04287001
         USING PMRIOMOD,R9        ... TO I/O ROUTINES          @KX41325 04288001
DELPGQ60 DS    0H                                              @KX41010 04289001
         LA    RE,4(,RE)          NEXT SLOT IN PFTE ADDR LIST  @KX41325 04290001
         BCT   RF,DELPGQ40        MOR TO DO ---------->        @KX41325 04291001
         SPACE 1                                               @KX41325 04292001
DELPGQ80 DS    0H                                              @KX41010 04293001
         LM    R7,R1,PMRSLEV3+OFR7                             @D52VDVB 04294001
         BR    RA                 ==========> EXIT DELPGQO     @D52VDVB 04295001
         SPACE 1                                               @D52VDVB 04296001
         DROP  R7                                              @KX41010 04297001
         DROP  RB                 FORGET BASE FOR DEVCB        @D14BDRP 04298001
         SPACE 1                                               @D52VDVB 04299001
*-------------------------------------------------------------*@D529DVB 04300001
         EJECT                                                 @D52VDVB 04301001
*------------------------------------------------------------* @D529DVB 04302001
*        ROUTINE PROLOGUE                                      @D529DVB 04303001
*        ROUTINE NAME: PGOQCHCK                                @D529DVB 04304001
*        MACRO:        SGPMR                                   @D529DVB 04305001
*        MODULE;       PMRIOMOD                                @D529DVB 04306001
*        FUNCTION:  VERIFIES WHETHER UNC. PAGE-OUT REQUESTS    @D529DVB 04307001
*                   ARE AFFECTED BY ONE BLOCKED PAGE-OUT       @D529DVB 04308001
*        CALLED BY:                                            @D529DVB 04309001
*              PGOUTSIO AMODE(31), DATON                       @D529DVB 04310001
*        CALLED ROUTINES: -                                    @D529DRP 04311001
*        ENTRY POINT:                                          @D529DVB 04312001
*              PGOQCHCK                                        @D529DVB 04313001
*        EXIT :  CALLER WITH AMODE(31),DATON                   @D529DVB 04314001
*        INPUT:                                                @D529DVB 04315001
*                   R6  :  AFFECTED POSLSTATE                  @D529DVB 04316001
*                   R7  :  RETURN ADDRESS                      @D529DVB 04317001
*                   R8  :  ADDR PAGE MANAGEMENT DATA AREA      @D529DVB 04318001
*                   R9  :  BASE OF PMRIOMOD                    @D529DVB 04319001
*                   RC  :  ADDR (IORE)                         @D529DVB 04320001
*        OUTPUT:    -                                          @D529DVB 04321001
*-------------------------------------------------------------*@D529DVB 04322001
*        INVARIANT REGISTERS: R0-R4,R6-RF                      @D529DVB 04323001
*-------------------------------------------------------------*@D529DVB 04324001
*    OPERATION:                                                @D529DVB 04325001
*        IORE = (* CURRENT IORE *);                            @D529DVB 04326001
*        T = IORE;                                             @D529DVB 04327001
*        DO WHILE T.TIBCHAIN /= NIL;                           @D529DVB 04328001
*           T = T.TIBCHAIN;                                    @D529DVB 04329001
*           IF (T.PGQTYP /= PGDELO      /* REQ NOT DELETED   */@D529DVB 04330001
*              & T.TIBSCB = IORE.TIBSCB /* SAME SCB          */@D529DVB 04331001
*              & T.TIBAALU=IORE.TIBAALU /* SAME ALLOC UNIT   */@D529DVB 04332001
*              & (* IORE-PGO > T-PGO *) )                      @D529DVB 04333001
*                /* BLOCKED REQ. INCLUDES CURRENT REQUEST    */@D529DVB 04334001
*              THEN DO;                                        @D529DVB 04335001
*                T.PGQTYP = PGDELO;      /* DELETE PGO REQ   */@D529DVB 04336001
*                N=(*INDEX OF T.TIBSTATE->PFTE IN TIBAPFT*);   @D529DVB 04337001
*                IORE.TIBAPFT(N) = T.TIBSTATE;                 @D529DVB 04338001
*              END;                                            @D529DVB 04339001
*        END_DO_WHILE;                                         @D529DVB 04340001
*      END(PGOQCHCK);                                          @D529DVB 04341001
*-------------------------------------------------------------*@D529DVB 04342001
         SPACE 1                                                        04343001
*SGLINK  PGOQCHCK,S,INPUT=(R6,R7,R8,R9,RC),NOMODR=(R6-R4),             *04344001
               AMODE=31 DATON                                           04345001
         USING PMRIOMOD,R9                                     @D52VDVB 04346001
PGOQCHCK DS    0H                                              @D52VDVB 04347001
         USING TIBADR,RC                                       @D52VDVB 04348001
         ICM   R5,M15,TIBCHAIN    ANY FURTHER UNC. PAGE-OUT            *04349001
                                  .. PENDING ON DEVCB          @D52VDVB 04350001
         BZR   R7                 NO, =========> EXIT PGOQCHCK @D52VDVB 04351001
         STM   RD,RF,PMRSLEV1+OFR13                            @D52VDVB 04352001
PGOQCH10 DS    0H                                              @D52VDVB 04353001
         TM    PGQTYP-TIBADR(R5),PGO PAGE-OUT REQUEST          @D52VDVB 04354001
         BZ    PGOQCH60           NO,  -------->               @D52VDVB 04355001
         TM    PGQTYP-TIBADR(R5),PGDELO ALREADY DEACTIVATED    @D52VDVB 04356001
         BO    PGOQCH60           YES, -------->               @D52VDVB 04357001
         CLC   TIBAALU,TIBAALU-TIBADR(R5) SAME POSLSTATE       @D52VDVB 04358001
         BNE   PGOQCH60           NO, -------->                @D52VDVB 04359001
         CLC   TIBPFSCB,TIBPFSCB-TIBADR(R5) ... FOR SAME SCB   @D52VDVB 04360001
         BNE   PGOQCH60           NO, -------->                @D52VDVB 04361001
         LR    RF,R6              I/O RELATED POSLSTATE        @D52VDVB 04362001
         SLR   RD,RD                                           @D52VDVB 04363001
         IC    RD,PGOEQPSL-TIBADR(,R5) POSLSTATE OF UNC PAGEOUT@D52VDVB 04364001
         NR    RF,RD              ANY INTERRELATIONSHIP        @D52VDVB 04365001
         BZ    PGOQCH60           NO,  ------------>           @D52VDVB 04366001
         SGCOV SGPMR,MC=7                                      @D52VDVB 04367001
         OI    PGQTYP-TIBADR(R5),PGDELO DEACTIVATE PAGE-OUT    @D52VDVB 04368001
*        GENSERV  PGONT,PSLVAL=(RD),PGONT=(RF)                 @D52VDVB 04369001
         GENSERV  PGONT,PSLVAL=(RD),PGONT=(RF)                 @D52VDVB 04370001
         USING PREPGENT,RF                                     @D52VDVB 04371001
         L     RD,PREPGOFF        RELATED OFFSET IN TIBAPFT  =         *04372001
                = OFFSET IN ALLOCATION UNIT *10**(-PNSHIFT+2)  @D52VDVB 04373001
         DROP  RF                                              @D52VDVB 04374001
         L     RF,TIBSTATE-TIBADR(,R5) COPY PFTE-ADDR          @D52VDVB 04375001
         ST    RF,TIBAPFT(RD)     ...INTO CURRENT PFTE ADDR LST@D52VDVB 04376001
         SPACE 1                                               @D52VDVB 04377001
PGOQCH60 DS    0H                                              @D52VDVB 04378001
         ICM   R5,M15,TIBCHAIN-TIBADR(R5) NEXT ELEMENT         @D52VDVB 04379001
         BNZ   PGOQCH10           YES, ----------> HANDLE NEXT @D52VDVB 04380001
         LM    RD,RF,PMRSLEV1+OFR13                            @D52VDVB 04381001
         BR    R7                 ==========> EXIT PGOQCHCK    @D52VDVB 04382001
         DROP  R9                                              @D52VDVB 04383001
         DROP  RC                                              @D52VDVB 04384001
*-------------------------------------------------------------*@D529DVB 04385001
         EJECT                                                 @D52VDVB 04386001
*-------------------------------------------------------------*@D529DVB 04387001
*        ROUTINE PROLOGUE                                      @D529DVB 04388001
*        ROUTINE NAME:  PGICOMPL                               @D529DVB 04389001
*        MACRO:         SGPMR                                  @D529DVB 04390001
*        MODULE:        PMRIOMOD                               @D529DVB 04391001
*        FUNCTION: HANDLES I/O COMPLETION FOR PAGE-IN REQUESTS @D529DVB 04392001
*        INPUT:                                                @D529DVB 04393001
*               R7 - RETURN ADDRESS                            @D529DVB 04394001
*               R8 - ADDR OF PAGEMANAGEMENT DATA-AREA          @D529DVB 04395001
*               RB - ADDR OF DEVCB                             @D529DVB 04396001
*        OUTPUT:   - (UNBLOCKED)                               @D529DVB 04397001
*               R1 - ADDR OF PAGE                              @D529DVB 04398001
*               R2 - ADDR OF RELATED PTE                       @D529DVB 04399001
*               RC - ADDR OF SELECTED PFTE (CORRESPONDING TO   @D529DVB 04400001
*                                                 FRAME)       @D529DVB 04401001
*               RE - ADDR OF PAGE FRAME                        @D529DVB 04402001
*-------------------------------------------------------------*@D529DVB 04403001
*     OPERATION:                                               @D529DVB 04404001
*        IF IORE.PGQTYP /=  PGBLK                              @D529DVB 04405001
*          THEN DO;               /* UNBL PAGE-IN COMPLETE   */@D529DVB 04406001
*            PFI = IORE.PGINF     /* CURRENT PFTE            */@D529DVB 04407001
*            F   = (* FRAME IDENTIFIED BY PFI *);              @D529DVB 04408001
*            CALL PMRIOCPL;       /* PROVIDES PAGE ADDRESS   */@D529DVB 04409001
*            IF PFTE.PFTEFLG /=  PIOERR                        @D529DVB 04410001
*               THEN RC = (* OK *);                            @D529DVB 04411001
*               ELSE DO;                                       @D529DVB 04412001
*                 PTE.PTESTAT =  (* PAGE ERRONEOUS *)          @D529DVB 04413001
*                 RC = (* OK *);                               @D529DVB 04414001
*               END;                                           @D529DVB 04415001
*          END;                                                @D529DVB 04416001
*          ELSE DO;               /* BLOCKED PAGE-IN COMPLETE*/@D529DVB 04417001
*            DO FOR (* ALL PFI IN IORE.TIBAPFT *)              @D529DVB 04418001
*              PFI = IORE.TIBAPFT(I); /* PFTE                */@D529DVB 04419001
*              PTI = PFI.PFTEEPA#;   /* ASSOCIATED PTE       */@D529DVB 04420001
*              CALL RPOST(SRQPGIO,PFTE);                       @D529DVB 04421001
*                                 /*POST TASKS WAITNG ON PFTE*/@D529DVB 04422001
*              PFI.PFTETIB = 0;                                @D529DVB 04423001
*              CALL MAKEADDR(PTI,PFI);                         @D529DVB 04424001
*                   /* HANDLE ERRONEOUS PAGE/FRAME OR        */@D52VDRP 04425001
*                   /* MAKE PAGE ADDRESSABLE                 */@D529DVB 04426001
*                   /* PROVIDE STORAGE KEY FROM PTI.PTEKEY   */@D529DVB 04427001
*                   /* INSERT PFI AT BOTTOM OF PSQ           */@D529DVB 04428001
*              IORE.TIBAPFT(* CURRENT ENTRY *) = 0;            @D529DVB 04429001
*            END DO_FOR;                                       @D529DVB 04430001
*            T = (*TIB CHAINED TO PAGE-IN TIB IN DEVCB.SYSQ*); @D529DVB 04431001
*            CALL DELENTR(TIB,T,DEVCB);  /* DEQUEUE IORE     */@D529DVB 04432001
*            TPIN = (* TIB OF PAGE_IN TASK *);                 @D529DVB 04433001
*            CALL POST(SRQPMR,T):        /*PAGE-IN TASK READY*/@D529DVB 04434001
*            RC = (* BLOCKED COMPL DONE *);                    @D529DVB 04435001
*          END;                                                @D529DVB 04436001
*        RETURN (RC);                                          @D529DVB 04437001
*        END (PGICOMPL);                                       @D529DVB 04438001
*-------------------------------------------------------------*@D529DVB 04439001
         SPACE 1                                               @D52VDVB 04440001
*SGLINK  PGICOMPL,S,INPUT=(R7,R8,RB),OUTPUT=(R1,R2,RC,RE),             *04441001
               NOMODR=(R7-RB,RD,RF),AMODE=31 DATON                      04442001
         USING PMRIOMOD,R9                                     @D52VDVB 04443001
         USING DEVCB,RB                                        @D52VDVB 04444001
PGICOMPL DS    0H                 COMPLETION OF PAGE IN        @D52VDVB 04445001
         STM   R7,RD,PMRSLEV0+OFR7                             @D52VDVB 04446001
         L     R9,APMRIORT        PROVIDE ADDRESSABILITY       @D52VDVB 04447001
         L     RC,PFPGQE          CURRENT REQUEST ELEMENT      @D52VDVB 04448001
         USING TIBADR,RC                                       @D52VDVB 04449001
         TM    PGQTYP,PGBLK       IS IT BLOCKED PAGE IN REQUEST@D52VDRP 04450001
         BO    PGICMP50           YES, ---------->             @D52VDRP 04451001
         SPACE 1                                               @D52VDVB 04452001
*-------------------------------------------------------------*@D52VDVB 04453001
*    UNBLOCKED PAGE-IN COMPLETED                               @D52VDVB 04454001
*-------------------------------------------------------------*@D52VDVB 04455001
         SPACE 1                                                        04456001
         L     RC,PGINF           GET ADDR OF PFTE             @D52VDRP 04457001
         ST    RC,PMRSLEV0+OFR12  ... SAVE IT FOR OUTPUT       @D52VDVB 04458001
         DROP  RC                 DROP BASE FOR TIBADR         @D52VDVB 04459001
         LR    RE,RC                                           @D52VDVB 04460001
         SL    RE,APFT            OFFSET OF PFTE               @D52VDVB 04461001
         SLL   RE,PFSHIFT         ADDRESS OF FRAME             @D52VDVB 04462001
*        AMODESW SET,DAT=OFF      ENTER REAL MODE              @D52VDRP 04463001
         AMODESW SET,DAT=OFF      ENTER REAL MODE              @D52VDRP 04464001
         SLR   R2,R2                                           @D52VDVB 04465001
         USING PFTE,RC                                         @D52VDVB 04466001
         ICM   R2,7,PFTEEPA#      GET EPA NUMBER               @D52VDVB 04467001
         SLL   R2,PNSHIFT         CONVERT TO EPA               @D52VDVB 04468001
         ST    R2,PAGEADDR        SAVE IT                      @D52VDVB 04469001
         DROP  RC                                              @0000036 04470001
*        AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @D52VDRP 04471001
         AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @D52VDRP 04472001
         SRL   R2,PTSHIFT         OFFSET IN PT                 @D14BDRP 04473001
         A     R2,APT             ADDRESS OF PTE               @D14BDRP 04474001
         USING PTE,R2                                          @D14BDRP 04475001
         TM    PTESTAT,PTEIBIT+PTEPGCO PTE = CONNECTED         @D14ADVB 04476001
         BO    PGICMP20           YES, ---------->                     *04477001
                                  PAGESTAT MUST NOT BE CHANGED @D52VDVB 04478001
         BAL   R5,PMRHWERR        ==========>     HW           @D52VDVB 04479001
PGICMP20 DS    0H                                              @D52VDVB 04480001
         DROP  R2                 DROP BASE FOR PTE            @D52VDVB 04481001
*        AMODESW SET,DAT=OFF      ENTER REAL MODE              @D52VDRP 04482001
         AMODESW SET,DAT=OFF      ENTER REAL MODE              @D52VDRP 04483001
         USING PFTE,RC                                         @D52VDVB 04484001
         TM    PFTEFLG,PIOERR     ERRONEOUS PAGE ?             @D52VDVB 04485001
         BZ    PGICMP40           NO,  HANDLE COMPL. READ REQ. @D14BDRP 04486001
         DROP  RC                 DROP PFTE (REAL)             @D52VDVB 04487001
*        AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @D52VDRP 04488001
         AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @D52VDRP 04489001
         USING PTE,R2                                          @D14BDRP 04490001
         OI    PTESTAT,PTEERR     INDICATE ERRONEOUS PAGE      @D52GDRP 04491001
         DROP  R2                 FORGET BASE FOR PTE          @D14BDRP 04492001
PGICMP40 DS    0H                                              @D52VDVB 04493001
*        AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @D52VDRP 04494001
         AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @D52VDRP 04495001
         LA    R0,PMRIOCDO-PMRIOCBG(,0)                        @D52VDVB 04496001
         B     PGICMPEX           ---------->                  @D52VDVB 04497001
         SPACE 1                                               @D52VDVB 04498001
*-------------------------------------------------------------*@D52VDVB 04499001
*     BLOCKED PAGE-IN COMPLETED                                @D52VDVB 04500001
*-------------------------------------------------------------*@D52VDVB 04501001
         SPACE 1                                                        04502001
PGICMP50 DS    0H                                              @D52VDVB 04503001
         SGCOV SGPMR,MC=8                                      @D52VDVB 04504001
         USING TIBADR,RC                                       @D52VDVB 04505001
         SLR   R5,R5                                           @D52VDVB 04506001
         IC    R5,DEVCPSL         CURRENT PISL VALUE IN DEVCB  @D52VDVB 04507001
         SLL   R5,PGIOFSH                                      @D52VDVB 04508001
         AL    R5,APGINTAB        CURRENT PGINENT              @D52VDVB 04509001
         USING PGINENT,R5                                      @D52VDVB 04510001
         L     R3,PGINPFOF        RELATED OFFSET IN TIBAPFT    @D52VDVB 04511001
         LA    R3,TIBAPFT(R3)     ADDRESS OF FIRST PFTE-ADDRESS        *04512001
                                  ... TO BE HANDLED            @D52VDVB 04513001
         LH    R0,PGINBLK         NUMBER OF BLOCKED PAGES      @D52VDVB 04514001
         DROP  R5                 PGINENT                      @D52VDVB 04515001
         DROP  RC                 IORE                         @D52VDVB 04516001
         SPACE 1                                               @D52VDVB 04517001
PGICMP60 DS    0H                                              @D52VDVB 04518001
         L     RE,0(,R3)          CURRENT PFTE ADDR            @D52VDVB 04519001
         LTR   RE,RE              AVAILABLE                    @D52VDVB 04520001
         BZ    PGICMP80           NO ----------> TRY NEXT ONE  @D52VDVB 04521001
*     POST PFTE                                                @D52VDVB 04522001
         L     R6,DISPAD                                       @D52VDVB 04523001
         USING DISP,R6            SET DISPATCHER ADDRESSABLE   @D52VDVB 04524001
         LR    R1,RE              GET PFTE POINTER             @D52VDVB 04525001
         L     R5,ASRQTAB         GET ADDRESS OF ...           @D61RDRP 04526001
         LA    R5,SRQPGIO-SRQTAB(,R5) ... RESOURCE QUEUE       @D61RDRP 04527001
         BAL   RF,RPOST           POST TASKS WAITING FOR FRAME @D52VDVB 04528001
*SGLINK  RPOST,INPUT=(R1,R5,R6,RF),WORK=(R5,RE)                @D52VDVB 04529001
*     MAKE ADDRESSABLE                                         @D52VDVB 04530001
         DROP  R6                 RESET ADDR. TO DISPATCHER    @D52VDVB 04531001
         LR    RC,R1                                           @D52VDVB 04532001
*        AMODESW SET,DAT=OFF      ENTER REAL MODE              @D52VDVB 04533001
         AMODESW SET,DAT=OFF      ENTER REAL MODE              @D52VDVB 04534001
         USING PFTE,RC                                         @D52VDVB 04535001
         L     R2,PFTEPNR         CURRENT EPA-NR               @D52VDVB 04536001
         N     R2,PAGNMASK                                     @D52VDVB 04537001
         SLL   R2,PNRPTOSH        OFFSET IN PT                 @D52VDVB 04538001
         A     R2,APT             ADDRESS OF PTE               @D52VDVB 04539001
         SLR   RA,RA                                           @D52VDVB 04540001
         ST    RA,PFTETIB         CLEAR CURRENT IORE ADDR      @D52VDVB 04541001
         LR    RE,RC              RESTORE ADDRESS(PAGE FRAME)  @D52VDVB 04542001
         SL    RE,APFT            OFFSET OF PFTE               @D52VDVB 04543001
         SLL   RE,PFSHIFT         ADDRESS OF FRAME             @D52VDVB 04544001
*        AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @D52GDRP 04545001
         AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @D52GDRP 04546001
         SPACE 1                                               @0000036 04547001
*     MAKE PAGE ADDRESSABLE OR HANDLE ERRONEOUS PAGE           @0000036 04548001
         SPACE 1                                               @D52VDVB 04549001
         L     R9,APMRSERV        GET BASE OF ....             @D52VDVB 04550001
         USING PMRSERV,R9         ... OF SERVICE ROUTINES      @D52VDVB 04551001
*SGLINK  MAKEADDR,INPUT=(R2,R8,R9,RA,RC,RE),NOMODR=(R6-R3),            *04552001
               AMODE=31 DATON                                           04553001
         BAL   RA,MAKEADDR        MAKE PAGE ADDRESSIBLE        @D52VDVB 04554001
         L     R9,APMRIORT        GET BASE OF ....             @D52VDVB 04555001
         USING PMRIOMOD,R9        ... OF I/O ROUTINE           @D52VDVB 04556001
PGICMP75 SLR   RA,RA                                           @D52VDVB 04557001
         ST    RA,0(,R3)          CLEAR CURRENT PFTE ADDR      @D52VDVB 04558001
PGICMP80 LA    R3,4(,R3)          NEXT ADDR IN ARRAY(PFTE_ADDR)@D52VDVB 04559001
         BCT   R0,PGICMP60        EOL, NO ------->             @D52VDVB 04560001
         SPACE 1                                               @D52VDVB 04561001
*-------------------------------------------------------------*@D52VDVB 04562001
*      DELETE ENTRY FROM DEVCB                                 @D52VDVB 04563001
*      POST PAGEIN TASK                                        @D52VDVB 04564001
*-------------------------------------------------------------*@D52VDVB 04565001
         SPACE 1                                               @D52VDVB 04566001
         L     RC,PFPGQE          CURRENT IORE                 @D52VDVB 04567001
         USING TIBADR,RC                                       @D52VDVB 04568001
         L     R4,DEVPCB                                       @D52VDVB 04569001
         ST    R4,PFPCB           PROVIDE CLASS_PCB FOR DELENTR@D52VDVB 04570001
         USING PCBADR,R4          SET BASE FOR CLASS-PCB       @D52VDVB 04571001
         LH    R4,PCBID           GET OFFSET                   @D52VDVB 04572001
         DROP  R4                                              @D52VDVB 04573001
         SLL   R4,3               ....       IN REQ. QUEUE     @D52VDVB 04574001
         LA    R3,PFRQBEG+TIBADR-TIBCHAIN(R4) GET PFQSYS       @D52VDVB 04575001
         CL    RC,TIBCHAIN-TIBADR(,R3)  IORE = 1ST ENTRY       @D52VDVB 04576001
         BE    PGICMP90           YES, ---------->             @D52VDVB 04577001
         BAL   R5,PMRHWERR        HARD WAIT ==========>        @D52GDWL 04578001
PGICMP90 DS    0H                                              @D52VDVB 04579001
         L     R9,APMRSERV        PROVIDE .....                @D52VDVB 04580001
         USING PMRSERV,R9         ...ADDRESSABILITY TO PMRSERV @D52VDVB 04581001
         BAL   RA,DELENTR         DELETE ENTRY FROM DEVCB      @D52VDVB 04582001
*SGLINK  DELENTR,INPUT=(R3,R8,RA,RB,RC),WORK=(R4,R5),OUTPUT=(R2),      *04583001
               NOMODR=(R6-R1,R3),AMODE=31 DATON                         04584001
         L     R9,APMRIORT        GET BASE OF ....             @D52VDVB 04585001
         USING PMRIOMOD,R9        ... OF I/O ROUTINE           @D52VDVB 04586001
         SPACE 1                                               @D52VDVB 04587001
*      POST PAGE-IN TASK                                       @D52VDVB 04588001
         LR    R0,R8              SAVE ADDR OF PMR DATA AREA   @D52VDVB 04589001
         L     R6,DISPAD          BASE OF DISPATCHER           @D52VDVB 04590001
         USING DISP,R6            SET DISPATCHER ADDRESSABLE   @D52VDVB 04591001
         L     R8,TIBSTATE        ADDR OF PAGE-IN TIB          @D52VDVB 04592001
         BAL   RF,POST            MAKE PAGE-IN READY           @D52VDVB 04593001
*SGLINK  POST,INPUT=(R6,R8,RF),WORK=(RE)                       @D52VDVB 04594001
         LR    R8,R0              RESET ADDR OF PMR DATA AREA  @D52VDVB 04595001
         LA    R0,PMRIOCBL-PMRIOCBG(,0)                        @D52VDVB 04596001
         SPACE 1                                               @D52VDVB 04597001
*-------------------------------------------------------------*@D52VDVB 04598001
         SPACE 1                                               @D52VDVB 04599001
PGICMPEX DS    0H                                              @D52VDVB 04600001
         LM    R7,RD,PMRSLEV0+OFR7 RESET REGISTERS             @D52VDVB 04601001
         ALR   R7,R0              ADJUST  BRANCH OFFSET        @D52VDVB 04602001
         BR    R7                 ==========>   EXIT PGICOMPL  @D52VDVB 04603001
         SPACE 1                                               @D52VDVB 04604001
         DROP  R6                 RESET ADDR DISPATCHER        @D52VDVB 04605001
         DROP  RB                 RESET ADDR DEVCB             @D52VDVB 04606001
         DROP  RC                 RESET ADDR IORE              @D52VDVB 04607001
         DROP  R9                 RESET ADDR PMRIOMOD          @D52VDVB 04608001
         EJECT                                                 @D52VDVB 04609001
*-------------------------------------------------------------*@D52VDVB 04610001
*        ROUTINE PROLOGUE                                      @D52VDVB 04611001
*        ROUTINE NAME:  PGOCOMPL                               @D52VDVB 04612001
*        MACRO:         SGPMR                                  @D52VDVB 04613001
*        FUNCTION: PROCESSES PAGE OUT COMPLETE FOR UNBLOCKED   @D52VDVB 04614001
*        CALLED BY:  PMR MAIN MODE(31,DATON)                   @D52VDVB 04615001
*        ENTRY POINT:                                          @D52VDVB 04616001
*               PGOCOMPL                                       @D52VDVB 04617001
*        CALLED ROUTINE:                                       @D52VDVB 04618001
*        INPUT:                                                @D52VDVB 04619001
*               R7 - RETURN ADDRESS                            @D52VDVB 04620001
*               R8 - ADDR OF PAGEMANAGEMENT DATA-AREA          @D52VDVB 04621001
*               RB - ADDR DEVCB TO WHICH THE PAGE-OUT REQ.     @D52VDVB 04622001
*                    IS QUEUED                                 @D52VDVB 04623001
*               RC - ADDR OF IORE / PSEUDO TIB                 @D52VDVB 04624001
*        OUTPUT:   -                                           @D52VDVB 04625001
*               RB - ADDR OF DEVCB TO BE HANDLED NEXT          @D52VDRP 04626001
*-------------------------------------------------------------*@D52VDVB 04627001
*        OPERATION:                                            @D149DVB 04628001
*        PGOCOMPL:       /*ENTERED HERE AFTER I/O IS COMPLETE*/@D149DVB 04629001
*         ENTER REAL MODE                                      @D52VDVB 04630001
*         IF PGQTYP=BLK                                        @D52VDVB 04631001
*           THEN DO            /*  HANDLE BLOCKED PAGE OUT   */@D52VDVB 04632001
*              DO FOR BLOCKED FRAMES  /*LOOP OVER BLOCKED PAR*/@D52VDVB 04633001
*                GET ADDRESS PFTE     /* GET CURRENT PFTE    */@D52VDVB 04634001
*                CALL PGOCPFTE        /* HANDLE PFTE         */@D52VDVB 04635001
*              END (LOOP)                                      @D52VDVB 04636001
*           ELSE DO            /*  HANDLE UNBLOCKED PAGE OUT */@D52VDVB 04637001
*              PROVIDE ADDRESS PFTE   /*  GET CURRENT PFTE   */@D52VDVB 04638001
*              CALL PGOCPFTE          /* HANDLE PFTE         */@D52VDVB 04639001
*         END-IF                                               @D52VDVB 04640001
*         DEVCPSL = 0                                          @D52VDVB 04641001
*         ENTER VIRTUAL MODE                                   @D52VDVB 04642001
*         CALL DELPQO                 /*DELETE TIB FROM PGQUO*/@D52VDVB 04643001
*         IF WAITDEVCB = 0            /*NO WAITING PAGE FAULT*/@D529DVB 04644001
*           THEN RETURN                                        @D529DVB 04645001
*           ELSE                                               @D529DVB 04646001
*             ADDR_DEVCB := WAITDEVCB                          @D529DVB 04647001
*             RETURN                                           @D529DVB 04648001
*        END PGOCOMPL;                                         @D52VDVB 04649001
*-------------------------------------------------------------*@D52VDVB 04650001
*     REGISTER USAGE                                           @D14BDVB 04651001
*        R2 - ADDR OF PFTE BELONGING TO PAGE/BLOCK             @D52VDVB 04652001
*        R7 - LINK REGISTER                                    @D52VDVB 04653001
*        R8 - ADDRESS OF PMR DATA AREA                         @D52VDVB 04654001
*        R9 - BASE OF PAGE OUT ROUTINES                        @D52VDVB 04655001
*        RA - RETURN ADDRESS/ LINK REGISTER                    @D52VDVB 04656001
*        RB - ADDR OF ACTUAL DEVICE CONTROL BLOCK (DEVCB)      @D52VDVB 04657001
*        RC - ADDR OF PSEUDO-TIB REPR. COMPL. PAGE-OUT REQ.    @D52VDVB 04658001
*        RD - BLOCKING FACTOR                                  @D52VDVB 04659001
*        RF - CURRENT ADDRESS IN PFTE-ADDR TABLE               @D52VDVB 04660001
*-------------------------------------------------------------*@D52VDVB 04661001
         SPACE 1                                                        04662001
         USING DEVCB,RB                                        @D14BDRP 04663001
         USING TIBADR,RC                                       @D14BDRP 04664001
*SGLINK  PGOCOMPL,S,INPUT=(R7,R8,RB,RC),OUTPUT=(RB),AMODE=31,          *04665001
               NOMODR=(R7,R8,R9,RA,RC,RD,RF) DATON                      04666001
PGOCOMPL DS    0H                 COMPLETION OF PAGE OUT       @D52VDVB 04667001
         STM   R7,RF,PMRSLEV0+OFR7                             @D52VDVB 04668001
         L     R9,APMRIORT        GET BASE OF CODE             @D52VDVB 04669001
         USING PMRIOMOD,R9                                     @D52VDVB 04670001
         TM    PGQTYP,PGBLK       BLOCKED PAGE OUT             @D52VDVB 04671001
         BO    PGOCOM20           YES ---------->              @D52VDVB 04672001
         SPACE 1                                               @D52VDVB 04673001
*-------------------------------------------------------------*@D52VDVB 04674001
*     PROCESS PAGE OUT COMPLETE - UNBLOCKED                    @D52VDVB 04675001
*-------------------------------------------------------------*@D52VDVB 04676001
         L     R2,TIBSTATE        GET PFTE ADDRESS             @D52VDVB 04677001
*SGLINK  PGOCPFTE,INPUT=(R2,R8,R9,RA,RB,RC),NOMODR=(R2,R7-RF),         *04678001
               AMODE=31 DATON                                           04679001
         BAL   RA,PGOCPFTE                                     @D52VDVB 04680001
         B     PGOCOM90           ----------> EXIT             @D52VDVB 04681001
         SPACE 1                                               @D52VDVB 04682001
*-------------------------------------------------------------*@D52VDVB 04683001
*     PROCESS PAGE OUT COMPLETE - BLOCKED                      @D52VDVB 04684001
*-------------------------------------------------------------*@D52VDVB 04685001
PGOCOM20 DS    0H                                              @D52VDVB 04686001
         SGCOV SGPMR,MC=9                                      @D52VDVB 04687001
         SLR   R6,R6                                           @D52VDVB 04688001
         IC    R6,DEVCPSL         PROCESSED POSLSTATE = INDEX IN       *04689001
                                  ... IN PREPGOTB              @D52VDVB 04690001
*        GENSERV  PGONT,PSLVAL=(R6),PGONT=(R5)                 @D52VDVB 04691001
         GENSERV  PGONT,PSLVAL=(R6),PGONT=(R5)                 @D52VDVB 04692001
         USING PREPGENT,R5                                     @D52VDVB 04693001
         L     RF,PREPGOFF        RELATED OFFSET IN TIBAPFT  =         *04694001
                = OFFSET IN ALLOCATION UNIT *10**(-PNSHIFT+2)  @D52VDVB 04695001
         LA    RF,TIBAPFT(RF)     ADDRESS OF FIRST PFTE-ADDR   @D52VDVB 04696001
         LH    RD,PREPGBLK        BLOCKING FACTOR OF COMPLETED         *04697001
                                  ... PAGE-OUT                 @D52VDVB 04698001
         DROP  R5                                              @D52VDVB 04699001
         SPACE 1                                               @D52VDVB 04700001
PGOCOM30 DS    0H                                              @D52VDVB 04701001
         L     R2,0(,RF)          ADDRESS OF CURRENT PFTE      @D52VDVB 04702001
*SGLINK  PGOCPFTE,INPUT=(R2,R8,R9,RA,RB,RC),NOMODR=(R2,R7-RF),         *04703001
               AMODE=31 DATON                                           04704001
         BAL   RA,PGOCPFTE                                     @D52VDVB 04705001
         LA    RF,4(,RF)          ADDRESS OF NEXT PFTE-ADDRES  @D52VDVB 04706001
         BCT   RD,PGOCOM30        ITERATE ---------->          @D52VDVB 04707001
         SPACE 1                                               @D52VDVB 04708001
         TM    PGQTYP,PGIOERR     ANY ERROR                    @0000036 04709001
         BZ    PGOCOM90           NO, ---------->              @0000036 04710001
         SGCOV SGPMRS,MC=5        ***** SPECIAL                @0000036 04711001
*SGLINK  PGOCUNDO,INPUT=(R8,R9,RA,RB,RC),NOMODR=(R7-R3),AMODE=31 DATON  04712001
         BAL   RA,PGOCUNDO        YES, CALL UNDO ROUTINE       @0000036 04713001
         B     PGOCOM90           ---------->  PRE PAGE OUT    @0000036 04714001
*                                 PGINF=0 IN CASE OF I/O ERROR @0000036 04715001
         B     PGOCOMEX           ---------->  UNCOND PAGE OUT @0000036 04716001
*-------------------------------------------------------------*@D52VDVB 04717001
*     COMMON EXIT                                              @D52VDVB 04718001
*-------------------------------------------------------------*@D52VDVB 04719001
PGOCOM90 DS    0H                                              @D52VDVB 04720001
*SGLINK  DELPGQO,INPUT=(R8,R9,RA,RB,RC),NOMODR=(R6-R1),AMODE=31 DATON   04721001
         BAL   RA,DELPGQO         DELETE ENTRY FROM PGQUO      @D52VDVB 04722001
PGOCOMEX DS    0H                                              @D52VDVB 04723001
         MVI   DEVCPSL,0          RESET PSL VALUE              @D52VDVB 04724001
         LM    R7,RF,PMRSLEV0+OFR7                             @D52VDVB 04725001
.*           NOTE: RC STILL POINTS TO CORRECT PAGE-OUT TIB     @D52VDVB 04726001
.*                 AND TIB CONTAINS VALID INFORMATION          @D52VDVB 04727001
         L     R0,PGINF           AT LEAST ONE-PAGE IN WAITING @D52VDVB 04728001
         LTR   R0,R0                                           @D52VDVB 04729001
         BZR   R7                 NO, ==========>  RETURN      @D52VDVB 04730001
         LR    RB,R0              PROVIDE LAST DEVCB           @D52VDVB 04731001
         BR    R7                 ==========> OTHERWISE RETURN TO      *04732001
                                    HANDLE WAITING DEVICE      @D52VDRP 04733001
         DROP  RB                 RESET ADDR DEVCB             @D52VDVB 04734001
         DROP  RC                 RESET ADDR IORE              @D52VDVB 04735001
         EJECT                                                 @D52VDVB 04736001
*-------------------------------------------------------------*@D52VDVB 04737001
*        ROUTINE PROLOGUE                                      @D52VDVB 04738001
*        ROUTINE NAME:  PGOCPFTE                               @D52VDVB 04739001
*        MACRO:         SGPMR                                  @D52VDVB 04740001
*        FUNCTION: PROCESSES PAGE OUT COMPLETE FOR UNBLOCKED   @D52VDVB 04741001
*        CALLED BY:  PGOCOMPL MODE(31,DATON)                   @D52VDVB 04742001
*        ENTRY POINT:                                          @D52VDVB 04743001
*               PGOCPFTE                                       @D52VDVB 04744001
*        CALLED ROUTINE:                                       @D52VDVB 04745001
*               PMRIOCPL MODE(31,DATOFF)                       @D52VDVB 04746001
*               BLKDISCN MODE(31,DATOFF)                       @D52VDVB 04747001
*               CLEARPF  MODE(31,DATOFF)                       @D52VDVB 04748001
*        INPUT:                                                @D52VDVB 04749001
*               R2 - ADDR OF PFTE BELONGING TO PAGE/BLOCK      @D52VDVB 04750001
*               R8 - ADDR OF PAGEMANAGEMENT DATA-AREA          @D52VDVB 04751001
*               R9 - BASE OF CODE                              @D52VDVB 04752001
*               RA - RETURN ADDRESS                            @D52VDVB 04753001
*               RB - ADDR DEVCB TO WHICH THE PAGE-OUT REQ.     @D52VDVB 04754001
*                    IS QUEUED                                 @D52VDVB 04755001
*               RC - ADDR OF PSEUDO-TIB REQ. PAGE-OUT          @D52VDVB 04756001
*        OUTPUT:   -                                           @D52VDVB 04757001
*        EXIT:  RETURN TO CALLER                               @D52VDRP 04758001
*        RETURN CODE: NONE                                     @D52VDVB 04759001
*        EXIT ERROR:  NONE                                     @D52VDVB 04760001
*------------------------------------------------------------* @D52VDVB 04761001
*     OPERATION:                                               @D52VDVB 04762001
*        PF.R-BIT := OFF               /* REF-BIT OFF        */@D14DDVB 04763001
*        IF PFTE.PCBIT = ON            /* FRAME CONNECTED    */@D149DVB 04764001
*           THEN DO                                            @D149DVB 04765001
*              IF IORE.PGQTYP = PGOPIGN /* PAGE-IN WAITING   */@D149DVB 04766001
*                THEN DO                                       @D149DVB 04767001
*                   WAITDEVCB := IORE.PGINF /*GET ADDR DEVCB */@D149DVB 04768001
*                   DEVCB.DEVSTAT :=  DEVPGWO                  @D149DVB 04769001
*                END                                           @D149DVB 04770001
*              IF PFTE.PFTEBLK = ON    /*ONLY BLOCK CONNECTED*/@D149DVB 04771001
*                THEN CALL BLKDISCN (ADDR(PF))                 @D149DVB 04772001
*                ELSE DO                                       @D149DVB 04773001
*                   IF PTE.PTESTAT=PTEIBIT+PTEPGCO/*CONNECTED*/@D149DVB 04774001
*                      THEN PTE.PTESTAT := ¬PTEPGCO            @D149DVB 04775001
*                END                                           @D149DVB 04776001
*              PFTE.POEBIT+POABIT = OFF                        @D149DVB 04777001
*              CALL CLEARPF(P_F,PSEUDO_TIB)/* CLEAR PAGE FRAME @D149DVB 04778001
*           END                                                @D149DVB 04779001
*        END PGOCPFTE;                                         @D149DVB 04780001
*-------------------------------------------------------------*@D52VDVB 04781001
         SPACE 1                                               @D52VDVB 04782001
         USING PMRIOMOD,R9                                     @D52VDVB 04783001
*SGLINK  PGOCPFTE,S,INPUT=(R2,R8,R9,RA,RB,RC),NOMODR=(R2,R7-RF),       *04784001
               AMODE=31 DATON                                           04785001
         USING DEVCB,RB                                        @D52VDVB 04786001
         USING TIBADR,RC                                       @D52VDVB 04787001
PGOCPFTE DS    0H                                              @D52VDVB 04788001
         STM   R7,RF,PMRSLEV1+OFR7 SAVE REGISTERS              @D52VDVB 04789001
         USING PFTE,R2                                         @D52VDVB 04790001
*        AMODESW SET,DAT=OFF      ENTER REAL MODE              @D52VDRP 04791001
         AMODESW SET,DAT=OFF      ENTER REAL MODE              @D52VDRP 04792001
         LR    RE,R2              GET PFTE ADDRESS             @D52VDVB 04793001
         SL    RE,APFT            OFFSET IN PFT                @D52VDVB 04794001
         SLL   RE,PFSHIFT         RE= PAGEFRAME ADDRESS        @D52VDVB 04795001
         TM    PGQTYP,PGIOERR+PGBLK I/O ERROR DURING BLKD I/O  @0000036 04796001
         BNO   PGOCPF10           NO, ---------->              @0000036 04797001
         TM    PFTEFLG,PIOERR     I/O ERROR ON FRAME           @0000036 04798001
         BZ    PGOCPF10           NO, ---------->              @0000036 04799001
         ISKE  R4,RE              GET STORAGE KEY              @0000036 04800001
         O     R4,CBITMON         C-BIT = ON                   @0000036 04801001
         N     R4,RBITOFF         R-BIT = OFF                  @0000036 04802001
         SSKE  R4,RE              SET MODIFIED STORAGE KEY     @0000036 04803001
         NI    PFTEFLG,XFF-POABIT-PIOERR RESET PAGE-OUT ACTIVE AND     *04804001
                                  ... I/O ERROR FLAGS          @0000036 04805001
         LA    R0,4(,0)           REQ: SET POSLSTATE ON        @DY43697 04806001
         LR    RC,R2              ADDR OF CURRENT PFTE         @D61NDVB 04807001
         L     RA,APFTPOSL                                     @D61NDVB 04808001
*SGLINK  PFTEPOSL,INPUT=(R0,R8,RA,RC),OUTPUT=(R0,R4,R5,R6,R7),         *04809001
               NOMODR=(R1-R3,R8-RF),AMODE=31 ANY,DATOFF                 04810001
         BALR  RA,RA              GET ADDRESS OF POSLSTATE     @D61NDVB 04811001
.*    OUTPUT NOT USED                                          @D61NDVB 04812001
         L     RC,PMRSLEV1+OFR12  GET ADDRESS OF IORE          @D61NDVB 04813001
         TM    PFTEFLG,PCBIT      UNCOND. PAGE-OUT REQUEST     @0000036 04814001
         BO    PGOCPFEX           YES,       --------->        @0000036 04815001
         NI    PFTEFLG,XFF-POEBIT RESET PAGEOUT FLAGS          @0000036 04816001
         B     PGOCPF60           CONTINUE NORMAL PROCESSING   @DY43697 04817001
         SPACE 1                                                        04818001
PGOCPF10 DS    0H                                              @0000036 04819001
         RRBE  0,RE               SET R_BIT OFF                @D51GDTP 04820001
         SLR   R1,R1                                           @D52VDVB 04821001
         ICM   R1,7,PFTEEPA#      GET EPA NUMBER               @D52VDVB 04822001
         SLL   R1,PNSHIFT         CONVERT TO EPA               @D52VDVB 04823001
         ST    R1,PAGEADDR        SAVE IT                      @D52VDVB 04824001
         NI    PFTEFLG,XFF-POEBIT-POABIT RESET ALL PGEOUT FLAGS@D52VDVB 04825001
         TM    PFTEFLG,PCBIT      UNCOND. PAGE-OUT REQUEST     @D14NDEJ 04826001
         BZ    PGOCPF60           NO,  ---------->             @D52VDVB 04827001
         TM    S370FLG,PFTEBLK    ONLY BLOCK CONNECTED         @D14BDRP 04828001
         BZ    PGOCPF20           NO, BRANCH                   @D14BDRP 04829001
         LR    RD,R1              SET I/F TO BLKDISCN          @D14BDRP 04830001
         L     R9,APMRSERV        GET ....                     @D52VDVB 04831001
         USING PMRSERV,R9         .... ADDRESSABILITY          @D52VDVB 04832001
         BAL   RA,BLKDISCN        DISCONNECT BLOCK             @D14BDRP 04833001
*SGLINK  BLKDISCN,INPUT=(R8,R9,RA,RD,RE),WORK=(R4,R5),                 *04834001
               AMODE=31 DATOFF                                          04835001
         L     R9,APMRIORT                                     @D52VDVB 04836001
         USING PMRIOMOD,R9        RESET BASE FOR CODE AREA     @D51GDRP 04837001
         B     PGOCPF40           ---------->                  @D14BDRP 04838001
         SPACE 1                                               @D52VDVB 04839001
PGOCPF20 LR    R4,R1                                           @D14BDRP 04840001
         SRL   R4,PTSHIFT          * GET PAGE TABLE ENTRY      @D14BDRP 04841001
         A     R4,APT              * BELONGING TO R1           @D14BDRP 04842001
         TM    PFTEFLG,PIOERR     ERRONEOUS PAGE (UNBLOCKED)   @D52GDRP 04843001
*        AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @D52VDRP 04844001
         AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @D52VDRP 04845001
         BZ    PGOCPF21           NO, PAGE-OUT WAS O.K.        @D52GDRP 04846001
         DROP  R2                 DROP BASE FOR PFTE (REAL)    @D52VDRP 04847001
*   R2 HAS STILL TO CONTAIN PFTE ADDRESS                       @D52VDRP 04848001
         USING PTE,R4                                          @D14BDRP 04849001
         OI    PTESTAT,PTEERR     INDICATE ERRONEOUS PAGE      @D52GDRP 04850001
PGOCPF21 DS    0H                                              @D52GDRP 04851001
         TM    PTESTAT,PTEIBIT+PTEPGCO    PAGE = CONNECTED     @D14ADVB 04852001
         BO    PGOCPF25           YES, --------->              @D14ADVB 04853001
         BAL   R5,PMRHWERR        NO,  =========> HARD WAIT    @D52VDVB 04854001
.*  PTE HAS NOT TO BE CHANGED                                  @D52VDRP 04855001
PGOCPF25 DS    0H                                              @D52VDVB 04856001
         NI    PTESTAT,XFF-PTEPGCO PAGE = DISCONNECTED         @D14ADVB 04857001
         DROP  R4                 FORGET BASE FOR PTE          @D14BDRP 04858001
         SPACE 1                                                        04859001
*     ENQUEUE PFTE IN INVALID-PAGE-FRAME QUEUE, REQUEST WAS    @D14BDRP 04860001
*     AN UNCONDITIONAL PAGE-OUT                                @D14BDRP 04861001
*        AMODESW SET,DAT=OFF      ENTER REAL MODE              @D52VDRP 04862001
         AMODESW SET,DAT=OFF      ENTER REAL MODE              @D52VDRP 04863001
         USING PFTE,R2                                         @D52VDRP 04864001
         DROP  RB                 RESET ADDR DEVCB             @D52VDVB 04865001
PGOCPF40 DS    0H                                              @D52VDRP 04866001
         LR    RC,R2              GET PFTE ADDR                @D14BDRP 04867001
         STM   R0,RF,PMRSVDBG     SAVE ALL REGISTER            @KD40295 04868001
         LM    R0,R7,PFTEPNR      GET PFTE IN REGISTER 0-7     @KD40295 04869001
         L     RF,PMRDDISC        INDICATE DISCONNECT EVENT    @KD40295 04870001
         DEBUG ALLREGS,XXDBGMC    * CREATE DEBUG ENTRY         @KD40295 04871001
         LM    R0,RF,PMRSVDBG     RESTORE REGISTERS            @KD40295 04872001
         BAL   R7,CLEARPF         CLEAR PF TO ZERO             @D35CDAA 04873001
*SGLINK  CLEARPF,INPUT=(R7,RC,RE),WORK=(R4,R5,RA,RB)           @D14BDRP 04874001
         L     RC,PMRSLEV1+OFR12  REESTABLISH ADDR IORE        @D52VDVB 04875001
         SPACE 1                                               @D52VDVB 04876001
PGOCPF50 DS    0H                                              @D52VDVB 04877001
         L     RB,PFTEDVCB        PAGE-IN WAITING              @D52VDVB 04878001
         LTR   RB,RB              ... ON DEVCB                 @D52VDVB 04879001
         BZ    PGOCPF70           NO, ---------->              @D52VDVB 04880001
         NI    DEVSTAT-DEVCB(RB),XFF-DEVPGWO RESET DEV. WAITING@D14BDRP 04881001
         ST    RB,PGINF                                        @D52VDVB 04882001
PGOCPF60 DS    0H                                              @D52VDVB 04883001
         SLR   RB,RB                                           @D52VDVB 04884001
         ST    RB,PFTEDVCB        RESET WAITING INDICATION     @D52VDVB 04885001
PGOCPF70 DS    0H                                              @D52VDVB 04886001
         ST    RB,PFTETIB         RESET ADDR (IORE)            @D52VDVB 04887001
*        AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @D52VDVB 04888001
         AMODESW SET,DAT=ON                                    @D52VDVB 04889001
         LR    R1,R2              GET PFTE ADDRESS             @D14BDRP 04890001
         L     R6,DISPAD          BASE OF DISPATCHER           @D52VDVB 04891001
         USING DISP,R6                                                  04892001
         L     R5,ASRQTAB         GET ADDRESS OF ...           @D61RDRP 04893001
         LA    R5,SRQPGIO-SRQTAB(,R5) ... RESOURCE QUEUE       @D61RDRP 04894001
         BAL   RF,RPOST           POST TASKS WAITING FOR PF    @D36IDRP 04895001
*SGLINK  RPOST,INPUT=(R1,R5,R6,RF),WORK=(R5,RE)                @D369DRP 04896001
         DROP  R6                 RESET ADDR DISPATCHER        @D52VDVB 04897001
PGOCPFEX DS    0H                                              @D52VDVB 04898001
*        AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @0000036 04899001
         AMODESW SET,DAT=ON                                    @0000036 04900001
         LM    R7,RF,PMRSLEV1+OFR7 RESET CALLER'S REGISTERS    @D52VDVB 04901001
         BR    RA                 ==========>   EXIT PGOCPFTE  @D52VDVB 04902001
         SPACE 1                                                        04903001
         DROP  RC                 RESET ADDR IORE              @D52VDVB 04904001
         DROP  R2                 RESET ADDR PFTE              @D52VDVB 04905001
         DROP  R9                 RESET ADDR OF CODE           @D52VDVB 04906001
*-------------------------------------------------------------*@D52VDVB 04907001
         EJECT                                                 @D52VDVB 04908001
*-------------------------------------------------------------*@0000036 04909001
*        ROUTINE PROLOGUE                                      @0000036 04910001
*        ROUTINE NAME:  PGOCUNDO                               @0000036 04911001
*        MACRO:         SGPMR                                  @0000036 04912001
*        FUNCTION: RESET POSLSTATE AND FRAME IF I/O ERROR      @0000036 04913001
*                  OCCURS FOR BLOCKED PAGE-OUT                 @0000036 04914001
*        CALLED BY:  PGOCOMPL MODE(31,DATON)                   @0000036 04915001
*        ENTRY POINT:                                          @0000036 04916001
*               PGOCUNDO                                       @0000036 04917001
*        CALLED ROUTINE:                                       @0000036 04918001
*               PGOQPFTE MODE(31,DATON)                        @0000036 04919001
*        INPUT:                                                @0000036 04920001
*               R8 - ADDR OF PAGEMANAGEMENT DATA-AREA          @0000036 04921001
*               R9 - BASE OF CODE                              @0000036 04922001
*               RA - RETURN ADDRESS                            @0000036 04923001
*               RB - ADDR DEVCB TO WHICH THE PAGE-OUT REQ.     @0000036 04924001
*                    IS QUEUED                                 @0000036 04925001
*               RC - ADDR OF PSEUDO-TIB REQ. PAGE-OUT          @0000036 04926001
*        OUTPUT:   -                                           @0000036 04927001
*        EXIT:  RETURN TO CALLER                               @0000036 04928001
*                    OFFSET 0 :  BLOCKED PRE-PAGE-OUT          @D61NDVB 04929001
*                    OFFSET 4 :  UNCONDITIONAL BLOCKED PAGE-OUT@D61NDVB 04930001
*        RETURN CODE: NONE                                     @0000036 04931001
*        EXIT ERROR:  NONE                                     @0000036 04932001
*------------------------------------------------------------* @0000036 04933001
*     OPERATION:                                               @0000036 04934001
*        IF TIBSTATE  = 0                                      @0000036 04935001
*           THEN RETURN(OFFSET 0)      /* PRE PAGE OUT       */@D61NDVB 04936001
*           ELSE DO                    /* UNCONDITION PAGEOUT*/@D61NDVB 04937001
*           /* UNDO ACTION: RESET ALL- DO UNBL UNCOND PAGEOUT*/@0000036 04938001
*              TIBAALU -> POSLSTATE =  /* RESET ORIGINAL POSL*/@0000036 04939001
*                TIBAALU -> POSLSTATE OR DEVCPSL               @0000036 04940001
*              CALL PGOQPFTE(SPEC,RC,DEVCPSL)                  @0000036 04941001
*                                      /* RESET TIBAPFT LIST */@0000036 04942001
*              IF TIB NOT IN PGQSYS                            @0000036 04943001
*                THEN DO                                       @0000036 04944001
*                  CALL DELENTR(TIB,PGQO) /* DELETE ENTRY    */@0000036 04945001
*                              /*DO NOT ENQUEUE IN FREE CHAIN*/@0000036 04946001
*                  INSERT TIB AT TOP OF PGQSYS                 @0000036 04947001
*                END                                           @0000036 04948001
*           RETURN(OFFSET 4)                                   @0000036 04949001
*           END                                                @0000036 04950001
*        END PGOCUNDO;                                         @0000036 04951001
*-------------------------------------------------------------*@0000036 04952001
         SPACE  2                                              @0000036 04953001
*SGLINK  PGOCUNDO,S,INPUT=(R8,R9,RA,RB,RC),NOMODR=(R7-R3),             *04954001
               AMODE=31 DATON                                           04955001
         USING PMRIOMOD,R9                                     @D52VDVB 04956001
PGOCUNDO DS    0H                                              @0000036 04957001
         USING TIBADR,RC          ADDRESSABILITY TO IORE       @0000036 04958001
         USING DEVCB,RB           ADDRESSABILITY TO DEVCB      @0000036 04959001
         L     R4,TIBSTATE        UNCOND. BLOCKED PAGE-OUT     @0000036 04960001
         LTR   R4,R4                                           @0000036 04961001
         BZR   RA                 NO, ==========> EXIT PGOCUNDO@0000036 04962001
         SPACE 1                                                        04963001
*     REDO UNCONDITIONAL PAGE-OUT UNBLOCKED                    @0000036 04964001
         STM   R7,R3,PMRSLEV2+OFR7 SAVE REGISTER               @0000036 04965001
         L     RE,TIBAALU                                      @0000036 04966001
         USING PSLSTATE,RE        ADDRESSABILITY TO POSLSTATE  @0000036 04967001
         SLR   R6,R6                                           @0000036 04968001
         IC    R6,DEVCPSL         POSLSTATE BEING PAGED-OUT    @0000036 04969001
         NI    PGQTYP,XFF-PGBLK   RESET BLOCKED I/O INDICATION @0000036 04970001
         LA    R0,12(,0)          SPECIAL RESET REQUEST        @0000036 04971001
         LR    R5,RC                                           @0000036 04972001
         L     RA,APGOQPFT        RESET                        @0000036 04973001
         BALR  RA,RA              ...ADDR(IORE) IN TIBAPFT LIST@0000036 04974001
*SGLINK  PGOQPFTE,INPUT=(R0,R5,R6,R8,RA),NOMODR=(R1-RF),AMODE=31 DATON  04975001
         LA    R3,PFRQBEG+TIBADR-TIBCHAIN  HEADER OF PGQSYS    @0000036 04976001
         CL    RC,TIBCHAIN-TIBADR(,R3) IORE IN PGQSYS          @0000036 04977001
         BE    PGOCUN40           YES, ------------>           @0000036 04978001
*      DELETE IORE FROM PGQO                                   @0000036 04979001
         L     R3,DEVPCB          GET A(ACTUAL CLASS-PCB)      @0000036 04980001
         ST    R3,PFPCB           SAVE IT FOR DELENTR RTN      @0000036 04981001
         LA    R3,PORQBEG-TIBCHAIN+TIBADR GET HEADER OF PGQO   @0000036 04982001
         L     R9,APMRSERV        ADDRESSABILITY               @0000036 04983001
         USING PMRSERV,R9         ... TO SERVICE ROUTINES      @0000036 04984001
         NI    PGQTYP,XFF-PGO     RESET PAGE-OUT INDICATION TO AVOID   *04985001
                                  ... ENQ IN FREE QUEUE(IORE)  @D000036 04986001
         BAL   RA,DELENTR         DELETE ENTRY FROM QUEUE      @D000036 04987001
*SGLINK  DELENTR,INPUT=(R3,R8,RA,RB,RC),WORK=(R4,R5),OUTPUT=(R2),      *04988001
               NOMODR=(R6-R1,R3),AMODE=31 DATON                         04989001
         L     R9,APMRIORT        ADDRESSABILITY               @0000036 04990001
         USING PMRIOMOD,R9        ... TO I/O ROUTINES          @0000036 04991001
         OI    PGQTYP,PGO         SET PAGE-OUT INDICATION      @0000036 04992001
*      ENQUEUE IORE TOP OF PGQSYS                              @0000036 04993001
.*     THIS IORE WAS BEING DEQUEUED FROM THE PGQO. I/O HAS BEEN@0000036 04994001
.*     COMPLETED ON PGQO. NO I/O ACTIVE ON DEVCB               @0000036 04995001
         LA    R3,PFRQBEG+TIBADR-TIBCHAIN  HEADER OF PGQSYS    @0000036 04996001
         L     R4,TIBCHAIN-TIBADR(,R3) 1ST ELEMENT IN PGQSYS   @0000036 04997001
         ST    RC,TIBCHAIN-TIBADR(,R3) CURRENT IORE AS 1ST ELEM@0000036 04998001
         ST    R4,TIBCHAIN        PREVIOUS 1ST ELEMENT WILL BE         *04999001
                                  ... 2ND ELEMENT              @0000036 05000001
         LTR   R4,R4              PGQSYS PREVIOUSLY EMPTY      @0000036 05001001
         BNZ   PGOCUN40           NO,  ---------->             @0000036 05002001
         ST    RC,PFRQEND         SET ADDR OF LAST QUEUE ELEMNT@0000036 05003001
         L     R5,ASYSPCB         GET ADDR SYS-PCB             @D61RDVB 05004001
         L     R1,DEVCBMSK        GET DEVICE MASK              @D61RDVB 05005001
         LA    R3,1(,0)           ENQUEUE REQUEST              @D61RDVB 05006001
*        DISPMAC FUNC=PFUPD,INP1=(R1),INP2=(R3),INP3=(R5)               05007001
         DISPMAC FUNC=PFUPD,INP1=(R1),INP2=(R3),INP3=(R5)               05008001
PGOCUN40 DS    0H                                              @0000036 05009001
         LM    R7,R3,PMRSLEV2+OFR7                             @0000036 05010001
         B     4(,RA)             ==========>    EXIT PGOCUNDO @0000036 05011001
         SPACE 1                                               @0000036 05012001
         DROP  RE                 RESET ADDR PSLSTATE          @0000036 05013001
         DROP  RB                 RESET ADDR DEVCB             @0000036 05014001
         DROP  RC                 RESET ADDR IORE              @0000036 05015001
         DROP  R9                 RESET ADDR PMRIOMOD          @0000036 05016001
*-------------------------------------------------------------*@D52VDVB 05017001
         TITLE 'VSE/AF SUPERVISOR     SGPMR     PAGE MANAGER ( GENERAL *05018001
               SERVICE ROUTINES)'                              @D14ZDRP 05019001
*-------------------------------------------------------------*@D529DVB 05020001
*   GENERAL SERVICES ROUTINES:                                 @D529DVB 05021001
*        MACRO:        SGPMR                                   @D529DVB 05022001
*        BASE :        PMRSERV                                 @D529DVB 05023001
*        BASE ADDRESS: APMRSERV                                @D529DVB 05024001
*-------------------------------------------------------------*@D529DVB 05025001
         SPACE 2                                                        05026001
PMRSERV  DS    0H                 BASE ADDRESS OF PAGE MANAGER         *05027001
                                  SERVICES                     @D52VDVB 05028001
         USING PMRSERV,R9         SET BASE FOR DATA AREA       @D52VDVB 05029001
         SPACE 2                                                        05030001
*-------------------------------------------------------------*@D149DVB 05031001
*        ROUTINE PROLOGUE                                      @D149DVB 05032001
*        ROUTINE NAME: ENQENTR                                 @D149DVB 05033001
*        MACRO:        SGPMR                                   @D149DVB 05034001
*        FUNCTION:  SETS TIBSTATE WITH PAGE FAULT ADDRESS      @D529DVB 05035001
*                   AND DETERMINES AFFECTED DEVCB (ENQUENTR).  @D529DVB 05036001
*                   ENQUEUES THE IORE AT BOTTOM OF PGQO/PGQSYS @D529DVB 05037001
*                   OF SPECIFIED RESP. DETERMINED DEVCB        @D529DVB 05038001
*                   (ENQENTR AND ENQENTR2)                     @D529DVB 05039001
*        CALLED BY:                                            @D149DVB 05040001
*              ENQUI    AT ENQENTR WITH AMODE(31),DATON        @D529DRP 05041001
*              POSTENT  AT ENQENTR WITH AMODE(31),DATON        @D529DRP 05042001
*              ENQUOBLK AT ENQENTR2 WITH AMODE(31),DATON       @D61RDRP 05043001
*              PGINENQI AT ENQENTR2 WITH AMODE(31),DATON       @D529DRP 05044001
*        CALLED ROUTINES: GETDEVCB WITH AMODE(31),DATON        @D149DVB 05045001
*        ENTRY POINT:ENQENTR                                   @D149DVB 05046001
*                   ENQENTR2                                   @D149DVB 05047001
*        EXIT :     CALLER WITH MODE OF CALLER                 @D149DVB 05048001
*        ERROR EXIT: -                                         @D149DVB 05049001
*        ENTERED IN ENQENTR:                                   @D149DVB 05050001
*           INPUT:                                             @D149DVB 05051001
*                   R7 : RETURN ADDRESS                        @D149DVB 05052001
*                   RC : ADDRESS(TIB) TO BE ENQUEUED           @D149DVB 05053001
*                   RD : EPA RELATED TO PAGE FAULT             @D149DVB 05054001
*                   RE : ADDR(CLASSPCB) BELONGING TO PAGE FAULT@D519DRP 05055001
*           OUTPUT:                                            @D149DVB 05056001
*                   RB : ADDR(DEVCB) WHERE TIB HAS BEEN ENQUEUED        05057001
*        ENTERED IN ENQENTR2:                                  @D149DVB 05058001
*           INPUT:                                             @D149DVB 05059001
*                   R7 : RETURN ADDRESS                        @D149DVB 05060001
*                   RB : ADDR(DEVCB) WHERE TIB HAS TO BE ENQUEUED       05061001
*                   RC : ADDRESS(TIB) TO BE ENQUEUED           @D149DVB 05062001
*                   RE : ADDR(CLASSPCB) BELONGING TO PAGE FAULT@D519DRP 05063001
*                                                              @D149DVB 05064001
*        OPERATION:                                            @D149DVB 05065001
*                                                              @D149DVB 05066001
*        ENQENTR: IORE.TIBSTATE := ADDR(PAGE_FAULT)            @D149DVB 05067001
*        CALL GETDEVCB (PAGE_FAULT) /*GET DEVICE TO PAGEFAULT*/@D149DVB 05068001
*        SET (RETURN REG)           /*USE ENQUENTR2 RET-REG  */@D149DVB 05069001
*        ENQENTR2:                                             @D149DVB 05070001
*        GET_ID (PCB)                                          @D149DVB 05071001
*        IORE.TIBCHAIN := 0         /* INDICATE LAST ELEM    */@D149DVB 05072001
*        GET_PFRQEND (DEVCB,ID)     /* PREVIOUS LAST ELEM    */@D149DVB 05073001
*        DEVCB.PFRQEND (ID) := ADDR(TIB)  /* UPDATE HEADER   */@D149DVB 05074001
*        PFRQEND.TIBCHAIN := ADDR (TIB) /* SET TIB IN DEVCBCH*/@D149DVB 05075001
*        IF ADDR(TIB) = DEVCB.PFRQBEG /* FIRST ELEMENT       */@D149DVB 05076001
*           THEN DO                                            @D149DVB 05077001
*           CALL DISPMAC(FUNC=PFUPD)  /*INDICATE P_F PENDING */@D149DVB 05078001
*           DEVCB.DEVEMPTY := OFF     /* REQUEST QUUED       */@D149DVB 05079001
*        END    ;                                              @D149DVB 05080001
*                                                              @D149DVB 05081001
*-------------------------------------------------------------*@D149DVB 05082001
*                                                                       05083001
*SGLINK  ENQENTR,S,INPUT=(R7,R9,RC,RD,RE),WORK=(R3-R5,RD),             *05084001
               OUTPUT=(RB),NOMODR=(RE-R2,R6-RA,RC),AMODE=31 DATON       05085001
* 'ANY' ONLY POSSIBLE WITH PAGE-OUT TIB                        @D52VDRP 05086001
         USING TIBADR,RC                                       @D36IDFR 05087001
ENQENTR  DS    0H                                              @D52VDVB 05088001
         ST    RD,TIBSTATE        EPA OF PAGE FAULT            @D36IDFR 05089001
         MVI   PGQTYP,ZERO        RESET PMR INDICATIONS        @D52VDRP 05090001
.*  INPUT FOR THE FOLLOWING SDAID MONITOR CALL:                @D149DRP 05091001
.*      RC - ADDR OF TIB BELONGING TO THE PAGE-FAULT REQUEST   @D149DRP 05092001
.*      RD - ADDR OF PAGE TO BE HANDLED (NOT IN STORAGE)       @D149DRP 05093001
.*       MC    $TRPAG1,$MCSDAID   PAGENQ EVENT SDAID                    05094001
         SPACE 2                                                        05095001
*     GET ADDR OF DEVCB CORRESP. TO PAGE-ADDR                  @D14BDRP 05096001
         LR    R5,RD              GET PAGE ADDR IN CORRECT REG.@D14BDRP 05097001
         BAL   R4,GETDEVCB                                     @D14BDRP 05098001
*SGLINK  GETDEVCB,INPUT=(R4,R5,R8,R9),OUTPUT=(RB),                     *05099001
               NOMODR=(RC-R2,R4,R6-RA)                                  05100001
*     ON RETURN RB POINTS TO CORRECT DEVCB                     @D14BDRP 05101001
         SPACE 1                                                        05102001
*SGLINK  ENQENTR2,S,INPUT=(R7,R8,R9,RB,RC,RE),WORK=(R3-R5,RD),         *05103001
               NOMODR=(RE-R2,R4,R6-RA,RC),AMODE=31 DATON       @D61RDRP 05104001
* 'ANY' ONLY POSSIBLE WITH PAGE-OUT TIB                        @D52VDRP 05105001
ENQENTR2 DS    0H                                              @D14BDRP 05106001
         STM   R7,R2,PMRSLEV3+OFR7   SAVE REGISTERS            @D61RDRP 05107001
         USING DEVCB,RB                                        @D14BDRP 05108001
*     GET OFFSET TO CORRECT PAGEFAULT-QUEUE HEADER IN DEVCB    @D14BDRP 05109001
         USING PCBADR,RE          SET BASE FOR CLASS-PCB       @D36IDRP 05110001
         LH    R5,PCBID           * GET OFFSET TO              @D51IDRP 05111001
         SLL   R5,3               * REQUEST QUEUE HEADER       @D51IDRP 05112001
         L     RD,PFRQEND(R5)     LOAD END PTR.OF PMR.REQ.QUEUE@D14BDRP 05113001
         ST    RC,PFRQEND(R5)     PUT REQUEST TO END OF CHAIN  @D14BDRP 05114001
         SR    R3,R3                                           @D36IDRP 05115001
         ST    R3,TIBCHAIN        INDICATE LAST ELEM. IN CHAIN @D36IDRP 05116001
         DROP  RC                 FORGET BASE FOR TIB          @D36IDRP 05117001
         USING TIBADR,RD                                       @D36IDFR 05118001
         ST    RC,TIBCHAIN        CHAIN REQUEST TO PREV.ONE    @D36IDFR 05119001
         DROP  RD                 FORGET BASE FOR TIB          @D36IDFR 05120001
         USING TIBADR,RC                                       @D61RDRP 05121001
         L     R5,ASYSPCB         ASSUME SYSTEM QUEUE          @D61RDRP 05122001
         SLR   R1,R1                                           @DY43697 05123001
*    GENSERV   COMP,FIELD=ASYSPCB,REG=(R3),BC=BE,LAB=ENQENT20,         *05124001
               COMPF=(RE)         ARE WE IN SYSTEM QUEUE       @DY43697 05125001
     GENSERV   COMP,FIELD=ASYSPCB,REG=(R3),BC=BE,LAB=ENQENT20,         *05126001
               COMPF=(RE)                                      @DY43697 05127001
         L     R5,TIBPCB          NO, GET ADDR. OF PART.PCB    @D61RDRP 05128001
         TM    PCBFLAG,SUPPRPFH+SUPPFTPI PARTITION/CLASS DEACT @DY43697 05129001
         BZ    ENQENT20           NO,  --------->              @DY43697 05130001
         L     R1,DEVDEACT        PROVIDE DEACTIVATION MASK... @DY43697 05131001
ENQENT20 DS    0H                                              @D61RDRP 05132001
         O     R1,DEVCBMSK        ... AND COMBINE WITH DEV MASK@DY43697 05133001
         LA    R3,1(,0)           ENQUEUE REQUEST              @D61RDVB 05134001
*        DISPMAC FUNC=PFUPD,INP1=(R1),INP2=(R3),INP3=(R5)               05135001
         DISPMAC FUNC=PFUPD,INP1=(R1),INP2=(R3),INP3=(R5)               05136001
ENQENTEX DS    0H                                              @D61RDVB 05137001
         NI    DEVSTAT,X'FF'-DEVEMPTY INDICATE REQUEST QUEUED  @D14BDRP 05138001
         LM    R7,R2,PMRSLEV3+OFR7                             @D61RDRP 05139001
         BR    R7                 ==========>  RETURN ENQENTR  @D14BDRP 05140001
         DROP  RB,RE              DROP BASE FOR DEVCB,CLASS-PCB@D14BDRP 05141001
         DROP  RC                 DROP BASE FOR TIBADR         @D61RDRP 05142001
         EJECT                                                 @D14ZDVB 05143001
*---------------------------------------------------------------------* 05144001
*        ROUTINE PROLOGUE                                      @D149DVB 05145001
*        ROUTINE NAME: DELENTR                                 @D149DVB 05146001
*        MACRO:        SGPMR                                   @D149DVB 05147001
*        FUNCTION:  DELETES ENTRIES FROM PAGE QUEUE            @D149DVB 05148001
*        CALLED BY:                                            @D149DVB 05149001
*             DELPGQO,PGICOMPL,PGOCUNDO,POSTENT,SCDELPGO,      @D149DVB 05150001
*             RESPHO                      WITH AMODE(31),DATON @D149DVB 05151001
*        CALLED ROUTINES:                                      @D529DRP 05152001
*              -                                               @D529DRP 05153001
*        ENTRY POINT :                                         @D149DVB 05154001
*              DELENTR                                         @D149DVB 05155001
*        EXIT :     CALLER WITH MODE OF CALLER                 @D149DVB 05156001
*        ERROR EXIT: -                                         @D149DVB 05157001
*        INPUT:                                                @D149DVB 05158001
*                   R3  :  ADDR PREVIOUS TIB IN CHAIN          @D149DVB 05159001
*                   RA  :  RETURN ADDRESS                      @D149DVB 05160001
*                   RB  :  ADDR OF DEVCB                       @D149DVB 05161001
*                   RC  :  ADDR CURRENT TIB IN CHAIN           @D149DVB 05162001
*                   PFPCB  A(CLASS-PCB) BELONGING TO PQ HEADER @D149DVB 05163001
*        OUTPUT:    R2  :  ADDR NEXT TIB OR 0 IF LAST TIB      @D149DVB 05164001
*                          HAS BEEN DELETED                    @D149DVB 05165001
*        UNCHANGED REGISTERS:                                  @D149DVB 05166001
*                   R3, R6, R7, RB, RD                         @D149DVB 05167001
*                                                              @D149DVB 05168001
*        OPERATION:                                            @D149DVB 05169001
*                                                              @D149DVB 05170001
*        DELENTR :                /*     ENTRY POINT         */@D149DVB 05171001
*        IORE.TIBCHAIN(PREV) := IORE.TIBCHAIN(NEXT)            @D149DVB 05172001
*        IF IORE.PGO = ON         /*    PSEUDO TIBS          */@D149DVB 05173001
*           THEN DO                                            @D149DVB 05174001
*               IORE.TIBCHAIN(CUR) := PGQOFREE                 @D149DVB 05175001
*               PGQOFREE := ADDR (TIB(CUR))                    @D149DVB 05176001
*               INCREASE PGQOCNT                               @D149DVB 05177001
*           END                                                @D149DVB 05178001
*        END_IF                                                @D149DVB 05179001
*        DELENTR1:                /*    SEC. ENTRY POINT     */@D149DVB 05180001
*        IF IORE.TIBCHAIN(NEXT) = 0 /* LAST TIB DEQUEUED     */@D149DVB 05181001
*           THEN DO                                            @D149DVB 05182001
*               ADDR_DEVCB.PFRQ (PIK)                          @D149DVB 05183001
*               DEVCB.PFRQEND := IORE.TIBCHAIN(PREV)           @D149DVB 05184001
*               IF DEVCB.PFRQBEG = 0  /*  QUEUE EMPTY        */@D149DVB 05185001
*                  THEN RETURN     /*   EXIT =====>          */@D149DVB 05186001
*           END                                                @D149DVB 05187001
*           ELSE                                               @D149DVB 05188001
*        END (DELENTR) ;                                       @D149DVB 05189001
*-------------------------------------------------------------*@D149DVB 05190001
         SPACE 1                                               @D14NDVB 05191001
*SGLINK  DELENTR,S,INPUT=(R3,R8,RA,RB,RC),WORK=(R4,R5),OUTPUT=(R2),    *05192001
               NOMODR=(R6-R1,R3),AMODE=31 DATON                         05193001
DELENTR  DS    0H                                                       05194001
         USING DEVCB,RB                                        @D14BDRP 05195001
         USING TIBADR,RC                                       @D36IDFR 05196001
         L     R2,TIBCHAIN        POINTER TO NEXT ENTRY        @D36IDFR 05197001
         DROP  RC                                              @D36IDFR 05198001
         USING TIBADR,R3                                       @D36IDFR 05199001
         ST    R2,TIBCHAIN        SETUP PREVIOUS POINTER       @D36IDFR 05200001
         DROP  R3                                              @D36IDRP 05201001
         USING TIBADR,RC                                       @D14BDRP 05202001
         TM    PGQTYP,PGO         PSEUDO-TIB REMOVED           @D51ZDRP 05203001
         BZ    DELENTR1           NO, BRANCH                   @D14BDRP 05204001
*    ENQUEUE PSEUDO-TIB ON TOP OF FREE QUEUE                   @D14BDRP 05205001
         CLI   PGOFLAG,X'80'      ALREADY IN FREE QUEUE        @D52VDVB 05206001
         BE    DELENTR0           NO,  ---------->             @D52VDVB 05207001
         BAL   R5,PMRHWERR        YES, ==========>  HW         @D52VDVB 05208001
DELENTR0 DS    0H                                              @D52VDVB 05209001
         MVI   PGOFLAG,0          IND. IORE IN FREE QUEUE      @D52VDVB 05210001
         L     R5,PGQOLAST                                     @D52VDVB 05211001
         ST    RC,PGQOLAST                                     @D52VDVB 05212001
         ST    RC,TIBCHAIN-TIBADR(,R5)                         @D52VDVB 05213001
         SLR   R5,R5                                           @D52VDVB 05214001
         ST    R5,TIBCHAIN                                     @D52BDRP 05215001
*        GENSERV INC,FIELD=PGQOCNT,REG=(R5)                    @D52VDVB 05216001
         GENSERV INC,FIELD=PGQOCNT,REG=(R5)                    @D52VDVB 05217001
         SPACE 1                                                        05218001
DELENTR1 LTR   R2,R2              LAST ENTRY TO BE DELETED?    @D36IDFR 05219001
         BNZR  RA                 NO, RETURN  ==========>      @D36IDFR 05220001
         L     R4,PFPCB           GET ADDR OF ACTUAL CLASS-PCB @D14BDRP 05221001
         USING PCBADR,R4          SET BASE FOR CLASS-PCB       @D14BDRP 05222001
         LH    R5,PCBID             * GET OFFSET               @D51IDRP 05223001
         SLL   R5,3                 * IN REQUEST QUEUE HEADER  @D51IDRP 05224001
         ST    R3,PFRQEND(R5)     UPDATE END PTR.OF PF-QUEUE   @D36IDFR 05225001
         L     R5,PFRQBEG(R5)                                  @D36IDRP 05226001
         LTR   R5,R5              QUEUE OF THIS PART. EMPTY    @D36IDRP 05227001
         BNZR  RA                 NO, ==========>              @D52VDVB 05228001
         SPACE 2                                               @D36IDRP 05229001
         LH    R5,PCBID             * GET OFFSET               @D51IDRP 05230001
         SLL   R5,3                 * IN REQUEST QUEUE HEADER  @D51IDRP 05231001
         LA    R4,PFRQBEG(R5)                                  @D36IDRP 05232001
         C     R4,PFRQEND(R5)     QUEUE REALLY EMPTY           @D14BDRP 05233001
         L     R4,PFPCB           REST. ACTUAL CLASS-PCB ADDR  @D14BDRP 05234001
         BE    PMRDBG10           YES, O.K.                    @D14BDRP 05235001
         BAL   R5,PMRHWERR        NO,  ERROR                   @D14BDRP 05236001
PMRDBG10 EQU   *                                               @D14BDRP 05237001
*   INDICATE NO PAGEFAULT PENDING FOR THIS REQ. QUEUE          @D369DRP 05238001
         STM   R1,R3,PMRSAVLO+OFR1                             @D61RDVB 05239001
         L     R5,ASYSPCB         ASSUME SYSTEM QUEUE          @D61RDRP 05240001
*    GENSERV   COMP,FIELD=ASYSPCB,REG=(R1),BC=BE,LAB=DELENTR5,         *05241001
               COMPF=(R4)         ARE WE IN SYSTEM QUEUE       @D61RDRP 05242001
     GENSERV   COMP,FIELD=ASYSPCB,REG=(R1),BC=BE,LAB=DELENTR5,         *05243001
               COMPF=(R4)                                      @D61RDRP 05244001
         L     R5,TIBPCB          NO, GET ADDR. OF PART.PCB    @D61RDRP 05245001
DELENTR5 DS    0H                                              @D61RDRP 05246001
         L     R1,DEVCBMSK        GET DEVICE MASK              @D61RDVB 05247001
         SLR   R3,R3              DEQUEUE REQUEST              @D61RDVB 05248001
*        DISPMAC FUNC=PFUPD,INP1=(R1),INP2=(R3),INP3=(R5)               05249001
         DISPMAC FUNC=PFUPD,INP1=(R1),INP2=(R3),INP3=(R5)               05250001
         LM    R1,R3,PMRSAVLO+OFR1                             @D61RDVB 05251001
         BR    RA                 ==========> RETURN           @D36IDRP 05252001
         SPACE 1                                                        05253001
         DROP  RB                 FORGET BASE FOR DEVCB        @D14BDRP 05254001
         DROP  RC                 DROP BASE FOR TIBADR         @D61RDRP 05255001
         DROP  R4                 FORGET BASE FOR CLASS-PCB    @D51IDRP 05256001
         EJECT                                                 @D14ADVB 05257001
*------------------------------------------------------------* @D149DVB 05258001
*        ROUTINE PROLOGUE                                      @D149DVB 05259001
*        ROUTINE NAME: GETDEVCB                                @D149DVB 05260001
*        MACRO:        SGPMR                                   @D149DVB 05261001
*        FUNCTION:  GET ADDR OF DEVCB CORRESPOND. TO PAGE ADDR @D149DVB 05262001
*                   OR PFTE ADDR PASSED                        @D149DVB 05263001
*        CALLED BY:                                            @D149DVB 05264001
*            ENQENTR, HANDLLST, RESPHO                         @D149DVB 05265001
*                              AT GETDEVCB WITH AMODE(31),DATON@D149DVB 05266001
*            ENQUO/ENQUOUNC, SCDELPGO, FIXEXCHG AT GETDEVCBF   @D529DRP 05267001
*                                         WITH AMODE(31),DATOFF@D529DRP 05268001
*        CALLED ROUTINES:                                      @D529DRP 05269001
*              GETPDS WITH AMODE(31),DATON                     @D529DRP 05270001
*        ENTRY POINT:                                          @D149DVB 05271001
*                   GETDVCBF                                   @D149DVB 05272001
*                   GETDEVCB                                   @D149DVB 05273001
*        EXIT: CALLER IN MODE OF CALLER                        @D149DVB 05274001
*        ERROR EXIT: -                                         @D149DVB 05275001
*        INPUT:                                                @D149DVB 05276001
*                   R8  :  ADDR PAGE MANAGEMENT DATA AREA      @D149DVB 05277001
*                   R4  :  RETURN ADDR                         @D149DVB 05278001
*                   R5  :  EPA              ... GETDEVCB       @D149DVB 05279001
*                   RC  :  ADDR OF PFTE     ... GETDVCBF       @D149DVB 05280001
*                   RC  :  ADDR OF TIB      ... GETDVCB        @D529DRP 05281001
*        OUTPUT:                                               @D149DVB 05282001
*                   RB  :  ADDR DEVCB CORRESP. TO PAGE ADDR    @D149DVB 05283001
*                                                              @D149DVB 05284001
*        INVARIANT REGISTERS:                                  @D52VDVB 05285001
*                   R0-R2,R4,R6-RA,RC-RF                       @D52VDVB 05286001
*        OPERATION:                                            @D149DVB 05287001
*                                                              @D149DVB 05288001
*        GETDVCBF :                                            @D149DVB 05289001
*        ADDR_PAGE (PFTE.PFTEPNR) /*  EXTENDED PAGE ADDRESS  */@D149DVB 05290001
*        IF PFTE.PFTEBLK = ON     /*   ONLY BLOCK CONNECTED  */@D149DVB 05291001
*           THEN DO                                            @D149DVB 05292001
*               BLKNR := BLKNR + VIOVPEPA                      @D149DVB 05293001
*                GOTO GETDEV02                                 @D149DVB 05294001
*           END                                                @D149DVB 05295001
*        GETDEVCB:                                             @D149DVB 05296001
*        IF ADDR(PAGE) > VIOVPEPA /* PAGE BELONGS TO VIOPOOL */@D149DVB 05297001
*           THEN DO                                            @D149DVB 05298001
*               ADDR_VTAB(ADDR(PAGE) /*  GET ADDR (VTAB)     */@D149DVB 05299001
*               BLKNR := VTAB.VTBLKN /*  GET BLOCK NR        */@D149DVB 05300001
*               BLKNR := BLKNR + VIOVPNF                       @D149DVB 05301001
*           END                                                @D149DVB 05302001
*           ELSE BLKNR := PAGENR(PAGE) /* GET PAGE NR        */@D149DVB 05303001
*        END_IF                                                @D149DVB 05304001
*        GETDEV02:                                           */@D149DVB 05305001
*        ADDR_DPD                      /*  FIRST DPD_TAB     */@D149DVB 05306001
*        UNTIL BLKNR < DPD.DPDGUL DO                           @D149DVB 05307001
*              DPD := NEXT  (DPD)      /*  NEXT DPD ENTRY    */@D149DVB 05308001
*           END                                                @D149DVB 05309001
*        ADDR_DEVCB := DPD.DPDDEVCB    /*  ADDR (DEVCB)      */@D149DVB 05310001
*        END (GETDEVCB);                                       @D149DVB 05311001
*------------------------------------------------------------* @D149DVB 05312001
         SPACE 1                                               @D14BDRP 05313001
         USING PFTE,RC                                         @D14BDRP 05314001
*SGLINK  GETDVCBF,S,INPUT=(R4,R8,R9,RC),OUTPUT=(RB),                   *05315001
               NOMODR=(RC-R2,R4,R6-RA),AMODE=ANY DATOFF                 05316001
GETDVCBF DS    0H                                              @D52VDRP 05317001
*        AMODESW SET,AMODE=31,SAVE=(R4),WR=(RB)                @D52VDRP 05318001
         AMODESW SET,AMODE=31,SAVE=(R4),WR=(RB)                @D52VDRP 05319001
         L     R5,PFTEPNR         GET                          @D14NDFG 05320001
         N     R5,PAGNMASK        * PAGE NUMBER                @D14NDFG 05321001
         MVC   PMRSCB,PFTESCB     SET SCB ADDR FOR GETPDS      @D52VDRP 05322001
         TM    S370FLG,PFTEBLK    ONLY BLOCK CONNECTED TO FRAME@D14BDRP 05323001
         BZ    GETDEV00           NO, BRANCH                   @D51GDRP 05324001
         DROP  RC                 DROP BASE FOR PFTE           @D14BDRP 05325001
         A     R5,VIORECN1        GET REC# ON PDS              @D51GDRP 05326001
         B     GETDEV01           JOIN MAIN PATH               @D51GDRP 05327001
GETDEV00 SLL   R5,PNSHIFT         CONVERT # TO EXT. PAGE ADDR  @D51GDRP 05328001
*        AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @D52VDRP 05329001
         AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @D52VDRP 05330001
         BAL   RB,GETPDS          GET RECORD NUMBER ON PDS     @D52VDRP 05331001
*SGLINK  GETPDS,INPUT=(R5,R8,R9,RB),OUTPUT=(R5),                       *05332001
               NOMODR=(R6-R2,R4)                                        05333001
*              INVARIANT=(R6-R2,R4)                            @D52VDVB 05334001
*        AMODESW SET,DAT=OFF      ENTER REAL MODE AGAIN        @D52VDRP 05335001
         AMODESW SET,DAT=OFF      ENTER REAL MODE AGAIN        @D52VDRP 05336001
         B     GETDEV01           JOIN MAIN PATH               @D52VDRP 05337001
         SPACE 1                                                        05338001
GETDEVCB DS    0H                                              @D52VDRP 05339001
*SGLINK  GETDEVCB,S,INPUT=(R4,R5,R8,R9,RC),OUTPUT=(RB),                *05340001
               NOMODR=(RC-R2,R4,R6-RA),AMODE=ANY DATON                  05341001
*        AMODESW SET,AMODE=31,SAVE=(R4),WR=(RB)                @D52VDRP 05342001
         AMODESW SET,AMODE=31,SAVE=(R4),WR=(RB)                @D52VDRP 05343001
         USING TIBADR,RC                                       @D52VDRP 05344001
         MVC   PMRSCB,TIBPFSCB    SET SCB ADDR FOR GETPDS      @D52VDRP 05345001
         DROP  RC                 DROP BASE FOR TIB            @D52VDRP 05346001
         BAL   RB,GETPDS          GET RECORD NUMBER ON PDS     @D51GDRP 05347001
*SGLINK  GETPDS,INPUT=(R5,R8,R9,RB),OUTPUT=(R5),                       *05348001
               NOMODR=(R6-R2,R4),AMODE=31 DATON                         05349001
GETDEV01 L     RB,IJBDPDTB        GET ADDR OF DPDTAB                    05350001
         USING DPDADR,RB          SET BASE FOR DPDTAB                   05351001
         LH    R3,DPDAEXT#        GET NO OF ENTRIES            @D35MDAA 05352001
         DROP  RB                 FORGET BASE FOR DPDADR       @D14BDRP 05353001
         LA    RB,DPDHDRL(,RB)    GET 1.ENTRY                  @D14BDVB 05354001
         USING DPDENTR,RB         SET BASE FOR DPDTAB ENTRY    @D35ZDAA 05355001
GETDEVLP C     R5,DPDPGUL         IS PAGE#<=UPPER LIMIT        @D14NDFG 05356001
         BNH   GETDEVND           ..YES, ENTRY IS FOUND        @D35MDAA 05357001
         LA    RB,DPDENTL(,RB)    GET NEXT ENTRY               @D14BDVB 05358001
         BCT   R3,GETDEVLP        CONTINUE SEARCHING           @D35MDAA 05359001
         BAL   R5,PMRHWERR        HARDWAIT IF ENTRY NOT FOUND  @D35MDAA 05360001
GETDEVND EQU   *                                               @D35MDAA 05361001
         L     RB,DPDDEVCB        GET ADDR OF DEVCB            @D14BDRP 05362001
*        AMODESW RETURN,REG=(R4)                               @D52VDRP 05363001
         AMODESW RETURN,REG=(R4)  ==========> RETURN           @D52VDRP 05364001
         DROP  RB                 FORGET BASE FOR DPD-ENTRY    @D14BDRP 05365001
*-------------------------------------------------------------*         05366001
         EJECT                                                          05367001
*------------------------------------------------------------*          05368001
*        ROUTINE PROLOGUE                                      @D519DRP 05369001
*        ROUTINE NAME: GETPDS                                  @D519DRP 05370001
*        MACRO:        SGPMR                                   @D519DRP 05371001
*        FUNCTION:  GET RECORD NUMBER ON PAGE DATA SET         @D519DRP 05372001
*        CALLED BY:                                            @D519DRP 05373001
*              GETDEVCB, SEEKEXT WITH AMODE(31),DATON          @D519DRP 05374001
*        CALLED ROUTINES:                                      @D529DRP 05375001
*              CHKVPOL1 WITH AMODE(31),DATON                   @D529DRP 05376001
*        ENTRY POINT:                                          @D519DRP 05377001
*                   GETPDS                                     @D519DRP 05378001
*        EXIT :  CALLER WITH MODE OF CALLER                    @D519DRP 05379001
*        ERROR EXIT: -                                         @D519DRP 05380001
*        INPUT:                                                @D519DRP 05381001
*                   R5  :  EXTENDED PAGE ADDR (EPA)            @D519DRP 05382001
*                   R8  :  ADDR PAGE MANAGEMENT DATA AREA      @D519DRP 05383001
*                   RB  :  RETURN ADDR                         @D519DRP 05384001
*        OUTPUT:                                               @D519DRP 05385001
*                   R5  :  RECORD NUMBER ON PAGE DATA SET      @D519DRP 05386001
*        WORK REGISTER:                                        @D519DRP 05387001
*                   R3                                         @D519DRP 05388001
*        INVARIANT REGISTERS:                                  @D519DRP 05389001
*                   R6 - R2, R4                                @D519DRP 05390001
*------------------------------------------------------------*          05391001
         SPACE 1                                                        05392001
*SGLINK  GETPDS,S,INPUT=(R5,R8,R9,RB),OUTPUT=(R5),NOMODR=(R6-R2,R4),   *05393001
               AMODE=31 DATON                                           05394001
GETPDS   N     R5,EPADRMSK        SET ON PAGE BOUNDARY         @D51GDRP 05395001
         LR    R3,R5              SAVE R5                      @D52VDRP 05396001
         ST    RA,PMRSAVX         SAVE REGISTER                @D52VDRP 05397001
         BAL   RA,CHKVPOL1        CHECK FOR VPOOL              @D52VDRP 05398001
*SGLINK  CHKVPOL1,INPUT=(R5,RA),OUTPUT=(R5),WORK=(R5)          @D52VDRP 05399001
         B     GETPDS00           BRANCH, PAGE NOT IN VPOOL    @D52VDRP 05400001
* ---->  B     GETPDS0A           PAGE IN VPOOL                @D52VDRP 05401001
GETPDS0A DS    0H                                              @D52VDRP 05402001
         USING VTABE,R5                                        @D51GDRP 05403001
         L     R5,VTBLKN          * GET RECORD NUMBER ON       @D51GDRP 05404001
         DROP  R5                                              @D51GDRP 05405001
         A     R5,VIORECN1        * PAGE DATA SET              @D51GDRP 05406001
         B     GETPDS01           ==========>  RETURN          @D52VDRP 05407001
         SPACE 1                                               @D51GDRP 05408001
GETPDS00 DS    0H                                              @D52VDRP 05409001
         LR    R5,R3              GET RECORD NUMBER            @D52VDRP 05410001
         N     R3,PMBLKDIS        ... WITHIN ALLOCATION UNIT   @D51GDRP 05411001
         SRL   R3,PNSHIFT         ... ON PDS (BLOCK)           @D51GDRP 05412001
         L     RA,PMRSCB          ADDR OF SCB FOR EPA          @D52VDRP 05413001
         USING SCBADR,RA                                       @D52VDRP 05414001
         N     R5,PMBLKMSK        GET  ADDR                    @D51GDRP 05415001
         SRL   R5,PNSHIFT+PNBLSHFT-PTASSHFT ... OF CORRESP     @D51GDRP 05416001
         A     R5,SCBAPTAS                  ... PTAS ENTRY     @D52VDRP 05417001
         L     RA,SCBAPMRA        GET SCB FOR PTAS             @D52VDRP 05418001
         LCTL  CR1,CR1,SCBRSTO    MAKE PTAS ACCESSIBLE         @D52VDRP 05419001
         USING PTASE,R5                                        @D51GDRP 05420001
         L     R5,PTASRECN        GET REC# OF BLOCK ON PDS     @D51GDRP 05421001
         DROP  R5                                              @D51GDRP 05422001
         L     RA,SCBPTR          SWITCH BACK TO               @D52VDRP 05423001
         LCTL  CR1,CR1,SCBRSTO    ....    ORIGINAL SPACE       @D52VDRP 05424001
         AR    R5,R3              GET REC# OF PAGE ON PDS      @D51GDRP 05425001
         DROP  RA                 DROP BASE FOR SCB            @D52VDRP 05426001
GETPDS01 L     RA,PMRSAVX         RESTORE REGISTER             @D52VDRP 05427001
         BR    RB                 ==========>  RETURN          @D51GDRP 05428001
*-------------------------------------------------------------*         05429001
         EJECT                                                          05430001
*-------------------------------------------------------------*@D149DVB 05431001
*        ROUTINE PROLOGUE                                      @D149DVB 05432001
*        ROUTINE NAMES: PAGEMUN, PAGDISCA,BLKDISCN,MAKEDADDR   @D149DVB 05433001
*        MACRO:        SGPMR                                   @D149DVB 05434001
*        FUNCTION:  PAGEMUN : SETS PAGESTATE FROM ADDRESSABLE  @D149DVB 05435001
*                             TO CONNECTED                     @D149DVB 05436001
*                   PAGDISCA: SETS PAGESTATE FROM ADDRESSABLE  @D149DVB 05437001
*                             TO DISCONNECTED, THE ASSOCIATED  @D149DVB 05438001
*                             PAGE FRAME IS CLEARED            @D149DVB 05439001
*                   BLKDISCN: SETS BLOCKSTATE TO DISCONNECTED  @D149DVB 05440001
*                   MAKEADDR: MAKES PAGE ADDRESSABLE           @D149DVB 05441001
*        ENTRY POINTS :                                        @D149DVB 05442001
*                   PAGEMUN                                    @D149DVB 05443001
*                   PAGDISCA                                   @D149DVB 05444001
*                   BLKDISCN                                   @D149DVB 05445001
*                   MAKEADDR                                   @D149DVB 05446001
*        CALLED BY:                                                     05447001
*              PAGEMUN: ENQUOW, ENQUOUNC WITH AMODE(31),DATOFF @D529DRP 05448001
*              PAGDISCA: SELECTPG,GETREAL WITH AMODE(31),DATOFF@D529DRP 05449001
*              BLKDISCN: PGOCPFTE, PAGDISCA  WITH AMODE(31),DATOFF      05450001
*              MAKEADDR: PMR MAIN, PGICOMPL WITH AMODE(31),DATON        05451001
*        CALLED ROUTINES:                                      @D529DRP 05452001
*              CHKVPOL1 WITH AMODE(31),DATOFF                  @D529DRP 05453001
*              PMRINSBT WITH AMODE(31),DATOFF                  @D529DRP 05454001
*        EXIT :     RETURN TO CALLER                           @D149DVB 05455001
*        ERROR EXIT: -                                         @D149DVB 05456001
*        INPUT:                                                @D149DVB 05457001
*              R2 - ADDRESS OF PTE       (MAKEADDR)            @D52VDRP 05458001
*              R9 - BASE ADDR OF THIS ROUTINES                 @D52VDRP 05459001
*              RA - RETURN ADDRESS                             @D149DVB 05460001
*              RC - ADDR OF PFTE   (NOT BLKDISCN)              @D149DVB 05461001
*              RD - EXTENDED BLOCK / PAGE ADDR (NOT MAKEADDR)  @D52VDRP 05462001
*              RE - PAGE-FRAME ADDR. BELONG. TO RC             @D149DVB 05463001
*        OUTPUT:                                               @D149DVB 05464001
*              CHANGED PAGESTATE                               @D149DVB 05465001
*-------------------------------------------------------------*@D149DVB 05466001
*     ATTRIBUTE: AMODE(31) DATOFF                              @D149DVB 05467001
*     PAGEMUN :                                                @D149DVB 05468001
*        PFTE.PCBIT := ON         /*  CONNECTED INDICATION   */@D149DVB 05469001
*        IF PFTE.PFTEBLK = ON  /* BLOCK CONNECTED            */@D149DVB 05470001
*           THEN RETURN        /* =====>   EXIT              */@D149DVB 05471001
*        IF ADDR(PAGE) > VIOVPBEG /* PAGE IN VPOOL           */@D149DVB 05472001
*           THEN ADDR_VTAB(ADDR(PAGE))                         @D149DVB 05473001
*        PTESTAT := PTECON                                     @D149DVB 05474001
*        CALL PAGDISC                                          @D619DRP 05475001
*        RETURN                                                @D619DRP 05476001
*-------------------------------------------------------------*@D149DVB 05477001
         SPACE 1                                               @D14BDRP 05478001
*SGLINK  PAGEMUN,S,INPUT=(R2,R9,RA,RC,RD,RE),AMODE=31 DATOFF   @INSERT  05479001
PAGEMUN  DS    0H                                              @D14BDRP 05480001
         USING PFTE,RC                                         @D14BDRP 05481001
         STM   R0,RF,PMRSVDBG     SAVE ALL REGISTER            @KD40295 05482001
         LM    R0,R7,PFTEPNR      GET PFTE IN REGISTER 0-7     @KD40295 05483001
         L     RF,PMRDMUN         INDICATE MUN EVENT           @KD40295 05484001
         DEBUG ALLREGS,XXDBGMC    * CREATE DEBUG ENTRY         @KD40295 05485001
         LM    R0,RF,PMRSVDBG     RESTORE REGISTERS            @KD40295 05486001
         OI    PFTEFLG,PCBIT      INDICATE PAGE CONNECTED      @D14BDRP 05487001
.*DELE   NI    PFTEFLG3,XFF-CURSELCT CURRENT SELECTION OFF     @KXA1851 05488001
         TM    S370FLG,PFTEBLK    ONLY BLOCK CONNECTED         @D14BDRP 05489001
         BOR   RA                 ==========>  YES             @D14BDRP 05490001
         MVC   PMRSCB,PFTESCB     SET SCB ADDR FOR CHKVPOL1    @D52VDRP 05491001
         LR    R5,RD                                           @D14NDFG 05492001
         ST    RA,PMRSLEV3+OFR10  SAVE REGISTER                @D52VDRP 05493001
         BAL   RA,CHKVPOL1        CHECK FOR VPOOL              @D52VDRP 05494001
*SGLINK  CHKVPOL1,INPUT=(R5,R8,RA),OUTPUT=(R5),WORK=(R5)       @D52VDRP 05495001
         B     PAGEMUN1           BRANCH, PAGE NOT IN VPOOL    @D52VDRP 05496001
* ---->  B     PAGEMUNA           PAGE IN VPOOL                @D52VDRP 05497001
PAGEMUNA DS    0H                                              @D52VDRP 05498001
         USING VTABE,R5                                        @D14BDRP 05499001
         LR    R4,RE              COPY REGISTER                @D51GDTP 05500001
         SRL   R4,PNSHIFT         GET FRAME NUMBER             @D51GDTP 05501001
         CLM   R4,M7,VTFRAM       IS VTFRAM SET CORRECT        @D51GDTP 05502001
         BE    PAGEMUN1           YES, BRANCH                  @D14BDRP 05503001
         BAL   R5,PMRHWERR        NO, ERROR ENTER HARD WAIT    @D14BDRP 05504001
         DROP  R5                                              @D14BDRP 05505001
PAGEMUN1 DS    0H                                              @D14BDRP 05506001
         L     RA,PMRSLEV3+OFR10  RESTORE REGISTER             @D52VDRP 05507001
         L     R5,PTECON          INDICATE CONN. STATE FOR PTE @D14BDRP 05508001
         BAL   RF,PAGDISC         ----------> SET TO CONNECTED @KXA1851 05509001
*SGLINK  PAGDISC,INPUT=(R5,R8,R9,RE,RF),WORK=(R5),OUTPUT=(R4)          *05510001
               AMODE=31 DATOFF                                          05511001
         BR    RA                 ==========>  RETURN          @KXA1851 05512001
         DROP  RC                                              @D14ADVB 05513001
         SPACE 2                  DROP BASE FOR PFTE (REAL)    @D14BDRP 05514001
*-------------------------------------------------------------*@D14BDRP 05515001
*     ATTRIBUTE: AMODE(31) DATOFF                              @D149DVB 05516001
*     PAGDISCA :                                               @D149DVB 05517001
*        PFE.PNRINV := ON    /*  PFTE DISCONNECTED           */@D149DVB 05518001
*        PAGE_FRAME := 0     /*   CLEAR PAGE FRAME           */@D149DVB 05519001
*        PTE.PTESTAT := PTEIBIT /* PTE SET TO INVALID        */@D149DVB 05520001
*        IF PFTE.PFTEBLK=ON  /*  ONLY BLOCK CONNECTED        */@D149DVB 05521001
*            THEN GOTO BLKDISCN                                @D149DVB 05522001
*        PAGDISC:                                              @D149DVB 05523001
*        PTE.PTEKEY =: KEY (PAGE FRAME)                        @D149DVB 05524001
*                                 /* GET KEY OUT OF PAGEFRAME*/@D149DVB 05525001
*                                 /*   PDSBIT UNCHANGED      */@D149DVB 05526001
*        IPTE                                                  @D149DVB 05527001
*        RETURN                   /*   =====>    EXIT        */@D149DVB 05528001
*-------------------------------------------------------------*@D14BDRP 05529001
         SPACE 1                                               @D14BDRP 05530001
*SGLINK  PAGDISCA,S,INPUT=(R8,R9,RA,RC,RD,RE),WORK=(R4,R5,RF),         *05531001
               AMODE=31 DATOFF                                          05532001
PAGDISCA DS    0H                                              @D14BDRP 05533001
         USING PFTE,RC                                         @D14BDRP 05534001
         STM   R0,RF,PMRSVDBG     SAVE ALL REGISTER            @KD40295 05535001
         LM    R0,R7,PFTEPNR      GET PFTE IN REGISTER 0-7     @KD40295 05536001
         L     RF,PMRDDISC        INDICATE DISCONNECT EVENT    @KD40295 05537001
         DEBUG ALLREGS,XXDBGMC    * CREATE DEBUG ENTRY         @KD40295 05538001
         LM    R0,RF,PMRSVDBG     RESTORE REGISTERS            @KD40295 05539001
         LA    R5,PTEIBIT         INDICATE DISC. STATE FOR PTE @KXA1851 05540001
         BAL   RF,PAGDISC         NO, ----> DISCONNECT PAGE    @KXA1851 05541001
*SGLINK  PAGDISC,INPUT=(R5,R8,R9,RE,RF),WORK=(R5),OUTPUT=(R4)          *05542001
               AMODE=31 DATOFF                                          05543001
         OI    S370FLG,PNRINV     INDICATE PAGE DISCONNECTED   @D14BDRP 05544001
.*DELE   NI    PFTEFLG3,XFF-CURSELCT CURRENT SELECTION OFF     @KXA1851 05545001
         TM    SUPFLAG,VMSYS      RUNNING UNDER VM ?           @DA33314 05546001
         BZ    PAGDISC0           NO, CONTINUE NORMAL          @D52VDRP 05547001
*                                 YES, ISSUE RELEASE PAGE TO VM@D52VDRP 05548001
*   GET STORAGE KEY FIRST FOR PERFORMANCE REASONS              @DA41877 05549001
         DC    X'83EE0010'        ISSUE 'RELEASE PAGE' TO VM   @DA33314 05550001
         B     PAGDISC1                                        @DA41877 05551001
PAGDISC0 DS    0H                                              @D52VDRP 05552001
         L     R5,PAGESIZE        GET LENGTH OF TARGET ONE PAGE@D35CDAA 05553001
         LR    R4,RE              GET TARGET ADDRESS FOR MVCL  @D35CDAA 05554001
         SR    RF,RF              SET PADDING CHARACTER AND    @D35CDAA 05555001
         MVCL  R4,RE              CLEAR PAGE FRAME             @D52VDVB 05556001
.*    NOTE: RE IS NOT TOUCHED BY HARDWARE                      @D529DVB 05557001
PAGDISC1 DS    0H                                              @KXA1851 05558001
         TM    S370FLG,PFTEBLK    ONLY BLOCK CONNECTED         @D14BDRP 05559001
         BZ    PAGDISC2           NO, BRANCH                   @KXA1851 05560001
*                                 YES, DISCONNECT BLOCK        @D14BDRP 05561001
         NI    S370FLG,NFRP+PFTERES+PNRINV RESET ALL OTHER     @KY30163 05562001
         B     BLKDISC1           ------> DISCONNECT BLOCK     @DA41877 05563001
         SPACE 1                                               @D14BDRP 05564001
PAGDISC2 NI    S370FLG,NFRP+PFTERES+PNRINV RESET ALL OTHER     @KY30163 05565001
         BR    RA                 ==========>  RETURN          @D14BDRP 05566001
         DROP  RC                 DROP BASE FOR PFTE (REAL)    @D52VDRP 05567001
         SPACE 2                                                        05568001
*-------------------------------------------------------------*@KXA1851 05569001
*     PAGDISC:                                                 @KXA1851 05570001
*        DISCONNECTS PAGE CORRESPONDING TO PROVIDED PFTE       @KXA1851 05571001
*     ATTRIBUTE: AMODE(31) DATOFF                              @KXA1851 05572001
*     INPUT:                                                   @KXA1851 05573001
*            R5 - PAGE STATE (DISC. OR CONN.)                  @KXA1851 05574001
*            RC - ADDR OF PFTE                                 @KXA1851 05575001
*            RE - ADDR OF PAGE FRAME                           @KXA1851 05576001
*            RF - RETURN ADDRESS                               @KXA1851 05577001
*     OUTPUT:                                                  @KXA1851 05578001
*            R4 - PAGES STATE                                  @KXA1851 05579001
*-------------------------------------------------------------*@KXA1851 05580001
*SGLINK  PAGDISC,S,INPUT=(R5,R8,R9,RE,RF),WORK=(R5),OUTPUT=(R4)        *05581001
               AMODE=31 DATOFF                                          05582001
PAGDISC  DS    0H                                              @KXA1851 05583001
         USING PFTE,RC            SET BASE FOR PFTE            @KXA1851 05584001
         ISKE  R4,RE              GET STORAGE KEY              @KXA1851 05585001
         TM    S370FLG,PFTEBLK    ONLY BLOCK CONNECTED         @KXA1851 05586001
         BOR   RF                 YES, =====>DON'T DISC  PAGE  @KXA1851 05587001
         N     R4,ISKFMASK         STOR. KEY WITH FETCH-BIT    @KXA1851 05588001
         SLL   R4,8                                            @KXA1851 05589001
         OR    R4,R5              SET PAGESTATE IN R4          @KXA1851 05590001
*        GENSERV RPTE,PFTE=(RC),RPTE=(R5),WORKR=(R3,R4,RF)     @KXA1851 05591001
         GENSERV RPTE,PFTE=(RC),RPTE=(R5),WORKR=(R3,R4,RF)     @KXA1851 05592001
*                                 GET REAL PTE ADDR IN R5      @KXA1851 05593001
         USING PTE,R5             SET BASE FOR PTE/BLKTBE      @KXA1851 05594001
         STCM  R4,7,PTE           SAVE KEY IN PTE (LEAVE PDSBIT@KXA1851 05595001
.*DELE   SLR   R4,R4                                           @KXA1851 05596001
.*DELE   ST    R4,PSQCPTR         SAVE ADDR OF CURRENT PFTE    @KXA1851 05597001
         BR    RF                 ==========>  RETURN          @KXA1851 05598001
         DROP  RC                 DROP BASE FOR PFTE (REAL)    @KXA1851 05599001
         DROP  R5                 DROP BASE FOR PTE/BLKTBE     @KXA1851 05600001
         SPACE 2                                               @KXA1851 05601001
*-------------------------------------------------------------*@KXA1851 05602001
*     PAGIPTE:                                                 @KXA1851 05603001
*        IPTE-S  PAGE CORRESPONDING TO PROVIDED PFTE           @KXA1851 05604001
*     ATTRIBUTE: AMODE(31) DATOFF                              @KXA1851 05605001
*     INPUT:                                                   @KXA1851 05606001
*            RC - ADDR OF PFTE                                 @KXA1851 05607001
*            RA - RETURN ADDR                                  @KXA1851 05608001
*-------------------------------------------------------------*@KXA1851 05609001
*SGLINK  PAGIPTE,S,INPUT=(R8,R9,RA,RC),WORK=(R4,R5,RD,RF),             *05610001
               AMODE=31 DATOFF                                          05611001
PAGIPTE  DS    0H                                              @KXA1851 05612001
         USING PFTE,RC            SET BASE FOR PFTE            @KXA1851 05613001
         TM    PFTEFLG3,CURSELCT  CURRENT SELECTION            @KXA1851 05614001
         BZ    PAGIPT10           NO.  ---------> 0K           @KXA1851 05615001
         BAL   R5,PMRHWERR        YES, =========> HW FF1       @KXA1851 05616001
PAGIPT10 DS    0H                                              @KXA1851 05617001
         ST    RC,PSQCPTR         SAVE ADDR OF CURRENT PFTE    @KXA1851 05618001
         TM    S370FLG,PFTEBLK    ONLY BLOCK CONNECTED         @KXA1851 05619001
         BOR   RA                 YES, =====>DON'T IPTE  PAGE  @KXA1851 05620001
         GENSERV RPTE,PFTE=(RC),RPTE=(R5),WORKR=(R3,R4,RF)     @KXA1851 05621001
         ST    R5,PSQCAPTE                                     @KXA8151 05622001
         L     RF,PFTESCB         GET REAL ADDR OF ...         @KXA1851 05623001
*        GENSERV LRADBG,RREG=(RF),VADD=(RF),ERR=NADDR ... SCB  @KXA1851 05624001
         GENSERV LRADBG,RREG=(RF),VADD=(RF),ERR=NADDR ... SCB  @KXA1851 05625001
         USING PTE,R5                                          @KXA1851 05626001
         TM    PTESTAT,PTEPGCO+PTEIBIT VPOOL PAGE CONNECTED    @KXA1851 05627001
         BNO   PAGIPT50           NO,  --------->              @KXA1851 05628001
         OI    PFTEFLG3,CURSELCT  HANDLE AS SELECTED FRAME     @KXA1851 05629001
         BR    RA                 ==========>  RETURN          @KXA1851 05630001
         DROP  R5                 DROP BASE FOR PTE  (REAL)    @KXA1851 05631001
PAGIPT50 DS    0H                                              @KXA1851 05632001
         L     RD,PFTEPNR                                      @KXA1851 05633001
         SLL   RD,PNSHIFT                                      @KXA1851 05634001
*        GENSERV IPTE,EPA=(RD),SCB=(RF),WORKR=(R3,R4) DO IPTE  @KXA1851 05635001
         GENSERV IPTE,EPA=(RD),SCB=(RF),WORKR=(R3,R4)          @KXA1851 05636001
         BR    RA                 ==========>  RETURN          @KXA1851 05637001
         DROP  RC                 DROP BASE FOR PFTE (REAL)    @KXA1851 05638001
         SPACE 2                                                        05639001
*-------------------------------------------------------------*@KXA1851 05640001
*     PAGADDR:                                                 @KXA1851 05641001
*        UNDO IPTE OF PAGE CORRESPONDING TO PROVIDED PFTE      @KXA1851 05642001
*     ATTRIBUTE: AMODE(31) DATOFF                              @KXA1851 05643001
*     INPUT:                                                   @KXA1851 05644001
*            RA - RETURN ADDRESS                               @KXA1851 05645001
*-------------------------------------------------------------*@KXA1851 05646001
*SGLINK  PAGADDR,S,INPUT=(R8,R9,RA),WORK=(R4,R5)                       *05647001
               AMODE=31 DATOFF                                          05648001
PAGADDR  DS    0H                                              @KXA1851 05649001
         L     R4,PSQCPTR         GET SAVED OF CURRENT PFTE    @KXA1851 05650001
         LTR   R4,R4                                           @KXA1851 05651001
         BNZ   PAGADD10           OK, --------->               @KXA1851 05652001
         BAL   R5,PMRHWERR                                     @KXA1851 05653001
PAGADD10 DS    0H                                              @KXA1851 05654001
         USING PFTE,R4            SET BASE FOR PFTE            @KXA1851 05655001
         TM    S370FLG,PFTEBLK    ONLY BLOCK CONNECTED         @KXA1851 05656001
         BO    PAGADD50           YES, ----->DON'T ADDR  PAGE  @KXA1851 05657001
         TM    PFTEFLG3,CURSELCT  CURRENT SELECTION            @KXA1851 05658001
         BO    PAGADD50           YES, ----->DON'T MAKEADDR PAG@KXA1851 05659001
         L     R5,PSQCAPTE        GET REAL PTE ADDR IN REG 5   @KXA8151 05660001
*                                                              @KXA1851 05661001
         USING PTE,R5                                          @KXA1851 05662001
         NI    PTESTAT,XFF-PTEIBIT                             @KXA1851 05663001
PAGADD50 NI    PFTEFLG3,XFF-CURSELCT CURRENT SELECTION OFF     @KXA1851 05664001
         SLR   R4,R4                                           @KXA1851 05665001
         ST    R4,PSQCPTR         INITIALIZE PTR               @KXA1851 05666001
         BR    RA                 ==========>  RETURN          @KXA1851 05667001
         DROP  R4                 DROP BASE FOR PFTE (REAL)    @KXA1851 05668001
         DROP  R5                 DROP BASE FOR PTE  (REAL)    @KXA1851 05669001
         SPACE 2                                                        05670001
*-------------------------------------------------------------*@D14BDRP 05671001
*     ATTRIBUTE: AMODE(31) DATOFF                              @D149DVB 05672001
*     BLKDISCN:                                                @D149DVB 05673001
*        BLKTBE.KEY := KEY (PAGE FRAME)                        @D149DVB 05674001
*        BLKTBE.BLKSTAT := BLKDISC/*  INVALID BLKTE .. BUT   */@D149DVB 05675001
*                                 /* PDSBIT REMAINS UNCHANGED*/@D149DVB 05676001
*        IF PFTEFLG.PIOERR = ON   /*   I/O ERROR OCCURRED    */@D149DVB 05677001
*           THEN BLKTBE.BLKSTAT := BLKERR                      @D149DVB 05678001
*                                 /*  BLOCK IN ERROR         */@D149DVB 05679001
*        RETURN                   /* =====>   EXIT           */@D149DVB 05680001
*-------------------------------------------------------------*@D14BDRP 05681001
         SPACE 1                                               @D14BDRP 05682001
*SGLINK  BLKDISCN,S,INPUT=(R8,R9,RA,RD,RE),WORK=(R4,R5),               *05683001
               AMODE=31 DATOFF                                          05684001
BLKDISCN DS    0H                 ----- ENTRY POINT  ----      @D14BDRP 05685001
         ISKE  R4,RE              GET STORAGE KEY              @D51GDTP 05686001
BLKDISC1 N     R4,ISKFMASK         WITH FETCH-BIT              @DA41877 05687001
         SLL   R4,8                                            @D14ADVB 05688001
         LA    R4,BLKDISC(R4)     SET BLKSTATE IN R4           @D14BDRP 05689001
         LR    R5,RD                                           @D14BDRP 05690001
         SRL   R5,PTSHIFT         CALCULATE ADDR               @DA33314 05691001
         A     R5,VIOBLKTB          * OF BLKTBE                @D14BDRP 05692001
         USING BLKTBE,R5                                       @D14BDRP 05693001
         STCM  R4,3,BLKKEY        SET STORAGE KEY (LEAVE PDSBIT@D51GDTP 05694001
         LR    R4,RE              GET ADDR ...                 @D52VDRP 05695001
         SRL   R4,PFSHIFT         ... OF  PFTE                 @D52VDRP 05696001
         A     R4,APFT            ... BEL. TO FRAME            @D52VDRP 05697001
         USING PFTE,R4                                         @D52VDRP 05698001
         TM    PFTEFLG,PIOERR     I/O  ERROR ON THIS FRAME     @D52VDRP 05699001
         BNOR  RA                 NO ==========>               @D14BDRP 05700001
         MVI   BLKSTAT,BLKERR     INDICATE BLOCK IN ERROR      @D14BDRP 05701001
         DROP  R5                 DROP BASE FOR BLKTBE         @D14BDRP 05702001
         BR    RA                 ===========>                 @D14BDRP 05703001
         EJECT                                                 @D52VDVB 05704001
*-------------------------------------------------------------*@D52BDRP 05705001
*     ROUTINE NAME: MAKEADDR                                   @D529DVB 05706001
*     MACRO:        SGPMR                                      @D529DVB 05707001
*     FUNCTION: PROVIDES ADDRESSABILITY OF A PAGE              @D529DVB 05708001
*     ATTRIBUTES: AMODE(31) DATON                              @D52BDRP 05709001
*     INPUT:                                                   @D529DVB 05710001
*                 R2   -  ADDRESS OF PTE IDENTIFYING PAGE      @D52VDVB 05711001
*                                 WHICH CAUSED PAGE FAULT      @D52VDVB 05712001
*                 RA   -  RETURN ADDRESS                       @D529DVB 05713001
*                 RC   -  ADDR(PFTE) BELONGING TO PAGE         @D529DVB 05714001
*                 RE   -  ADDRESS OF FRAME                     @D529DVB 05715001
*                                                              @D529DVB 05716001
*     OUTPUT:                                                  @D529DVB 05717001
*                 -                                            @D529DVB 05718001
*-------------------------------------------------------------*@D14BDRP 05719001
*     OPERATION:                                               @D529DVB 05720001
*                                                            */@D529DVB 05721001
*     IF PTE.PTESTAT=PTEERR | PFTE.PFTEFLG=PIOERR            */@D529DVB 05722001
*       THEN DO                                              */@D529DVB 05723001
*        CLEARPF(PFTE)            /* CLEAR PAGE FRAME        */@D529DVB 05724001
*        PFTE.PFTEFLG:=OFF-PCBIT-PIOERR                        @D529DVB 05725001
*        PFTE.PFTESCB:=NIL                                     @D529DVB 05726001
*        PTE.PTESTAT:=PTE.PTESTAT-PTEPGCON /*NO LONGER CONNECTED*/      05727001
*       END                                                  */@D529DVB 05728001
*       ELSE DO                                              */@D529DVB 05729001
*        FRAME.KEY:=PTE.PTEKEY    /*  KEY                    */@D529DVB 05730001
*        FRAME.FRAMBITS =(1,0)    /*  REFERENCE BIT = ON     */@D529DVB 05731001
*        PFTE.S370FLG:=OFF-NFRP-PFTERES  /*  PFTE            */@D529DVB 05732001
*        PFTE.PFTEFLG:=OFF-PCBIT                               @D529DVB 05733001
*        CALL PMRINSBT            /* PSQ = PSQ || <PFTE>     */@D529DVB 05734001
*        PTE.PTEFRA:=P_FR/2K                                   @D529DVB 05735001
*        PTE.PTESTAT:= VALID                                   @D529DVB 05736001
*       END                                                    @D529DVB 05737001
*     END (MAKEADDR)                                           @D529DVB 05738001
*-------------------------------------------------------------*@D14BDRP 05739001
*     ROUTINE REMOVED FROM PMR MAIN ROUTINE (LABEL PAGERDIO)   @D529DVB 05740001
*-------------------------------------------------------------*@D14BDRP 05741001
         SPACE 1                                               @D52VDVB 05742001
MAKEADDR DS    0H                 ENTRY POINT MAKEADDR ROUTINE @D52VDVB 05743001
*SGLINK  MAKEADDR,S,INPUT=(R2,R8,R9,RA,RC,RE),NOMODR=(R6-R3),          *05744001
               AMODE=31 DATON                                           05745001
         USING PTE,R2                                          @D52VDVB 05746001
         STM   R7,R3,PMRSLEV3+OFR7                             @D52VDRP 05747001
         USING PTE,R2                                          @D52GDRP 05748001
         TM    PTESTAT,PTEERR     IS PAGE ERRONEOUS            @D52GDRP 05749001
*        AMODESW SET,DAT=OFF      ENTER REAL MODE              @D52GDRP 05750001
         AMODESW SET,DAT=OFF      ENTER REAL MODE              @D52GDRP 05751001
         BO    MAD0X1             YES, ----------->            @D52GDRP 05752001
         DROP  R2                 DROP PTE (VIRTUAL)           @D52VDRP 05753001
         USING PFTE,RC                                         @D52VDRP 05754001
         TM    PFTEFLG,PIOERR     ANY I/O ERROR                @0000036 05755001
         BZ    MAD0X2             NO,  ---------->             @0000036 05756001
         SPACE 1                                                        05757001
*     FREE FRAME IN CASE OF I/O ERROR                          @0000036 05758001
         SPACE 1                                                        05759001
MAD0X1   BAL   R7,CLEARPF                                      @0000036 05760001
*SGLINK  CLEARPF,INPUT=(R7,R8,RC,RE),NOMODR=(R0-R3,R6-R9,RC-RF),       *05761001
               AMODE=31 DATOFF                                          05762001
         NI    PFTEFLG,XFF-PCBIT-PIOERR RESET CONNECTED FLAG AND       *05763001
                                  ... I/O ERROR INDICATION     @0000036 05764001
         SLR   RA,RA              CLEAR                        @0000036 05765001
         ST    RA,PFTESCB         ... ADDR SCB PFTE BELONGS TO @0000036 05766001
         DROP  RC                 DROP PFTE  (REAL)            @0000036 05767001
*        AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @0000036 05768001
         AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @0000036 05769001
         USING PTE,R2                                          @0000036 05770001
         NI    PTESTAT,XFF-PTEPGCO PAGE INVALID                @0000036 05771001
*                                 (NO LONGER CONNECTED)        @0000036 05772001
         B     MAD0EX             ------------> EXIT           @0000036 05773001
MAD0X2   DS    0H                                              @D52VDRP 05774001
*        AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @D52VDRP 05775001
         AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @D52VDRP 05776001
         IC    R5,PTEKEY          INSERT STORAGE KEY FROM      @D14ADVB 05777001
         N     R5,ISKFMASK        PTE INTO PF, RESET R/C-BIT   @D35CDAA 05778001
         L     R4,PFPGQE          GET ADDR OF SAVED REQ.ELEM.  @D14NDFG 05779001
         USING TIBADR,R4                                       @D14NDFG 05780001
         TM    TIBFLAG1,PHOIND    IS IT PHO/VIO PSEUDO-TIB     @D14NDFG 05781001
         BZ    MAD020             SKIP IF NOT                  @D14NDFG 05782001
         DROP  R4                 DROP TIBADR                  @D14NDFG 05783001
         LA    R5,RBIT(,R5)       SET REFERENCE BIT ON         @D14NDFG 05784001
MAD020   DS    0H                 SET STORAGE KEY              @D51GDTP 05785001
         SSKE  R5,RE              SET STORAGE KEY EXTENDED     @D51GDTP 05786001
         STCM  RE,14,PTEFRA       INSERT PF-ADD IN PTE                 *05787001
                                   WITHOUT DISTURBING PDSBIT   @D51GDTP 05788001
*        AMODESW SET,DAT=OFF      ENTER REAL MODE              @D52VDRP 05789001
         AMODESW SET,DAT=OFF      ENTER REAL MODE              @D52VDRP 05790001
         DROP  R2                 DROP PTE  (VIRTUAL)          @D35CDAA 05791001
         USING PFTE,RC            BASE FOR PFTE                @D52VDRP 05792001
         NI    S370FLG,NFRP+PFTERES  RESET ALL EXCEPT THE TWO  @KY30163 05793001
         NI    PFTEFLG,XFF-PCBIT  SET CONNECTED IND. OFF       @D14BDRP 05794001
         NI    PFTEFLG3,XFF-POSLISON-CURSELCT INITIALIZE       @D64ADOW 05795001
         L     RB,PSQPTR          LOAD RB WITH ADDR OF PSQ-HEADER       05796001
         BAL   RA,PMRINSBT        INSERT PFTE ON BOTTOM OF PSQ          05797001
         STM   R0,RF,PMRSVDBG     SAVE ALL REGISTER            @KD40295 05798001
         LM    R0,R7,PFTEPNR      GET PFTE IN REGISTER 0-7     @KD40295 05799001
         L     RF,PMRDADDR        INDICATE ADDRESSABLE EVENT   @KD40295 05800001
         L     RA,PMRSLEV3+OFR10  *                            @KD40295 05801001
         DEBUG ALLREGS,XXDBGMC    * CREATE DEBUG ENTRY         @KD40295 05802001
         LM    R0,RF,PMRSVDBG     RESTORE REGISTERS            @KD40295 05803001
         DROP  RC                 DROP BASE FOR PFTE (REAL)    @D52VDRP 05804001
*        AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @D52VDRP 05805001
         AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @D52VDRP 05806001
MAD0EX   LM    R7,R3,PMRSLEV3+OFR7                             @D52VDRP 05807001
         BR    RA                 ==========>   EXIT MAKEADDR  @D52VDVB 05808001
         SPACE 2                                               @D14ADVB 05809001
         DROP  R9                                              @D52VDVB 05810001
         TITLE 'VSE/AF SUPERVISOR     SGPMR     PAGE MANAGER (SCDELPGO *05811001
               / PFTEPOSL / PGOQPFTE ROUTINES) '               @D52VDVB 05812001
*-------------------------------------------------------------*@D529DVB 05813001
*        ROUTINE PROLOGUE                                      @D529DVB 05814001
*        ROUTINE NAME: SCDELPGO                                @D529DVB 05815001
*        MACRO:        SGPMR                                   @D529DVB 05816001
*        MODULE:       PMR SERVICES                            @D529DVB 05817001
*        FUNCTION: RESETS PSLSTATE OF PFTE                     @D529DVB 05818001
*        CALLED BY: DRAPDEQ,FREEPDS,INVPAGE, RELPAG,SELECTPG   @D529DRP 05819001
*                         WITH AMODE(31),DATOFF                @D529DRP 05820001
*        CALLED ROUTINES:                                      @D529DVB 05821001
*              DELENTR, RPOST WITH AMODE(31),DATON             @D529DRP 05822001
*              GETDEVCB       WITH AMODE(31),DATOFF            @D529DRP 05823001
*        INPUT:                                                @D529DVB 05824001
*                 R8   -  ADDRESS OF PMR DATA AREA             @D529DVB 05825001
*                 RA   -  RETURN ADDRESS                       @D529DVB 05826001
*                 RC   -  ADDR(PFTE) WHICH PAGE_OUT BELONGS TO @D529DVB 05827001
*                         ( PTE IS ADDRESSABLE)                @D529DVB 05828001
*                                                              @D529DVB 05829001
*        OUTPUT:                                               @D529DVB 05830001
*                 IF NO MORE PAGE OUT ENTRY DELETED FROM PGQUO @D52VDVB 05831001
*                                                              @D529DVB 05832001
*        EXIT NORMAL: RETURN TO CALLER                         @D529DVB 05833001
*        EXIT ERROR: NONE                                      @D529DVB 05834001
*        RETURN CODE: NONE                                     @D529DVB 05835001
*                                                              @D529DVB 05836001
*------------------------------------------------------------* @D529DVB 05837001
*    OPERATION:                                                @D529DVB 05838001
*        IF PF.PFTEFLG3=PSOLISON  /* PAGE MARKED FOR PAGE-OUT*/@D529DVB 05839001
*         THEN DO;                                             @D529DVB 05840001
*          CALL PFTEPOSL(RESET,PF); /*  RESET RELATED POSL   */@D529DVB 05841001
*          Q  = POSL.PSLSTATE(PF.PFTEEPA#,PF.PFTESCB);         @D529DVB 05842001
*          IF (* ALLOCATION UNIT NOT EMPTY *)                  @D529DVB 05843001
*            THEN DO;                                          @D529DVB 05844001
*              CALL GETDVCBF(PF);  /*  GET  RELATED  DEVCB   */@D529DVB 05845001
*              IF (* DVCB.PGQ &NE. <> &  T /= DVCB.DEVACT *) @D529DVB   05846001
*                THEN DO;                                      @D529DVB 05847001
*                  IF (* THERE IS T &MEMBEROF. DVCB.PGQO       @D529DVB 05848001
*                   WITH T.TIBAALU = ADDRESS(Q)                @D529DVB 05849001
*                      & T.TIBPFSCB= PF.PFTESCB *)             @D529DVB 05850001
*                                  /* DELETE ENTRY FROM PGQO */@D529DVB 05851001
*                    THEN CALL DELENTR(T,DVCB);                @D529DVB 05852001
*                END;                                          @D529DVB 05853001
*            END;                                              @D529DVB 05854001
*            ELSE;                                             @D529DVB 05855001
*         END;                                                 @D529DVB 05856001
*        RETURN;                                               @D529DVB 05857001
*      END SCDELPGO;                                           @D529DVB 05858001
*------------------------------------------------------------* @D529DVB 05859001
*        INVARIANT REGISTERS: R0-RF                            @D529DVB 05860001
*------------------------------------------------------------* @D529DVB 05861001
*        INTERNAL USAGE OF REGISTERS                           @D529DVB 05862001
*              R) - WORKREGISTER                               @D529DVB 05863001
*              R2 - WORK REGISTER                              @D529DVB 05864001
*              R3 - ADDR OF PREVIOUS TIB IN CHAIN              @D529DVB 05865001
*              R4 - WORKREGISTER                               @D529DVB 05866001
*              R5 - WORKREGISTER                               @D529DVB 05867001
*              R6 - CURRENT POSLSTATE                          @D529DVB 05868001
*              R7 - ADDR OF POSLSTATE                          @D529DVB 05869001
*              RA - WORKREGISTER                               @D519DRP 05870001
*              RC - ADDR OF TIB BELONGING TO REQ. FOUND        @D529DVB 05871001
*                                                              @D529DVB 05872001
*-------------------------------------------------------------*@D529DVB 05873001
         SPACE  1                                              @D52VDVB 05874001
*SGLINK  SCDELPGO,S,INPUT=(R8,RA,RC),NOMODR=(R0-RF),AMODE=31 DATOFF     05875001
SCDELPGO DS    0H                                              @D52VDVB 05876001
         USING PFTE,RC            ADDRESS PFTE                 @D52VDVB 05877001
         TM    PFTEFLG3,POSLISON  POSL.PSLSTATE SET FOR PAGE   @KX41010 05878001
         BNOR  RA                 NO,  ==========> EXIT        @KX41010 05879001
         STM   R7,R6,PMRSLEV0+OFR7 SAVE CALLERS REGISTERS      @D52VDVB 05880001
         L     R9,APMRSERV        PROVIDE ....                 @D52VDVB 05881001
         USING PMRSERV,R9         .... ADDRESSABILITY          @D52VDVB 05882001
         SGCOV SGPMR,MC=10                                     @D52VDVB 05883001
         LA    R0,8(,0)           RESET ...                    @D52VDVB 05884001
         L     RA,APFTPOSL        ...POSLSTATE                 @D52VDVB 05885001
*SGLINK  PFTEPOSL,INPUT=(R0,R8,RA,RC),OUTPUT=(R0,R4,R5,R6,R7),         *05886001
               NOMODR=(R1,R2,R8-RF),AMODE=31 ANY,DATOFF                 05887001
         BALR  RA,RA              SET POSLSTATE OFF            @D52VDVB 05888001
.*    OUTPUT:   R0  =  VALUE OF POSL BEFORE CHANGE             @D52VDVB 05889001
.*              R4  =  OFFSET IN POSLSTATE                     @D52VDVB 05890001
.*              R5  =  MASK TO SET POSLSTATE                   @D52VDVB 05891001
.*              R6  =  CURRENT VALUE OF POSLSTATE              @D52VDVB 05892001
.*              R7  =  ADDRRESS  POSLSTATE                     @D52VDVB 05893001
         LTR   R6,R6              ALLOCATION UNIT EMPTY        @D52VDVB 05894001
         BNZ   SCDELEXT           NO,  ---------->             @D52VDVB 05895001
         SPACE 1                                               @D52VDVB 05896001
.*    GETDVCB  IS IN SAME MODUL                                @D52VDVB 05897001
         BAL   R4,GETDVCBF        GET CORRECT DEVICE CONTR. BL.@D52VDVB 05898001
*SGLINK  GETDVCBF,INPUT=(R4,R8,R9,RC),OUTPUT=(RB),                     *05899001
               NOMODR=(RC-R2,R4,R6-RA),AMODE=ANY DATOFF                 05900001
         USING DEVCB,RB                                        @D52VDVB 05901001
         SPACE 1                                               @D52VDVB 05902001
*     SCAN AND DELETE REQUEST FROM PGQUO                       @D52VDVB 05903001
         SPACE 1                                               @D52VDVB 05904001
         L     R0,PFTESCB         RELATED SCB ADDR             @D52VDVB 05905001
         DROP  RC                                              @D52VDVB 05906001
         LA    RC,PORQBEG-TIBCHAIN+TIBADR GET PGQUO            @D52VDVB 05907001
         USING TIBADR,RC                                       @D52VDVB 05908001
         SPACE 1                                               @D52VDVB 05909001
SCDEL040 DS    0H                                              @D52VDVB 05910001
         LR    R3,RC              SAVE ADDR OF PREVIOUS IORE   @D52VDVB 05911001
         L     RC,TIBCHAIN        GET NEXT IORE                @D52VDVB 05912001
         LTR   RC,RC              LAST ENTRY                   @D52VDVB 05913001
         BZ    SCDELEXT           YES, ---------->             @D52VDVB 05914001
         CL    RC,DEVACT          I/O ACTIVE                   @D52VDVB 05915001
         BNE   SCDEL050           NO,  ---------->  DO DEQ     @D61NDRP 05916001
         SGCOV SGPMRS,MC=6        SPECIAL COVERAGE             @D52VDRP 05917001
         B     SCDEL040           YES, ---------->  DO NOT DEQ @D52VDVB 05918001
SCDEL050 CL    R0,TIBPFSCB        SPECIFIED SPACE              @D52VDVB 05919001
         BNE   SCDEL040           NO,  ---------->  NEXT IORE  @D52VDVB 05920001
         CL    R7,TIBAALU         SPECIFIED POSLSTATE          @D52VDVB 05921001
         BNE   SCDEL040           NO,  ---------->  NEXT IORE  @D52VDVB 05922001
         SPACE 1                                               @D52VDVB 05923001
         LA    R4,PGTPCB          GET PCB FOR PAGE-OUT         @D52VDVB 05924001
         ST    R4,PFPCB           SET IT FOR DELENTR RTN       @D52VDVB 05925001
*        AMODESW SET,DAT=ON       ENTER VIRT. MODE             @D61RDRP 05926001
         AMODESW SET,DAT=ON       ENTER VIRT. MODE             @D61RDRP 05927001
         BAL   RA,DELENTR         DELETE ENTRY FROM QUEUE      @D52VDVB 05928001
*SGLINK  DELENTR,INPUT=(R3,R8,R9,RA,RB,RC),WORK=(R4,R5),OUTPUT=(R2),   *05929001
               NOMODR=(R6-R1,R3),AMODE=31 DATON                         05930001
*        AMODESW SET,DAT=OFF      ENTER REAL MODE AGAIN        @D61RDRP 05931001
         AMODESW SET,DAT=OFF      ENTER REAL MODE AGAIN        @D61RDRP 05932001
         SPACE 1                                               @D52VDVB 05933001
SCDELEXT DS    0H                                              @D52VDVB 05934001
         LM    R7,R6,PMRSLEV0+OFR7 RESTORE REGISTERS           @D52VDVB 05935001
         BR    RA                 ==========>  EXIT SCDELPGO   @D52VDVB 05936001
         SPACE 1                                               @D52VDVB 05937001
         DROP  RB                 FORGET BASE FOR DEVCB        @D14BDRP 05938001
         DROP  RC                 FORGET BASE FOR TIBADR       @D14BDRP 05939001
*-------------------------------------------------------------*@D529DVB 05940001
         EJECT                                                 @D52VDVB 05941001
*-------------------------------------------------------------*@D529DVB 05942001
*        ROUTINE PROLOGUE                                      @D529DVB 05943001
*        ROUTINE NAME:  PFTEPOSL                               @D529DVB 05944001
*        MACRO:         SGPMR                                  @D529DVB 05945001
*        MODULE:        PMRSERV                                @D529DVB 05946001
*        FUNCTION: PROVIDES ACCESS TO POSL.POSLSTATE (PTE)     @D529DVB 05947001
*                  ACTIONS: - ACCESS                           @D529DVB 05948001
*                           - SET STATE ON                     @D529DVB 05949001
*                           - SET STATE OFF                    @D529DVB 05950001
*        ENTRY POINT:                                          @D529DVB 05951001
*           PFTEPOSL MODE(31),ANY                              @D529DVB 05952001
*        INPUT:                                                @D529DVB 05953001
*           R0 - REQUEST TYPE                                  @D529DVB 05954001
*                =  0   ACCESS                                 @D529DVB 05955001
*                =  4   POSLSTATE = ON                         @D529DVB 05956001
*                =  8   POSLSTATE = OFF                        @D529DVB 05957001
*           R8 - ADDR OF PAGEMANAGEMENT DATA-AREA (PMGMDATA)   @D529DVB 05958001
*           RA - RETURN ADDR                                   @D529DVB 05959001
*           RC - ADDR(PFTE) OF PAGE TO BE CONSIDERED           @D529DVD 05960001
*        OUTPUT:                                               @D529DVB 05961001
*           R0 - PREVIOUS VALUE OF POSLSTATE                   @D529DVB 05962001
*           R4 - OFFSET OF POSLSTATE  (WITHOUT HEADER)         @D529DVB 05963001
*           R5 - MASK OF RELATED PFTE                          @D529DVB 05964001
*           R6 - CURRENT VALUE OF POSLSTATE ( ALLOCATION UNIT) @D529DVB 05965001
*           R7 - ADDRESS OF POSLSTATE                          @D529DVB 05966001
*                0 IF PFTE IS BLOCK CONNECTED /                @D529DVB 05967001
*                     OR RELATED PAGE BELONGS TO VPOOL         @D529DVB 05968001
*                -1 IF PFTE BELONGS PMR ADDRESS SPACE          @D529DVB 05969001
*        DATA= SCB, PFTE, POSL                                 @D529DVB 05970001
*                                                              @D529DVB 05971001
*        EXIT NORMAL:                                          @D529DVB 05972001
*           RETURN TO CALLER:                                  @D529DVB 05973001
*                PFTEPOSL- 31 BIT ADDRESSING MODE, DATOFF      @D529DVB 05974001
*           RETURN CODE: NONE                                  @D529DVB 05975001
*        EXIT ERROR: -                                         @D529DVB 05976001
*           -                                                  @D529DVB 05977001
*-------------------------------------------------------------*@D529DVB 05978001
*     OPERATION:                                               @D529DVB 05979001
*        Q = 0;                                                @D529DVB 05980001
*        IF (* PF.PFTEFLG /= PFTEBLK & PF.PFTEEPA# IN VPOOL    @D529DVB 05981001
*            & PF.PFTESCB /= PMR-ADDRESS-SPACE *)              @D529DVB 05982001
*          THEN DO;                                            @D529DVB 05983001
*          SCB = PF.PFTESCB;      /*SCB WHERE PAGE BELONGS TO*/@D529DVB 05984001
*          SPACE-SWITCH(SCB);                                  @D529DVB 05985001
*          Q = POSL.PSLSTATE(PF.PFTEEPA#,SCB);                 @D529DVB 05986001
*          SELECT RQ;                                          @D529DVB 05987001
*            WHEN ACCESS;                                      @D529DVB 05988001
*            WHEN SET DO;                                      @D529DVB 05989001
*                 P = Q;                                       @D529DVB 05990001
*                 Q = Q OR POSL-MASK(PF.PFTEEPA#);             @D529DVB 05991001
*                 PF.PFTEFLG3 = POSLISON;                      @D529DVB 05992001
*            END                                               @D529DVB 05993001
*            WHEN RESET DO;                                    @D529DVB 05994001
*                 P = Q;                                       @D529DVB 05995001
*                 Q = Q XR POSL-MASK(PF.PFTEEPA#);             @D529DVB 05996001
*                 PF.PFTEFLG3 = &NOT.POSLISON;                 @D529DVB 05997001
*            END;                                              @D529DVB 05998001
*          END_SELECT;                                         @D529DVB 05999001
*          SPACE-SWITCH(*BACK*);/*SPACE SWITCH BACK TO ORIGIN*/@D529DVB 06000001
*          END_IF_THEN;                                        @D529DVB 06001001
*          ELSE;                                               @D52VDVB 06002001
*      END PFTEPOSL;                                           @D529DVB 06003001
*-------------------------------------------------------------*@D529DVB 06004001
*        INVARIANT REGISTERS: R1-R3,R8-RF                      @D529DVB 06005001
*-------------------------------------------------------------*@D529DVB 06006001
*        INTERNAL USAGE OF REGISTERS                           @D529DVB 06007001
*              R4 - OFFSET POSLSTATE                           @D529DVB 06008001
*              R5 - MASK  POSLSTATE                            @D529DVB 06009001
*              R6 - MASK  POSLSTATE                            @D529DVB 06010001
*              R7 - ADDRESS POSLSTATE                          @D529DVB 06011001
*              R9 - WORKREGISTER / BASE                        @D529DVB 06012001
*              RA - RETURN ADDR                                @D529DVB 06013001
*              RC - ADDR OF PTE                                @D52VDVB 06014001
*              RD - WORK REGISTER                              @D52VDVB 06015001
*-------------------------------------------------------------*@D529DVB 06016001
         SPACE 1                                               @D52VDVB 06017001
*SGLINK  PFTEPOSL,S,INPUT=(R0,R8,RA,RC),OUTPUT=(R0,R4,R5,R6,R7),       *06018001
               NOMODR=(R1-R3,R8-RF),AMODE=31 ANY,DATOFF                 06019001
PFTEPOSL DS    0H                                              @D52VDVB 06020001
         STM   R9,R3,PMRSLEV3+OFR9 SAVE CALLER'S REGS          @KD40056 06021001
         L     R9,APMRSERV        BASE OF ROUTINE              @D52VDVB 06022001
         USING PMRSERV,R9                                      @D52VDVB 06023001
         SLR   R7,R7                                           @D52VDVB 06024001
*        AMODESW SET,DAT=OFF      ENTER REAL MODE              @D52VDVB 06025001
         AMODESW SET,DAT=OFF      ENTER REAL MODE              @D52VDVB 06026001
         USING PFTE,RC            SET BASE FOR PFTE            @D52VDVB 06027001
         TM    S370FLG,PFTEBLK    BLOCK CONNECTED ONLY         @D52VDVB 06028001
         BO    PFTPOLEX           YES, ----------> NO POSL     @D52VDVB 06029001
         L     R3,PFTESCB         SCB WHERE PFTE BELONGS TO    @D52VDVB 06030001
         ST    R3,PMRSCB          SET UP I/F TO CHKVPOL1       @D52VDVB 06031001
         SLR   R5,R5                                           @D52VDVB 06032001
         ICM   R5,M7,PFTEEPA#     ... GET EPA-NR               @D52VDVB 06033001
         LR    R6,R5              ... SAVE IT FOR LATER USE    @D52VDVB 06034001
         SLL   R5,PNSHIFT         ... EPANR -> EPA             @D52VDVB 06035001
         BAL   RA,CHKVPOL1        CHECK FOR VPOOL              @D52VDVB 06036001
         B     PFTPOL00           NO VPOOL ---------->         @D52VDVB 06037001
         B     PFTPOLEX           VPOOL    ---------->                 *06038001
                                           POSL NOT USEABLE    @D52VDVB 06039001
PFTPOL00 DS    0H                                              @D52VDVB 06040001
*        AMODESW SET,DAT=ON                                    @D52VDVB 06041001
         AMODESW SET,DAT=ON                                    @D52VDVB 06042001
         USING SCBADR,R3          ADDRESSABILITY TO OWNERS SCB @D52VDVB 06043001
         BCTR  R7,0                                            @D52VDVB 06044001
         TM    SCBFLG,SCBPMRSP    PMR ADDRESS SPACE            @D52VDVB 06045001
         BO    PFTPOLEX           YES, ---------->  NO POSL    @D52VDVB 06046001
         SPACE 1                                               @D52VDVB 06047001
         L     R7,SCBAPOSL        RELATED POSL ADDRESS         @D52VDVB 06048001
         L     R4,TIBPTR          SAVE ADDRESS OF...           @D52VDVB 06049001
         MVC   PMRSLEV3+OFR4,TIBSCB-TIBADR(R4)   ...CURRENT SCB@KD40056 06050001
         L     R3,SCBAPMRA        GET SCB FOR PT AND PTAS      @D52VDRP 06051001
         DROP  R3                 DROP BASE FOR SCB            @D52VDRP 06052001
*    SWITCH TO PMR ADDRESS SPACE                               @D52VDRP 06053001
*        SGSETUP SETSCB,NEXTSCB=R3,OPTION=NOSAVE,WR1=R4,WR2=R5 @D52VDRP 06054001
         SGSETUP SETSCB,NEXTSCB=R3,OPTION=NOSAVE,WR1=R4,WR2=R5 @D52VDRP 06055001
         SPACE 1                                               @D52VDVB 06056001
         USING PSLCB,R7           ADDRESSABILITY TO POSL               *06057001
                                  IN PMR-ADDRESS SPACE         @D52VDVB 06058001
         LR    R4,R6                                           @D52VDVB 06059001
         SRDL  R4,PNBLSHFT        GET EPA-NR / 8                       *06060001
                                  ( = OFFSET IN POSLSTATE)     @D52VDVB 06061001
         SRL   R5,32-PNBLSHFT     BIT VALUE OF CURRENT PAGE    @D52VDVB 06062001
         IC    R5,RTMASK(R5)      ... IN ALLOCATION UNIT       @D52VDVB 06063001
         LA    R7,PSLSTATE(R4)    ADDRESS OF PSLSTATE          @D52VDVB 06064001
         DROP  R7                                              @D52VDVB 06065001
         SLR   R6,R6                                           @D52VDVB 06066001
         IC    R6,0(,R7)          PROVIDE CURRENT VALUE        @D52VDVB 06067001
         ST    R6,PMRSLEV3+OFR0   ... BEFORE ANY CHANGE        @KD40056 06068001
         LR    R6,R5              PROVIDE CURRENT MASK         @D52VDVB 06069001
         LR    R1,R0                                           @D52VDVB 06070001
         B     PFTPOLTB(R1)                                    @KX41010 06071001
PFTPOLTB B     PFTPOL50           ACCESS ONLY, ---------->     @KX41010 06072001
         B     PFTPOL30           POSLSTATE = ON  ---------->  @KX41010 06073001
*------> B     PFTPOL20           POSLSTATE = OFF ---------->  @KX41010 06074001
PFTPOL20 X     R6,ADDRMSK         BUILD COMPLEMENT             @KX41010 06075001
PFTPOL30 EX    R6,POSLSTA(R1)                                  @KX41010 06076001
         SLR   R6,R6                                           @D52VDVB 06077001
         SPACE 1                                               @D52VDVB 06078001
PFTPOL50 IC    R6,0(,R7)          PROVIDE CURRENT VALUE        @D52VDVB 06079001
         L     R3,PMRSLEV3+OFR4   CURRENT SCB                  @KD40056 06080001
*    SWITCH TO USER ADDRESS SPACE                              @D52VDRP 06081001
*        SGSETUP SETSCB,NEXTSCB=R3,OPTION=NOSAVE,WR1=R1,WR2=R2 @D52VDRP 06082001
         SGSETUP SETSCB,NEXTSCB=R3,OPTION=NOSAVE,WR1=R1,WR2=R2 @D52VDRP 06083001
*        AMODESW SET,DAT=OFF      ENTER REAL MODE              @D52VDVB 06084001
         AMODESW SET,DAT=OFF      ENTER REAL MODE              @D52VDVB 06085001
         SPACE 1                                               @D52VDVB 06086001
         USING PFTE,RC            ADDRESSABILITY TO PFTE       @KX41010 06087001
         LR    R1,R0                                           @KX41010 06088001
         EX    0,POSLSTB(R1)      SET / RESET PFTEFLG3.POLSISON@KX41010 06089001
         LM    R9,R3,PMRSLEV3+OFR9  RESET CALLER'S REGS        @KD40056 06090001
         BR    RA                 ============> EXIT PFTEPOSL  @D52VDVB 06091001
         SPACE 1                                                        06092001
PFTPOLEX DS    0H                                              @D52VDVB 06093001
*        AMODESW SET,DAT=OFF      ENTER REAL MODE              @D52VDVB 06094001
         AMODESW SET,DAT=OFF      ENTER REAL MODE              @D52VDVB 06095001
         SLR   R5,R5                                           @D52VDVB 06096001
         LR    R6,R5                                           @D52VDVB 06097001
         LM    R9,R3,PMRSLEV3+OFR9  RESET CALLER'S REGS        @KD40056 06098001
         BR    RA                 ============> EXIT PFTEPOSL  @D52VDVB 06099001
         SPACE 2                                                        06100001
POSLSTA  NOP   POSLSTA                                         @KX41010 06101001
         OI    0(R7),0            SET POSL BIT ON              @D52VDVB 06102001
POSLSTX  NI    0(R7),0            SET POSL BIT OFF             @D52VDVB 06103001
POSLSTB  NOP   POSLSTB                                         @KX41010 06104001
         OI    PFTEFLG3,POSLISON      POSL BIT ON              @KX41010 06105001
         NI    PFTEFLG3,XFF-POSLISON  POSL BIT OFF             @KX41010 06106001
         SPACE 1                                               @D52VDVB 06107001
         DROP  RC                 RESET ADDRESSABILITY TO PFTE @KX41010 06108001
         DROP  R9                 RESET ADDRESSABILITY TO CODE @K52VDVB 06109001
*-------------------------------------------------------------*@D529DVB 06110001
         EJECT                                                 @D52VDVB 06111001
*-------------------------------------------------------------*@D529DVB 06112001
*        ROUTINE PROLOGUE                                      @D529DVB 06113001
*        ROUTINE NAME:  PGOQPFTE                               @D529DVB 06114001
*        MACRO:         SGPMR                                  @D529DVB 06115001
*        MODULE:        PMRSERV                                @D529DVB 06116001
*        FUNCTION:                                             @D529DVB 06117001
*               1. PREPARES THE PFTE-S OF THE RELATED          @D529DVB 06118001
*                  ALLOCATION UNIT FOR PAGE I/O                @D529DVB 06119001
*               2. RESETS THE PFTE-S                           @D529DVB 06120001
*        ENTRY POINT:                                          @D529DVB 06121001
*           PGOQPFTE AMODE(31),DATON                           @D529DVB 06122001
*        INPUT:                                                @D529DVB 06123001
*           R0 - INDICATION WHETHER SYSTEM REQ OR NOT          @D529DVB 06124001
*                =  0 PREPARE FOR PAGE OUT                     @D529DVB 06125001
*                =  4 RESERVED                                 @D529DVB 06126001
*                =  8 RESET PFTE-S                             @D529DVB 06127001
*                = 12 RESET PFTE-S SPECIAL                     @D529DVB 06128001
*           R5 - ADDR OF IORE (PSEUDO TIB)                     @D529DVB 06129001
*           R6 - VALUE OF POSLSTATE TO BE CONSIDERED           @D52VDVB 06130001
*           R8 - ADDR OF PAGEMANAGEMENT DATA-AREA (PMGMDATA)   @D529DVB 06131001
*           RA - RETURN ADDR                                   @D529DVB 06132001
*        OUTPUT:                                               @D529DVB 06133001
*            -                                                 @D529DVB 06134001
*        EXIT:                                                 @D529DVB 06135001
*           RETURN WITH OFFSET 0 IF R0 > 0  OR R0 = 0 AND      @D529DVB 06136001
*                                               PTE.PTEIBIT=ON @D529DVB 06137001
*           RETURN WITH OFFSET 4 IF R0 = 0  AND PTE.PTEIBIT=OFF@D529DVB 06138001
*------------------------------------------------------------* @D529DVB 06139001
*      PT = (* FIRST PTE OF CONTIGUOUS PART OF Q *);           @D529DVB 06140001
*      N  = (* NUMBER OF CONTIGUOUS BLOCKS       *);           @D529DVB 06141001
*      DO FOR I = 1 TO N;                                      @D529DVB 06142001
*        SELECT RQ;                                            @D529DVB 06143001
*          WHEN PGO | SYS DO;                                  @D529DVB 06144001
*             PF = (* PT.PTEFRA *);    /* GET ASSOCIATED PFTE*/@D529DVB 06145001
*             PF.PFTETIB = ADDRESS(T); /* ADDR(IORE)  IN PFTE*/@D529DVB 06146001
*             T.TIBAPFT(Q(PT)) = ADDRESS(PF);/* ADDR(PFTE) ..*/@D529DVB 06147001
*                                      /*.. IN SLOT OF IORE  */@D529DVB 06148001
*          END;                                                @D529DVB 06149001
*          WHEN DEL DO;                                        @D529DVB 06150001
*             PF.PFTETIB = 0;          /* RESET ADDR IN PFTE */@D529DVB 06151001
*          END;                                                @D529DVB 06152001
*          WHEN SPC DO;                                        @D529DVB 06153001
*             IF (* PF /= T.TIBSTATE                           @D529DVB 06154001
*                   & ADDR(T) /= PF.PFTETIB *)                 @D529DVB 06155001
*               THEN PF.PFTIB -> TIB.PGQTYP=(*RESET PGDELO*);  @D529DVB 06156001
*               /*  REACTIVATE PAGE-OUT REQUEST FOR POSSIBLY */@D529DVB 06157001
*               /*  ...  COMBINED UNC. PAGE-OUT REQUEST      */@D529DVB 06158001
*          END;                                                @D529DVB 06159001
*        END SELECT;                                           @D529DVB 06160001
*      END DO-FOR;                                             @D529DVB 06161001
*      END PGOQPFTE;                                           @D529DVB 06162001
*------------------------------------------------------------* @D529DVB 06163001
*        INVARIANT REGISTERS: R0-RF                            @D529DVB 06164001
*------------------------------------------------------------* @D529DVB 06165001
*        INTERNAL USAGE OF REGISTERS                           @D529DVB 06166001
*              R5 - ADDR OF PAGE-OUT REQUEST ELEMENT (TIB)     @D529DVB 06167001
*              R6 - VALUE OF CURRENT PSLSTATE                  @D529DVB 06168001
*              R8 - PMR DATA AREA                              @D529DVB 06169001
*              R9 - BASE (PMRSERV)                             @D529DVB 06170001
*              RA - RF WORKREGISTERS                           @D529DVB 06171001
*-------------------------------------------------------------*@D529DVB 06172001
         SPACE 1                                                        06173001
*SGLINK  PGOQPFTE,S,INPUT=(R0,R5,R6,R8,RA),NOMODR=(R1-RF),             *06174001
               AMODE=31 DATON                                           06175001
PGOQPFTE DS    0H                                              @D52VDVB 06176001
         STM   R7,RF,PMRSLEV3+OFR7                             @D52VDVB 06177001
         L     R9,APMRSERV        PROVIDE ADDRESSABILITY       @D52VDVB 06178001
         USING PMRSERV,R9                                      @D52VDVB 06179001
         USING TIBADR,R5                                       @D52VDVB 06180001
         L     RA,TIBAALU                                      @D52VDVB 06181001
         L     RD,TIBPFSCB        CURRENT SCB                  @D52VDVB 06182001
         USING SCBADR,RD                                       @D52VDVB 06183001
         SL    RA,SCBAPOSL        CALCULATE ...                @D52VDVB 06184001
         LA    RE,PSLHDLN(,0)     ... OFFSET                   @D52VDVB 06185001
         SLR   RA,RE              ... OF POSLASTATE            @D52VDVB 06186001
         SLL   RA,PNBLSHFT+PNRPTOSH   EPANR OF FIRST PAGE      @D52VDVB 06187001
*                                 ... REPRESENTED BY PSLSTATE  @D52VDVB 06188001
*                                 = OFFSET IN PT               @D52VDVB 06189001
         AL    RA,SCBAPT          + ADDRESS OF PT OF SPACE     @D52VDVB 06190001
*                                 = ADDRESS OF PT CORRESPONDING@D52VDVB 06191001
*                                 ... TO ALLOCATION UNIT       @D52VDVB 06192001
         DROP  RD                                              @D52VDVB 06193001
*        GENSERV PGONT,PSLVAL=(R6),PGONT=(RD)                  @D52VDVB 06194001
         GENSERV PGONT,PSLVAL=(R6),PGONT=(RD)                  @D52VDVB 06195001
         USING PREPGENT,RD                                     @D52VDVB 06196001
         LH    RE,PREPGBLK        BLOCKING FACTOR              @D52VDVB 06197001
         LA    RF,TIBAPFT         ADDRESS OF A(PFTE) ARRAY             *06198001
                                  ... IN IORE                  @D52VDVB 06199001
         AL    RF,PREPGOFF        FIRST ADDRESS OF A(PFTE)-LIST@D52VDVB 06200001
         SLR   RC,RC                                           @D52VDVB 06201001
         IC    RC,PREPGPTE        RELATIVE EPA-NR OF 1ST PAGE  @D52VDVB 06202001
         DROP  RD                                              @D52VDVB 06203001
         ALR   RC,RC              370                          @D52VDVB 06204001
         ALR   RC,RC              XA                           @D52VDVB 06205001
         ALR   RA,RC              ADDRESS OF FIRST AFFECTED PTE@D52VDVB 06206001
         SPACE 1                                               @D52VDVB 06207001
*------------------------------------------------------------* @D52VDVB 06208001
*     PROCESS ALLOCATION UNIT ( LOOP OVER BITMAP OF ONE BYTE ) @D52VDVB 06209001
*------------------------------------------------------------* @D52VDVB 06210001
         SPACE 1                                               @D52VDVB 06211001
         LR    RB,R0                                           @D52VDVB 06212001
         LA    R0,4(,0)           RETURN OFFSET 4 FOR SET-PGO  @D52VDVB 06213001
PGOQP000 DS    0H                                              @D52VDVB 06214001
         B     PGOQPTAB(RB)                                    @D52VDVB 06215001
PGOQPTAB B     PGOQP010           SET PGO-PFTE                 @D52VDVB 06216001
         B     PGOQP010                                        @D52VDVB 06217001
         B     PGOQP060           NORMAL RESET                 @D52VDVB 06218001
         B     PGOQP070           SPECIAL RESET                @D52VDVB 06219001
*------------------------------------------------------------* @D52VDVB 06220001
*     PREPARE PAGE-OUT                                         @D52VDVB 06221001
*     GET CORRESPONDING PFTE VIA PTE                           @D52VDVB 06222001
*------------------------------------------------------------* @D52VDVB 06223001
         USING PTE,RA             SET BASE FOR PTE             @D52VDVB 06224001
PGOQP010 DS    0H                                              @D52VDVB 06225001
         TM    PTESTAT,PTEIBIT    PAGE ADDRESSABLE             @D52VDVB 06226001
         BZ    PGOQP040           ----------> YES              @D52VDRP 06227001
         TM    PTESTAT,PTEPGCO    PAGE CONNECTED (UNC PAGE-OUT)@D52VDVB 06228001
         BO    PGOQP020           ---------->  YES             @D52VDVB 06229001
*------------------------------------------------------------* @D52VDVB 06230001
*     HANDLE PAGE WITH RELATED POSLBIT ON                      @KD40396 06231001
*------------------------------------------------------------* @KD40396 06232001
         BAL   R5,PMRHWERR        ==========>  HARD WAIT       @D52VDVB 06233001
.* IN CASE THE HARDWAIT SHOULD BE REMOVED,                     @KD40396 06234001
.* SET POSLBIT OFF AND CONTINUE NORMAL PROCESSING              @KD40396 06235001
         SLR   R0,R0                                           @KD40396 06236001
         LR    RD,RF                                           @KD40396 06237001
         LA    RC,TIBAPFT         START OF PFTETABLE           @KD40396 06238001
         SLR   RD,RC              OFFSET IN IORE-S PFTETABLE   @KD40396 06239001
         SRL   RD,2               BIT NUMBER                   @KD40396 06240001
         IC    RC,RTMASK(RD)      GET RELATED POSLVALUE        @KD40396 06241001
         X     RC,ADDRMSK         ... AND PROVIDE COMPLEMENT   @KD40396 06242001
         L     R7,TIBAALU                                      @KD40396 06243001
         EX    RC,POSLSTX         RESET RELATED POSLSTATE      @KD40396 06244001
         B     PGOQP100           ---------->  NEXT PAGE       @KD40396 06245001
         SPACE 1                                               @D52VDVB 06246001
PGOQP020 DS    0H                                              @D52VDVB 06247001
*        AMODESW SET,DAT=OFF      ENTER REAL MODE              @D52VDVB 06248001
         AMODESW SET,DAT=OFF      ENTER REAL MODE              @D52VDVB 06249001
         L     RC,0(,RF)          PFTE MUST BE ALREADY SET     @D52VDVB 06250001
         LTR   RC,RC              ... IN PGOQCHCK              @D52VDVB 06251001
         BNZ   PGOQP100           YES, --------->              @D52VDVB 06252001
         BAL   R5,PMRHWERR        NO,  ==========>  HARD WAIT  @D52VDVB 06253001
         SPACE 1                                               @D52VDVB 06254001
PGOQP040 DS    0H                                              @D52VDVB 06255001
         SLR   RC,RC                                           @D52VDVB 06256001
         ICM   RC,M7,PTEFRA       FRAME ID = PFTE INDEX * 2**4 @D52VDVB 06257001
         SLL   RC,PNPFTESH-PF4SHIFT PFTE OFFSET IN PFT         @D52VDVB 06258001
         DROP  RA                                              @D52VDVB 06259001
         AL    RC,APFT            ADDRESS OF PFTE              @D52VDVB 06260001
         ST    RC,0(,RF)          PROVIDE A(PFTE) IN IORE      @D52VDVB 06261001
*        AMODESW SET,DAT=OFF      ENTER REAL MODE              @D52VDVB 06262001
         AMODESW SET,DAT=OFF      ENTER REAL MODE              @D52VDVB 06263001
         USING PFTE,RC                                         @D52VDVB 06264001
         ST    R5,PFTETIB         ADDRESS OF IORE / PSEUDO TIB @D52VDVB 06265001
         B     PGOQP100           ---------> NEXT PAGE         @D52VDVB 06266001
         SPACE 1                                               @D52VDVB 06267001
         DROP  RC                                              @D52VDVB 06268001
         SPACE 1                                               @D52VDVB 06269001
*------------------------------------------------------------* @D52VDVB 06270001
*     RESET-PAGE OUT                                           @D52VDVB 06271001
*     GET CORRESPONDING PFTE FROM TIBAPFT TABLE                @D52VDVB 06272001
*------------------------------------------------------------* @D52VDVB 06273001
PGOQP060 DS    0H                                              @D52VDVB 06274001
         L     RC,0(,RF)          ADDRESS OF CURRENT PFTE      @D52VDVB 06275001
         LTR   RC,RC              AVAILABLE                    @D52VDVB 06276001
         BZ    PGOQP090           NO, -------->   NEXT ENTRY   @D52VDVB 06277001
*        AMODESW SET,DAT=OFF      ENTER REAL MODE              @D52VDVB 06278001
         AMODESW SET,DAT=OFF      ENTER REAL MODE              @D52VDVB 06279001
         B     PGOQP080           --------->   RESET IORE      @D52VDVB 06280001
         SPACE 1                                               @D52VDVB 06281001
*------------------------------------------------------------* @D52VDVB 06282001
*     RESET-PAGE OUT                                           @D52VDVB 06283001
*     GET CORRESPONDING PFTE FROM TIBAPFT TABLE                @D52VDVB 06284001
*------------------------------------------------------------* @D52VDVB 06285001
PGOQP070 DS    0H                                              @D52VDVB 06286001
         L     RC,0(,RF)          ADDRESS OF CURRENT PFTE      @D52VDVB 06287001
         LTR   RC,RC              AVAILABLE                    @D52VDVB 06288001
         BZ    PGOQP090           NO, -------->   NEXT ENTRY   @D52VDVB 06289001
*        AMODESW SET,DAT=OFF      ENTER REAL MODE              @D52VDVB 06290001
         AMODESW SET,DAT=OFF      ENTER REAL MODE              @D52VDVB 06291001
         USING PFTE,RC                                         @D52VDVB 06292001
         CL    RC,TIBSTATE        UNC. PAGE-OUT PFTE           @D52VDVB 06293001
         BE    PGOQP090           YES, --------> DON'T TOUCH IT@D52VDVB 06294001
         L     RD,PFTETIB                                      @D52VDVB 06295001
         CLR   RD,R5              PFTE BELONGS TO OTHER UNC.           *06296001
                                  ... PAGE OUT REQUEST         @D52VDVB 06297001
         BE    PGOQP080           YES, --------->              @D52VDVB 06298001
         NI    PGQTYP-TIBADR(RD),XFF-PGDELO RE-ACTIVATE PAGE-OUT       *06299001
                                  ... REQUEST                  @D52VDVB 06300001
         B     PGOQP090                                        @D52VDVB 06301001
PGOQP080 DS    0H                                              @D52VDVB 06302001
         XC    PFTETIB,PFTETIB    CLEAR ADDR IORE IN PFTE      @D52VDVB 06303001
         DROP  RC                                              @D52VDVB 06304001
PGOQP090 DS    0H                                              @KD40396 06305001
         SLR   R0,R0              RETURN VIA OFFSET 0          @KD40396 06306001
         SPACE 1                                               @D52VDVB 06307001
*------------------------------------------------------------* @D52VDVB 06308001
*     HANDLE NEXT PAGE - IF ANY                                @D52VDVB 06309001
*------------------------------------------------------------* @D52VDVB 06310001
PGOQP100 DS    0H                                              @D52VDVB 06311001
*        AMODESW SET,DAT=ON       ENTER REAL MODE              @D52VDVB 06312001
         AMODESW SET,DAT=ON       ENTER REAL MODE              @D52VDVB 06313001
         LA    RA,LPTE(,RA)       NEXT PTE                     @D52VDVB 06314001
         LA    RF,4(,RF)          NEXT A(PFTE) IN PFTE TABLE   @D52VDVB 06315001
         BCT   RE,PGOQP000        MORE TO DO - YES, ---------->@D52VDVB 06316001
         SPACE 1                                               @D52VDVB 06317001
*     ALLOCATION UNIT PROCESSED                                @D52VDVB 06318001
         SPACE 1                                               @D52VDVB 06319001
PGOQP110 DS    0H                                              @D52VDVB 06320001
         LM    R7,RF,PMRSLEV3+OFR7                             @D52VDVB 06321001
         ALR   RA,R0              ADJUST RETURN ADDR IF REQUIR.@KD40396 06322001
         BR    RA                 ==========>  EXIT PGOQPFTE           *06323001
                                               OFFSET 0 / 4    @KD40396 06324001
         SPACE 1                                               @D52VDVB 06325001
         DROP  R5                                              @D52VDVB 06326001
         DROP  R9                                              @D52VDVB 06327001
*-------------------------------------------------------------*@D52VDVB 06328001
         TITLE 'VSE/AF SUPERVISOR     SGPMR     PAGE MANAGER (LOAD-LEVE*06329001
               LING SUBROUTINES)'                              @D14ZDRP 06330001
*-------------------------------------------------------------*         06331001
*        TRTABB - ROUTINE                                     *         06332001
*              TESTS BIT IN REENTRY-RATE TABLES RTAB, RTABX   *         06333001
*              INCREASES REENTRY-RATE COUNTERS RRCTR, RRCTRX  *         06334001
*              AMODE(31),DATON                                 @D529DRP 06335001
*        INPUT:  R1 = EXTENDED PAGE ADDRESS ON PAGE BOUNDARY  *         06336001
*                R7 = RETURN ADDR                             *         06337001
* ------------------------------------------------------------*         06338001
         SPACE 1                                                        06339001
         USING PMGMDATA,R8                                     @D52VDVB 06340001
         USING PMRSERV,R9                                      @D52VDVB 06341001
TRTABB   DS    0H                                              @DA33314 06342001
         L     R5,PFSCB                                        @KD40310 06343001
         USING SCBADR,R5                                       @KD40310 06344001
         LR    R4,R1              GET ADDRESS                  @KD40310 06345001
         N     R4,PMBLKMSK        ...  OF                      @KD40310 06346001
         SRL   R4,PNSHIFT+PNBLSHFT-PTASSHFT  ...   CORRESP.    @KD40310 06347001
         A     R4,SCBAPTAS        ...            PTAS ENTRY    @KD40310 06348001
         DROP  R5                 DROP BASE FOR SCBADR         @KD40310 06349001
         USING PTASE,R4                                        @KD40310 06350001
         L     R4,PTASRECN        GET RECORD OF BLOCK ON PDS   @KD40310 06351001
         DROP  R4                 DROP BASE FOR PTASE          @KD40310 06352001
         SRL   R4,3               GET REC#/8   (OFFSET IN RTAB)@KD40310 06353001
         LR    RC,R4              SAVE IT FOR RTABX            @KD40310 06354001
         LR    R5,R1              GET RECORD NUMBER            @KD40310 06355001
         N     R5,PMBLKDIS        ... WITHIN ALLOCATION UNIT   @KD40310 06356001
         SRL   R5,PNSHIFT         ... ON PDS (BLOCK)           @KD40310 06357001
*        AMODESW SET,DAT=OFF      ENTER REAL MODE              @D52VDRP 06358001
         AMODESW SET,DAT=OFF      ENTER REAL MODE              @D52VDRP 06359001
         A     R4,ARTAB           R4 ADDR OF RTAB BYTE                  06360001
         IC    R5,RTMASK(R5)                                            06361001
         EX    R5,TMRTAB          TEST RTAB-BIT                         06362001
         BZ    TRT010             ---->  IF BIT OFF            @DA33314 06363001
*        GENSERV INC,FIELD=RRCTR,REG=(R0)                      @D52VDVB 06364001
         GENSERV INC,FIELD=RRCTR,REG=(R0)                      @D52VDVB 06365001
TRT010   LR    R4,RC              GET REC#/8 OF 1ST PAGE IN BLK@DA33314 06366001
         A     R4,ARTABX          R4 ADDR OF RTABX BYTE        @DA33314 06367001
         EX    R5,TMRTAB          TEST RTABX-BIT               @DA33314 06368001
         BZ    TRTABEX            ---------->  RETURN IF NO    @DA33314 06369001
*        GENSERV INC,FIELD=RRCTRX,REG=(R0)                     @D52VDVB 06370001
         GENSERV INC,FIELD=RRCTRX,REG=(R0)                     @D52VDVB 06371001
TRTABEX  DS    0H                                              @D52VDVB 06372001
*        AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @D52VDRP 06373001
         AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @D52VDRP 06374001
         BR    R7                 ==========>                  @DA33314 06375001
         SPACE 1                                               @D51GDRP 06376001
TMRTAB   TM    0(R4),0                                                  06377001
         DROP  R8                                              @D52VDVB 06378001
         SPACE 2                                                        06379001
*-------------------------------------------------------------*         06380001
*        CPGIN - ROUTINE                                      *         06381001
*              COUNTS PAGE-INS FOR DEACTIVATION/REACTIVATION. *         06382001
*              ROUTINE DEACT IS CALLED, IF THERE ARE N PAGE-INS         06383001
*              SINCE LAST DEACTIVATION-MEASUREMENT            *         06384001
*        CALLED BY: PMR WITH AMODE(31),DATON                   @D529DRP 06385001
*        CALLED ROUTINE: DEACT WITH AMODE(24),DATON            @D529DRP 06386001
*         R7 - RETURN ADDR                                    *         06387001
*-------------------------------------------------------------*         06388001
         SPACE 1                                                        06389001
         USING PMGMDATA,R8        SET BASE FOR DATA AREA                06390001
CPGIN    CLC   PIDCTR,NPI         PIDCTR=N ? SWITCH                     06391001
         BL    CPGIN1             NO, BRANCH                            06392001
         L     RF,ALOLEV          GET BASE FOR LOAD LEVELLER            06393001
         LR    RE,R8              GET DATA-AREA BASE                    06394001
         USING LOLEV,RF           SET BASE                              06395001
*        AMODESW CALL,AMODE=24,ADDRESS=DEACT,REGS=(RA,RA)      @D52VDRP 06396001
         AMODESW CALL,AMODE=24,ADDRESS=DEACT,REGS=(RA,RA)      @D52VDRP 06397001
         DROP  RF                                                       06398001
CPGIN1   LM    R4,R5,PIDCTR                                             06399001
         AL    R4,F1              INCREASE                     @D52VDVB 06400001
         AL    R5,F1              PAGE-IN COUNTERS             @D52VDVB 06401001
         STM   R4,R5,PIDCTR                                             06402001
         BR    R7                 ==========>    RETURN CPGIN           06403001
         DROP  R8                                              @D51GDRP 06404001
         SPACE 2                                               @D52VDVB 06405001
*-------------------------------------------------------------*         06406001
*        SRTABB - ROUTINE                                     *         06407001
*              SETS BIT IN REENTRY-RATE TABLES RTAB AND RTABX *         06408001
*              AMODE(31),DATOFF                               *@D529DRP 06409001
*        INPUT: RC = ADDR OF PFTE                             *         06410001
*               RD = EXTENDED PAGE ADDRESS ON PAGE BOUNDARY   *         06411001
*               RA = RETURN ADDRESS                           *         06412001
*-------------------------------------------------------------*         06413001
         SPACE 1                                                        06414001
         USING PMGMDATA,R8        SET BASE FOR DATA AREA                06415001
         USING PFTE,RC                                         @KD40310 06416001
SRTABB   L     R5,PFTESCB         ADDR OF SCB FOR EPA          @KD40310 06417001
         DROP  RC                 DROP BASE FOR PFTE           @KD40310 06418001
*        AMODESW SET,DAT=ON        ENTER VIRTUAL MODE          @KD40310 06419001
         AMODESW SET,DAT=ON        ENTER VIRTUAL MODE          @KD40310 06420001
         USING SCBADR,R5                                       @KD40310 06421001
         LR    R4,RD              GET                          @KD40310 06422001
         N     R4,PMBLKMSK        ...  ADDR                    @KD40310 06423001
         SRL   R4,PNSHIFT+PNBLSHFT-PTASSHFT ... OF CORRESP     @KD40310 06424001
         A     R4,SCBAPTAS                  ... PTAS ENTRY     @KD40310 06425001
         USING PTASE,R4                                        @KD40310 06426001
         L     R5,SCBAPMRA        GET SCB FOR PTAS             @KD40310 06427001
         C     R5,SCBPTR          SPACE SWITCH REQUIRED        @KD40310 06428001
         BE    SRTABB10           NO, SKIP SWITCH              @KD40310 06429001
         LCTL  CR1,CR1,SCBRSTO    MAKE PTAS ACCESSIBLE         @KD40310 06430001
         L     R4,PTASRECN        GET REC# OF BLOCK ON PDS     @KD40310 06431001
         DROP  R4                 DROP BASE FOR PTASE          @KD40310 06432001
         L     R5,SCBPTR          SWITCH BACK TO               @KD40310 06433001
         LCTL  CR1,CR1,SCBRSTO    ....    ORIGINAL SPACE       @KD40310 06434001
         B     SRTABB15           SKIP NO SWITCH CODE          @KD40310 06435001
         DROP  R5                 DROP BASE FOR SCB            @KD40310 06436001
         USING PTASE,R4                                        @KD40310 06437001
SRTABB10 L     R4,PTASRECN        GET REC# OF BLOCK ON PDS     @KD40310 06438001
         DROP  R4                 DROP BASE FOR PTASE          @KD40310 06439001
SRTABB15 DS    0H                                              @KD40310 06440001
*        AMODESW SET,DAT=OFF       ENTER REAL MODE AGAIN       @KD40310 06441001
         AMODESW SET,DAT=OFF       ENTER REAL MODE AGAIN       @KD40310 06442001
         SRL   R4,3               GET REC#/8 OF 1ST PAGE IN BLK@KD40310 06443001
         A     R4,ARTAB           R4 ADDR OF RTAB BYTE                  06444001
         LR    R5,RD              GET RECORD NUMBER            @KD40310 06445001
         N     R5,PMBLKDIS        ... WITHIN ALLOCATION UNIT   @KD40310 06446001
         SRL   R5,PNSHIFT         ... ON PDS (BLOCK) (BIT#)    @KD40310 06447001
         IC    R5,RTMASK(R5)                                            06448001
         EX    R5,OIRTAB          SET RTAB-BIT ON BELONGING TO THE      06449001
*                                 PAGE                                  06450001
         S     R4,ARTAB           GET ADDRESS OF               @KD40310 06451001
         A     R4,ARTABX          ...        RTABX BYTE        @DA33314 06452001
         EX    R5,OIRTAB          SET RTABX-BIT ON BELONGING TO        *06453001
                                  PAGE                         @DA33314 06454001
         BR    RA                 ==========>  RETURN SRTABB   @DA33314 06455001
OIRTAB   OI    0(R4),0                                                  06456001
         SPACE 2                                                        06457001
         DROP  R9                                              @D52VDVB 06458001
         TITLE 'VSE/AF SUPERVISOR     SGPMR     PAGE TABLE ASSIGN/UNASS*06459001
               IGN SUBROUTINES)'                               @D14ZDRP 06460001
*-------------------------------------------------------------*@DA33314 06461001
*        PTASG - ROUTINE                                       @DA33314 06462001
*           ASSIGNES A FREE PAGE TABLE TO A BLOCK ON PDS       @D519DRP 06463001
*           NPAGPBLK CONTAINS NUMBER OF PTE'S IN ONE BLOCK     @D519DRP 06464001
*        PTASG2 - RTN IS ONLY CALLED DURING IPL ($INTVIRT)     @D529DRP 06465001
*        INPUT:                                                @DA33314 06466001
*           R8 - PMGMDATA ADDRESS (IF ENTERED AT PTASG)        @DA33314 06467001
*           RA - RETURN ADDRESS                                @DA33314 06468001
*           RB - VIRT. ADDRESS OF SCB IF NOT CALLED BY IPL     @D52GDWL 06469001
*           RD - VIRT. ADDR OF A PAGE IN BLOCK TO BE ASSIGNED  @D519DRP 06470001
*        WORK REGISTER:                                        @DA33314 06471001
*           R0 - R7, RA - RF ALL SAVED AND RESTORED            @D519DRP 06472001
*           IF ENTERED VIA PTASG2 R8 AND R9 ARE DESTROYED      @D519DRP 06473001
*        CALLED BY:                                            @DA33314 06474001
*           INVPAGE, GETREAL, $INTVIRT WITH AMODE(31),DATOFF   @D529DRP 06475001
*        CALLED ROUTINES:                                      @D529DRP 06476001
*           PDASFIND WITH AMODE(31),DATOFF                     @D529DRP 06477001
*           CHKSAREA, PTASSGMT, EPACNVR3 WITH AMODE(31),DATON  @D529DRP 06478001
*-------------------------------------------------------------*@DA33314 06479001
         SPACE 1                                               @DA33314 06480001
PTASG2   DS    0H                                                       06481001
         L     R8,APMGMDAT        BASE OF DATA AREA            @D52VDVB 06482001
         USING PMGMDATA,R8        ADDRESSABILITY OF DATA AREA  @D52VDVB 06483001
         L     R9,APMRSERV        BASE OF MODULE               @D52VDVB 06484001
         USING PMRSERV,R9         ADDRESSABILITY OF CODE       @D52VDVB 06485001
         STM   R0,RF,PMRSAVE2     SAVE WORK REGISTERS          @D52GDWL 06486001
         L     RB,SCBPTR          ADDR OF SCB                  @D52GDWL 06487001
         B     PTASGX                                          @D52GDWL 06488001
         SPACE 1                                               @D52VDVB 06489001
*SGLINK  PTASG,S,INPUT=(R8:APMGMDAT,R9:BASE,RA:LINK,RB:SCB,RD),        *06490001
               WORK=(),AMODE=31 DATOFF                                  06491001
PTASG    STM   R0,RF,PMRSAVE2     SAVE WORK REGISTERS          @D51GDRP 06492001
PTASGX   BAL   RE,PDASFIND        FIND CORRECT PDASE           @D51IDRP 06493001
*SGLINK  PDASFIND INPUT=(RE),OUTPUT=(RF),WORK=(R0,RA,RD)       @D52VDRP 06494001
*   RF - ADDR OF PDASE                                         @D51GDRP 06495001
         USING PDASE,RF           SET BASE FOR PDASE           @D51GDRP 06496001
         MVI   PDASE,XFF          INDICATE BLOCK ALLOCATED     @D51GDRP 06497001
         DROP  RF                 DROP BASE FOR PDASE (REAL)   @D52VDRP 06498001
*  RF HAS STILL TO CONTAIN ADDRESS OF PDASE                    @D52VDRP 06499001
         TM    SUPFLAG,PMRINIT    PMR ALREADY INITIALIZED      @D52VDRP 06500001
         BZ    PTASGT1            NO, -------->                @D52VDRP 06501001
*        AMODESW SET,DAT=ON       ENTER VIRTUAL MODE (DAT=ON)  @D52VDRP 06502001
         AMODESW SET,DAT=ON                                    @D52VDRP 06503001
PTASGT1  DS    0H                                              @D52VDRP 06504001
         L     RC,PMRSAVE2+(RD-R0)*4 GET ADDR WITHIN BLOCK     @D51GDRP 06505001
*   GET ADDR OF CORRESPONDING STE                              @D51GDRP 06506001
         N     RC,PMSGMSK         SET IT ON SEGMENT BOUNDARY   @D51GDRP 06507001
         LR    RD,RC              SAVE IT FOR LATER USE        @D52VDRP 06508001
         SRL   RC,SNSHIFT-SNSTESH GET OFFSET IN SEGMENT TABLE  @D51GDRP 06509001
         LR    R4,RB              ADDR OF SCB                  @D52GDWL 06510001
         USING SCBADR,R4          SET BASE FOR SCB             @D52GDWL 06511001
         BAL   R2,CHKSAREX        GET SCB ADDR FOR PAGE        @D52GDWL 06512001
*SGLINK  CHKSAREX,INPUT=(R2,R4,RD),OUTPUT=(R4),WORK=(R3)       @D52GDWL 06513001
         L     RE,ASIDSTR         ADDRESS OF SPACE IDS         @D52VDRP 06514001
         USING SIDSTR,RE                                       @D52VDRP 06515001
         CLC   SCBID,SIDR         FOR PRIV. AREA IN SPACE R    @D52VDRP 06516001
         BNE   PTASGT1A           NO,  ---> O.K.               @D52VDRP 06517001
         BAL   R5,PMRHWERR        YES, ====> ERROR             @D52VDRP 06518001
         DROP  RE                 DROP BASE FOR SIDSTR         @D52VDRP 06519001
PTASGT1A DS    0H                                              @D52VDRP 06520001
         AL    RC,SCBVSTO         GET ADDR OF STE              @D51GDRP 06521001
         TM    SUPFLAG,PMRINIT    PMR ALREADY INITIALIZED      @D52VDRP 06522001
         BZ    PTASGT2            NO, -------->                @D52VDRP 06523001
         L     RE,SCBAPMRA        SWITCH TO PMRAS CONTAINING   @D52VDRP 06524001
*    SWITCH TO PMR ADDRESS SPACE, CONTAINING SGT, PT AND PTAS  @D52VDRP 06525001
*        SGSETUP SETSCB,NEXTSCB=RE,OPTION=SAVE,WR1=R4,WR2=R5   @D52VDRP 06526001
         SGSETUP SETSCB,NEXTSCB=RE,OPTION=SAVE,WR1=R4,WR2=R5   @D52VDRP 06527001
PTASGT2  DS    0H                                              @D52VDRP 06528001
         USING STE,RC                                          @D51GDRP 06529001
         TM    STEFLG,STEINV      IS PTAS SEGMENT ALLOCATED    @D51GDRP 06530001
         BZ    PTASG030           YES, BRANCH                  @D51GDRP 06531001
*   GET 1ST FREE PTAS ENTRY                                    @D51GDRP 06532001
         BAL   RE,EPACNVR2        CONVERT ADDR TO EPA          @D52VDRP 06533001
*SGLINK  EPACNVR2,INPUT=(R4,R8,RD,RE),WORK=(R5),OUTPUT=(RD)    @D52VDRP 06534001
         LR    R1,RD              GET EPA IN CORRECT REGISTER  @D52VDRP 06535001
         SRL   R1,PNSHIFT+PNBLSHFT-PTASSHFT GET OFFSET IN PTAS @D52VDRP 06536001
         A     R1,SCBAPTAS        GET ADDR OF PTASE            @D52VDRP 06537001
         USING PTASE,R1           SET BASE                     @D51GDRP 06538001
         OC    PTASE(LPTASG),PTASE IS SEGMENT FREE             @D51GDRP 06539001
         BZ    PTASG020           YES, O.K.                    @D52VDRP 06540001
         BAL   R5,PMRHWERR        NO, SYSTEM ERROR             @D52VDRP 06541001
* R1 CONTAINS ADDR OF FREE PTAS SEGMENT                        @D51GDRP 06542001
PTASG020 DS    0H                                              @D51GDRP 06543001
* !!!! HERE THE PT BEL. TO THE SEGMENT HAS TO BE INITIALIZED !!@D52VDRP 06544001
         SRL   RD,PTSHIFT         GET OFFSET IN PAGE TABLE     @D52VDRP 06545001
         A     RD,SCBAPT          GET ADDR OF 1ST PTE          @D52VDRP 06546001
         L     RE,PMSGSIZE        GET LENGTH OF PT             @D52VDRP 06547001
         SRL   RE,PTSHIFT         .... AREA                    @D52VDRP 06548001
         AR    RE,RD              ADDR OF LAST+1 PTE           @D52VDRP 06549001
* SET ALL PTE'S OF THIS SEGMENT INVALID                        @D52VDRP 06550001
         USING PTE,RD             SET BASE FOR PTE             @D52VDRP 06551001
PTASG025 MVC   PTE(LPTE),PMINVPTE SET ENTRY INVALID            @D52VDRP 06552001
         LA    RD,LPTE(,RD)       GET NEXT ENTRY               @D52VDRP 06553001
         CR    RD,RE              STILL IN AREA                @D52VDRP 06554001
         BL    PTASG025           YES, HANDLE IT               @D52VDRP 06555001
         BAL   RE,PTASSGMT        HANDLE STE                   @D51GDRP 06556001
         DROP  RC                 FORGET STE                   @D51GDRP 06557001
PTASG030 DS    0H                                              @D51GDRP 06558001
         L     RD,PMRSAVE2+(RD-R0)*4 GET ADDR WITHIN BLOCK     @D51GDRP 06559001
         N     RD,PMBLKMSK        SET IT ON BLOCK BOUNDARY     @D51EDRP 06560001
         BAL   RE,EPACNVR2        CONVERT IT TO EPA            @D51GDRP 06561001
*SGLINK  EPACNVR2,INPUT=(R4,R8,RD,RE),WORK=(R5),OUTPUT=(RD)    @D51GDRP 06562001
         LR    RC,RD              SAVE EPA                     @D51GDRP 06563001
         SRL   RD,PNSHIFT+PNBLSHFT-PTASSHFT GET OFFSET IN PTAS @D51GDRP 06564001
         A     RD,SCBAPTAS        GET ADDR OF CORRESP. PTASE   @D52VDRP 06565001
         DROP  R1                 FORGET BASE FOR PTASE        @D51GDRP 06566001
         SPACE 2                                                        06567001
*    RD POINTS TO FREE PTASE                                   @D51GDRP 06568001
         USING PTASE,RD                                        @D51GDRP 06569001
         OI    PTASFLG1,PTASUSED  INDICATE PTASE AS USED       @D52VDRP 06570001
         LR    RE,RF              GET ADDR OF PDASE            @D51GDRP 06571001
         S     RE,APDAS           GET OFFSET IN PDAS           @D51GDRP 06572001
         SLL   RE,PNBLSHFT        GET RECORD NUMBER ON PDS     @D51GDRP 06573001
.*DEL    SRL   RE,PDASSHFT                                     @D51GDRP 06574001
         ST    RE,PTASRECN        SET IT IN PTASE              @D51GDRP 06575001
         DROP  RD                 FORGET BASE FOR PTASE        @D52VDRP 06576001
         SPACE 1                                                        06577001
*    RESET PTENASS BIT IN PTE'S FOR ACTUAL BLOCK               @D51GDRP 06578001
         SRL   RC,PTSHIFT         OFFSET IN PAGE TABLE         @D51GDRP 06579001
         A     RC,SCBAPT          GET ADDR OF 1ST PTE          @D52VDRP 06580001
         LA    R0,NPAGPBLK        GET NUMBER OF PAGES IN BLOCK @D51GDRP 06581001
         USING PTE,RC                                          @D51GDRP 06582001
PTASG50  TM    PTESTAT,PTEIBIT    IS PAGE DISCONNECTED         @D52VDRP 06583001
.* PAGE MIGHT BE ADDRESSABLE IN CASE OF ALLOCATION OF PMR SPACE@D52VDRP 06584001
         BZ    PTASG51            NO, DON'T CHANGE PTE         @D52VDRP 06585001
         NI    PTESTAT,XFF-PTENASS INDICATE PTE AS ALLOCATED   @D51GDRP 06586001
PTASG51  LA    RC,LPTE(,RC)                                    @D51GDRP 06587001
         BCT   R0,PTASG50                                      @D51GDRP 06588001
         TM    SUPFLAG,PMRINIT    VIRT. ENV. ALREADY ESTABL.   @D52VDRP 06589001
         BZ    PTASG060           NO, DON'T SWITCH BACK        @D52VDRP 06590001
*    SWITCH BACK TO ORIGINAL SPACE                                      06591001
*        SGSETUP RESETSCB,WR1=R4,WR2=R5                        @D52VDRP 06592001
         SGSETUP RESETSCB,WR1=R4,WR2=R5                        @D52VDRP 06593001
PTASG060 DS    0H                                              @D52VDRP 06594001
*        AMODESW SET,DAT=OFF      ENTER REAL MODE (DAT=OFF)    @D52VDRP 06595001
         AMODESW SET,DAT=OFF                                   @D52VDRP 06596001
*                                 ENTER REAL MODE (DAT=OFF)    @D52VDRP 06597001
         LM    R0,RF,PMRSAVE2     RESTORE WORK REGISTERS       @D51GDRP 06598001
         BR    RA                 ==========>  RETURN TO CALLER@DA33314 06599001
         DROP  R4,RC              FORGET SCB, PTE              @D51GDRP 06600001
         SPACE 2                                                        06601001
*  SET STE ENTRY AND HANDLE COMMON SEGMENTS                    @D519DRP 06602001
*    CALLED BY: PTASG WITH AMODE(31),DATON                     @D529DRP 06603001
*    CALLS:     NONE                                           @D529DRP 06604001
*    INPUT:                                                    @D519DRP 06605001
*      R1 - ADDR OF PTASE BELONGING TO SEGMENT                 @D519DRP 06606001
*      R4 - ADDR OF SCB                                        @D519DRP 06607001
*      RC - ADDR OF STE                                        @D519DRP 06608001
*      RE - RETURN ADDR.                                       @D519DRP 06609001
*    WORK REGISTER:                                            @D519DRP 06610001
*      R0, R2, R3, R6, RD                                      @D519DRP 06611001
         USING PTASE,R1                                        @D51GDRP 06612001
         USING SCBADR,R4                                       @DA33314 06613001
         USING STE,RC                                          @D51GDRP 06614001
PTASSGMT LR    RD,RC              GIVEN STE POINTER            @DA33314 06615001
         S     RD,SCBVSTO         STE OFFSET IN CURRENT ST     @DA33314 06616001
         LR    R0,RD              REMEMBER FOR LATER           @DA33314 06617001
         SRL   RD,SNSTESH         CONVERT TO SEGMENT NUMBER    @DA33314 06618001
         OI    PTASFLG1,PTASUSED  INDICATE PTASE USED          @D52VDRP 06619001
         LR    R6,R1              GET PTAS ENTRY ADDRESS       @DA33314 06620001
         S     R6,SCBAPTAS        GET OFFSET IN PTAS           @D52VDRP 06621001
         SRL   R6,PTASSHFT        GET BLOCK NUMBER             @DA33314 06622001
         SLL   R6,PNBLSHFT+PNSHIFT-PTSHIFT GET OFFSET IN PT    @DA33314 06623001
         A     R6,SCBAPT          ADDRESS OF PAGE TABLE        @D52VDRP 06624001
         TM    SUPFLAG,PMRINIT    VIRT. ENV. ALREADY ESTABL.   @D52VDRP 06625001
         BZ    PTASSG10           NO, ADDR ALREADY REAL        @D52VDRP 06626001
*        GENSERV LRADBG,RREG=(R6),VADD=(R6),ERR=NADDR          @D52VDRP 06627001
         GENSERV LRADBG,RREG=(R6),VADD=(R6),ERR=NADDR          @D52VDRP 06628001
PTASSG10 TM    SCBFLG,SCBSHA      IS IT SHARED AREA            @D52VDRP 06629001
         BO    PTASSG70           YES, COMMON SEGMENT          @D51GDRP 06630001
*                                 NO,  PRIVATE SEGMENT         @D51GDRP 06631001
         ST    R6,STEPTO          SET PTO AND MAKE SEG VALID   @D51GDTP 06632001
         OI    STEPTL,STELENXA    SET UP LENGTH OF STE         @D51GDTP 06633001
         BR    RE                 =============>  RETURN       @D51GDRP 06634001
PTASSG70 BAL   R7,PTAUSG          HANDLE COMMON SEGMENT        @D52VDRP 06635001
         BR    RE                 =============>  RETURN       @D52VDRP 06636001
         DROP  R1                 DROP PTASE BASE              @D51GDRP 06637001
         DROP  RC,R4              FORGET STE AND SCB POINTERS  @DA33314 06638001
         SPACE 1                                                        06639001
*   HANDLE STE OF COMMON SEGMENT IN ALL ADDRESS SPACE SEGMENT  @D52VDRP 06640001
*   TABLES. COMMON ROUTINE FOR ASSIGN AND UNASSIGN             @D52VDRP 06641001
*     R0 - OFFSET OF STE IN SEGMENT TABLE                      @D52VDRP 06642001
*     R6 - ADDRESS OF REAL PAGE-TABLE (FOR ASSIGN FUNCTION)    @D52VDRP 06643001
*     R6 - 0                          (FOR ASSIGN FUNCTION)    @D52VDRP 06644001
*     R7 - RETURN ADDRESS                                      @D52VDRP 06645001
         SPACE 1                                                        06646001
PTAUSG   STM   R1,RF,PMRSAVLO     SAVE CALLERS REGISTER        @D52VDRP 06647001
         L     RD,ASCBATAB        POINT TO SCB ADDRESS TABLE   @D52VDRP 06648001
         USING SCBATAB,RD                                      @D51GDRP 06649001
         LA    RD,ASCBQB          SET START OF QUEUE POINTERS  @D52VDRP 06650001
         DROP  RD                 DROP SCBATAB BASE            @D52VDRP 06651001
         LA    R4,SCBCHNUM        GET NUMBER OF CHAINS         @D51IDRP 06652001
         B     PTAUSG15                                        @D52VDVB 06653001
PTAUSG10 LA    RD,4(,RD)          GET NEXT CHAIN START         @D52VDRP 06654001
PTAUSG15 L     R3,0(RD)           GET 1ST SCB IN CHAIN         @D52VDRP 06655001
         LTR   R3,R3              CHAIN EMPTY                  @D52VDRP 06656001
         BZ    PTAUSG29                                        @D52VDRP 06657001
         USING SCBADR,R3                                       @D52VDRP 06658001
PTAUSG20 DS    0H                                              @D52VDRP 06659001
         L     R5,SCBRSTO         GET REAL ADDRESS OF ...      @D52VDRP 06660001
         N     R5,PMCR1MSK        ... OF SEGMENT TABLE         @D52VDRP 06661001
         BZ    PTAUSG23           ---> SKIP, IF SPACE NOT ACT. @D52VDRP 06662001
*        AMODESW SET,DAT=OFF      ENTER REAL MODE              @D52VDRP 06663001
         AMODESW SET,DAT=OFF      ENTER REAL MODE              @D52VDRP 06664001
         AR    R5,R0              STE POINTER                  @DA33314 06665001
         USING STE,R5                                          @DA33314 06666001
         OI    STEFLG,STEINV      FLAG SEGMENT AS INVALID      @D52VDRP 06667001
         LTR   R6,R6              IS IT ASSIGN REQUEST         @D52VDRP 06668001
         BZ    PTAUSG23           NO, UNASSGIGN IS DONE        @D52VDRP 06669001
         ST    R6,STEPTO          SET PTO AND MAKE SEGM VALID  @D51GDTP 06670001
         OI    STEPTL,STELENXA    SET UP LENGTH                @D51GDTP 06671001
         OC    STEFLG,PMSTECOM    RESTORE COMMON SEGMENT BIT   @DA33314 06672001
         DROP  R5                 DROP BASE FOR STE            @DA33314 06673001
PTAUSG23 TM    SUPFLAG,PMRINIT    VIRT. ENV. ALREADY ESTABL.   @D52VDRP 06674001
         BZ    PTAUSG27           NO, LEAVE IT REAL            @D52VDRP 06675001
*        AMODESW SET,DAT=ON       ENTER VIRT. MODE AGAIN       @D52VDRP 06676001
         AMODESW SET,DAT=ON       ENTER VIRT. MODE AGAIN       @D52VDRP 06677001
PTAUSG27 L     R3,SCBFWPT         GET NEXT SCB IN CHAIN        @D52VDRP 06678001
         C     R3,0(RD)           END OF CHAIN REACHED         @D52VDRP 06679001
         BNE   PTAUSG20           NO, HANDLE THIS SPACE        @D52VDRP 06680001
PTAUSG29 BCT   R4,PTAUSG10        HANDLE NEXT CHAIN            @D52VDRP 06681001
         LM    R1,RF,PMRSAVLO     RESTORE CALLERS REGISTER     @D52VDRP 06682001
         BR    R7                 ============>  RETURN        @D52VDRP 06683001
         DROP  R3                 DROP BASE FOR SCB            @D52VDRP 06684001
         SPACE 2                                                        06685001
*   FIND PDASE  WITH MINIMUM PDAS SCAN NUMBER (DEVPDASA)       @D51GDRP 06686001
*     OUTPUT:                                                  @D51IDRP 06687001
*      RF - ADDR OF PDAS ENTRY TO BE USED                      @D51GDRP 06688001
         SPACE 1                                                        06689001
PDASFIND L     RD,ADEVCB          POINT TO FIRST DEVCB         @DA33314 06690001
         USING DEVCB,RD                                        @DA33314 06691001
         L     RA,PDAS#           INIT MAX NUMBER TO BE SCANNED@DA33314 06692001
         SLR   RF,RF              INIT.POINTER OF SELECT.DEVCB @DA33314 06693001
PDASFN10 DS    0H                                              @KY30015 06694001
*      GENSERV COMF,FIELD=DEVPDASA,REG=(RA),BC=BNH,LAB=PDASFN20        *06695001
               NUMBER SMALLER THAN CURRENT, IF NOT LOOK AT NEXT@KY30015 06696001
      GENSERV COMF,FIELD=DEVPDASA,REG=(RA),BC=BNH,LAB=PDASFN20 @KY30015 06697001
*      GENSERV TEST,FIELD=DEVPDASB,BC=BZ,LAB=PDASFN20,REG=(R0) ANY     *06698001
               PDAS ENTRIES TO BE SCANNED, BRANCH IF NOT       @D52VDVB 06699001
       GENSERV TEST,FIELD=DEVPDASB,BC=BZ,LAB=PDASFN20,REG=(R0) @D52VDVB 06700001
*      GENSERV GETF,FIELD=DEVPDASA,REG=(RA) UPDATE CURRENT MIN @KY30015*06701001
               ,                              NUMBER           @KY30015 06702001
       GENSERV GETF,FIELD=DEVPDASA,REG=(RA)                    @KY30015 06703001
         LR    RF,RD              REMEMBER SELECTED DEVCB      @DA33314 06704001
PDASFN20 L     RD,DEVCBNXT        POINT TO NEXT DEVCB          @DA33314 06705001
         C     RD,ADEVCB          END OF CHAIN                 @DA33314 06706001
         BNE   PDASFN10           IF NOT, LOOK AT NEXT DEVCB   @DA33314 06707001
         LTR   RF,RF              ANY DEVCB FOUND              @DA33314 06708001
         BNZ   PDASFN30           SKIP IF YES                  @DA33314 06709001
         BAL   R5,PMRHWERR        SYSTEM ERROR                 @DA33314 06710001
PDASFN30 DS    0H                                              @D51IDRP 06711001
         LR    RD,RF              POINT TO SELECTED DEVCB      @DA33314 06712001
.*DEL    SLL   RA,PDASSHFT        CONSIDER  LENGTH OF ENTRY    @DA33314 06713001
         A     RA,DEVAPDAS        START OF PDAS SCAN           @DA33314 06714001
*      GENSERV GETF,FIELD=DEVPDASB,REG=(R0) # OF PDAS ENTRIES  @KY30015*06715001
               ,                          TO BE SCANNED        @KY30015 06716001
       GENSERV GETF,FIELD=DEVPDASB,REG=(R0)                    @KY30015 06717001
         B     PDASFN41           SKIP FOR 1ST TIME            @KX40510 06718001
         USING PDASE,RA                                        @KX40510 06719001
PDASFN40 LA    RA,LPDASE(,RA)     ADDR NEXT PDASE              @KX40510 06720001
PDASFN41 CLC   PDASE,F0           CHECK ACTUAL PDASE           @DA33314 06721001
         BE    PDASFN50           IF FREE, LEAVE LOOP          @DA33314 06722001
         BCT   R0,PDASFN40        CHECK NEXT PDASE IF ANY      @DA33314 06723001
         B     PDASFN60           SKIP NEXT INSTRUCTION        @DA33314 06724001
PDASFN50 BCTR  R0,0               CORRECT REMAINING POSITIONS  @DA33314 06725001
PDASFN60 LR    RF,RA              SAVE ADDR OF ACTUAL PDASE    @KX40510 06726001
         DROP  RA                 DROP BASE FOR PDASE          @KX40510 06727001
         S     RA,DEVAPDAS        REL OFFSET OF ACTUAL PDASE,          *06728001
                                    = NUMBER OF PDASE'S ...    @D51GDRP 06729001
.*DEL    SRL   RA,PDASSHFT        NUMBER OF PDASE ...          @DA33314 06730001
         LA    RA,1(,RA)          ... TO BE SKIPPED NEXT TIME  @KX40510 06731001
*      GENSERV PUTF,FIELD=DEVPDASA,REG=(RA) SET NUMBER OF PDAS @KY30015*06732001
               ,         ENTRIES TO BE SKIPPED NEXT TIME       @KY30015 06733001
       GENSERV PUTF,FIELD=DEVPDASA,REG=(RA)                    @KY30015 06734001
*      GENSERV PUTF,FIELD=DEVPDASB,REG=(R0) SET NUMBER OF PDAS @KY30015*06735001
               ,         ENTRIES TO BE SCANNED NEXT TIME       @KY30015 06736001
       GENSERV PUTF,FIELD=DEVPDASB,REG=(R0)                    @KY30015 06737001
         USING PDASE,RF                                        @KX40510 06738001
         CLC   PDASE,F0           CHECK ACTUAL PDASE           @DA33314 06739001
         BNE   PDASFIND           IF NOT, TRY AGAIN            @DA33314 06740001
         BR    RE                 RETURN TO CALLER             @D51IDRP 06741001
         DROP  RD,RF              FORGET BASE FOR DEVCB,PDASE  @D51GDRP 06742001
         SPACE 2                                               @DA33314 06743001
*-------------------------------------------------------------*@DA33314 06744001
*        PTUSG - ROUTINE                                       @DA33314 06745001
*           UNASSIGNES A PAGE TABLE FROM A VALID SEGMENT       @DA33314 06746001
*        INPUT:                                                @DA33314 06747001
*           R8 - PMGMDATA ADDRESS                              @DA33314 06748001
*           RA - RETURN ADDRESS                                @DA33314 06749001
*           RB - ADDRESS OF SCB                                @D52GDWL 06750001
*           RC - VIRT. ADDR OF 1ST PAGE OF BLOCK               @DA33314 06751001
*        WORK REGISTER:                                        @DA33314 06752001
*           R0 - R7, RA - RF ALL SAVE AND RESTORED             @D519DRP 06753001
*        CALLED BY:                                            @DA33314 06754001
*           INVPAGE WITH AMODE(31),DATOFF                      @DA33314 06755001
*        CALLS: EPACNVR2, CHKSAREA WITH AMODE(31),DATON        @D529DRP 06756001
*-------------------------------------------------------------*@DA33314 06757001
         SPACE 1                                               @DA33314 06758001
*SGLINK  PTUSG,S,INPUT=(R8:APMGMDAT,R9:BASE,RA:LINK,RB:SCB,RC),WORK=(),*06759001
               AMODE=31 DATOFF                                          06760001
PTUSG    DS    0H                                              @D52VDRP 06761001
         STM   R0,RF,PMRSAVE2     SAVE WORK REGISTERS          @D51GDRP 06762001
*        AMODESW SET,DAT=ON       ENTER VIRTUAL MODE (DAT=ON)  @D52VDRP 06763001
         AMODESW SET,DAT=ON                                    @D52VDRP 06764001
         LR    R4,RB              ADDR OF SCB                  @D52GDWL 06765001
         USING SCBADR,R4                                       @D51GDRP 06766001
         BAL   R2,CHKSAREX        GET SCB ADDR FOR PAGE        @D52GDWL 06767001
*SGLINK  CHKSAREX,INPUT=(R2,R4,RD),OUTPUT=(R4),WORK=(R3)       @D52GDWL 06768001
         L     R2,SCBAPMRA        SWITCH TO PMRAS CONTAINING   @D52VDRP 06769001
*    SWITCH TO PMR ADDRESS SPACE, CONTAINING SGT, PT AND PTAS  @D52VDRP 06770001
*        SGSETUP SETSCB,NEXTSCB=R2,OPTION=SAVE,WR1=R4,WR2=R5   @D52VDRP 06771001
         SGSETUP SETSCB,NEXTSCB=R2,OPTION=SAVE,WR1=R4,WR2=R5   @D52VDRP 06772001
         LR    RD,RC                                                    06773001
         BAL   RE,EPACNVR2        GET CORRESP. EPA IN RD       @D51GDRP 06774001
*SGLINK  EPACNVR2,INPUT=(R4,R8,RD,RE),WORK=(R5),OUTPUT=(RD)    @D51GDRP 06775001
         ST    RD,PTUSGEPA        SAVE EPA FOR LATER USE       @D51GDRP 06776001
         L     RE,ASIDSTR         ADDRESS OF SPACE IDS         @DA40317 06777001
         USING SIDSTR,RE                                       @DA40317 06778001
         CLC   SCBID,SIDR         IS IT SPACE R (V=R)          @DA40317 06779001
         BNE   PTUSG005           NO,  --->                    @D52VDRP 06780001
         BAL   R5,PMRHWERR        YES, ERROR                   @D52VDRP 06781001
         DROP  RE                                              @DA40317 06782001
PTUSG005 DS    0H                                              @D52VDRP 06783001
         SRL   RD,PNSHIFT+PNBLSHFT-PTASSHFT GET OFFSET IN PTAS @D51GDRP 06784001
         A     RD,SCBAPTAS        ADDRESS OF PTAS SLOT         @D52VDRP 06785001
         USING PTASE,RD                                        @DA33314 06786001
         L     RC,PTASRECN        GET                          @D51GDRP 06787001
         SRL   RC,PNBLSHFT          CORRESP. PDAS              @D51GDRP 06788001
.*DEL    SLL   RC,PDASSHFT            PDAS                     @D51GDRP 06789001
         A     RC,APDAS                    SLOT                @D51GDRP 06790001
*        AMODESW SET,DAT=OFF      ENTER REAL MODE (DAT=OFF)    @D52VDRP 06791001
         AMODESW SET,DAT=OFF                                   @D52VDRP 06792001
*                                 ENTER REAL MODE (DAT=OFF)    @D52VDRP 06793001
         USING PDASE,RC           SET BASE FOR PDAS            @D51GDRP 06794001
         XC    PDASE(LPDASE),PDASE PDASE=0 : ASSOCIATED PAGE TABLE     *06795001
                                  ... BLOCK IS FREE            @DA33314 06796001
*        AMODESW SET,DAT=ON       ENTER VIRTUAL MODE (DAT=ON)  @D52VDRP 06797001
         AMODESW SET,DAT=ON                                    @D52VDRP 06798001
*                                 ENTER VIRTUAL MODE (DAT=ON)  @D52VDRP 06799001
         XC    PTASE(LPTASE),PTASE PTASE= 0: ASSOCIATED PAGE TABLE     *06800001
                                  ... BLOCK IS FREE            @DA33314 06801001
         DROP  RD                 FORGET BASE FOR PTASE        @DA33314 06802001
         L     RE,ADEVCB          POINT TO FIRST DEVCB         @DA33314 06803001
         USING DEVCB,RE                                        @DA33314 06804001
PTUSG010 LR    RF,RC              ADDRESS OF PDAS SLOT         @D51GDRP 06805001
         S     RF,DEVAPDAS        OFFSET WITHIN DEVICE RANGE   @DA33314 06806001
.*DEL    SRL   RF,PDASSHFT        CONVERT OFFSET TO NUMBER ...          06807001
.*DEL                             ... OF ENTRIES               @DA33314 06808001
*      GENSERV SUBF,FIELD=DEVPDASA,REG=(RF) REL.TO NUMBER TO BE SCANNED 06809001
       GENSERV SUBF,FIELD=DEVPDASA,REG=(RF)                    @KY30015 06810001
*      GENSERV COMF,FIELD=DEVPDASB,REG=(RF),BC=BL,LAB=PTUSG020         *06811001
               ,  WITHIN DEVICE RANGE, IF YES LEAVE LOOP       @KY30015 06812001
       GENSERV COMF,FIELD=DEVPDASB,REG=(RF),BC=BL,LAB=PTUSG020 @KY30015 06813001
         L     RE,DEVCBNXT        POINT TO NEXT DEVICE         @DA33314 06814001
         C     RE,ADEVCB          END OF CHAIN                 @DA33314 06815001
         BNE   PTUSG010           NO, CHECK NEXT DEVICE        @DA33314 06816001
         BAL   R5,PMRHWERR        YES, SYSTEM ERROR            @DA33314 06817001
PTUSG020 LTR   RF,RF              NEED TO UPDATE NUMBER TO BE ...      *06818001
                                  ... SCANNED                  @DA33314 06819001
         BNM   PTUSG025           SKIP IF NOT                  @DA33314 06820001
         DROP  RC                 DROP BASE FOR PDASE          @D51GDRP 06821001
*      GENSERV GETF,FIELD=DEVPDASB,REG=(RC) CURRENT SCAN NUMBER@KY30015 06822001
       GENSERV GETF,FIELD=DEVPDASB,REG=(RC) CURRENT SCAN NUMBER@KY30015 06823001
         SR    RC,RF              GET NEW SCAN NUMBER          @DA33314 06824001
*      GENSERV PUTF,FIELD=DEVPDASB,REG=(RC) SAVE NEW VALUE     @KY30015 06825001
       GENSERV PUTF,FIELD=DEVPDASB,REG=(RC) SAVE NEW VALUE     @KY30015 06826001
*      GENSERV ADDF,FIELD=DEVPDASA,REG=(RF) NEW # TO BE SKIPPED@KY30015 06827001
       GENSERV ADDF,FIELD=DEVPDASA,REG=(RF) NEW # TO BE SKIPPED@KY30015 06828001
*      GENSERV PUTF,FIELD=DEVPDASA,REG=(RF) SAVE NEW VALUE     @KY30015 06829001
       GENSERV PUTF,FIELD=DEVPDASA,REG=(RF) SAVE NEW VALUE     @KY30015 06830001
         DROP  RE                 DEVCB NOT NEEDED ANY MORE    @DA33314 06831001
         SPACE 1                                                        06832001
*    SET PTENASS BIT IN PTE'S FOR ACTUAL BLOCK                 @D519DRP 06833001
PTUSG025 DS    0H                                                       06834001
         L     R1,PTUSGEPA        GET EPA OF 1ST PAGE OF BLOCK @D51GDRP 06835001
         SRL   R1,PTSHIFT         GET OFFSET IN PAGE TABLE     @D51GDRP 06836001
         A     R1,SCBAPT          GET ADDR OF 1ST PTE          @D52VDRP 06837001
         LA    R0,NPAGPBLK        GET NUMBER OF PAGES IN BLOCK @D51GDRP 06838001
         USING PTE,R1                                          @D51GDRP 06839001
PTUSG026 OI    PTESTAT,PTENASS    INDICATE PTE AS UNASSIGNED   @D51GDRP 06840001
         LA    R1,LPTE(,R1)       GET NEXT PTE                 @D51GDRP 06841001
         BCT   R0,PTUSG026        HANDLE IT                    @D51GDRP 06842001
         DROP  R1                 DROP PTE BASE                @D51GDRP 06843001
         SPACE 1                                                        06844001
*    CHECK WHETHER WHOLE SEGMENT IS UNASSIGNED                 @D519DRP 06845001
         L     RD,PTUSGEPA        GET EPA OF 1ST PAGE OF BLOCK @D52VDRP 06846001
         N     RD,PMSGMSK         SET IT ON SEGMENT BOUNDARY   @D52VDRP 06847001
         SRL   RD,PTSHIFT         GET OFFSET IN PAGE TABLE     @D52VDRP 06848001
         A     RD,SCBAPT          GET ADDR OF 1ST PTE OF SEGM. @D52VDRP 06849001
         LR    R2,RD              SAVE IT FOR LATER USE        @D52VDRP 06850001
         LA    R0,NPAGPSEG        GET # OF PAGES PER SEGMENT   @D51GDRP 06851001
         USING PTE,RD                                          @D51GDRP 06852001
PTUSG027 TM    PTESTAT,PTENASS+PTEIBIT UNASSIGNED PAGE         @KX40523 06853001
         BNO   PTUSGEND           NO, LEAVE LOOP               @KX40523 06854001
         LA    RD,LPTE(,RD)       GET NEXT PTE                 @D51GDRP 06855001
         BCT   R0,PTUSG027        CHECK IT                     @D51GDRP 06856001
         DROP  RD                 DROP PTE BASE                @D51GDRP 06857001
*  ALL PAGES OF THE SEGMENT ARE UNASSIGNED, THEREFORE THE      @D519DRP 06858001
*     THE SEGMENT CAN BE SET INVALID                           @D519DRP 06859001
         SL    R2,SCBAPT          GET OFFSET WITHIN PAGE TABLE @D52VDRP 06860001
         SRL   R2,PNRPTOSH+PNBLSHFT-PTASSHFT OFFSET IN PTAS    @D51GDRP 06861001
         A     R2,SCBAPTAS        GET ADDR OF 1ST PTASE OF SEGM@D52VDRP 06862001
         USING PTASE,R2                                        @D51GDRP 06863001
         XC    PTASE(LPTASE),PTASE FREE PTASE EXPLICITELY      @D51GDRP 06864001
         DROP  R2                 DROP BASE FOR PTASE          @D51GDRP 06865001
         L     RC,PMRSAVE2+(RC-R0)*4 GET BEGIN OF BLOCK        @D51GDRP 06866001
*   GET ADDR OF CORRESPONDING STE                              @D52VDRP 06867001
         N     RC,PMSGMSK         SET IT ON SEGM. BOUNDARY     @D52VDRP 06868001
         SRL   RC,SNSHIFT-SNSTESH GET OFFSET IN SEGMENT TABLE  @D52VDRP 06869001
         TM    SCBFLG,SCBSHA      IS IT SHARED AREA            @D52VDRP 06870001
         BO    PTUSG030           YES, COMMON SEGMENT          @D52VDRP 06871001
*                                 NO, PRIVATE SEGMENT          @D51GDRP 06872001
         AL    RC,SCBVSTO         GET ADDR OF STE              @D52VDRP 06873001
         USING STE,RC                                          @D52VDRP 06874001
         OI    STEFLG,STEINV      FLAG SEGMENT AS INVALID      @DA33314 06875001
         B     PTUSGEND           ALL DONE                     @DA33314 06876001
PTUSG030 LR    R0,RC              SET OFFSET OF STE IN SGT     @D52VDRP 06877001
         SLR   R6,R6              INDICATE UNASSIGN FUNCTION   @D52VDRP 06878001
         BAL   R7,PTAUSG          DO UNASSIGM                  @D52VDRP 06879001
         DROP  R4                 DROP SCBADR                  @D51GDRP 06880001
         DROP  RC                 FORGET BASE FOR STE          @D51GDRP 06881001
PTUSGEND DS    0H                                              @D52VDRP 06882001
*    SWITCH BACK TO ORIGINAL SPACE                                      06883001
*        SGSETUP RESETSCB,WR1=R4,WR2=R5                        @D52VDRP 06884001
         SGSETUP RESETSCB,WR1=R4,WR2=R5                        @D52VDRP 06885001
*        AMODESW SET,DAT=OFF      ENTER REAL MODE (DAT=OFF)    @D52VDRP 06886001
         AMODESW SET,DAT=OFF                                   @D52VDRP 06887001
*                                 ENTER REAL MODE (DAT=OFF)    @D52VDRP 06888001
         LM    R0,RF,PMRSAVE2     RESTORE WORK REGISTERS       @DA33314 06889001
         BR    RA                 ==========>  RETURN TO CALLER@DA33314 06890001
         DROP  R9                 DROP BASE FOR CODE AREA      @D52VDRP 06891001
*                                                              @D52GDWL 06892001
*-------------------------------------------------------------*@D52GDWL 06893001
*                                                             *@D52GDWL 06894001
*   GET REAL ADDRESS ROUTINE                                  *@D52GDWL 06895001
*                                                             *@D52GDWL 06896001
*   THIS ROUTINE PERFORMS A SIMILAR FUNCTION AS THE LRA       *@D52GDWL 06897001
*   INSTRUCTION. IT CALCULATES FOR A GIVEN VIRTUAL ADDRESS    *@D52GDWL 06898001
*   THE REAL ADDRESS OF THE SGTE / PTE AND, IF THE PAGE IS    *@D52GDWL 06899001
*   ADDRESSABLE, THE PAGE FRAME ADDRESS. IT IS CALLED WHEN    *@D52GDWL 06900001
*   THE LRA INSTRUCTION IS NOT APPLICABLE BECAUSE THE VIRTUAL *@D52GDWL 06901001
*   ADDRESS REFERS TO AN ADDRESS/DATA SPACE THAT IS DIFFERENT *@D52GDWL 06902001
*   FROM THE PRIMARY ADDRESS SPACE.                           *@D52GDWL 06903001
*                                                             *@D52GDWL 06904001
*   INPUT:  R8 - BASE FOR DATA AREA (PMGMDATA)                *@D52GDWL 06905001
*           RA - RETURN ADDRESS                               *@D52GDWL 06906001
*           RB - REAL SCB ADDRESS, IF ENTERED VIA REALADR     *@D52GDWL 06907001
*              - VIRT. SCB ADDRESS, IF ENTERED VIA REALADV    *@D52GDWL 06908001
*           RD - VIRTUAL ADDRESS                              *@D52GDWL 06909001
*                                                             *@D52GDWL 06910001
*   OUTPUT: R4 - REAL ADDRESS OF SGTE OR PTE                  *@D52GDWL 06911001
*           RC - FRAME ADDRESS IF PAGE ADDRESSABLE            *@D52GDWL 06912001
*              - 0  IF PAGE IS INVALID                        *@D52GDWL 06913001
*              - 1  IF SEGMENT IS INVALID                     *@D52GDWL 06914001
*              - 2  IF SEGMENT TABLE LENGTH VIOLATION         *@D52GDWL 06915001
*                                                             *@D52GDWL 06916001
*   LINKAGE:                                                  *@D52GDWL 06917001
*   SGLINK  REALADR,INP=(R8,RA,RB,RD),OUTPUT=(R4,RC)          *@D52GDWL 06918001
*           WITH DAT=OFF AND AMODE=31                         *@D52GDWL 06919001
*                                                              @D52GDWL 06920001
*   RETURN:                                                    @D52GDWL 06921001
*           OFFSET 0  -  PAGE IS ADDRESSABLE                  *@D52GDWL 06922001
*           OFFSET 4  -  PAGE IS NOT ADDRESSABLE               @D52GDWL 06923001
*                                                              @D52GDWL 06924001
*-------------------------------------------------------------*@D52GDWL 06925001
*                                                              @D52GDWL 06926001
*SGLINK  REALADV,S,INPUT=(R8,RA,RB,RD),OUTPUT=(R4,RC),AMODE=31 DATOFF   06927001
REALADV  DS    0H                 ENTRY POINT FOR VIRT. SCB ADD@D52VDRP 06928001
         STM   R9,RB,PMRSAVLO+OFR9 SAVE REGISTERS              @D52VDRP 06929001
         L     R9,APMRSERV        SET BASE FOR THIS ROUTINE    @D52VDRP 06930001
         USING PMRSERV,R9                                      @D52VDRP 06931001
*        GENSERV LRADBG,RREG=(RB),VADD=(RB),ERR=NADDR          @D52VDRP 06932001
*                                 GET REAL ADDR OF SCB IN RB   @D52VDRP 06933001
         GENSERV LRADBG,RREG=(RB),VADD=(RB),ERR=NADDR          @D52VDRP 06934001
         B     LRA10              SKIP ENTRY POINT CODE        @D52VDRP 06935001
         SPACE 1                                                        06936001
*SGLINK  REALADR,S,INPUT=(R8,RA,RB,RD),OUTPUT=(R4,RC),AMODE=31 DATOFF   06937001
REALADR  DS    0H                 ENTRY POINT FOR REAL SCB ADDR@D52VDRP 06938001
         STM   R9,RB,PMRSAVLO+OFR9 SAVE REGISTERS              @D52VDRP 06939001
         L     R9,APMRSERV        SET BASE FOR THIS ROUTINE    @D52VDRP 06940001
LRA10    LR    RC,RD               VIRTUAL ADDRESS             @D52GDWL 06941001
*        TEST IF SEGMENT TABLE ENTRY EXISTS AND IF IT IS VALID @D52GDWL 06942001
         N     RC,PMSGMSK          GET SEGMENT TABLE INDEX     @D52GDWL 06943001
         LA    RC,0(RC)            RESET BIT ZERO              @D52GDWL 06944001
         SR    R4,R4               CLEAR                       @D52GDWL 06945001
         IC    R4,SCBXSTL-SCBADR(RB) GET MAX INDEX - 1 FOR XA  @D52GDWL 06946001
         LA    R4,1(R4)            MAX INDEX                   @D52GDWL 06947001
         SLL   R4,SNSHIFT+4        ADAPT IT TO SGTM INDEX      @D52GDWL 06948001
         CLR   RC,R4               IS INDEX WITHIN SGT ?       @KX40737 06949001
         BNL   LRA25               NO, SGT LENGTH VIOLATION    @D52GDWL 06950001
*                                                              @D52GDWL 06951001
*        GET REAL ADDRESS OF SEGMENT TABLE ENTRY               @D52GDWL 06952001
         SRL   RC,SNSHIFT-SNSTESH  OFFSET WITHIN SGT           @D52GDWL 06953001
         L     R4,SCBRSTO-SCBADR(RB) SEGMENT TABLE ...         @D52GDWL 06954001
         N     R4,PMCR1MSK         ... ORIGIN                  @D52GDWL 06955001
         AR    R4,RC               REAL SGTE ADDRESS           @D52GDWL 06956001
*                                                              @D52GDWL 06957001
         USING STE,R4              R4 IS BASE FOR SGT          @D52GDWL 06958001
         TM    STEFLG,STEINV       IS SEGMENT INVALID?         @D52GDWL 06959001
         BO    LRA30               YES                         @D52GDWL 06960001
         DROP  R4                  DROP SGT ADDRESSABILITY     @D52GDWL 06961001
*                                                              @D52GDWL 06962001
*        GET REAL ADDRESS OF PAGE TABLE ENTRY                  @D52GDWL 06963001
         L     R4,0(R4)            GET REAL ADDRESS...         @D52GDWL 06964001
         N     R4,PMSTEMSK         ... OF PAGE TABLE           @D52GDWL 06965001
         LR    RC,RD               VIRTUAL ADDRESS             @D52GDWL 06966001
         N     RC,PMSGDIS          GET PAGE OFFSET ...         @D52GDWL 06967001
         N     RC,PMPAGMSK         ... WITHIN                  @D52GDWL 06968001
         SRL   RC,PTSHIFT          ... PAGE TABLE              @D52GDWL 06969001
         AR    R4,RC               REAL ADDRESS OF PTE         @D52GDWL 06970001
*                                                              @D52GDWL 06971001
*        TEST IF PAGE TABLE ENTRY IS VALID                     @D52GDWL 06972001
         USING PTE,R4              R4 IS BASE FOR PTE          @D52GDWL 06973001
         TM    PTESTAT,PTEIBIT     IS PAGE ADDRESSABLE?        @D52GDWL 06974001
         BO    LRA35               NO                          @D52GDWL 06975001
*                                                              @D52GDWL 06976001
         L     RC,PTEFRA           FRAME ID XA MODE            @D52GDWL 06977001
         N     RC,EPADRMSK         EXTRACT ADDR OF PAGE FRAME  @D52GDWL 06978001
         DROP  R4                  RELEASE ADDRESSAB. OF PTE   @D52GDWL 06979001
         LM    R9,RB,PMRSAVLO+OFR9 RESTORE REGISTERS           @D52VDRP 06980001
         BR    RA                  =======> RETURN, OFFSET 0   @D52GDWL 06981001
*                                         PAGE IS ADDRESSABLE  @D52GDWL 06982001
*                                                              @D52GDWL 06983001
LRA25    LA    RC,2                SGT LENGTH VIOLATION        @D52GDWL 06984001
         B     LRA37                                           @D52GDWL 06985001
LRA30    LA    RC,1                INVALID SGT  R4=A(SGTE)     @D52GDWL 06986001
         B     LRA37                                           @D52GDWL 06987001
LRA35    SR    RC,RC               INVALID PAGE R4=A(PTE)      @D52GDWL 06988001
LRA37    LM    R9,RB,PMRSAVLO+OFR9 RESTORE REGISTERS           @D52VDRP 06989001
         B     4(RA)               =======> RETURN, OFFSET 4   @D52GDWL 06990001
*                                      PAGE IS NOT ADDRESSABLE @D52GDWL 06991001
         DROP  R8                 DROP BASE FOR DATA AREA      @D52VDRP 06992001
         DROP  R9                  RELEASE CODE BASE           @D52GDWL 06993001
         TITLE 'VSE/AF SUPERVISOR     SGPMR    CHECK FOR I/O ERROR'     06994001
*                                                              @D52GDWL 06995001
*-------------------------------------------------------------*@D52VDVB 06996001
*        ROUTINE PROLOGUE                                      @D52VDVB 06997001
*        ROUTINE NAME:  PMRIOERR                               @D52VDVB 06998001
*        MACRO:         SGPMR                                  @D52VDVB 06999001
*        FUNCTION: PROCESSES PAGE I/O ERRORS                   @D52VDVB 07000001
*        CALLED BY:  PMR WITH AMODE(31),DATON                  @D52VDRP 07001001
*        ENTRY POINT:                                          @D52VDVB 07002001
*               PMRIOERR                                       @D52VDVB 07003001
*        CALLED ROUTINE:                                       @D52VDVB 07004001
*               PMRIOBLK                      AMODE(31),DATOFF @D52VDRP 07005001
*        INPUT:                                                @D52VDVB 07006001
*               R7 - RETURN ADDRESS                            @D52VDVB 07007001
*               R8 - ADDR OF PAGEMANAGEMENT DATA-AREA          @D52VDVB 07008001
*               RB - ADDR DEVCB TO WHICH THE PAGE-OUT REQ.     @D52VDVB 07009001
*                    IS QUEUED                                 @D52VDVB 07010001
*               RC - ADDR OF IORE (PSEUDO TIB)                 @D52VDVB 07011001
*        OUTPUT:                                               @D52VDVB 07012001
*               -                                              @D52VDVB 07013001
*        EXIT:  RETURN TO CALLER WITH AMODE(31),DATON          @D52VDRP 07014001
*        RETURN CODE: NONE                                     @D52VDVB 07015001
*        EXIT ERROR:  PAGHWTF - HARD WAIT FF9                  @D52VDVB 07016001
*-------------------------------------------------------------*@D52VDVB 07017001
*   OPERATION:                                                 @D52VDVB 07018001
*      IORE.PGQTYP = OFF(PGIOERR); /* RESET ERROR INDICATION */@D52VDVB 07019001
*      DEVCCB.CCBCOM1 = OFF(TRABIT);                           @D52VDVB 07020001
*      IF CCBCOM1=DISERR | CCBSTA2=IL | CCBCOM2=NORCDFND       @D52VDVB 07021001
*       THEN                                                   @D52VDVB 07022001
*          IF IORE.PGQTYP = PGBLK                              @D52VDVB 07023001
*            THEN  CALL PMRIOBLK;  /*PROCESS BLOCKED PAGE I/O*/@D52VDVB 07024001
*            ELSE DO;                                          @D52VDVB 07025001
*              PFTE.PFTEFLG = PIOERR;/* INDICATE I/O IN PFTE */@D52VDVB 07026001
*              IF PFTE.S370FLG /= PFTEBLK                      @D52VDVB 07027001
*                THEN              /*  NOT BLOCKCONNECTED    */@D52VDVB 07028001
*                IF VPOOL-PAGE                                 @D52VDVB 07029001
*                  THEN VTABE.VTFL = VTPAGERR;                 @D52VDVB 07030001
*            END;                                              @D52VDVB 07031001
*      END (PMRIOERR);                                         @D52VDVB 07032001
*------------------------------------------------------------* @D52VDVB 07033001
*        INTERNAL USAGE OF REGISTERS                           @D52VDVB 07034001
*              R1 - ADDR OF CCB                                @D52VDVB 07035001
*              R4-R5, RA   WORKREGISTERS                       @D52VDVB 07036001
*              R8 - ADDR OF PAGE-MANAGEMENT DATA AREA          @D52VDVB 07037001
*              R9 - BASE OF ROUTINE                            @D52VDVB 07038001
*              RB - UNCHANGED (ADDR OF DEVCB)                  @D52VDVB 07039001
*              RC - ADDR OF IORE                               @D52VDVB 07040001
*-------------------------------------------------------------*@D52VDVB 07041001
         SPACE 1                                               @D52VDVB 07042001
*SGLINK  PMRIOERR,S,INPUT=(R7,R8,R9,RB,RC),                            *07043001
               NOMODR=(R7-RF),AMODE=31 DATON                            07044001
PMRIOERR DS    0H                                              @0000036 07045001
         USING PMGMDATA,R8                                     @D52GDRP 07046001
         STM   R7,RF,PMRSLEV0+OFR7                             @0000036 07047001
         BALR  R9,0               SET BASE FOR THESE ROUTINES  @D52GDRP 07048001
         USING *,R9                                            @D52GDRP 07049001
         USING TIBADR,RC          ADDRESSABILITY TO IORE       @0000036 07050001
         NI    PGQTYP,XFF-PGIOERR RESET ERROR IND. IN IORE     @D52GDRP 07051001
         USING DEVCB,RB           ADDRESSABILITY TO DEVCB      @0000036 07052001
         LA    R1,DEVCCB          GET CCB ADDR                 @D52VDRP 07053001
         USING CCBADR,R1                                       @D14BDRP 07054001
         NI    CCBCOM1,XFF-TRABIT RESET I/O COMPLETE           @D14BDRP 07055001
         TM    CCBCOM1,DISERR     UNREC.I/O ERROR                       07056001
         BO    PMRIOC10           YES  --------->              @DA39188 07057001
         TM    CCBSTA2,IL         INCORRECT LENGTH?            @DA39188 07058001
         BO    PMRIOC10           YES, --------->              @DA39188 07059001
         TM    CCBCOM2,NORCDFND   NO RECORD FOUND COND.                 07060001
         BZ    PMRIOCEX           NO, ---------->              @D52VDVB 07061001
PMRIOC10 OI    PGQTYP,PGIOERR     INDICATE I/O ERROR           @0000036 07062001
         TM    PGQTYP,PGBLK       BLOCKED PAGE I/O             @0000036 07063001
         BZ    PMRIOC80           NO, ---------->              @0000036 07064001
         BAL   RA,PMRIOBLK        HANDLE ERROR BLOCKED I/O     @0000036 07065001
*SGLINK  PMRIOBLK,INPUT=(R8,R9,RA,RB),                                 *07066001
               NOMODR=(R6-RF),AMODE=31 DATON                            07067001
         B     PMRIOCEX           EXIT ---------->             @0000036 07068001
         SPACE 1                                               @0000036 07069001
PMRIOC80 L     R4,TIBSTATE        ADDR(PFTE) FOR UNBL PGOUT    @D52VDVB 07070001
         TM    PGQTYP,PGO         PAGE-OUT                     @0000036 07071001
         BO    PMRIOC85           YES ---------->              @0000036 07072001
         L     R4,PGINF           ADDR(PFTE) FOR UNBL PGIN     @0000036 07073001
PMRIOC85 DS    0H                                              @0000036 07074001
*        AMODESW SET,DAT=OFF      SWITCH IN REAL MODE          @0000036 07075001
         AMODESW SET,DAT=OFF      SWITCH IN REAL MODE          @0000036 07076001
         USING PFTE,R4                                         @0000036 07077001
         OI    PFTEFLG,PIOERR     INDICATE I/O ERROR           @0000036 07078001
*   CHECK WHETHER VPOOL REQUEST AND SET ERROR IND. IN VTABE    @D52GDRP 07079001
         TM    S370FLG,PFTEBLK    ONLY BLOCK CONNECTED TO FRAME@D52VDRP 07080001
*        AMODESW SET,DAT=ON       SWITCH IN VIRT. MODE AGAIN   @0000036 07081001
         AMODESW SET,DAT=ON       SWITCH IN VIRT. MODE AGAIN   @0000036 07082001
         DROP  R4                 DROP BASE FOR PFTE (REAL)    @D52VDRP 07083001
         BO    PMRIOCEX           YES, ---------> EXIT         @D52VDRP 07084001
         ICM   R5,15,PFVTABE      IS IT VPOOL PAGE             @D52GDRP 07085001
         BNP   PMRIOC90           NO, ----->                   @D52GDRP 07086001
*     INDICATE I/O ERROR IN VTAB ENTRY                         @D14BDRP 07087001
         USING VTABE,R5                                        @D14BDRP 07088001
         OI    VTFLG,VTPAGERR     INDICATE PAGE IN ERROR       @D14BDRP 07089001
         B     PMRIOCEX           -------> EXIT                @D52GDRP 07090001
         DROP  R5                                              @D14BDRP 07091001
         SPACE 2                                                        07092001
PMRIOC90 DS    0H                                              @D52GDRP 07093001
         L     RA,PFSCB           ADDR OF SCB                  @D52GDWL 07094001
         USING SCBADR,RA          SET BASE FOR SCB             @D52GDWL 07095001
         TM    SCBFLG,SCBDSP      DATA SPACE INVOLVED?         @D52GDWL 07096001
         BZ    PMRIOC91           NO, BRANCH                   @D52GDRP 07097001
         TM    DSCBFLGS,DSCBVDSK  DATA SPACE FOR VIRTUAL DISK? @D52GDWL 07098001
         BO    PMRIOCEX           YES, ---------> EXIT         @D52GDRP 07099001
         B     PMRIOCEX           CANCEL FOR DATA SPACE ERROR  @D52GDRP 07100001
         DROP  RA                 RELEASE SCB ADDRESSAB.       @D52GDWL 07101001
PMRIOC91 BAL   R5,PAGHWTF9        REPLACE BAL BY NOP, IF YOU WANT TO   *07102001
               CANCEL USER FOR PAGE I/O ERROR                  @D52GDRP 07103001
         DROP  RC                 DROP BASE FOR IORE           @0000036 07104001
         DROP  RB                 DROP BASE FOR DEVCB          @0000036 07105001
         DROP  R1                 DROP BASE FOR CCB            @D52VDVB 07106001
*                                                              @D52GDWL 07107001
PMRIOCEX DS    0H                                              @D52VDRP 07108001
         LM    R7,RF,PMRSLEV0+OFR7                             @0000036 07109001
         BR    R7                 EXIT PMRIOERR =============> @0000036 07110001
         EJECT                                                          07111001
*-------------------------------------------------------------*@D52VDVB 07112001
*        ROUTINE PROLOGUE                                      @D52VDVB 07113001
*        ROUTINE NAME:  PMRIOBLK                               @D52VDVB 07114001
*        MACRO:         SGPMR                                  @D52VDVB 07115001
*        FUNCTION: PROCESSES PAGE I/O ERRORS / BLOCKED PAGING  @D52VDVB 07116001
*        CALLED BY:  PMRIOERR WITH AMODE(31),DATON             @D52VDRP 07117001
*        ENTRY POINT:                                          @D52VDVB 07118001
*               PMRIOBLK                                       @D52VDVB 07119001
*        CALLED ROUTINE:                                       @D52VDVB 07120001
*               -                                              @D52VDRP 07121001
*        INPUT:                                                @D52VDVB 07122001
*               R7 - RETURN ADDRESS                            @D52VDVB 07123001
*               R8 - ADDR OF PAGEMANAGEMENT DATA-AREA          @D52VDVB 07124001
*               RB - ADDR DEVCB TO WHICH THE PAGE-OUT REQ.     @D52VDVB 07125001
*                    IS QUEUED                                 @D52VDVB 07126001
*               RC - ADDR OF IORE (PSEUDO TIB)                 @D52VDVB 07127001
*        OUTPUT:                                               @D52VDVB 07128001
*               -                                              @D52VDVB 07129001
*        EXIT:  RETURN TO CALLER WITH AMODE(31),DATON          @D52VDRP 07130001
*        RETURN CODE: NONE                                     @D52VDVB 07131001
*        EXIT ERROR:  NONE                                     @D52VDVB 07132001
*-------------------------------------------------------------*@D52VDVB 07133001
*    OPERATION:                                                @D52VDVB 07134001
*        IF IORE.PGQTYP = PGIN                                 @D52VDVB 07135001
*           THEN DVCB.DEVERIN = DVCB.DEVERIN+1;                @D52VDVB 07136001
*           ELSE DVCB.DEVEROUT = DVCB.DEVEROUT+1;              @D52VDVB 07137001
*        /*DETERMINE ADDRESS OF FAILING PFTE IN IORE.TIBAPFT*/ @D52VDVB 07138001
*        IF IORE.PGQTYP=PGO & IORE.TIBSTATE /= 0               @D52VDVB 07139001
*           THEN            /* IN CASE OF UNCOND BLK PGO ALL*/ @D52VDVB 07140001
*             IORE.TIBERPFT = ADDR(IORE.TIBAPFT);/*PFTES ARE*/ @D52VDVB 07141001
*                           /* BE RESET -> UNBLOCKED I/O    */ @D52VDVB 07142001
*           ELSE                                               @D52VDVB 07143001
*             IORE.TIBERPFT = ADDR(IORE.TIBAPFT)               @D52VDVB 07144001
*                      + ((DVCB.DEVCCB(NEXTCCW)-8-BEG_CCWS)/2; @D52VDVB 07145001
*                           /* BEGIN OF PFTE ADDRESS LIST + */ @D52VDVB 07146001
*                           /*   OFFSET OF FAILING CCW / 2  */ @D52VDVB 07147001
*        /* INDICATE I/O ERROR IN PFTE                      */ @D52VDVB 07148001
*        DO FOR I = (IORE.TIBERPFT-IORE.TIBAPFT+4)/4 TO 8;     @D52VDVB 07149001
*           IF IORE.TIBAPFT(I) &NE. 0                          @D52VDVB 07150001
*             THEN                                             @D52VDVB 07151001
*                IORE.TIBAPFT(I) -> PFTE.PFTEFLG = PIOERR;     @D52VDVB 07152001
*        END DO FOR;                                           @D52VDVB 07153001
*       END;                                                   @D52VDVB 07154001
*    END (PMRIOBLK);                                           @D52VDVB 07155001
*-------------------------------------------------------------*@D52VDVB 07156001
         SPACE 1                                               @D52VDVB 07157001
*SGLINK  PMRIOBLK,S,INPUT=(R8,R9,RA,RB),                               *07158001
               NOMODR=(R6-RF),AMODE=31 DATON                            07159001
PMRIOBLK DS    0H                                              @0000036 07160001
         STM   R7,RF,PMRSLEV2+OFR7                             @0000036 07161001
         USING TIBADR,RC          ADDRESSABILITY TO IORE       @0000036 07162001
         USING DEVCB,RB           ADDRESSABILITY TO DEVCB      @0000036 07163001
         SPACE 1                                                        07164001
*     DETERMINATION OF FAILING CCW                             @0000036 07165001
         SPACE 1                                                        07166001
         SLR   R5,R5              OFFSET OF ADDR OF FIRST PFTE @0000036 07167001
         ICM   R5,7,DEVCCB+CCBCSWW-CCBADR                      @0000036 07168001
         SL    R5,F8              ADDRESS OF FAILING CCW       @0000036 07169001
         TM    PGQTYP,PGIN        BLOCKED PAGE-IN              @0000036 07170001
         BZ    PMRBLK20           NO, ---------->              @0000036 07171001
*     BLOCKED PAGE-IN                                          @0000036 07172001
*        GENSERV INC,FIELD=DEVERIN,REG=(R0)                    @0000036 07173001
         GENSERV INC,FIELD=DEVERIN,REG=(R0)                    @0000036 07174001
         B     PMRBLK30                                        @0000036 07175001
*     BLOCKED PAGE-OUT                                         @0000036 07176001
PMRBLK20 DS    0H                                              @0000036 07177001
*        GENSERV INC,FIELD=DEVEROUT,REG=(R0)                   @0000036 07178001
         GENSERV INC,FIELD=DEVEROUT,REG=(R0)                   @0000036 07179001
         L     RF,TIBSTATE                                     @0000036 07180001
         LTR   RF,RF              UNCONDITIONAL PAGE-OUT       @0000036 07181001
         BNZ   PMRBLK40           YES, --------->                      *07182001
                                  ALL PFTE'S ARE AFFECTED      @0000036 07183001
         CLI   DEVCBTYP,AVRFBA    FBA DEVICE                   @0000036 07184001
         BE    PMRBLK30           YES, --------->              @0000036 07185001
         CLI   DEVCBTYP,AVRECKD   ECKD DEVICE                  @0000036 07186001
         BE    PMRBLK30           YES, --------->              @0000036 07187001
*     ADJUSTMENTS FOR CKD/RPS                                  @0000036 07188001
         LA    RF,CKDGENWR                                     @0000036 07189001
         SR    R5,RF              OFFSET IN CKD/RPS WRITE CCWS @0000036 07190001
         BM    PMRBLK40           NO WRITE CCW, ---------->            *07191001
                                  ALL PFTE'S ARE AFFECTED      @0000036 07192001
         SLR   R4,R4                                           @0000036 07193001
         D     R4,PMRF24          NUMBER OF WRITE CCW          @0000036 07194001
         LTR   R4,R4              REALLY WRITE                 @0000036 07195001
         BZ    PMRBLK25           YES, -------->               @0000036 07196001
         LA    R5,1(,R5)          ADJUST TO NEXT WRITE                 *07197001
                                  ERROR IN SEARCH OR TIC       @0000036 07198001
PMRBLK25 SLL   R5,2               NBR OF WRITE CCW * 4 ...     @0000036 07199001
*                                 = RELATIVE OFF OF PFTE IN    @0000036 07200001
*                                 ..TIBAPFT CORESEPONDING TO   @0000036 07201001
*                                 ..FAILING CCW                @0000036 07202001
         B     PMRBLK50                                        @0000036 07203001
         SPACE 1                                               @0000036 07204001
PMRBLK30 LA    RF,CKDGENRD                                     @0000036 07205001
         SR    R5,RF              FAILURE IN READ/WRITE CCWS   @0000036 07206001
         BNP   PMRBLK40           NO,  ---------->                     *07207001
                                  ALL PFTE'S ARE AFFECTED      @0000036 07208001
         SRL   R5,1               NBR OF CCW * 4               @0000036 07209001
*                                 = RELATIVE OFF OF PFTE IN    @0000036 07210001
*                                 ..TIBAPFT CORESEPONDING TO   @0000036 07211001
*                                 ..FAILING CCW                @0000036 07212001
         B     PMRBLK50                                        @0000036 07213001
PMRBLK40 SLR   R5,R5              RELATIVE OFFS OF 1ST PFTE    @0000036 07214001
PMRBLK50 SLR   R4,R4                                           @0000036 07215001
         IC    R4,DEVCPSL         GET I/O-EFFECTIVE PSLSTATE   @0000036 07216001
*        GENSERV PGONT,PSLVAL=(R4),PGONT=(RF) GET RELATED PREPGENT      07217001
*              TO CONSIDER RELATIVE ADDRESS OF FIRST PFTE      @0000036 07218001
*              SAME FOR PAGE-IN AND PAGE-OUT                   @0000036 07219001
         GENSERV PGONT,PSLVAL=(R4),PGONT=(RF)                  @0000036 07220001
         LR    R4,R5                                           @0000036 07221001
         USING PREPGENT,RF        ADDRESSABILITY PREPGENT      @0000036 07222001
         AL    R5,PREPGOFF        RELATIVE OFFS OF FAILING PFTE@0000036 07223001
         SRL   R4,2               NO OF FAILING PFTE IN TIBAPFT@0000036 07224001
         LH    RF,PREPGBLK        TOTAL NBR OF BLOCKS          @0000036 07225001
         DROP  RF                 RESET ADDRESSABILITY PREPGENT@0000036 07226001
         SLR   RF,R4              NBR OF PFTE-S TO BE HANDLED  @0000036 07227001
*        AMODESW SET,DAT=OFF      SWITCH IN REAL MODE          @0000036 07228001
         AMODESW SET,DAT=OFF      SWITCH IN REAL MODE          @0000036 07229001
PMRBLK60 L     R4,TIBAPFT(R5)     ADDRESS OF CURRENT PFTE      @0000036 07230001
         LTR   R4,R4              ANY PFTE AVAILABLE           @0000036 07231001
         BZ    PMRBLK70           NO,  --------->              @0000036 07232001
         USING PFTE,R4                                         @0000036 07233001
         OI    PFTEFLG,PIOERR     INDICATE I/O ERROR           @0000036 07234001
         DROP  R4                                              @0000036 07235001
PMRBLK70 LA    R5,4(,R5)          NEXT SLOT IN TIBAPFT ADDRLIST@0000036 07236001
         BCT   RF,PMRBLK60        TRY NEXT ONE                 @0000036 07237001
         DROP  RC                 DROP BASE FOR IORE           @0000036 07238001
         DROP  RB                 DROP BASE FOR DEVCB          @0000036 07239001
*        AMODESW SET,DAT=ON       SWITCH IN VIRTUAL MODE AGAIN @0000036 07240001
         AMODESW SET,DAT=ON       SWITCH IN VIRTUAL MODE AGAIN @0000036 07241001
         LM    R7,RF,PMRSLEV2+OFR7                             @0000036 07242001
         BR    RA                 EXIT PMRIOBLK ============>  @0000036 07243001
         DROP  R8                 DROP BASE FOR DATA AREA      @D52GDRP 07244001
         DROP  R9                 DROP BASE FOR CODE AREA      @D52GDRP 07245001
         SPACE 1                                                        07246001
PMRF24   DC    F'24'                                           @0000036 07247001
*-------------------------------------------------------------*@D52VDVB 07248001
         TITLE 'VSE/AF SUPERVISOR     SGPMR     PAGE MANAGEMENT (PSEUDO*07249001
                PAGE FAULT HANDLING)'                          @D14ZDRP 07250001
*---------------------------------------------------------------------* 07251001
*                                                                     * 07252001
*   LINKAGE ENHANCEMENT PSEUDO PAGE FAULT PROCESSING ROUTINES         * 07253001
*                                                                     * 07254001
*        CALLED BY: SGPCK WITH AMODE(31),DATON                 @D529DRP 07255001
*        CALLED ROUTINES:                                      @D529DRP 07256001
*              SPGENENT, RPOST, UNPOST WITH AMODE(31),DATON    @D529DRP 07257001
*        EXIT: TO DISP, ALLBOUND WITH AMODE(24),DATON          @D529DRP 07258001
*        INPUT: R9 - A(VMPF)                                   @D369DRP 07259001
*               RC - ADDR OF PAGE MANAGEMENT DATA AREA                * 07260001
*               TRADDR - PAGE FAULT ADDRESS                           * 07261001
*               BIT 0 (TRADDR) - 0, IF COMPLETION INTERRUPT           * 07262001
*               BIT 0 (TRADDR) - 1, IF PAGEFAULT INTERRUPT            * 07263001
*                                                                     * 07264001
*---------------------------------------------------------------------* 07265001
         SPACE 1                                               @D14CDVB 07266001
*SGLINK  VMPF,S,INPUT=(R9:BASE,RC:APMGMDAT),AMODE=31 DATON     @D61RDRP 07267001
VMPF     DS    0H                                              @D14CDVB 07268001
         USING *,R9                                            @D36IDFR 07269001
         USING PMGMDATA,RC                                     @D36IDFR 07270001
         L     RB,TRADDR          GET PAGE FAULT ADDRESS       @D14CDVB 07271001
         N     RB,PMPAGMSK        ALIGN ON PAGE BOUNDARY       @D14CDVB 07272001
         LTR   RB,RB              COMPLETION INTERRUPT         @D14CDVB 07273001
         BNM   VMNORM             NO ----->                    @D14CDVB 07274001
         CL    RB,PREV            COMPLETION SAME AS LAST ONE  @D14CDVB 07275001
         BE    VMEXITP            YES ---->                    @D14CDVB 07276001
         SPACE                                                          07277001
VMNORM   CLI   RID+1,DISPID       IS DISPATCHER WORKING        @D14CDVB 07278001
         BNE   VMSAVE             NO -SAVE INTERUPT INFO.      @D34NE58 07279001
         LTR   RB,RB              COMPLETITION                 @D14CDVB 07280001
         BM    VMCOMP             YES ----->                   @D14CDVB 07281001
*      PAGE FAULT OCCURED AT DISABLE IN DISPATCHER             @D369DRP 07282001
         NI    PCOLDPS,DISABLE    DISABLE PROGR. CHECK OLD PSW @D14CDVB 07283001
VMEXITP  LM    R9,RD,ERA          RELOAD REGS                  @D14CDVB 07284001
         LPSW  PCOLDPS            ==========>  RETURN TO DISP          *07285001
                                               NOW DISABLED    @D14CDVB 07286001
         SPACE 1                                                        07287001
VMSAVE   LA    RC,PCOLDPS         ADDRESS OF PCK.OLD PSW       @D14CDVB 07288001
         L     RD,AFLIH           GET BASE FOR SPGENENT        @D36IDRP 07289001
         ST    RB,TRADDR          RESTORE ALIGN. PAGEFAULT ADDR@D14CDVB 07290001
         USING FLIH,RD                                         @D36IDRP 07291001
         BAL   R9,SPGENENT        SAVE INTERUPT STATUS         @D36IDRP 07292001
*SGLINK  SPGENENT,INPUT=(R9,RC,RD),OUTPUT=(R6:DISP,RA),WORK=(RB)        07293001
         DROP  RD                                              @D36IDRP 07294001
*   R6 - NOW CONTAINS ADDRESS OF DISPATCHER                    @D36IDRP 07295001
         USING DISP,R6                                         @D61NDRP 07296001
         L     RC,APMGMDAT        RELOAD RC                    @D36IDFR 07297001
         L     R9,AVMPF           RELOAD R9                    @D36IDFR 07298001
         L     RB,TRADDR          GET  PAGE FAULT ADDRESS      @D14CDVB 07299001
         LTR   RB,RB              COMPLETION                   @D14CDVB 07300001
         BM    VMCOMP1            YES ----->                   @D64ADOW 07301001
         CLC   IJBICPIK,F0        ICCF ACTIVE                  @D52VDRP 07302001
         BE    VMTRADD            NO ----->                    @D14CDVB 07303001
         L     RD,IJBETSS         ADDRESS (ICCF VECTOR TABLE)  @D14CDVB 07304001
         USING DTSVECDS,RD        ESTABLISH ADDRESSABILITY     @D14CDVB 07305001
         CLC   TID,DTSHTID        ICCF HIGH PRIOR TASK RUNNING @D14CDVB 07306001
         BE    VMICCFBD           YES ----->                   @D14CDVB 07307001
         DROP  RD                                              @D14CDVB 07308001
         SPACE 1                                                        07309001
*-------------------------------------------------------------*@D149DVB 07310001
* ROUTINE HANDLES VM PSEUDO PAGE FAULT EXCEPTIONS.             @D149DVB 07311001
* IT ENTERS EACH EXCEPTION INTO THE PSEUDO PAGE-FAULT QUEUE    @D149DVB 07312001
* SETS TASK NEEDING TO PMRBND                                  @D149DVB 07313001
*        INPUT:                                                @D369DRP 07314001
*           R1 - ADDR OF PAGE BELONGING TO PSEUDO PAGE-FAULT   @D369DRP 07315001
*           R5 - ADDR OF PSEUDO PAGE-FAULT QUEUE               @D369DRP 07316001
*           R6 - ADDR OF DISPATCHER                            @D149DVB 07317001
*-------------------------------------------------------------*@D149DVB 07318001
VMTRADD  LA    R1,0(,RB)          RESET FIRST BYTE/BIT         @D14CDVB 07319001
         L     R5,ASRQTAB         GET ADDRESS OF ...           @D61RDRP 07320001
         LA    R5,SRQPSPF-SRQTAB(,R5) ... RESOURCE QUEUE       @D61RDRP 07321001
         OI    PREV3,FLTFLG       INDICATE FAULT BEFORE NEXT   @D34NE58 07322001
*                                 COMPLETION                   @D34NE58 07323001
*SGLINK  UNPOST,INPUT=(R1,R5,R6,RF),WORK=(R5,RE)               @D369DRP 07324001
         BAL   RF,UNPOST          MAKE TASK UNDISPATCHABLE     @D36IDRP 07325001
         AMODESW RETURN,REG=(R6)  ==========> RETURN TO DISP.  @D52VDRP 07326001
         SPACE 1                                                        07327001
*-------------------------------------------------------------*@D149DVB 07328001
* ROUTINE HANDLES VM PSEUDO PAGE FAULT COMPLETION EXCEPTIONS.  @D149DVB 07329001
* THE WAITING TASKS ARE POSTED                                 @D149DVB 07330001
*        INPUT:                                                @D369DRP 07331001
*           R1 - ADDR OF PAGE BELONGING TO PSEUDO PAGE-FAULT   @D369DRP 07332001
*           R5 - ADDR OF PSEUDO PAGE-FAULT QUEUE               @D369DRP 07333001
*           R6 - ADDR OF DISPATCHER                            @D149DVB 07334001
*-------------------------------------------------------------*@D149DVB 07335001
VMCOMP   L     R6,DISPAD          BASE ADDR OF DISPATCHER      @D64ADOW 07336001
VMCOMP1  LA    R1,0(,RB)          RESET FIRST BYTE/BIT         @D64ADOW 07337001
         L     R5,ASRQTAB         GET ADDRESS OF ...           @D61RDRP 07338001
         LA    R5,SRQPSPF-SRQTAB(,R5) ... RESOURCE QUEUE       @D61RDRP 07339001
*SGLINK  RPOST,INPUT=(R1,R5,R6,RF),WORK=(R5,RE)                @D369DRP 07340001
         BAL   RF,RPOST           POST TASKS WAITING FOR PAGE  @D36IDRP 07341001
         ST    RB,PREV            SET PREV COMP = THIS ONE     @D14CDVB 07342001
         AMODESW RETURN,REG=(R6)  ==========> RETURN TO DISP.  @D52VDRP 07343001
         SPACE 1                                               @D14CDVB 07344001
*-------------------------------------------------------------*@D14CDVB 07345001
VMICCFBD MVI   RID+1,DISPID       PROVIDE DISP RID FOR ALLBOUND@D14CDVB 07346001
*        AMODESW BRANCH,AMODE=24,ADDRESS=ALLBND,REG=(RD)               *07347001
                                  ==========>  EXIT ALLBOUND   @D52VDRP 07348001
         AMODESW BRANCH,AMODE=24,ADDRESS=ALLBND,REG=(RD)       @D52VDRP 07349001
*     ICCF HIGH PRIOR. TASK MUST NOT BE SET IN WAIT STATE      @D14CDVB 07350001
         SPACE 1                                               @D14CDVB 07351001
         DROP  R6                DROP BASE FOR DISP            @D36IDFR 07352001
         DROP  R9,RC             DROP BASE FOR CODE AND DATA   @D36IDFR 07353001
.* ------------------------------------------------------------@D35NDRP 07354001
         TITLE 'VSE/AF SUPERVISOR     SGPMR     PAGE MANAGEMENT (INVPAG*07355001
               E ROUTINE)'                                     @D61NDRP 07356001
*-------------------------------------------------------------*@D14ZDVB 07357001
*                                                                       07358001
*        ROUTINE PROLOGUE                                               07359001
*        ROUTINE NAME= INVPAGE                                          07360001
*        MACRO=        SGPMR                                            07361001
*        FUNCTION= CHANGES THE PAGE-STATE OF THE PAGES SPECIFIED BY THE 07362001
*                  PARAMETER REGISTERS TO DISCONNECTED WITH NO COPY ON  07363001
*                  PDS OR INACTIVE AND UPDATES THE STORAGE KEY @D14NDFG 07364001
*        ENTRY POINTS:                                                  07365001
*           INVPAGE   FOR SVC 59 (USED ONLY BY $INTVIRT)       @D14NDFG 07366001
*                       AMODE(24),DATON                        @D529DRP 07367001
*           INVP2ND   FOR INVPART AND STORAGE MANAGEMENT, TSTOP,        07368001
*                         UNBATCH AND $INTVIRT                 @D61NDRP 07369001
*                       AMODE(31),DATON                        @D529DRP 07370001
*           INVP3RD   FOR DSPSERV CREATE INTERFACE             @D52GDWL 07371001
*                       AMODE(31),DATON                        @D52GDWL 07372001
*        CALLED ROUTINES:                                      @D529DRP 07373001
*              CHCKPSQE, PTASG, PTUSG, PMRREMOV,SCDELPGO,      @D529DRP 07374001
*              CLEARPF2 WITH AMODE(31),DATOFF                  @D529DRP 07375001
*              DELREPA WITH AMODE(24),DATON                    @D529DRP 07376001
*        OPERATION                                                      07377001
*        1. GET 1ST PAGE OF AREA TO BE HANDLED.                         07378001
*        2. IF PAGE IS DISCONNECTED, CONTINUE WITH 10.                  07379001
*        3. IF PAGE IS CONNECTED, SET H-BIT OFF AND CONTINUE WITH 10.   07380001
*           (CONNECTED IS ONLY POSSIBLE IF PAGE IS IN PGQUO AND PMR-    07381001
*           TASK WAITS FOR COMPL. OF PAGE-OUT OR IF PMR-TASK WAITS FOR  07382001
*           PAGE-IN COMPL.(THE LATTER SHOULD NOT BE POSSIBLE HERE) OR   07383001
*           IF THE FRAME IS REQUESTED BY GETREAL (/370-MODE ONLY)).     07384001
*        4. IF PAGE PFIXED, DECREASE SMPFIX BY 1.                       07385001
*        5. IF PAGE FIXED, INCREASE NUMBER OF PSQ-ENTRIES BY 1.         07386001
*        6. IF PAGE NOT FIXED, REMOVE PFTE FROM PSQ.                    07387001
*        7. IF PAGE-OUT ACTIVE FOR THE PAGE, CLEAR PFIXC AND TFIXC.     07388001
*           ENQUEUE PFTE ON TOP OF PSQ AND CONTINUE WITH 10.            07389001
*        8. CALL SCDELPGQO TO RESET POSL.                               07390001
*        9. DISCONNECT PAGE.                                            07391001
*       10. COUNT PAGE AS REFERENCED IF R-,C- OR PDS-BIT ON    @D14NDFG 07392001
*       11. SET R-,C- AND PDS-BIT TO ZERO.                              07393001
*       12. GET NEXT PAGE                                               07394001
*       13. IF PAGE IN THE AREA, CONTINUE WITH 2.                       07395001
*       15. IF NPSQE>MINPSQE, POST TASKS WAITING FOR FREE               07396001
*           PAGE-FRAMES.                                                07397001
*       16. RETURN TO REQUESTOR.                                        07398001
*        INPUT:                                                         07399001
*         IF ENTERED VIA INVP2ND                                        07400001
*          RD PTR TO 1ST PAGE OF AREA TO BE HANDLED                     07401001
*          R1 PTR TO LAST PAGE OF AREA TO BE HANDLED                    07402001
*          R5 >= 0 STORAGE KEY FOR DISCONNECTED PAGES          @D14NDFG 07403001
*             < 0 AREA TO BE DEACTIVATED                       @D14NDFG 07404001
*          RE - RETURN ADDR, IF ENTERED VIA INVP2ND            @D14NDFG 07405001
*          RA - ADDR OF TCB ONLY IF ENTERED VIA INVPAGE                 07406001
*         IF ENTERED VIA INVP3RD                               @D52GDWL 07407001
*          RB - ADDR OF DATA SPACE SCB                                  07408001
*          SAME REGISTERS AS FOR INVP2ND                       @D52GDWL 07409001
*        OUTPUT:                                                        07410001
*          R0 - NUMBER OF REFERENCED PAGES                     @D14NDFG 07411001
*                                                                       07412001
*        EXIT NORMAL= IF ENTERED VIA INVPAGE, RETURN TO DISPATCHER      07413001
*                     IF ENTERED VIA INVP2ND/INVP3RD RETURN TO CALLER   07414001
*         CONDITION= FUNCTION COMPLETED                                 07415001
*         OUTPUT= SEE ABOVE                                             07416001
*         RETURN CODE= NONE                                             07417001
*        EXIT ERROR= NONE                                               07418001
*                                                                       07419001
*        EXTERNAL REFERENCES                                            07420001
*         ROUTINES= SCDELPGO  TO HANDLE POSL                            07421001
*         DATA=  PAGE-STATE(READ,WRITE)                                 07422001
*                PSQ(READ,WRITE)    PAGE SELECTION QUEUE                07423001
*                PFTE(READ,WRITE)   PAGE FRAME TABLE ENTRIES            07424001
*                NPSQE(READ,WRITE)  NUMBER OF PSQ-ENTRIES + FFCC        07425001
*                MINPSQE(READ)      MIN. VALUE OF NPSQE                 07426001
*                SRQPFG(WRITE)      RESOURCE QUEUE                      07427001
*        CONTROL BLOCKS=                                                07428001
*               PCB(READ,WRITE) PARTITION CONTROL BLOCK                 07429001
*                SMPFIX(READ,WRITE) # OF PAGES PFIXED FOR THE PART.     07430001
*                                                                       07431001
*        MACROS= REMOVE - REMOVE PFTE FROM PSQ                          07432001
*                INSTOP - INSERT PFTE ON TOP OF PSQ                     07433001
*                                                                       07434001
*        INTERNAL USAGE OF REGISTERS                                    07435001
*              R0 - NUMBER OF REFERENCED PAGES UP TO NOW       @D14NDFG 07436001
*              R1 - END ADDR OF AREA                                    07437001
*              R2 - WORK REGISTER                                       07438001
*              R3 - ADDR OF PIB                                @D52VDRP 07439001
*                   ADDR OF REAL PCB (WITHIN LOOP)             @D52VDRP 07440001
*              R4 - PCB ADDR, WORK REGISTER                             07441001
*              R5 - WORK REGISTER                                       07442001
*              R6 - ADDR OF DISPATCHER                                  07443001
*              R7 - RETURN ADDR                                         07444001
*              R8 - BASE ADDR FOR DATA AREA                             07445001
*              R9 - BASE ADDR FOR CODE AREA                             07446001
*              RA - LINK REGISTER TO NEXT LEVEL                         07447001
*              RB - ADDR OF SCB                                @D52GDWL 07448001
*              RC - ADDR OF PFTE CORRESP. TO RD                         07449001
*              RD - ADDR OF CURRENT PAGE TO BE HANDLED                  07450001
*              RE - REAL ADDR OF PIB                           @D52VDRP 07451001
*              RF - NEW CONTENT FOR PTE                        @D61NDRP 07452001
*                                                                       07453001
*-------------------------------------------------------------*@D14ZDVB 07454001
         SPACE 1                                               @D14BDVB 07455001
         AGO   .SKIPINV           SKIP SVC59 ENTRY             @D....RP 07456001
         USING DISP,R6                                                  07457001
INVPAGE  TM    SYSFLAG2,IPLBIT    CALLED BY IPL (INITVIRT)     @D14NDFG 07458001
         BZ    ERR21              NO, ILLEGAL SVC              @D14NDFG 07459001
         DROP  R6                                                       07460001
         BALR  R9,0               SET TEMPORARY BASE           @D52VDRP 07461001
         USING *,R9               *       FOR AMODESW          @D52VDRP 07462001
         N     R9,ADDRMSK         *  WITHOUT CONDITION CODE    @D52VDRP 07463001
*        AMODESW SET,AMODE=31,WR=(RE)    GET 31-BIT ADDR. MODE @D52VDRP 07464001
         AMODESW SET,AMODE=31,WR=(RE)    GET 31-BIT ADDR. MODE @D52VDRP 07465001
         SR    RE,RE              INDICATE ENTRED VIA INVPAGE  @D14NDFG 07466001
         USING SVEARA,RB          SET BASE FOR SAVE-AREA       @D14NDFG 07467001
         L     RD,SVER03          GET PARAMETER REGISTERS               07468001
         L     R1,SVER04          FROM SAVE-AREA                        07469001
         L     R5,SVER05                                       @D14NDFG 07470001
         DROP  RB                 FORGET BASE FOR SAVE AREA    @D14NDFG 07471001
.SKIPINV ANOP                                                  @D....RP 07472001
*SGLINK  INVPAG2ND,INPUT=(R1:END,R5,RD:BEG,RE:LINK),OUTPUT=(R0),       *07473001
               WORK=(R1-RD,RF),AMODE=31                                 07474001
INVP2ND  DS    0H                 RET.ADDR. FOR SUBR.ENTRY     @D14NDFG 07475001
         L     RB,SCBPTR          GET ADDR OF ACTIVE SCB       @D52GDWL 07476001
         USING SCBADR,RB          SET BASE FOR SCB             @D52GDWL 07477001
*SGLINK  INVPAG3RD INPUT=(R1:END,R5,RB:SCB,RD:BEG,RE:LINK),            *07478001
               OUTPUT=(R0),WORK=(R1-RD,RF),AMODE=31                     07479001
INVP3RD  DS    0H                 ENTRY POINT FOR DATA SPACES  @D52GDWL 07480001
*                                 RB CONTAINS ADDR OF SCB      @D52GDWL 07481001
         LR    R7,RE              RETURN ADDRESS IF ENTERED    @D52GDWL 07482001
*                                 VIA INVP2ND AND INVP3RD      @D52GDWL 07483001
         L     R8,APMGMDAT        GET ADDR OF DATA AREA        @D14NDFG 07484001
         USING PMGMDATA,R8        SET BASE FOR DATA AREA       @D14NDFG 07485001
         L     R9,AINVPSUB        GET BASE FOR THIS ROUTINE    @D14NDFG 07486001
         USING INVP2ND,R9         SET BASE FOR THIS ROUTINE    @D14BDRP 07487001
         L     R6,PMRINVBG        INDICATE BEGIN OF INVPAGE    @D52VDRP 07488001
         DEBUG ALLREGS,XXDBGMC    * CREATE DEBUG ENTRY         @D61NDRP 07489001
         L     R6,DISPAD                                       @D365DRP 07490001
         USING DISP,R6                                         @D365DRP 07491001
         N     RD,PADDRMSK        SET BEGIN ADDR ON PAGE BOUNDARY       07492001
         N     R1,PADDRMSK        SET END ADDR ON PAGE BOUNDARY         07493001
         SLR   R0,R0              COUNT REG = 0                @D14ADVB 07494001
         L     RF,IJBSMCOM        STOR. MANAGMNT COMM. AREA    @D51GDRP 07495001
         USING SMCOM,RF                                        @D51GDRP 07496001
         CR    RD,R1              BEGIN ADDR > END ADDR                 07497001
         BH    INVP001A           YES, ERROR                            07498001
         TM    SCBFLG,SCBDSP      DATA SPACE TO BE HANDLED?    @D52GDWL 07499001
         BO    INVPG02            YES                          @D52GDWL 07500001
         C     R1,EOVSADR         END ADDR BEYOND SYSTEM       @D51GDRP 07501001
         BH    INVP001A           YES, ERROR                   @D51GDRP 07502001
         C     RD,SMCSSBEG        BEGIN ADDR IN SUPERVISOR     @D14NDFG 07503001
         BNL   INVPG03            NO, OK                                07504001
INVP001A BAL   R5,PMRHWERR         ERROR                                07505001
*                                                              @D52GDWL 07506001
INVPG02  DS    0H                 PF IN DATA SPACE             @D64ADOW 07507001
         L     R3,PIBPTR2         GET ADDR OF                  @D64ADOW 07508001
         USING PIB2ADR,R3              CURRENT                 @D64ADOW 07509001
         L     R4,PIBPCB                   PCB                 @D64ADOW 07510001
         DROP  R3                                              @D64ADOW 07511001
         L     R3,SCBCUSZ         CURR SIZE OF DATA SPACE IN K @D52GDWL 07512001
         SLL   R3,10              SIZE IN BYTES                @D52GDWL 07513001
         BCTR  R3,0               HIGHEST DATA SPACE ADDRESS   @D52GDWL 07514001
         CR    R1,R3              ADDRESS WITHIN DATA SPACE?   @D52GDWL 07515001
         BNH   INVPGK06           YES, CONTINUE                @D64ADOW 07516001
         BAL   R5,PMRHWERR        NO, ERROR                    @D52GDWL 07517001
.* ------------------------------------------------------------@D35NDRP 07518001
INVPG03  EQU   *                                                        07519001
         L     R4,ASYSPCB         POINT TO SYSTEM PCB          @D51IDRP 07520001
         C     R1,SMCESVA         SYSTEM AREA OR SVA_24        @D52VDRP 07521001
         BNH   INVPGK06           IF YES, USE SYSTEM PCB       @D51GDRP 07522001
         C     RD,SMCSVA31        AREA IN SVA_31               @D52VDRP 07523001
         BNL   INVPGK06           YES, USE SYSTEM PCB          @D52VDRP 07524001
         TM    SCBFLG,SCBPMRSP    IS REQUEST FOR PMR ADDR. SPAC@D52VDRP 07525001
         BZ    INVPGK04           NO, USE PARTITION PCB        @D52VDRP 07526001
         C     RD,SMCPRPBG        REQUEST FOR PRIV. AREA       @D52VDRP 07527001
         BNL   INVPGK06           YES, USE SYSTEM PCB (INVPAGE FOR     *07528001
                                      PMR ADDR. SPACE)         @D52VDRP 07529001
         DROP  RF                 DROP SMCOM                   @D51GDRP 07530001
INVPGK04 L     R3,PIBPTR2         GET ADDR OF                  @D51IDRP 07531001
         USING PIB2ADR,R3              CURRENT                 @D51IDRP 07532001
         L     RF,PIBPCB                   PCB                 @D64ADOW 07533001
         DROP  R3                                              @D64ADOW 07534001
         USING PCBADR,RF                                       @D64ADOW 07535001
         TM    PCEFLAG,PCEDYNP    DYNAMIC PARTITION            @D64ADOW 07536001
         BNO   INVPGK05           NO  ---> TAKE PART PCB       @D64ADOW 07537001
         C     R1,SMVPBEG         PART OF SPACE GETVIS AREA    @D64ADOW 07538001
         BL    INVPGK06           YES ---> KEEP SYS PCB        @D64ADOW 07539001
         DROP  RF                                              @D64ADOW 07540001
INVPGK05 EQU   *                                               @D64ADOW 07541001
         LR    R4,RF              TAKE PART PCB                @D64ADOW 07542001
         USING PCBADR,R4                                       @D51IDRP 07543001
INVPGK06 EQU   *                                               @D51IDRP 07544001
         L     R3,PCEPIB          POINT TO CORRECT PIB         @D51IDRP 07545001
         USING PIBADR,R3                                       @D14NDFG 07546001
         LTR   RF,R5              AREA TO BE DEACTIVATED       @D14NDFG 07547001
         BNM   INVPGK10           SKIP IF NOT                  @D14NDFG 07548001
         TM    PIBDATFL,PIBTRAM   PARTITION IN VIRTUAL MODE    @D52VDRP 07549001
         BO    PMRDBG71           YES, O.K.                    @D52VDRP 07550001
         BAL   R5,PMRHWERR        NO, SYSTEM ERROR             @D52VDRP 07551001
PMRDBG71 DS    0H                                              @D52VDRP 07552001
         LA    RF,PTEIBIT+PTEINVAD PATTERN FOR INACTIVE PAGE   @D14NDFG 07553001
         B     INVPGK20                                        @D14NDFG 07554001
INVPGK10 TM    PIBDATFL,PIBTRAM   PARTITION EXECUTING REAL     @D51IDRP 07555001
         BZ    INVPGK21           YES, KEEP STORAGE KEY        @D61NDRP 07556001
         SLL   RF,8               SHIFT KEY IN RIGHT PTE POS.  @D14NDFG 07557001
         LA    RF,PTEIBIT(,RF)    NORMAL INVALIDATION PATTERN  @D14NDFG 07558001
INVPGK20 EQU   *                                               @D14NDFG 07559001
         SLL   RF,8               GET FINAL PTE CONTENT        @D61NDRP 07560001
INVPGK21 DS    0H                                              @D61NDRP 07561001
         AGO   .PMRFAST                                        @D64YDOW 07562001
         TM    SCBFLG,SCBDSP      DATA SPACE TO BE HANDLED?    @D52GDWL 07563001
         BO    INVPGK30           YES                          @D52GDWL 07564001
         LH    R5,PCEPIK          GET CORRECT PIK              @D52VDRP 07565001
         L     RE,ADELREPA        ADDRESS OF DELREPA ROUTINE   @DA33314 07566001
*        AMODESW CALL,REGS=(RE,RE) DELETE REPLICAS FOR PART.   @D52VDRP 07567001
         AMODESW CALL,REGS=(RE,RE) DELETE REPLICAS FOR PART.   @D52VDRP 07568001
*SGLINK  DELREPA,INPUT=(R5,RE),WORK=(R9)                       @DA33314 07569001
         L     R9,AINVPSUB        RESTORE BASE ADDRESS         @DA33314 07570001
         SPACE 1                                               @DA33314 07571001
.PMRFAST ANOP                                                  @D64YDOW 07572001
         DROP  R3,R4,RB           DROP BASE FOR PIB, PCB, SCB  @D52VDRP 07573001
INVPGK30 DS    0H                                              @D52GDWL 07574001
*        AMODESW SET,DAT=OFF      ENTER REAL MODE              @D52VDRP 07575001
         AMODESW SET,DAT=OFF      ENTER REAL MODE              @D52VDRP 07576001
*        GENSERV LRADBG,RREG=(RE),VADD=(R3),ERR=NADDR          @D52VDRP 07577001
*                           GET REAL ADDR OF PIB IN RE         @D52VDRP 07578001
         GENSERV LRADBG,RREG=(RE),VADD=(R3),ERR=NADDR          @D52VDRP 07579001
         USING PIBADR,RE          SET BASE FOR REAL PIB        @D52VDRP 07580001
*        GENSERV LRADBG,RREG=(R3),VADD=(R4),ERR=NADDR          @D52VDRP 07581001
*                           GET REAL ADDR OF PCB IN R3         @D52VDRP 07582001
         GENSERV LRADBG,RREG=(R3),VADD=(R4),ERR=NADDR          @D52VDRP 07583001
         USING PCBADR,R3          SET BASE FOR REAL PCB        @D52VDRP 07584001
         LR    RC,RB              SAVE VIRTUAL SCB ADDR        @D52GDWL 07585001
*        GENSERV LRADBG,RREG=(RB),VADD=(RB),ERR=NADDR          @D52GDWL 07586001
*                           GET REAL ADDR OF SCB IN RB         @D52GDWL 07587001
         GENSERV LRADBG,RREG=(RB),VADD=(RB),ERR=NADDR          @D52GDWL 07588001
         USING SCBADR,RB          SET BASE FOR REAL SCB        @D52VDRP 07589001
         STM   R7,R6,PMRSLEVA+OFR7 SAVE REGISTERS...           @D52GDWL 07590001
*                                 ... R1=END ADDR OF AREA      @D52GDWL 07591001
*                                 ... R3=REAL A(PCB)           @D52GDWL 07592001
*                                 ... R7=RETURN ADDRESS        @D52GDWL 07593001
*                                 ... RB=REAL A(SCB)           @D52GDWL 07594001
*                                 ... RC=VIRT. A(SCB)          @D52GDWL 07595001
*                                 ... RD=VIRT. PAGE ADDR       @D52GDWL 07596001
*                                 ... RE=REAL A(PIB)           @D52GDWL 07597001
*                                 ... RF=INVALID PATTERN       @D52GDWL 07598001
INVPAG00 DS    0H                                              @D51GDTP 07599001
         L     RA,AREALADR        GET ENTRY POINT FOR REALADR  @D52GDRP 07600001
*SGLINK  REALADR,INPUT=(R8,RA,RB,RD),OUTPUT=(R4,RC),AMODE=31 DATOFF     07601001
         BALR  RA,RA              TEST PAGE STATE              @D52GDRP 07602001
         B     INVP3705           PAGE IS ADDRESSABLE          @D52GDWL 07603001
*                                 PAGE IS NOT ADDRESSABLE      @D52VDRP 07604001
         LTR   RC,RC              PAGE INVALID?                @D52GDWL 07605001
         BZ    INVP3740           YES                          @D52GDWL 07606001
*                                                              @D52GDWL 07607001
*        SEGMENT IS INVALID                                    @D14NDFG 07608001
*                                                              @D52GDWL 07609001
INVP3700 DS    0H                                              @D52VDVB 07610001
         TM    SCBFLG,SCBDSP      DATA SPACE TO BE HANDLED?    @D52GDWL 07611001
         BO    PMRDBG72           YES                          @D52GDWL 07612001
         TM    PIBDATFL,PIBTRAM   PARTITION IN VIRTUAL MODE    @D52VDRP 07613001
         BO    PMRDBG72           YES, O.K.                    @D52VDRP 07614001
         BAL   R5,PMRHWERR        NO, SYSTEM ERROR             @D52VDRP 07615001
PMRDBG72 DS    0H                                              @D52VDRP 07616001
         L     RB,PMRSLEVA+OFR12  VIRTUAL SCB ADDR             @D52GDWL 07617001
         L     R9,APMRSERV        PROVIDE...                   @D52VDVB 07618001
         USING PMRSERV,R9         ... ADDRESSABILITY           @D52VDVB 07619001
         BAL   RA,PTASG           ASSIGN PAGE TABLE TO PDS     @D14NDFG 07620001
*SGLINK  PTASG,INPUT=(R8,R9,RA,RB,RD)                          @D52GDWL 07621001
         L     R9,AINVPSUB        RESTORE BASE ADDRESS         @DA33314 07622001
         USING INVP2ND,R9         SET BASE FOR THIS ROUTINE    @D14BDRP 07623001
         L     RB,PMRSLEVA+OFR11  REAL ADDR OF SCB             @D52GDWL 07624001
         B     INVPAG00           TRY AGAIN                    @D14NDFG 07625001
*                                                              @D52GDWL 07626001
*        PAGE IS ADDRESSABLE                                   @D14NDFG 07627001
*                                                              @D52GDWL 07628001
INVP3705 DS    0H                                              @D51GDRP 07629001
         ST    R4,PMRSLEVA+OFR4   SAVE ADDR OF PTE             @D52GDWL 07630001
         LTR   RC,RC              IS IT FRAME ZERO             @D51GDRP 07631001
         BNZ   INVP370X           NO, O.K.                     @D51GDRP 07632001
         BAL   R5,PMRHWERR        YES, INPUT WAS WRONG         @D51GDRP 07633001
INVP370X DS    0H                                              @D51GDRP 07634001
         LR    R5,RC              SAVE FRAME ADDRESS           @D52VDVB 07635001
         SRL   RC,PFSHIFT         GET PFTE OFFSET              @D14NDFG 07636001
         A     RC,APFT            GET ADDR OF PFTE             @D14NDFG 07637001
         USING PFTE,RC                                         @D14NDFG 07638001
         TM    PFTEFLG,POABIT+POEBIT PAGE-OUT ACTIVE           @D52VDRP 07639001
         BO    INVPWTFR           YES, WAIT FOR COMPLETION     @D52VDRP 07640001
         AL    R0,F1              INCREMENT REFERENCE COUNT    @D14NDFG 07641001
*     GENSERV  TEST,FIELD=FIXC,REG=(R2),LAB=INVP3720,BC=BZ     @D52GDWL 07642001
      GENSERV  TEST,FIELD=FIXC,REG=(R2),LAB=INVP3720,BC=BZ     @D52GDWL 07643001
*     GENSERV  GETF,FIELD=PFIXC,REG=(R2)                       @D52GDWL 07644001
      GENSERV  GETF,FIELD=PFIXC,REG=(R2)                       @D52GDWL 07645001
         LTR   R2,R2              PAGE PFIXED                  @D52VDVB 07646001
         BZ    INVP3715           NO, BRANCH                   @D14NDFG 07647001
         TM    PIBDATFL,PIBTRAM   PARTITION EXECUTING VIRTUAL  @D51IDRP 07648001
         BO    INVP3710           SKIP IF YES                  @D14NDFG 07649001
         SPACE 1                                                        07650001
*  REQUEST TO SET STORAGE KEY FOR GETVIS CONTROL INFO IN REAL PARTITION 07651001
         SPACE 1                                                        07652001
         LR    R4,RD              PAGE ADDRESS                 @D14NDFG 07653001
         TM    SUPFLAG,VMSYS      RUNNING UNDER VM ?           @DA33314 07654001
         BZ    INVP3706           NO, DO MVCL                  @D61CDRP 07655001
*                                 YES, ISSUE RELEASE PAGE TO VM@D61CDRP 07656001
         DC    X'83440010'        ISSUE 'RELEASE PAGE' TO VM   @DA33314 07657001
         B     INVP3707                                        @DA33314 07658001
INVP3706 L     R5,PAGESIZE        LENGTH FOR MOVE LONG         @D14NDFG 07659001
         SLR   RA,RA              CLEAR FOR MOVE LONG          @D14NDFG 07660001
         SLR   RB,RB              CLEAR FOR MOVE LONG          @D14NDFG 07661001
         MVCL  R4,RA              CLEAR THE PAGE               @D14NDFG 07662001
         L     RB,PMRSLEVA+OFR11  RELOAD ADDR OF SCB           @D52GDWL 07663001
INVP3707 DS    0H                 SET STORAGE KEY              @D52VDRP 07664001
         SSKE  RF,RD              SET NEW STORAGE KEY          @D51GDTP 07665001
         B     INVP3760           JOIN COMMON LOGIC            @D14NDFG 07666001
         SPACE 1                                                        07667001
INVP3710 DS    0H                                              @D52VDVB 07668001
         TM    PMOPFLAG,PMOPNPFX  CALLED BY $INTVIRT           @D61CDRP 07669001
         BO    INVP3715           YES, SKIP PFIX COUNTER UPDATE@D61CDRP 07670001
         L     RA,IJBSMCOM                                     @D52VDVB 07671001
*     DECREASE PARTITION PFIX COUNTER                          @D52VDVB 07672001
         USING SMCOM,RA                                        @D52VDVB 07673001
*    GENSERV COMP,FIELD=SMCRBG3,BC=BNH,LAB=INVP3712,COMPF=(R5),        *07674001
               REG=(R2)                                        @D52GDWL 07675001
     GENSERV COMP,FIELD=SMCRBG3,BC=BNH,LAB=INVP3712,COMPF=(R5),        *07676001
               REG=(R2)                                        @D52GDWL 07677001
         DROP   RA                DROP BASE FOR SMCOM          @D52VDVB 07678001
*        GENSERV DEC,FIELD=SMPFIX,REG=(RA)                     @D52VDVB 07679001
         GENSERV DEC,FIELD=SMPFIX,REG=(RA)                     @D52VDVB 07680001
         B     INVP3715           ----------->                 @D52VDVB 07681001
INVP3712 DS    0H                                              @D52VDVB 07682001
*        GENSERV DEC,FIELD=SMPFIX3,REG=(RA)                    @D52VDVB 07683001
         GENSERV DEC,FIELD=SMPFIX3,REG=(RA)                    @D52VDVB 07684001
INVP3715 TM    S370FLG,DRAP       FAILING STORAGE              @D14NDFG 07685001
         BO    INVP3725           SKIP IF YES                  @D14NDFG 07686001
*        GENSERV INC,FIELD=NPSQE,REG=(RA)                      @D52VDVB 07687001
         GENSERV INC,FIELD=NPSQE,REG=(RA)                      @D52VDVB 07688001
         B     INVP3725                                        @D14NDFG 07689001
         SPACE 1                                               @D14NDFG 07690001
INVP3720 BAL   RA,PMRREMOV        REMOVE PFTE FROM PSQ         @D14NDFG 07691001
*SGLINK  PMRREMOV,INPUT=(R8,RA,RC),WORK=(R4,R5)                @D14NDFG 07692001
*                                                              @D52GDWL 07693001
INVP3725 L     RA,ASCNPGQO        ENTRY POINT OF SCDELPGO      @D52VDVB 07694001
         BALR  RA,RA              RESET POSL                   @D52VDVB 07695001
*SGLINK  SCDELPGO,INPUT=(R8,RA,RC),NOMODR=(R0-RF),AMODE=31 DATOFF       07696001
         XC    FIXC,FIXC          CLEAR FIX-COUNTERS           @D14NDFG 07697001
         LR    R4,RD                                           @KXA1851 07698001
         N     R4,PMSGMSK         GET OFFSET                   @KXA1851 07699001
         SRL   R4,SNSHIFT-SNSTESH   * IN SGT                   @KXA1851 07700001
         L     R5,SCBRSTO-SCBADR(,RB)    GET REAL              @KXA1851 07701001
         N     R5,PMCR1MSK         *     SGT ADDRESS           @KXA1851 07702001
         AR    R5,R4              GET REAL ADDR OF STE         @KXA1851 07703001
         L     R4,0(,R5)          GET REAL PTE ADDR FOR IPTE   @KXA1851 07704001
         IPTE  R4,RD              PURGE ENTRY IN X-LOOKASIDE B @KXA1851 07705001
         L     R4,PMRSLEVA+OFR4   RELOAD ADDR OF PTE           @KXA1851 07706001
         TM    S370FLG,DRAP       FAILING STORAGE              @D14NDFG 07707001
         BO    INVP3735           SKIP IF YES                  @D14NDFG 07708001
         LR    RA,RC              GET ...                      @D52GDWL 07709001
         S     RA,APFT            ...FRAME ADDRESS ...         @D52GDWL 07710001
         SLL   RA,PFSHIFT         ...FROM PFTE                 @D52GDWL 07711001
         BAL   R7,CLEARPF2        CLEAR FRAME AND ENQ IN IPSQ  @D14NDFG 07712001
*SGLINK  CLEARPF2,INPUT=(R7,RA,RC),WORK=(R4,R5,RA,RB),AMODE=31 DATOFF   07713001
         L     RB,PMRSLEVA+OFR11  REAL SCB ADDRESS             @D52GDWL 07714001
INVP3735 DS    0H                                              @D52VDRP 07715001
         L     R4,PMRSLEVA+OFR4   RELOAD ADDR OF PTE           @D52GDWL 07716001
         B     INVP3745           JOIN COMMON LOGIC            @D14NDFG 07717001
         DROP  RC                 DROP BASE FOR PFTE           @D52VDRP 07718001
*                                                              @D52GDWL 07719001
*        PAGE IS INVALID                                       @D14NDFG 07720001
*                                                              @D52GDWL 07721001
         USING PTE,R4                                          @D52GDWL 07722001
INVP3740 EQU   *                                               @D14NDFG 07723001
         L     R3,PMRSLEVA+OFR3   RESTORE REAL ADDR OF PCB     @D52GDWL 07724001
         TM    SCBFLG,SCBDSP      IS A DATA SPACE INVOLVED?    @D52GDWL 07725001
         BO    PMRDBG73           YES                          @D52GDWL 07726001
         TM    PIBDATFL,PIBTRAM   PARTITION IN VIRTUAL MODE    @D52VDRP 07727001
         BO    PMRDBG73           YES, O.K.                    @D52VDRP 07728001
         BAL   R5,PMRHWERR        NO, SYSTEM ERROR             @D52VDRP 07729001
PMRDBG73 DS    0H                                              @D52VDRP 07730001
         TM    PTESTAT,PTEPGCO    PAGE CONNECTED               @D52VDRP 07731001
         BO    INVPWTPG           YES, WAIT FOR COMPL. OF I/O  @D52VDRP 07732001
         TM    PTESTAT,PTENASS    IS PDS ALLOCATED             @D51GDRP 07733001
         BO    INVP3700           NO, ALLOCATE IT NOW          @D51GDRP 07734001
         TM    PTESTAT2,PTEPDS    WAS PAGE REFERENCED          @D14NDFG 07735001
         BZ    INVP3745           SKIP IF NOT                  @D14NDFG 07736001
         AL    R0,F1              INCREMENT REFERENCE COUNT    @D14NDFG 07737001
INVP3745 DS    0H                                                       07738001
         ST    RF,PTE             SET INVALID., PDS-BIT OFF    @D61NDRP 07739001
         DROP  R4                 RELESE BASE OF PTE           @D52GDWL 07740001
         CR    RD,R1              END OF ADDRESS RANGE         @D14NDFG 07741001
         BE    INVP3750           SKIP IF YES                  @D14NDFG 07742001
         LR    RC,RD                                           @D14NDFG 07743001
         AL    RC,PAGESIZE        FIRST BYTE AFTER CURR.PAGE   @D14NDFG 07744001
         N     RC,PMBLKDIS        LAST PAGE OF PDS BLOCK       @D51GDRP 07745001
         BNZ   INVP3760           SKIP IF NOT                  @D14NDFG 07746001
INVP3750 LA    RA,PTEINVAD+PTEIBIT MASK FOR INVALIDATION ...   @D14NDVB 07747001
         SLL   RA,8               ...IN CORRECT POSITION       @D61NDRP 07748001
         LR    RC,RA                                           @D14NDVB 07749001
         NR    RA,RF              CONSIDER PTEINVAD+PTEIBIT    @D14NDVB 07750001
         XR    RA,RC              TEST FOR INVALIDATION        @D14NDVB 07751001
         BNZ   INVP3760           -----> NO, PAGE TABLE USED   @D14NDVB 07752001
         N     RD,PMBLKMSK        SET ADDR ON BLOCK BOUNDARY   @D52GDWL 07753001
         L     RA,AREALADR        GET ENTRY POINT FOR REALADR  @D52GDRP 07754001
*SGLINK  REALADR,INPUT=(R8,RA,RB,RD),OUTPUT=(R4,RC),AMODE=31 DATOFF     07755001
         BALR  RA,RA              TEST PAGE STATE              @D52GDRP 07756001
         B     INVP3751           PAGE IS ADDRESSABLE, BLOCK           *07757001
                                    CAN'T BE INVALID           @D52GDWL 07758001
*                                 PAGE IS NOT ADDRESSABLE      @D52VDRP 07759001
         LTR   RC,RC              PAGE INVALID?                @D52GDWL 07760001
         BZ    INVP3752           YES, CHECK IF BLOCK INVALID  @D52GDWL 07761001
         BAL   R5,PMRHWERR        SEGMENT INVALID, SYSTEM ERROR@D52VDRP 07762001
*                                                              @D52GDWL 07763001
*        BLOCK IS NOT INVALID                                  @D52GDWL 07764001
*                                                              @D52GDWL 07765001
INVP3751 DS    0H                 BLOCK IS ADDRESSABLE         @D52GDWL 07766001
         L     RD,PMRSLEVA+OFR13  RELOAD  PAGE ADDRESS         @D52GDWL 07767001
         B     INVP3760                                        @D52GDWL 07768001
*                                                              @D52GDWL 07769001
*        CHECK WHETHER TOTAL BLOCK IS INVALID                  @D52GDWL 07770001
*                                                              @D52GDWL 07771001
INVP3752 DS    0H                 BLOCK IS INVALID             @D52VDRP 07772001
         L     RD,PMRSLEVA+OFR13  RESTORE PAGE ADDRESS         @D52GDWL 07773001
         LA    RC,NPAGPBLK        NUMBER OF PAGES PER BLOCK    @D14NDFG 07774001
         USING PTE,R4                                          @D14NDFG 07775001
INVP3755 TM    PTESTAT,PTEIBIT+PTEINVAD INACTIVE PAGE          @D14NDFG 07776001
         BNO   INVP3760           IF NOT, LEAVE LOOP           @D14NDFG 07777001
         LA    R4,LPTE(,R4)       ADDRESS OF NEXT PTE          @D14NDFG 07778001
         BCT   RC,INVP3755        CHECK NEXT PAGE IF ANY       @D14NDFG 07779001
         DROP  R4                 FORGET PTE POINTER           @D14NDFG 07780001
*    TOTAL BLOCK IS INVALID, HAS TO BE UNASSIGNED              @D52VDRP 07781001
         LR    RC,RD              RESTORE PAGE ADDRESS         @D51GDRP 07782001
         N     RC,PMBLKMSK        SET ADDR ON BLOCK BOUNDARY   @D51GDRP 07783001
         L     RB,PMRSLEVA+OFR12  VIRTUAL SCB ADDRESS          @D52GDWL 07784001
         L     R9,APMRSERV        PROVIDE...                   @D52VDVB 07785001
         USING PMRSERV,R9         ... ADDRESSABILITY           @D52VDVB 07786001
         BAL   RA,PTUSG           UNASSIGN PAGE TABLE          @D14NDFG 07787001
*SGLINK  PTUSG,INPUT=(R8,R9,RA,RB,RC),WORK=(),AMODE=31 DATOFF  @D14NDFG 07788001
         L     R9,AINVPSUB        RESTORE BASE ADDRESS         @DA33314 07789001
         USING INVP2ND,R9         SET BASE FOR THIS ROUTINE    @D14BDRP 07790001
INVP3760 EQU   *                                               @D14NDFG 07791001
         CR    RD,R1              ALL PAGES HANDLED            @D14NDFG 07792001
         BNL   INVPAGND           YES, END                              07793001
         AL    RD,PAGESIZE        GET NEXT PAGE ADDR           @D14BDVB 07794001
         ST    R0,PMRSLEVA+OFR0   UPDATE ...                   @D52GDWL 07795001
         ST    RD,PMRSLEVA+OFR13  ...SAVE AREA                 @D52GDWL 07796001
         L     RB,PMRSLEVA+OFR11  REAL SCB ADDRESS             @D52GDWL 07797001
         L     RC,PMRSLEVA+OFR12  VIRTUAL SCB ADDRESS          @D52GDWL 07798001
         B     INVPAG00           --->     ... AND HANDLE IT   @D64ADOW 07799001
         DROP  R3,RB,RE           DROP BASE FOR PCB, SCB, ...  @D52VDRP 07800001
*                                 ...PIB (REAL)                @D14BDVB 07801001
INVPWTFR DS    0H                 WAIT FOR PAGE-OUT            @D52VDRP 07802001
*        AMODESW SET,DAT=ON                                    @D52VDRP 07803001
         AMODESW SET,DAT=ON                                    @D52VDRP 07804001
         ST    RC,PMRSLEVA+OFR5   SAVE ADDR OF PFTE WITH I/O   @D52GDWL 07805001
         B     INVPWAIT                                        @D52VDRP 07806001
INVPWTPG DS    0H                                              @D52VDRP 07807001
*        AMODESW SET,DAT=ON                                    @D52VDRP 07808001
         AMODESW SET,DAT=ON                                    @D52VDRP 07809001
         L     R4,PMRSLEVA+OFR12  VIRTUAL SCB ADDR             @D52GDWL 07810001
         BAL   R2,CHKSAREX        GET SCB BELONGING TO ADDRESS @D52VDRP 07811001
*SGLINK  CHKSAREX,INPUT=(R2,R4,RD),WORK=(R3),OUTPUT=(R4)       @D52VDRP 07812001
         L     RC,TIBPTR          GET ACTIVE TIB               @D52VDRP 07813001
         USING TIBADR,RC                                       @D52VDRP 07814001
         BAL   RE,EPACNVR2        CONVERT PAGE ADDR TO EPA     @D52VDRP 07815001
*SGLINK  EPACNVR2,INPUT=(R4,R8,RD,RE),WORK=(R5),OUTPUT=(RD)    @D52VDRP 07816001
         ST    R4,TIBPFSCB        SET SCB FOR GETDEVCB'        @D52VDRP 07817001
         L     R9,APMRSERV        GET BASE FOR DEVCB RTN       @D52VDRP 07818001
         USING PMRSERV,R9                                      @D52VDRP 07819001
         LR    R5,RD              GET EPA IN CORRECT REGISTER  @D52VDRP 07820001
         BAL   R4,GETDEVCB        GET ADDR OF DEVICE CONTR. BL.@D52VDRP 07821001
*SGLINK  GETDEVCB,INPUT=(R4,R5,RC),WORK=(R3,R5),OUTPUT=(RB),           *07822001
               AMODE=ANY DATON                                          07823001
         L     R9,AINVPSUB        RESET BASE FOR THIS RTN      @D52VDRP 07824001
         USING INVP2ND,R9                                      @D52VDRP 07825001
         DROP  RC                 DROP BASE FOR TIB            @D52VDRP 07826001
         ST    RB,PMRSLEVA+OFR5   ADDR OF DEVCB                @D52GDWL 07827001
INVPWAIT LM    R7,R6,PMRSLEVA+OFR7 LOAD REGISTERS, SAVE ...    @D52GDWL 07828001
*                                 ...AREA MAY BE DESTROYED     @D52GDWL 07829001
         LR    R4,RC              SAVE VIRT ADDR OF SCB        @D52GDWL 07830001
         LR    R2,R1              SAVE END ADDRESS             @D52GDWL 07831001
         LR    R1,R5              SET WAITSTATE                @D52GDWL 07832001
         L     R5,ASRQTAB         GET ADDRESS OF ...           @D61RDRP 07833001
         LA    R5,SRQPGIO-SRQTAB(,R5) ... RESOURCE QUEUE       @D61RDRP 07834001
         SGCOV SGPMRS,MC=7                                     @D52VDRP 07835001
         BAL   RC,RWAIT           WAIT FOR COMPL. OF I/O       @D52VDRP 07836001
*SGLINK  RWAIT,INPUT=(R1,R5,RC)                                @D52VDRP 07837001
         LR    RC,R4              SAVE VIRT ADDR OF SCB        @D52GDWL 07838001
         LR    R1,R2              SAVE END ADDRESS             @D52GDWL 07839001
         STM   R7,R6,PMRSLEVA+OFR7 RECOVER SAVE AREA           @D52GDWL 07840001
*        AMODESW SET,DAT=OFF      ENTER REAL MODE AGAIN        @D52VDRP 07841001
         AMODESW SET,DAT=OFF      ENTER REAL MODE AGAIN        @D52VDRP 07842001
         B     INVPAG00           TRY IT ONCE MORE             @D52VDRP 07843001
*--------------------------------------------------------------@D14BDVB 07844001
         SPACE 1                                               @D14BDVB 07845001
INVPAGND EQU   *                                                        07846001
*SGLINK  CHCKPSQE,INPUT=(R6,R9,RA),WORK=(R5,RE,RF)             @D14NDFG 07847001
         BAL   RA,CHCKPSQE                                     @D14BDVB 07848001
*        AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @D52VDRP 07849001
         AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @D52VDRP 07850001
         L     R7,PMRSLEVA+OFR7   RESTORE RETURN ADDRESS       @D52GDWL 07851001
         L     RA,PMRINVND        INDICATE END OF INVPAGE      @D52VDRP 07852001
         DEBUG ALLREGS,XXDBGMC    * CREATE DEBUG ENTRY         @D61NDRP 07853001
         LTR   RE,R7              IS THERE A RETURN ADDRESS?   @D52GDWL 07854001
         BZ    INVPGEXT           NO, NOT CALLED AS SUBRTN     @D52VDRP 07855001
*        AMODESW RETURN,REG=(RE)  ==========> RETURN TO CALLER @D52VDRP 07856001
         AMODESW RETURN,REG=(RE)  ==========> RETURN TO CALLER @D52VDRP 07857001
*-------------------------------------------------------------*         07858001
INVPGEXT DS    0H                                              @D52VDRP 07859001
*        AMODESW RETURN,REG=(R6)  ==========> RETURN TO DISP.  @D52VDRP 07860001
         AMODESW RETURN,REG=(R6)  ==========> RETURN TO DISP.  @D52VDRP 07861001
         SPACE 1                                                        07862001
*-------------------------------------------------------------*         07863001
         SPACE 2                                                        07864001
*-------------------------------------------------------------*@D149DVB 07865001
*    IF VALUE OF MINPSQE IS EXCEEDED                          *@D149DVB 07866001
*       POST WAITING TASKS                                    *@D149DVB 07867001
*        AMODE(31),DATOFF                                      @D529DRP 07868001
*        CALLS RPOST WITH AMODE(31),DATON                      @D529DRP 07869001
*-------------------------------------------------------------*@D149DVB 07870001
         SPACE 1                                               @D14BDVB 07871001
*SGLINK  CHCKPSQE,S,INPUT=(R6,R9,RA),WORK=(R5,RE,RF)           @D14NDFG 07872001
CHCKPSQE CLC   NPSQE,MINPSQE      VALUE NOW ABOVE MINIMUM      @D14BDVB 07873001
         BNHR  RA                 NO  ==========>              @D14BDVB 07874001
*        AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @D52VDRP 07875001
         AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @D52VDRP 07876001
         L     R5,ASRQTAB         GET ADDRESS OF ...           @D61RDRP 07877001
         LA    R5,SRQPFG-SRQTAB(,R5) ... RESOURCE QUEUE  ,     @D61RDRP 07878001
         BAL   RF,RPOST           POST TASKS WAITING FOR PF'S  @D36IDRP 07879001
*SGLINK  RPOST,INPUT=(R5,R6,RF),WORK=(R5,RE)                   @D369DRP 07880001
         L     R5,ASRQTAB         GET ADDRESS OF ...           @D61RDRP 07881001
         LA    R5,SRQPFR-SRQTAB(,R5) ... RESOURCE QUEUE  ,     @D61RDRP 07882001
         BAL   RF,RPOST           POST CCW TRANSL              @D36IDRP 07883001
*SGLINK  RPOST,INPUT=(R5,R6,RF),WORK=(R5,RE)                   @D369DRP 07884001
*        AMODESW SET,DAT=OFF      ENTER REAL MODE AGAIN        @D52VDRP 07885001
         AMODESW SET,DAT=OFF      ENTER REAL MODE AGAIN        @D52VDRP 07886001
         BR    RA                 ==========>                  @D14BDVB 07887001
         SPACE 1                                               @D14BDVB 07888001
         DROP  R6                 FORGET BASE FOR DISP         @D36IDRP 07889001
         DROP  R8,R9                                                    07890001
         SPACE 2                                               @D14BDVB 07891001
*-------------------------------------------------------------*@D149DVB 07892001
         SPACE 1                                               @D14BDVB 07893001
         TITLE 'VSE/AF SUPERVISOR     SGPMR     PAGE MANAGEMENT (SVC106*07894001
                ROUTINE)'                                      @D14ZDRP 07895001
*-------------------------------------------------------------*@D149DVB 07896001
*        ROUTINE PROLOGUE                                      @D149DVB 07897001
*        ROUTINE NAME: SVC106                                  @D149DVB 07898001
*        MACRO:        SGPMR                                   @D149DVB 07899001
*        FUNCTION: THE AREA SPECIFIED BY R1,R2 IS INVALIDATED  @D149DVB 07900001
*                  AND THE STORAGE KEY IS SET TO VALUE         @D149DVB 07901001
*                  GIVEN BY R0                                 @D149DVB 07902001
*        CALLED BY: SVC HANDLER WITH AMODE(24),DATON           @D149DVB 07903001
*        ENTRY POINT:                                          @D149DVB 07904001
*                   SVC106                                     @D149DVB 07905001
*        EXIT :     DISPATCHER WITH AMODE(24),DATON            @D149DVB 07906001
*        ERROR EXIT: ILLEGAL SVC (ERR21)                       @D149DVB 07907001
*        INPUT:                                                @D149DVB 07908001
*                   R0 - STORAGE KEY                           @D149DVB 07909001
*                   R1 - ADDR IN 1ST PAGE TO BE HANDLED        @D149DVB 07910001
*                   R2 - ADDR IN LAST PAGE TO BE HANDLED       @D149DVB 07911001
*                   R1,R2 HAVE TO CONTAIN REAL ADDRESS IF      @D52VDRP 07912001
*                     CALLED FROM OCCF, AND VIRT. ADDRESSES IF @D52VDRP 07913001
*                     CALLED FROM ICCF.                        @D52VDRP 07914001
*        OUTPUT:    FUNCTION AS SPECIFIED                      @D149DVB 07915001
*                                                              @D149DVB 07916001
*        OPERATION:                                            @D149DVB 07917001
*                                                              @D149DVB 07918001
*        SVC106 :                 /*     ENTRY POINT         */@D149DVB 07919001
*        IF SVOLDKEY = ¬0         /*    PSWKEY NOT ZERO      */@D149DVB 07920001
*           THEN GOTO ERR21       /*    =====>  ILLEGAL SVC  */@D149DVB 07921001
*        IF REQUESTOR ¬= (ICCF | OCCF)                         @D149DVB 07922001
*                               /* REQUESTOR NOT ICCF OR OCCF*/@D149DVB 07923001
*           THEN GOTO ERR21       /*    =====>  ILLEGAL SVC  */@D149DVB 07924001
*        IF REQUESTOR = ICCF                                   @D149DVB 07925001
*           THEN DO               /*    FOR  I C C F  DO     */@D149DVB 07926001
*           CALL INVPAG2 (KEY=R0,START=R1,END=R2)              @D149DVB 07927001
*           END                   /*  INVALIDATE PAGES       */@D149DVB 07928001
*           ELSE DO               /*    FOR  O C C F  DO     */@D149DVB 07929001
*           ACTUAL_PAGE := BEGIN(AREA)                         @D149DVB 07930001
*           UNTIL ACTUAL PAGE > END(AREA) DO                   @D149DVB 07931001
*               PAGE.KEY := <R0>                               @D149DVB 07932001
*               ACTUAL_PAGE := SUCC(ACTUAL PAGE)               @D149DVB 07933001
*                                  /*       NEXT PAGE        */@D149DVB 07934001
*           END                                                @D149DVB 07935001
*        EXIT DISPATCHER          /*     =====>  DISPATCHER  */@D149DVB 07936001
*        END (SVC106)  ;                                       @D149DVB 07937001
*-------------------------------------------------------------*@D149DVB 07938001
         SPACE 2                                                        07939001
         USING DISP,R6                                         @D35ZDRP 07940001
SVC106   TM    SVOLDKEY,KEY0      PSWKEY OF REQUESTOR ZERO     @D35ZDRP 07941001
         BNZ   ERR21              NO, ILLEGAL SVC              @D35ZDRP 07942001
         L     R8,APMGMDAT        LOAD ADDR OF DATA AREA       @D35ZDRP 07943001
         USING PMGMDATA,R8        BASE FOR DATA AREA           @D35ZDRP 07944001
         BALR  R9,0               SET BASE                     @D14BDRP 07945001
         USING *,R9               *    FOR CODE                @D14BDRP 07946001
         N     R9,ADDRMSK         ENSURE CORRECT 31-BIT ADDRESS@D52VDRP 07947001
         LR    R5,R0              GET STORAGE KEY IN R5        @D35ZDRP 07948001
         L     R7,PCBPTR          GET PCB OF REQUESTING PART.  @D36GDRP 07949001
         USING PCBADR,R7                                       @D36GDRP 07950001
         TM    PCBSSFLG,ICCF      IS IT ICCF                   @D14NDFG 07951001
         BO    SVC106SK           IF YES, INVALID. AND SET KEY @D14NDFG 07952001
         TM    PCBSSFLG,OCCF      REQUEST FROM OCCF (HCFIOMOD) @D37DDRP 07953001
         BZ    ERR21              NO, ILLEGAL SVC              @D36GDRP 07954001
         DROP  R7                                              @DA33314 07955001
         SPACE 2                                               @D35ZDRP 07956001
*        SET STORAGE KEY FOR THE REAL AREA                     @D35ZDRP 07957001
         SPACE 1                                               @D35ZDRP 07958001
*        AMODESW SET,AMODE=31,WR=(R7)    GET TO 31-BIT MODE    @D51GDTP 07959001
         AMODESW SET,AMODE=31,WR=(R7)    GET TO 31-BIT MODE    @D51GDTP 07960001
         LR    R4,R1                                           @D35ZDRP 07961001
         N     R4,PADDRMSK        SET BEG. ADDR ON PAGE BOUND. @D35ZDRP 07962001
SVC106LP CR    R4,R2              END OF AREA REACHED          @D35ZDRP 07963001
         BH    SVC106XT           YES, EXIT                    @D52VDRP 07964001
         SSKE  R5,R4              SET STORAGE KEY FOR PAGE     @D51GDTP 07965001
         AL    R4,PAGESIZE        GET NEXT PAGE ADDR           @D14NDVB 07966001
         B     SVC106LP           HANDLE THIS PAGE             @D35ZDRP 07967001
         DROP  R6                                              @D35ZDRP 07968001
SVC106SK EQU   *                                               @D35ZDRP 07969001
         LR    RD,R1              GET BEG. ADDR IN CORRECT REG @D35ZDRP 07970001
         LR    R1,R2              GET END ADDR IN CORRECT REG  @D35ZDRP 07971001
         L     RF,AINVPSUB        GET ADDR OF INVP2ND RTN      @D14NDFG 07972001
*        AMODESW CALL,REGS=(RE,RF) INVALIDATE AREA             @D52VDRP 07973001
         AMODESW CALL,REGS=(RE,RF) INVALIDATE AREA             @D52VDRP 07974001
*SGLINK  INVP2ND,INPUT=(R1:END,R5,RD:BEG,RE:LINK),OUTPUT=(R0),         *07975001
               WORK=(R1-RD,RF),AMODE=31 DATON                           07976001
SVC106XT DS    0H                                              @D52VDRP 07977001
*        AMODESW RETURN,REG=(R6)  ==========> RETURN TO DISP.  @D52VDRP 07978001
         AMODESW RETURN,REG=(R6)  ==========> RETURN TO DISP.  @D52VDRP 07979001
         DROP  R8,R9              FORGET BASE FOR CODE AND DATA@D36ZDRP 07980001
         TITLE 'VSE/AF SUPERVISOR     SGPMR     PAGE MANAGEMENT (DRAP D*07981001
               EQUEUE ROUTINE)'                                @D14ZDRP 07982001
*-------------------------------------------------------------*@D149DVB 07983001
*        ROUTINE PROLOGUE                                      @D149DVB 07984001
*        ROUTINE NAME: DRAPDEQ                                 @D149DVB 07985001
*        MACRO:        SGPMR                                   @D149DVB 07986001
*        FUNCTION:  REMOVES PFTE FROM PSQ WHEN FAILING STORAGE @D149DVB 07987001
*                   IN PAGE_FRAME                            */@D149DVB 07988001
*        CALLED BY: MCRAS (AMODE(31),DATON)                    @D529DRP 07989001
*        ENTRY POINTS :                                        @D149DVB 07990001
*                   DRAPDEQ                                    @D149DVB 07991001
*        EXIT :     CALLER (AMODE(CALLER),DATON)               @D529DRP 07992001
*        ERROR EXIT: -                                         @D149DVB 07993001
*        INPUT:                                                @D149DVB 07994001
*             R0 - FAILING STORAGE ADDR (PF-ADDR )             @D149DVB 07995001
*             R7 - RETURN ADDR                                 @D149DVB 07996001
*             R8 - BASE ADDR OF DATA AREA                      @D149DVB 07997001
*        OUTPUT:                                               @D149DVB 07998001
*             R0 - UNCHANGED IF PFTE REMOVED FROM PSQ          @D149DVB 07999001
*                  OTHERWISE R0 NEGATIVE                       @D149DVB 08000001
*        UNCHANGED REGISTERS:                                  @D149DVB 08001001
*                   R1 - RF                                    @D149DVB 08002001
*                                                              @D149DVB 08003001
*        OPERATION: AMODE(31),DATOFF EXCEPT ACCESS TO PTE      @D529DRP 08004001
*                                                              @D149DVB 08005001
*        DRAPDEQ :                /*     ENTRY POINT         */@D149DVB 08006001
*        ADDR_PFTE (R0)           /* PFTE OUT OF PAGE/PAGE_FR*/@D149DVB 08007001
*        IF PFTE.FIXC = 0 & PFTE.NFVP+NFRP+PFTRES = OFF        @D52VDRP 08008001
*           THEN DO               /*  PFTE CAN BE REMOVED    */@D149DVB 08009001
*               CALL PMRREMOV(PFTE)                            @D149DVB 08010001
*               DECREASE NPSQE    /* DECREASE # PSQ ENTRIES  */@D149DVB 08011001
*               PFTE.DRAP := ON        /*   DRAP BIT ON      */@D149DVB 08012001
*               IF PFTE.PNRINV = OFF   /*  FRAME USED        */@D149DVB 08013001
*                  THEN DO                                     @D149DVB 08014001
*                      ADDR_PTE (PFTE) /* GET ADDR PTE       */@D149DVB 08015001
*                      PTE.PTESTAT := PTEIBIT                  @D149DVB 08016001
*                      IPTE            /*PURGE LOOKASIDE     */@D149DVB 08017001
*                  END                                         @D149DVB 08018001
*           END                                                @D149DVB 08019001
*           ELSE DO                                            @D149DVB 08020001
*               PFTE.DRAP := OFF                               @D149DVB 08021001
*               RC (R0) := - 1    /*  RETURN REG R0 NEGATIVE */@D149DVB 08022001
*           END                                                @D149DVB 08023001
*        RETURN (RC)                                           @D149DVB 08024001
*        END (DRAPDEQ) ;                                       @D149DVB 08025001
*-------------------------------------------------------------*@D149DVB 08026001
         SPACE 1                                               @D35CDKH 08027001
*SGLINK  DRAPDEQ,S,INPUT=(R0:FSA,R7:LINK,R8:APMGMDAT),OUTPUT=(R0),     *08028001
               AMODE=31                                                 08029001
DRAPDEQ  DS    0H                                              @D14ZDVB 08030001
         USING PMGMDATA,R8        SET BASE FOOR DATA AREA      @D35CDKH 08031001
         STM   R7,R6,PMRSLEV0+OFR7 SAVE CALLERS REGISTERS      @D52VDVB 08032001
         L     R9,ADRAPDEQ        GET BASE FOR CODE            @D35CDKH 08033001
         USING DRAPDEQ,R9         SET BASE FOR CODE            @D35CDKH 08034001
*        AMODESW SET,DAT=OFF      ENTER REAL MODE              @D52VDRP 08035001
         AMODESW SET,DAT=OFF                                   @D52VDRP 08036001
         LR    RC,R0              GET FAILING ADDRESS          @D35CDKH 08037001
         N     RC,PADDRMSK        GET IT ON PG BOUNDARY        @D35CDKH 08038001
         SRL   RC,PFSHIFT         OFFSET IN PFT                @D35CDKH 08039001
         A     RC,APFT            POINT TO PFTE                @D35CDKH 08040001
         USING PFTE,RC            SET BASE FOR PFTE            @D35CDKH 08041001
         CLC   FIXC,F0            PAGE FIXED                            08042001
         BNE   DRAPRET1           YES, BRANCH                           08043001
         TM    S370FLG,NFVP+NFRP+PFTERES  CAN PFTE BE REMOVED  @D52VDRP 08044001
         BNZ   DRAPRET1           NO, BRANCH                   @D35CDKH 08045001
         TM    PFTEFLG,PCBIT+POABIT FRAME CONNECTED TO PAGE ...        *08046001
                                  OR PAGE OUT ACTIVE           @KD40353 08047001
         BNZ   DRAPRET1           YES, BRANCH                  @KD40353 08048001
         L     RA,ASCNPGQO        ENTRY POINT OF SCDELPGO      @KD40353 08049001
         BALR  RA,RA              RESET POSL                   @KD40353 08050001
*SGLINK  SCDELPGO,INPUT=(R8,RA,RC),NOMODR=(R0-RF),AMODE=31 DATOFF       08051001
         BAL   RA,PMRREMOV        REMOVE PFTE FROM PSQ         @D35CDKH 08052001
         L     R5,NPSQE                                                 08053001
         BCTR  R5,0               DECREASE NUMB. OF PSQ ENTRIES         08054001
         ST    R5,NPSQE                                                 08055001
         OI    S370FLG,DRAP       TURN ON DRAP FLAG            @D35CDKH 08056001
         TM    S370FLG,PNRINV     PAGE-FRAME UNUSED                     08057001
         BO    DRAPRET            YES, BRANCH                           08058001
         L     RB,PFTESCB         GET REAL ADDRESS OF          @D61RDRP 08059001
*        GENSERV LRADBG,RREG=(RB),VADD=(RB),ERR=NADDR ... SCB           08060001
         GENSERV LRADBG,RREG=(RB),VADD=(RB),ERR=NADDR          @D61RDRP 08061001
         ICM   RD,7,PFTEEPA#      GET EPA ...                  @D61RDRP 08062001
         SLL   RD,PNSHIFT         ... ADDRESS                  @D61RDRP 08063001
*        GENSERV IPTE,EPA=(RD),SCB=(RB),WORKR=(R3,R4) DO IPTE           08064001
         GENSERV IPTE,EPA=(RD),SCB=(RB),WORKR=(R3,R4)          @D61RDRP 08065001
*        GENSERV RPTE,PFTE=(RC),RPTE=(R2),WORKR=(R3,R4,R5)              08066001
***                            GET REAL ADDR OF PTE IN R2               08067001
         GENSERV RPTE,PFTE=(RC),RPTE=(R2),WORKR=(R3,R4,R5)     @DY44241 08068001
         USING PTE,R2                                          @DY44241 08069001
         LA    RB,PTEIBIT*256     GET PTE ENTRY                @DY44241 08070001
         ST    RB,PTE             SET PAGE INV, NO COPY ON PDS @DY44241 08071001
         DROP  R2                                              @DY44241 08072001
         B     DRAPRET                                                  08073001
DRAPRET1 EQU   *                                                        08074001
         NI    S370FLG,XFF-DRAP   SET DRAP BIT OFF                      08075001
         SR    R0,R0              MAKE                         @D35CDKH 08076001
         BCTR  R0,R0              R0 NEGATIVE                  @D35CDKH 08077001
         ST    R0,PMRSLEV0+OFR0   ... AND SAVE IT              @D52VDVB 08078001
DRAPRET  LM    R7,R6,PMRSLEV0+OFR7 RESTORE CALLERS REGISTERS   @D52VDVB 08079001
*        AMODESW SET,DAT=ON       ENTER VIRTUAL MODE           @D52VDRP 08080001
         AMODESW SET,DAT=ON                                    @D52VDRP 08081001
*        AMODESW RETURN,REG=(R7)  ==========> RETURN           @D52VDRP 08082001
         AMODESW RETURN,REG=(R7)  ==========> RETURN           @D52VDRP 08083001
         DROP  RC                                              @D35CDKH 08084001
         DROP  R8,R9              DROP BASE FOR PFTE           @D35CDKH 08085001
         TITLE 'VSE/AF SUPERVISOR     SGPMR     PAGE MANAGEMENT (RESPHO*08086001
                ROUTINE)'                                      @D14ZDRP 08087001
*-------------------------------------------------------------*@D149DVB 08088001
*        ROUTINE PROLOGUE                                      @D149DVB 08089001
*        ROUTINE NAME: SVC71                                   @D149DVB 08090001
*        MACRO:        SGPMR                                   @D149DVB 08091001
*        FUNCTION:  ENABLES AND DISABLES THE PHO-CAPABILITY OF @D149DVB 08092001
*                   A TASK, REQUESTED BY SETPFA MACRO (SVC71)  @D149DVB 08093001
*        CALLED BY: SVC HANDLER AMODE(24),DATON                @D149DVB 08094001
*        CALLED ROUTINES: RESPHO WITH AMODE(31),DATON          @D529DRP 08095001
*        ENTRY POINTS :                                        @D149DVB 08096001
*                   SVC71                                      @D149DVB 08097001
*                   SETPFAX                                    @D52GDWL 08098001
*        EXIT :     DISPATCHER AMODE(24),DATON                 @D149DVB 08099001
*        ERROR EXIT: ILLEGAL SVC (ERR21) AMODE(24),DATON       @D149DVB 08100001
*        INPUT AT ENTRY POINT SVC71:                           @D149DVB 08101001
*             R0 - ADDR(APPENDAGE ROUTINE),IF ENABLE REQUESTED @D149DVB 08102001
*                - 0 ,IF DISABLE REQUESTED                     @D149DVB 08103001
*             R6 - ADDR OF DISPATCHER                          @D149DVB 08104001
*             RA - ADDR OF TCB                                 @D149DVB 08105001
*        INPUT AT ENTRY POINT SETPFAX:                         @D52GDWL 08106001
*             R1 - ADDR(PARAMETER LIST)                        @D52GDWL 08107001
*             R6 - ADDR OF DISPACHER                           @D52GDWL 08108001
*             RA - ADDR OF TCB                                 @D52GDWL 08109001
*        OUTPUT:                                               @D149DVB 08110001
*             SEE REFERENCED DATA                              @D149DVB 08111001
*        REFERENCED DATA:                                      @D149DVB 08112001
*             PCB, TIB (EXTERNAL, UPDATE)                      @D149DVB 08113001
*                                                              @D149DVB 08114001
*        OPERATION:                                            @D149DVB 08115001
*                                                              @D149DVB 08116001
*        ENTRY POINT:                                          @D52GDWL 08117001
*        IF REQUEST = PHODISABLE  /* RESET PHO CAPABILITY    */@D149DVB 08118001
*           THEN CALL RESPHO                                   @D149DVB 08119001
*           ELSE DO               /* ESTABLISH  P H O  CAPAB.*/@D149DVB 08120001
*             ADDR_PCB                                         @D149DVB 08121001
*             ADDR_PHOTIB                                      @D149DVB 08122001
*             IF PHOTIB.TIBRBYTE = ¬TIDBYTE                    @D149DVB 08123001
*                                 /*P H O  NOT ALREADY ACTIVE*/@D149DVB 08124001
*                THEN DO                                       @D149DVB 08125001
*                   IF PHOTIB.TIBRBYTE ¬= 0                    @D149DVB 08126001
*                      THEN GOTO ERR21 /* =====> ILLEGAL SVC */@D149DVB 08127001
*                      ELSE DO                                 @D149DVB 08128001
*                        PHOTIB.TIBRBYTE := TIDBYTE            @D149DVB 08129001
*                                 /*  TASK_ID INTO  PHO ENTRY*/@D149DVB 08130001
*                        PHOTIB.TIBRPIK := PIK               */@D149DVB 08131001
*                                 /*  PART_ID INTO  PHO ENTRY*/@D149DVB 08132001
*                      END                                     @D149DVB 08133001
*                END                                           @D149DVB 08134001
*             PHOTIB.TIBPFAPP := ADDR (R0) /*ADDR APPENDAGE R*/@D149DVB 08135001
*             ADDR_SCB                                         @D52GDWL 08136001
*             IF SCBSPN > 255 & ADDR(AREA) = 0                 @D52GDWL 08137001
*                                 /*AREA PARAM NOT SPECIF.   */@D52GDWL 08138001
*                      THEN GOTO ERR21 /* =====> ILLEGAL SVC */@D52GDWL 08139001
*             IORE.TIBFLAG1 := PHOACT      /* PHO INITIALIZED*/@D149DVB 08140001
*           END                                                @D149DVB 08141001
*        EXIT DISPATCHER           /*  =====>     DISPATCHER */@D149DVB 08142001
*        END (SVC71)  ;                                        @D149DVB 08143001
*-------------------------------------------------------------*@D149DVB 08144001
         SPACE 1                                               @D14ZDVB 08145001
         USING TCBADR,RA                                       @D36IDFR 08146001
         USING DISP,R6                                         @D36IDFR 08147001
SETPFAX  DS    0H                 ENTRY POINT FROM SVC121      @D52GDWL 08148001
*                                 R1 POINTS TO PARAMETER LIST  @D52GDWL 08149001
         LA    R2,11(R1)          GET END OF PARAMETER LIST    @KOP0018 08150001
         BAL   R8,VALIDSVA        VALIDATE PARAMETER LIST      @KOP0018 08151001
*SGLINK  VALIDSVA,INPUT=(R1:BEG,R2:END,R6:DISP,R8:LINK),               *08152001
               WORK=(R2,R5)                                             08153001
         L     R0,0(R1)           ADDR OF PHO ROUTINE OR ZERO  @D52GDWL 08154001
         L     R4,4(R1)           ADDR OF AREA OR ZERO         @D52GDWL 08155001
         L     RF,8(R1)           FLAG BYTE                    @D52GDWL 08156001
         L     R8,APMGMDAT        GET ADDR OF PMR DATA AREA    @D52GDWL 08157001
         USING PMGMDATA,R8        SET BASE FOR PMR DATA AREA   @D52GDWL 08158001
         L     R9,ASVC71B         LOAD BASE REGISTER           @D52GDWL 08159001
         USING SVC71B,R9          SET BASE FOR CODE            @D52GDWL 08160001
         B     SVC71B             SKIP FORWARD                 @D52GDWL 08161001
         DROP  R9                                              @D52GDWL 08162001
*                                                              @D52GDWL 08163001
SVC71    SR    R4,R4              NO AREA SPECIFIED, OLD INTERF@D52GDWL 08164001
         SR    RF,RF                                           @D52GDWL 08165001
         L     R8,APMGMDAT        GET ADDR OF DATA AREA                 08166001
         USING PMGMDATA,R8        SET BASE FOR DATA AREA                08167001
         L     R9,ASVC71B         GET BASE OF CODE AREA        @D14BDVB 08168001
         USING SVC71B,R9          SET ADDRESSABILTIY           @D14BDVB 08169001
SVC71B   LTR   R0,R0              PHO RESET REQUEST            @D14BDVB 08170001
         BNZ   SETPFA             NO, BRANCH                            08171001
         SR    RD,RD              INPUT FOR RESPHO             @D52GDWL 08172001
         L     R7,ARESPHO                                      @D52GDWL 08173001
*        AMODESW CALL,REGS=(R7,R7)  RESET PHO CAPABILITY       @D52GDWL 08174001
         AMODESW CALL,REGS=(R7,R7)  RESET PHO CAPABILITY       @D52GDWL 08175001
         B     0(R6)              ==========> RETURN DISPATCHER@D149DVB 08176001
         BAL   R5,PMRHWERR        OFFSET 4 FROM RESPHO         @D52GDWL 08177001
         SPACE 1                                               @D14ZDVB 08178001
SETPFA   L     R5,PCBPTR          GET PCB POINTER              @D36IDRP 08179001
         USING PCBADR,R5          ADDR.OF PART.PHO ENTRY       @D36IDFR 08180001
         L     R5,PCBAPHOT        POINT TO PHO TIB             @D51IDRP 08181001
         USING TIBADR,R5                                       @D36IDFR 08182001
         CLC   TIBRTID,TID        PHO ALREADY ACTIVE FOR TASK  @D66CDOW 08183001
         BE    SETPFA1            YES, BRANCH                  @D36IDRP 08184001
         CLC   TIBRTID,H0         PHO ACTIVE FOR OTHER TASK?   @D66CDOW 08185001
         BNE   ERR21              ==========>  YES, ILLEGAL SVC@D149DVB 08186001
         MVC   TIBRTID,TID        SET TASK ID INTO PHO ENTRY   @D66CDOW 08187001
         MVC   TIBRPIK,PIK        SET PART ID INTO PHO ENTRY   @D14BDRP 08188001
SETPFA1  N     R0,ADDRMSK         FORCE 24-BIT ADDRESS         @D52VDRP 08189001
         ST    R0,TIBPFAPP        STORE APPENDAGE ADDR         @D36IDRP 08190001
         LTR   R1,R4              AREA SPECIFIED?              @D52GDWL 08191001
         BZ    SETPFA5            NO                           @D52GDWL 08192001
         N     R1,ADDRMSK         FORCE 24-BIT ADDRESS         @D52VDRP 08193001
         LR    R2,R1              SINGLE ADDRESS               @D52GDWL 08194001
         LR    R7,R5              SAVE ADDR OF TIB             @D52GDWL 08195001
         BAL   R8,VALIDAD         VALIDATE PAGE                @D52GDWL 08196001
*SGLINK  VALIDAD,INPUT=(R1,R2,R6,R8),OUTPUT=(R5),WORK=(R2)     @D52GDWL 08197001
         B     ERR21              ==========> ILLEGAL SVC      @D52GDWL 08198001
         B     ERR21              ==========> ILLEGAL SVC      @D52GDWL 08199001
         L     R8,APMGMDAT        RESTORE DATA BASE            @D52GDWL 08200001
         LR    R5,R7              RELOAD ADDR OF TIB           @D52GDWL 08201001
         ST    R1,TIBPFARA        STORE ADDR OF AREA IN PHO TIB@D52GDWL 08202001
         LTR   RF,RF              TEST IF DSPACE=YES SPECIFIED @D52GDWL 08203001
         BNM   SETPFA8            NO, DSPACE=NO                @D52GDWL 08204001
         OI    TIBFLAG4,TIBPFDSP  INDICATE DSPACE=YES          @D52GDWL 08205001
         SGCOV SGPMRD,MC=2        DATA SPACE COVERAGE          @D52GDWL 08206001
         B     SETPFA8                                         @D52GDWL 08207001
SETPFA5  L     R7,SCBPTR          IF AREA IS NOT SPECIFIED ... @D52GDWL 08208001
         USING SCBADR,R7          ... BUT THE SPACE NUMBER     @D52GDWL 08209001
         LA    R0,255             ... IS LARGER THAN THE OLD   @D52GDWL 08210001
         CH    R0,SCBSPN          ... MAXIMUM OF 255,          @D52GDWL 08211001
         BL    ERR21              ... THE CALLER IS CANCELED   @D52GDWL 08212001
         DROP  R5,R7                                           @D52GDWL 08213001
SETPFA8  L     R5,TIBPTR          GET ADDR OF REQ. TIB         @D36IDRP 08214001
         USING TIBADR,R5                                       @D36IDRP 08215001
         OI    TIBFLAG1,PHOACT    IND. PHO INITIALIZED FOR TASK@D36IDRP 08216001
         BR    R6                 ==========> RETURN DISPATCHER@D149DVB 08217001
         DROP  R5,R6                                           @D36IDRP 08218001
         DROP  RA                                              @D36IDFR 08219001
         EJECT                                                 @D14ZDVB 08220001
*-------------------------------------------------------------*@D149DVB 08221001
*        ROUTINE PROLOGUE                                      @D149DVB 08222001
*        ROUTINE NAME: RESPHO                                  @D149DVB 08223001
*        MACRO:        SGPMR                                   @D149DVB 08224001
*        FUNCTION:  RESETS PHO-CAPABILITY OF A TASK            @D149DVB 08225001
*        CALLED BY:                                            @D529DRP 08226001
*              SVC71, POSTENT, TASK-TERMINATION (SGAP),        @D529DRP 08227001
*              PROGRAM-CHECK HANDLER    WITH AMODE(31),DATON   @D529DRP 08228001
*        CALLED ROUTINES:                                      @D529DRP 08229001
*              GETDEVCB, DELENTR WITH AMODE(31),DATON          @D529DRP 08230001
*        ENTRY POINTS :                                        @D149DVB 08231001
*                   RESPHO                                     @D149DVB 08232001
*        EXIT :     CALLER WITH AMODE(CALLER)                  @D529DRP 08233001
*                    OFFSET 0,NORMAL                           @D529DRP 08234001
*                    OFFSET 4, IF CALLED DUE TO PROGRAMCHECK   @D529DRP 08235001
*                              IN POSTENT RTN (ONLY POSSIBLE   @D529DRP 08236001
*                              IF CALLED FROM SGPCK)           @D529DRP 08237001
*        ERROR EXIT: -                                         @D149DVB 08238001
*        INPUT:                                                @D149DVB 08239001
*                   R7 : RETURN ADDR                           @D149DVB 08240001
*                   R8 : ADDR OF DATA AREA PMGMDATA            @D149DVB 08241001
*                   RD : IF CALLED FROM PROGRAM CHECK HANDLER: @D52GDRP 08242001
*                         PROGRAM-CHECK ADDRESS,               @D52GDRP 08243001
*                        OTHERWISE: ZERO                       @D52GDRP 08244001
*        OUTPUT:                                               @D149DVB 08245001
*                   NO PHO FOR TASK                            @D149DVB 08246001
*        UNCHANGED REGISTERS:                                  @D149DVB 08247001
*                   R0 - RF                                    @D52GDRP 08248001
*                                                              @D149DVB 08249001
*        OPERATION:                                            @D149DVB 08250001
*                                                              @D149DVB 08251001
*        RESPHO  :                /*     ENTRY POINT         */@D149DVB 08252001
*        ADDR_TIB                 /*   GET TIB OF REQUESTOR  */@D149DVB 08253001
*        IF TIDBYTE = ¬PMRTID     /*       PMR TASK ACTIVE   */@D149DVB 08254001
*           THEN                                               @D149DVB 08255001
*               (TID,TIBPTR,TCBPTR,PCBPTR) :=  REQUESTOR       @D149DVB 08256001
*                                 /* SET UP LOW CORE INFO    */@D149DVB 08257001
*        END_IF                                                @D149DVB 08258001
*        IF IORE.TIBFLAG1=¬PHOACT /*    PHO NOT ACTIVE       */@D149DVB 08259001
*           THEN RETURN           /*  =====>     EXIT        */@D149DVB 08260001
*        IORE.TIBFLAG1 := ¬PHOACT /*   RESET PHO CAPABILITY  */@D149DVB 08261001
*        PFPCB := PCBPTR          /*   FOR DELENTR ROUTINE   */@D149DVB 08262001
*        IF IORE.TIBFLAG1=¬PHOREQ /*   NO PHO_REQ ENQUEUED   */@D149DVB 08263001
*           THEN RETURN           /*  =====>     EXIT        */@D149DVB 08264001
*        IORE.TIBFLAG1 := ¬PHOREQ /* INDICATE NO PHO REQ ENQ.*/@D149DVB 08265001
*        CALL GETDEVCB (ADDR_PAGE:=IORE.TIBSTATE)              @D149DVB 08266001
*                                 /*   GET ACTUAL DEVCB      */@D149DVB 08267001
*        ADDR_REQ_E := DEVCB(PFRQBEG)                          @D149DVB 08268001
*        UNTIL TIB := REQ_E.TIBCHAIN DO                      */@D149DVB 08269001
*           REQ_E := REQ_E.TIBCHAIN                            @D149DVB 08270001
*           IF REQ_E = NIL         /*     QUEUE EMPTY        */@D149DVB 08271001
*                  THEN RETURN     /*  =====>     EXIT       */@D149DVB 08272001
*        END                                                   @D149DVB 08273001
*        CALL DELENTR (PREV.TIB,TIB,DEVCB)                     @D149DVB 08274001
*                                  /*  DELETE ENTRY          */@D149DVB 08275001
*        RETURN                                                @D149DVB 08276001
*        END (RESPHO) ;                                        @D149DVB 08277001
*                                                              @D149DVB 08278001
*        INTERNAL REGISTER USAGE                               @D149DVB 08279001
*        R3 - ADDR OF PREVIOUS TIB IN CHAIN                    @D149DVB 08280001
*        R4 - WORK REGISTER                                    @D149DVB 08281001
*        R5 - WORK REGISTER                                    @D149DVB 08282001
*        R7 - RETURN ADDR                                      @D149DVB 08283001
*        R8 - BASE ADDR OF DATA AREA                           @D149DVB 08284001
*        R9 - BASE ADDR OF CODE AREA                           @D149DVB 08285001
*        RA - LINK REGISTER, WORK REGISTER                     @D149DVB 08286001
*        RB - ADDR OF PCB OF REQUESTING PARTITION / DEVCB      @D149DVB 08287001
*        RC - ADDR OF TIB                                      @D149DVB 08288001
*        RD - PROGRAM CHECK ADDRESS OR ZERO                    @D52GDWL 08289001
*-------------------------------------------------------------*@D149DVB 08290001
         USING PMGMDATA,R8        SET BASE FOR DATA AREA                08291001
*SGLINK  RESPHO,S,INPUT=(R7:LINK,R8:APMGMDAT,RD),AMODE=31      @D52VDRP 08292001
RESPHO   STM   R7,R6,PMRSLEV2+OFR7 SAVE CALLERS REGISTER       @KD40056 08293001
         L     R9,ASVC71B         GET BASE FOR CODE AREA       @D14BDVB 08294001
         USING SVC71B,R9          SET ADDRESSABILITY           @D14BDVB 08295001
         L     RC,TIBPTR          GET TIB OF REQUESTOR         @D36IDRP 08296001
         USING TIBADR,RC                                       @D36IDRP 08297001
         CLC   TID,PMRTIDH        PMR ACTIVE                   @D66CDOW 08298001
         BNE   RESPHO1            NO, BRANCH                   @D36IDRP 08299001
         SPACE 1                                                        08300001
         LTR   RD,RD              CALLED BY PROGR. CHECK HANDL?@D52GDWL 08301001
         BZ    RESPHO0            NO                           @D52GDWL 08302001
         L     RA,APMRADR         GET BASE OF PMR CODE         @D52GDWL 08303001
         USING PMRADR,RA          SET BASE FOR PMR CODE        @D52GDWL 08304001
         LA    R5,PHOCHK1         CHECK IF PROGRAM CHECK ...   @D52GDWL 08305001
         CR    RD,R5              ...HAS OCCURRED BECAUSE      @D52GDWL 08306001
         BL    RESPHO0            ...OF AN INVALID SCB         @D52GDWL 08307001
         LA    R5,PHOCHK2         ...ADDR THAT HAS BEEN        @D52GDWL 08308001
         CR    RD,R5              ...PASSED BACK BY THE        @D52GDWL 08309001
         BH    RESPHO0            ...PHO APPEND. ROUTINE       @D52GDWL 08310001
         AL    R7,F4              INDICATE THIS TO THE ...     @D52GDWL 08311001
         ST    R7,PMRSLEV2+OFR7   ...PROGRAM CHECK HANDLER     @KD40056 08312001
         SGCOV SGPMRDS,MC=1       DATA SPACE COVERAGE          @D52GDWL 08313001
         DROP  RA                                              @D52GDWL 08314001
*                                                              @D52GDWL 08315001
*   SET UP LOW CORE INFORMATION FOR REQUESTOR                  @D369DRP 08316001
RESPHO0  DS    0H                                              @D61RDVB 08317001
.*     SETUP OF LOW-CORE FOR PHO TASK                          @D61RDVB 08318001
*      SGSETUP ACTIVATE,STASK=PMR,WR1=RC,OPTION=PMRUSER        @D61NDIS 08319001
*                       WR1 IS INPUT: TIB OF PMR-TASK          @D61NDIS 08320001
       SGSETUP ACTIVATE,STASK=PMR,WR1=RC,OPTION=PMRUSER        @D61NDIS 08321001
         L     RC,TIBPTR          SET USER TIB ADDR            @D61NDIS 08322001
         SPACE 1                                               @D36IDRP 08323001
RESPHO1  TM    TIBFLAG1,PHOACT    PHO INITIALIZED FOR TASK?    @D36IDRP 08324001
         BNO   RRPHOEX            NO, RETURN                   @D36IDRP 08325001
         NI    TIBFLAG1,XFF-PHOACT RESET PHO FOR THIS TASK     @D36IDRP 08326001
         DROP  RC                 FORGET BASE FOR TASK TIB     @D36IDRP 08327001
         L     RB,PCBPTR          GET PCB OF PART. TO BE RESET @D36IDRP 08328001
         USING PCBADR,RB                                       @D36IDRP 08329001
         L     RC,PCBAPHOT        GET ADDR OF PHO TIB OF TASK  @D51IDRP 08330001
         L     RB,PCBACPCB        GET ADDR OF CLASS-PCB        @D51IDRP 08331001
         DROP  RB                 DROP BASE FOR PCB            @D14BDRP 08332001
         ST    RB,PFPCB           SAVE A(CLASS-PCB),DELENTR RTN@D14BDRP 08333001
         USING TIBADR,RC          SET BASE FOR PHO TIB         @D36IDRP 08334001
         NI    TIBFLAG4,XFF-TIBPFDSP RESET DATA SPACE INDICATOR@D52GDWL 08335001
         XC    TIBPFARA,TIBPFARA  CLEAR AREA ADDRESS           @D52GDWL 08336001
         TM    TIBFLAG1,PHOREQ    REQUEST QUEUED TO PHO TIB?   @D36IDFR 08337001
         BNO   RRPHO              NO,DO NOT DEQUEUE            @D36IDFR 08338001
         NI    TIBFLAG1,XFF-PHOREQ IND. NO PHO REQ. IN QUEUE   @D36IDRP 08339001
         L     R5,TIBSTATE        GET PAGE ADDR                @D14BDRP 08340001
         L     R9,APMRSERV        GET BASE ...                 @D52VDVB 08341001
         USING PMRSERV,R9         ... FOR SERVICES             @D52VDVB 08342001
         BAL   R4,GETDEVCB        GET DEVICE CONTRL. BLOCK     @D14BDRP 08343001
*SGLINK  GETDEVCB,INPUT=(R4,R5,R8,R9),OUTPUT=(RB),                     *08344001
               NOMODR=(RC-R2,R4,R6-RA),AMODE=ANY DATON                  08345001
         L     R9,ASVC71B         GET BASE FOR CODE AREA       @D52VDVB 08346001
         USING SVC71B,R9          RESET ADDRESSABILITY         @D52VDVB 08347001
         USING DEVCB,RB                                        @D14BDRP 08348001
         C     RC,DEVACT          I/O ACTIVE FOR THIS ENTRY    @KY30133 08349001
         BNE   RESPHODL           NO, DELETE ENTRY FROM QUEUE  @KY30133 08350001
         L     R6,DISPAD          GET ADR OF DISPATCHER        @KY30133 08351001
         USING DISP,R6                                         @KY30133 08352001
         L     R5,ASRQTAB         GET ADDRESS OF ...           @D61RDRP 08353001
         LA    R5,SRQPMR-SRQTAB(,R5) ... RESOURCE QUEUE  ,     @D61RDRP 08354001
         BAL   RF,UNPOST          SET TASK IN PAGE-FAULT WAIT  @KY30133 08355001
*SGLINK  UNPOST,INPUT=(R5,R6,RF),WORK=(R5,RE)                  @KY30133 08356001
         BR    R6                 ========> EXIT DISP          @KY30133 08357001
         DROP  R6                 DROP BASE FOR DISPATCHER     @KY30133 08358001
         SPACE 1                                                        08359001
*  SEARCH PHO TIB IN PAGEFAULT QUEUE AND DELETE IT             @KY30133 08360001
RESPHODL L     R4,PFPCB           GET ADDR OF CLASS PCB        @D52VDRP 08361001
         USING PCBADR,R4                                       @D52VDRP 08362001
         LH    R4,PCBID           * GET OFFSET OF              @D52VDRP 08363001
         SLL   R4,3               * REQ. QUEUE (PCBID*8)       @D52VDRP 08364001
         DROP  R4                 DROP BASE FOR PCB            @D52VDRP 08365001
         LA    R3,PFRQBEG-TIBCHAIN+TIBADR(R4) GET CORRECT QUEUE@D14BDRP 08366001
         DROP  RC                                              @D36IDFR 08367001
         USING TIBADR,R3          BASE FOR PAGE-REQ. ELEMENT   @D36IDFR 08368001
NEXTE    L     RA,TIBCHAIN        POINT TO NEXT QUEUE ENTRY    @D36IDFR 08369001
         CR    RC,RA              IS THIS THE RIGHT ENTRY?     @D36IDFR 08370001
         BE    DELPHOEN           YES,GOTO DELETE ENTRY        @D36IDFR 08371001
         LTR   R3,RA              END OF QUEUE REACHED?        @D36IDFR 08372001
         BNZ   NEXTE              NO,CONTINUE SCAN             @D36IDFR 08373001
         B     RRPHO              RETURN                       @D36IDFR 08374001
DELPHOEN L     R9,APMRSERV        GET BASE ...                 @D52VDVB 08375001
         USING PMRSERV,R9         ... FOR SERVICES             @D52VDVB 08376001
*SGLINK  DELENTR,INPUT=(R3,R8,RA,RB,RC),WORK=(R4,R5),OUTPUT=(R2),      *08377001
               NOMODR=(R6-R1,R3),AMODE=31 DATON                         08378001
         BAL   RA,DELENTR         DELETE PHOTIB FROM DEV. QUEUE@D14BDRP 08379001
         DROP  RB                 FORGET BASE FOR DEVCB        @D36IDRP 08380001
         DROP  R3                 FORGET BASE FOR TIB                   08381001
         SPACE                                                          08382001
RRPHO    DS    0H                                              @KY30133 08383001
         USING TIBADR,RC          SET BASE FOR PHO TIB         @KY30133 08384001
         MVC   TIBRTID,H0         IND. NO PHO IN PARTITION     @D66CDOW 08385001
         DROP  RC                 DROP BASE FOR PHO TIB        @KY30133 08386001
RRPHOEX  LM    R7,R6,PMRSLEV2+OFR7 RESTORE CALLERS REGISTER    @KD40056 08387001
         AMODESW RETURN,REG=(R7)  ==========>                  @D149DVB 08388001
         DROP  R8                 FORGET BASE FOR DATA AREA             08389001
         DROP  R9                 FORGET BASE FOR CODE AREA             08390001
         TITLE 'VSE/AF SUPERVISOR     SGPMR     PAGE MANAGEMENT (SVC109*08391001
                ROUTINE)'                                      @D14ZDRP 08392001
*-------------------------------------------------------------*@D149DVB 08393001
*        ROUTINE PROLOGUE                                      @D149DVB 08394001
*        ROUTINE NAME: PAGESTAT                                @D149DVB 08395001
*        MACRO:        SGPMR                                   @D149DVB 08396001
*        FUNCTION:  RETURNS STATUS OF SPECIFIED AREA           @D149DVB 08397001
*        CALLED BY:    SVC 109 / 121 WITH AMODE(24),DATON      @D52GDWL 08398001
*        ENTRY POINT:                                          @D149DVB 08399001
*                   PAGESTAT   SVC 109                         @D149DVB 08400001
*                   PAGSTATX   SVC 121                         @D52GDWL 08401001
*        EXIT :     DISPATCHER (VIA RETCODE) AMODE(24),DATON   @D149DVB 08402001
*        ERROR EXIT: INVALID ADDRESS (ERR25) AMODE(24),DATON   @D149DVB 08403001
*        INPUT AT ENTRY POINT PAGESTAT:                        @D52GDWL 08404001
*               R0 - ADDR IN 1ST PAGE TO BE HANDLED            @D149DVB 08405001
*               R1 - ADDR IN LAST PAGE TO BE HANDLED           @D149DVB 08406001
*               R6 - ADDR OF DISPATCHER                        @D149DVB 08407001
*               RA - ADDR OF TCB                               @D149DVB 08408001
*        INPUT AT ENTRY POINT PAGSTATX:                        @D52GDWL 08409001
*               R0 - ADDR OF THE 3 FULLWORD PARAMETER LIST     @D52GDWL 08410001
*                    FULLWORD 1  -  BEGIN ADDR OF AREA         @D52GDWL 08411001
*                    FULLWORD 2  -  END ADDRESS OF AREA        @D52GDWL 08412001
*                    FULLWORD 3  -  ADDR OF ALET OR ZERO       @D52GDWL 08413001
*               R6 - ADDR OF DISPATCHER                        @D52GDWL 08414001
*               RA - ADDR OF TCB                               @D52GDWL 08415001
*               RF - FUNCTION CODE AND ADDRESSING MODE         @D52GDWL 08416001
*        OUTPUT:                                               @D149DVB 08417001
*               R0  - ADDRESS OF 1ST PAGE OF AREA WITH A       @D52VDRP 08418001
*                     DIFFERENT STATUS                         @D52VDRP 08419001
*                     = 0 IF ALL PAGES HAVE SAME STATUS        @D52VDRP 08420001
*               R15 - CONTAINING STATUS OF AREA                @D52VDRP 08421001
*                     = 0 : ADDR IS VALID, PAGE IS USED        @D149DVB 08422001
*                     = 4 : ADDR IS VALID, PAGE IS NOT USED    @D149DVB 08423001
*                     = 8 : ADDR IS INVALID                    @D149DVB 08424001
*                     = 12: ADDR IS VALID, PAGE CONNECTED      @D149DVB 08425001
*                           FRAME HAS DRAP-BIT ON (/370-ONLY)  @D149DVB 08426001
*                     = 16: ADDR BELONGS TO VPOOL              @D319DRP 08427001
*                                                              @D149DVB 08428001
*        OPERATION: AMODE(31)                                  @D529DRP 08429001
*                                                              @D149DVB 08430001
*        ENTRY POINT:                                          @D52GDWL 08431001
*        IF BEG_ADDR > END_ADDR THEN GOTO ERR25                @D149DVB 08432001
*        INITILIAZE RC                                         @D149DVB 08433001
*        UNTIL BEG_ADDR > END_ADDR AND RC(FIRST_PAGE)¬=RC DO   @D149DVB 08434001
*           IF BEG_ADDR > EOVSADR  /*  ADDR IN VIRTUAL STORE */@D149DVB 08435001
*              THEN GOTO PAGINVAD  /*   INVALID PAGE STATE   */@D149DVB 08436001
*           IF BEG_ADDR > AVPBEG AND BEG_ADDR <= AVPEND                 08437001
*                                  /* IF ADDR IN VPOOL       */@D51GDRP 08438001
*              THEN DO             /*                        */@D319DRP 08439001
*                   RC:= 16        /*   PROVIDE RC           */@D319DRP 08440001
*                   GOTO PAGNEXT   /*   GET NEXT ADDR        */@D319DRP 08441001
*                   END            /*                        */@D319DRP 08442001
*           GET_STE (BEG_ADDR)                                 @D149DVB 08443001
*           IF STE.STEFLG = STEINV /*   INVALID SEGMENT      */@D149DVB 08444001
*              THEN DO                                         @D149DVB 08445001
*        PAGINVAD:                                           */@D149DVB 08446001
*                  RC := 8         /*   PROVIDE RC           */@D149DVB 08447001
*              END                                             @D149DVB 08448001
*              ELSE DO                                       */@D149DVB 08449001
*                IF STEFLG = ¬STECOM & IORE.TIBSCB = 0         @D149DVB 08450001
*                 THEN GOTO PAGINVAD                           @D149DVB 08451001
*                IF LRA (BEG_ADDR)=PTE /*PAGE NOT ADDRESSABLE*/@D149DVB 08452001
*                  THEN DO                                     @D149DVB 08453001
*                    IF PTE.PTESTAT=INVADBIT   /*INVALID PTE */@D149DVB 08454001
*                      THEN GOTO PAGINVAD                      @D149DVB 08455001
*                    IF PTE.PTESTAT = PDSBIT  /*PAGE CHANGED */@D149DVB 08456001
*                     OR PTE.PTESTAT=PGCONNECT /*PAGE CONNECD*/@D149DVB 08457001
*                       THEN                                   @D149DVB 08458001
*        PAGVUSED:           RC := 0         /*  USED PAGE   */@D149DVB 08459001
*                       ELSE RC := 4         /* UNUSED PAGE  */@D149DVB 08460001
*                  END                                         @D149DVB 08461001
*                  ELSE DO                                     @D149DVB 08462001
*                     ADDR_PFTE(PTE) /* ADDR ASSOCIATED PFTE */@D149DVB 08463001
*                     IF PFTE.DRAP = ON  /* FAILING STORAGE  */@D149DVB 08464001
*                        THEN  RC := 12  /*    SET RC        */@D149DVB 08465001
*                  END                                         @D149DVB 08466001
*              END                                             @D149DVB 08467001
*        PAGNEXT:                                              @D319DRP 08468001
*        BEG_ADDR := NEXT(BEG_ADDR)  /*  CONSIDER NEXT PAGE  */@D149DVB 08469001
*        ENDO                                                  @D149DVB 08470001
*        IF BEG_ADDR > END_ADDR                                @D149DVB 08471001
*              THEN                  /*   RETURN RC VALUE    */@D149DVB 08472001
*              ELSE  RC := (RC,BEG_ADDR)                       @D149DVB 08473001
*        RETURN (ADDR=RETCODE,RC)                              @D149DVB 08474001
*        END (PAGESTAT);                                       @D149DVB 08475001
*                                                              @D149DVB 08476001
*        INTERNAL REGISTER USAGE                               @D149DVB 08477001
*        R0 - ADDR OF 1ST PAGE ON PAGE BOUNDARY                @D149DVB 08478001
*        R1 - ADDR OF LAST PAGE ON PAGE BOUNDARY               @D149DVB 08479001
*        R2 - ADDR OF PAGE UNDER INVESTIGATION                 @D149DVB 08480001
*        R3 - WORK REGISTER                                    @D149DVB 08481001
*        R4 - WORK REGISTER                                    @D149DVB 08482001
*        R5 - STATUS OF 1ST PAGE                               @D149DVB 08483001
*        R7 - WORK REGISTER                                    @DA33314 08484001
*        R8 - BASE ADDR OF DATA AREA                           @DA33314 08485001
*        R9 - BASE ADDR OF CODE AREA                           @DA33314 08486001
*        RB - ADDR OF ALET OR ZERO                             @D52GDWL 08487001
*        RC - WORK REGISTER                                    @D52VDRP 08488001
*        RF - STATUS OF ACTUAL PAGE                            @DA33314 08489001
*-------------------------------------------------------------*@DA33314 08490001
         SPACE 2                                               @DA33314 08491001
         USING DISP,R6                                         @DA33314 08492001
PAGSTATX DS    0H                 ENTRY POINY FROM SVC 121     @D52GDWL 08493001
*                                 R1 POINTS TO PARAMETER LIST  @D52GDWL 08494001
         BALR  R9,0               SET BASE ...                 @KOP0018 08495001
         USING *,R9               ... ADDR FOR ...             @KOP0018 08496001
         LA    R9,0(,R9)          ... ENTRY CODE               @KOP0018 08497001
*        AMODESW SET,AMODE=(RF),WR=(R2) SET MODE OF CALLER     @KOP0018 08498001
         AMODESW SET,AMODE=(RF),WR=(R2) SET MODE OF CALLER     @KOP0018 08499001
         LA    R2,11(R1)          GET END OF PARAMETER LIST    @KOP0018 08500001
         BAL   R8,VALIDSVA        VALIDATE PARAMETER LIST      @KOP0018 08501001
*SGLINK  VALIDSVA,INPUT=(R1:BEG,R2:END,R6:DISP,R8:LINK),               *08502001
               WORK=(R2,R5)                                             08503001
         L     R0,0(R1)           R0--BEGIN OF AREA            @D52GDWL 08504001
         L     RB,8(R1)           RB--ADDR OF ALET OR ZERO     @D52GDWL 08505001
         L     R1,4(R1)           R1--END OF AREA              @D52GDWL 08506001
         L     R8,APMGMDAT        GET ADDR OF PMR DATA AREA    @D52GDWL 08507001
         USING PMGMDATA,R8        SET BASE FOR PMR DATA AREA   @D52GDWL 08508001
         L     R9,APAGSTB         LOAD BASE REGISTER           @D52GDWL 08509001
         USING PAGSTB,R9          SET BASE FOR CODE            @D52GDWL 08510001
         B     PAGSTB             SKIP FORWARD                 @D52GDWL 08511001
         DROP  R9                                              @D52GDWL 08512001
*                                                              @D52GDWL 08513001
PAGESTAT SLR   RB,RB              ENTRYPOINT FROM SVC 109      @D52GDWL 08514001
         L     R8,APMGMDAT        GET ADDR OF DATA AREA        @DA33314 08515001
         USING PMGMDATA,R8        SET BASE FOR DATA AREA       @DA33314 08516001
         L     R9,APAGSTB         LOAD BASE REGISTER           @D52GDWL 08517001
         USING PAGSTB,R9                                       @DA33314 08518001
PAGSTB   DS    0H                                              @D52GDWL 08519001
         N     R0,PADDRMSK        SET BEGIN ADDR ON PAGE BOUND @DA33314 08520001
         N     R1,PADDRMSK        SET END ADDR ON PAGE BOUNDARY@DA33314 08521001
         CR    R0,R1              BEG ADDR > END ADDR          @DA33314 08522001
         BH    ERR25              YES, CANCEL INVALID ADDR     @DA33314 08523001
         L     R4,SCBPTR          GET ADDR OF SCB              @D52GDWL 08524001
*        AMODESW SET,AMODE=31,WR=(R3)  SET 31 BIT MODE         @D52GDWL 08525001
         AMODESW SET,AMODE=31,WR=(R3)                          @D52GDWL 08526001
         LTR   RB,RB              ALET SPECIFIED?              @D52GDWL 08527001
         BZ    PAGST0             NO                           @D52GDWL 08528001
         LR    R3,R1              SAVE PARAMETERLIST ADDRESS   @KX41349 08529001
         LR    R1,RB              R1--ADDR OF ALET             @KX41349 08530001
         LA    R2,3(R1)           GET END ADDR OF ALET AREA    @KX41349 08531001
         DROP  R8                 DROP BASE FOR PMGMDATA       @KX41349 08532001
         BAL   R8,VALIDSVA        VALIDATE ADDR OF ALET        @KX41349 08533001
*SGLINK  VALIDSVA,INPUT=(R1:BEG,R2:END,R6:DISP,R8:LINK),               *08534001
               WORK=(R2,R5)                                             08535001
         L     R8,APMGMDAT        RESTORE BASE FOR PMR DATAAREA@KX41349 08536001
         USING PMGMDATA,R8        RESET BASE FOR PMR DATA AREA @DX41349 08537001
         LR    R1,R3              RESTORE PARAMETER LIST ADDR  @KX41349 08538001
         ICM   RB,15,0(RB)        ALET REALLY SPECIFIED?       @D52GDWL 08539001
         BZ    PAGST0             NO                           @D52GDWL 08540001
         LTR   RF,RF              CALLER IN 31 BIT MODE?       @D52GDWL 08541001
         BNM   ERR45              NO, INVALID MODE             @D64ADOW 08542001
         LR    R2,R0              SAVE REGISTERS USED...       @D52GDWL 08543001
         LR    R3,R1              ...BY ALETMAC                @D52GDWL 08544001
*        ALETMAC FUNC=GETSCB,ALET=(RB),SCBADR=(R4)  GET A(SCB) @D52GDWL 08545001
         ALETMAC FUNC=GETSCB,ALET=(RB),SCBADR=(R4)  GET A(SCB) @D52GDWL 08546001
         LTR   RF,RF              ERROR DETECTED?              @D52GDWL 08547001
         BNZ   ERR25              YES, INVALID ADDRESS         @D64ADOW 08548001
         LR    R0,R2              RESTORE ...                  @D52GDWL 08549001
         LR    R1,R3              ...REGISTERS                 @D52GDWL 08550001
         USING SCBADR,R4          SET BASE FOR SCB             @D52GDWL 08551001
         TM    SCBFLG,SCBDSP      SCB OF A DATA SPACE?         @D52GDWL 08552001
         BO    PAGST0             YES, --->                    @D64ADOW 08553001
         L     RB,TIBPTR          GET CURRENT TIB              @D64ADOW 08554001
         TM    TIBFLAG1-TIBADR(RB),TERMACT DUMP ACTIVE         @D64ADOW 08555001
         BNO   ERR25                                           @D64ADOW 08556001
         DROP  R4                                              @D52GDWL 08557001
*                                                              @D52GDWL 08558001
PAGST0   LR    RB,R4              RB IS BASE FOR SCB           @D52GDWL 08559001
         USING SCBADR,RB          SET BASE FOR SCB             @D52GDWL 08560001
         LR    R2,R0              ADDR OF 1ST PAGE TO HANDLE   @KX41349 08561001
PAGLOOP  EQU   *                                               @DA33314 08562001
         TM    SCBFLG,SCBDSP      SCB OF A DATA SPACE?         @D52GDWL 08563001
         BZ    PAGST1             NO                           @D52GDWL 08564001
         L     R3,SCBCUSZ         SIZE OF DATA SPACE IN K      @D52GDWL 08565001
         SLL   R3,10              DATA SPACE SIZE IN BYTES     @D52GDWL 08566001
         BCTR  R3,0               HIGHEST ADDR IN DATA SPACE   @D52GDWL 08567001
         CR    R2,R3              ADDRESS WITHIN RANGE?        @D52GDWL 08568001
         BH    PAGINVAD           PAGE IS INVALID              @D52GDWL 08569001
         B     PAGEPRIV                                        @D52GDWL 08570001
PAGST1   DS    0H                                              @KX41349 08571001
         CL    R2,EOVSADR         ADDR BEYOND VIRT. STORAGE    @DA33314 08572001
         BH    PAGINVAD           INVALID ADDR                 @DA33314 08573001
         C     R2,AVPBEG          BELONGS PAGE TO VPOOL        @D31UDRP 08574001
         BL    PAGST3             NO, CONTINUE NORMAL          @D51GDRP 08575001
         C     R2,AVPEND          IS IT REALY VPOOL            @D51GDRP 08576001
         BNH   PAGVPOOL           YES, SET RETURN CODE         @D51GDRP 08577001
PAGST3   DS    0H                                              @D51GDRP 08578001
.* ----------------------------------------------------------           08579001
         L     RC,TIBPTR          TIB OF CURRENT TASK          @D14NDFG 08580001
         USING TIBADR,RC                                       @D14NDFG 08581001
         L     RC,TIBSCB          CURRENT ADDRESSABILITY SCOPE @D14NDFG 08582001
         DROP  RC                                              @D14NDFG 08583001
         LTR   RC,RC              ANY PRIVATE SCOPE            @D14NDFG 08584001
         BNZ   PAGEPRIV           SKIP IF YES                  @D14NDFG 08585001
         L     R3,IJBSMCOM        STOR. MANAGMNT COMM. AREA    @D51GDRP 08586001
         USING SMCOM,R3                                        @D51GDRP 08587001
         C     R2,SMCPRPBG        WITHIN PRIVATE AREA          @D52VDRP 08588001
         BL    PAGEPRIV           NO, BRANCH                   @D52VDRP 08589001
         C     R2,SMCPRPND        REALY IN PRIVATE AREA        @D52VDRP 08590001
         BNH   PAGINVAD           YES, BRANCH                  @D52VDRP 08591001
         DROP  R3                 DROP SMCOM                   @D51GDRP 08592001
PAGEPRIV DS    0H                                              @D52VDRP 08593001
*        AMODESW SET,DAT=OFF      ENTER REAL MODE              @D52VDRP 08594001
         AMODESW SET,DAT=OFF                                   @D52VDRP 08595001
*                                                              @D52GDWL 08596001
         LR    RD,R2              LOAD ADDR IN CORRECT REGISTER@D52GDWL 08597001
         L     RA,AREALADV        GET ENTRY POINT FOR REALADV  @D52GDRP 08598001
*SGLINK  REALADV,INPUT=(R8,RA,RB,RD),OUTPUT=(R4,RC),AMODE=31 DATOFF     08599001
         BALR  RA,RA              TEST PAGE STATE              @D52GDRP 08600001
         B     PGST4              PAGE IS ADDRESSABLE          @D52GDWL 08601001
*                                 PAGE IS NOT ADDRESSABLE      @D52VDRP 08602001
         LTR   RC,RC              PAGE WITH I BIT ON?          @D52GDWL 08603001
         BZ    PAGSDISC           YES                          @D52GDWL 08604001
         B     PAGINVAD           PAGE IS INVALID              @D52GDWL 08605001
*                                                              @D52GDWL 08606001
*        PAGE IS ADDRESSABLE                                   @D52VDRP 08607001
PGST4    LR    R3,RC              SAVE PAGE FRAME ADDRESS      @D61BDRP 08608001
         SRL   RC,PFSHIFT         FRAME ADDR TO OFFSET IN PFT  @D52GDWL 08609001
         A     RC,APFT            RC= ADDR OF PFTE             @D52GDWL 08610001
         USING PFTE,RC                                         @D52GDWL 08611001
         TM    S370FLG,DRAP       FAILING STORAGE              @D36IDRP 08612001
         BO    PAGFSTOR           YES, BRANCH                  @D61BDRP 08613001
         DROP  RC                 DROP BASE FOR PFTE (REAL)    @D52VDRP 08614001
* AN ADDRESSABLE PAGE IS CONSIDERED VALID AND NOT USED,        @D61BDRP 08615001
*  IF NO COPY ON PDS AND R-,C-BIT OFF (MAY BE RESULT OF RELPAG)@D61BDRP 08616001
         USING PTE,R4                                          @D61BDRP 08617001
         TM    PTESTAT2,PTEPDS    COPY ON PAGE DATA SET        @D61BDRP 08618001
         BO    PAGVUSED           YES, PAGE IS USED            @D61BDRP 08619001
         DROP  R4                 DROP BASE FOR PTE            @D61BDRP 08620001
         ISKE  RC,R3              GET STORAGE KEY              @D61BDRP 08621001
         LA    R4,RBIT+CBIT(,0)   PAGE...                      @D61BDRP 08622001
         NR    RC,R4              ... USED                     @D61BDRP 08623001
         BNZ   PAGVUSED           YES, BRANCH                  @D61BDRP 08624001
         B     PAGVUNUS           PAGE IS VALID BUT NOT USED   @D61BDRP 08625001
PAGFSTOR DS    0H                                              @D61BDRP 08626001
         LA    RF,12              SET PAGE-STATUS OF THIS PAGE @D36IDRP 08627001
         B     PAGNEXT                                         @D36IDRP 08628001
         USING PTE,R4                                          @D14NDFG 08629001
*                                                              @D52GDWL 08630001
*        PAGE IS VALID BUT NOT ADDRESSABLE                     @D35ZDRP 08631001
*                                                              @D52GDWL 08632001
PAGSDISC TM    PTESTAT,PTEINVAD   PAGE INVALID                 @D14ADVB 08633001
         BO    PAGINVAD           YES --->                     @D14ADVB 08634001
         TM    PTESTAT2,PTEPDS    COPY ON PAGE DATA SET        @D14ADVB 08635001
         BO    PAGVUSED           YES  --->                    @D14ADVB 08636001
         TM    PTESTAT,PTEPGCO    PAGE CONNECTED               @D14ADVB 08637001
         BO    PAGVUSED           YES  --->                    @D14ADVB 08638001
         DROP  R4                 FORGET PTE POINTER           @D14NDFG 08639001
*    PAGE IS VALID BUT NOT USED                                @D35ZDRP 08640001
PAGVUNUS DS    0H                                              @D61BDRP 08641001
         LA    RF,4               SET PAGE STATUS              @D35ZDRP 08642001
         B     PAGNEXT                                         @D35ZDRP 08643001
*    PAGE IS VALID AND USED                                    @D35ZDRP 08644001
PAGVUSED SR    RF,RF              SET PAGE STATUS              @D35ZDRP 08645001
         B     PAGNEXT                                         @D35ZDRP 08646001
*    PAGE BELONGS TO VPOOL                                              08647001
PAGVPOOL LA    RF,16              SET PAGE STATUS              @D31UDRP 08648001
         B     PAGNEXT                                         @D31UDRP 08649001
*                                                              @D52GDWL 08650001
*        PAGE IS INVALID                                       @D35ZDRP 08651001
*                                                              @D52GDWL 08652001
PAGINVAD LA    RF,8               SET PAGE STATUS              @D35ZDRP 08653001
PAGNEXT  DS    0H                                              @D52VDRP 08654001
*        AMODESW SET,DAT=ON       ENTER VIRTUAL MODE AGAIN     @D52VDRP 08655001
         AMODESW SET,DAT=ON                                    @D52VDRP 08656001
         CR    R0,R2              IS IT 1ST PAGE               @D35ZDRP 08657001
         BNE   PAGNEXT1           NO, BRANCH                   @D35ZDRP 08658001
         LR    R5,RF              SAVE PAGE STATUS OF 1ST PAGE @D35ZDRP 08659001
PAGNEXT1 CR    R5,RF              SAME STATUS AS 1ST PAGE      @D35ZDRP 08660001
         BNE   PAGEND1            NO, BRANCH                   @D35ZDRP 08661001
         CR    R2,R1              ALL PAGES HANDLED            @D35ZDRP 08662001
         BE    PAGEND             YES, BRANCH                  @D35ZDRP 08663001
         AL    R2,PAGESIZE        GET NEXT PAGE                @D14NDVB 08664001
         B     PAGLOOP            HANDLE IT                    @D35ZDRP 08665001
PAGEND   SR    R2,R2              INDICATE ALL PAGES SAME STAT @D35ZDRP 08666001
PAGEND1  L     RA,TCBPTR          LOAD TCB POINTER             @D52VDWL 08667001
         USING TCBADR,RA          ESTABLISH ADDRESSABILITY     @D52VDWL 08668001
         L     RA,TCBSAVE         LOAD ADDRESS OF SAVE AREA    @D52VDWL 08669001
         USING SVEARA,RA          ESTABLISH ADDRESSABILITY     @D52VDWL 08670001
         ST    R5,SVER0F          STORE RETURN INFO (IN R15)   @D52VDWL 08671001
         ST    R2,SVER00          STORE PAGE ADDRESS (IN R0)   @D52VDWL 08672001
         DROP  RA                 RELEASE REGISTER             @D52VDWL 08673001
*        AMODESW RETURN,REG=(R6)  =========> RETURN TO DISP.   @D52VDWL 08674001
         AMODESW RETURN,REG=(R6)  =========> RETURN TO DISP.   @D52VDWL 08675001
         DROP  R8,R9,R6,RB                                     @D365DRP 08676001
         SGPSVC                   GENERATE VIO-SUPPORT         @D14BDRP 08677001
         SGPPMT                   GENERATE DYN. PT SUPPORT     @D52VDRP 08678001
         SGPLLEV                  GENERATE LOAD-LEVELLING SUPP.         08679001
         SGPFIX                   GENERATE FIX SUPPORT                  08680001
         SGPOPT                   GENERATE PAGE OPT. ROUTINES           08681001
         SGPREAL                  GENERATE GETREAL/FREEREAL    @D52VDRP 08682001
         AIF   (NOT &SGPMR).NOPRT20                                     08683001
         PRINT NOGEN                                                    08684001
.NOPRT20 ANOP                                                           08685001
         MEND                                                           08686001
