         MACRO                                                          00010051
         DISP                                                           00020051
***************************************************************         00030060
*                                                             *         00040060
.*       IBM DISK OPERATING SYSTEM                            *         00050060
*        SUPERVISOR - DISP - 5686-CF7-06                      *         00060087
.*                                                            *         00070060
*        LICENSED MATERIALS - PROPERTY OF IBM                 *         00080060
*        "RESTRICTED MATERIALS OF IBM"                        *         00090060
*        5686-CF7                                             *         00100087
*        (C) COPYRIGHT IBM CORP. 1977, 2004                   *         00101084
*                                                             *         00120060
***************************************************************         00130060
.* /* START OF SPECIFICATIONS                                           00140060
.*01  MODULE-TYPE      = SUPERVISOR GENERATION MACRO                    00150051
.*01  DESCRIPTIVE NAME = TASK SELECTION AND POSTING ROUTINES            00160051
.*01  NOTES            = CHANGE ACTIVITY                                00170051
.*    TASKING EXTENSIONS                                       @D149DFR 00180051
.*    SENSE DATA INCORRECT PROVIDED                            @DA33459 00190051
.*    MICR TASK NOT POSTED AFTER WAITF WAS ISSUED              @DA34738 00200051
.*    CANCEL OF SUBSYSTEM, NO EARLY ABEND EXIT TAKEN           @DA35410 00210051
.*    VALIDATION OF PAGE ZERO UNDER VM WITH V=R AND STBYPASS   @DA35843 00220051
.*    ACTIVATE VTAM'S ISTAPCKU ROUTINE, WHENEVER VTAM ISSUES   @DA36477 00230051
.*    A TREADY COND=VCANCEL FOR TASKS WITH OPEN ACBS           @DA36477 00240051
.*    0P25I C PROT CHECK IN COMPLICATED ADDR SPACE SITUATION   @DA36545 00250051
.*    DISABLED LOOP WHEN TERMINATOR CANCELED WHILE SYTEM TASK  @DA36602 00260051
.*    I/O REQUEST IS ACTIVE FOR TERMINATING PARTITION          @DA36602 00270051
.*    CALL EXTERNAL DAMAGE CHANNEL CHECK PRE-PROCESSOR         @D21YDIS 00280051
.*    PDUMP CANCEL CAUSES RESERVED BLOCKS IN THE DUMP LIBRARY  @DA36570 00290051
.*    SOFTWARE RE-IPL                                          @D31QDHB 00300051
.*    NEW SYSTEM LAYOUT                                        @D51GDRP 00310051
.*    5.1 EXTENSIONS FOR CICS                                  @D51HDOW 00320051
.*    5.1 MORE PARTITIONS                                      @D51IDIS 00330051
.*    REAL STORAGE EXTENSION                                   @D51GDTP 00340051
.*    ESA ACCESS REGISTER SUPPORT                              @D51ADTP 00350051
.*    NEW INTERFACE FOR PERFORMANCE MONITOR                    @D51MDKH 00360051
.*    VALIDATION OF DYNAMIC GETVIS AREA INCLUDED INTO VALIDSVA @DY40100 00370051
.*    ALLOW FOR AR 'CANCEL CUU' INSTEAD OF 'RC'                @DY40195 00380051
.*        - ROUTINE ATTNINT REMOVED FROM DISP                  @DY40195 00390051
.*    MORE DEVICES SUPPORT                                     @D51ODGL 00400051
.*    SECURITY MANAGER SUPPORT                                 @D51SDIS 00410051
.*    31 BIT ADDRESSING                                        @D52VDIS 00420051
.*    VIRTUAL DISK ADAPTATION                                  @D52HDIS 00430051
.*    -- DISPATCHER BASE OVERFLOW                              @D52HDIS 00440051
.*    READY CROSS PARTITION RESOURCE                           @DY41919 00450051
.*    VSE/AF 5.2.0 PTMS:                                       @D52VDIS 00460051
.*      VALIDSVA: HARDWAIT, IF AREA LOCATED IN VPOOL  @D14BDFR @KX40089 00470051
.*      UNPOST: NON ICCF PARTITION NOT UNPOSTED,               @KX40316 00480051
.*              IF ICCFPP READY TO RUN                @D52VDIS @KX40316 00490051
.*      NO ADDITIONAL MESSAGE INFO. MOVED TO AB SAVE           @KX40555 00500051
.*      AREA, IF STXIT ...,OPTION=DUMP SPECIFIED      @D52GDIS @KX40555 00510051
.*      DISPSMRS: CONDITION CODE DESTROYED            @D52GDIS @KD40187 00520051
.*      ICCFEXIT: ICCF PARTITION NOT POSTED           @D14BDFR @KD40342 00530051
.*      SGMIH BASE REGISTER OVERFLOW                  @D14BDFR @KD40338 00540051
.*      CRTUNPST: TEMPFLD USED BY RPOST ROUTINES, WHEN         @KD40388 00550051
.*                CRT SYSTEM TASK IS CONDREADY        @D52GDIS @KD40388 00560051
.*      LINKAGE STACK SUPPORT                                  @D61PDOW 00570051
.*      NEW DISPATCHER FAST PATH ROUTINE FOR SGSETUP CALLERS   @D61PDIS 00580051
.*      CONSOLE SUPPORT                                        @D61CDIS 00590051
.*      PROBLEM DETERMINATION ENHANCEMENTS (TRACE)             @D61HDIS 00600051
.*      TRACE: SUBTASKING NOT CONSIDERED                       @KXA0065 00610051
.*      TURBO DISPATCHER CHANGES                               @D61RDIS 00620051
.*      CQDSP/SETLCALL: USE SERVICE OWNER FOR DISP.FAST PATH   @DY43802 00630051
.*      ESA EXPLOITATION                                       @D64XDIS 00640051
.*      FAMILY API                                             @D64ADIS 00650051
.*      CQDSP: CLEAR HIGH ORDER BYTE CHANQ ENTRY ADDRESS       @DY44052 00660051
.*      MORE THAN 255 TASKS                                    @D66ODOW 00670056
.*      VALWRITE: DO PRIVILEGED VALIDATION FOR VENDOR PROGRAMS @DY45586 00671061
.*      DEFINE SNSFLAG SNSPVDLY                                @DY45768 00672065
.*02  PROCESSOR        = ASSEMBLER                                      00680051
.**** END OF SPECIFICATIONS ******************************************/ 00690051
         GBLA  &NCLASS            NUMBER OF CLASSES            @D51IDIS 00700051
         GBLA  &NPART             NUMBER OF PARTITIONS                  00710051
         GBLA  &AG13              NUMBER OF SYSTEM LUBS        @D359DPS 00720051
         GBLA  &AG1               NUMBER OF PUBS (MORE DEVICES)@D51ODGL 00730051
         GBLB  &DISP              PRINT REQUIRED               @D35NDHB 00740051
         GBLC  &P(13)             PARTITION IDENT.IN PRTY ORDER@D61NDIS 00750051
         LCLA  &Y                                              @D36IDFR 00760051
         LCLC  &C                                              @D36IDFR 00770051
         ACTR  2000                                            @D14BDFR 00780051
         SPACE 4                                               @D369DFR 00790051
         AIF   (NOT &DISP).NOPRT10                                      00800051
         PRINT GEN                                                      00810051
.NOPRT10 ANOP                                                           00820051
         TITLE 'VSE/AF SUPERVISOR    DISP  GENERAL DISPATCHER ROUTINES' 00830051
*********************************************************************** 00840051
*                                                                     * 00850051
*        TASK SELECTION ROUTINE                                       * 00860051
*                                                                     * 00870051
*********************************************************************** 00880051
*                                                                     * 00890051
*        FUNCTION :                                                   * 00900051
*              EXIT FROM THE SUPERVISOR. THE NEXT TASK READY TO RUN   * 00910051
*              IS SELECTED FOR PROCESSING.                            * 00920051
*        ENTRY POINT :                                                * 00930051
*              AT LABEL DISP                                          * 00940051
*        REGISTER USAGE :                                             * 00950051
*              REG 6 BASE REGISTER, MUST POINT TO LABEL DISP          * 00960051
*        EXIT :                                                       * 00970051
*              VIA LOAD PSW AND REGISTERS TO                          * 00980051
*                  SYSTEM AND USER TASK PROCESSING ROUTINES           * 00990051
*              VIA BRANCH TO                                          * 01000051
*                  SUPVR SERVICE ROUTINES                             * 01010051
*                                                                     * 01020051
*********************************************************************** 01030051
         SPACE 2                                               @D369DFR 01040051
         DC    CL8'DISP'           MACRO NAME                  @D52VDIS 01050051
         DC    CL8'DY45768 '       LAST APAR FIX                        01060065
         SPACE 1                                               @D14BDIS 01080051
         USING DISP,R6                                         @D14BDFR 01090051
DISP     DS    0H                                              @D14BDFR 01100051
SAMETASK EQU   DISP                                            @D14BDFR 01110051
         NOP   0                  DISP ENTRY ...               @D61RDIS 01120051
         NOP   0                         ...        ...        @D61RDIS 01130051
         NOP   0                         ... VENDOR ...        @D61RDIS 01140051
         NOP   0                                ... HOOK       @D61RDIS 01150051
         MVI   RID+1,DISPID       IDENTIFY DISPATCHER PROC.    @D52VDIS 01160051
*DEL     MC    $MCIOS,$MCSDAID    LET SDAID PRESENT INTERRUPT  @D35IDAP 01170051
         EJECT ,                                               @D64XDIS 01180051
*--------------------------------------------------------------         01190051
*          - TURBO DISPATCHER ACTIVE                                    01200051
*            CALL TASK SELECTION ROUTINE                                01210051
*--------------------------------------------------------------         01220051
*        DISPMAC FUNC=DISP         PROCESS TASK SELECTION      @D61RDIS 01230051
         DISPMAC FUNC=DISP         PROCESS TASK SELECTION      @D61RDIS 01240051
DISPRETT DS    0H                                              @D64XDIS 01250051
         L     R6,DISPAD          GET DISPATCHER BASE ADDRESS  @D61RDIS 01260051
         L     RF,DISPCAT(RF)     GET ROUTINE ADDRESS          @D61RDIS 01290073
         BSM   0,RF               PROCESS EXIT REQUEST         @D67BDOW 01300071
         EJECT ,                                               @D149DIS 01310051
*--------------------------------------------------------------         01320051
* DISPCAT  - CONTINUATION ADDRESS TABLE                                 01330051
*--------------------------------------------------------------         01340051
DISPCAT  DS    0F                                              @D61RDIS 01350051
         DC    A(ALLBND)          RF = 0 -> ALLBOUND PROCESS   @D61RDIS 01360051
         DC    A(DISPFLIX)        RF = 4 -> EXT. INTERRUPTS    @D61RDIS 01370051
ADISPEXT DC    A(DISPEXIT)        RF = 8 -> DISP. EXITS        @D61RDIS 01380051
         DC    A(TITXEXIT+X'80000000')                                 X01390074
                                  RF = 12 -> TASK TIMER EXIT   @D67BDOW 01391072
         DC    A(DISPSTOP)        RF = 16 -> STOP REQUESTED    @D61RDIS 01400051
         DC    A(DISP)            RF = 20 -> NOT USED          @D61RDIS 01410051
         DC    A(DISPPOST)        RF = 24 -> POST REQUESTED    @D61RDIS 01420051
         DC    A(DISPPDSP)        RF = 28 -> SET DSP TASK READY@D61RDIS 01430051
         DC    A(THIN_INT_HND+X'80000000')                             X01431071
                                  RF = 32 -> THIN INT HANDLER  @D67BDOW 01432071
         SPACE 2                                               @D61RDIS 01440051
*--------------------------------------------------------------         01450051
* DISPFLIX - PROCESS CLOCK COMPARATOR INTERRUPTS                        01460051
*--------------------------------------------------------------         01470051
DISPFLIX DS    0H                                              @D61RDIS 01480051
         L     RE,AEXTRTN         SET BASE FOR EXTERNAL INT.   @D61RDIS 01490051
         USING EXTRTN,RE                                       @D61RDIS 01500051
         B     EXTCLOCK           PROCESS CL.COMPARATOR INTER. @D61RDIS 01510051
         DROP  RE                                              @D61RDIS 01520051
         EJECT ,                                               @D52VDIS 01530051
*--------------------------------------------------------------         01540051
* DISPSTOP - PROCESS STOP REQUEST                                       01550051
*--------------------------------------------------------------         01560051
DISPSTOP DS    0H                                              @D61RDIS 01570051
*        TDSERV FUNC=STOPRQ      STOP THIS CPU                 @D61RDIS 01580051
         TDSERV FUNC=STOPRQ      STOP THIS CPU                 @D61RDIS 01590051
         B     DISP              RETURN TO DISPATCHER          @D61RDIS 01600051
         SPACE 2                                               @D52VDIS 01610051
*--------------------------------------------------------------         01620051
* DISPPOST - POST SYSTEM TASK                                           01630051
*--------------------------------------------------------------         01640051
DISPPOST DS    0H                                              @D61RDIS 01650051
         BAL   RF,POST           POST SYSTEM TASK              @D61RDIS 01660051
         B     DISP              RETURN TO DISPATCHER          @D61RDIS 01670051
         SPACE 2                                               @D52VDIS 01680051
*--------------------------------------------------------------         01690051
* DISPPDSP - SET DSP SYSTEM TASK READY                                  01700051
*--------------------------------------------------------------         01710051
DISPPDSP DS    0H                                              @D61RDIS 01720051
         L     R5,ASRQTAB                                      @D61RDIS 01730051
         LA    R5,SRQDSP-SRQTAB(,R5) EXT.  WAIT QUEUE          @D61RDIS 01740051
         BAL   RF,RPOST           POST WAITING TASKS           @D61RDIS 01750051
*SGLINK  RPOST,INPUT=(R1,R5,R6,RF),WORK=(R5,RE)                @D61RDIS 01760051
         B     DISP              RETURN TO DISPATCHER          @D61RDIS 01770051
         EJECT ,                                               @D149DIS 01780051
*--------------------------------------------------------------         01790051
* DISPMVS  - DISPATCHER RETURN FOR SIMULATED MVS SERVICES               01800051
*            INPUT: R6 = DISPATCHER BASE REGISTER                       01810051
*            AMODE: ANY                                                 01820051
*--------------------------------------------------------------         01830051
DISPMVS  DS    0H                                              @D61CDIS 01840051
*        AMODESW SET,AMODE=31,WR=(9)                           @D61CDIS 01850051
         AMODESW SET,AMODE=31,WR=(9)                           @D61CDIS 01860051
         MVI   RID+1,REENTRID     IDENTIFY REENTRANT ROUTINE   @D61CDIS 01870051
         L     RA,TCBPTR          GET ADDRESS OF CURRENT TCB   @D61CDIS 01880051
         USING TCBADR,RA                                       @D61CDIS 01890051
         TM    TCBMVSIS,TCBMVSSA  MVS SIMULATION ACTIVE ?      @D61CDIS 01900051
         BZ    DISPRET            NO, SKIP PSW UPDATE          @D61CDIS 01910051
         NI    TCBMVSIS,XFF-TCBMVSSA RESET MVS SIMULATION IND. @D61CDIS 01920051
         L     RB,TCBSAVE         GET ADDRESS PP SAVE AREA ADDR@D61CDIS 01930051
         USING SVEARA,RB                                       @D61CDIS 01940051
         L     R9,SVEPSW2         LOAD ADDRESS FROM TASKS PSW  @D61CDIS 01950051
         A     R9,F6              CONTINUE AFTER MVS SVC INSTR.@D61CDIS 01960051
* $$ CHECK, IF HIGH ORDER BIT DISTROYED ???                             01970051
         ST    R9,SVEPSW2         RESTORE PSW ADDRESS          @D61CDIS 01980051
         DROP  RB                                              @D61CDIS 01990051
*--------------------------------------------------------------         02000051
* DISPRET  - DISPATCHER RETURN (CALLED FROM 'EXIT' ROUTINE)             02010051
*            INPUT: R6 = DISPATCHER BASE REGISTER                       02020051
*            AMODE: 31                                                  02030051
*--------------------------------------------------------------         02040051
DISPRET  DS    0H                                              @D61CDIS 02050051
         L     RA,TCBPTR          GET ADDRESS OF CURRENT TCB   @D61CDIS 02060051
         L     R3,TCBATCBE        GET ADDR. OF TCB EXTENSION   @D61PDIS 02070051
         USING TCBXADR,R3                                      @D61PDIS 02080051
         TM    TCBXFLG1,TCBXDRSA PERMANENT REPL. OF SYSTEM AL ?@D64XDIS 02090051
         BO    DISP              YES, CALL TASK SELECTION      @D64XDIS 02100051
         TM    TCBXFLG1,TCBXSALA SYSTEM ENVIRONMENT ACTIVE     @D61CDOW 02110051
         BZ    DISP              NO, CALL TASK SELECTION       @D61CDOW 02120051
         NI    TCBXFLG1,XFF-TCBXSALA USER'S DUAL IS ACTIVE     @D61CDIS 02130051
         MVC   TCBX1CR8(2),TCBXSEAX    RESTORE TASKS EAX       @D64XDIS 02140051
         MVC   TCBX1CR2(4),TCBXSDUC    RESTORE TASK'S DU-AL    @D64XDIS 02150051
         B     DISP                CALL TASK SELECTION         @D61NDIS 02160051
         DROP  R3                                              @D61CDIS 02170051
         DROP  RA                                              @D61CDIS 02180051
         EJECT ,                                               @D61NDIS 02190051
*--------------------------------------------------------------         02200051
* ALLBND   - ALLBOUND ROUTINE'S ENTRY POINT                             02210051
*--------------------------------------------------------------         02220051
ALLBND   DS    0H                 RETURN POINT FROM LOAD.LEV.  @D52HDIS 02230051
         L     RF,ADISPALL        GET DISP. ALLBOUND ROUTINE PT@D52HDIS 02240051
         USING ALLBNDX,RF                                      @D61NDIS 02250051
         B     ALLBNDXE           CONTINUE WITH ALLBOUND ROUT. @D52HDIS 02260051
         DROP  RF                                              @D61NDIS 02270051
         SPACE 2                                               @D52HDIS 02280051
*--------------------------------------------------------------         02290051
* ALBRTRN  - RETURN TO ALLBOUND ROUTINE (FROM LOAD LEVEL ROUTINE)       02300051
*--------------------------------------------------------------         02310051
ALBRTRN  DS    0H                 RETURN POINT FROM LOAD.LEV.  @D52HDIS 02320051
         L     RF,ADISPALL        GET DISP. ALLBOUND ROUTINE PT@D52HDIS 02330051
         USING ALLBNDX,RF                                      @D61NDIS 02340051
         B     ALBRTRNX           CONTINUE WITH ALLBOUND ROUT. @D52HDIS 02350051
         DROP  RF                                              @D52HDIS 02360051
         EJECT ,                                               @D149DIS 02370051
**********************************************************************  02380051
*                                                                       02390051
*            FREE LOGICAL TRANSIENT AREA                                02400051
*                                                                       02410051
**********************************************************************  02420051
* FREELTA  - FUNCTION: FREE LTA AND POST LTA BOUND TASKS                02430051
*            INPUT: R6 = BASE REGISTER                                  02440051
*                   R7 = RETURN REGISTER                                02450051
*                   R8 = TIB POINTER                                    02460051
*                   RA = TCB POINTER                                    02470051
*            WORK:  R5, RE, RF                                          02480051
*            AMODE: ANY                                                 02490051
**********************************************************************  02500051
         USING TIBADR,R8                                       @D36IDFR 02510051
         USING TCBADR,RA                                       @D36IDFR 02520051
*SGLINK  FREELTA,S,INPUT=(R6,R7,R8,RA),WORK=(R5,RE,RF)                  02530051
FREELTA  MVC   LTKEY(2),H0        RESET ID OF LTA OWNER PART.  @D51IDIS 02540051
         MVC   LTID,H0            RESET ID OF LTA OWNER TASK   @D66ODOW 02550056
         NI    TIBFLAG1,XFF-LTAOWNER RESET LTA OWNER FLAG      @D36IDFR 02560051
         L     R5,ASRQTAB         POINTER TO ...               @D61RDIS 02570051
         LA    R5,SRQLTA-SRQTAB(,R5)     ... LTA RES.DESCRIPTOR@D61RDIS 02580051
         BAL   RF,RPOST           FREE LTA AND POST WAITER     @D36IDFR 02590051
*SGLINK  RPOST,INPUT=(R5,R6,RF),WORK=(R5,RE)                   @D36ZDFR 02600051
         TM    APSFLAG,VTLTDLY    VTAM USER EXIT DELAYED       @D36IDFG 02610051
         BZ    VTAMLTA            SKIP IF NOT                  @D36IDFG 02620051
         NI    APSFLAG,XFF-VTLTDLY  RESET DELAYED EXIT FLAG    @D36IDFG 02630051
         OI    TIBFLAG,APSEXFLG   RESCHEDULE VTAM APS EXIT     @D36IDFG 02640051
VTAMLTA  DS    0H                                              @D36ZDFR 02650051
         L     RE,LTAREA2         GET SAVE AREA ADDDRESS       @D35EDFR 02660051
         USING SVEARA,RE                                       @D35EDFR 02670051
         L     RF,APBASE          GET SGAP BASE ADDRESS        @D61NDIS 02680051
         USING SGAP,RF                                         @D61NDIS 02690051
         MVC   SVEPSW(4),PSWFRAME ENSURE CORRECT PSW           @D61NDIS 02700051
         DROP  RF                                              @D61NDIS 02710051
         TM    TIBFLAG1,LTAACT    LTA ACTIVE?                  @D36IDFR 02720051
         BZR   R7                 NO,RETURN TO CALLER          @D36IDFR 02730051
         L     R5,ASYSPCB         POINT TO AR PCB              @D51IDIS 02740051
         USING PCBADR,R5                                       @D51IDIS 02750051
         L     R5,PCEPIB          POINT TO AR PIB              @D51IDIS 02760051
         USING PIBADR,R5                                       @D36IDFR 02770051
         L     RF,PIBSAV2N        RESTORE LTA                  @D51IDIS 02780051
         ST    RE,PIBSAV2N            SAVEAREA POINTER         @D51IDIS 02790051
         DROP  RE                                              @D35EDFR 02800051
         DROP  R5                                              @D36IDFR 02810051
         EJECT ,                                               @D52VDIS 02820051
*--------------------------------------------------------------         02830051
* SETLT    - SWITCH FROM LTA TO PROBL.PROGR.PROC. AND VICE VERSA        02840051
*            EXCHANGE SAVEAREAS AND INTERRUPT INFORMATION               02850051
*            INPUT: R6 = BASE REGISTER                                  02860051
*                   R7 = RETURN REGISTER                                02870051
*                   R8 = TIB POINTER                                    02880051
*                   RA = TCB POINTER                                    02890051
*                   RF = POINTER TO SAVEAREA TO BE ACTIVATED            02900051
*            WORK:  R5, RF                                              02910051
*            AMODE: ANY                                                 02920051
*--------------------------------------------------------------         02930051
*SGLINK  SETLT,S,INPUT=(R6,R7,R8,RA,RF),WORK=(R5,RF)           @D149DIS 02940051
SETLT    DS    0H                                              @D61RDIS 02950051
         NOP   0                  LTA SWITCH ...               @D61RDIS 02960051
         NOP   0                         ...        ...        @D61RDIS 02970051
         NOP   0                         ... VENDOR ...        @D61RDIS 02980051
         NOP   0                                ... HOOK       @D61RDIS 02990051
         XI    TIBFLAG1,LTAACT    SET/RESET LTAACT FLAG        @D36IDFR 03000051
         XI    DISPHIFL,LTAACT    SET/RESET LTAACT FLAG        @D52VDIS 03010051
*        DISPMAC FUNC=SETLT        PROCESS TASK SELECTION      @D61RDIS 03020051
         DISPMAC FUNC=SETLT        PROCESS TASK SELECTION      @D61RDIS 03030051
         ST    R8,LTATIB          SAVE TIB ADDRESS             @D51IDIS 03040051
         ST    RF,TCBSAVE         STORE PASSED SAVEAREA POINTER@D36IDFR 03050051
         L     RF,INTINFO         GET AND                      @DM02326 03060051
         L     R5,PIBINFO                 EXCHANGE             @DM02326 03070051
         ST    RF,PIBINFO                 INTERRUPT            @DM02326 03080051
         ST    R5,INTINFO                 INFORMATION          @DM02326 03090051
         LA    R7,0(,R7)          CLEAR HIGH ORDER BIT/BYTE    @D64XDIS 03100051
         BSM   R7,0               SAVE CURRENT MODE            @D64XDIS 03110051
         LA    R5,SETLTC31        GET ADDR OF CONTINUATION     @D64XDIS 03120051
         O     R5,BIT0OMSK        GET ADDR OF CONTINUATION     @D64XDIS 03130051
         BSM   0,R5               PASS CONTROL 31-BIT MODE     @D64XDIS 03140051
SETLTC31 DS    0H                                              @D61RDIS 03150051
         L     R5,TCBARSAV        GET AR SAVE AREA ADDRESS     @D61PDIS 03160051
         TM    TIBFLAG1,LTAACT    LTA ACTIVE ?                 @D61PDIS 03170051
         BZ    SETLTNA            NO, RESTORE AR SAVE AREA     @D61PDIS 03180051
         MVC   DISPLTAS(64),0(R5) SAVE ACCESS REGISTERS        @D61PDIS 03190051
         BSM   0,R7               RETURN TO CALLER             @D64XDIS 03200051
         EJECT ,                                               @D61NDIS 03210051
*--------------------------------------------------------------         03220051
* SETLTNA  - RESTORE TASK'S AR SAVE AREA                                03230051
*--------------------------------------------------------------         03240051
SETLTNA  DS    0H                                              @D61PDIS 03250051
         MVC   0(64,R5),DISPLTAS  RESTORE ACCESS REGISTERS     @D61PDIS 03260051
         BSM   0,R7               RETURN TO CALLER             @D64XDIS 03270051
         DROP  R8                                              @D36ZDFR 03280051
         DROP  RA                                              @D36ZDFR 03290051
         TITLE 'VSE/AF SUPERVISOR    DISP         POST/UNPOST ROUTINES' 03300051
*********************************************************************** 03310051
*                                                                     * 03320051
*        POST RESOURCE WITHIN THE SPECIFIED PARTITION                 * 03330051
*                                                                     * 03340051
*********************************************************************** 03350051
*                                                                     * 03360051
*        FUNCTION :                                                   * 03370051
*              FREE ANY WAIT-BOUND TASKS WITHIN A PARTITION           * 03380051
*        INPUT REGISTER CONTENTS :                                    * 03390051
*              R1 = BOUND INFORMATION (OPTIONAL)                      * 03400051
*              R6 = DISPATCHERS BASE ADDRESS                          * 03410051
*              RE = PCB POINTER                                       * 03420051
*              RF = RETURN ADDRESS                                    * 03430051
*                                                                     * 03440051
*            AMODE: ANY                                                 03450051
*********************************************************************** 03460051
         SPACE 2                                               @D51HDIS 03470051
*SGLINK  RPOSTIOP,S,INPUT=(R1,R6,RE,RF),WORK=(R5,RE)           @D51HDIS 03480051
RPOSTIOP DS    0H                                              @D51HDIS 03490051
         MVI   RPOSTID,WAITBND    SETUP WAIT CODE FOR RPOST    @D51HDIS 03500051
         B     RPOSTPRX           CALL RPOST                   @D51HDIS 03510051
*SGLINK  RPOSTPRX,S,INPUT=(R1,R6,RE,RF),WORK=(R5)                       03520051
         EJECT ,                                               @D51HDIS 03530051
*********************************************************************** 03540051
*                                                                     * 03550051
*        POST RESOURCE ACCROSS PARTITIONS                             * 03560051
*                                                                     * 03570051
*********************************************************************** 03580051
*                                                                     * 03590051
*        FUNCTION :                                                   * 03600051
*              FREE ANY WAIT-BOUND TASKS ACCROSS PARTITIONS           * 03610051
*        INPUT REGISTER CONTENTS :                                    * 03620051
*              R1 = BOUND INFORMATION (OPTIONAL)                      * 03630051
*              R6 = DISPATCHERS BASE ADDRESS                          * 03640051
*              R7 = RETURN ADDRESS                                    * 03650051
*              R8 = TIB POINTER                                       * 03660051
*                                                                     * 03670051
*            AMODE: ANY                                                 03680051
*********************************************************************** 03690051
         SPACE 2                                               @D369DFR 03700051
*SGLINK  RPOSTALL,S,INPUT=(R1,R6,R7,R8),WORK=(R4,R5,RE,RF)     @D149DIS 03710051
         SPACE 1                                               @D369DFR 03720051
*--------------------------------------------------------------         03730051
*            INITIALIZE LOOP OVER ALL PARTITIONS                        03740051
*--------------------------------------------------------------         03750051
RPOSTALL MVI   RPOSTID,WAITBND    SETUP WAIT CODE FOR RPOST    @D36IDFR 03760051
         LA    RF,RPOSTALN        SETUP RETURN ADDRESS         @D36IDFR 03770051
         L     R4,APCBATAB        GET ADDRESS OF PCBATAB       @D51IDIS 03780051
         SPACE 1                                               @D369DFR 03790051
*--------------------------------------------------------------         03800051
* RPOSTALN - INITIALIZE AND CALL RPOST FOR PARTITION NN                 03810051
*--------------------------------------------------------------         03820051
RPOSTALN LA    R4,4(,R4)          POINT TO NEXT PCB POINTER    @D51IDIS 03830051
         L     RE,0(,R4)          LOAD PCB POINTER             @D51IDIS 03840051
         USING PCBADR,RE                                       @D14BDFR 03850051
         LTR   RE,RE              PCB ADDRESS AVAILABLE ?      @D51IDIS 03860051
         BZ    RPOSTALN           NO, LOOK FOR NEXT PCB ADDR.  @D51IDIS 03870051
         BP    RPOSTPRX           YES, CALL RPOST              @D51IDIS 03880051
*SGLINK  RPOSTPRX,S,INPUT=(R1,R6,RE,RF),WORK=(R5)                       03890051
         BR    R7                 RETURN TO CALLER             @D14BDFR 03900051
         DROP  RE                                              @D36IDFR 03910051
         EJECT ,                                               @D149DIS 03920051
*********************************************************************** 03930051
*                                                                     * 03940051
*        RESOURCE POST ROUTINE                                        * 03950051
*                                                                     * 03960051
*********************************************************************** 03970051
*        FUNCTION :                                                   * 03980051
*              FREE RESOURCE AND POST WAITER                          * 03990051
*        ENTRY POINTS:                                                * 04000051
*              RPOST                                                  * 04010051
*              RPOSTPRX                                               * 04020051
*        INPUT REGISTER CONTENTS :                                    * 04030051
*              R1 = BOUND INFORMATION (OPTIONAL)                      * 04040051
*              R5 = ADDRESS OF RESOURCE DESCRIPTOR                    * 04050051
*              R6 = DISPATCHERS BASE ADDRESS                          * 04060051
*              RF = RETURN ADDRESS                                    * 04070051
*                                                                     * 04080051
*        AMODE: ANY                                                   * 04090051
*********************************************************************** 04100051
         SPACE 2                                               @D369DFR 04110051
         USING RQADR,R5                                        @D36IDFR 04120051
*SGLINK  RPOST,S,INPUT=(R1,R5,R6,RF),WORK=(R5,RE)              @D149DIS 04130051
         SPACE 1                                               @D369DFR 04140051
*--------------------------------------------------------------         04150051
*        DETERMINE RESOURCE TYPE AND GOTO CORRESP.ROUTINE      @D369DFR 04160051
*--------------------------------------------------------------         04170051
RPOST    TM    RQFLAG,SYSTQ+PARTQ IS IT A SYST.OR PART.RESOURCE@D14BDFR 04180051
         BZ    RPOSTPR            NO,GOTO TEST FOR OTHER TYPES @D14BDFR 04190051
         OI    RSCDESC,FREEBIT    OPEN RESOURCE GATE           @D66ODOW 04200063
.***                              ...KEEP OWNER, SOME FCT'S USE INFO    04201064
         CLI   RQCHAIN,TIBAVAIL   ANY WAITER ENQUEUED          @D14BDFR 04210051
         BNER  RF                 RETURN IF NOT                @D14BDFR 04220051
         SPACE 1                                               @D369DFR 04230051
*--------------------------------------------------------------         04240051
*        POST PARTITIONS ENQUEUED ON GIVEN RESOURCE            @D369DFR 04250051
*--------------------------------------------------------------         04260051
RPOST2   L     RE,RQCHAIN         POINT TO FIRST/NEXT TIB      @D14BDFR 04270051
         USING TIBADR,RE                                       @D14BDFR 04280051
         CLI   TIBCHAIN,TIBAVAIL  MULTIPLE WAITERS ENQUEUED    @D14BDFR 04290051
         BE    RPOST3             YES,GOTO FIND HIGHEST PRTY   @D14BDFR 04300051
*--------------------------------------------------------------         04310051
*        POST SINGLE WAITER                                    @D14BDFR 04320051
*--------------------------------------------------------------         04330051
         MVC   RQCHAIN,TIBCHAIN   RESET CHAIN HEADER           @D14BDFR 04340051
         DROP  RE                                              @D52VDIS 04350051
         EJECT ,                                               @D52VDIS 04360051
*--------------------------------------------------------------         04370051
* RPOST... - COMMON INTERNAL RPOST ROUTINES                             04380051
*--------------------------------------------------------------         04390051
* RPOSTPST - POST TASK AND PARTITION                                    04400051
*            INPUT: R6 - DISPATCHER BASE ADDRESS                        04410051
*                   RE - TIB ADDRESS                                    04420051
*                   RF - RETURN ADDRESS                                 04430051
*            WORK:  R5, RE                                              04440051
*--------------------------------------------------------------         04450051
         USING TIBADR,RE                                       @D52VDIS 04460051
*SGLINK  RPOSTPST,S,INPUT=(R6,RE,RF),WORK=(R5,RE)                       04470051
RPOSTPST DS    0H                                              @D52VDIS 04480051
         MVI   TIBRQID,READY      SET TASK READY               @D52VDIS 04490051
*--------------------------------------------------------------         04500051
* RPOSTPS0 - SECONDARY ENTRY POINT                                      04510051
*--------------------------------------------------------------         04520051
*SGLINK  RPOSTPS0,S,INPUT=(R6,RE,RF),WORK=(R5,RE)                       04530051
RPOSTPS0 DS    0H                                              @D52VDIS 04540051
*        DISPMAC FUNC=RPOST,INP1=RE READY TASK                 @D61RDIS 04550051
         DISPMAC FUNC=RPOST,INP1=RE READY TASK                 @D61RDIS 04560051
         BR    RF                 RETURN TO CALLER             @D61RDIS 04570051
         EJECT ,                                               @D52VDIS 04580051
*--------------------------------------------------------------         04590051
* RPOST3   - POST HIGHEST PRIORITY WAITER                               04600051
*--------------------------------------------------------------         04610051
RPOST3   DS    0H                                              @D61RDIS 04620051
*        DISPMAC FUNC=RPOST3,INP1=R5,INP2=RE POST HIGH PRIO.TSK@D61RDIS 04630051
         DISPMAC FUNC=RPOST3,INP1=R5,INP2=RE POST HIGH PRIO.TSK@D61RDIS 04640051
         BR    RF                 RETURN TO CALLER             @D61RDIS 04650051
         EJECT ,                                               @D52VDIS 04660051
*--------------------------------------------------------------         04670051
* RPOSTPR  - DETERMINE RESOURCE TYPE AND GOTO CORRESP.ROUTINE           04680051
*--------------------------------------------------------------         04690051
         USING RQADR,R5                                        @D52VDIS 04700051
RPOSTPR  TM    RQFLAG,WAITCHN     IS IT A CHAINED RESOURCE     @D14BDFR 04710051
         BO    RPOSTCHN           YES,IT IS A SYSTEM CHAIN     @D36IDFR 04720051
         TM    IJBFLG08,IJBDEBUG  DEBUG ON ?                   @D61NDIS 04730051
         BZ    RPOSTIO            NO, CONTINUE                 @D61NDIS 04740051
         TM    RQFLAG,IOCHN       IS IT IMPLEMENTED VIA SCAN   @D14BDFR 04750051
         BZ    RPOSTPRH           NO, SYSTEM ERROR             @D61NDIS 04760051
RPOSTIO  DS    0H                                              @D14BDFR 04770051
         SPACE 1                                               @D369DFR 04780051
*--------------------------------------------------------------         04790051
*        IT IS WAIT/ENQ SCAN TIBS IN ORDER TO FIND ANY WAITERS @D369DFR 04800051
*              WITH TIBSTATE EQUAL TO PASSED CONTENT OF R1     @D369DFR 04810051
*--------------------------------------------------------------         04820051
         L     RE,PCBPTR          POINTER TO ACTIVE PARTITION  @D36IDFR 04830051
         MVC   RPOSTID(1),RQID    SETUP CLI INSTRUCTION        @D36IDFR 04840051
         DROP  R5                                              @D36IDFR 04850051
         SPACE 1                                               @D369DFR 04860051
*SGLINK  RPOSTPRX,S,INPUT=(R1,R6,RE,RF),WORK=(R5)                       04870051
RPOSTPRX DS    0H                                              @D61RDIS 04880051
*        DISPMAC FUNC=RPOSTX,INP1=R1,INP2=RE                   @D61RDIS 04890051
         DISPMAC FUNC=RPOSTX,INP1=R1,INP2=RE                   @D61RDIS 04900051
         BR    RF                 RETURN TO CALLER             @D61RDIS 04910051
         SPACE 2                                               @D64ADIS 04920051
RPOSTID  DC    X'00'              SAVED BOUND CONDITION        @D64ADIS 04930051
         SPACE 2                                               @D61IDIS 04940051
*--------------------------------------------------------------         04950051
* RPOSTPRH - SYSTEM ERROR (HARDWAIT)                                    04960051
*--------------------------------------------------------------         04970051
RPOSTPRH DS    0H                                                       04980051
         MVI   IJBHWORG,HWORG012  UNIQUE HARD WAIT ORIGINATOR  @D31QDHB 04990051
         BAL   R5,SYSERROR        NO, HARD WAIT                @D14BDFR 05000051
         EJECT ,                                               @D149DIS 05010051
*--------------------------------------------------------------         05020051
* RPOSTCHN - POST ALL TASKS IN RESOURCE WAIT CHAIN WHOSE                05030051
*            TIBSTATE IS EQUAL TO PASSED CONTENT OF R1                  05040051
*--------------------------------------------------------------         05050051
*SGLINK RPOSTCHN,S,INPUT=(R1,R5,R6,RF),WORK=(R5,RE)                     05060051
RPOSTCHN DS    0H                                              @D14BDFR 05070051
         USING RQADR,R5                                        @D52VDIS 05080051
         CLI   RQCHAIN,TIBAVAIL   ANY TASK ENQUEUED            @D52VDIS 05090051
         BNER  RF                 NO,RETURN TO CALLER          @D52VDIS 05100051
         DROP  R5                                              @D52VDIS 05110051
*--------------------------------------------------------------         05120051
*            SCAN FOR TASKS WAITING FOR GIVEN RESOURCE                  05130051
*--------------------------------------------------------------         05140051
         ST    R4,RPOSTSAV        SAVE WORK REGISTER           @D52VDIS 05150051
         ST    RF,RPOSTSAV+4      SAVE WORK REGISTER           @D52VDIS 05160051
         LR    R4,R5              GET RESOURCE DESCRIPTOR      @D52VDIS 05170051
         USING RQADR,R4                                        @D52VDIS 05180051
RPOSTNXT DS    0H                                              @D52VDIS 05190051
         L     RE,RQCHAIN         POINTER TO FIRST/NEXT ENTRY  @D36IDFR 05200051
         USING TIBADR,RE                                       @D36IDFR 05210051
         C     R1,TIBSTATE        MATCHING WITH ARGUMENT ?     @D36IDFR 05220051
         BE    RPOSTDEQ           IF YES, DEQUEUE              @D36IDFR 05230051
         LR    R4,RE              SKIP THIS TASK               @D52VDIS 05240051
RPOSTNX1 DS    0H                                              @D52VDIS 05250051
         CLI   RQCHAIN,TIBAVAIL   ANY TASK ENQUEUED            @D52VDIS 05260051
         BE    RPOSTNXT           YES, CHECK NEXT TASK         @D52VDIS 05270051
         L     R4,RPOSTSAV        RESTORE ...                  @D52VDIS 05280051
         L     RF,RPOSTSAV+4              ... WORK REGISTERS   @D52VDIS 05290051
         BR    RF                 RETURN TO CALLER             @D52VDIS 05300051
         SPACE 2                                               @D52VDIS 05310051
*--------------------------------------------------------------         05320051
* RPOSTDEQ - POST TASK AND REMOVE IT FROM WAITER CHAIN                  05330051
*--------------------------------------------------------------         05340051
RPOSTDEQ DS    0H                                              @D52VDIS 05350051
         L     RF,TIBCHAIN        REMOVE TASK                  @D14BDFR 05360051
         ST    RF,RQCHAIN          FROM CHAIN                  @D36IDFR 05370051
         LA    RF,RPOSTNX1        RETURN FROM RPOSTPST         @D52VDIS 05380051
         B     RPOSTPST           POST TASK / PARTITION        @D52VDIS 05390051
*SGLINK  RPOSTPST,INPUT=(R6,RE,RF),WORK=(R5,RE)                         05400051
         DROP  R4                                              @D52VDIS 05410051
         DROP  RE                                              @D36IDFR 05420051
         EJECT ,                                               @D149DIS 05430051
**********************************************************************  05440051
*                                                                       05450051
*        POST AND IOPOST ROUTINES                                       05460051
*                                                                       05470051
**********************************************************************  05480051
*  FUNCTION:     POST  WAITER NOT ENQUEUED ON A RESOURCE                05490051
*  ENTRY POINTS: POST, IOPOST0, IOPOST1                                 05500051
*  INPUT:        R6 = DISPATCHERS BASE ADDRESS                          05510051
*                R8 = TIB POINTER                                       05520051
*                R8 = TID  (IF ENTERED AT IOPOST0)                      05530051
*                RF = RETURN ADDRESS                                    05540051
*            AMODE: ANY                                                 05550051
**********************************************************************  05560051
         USING TIBADR,R8                                       @D36IDFR 05570051
*SGLINK  POST,S,INPUT=(R6,R8,RF),WORK=(RE)                     @D149DIS 05580051
POST     DS    0H                                              @D14BDFR 05590051
         ST    R5,R5SAVE          SAVE REG 5                   @D52VDIS 05600051
         ST    RF,RFSAVE          AND  REG 15                  @D52VDIS 05610051
         TM    IJBFLG08,IJBDEBUG  DEBUG ON ?                   @D61NDIS 05620051
         BZ    IOPOST             NO, CONTINUE                 @D61NDIS 05630051
         CLI   TIBRQID,PARTGATE   IS IT A PARTITION RESOURCE   @D14BDFR 05640051
         BNL   HWPOST             YES, MUST BE AN ERROR        @D14BDFR 05650051
         SLR   RE,RE                                           @D14BDFR 05660051
         IC    RE,TIBRQID         GET BOUND CONDITION          @D14BDFR 05670051
         SLL   RE,3                                            @D14BDFR 05680051
         A     RE,ASRQTAB         POINT TO RESOURCE DESCRIPTOR @D61RDIS 05690051
         USING RQADR,RE                                        @D14BDFR 05700051
         TM    RQFLAG,IOCHN+PGATE USE OF POST ALLOWED          @D14BDFR 05710051
         BZ    HWPOST             NO, HARDWAIT                 @D52VDIS 05720051
         DROP  RE                                              @D14BDFR 05730051
IOPOST   DS    0H                                              @D52VDIS 05740051
         LR    RE,R8              GET TIB ADDRESS              @D52VDIS 05750051
         LA    RF,IOPOST6         RETURN FROM RPOSTPST         @D52VDIS 05760051
         B     RPOSTPST           POST TASK / PARTITION        @D52VDIS 05770051
*SGLINK  RPOSTPST,INPUT=(R6,RE,RF),WORK=(R5,RE)                         05780051
         SPACE 2                                               @D52VDIS 05790051
*--------------------------------------------------------------         05800051
* HWPOST   - SYSTEM ERROR (HARDWAIT)                                    05810051
*--------------------------------------------------------------         05820051
HWPOST   MVI   IJBHWORG,HWORG016  UNIQUE HARD WAIT ORIGINATOR  @D31QDHB 05830051
         BAL   R5,SYSERROR        NO, HARD WAIT                @D31QDHB 05840051
         EJECT ,                                               @D149DIS 05850051
*--------------------------------------------------------------         05860051
* IOPOST0  - POST ANY WAITBND TASK (INPUT: TID)                         05870051
*            INPUT: R6 = DISPATCHERS BASE ADDRESS                       05880051
*                   R8 = TID                                            05890051
*                   RF = RETURN ADDRESS                                 05900051
*            WORK:  R8, RE                                              05910051
*--------------------------------------------------------------         05920051
*SGLINK  IOPOST0,S,INPUT=(R6,R8,RF),WORK=(R8,RE)               @D149DIS 05930051
IOPOST0  DS    0H                                              @D36IDFR 05940051
         SLL   R8,2               GET                          @D66ODOW 05950056
         AL    R8,ATIBATAB        ... TIB                      @D66ODOW 05960056
         L     R8,0(,R8)          ....... POINTER              @D66ODOW 05970056
         SPACE 1                                               @D149DIS 05980051
*--------------------------------------------------------------         05990051
* IOPOST1  - POST ANY WAITBND TASK (INPUT: TIB)                         06000051
*            INPUT: R6 = DISPATCHERS BASE ADDRESS                       06010051
*                   R8 = TIB POINTER                                    06020051
*                   RF = RETURN ADDRESS                                 06030051
*            WORK:  RE                                                  06040051
*--------------------------------------------------------------         06050051
*SGLINK  IOPOST1,S,INPUT=(R6,R8,RF),WORK=(RE)                  @D149DIS 06060051
IOPOST1  DS    0H                                              @D52VDIS 06070051
         ST    R5,R5SAVE          SAVE REG 5                   @D52VDIS 06080051
         ST    RF,RFSAVE          AND  REG 15                  @D52VDIS 06090051
         L     R5,ASRQTAB         GET WAIT ...                 @D61RDIS 06100051
         LA    R5,SRQSV3-SRQTAB(,R5)   ... CONDITION           @D61RDIS 06110051
         USING RQADR,R5                                        @D61RDIS 06120051
         TM    RSCDESC,FREEBIT    ANYONE WAITING ON COMPLETION @D66ODOW 06130056
*                                 OF A SYSTEM TASK                      06140051
         BO    IOPOST5            NO, =====>                   @D66ODOW 06150056
         L     RE,TIBPCB                                       @DA36602 06160051
         C     RE,ASYSPCB         IS SYSTEM TASK TO BE POSTED  @DA36602 06170051
         BNE   IOPOST5            NO, =====>                   @DA36602 06180051
         BAL   RF,RPOST           POST WAITING TASKS           @DA36602 06190051
*SGLINK RPOST,INPUT=(R5,R6,RF),WORK=(R5,RE)                             06200051
         DROP  R5                                              @D61RDIS 06210051
IOPOST5  CLI   TIBRQID,WAITBND                                 @DA36602 06220051
         BE    IOPOST             YES, POST TASK               @D52VDIS 06230051
         EJECT ,                                               @D149DIS 06240051
*--------------------------------------------------------------         06250051
*          - TASK IS NOT 'WAIT BOUND'                                   06260051
*            IF WE ARE IN A MULTIPROCESSING ENVIRONMENT AND             06270051
*            THE TASK IS ACTIVE ON A DIFFERENT CPU, WE HAVE             06280051
*            TO INTERRUPT THAT CPU'S PROCESS VIA SIGP                   06290051
*--------------------------------------------------------------         06300051
         TM    SUPVFLAG,MPACT     MULTIPROCESSING ACTIVE ?     @KXANN16 06310051
         BZ    IOPOST6            YES, PROCESS OLD DISP CODE   @KXANN16 06320051
*        DISPMAC FUNC=SIGPTSK,INP1=R8 CHECK IF SIGP NECESSARY  @KXANN16 06330051
         DISPMAC FUNC=SIGPTSK,INP1=R8 CHECK IF SIGP NECESSARY  @KXANN16 06340051
IOPOST6  DS    0H                                              @D52VDIS 06350051
         L     R5,R5SAVE          RESTORE ...                  @D52VDIS 06360051
         L     RF,RFSAVE                  ... REGISTERS        @D52VDIS 06370051
         BR    RF                 RETURN TO CALLER             @D52VDIS 06380051
         DROP  R8                                              @D36IDFR 06390051
         EJECT ,                                               @D149DIS 06400051
         SPACE 4                                               @D369DFR 06410051
*********************************************************************** 06420051
*                                                                     * 06430051
*        UNPOST ROUTINE                                               * 06440051
*                                                                     * 06450051
*********************************************************************** 06460051
*                                                                     * 06470051
*        FUNCTION :                                                   * 06480051
*              UNPOST CURRENT TASK, ENQUEUE IN WAIT CHAIN             * 06490051
*        ENTRY POINT :                                                * 06500051
*              UNPOST                                                 * 06510051
*              SYSDEACT                                               * 06520051
*        INPUT REGISTER CONTENTS:                                     * 06530051
*              R1 = BOUND INFORMATION (OPTIONAL) (UNPOST ONLY)        * 06540051
*              R5 = RESOURCE QUEUE POINTER       (UNPOST ONLY)        * 06550051
*              R6 = DISPATCHERS BASE ADDRESS                          * 06560051
*              RF = RETURN ADDRESS                                    * 06570051
*                                                                     * 06580051
*        AMODE OF CALLER: ANY                                         * 06590051
*********************************************************************** 06600051
         SPACE 2                                               @D369DFR 06610051
*SGLINK  SYSDEACT,S,INPUT=(R6,RF),WORK=(R5,RE)                 @D149DIS 06620051
SYSDEACT DS    0H                                              @D61RDIS 06630051
         L     R5,ASRQTAB         POINT TO SYS.TASK. ...       @D61RDIS 06640051
         LA    R5,SRQSYS-SRQTAB(,R5)            ... DEACT.QUEUE@D61RDIS 06650051
         L     RE,TIBPTR          TIB OF SYSTEM TASK           @D14NDFG 06660051
         USING TIBADR,RE                                       @D14BDFR 06670051
         MVC   TIBRTID,TID        RESET SERVICE OWNER TASK     @D14NDFG 06680051
         MVC   TIBRPIK(2),H0      RESET SERVICE OWENR PART.    @D51IDIS 06690051
         XC    TIBSCB,TIBSCB      RESET ADDRESSAB. TO SHARED   @D14NDFG 06700051
         USING RQADR,R5                                        @D36IDFR 06710051
         SPACE 1                                               @D149DIS 06720051
*SGLINK  UNPOST,S,INPUT=(R1,R5,R6,RF),WORK=(R5,RE)             @D149DIS 06730051
UNPOST   L     RE,TIBPTR          GET TIB POINTER              @D14BDFR 06740051
         CLI   TIBRQID,CONDRDY    DO TASK HAS ANY RESERVATION  @D14BDFR 06750051
         BE    POSTNEXT           YES, GOTO POST NEXT WAITER   @D14BDFR 06760051
UNPOSTB  TM    RQFLAG,WAITCHN+IOCHN TASK SCAN TO BE DONE       @D14BDFR 06770051
         BZ    UNPOSTC            NO, CHECK FOR WAIT CHAIN     @D14BDFR 06780051
         LA    R1,0(,R1)          RESET HIGH ORDER BYTE AND    @D14BDFR 06790051
         ST    R1,TIBSTATE        STORE BOUND INFORMATION      @D14BDFR 06800051
UNPOSTC  TM    RQFLAG,SYSTQ+PARTQ+WAITCHN RES.WITH WAIT CHAIN  @D14BDFR 06810051
         BZ    UNPOSTD            NO, GOTO SETUP TASK TO WAIT  @D14BDFR 06820051
         NI    RSCDESC,NFREEMSK   KEEP RESOURCE IN USE         @D66ODOW 06830062
         MVC   TIBCHAIN(4),RQCHAIN INSERT TASKS TIB TO         @D14BDFR 06840051
         ST    RE,RQCHAIN         THE BEGIN OF CHAIN           @D14BDFR 06850051
         TM    RQFLAG,PARTQ       PARTITION QUEUE ?            @D....IS 06860051
         BZ    UNPOSTD            NO, GOTO SETUP TASK TO WAIT  @D....IS 06870051
         ST    R5,TIBPSRQ         SAVE SRQ ADDRESS FOR DEBUG   @D....IS 06880051
UNPOSTD  MVC   TIBRQID(1),RQID    SETUP TASKS STATUS FLAG      @D36IDFR 06890051
         EJECT ,                                               @D149DIS 06900051
*--------------------------------------------------------------         06910051
* UNPOSTPT - UNPOST TASK / PARTITION                                    06920051
*            INPUT: R6 = DISPATCHERS BASE ADDRESS                       06930051
*                   RE = TIB POINTER                                    06940051
*                   RF = RETURN ADDRESS                                 06950051
*            WORK:  R5, RE                                              06960051
*--------------------------------------------------------------         06970051
*SGLINK  UNPOSTPT,S,INPUT=(R6,RE,RF),WORK=(R5,RE)                       06980051
UNPOSTPT DS    0H                                              @D52VDIS 06990051
*        DISPMAC FUNC=UNPOST,INP1=RE PROCESS UNPOST REQUEST    @D61RDIS 07000051
         DISPMAC FUNC=UNPOST,INP1=RE PROCESS UNPOST REQUEST    @D61RDIS 07010051
         BR    RF                 RETURN TO CALLER             @D61RDIS 07020051
         EJECT ,                                               @D149DIS 07030051
*--------------------------------------------------------------         07040051
* POSTNEXT - POST NEXT TASK, IF IT HAS A RESERVATION                    07050051
*--------------------------------------------------------------         07060051
         USING RQADR,R5                                        @D36IDFR 07070051
         USING TIBADR,RE                                       @D51IDIS 07080051
POSTNEXT C     R5,TIBCHAIN        RE-WAIT FOR A RESERVED RESOUR@D14BDFR 07090051
         BE    UNPOSTB            YES, DO NOT POST NEXT WAITER @D14BDFR 07100051
         ST    R5,TIBSTATE        SAVE WORKREGISTER            @D14BDFR 07110051
         L     R5,TIBCHAIN        POINT TO RESERVED RES.QUEUE  @D14BDFR 07120051
         TM    RSCDESC,FREEBIT    IS IT A FREE RESOURCE        @D66ODOW 07130056
         BNO   UNPOSTA            NO, DO NOT POST ANY WAITER   @D66ODOW 07140056
         CLI   RQCHAIN,TIBAVAIL   ARE ANY WAITERS ENQUEUED     @D14BDFR 07150051
         BNE   UNPOSTA            NO, NO TASK TO BE POSTED     @D14BDFR 07160051
         ST    RF,TIBCHAIN        SAVE WORKREG                 @D14BDFR 07170051
         BAL   RF,RPOST2          CALL RESOURCE POST ROUTINE   @D14BDFR 07180051
*SGLINK  RPOST,INPUT=(R1,R5,R6,RF),WORK=(R5,RE)                         07190051
         L     RE,TIBPTR          RELOAD TIB POINTER           @D14BDFR 07200051
         L     RF,TIBCHAIN        RELOAD SAVED REGISTER        @D14BDFR 07210051
UNPOSTA  L     R5,TIBSTATE        RELOAD SAVED REGISTER        @D14BDFR 07220051
         B     UNPOSTB            RETURN TO UNPOST ROUTINE     @D14BDFR 07230051
         DROP  R5                                              @D36IDFR 07240051
         DROP  RE                                              @D36ZDFR 07250051
         EJECT ,                                               @D149DIS 07260051
*********************************************************************** 07270051
*                                                                     * 07280051
*        SETUP TASK TO RETRY ENTERING OF A SVC ROUTINE                * 07290051
*                                                                     * 07300051
*********************************************************************** 07310051
*                                                                     * 07320051
*        FUNCTION :                                                   * 07330051
*              SETUP TASK TO REENTER ENTSVC ROUTINE VIA A DISP.EXIT   * 07340051
*        ENTRY POINTS AND SPECIAL FUNCTION :                          * 07350051
*              RESVCIO : SET TASK TO CHANNEL QUEUE BOUND              * 07360051
*              RESVCX  : SET TASK TO RESOURCE BOUND                   * 07370051
*              RESVC   :                                              * 07380051
*        INPUT REGISTER CONTENTS:                                     * 07390051
*              R1 = BOUND INFORM. OR ZERO (RESVCIO/RESVCX)            * 07400051
*              R5 = PTR.TO RESOURCE DESCRIPTOR (RESVCIX)              * 07410051
*              R6 = DISPATCHERS BASE ADDRESS                          * 07420051
*        EXIT: TO DISPATCHER VIA R6                                   * 07430051
*                                                                     * 07440051
*        AMODE OF CALLER: ANY                                         * 07450051
*********************************************************************** 07460051
         SPACE 2                                               @D369DFR 07470051
*SGLINK  RESVCIO,S,INPUT=(R6),WORK=(R5,R8,RF)                  @D149DIS 07480051
RESVCIO  DS    0H                                              @D61RDIS 07490051
         L     R5,ASRQTAB         INDICATE CHANNEL ...         @D61RDIS 07500051
         LA    R5,SRQCHQ-SRQTAB(,R5)           ... QUEUE BOUND @D61RDIS 07510051
         SPACE 1                                               @D149DIS 07520051
*SGLINK  RESVCX,S,INPUT=(R5,R6),WORK=(R8,RF)                   @D149DIS 07530051
RESVCX   BAL   RF,UNPOST          ENQUEUE TASK IN WAIT CHAIN   @D36IDFG 07540051
*SGLINK  UNPOST,INPUT=(R5,R6,RF),WORK=(R5,RE)                           07550051
         SPACE 1                                               @D149DIS 07560051
*SGLINK  RESVC,S,INPUT=(R6),WORK=(R8)                          @D149DIS 07570051
RESVC    L     R8,TIBPTR          LOAD TIB POINTER             @D36IDFR 07580051
         USING TIBADR,R8          TIB BASE POINTER             @D36IDFR 07590051
         OI    TIBFLAG,RETRYSVC   SETUP DISP.EXIT RETRY SVC    @D36IDFR 07600051
         DROP  R8                                              @D36IDFR 07610051
         BR    R6                 GOTO TASK SELECTION          @D36IDFR 07620051
         EJECT ,                                               @D149DIS 07630051
*********************************************************************** 07640051
*                                                                     * 07650051
*        SETUP TASK TO REISSUE SVC                                    * 07660051
*                                                                     * 07670051
*********************************************************************** 07680051
*                                                                     * 07690051
*        FUNCTION :                                                   * 07700051
*              RESET DISP.EXIT FLAG AND SETUP TASK TO REISSUE SVC     * 07710051
*        ENTRY POINT:                                                 * 07720051
*              SETRESVC                                               * 07730051
*        INPUT REGISTER CONTENTS:                                     * 07740051
*              R5 = RETURN ADDRESS                                    * 07750051
*              R6 = DISPATCHERS BASE ADDRESS                          * 07760051
*              R8 = TIB POINTER                                       * 07770051
*              RA = TCB POINTER                                       * 07780051
*              RB = SAVEAREA POINTER                                  * 07790051
*                                                                     * 07800051
*            AMODE: ANY                                                 07810051
*********************************************************************** 07820051
         SPACE 2                                               @D35IDFR 07830051
         USING TIBADR,R8                                       @D36IDFR 07840051
         USING TCBADR,RA                                       @D36IDFR 07850051
         USING SVEARA,RB                                       @D36IDFR 07860051
*SGLINK  RESRETRY,S,INPUT=(R6,R8,RA,RB),WORK=(R5,R9)           @D149DIS 07870051
RESRETRY LR    R5,R6                                           @D14BDFR 07880051
         MVI   RID+1,REENTRID     IDENTIFY REENTRANT ROUTINE   @D14BDFR 07890051
         SPACE 1                                               @D149DIS 07900051
*SGLINK  SETRESVC,S,INPUT=(R5,R6,R8,RA,RB),WORK=R9             @D149DIS 07910051
SETRESVC DS    0H                                              @D14BDFR 07920051
         L     R9,SVEPSW2         LOAD ADDRESS FROM TASKS PSW  @D36IDFR 07930051
         SH    R9,INTINFO         REDUCE IT BY SVC LENGTH CODE @D36IDFR 07940051
         ST    R9,SVEPSW2         RESTORE PSW ADDRESS          @D36IDFR 07950051
         NI    TIBFLAG,XFF-RETRYSVC RESET SVC RETRY EXIT FLAG  @D14BDFR 07960051
         BR    R5                 RETURN TO CALLER             @D36IDFR 07970051
         DROP  R8                                              @D36IDFR 07980051
         DROP  RA                                              @D36IDFR 07990051
         DROP  RB                                              @D36IDFR 08000051
         EJECT ,                                               @D149DIS 08010051
*********************************************************************** 08020051
*                                                                     * 08030051
*        PROPAGATE TASK TERMINATION                                   * 08040051
*                                                                     * 08050051
*********************************************************************** 08060051
* RDYCNCL  - PROPAGATE TASK TERMINATION FOR ONE SPECIFIC TASK           08070051
* RDYCNCLY   (ENTRY POINT RDYCNCLY) OR ALL TASKS OF A PARTITION.        08080051
* VSECNCL    ENTRY POINT TO CANCEL ALL TASKS WITHIN A PARTITION         08090051
*            THAT ARE ATTACHED VIA VSE ATTACH                           08100051
*                                                                       08110051
*          - SOFT CANCEL:                                               08120051
*             FUNCTION IS PERFORMED WHEN A TASK IS                      08130051
*             TERMINATOR OWNER OR IT IS NOT TERMINATING YET.            08140051
*             A CANCEL CODE IS SET INTO THE TIB (TIBCNCL BYTE).         08150051
*          - HARD CANCEL:                                               08160051
*             WITH NO REGARD TO TASKS STATUS A CANCEL CODE IS           08170051
*             IS SET INTO THE TIB (TIBCNCL/TIBCNCL2 BYTE).              08180051
*                                                                       08190051
*          - WHEN NECESSARY, THE DISPATCHER CANCEL EXIT IS              08200051
*            ACTIVATED (FETCHEOJ BIT IN TIBFLAG) AND                    08210051
*            THE TASK IS MADE READY (CALLING SETREADY ROUTINE)          08220051
*                                                                       08230051
*          CANCEL CODES :                                               08240051
*             X'1D' : CANCEL DUE TO MAINTASK TERMINATION                08250051
*             X'NN' : CANCEL CODE PARAMETER PASSED VIA R1               08260051
*                                                                       08270051
*          INPUT: R1 = CANCEL CODE                                      08280051
*                 R5 = -1                        (RDYCNCLY ONLY)        08290051
*                 R6 = DISPATCHERS BASE ADDRESS                         08300051
*                 R7 = RETURN ADDRESS                                   08310051
*                 R8 = TIB ADDRESS               (RDYCNCLY ONLY)        08320051
*                 R9 = PCB ADDRESS                                      08330051
*          WORK:  R5, R8, RE, RF                                        08340051
*          AMODE: ANY                                                   08350051
*********************************************************************** 08360051
         SPACE 2                                               @D35EDFR 08370051
         USING PCBADR,R9                                       @D36IDFR 08380051
*SGLINK VSECNCL,S,INPUT=(R1,R6,R7,R9),WORK=(R5,R8,RE,RF)                08390051
VSECNCL  DS    0H                                              @D64ADIS 08400051
         MVI   VCNCFLAG,X'80'    INDICATE VSE CANCEL REQUEST   @D64ADIS 08410051
         LH    R5,PCBLCTSS        NUMBER OF SUBTASKS           @D64ADIS 08420051
         ST    R7,RDYRTSAV        SAVE RETURN REGISTER         @D64ADIS 08430051
         ST    RD,RDYSAVRD        SAVE REGISTER 13             @D64ADIS 08440051
         SLR   R8,R8              PREPARE INDICATOR            @D66ODOW 08441056
         L     RD,ADISPCNC        GET BASE ADDR. OF CANCEL ROUT@D64ADIS 08442051
         BR    RD                 PROPAGATE TASK TERMINATION   @D64ADIS 08443051
*SGLINK DISPCNCL,INPUT=(R1,R6,R9,RD),WORK=(R5,R7,R8,RE,RF)              08444051
         SPACE 1                                               @D64ADIS 08445051
VCNCFLAG DC    X'00'             VSE CANCEL INDICATION         @D64ADIS 08446051
         DS    0F                                              @D64ADIS 08447051
         SPACE 2                                               @D64ADIS 08448051
*SGLINK RDYCNCL,S,INPUT=(R1,R6,R7,R9),WORK=(R5,R8,RE,RF)                08449051
RDYCNCL  LH    R5,PCBLCTSS        NUMBER OF ATTACHED SUBRASKS  @D36IDFR 08450051
         MVI   VCNCFLAG,X'00'    INDICATE NORMAL CNCL REQUEST  @D64ADIS 08460051
         ST    R7,RDYRTSAV        SAVE RETURN REGISTER         @D52HDIS 08470051
         ST    RD,RDYSAVRD        SAVE REGISTER 13             @D61NDIS 08480051
         SLR   R8,R8              PREPARE INDICATOR            @D66ODOW 08490056
         L     RD,ADISPCNC        GET BASE ADDR. OF CANCEL ROUT@D61NDIS 08500051
         BR    RD                 PROPAGATE TASK TERMINATION   @D61NDIS 08510051
*SGLINK DISPCNCL,INPUT=(R1,R6,R9,RD),WORK=(R5,R7,R8,RE,RF)              08520051
         DROP  R9                                              @D61NDIS 08530051
         EJECT ,                                               @D61NDIS 08540051
*--------------------------------------------------------------         08550051
* RDYCNCLY - PROCESS CANCEL FOR A SPECIFIC TASK                         08560051
*            CALLED BY SGTINF (TREADY COND=CANCEL)                      08570051
*--------------------------------------------------------------         08580051
*SGLINK RDYCNCLY,S,INPUT=(R1,R5,R6,R7,R8,R9),WORK=(R5,R8,RE,RF)         08590051
RDYCNCLY DS    0H                                              @D61NDIS 08600051
         MVI   VCNCFLAG,X'00'    INDICATE NORMAL CNCL REQUEST  @D64ADIS 08610051
         ST    R7,RDYRTSAV        SAVE RETURN REGISTER         @D52HDIS 08620051
         ST    RD,RDYSAVRD        SAVE REGISTER D              @D61NDIS 08630051
         L     RD,ADISPCNC        GET BASE ADDR. OF CANCEL ROUT@D61NDIS 08640051
         USING DISPCNCL,RD                                     @D61NDIS 08650051
         B     DISPCNCY           GET ENTRY POINT ADDRESS      @D61NDIS 08660051
*SGLINK DISPCNCY,INPUT=(R1,R5,R6,R8,R9,RD),WORK=(R5,R7,R8,RE,RF)        08670051
         DROP  RD                                              @D61NDIS 08680051
         SPACE 2                                               @D52HDIS 08690051
*--------------------------------------------------------------         08700051
* RDYCNRET - RESTORE RETURN REGISTER AND RETURN TO CALLER               08710051
*--------------------------------------------------------------         08720051
RDYCNRET DS    0H                                              @D52HDIS 08730051
         L     RD,RDYSAVRD        RESTORE REGISTER D           @D61NDIS 08740051
         L     R7,RDYRTSAV        LOAD RETURN REGISTER         @D52HDIS 08750051
         BR    R7                 RETURN TO  CALLER            @D52HDIS 08760051
         SPACE 1                                               @D52HDIS 08770051
         DS    0F                                              @D52HDIS 08780051
RDYRTSAV DC    F'0'               SAVED RETURN ADDRESS         @D52HDIS 08790051
RDYSAVRD DC    F'0'               SAVED REGISTER 13            @D61NDIS 08800051
         EJECT ,                                               @D149DIS 08810051
*********************************************************************** 08820051
*                                                                     * 08830051
*        READY TASK UNCONDITIONAL                                     * 08840051
*                                                                     * 08850051
*********************************************************************** 08860051
* SETREADY - SET TASK READY FOR CANCEL (READY TASK UNCONDITIONAL)       08870051
*            INPUT: R6 = BASE REGISTER                                  08880051
*                   R8 = TIB POINTER                                    08890051
*                   RF = RETURN ADDRESS                                 08900051
*            AMODE: ANY                                                 08910051
*********************************************************************** 08920051
         USING TIBADR,R8                                       @D36IDFR 08930051
*SGLINK  SETREADY,S,INPUT=(R6,R8,RF),WORK=(RE)                 @D36IDFR 08940051
SETREADY ST    RF,RPOSTSAV        SAVE RETURN ADDR.            @D36IDFR 08950051
         ST    R4,RPOSTSAV+4      SAVE REGISTER   .            @D52VDIS 08960051
         ST    R5,RPOSTSAV+8      SAVE REGISTER   .            @D52VDIS 08970051
         SLR   R4,R4                                           @D52VDIS 08980051
         IC    R4,TIBRQID         GET BOUND CONDITION          @D52VDIS 08990051
         SLL   R4,3                                            @D52VDIS 09000051
         CLI   TIBRQID,PARTGATE   IS IT A PARTITION RESOURCE   @D14BDFR 09010051
         BNL   RDYPARTQ           YES, GOTO ADDR.IT IN PCB     @D14BDFR 09020051
         A     R4,ASRQTAB        ADDRESS OF RESOURCE DESCRIPT. @D61RDIS 09030051
         USING RQADR,R4                                        @D52VDIS 09040051
RDYTESTQ DS    0H                                              @D64ADIS 09050051
*        DISPMAC FUNC=SETREADY,INP1=R8,INP2=R4 SIGP NECESSARY ?@D64ADIS 09060051
         DISPMAC FUNC=SETREADY,INP1=R8,INP2=R4 SIGP NECESSARY ?@D64ADIS 09070051
         TM    RQFLAG,NORDY       ALLOWED TO READY             @D64ADIS 09080051
         BO    SETREADX           NO,RETURN TO CALLER          @D64ADIS 09090051
         LR    RE,R8              GET TIB ADDRESS              @D52VDIS 09100051
         BAL   RF,RPOSTPST        POST TASK / PARTITION        @D52VDIS 09110051
*SGLINK  RPOSTPST,INPUT=(R6,RE,RF),WORK=(R5,RE)                         09120051
         TM    RQFLAG,WAITCHN+SYSTQ+PARTQ IS IT A CHAINED RES.?@D14BDFR 09130051
         BZ    SETREADX           NO,GOTO RETURN TO CALLER     @D36IDFR 09140051
         B     RDYCHNE            GOTO ENTRY OF SCAN ROUTINE   @D36IDFR 09150051
         SPACE 2                                               @D52VDIS 09160051
RDYPARTQ S     R4,DPGATE          DETERMINE DISPL.IN PCB       @D52VDIS 09170051
         A     R4,TIBPCB          POINT TO RESOURCE DESCRIPTOR @D52VDIS 09180051
         B     RDYTESTQ           GOTO TEST RESOURCE           @D14BDFR 09190051
         EJECT ,                                               @D64ADIS 09200051
*--------------------------------------------------------------         09210051
* RDYCHNE  - REMOVE TIB FROM TIB CHAIN (CHAINED RESOURCES)              09220051
*            INPUT: R4 = ADDRESS OF RESOURCE DESCRIPTOR                 09230051
*                   R6 = BASE REGISTER                                  09240051
*                   R8 = TIB POINTER                                    09250051
*                   RF = RETURN ADDRESS (SAVED IN RPOSTSAV)             09260051
*            AMODE: ANY                                                 09270051
*--------------------------------------------------------------         09280051
RDYCHNL  L     R4,RQCHAIN         POINT TO CHAIN FIELD         @D36IDFG 09290051
RDYCHNE  DS    0H                                              @D52VDIS 09300051
         CLI   RQCHAIN,TIBAVAIL   ALL TIBS IN CHAIN PROCESSED ?@D52VDIS 09310051
         BNE   SETREADC           YES, CHECK FOR OTHER PART.   @D52VDIS 09320051
         C     R8,RQCHAIN         IS THIS THE PREDECESSOR      @D52VDIS 09330051
         BNE   RDYCHNL            IF NOT, SEARCH FURTHER       @D36IDFG 09340051
         L     RF,TIBCHAIN        REMOVE TASK                  @D36IDFG 09350051
         ST    RF,RQCHAIN          FROM CHAIN                  @D36IDFG 09360051
SETREADX L     RF,RPOSTSAV        RELOAD RETURN ADDRESS        @D36IDFR 09370051
         L     R4,RPOSTSAV+4      RESTORE REGISTER             @D52VDIS 09380051
         L     R5,RPOSTSAV+8      RESTORE REGISTER             @D52VDIS 09390051
         BR    RF                 RETURN TO CALLER             @D36IDFR 09400051
         SPACE 2                                               @D52VDIS 09410051
*--------------------------------------------------------------         09420051
* SETREADC - IF TIB IS NOT ENQUEUED ON TIB'S PCB RESOURCE,              09430051
*            HARDWAIT                                                   09440051
*--------------------------------------------------------------         09450051
SETREADC DS    0H                                              @D....IS 09460051
         MVI   IJBHWORG,HWORG008  UNIQUE HARD WAIT ORIGINATOR  @D52VDIS 09470051
         BAL   R5,SYSERROR        HARD WAIT OTHERWISE          @D52VDIS 09480051
         DROP  R8                                              @D36IDFR 09490051
         DROP  R4                                              @D52VDIS 09500051
         TITLE 'VSE/AF SUPERVISOR    DISP          VALIDATION ROUTINES' 09510051
*********************************************************************** 09520051
*        ADDRESS VALIDATION ROUTINE.                                  * 09530051
*********************************************************************** 09540051
*                                                                     * 09550051
*        VALIDATES THE SPECIFIED ADDRESS RANGE FOR READ OR WRITE      * 09560051
*         ENTRY POINTS :                                              * 09570051
*              VALIDSVA : USED FOR THOSE SVC'S WHICH CAN HAVE         * 09580051
*                         PARAMETER LIST IN SVA,                      * 09590051
*                         DYNAMIC GETVIS AREA OR PARTITION            * 09600051
*              VALIDGSP : USED FOR THOSE SVC'S WHICH CAN HAVE         * 09610051
*                         PARAMETER LIST IN                           * 09620051
*                         DYNAMIC GETVIS AREA OR PARTITION            * 09630051
*              VALID, VALIDR2, VALIDPAR (OLD INTERFACE):              * 09640051
*                         AREA MIGHT BE IN PARTITION OR LTA           * 09650051
*                         IF INVALID ADDRESS, BRANCH TO ERR25         * 09660051
*              VALIDAD, VALWRITE:       (NEW INTERFACE):              * 09670051
*                         AREA MIGHT BE IN PARTITION OR LTA           * 09680051
*                         IF VALID ADDRESS, RETURN WITH OFFSET 8.     * 09690051
*                         IF INVALID ADDRESS, RETURN                  * 09700051
*                            RETURN WITH OFFSET 0 OR 4.               * 09710051
*              VALREAD:   VALIDATION FOR READ ACCESS                  * 09720051
*                                                                     * 09730051
*        AMODE: ANY                                                   * 09740051
*               R1, R2 CONTENTS USED AS 4 BYTE ADDRESSES              * 09750051
*        ALL SERVICES ARE NON-PARALLEL                                  09760051
*********************************************************************** 09770051
         EJECT ,                                                        09780051
*--------------------------------------------------------------         09790051
* VALIDSVA - VALIDATION OF PARAMETER LIST THAT MAY BE LOCATED           09800051
*            IN SVA                                                     09810051
*            INPUT REGISTER:                                            09820051
*              R1 - LOW ADDRESS OF AREA TO BE VALIDATED                 09830051
*              R2 - HIGH ADDRESS OF AREA                                09840051
*              R6 - BASE REGISTER                                       09850051
*              R8 - RETURN ADDRESS                                      09860051
*            WORK REGISTER: R2, R5                                      09870051
*            EXIT: USER TASK CANCELLED ERR25 (INVALID ADDRESS)          09880051
*            AMODE: ANY                                                 09890051
*--------------------------------------------------------------         09900051
*SGLINK  VALIDSVA,S,INPUT=(R1,R2,R6,R8),WORK=(R2,R5)                    09910051
VALIDSVA LA    R1,0(,R1)          GET ADDRESS ALONE            @D14BDFR 09920051
         L     R5,IJBSMCOM        GET SMCOM ADDRESS            @D52VDIS 09930051
         USING SMCOM,R5                                        @D52VDIS 09940051
         C     R1,SMCSVA          LOW ADDRESS IN SUPERVISOR ?  @D52VDIS 09950051
         BL    VALID              YES, VALIDATE ADDRESS        @D52VDIS 09960051
         LA    R2,0(,R2)          CHECK LENGTH OF PARAMETERLIST@D14BDFR 09970051
         CLR   R2,R1              END BELOW BEGIN ?            @D35CDEM 09980051
         BL    ERR25              YES, WRAP AROUND , ERROR     @D35CDEM 09990051
         CL    R2,SMCESVA         HIGH ADDR IN SVA (24 BIT)    @D52VDIS 10000051
         BNH   VALIDVP            YES, CHECK IF ADDR. IN VPOOL @KX40089 10010051
         C     R1,SMCSVA31        LOW ADDRESS IN PRIV. SPACE ? @D52VDIS 10020051
         BL    VALIDGSP           YES, VALIDATE PRIV. AREA     @D52VDIS 10030051
         CL    R2,EOVSADR         HIGH ADDRESS IN VIRT.STOR    @D51GDRP 10040051
         BH    ERR25              NO,ERROR                     @D51GDRP 10050051
         BR    R8                 YES, MUST BE IN 31 BIT SVA   @D52VDIS 10060051
         DROP  R5                                              @D51GDRP 10070051
         EJECT ,                                                        10080051
*--------------------------------------------------------------         10090051
* VALIDVP  - IF THE ADDRESS IS LOCATED IN THE VPOOL AREA                10100051
*              AS PART OF THE SVA (24 BIT), THE APPLICATION             10110051
*              WILL BE CANCELLED WITH INVALID ADDRESS                   10120051
*--------------------------------------------------------------         10130051
VALIDVP  DS    0H                 VALIDATE NON-SVA ADDRESS     @KX40089 10140051
         CL    R2,AVPBEG          ADDR IN VPOOL                @KX40089 10150051
         BLR   R8                 NO, ADDRESS IS VALID         @KX40089 10160051
         CL    R2,AVPEND          ADDR REALLY IN VPOOL         @KX40089 10170051
         BNH   ERR25              YES, ADDR INVALID            @KX40089 10180051
         SPACE 2                                               @KX40089 10190051
VALIDGSP DS    0H                 VALIDATE NON-SVA ADDRESS     @D52VDIS 10200051
*--------------------------------------------------------------         10210051
* VALIDGSP - VALIDATION OF PARAMETER LIST THAT MAY BE LOCATED           10220051
*            IN THE DYNAMIC GETVIS AREA                                 10230051
*            INPUT REGISTER:                                            10240051
*              R1 - LOW ADDRESS OF AREA TO BE VALIDATED                 10250051
*              R2 - HIGH ADDRESS OF AREA                                10260051
*              R6 - BASE REGISTER                                       10270051
*              R8 - RETURN ADDRESS                                      10280051
*            WORK REGISTER: R2, R5                                      10290051
*            EXIT: USER TASK CANCELLED ERR25 (INVALID ADDRESS)          10300051
*            AMODE: ANY                                                 10310051
*--------------------------------------------------------------         10320051
*SGLINK  VALIDGSP,S,INPUT=(R1,R2,R6,R8),WORK=(R2,R5)                    10330051
         LA    R1,0(,R1)          RESET HIGH ORDER BYTE/BIT    @DY40100 10340051
         L     R5,SCBPTR          GET CURRENT SCB ADDRESS      @DY40100 10350051
         USING SCBADR,R5                                       @DY40100 10360051
         CLI   SCBID+1,X'40'      DYNAMIC SPACE GETVIS AVAIL.? @DY40100 10370051
         BE    VALID              NO,VALIDATE NON-DYN.SP.GETVIS@DY40100 10380051
         C     R1,SCBSPGVB        LOW ADDRESS IN DYN.SP.GETVIS @DY40100 10390051
         BL    VALID              NO,VALIDATE NON-DYN.SP.GETVIS@DY40100 10400051
         LA    R2,0(,R2)          CHECK LENGTH OF PARAMETERLIST@DY40100 10410051
         CLR   R2,R1              END BELOW BEGIN ?            @DY40100 10420051
         BL    ERR25              YES, WRAP AROUND , ERROR     @DY40100 10430051
         CL    R2,SCBSPGVE        HIGH ADDR IN DYN.SPACE GETVIS@DY40100 10440051
         BNHR  R8                 YES,RETURN TO CALLER         @DY40100 10450051
         DROP  R5                                              @DY40100 10460051
         EJECT ,                                                        10470051
*--------------------------------------------------------------         10480051
*        VALIDATION FOR WRITE AUTHORIZATION                    @D14BDFR 10490051
*--------------------------------------------------------------         10500051
* VALIDPAR - VALIDATION OF PARAMETER LIST THAT MAY BE LOCATED           10510051
* VALIDR2    IN THE PARTITION OR LTA OR IN SVA FOR                      10520051
* VALID      PRIVILEGED ROUTINES                                        10530051
*            INPUT REGISTER:                                            10540051
*              R1 - LOW ADDRESS OF AREA TO BE VALIDATED                 10550051
*              R2 - HIGH ADDRESS OF AREA                                10560051
*              R6 - BASE REGISTER                                       10570051
*              R8 - RETURN ADDRESS                                      10580051
*            OUTPUT REGISTER:                                           10590051
*              R5 - STORAGE KEY                                         10600051
*            WORK REGISTER: R2                                          10610051
*            EXIT: USER TASK CANCELLED ERR25 (INVALID ADDRESS)          10620051
*            AMODE: ANY                                                 10630051
*--------------------------------------------------------------         10640051
         SPACE 1                                               @D14BDFR 10650051
VALIDPAR DS    0H                                              @D14BDFR 10660051
         SPACE 1                                               @D149DIS 10670051
*SGLINK  VALID,S,INPUT=(R1,R2,R6,R8),WORK=(R2),OUTPUT=(R5)     @D149DIS 10680051
VALID    DS    0H                                              @D14BDFR 10690051
         ST    R8,TEMPSAV         SIMULATE NEW INTERFACE       @D14BDFR 10700051
         LA    R8,VALIDAX         FOR OLD CALLS                @D14BDFR 10710051
         SPACE 1                                               @D14BDFR 10720051
*--------------------------------------------------------------         10730051
* VALIDAD  - VALIDATION OF PARAMETER LIST THAT MAY BE LOCATED           10740051
*            IN THE PARTITION OR LTA OR IN SVA FOR                      10750051
*            PRIVILEGED ROUTINES                                        10760051
*            USED KEY = KEY OF SERVICE OWNER                            10770051
*            INPUT REGISTER:                                            10780051
*              R1 - LOW ADDRESS OF AREA TO BE VALIDATED                 10790051
*              R2 - HIGH ADDRESS OF AREA                                10800051
*              R6 - BASE REGISTER                                       10810051
*              R8 - RETURN ADDRESS                                      10820051
*            OUTPUT REGISTER:                                           10830051
*              R5 - STORAGE KEY                                         10840051
*            WORK REGISTER: R2, R8                                      10850051
*            EXIT: R8 + 0 = INCORRECT ADDRESS                           10860051
*                  R8 + 4 = PROTECTION VIOLATION                        10870051
*                  R8 + 8 = AUTHORIZATION OK                            10880051
*            AMODE: ANY                                                 10890051
*--------------------------------------------------------------         10900051
*SGLINK  VALIDAD,S,INPUT=(R1,R2,R6,R8),WORK=(R2,R8),OUTPUT=(R5)         10910051
VALIDAD  DS    0H                                              @D14BDFR 10920051
         LH    R5,PIK             GET PARTITION KEY            @D14BDFR 10930051
         EJECT ,                                                        10940051
*--------------------------------------------------------------         10950051
* VALWRITE - VALIDATION OF AREA THAT MAY BE LOCATED                     10960051
*            IN THE PARTITION OR LTA OR IN SVA FOR                      10970051
*            PRIVILEGED ROUTINES                                        10980051
*            INPUT REGISTER:                                            10990051
*              R1 - LOW ADDRESS OF AREA TO BE VALIDATED                 11000051
*              R2 - HIGH ADDRESS OF AREA                                11010051
*              R5 - PIK                                                 11020051
*              R6 - BASE REGISTER                                       11030051
*              R8 - RETURN ADDRESS                                      11040051
*            OUTPUT REGISTER:                                           11050051
*              R5 - STORAGE KEY                                         11060051
*            WORK REGISTER: R2, R8                                      11070051
*            EXIT: R8 + 0 = INCORRECT ADDRESS                           11080051
*                  R8 + 4 = PROTECTION VIOLATION                        11090051
*                  R8 + 8 = AUTHORIZATION OK                            11100051
*            AMODE: ANY                                                 11110051
*--------------------------------------------------------------         11120051
*SGLINK  VALWRITE,S,INPUT=(R1,R2,R5,R6,R8),WORK=(R2,R8),OUTPUT=(R5)     11130051
VALWRITE DS    0H                                              @D14BDFR 11140051
         ST    RD,VALIDSA1        SAVE REGISTER                @D61NDIS 11150051
         LA    R2,0(,R2)          RESET HIGH ORDER BYTE/BIT    @D14BDFR 11160051
         LA    R1,0(,R1)          RESET HIGH ORDER BYTE/BIT    @D14BDFR 11170051
         CR    R2,R1              END ADDRESS LOWER THEN BEGIN @D14BDFR 11180051
         BLR   R8                 RETURN,INVALID ADDRESS       @D14BDFR 11190051
         SRL   R5,2               DIVIDE PIK BY 4              @D51IDIS 11200051
         A     R5,APCBATAB        POINT TO PCB OF SERV.OWNER   @D51IDIS 11210051
         L     R5,0(,R5)          POINT TO SERV.OWNERS PCB     @D14BDFR 11220051
         ST    R5,VALIDPCB        SAVE PCB ADDRESS             @D52VDIS 11230051
         USING PCBADR,R5                                       @D14BDFR 11240051
         MVC   VALIDKEY+1(1),PCEKEY   SETUP KEY FOR VALIDATION @D51IDIS 11250051
         ST    RD,VALIDSA1        SAVE    REGISTER D           @D61NDIS 11260051
         L     RD,ADISPVAW        GET ADDR. OF WRITE VAL. ROUT.@D61NDIS 11270051
VALIDCOM DS    0H                                              @D52VDIS 11280051
         LA    R8,0(,R8)          CLEAR HIGH ORDER BIT/BYTE    @D52VDIS 11290051
         ST    R8,VALIDSRT        SAVE RETURN REGISTER         @D52VDIS 11300051
         ST    RF,VALIDSA2        SAVE    REGISTER F           @D52VDIS 11310051
         LA    RF,8               SET OFFSET FOR RETURN        @D52VDIS 11320051
*        AMODESW CALL,REGS=(8,13) CALL R/W VALIDATION ROUT.    @D61NDIS 11330051
         AMODESW CALL,REGS=(8,13) CALL R/W VALIDATION ROUT.    @D61NDIS 11340051
         EJECT ,                                                        11350051
*--------------------------------------------------------------         11360051
* VALIDRET - SIMULATE 31 BIT VALIDATION INTERFACE                       11370051
*--------------------------------------------------------------         11380051
VALIDRET DS    0H                                              @D52VDIS 11390051
         S     RF,F4              ENTRY POINT - INCORRECT ADDR.@D52VDIS 11400051
         S     RF,F4              ENTRY POINT - PROTECTION VOI.@D52VDIS 11410051
         AL    RF,VALIDSRT        GET RETURN ADDRESS           @D52VDIS 11420051
         N     R8,BIT0OMSK        GET AMODE ALONE              @D61NDIS 11430051
         OR    R8,RF              GET AMODE + RETURN ADDRESS   @D61NDIS 11440051
         L     RF,VALIDSA2        RESTORE REGISTER F           @D52VDIS 11450051
         L     RD,VALIDSA1        RESTORE REGISTER D           @D61NDIS 11460051
*        AMODESW RETURN,REG=(8)             RETURN TO CALLER            11470051
         AMODESW RETURN,REG=(8)             RETURN TO CALLER   @D52VDIS 11480051
         SPACE 2                                                        11490051
*--------------------------------------------------------------         11500051
* VALIDAX  - SIMULATE OLD VALIDATION INTERFACE                          11510051
*--------------------------------------------------------------         11520051
VALIDAX  DS    0H                                              @D52VDIS 11530051
         B     ERR25              INCORRECT ADDRESS,CANCEL     @D52VDIS 11540051
         B     ERR25              PROTECTION VIOLATION,CANCEL  @D14BDFR 11550051
         L     R8,TEMPSAV         AUTHORIZATION OK             @D14BDFR 11560051
         BR    R8                    RETURN TO CALLER          @D14BDFR 11570051
         DROP  R5                                              @D64ADIS 11580051
         EJECT ,                                               @D14BDFR 11590051
*--------------------------------------------------------------         11600051
* VALREAD  - VALIDATION FOR READ ACCESS BASED ON GIVEN STORAGE KEY      11610051
* VALREADK - VALIDATION FOR READ ACCESS BASED ON PSW KEY                11620051
*            OF CURRENT ACTIVE TASK                                     11630051
* VALREADN - VALIDATION FOR READ ACCESS BASED ON PROGRAM KEY MASK       11640051
*            OF CURRENT ACTIVE TASK                                     11650051
*            INPUT REGISTER:                                            11660051
*              R1 - LOW ADDRESS OF AREA TO BE VALIDATED                 11670051
*              R2 - HIGH ADDRESS OF AREA                                11680051
*              R5 - STORAGE KEY (VALREAD ONLY)                          11690051
*              R6 - BASE REGISTER                                       11700051
*              R8 - RETURN ADDRESS                                      11710051
*            OUTPUT REGISTER:                                           11720051
*              R5 - ISKMASK,  IF R5(INPUT) = 0 OR                       11730051
*                                R5(INPUT) = PAGE FRAME KEY             11740051
*              R5 - ISKFMASK, IF R5(INPUT) NOT = 0 AND                  11750051
*                                R5(INPUT) NOT = PAGE FRAME KEY BUT     11760051
*                                                NOT FETCH PROTECTED    11770051
*            WORK REGISTER: R2, R3, R4                                  11780051
*            EXIT: R8 + 0 = INCORRECT ADDRESS                           11790051
*                  R8 + 4 = PROTECTION VIOLATION                        11800051
*                  R8 + 8 = AUTHORIZATION OK                            11810051
*            AMODE: ANY                                                 11820051
*--------------------------------------------------------------         11830051
         SPACE 1                                               @D14BDFR 11840051
*SGLINK  VALREADK,S,INPUT=(R1,R2,R6,R8),WORK=(R2,R3,R4),OUTPUT=(R5)     11850051
VALREADK DS    0H                                              @D64ADIS 11860051
         L     R5,TIBPTR          LOAD TIB POINTER             @D64ADIS 11870051
         USING TIBADR,R5                                       @D64ADIS 11880051
         L     R5,TIBTCB          GET CURRENT TASK CONTR. BL.  @D64ADIS 11890051
         USING TCBADR,R5                                       @D64ADIS 11900051
         L     R5,TCBSAVE         GET TASK'S SAVE AREA ADDR.   @D64ADIS 11910051
         USING SVEARA,R5                                       @D64ADIS 11920051
         TM    SVEPSWKY,KEY0      PROGRAM RUNNING IN KEY 0 ?   @D64ADIS 11930051
         DROP  R5                                              @D64ADIS 11940051
         LA    R5,0               INDICATE KEY 0 PROGRAM       @D64ADIS 11950051
         BZ    VALREAD            YES, SKIP VALIDATION         @D64ADIS 11960051
*SGLINK  VALREADN,S,INPUT=(R1,R2,R6,R8),WORK=(R2,R3,R4),OUTPUT=(R5)     11970051
VALREADN DS    0H                                              @D64ADIS 11980051
         LA    R3,X'80'           IND. NEW READ VALIDATION     @D64ADIS 11990051
         SR    R5,R5              INITIALIZE REGISTER 5        @D64ADIS 12000051
         B     VALREADX           CONTINUE WITH VALIDATION     @D64ADIS 12010051
         SPACE 2                                               @D64ADIS 12020051
*SGLINK  VALREAD,S,INPUT=(R1,R2,R5,R6,R8),WORK=(R2,R3,R4),OUTPUT=(R5)   12030051
VALREAD  DS    0H                                              @D14BDFR 12040051
         SR    R3,R3              IND. OLD READ VALIDATION     @D64ADIS 12050051
VALREADX DS    0H                                              @D64ADIS 12060051
         LA    R1,0(,R1)          RESET HIGH ORDER BYTE/BIT    @D14BDFR 12070051
         LA    R2,0(,R2)          RESET HIGH ORDER BYTE/BIT    @D14BDFR 12080051
         CR    R2,R1              END ADDRESS LOWER THEN BEGIN @D14BDFR 12090051
         BLR   R8                 YES, RETURN INVALID ADDRESS  @D14BDFR 12100051
         N     R2,PADDRMSK        RESET TO PAGE BEGIN ADDRESS  @D52VDIS 12110051
         LTR   R4,R2              PAGE ZERO (VM:V=R)           @DA35843 12120051
         BZ    8(,R8)             YES, RETURN                  @DA35843 12130051
         ST    RD,VALIDSA1        SAVE    REGISTER D           @D61NDIS 12140051
         L     RD,ADISPVAR        GET ADDR. OF WRITE VAL. ROUT.@D61NDIS 12150051
         B     VALIDCOM           CALL READ VALIDATION ROUTINE @D61NDIS 12160051
         TITLE 'VSE/AF SUPERVISOR    DISP               CANCEL ROUTINE' 12170051
*********************************************************************** 12180051
*                                                                     * 12190051
*        DETERMINE TERMINATION CODES, INITIALIZE TASK TERMINATION     * 12200051
*                                                                     * 12210051
*********************************************************************** 12220051
*                                                                     * 12230051
*        FUNCTION :                                                   * 12240051
*              DETERMINE TERMINATION CODES                            * 12250051
*              INITIALIZE TASK TERMINATION                            * 12260051
*        INPUT REGISTERS:                                             * 12270051
*              R6 : BASE REGISTER                                     * 12280051
*              R3 : PUB POINTER IN CASE OF I/O ERR.CODES              * 12290051
*                                                                     * 12300051
*            AMODE: ANY                                                 12310051
*********************************************************************** 12320051
         SPACE 2                                               @D369DFR 12330051
*--------------------------------------------------------------         12340051
* ERR..   - TERMINATION CODES NOT RELATED TO I/O OPERATIONS             12350051
*--------------------------------------------------------------         12360051
         SPACE 1                                               @D369DFR 12370051
ERR08    BCTR  R6,R0              CANCEL REQUEST FROM SUBSYSTEM@D14BDFR 12380051
ERR09    BCTR  R6,R0              CANCEL REQUEST FROM LIOCS    @D14BDFR 12390051
ERR0A    BCTR  R6,R0              SECURITY LOG.PROGR.NOT AVAIL.@D36IDFR 12400051
ERR0B    BCTR  R6,R0              SECURITY VIOLATION           @D36IDFR 12410051
ERR0C    BCTR  R6,R0              ICCF PSEUDO PART.EXEC.FAILURE@D35ZDFR 12420051
ERR0D    BCTR  R6,R0              PCK.IN DISABLED USER PROGR.  @D36IDFR 12430051
ERR0DE   EQU   X'0D'              ... CORRESPONDING EQUATE     @D61NDIS 12440051
ERR0E    BCTR  R6,R0              PAGE FAULT IN SUBSYSTEM HOOK @D36IDFR 12450051
ERR0EE   EQU   X'0E'              ... CORRESPONDING EQUATE     @D61NDIS 12460051
ERR0F    BCTR  R6,R0              INVALID SYSFIL REQUEST       @D35DDJO 12470051
         BCTR  R6,R0              PLACE HOLDER FOR EOJ/DETACH  @D14BDFR 12480051
ERR11    BCTR  R6,R0              NO CCW TRANSL. FOR UNSUPPORTED DEV UL 12490051
ERR12    BCTR  R6,R0              INSUFF.BUFFER SPACE FOR CCW TRANSL UL 12500051
ERR13    BCTR  R6,R0              ERROR IN CHANNEL PROGRAM     @D52VDIS 12510051
ERR14    BCTR  R6,R0              PAGE POOL TOO SMALL                UL 12520051
ERR15    BCTR  R6,R0              PAGE FAULT IN DISABLD PGM (NOT SV) UL 12530051
ERR16    BCTR  R6,R0              PAGE FAULT IN TRANSLATED CCW          12540051
ERR17    BCTR  R6,R0              MAINTASK REQUEST,SUBS AVAIL. @D36IDFR 12550051
ERR18I   S     R6,F6              PROGR.REQUEST,DUMP           @D14BDFR 12560051
*RR19 TO ERR1B                    SEE I/O ERROR CODES          @D14BDFR 12570051
*RR1C                             CANCEL DUE TO CANCEL ALL REQ.@D14BDFR 12580051
*RR1D                             CANCEL DUE TO MAINTASK TERM. @D14BDFR 12590051
ERR1E    BCTR  R6,R0              ERROR ON LOCK FILE           @D36SDFR 12600051
ERR1F    BCTR  R6,R0              CPU FAILURE                           12610051
ERR20    BCTR  R6,R0              PROGRAM CHECK                      AC 12620051
ERR21    BCTR  R6,R0              ILLEGAL SVC                        AC 12630051
ERR22    BCTR  R6,R0              PHASE NOT FOUND                    AC 12640051
ERR23    BCTR  R6,R0              PROGRAM REQUEST                    AC 12650051
ERR24    BCTR  R6,R0              OPERATOR REQUEST                   AC 12660051
         EJECT ,                                                        12670051
ERR25    BCTR  R6,R0              INVALID ADDRESS                    AC 12680051
ERR25C   EQU   ERR25              INVALID ADDRESS                    AC 12690051
ERR26    BCTR  R6,R0              UNASSIGNED LUB CODE                AC 12700051
ERR27    BCTR  R6,R0              INVALID LUB CODE IN CCB      @D14BDFR 12710051
ERR28    BCTR  R6,R0              PHASE TOO LONG               @D14BDFR 12720051
ERR29    BCTR  R6,R0              INVALID SUBLIB.STRUCTURE     @D14BDFR 12730051
ERR2A    BCTR  R6,R0              I/O ERROR ON PAGE DATASET    @D14BDFR 12740051
ERR2B    BCTR  R6,R0              I/O ERROR ON PCIL            @DM03673 12750051
ERR2C    BCTR  R6,R0              INVALID PARAMETER PASSED TO SUPERVISOR12760051
                                  BY PAGE AULT APPENDAGE ROUTINE     UL 12770051
ERR2D    BCTR  R6,R0              PGM CANNOT BE EXECUTED - RESTART DUE *12780051
                                  TO FAILING STORAGE BLOCK           UL 12790051
ERR2E    BCTR  R6,R0              INVALID RESOURCE REQUEST             *12800051
                                     (POSSIBLE DEADLOCK)          Z0795 12810051
ERR2F    S     R6,F4              MORE THAN 255 PFIX REQUESTS FOR 1 PG  12820051
*RR30 TO ERR32                    SEE I/O ERROR CODES          @D14BDFR 12830051
ERR33    S     R6,F2              NO LONG SEEK                 @D14BDFR 12840051
*RR34                             RESERVED                     @D14BDFR 12850051
ERR35    BCTR  R6,R0              JCL OPEN FAILURE             @D14BDFR 12860051
         S     R6,F7              UNUSED ERROR LABELS          @D51KDIS 12870051
*RR36 TO ERR39                    SEE I/O ERROR CODES          @D14BDFR 12880051
*RR3A                             SPOOL REQUEST OUT OF SEQUENCE@DA29183 12890051
*RR3B                             CANCEL REQUEST BY OCCF       @D31QDAZ 12900051
*RR3C                             CANCEL REQUEST BY OCCF       @D31QDAZ 12910051
ERR3D    BCTR  R6,R0              ERROR DURING FETCH PFIX      @D51KDIS 12920051
ERR40E   EQU   X'40'              VTAM CANCEL CODES            @D14BDFR 12930051
ERR41E   EQU   X'41'              ...                          @D14BDFR 12940051
         SH    R6,H4              UNUSED ERROR LABELS          @D51KDIS 12950051
ERR42    BCTR  R6,R0              INVALID DASD EXTENT INFORM.  @D51IDIS 12960051
ERR43    BCTR  R6,R0              NOT POSSIBLE TO EXECUTE IN   @D51SDIS 12970051
*                                 DYNAMIC PARTITION            @D51IDIS 12980051
ERR44    BCTR  R6,R0              SECURITY MANAGER ERROR / VM  @D51SDIS 12990051
ERR45    BCTR  R6,R0              AMODE / RMODE VIOLATION      @D52VDIS 13000051
ERR45E   EQU   X'45'              AMODE / RMODE VIOLATION EQU. @D52GDIS 13010051
ERR46    LA    R6,X'36'(0,R6)     CANCEL CODE FOR DATA SPACE   @D52VDIS 13020051
*                                 SERVICES                     @D52VDIS 13030051
ERR47E   EQU   X'47'              CANCEL WITH ABEND CODE       @D61PDOW 13040051
ERR48E   EQU   X'48'              CANCEL WITH ABEND CODE (FM)  @D61PDIS 13050051
ERR49E   EQU   X'49'              MVS ABEND MACRO ISSUED       @D62ADIS 13060051
ERR4AE   EQU   X'4A'              X-MEM PROVIDER TERMINATION   @D64XDIS 13070051
*        DEBUG ALLREGS,XXDBGMC                                 @D61NDFR 13080051
         DEBUG ALLREGS,XXDBGMC                                 @D61NDFR 13090051
         EJECT ,                                                        13100051
*--------------------------------------------------------------         13110051
* ERR10   - PROCESS NORMAL EOJ OR CALCULATE CANCEL CODE                 13120051
*            INPUT: R6 = DISPATCHER BASE ADDRESS                        13130051
*--------------------------------------------------------------         13140051
ERR10    LA    RB,NORMEOJ(R6)     NORMAL EOJ                            13150051
         L     R6,DISPAD          RESTORE DISPATCHERS BASE     @D36IDFR 13160051
         SLR   RB,R6              DIFF=CANCEL CODE             @D36IDFR 13170051
ERRNN    LR    RF,R6              SET UP EXIT ADDRESS          @D36IDFR 13180051
*        B     ERRGO              GOTO INIT.TASKS TERMINATION  @D52VDIS 13190051
*--------------------------------------------------------------         13200051
* ERRGO    - ACTIVATE ANY TERMINATION EXIT ROUTINE                      13210051
*            INPUT: R6 = DISPATCHER BASE ADDRESS                        13220051
*                   RB = CANCEL CODE                                    13230051
*                   RF = EXIT ADDRESS                                   13240051
*            AMODE: ANY                                                 13250051
*            RID:   SYSTEMID OR REENTRID                                13260051
*--------------------------------------------------------------         13270051
*SGLINK ERRGO,S,INPUT=(R6,RB,RF)                                        13280051
ERRGO    DS    0H                                              @D52VDIS 13290051
*        AMODESW SET,AMODE=24,WR=(8)                           @D52VDIS 13300051
         AMODESW SET,AMODE=24,WR=(8)                           @D52VDIS 13310051
ERRGO24  DS    0H                                              @D52VDIS 13320051
         L     R8,TIBPTR          LOAD TIB POINTER             @D52VDIS 13330051
         USING TIBADR,R8                                       @D36IDFR 13340051
*--------------------------------------------------------------         13350051
*        ACTIVATE TASKS TERMINATION                            @D369DFR 13360051
*--------------------------------------------------------------         13370051
         LA    RE,TIBCNCL                                      @D36IDFR 13380051
         TM    TIBCNCL,XFF                                     @D36IDFR 13390051
         BNM   ERRGO2A                                         @D67BDOW 13400075
         LA    RE,TIBCNCL2                                     @D36IDFR 13410051
         B     ERRGO2                                          @D67BDOW 13411075
         DROP  R8                                              @D67BDOW 13411177
ERRGO2A  L     R8,TCBPTR                                       @D67BDOW 13412076
         NI    TCBRFLAG-TCBADR(R8),XFF-TCBRCVAL NO REASON CODE @D67BDOW 13413076
         L     R8,TIBPTR          RELOAD TIB POINTER           @D67BDOW 13414076
         USING TIBADR,R8                                       @D67BDOW 13415077
ERRGO2   STC   RB,0(,RE)          STORE CANCEL CODE            @D36IDFR 13420051
         STC   RB,DISPCCOD        STORE CANCEL CODE            @D51IDIS 13430051
         CLC   TID,ARTIDH         ANY SYSTEM TASK ACTIVE       @D66ODOW 13440056
         BL    ERRGO3             YES --->                     @D61PDIS 13450051
         EJECT ,                                               @D61NDIS 13460051
*--------------------------------------------------------------         13470051
* ERRGO1   - INITIATE USER TASK TERMINATION PROCESS                     13480051
*            ENTERED FOR SEVERAL SYSTEM TASKS AFTER                     13490051
*            ERRGO3 PROCESS (ADDRESS IN AERREXIT)                       13500051
*            INPUT: R6 - DISPATCHER BASE ADDRESS                        13510051
*                   R8 - TIB ADDRESS                                    13520051
*                   RF - CONTINUATION ADDRESS                           13530051
*--------------------------------------------------------------         13540051
*SGLINK  ERRGO1,S,INPUT=(R6,R8,RF)                                      13550051
ERRGO1   DS    0H                                              @D61PDIS 13560051
*        DEBUG RATIB,XXDBGMC                                   @D64ADIS 13570051
         DEBUG RATIB,XXDBGMC                                   @D64ADIS 13580051
         OI    TIBFLAG,FETCHEOJ  SET CANCEL IN PROGRESS        @D52VDIS 13590051
         CLI   DISPCCOD,NORMEOJ   NORMAL END-OF-JOB ?          @D51IDIS 13600051
         BER   RF                                              @D36ZDFR 13610051
*        DEBUG XXDUMPNR,XXDBGMC                                @D61NDIS 13620051
         DEBUG XXDUMPNR,XXDBGMC                                @D61NDIS 13630051
         BR    RF                 GOTO EXIT OR TURNOFF               FR 13640051
         SPACE 2                                               @D52VDIS 13650051
ACANCX1B DC    A(CANCX1B)         HIGHEST I/O ERROR CODE       @D14BDFR 13660079
DISPCCOD DC    X'00'              SAVED CANCEL CODE            @D51IDIS 13670051
         EJECT ,                                               @D61PDIS 13680051
*--------------------------------------------------------------         13690051
* ERRGO3   - INITIATE SYSTEM TASK TERMINATION PROCESS                   13700051
*            ENTERED FROM CANCEL ROUTINE AND CANCEL EXIT                13710051
*            INPUT: R6 - DISPATCHER BASE ADDRESS                        13720051
*                   R8 - TIB ADDRESS                                    13730051
*                   RF - CONTINUATION ADDRESS                           13740051
*--------------------------------------------------------------         13750051
*SGLINK  ERRGO3,S,INPUT=(R6,R8,RF)                                      13760051
ERRGO3   DS    0H                 FORCE ALIGNMENT              @D52VDIS 13770051
*        DEBUG RATIB,XXDBGMC                                   @D64ADIS 13780051
         DEBUG RATIB,XXDBGMC                                   @D64ADIS 13790051
         MVI   RID+1,REENTRID       IDENTIFY REENTRANT ROUTINE @D61PDIS 13800051
         L     RA,TCBPTR          LOAD TCB POINTER             @D36IDFR 13810051
         USING TCBADR,RA                                       @D36IDFR 13820051
         STM   R0,RF,SVCWORK      SAVE REGISTER                @D61PDOW 13830051
*--------------------------------------------------------------         13840051
* $IJBLSTK  - GIVE TASK EMPTY LINKAGE STACK                             13850051
*             INPUT:  R8 - TIB ADDRESS                                  13860051
*                     RA - TCB ADDRESS                                  13870051
*                     RE - RETURN ADDRESS                               13880051
*                     RC - $IJBLSTK BASE ADDRESS                        13890051
*                     RF - FUNCTION CODE (=4)                           13900051
*             AMODE:  31                                                13910051
*             $IJBLSTK WILL LOAD A NEW LINKAGE STACK ADDRESS            13920051
*             INTO CONTROL REGISTER 15 AND HAS TO                       13930051
*             RETURN WITH THE AMODE OF THE CALLER                       13940051
*--------------------------------------------------------------         13950051
         L     RC,ASVASVDL        PTR.TO SVA ROUT.ADDR.TABLE   @D61PDOW 13960051
         L     RC,AIJBLSTK-SVASVDL(,RC) GET ROUTINE ADDRESS    @D61PDOW 13970051
         LA    RF,4               SET UP FUNCTION CODE         @D61PDOW 13980051
         OI    TIBFLAG4,TIBDSAPA  SET DATA SPACE APPENDAGE ACT.@D61PDOW 13990051
***      AMODESW CALL,REGS=(RE,RC) CALL ROUTINE                         14000051
         AMODESW CALL,REGS=(RE,RC) CALL ROUTINE                @D61PDOW 14010051
         NI    TIBFLAG4,XFF-TIBDSAPA  RESET ACTIVE INDICATION  @D61PDOW 14020051
*--------------------------------------------------------------         14030051
*           - RESET TO TASK'S ACCESS LIST                               14040051
*--------------------------------------------------------------         14050051
         L     R6,ADISPSER        GET ADDRESS OF DISP.SERVICES @D61PDIS 14060051
         LA    R0,20              SET FUNCTION CODE            @D61PDIS 14070051
*        AMODESW CALL,REGS=(R7,R6) REESTABLISH TASK'S ENVIRONM.@D61PDIS 14080051
         AMODESW CALL,REGS=(R7,R6) REESTABLISH TASK'S ENVIRONM.@D61PDIS 14090051
         LM    R0,RF,SVCWORK      RESTORE REGISTER             @D61PDOW 14100051
         L     RE,AERREXIT        LOAD ADDR.OF ERROR EXIT ROUT.@D36IDFR 14110051
         BR    RE                 BRANCH TO ROUTINE            @D36IDFR 14120051
*SGLINK AERREXIT,INPUT=(R6,R8,RB,RF)                                    14130051
         DROP  R8                                              @D61PDIS 14140051
         DROP  RA                                              @D36ZDFR 14150051
         EJECT ,                                               @D52VDIS 14160051
*--------------------------------------------------------------         14170051
*        I/O RELATED TERMINATION CODES                         @D369DFR 14180051
*--------------------------------------------------------------         14190051
         SPACE 1                                               @D369DFR 14200051
ERR30    BCTR  R6,R0              READING PAST /&                       14210051
ERR31    BCTR  R6,R0              RESERVED                     @D37BDAP 14220051
ERR32    S     R6,F4              INVALID DASD ADDRESS         @D35DDEM 14230051
ERR36    BCTR  R6,R0              PAGE FAULT IN I/O APPENDAGE           14240051
ERR37    BCTR  R6,R0              RESERVED                     @D37BDAP 14250051
ERR38    BCTR  R6,R0              INVALID SEEK/SEARCH/COUNTF            14260051
ERR39    LA    R6,X'20'(R6)       INVALID CCW-CHAIN FOR SYSLOG @D354DFR 14270051
ERR19    BCTR  R6,R0              OPERATOR OPTION                       14280051
ERR1A    BCTR  R6,R0              I/O ERROR                             14290051
ERR1B    DS    0H                 CHANNEL FAILURE              @D14BDFR 14300051
*        DEBUG ALLREGS,XXDBGMC                                 @D61NDIS 14310051
         DEBUG ALLREGS,XXDBGMC                                 @D61NDIS 14320051
         LA    RB,CANCX1B(R6)                                  @D14BDFR 14330079
         L     R6,DISPAD          RESTORE DISPATCHERS BASE     @D36IDFR 14340051
         SLR   RB,R6              DIFF=CANCEL CODE             @D36IDFR 14350051
*        B     ERRIOGO            GOTO INIT.TASKS TERMINATION  @D52VDIS 14360051
         EJECT ,                                                        14370051
*--------------------------------------------------------------         14380051
* ERRIOGO  - DO SOME STATUS ANALYSE AND PERFORM CORRESPOND.ACTION       14390051
*            (ENTERED FROM IOINTER WITH CANCEL CODE 25 IN REG. B)       14400051
*     >>>>>> ASYNCHRONOUS PROCESS FOR SYSTEM TASKS MUST NOT CANCEL      14410051
*            INPUT: R3 = PUB ENTRY ADDRESS                              14420051
*                   R6 = DISPATCHER BASE ADDRESS                        14430051
*                   RB = CANCEL CODE                                    14440051
*            AMODE: ANY                                                 14450051
*--------------------------------------------------------------         14460051
         USING PUBADR,R3                                       @D35IDAP 14470051
*SGLINK ERRIOGO,S,INPUT=(R6,RB)                                         14480051
ERRIOGO  DS    0H                                              @D52VDIS 14490051
*        AMODESW SET,AMODE=24,WR=(7)                           @D52VDIS 14500051
         AMODESW SET,AMODE=24,WR=(7)                           @D52VDIS 14510051
         TM    SYSFLAG2,AFTIOINT  ENTERED FROM IOINTER         @D52VDIS 14520051
         BO    ERRIOSET           YES, DONT CHANGE CHNADR      @D35IDAP 14530051
         MVC   CHNADR,PUBCHANN    COPY CUU FROM PUB TO CHNADR  @D35IDAP 14540051
ERRIOSET BAL   R7,CQDSP           SET UP I/O POINTERS          @D37BDAP 14550051
*SGLINK  CQDSP,INPUT=(R3,R6,R7),OUTPUT=(R1,R4,RA),WORK=(R0)             14560051
         USING CHQADR,R4                                       @D35IDAP 14570051
         NI    PUBCSFLG,XFF-DEVBSY-OPINTV-QEDERR RESET FLAGS   @D35IDAP 14580051
         L     R9,AINTER          SET BASE FOR I/O INTERRUPT            14590051
         USING INTRTN,R9                                       @D35EDEM 14600051
         BAL   RF,INTERTRN        FILL ADDR CHNTAB,COM REG     @D35IDEP 14610051
*SGLINK  INTERTRN,INPUT=(R9,RF),OUTPUT=(R2,R5)                          14620051
         LTR   R4,R4              CHANQ ENTRY AVAILABLE        @D35IDAP 14630051
         BZ    INITRG             NO, GET CHANNEL RESTARTED    @D369DAP 14640051
         OI    CHQCCBB1,DISERR    SET DISASTER ERROR           @D35IDAP 14650051
         MVC   CSW(8),CHQCSW      SET UP CSW IN CASE NO INTERR @D35IDAP 14660051
         LTR   R1,R1              IS CCB AVAILABLE             @D35IDAP 14670051
         BZ    DEQUNCON           NO, ENTRY MUST BE DEQUEUED   @D369DAP 14680051
         LA    RF,PSTPUB          POST/DEQUEUE AFTER ANCEL     @D36IDAP 14690051
         C     RB,ACANCX1B        IS IT PROGRAM FAILURE        @D14BDIS 14711079
         BH    ERRNOCCB           YES, CANCEL                  @D14BDFR 14712079
         TM    CHQCCBB1,ACCUNRIO  DOES USER ACCEPT I/O ERRORS  @D37BDAP 14720051
         BOR   RF                 YES, DO NOT CANCEL           @D37BDAP 14730051
ERRNOCCB DS    0H                                              @D66ODOW 14740079
         CLC   CHQTID,ARTIDH      IS IT SYSTEM TASK REQUEST    @D66ODOW 14741079
         BNL   ERRGO24            NO, GO TO INIT.TASKS TERM    @D68CDOW 14742079
         CLC   CHQTID,FCPTIDH     IS IT FCP SYSTEM TASK        @D68CDOW 14743079
         BE    ERRGO24            YES, CANCEL (HARDWAIT)       @D68CDOW 14744079
         BR    RF                 OTHER SYSTEM TASK,           @D68CDOW 14750079
***                               ...--> DO NOT CANCEL                  14760079
         DROP  R4                 RELEASE CHANQ BASE           @D36ZDFR 14770051
         DROP  R3                 RELEASE PUB BASE             @D36ZDFR 14780051
         DROP  R9                 RELEASE IOINTER BASE         @D36ZDFR 14790051
         TITLE 'VSE/AF SUPERVISOR    DISP             SOME SUBROUTINES' 14800051
*********************************************************************   14810051
* RMSGETP2 - THIS ROUTINE FINDS THE PUB2 ADDRESS AND RETURNS IT IN R8   14820051
*            INPUT:  R3 = PUB ENTRY ADDRESS                             14830051
*                    R6 = DISPATCHER BASE ADDRESS                       14840051
*                    RE = RETURN ADDRESS                                14850051
*            OUTPUT: R8 = PUB2 ADDRESS                                  14860051
*********************************************************************   14870051
         SPACE                                                          14880051
*SGLINK  RMSGETP2,S,INPUT=(R3,R6,RE),OUTPUT=(R8)                        14890051
RMSGETP2 DS    0H                                              @D52VDIS 14900051
         LR    R8,R3              COPY PUB ADDRESS                   HL 14910051
         SH    R8,YPUBTAB         GET NORMAL PUB INDEX         @D35IDAP 14920051
         SRL   R8,PUBSLEN-2       ADJUST FOR PUB2 INDEX              HL 14930051
         A     R8,APB2AREA        GET PUB2 INDEX FROM TABLE    @D52VDIS 14940051
         L     R8,0(,R8)          GET ADDRESS OF PUB2          @D52VDIS 14950051
         BR    RE                 RETURN TO CALLER                      14960051
         EJECT ,                                               @D51ADIS 14970051
*********************************************************************** 14980051
* GETDADR  - GET DATA ADDRESS ROUTINE (ENTRY POINT IN DISP)             14990051
* GETDADRF1                                                             14991081
*-------------------------------------------------------------          15000051
*            ROUTINE CALLED BY SVC 60 AND BY BAL R7,GETDADR FOR         15010051
*            ENSURING THAT REFERENCE WITHIN AN I/O AREA                 15020051
*            DOES NOT CAUSE PAGE FAULT OR PROGRAM CHECK.                15030051
*                                                                       15040051
*            INPUT:  R0 - CONTAINS OFFSET WITHIN THIS I/O AREA          15050051
*                    R8 - ENTRY AT GETDADR                              15060081
*                         POINTS TO F0-CCW, WHICH CONTAINS              15061081
*                         I/O AREA ADDRESS (REAL ADDRESSES)             15070051
*                         ENTRY AT GETDADRF1                            15071081
*                         POINTS TO F1-CCW, WHICH CONTAINS              15072081
*                         I/O AREA ADDRESS (REAL ADDRESSES)             15073081
*            OUTPUT: RF - IF ADDRESS IS INVALID, RF = 0                 15080051
*                         ELSE RF = ADDRESS OF BYTE IN I/O AREA         15090051
*            LINKAGE: R7                                                15100051
*            MODE OF CALLER: 24                                         15110051
*            CCW FORMAT: 0                                              15120051
*************************************************************  @DA33314 15130051
         SPACE 1                                               @DA33314 15140051
GETDADRF1 DS    0H                                             @D52VDIS 15160080
*SGLINK  GETDADRF1,INPUT=(R0,R6,R7,R8),OUTPUT=(RF)                      15160180
         STM   R7,RC,TEMPFLD      SAVE REG 7-12                @D68CDOW 15160280
         SLR   R7,R7              INDICATE FORMAT 1 CCW        @D68CDOW 15160380
         B     GETDADR1                                        @D68CDOW 15160480
GETDADR  DS    0H                                              @D52VDIS 15160580
*SGLINK  GETDADR,INPUT=(R0,R6,R7,R8),OUTPUT=(RF)                        15160680
         STM   R7,RC,TEMPFLD      SAVE REG 7-12                @D68CDOW 15161080
GETDADR1 DS    0H                                              @D68CDOW 15162080
         MVC   PCKICEPT,AGETD3    SETUP PCK HANDLER INTERCEPT  @D68CDOW 15163083
         CLC   0(1,R8),7(R8)      DUMMY COMP.FOR VALIDATION    @D68CDOW 15170080
***                               ... NEITHER PROG CHK NOR PF ALLOWED   15180083
         MVC   PCKICEPT,F0        DEACT INTERCEPT RTN          @D68CDOW 15191083
         L     RC,AGETDADS        GET SUBROUTINES BASE         @D52VDIS 15200051
         BR    RC                 CALL SUBROUTINE              @D52VDIS 15210051
*SGLINK  GETDADRS,INPUT=(R0,R6,R7,R8,RC),OUTPUT=(RF)                    15220051
         SPACE 2                                               @D51ADIS 15230051
AGETDADS DC    A(GETDADRS)        ADDR. OF GETDADRS ROUTINE    @D51ADIS 15240051
         EJECT ,                                               @D51ADIS 15250051
*********************************************************************** 15260051
* CQDSP - SET UP OF CHANNEL QUEUE-, PIB2- AND CCB POINTER      @D51ADIS 15270051
*         OUTPUT:                                              @D51ADIS 15280051
*            RA = PIB ADDRESS                                  @D51ADIS 15290051
*            AMODE: 24                                                  15300051
*********************************************************************** 15310051
         SPACE 2                                               @D51ADIS 15320051
*SGLINK  CQDSP,S,INPUT=(R3,R6,R7),WORK=(R0),OUTPUT=(R1,R4,RA)  @D51ADIS 15330051
CQDSP31  DS    0H                                              @D68CDOW 15340078
         LA    R0,1               GET INDICATOR                @D68CDOW 15340178
         B     CQDSPC                                          @D68CDOW 15340278
CQDSP    DS    0H                                              @D51ADIS 15341078
         SLR   R0,R0              GET INDICATOR                @D68CDOW 15341178
CQDSPC   DS    0H                                              @D68CDOW 15342078
         SLR   R1,R1              RESET CCB REGISTER           @D61NDIS 15350051
         LR    R4,R1              RESET CHANQ POINTER          @D61NDIS 15360051
         STM   R0,RF,TDSAVE       SAVE REGISTERS               @D61RDIS 15370051
         L     R7,ACQDSPS         GET ROUTINES BASE            @D52GDIS 15380051
         BR    R7                 BRANCH TO ROUTINE            @D51ADIS 15390051
         SPACE 2                                               @D51ADIS 15400051
*SGLINK  SETLCALL,S,INPUT=(R6,R7,RA),WORK=(R0),OUTPUT=(RA)     @D52GDIS 15410051
SETLCALL DS    0H                                              @D51ADIS 15420051
         SLR   R0,R0              GET INDICATOR                @D68CDOW 15421078
         STM   R0,RF,TDSAVE       SAVE REGISTERS               @D61RDIS 15430051
         L     R7,ACQDSPS         GET ROUTINES BASE            @D52GDIS 15440051
         B     SETLCALS-CQDSPS(,R7) BRANCH TO ROUTINE          @D51ADIS 15450051
         SPACE 2                                               @D51ADIS 15460051
ACQDSPS  DC    A(CQDSPS)          ADDR. OF CQDSP ROUTINE       @D51ADIS 15470051
         DROP  R6                                              @D36IDFR 15480051
         TITLE 'VSE/AF SUPERVISOR    DISP             CONSTANTS,FIELDS' 15490051
**************************************************************          15500051
*                                                            *          15510051
*        CONSTANTS,DISPATCHER FIELDS                         *          15520051
*                                                            *          15530051
**************************************************************          15540051
         SPACE 1                                               @D35EDFR 15550051
OLTSAV   DC    F'0'               OLTEP SAVE AREA                       15560051
OLTABL   DC    0F'0'              OLTEP TABLE                  @D359DPS 15570051
OLTAPP1  DC    A(OLTRET1)         THESE ADDRESSES                   451 15580051
OLTAPP2  DC    A(OLTRET2)         ARE DYNAMICALLY MODIFIED          451 15590051
         DC    A(0)               NO MICR,BUT KEEP OFFSET      @D35ZDEM 15600051
OLTPIK   DC    AL2(0)             PIK OF OLTEP PARTITION       @D36BDFR 15610051
SNSFLAG  DC    X'00'              SNS-TASK FLAG BYTE           @KD40338 15620051
SNSWORK  EQU   X'80'              SNS-TASK WAITS FOR ERR ENTRY @D35IDPS 15630051
SNSDVFRI EQU   X'40'              AT LEAST ONE DEVICE WAS FREED@D35IDPS 15640051
SNSPVWRK EQU   X'20'              DO PATH VERIFICATION         @KD40338 15650051
SNSPVDLY EQU   X'10'              PATH VERIFICATION DELAY      @DY45768 15651065
SNSMSGOP EQU   X'08'              PROVIDE MESSAGE TO OPERATOR  @D369DAP 15660051
SNSMSGRO EQU   X'04'              OPERATOR REPLY OUTSTANDING   @D14BDIS 15670051
SNSMSGRR EQU   X'02'              OPERATOR REPLY READ          @D14BDIS 15680051
SNSFLAG1 DC    X'00'              SNS-TASK FLAG BYTE 1         @KD40338 15690051
AHQRESCH DC    A(HQRESCHQ)        ADDR OF RESERVED CHANQ ELES  @D35IDEP 15700051
ADISKERR DC    A(DER0000)         ADDRESS OF DISK ERP          @D35DDPS 15710051
EDHA     DC    XL5'00'            READIN AREA H.A. DISK ERROR REC.      15720051
FLAGSYS  DC    X'00'                                           @D35EDPS 15730051
EDSA     DC    H'0'               BBCCHH FOR ERP                   120  15740051
EDR0     DC    2H'0'              R0 FOR ERP                       120  15750051
HEAD     EQU   EDR0+3             HEAD NUMBER                      120  15760051
LUBIGN   DC    X'00FE'            MASK FOR IGNORED LUB                  15770051
         ORG   *-2                OVERWRITE LUBIGN             @D68CDOW 15771085
NOTOP    DC    X'00FE'            USED TO INDICATE NOT OPERATIONAL      15780085
SYSLUBNO DC    H'&AG13'           NUMBER OF SYSTEM LUB ENTRIES @D35IDAP 15790051
LUBNO    EQU   &AG13              NUMBER OF SYSTEM LUBS        @D36IDFR 15800051
         SPACE 2                                                    BSW 15810051
ATRMBASE DC    A(TERMBASE)        BASE TO DUMP COM AREA        @D31EDOW 15820051
BTSAV    DC    2F'0'              SAVE AREA FOR R1 AND CCW ADDR@D369DFR 15830051
R5SAVE   DC    F'0'               SAVE AREA FOR R5             @DA36602 15840051
RFSAVE   DC    F'0'               SAVE AREA FOR R15            @DA36602 15850051
SEARCHFL DS    0CL5               WORKFIELD                         JAB 15860051
         DS    CL4                * FOR                             UER 15870051
RECNO    DS    CL1                * SYSFIL                          UER 15880051
DASDCPT  DC    F'0'               SET FILE MASK CCW SEL.CHANL. @D36ZDFR 15890051
DASDCPTA DC    F'0'               SET FILE MASK CCW BL-MPX CHN.@D36EDFR 15900051
         EJECT                                                 @D149DIS 15910051
*--------------------------------------------------------------         15920051
*        DISPATCHER WORK AREAS                                          15930051
*        ROUTINES MUST NOT BE INTERRUPTED,                              15940051
*        WHEN USING THESE FIELDS                                        15950051
*--------------------------------------------------------------         15960051
         DS    0F                                              @D36IDFR 15970051
PIBINFO  DC    F'0'           INT.CODE OF LTA OWNER            @D36IDFR 15980051
TEMPFLD  DC    7F'0'          TEMP.REG.SAVEAREA                @D52GDIS 15990051
VALIDPCB EQU   TEMPFLD        TEMP. HOLDS THE PCB ADDRESS      @D52VDIS 16000051
VALIDSRT EQU   TEMPFLD+4      RETURN ADDRESS TO COMMON EXIT    @D52VDIS 16010051
VALIDSA2 EQU   TEMPFLD+8      TEMP. REGISTER SAVE AREA         @D52VDIS 16020051
VALIDSA1 EQU   TEMPFLD+12     TEMP. REGISTER SAVE AREA         @D61NDIS 16030051
RPOSTSAV DC    6F'0'          TEMP.REG SAVE AREA               @KD40388 16040051
VALIDKEY DC    H'0'           VALIDATION KEY                   @D52HDIS 16050051
         SPACE 2                                                        16060051
*--------------------------------------------------------------         16070051
*        DISPATCHER CONSTANTS                                           16080051
*--------------------------------------------------------------         16090051
APPRTYOT DC    A(PPRTYOWN-4)  ADDRESS OF PPRTYOWN FOR TRT INST.@D51IDIS 16100051
ADISPEXR DC    A(DISPEXRT)        GENERAL DISPATCHER EXIT ROUT.@D52HDIS 16110051
ADISPCNC DC    A(DISPCNCL)        CANCEL PROPAGATION ROUT.ADDR.@D61NDIS 16120051
AACCTTIM DC    A(ACCTTIME)    ADDRESS OF ACCOUNTING ROUTINE    @D64ADIS 16130051
ADISPICP DC    A(DISPICP)     ADDRESS OF ICCFPP SET/RESET ROUT.@D52VDIS 16140051
ADISPALL DC    A(ALLBNDX)         ALLBOUND ROUTINE ADDRESS     @D52HDIS 16150051
ADISPVAW DC    X'80',AL3(DISPVALW) ADDRESS OF WRITE VAL. ROUT. @D61NDIS 16160051
ADISPVAR DC    X'80',AL3(DISPVALR) ADDRESS OF READ VAL. ROUT.  @D61NDIS 16170051
ADISPATB DC    A(DISPATAB)        DISP EXIT ADDRESS TABLE ADDR.@D52HDIS 16180051
AAPSEXIT DC    A(APSEXIT)         VTAM EXIT ADDRESS            @D52HDIS 16190051
ASNSINIT DC    A(SNSINIT)         SNSINIT BASE ADDRESS         @KD40338 16200051
AMISINTA DC    A(MISINTAT)        SGMIH BASE ADDRESS           @KD40338 16210051
SPINIT   CRSPID NAME=IINIT       SUBPOOL ID                    @D52HDIS 16230051
         EJECT ,                                               @D52GDIS 16240051
***************************************************************         16250051
*        HIGH PRIORITY DISPATCHING FIELDS                               16260051
***************************************************************         16270051
*--------------------------------------------------------------         16280051
*        HIGH PRIORITY TASKS' TIB TABLE                                 16290051
*        THE FOLLOWING FIELDS HAVE TO STAY TOGETHER                     16300051
*--------------------------------------------------------------         16310051
         DS    0F             FORCE ALIGNMENT                  @D52VDIS 16320051
DISPTIBT EQU   *-12           ALIGN TO START OF TABLE          @D51IDIS 16330051
EOTTIB   DC    F'0'           TIB ADDRESS OF END-OF-TASK OWNER @D51IDIS 16340051
         DC    F'0'           NOT USED                         @D52VDIS 16350051
LTATIB   DC    F'0'           TIB ADDRESS OF LTA OWNER         @D51IDIS 16360051
         DC    F'0'           NOT USED                         @D52VDIS 16370051
TERMTIB  DC    F'0'           TIB ADDRESS OF DUMP OWNER        @D51IDIS 16380051
*--------------- END OF TIB TABLE -----------------------------         16390051
DISPHIFL DC    X'00'          HIGH PRTY DISP.FLAG              @D51IDIS 16400051
*        EQU   EOTACT         EOT ACTIVE                       @D52VDIS 16410051
*        EQU   LTAACT         LTA ACTIVE                       @D52VDIS 16420051
*        EQU   TERMACT        TERMINATOR ACTIVE                @D52VDIS 16430051
         EJECT ,                                               @D61NDIS 16440051
*--------------------------------------------------------------         16450051
*        DISPATCHER SAVE AREA FOR CONTROL REGISTERS                     16460051
*--------------------------------------------------------------         16470051
         DS    0F                                              @D61PDIS 16480051
DISPSCR1 DC    F'0'           SAVE AREA FOR CTL.REG. 1         @D61PDIS 16490051
DISPSCR2 DC    F'0'           SAVE AREA FOR CTL.REG. 2         @D61PDIS 16500051
DISPSCR3 DC    F'0'           SAVE AREA FOR CTL.REG. 3         @D61PDIS 16510051
DISPSCR4 DC    F'0'           SAVE AREA FOR CTL.REG. 4         @D61PDIS 16520051
DISPSCR5 DC    F'0'           SAVE AREA FOR CTL.REG. 5         @D61PDIS 16530051
DISPSCR6 DC    F'0'           SAVE AREA FOR CTL.REG. 6         @D61PDIS 16540051
DISPSCR7 DC    F'0'           SAVE AREA FOR CTL.REG. 7         @D61PDIS 16550051
DISPSCR8 DC    F'0'           SAVE AREA FOR CTL.REG. 8         @D61PDIS 16560051
DISPSCR9 DC    F'0'           SAVE AREA FOR CTL.REG. 9         @D61PDIS 16570051
DISPSCRA DC    F'0'           SAVE AREA FOR CTL.REG. 10        @D61PDIS 16580051
DISPSCRB DC    F'0'           SAVE AREA FOR CTL.REG. 11        @D61PDIS 16590051
DISPSCRC DC    F'0'           SAVE AREA FOR CTL.REG. 12        @D61PDIS 16600051
DISPSCRD DC    F'0'           SAVE AREA FOR CTL.REG. 13        @D61PDIS 16610051
DISPSCRE DC    F'0'           SAVE AREA FOR CTL.REG. 14        @D61PDIS 16620051
DISPSCRF DC    F'0'           SAVE AREA FOR CTL.REG. 15        @D61PDIS 16630051
*--------------------------------------------------------------         16640051
* DISPLTAS - PROGRAM'S ACCESS REGISTERS, WHEN LTA ACTIVE                16650051
*--------------------------------------------------------------         16660051
DISPLTAS DC    16F'0'         SAVE AREA FOR AR REGISTERS       @D61PDIS 16670051
*--------------------------------------------------------------         16680051
* DISPLTAC - PROGRAM'S CONTROL REGISTERS WHEN LTA ACTIVE                16690051
*--------------------------------------------------------------         16700051
DISPLTAC DC    16F'0'         SAVE AREA FOR CONTROL REGISTERS  @D64XDIS 16710051
         EJECT ,                                               @D51IDIS 16720051
         MAPDISPV ,                                            @D61RDIS 16730051
         EJECT ,                                               @D61RDIS 16740051
***************************************************************@D149DIS 16750051
*        PRIORITY EXTRACTION TABLE                             @D14BDFR 16760051
***************************************************************@D149DIS 16770051
         SPACE 1                                               @D14BDFR 16780051
PREXTTAB DS    0F                                              @D14BDFR 16790051
         DC    X'00201C1C181818181414141414141414'             @D14BDFR 16800051
         DC    X'10101010101010101010101010101010'             @D14BDFR 16810051
         DC    X'0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C'             @D14BDFR 16820051
         DC    X'0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C'             @D14BDFR 16830051
         DC    X'08080808080808080808080808080808'             @D14BDFR 16840051
         DC    X'08080808080808080808080808080808'             @D14BDFR 16850051
         DC    X'08080808080808080808080808080808'             @D14BDFR 16860051
         DC    X'08080808080808080808080808080808'             @D14BDFR 16870051
         DC    X'04040404040404040404040404040404'             @D14BDFR 16880051
         DC    X'04040404040404040404040404040404'             @D14BDFR 16890051
         DC    X'04040404040404040404040404040404'             @D14BDFR 16900051
         DC    X'04040404040404040404040404040404'             @D14BDFR 16910051
         DC    X'04040404040404040404040404040404'             @D14BDFR 16920051
         DC    X'04040404040404040404040404040404'             @D14BDFR 16930051
         DC    X'04040404040404040404040404040404'             @D14BDFR 16940051
         DC    X'04040404040404040404040404040404'             @D14BDFR 16950051
         EJECT                                                 @D149DIS 16960051
*------------------------------------------------------------- @D149DIS 16970051
* PPRTYOWN - PARTITION PRIORITY OWNER TABLE                    @D51IDIS 16980051
* STATPOWN - STATIC PARTITION PRIORITY OWNER TABLE             @D51IDIS 16990051
*            ASTATPOW POINTS TO THIS TABLE DURING GENERATION.  @D51IDIS 17000051
*            AFTER DYNCLASS ID=INIT CALLED DURING IPL          @D51IDIS 17010051
*            ASTATPOW POINTS TO PRETABLE.                      @D51IDIS 17020051
*------------------------------------------------------------- @D149DIS 17030051
         SPACE 1                                               @D369DFR 17040051
PPRTYOWN DS    0F                                              @D14BDFR 17050051
STATPOWN EQU   PPRTYOWN                                        @D51IDIS 17060051
         SPACE 1                                               @D369DFR 17070051
         DC    A(SYSPCB)          PCB POINTER OF SYSTEM PART.  @D51IDIS 17080051
&Y       SETA  &NPART                                          @D51IDIS 17090051
.MVCLP   ANOP                                                  @D51IDIS 17100051
&C       SETC  '&P(&Y)'                                        @D51IDIS 17110051
         DC    A(&C.PCB)                                       @D51IDIS 17120051
&Y       SETA  &Y-1                                            @D51IDIS 17130051
         AIF   (&Y GT 0).MVCLP    REPEAT FOR ALL PARTITIONS    @D51IDIS 17140051
         DC    &NCLASS.F'0'       RESERVED ENTRIES FOR CLASSES @D51IDIS 17150051
         DC    A(PGTPCB)          PSEUDO PCB FOR PAGE-OUT      @D51IDIS 17160051
*                                 ALWAYS LAST ENTRY OF PPRTYOWN@D51IDIS 17170051
         TITLE 'VSE/AF SUPERVISOR   DISP  SUBROUTINES - NOT DISP BASED' 17180051
*********************************************************************** 17190051
* CQDSP - SET UP OF CHANNEL QUEUE-, PIB2- AND CCB POINTER      @D51IDIS 17200051
*         BASE ADDRESS: R7                                     @D51ADIS 17210051
*         OUTPUT:                                              @D51IDIS 17220051
*            RA = PIB ADDRESS                                  @D51IDIS 17230051
*         AMODE: 24                                            @DY44052 17240051
*********************************************************************** 17250051
         SPACE 2                                               @D369DFR 17260051
         USING DISP,R6                                         @D52GDIS 17270051
         USING CQDSPS,R7                                       @D52GDIS 17280051
*SGLINK  CQDSPS,S,INPUT=(R1,R3,R4,R6,R7),WORK=(R0),OUTPUT=(R1,R4,RA)    17290051
CQDSPS   DS    0H                                              @D61NDIS 17300051
         USING PUBADR,R3          PUB-ENTRY LAYOUT             @D35CDEM 17310051
         MVI   RID+1,SYSTEMID     DO NOT ALLOW PAGE FAULTS     @D36IDFR 17320051
MVZONE   MVZ   DEVZON,PUBDEVTY    GET ZONE OF DEVICE TYPE           403 17330051
         CLI   PUBCHQPT,NOTQUED   UNSOLICITED INTERRUPT ?      @D149DIS 17340051
         BE    CQDEL1             YES,RETURN                   @D52GDIS 17350051
         IC    R4,PUBCHQPT        GET CHANNEL QUEUE INDEX               17360051
         AIF   (&AG1 LE 254).LOD0000                           @D51ODGL 17370051
         ICM   R4,2,PUBCHQPH      ..INCLUDING HIGH ORDER BYTE  @D51ODGL 17380051
.LOD0000 ANOP                                                  @D51ODGL 17390051
         SLL   R4,CHQSLEN         CALCULATE DISPLACEMENT       @D35IDAP 17400051
         A     R4,ACHANQ          SET UP CHANNEL QUEUE POINTER          17410051
         ICM   R4,8,H0            CLEAR HIGH ORDER BYTE        @D68REEF 17411088
         USING CHQADR,R4          CHQ-ENTRY LAYOUT             @D35CDEM 17420051
         ST    R4,TDSAVE+4*R4     SAVE CHANNEL QUEUE POINTER   @D61NDIS 17440051
         L     R1,CHQCCBAD        LOAD CCB ADDRESS             @D36IDAP 17450051
         ICM   R1,8,H0            CLEAR HIGH ORDER BYTE(CHAINB)@D68REEF 17460088
         LTR   R1,R1              CCB STILL AVAILABLE ?        @D14BDIS 17470051
         BZ    CQDEL1             NO,LOAD PIBPTR AND RETURN    @D14BDIS 17480051
         ST    R1,TDSAVE+4*R1     SAVE CCB ADDRESS             @D61NDIS 17490051
         LH    RA,CHQTID          GET TASK IDENTIFIER          @D66ODOW 17510056
         DROP  R3                                              @D52GDIS 17520051
         DROP  R4                                              @D52GDIS 17530051
         EJECT ,                                               @D52VDIS 17540051
*-------------------------------------------------------------          17550051
* SETLCALS - SET UP LOW CORE FIELDS                                     17560051
*-------------------------------------------------------------          17570051
*SGLINK  SETLCALS,S,INPUT=(R6,R7,RA),WORK=(R0),OUTPUT=(RA)     @D52GDIS 17580051
SETLCALS DS    0H                                              @D61RDIS 17590051
         NOP   0                  SET UP LOW CORE ...          @D61RDIS 17600051
         NOP   0                         ...        ...        @D61RDIS 17610051
         NOP   0                         ... VENDOR ...        @D61RDIS 17620051
         NOP   0                                ... HOOK       @D61RDIS 17630051
         LR    R1,RA              GET TASK ID                  @D61RDIS 17640051
*        DISPMAC FUNC=SETLCALL,INP1=R1                         @D61RDIS 17650051
         DISPMAC FUNC=SETLCALL,INP1=R1                         @D61RDIS 17660051
*-------------------------------------------------------------          17670051
* CQDEL1   - PREPARE OUTPUT AND RETURN TO CALLER                        17680051
*-------------------------------------------------------------          17690051
CQDEL1   DS    0H                                              @D52GDIS 17700051
         LM    R0,RF,TDSAVE       RESTORE REGISTERS            @D61NDIS 17710051
         L     RA,PIBPTR2         SET CURRENT PIB2 POINTER     @D52GDIS 17720051
         USING PIB2ADR,RA                                      @D51IDIS 17730051
         L     RA,PIBPCB          GET CURRENT PCB  POINTER     @D51IDIS 17740051
         USING PCBADR,RA          PCB-ENTRY LAYOUT             @D51IDIS 17750051
         L     RA,PCEPIB          SET CURRENT PIB  POINTER     @D51IDIS 17760051
         LTR   R0,R0              31 BIT ENTRY                 @D68CDOW 17761078
         BZR   R7                 NO, RETURN IN 24 BIT MODE    @D68CDOW 17762078
         BSM   0,R7               RETURN IN CALLERS MODE       @D68CDOW 17770078
         DROP  RA                                              @D52GDIS 17780051
         EJECT ,                                               @D149DIS 17790051
*-------------------------------------------------------------          17800051
* GETDADRS - GET DATA ADDRESS ROUTINE (ENTRY POINT IN DISP)             17810051
*-------------------------------------------------------------          17820051
*            ROUTINE CALLED BY SVC 60 AND BY BAL R7,GETDADR FOR         17830051
*            ENSURING THAT REFERENCE WITHIN AN I/O AREA                 17840051
*            DOES NOT CAUSE PAGE FAULT OR PROGRAM CHECK.                17850051
*                                                                       17860051
*            INPUT:  R0 - CONTAINS OFFSET WITHIN THIS I/O AREA          17870051
*                    R8 - POINTS TO CCW, WHICH CONTAINS                 17880051
*                         I/O AREA ADDRESS (REAL ADDRESSES)             17890051
*                    RC - SUBROUTINE'S BASE ADDRESS                     17900051
*            OUTPUT: RF - IF ADDRESS IS INVALID, RF = 0                 17910051
*                         ELSE RF = ADDRESS OF BYTE IN I/O AREA         17920051
*            LINKAGE: R7                                                17930051
*            MODE OF CALLER: 24                                         17940051
*            CCW FORMAT: 0                                              17950051
*-------------------------------------------------------------          17960051
         SPACE 1                                               @DA33314 17970051
         USING DISP,R6                                         @D51ADIS 17980051
         USING GETDADRS,RC                                     @D51ADIS 17990051
*SGLINK  GETDADRS,S,INPUT=(R0,R6,R7,R8,RC),OUTPUT=(RF)                  18000051
GETDADRS DS    0H                                              @D52VDIS 18010051
         L     RF,0(,R8)          LOAD CCW DATA ADDRESS        @D14BDFR 18040051
         LA    RB,0(,RF)          RESET HIGH ORDER BYTE        @D14BDFR 18040180
         LA    R9,4               DISP FOR IDAL TEST           @D68CDOW 18040280
         LTR   R7,R7              FORMAT 1 CCW                 @D68CDOW 18041080
         BNZ   GETDADRS1                                       @D68CDOW 18042080
         L     RB,4(,R8)          LOAD CCW DATA ADDRESS F1     @D68CDOW 18043081
         LA    R9,1               DISP FOR IDAL TEST           @D68CDOW 18043180
GETDADRS1 DS   0H                                              @D68CDOW 18044080
         C     RB,IJBEOR          REAL STORAGE ADDRESS         @D51GDRP 18060051
         BH    GETD3              NO,ERROR                           EM 18070051
         AR    R9,R8                                           @D68CDOW 18071082
         TM    0(R9),IDAL         IDAL BIT ON                  @D68CDOW 18080082
         BZ    GETD2              NO                                 EM 18090051
         LR    R9,RB              PREPARE INPUT FOR VIRTADPT   @D52HDIS 18100051
*                                     = REAL ADDRESS           @D52HDIS 18110051
         LA    R6,GETDARTX        ENSURE FIRST BYTE OF ...     @D52HDIS 18120051
*                                 ... RETURN REGISTER IS ZERO  @D52VDIS 18130051
         B     VIRTADPT           CONVERT ADDR.OF IDAL TO VIRT.@D52HDIS 18140051
*SGLINK  VIRTADPT,INPUT=(R6,R9),WORK=(R9),OUTPUT=(RF)                   18150051
GETDARTX DS    0H                 RETURN FROM VIRTADPT         @D52HDIS 18160051
         L     R6,DISPAD          RELOAD DISPATCHERS BASE REG. @D36IDFR 18170051
         LTR   RB,RF              IS ADDRESS VALID             @D36IDFR 18180051
         BZ    GETDX              NO                           @D36IDFR 18190051
         L     RF,0(,RB)          POINT TO BEG.OF I/O AREA     @D14BDFR 18200051
         N     RF,IDALMSK         CALC.DISPL.WITHIN FIRST PAGE @DA33314 18210051
         AR    RF,R0              OFFSET FROM BEG.FIRST PAGE   @D36IDFR 18220051
         C     RF,IDALMSK         OFFSET WITHIN FIRST PAGE?    @DA33314 18230051
         BNH   GETD1              YES,                         @D36IDFR 18240051
         LR    R9,RF              CALCULATE                    @D36IDFR 18250051
         SRL   R9,IDALSHFT          DISPLACEMENT               @DA33314 18260051
         ALR   R9,R9                TO                         @D36IDFR 18270051
         ALR   R9,R9                IDAL ENTRY                 @D36IDFR 18280051
         AR    RB,R9              POINT TO CORRESP.IDAL ENTRY  @D36IDFR 18290051
         EJECT ,                                               @D52VDIS 18300051
*-------------------------------------------------------------          18310051
*          - TEST ADDRESS OF I/O AREA                                   18320083
*-------------------------------------------------------------          18330051
         MVC   PCKICEPT,AGETD3    SETUP PCK HANDLER INTERCEPT  @D68CDOW 18331083
         L     RB,0(,RB)          LOAD ADDR.OF I/O AREA PART   @D14BDFR 18340083
***                               ... NEITHER PROG CHK NOR PF ALLOWED   18340183
         MVC   PCKICEPT,F0        DEACT INTERCEPT RTN          @D68CDOW 18341083
         N     RF,IDALMSK         DISPL. WITHIN LAST PAGE      @DA33314 18360051
         AR    RB,RF              ADDRESS TO BE TESTED         @D36IDFR 18370051
GETD4    CL    RB,IJBEOR          REAL ADDR.OF I/O AREA        @D51GDRP 18380051
         BH    GETD3              NO,INDICATE INVALID VALUE    @DM03329 18390051
*                                 IN AN IADW THE FIRST BYTE    @DM03329 18400051
*                                 SHOULD BE ZERO,SO FULL REG.IS COMPAR. 18410051
         LR    RF,RB              REAL ADDRESS                 @D14NDFG 18420051
         LR    R9,RB              PREPARE INPUT FOR VIRTADPT   @D52HDIS 18430051
         LA    R6,GETDARTY        ENSURE FIRST BYTE OF ...     @D52VDIS 18440051
*                                 ... RETURN REGISTER IS ZERO  @D52VDIS 18450051
         B     VIRTADPT           CONVERT ADDR.OF IDAL TO VIRT.@D52HDIS 18460051
*SGLINK  VIRTADPT,INPUT=(R6,R9),WORK=(R9),OUTPUT=(RF)                   18470051
GETDARTY DS    0H                 RETURN FROM VIRTADPT         @D52HDIS 18480051
         L     R6,DISPAD          RESTORE DISPACHER ADDRESS    @D52VDIS 18490051
*-------------------------------------------------------------          18500051
* GETDX    - RESTORE SAVED REGISTERS AND RETURN TO CALLER               18510051
*-------------------------------------------------------------          18520051
GETDX    LM    R7,RC,TEMPFLD      RELOAD REG R7-RC             @D68CDOW 18530080
         BR    R7                 RETURN TO CALLER             @D36IDFR 18560051
         SPACE 2                                               @D52VDIS 18570051
*-------------------------------------------------------------          18580051
* GETD1    - GET I/O AREA ADDRESS PART INCREASED BY OFFSET              18590051
*-------------------------------------------------------------          18600051
GETD1    DS    0H                                              @D14BDFR 18610083
         MVC   PCKICEPT,AGETD3    SETUP PCK HANDLER INTERCEPT  @D68CDOW 18610183
         L     RB,0(,RB)          LOAD ADDR.OF I/O AREA PART   @D14BDFR 18611083
***                               ... NEITHER PROG CHK NOR PF ALLOWED   18612083
         MVC   PCKICEPT,F0        DEACT INTERCEPT RTN          @D68CDOW 18620083
GETD2    AR    RB,R0              ADDRESS TO BE TESTED         @D36IDFR 18630051
         B     GETD4                                           @D36IDFR 18640051
         SPACE 2                                               @D52VDIS 18650051
*-------------------------------------------------------------          18660051
* GETD3    - SET RETURN CODE AND RETURN                                 18670051
*-------------------------------------------------------------          18680051
GETD3    MVC   PCKICEPT,F0        DEACT INTERCEPT RTN          @D68CDOW 18681086
         SLR   RF,RF              RETURN ZERO IN RF            @D36IDFR 18690086
         B     GETDX              RELOAD REGS AND RETURN       @D36IDFR 18700051
AGETD3   DC    A(GETD3)           PROG CHECK EXIT ADDR         @D68CDOW 18701083
         DROP  R6                                              @D51ADIS 18710051
         DROP  RC                                              @D52VDIS 18720051
         EJECT ,                                               @D149DIS 18730051
*------------------------------------------------------------- @D51IDIS 18740051
* SETDEFSP - CALLED BY DEALLOCATION ROUTINE                    @D51IDIS 18750051
*            1) THE FUNCTION 'SET DEFAULT SPACE' IS NO LONGER           18760051
*               NECESSARY. IT IS NOT POSSIBLE THAT THE SPACE            18770051
*               WHICH IS CURRENTLY ACTIVE, IS DEALLOCATED.              18780051
*               DEALLOC BY AR-> SHARED SCB ACTIVE                       18790051
*               DEALLOC BY BG-> SPACE 0 ACTIVE                          18800051
*               DEALLOC BY PWR -> PWR SPACE ACTIVE                      18810051
*            2) SCAN TIBS                                      @D51IDIS 18820051
*               IF TIBSCB = R1 THEN                            @D51IDIS 18830051
*                    RESET TIBSCB TO DEFAULT                   @D51IDIS 18840051
*            INPUT:                                            @D51IDIS 18850051
*               R1 = SCB ADDRESS OF ADDRESS SPACE TO BE DEALLOC@D51IDIS 18860051
*               R7 = RETURN REGISTER                           @D51IDIS 18870051
*               R8 = SETDEFSP ADDRESS                          @D51IDIS 18880051
*            WORK: R4, R5, R6                                           18890051
*            AMODE: 24                                                  18900051
*------------------------------------------------------------- @D51IDIS 18910051
         USING SETDEFSP,R8                                     @D51IDIS 18920051
*SGLINK SETDEFSP,S,INPUT=(R1,R7,R8),WORK=(R4,R5,R6)            @D51IDIS 18930051
SETDEFSP DS    0F                                              @D51IDIS 18940051
*-------------------------------------------------------------          18950051
*  SCAN ALL TIBS TO FIND SCB TO BE DEALLOCATED                          18960051
*-------------------------------------------------------------          18970051
         L     R4,ATIBATAB        GET TIBATAB START            @D66ODOW 18980056
SETDEFSL DS    0H                                              @D51IDIS 18990051
         LA    R4,4(,R4)          POINT TO FIRST/NEXT TIB ADDR.@D51IDIS 19000051
         L     R6,0(,R4)          GET TIB ADDRESS              @D51IDIS 19010051
         LTR   R6,R6              CHECK FOR TIB ADDRESS        @D51IDIS 19020051
         BZ    SETDEFSL           NOT AVAIL. --> LOOP          @D51IDIS 19030051
         BNP   SETDEFS2           ALL TIBS SCANNED --> RETURN  @D51IDIS 19040051
         USING TIBADR,R6                                       @D51IDIS 19050051
         C     R1,TIBSCB          SCB = SCB TO BE DEALLOC. ?   @D51IDIS 19060051
         BNE   SETDEFSL           NO, LOOP                     @D51IDIS 19070051
         L     R5,TIBPCB          GET PCB ADDRESS              @D51IDIS 19080051
         USING PCBADR,R5                                       @D51IDIS 19090051
         MVC   TIBSCB(4),PCBASCB  SET TO DEFAULT SCB           @D51IDIS 19100051
         B     SETDEFSL           LOOP                         @D51IDIS 19110051
         DROP  R6                                              @D51IDIS 19120051
         DROP  R5                                              @D51IDIS 19130051
         DROP  R8                                              @D51IDIS 19140051
         EJECT ,                                               @D149DIS 19150051
*-------------------------------------------------------------          19160051
* SETDEFS2 - CHECK, IF SCB TO BE DEALLOCATED IS ACTIVE ON ANY CPU       19170051
*-------------------------------------------------------------          19180051
SETDEFS2 DS    0H                                              @D51IDIS 19190051
*        DISPMAC FUNC=SETDEF,INP1=R1,WR1=R4                    @D61RDIS 19200051
         DISPMAC FUNC=SETDEF,INP1=R1,WR1=R4                    @D61RDIS 19210051
         BR    R7                 RETURN TO CALLER             @D61RDIS 19220051
         EJECT ,                                               @D61RDIS 19230051
         DS    0F                                              @D52HDIS 19240051
ALLBNDX  DC    CL8'DISPALLB'                                   @D61NDIS 19250051
**********************************************************************  19260051
* ALLBND   - ALLBOUND TIME PROCESSING ROUTINES                          19270051
**********************************************************************  19280051
*            FUNCTION: PRIOR TO ENTER ALL-BOUND WAIT STATE TEST         19290051
*                      SYSTEM STATUS AND DO ANY NECESSARY ACTIONS       19300051
**********************************************************************  19310051
         USING DISP,R6                                         @D52HDIS 19320051
         USING ALLBNDX,RF                                      @D61NDIS 19330051
ALLBNDXE DS    0H                                              @D35EDFR 19340051
*        AMODESW SET,AMODE=24,WR=(14) SWITCH TO AMODE 24       @D52VDIS 19350051
         AMODESW SET,AMODE=24,WR=(14)                          @D52VDIS 19360051
         SPACE 1                                               @D369DFR 19370051
*--------------------------------------------------------------         19380051
*        CALL LOAD LEVELER                                     @D369DFR 19390051
*--------------------------------------------------------------         19400051
         TM    SYSFLAG2,IPLBIT    IS IPL IN PROGRESS           @DM04212 19410051
         BO    ALBRTRNX           YES, NO LOAD LEVELLING       @D52HDIS 19420051
         L     RE,APMGMDAT        LOAD PMR BASE-DATA BASE      @D35EDRP 19430051
         USING PMGMDATA,RE                                     @D35EDRP 19440051
         L     R5,AALBEXIT        CONDITIONAL REACTIVATION     @D35EDRP 19450051
         DROP  RE                                              @DM03306 19460051
         BR    R5                 GOTO LOAD LEVELER            @D35EDRP 19470051
*SGLINK  ALBEXIT,INPUT=(R5,R6,RE)                              @D14BDFR 19480051
ALBRTRNX DS    0H                 RETURN POINT FROM LOAD.LEV.  @D52HDIS 19490051
         L     RF,ADISPALL        GET DISP. ALLBOUND ROUTINE PT@D52HDIS 19500051
*--------------------------------------------------------------         19510051
*        CALL RAS ALLBOUND ROUTINES                                     19520051
*--------------------------------------------------------------         19530051
         L     RB,RASLINKA        GET BASE FOR ...             @D61RDIS 19540051
         L     RB,RASBASE-RASLINK(,RB)     ... RAS ROUTINES    @D61RDIS 19550051
         USING MCSTRT,RB          MCRAS BASE POINTER           @D52HDIS 19560051
         BAL   R7,MACHALLB        CALL RAS ALLBOUND ROUTINE    @D21HDIS 19570051
         DROP  RB                 RELEASE MCRAS BASE           @D52HDIS 19580051
         L     RF,ADISPALL        GET DISP. ALLBOUND ROUTINE PT@D52HDIS 19590051
         EJECT ,                                               @D52VDIS 19600051
*--------------------------------------------------------------         19610051
*        CALL  MISSING INTERRUPT HANDLER                       @D14BDFR 19620051
*--------------------------------------------------------------         19630051
         L     RD,AMISINTA        ADDRESS OF SGMIH             @KD40338 19640051
         USING MISINTAT,RD        SGMIH BASE POINTER           @KD40338 19650051
         BAL   R7,MISINTHD        CHECK IF INTERRUPT IS MISSING@D37BDAP 19660051
*SGLINK  MISINTHD,INPUT=(R6,R7,RD)                             @D37BDAP 19670051
         DROP  RD                 RELEASE SGMIH BASE           @D37BDAP 19680051
         L     RF,ADISPALL        GET DISP. ALLBOUND ROUTINE PT@D52HDIS 19690051
*--------------------------------------------------------------         19700051
*        CALL PERFORMANCE TOOL                                          19710051
*--------------------------------------------------------------         19720051
DISPALLP DS    0H                                              @D61RDIS 19730051
         NOP   0                   ALLBOUND ...                @D61RDIS 19740051
         NOP   0                        ...        ...         @D61RDIS 19750051
         NOP   0                        ... VENDOR ...         @D61RDIS 19760051
         NOP   0                               ... HOOK        @D61RDIS 19770051
*        SGVSEPT PROBE=3               I/F TO PERFORM.TOOL     @D51MDKH 19780051
         SGVSEPT PROBE=3               I/F TO PERFORM.TOOL     @D51MDKH 19790051
*        DISPMAC FUNC=ALLBND                                   @D61RDIS 19800051
         DISPMAC FUNC=ALLBND                                   @D61RDIS 19810051
         DROP  R6                                              @D52HDIS 19820051
         DROP  RF                                              @D52HDIS 19830051
         EJECT ,                                               @D149DIS 19840051
         DS    0F                                              @D52HDIS 19850051
         DC    CL8'DISPEXIT'                                   @D52HDIS 19860051
**********************************************************************  19870051
* DISPEXIT - DISPATCHER EXIT ROUTINES                                   19880051
**********************************************************************  19890051
*            FUNCTION: PRIOR TO TASK NORMAL PROCESSING PERFORM          19900051
*                      ANY DISPATCHER EXIT PROCESSING                   19910051
*            INPUT: R6 - DISPATCHER BASE ADDRESS                        19920051
*                   R8 - TIB ADDRESS                                    19930051
*                   RA - TCB ADDRESS                                    19940051
*                   RB - SAVE AREA ADDRESS                              19950051
*            AMODE: 24                                                  19960051
**********************************************************************  19970051
         USING DISP,R6                                         @D52HDIS 19980051
         USING TIBADR,R8                                       @D52HDIS 19990051
         USING DISPEXIT,RF                                     @D52HDIS 20000051
*--------------------------------------------------------------         20010051
*        DETERMINE ROUTINE ADDRESS AND BRANCH TO THE ROUTINE   @D369DFR 20020051
*--------------------------------------------------------------         20030051
DISPEXIT SLR   R1,R1              RESET WORKREGISTER           @D14BDFR 20040051
         IC    R1,TIBFLAG         INSERT TIBFLAG               @D14BDFR 20050051
         IC    R1,PREXTTAB(R1)    ID OF HIGHEST PRIORITY ROUT. @D14BDFR 20060051
         L     R1,DISPATAB(R1)    ADDRESS OF EXIT ROUTINE      @D14BDFR 20070051
         C     R1,DISPDELM        DELAYED MOVE ROUTINE         @D52HDIS 20080051
         BER   R1                 YES, SKIP DEBUG ENTRY        @D52HDIS 20090051
         L     R0,DISPEXD0    GET DEBUG INDICATION             @D52HDIS 20100051
*        DEBUG ALLREGS,XXDBGMC                                 @D61NDIS 20110051
         DEBUG ALLREGS,XXDBGMC                                 @D61NDIS 20120051
         SLR   R0,R0              RESET INDICATION             @D61NDIS 20130051
         LA    R1,0(,R1)          CLEAR HIGH ORDER BYTE        @D52HDIS 20140051
         BR    R1                 BRANCH TO SPECIAL ROUTINE    @D14BDFR 20150051
         EJECT ,                                                        20160051
*--------------------------------------------------------------         20170051
*        TABLE OF DISPATCHER EXIT ROUTINE ADDRESSES            @D14BDFR 20180051
*--------------------------------------------------------------         20190051
         DS    0F                                              @D14BDFR 20200051
DISPATAB EQU   *-4                                             @D14BDFR 20210051
         DC    AL1(CSVRET)                                     @D14BDFR 20220051
         DC    AL3(SVRETURN)      RETURN TO SUPERVISOR ROUTINE @D14BDFR 20230051
         DC    AL1(RETRYSVC)                                   @D14BDFR 20240051
         DC    AL3(REENTSVC)      REENTER SVC FLIH             @D14BDFR 20250051
DISPDELM DC    AL1(TIBDELMV)                                   @D52HDIS 20260051
         DC    AL3(DELMOVE)       GENERAL DELAYED MOVE ROUTINE @D14NDFG 20270051
         DC    AL1(FETCHEOJ)                                   @D14BDFR 20280051
         DC    AL3(CNCLEXIT)      INITIALIZE TASK TERMINATION  @D14BDFR 20290051
         DC    AL1(ROLLOUT)                                    @D14BDFR 20300051
         DC    AL3(ICCFEXIT)      ACTIVATE ICCF HIGH PRTY.TASK @D14BDFR 20310051
         DC    AL1(CDELEX)                                     @D14BDFR 20320051
         DC    AL3(EXTRETRN)      PROCESS DELAYED TIMER INTER. @D14BDFR 20330051
         DC    AL1(OCPEND)                                     @D14BDFR 20340051
         DC    AL3(OCEXIT)        PROC.DELAYED OC INTERRUPT    @D14BDFR 20350051
         DC    AL1(APSEXFLG)                                   @D14BDFR 20360051
         DC    AL3(APSEXIT)       CALL VTAM                    @D14BDFR 20370051
         SPACE 1                                               @D369DFR 20380051
DISPEXD0 DC    C'EXT0'            EXIT 0 INDICATOR FOR DEBUG   @D52HDIS 20390051
ANYEXIT  EQU   X'FF'                                           @D36IDFR 20400051
         DROP  R6                                              @D52HDIS 20410051
         DROP  R8                                              @D52HDIS 20420051
         DROP  RF                                              @D52HDIS 20430051
         EJECT ,                                                        20440051
***************************************************************         20450051
*        DISPATCHER EXITS                                               20460051
*            AMODE: 24                                                  20470051
***************************************************************         20480051
         USING DISP,R6                                         @D52HDIS 20490051
         USING TIBADR,R8                                       @D52HDIS 20500051
         USING TCBADR,RA                                       @D52HDIS 20510051
         USING SVEARA,RB                                       @D52HDIS 20520051
*--------------------------------------------------------------         20530051
* SVRETURN - INITIALIZE RETURN TO A SUPERVISOR ROUTINE                  20540051
*--------------------------------------------------------------         20550051
         USING SVRETURN,R1                                     @D52HDIS 20560051
SVRETURN DS    0H                                              @D61NDIS 20570051
         L     RD,AACCTTIM        GET TIME ACCOUNTING BASE     @D64ADIS 20580051
         BALR  R9,RD              PERFORM TIME ACCOUNTING      @D64ADIS 20590051
         L     RB,TCBSAV2         POINT TO SPECIAL SAVE AREA   @D14BDFR 20600051
         STOSM SVEPSW,M0          USE CURRENT SYSTEM MASK      @DA05788 20610051
         MVI   SVEPSW+1,ECBIT+MCBIT CREATE A CORRECT PSW       @DA05788 20620051
         MVC   ERA(8),SVEPSW      MAKE PSW ADDRESSABLE                  20630051
         NI    TIBFLAG,XFF-CSVRET RESET TIBFLAG                @D36IDFR 20640051
*        BE CAREFULLY: THIS ROUTINE MUST NOT BE INTERRUPTED!!! @D36IDFR 20650051
         MVC   RID+1(1),TCBRID    IDENTIFY ROUTINE             @D14BDFR 20660051
         CLI   TCBRID,REENTRID    REENTRANT ROUTINE TO BE RET.?@D36ZDFR 20670051
         BNE   GATERTRN           IF NOT,GOTO PROC.GATED ONE   @D14BDFR 20680051
         EJECT ,                                               @D61NDIS 20690051
*--------------------------------------------------------------         20700051
* LPSW     - LOAD ACCESS REGISTERS                                      20710051
*--------------------------------------------------------------         20720051
LPSW     DS    0H                                              @D51ADTP 20730051
*        AMODESW SET,AMODE=31     SWITCH INTO 31 BIT MODE      @D61PDIS 20740051
         AMODESW SET,AMODE=31     SWITCH INTO 31 BIT MODE      @D61PDIS 20750051
         L     R9,TCBAR2SV        GET AR SAVE AREA POINTER     @D61PDIS 20760051
         LAM   R0,RF,0(R9)        RESTORE ACCRESS REGISTERS    @D51ADTP 20770051
         LM    R9,R8,SVER09       LOAD TASKS GENERAL REGISTERS @D51ADTP 20780051
DISP3002 DS    0H                                              @D61RDIS 20790051
         NOP   0                  DISPATCHER EXIT ...          @D61RDIS 20800051
         NOP   0                             ...        ...    @D61RDIS 20810051
         NOP   0                             ... VENDOR ...    @D61RDIS 20820051
         NOP   0                                       ... HOOK@D61RDIS 20830051
*        DEBUG ERAPSW,XXDBGMC                                  @D61NDIS 20840051
         DEBUG ERAPSW,XXDBGMC                                  @D61NDIS 20850051
         LPSW  ERA                ACTIVATE TASKS PROC.VIA LPSW @D14BDFR 20860051
         EJECT ,                                               @D52VDIS 20870051
*--------------------------------------------------------------         20880051
* GATERTRN - INITIALIZE RETURN TO A GATED SVC                           20890051
*--------------------------------------------------------------         20900051
GATERTRN LH    R5,RID             INSERT RID FROM TCB          @D36IDFG 20910051
         SLL   R5,3               DISPL.TO SRQTAB ENTRY        @D14BDFR 20920051
         LA    RF,LPSW            RETURN ADDRESS               @D14BDFG 20930051
         CLI   RID+1,PARTGATE     IS IT A PART.GATE            @D14BDFR 20940051
         BNL   GATEDSVP           YES,RES.QUEUE IS IN PCB      @D14BDFR 20950051
         A     R5,ASRQTAB         POINT TO RESOURCE QUEUE      @D61RDIS 20960051
         B     RPOST              POST ALL WAITERS             @D36IDFG 20970051
*SGLINK RPOST,INPUT=(R5,R6,RF),WORK=(R5,RE)                             20980051
GATEDSVP S     R5,DPGATE          DISPL.TO RES.QUEUE IN PCB    @D14BDFR 20990051
         A     R5,PCBPTR          POINT TO RES.QUEUE IN PCB    @D14BDFR 21000051
         B     RPOST              GOTO POST ANY WAITERS        @D14BDFR 21010051
*SGLINK RPOST,INPUT=(R5,R6,RF),WORK=(R5,RE)                             21020051
         DROP  R1                                              @D52HDIS 21030051
         EJECT ,                                               @D52VDIS 21040051
*--------------------------------------------------------------         21050051
* DELMOVE  - GENERAL DELAYED MOVE ROUTINE                               21060051
*            DETERMINE ROUTINE ADDRESS AND BRANCH TO THE ROUTINE        21070051
*            AMODE: 24                                                  21080051
*--------------------------------------------------------------         21090051
         USING DELMOVE,R1                                      @D52HDIS 21100051
DELMOVE  SLR   RF,RF              CLEAR WORKREGISTER           @D14NDFG 21110051
         IC    RF,TIBDMFLG        GET DELAYED MOVE FLAG        @D14NDFG 21120051
         IC    RF,PREXTTAB(RF)    HIGHEST PRIORITY OFFSET      @D14NDFG 21130051
         LA    RF,DELMATAB(RF)    ADDRESS OF RESET MASK        @D14NDFG 21140051
         NC    TIBDMFLG,0(RF)     RESET HIGHEST PRIORITY BIT   @D14NDFG 21150051
         BNZ   DELMOVE1           SKIP IF STILL NON-ZERO       @D14NDFG 21160051
         NI    TIBFLAG,XFF-TIBDELMV RESET GLOBAL DEL.MOVE FLAG @D14NDFG 21170051
DELMOVE1 DS    0H                                              @D52HDIS 21180051
         MVI   RID+1,REENTRID       IDENTIFY REENTRANT ROUTINE @D14NDFG 21190051
         L     R0,DISPEXD1    GET DEBUG INDICATION             @D52HDIS 21200051
         DROP  R1                                              @D52HDIS 21210051
         L     R1,0(RF)           ADDRESS OF EXIT ROUTINE      @D52HDIS 21220051
*        DEBUG ALLREGS,XXDBGMC                                 @D61NDIS 21230051
         DEBUG ALLREGS,XXDBGMC                                 @D61NDIS 21240051
         SLR   R0,R0              RESET INDICATION             @D61NDIS 21250051
         LA    R1,0(,R1)      CLEAR HIGH ORDER BYTE            @D52HDIS 21260051
         LR    RF,R1          SET RF FOR BASE ADDRESS          @D52HDIS 21270051
         BR    RF                 BRANCH TO SPECIAL ROUTINE    @D14NDFG 21280051
         EJECT ,                                               @D61NDIS 21290051
*--------------------------------------------------------------         21300051
*        TABLE OF DELAYED MOVE ROUTINE ADDRESSES               @D14NDFG 21310051
*--------------------------------------------------------------         21320051
         DS    0F                                              @D14NDFG 21330051
DELMATAB DC    AL1(TIBDMALL)                                   @D14NDFG 21340051
         DC    AL3(DISP)          EXIT IF FLAG IS 0            @D14NDFG 21350051
         DC    AL1(TIBDMALL-TIBCMVEX)                          @D14NDFG 21360051
         DC    AL3(MOVECCB)       DELAYED CCB POSTING ROUTINE  @D14NDFG 21370051
         DC    AL1(TIBDMALL-TIBXPCEX)                          @D14NDFG 21380051
         DC    AL3(XPCCEXIT)      DELAYED XPCC MOVE ROUTINE    @D14NDFG 21390051
         DC    AL1(TIBDMALL-TIBSFLEX)                          @D14NDFG 21400051
         DC    AL3(SV103RET)      DELAYED SYSFIL FBA ROUTINE   @D14NDFG 21410051
         DC    AL1(TIBDMALL-TIBPERST)                          @D14NDFG 21420051
         DC    AL3(TINFMOPD)      DELAYED PER BIT SETTING      @D14NDFG 21430051
         DC    AL1(TIBDMALL-TIBGENEX)                          @D52HDIS 21440051
         DC    AL3(DISPEXRI)      GENERAL DISPATCHER EXIT ROUT.@D52HDIS 21450051
         DC    AL1(TIBDMALL-TIBTERMX)                          @D52GDIS 21460051
         DC    AL3(TERMSRES)      RESET DUMP TO LOW PRIORITY   @D52GDIS 21470051
         DC    AL1(TIBDMALL-TIBSTOPR)                          @D61RDIS 21480051
         DC    AL3(DISPTSTP)      TASK TO BE STOPPED           @D61RDIS 21490051
         SPACE 2                                               @D52HDIS 21500051
DISPEXD1 DC    C'EXT1'            EXIT 1 INDICATOR FOR DEBUG   @D52HDIS 21510051
         EJECT ,                                               @D61RDIS 21520051
*--------------------------------------------------------------         21530051
* DISPSTOP - TASK TO BE STOPPED                                         21540051
*--------------------------------------------------------------         21550051
DISPTSTP DS    0H                                              @D61RDIS 21560051
         MVI   RID+1,REENTRID     IDENTIFY REENTRANT ROUTINE   @D61RDIS 21570051
*        DISPMAC FUNC=DISPSTOP    STOP CURRENT TASK            @D61RDIS 21580051
         DISPMAC FUNC=DISPSTOP    STOP CURRENT TASK            @D61RDIS 21590051
         EJECT ,                                               @D52VDIS 21600051
*--------------------------------------------------------------         21610051
* OCEXIT  - ACTIVATE USER OC EXIT ROUTINE                               21620051
*--------------------------------------------------------------         21630051
         USING OCEXIT,R1                                       @D52HDIS 21640051
OCEXIT   MVI   RID+1,REENTRID     IDENTIFY REENTRANT ROUTINE   @D36IDFR 21650051
         NI    TIBFLAG,XFF-OCPEND SETOFF OC INT. PENDING       @D36IDFR 21660051
         CLI   TIBCNCL,ZERO       CANCEL IN PROGRESS           @D36IDFR 21670051
         BNER  R6                 YES, FORGET OC INTERRUPT     @D14BDFR 21680051
*        AMODESW SET,AMODE=31,WR=(7)                           @D64ADIS 21690051
         AMODESW SET,AMODE=31,WR=(7)                           @D64ADIS 21700051
         USING PCBADR,R5                                       @D34RDFG 21710051
         ICM   R7,15,PCBOCPTR     GET OC EXIT BLOCK ADDRESS    @D64ADIS 21720051
         BZR   R6                 NOT AVAILABLE -> SKIP        @D64ADIS 21730051
         USING EXITBLK,R7                                      @D64ADIS 21740051
         TM    VTAMFLG,VTAPP+VTURX VTAM PROCESS ACTIVE         @DA27622 21750051
         BNZ   OCEXIT1            IF YES, DELAY OC EXIT        @DA27622 21760051
         TM    TCBFLAG6,TCBPSTAC  VENDOR P-STATE EXIT ACTIVE   @D64ADIS 21770051
         BO    OCEXIT1            YES, ---> DELAY OC EXIT      @D61EDOW 21780051
         TM    TCBEXITF,TCBPOACT+TCBEXACT ANY POST|ETXR EXIT AC@D64ADOW 21790051
         BNZ   OCEXIT1            YES, ---> DELAY OC EXIT      @D64ADOW 21800051
         LM    R3,R4,EXITADR      GET ROUT.AND SAVEAREA ADDR.  @D64ADIS 21810051
         L     RD,ASGEXIT         BASE OF IT-EXIT RTN          @D51HDOW 21820051
         USING SGEXIT,RD                                       @D51HDOW 21830051
         TM    TIBFLAG1,TERMACT   PDUMP ACTIVE                 @D36IDFR 21840051
         BNO   OCROUT             NO, ENTER OC EXIT ROUTINE    @D64ADIS 21850051
*SGLINK  OCROUT,INPUT=(R3,R4,R6,R7,RA,RD),WORK=(R5,RB)                  21860051
OCEXIT1  OI    EXITFLG,DELINT     OC INTERRUPT PENDING         @D64ADIS 21870051
         BR    R6                 RETURN TO TASK SELECTION     @D14BDFR 21880051
         DROP  R1                                              @D52HDIS 21890051
         DROP  R5                                              @D36IDFR 21900051
         DROP  R7                                              @D64ADIS 21910051
         DROP  RD                                              @D36IDFR 21920051
         EJECT ,                                               @D52VDIS 21930051
*--------------------------------------------------------------         21940051
* REENTSVC - RETRY ENTERING OF AN SVC ROUTINE                           21950051
*--------------------------------------------------------------         21960051
         USING REENTSVC,R1                                     @D52GDIS 21970051
REENTSVC CLI   TIBFLAG,RETRYSVC   ANY OTHER DISPATCHER EXIT    @D14BDFR 21980051
         BNE   RESRETRY           YES,SETUP TASK TO RESVC      @D14BDFR 21990051
*SGLINK  RESRETRY,INPUT=(R6,R8,RA,RB),WORK=(R5,R9)             @D149DIS 22000051
         STOSM PSWMASK,ENABLE     OPEN WINDOW FOR INTERRUPTS   @D14BDFR 22010051
         STNSM PSWMASK,DISABLE    CLOSE WINDOW IMMEDIATELY     @D14BDFR 22020051
         CLC   SVEPSW(1),SVEEND-1 ENSURE SAVEAREA TO BE        @D52GDIS 22030051
*                                      PAGED IN                @D52GDIS 22040051
*--------------------------------------------------------------         22050051
*        LOAD ACCESS REGISTERS                                          22060051
*--------------------------------------------------------------         22070051
         L     R9,TCBARSAV        GET AR SAVE AREA POINTER     @D61PDIS 22080051
         LAM   R0,RF,0(R9)        RESTORE ACCRESS REGISTERS    @D52GDIS 22090051
         DROP  R1                                              @D52GDIS 22100051
         L     RD,AACCTTIM        GET TIME ACCOUNTING BASE     @D64ADIS 22110051
         BALR  R9,RD              PERFORM TIME ACCOUNTING      @D64ADIS 22120051
         LM    RF,R2,SVER0F       LOAD PARAMETER REGISTERS     @D36IDFR 22130051
         MVI   RID+1,REENTRID     IDENTIFY REENTRANT ROUTINE   @D36IDFG 22140051
         NI    TIBFLAG,XFF-RETRYSVC RESET DISPATCHER EXIT      @D36IDFR 22150051
         L     RD,AFLIH           BASE ADDRESS OF ENTSVC       @D36IDFR 22160051
         USING FLIH,RD                                         @D36IDFR 22170051
         B     SVCINDEX           EXIT POINTER FOR ACCOUNTING  @D14BDFR 22180051
*SGLINK  SVCINDEX,INPUT=(R0,R1,R2,R8,RA,RB,RD,RF)                       22190051
         DROP  RD                                              @D36ZDFR 22200051
         EJECT ,                                               @D52VDIS 22210051
*--------------------------------------------------------------         22220051
* APSEXIT  - CALL VTAM APS EXIT (ISTAPCIE) OR TPEND EXIT (ISTAPCKU)     22230051
*--------------------------------------------------------------         22240051
         USING APSEXIT,R2                                      @D52HDIS 22250051
APSEXIT  MVI   RID+1,REENTRID     IDENTIFY REENTRANT ROUTINE   @D14BDFR 22260051
         LR    R2,R1              GET BASE ADDRESS             @D52VDIS 22270051
         NI    TIBFLAG,XFF-APSEXFLG  RESET VTAM APS EXIT FLAG  @D14BDFR 22280051
         LA    R1,AOTADR          SETUP PARAM.FOR APS ROUT.    @DA36477 22290051
         USING AOTADR,R1                                       @DA36477 22300051
         TM    TIBFLAG3,VTACTCKU+VTDELCKU                      @DA36477 22310051
*                                 ISTAPCKU TO BE ACTIVATED ?   @DA36477 22320051
         BNZ   APCKUACT           YES, GOTO ACTIVATE ISTAPCKU  @DA36477 22330051
         TM    TIBFLAG1,TERMACT   IS TASK TERMINATING          @D14BDFR 22340051
         BO    APSEXDEL           YES, GOTO DELAY EXIT         @D14BDFR 22350051
         L     RE,IJBTCAVT        POINT TO VTAM VECTOR         @D36IDFG 22360051
         USING ISTAVT,RE                                       @D36IDFG 22370051
         L     R8,ISTAPSEX        ADDRESS EXIT TO APS          @DL28101 22380051
         DROP  RE                                              @D35EDEM 22390051
*        AMODESW CALL,REGS=(R7,R8) BRANCH TO APS SWAP RTNE     @D61PDIS 22400051
         AMODESW CALL,REGS=(R7,R8) BRANCH TO APS SWAP RTNE     @D61PDIS 22410051
         DROP  R1                                              @D36IDFG 22420051
         EJECT ,                                               @D61NDIS 22430051
*--------------------------------------------------------------         22440051
* ATCONT  - ENTRY POINT FROM ISTAVT                                     22450051
*--------------------------------------------------------------         22460051
ATCONT   DS    0H                                              @D52HDIS 22470051
         L     R6,DISPAD      GET DISPATCHER BASE ADDRESS      @D61PDIS 22480051
         L     R2,AAPSEXIT        RESTORE BASE ADDRESS         @D52HDIS 22490051
*        AMODESW SET,AMODE=31,WR=(8)                           @D61PDIS 22500051
         AMODESW SET,AMODE=31,WR=(8)                           @D61PDIS 22510051
         L     R8,TIBPTR          RESTORE TIB POINTER          @D52HDIS 22520051
         L     RA,TCBPTR          RESTORE TCB POINTER          @D61PDIS 22530051
         L     R3,TCBATCBE        GET ADDR. OF TCB EXTENSION   @D61PDIS 22540051
         USING TCBXADR,R3                                      @D61PDIS 22550051
         B     ATCONTU            *** TEMPORARY ***           TEMPORARY 22560051
         STCTL CRF,CRF,TCBX1CRF   *** TEMPORARY ***           TEMPORARY 22570051
ATCONTU  DS    0H                                              @D64ADIS 22580051
         ICM   R5,15,TCBXTLSA     LINKAGE STACK ENTRY SAVED ?  @D61PDIS 22590051
         BZ    ATCONTX            NO, SKIP                     @D61PDIS 22600051
         ST    R5,TCBX1CRF        RESTORE LINKAGE STACK ENTRY  @D61PDIS 22610051
         XC    TCBXTLSA(4),TCBXTLSA  INDICATE ENTRY NOT SAVED  @D61PDIS 22620051
ATCONTY  DS    0H                                              @D61PDIS 22630051
         MVI   RID+1,REENTRID                                  @D61PDOW 22640051
         TM    VTAMFLG,VTAPP      VTAM PROCESS ACTIVE          @DA36477 22650051
         BOR   R6                 IF YES, DISPATCH IT          @D14BDFR 22660051
         TM    VTAMFLG,VTCDLY     CANCEL DELAYED BY VTAM       @D36IDFG 22670051
         BZ    ATCONT1            SKIP IF NOT                  @D36IDFG 22680051
         NI    VTAMFLG,XFF-VTCDLY RESET DELAYED CANCEL FLAG    @D36IDFG 22690051
         OI    TIBFLAG,FETCHEOJ   RESCHEDULE CANCEL EXIT       @D36IDFG 22700051
         BR    R6                 TAKE CANCEL EXIT             @D14BDFR 22710051
         SPACE 2                                               @D64ADIS 22720051
ATCONTX  DS    0H                                              @D61PDIS 22730051
         CLI   RID+1,USERTID      USER TASK INTERRUPTED ?      @D64ADOW 22740051
         BNE   ATCONTY            NO, CONTINUE                 @D64ADOW 22750051
         STCTL CRF,CRF,TCBX1CRF   SAVE CURRENT LINKAGE STACK EN@D61PDOW 22760051
         B     ATCONTY            CONTINUE                     @D64ADIS 22770051
         SPACE 2                                               @D64ADIS 22780051
ATCONT1  L     R5,PCBPTR          RESTORE PCB POINTER          @D36IDFG 22790051
         USING PCBADR,R5                                       @D36IDFG 22800051
         ICM   R5,15,PCBOCPTR     GET OC EXIT BLOCK ADDRESS    @D64ADIS 22810051
         BZ    ATCONT2            NOT AVAILABLE -> SKIP        @D64ADIS 22820051
         USING EXITBLK,R5                                      @D64ADIS 22830051
         TM    EXITFLG,DELINT     DELAYED OC EXIT ?            @D64ADIS 22840051
         BZ    ATCONT2            SKIP IF NOT                  @D36IDFG 22850051
         CLC   TID(2),IJBHMTID    IS THIS A MAINTASK           @D51IDIS 22860051
         BH    ATCONT2            NO, NO OC EXIT ROUTINE       @DA29468 22870051
         NI    EXITFLG,XFF-DELINT RESET DELAYED OC EXIT FLAG   @D64ADIS 22880051
         DROP  R5                                              @D36IDFG 22890051
         OI    TIBFLAG,OCPEND     RESCHEDULE OC EXIT           @D36IDFG 22900051
ATCONT2  TM    VTAMFLG,VTURX      ANY VTAM USER EXIT ACTIVE    @D36IDFG 22910051
         BOR   R6                 IF YES, AVOID IT EXIT        @D14BDFR 22920051
         ICM   R5,15,TCBXTQCA     GET ADDRESS OF IT-EXIT BLOCK @D64ADOW 22930051
         BZR   R6                 NOT AVAILABLE ---->>>>       @D64ADIS 22940051
         USING EXITBLK,R5                                      @D64ADIS 22950051
         TM    EXITFLG,DELINT     DELAYED EXIT ?               @D64ADIS 22960051
         BZR   R6                 NO, RESUME DISPATCHING       @D64ADIS 22970051
         NI    EXITFLG,XFF-DELINT   RESET DELAYED IT EXIT FLAG @D64ADIS 22980051
         OI    TIBFLAG,CDELEX     RESCHEDULE IT EXIT           @D36IDFG 22990051
         BR    R6                 CHECK AGAIN FOR EXITS        @D14BDFR 23000051
         DROP  R3                                              @D64ADIS 23010051
         DROP  R5                                              @D64ADIS 23020051
         SPACE 2                                               @D64ADIS 23030051
APSEXDEL OI    VTAMFLG,VTAPDEL    TURN ON DELAY INDICATOR      @D14BDFR 23040051
         BR    R6                 GOTO EXIT                    @D14BDFR 23050051
         EJECT ,                                               @D52VDIS 23060051
*--------------------------------------------------------------         23070051
* APCKUACT - ACTIVATE ISTAPCKU ROUTINE                                  23080051
*        INPUT: R1 = POINTER TO AOT TABLE                               23090051
*               R7 = RETURN ADDRESS TO SUPERVISOR                       23100051
*               R8 = ENTRY POINT OF ISTAPCKU ROUTINE                    23110051
*--------------------------------------------------------------         23120051
APCKUACT NI    TIBFLAG3,XFF-VTACTCKU-VTDELCKU                  @DA36477 23130051
*                                 RESET DELAYED IT EXIT FLAGS  @DA36477 23140051
         OI    TIBFLAG3,CKUACTIV     SET ACTIVE INDICATOR      @DA36477 23150051
         L     R8,ASVASVDL        POINT SVA SUPERV.SUBDIRECTORY@DA36477 23160051
         L     R8,AISTAPCK-SVASVDL(R8) POINT TO SVA APPENDAGE  @DA36477 23170051
*        AMODESW CALL,REGS=(R7,R8) BRANCH TO ISTAPCKU ROUTINE  @D61PDIS 23180051
         AMODESW CALL,REGS=(R7,R8) BRANCH TO ISTAPCKU ROUTINE  @D61PDIS 23190051
         L     R2,AAPSEXIT        RESTORE BASE ADDRESS         @D52HDIS 23200051
         L     R8,TIBPTR          RESTORE TIB AND TCB POINTERS @DA36477 23210051
         NI    TIBFLAG3,XFF-CKUACTIV RESET ACTIVE INDICATOR    @DA36477 23220051
         B     ATCONT             FINISH DISPATCHER EXIT PROC. @D61PDIS 23230051
         DROP  R2                                              @D52HDIS 23240051
         EJECT ,                                               @D52VDIS 23250051
*--------------------------------------------------------------         23260051
* ICCFEXIT - ACTIVATE ICCF HIGH PRTY.TASK                               23270051
*--------------------------------------------------------------         23280051
ICCFEXIT L     R9,IJBETSS         ICCF VECTOR TABLE            @D35ZDUL 23290051
         USING DTSVECDS,R9                                     @D35ZDUL 23300051
         OI    DTSECB+2,TRABIT    POST ICCF HIGH TASK ECB      @D35ZDUL 23310051
         MVI   RID+1,SYSTEMID     IDENT.NON INTERRUPTABLE PROC.@D14BDFR 23320051
         L     R5,ASRQTAB         POINT R5 TO ...              @D61RDIS 23330051
         LA    R5,SRQICCF-SRQTAB(,R5)     ... ICCF SRQ ENTRY   @D61RDIS 23340051
         BAL   RF,UNPOST          MAKE TASK ICCF BOUND         @D14BDFR 23350051
*SGLINK  UNPOST,INPUT=(R1,R5,R6,RF),WORK=(R5,RE)                        23360051
         LH    R8,DTSHTID         GET TID OF ICCF HIGH PR TASK @KD40342 23370051
         BAL   RF,IOPOST0         POST HIGH PRIORITY TASK      @KD40342 23380051
*SGLINK  IOPOST0,INPUT=(R6,R8,RF),WORK=(R8,RE)                          23390051
         BR    R6                 LET DISP DISPATCH ICCF HIGH  @D36ZDUL 23400051
         DROP  R9                 DROP VECTOR TABLE ADDRESS    @D35ZDUL 23410051
         DROP  RA                                              @D52HDIS 23420051
         DROP  RB                                              @D52HDIS 23430051
         EJECT ,                                               @D52HDIS 23440051
***************************************************************         23450051
*          - GENERAL DISPATCHER EXIT SERVICES                           23460051
***************************************************************         23470051
*--------------------------------------------------------------         23480051
* DISPXRB  - DISPATCHER EXIT REQUEST BLOCK (DSECT)                      23490051
*--------------------------------------------------------------         23500051
DISPXRB  DSECT                                                 @D52HDIS 23510051
DISPXCHF DS    A              CHAIN POINTER TO NEXT REQUEST    @D52HDIS 23520051
DISPXCHB DS    A              CHAIN POINTER TO FORMER REQUEST  @D52HDIS 23530051
DISPXEPT DS    A              EXIT ADDRESS                     @D52HDIS 23540051
DISPXRPT DS    A              RETURN ADDRESS AFTER EXIT        @D52HDIS 23550051
DISPXPPT DS    A              PARAMETER OR PARAMETER ADDRESS   @D52HDIS 23560051
DISPXPCK DS    A              PROGRAM CHECK EXIT ADDRESS       @D52HDIS 23570051
DISPXFLG DS    X              FLAG BYTE                        @D52HDIS 23580051
DISPXUSE EQU   X'80'          X'80' REQUEST BLOCK IN USE       @D52HDIS 23590051
         DS    3X             NOT USED                         @D52HDIS 23600051
DISPXLN  EQU   *-DISPXRB      LENGTH OF CONTROL BLOCK          @D52HDIS 23610051
         EJECT ,                                                        23620051
IJBSUP50 CSECT                  RESUME CSECT                   @D52HDIS 23630051
*--------------------------------------------------------------         23640051
* DISPEXRI - GENERAL DISPATCHER EXIT                                    23650051
*          - DEQUEUE ELEMENT AND CALL EXIT                              23660051
*            AMODE: 24                                                  23670051
*--------------------------------------------------------------         23680051
         USING DISPEXRI,R1                                     @D52HDIS 23690051
DISPEXRI DS    0H                                              @D52HDIS 23700051
         L     RF,TIBEXAF     GET FIRST ELEMENT IN QUEUE       @D52HDIS 23710051
         LA    R7,DISPEXRR    GET RETURN ADDRESS FOR EXIT      @D52HDIS 23720051
         TM    TIBFLAG4,TIBGEXAC EXIT ALREADY SCHEDULED ?      @D52HDIS 23730051
         BO    DISPEXRE       YES, ERROR                       @D52HDIS 23740051
         USING DISPXRB,RF     POINT TO FIRST ELEMENT           @D52HDIS 23750051
*--------------------------------------------------------------         23760051
*          - PREPARE INPUT FOR EXIT ROUTINE                             23770051
*--------------------------------------------------------------         23780051
         L     R9,DISPXEPT    GET ENTRY POINT OF EXIT          @D52HDIS 23790051
         L     RF,DISPXPPT    GET PARAMETER (ADDRESS)          @D52HDIS 23800051
         DROP  RF             RELEASE FIRST ELEMENT            @D52HDIS 23810051
         L     R0,DISPEXDB    GET DEBUG INDICATION             @D52HDIS 23820051
*        DEBUG ALLREGS,XXDBGMC                                 @D61NDIS 23830051
         DEBUG ALLREGS,XXDBGMC                                 @D61NDIS 23840051
         SLR   R0,R0              RESET INDICATION             @D61NDIS 23850051
*--------------------------------------------------------------         23860051
*          - DISPATCHER EXIT CALL                                       23870051
*            INPUT:  R6 - DISPATCHER BASE ADDRESS                       23880051
*                    R7 - RETURN ADDRESS (EXIT MUST RETURN WITH R7)     23890051
*                    R9 - ENTRY POINT ADDRESS                           23900051
*                    RF - USER INFORMATION (E.G. PARAMETER)             23910051
*            OUTPUT: R0 - R5 = EXIT DEFINED OUTPUT FOR                  23920051
*                              THE ROUTINE TO BE ENTERED                23930051
*                              AFTER EXIT                               23940051
*            WORK:   R6, R8 - RF                                        23950051
*            AMODE:  GIVEN BY FIRST BIT OF ENTRY POINT ADDRESS          23960051
*--------------------------------------------------------------         23970051
         OI    TIBFLAG4,TIBGEXAC INDICATE EXIT ACTIVE          @D52HDIS 23980051
*        AMODESW RETURN,REG=(9)                                @D52HDIS 23990051
         AMODESW RETURN,REG=(9)                                @D52HDIS 24000051
         DROP  R1                                              @D52HDIS 24010051
         EJECT ,                                               @D52HDIS 24020051
*--------------------------------------------------------------         24030051
* DISPEXRR - RETURN AFTER DISPATCHER EXIT                               24040051
*            DEQUEUE ELEMENT FROM REQUEST QUEUE,                        24050051
*            ENQUEUE ELEMENT INTO FREE QUEUE                            24060051
*            CONTINUE WITH USER DEFINED RETURN                          24070051
*            AMODE: ANY                                                 24080051
*--------------------------------------------------------------         24090051
         USING DISPEXRR,R7                                              24100051
DISPEXRR DS    0H                                              @D52HDIS 24110051
         L     R6,DISPAD      GET DISPATCHER BASE ADDRESS      @D52HDIS 24120051
         L     R8,TIBPTR      GET CURRENT TIB ADDRESS          @D52HDIS 24130051
         NI    TIBFLAG4,XFF-TIBGEXAC INDICATE EXIT INACTIVE    @D52HDIS 24140051
DISPEXRE DS    0H                                              @D52HDIS 24150051
         L     RF,TIBEXAF     GET FIRST ELEMENT IN QUEUE       @D52HDIS 24160051
         USING DISPXRB,RF     POINT TO FIRST ELEMENT           @D52HDIS 24170051
         NI    DISPXFLG,XFF-DISPXUSE RESET IN USE INDICATION   @D52HDIS 24180051
         L     R9,DISPXCHF    GET ADDRESS OF NEXT ELEMENT      @D52HDIS 24190051
         ST    R9,TIBEXAF     DEQUEUE ELEMENT                  @D52HDIS 24200051
         L     RA,DISPEXF     ENQUEUE ELEMENT ...              @D52HDIS 24210051
         ST    RA,DISPXCHF            ... INTO FREE QUEUE      @D52HDIS 24220051
         ST    RF,DISPEXF                                      @D52HDIS 24230051
         DROP  RF             RELEASE FIRST ELEMENT            @D52HDIS 24240051
         USING DISPXRB,R9     POINT TO NEXT ELEMENT            @D52HDIS 24250051
         LA    RA,TIBEXAF     GET ADDRESS OF ANCHOR            @D52HDIS 24260051
         ST    RA,DISPXCHB    SET NEW BACKWARD POINTER         @D52HDIS 24270051
         CR    R9,RA          MORE ELEMENTS IN QUEUE ?         @D52HDIS 24280051
         BE    DISPEXRX       NO, DO NOT SET EXIT AGAIN        @D52HDIS 24290051
         DROP  R9             RELEASE NEXT ELEMENT             @D52HDIS 24300051
         OI    TIBFLAG,TIBDELMV PROCESS NEXT ...               @D52HDIS 24310051
         OI    TIBDMFLG,TIBGENEX             ... EXITS         @D52HDIS 24320051
         EJECT ,                                                        24330051
*--------------------------------------------------------------         24340051
* DISPEXRX - DISPATCHER EXIT RETURN                                     24350051
*            REGISTER CONTENTS:                                         24360051
*                    R0 - R5 = EXIT DEFINED OUTPUT FOR                  24370051
*                              THE ROUTINE TO BE ENTERED                24380051
*                              AFTER EXIT                               24390051
*                    R9 - RETURN ADDRESS                                24400051
*                    OTHER REGISTERS ARE UNPREDICTABLE                  24410051
*            AMODE:  GIVEN BY FIRST BIT OF RETURN ADDRESS               24420051
*--------------------------------------------------------------         24430051
DISPEXRX DS    0H                                              @D52HDIS 24440051
         TM    TIBFLAG4,TIBGEXAC EXIT SCHEDULED TWICE ?        @D52HDIS 24450051
         BO    DISPEXRD       YES, ERROR                       @D52HDIS 24460051
         USING DISPXRB,RF     POINT TO FIRST ELEMENT           @D52HDIS 24470051
         L     R9,DISPXRPT    GET RETURN ADDRESS               @D52HDIS 24480051
         LR    RB,R0          SAVE R0                          @D52HDIS 24490051
         L     R0,DISPEXDE    GET DEBUG INDICATION             @D52HDIS 24500051
*        DEBUG ALLREGS,XXDBGMC                                 @D61NDIS 24510051
         DEBUG ALLREGS,XXDBGMC                                 @D61NDIS 24520051
         LR    R0,RB          RESTORE R0                       @D52HDIS 24530051
*        AMODESW RETURN,REG=(9)                                @D52HDIS 24540051
         AMODESW RETURN,REG=(9)                                @D52HDIS 24550051
         DROP  RF             RELEASE FIRST ELEMENT            @D52HDIS 24560051
         EJECT ,                                               @D61NDIS 24570051
*--------------------------------------------------------------         24580051
* DISPEXRD - EXIT DEQUEUED, RETURN TO DISPATCHER                        24590051
*--------------------------------------------------------------         24600051
DISPEXRD DS    0H                                              @D52HDIS 24610051
         NI    TIBFLAG4,XFF-TIBGEXAC INDICATE EXIT INACTIVE    @D52HDIS 24620051
         L     R0,DISPEXDR    GET DEBUG INDICATION             @D52HDIS 24630051
*        DEBUG ALLREGS,XXDBGMC                                 @D61NDIS 24640051
         DEBUG ALLREGS,XXDBGMC                                 @D61NDIS 24650051
         SLR   R0,R0              RESET INDICATION             @D61NDIS 24660051
         BR    R6             RETURN TO DISPATCHER             @D52HDIS 24670051
         DROP  R6                                              @D52HDIS 24680051
         DROP  R7                                              @D52HDIS 24690051
         DROP  R8                                              @D52HDIS 24700051
         EJECT ,                                                        24710051
***************************************************************         24720051
* DISPEXRT - GENERAL DISPATCHER EXIT SCHEDULER                          24730051
*--------------------------------------------------------------         24740051
*            ANY SUPERVISOR SERVICE WITH RID+1=REENTRID                 24750051
*            CAN SET THE GENERAL DISPATCHER EXIT.                       24760051
*            DISPEXRT USES THE SVCSV3 WORK AREA LOCATED IN TCB.         24770051
*            INPUT (DISPEXRT):                                          24780051
*              R0 - ENTRY POINT ADDRESS OF EXIT                         24790051
*                   AMODE OF ENTRY POINT DEFINED BY HIGH ORDER BIT      24800051
*                     ON = AMODE 31, OFF = AMODE 24                     24810051
*              R1 - USER INFORMATION (E.G. PARAMETER)                   24820051
*              R2 - ROUTINE ADDRESS TO BE CALLED AFTER                  24830051
*                   RETURN FROM EXIT                                    24840051
*                   AMODE OF ENTRY POINT DEFINED BY HIGH ORDER BIT      24850051
*                     ON = AMODE 31, OFF = AMODE 24                     24860051
*              R3 - ROUTINE ADDRESS TO BE CALLED AFTER PROGRAM CHECK    24870051
*                   AMODE OF ENTRY POINT DEFINED BY HIGH ORDER BIT      24880051
*                     ON = AMODE 31, OFF = AMODE 24                     24890051
*              R6 - DISPATCHER BASE ADDRESS                             24900051
*              R7 - RETURN REGISTER FROM DISPEXRT                       24910051
*              R8 - TIB ADDRESS OF TASK,                                24920051
*                   WHERE EXIT HAS TO BE SCHEDULED                      24930051
*              R9 - DISPEXRT ROUTINE'S BASE ADDRESS                     24940051
*                   ADISPEXR IN DISP BASE                               24950051
*            OUTPUT:                                                    24960051
*              RF - GETVIS RETURN CODE, GETVIS FAILS                    24970051
*                   0 OTHERWISE                                         24980051
*            WORK: R1, R3, R5, RA, RC                                   24990051
*            AMODE: 24                                                  25000051
***************************************************************         25010051
         EJECT ,                                                        25020051
***************************************************************         25030051
* DISPEXRI - GENERAL DISPATCHER EXIT                                    25040051
*--------------------------------------------------------------         25050051
*            CALLS AN EXIT ROUTINE THAT WAS DEFINED BY THE              25060051
*            GENERAL DISPATCHER EXIT SCHEDULER (DISPEXRT).              25070051
*            THE EXIT ROUTINE WILL GET CONTROL WITH                     25080051
*            RID+1=REENTRID.                                            25090051
*          - LINKAGE CONVENTIONS FOR THE EXIT ROUTINE:                  25100051
*            INPUT:                                                     25110051
*              R6 - DISPATCHER BASE                                     25120051
*              R7 - RETURN ADDRESS AFTER EXIT                           25130051
*                   (EXIT MUST RETURN WITH R7)                          25140051
*              R9 - ENTRY POINT ADDRESS OF EXIT                         25150051
*              RF - USER INFORMATION (E.G. PARAMETER)                   25160051
*          - ONLY CLASS A FAST PATH SVCS AND PAGE FAULTS                25170051
*            ARE ALLOWED WITHIN EXIT                                    25180051
*          - DISPATCHER EXIT PRIORITY SEQUENCE (HIGH TO LOW):           25190051
*                 1) THE SUPERVISOR RETURN ROUTINE                      25200051
*                    (CALLED E.G. AFTER PAGE FAULT)                     25210051
*                 2) REENTER SVC ROUTINE                                25220051
*                 3) DELAYED MOVE CCB ROUTINE                           25230051
*                 4) DELAYED XPPC MOVE ROUTINE                          25240051
*                 5) DELAYED SYSFIL FBA ROUTINE                         25250051
*                 6) DELAYED PER BIT SETTING                            25260051
*          ====>> 7) GENERAL DISPATCHER EXIT                            25270051
*                 8) INITIALIZE TASK TERMINATION                        25280051
*                 9) ACTIVATE ICCF HIGH PRIORITY TASK                   25290051
*                10) PROCESS DELAYED TIMER INTERRUPTS                   25300051
*                11) PROCESS DELAYED OC INTERRUPTS                      25310051
*                12) CALL VTAM EXITS                                    25320051
***************************************************************         25330051
         EJECT ,                                                        25340051
***************************************************************         25350051
* DISPEXRX - CONTINUATION AFTER EXIT RETURN                             25360051
*--------------------------------------------------------------         25370051
*            IS DEFINED BY THE INPUT (REGISTER 2)                       25380051
*            OF THE DISPEXRT ROUTINE.                                   25390051
*            INPUT (FOR POINT OF CONTINUATION):                         25400051
*              R0 - R5 - EXIT DEFINED OUTPUT                            25410051
*              R9 - ADDRESS OF ENTRY POINT                              25420051
*              OTHER REGISTERS ARE UNPREDICTABLE                        25430051
*            THE ROUTINE WILL GET CONTROL WITH RID=REENTRID.            25440051
***************************************************************         25450051
         SPACE 2                                                        25460051
***************************************************************         25470051
*          - PROGRAM CHECK EXIT CONVENTIONS                             25480051
*--------------------------------------------------------------         25490051
*            THE PROGRAM CHECK EXIT ADDRESS MAY BE DEFINED AS           25500051
*            INPUT FOR THE GENERAL DISPATCHER EXIT SCHEDULER.           25510051
*            WHEN THE EXIT MAY GET A PROGRAM CHECK,                     25520051
*            THAT ADDRESS WILL GET CONTROL. THE PROGRAM                 25530051
*            CHECK EXIT WILL BE RESET. THE STATUS                       25540051
*            WAS SAVED IN THE SUPERVISOR SPECIAL SAVE AREA              25550051
*            AND WILL BE AVAILABLE UNTIL THE PCK EXIT GIVES UP          25560051
*            CONTROL (E.G. PAGE FAULT).                                 25570051
*            THE PCK EXIT WILL GET CONTROL WITH RID=REENTRID.           25580051
*            THE EXIT HAS TO RETURN TO THE GENERAL DISPATCHER           25590051
*            EXIT ROUTINE (LABEL DISPEXRR). REGISTER 7 HAS TO           25600051
*            CONTAIN THE RETURN ADDRESS, WHICH IS GIVEN AS              25610051
*            THE INPUT FOR THE EXIT ROUTINE ACTIVATION                  25620051
*            (SEE DISPEXRI). THE GENERAL DISPATCHER EXIT                25630051
*            ROUTINE CONTINES WITH THE ROUTINE ADDRESS                  25640051
*            TO BE CALLED AFTER RETURN FROM EXIT.                       25650051
*                                                                       25660051
*            INPUT (FOR PROGRAM CHECK EXIT):                            25670051
*              R9 - PROGRAM CHECK EXIT ADDRESS                          25680051
*              RF - ADDRESS OF SPECIAL SAVE AREA                        25690051
*                                                                       25700051
*            DISPEXPC - RETURN PROGRAM CHECK EXIT ADDRESS               25710051
*                       TO THE PROGRAM CHECK HANDLER                    25720051
***************************************************************         25730051
         EJECT ,                                                        25740051
         USING TIBADR,R8                                       @D52HDIS 25750051
         USING DISPEXRT,R9                                     @D52HDIS 25760051
*--------------------------------------------------------------         25770051
* DISPEXRT - GENERAL EXIT SCHEDULER ENTRY POINT                         25780051
*--------------------------------------------------------------         25790051
*SGLINK  DISPEXRT,S,INPUT=(R0,R1,R2,R3,R6,R7,R8,R9),                   *25800051
               WORK=(R1,R3,R5,RA,RC),OUTPUT=(RF)                        25810051
DISPEXRT DS    0H                                              @D52HDIS 25820051
         LR    R5,R1             SAVE USER INFORMATION         @D52HDIS 25830051
         ICM   R1,15,TIBEXAF     REQUEST CHAIN INITIALIZED ?   @D52HDIS 25840051
         BNZ   DISPEXXX          YES, CONTINUE                 @D52HDIS 25850051
         LA    R1,TIBEXAF        INITIALIZE REQUEST CHAIN      @D52HDIS 25860051
         ST    R1,TIBEXAB        SET BACKWARD POINTER          @D52HDIS 25870051
         ST    R1,TIBEXAF        SET FOREWARD POINTER          @D52HDIS 25880051
DISPEXXX DS    0H                                              @D52HDIS 25890051
         ICM   R1,15,DISPEXF     FREE REQUEST ELEMENT AVAIL. ? @D52HDIS 25900051
         BZ    DISPEXRA          NO, ALLOCATE AN ELEMENT       @D52HDIS 25910051
         USING DISPXRB,R1     POINT TO NEW ELEMENT             @D52HDIS 25920051
         L     RC,DISPXCHF       GET ADDRESS OF NEXT ELEMENT   @D52HDIS 25930051
         ST    RC,DISPEXF        SET NEW FREE CHAIN POINTER    @D52HDIS 25940051
*--------------------------------------------------------------         25950051
* DISPEXR0 - INITIALIZE ELEMENT                                         25960051
*--------------------------------------------------------------         25970051
DISPEXR0 DS    0H                                              @D52HDIS 25980051
         OI    DISPXFLG,DISPXUSE SET IN USE INDICATION         @D52HDIS 25990051
         ST    R0,DISPXEPT    SAVE EXIT ENTRY ADDRESS          @D52HDIS 26000051
         ST    R5,DISPXPPT    SAVE PARAMETER                   @D52HDIS 26010051
         ST    R2,DISPXRPT    SAVE RETURN ADDRESS              @D52HDIS 26020051
         ST    R3,DISPXPCK       SAVE PROGRAM CHECK EXIT ADDR. @D52HDIS 26030051
         LA    R3,TIBEXAF     GET ADDRESS OF QUEUE HEADER      @D52HDIS 26040051
         ST    R3,DISPXCHF    SET FORWARD POINTER IN NEW ELEM. @D52HDIS 26050051
*--------------------------------------------------------------         26060051
*          - ENQUEUE NEW ELEMENT (BECOMES LAST ELEMENT)                 26070051
*--------------------------------------------------------------         26080051
         L     R5,TIBEXAB     GET ADDRESS OF LAST ELEMENT      @D52HDIS 26090051
         ST    R5,DISPXCHB    SET BACKWARD POINTER             @D52HDIS 26100051
         DROP  R1             RELEASE NEW ELEMENT              @D52HDIS 26110051
         USING DISPXRB,R5     POINT TO LAST ELEMENT            @D52HDIS 26120051
         ST    R1,DISPXCHF    SET FORWARD POINTER              @D52HDIS 26130051
         DROP  R5             RELEASE LAST ELEMENT             @D52HDIS 26140051
         ST    R1,TIBEXAB     SET NEW BACKWARD POINTER         @D52HDIS 26150051
         SLR   RF,RF          SET RETURN CODE                  @D52HDIS 26160051
         OI    TIBFLAG,TIBDELMV SCHEDULE ...                   @D52HDIS 26170051
         OI    TIBDMFLG,TIBGENEX             ... EXIT          @D52HDIS 26180051
         BR    R7             RETURN TO CALLER                 @D52HDIS 26190051
         EJECT ,                                                        26200051
*--------------------------------------------------------------         26210051
* DISPEXRA - ALLOCATE A NEW DISP EXIT ELEMENT                           26220051
*--------------------------------------------------------------         26230051
         USING DISP,R6                                         @D52HDIS 26240051
DISPEXRA DS    0H                                              @D52HDIS 26250051
         LR    RC,R0             SAVE REGISTER R0              @D52HDIS 26260051
         LA    R0,DISPXLN        GET LENGTH OF REQUEST ELEM.   @D52HDIS 26270051
         L     RA,TCBPTR         GET CURRENT TCB ADDRESS       @D52HDIS 26280051
*        SGETVIS PFIX=YES,ADDRESS=(1),LENGTH=(0),SPID=SPINIT   @D52HDIS 26290051
         SGETVIS PFIX=YES,ADDRESS=(1),LENGTH=(0),SPID=SPINIT   @D52HDIS 26300051
         LR    R0,RC             RESTORE REGISTER R0           @D52HDIS 26310051
         LTR   RF,RF             CHECK RETURN CODE             @D52HDIS 26320051
         BZ    DISPEXR0          ZERO - ALLOCATE AN ELEMENT    @D52HDIS 26330051
         BR    R7                NOT ZERO - RETURN TO CALLER   @D52HDIS 26340051
         DROP  R6                                              @D52HDIS 26350051
         DROP  R8                                              @D52HDIS 26360051
         DROP  R9                                              @D52HDIS 26370051
         EJECT ,                                                        26380051
*--------------------------------------------------------------         26390051
* DISPEXPC - RETURN PROGRAM CHECK EXIT ADDRESS                          26400051
*            OF GENERAL EXIT FOR CURRENT TASK                           26410051
*            (NOT YET SUPPORTED)                                        26420051
*            THIS ROUTINE HAS TO BE CALLED FOR PROGRAM CHECKS           26430051
*            IN RID=REENTRID ROUTINES.                                  26440051
*            INPUT:                                                     26450051
*              R6 - DISPATCHER BASE ADDRESS                             26460051
*              R7 - RETURN REGISTER                                     26470051
*              R9 - DISPEXRT ROUTINE'S BASE ADDRESS                     26480051
*                   ADISPEXR IN DISP BASE                               26490051
*            OUTPUT:                                                    26500051
*              R9 - EXIT ADDRESS, IF AVAILABLE                          26510051
*                       HIGH ORDER BIT IDENTIFIES AMODE OF EXIT         26520051
*                   0 OTHERWISE                                         26530051
*            WORK: R8, RA                                               26540051
*            AMODE: ANY                                                 26550051
*--------------------------------------------------------------         26560051
         USING DISPEXRT,R9                                     @D52HDIS 26570051
*SGLINK  DISPEXPC,S,INPUT=(R6,R7,R9),OUTPUT=(R9),WORK=(R8,RA)           26580051
DISPEXPC DS    0H                                              @D52HDIS 26590051
         L     R8,TIBPTR      GET CURRENT TIB ADDRESS          @D52HDIS 26600051
         USING TIBADR,R8                                       @D52HDIS 26610051
         TM    TIBFLAG4,TIBGEXAC EXIT ACTIVE FOR THIS TASK ?   @D52HDIS 26620051
         BZ    DISPEXP0       NO, RETURN TO CALLER             @D52HDIS 26630051
         DROP  R9                                              @D52HDIS 26640051
         L     RA,TIBEXAF     GET FIRST ELEMENT IN QUEUE       @D52HDIS 26650051
         DROP  R8                                              @D52HDIS 26660051
         USING DISPXRB,RA     POINT TO ACTIVE ELEMENT          @D52HDIS 26670051
         L     R9,DISPXPCK    GET PROGRAM CHECK EXIT ADDRESS   @D52HDIS 26680051
         SLR   R8,R8          RESET ...                        @D52HDIS 26690051
         ST    R8,DISPXPCK    ... PROGRAM CHECK EXIT ADDRESS   @D52HDIS 26700051
         BR    R7             RETURN TO CALLER                 @D52HDIS 26710051
         DROP  RA                                              @D52HDIS 26720051
         SPACE 2                                               @D52HDIS 26730051
*--------------------------------------------------------------         26740051
* DISPEXP0 - RETURN NO EXIT AVAILABLE                                   26750051
*--------------------------------------------------------------         26760051
DISPEXP0 DS    0H                                              @D52HDIS 26770051
         SLR   R9,R9          INDICATE NO EXIT AVAILABLE       @D52HDIS 26780051
         BR    R7             RETURN TO CALLER                 @D52HDIS 26790051
         EJECT ,                                                        26800051
***************************************************************         26810051
*        DISPATCHER EXIT FIELDS                                         26820051
***************************************************************         26830051
*--------------------------------------------------------------         26840051
*          FREE CHAIN HEADER                                            26850051
*--------------------------------------------------------------         26860051
DISPEXF  DC    A(0)           FREE REQUEST BLOCK ELEMENTS      @D52HDIS 26870051
         SPACE 2                                                        26880051
*--------------------------------------------------------------         26890051
*          DEBUG LABELS                                                 26900051
*--------------------------------------------------------------         26910051
DISPEXDB DC    C'GEXS'        DEBUG IDENTIFICATION - START     @D52HDIS 26920051
DISPEXDE DC    C'GEXR'        DEBUG IDENTIFICATION - RETURN    @D52HDIS 26930051
DISPEXDR DC    C'GEXX'        DEBUG IDENTIFICATION - ERROR     @D52HDIS 26940051
         EJECT ,                                                        26950051
***************************************************************         26960051
* DISPICP  - SET/RESET ICCF PSEUDO PARTITION INDICATOR AND              26970051
*            ICCF PSEUDO PARTITION SPECIAL PRIORITY                     26980051
*            CALLED BY MODFLD SERVICE                                   26990051
*            INPUT:                                                     27000051
*              R1 = 0 - RESET ICCFPP INDICATION                         27010051
*                 = 1 - SET ICCFPP INDICATION                           27020051
*              R6 - DISPATCHER BASE ADDRESS                             27030051
*              R7 - RETURN REGISTER                                     27040051
*              R8 - TIB ADDRESS                                         27050051
*              RF - ROUTINE'S BASE ADDRESS                              27060051
*            OUTPUT:                                                    27070051
*                 NONE                                                  27080051
*            WORK: R1, RF                                               27090051
*            AMODE: 24                                                  27100051
***************************************************************         27110051
         USING DISP,R6                                         @D52VDIS 27120051
         USING TIBADR,R8                                       @D52VDIS 27130051
         USING DISPICP,RF                                      @D52VDIS 27140051
*SGLINK  DISPICP,S,INPUT=(R1,R6,R7,R8,RF),WORK=(R1,RF)                  27150051
DISPICP  DS    0H                                              @D52VDIS 27160051
         LTR   R1,R1              ICCFPP INDICATION TO BE SET ?@D52VDIS 27170051
         BZ    DISPICPR           NO, RESET INDICATOR AND PRIO.@D52VDIS 27180051
*--------------------------------------------------------------         27190051
*          - SET ICCFPP FLAG AND TASK TO SPECIAL DISPATCHING            27200051
*--------------------------------------------------------------         27210051
         TM    TIBFLAG2,ICCFPP    INTERACTIVE PARTITION ?      @D61CDIS 27220051
         BOR   R7                 YES, RETURN TO CALLER        @D61CDIS 27230051
         OI    TIBFLAG2,ICCFPP    SET PSEUDO PART. IND.        @D52VDIS 27240051
*        DISPMAC FUNC=DISPICS,INP1=R8                          @D61RDIS 27250051
         DISPMAC FUNC=DISPICS,INP1=R8                          @D61RDIS 27260051
         BR    R7                 RETURN TO CALLER             @D61RDIS 27270051
         EJECT ,                                                        27280051
*--------------------------------------------------------------         27290051
* DISPICPR - RESET ICCFPP FLAG AND TASK TO NORMAL DISPATCHING           27300051
*--------------------------------------------------------------         27310051
DISPICPR DS    0H                                              @D52VDIS 27320051
         NI    TIBFLAG2,XFF-ICCFPP RESET PSEUDO PART. IND.     @D52VDIS 27330051
*        DISPMAC FUNC=DISPICR,INP1=R8                          @D61RDIS 27340051
         DISPMAC FUNC=DISPICR,INP1=R8                          @D61RDIS 27350051
         BR    R7                 RETURN TO CALLER             @D61RDIS 27360051
         DROP  R6                                              @D52VDIS 27370051
         DROP  R8                                              @D52VDIS 27380051
         DROP  RF                                              @D52VDIS 27390051
         TITLE 'VSE/AF SUPERVISOR    DISP ACCOUNTING ROUTINE'           27400051
*--------------------------------------------------------------         27410051
* ACCTTIME - ACCOUNT CPU TIME                                           27420051
*--------------------------------------------------------------         27430051
         USING PCBADR,R5                                       @D64ADIS 27440051
         USING TIBADR,R8                                       @D64ADIS 27450051
         USING PIB2ADR,RC                                      @D64ADIS 27460051
         USING ACCTTIME,RD                                     @D64ADIS 27470051
ACCTTIME SGSETUP UPDTIME,WR1=R3,WR2=R5,WR3=RF,                         *27480051
               EXIT=(R9),OPTION=SERVER                         @D51IDIS 27490051
         DROP  RC                                              @D61NDIS 27500051
         DROP  RD                                              @D64ADIS 27510051
         DROP  R5                                              @D14BDFR 27520051
         DROP  R8                                              @D36IDFR 27530051
         TITLE 'VSE/AF SUPERVISOR    DISP       VALIDATION SUBROUTINES' 27540051
         DS    0F                                              @D61NDIS 27550051
         DC    CL8'DISPVALW'                                   @D61NDIS 27560051
*--------------------------------------------------------------         27570051
* DISPVALW - WRITE VALIDATION ROUTINE                                   27580051
*            VALIDATION OF AREA THAT MAY BE LOCATED                     27590051
*            IN THE PARTITION OR LTA OR IN SVA FOR                      27600051
*            PRIVILEGED ROUTINES                                        27610051
*            INPUT REGISTER:                                            27620051
*              R1 - LOW ADDRESS OF AREA TO BE VALIDATED                 27630051
*              R2 - HIGH ADDRESS OF AREA                                27640051
*              R5 - PCB ADDRESS                                         27650051
*              R6 - BASE REGISTER                                       27660051
*              R8 - RETURN ADDRESS                                      27670051
*              RD - BASE ADDRESS                                        27680051
*            OUTPUT REGISTER:                                           27690051
*              R5 - STORAGE KEY                                         27700051
*            WORK REGISTER: R2, R8                                      27710051
*            AMODE: 31                                                  27720051
*--------------------------------------------------------------         27730051
         USING DISP,R6                                         @D61NDIS 27740051
         USING DISPVALW,RD                                     @D61NDIS 27750051
*SGLINK  DISPVALW,S,INPUT=(R1,R2,R5,R6,R8,RD),WORK=(R2,R8),OUTPUT=(R5)  27760051
DISPVALW DS    0H                                              @D61NDIS 27770051
         USING PCBADR,R5                                       @D61NDIS 27780051
         C     R2,PCBAPEND        GOTO COMPARE KEYS WHEN       @D52VDIS 27790051
         BNL   VALIDA1               ADDRESS RANGE IS          @D14BDFR 27800051
         C     R1,PCBAPBEG           OUTSIDE APPROPRIATE       @D14BDFR 27810051
         BL    VALIDA1               PARTITION BOUNDARIES      @D14BDFR 27820051
         L     R5,TIBPTR          LOAD TIB POINTER             @D36IDFR 27830051
         USING TIBADR,R5          ASSUMES TIBPOINTER IN R5     @D36IDFR 27840051
         LH    R5,TIBRTID         LOAD TIB POINTER             @D36IDFR 27850051
         SLL   R5,2               ... OF                       @D66ODOW 27860056
         AL    R5,ATIBATAB        ... SERVICED                 @D66ODOW 27870056
         L     R5,0(,R5)          ... TASK                     @D66ODOW 27880056
         TM    TIBFLAG2,ICCFPP    INTERACTIVE PARTITION ?      @D14BDRP 27890051
         BO    VALIDICF           YES, BRANCH                  @D14BDRP 27900051
         DROP  R5                                              @D14BDFR 27910051
         EJECT ,                                               @D64ADIS 27920051
*--------------------------------------------------------------         27930051
*          - RETURN STORAGE KEY OF LAST PAGE                            27940051
*--------------------------------------------------------------         27950051
         N     R2,PADDRMSK        RESET TO PAGE BEGIN ADDRESS  @D64ADIS 27960051
         LTR   R5,R2              LOAD & TEST PAGE ZERO(VM:V=R)@D64ADIS 27970051
         BZ    8(,R8)             YES, RETURN TO CALLER        @D64ADIS 27980051
*        SGSETUP LRA,OPTION=STRK,WR1=R5,EXIT=(R8)                       27990051
         SGSETUP LRA,OPTION=STRK,WR1=R5,EXIT=(R8)              @D64ADIS 28000051
         B     8(,R8)             RETURN TO CALLER             @D14BDFR 28010051
         EJECT ,                                               @D61NDIS 28020051
*--------------------------------------------------------------         28030051
* VALIDA1  - VALIDATION OF AREAS OUTSIDE                                28040051
*            PARTITION BOUNDARIES                                       28050051
*--------------------------------------------------------------         28060051
VALIDA1  DS    0H                                              @D52VDIS 28070051
         L     R5,TIBPTR          LOAD TIB POINTER             @D52VDIS 28080051
         USING TIBADR,R5          ASSUMES TIBPOINTER IN R5     @D36IDFR 28090051
         LH    R5,TIBRTID         LOAD TIB POINTER             @D36IDFR 28100051
         SLL   R5,2               ... OF                       @D66ODOW 28110056
         AL    R5,ATIBATAB        ... SERVICED                 @D66ODOW 28120056
         L     R5,0(,R5)          ... TASK                     @D66ODOW 28130056
         TM    TIBFLAG1,PRIVILEG  REQ.FROM PRIVILEGED ROUTINE? @D36IDFR 28140051
         BZ    VALIDSP            NO, CHECK FOR SUBSYSTEM      @D51GDIS 28150051
         DROP  R5                                              @D52GDIS 28160051
*--------------------------------------------------------------         28170051
* VALIDA2  - ENTRY POINT FOR PRIVILEGED VALIDATION                      28180051
*--------------------------------------------------------------         28190051
VALIDA2  N     R2,PADDRMSK        RESET TO PAGE BEGIN ADDRESS  @D14BDFR 28200051
         SPACE 1                                               @D149DIS 28210051
         LTR   R5,R2              LOAD & TEST PAGE ZERO(VM:V=R)@DA35843 28220051
         BZ    8(,R8)             YES, RETURN TO CALLER        @DA35843 28230051
         EJECT ,                                                        28240051
*--------------------------------------------------------------         28250051
*            VALIDATE PAGE                                              28260051
*--------------------------------------------------------------         28270051
*        SGSETUP LRA,OPTION=STRK,WR1=R5,EXIT=(R8)                       28280051
         SGSETUP LRA,OPTION=STRK,WR1=R5,EXIT=(R8)              @D14BDFR 28290051
         STC   R5,VALIDKEY+1      OVERWRITE PASSED KEY         @D14BDFR 28300051
         B     VALIDA6            GOTO CHECK FOR CORRECT STRING@D14BDFR 28310051
VALIDA3  LH    R5,VALIDKEY        GET KEY FOR VALIDATION       @D14BDFR 28320051
         SPACE 1                                               @D14BDFR 28330051
VALIDA4  LTR   R5,R5              IS IT A NONZERO KEY          @D14BDFR 28340051
         BZ    VALIDA2            NO, RETURN TO MAIN PATH      @D14BDFR 28350051
         N     R2,PADDRMSK        RESET TO PAGE BEGIN ADDRESS  @D14BDFR 28360051
         EJECT ,                                                        28370051
*--------------------------------------------------------------         28380051
* VALIDA5  - VALIDATE PAGE                                              28390051
*--------------------------------------------------------------         28400051
VALIDA5  DS    0H                                              @D14BDFR 28410051
         LTR   R2,R2              PAGE ZERO (VM:V=R)           @DA35843 28420051
         BNZ   VALIDA5A           NO                           @DA35843 28430051
         CH    R2,VALIDKEY        KEY ZERO REQUESTER           @DA35843 28440051
         BE    8(,R8)             YES, RETURN                  @DA35843 28450051
         B     4(,R8)             NO,  INVALID KEY             @DA35843 28460051
         SPACE 2                                                        28470051
VALIDA5A LR    R5,R2              POINT TO                     @DA35843 28480051
*        SGSETUP LRA,OPTION=STRK,WR1=R5,EXIT=(R8)                       28490051
         SGSETUP LRA,OPTION=STRK,WR1=R5,EXIT=(R8)              @D14BDFR 28500051
         CH    R5,VALIDKEY        MATCHING KEY                 @D14BDRP 28510051
         BNE   4(,R8)             NO,ERROR,CANCEL USER         @D14BDFR 28520051
VALIDA6  CR    R2,R1              ALL PAGES PROCESSED          @D14BDFR 28530051
         BNH   8(,R8)             YES,RETURN TO CALLER         @D14BDFR 28540051
         S     R2,PAGESIZE        SUBTRACT PAGE SIZE           @D14BDFR 28550051
         B     VALIDA5            GOTO VALIDATE NEXT ONE       @D14BDFR 28560051
         EJECT ,                                                        28570051
*--------------------------------------------------------------         28580051
* VALIDICF - CHECK FOR ICCF AND GET PROTECTION KEY IF INTERACT. PART.   28590051
*--------------------------------------------------------------         28600051
VALIDICF DS    0H                                              @D52VDIS 28610051
         USING TIBADR,R5          ASSUMES TIB POINTER IN R5    @D52VDIS 28620051
         L     R5,TIBTCB          GET CURRENT TASK CONTR. BL.  @D52VDIS 28630051
         USING TCBADR,R5                                       @D14BDRP 28640051
         L     R5,TCBSAVE         GET TASK'S SAVE AREA ADDR.   @D14BDRP 28650051
         USING SVEARA,R5                                       @D14BDRP 28660051
         TM    SVEPSWKY,KEY0      CAME REQUEST FROM ICCF  ?    @D14BDRF 28670051
         BZ    VALIDA2            YES, SKIP VALIDATION         @D14BDRP 28680051
         MVC   VALIDKEY+1(L1),SVPPKEY  GET INTERACT.PART. KEY  @D14BDFR 28690051
         LH    R5,VALIDKEY                                     @D14BDFR 28700051
         B     VALIDA4                                         @D14BDFR 28710051
         DROP  R5                                              @D14BDFR 28720051
         EJECT ,                                                        28730051
*--------------------------------------------------------------         28740051
* VALIDSP  - ALLOW AUTHORIZED SUBSYSTEMS TO USE SVA AREAS               28750051
*            INPUT:                                                     28760051
*              R1 - LOW ADDRESS                                         28770051
*              R2 - HIGH ADDRESS                                        28780051
*              R5 - SERVICE OWNER TIB ADDRESS                           28790051
*              R6 - DISPATCHER BASE ADDRESS                             28800051
*--------------------------------------------------------------         28810051
VALIDSP  DS    0H                                              @D51GDIS 28820051
         USING TIBADR,R5                                       @D51MDIS 28830051
         L     R5,TIBTCB          GET SERVICE OWNER TCB ADDRESS@D51MDIS 28840051
         USING TCBADR,R5                                       @D51MDIS 28850051
         TM    TCBFLAG3,VSPT+TCBVEND PERFORMANCE TOOL OR VENDOR PROGRAM*28860061
                                  ACTIVE?                      @DY45586 28861061
         BNZ   VALIDSP1           YES, DO PRIVILEGED VALIDATION@DY45586 28870061
         TM    VTAMFLG,VTAMK0     VTAM CODE ACTIVE ?           @D61PDIS 28880051
         BO    VALIDSP1           YES, DO PRIVILEGED VALIDATION@D61PDIS 28890051
         L     R5,VALIDPCB        GET SAVED PCB ADDRESS        @D52VDIS 28900051
         USING PCBADR,R5                                       @D51GDIS 28910051
         TM    PCBSSFLG,VTAM+PWR+CICS+OCCF SUBSYSTEM PARTITION?@D61CDIS 28920051
         BNZ   VALIDSP1           YES, DO PRIVILEGED VALIDATION@D51SDIS 28930051
         DROP  R5                                              @D51GDIS 28940051
         TM    SYSFLAG2,IPLBIT    IPL IN PROGRESS ?            @D51SDIS 28950051
         BZ    VALIDA3            NO, GOTO USE PASSED KEY      @D51SDIS 28960051
VALIDSP1 DS    0H                                              @D51MDIS 28970051
         L     R5,IJBSMCOM        GET STORAGE MGMT CONTROL INFO@D51GDIS 28980051
         USING SMCOM,R5                                        @D51GDIS 28990051
         C     R1,SMCSVA          LOW ADDRESS IN SVA           @D51GDIS 29000051
         BL    VALIDSP2           NO,VALIDATE NON-SVA ADDRESS  @DY40100 29010051
         CL    R2,SMCESVA         HIGH ADDR IN SVA             @D51GDIS 29020051
         BNH   VALIDA2            YES, CONTINUE WITH           @D51GDIS 29030051
*                                 ... PRIVILEGED VALIDATION    @D51GDIS 29040051
         C     R1,SMCSVA31        LOW ADDRESS IN PRIV. SPACE ? @D52VDIS 29050051
         BL    VALIDSP2           YES, VALIDATE DYN.SPACE GETV.@D52VDIS 29060051
         CL    R2,SMCESV31        HIGH ADDRESS IN SVA (31 BIT)?@D52VDIS 29070051
         BNH   VALIDA2            YES, CONTINUE WITH           @D52VDIS 29080051
*                                 ... PRIVILEGED VALIDATION    @D52VDIS 29090051
         DROP  R5                                              @D51GDIS 29100051
VALIDSP2 DS    0H                                              @DY40100 29110051
         L     R5,SCBPTR          GET CURRENT SCB ADDRESS      @DY40100 29120051
         USING SCBADR,R5                                       @DY40100 29130051
         CLI   SCBID+1,X'40'      DYNAMIC SPACE GETVIS AVAIL.? @DY40100 29140051
         BE    VALIDA3            NO,VALIDATE NON-DYN.SP.GETVIS@DY40100 29150051
         C     R1,SCBSPGVB        LOW ADDRESS IN DYN.SP.GETVIS @DY40100 29160051
         BL    VALIDA3            NO,VALIDATE NON-DYN.SP.GETVIS@DY40100 29170051
         CL    R2,SCBSPGVE        HIGH ADDR IN DYN.SPACE GETVIS@DY40100 29180051
         BNH   VALIDA2            YES, CONTINUE WITH           @DY40100 29190051
*                                 ... PRIVILEGED VALIDATION    @DY40100 29200051
         DROP  R5                                              @DY40100 29210051
         B     VALIDA3            VALIDATE NON-SVA ADDRESS     @D51GDIS 29220051
         DROP  R6                                              @D61NDIS 29230051
         DROP  RD                                              @D61NDIS 29240051
         EJECT ,                                               @D14BDFR 29250051
         DS    0F                                              @D61NDIS 29260051
         DC    CL8'DISPVALR'                                   @D61NDIS 29270051
*--------------------------------------------------------------         29280051
* DISPVALR - VALIDATION FOR READ ACCESS                                 29290051
*            INPUT REGISTER:                                            29300051
*              R1 - LOW ADDRESS OF AREA TO BE VALIDATED                 29310051
*              R2 - HIGH ADDRESS OF AREA                                29320051
*              R3 - = 0     - OLD VALIDATION                            29330051
*              R3 - = X'80' - NEW VALIDATION                            29340051
*              R5 - STORAGE KEY (OLD VALIDATION ONLY)                   29350051
*              R6 - BASE REGISTER                                       29360051
*              R8 - RETURN ADDRESS                                      29370051
*              RD - BASE ADDRESS                                        29380051
*            OUTPUT REGISTER:                                           29390051
*              R5 - ISKMASK,  IF R5(INPUT) = 0 OR                       29400051
*                                R5(INPUT) NOT = KEY OF PAGE FRAME      29410051
*              R5 - ISKFMASK, IF R5(INPUT) NOT = 0 AND                  29420051
*                                R5(INPUT) NOT = PAGE FRAME KEY         29430051
*            WORK REGISTER: R2, R3, R4                                  29440051
*            AMODE: 31                                                  29450051
*--------------------------------------------------------------         29460051
         USING DISP,R6                                         @D61NDIS 29470051
         USING DISPVALR,RD                                     @D61NDIS 29480051
*SGLINK  DISPVALR,S,INPUT=(R1,R2,R3,R5,R6,R8,RD),                      X29490051
               WORK=(R2,R3,R4),OUTPUT=(R5)                              29500051
DISPVALR DS    0H                                              @D61NDIS 29510051
         STC   R3,DISPVRIN        SAVE VALIDATION TYPE         @D64ADIS 29520051
         EJECT ,                                               @D64ADIS 29530051
*--------------------------------------------------------------         29540051
*        VALIDATE LAST PAGE                                             29550051
*--------------------------------------------------------------         29560051
*        SGSETUP LRA,OPTION=STRKF,WR1=R4,EXIT=(R8)                      29570051
         SGSETUP LRA,OPTION=STRKF,WR1=R4,EXIT=(R8)             @D14BDFR 29580051
         EJECT ,                                               @D61NDIS 29590051
*--------------------------------------------------------------         29600051
*        SAME STORAGE KEY ?                                             29610051
*--------------------------------------------------------------         29620051
         TM    DISPVRIN,X'80'     NEW VALIDATION ?             @D64ADIS 29630051
         BO    VALREAD4           NO, PROCESS OLD VALIDATION   @D64ADIS 29640051
         CR    R4,R5              MATCHING KEYS ?              @D14BDFR 29650051
         BNE   VALREAD3           NO, CHECK FETCH PROTECTION   @D14BDFR 29660051
VALREAD1 L     R5,ISKMASK         INDICATE AREA ACCESSIBLE     @D14BDFR 29670051
VALREAD2 CR    R2,R1              ALL PAGES PROCESSED          @D14BDFR 29680051
         BNH   8(,R8)             YES,RETURN TO CALLER         @D14BDFR 29690051
         S     R2,PAGESIZE        SUBTRACT PAGE SIZE           @D14BDFR 29700051
         LTR   R3,R2              PAGE ZERO (VM:V=R)           @DA35843 29710051
         BZ    8(,R8)             YES, RETURN                  @DA35843 29720051
         EJECT ,                                               @D14BDFR 29730051
*--------------------------------------------------------------         29740051
*        VALIDATE PAGE                                                  29750051
*--------------------------------------------------------------         29760051
*        SGSETUP LRA,OPTION=STRKF,WR1=R3,EXIT=(R8)                      29770051
         SGSETUP LRA,OPTION=STRKF,WR1=R3,EXIT=(R8)             @D14BDFR 29780051
*--------------------------------------------------------------         29790051
         NR    R3,R5              CLEAR 3 OR 4 LOW ORDER BITS  @D14BDFR 29800051
         CR    R3,R4              MATCHING KEY                 @D14BDRP 29810051
         BNE   4(,R8)             NO,ERROR,CANCEL USER         @D14BDFR 29820051
         B     VALREAD2           GOTO VALIDATE NEXT ONE       @D14BDFR 29830051
         EJECT ,                                               @D64ADIS 29840051
*--------------------------------------------------------------         29850051
* VALREAD3 - CHECK, IF FETCH PROTECTED AREA                             29860051
*--------------------------------------------------------------         29870051
VALREAD3 LR    R3,R4              SAVE ISKE VALUE              @D14BDFR 29880051
         N     R4,ISKMASK         RESET FCH.PROT.BIT           @D14BDFR 29890051
         CR    R4,R5              MATCHING KEYS ?              @D14BDFR 29900051
         BE    VALREAD1           YES, CONTINUE WITH VALIDATION@D14BDFR 29910051
         LTR   R5,R5              INPUT STORAGE KEY = 0 ?      @D14BDFR 29920051
         BZ    VALREAD1           YES, CONTINUE WITH VALIDATION@D14BDFR 29930051
         L     R5,ISKFMASK        INDICATE KEYS DO NOT MATCH   @D14BDFR 29940051
         CR    R4,R3              FETCH PROTECTED ?            @D14BDFR 29950051
         BE    VALREAD2           NO, CONTINUE WITH VALIDATION @D14BDFR 29960051
         B     4(,R8)             PROTECTION VIOLATION         @D14BDFR 29970051
         EJECT ,                                               @D64ADIS 29980051
*--------------------------------------------------------------         29990051
* VALREAD4 - NEW VALIDATION, CONSIDER PROGAM KEY MASK                   30000051
*            OF CURRENT ACTIVE TASK                                     30010051
*--------------------------------------------------------------         30020051
VALREAD4 DS    0H                                              @D64ADIS 30030051
         ST    R4,DISPVRIS        SAVE STORE.KEY INFORMATION   @D64ADIS 30040051
         N     R4,ISKMASK         RESET FETCH PROTECTION       @D64ADIS 30050051
         LR    R3,R4              SAVE STORAGE KEY             @D64ADIS 30060051
         SRL   R3,4               MOVE KEY TO LAST HALF BYTE   @D64ADIS 30070051
         ST    R7,DISPVRSV        SAVE REGISTER                @D64ADIS 30080051
         L     R7,BIT0OMSK        GET KEY 0 INDICATION         @D64ADIS 30090051
         SRL   R7,0(R3)           GET PSW-KEY-MASK OF STORE.KEY@D64ADIS 30100051
         L     R3,TCBPTR          GET TCB ADDRESS              @D64ADIS 30110051
         USING TCBADR,R3                                       @D64ADIS 30120051
         L     R3,TCBATCBE        GET TCB EXTENSION ADDRESS    @D64ADIS 30130051
         USING TCBXADR,R3                                      @D64ADIS 30140051
         N     R7,TCBX1CR3        MACHING KEYS ?               @D64ADIS 30150051
         L     R7,DISPVRSV        RESTORE REGISTER             @D64ADIS 30160051
         BNZ   VALREAD1           YES, VALIDATE REMAINING AREA @D64ADIS 30170051
         TM    TCBX1CR3,X'80'     AUTHORIZED FOR KEY 0 ?       @D64ADIS 30180051
         BO    VALREAD1           YES, VALIDATE REMAINING AREA @D64ADIS 30190051
         L     R5,ISKFMASK        INDICATE KEYS DO NOT MATCH   @D64ADIS 30200051
         TM    DISPVRIS+3,FCHPBIT FETCH PROTECTED AREA ?       @D64ADIS 30210051
         BZ    VALREAD2           NO, CONTINUE WITH VALIDATION @D64ADIS 30220051
         B     4(,R8)             PROTECTION VIOLATION         @D64ADIS 30230051
         DROP  R3                                              @D64ADIS 30240051
         DROP  R6                                              @D61NDIS 30250051
         DROP  RD                                              @D61NDIS 30260051
         SPACE 2                                               @D64ADIS 30270051
         DS    0F                                              @D64ADIS 30280051
DISPVRSV DC    F'0'               SAVED REGISTER               @D64ADIS 30290051
DISPVRIS DC    F'0'               SAVED STORE.KEY INFORMATION  @D64ADIS 30300051
DISPVRIN DC    X'00'              SAVED REQUEST TYPE           @D64ADIS 30310051
         TITLE 'VSE/AF SUPERVISOR    DISP      CANCEL REQUEST SERVICES' 30320051
         DS    0F                                              @D61NDIS 30330051
         DC    CL8'DISPCNCL'                                   @D61NDIS 30340051
*--------------------------------------------------------------         30350051
* DISPCNCL - PROPAGATE TASK TERMINATION FOR ONE SPECIFIC TASK           30360051
*            (ENTRY POINT DISPCNCY) OR ALL TASKS OF A PARTITION.        30370051
*                                                                       30380051
*          - SOFT CANCEL:                                               30390051
*             FUNCTION IS PERFORMED WHEN A TASK IS                      30400051
*             TERMINATOR OWNER OR IT IS NOT TERMINATING YET.            30410051
*             A CANCEL CODE IS SET INTO THE TIB (TIBCNCL BYTE).         30420051
*          - HARD CANCEL:                                               30430051
*             WITH NO REGARD TO TASKS STATUS A CANCEL CODE IS           30440051
*             IS SET INTO THE TIB (TIBCNCL/TIBCNCL2 BYTE).              30450051
*                                                                       30460051
*          - WHEN NECESSARY, THE DISPATCHER CANCEL EXIT IS              30470051
*            ACTIVATED (FETCHEOJ BIT IN TIBFLAG) AND                    30480051
*            THE TASK IS MADE READY (CALLING SETREADY ROUTINE)          30490051
*                                                                       30500051
*          CANCEL CODES :                                               30510051
*             X'1D' : CANCEL DUE TO MAINTASK TERMINATION                30520051
*             X'NN' : CANCEL CODE PARAMETER PASSED VIA R1               30530051
*                                                                       30540051
*          INPUT: R1 = CANCEL CODE                                      30550051
*                 R5 = -1                        (DISPCNCY ONLY)        30560051
*                 R6 = DISPATCHERS BASE ADDRESS                         30570051
*                 R8 = TIB ADDRESS               (DISPCNCY ONLY)        30580051
*                 R9 = PCB ADDRESS                                      30590051
*                 RD = ROUTINE'S BASE ADDRESS                           30600051
*          WORK:  R5, R7, R8, RE, RF                                    30610051
*          EXIT:  RDYCNRET                                              30620051
*                                                                       30630051
*            AMODE: ANY                                                 30640051
*--------------------------------------------------------------         30650051
         USING DISP,R6                                         @D61NDIS 30660051
         USING PCBADR,R9                                       @D36IDFR 30670051
         USING DISPCNCL,RD                                     @D61NDIS 30680051
*SGLINK DISPCNCL,S,INPUT=(R1,R6,R9,RD),WORK=(R5,R7,R8,RE,RF)            30690051
DISPCNCL LTR   R5,R5              DETERMINE NEXT TASK TO BE    @D66ODOW 30700056
***                                  PROCESSED                          30710051
         BCTR  R5,0               DECREASE # OF SUBTASKS       @D36IDFR 30720051
         BM    RDYCNRET           RETURN IF LAST TASK PROCESSED@D36IDFR 30730051
*        DISPMAC FUNC=TIB,SFUNC=NEXTHIGH,INP2=R9,ERREXIT=DISPCNHW       30740054
         DISPMAC FUNC=TIB,SFUNC=NEXTHIGH,INP2=R9,ERREXIT=DISPCNHW      X30750057
                                                               @D66ODOW 30750157
         EJECT ,                                               @D64ADIS 30760051
*--------------------------------------------------------------         30770051
*          - PROCESS VSE CANCEL, IF REQUESTED                           30780051
*--------------------------------------------------------------         30790051
         USING TIBADR,R8                                       @D64ADIS 30800051
         TM    VCNCFLAG,X'80'     VSE CANCEL REQUEST ?         @D64ADIS 30810051
         BZ    DISPCNCY           NO, SKIP                     @D64ADIS 30820051
         CLC   TIBRTID(2),IJBHMTID    IS THIS A MAINTASK       @D64ADIS 30830051
         BNHR  RD                 NO,DO NOT CANCEL             @D64ADIS 30840051
         SR    R7,R7             CLEAR FOR ADDRESSING MODE     @D64ADIS 30850051
         LA    RE,DISPCNCX       GET CONTINUATION ADDRESS      @D64ADIS 30860051
         O     RE,BIT0OMSK       CONTINUE IN ...               @D64ADIS 30870051
         BSM   R7,RE                     ... 31 BIT MODE       @D64ADIS 30880051
DISPCNCX DS    0H                                              @D64ADIS 30890051
         L     RE,TIBTCB          GET TCB ADDRESS              @D64ADIS 30900051
         USING TCBADR,RE                                       @D64ADIS 30910051
         L     RE,TCBATCBE        GET ADDR. OF TCB EXTENSION   @D64ADIS 30920051
         USING TCBXADR,RE                                      @D64ADIS 30930051
         TM    TCBXFLG2,TCBXATTX ATTACHED BY ATTACHX ?         @D64ADIS 30940051
         BZ    DISPCNCW          NO, CANCEL TASK               @D64ADIS 30950051
         LA    RE,DISPCNCV       GET CONTINUATION ADDRESS      @D64ADIS 30960051
         OR    RE,R7             CONTINUE IN ...               @D64ADIS 30970051
         BSM   0,RE                      ... CALLER'S MODE     @D64ADIS 30980051
DISPCNCV DS    0H                                              @D64ADIS 30990051
         BR    RD                DO NOT CANCEL                 @D64ADIS 31000051
         DROP  RE                                              @D64ADIS 31010051
         SPACE 2                                               @D64ADIS 31020051
DISPCNCW DS    0H                                              @D64ADIS 31030051
         LA    RE,DISPCNCY       GET CONTINUATION ADDRESS      @D64ADIS 31040051
         OR    RE,R7             CONTINUE IN ...               @D64ADIS 31050051
         BSM   0,RE                      ... CALLER'S MODE     @D64ADIS 31060051
         SPACE 2                                               @D64ADIS 31061054
DISPCNHW DS    0H                                              @D66ODOW 31062056
         BAS   R5,SYSERROR        ERROR IN CONTROL BLOCK STRUCT@D66ODOW 31063056
         DC    C'INCONSISTENT CONTROL BLOCK STRUCTURE'         @D66ODOW 31064056
         EJECT ,                                               @D149DIS 31070051
*--------------------------------------------------------------         31080051
* DISPCNCY - PROCESS CANCEL REQUEST FOR GIVEN TASK                      31090051
*            CALLED BY SGTINF (TREADY COND=CANCEL)                      31100051
*--------------------------------------------------------------         31110051
*SGLINK DISPCNCY,S,INPUT=(R1,R5,R6,R8,R9,RD),WORK=(R5,R7,R8,RE,RF)      31120051
DISPCNCY DS    0H                                              @D61NDIS 31130051
         LA    RE,TIBCNCL         POINT TO TASKS CANCEL CODE   @D52HDIS 31140051
         C     R9,PCBPTR          CURR.PART.TO BE TERMINATED?  @D36IDFR 31150051
         BE    RDYCNCLS           YES, PROCESS SOFT CANCEL     @D52HDIS 31160051
*--------------------------------------------------------------         31170051
*          - CANCELLED BY AR OR OTHER PARTITION (E.G. VSE/POWER)        31180051
*          - CHECK FOR HARD CANCEL REQUEST                              31190051
*            VSE/POWER PFLUSH HAS TO BE HANDELED LIKE AR CANCEL         31200051
*--------------------------------------------------------------         31210051
RDYCNC0Y DS    0H                                              @D52HDIS 31220051
         CLC   TID,ARTIDH         IF REQUEST IS NOT FROM AR    @D66ODOW 31230056
         BNE   RDYCNCLB              GOTO CANCEL TASK          @D52HDIS 31240051
         L     RF,AARBUFAR        POINT TO ATTENTION BUFFER    @D36IDFR 31250051
         USING ARBUFFER,RF                                     @D36IDFR 31260051
         TM    ARCMDFLG,ARCMDCAN  IF IT IS REQUEST CANCEL      @D61CDIS 31270051
         BO    RDYCNCLH              GOTO CANCEL TASK          @D14BDFR 31280051
         DROP  RF                                              @D36IDFR 31290051
RDYCNCLB DS    0H                                              @D52HDIS 31300051
         TM    TIBCNCL,XFF        TASK ALLREADY TERMINATING?   @D52HDIS 31310051
         BZ    RDYCNTR0           NO, GOTO INITIALIZE CANCEL   @D52HDIS 31320051
         LA    R7,RDYCNCLH        CONTINUATION, IF NOT TERMACT @D52HDIS 31330051
         BNO   RDYCNTRM           YES,BUT NOT IN ITS AB ROUTINE@D52HDIS 31340051
         TM    PCBSSFLG,PWR+ICCF+CICS+VTAM IS IT ANY SUBSYSTEM @D36IDFR 31350051
         BZ    RDYCNTR0           NO, CANCEL TASK              @D52HDIS 31360051
         LR    R7,RD              SKIP CANCEL, IF NOT TERMACT  @D61NDIS 31370051
         CLC   TID,ARTIDH         IF REQUEST IS FROM AR        @D66ODOW 31380056
         BE    RDYCNTRM              DO NOT CANCEL             @D52HDIS 31390051
*--------------------------------------------------------------         31400051
* RDYCNTR0 - CANCEL, IF PFLUSH - EVEN IF SUBSYSTEM AB EXIT ACTIVE       31410051
*--------------------------------------------------------------         31420051
RDYCNTR0 DS    0H                                              @D52HDIS 31430051
         LA    R7,RDYCNCLR        CONTINUATION, IF NOT TERMACT @D52HDIS 31440051
         EJECT ,                                               @D52HDIS 31450051
*--------------------------------------------------------------         31460051
* RDYCNTRM - DELAY CANCEL REQUEST, WHEN DUMP ROUTINE ACTIVE             31470051
*--------------------------------------------------------------         31480051
RDYCNTRM DS    0H                                              @D52HDIS 31490051
         TM    TIBFLAG1,TERMACT   TERM.OWNED BY THIS TASK?     @D36IDFR 31500051
         BZR   R7                 NO, PROCESS DEFINED ACTION   @D52HDIS 31510051
         OI    TIBFLAG4,TIBDMPCN  REQUEST DUMP TO TERMINATE    @D52VDIS 31520051
         TM    TIBTFLAG,XFF       SDUMP/PDUMP/TRACE CANCELLED ?@D61HDIS 31530051
         BNZ   RDYCNTR1           YES, SET CANCEL CODE         @D61HDIS 31540051
         STC   R1,TIBCNCL3        STORE PASSED TERM.CODE       @D14BDFR 31550051
RDYCNTRP DS    0H                                              @D52HDIS 31560051
         LR    RF,RD              LOAD IOPOST1 RETURN ADDRESS  @D61NDIS 31570051
         B     IOPOST1            POST DUMP ROUTINE            @D52HDIS 31580051
*SGLINK  IOPOST1,INPUT=(R6,R8,RF),WORK=(RE)                             31590051
         BR    RD                                              @D61NDIS 31600051
         SPACE 2                                               @D52HDIS 31610051
*--------------------------------------------------------------         31620051
* RDYCNTR1 - SET CANCEL CODE FOR IDUMP, PDUMP, SDUMP, TRACE REQUESTS    31630051
*--------------------------------------------------------------         31640051
RDYCNTR1 DS    0H                                              @D52HDIS 31650051
         MVI   0(RE),CANCX1D      CANCEL DUE TO MAINT.TERM.    @D52HDIS 31660051
         CLC   TIBRTID(2),IJBHMTID    IS THIS A MAINTASK       @D52HDIS 31670051
         BH    RDYCNTR2           NO,CANCEL CODE IS OK         @D52HDIS 31680075
         STC   R1,0(0,RE)         STORE PASSED TERM.CODE       @D52HDIS 31690051
RDYCNTR2 DS    0H                                              @D67BDOW 31691075
         LA    RF,TIBCNCL                                      @D67BDOW 31692075
         CR    RF,RE              UPDATE OF FIRST CANCEL CODE  @D67BDOW 31693075
         BNE   RDYCNTRP           NO,                          @D67BDOW 31694075
         L     RF,TIBTCB                                       @D67BDOW 31695075
         NI    TCBRFLAG-TCBADR(RF),XFF-TCBRCVAL NO REASON CODE @D67BDOW 31697075
         B     RDYCNTRP                                        @D52HDIS 31700051
         SPACE 2                                               @D52HDIS 31710051
*--------------------------------------------------------------         31720051
* RDYCNCLS - PROCESS SOFT CANCEL REQUEST                                31730051
*--------------------------------------------------------------         31740051
RDYCNCLS DS    0H                                              @D61NDIS 31750051
         LA    R7,RDYCNCLC        CONTINUATION, IF NOT TERMACT @D52HDIS 31760051
         TM    TIBCNCL,XFF        TASK ALLREADY TERMINATING?   @D36IDFR 31770051
         BZ    RDYCNTRM           NO, GOTO CANCEL TASK         @D36IDFR 31780051
         BR    RD                 OTHERWISE DO NOT CANCEL      @D61NDIS 31790051
         EJECT ,                                               @D52VDIS 31800051
*--------------------------------------------------------------         31810051
* RDYCNCLH - SET CANCEL CODE                                            31820051
*--------------------------------------------------------------         31830051
RDYCNCLH DS    0H                                              @D52HDIS 31840051
         TM    TIBCNCL,XFF        TASK ALLREADY TERMINATING?   @D52HDIS 31850051
         BNM   RDYCNCLR           NO, GOTO INITIALIZE CANCEL   @D52HDIS 31860051
         LA    RE,TIBCNCL2        PROCESS CANCEL IN CANCEL     @D52HDIS 31870051
RDYCNCLR MVI   0(RE),CANCX1D      CANCEL DUE TO MAINT.TERM.    @D36IDFR 31880051
         CLC   TIBRTID(2),IJBHMTID    IS THIS A MAINTASK       @D52HDIS 31890051
         BH    RDYCNCLX           NO,CANCEL CODE IS OK         @D36IDFR 31900051
RDYCNCLC STC   R1,0(0,RE)         STORE PASSED TERM.CODE       @D36IDFR 31910051
RDYCNCLX OI    TIBFLAG,FETCHEOJ   SET CANCEL IN PROGRESS       @D36IDFR 31920051
         LA    RF,TIBCNCL                                      @D67BDOW 31921075
         CR    RF,RE              UPDATE OF FIRST CANCEL CODE  @D67BDOW 31922075
         BNE   RDYCNCLZ           NO,                          @D67BDOW 31923075
         L     RF,TIBTCB                                       @D67BDOW 31924075
         NI    TCBRFLAG-TCBADR(RF),XFF-TCBRCVAL NO REASON CODE @D67BDOW 31925075
RDYCNCLZ DS    0H                                              @D67BDOW 31926075
         LR    RF,RD              SETUP EXIT ADDRESS           @D61NDIS 31930051
         B     SETREADY           TRY TO READY TASK            @D61NDIS 31940051
*SGLINK  SETREADY,INPUT=(R6,R8,RF),WORK=(RE)                   @D149DIS 31950051
         DROP  R6                                              @D61NDIS 31960051
         DROP  R8                                              @D36IDFR 31970051
         DROP  R9                                              @D36IDFR 31980051
         DROP  RD                                              @D61NDIS 31990051
         TITLE 'VSE/AF SUPERVISOR    DISP      IPL INITIALIZATION'      32000051
         DS    0F                                              @D61NDIS 32010051
         DC    CL8'DISPIPL'                                    @D61NDIS 32020051
*--------------------------------------------------------------         32030051
* DISPIPL  - INITIALIZES DISPATCHER SERVICE INTERFACES,                 32040051
*            CALLED BEFORE THE FIRST DISPATCHER SERVICE                 32050051
*            (DISPMAC, TDLOCK) REQUEST WILL BE EXECUTED.                32060051
*            SUPERVISOR GENERATION: ADISPRT WILL POINT TO DISPIPL       32070051
*            INPUT: RD - BASE ADDRESS                                   32080051
*                   RE - RETURN ADDRESS FOR FUNCTION                    32090051
*            WORK:  RC                                                  32100051
*                                                                       32110051
*            AMODE: 31                                                  32120051
*--------------------------------------------------------------         32130051
         USING DISPIPL,RD                                      @D61RDIS 32140051
DISPIPL  DS    0H                                              @D61RDIS 32150051
         L     R6,DISPAD          GET DISPATCHER BASE          @D64XDIS 32160051
         USING DISP,R6                                         @D64XDIS 32170051
         LA    R7,DISPRETT        GET ADDRESS OF TD RETURN     @D64XDIS 32180051
         L     R6,ADISPINF        GET ADDRESS OF DISP.INTERFACE@D61RDIS 32190051
         USING DISPINF,R6                                      @D61RDIS 32200051
         L     RC,ASVASVDL        GET SUP. SUBDIRECTORY        @D61RDIS 32210051
         USING SVASVDL,RC                                      @D61RDIS 32220051
         MVC   ADISPRT(4),AIJBDSPU  GET DISPATCHER ROUTINE ADDR@D61RDIS 32230051
         DROP  RC                 RELEASE SVASVDL              @D61RDIS 32240051
         OI    SUPFLAG,TDACT      INDICATE TURBO DISP.ACTIVE   @D61RDIS 32250051
         L     RC,DISPAD          GET DISPATCHER BASE ADDRESS  @D61RDIS 32260051
         DROP  RD                                              @D61RDIS 32270051
         L     RD,ADISPRT         GET DISPTACHER ROUTINE ADDR. @D61RDIS 32280051
         BR    RD                 RETURN TO CALLER             @D61RDIS 32290051
         DROP  R6                 RELEASE DISP                 @D61RDIS 32300051
         SPACE 2                                               @D61RDIS 32310051
DISPIPL0 DS    0H                                              @D64XDIS 32320051
         BAL   R5,SYSERROR        TURBO DISPATCHER NOT LOADED  @D64XDIS 32330051
         DC    C'TURBO DISPATCHER NOT LOADED'                  @D64XDIS 32340051
         SPACE 2                                               @D61RDIS 32350051
DISPIPCU DC    CL1'U'                                          @D61RDIS 32360051
ADISPINF DC    A(DISPINF)         ADDRESS OF DISP.INTERFACE    @D61RDIS 32370051
         DS    0F                 ALIGNMENT                    @D61RDIS 32380051
         TITLE 'VSE/AF SUPERVISOR    DISPSERV   DISPATCHER SERVICES'    32390051
         DISPSERV ,                                            @D61PDIS 32400051
         AIF   (NOT &DISP).NOPRT20                                      32410051
         PRINT NOGEN                                                    32420051
.NOPRT20 ANOP                                                           32430051
         MEND                                                           32440051
