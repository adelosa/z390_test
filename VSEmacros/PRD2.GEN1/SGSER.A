         MACRO                                                          00001000
         SGSER                                                          00002000
         GBLB  &BG31        RPS SUPPORT IN SYSTEM              @D35VDEP 00003000
         GBLB  &SGSER       SGSER PRINT CONTROL SWITCH         @D37BDAP 00004000
         GBLB  &VSE270      RELEASE CONTROL SWITCH             @D68REEF 00006000
         GBLB  &VSE280      RELEASE CONTROL SWITCH             @D68ADAP 00007000
         GBLA  &AG1         NUMBER OF IODEV                    @D51ODAP 00008000
         LCLB  &VSEPLF      VTS SUPPORT SWITCH                 @D25IDAP 00009000
***************************************************************         00012000
*                                                             *         00013000
.*       IBM DISK OPERATING SYSTEM                            *         00014000
*        SUPERVISOR - SGSER - 5686-CF7-06                     *         00015000
.*                                                            *         00016000
*        LICENSED MATERIALS - PROPERTY OF IBM                 *         00017000
*        THIS MACRO IS "RESTRICTED MATERIALS OF IBM"          *         00018000
*        5686-CF7 (C) COPYRIGHT IBM CORP. 1979, 2005          *         00019490
*        SEE COPYRIGHT INSTRUCTIONS                           *         00020000
*                                                             *         00021000
.* /* START OF SPECIFICATIONS ***************************************** 00022000
.*                                                                    * 00023000
.*01* MODULE-TYPE = SUPERVISOR GENERATION MACRO                       * 00024000
.*                                                                    * 00025000
.*01* DESCRIPTIVE NAME = SERVICE SYSTEM TASK                          * 00026000
.*                                                                    * 00027000
.*01* NOTES = CHANGE ACTIVITY                                         * 00028000
.*    NEW MODULE FIRST RELEASE IS 34                           @D34SDEP 00029000
.*    TASKING SUPPORT                                          @D36IDAP 00030000
.*    SUPPORT OF EXTERNEAL DEVICE CODE                         @D14BDAP 00031000
.*    RETRY IF ENVIRONMENTAL DATA PRESENT                      @DA23802 00032000
.*    SUPPORT OF EXTERNEAL DEVICE CODE                         @DA27235 00033000
.*    FORCE RC=4 IN CASE LNO IS INVALID                        @DA30088 00034000
.*    INVALID CALL FOR SECTVAL MACRO WHEN RPS NOT GENERATED    @DA34718 00035000
.*    NEW DEVICE SUPPORT                                       @D21IDAP 00036000
.*    MSG4476D RECEIVED INSTEAD OF MSG4455D                    @DA35542 00037000
.*    MAINTAIN MDR/OBR RECORD ID IN PUBX                       @D21IDAP 00038000
.*    VOLUME COMMAND OUTPUT INCORRECT FOR REMOVEABLE DASD      @DA36540 00039000
.*    GETVCE/MODVCE FOR TAPE                                   @D21LDAP 00040000
.*    TAPE VOLUME RECOGNITION                                  @D21LDAP 00041000
.*    9332 MODEL 600 FBA SUPPORT                               @D21LDAP 00042000
.*    0671 FBA SUPPORT                         (SPE DA37265)   @D21FDAP 00043000
.*    LIMIT NUMBER OF CYLINDERS TO NATIVE DEVICE CONSTANTS     @DA37579 00044000
.*    MAINTAIN CORRECT VCTATYPE CODE FOR RPS DEVICES           @DA38012 00045000
.*    RETURN PUB ADDRESS DEPENDING ON USERS SPECIFICATIONS     @DA38034 00046000
.*    3990 CACHE SUPPORT                                       @D31ADAP 00047000
.*    PREVENT LOOP IN CASE OF 3990 CACHE BEING ACTIVE          @DA38423 00048000
.*    DUAL COPY SUPPORT                                        @D31ODAP 00049000
.*    9348 TAPE SUPPORT                                        @D31KMAP 00050000
.*    0675 FBA DEVICE SUPPORT                                  @D31DMAP 00051000
.*    9336 FBA DEVICE SUPPORT                                  @D31CMAP 00052000
.*    ECKD DEVICE SUPPORT                                      @D51EDAP 00053000
.*    MORE DEVICES SUPPORT                                     @D51ODGL 00054000
.*    3990-6 SUPPORT                                           @D61ADMK 00055000
.*    TPA DEVICE CHANGES                                       @D62TAAP 00056000
.*    MORE TASKS SUPPORT                                       @D66CDAP 00057000
.*    3590 SUPPORT ENHENCEMENTS                                @D63TAAP 00058000
.*    DO NOT PLACE VOLID IN PUB2 FOR D/T3540                   @DA40290 00059000
.*    PREVENT DIVIDE EXCEPTION FOR D/T3540                     @DA40427 00060000
.*    INCORRECT DEVICE PROPERTIES FOR 3430 ADDED DEVICE        @DA40741 00061000
.*    INCORRECT MODE D0 IF TAPE 3430 NOT ATTACHED AT IPL       @DA40741 00062000
.*    MSG0P03 IS ISSUED WHEN D/T3480 IS ADDED AS SWITCHABLE    @DA40763 00063000
.*    CACHE STATUS CHANGE MSG NOT ISSUED FOR ECKD DEVICES      @DA41012 00064000
.*    SUPPRESS MSG IN CASE OF ENVIRONMETAL DATA PRESENT        @DA41483 00065000
.*    INCORRECT TAPE PROPERTIES IN CASE OF DEV. NOT OPERATIONAL@DA41649 00066000
.*    ENSURE 3480 DISPLAY ERASURE AFTER READ ERROR             @DA41772 00067000
.*    PREVENT ATTENTION TO BY SET SVT-BOUND IF SDAID USES TAPE @DA41249 00068000
.*    3480 DISPLAY SHOWS OLD VOLID INSTEAD OF CURRENT ONE      @DA41927 00069000
.*    PROVIDE NEW DEVICE CHARACTERISTICS IF PBXVCTE IS ZERO    @DA42950 00070000
.*    HANDLE COMMAND REJECT AS TEMPORARY ERROR CONDITION       @DA42840 00071000
.*    ACCEPT DUPLICATE VOLIDS                                  @DA43487 00072000
.*    RETURN CODE SETTING FOR MODVCE                           @DA43606 00073000
.*    CLEAN UP CHANGES                                         @DA43697 00074000
.*    PREVENT RETRY IN CASE OF PERMANENT READ ERROR            @DA43914 00075000
.*    9348 IS NOT A CARTRIDGE DEVICE                           @DA44241 00076000
.*    PPRC SUPPORT                                             @DA44172 00077000
.*    PROVIDE PROPER RETURN CODE FOR NO VOL1-LABEL             @DA44201 00078000
.*    ENSURE PBXREADY TO BE SET DURING VOLUME RECOGNITION ONLY @DA44201 00079000
.*    CORRECT THE TEST FOR RESERVED DEVICE                     @DA44277 00080000
.*    PROVIDE SUPPORT FOR "MIRRORING STATUS CHANGE"            @DA44364 00081000
.*    OPTION TO DISPLAY THE JOBNAME IN THE LOAD DISPLAY ADDED  @DA44471 00082000
.*    ENSURE PROPER VCTATYP TO BE SET IN VCT-ENTRY             @DA44498 00083000
.*    ENSURE PROPER DEVICE CHARACTERISTIC FOR 3380 DEVICES     @DA44600 00084000
.*    ENSURE PROPER PPRC STATUS CHANGE REPORTING               @DA44616 00085000
.*    PREVENT ENDLESS LOOP IN CASE OF COMMAND REJECT           @DA44634 00086000
.*    PREVENT HARDWAIT IN CALCPUB AFTER A GETVCE  BAD AVRIDEV  @DA44680 00087000
.*    ADD SYSUSE AS A VALID SYSTEM LUB                         @DA44738 00088000
.*    RESET CMS-DISK INDICATION IF VOLID IS INVALID            @DA44738 00089000
.*    ALLOW AR TO BE CANCELED WHILE AVR-BOUND                  @DA44841 00090000
.*    PREVENT UNASSGN FOR TAPE DEVICES WHICH ARE MARKED "HOLD" @DA44841 00091000
.*    DISPLAY OLD VOLID WHEN DSPLY=JNM AND UNLOAD REQUESTED    @DA44841 00092000
.*    RQT-ENTRY-CHAIN CORRUPTION RESULTS IN WRONG MODVCE RC    @DA45062 00093000
.*    CHANGED INTERFACE TO CALCPUB ROUTINE                     @DY45385 00094000
.*    PROVIDE CORRECT RETURN CODE WHEN TAPE UNASSGN REQUESTED  @DY45540 00095000
.*                                AND MODVCE REQUEST PENDING   @DY45540 00096000
.*    ENSURE READ-ONLY ADDED DEVICES TO BE IDENTIFIED PROPERLY @DY45540 00097000
.*    RETRY RDC COMMAND WHEN RESULT IS ZERO AND NO UNIT-CHECK  @DY45817 00098000
.*    MAKE PROVISIONS TO WRITE BUFFERED TAPE MARKS             @DY45817 00099000
.*    REESTABLISH PUBX ADDRESS FOLLOWING A VM DIAG INSTRUCTION @DY45909 00100000
.*    ENSURE DISP-EXIT IN CASE OF NO MORE FREE RQT ENTRIES     @DY46037 00101000
.*    TAPE HANG, VOL1 RECORD OVERWRITTEN                       @DY46053 00102000
.*    3592 SUPPORT                                             @DY46071 00103000
.*    CHANNEL PROGRAM CHECK DUE TO INVALID ADDRESS IN RF (CCW) @DY46139 00104000
.*    ENSURE AVRNOWRT (INHIBIT WRITE) TO BE MAINTAINED PROPERLY@DY46145 00105000
.*    DIAGNOSE ISSUED BUT NOT RUNNING UNDER VM (AFTER DY46145) @DY46148 00106000
.*    PREVIOUS VOL-ID DISPLAYED AFTER ASSGN UA                 @DY46187 00107000
.*    UNEXPECTED DCTUTYP AFTER DY46120                         @DY46252 00108000
.*    PREVENT DCTPCYL OF ZERO FOR DEDICATED DASD DEVICES       @DY46253 00109000
.*    LOW CORE OVERLAY AFTER AVR-BOUND AR TASK WAS CANCELED    @DY46225 00109500
.*    DISABLED SVT-TASK LOOP IF RQTFLPTR IS ZEROES             @DY46315 00109750
.*    PROVIDE PROPER TACNADR ADDRESS                           @DY46314 00109800
.*    SKIP DASD MODVCE PROCESSING WHEN SVT IS VIRT.-DEVICE BND @DY46299 00109850
.*    HARD WAIT DUE TO IMPROPER SERVICE OWNER FOR UNSOL.INTERR.@DY46433 00109900
.*    HARDWAIT FEC SVT TASK DUE TO RQTE OVERLAY W CANCEL AR    @DY46496 00109950
.*    X'CB' MODE SET COMMAND FOR TPA DEVICES NOT PERFORMED     @DY46564 00109970
.*    PBXNOVOL SET BUT ASSIGN CCW NOT ISSUED                   @DY46592 00109980
.*    0P73I WITH 3420 3430 AFTER DY46592                       @DY46611 00109990
.*                                                                      00110000
.**** END OF SPECIFICATIONS ******************************************* 00111000
         SPACE 3                                                        00112000
         PRINT GEN                                             @D37BDAP 00114000
.NPRT010 ANOP                                                  @D37BDAP 00115000
         DC    CL8'SGSER'                                      @DY46071 00116000
         DC    CL8'DY46611'       CHANGE ACTIVITY CODE         @DY46611 00117960
         USING DISP,R6            DISPATCHER BASE              @D36IDAP 00118000
         USING SERTASK,RD         SGSER BASE                            00119000
SERTASK  DS    0H'0'              ENTRY POINT                  @D369DAP 00120000
         BR    RC                      ======================> @D369DAP 00121000
*                                 EXIT TO SVC99  (GETVCE)      @D369DAP 00122000
*                                 EXIT TO SVC101 (MODVCE)      @D369DAP 00123000
         TITLE 'VSE SUPERVISOR     SGSER     SERVICE CONTROL ROUTINE  ' 00124000
         AGO   .SKIP020                                                 00125000
         L     RC,TCBPTR          POINT TO SVT TCB             @DBOC    00126000
         USING TCBADR,RC          TCB BASE ADDRESS             @DBOC    00127000
         L     RC,TCBSAVE         GET ADDR OF SAVE AREA        @DBOC    00128000
         USING SVEARA,RC          SAVE AREA BASE ADDRESS       @DBOC    00129000
         LA    RF,SERTASK1        GET SERVICE TASK ENTRY POINT @DBOC    00130000
         ST    RF,SVEPSW+4        STORE ENTRY POINT IN PSW     @DBOC    00131000
         DROP  RC                 RELEASE SAVE AREA BASE       @DBOC    00132000
.SKIP020 ANOP                                                           00133000
SERTASK1 L     RC,BASESERI        SGSERI BASE ADDRESS          @D35CDFG 00134000
         USING SGSERI,RC          SGSERI BASE POINTER          @D35CDFG 00135000
         LA    R4,SVTTID          SVT-TASK IS SERVICE OWNER    @D61NDAP 00136000
         BAL   R7,AVRSOWNR        SET UP SERVICE OWNER         @D61NDAP 00137000
*SGLINK  AVRSOWNR,WORK=(R4,R5)                                 @D61NDAP 00138000
         TM    SERFLGPR,SERDORDY  DO WE HAVE TO SCAN VCT-TABLE @DBOC    00139000
         BO    AVRTSK             YES, ======================> @D61ADAP 00140000
SERTASK2 TM    SERFLGPR,SERRQTMV  MODVCE/AVR PROCESSING        @D61ADAP 00141680
         BO    AVRRQTPR           YES, ======================> @D61ADAP 00142000
         L     RF,ASERFCPY        ADDRESS OF FLASH-COPY ROUTINE@D25IDAP 00143000
         TM    SERFLGPR,SERRQTIX  IS THIS A FLASH COPY REQUEST @D25IDAP 00144000
         BOR   RF                 YES, =====================>> @D25IDAP 00145000
         L     RF,AUPDSLD         ADDRESS OF UPDATE ROUTINE    @D36SDAP 00146000
         TM    SERFLGPR,SERUPSLD  SEC. LEVEL DIRECTORY CHANGE  @D36SDAP 00147000
         BOR   RF                 YES, =====================>> @D36SDAP 00148000
         L     RF,ASERMSG         ADDRESS OF MESSAGING ROUTINE @D61PDAP 00149000
         TM    SERFLGPR,SERRQTMS  MESSAGING REQUEST            @D61PDAP 00150000
         BOR   RF                 YES, =====================>> @D36SDAP 00151000
         TM    SERFLGPR,SERRQTQR  QUIESCE/RESUME REQUEST       @D52BDGL 00152000
         BZ    SERTASK3           NO,                          @D52BDGL 00153000
         L     RF,ASVASVDL        SVA  SUPERVISOR DIRECTORY    @D61ADGL 00154000
         L     RF,AIJBCUIR-SVASVDL(,RF) IJBCUIR LOAD ADDRESS   @D61ADGL 00155000
         LTR   R8,RF              HAS IJBCUIR BEEN LOADED      @D61ADAP 00156000
         BZ    SERTASK3           NO, SKIP PROCESSING          @D61NDGL 00157000
         L     RF,AQRSGLOB        SGCUIR BASE ADDRESS          @D61NDGL 00158000
         LR    RC,R8              IJBCUIR BASE ADDRESS         @D61ADAP 00159000
         BASSM RE,RC                   ======================> @D66ADAP 00160000
         L     RC,BASESERI        RESTORE SGSERI BASE          @D61ADAP 00161000
         B     SERTASK1           START IT ALL OVER AGAIN      @D62TAAP 00162000
SERTASK3 NI    SERFLGPR,XFF-SERRQTQR RESET QUIESCE/RESUME      @DAOM    00163000
         L     R8,TCBPTR          ADDRESS OF SVT-TCB           @D36IDAP 00164000
         USING TCBADR,R8          TCB BASE ADDRESS             @D36IDAP 00165000
.*       RESTORE PSW IN SAVE AREA                              @D35VDEP 00166000
         L     R8,TCBSAVE         GET ADDR OF SAVE AREA        @D36IDAP 00167000
         USING SVEARA,R8          SAVE AREA BASE ADDRESS       @D35VDEP 00168000
         LA    R7,SERTASK1        GET SERVICE TASK ENTRY POINT @D35VDEP 00169000
         ST    R7,SVEPSW+4        STORE ENTRY POINT IN PSW     @D35VDEP 00170000
         DROP  R8                 RELEASE SAVE AREA BASE       @D35VDEP 00171000
         L     R6,DISPAD          GET ADDR OF DISP ENTRY POINT @D35VDEP 00172000
         SR    R1,R1              INDICATE UNCOND. POSTING     @D36IDAP 00173000
         L     R5,ASRQTAB         RESOURCE DESCRIPTOR TABLE    @D61MPAP 00174000
         LA    R5,SRQAVR-SRQTAB(,R5) AVR BOUND                 @D61MPAP 00175000
         BAL   RF,RPOST           ACTIVATE UNCONDITIONAL WAITER@D36IDAP 00176000
*SGLINK  RPOST,INPUT=(R5,R6,RF),WORK=(R5,RE)                   @D369DAP 00177000
         OC    SERECBLST(16*4),SERECBLST ANY REQUEST QUEUED    @DY46053 00178000
         BZ    SERDEACT           NO, WE ARE DONE              @DBOC    00179000
SERWAITM LA    R1,SERAWTDCB       ADDRESS OF ECB LIST          @D28ADAP 00180000
         WAITM (1)                WAIT FOR ONE TO COMPLETE     @DBOC    00181000
         LTR   R1,R1              IS THIS A VALID ADDRESS      @DAOM    00182000
         BNZ   SERMW000           YES, TRY TO FIND I/O FIRST   @DAOM123 00183000
         ST    R1,0               RESET LOW CORE INFO          @DAOM123 00184000
         B     SERWAITM           NO, ITS STORAGE OVERLAY      @DAOM123 00185000
SERMW000 LA    RE,SERECBLST       CHECK I/O ECB FIRST          @DBOC    00186000
SERWM020 C     R1,0(,RE)          IS THIS THE MATCHING ENTRY   @DBOC    00187000
         BE    SERWM060           YES,                         @DBOC    00188000
         LA    RE,4(,RE)          ADVANCE ECB ADDRESS POINTER  @DBOC    00189000
         TM    0(RE),X'80'        END OF ECB-LIST              @DBOC    00190000
         BZ    SERWM020           NO, CHECK NEXT ECB           @DBOC    00191000
         LA    RE,SERWTDECB       WORK-TO-DO ECB               @DBOC    00192000
         CR    R1,RE              DID WE GET NEW WORK-TO-DO    @DBOC    00193000
         BE    SERWM040           YES,                         @DBOC    00194000
         TM    IJBFLG08,IJBDEBUG  IS DEBUG ACTIVE              @DBOC    00195000
         BZ    SERWM040           NO,                          @DBOC    00196000
         BAL   R5,SYSERROR        HARD-WAIT THE SYSTEM         @DBOC    00197000
SERWM040 NI    2(R1),XFF-X'C0'    RESET WAIT BIT IN SERWTDECB  @DBOC    00198000
         B     SERTASK1           HANDLE NEW REQUEST           @DBOC    00199000
         SPACE 1                                               @DBOC    00200000
SERWM060 XC    0(4,RE),0(RE)      DELETE ECB FROM ECBLIST      @DBOC    00201000
         LA    R2,RQTCCB-RQTE     GET CCB OFFSET WITHIN RQT    @DBOC    00202000
         LCR   R2,R2              PROVIDE FOR SUBTRACTION      @DBOC    00203000
         AR    R2,R1              ADDRESS OF RQT-ENTRY         @DBOC    00204000
         USING RQTE,R2            RQTE BASE POINTER            @DBOC    00205000
         LM    R0,RF,RQTIOREG     RESTORE I/O ROUTINE REGISTER @DBOC    00206000
         DROP  R2                 RELEASE RQTE POINTER         @DBOC    00207000
         B     TAPIORWT           RETURN TO I/O ROUTINE        @DBOC    00208000
.*                                                                      00209000
.*       NOW DEACTIVATE SVT-TASK                                        00210000
.*                                                                      00211000
SERDEACT DS    0H'0'                                                    00212000
         CLI   SERFLGPR,ZERO      ANOTHER PASS REQUIRED        @DY46037 00213000
         BE    SERDEA10           NO,                          @DY46315 00214380
         L     RE,RQTFLPTR        GET A FREE REQUEST ENTRY     @DY46315 00214470
         LTR   RE,RE              IS REQUEST ELEMENT AVAILABLE @DY46315 00214560
         BNZ   SERTASK1           YES,                         @DY46315 00214650
         L     R5,ASRQTAB         ADDR(RESOURCE DESRIPTOR TAB) @DY46315 00214740
         LA    R5,SRQCHQ-SRQTAB(,R5) PTR TO CHANQ WAIT QUEUE   @DY46315 00214830
         BAL   RC,RWAIT           WAIT                         @DY46315 00214920
*SGLINK  RWAIT INPUT=(R5,RC)                                   @DY46315 00215010
         B     SERTASK1           TEST CHANNEL QUEUE AGAIN     @DY46315 00215100
SERDEA10 SGSETUP UNPOST,STASK=SVT,WR1=R8,OPTION=RESETOWNER     @D36IDAP 00215450
         BR    R6                      ====================>>> @D36IDAP 00216000
         TITLE 'VSE SUPERVISOR     SGSER    ENQUEUE ''READY'' REQUEST ' 00217000
.********************************************************************** 00218000
.*                                                                      00219000
.* FUNCTION       ALLOCATE A RQT-ENTRY FOR AVR PROCESSING               00220000
.*                FOR ALL THOSE DEVICE THAT HAVE BEEN FLAGGED           00221000
.*                WITH WORK-TO-DO (BECAME READY) IN THE VCT-ENTRY       00222000
.*                                                                      00223000
.* ENTRY POINT    AVRTSK                                                00224000
.*                                                                      00225000
.* SUBROUTINES                                                          00226000
.*                AVRFVCTE - FIND ASSOCIATED VCT ENTRY                  00227000
.*                AVRUPD   - DO SENSE, READ VOL1 LABEL, UPDATE VCTE     00228000
.*                                                                      00229000
.********************************************************************** 00230000
AVRTSK   DS    0H'0'              DO DEVICE READY PROCESSING   @D61ADAP 00231000
         NI    SERFLGPR,XFF-SERDORDY RESET READY PROCESSING    @D61ADAP 00232000
         LH    R5,AVRCOUNT        GET NUMBER OF VCTE ENTRIES   @D35VDEP 00233000
         L     R4,AAVRTAB         GET ADDRESS OF VCTE TABLE    @D35VDEP 00234000
         USING VCTEADR,R4         VCT BASE POINTER             @D35VDEP 00235000
AVRTSK20 TM    VCTAPROC,VCTAPWTD  DOES ENTRY HAVE WORK-TO-DO   @DBOC    00236000
         BNO   AVRTSK40           NO, PROCESS NEXT ENTRY       @D35VDEP 00237000
         NI    VCTAPROC,XFF-VCTAPWTD RESET WORK TO DO FLAG     @D35VDEP 00238000
         L     R3,VCTAPUB         GET PUB ADDRESS              @DBOC    00239000
         USING PUBADR,R3          PUB BASE POINTER             @DBOC    00240000
         BAL   RE,SERADD          ENQUEUE INTO WORK-TO-DO CHAIN@DBOC    00241000
*SGLINK  SERADD,INPUT=(R3,R6,RC,RE),WORK=(R7,R8,RF)            @DBOC    00242000
AVRTSK40 AH    R4,VCTELEN         POINT AT NEXT ENTRY          @D51EDAP 00243000
         BCT   R5,AVRTSK20        PROCESS NEXT VCTE ENTRY      @DBOC    00244000
         B     SERTASK2           CHECK FOR OTHER WORK TO DO   @27GAPTM 00245000
         DROP  R3                 RELEASE PUB BASE             @D14BDAP 00246000
         DROP  R4                 RELEASE VCT ENTRY BASE       @D14BDAP 00247000
         TITLE 'VSE SUPERVISOR     SGSER    PROCESS RQT-ENTRY REQUEST ' 00248000
.*                                                             @D149DAP 00249000
.*       PROCESS REQUEST QUEUE TABLE ENTRIES                   @D149DAP 00250000
.*                                                             @D149DAP 00251000
AVRRQTPR NI    SERFLGPR,XFF-SERRQTMV RESET MODVCE PROCESSING   @D61ADAP 00252000
         L     R2,RQTBEGIN        ADDRESS OF REQUEST ENTRY     @DBOC    00253000
         USING RQTE,R2            RQT BASE POINTER             @D61ADAP 00254000
AVRRQT10 TM    RQTFLG,RQTINUSE    DOES ENTRY HAVE WORK TO DO   @D356DAP 00255000
         BNO   AVRRQT70           NO, PROCESS REST OF TABLE    @D25IDAP 00256490
         TM    RQTFLG,RQTDOWTO+RQTDOIXF WTO OR FLASH-COPY ENTRY@DAOM    00257000
         BNZ   AVRRQT70           YES, SKIP AVR PROCESSING     @DAOM    00258490
         NI    RQTFLG,XFF-RQTINUSE WITHDRAW FROM ACTIVE CHAIN  @DBOC    00259000
*        TM    RQTFLG,RQTSET15    IS TASK WAITING              @DY46433 00260590
*        BZ    AVRRQT20           NO, SVT REMAINS SERVICE OWNER@DY46433 00261180
         LH    R4,RQTTID          GET TID OF SERVICE OWNER     @D36IDAP 00262000
         BAL   R7,AVRSOWNR        SET SERVICE OWNER            @D52VDAP 00263000
*SGLINK  AVRSOWNR,WORK=(R4,R5)                                 @D61PDAP 00264000
AVRRQT20 LH    R3,RQTPUB          UPDATE RTN REQUIRES PUB ADDR @D51ODGL 00265000
         USING PUBADR,R3          PUB BASE POINTER             @D14BDAP 00266000
         BAL   R7,AVRFVCTE        FIND RELATED VCT ENTRY       @D35VDEP 00267000
*SGLINK  AVRFVCTE,INPUT=(R3,R7,RC),OUTPUT=R4,WORK=R8           @D369DAP 00268000
         LTR   R4,R4              DOES VCTE EXIST              @D52VDAP 00269000
         BZ    AVRRQT60           SHOULD NEVER OCCUR           @D68PGA  00270490
         USING VCTEADR,R4         VCT ENTRY BASE POINTER       @D14BDAP 00271000
         CLI   VCTATYPE,VCTATAPE  IS THIS A TAPE DEVICE        @D61ADAP 00272000
         BE    AVRRQT30           YES,                         @D61ADAP 00273000
         TM    RQTFLG,RQTOPRLS    IS DEVICE TO BE RELEASED     @D356DAP 00274000
         BZ    AVRRQT30           NO, DONT RESET RESERV BIT    @D356DAP 00275000
         NI    VCTAFLAG,XFF-VCTARSV RESET DEVICE RESERVED BIT  @D356DAP 00276000
AVRRQT30 BAL   R8,AVRGPUBX        CALCULATE PUBX ADDRESS       @D68ADAP 00278990
*SGLINK  AVRGPUBX,INPUT=(R3,R8,RC),OUTPUT=R9                   @D68ADAP 00282000
         USING PBXADR,R9          PUBX BASE POINTER            @D68ADAP 00283000
         BAL   R7,AVRUPD          UPDATE VOLUME INFO    =====> @D356DAP 00283200
*SGLINK  AVRUPD,INPUT=(R2,R3,R4,R6,R7,R9,RC,RD),                       *00283400
               WORK=(R0,R1,R5,R8,RA,RB,RE,RF)                  @D369DAP 00283600
         AIF   (NOT &VSE280).N280020                           @D68ADAP 00283800
         NI    PBXFLAG3,XFF-PBXF3VOL RESET VOLUME PROCESSING   @D68ADAP 00284000
         DROP  R9                 RELEASE PUBX BASE POINTER    @D68ADAP 00285000
.N280020 ANOP                                                  @D68ADAP 00286000
         TM    IJBFLG08,IJBDEBUG  IS DEBUG ACTIVE              @D61ADAP 00287000
         BO    AVRRQT40           YES,                         @D61ADAP 00288000
         TM    VCTAPROC,VCTASTCK  CASCADED STATUS CHANGE REQ.  @D61ADAP 00289000
         BO    AVRRQT50           YES, DONT PRINT MESSAGE      @D61ADAP 00290000
AVRRQT40 BAL   R7,AVRMSGRT        PROVIDE MESSAGE(S) IF ANY    @D61ADAP 00291000
AVRRQT50 NI    VCTAPROC,XFF-VCTASTCK RESET CHECK STATUS PROC   @D68PGA  00292790
AVRRQT60 XC    AVRMSINF(2),AVRMSINF CLEAR MESSAGES             @D68PGA  00293580
         BAL   R7,AVRRQPST        POST TASK AND FREE RQT-ENTRY @D68PGA  00294370
AVRRQT70 LA    R2,RQTEND(,R2)     ADVANCE TO NEXT RQT ENTRY    @D25IDAP 00295160
         C     R2,RQTENDAD        WAS THIS THE LAST RQT ENTRY  @DBOC    00296000
         BL    AVRRQT10           NO, PROCESS NEXT ENTRY       @D36IDAP 00297000
         B     SERTASK1                ======================> @D35VDEP 00298000
         DROP  R2                 RELEASE RQTE BASE POINTER    @D25IDAP 00299000
         DROP  R4                 RELEASE VCTE BASE POINTER    @D25IDAP 00300000
         SPACE 3                                                        00301000
.*                                                             @D25IDAP 00302000
.*       POST THE REQUESTING TASK AND DEQUEUE ENTRY            @D25IDAP 00303000
.*                                                             @D25IDAP 00304000
         USING RQTE,R2            RQT BASE POINTER             @D61ADAP 00305000
AVRRQPST TM    RQTFLG,RQTSET15    WAS THIS A SYNCHRONEOUS SVC  @DY46496 00308990
         BZ    AVRRQP20           NO, DEQUEUE RIGHT NOW        @D61ADAP 00312690
         LA    RF,ARTID           TID OF AR-TASK               @D66CDAP 00313380
         CH    RF,RQTTID          IS THIS AN AR TASK REQUEST   @D66CDAP 00314070
         BNE   AVRRQP10           NO,                          @DA44841 00315000
         L     RF,AARTIB          ADDRESS OF ATTENTION TIB     @DA44841 00316000
         USING TIBADR,RF          AR-TIB BASE                  @DA44841 00317000
         CLI   TIBRQID,AVRBND     IS AR STILL AVR-BOUND        @DA44841 00318000
         BNE   AVRRQP20           NO, ASSUME IT WAS CANCELED   @DA44841 00319000
         DROP  RF                 RELEASE AR-TIB BASE          @DA44841 00320000
AVRRQP10 LR    R1,R2              POST THIS RQT WAITER         @DA44841 00321000
         L     R5,ASRQTAB         RESOURCE DESCRIPTOR TABLE    @D61APAP 00322000
         LA    R5,SRQAVR-SRQTAB(,R5) AVRBOUND STATE            @D61APAP 00323000
         BAL   RF,RPOST           CONDITIONAL POST RQT OWNER   @D61ADAP 00324000
*SGLINK  RPOST,INPUT=(R5,R6,RF),WORK=(R5,RE)                   @D61ADAP 00325000
*        NI    RQTFLG,XFF-RQTINUSE INDICATE WORK COMPLETED     @DA45062 00326000
         B     AVRRQP30           YES, LET CALLER DEQUEUE IT   @D61ADAP 00327000
AVRRQP20 MVC   RQTNEXT,RQTFLPTR   ADD ENTRY                    @DBOC    00328590
         ST    R2,RQTFLPTR        TO FREE CHAIN                @D61ADAP 00329180
AVRRQP30 BR    R7                      ======================> @D25IDAP 00330000
         DROP  R2                 RELEASE RQTE BASE POINTER    @D61ADAP 00331000
         SPACE 3                                                        00332000
*SGLINK  AVRSOWNR,WORK=(R4,R5)                                 @D61PDAP 00333000
AVRSOWNR SGSETUP SWOWNER,STASK=SVT,WR1=R4,WR2=R5,OPTION=SETOWNER        00334000
         BR    R7                      ======================> @D52VDAP 00335000
         TITLE 'VSE SUPERVISOR     SGSER     SVT-TASK I/O ROUTINE     ' 00336000
.********************************************************************** 00337000
.*                                                                      00338000
.* FUNCTION- UPDATE VCTE WITH DATA FROM DEVICE                          00339000
.* ENTRY POINT- AVRUPD - FROM AVRTSK MAIN LINE                          00340000
.* INPUTS-                                                              00341000
.*           R2= RQT ENTRY ADDRESS                                      00342000
.*           R3= PUB ADDRESS                                            00343000
.*           R4= VCT ENTRY ADDRESS                                      00344000
.*           R6= DISPATCHER BASE POINTER                                00345000
.*           R7= LINK REGISTER                                          00346000
.*           RC= SGSERI BASE POINTER                                    00347000
.*           RD= SGSER BASE POINTER                                     00348000
.*           PUB TABLE                                                  00349000
.* OUTPUTS-  VCT ENTRY IS UPDATED                                       00350000
.*           RETURN CODE IN R15                                         00351000
.*           ALL USERS OF VCT ENTRY ARE POSTED                          00352000
.* EXITS-    TO CALLER                                                  00353000
.* REGISTERS-R0= RETURN CODE TO BE PASSED TO REQUESTOR                  00354000
.*           R1= ADDR OF CCB USED FOR I/O                               00355000
.*               ALSO VCTE ADDR IN DUPLICATE VOLID SEARCH RTN           00356000
.*           R8= TO UPDATE SERVICE TASK SAVE AREA AFTER I/O             00357000
.*           RF= CCW ADDR FOR I/O AND CTR FOR DUPLI.VOLID SRCH          00358000
.* SUBROUTINES- AVRUCKD - EXECUTE DEVICE SPECIFIC ROUTINES              00359000
.*           AVRDCTPR - WAKE-UP REQUESTORS FOR THIS DEVICE              00360000
.* MACROS-   SYSIO - HEADQUEUE I/O REQUEST SVC                          00361000
.*                                                                      00362000
.********************************************************************** 00363000
         USING RQTE,R2            RQT ENTRY ADDRESS OR ZERO    @DBOC    00364000
         USING PUBADR,R3          PUBADR BASE POINTER          @DBOC    00365000
         USING VCTEADR,R4         VCT-ENTRY BASE POINTER       @D25IDAP 00366000
         USING PBXADR,R9          PUBX BASE POINTER            @D51TDAP 00372000
*SGLINK  AVRUPD,INPUT=(R2,R3,R4,R6,R7,R9,RC,RD),                       *00372200
               WORK=(R0,R1,R5,R8,RA,RB,RE,RF)                  @D369DAP 00372400
AVRUPD   EQU   *                  UPDATE VCT ENTRY             @D35VDEP 00372600
         OI    VCTAPROC,VCTAPWIP  MARK ENTRY WORK-IN-PROGRESS  @D52VDAP 00373000
         TM    PBXFLAG,PBXTAPE    IS THIS A TAPE DEVICE        @D61ADAP 00374000
         BO    AVRTAPPR           YES, ======================> @D61ADAP 00375000
         XC    SIDAREA(L'SIDAREA),SIDAREA FORCE TO ALL ZERO    @D21IDAP 00376000
         XC    SSSAREA(L'SSSAREA),SSSAREA FORCE TO ALL ZERO    @D31ADAP 00377000
         XC    SERSNSDT(L'SERSNSDT),SERSNSDT CLEAR SNS-DATA    @DA41249 00378000
         XC    RDCFAREA(L'RDCFAREA),RDCFAREA FORCE TO ALL ZERO @D61ADAP 00379000
         XC    RDCCAREA(L'RDCCAREA),RDCCAREA FORCE TO ALL ZERO @D51EDAP 00380000
         XC    PSFOAREA(L'PSFOAREA),PSFOAREA FORCE TO ALL ZERO @D68ADAP 00381000
         MVI   PSFIAREA+6,X'41'   PROVIDE TO READ FEATURE CODES@D68ADAP 00382000
         MVI   AVRVOL1,ZERO       INVALIDATE VOL1 ID           @D21LDAP 00383000
         LA    RF,AVRDSKTE        POINT AT DISKETTE CCW CHAIN  @D14BDAP 00384000
         CLI   PUBDEVTY,T3540     IS THIS A DISKETTE           @D14BDAP 00385000
         BNE   AVRIO010           NO,                          @DA44498 00386000
         MVI   VCTATYPE,VCTACKD   TREAT AS CKD DEVICE          @DA44498 00387000
         B     AVRIO050           YES                          @DA44498 00388000
AVRIO010 CLI   PUBDEVTY,TFBA      IS DEVICE FBA                @D35DDEP 00389000
         BNE   AVRIO020           NO, MUST BE CKD              @DA44172 00390000
         MVI   VCTATYPE,VCTAFBA   INDICATE FBA DEVICE          @D21LDAP 00391000
         LA    RF,AVRFBACW        POINT AT RIGHT CCW CHAIN     @D35DDEP 00392000
         B     AVRIO050           SET UP CCB                   @D21IDAP 00393000
AVRIO020 DS    0H'0'                                           @DA44172 00394000
         TM    PBXFLAG2,PBXNOSIO  VALID CHARACTERISTICS EXIST  @TEST    00395000
*        ICM   RF,15,PBXVCTE      VALID CHARACTERISTICS EXIST  @TEST    00396000
         BO    AVRIO030           NO, NOT YET                  @DA44172 00397000
         LA    RF,AVRCKSEK        POINT TO READ VOL1 CHAIN     @DA44172 00398000
         LTR   R2,R2              IS THIS A MODVCE REQUEST     @DA44172 00399000
         BZ    AVRIO030           NO, SHOULD NEVER OCCUR       @DBOC    00400000
         TM    RQTFLG,RQTREADY    READY PROCESSING             @DBOC    00401000
         BZ    AVRIO050           NO,                          @DBOC    00402000
AVRIO030 LA    RF,AVRDSNSS        SENSE-SUBSYSTEM STATUS CMD   @D21BDOW 00403000
         CLI   PUBDEVTY,TECKD     IS THIS ECKD DEVICE          @D51EDAP 00404000
         BNE   AVRIO040           NO, ITS A CKD                @D51GDAP 00405000
         MVI   VCTATYPE,VCTAECKD  INDICATE ECKD DEVICE         @D51GDAP 00406000
         B     AVRIO050           YES,                         @DA44498 00407000
AVRIO040 MVI   VCTATYPE,VCTACKD   TREAT AS CKD DEVICE          @DA44498 00408000
         CLI   PUBDEVTY,T3380     IS THIS A 3380 OR ECKD DEVICE@DA44600 00409000
         BNL   AVRIO050           YES,                         @DA44600 00410000
         LA    RF,AVRDSNID        START WITH SENSE-ID COMMAND  @D149DAP 00411000
AVRIO050 DS    0H                 DASD I/O PROCESSING          @DA23802 00412000
         LA    R1,AVRCCB          GET DASD CCB ADDRESS         @DY46139 00413000
         USING CCBADR,R1          CCB BASE POINTER             @DY46139 00414000
         ST    RF,CCBCCW          PROVIDE CCW ADDRESS          @DY46139 00415000
         OI    CCBCOM1,OWNUCRT    USER-OWN ERROR PROCESSING    @DY46139 00416000
         OI    CCBBY3,USENSE      USER WANTS SENSE             @DY46139 00417000
AVRIO060 LA    R0,3               SET RETRY COUNTER            @D52VDGL 00418000
AVRIO070 BAL   RE,AVRDSDIO        GET COMMAND CHAIN ISSUED     @D68ADAP 00419000
*SGLINK  AVRDSDIO INPUT=(R3,RE)                                @DY46139 00420000
         OC    SIDAREA(7),SIDAREA IS SNSID DATA PRESENT        @DAOM084 00421000
         BZ    AVRIO080           NO,                          @DAOM084 00422000
         MVC   PBXSNSID(7),SIDAREA SAVE SNSID IN PUBX          @DAOM084 00423000
AVRIO080 DS    0H'0'                                           @DAOM084 00424000
         AGO   .SKIP040                                        @D28ADAP 00425000
         SLR   RF,RF              INDICATE VOLID IS INVALID    @D35VDEP 00426000
         TM    VCTAFLG,VCTAFOP+VCTARDY WAS DEVICE READY BEFORE @D35VDEP 00427000
         BNO   AVRIO100           NO, LEAVE VOLID INVALID      @D35VDEP 00428000
         TM    VCTAFLAG,VCTANVOL  WAS PREVIOUS VOL1 VALID      @D35VDEP 00429000
         BO    AVRIO100           NO,  LEAVE IT FOR THE MOMENT @D35VDEP 00430000
         LR    RF,R4              PRESERVE VCT-ENTRY ADDRESS   @D35VDEP 00431000
.SKIP040 ANOP                                                  @D28ADAP 00432000
AVRIO100 TM    CCBCOM1,DISERR     DID WE GET ANY ERROR         @D35VDEP 00433000
         BO    AVRDISER           YES, ======================> @D35VDEP 00434000
*                                                              @D51GDAP 00435000
*        I/O OPERATION COMPLETED WITHOUT ERROR                 @D51GDAP 00436000
*                                                              @D51GDAP 00437000
         OI    VCTAFLG,VCTAFOP+VCTARDY OPERATIONAL AND READY   @D35VDEP 00438000
         LA    R0,MODVCEOK        SET OK RETURN CODE           @D35VDEP 00439000
         CLC   CVOL1,AVRVOL1      WAS A VOL1 LABEL READ        @D35VDEP 00440000
         BE    AVRUVOL1           YES, ======================> @D35VDEP 00441000
*                                                              @D61ADAP 00442000
*        NO VOL1 LABEL YET READ                                @D61ADAP 00443000
*                                                              @D61ADAP 00444000
         CLI   VCTATYPE,VCTAFBA   IS THIS FBA DEVICE           @D31ODAP 00445000
         BE    AVRIO1C0           YES,                         @D31ODAP 00446000
         L     RF,CCBCCW          GET CCW STARTING ADDRESS     @DY45817 00447000
         TM    SYSFLAG2,IPLBIT    IS IPL ACTIVE                @DY45817 00448000
         BZ    AVRIO120           NO, SKIP INTERNAL-DASD CODE  @DY45817 00449000
         CLI   0(RF),RDC          IS THIS THE RDC COMMAND      @DY45817 00450000
         BNE   AVRIO120           NO,                          @DY45817 00451000
         OC    RDCCAREA(L'RDCCAREA),RDCCAREA VALID DATA        @DY45817 00452000
         BNE   AVRIO120           YES,                         @DY45817 00453000
         CLI   PUBDEVTY,T3380     IS THIS A 3380 OR ECKD DEVICE@DY45817 00454000
         BNL   AVRIO050           YES, ASSUME NOT YET READY    @DY45817 00455000
AVRIO120 CLI   0(RF),SEEK         DID WE ATTEMPT SEEK ALREADY  @DY45817 00456000
         BE    AVRIO140           YES, NO VOL1 LABEL EXISTS    @D51GDAP 00457000
         SLR   RF,RF              CLEAR REGISTER               @DGA270  00458000
         ICM   RF,7,CCBCSWW       LAST EXECUTED CCW ADDRESS    @DGA270  00459000
         B     AVRIO050           START NEXT CCW CHAIN         @DGA270  00460000
*                                                              @D51EDAP 00461000
*        NO REGULAR VOL1 LABEL EXISTS ON DASD                           00462000
*                                                              @D51EDAP 00463000
AVRIO140 LA    R0,MODVCENV        VOL1 LABEL IS INVALID        @D35VDEP 00464000
         BAL   R8,AVRREC00        RECORD WITH NO NEW VOLID     @D35VDEP 00465000
*SGLINK  AVRREC00,INPUT=(R3,R4,R6,R8,R9,RC,RD,RF),WORK=R1      @D28ADAP 00466000
         DROP  R1                 RELEASE CCB BASE POINTER     @D51EDAP 00467000
         CLC   CCMS1,AVRVOL1      IS THIS A CMS DISK           @D21LDAP 00468000
         BE    AVRIO180           YES, DO SPECIAL PROCESSING   @D21LDAP 00469000
*                                                              @D51EDAP 00470000
*        NO VOL1 LABEL FOUND                                            00471000
*                                                              @D51EDAP 00472000
AVRIO160 OI    VCTAFLAG,VCTANVOL  SET VOL1 INVALID             @D35VDEP 00473000
         NI    VCTAFLAG,XFF-VCTACMSV RESET CMS DISK INDICATOR  @DA44738 00474000
         XC    VCTAVOL1,VCTAVOL1  INVALIDATE VOLID IN TABLE    @D21LDAP 00475000
         B     AVRUDASD                ======================> @D35VDEP 00476000
*                                                              @D51EDAP 00477000
*        DEVICE IS A CMS DISK                                           00478000
*                                                              @D51EDAP 00479000
AVRIO180 TM    IJBFLG08,IJBSAENV  IS THIS STAND ALONE ENVIR.   @D61DDAP 00480000
         BO    AVRIO1A0           YES,                         @D61DDAP 00481000
         TM    SYSFLAG2,IPLBIT    IS IPL ACTIVE                @D66ADAP 00482000
         BZ    AVRIO1A0           NO, LEAVE PUB AS IT IS       @D66ADAP 00483000
         NI    PUBJCFLG,XFF-PUBDVCUP SET DEVICE DOWN           @D21LDAP 00484000
AVRIO1A0 NI    VCTAFLAG,XFF-VCTANVOL SET VOL1 VALID            @D21LDAP 00485000
         OI    VCTAFLAG,VCTACMSV  INDICATE THIS IS CMS DISK    @D21LDAP 00486000
         MVC   VCTAVOL1,AVRSVOL   MOVE VOLID TO VCTE           @D21LDAP 00487000
         B     AVRUDASD               =======================> @DA41555 00488000
*                                                                       00489000
*        DEVICE IS A FBA DEVICE AND NO VOL1 YET READ                    00490000
*                                                                       00491000
         USING CCBADR,R1          CCB BASE POINTER             @D51EDAP 00492000
AVRIO1C0 L     RF,CCBCCW          GET START OF CCW-CHAIN       @D31ODAP 00493000
         OI    4(RF),CC           SET CC FLAG ON AGAIN         @D31ODAP 00494000
         CLI   0(RF),FBAEXT       IS THIS DEFINE EXTENT CCW    @D31ODAP 00495000
         BE    AVRIO140           YES, THEN THERE IS NO VOL1   @D31ODAP 00496000
AVRIO1E0 LA    RF,8(,RF)          ADJUST TO NEXT CCW           @D31ODAP 00497000
         B     AVRIO050           SIO                          @D21IDAP 00498000
         DROP  R1                 RELEASE CCB BASE POINTER     @D51EDAP 00499000
         TITLE 'VSE SUPERVISOR     SGSER     I/O ERROR PROCESSING     ' 00500000
         USING CCBADR,R1          CCB BASE POINTER             @D51EDAP 00501000
AVRDISER CLI   CCBSTA2,X'FE'      UNIQUE NOT-OPERATIONAL CODE  @D35VDEP 00502000
         BE    AVRNOTOP           SET RETURN CODE              @D35DDAP 00503000
         OI    VCTAFLG,VCTAFOP+VCTARDY DEVICE IS OPERATIONAL   @D21LDAP 00504000
         TM    SERSNSDT,COMREJ    WAS COMMAND CHAIN REJECTED   @D21LDAP 00505000
         BNO   AVRDIS15           NO, LOOK FOR SOMETHING ELSE  @DA42840 00506000
.*                                                             @DA42840 00507000
.*  SOME SENSE DATA FOR CKD/ECKD DEVICES GIVE A COMMAND REJECT @DA42840 00508000
.*  BECAUSE THE COMMAND CANNOT BE EXECUTED AT THE MOMENT, BUT  @DA42840 00509000
.*  WOULD HAVE BEEN VALID AT SOME OTHER POINT IN TIME.         @DA42840 00510000
.*  IF WE HAVE SUCH A CASE, WE KEEP TRYING WITH DSK SUPPORT.   @DA42840 00511000
.*                                                             @DA42840 00512000
         CLI   VCTATYPE,VCTARPS   DEVICE IS RPS DEVICE         @D62NDAP 00513000
         BE    AVRDIS02           YES, COM.REJCT. NOT FINAL    @DA42840 00514000
         CLI   VCTATYPE,VCTAECKD  DEVICE IS ECKD DEVICE        @DA42840 00515000
         BNE   AVRDIS25           NO, COM.REJECT IS FINAL      @DA42840 00516000
AVRDIS02 L     R5,TCBPTR          GET SVT TCB ADDRESS          @DA42840 00517000
         L     R5,TCBERBLK-TCBADR(,R5)  DEVICE ERROR ENTRY     @DA42840 00518000
         CLI   ERRQLSNS-ERBLKADR(R5),32 32 SNS BYTES           @DA42840 00519000
         BNE   AVRDIS25           NO, COMMAND REJECT           @DA42840 00520000
         TM    SERSNSDT+27,X'80'  SENSE IS 24+8                @D62NDAP 00521000
         BO    AVRDIS06           YES,                         @DA42840 00522000
         TM    SERSNSDT+25,X'80'  SIMPLE PAC                   @D62NDAP 00523000
         BNO   AVRDIS04           YES,                         @DA42840 00524000
         TM    SERSNSDT+25,X'03'  RETRY RECOMMENDED            @D62NDAP 00525000
         BNZ   AVRDIS15           YES,                         @DA42840 00526000
         B     AVRDIS25           COMMAND REJECT               @DA42840 00527000
AVRDIS04 CLI   SERSNSDT+25,X'10'  RETRYABLE                    @D62NDAP 00528000
         BE    AVRDIS15           YES,                         @DA42840 00529000
         CLI   SERSNSDT+25,X'1B'  RETRYABLE                    @D62NDAP 00530000
         BE    AVRDIS15           YES,                         @DA42840 00531000
AVRDIS06 CLI   SERSNSDT+25,X'1D'  RETRYABLE                    @D62NDAP 00532000
         BNE   AVRDIS25           NO, COMMAND REJ.             @DA42840 00533000
AVRDIS15 TM    SERSNSDT,INTVRQD   IS IT INTERVENTION REQUIRED  @DA27235 00534000
         BNO   AVRDIS60           NO, A VOLUME IS MOUNTED      @DA27235 00535000
.*                                                             @D21LDAP 00536000
.*       INTERVENTION REQUIRED PROCESSING                      @D21LDAP 00537000
.*                                                             @D21LDAP 00538000
AVRDISIR NI    VCTAFLG,XFF-VCTARDY YES, FLAG AS NOT READY      @D35VDEP 00539000
         NI    VCTAFLAG,XFF-VCTANVOL OLD VOL1 IS STILL VALID   @D28ADAP 00540000
         AGO   .SKIP060                                        @D28ADAP 00541000
         LA    R0,MODVCENO        SET RETURN CODE              @D35VDEP 00542000
         BAL   R8,AVRREC00        RECORD WITH NO NEW VOLID     @D35VDEP 00543000
*SGLINK  AVRREC00,INPUT=(R3,R4,R6,R8,R9,RC,RD,RF),WORK=R1      @D28ADAP 00544000
.SKIP060 ANOP                                                  @D28ADAP 00545000
         B     AVRUDASD           SET   =====================> @D35VDEP 00546000
         SPACE 3                                                        00547000
.*                                                             @D21LDAP 00548000
.*       COMMAND REJECT PROCESSING                             @D21LDAP 00549000
.*                                                             @D21LDAP 00550000
AVRDIS25 L     RF,CCBCCW          GET START OF CCW-CHAIN       @D31ODAP 00551000
         CLI   PUBDEVTY,TFBA      IS IT FBA DEVICE             @D61ADAP 00552000
         BNE   AVRDIS45           NO, TAKE DISK PATH           @D61ADRP 00553000
         CLI   0(RF),FBAEXT       DID WE TRY THE DEFINE EXTENT @D61ADAP 00554000
         BNE   AVRIO1E0           NO, TRY NEXT COMMAND         @D61ADAP 00555000
AVRDIS30 LA    R0,MODVCEER        NO, SOME OTHER I/O ERROR     @D14BDAP 00556000
         B     AVRIO160                ======================> @D35VDEP 00557000
         SPACE 1                                               @D41XXAP 00558000
AVRDIS45 CLI   0(RF),SEEK         DID WE TRY THE SEEK CHAIN    @D31ODAP 00559000
         BE    AVRDIS30           YES, ACCEPT THE ERROR        @D21IDAP 00560000
         B     AVRIO1E0                                        @D52VDAP 00561000
         SPACE 3                                                        00562000
.*                                                             @D21LDAP 00563000
.*       SEVERE ERROR PROCESSING                               @D21LDAP 00564000
.*                                                             @D21LDAP 00565000
AVRDIS60 CLI   PUBDEVTY,T3540     IS THIS A DISKETTE           @D14BDAP 00566000
         BE    AVRDIS30           YES, NO NEED TO RETRY        @D14BDAP 00567000
         TM    CCBSTA1,CHANEND+DEVEND INITIAL SELECTION        @DA41483 00568000
         BNZ   AVRDIS70           NO,                          @DA41483 00569000
         BCT   R0,AVRIO070             ======================> @DA41483 00570000
AVRDIS70 CLI   VCTATYPE,VCTAFBA   IS IT FBA DEVICE             @D52VDAP 00571000
         BE    AVRDIS25           YES,                         @DA44201 00572000
         TM    SERSNSDT+1,NORECFND NO-REC-FOUND                @D21LDAP 00573000
         BO    AVRIO140           YES, ======================> @D35VDEP 00574000
         TM    CCBCOM1,OWNUCRT    DID DSK-ERP RETRY ALREADY    @D35VDAP 00575000
         BZ    AVRDIS25           YES, NO MORE RETRIES         @DA44201 00576000
         NI    CCBCOM1,XFF-OWNUCRT LET DSK-ERP HANDLE ERROR    @D35VDAP 00577000
         NI    CCBBY3,XFF-USENSE  DONT OVERWRITE SERSNSDT      @D35VDAP 00578000
         B     AVRIO060                ======================> @D35VDAP 00579000
         SPACE 1                                                        00580000
AVRNOTOP LA    R0,MODVCNOP        NOT OPERATIONAL RETURN CODE  @D35VDEP 00581000
         NI    VCTAFLG,XFF-VCTARDY-VCTAFOP SET NOT OPERATIONAL @D35VDEP 00582000
         NI    VCTAFLAG,XFF-VCTANVOL OLD VOLID IS STILL VALID  @D35VDEP 00583000
         AGO   .SKIP080                                        @D28ADAP 00584000
         BAL   R8,AVRREC00        RECORD WITH NO NEW VOLID     @D35VDEP 00585000
*SGLINK  AVRREC00,INPUT=(R3,R4,R6,R8,R9,RC,RD,RF),WORK=R1      @D28ADAP 00586000
.SKIP080 ANOP                                                  @D28ADAP 00587000
         B     AVRUCKD            SET  ======================> @DA44471 00588000
         DROP  R1                 DROP CCB BASE                @D36IDAP 00589000
         DROP  R9                 RELEASE PBXADR BASE          @DBOC    00590000
         TITLE 'VSE SUPERVISOR     SGSER     DASD VOLUME RECOGNOITION ' 00591000
*SGLINK  AVRDSDIO INPUT=(R3,RE)                                @DY46139 00592000
AVRDSDIO DS    0H                 DASD IO PROCESSING           @D68ADAP 00593000
         STM   RE,R1,AVRDSDSV     SAVE CALLERS REGISTERS       @D68ADAP 00594000
         LA    R1,AVRCCB          POINT AT SERVICE TASK CCB    @DA23802 00595000
         USING CCBADR,R1          NEED ADDRESSIBILITY          @D35VDEP 00596000
         LR    RF,R3              GET PUB ADDRESS              @D61ADAP 00597000
         SH    RF,YPUBTAB         OFFSET WITHIN PUB TABLE      @D61ADAP 00598000
         SRL   RF,PUBSLEN         PUB INDEX NOW                @D61ADAP 00599000
         STH   RF,CCBCLS          SAVE PUB INDEX IN CCB        @D61ADAP 00600000
         OI    CCBCLS,CCBPHYAD    SET PHYSICAL ADDRESSING      @D61ADAP 00601000
         XC    SERSNSDT,SERSNSDT  CLEAR SENSE AREA FOR RETRY   @DA23802 00602000
         SYSIO (1)                EXECUTE CHANNEL PROGRAM      @D35VDAP 00603000
         LM    RE,R1,AVRDSDSV     RESTORE CALLERS REGISTERS    @D68ADAP 00604000
         BR    RE                 DONE=======================> @D68ADAP 00605000
         DROP  R1                 RELEASE AVRCCB BASE          @D68ADAP 00606000
AVRDSDSV DC    4F'0'              IO-ROUTINE SAVE AREA                  00607000
         DROP  ,                                                        00608000
         TITLE 'VSE SUPERVISOR     SGSER     TAPE VOLUME RECOGNOITION ' 00609000
         USING SYSS00,R0          LOW-CORE BASE POINTER        @D28ADAP 00610000
         USING RQTE,R2            RQT ENTRY ADDRESS OR ZERO    @DBOC    00611000
         USING PUBADR,R3          PUBADR BASE POINTER          @DBOC    00612000
         USING VCTEADR,R4         VCT-ENTRY BASE POINTER       @DBOC    00613000
         USING DISP,R6            DISPATCHER BASE              @D28ADAP 00614000
         USING PBXADR,R9          PUBX BASE POINTER            @DBOC    00615000
         USING SGSERI,RC          SGSERI BASE POINTER          @D28ADAP 00616000
         USING SERTASK,RD         SGSER BASE                   @D28ADAP 00617000
AVRTAPPR EQU   *                  UPDATE VCT ENTRY             @D35VDEP 00618000
         XC    RQTRDC(L'RQTRDC),RQTRDC FORCE TO ALL ZERO       @DBOC    00619000
         XC    RQTSNID(L'RQTSNID),RQTSNID SNID AREA            @DBOC    00620000
         XC    RQTSNSDT(L'RQTSNSDT),RQTSNSDT CLEAR SNS-DATA    @DBOC    00621000
         MVI   RQTVOL1,ZERO       INVALIDATE VOL1 QUALIFIER    @DBOC    00622000
         MVI   VCTATYPE,VCTATAPE  INDICATE TAPE DEVICE         @D61ADAP 00623000
         NI    VCTAFLAG,XFF-VCTASHR RESET ASSIGNED ELSEWHERE   @D61ADAP 00624000
         CLC   PUBCHANN(2),IJBIJBSD IN USE BY SDAID            @D61ADAP 00625000
         BNE   AVRTAP00           NO,                          @D61ADAP 00626000
         LA    R0,MODVCNOP        NOT OPERATIONAL RETURN CODE  @D61ADAP 00627000
         NI    VCTAFLG,XFF-VCTARDY-VCTAFOP SET NOT OPERATIONAL @D61ADAP 00628000
         OI    VCTAFLAG,VCTANVOL  SET VOL1 INVALID             @D61ADAP 00629000
         NI    VCTAFLAG,XFF-VCTARSV RESET DEVICE RESERVED      @D61ADAP 00630000
         NI    PBXFLAG2,XFF-PBXREADY PREVENT INTERCEPTION      @DA44201 00631000
         B     AVRDCT00                ======================> @D61ADAP 00632000
AVRTAP00 OI    PBXFLAG2,PBXREADY  INDICATE SVT-AVR PROCESSING  @DA44201 00633000
         TM    RQTFLG,RQTREADY    READY PROCESSING             @DBOC    00634000
         BZ    AVRTAP05           NO, ITS A MODVCE REQUEST     @DBOC    00635000
         TM    VCTAPROC,VCTAUASN  READIED AS RESULT OF UNASSGN @DBOC    00636000
         BO    AVRTUAPR           YES, ======================> @DBOC    00637000
         B     AVRTAP10           NO,                          @DY45540 00638000
AVRTAP05 DS    0H'0'              MODVCE PROCESSING            @DBOC    00639000
         AGO   .SKIP100                                                 00640000
         CLI   RQTOPCMD,RQTOPPLF  IS THIS A PLF COMMAND        @D3570   00641000
         BE    AVRTSP40           YES,                         @D3570   00642000
.SKIP100 ANOP                                                           00643000
         CLI   RQTOPCMD,RQTOPRUN  HAS UNLOAD BEEN REQUESTED    @D61ADAP 00644000
         BE    AVRTSP00           YES, DO THE UNLOAD           @DBOC    00645000
AVRTAP10 TM    PBXFLAG2,PBXNOSIO  CHARACTERISTICS TO BE UPDATED@D61ADAP 00646000
         BZ    AVRTAP30           NO,                          @D61ADAP 00647000
         LA    RF,AVRTCCW1+8      POINT TO SNSID COMMAND       @D68ADAP 00648000
         TM    PBXTREC,PBXTCTG    CARTRIDGE DEVICE             @D68ADAP 00649000
         BZ    AVRTAP15           NO,                          @D68ADAP 00650000
         ICM   RF,15,PBXLBINF     IS A LIBRARY PRESENT         @D68ADAP 00651000
         BZ    AVRTAP12           NO, JOIN MAIN LINE           @D68ADAP 00652000
         USING TLMADR,RF          TLMADR BASE POINTER          @D68ADAP 00653000
         TM    TLMLBCTL,TLMLCDD   IS DEVICE LCDD-CONTROLLED    @D68ADAP 00654000
         BO    AVRPSF60           YES, SUPPRESS UNSOL.ATTENT   @D68ADAP 00655000
         DROP  RF                 RELEASE TLMADR BASE          @D68ADAP 00656000
AVRTAP12 LA    RF,AVRTCCW1        RDC+SNSID+NOP+SNS CHAIN OR,  @D68ADAP 00657000
AVRTAP15 BAL   RE,TAPIORTN        SNSID+NOP+SNS CHAIN          @D68ADAP 00658000
*SGLINK  TAPIORTN INPUT=(R2,R4,R9,RE,RF),OUTPUT=R0             @D68ADAP 00659000
         B     AVRTAP20         0 O.K RETURN                   @D61ADAP 00660000
         LA    RE,MODVCNOP      4 DEVICE NOT OPERATIONAL COND. @D61ADAP 00661000
         CLR   R0,RE              IS DEVICE OPERATIONAL        @D61ADAP 00662000
         BNE   AVRTAP20           YES, PROCEED                 @D61ADAP 00663000
         NI    VCTAFLAG,XFF-VCTARSV RESET DEVICE RESERVED      @D61ADAP 00664000
         BAL   RE,AVRUTAPE        UPDATE VCTE AND PUBX INFO    @DA44471 00665000
*SGLINK  AVRUTAPE,INPUT=(R2,R3,R4,R9,RC,RD,RE),WORK=(R5,R8)    @DA44471 00666000
         B     AVRUTXIT                ======================> @DA44471 00667000
AVRTAP20 DS    0H'0'                                                    00668000
         BAL   RE,AVRUTAPE        UPDATE VCTE AND PUBX INFO    @DA44471 00669000
*SGLINK  AVRUTAPE,INPUT=(R2,R3,R4,R9,RC,RD,RE),WORK=(R5,R8)    @DA44471 00670000
AVRTAP30 DS    0H'0'              CHECK IF WE NEED TO ASSGN    @D61ADAP 00671000
         TM    PBXFLAG2,PBXNOASS  ASSGN TO BE BYPASSED         @D61ADAP 00672000
         BO    AVRTAP35           YES,                         @D61ADAP 00673000
         L     R8,AAVRASNP        GET ROUTINE ADDRESS          @D68ADAP 00674000
         USING AVRASNPR,R8        SUBROUTINE BASE              @D68ADAP 00675000
         BAL   RE,AVRASNPR        DO ASSGN PROCESSING          @D68ADAP 00676000
*SGLINK  AVRASNPR INPUT=(R2,R3,R4,R8,R9,RE),WORK=(R0,R1)       @D68ADAP 00677000
         DROP  R8                 RELEASE AVRASNPR  BASE       @D68ADAP 00678000
AVRTAP35 TM    VCTTFS21,VCTTMSET  IS MODE-SET/SENSE SUPPORTED  @D63TAAP 00679000
         BO    AVRTPAPR           YES, DO DCP-PROCESSING       @D63TAAP 00680000
AVRTAP40 NI    VCTAPROC,XFF-VCTAPWTD RESET WORK TO DO FLAG     @DBOC    00681000
         LA    RF,AVRTCCW2        NOP+SNS           CHAIN      @D61ADAP 00682000
         BAL   RE,TAPIORTN        NOP+SNS                      @D61ADAP 00683000
*SGLINK  TAPIORTN INPUT=(R2,R4,R9,RE,RF),OUTPUT=R0             @D68ADAP 00684000
         B     AVRTAP50         0 O.K RETURN                   @D61ADAP 00685000
         LTR   R0,R0            4 PERMANENT ERROR              @D61ADAP 00686000
         BNZ   AVRTAP95           YES,                         @D61ADAP 00687000
AVRTAP50 TM    VCTAPROC,VCTAPWTD  ANOTHER 'READY' RECEIVED     @DBOC    00688000
         BO    AVRTAP40           YES, GET LATEST STATUS       @DBOC    00689000
         OI    VCTAFLG,VCTAFOP+VCTARDY TAPE OPERATIONAL+READY  @D61ADAP 00690000
         LA    R0,MODVCEOK        SET OK RETURN CODE           @D61ADAP 00691000
*          AIF   (NOT &VSE270).N280040                         @DWORM   00692490
           CLI   PUBDEVTY,TTPA    IS THIS A TPA DEVICE         @DWORM   00693000
           BNE   AVRTAP60         NO,                          @DWORM   00694000
           L     R8,AAVRMESN      GET ROUTINE ADDRESS          @DWORM   00695000
           USING AVRMESNPR,R8     SUBROUTINE BASE              @DWORM   00696000
           BAL   RE,AVRMESNPR     ISSUE MEDIA-SENSE COMMAND    @DWORM   00697000
           TM    VCTAPROC,VCTAPWTD  ANOTHER 'READY' RECEIVED   @DWORM   00698000
           BZ    AVRLDSP          NO, PREPARE LDSP MESSAGES    @DWORM   00699000
           B     AVRTAP40         YES, GET LATEST STATUS       @DWORM   00700000
           DROP  R8               RELEASE AVRMESNPR BASE       @DWORM   00701000
.N280040 ANOP                                                           00702490
AVRTAP60 TM    PBXFLAG2,PBXNOSVT  AVR INHIBITED                @D61ADAP 00703000
         BO    AVRNOSVT           YES,                         @DA43697 00704000
         TM    RQTSNSDT+1,X'08'   TAPE AT LOAD POINT           @DBOC    00705000
         BZ    AVRTAP95           NO,                          @D61ADAP 00706000
.*                                                             @D61ADAP 00707000
.*       PREPARE LOAD-DISPLAY MESSAGE                          @D61ADAP 00708000
.*                                                             @D61ADAP 00709000
AVRLDSP  L     R8,ASERILDS        GET ROUTINE ADDRESS          @D68ADAP 00710000
         USING SERILDSP,R8        SUBROUTINE BASE              @D68ADAP 00711000
         BAL   RE,SERILDSP        PREPARE LDSP MESSAGE         @D68ADAP 00712000
*SGLINK  SERILDSP INPUT=(R2,R3,R4,R8,R9,RC,RE),WORK=(R0,R1,RF) @D68ADAP 00713000
         OI    VCTAFLAG,VCTANVOL  SET VOLID INVALID FOR NOW    @D61ADAP 00714000
         DROP  R8                 RELEASE SERILDSP BASE        @D68ADAP 00715000
*        AIF   (NOT &VSE270).N280060                           @DWORM   00716490
         CLC   CVOL1,RQTVOL1      IS VOL1 LABEL ALREADY PRESENT@DWORM   00717000
         BE    AVRTAP80           YES, MESN PROVIDED THE DATA  @DWORM   00718000
.N280060 ANOP                                                           00719490
         TM    RQTSNSDT+1,X'08'   TAPE AT LOAD POINT           @DWORM   00720000
         BZ    AVRTAP95           NO,                          @DWORM   00721000
         LA    RF,AVRTCCW3        READ+REW           CHAIN     @D61ADAP 00722000
         BAL   RE,TAPIORTN        READ+REW  OR REW             @D61ADAP 00723000
*SGLINK  TAPIORTN INPUT=(R2,R4,R9,RE,RF),OUTPUT=R0             @D68ADAP 00724000
         B     AVRTAP70         0 O.K RETURN                   @D61ADAP 00725000
         LTR   R0,R0            4 PERMANENT ERROR              @D61ADAP 00726000
         BNZ   AVRTAP95           YES,                         @D61ADAP 00727000
         BAL   RE,AVRTAPE0        PROVIDE ERROR MSG FOR DSPLY  @D61ADAP 00728000
AVRTAP70 CLC   CVOL1,RQTVOL1      WAS A VOL1 LABEL READ        @DBOC    00729000
         BE    AVRTAP80           YES,                         @D61ADAP 00730000
.*                                                             @D61ADAP 00731000
.*       CHECK FOR AN ANSI TAPE LABEL                          @D61ADAP 00732000
.*                                                             @D61ADAP 00733000
         L     RE,RASLINKA+4      GET ASCII TABLE ADDRESS      @D61ADAP 00734000
         LTR   RE,RE              IS ASCII TABLE PRESENT       @D61ADAP 00735000
         BZ    AVRTAP90           NO,                          @D28ADAP 00736000
         TR    RQTVOL1(L'RQTVOL1),0(RE) TRANSLATE TO EBCDIC    @DBOC    00737000
         CLC   CVOL1,RQTVOL1      WAS A VOL1 LABEL READ        @DBOC    00738000
         BNE   AVRTAP90           NO,                          @D28ADAP 00739000
         TM    IJBAIDID,X'80'     DID USER REQUEST JOB NAME    @DA44471 00740000
         BO    AVRTAP85           YES,                         @DA44471 00741000
         MVI   RQTTMSG1+7,C'A'    INDICATE ANSI TAPE           @DBOC    00742000
         B     AVRTAP85                                        @D61ADAP 00743000
AVRTAP80 TM    IJBAIDID,X'80'     DID USER REQUEST JOB NAME    @DA44471 00744000
         BO    AVRTAP85           YES,                         @DA44471 00745000
         MVI   RQTTMSG1+7,C'S'    INDICATE STANDARD LABEL      @DBOC    00746000
AVRTAP85 NI    VCTAFLAG,XFF-VCTANVOL SET VOL1 VALID            @DA43487 00747000
         MVC   RQTTMSG1(6),RQTSVOL MOVE VOLID TO MESSAGE       @DBOC    00748000
         CLC   VCTAVOL1,RQTSVOL   WAS VOLUME CHANGED           @DBOC    00749000
         BE    AVRTAP90           NO,                          @DA43487 00750000
         MVC   AVRSVOL(6),RQTSVOL SET  VOLID FOR AVRDUPCH      @DBOC    00751000
         BAL   RE,AVRDUPCH        MARK DEVICES WITH SAME VOLID @D61ADAP 00752000
*SGLINK  AVRDUPCH INPUT=(R4,RC,RE),WORK=(R1,RF)                @D28ADAP 00753000
         MVC   VCTAVOL1,RQTSVOL   SAVE VOLID IN VCT ENTRY      @D28ADAP 00754000
AVRTAP90 TM    VCTTFEAD,VCTTFMDF  MESSAGE DISPLAY FACILITY     @D62TAAP 00755000
         BZ    AVRTAP95           NO, IS NOT PRESENT           @DA44471 00756000
         LA    RF,AVRTCCW5        LDSP               CCW       @D61ADAP 00757000
         BAL   RE,TAPIORTN        LDSP                         @D61ADAP 00758000
*SGLINK  TAPIORTN INPUT=(R2,R4,R9,RE,RF),OUTPUT=R0             @D68ADAP 00759000
         B     AVRTAP95         0 O.K RETURN                   @D61ADAP 00760000
AVRTAP95 TM    RQTFLG,RQTREADY  4 WAS THIS "READY" PROCESSING  @D61ADAP 00761000
         BO    AVRUTXIT           YES, ======================> @D61ADAP 00762000
.*                                                                      00763000
.* EXECUTE SPECIAL MODVCE REQUESTS                                      00764000
.*                                                                      00765000
AVRTSP00 DS    0H'0'              SPECIAL TAPE REQUESTS                 00766000
         CLI   RQTOPCMD,0         SPECIAL COMMAND REQUIRED     @D61ADAP 00767000
         BE    AVRTSPC0           NO,                          @D61ADAP 00768000
.*                                                                      00769000
.*       MTC=RUN                                                        00770000
.*                                                                      00771000
         CLI   RQTOPCMD,RQTOPRUN  HAS A RUN BEEN REQUESTED     @D61ADAP 00772490
         BNE   AVRPSF20           NO,                          @D61ADAP 00773000
         BAL   RE,AVRUTAPE        UPDATE VCTE AND PUBX INFO    @DBOC    00774000
*SGLINK  AVRUTAPE,INPUT=(R2,R3,R4,R9,RC,RD,RE),WORK=(R5,R8)    @DA44471 00775000
         NI    RQTCCB+2,XFF-POSTDE RESET POST AT DE BIT        @DAOM123 00776000
         LA    RF,AVRTCCW7        RUN                CCW       @D61ADAP 00777000
         TM    PBXTFLG1,PBXTNUNL  USER WANTS UNL=REW           @DAOM053 00778000
         BO    AVRTSP20           YES,                         @DAOM053 00779000
         TM    SYSFLAG2,IJBNOUNL  USER REQUESTS UNL=REW        @D61ADAP 00780000
         BZ    AVRTSPA0           NO, EXECUTE REWIND/UNLOAD    @D61ADAP 00781000
AVRTSP20 LA    RF,AVRTCCW4        YES, DO REWIND ONLY          @D61ADAP 00782000
         B     AVRTSPA0                                        @D61ADAP 00783000
.*                                                                      00784000
.*       MTC=AAC/DAC (VIA PSF COMMAND)                                  00785000
.*                                                                      00786000
AVRPSF20 LA    RF,AVRTCCW6        PSF AAC/DAC COMMAND          @D61ADAP 00787000
         MVI   7(RF),4            ASSUME FOUR BYTES OPERAND    @D68ADAP 00788000
         XC    RQTACBUF,RQTACBUF  CLEAR PSF ACC BUFFER         @D68ADAP 00789000
         MVI   RQTACBUF+2,X'80'   INDICATE LOGICAL WRITE PROT. @D68ADAP 00790000
         CLI   RQTOPCMD,RQTOPAAC  IS THIS AAC REQUEST          @D61ADAP 00791000
         BNE   AVRPSF40           NO,                          @D61ADAP 00792000
         MVI   RQTACBUF,X'82'     ORDER = ACTIVATE ACC.CONTROL @D61ADAP 00793000
         B     AVRTSPA0           YES,                         @D61ADAP 00794000
AVRPSF40 CLI   RQTOPCMD,RQTOPDAC  IS THIS AAC REQUEST          @D61ADAP 00795000
         BNE   AVRTSPA0           VERY STRANGE                 @D61ADAP 00796000
         MVI   RQTACBUF,X'83'     ORDER = DEACTIV. ACC.CONTROL @D61ADAP 00797000
         B     AVRTSPA0                                                 00798000
         AIF   (NOT &VSE270).N270040                                    00798500
AVRPSF60 LA    RF,AVRTCCW6        PSF SAS COMMAND              @D68ADAP 00799000
         MVI   7(RF),8            ASSUME EIGHT BYTES OPERAND   @D68ADAP 00800000
         XC    RQTACBUF,RQTACBUF  CLEAR PSF ACC BUFFER         @D68ADAP 00801000
         MVI   RQTACBUF,X'1E'     ORDER = SUPPRESS ATTENTION   @D68ADAP 00802000
         MVI   RQTACBUF+6,X'10'   DISABLE ALL NOTIFICATION     @D68ADAP 00803000
         BAL   RE,TAPIORTN        ENSURE ATTENTION SUPPRESSION @D68ADAP 00804000
*SGLINK  TAPIORTN INPUT=(R2,R4,R9,RE,RF),OUTPUT=R0             @D68ADAP 00805000
         B     AVRTAP12         0 O.K RETURN                   @D68ADAP 00806000
         B     AVRTAP12         4 DEVICE NOT OPERATIONAL COND. @D68ADAP 00807000
.N270040 ANOP                                                           00807500
         AGO   .SKIP120                                                 00808000
.*                                                                      00809000
.*       MTC=PLF                                                        00810000
.*                                                                      00811000
AVRTSP40 DS    0H'0'                                                    00812000
         L     RF,RQTPLFAD        GET PARAMETER LIST ADDRESS   @D3570   00813000
         USING MAPPLF,RF          MAPPLF BASE POINTER          @D3570   00814000
         MVC   RQTTMSG1(6),PLFVOL1 SAVE VOL1 LABEL IN MESSAGE  @D3570   00815000
         MVI   RQTTMSG1+6,C' '    FORCE A BLANK                @D3570   00816000
         MVI   RQTTMSG1+7,C'M'    INDICATE MOUNT PENDING       @D3570   00817000
         MVI   RQTTMSGP,X'40'     MOUNT DISPLAY                @D3570   00818000
         OI    PBXFLAG2,PBXMTFLG  INDICATE MOUNT PENDING       @D3570   00819000
         DROP  RF                 RELEASE MAPPLF BASE          @D3570   00820000
         LA    RF,AVRTCCWB        LDSP MOUNT CCW (3570)        @D3570   00821000
         BAL   RE,TAPIORTN        LDSP                         @D3570   00822000
*SGLINK  TAPIORTN INPUT=(R2,R4,R9,RE,RF),OUTPUT=R0             @D3570   00823490
         LA    RF,0             0 INDICATE MOUNT IN PROGRESS   @D3570   00824000
         NOP   AVRTSP60         4 ERR, ======================> @D3570   00825000
AVRTSP60 NI    PBXFLAG2,XFF-PBXREADY INDICATE SVT TASK IS DONE @D3570   00826000
         BR    R7                 RETURN TO CALLER             @D3570   00827000
.SKIP120 ANOP                                                           00828000
.*                                                                      00829000
.*       EXECUTE I/O                                                    00830000
.*                                                                      00831000
AVRTSPA0 BAL   RE,TAPIORTN        EXECUTE COMMAND              @D61ADAP 00832000
*SGLINK  TAPIORTN INPUT=(R2,R4,R9,RE,RF),OUTPUT=R0             @D68ADAP 00833000
         B     AVRTSPB0         0 O.K RETURN                   @D61ADAP 00834000
         LTR   R0,R0            4 PERMANENT ERROR CONDITION    @D61ADAP 00835000
         BNZ   AVRTSPC0           YES,                         @D61ADAP 00836000
AVRTSPB0 CLI   RQTOPCMD,RQTOPRUN  HAVE WE JUST ISSUED RUN      @D61ADAP 00837000
         BNE   AVRTSPC0           NO,                          @D61ADAP 00838000
         LA    RF,AVRTCCW2        NOP+SNS           CHAIN      @D61ADAP 00839000
         BAL   RE,TAPIORTN        NOP+SNS                      @D61ADAP 00840000
*SGLINK  TAPIORTN INPUT=(R2,R4,R9,RE,RF),OUTPUT=R0             @D68ADAP 00841000
         NOP   AVRTSPC0         0 O.K RETURN                   @D61ADAP 00842000
         B     AVRTUAPR         4 GET DEVICE UNASSGNED         @DY45629 00843000
AVRTSPC0 TM    RQTFLG,RQTOPRLS    IS DEVICE TO BE RELEASED     @D61ADAP 00844000
         BZ    AVRUTXIT           NO,  ======================> @DA44471 00845000
         B     AVRTUAPR           GET DEVICE UNASSGNED         @DAOM    00846000
         AGO   .SKIP140                                                 00847000
         LR    R0,R3              COPY PUB POINTER             @D61ADAP 00848000
         SH    R0,YPUBTAB         PUB OFFSET                   @D61APAP 00849000
         SRL   R0,3               PUB INDEX                    @D61ADAP 00850000
*        GETFLD FIELD=OWNER,PU=(0) GET OWNERSHIP               @D61ADAP 00851000
         GETFLD FIELD=OWNER,PU=(0) GET OWNERSHIP               @D61ADAP 00852000
         LTR   RF,RF              DOES OWNER EXIST             @D61ADAP 00853000
         BNZ   AVRTSPD0           YES, DO NOT UNASSGN DEVICE   @D61ADAP 00854000
         LA    RF,AVRTCCW9        UNA                CCW       @D61ADAP 00855000
         BAL   RE,TAPIORTN        UNASSIGN THE DEVICE          @D61ADAP 00856000
*SGLINK  TAPIORTN INPUT=(R2,R4,R9,RE,RF),OUTPUT=R0             @D68ADAP 00857000
         B     AVRTSPD0         0 O.K RETURN                   @D61ADAP 00858000
         B     AVRUTXIT         4 ERR  ======================> @DA44471 00859000
AVRTSPD0 NI    VCTAFLAG,XFF-VCTARSV RESET DEVICE RESERVED BIT  @D61ADAP 00860000
         OI    PBXFLAG2,PBXNOVOL  INDICATE NOT OWNED VOLUME    @D61ADAP 00861000
         B     AVRUTXIT                ======================> @DA44471 00862000
.SKIP140 ANOP                                                           00863000
         SPACE 3                                                        00864000
AVRNOSVT DS    0H'0'                                           @DA43697 00865000
         BAL   RE,RMSGETP2        GET PUB2 ADDRESS             @DA43697 00866000
*SGLINK  RMSGETP2,INPUT=(R3,R6,RE),OUTPUT=R8,WORK=RB           @DA43697 00867000
         USING PUB2ADR,R8                                      @DA43697 00868000
         OI    VCTAFLAG,VCTANVOL  SET VOLID INVALID FOR NOW    @D28ADAP 00869000
         CLI   P2TVOL,C' '        IS VOLID PRESENT             @D28ADAP 00870000
         BNH   AVRTAP95           NO,                          @DA43697 00871000
         MVC   RQTSVOL(6),P2TVOL  MOVE VOLID FOR TAPE MSG      @DBOC    00872000
         MVC   VCTAVOL1,P2TVOL    MOVE VOL1 LABEL              @DA43697 00873000
         NI    VCTAFLAG,XFF-VCTANVOL SET VOL1 VALID            @DA43697 00874000
         B     AVRTAP95                                        @DA43697 00875000
         DROP  R8                 RELEASE PUB2 BASE POINTER    @DA43697 00876000
         SPACE 3                                                        00877000
AVRTPAPR DS    0H'0'              TPA SPECIFIC PROCESSING      @D63TAAP 00878000
*        TM    PBXFLAG2,PBXNOSIO  CHARACTERISTICS TO BE UPDATED@DY46564 00879590
*        BZ    AVRTAP40           NO,                          @DY46564 00880180
         XC    RQTDCPGE(L'RQTDCPGE),RQTDCPGE CLEAR OLD SETTING @D63TAAP 00881000
         MVI   RQTDCPGE,X'05'     FUNCTION=RESET ALL PAGES     @D63TAAP 00882000
         LA    RF,AVRTCCWA        MOS CCW                      @D63TAAP 00883000
         BAL   RE,TAPIORTN        MODE SET                     @D63TAAP 00884000
*SGLINK  TAPIORTN INPUT=(R2,R4,R9,RE,RF),OUTPUT=R0             @D68ADAP 00885000
         B     AVRTPA10        0  O.K. RETURN                  @D63TAAP 00886000
         B     AVRTPA30        4  OOPS                         @D63TAAP 00887000
AVRTPA10 DS    0H'0'                                           @D63TAAP 00888000
         MVC   RQTDCPGE(L'RQTDCPGE),MODEDFLT USE DEFAULTS      @DBOC    00889000
         TM    IJBAIDID,X'40'     WTM=NOSYNC WRITE BUFFERED TM @DY45817 00890000
         BZ    AVRTPA20           NO, WTM=SYNC                 @DY45817 00891000
         MVI   RQTDCPGE+6,ZERO    ALLOW FOR BUFFERED TM WRITE  @DY45817 00892000
AVRTPA20 BAL   RE,TAPIORTN        MODE SET                     @DY45817 00893000
*SGLINK  TAPIORTN INPUT=(R2,R4,R9,RE,RF),OUTPUT=R0             @D68ADAP 00894000
         B     AVRTPA30        0  O.K. RETURN                  @D63TAAP 00895000
         B     AVRTPA30        4  OOPS                         @D63TAAP 00896000
AVRTPA30 DS    0H'0'                                           @D63TAAP 00897000
         B     AVRTAP40                ======================> @D63TAAP 00898000
.*                                                             @D61ADAP 00899000
.*       FAILURE WHEN TRYING TO READ VOL1 LABEL                @D61ADAP 00900000
.*                                                             @D61ADAP 00901000
         TITLE 'VSE SUPERVISOR     SGSER     ANALYSE TAPE ERROR       ' 00902000
AVRTAPE0 ST    RE,AVRTAERE        SAVE LINK REGISTER           @D61ADAP 00903000
         MVC   RQTTMSG1(8),AVRTRERR INDICATE READ ERROR        @DBOC    00904000
         MVI   RQTTMSGP,0         DISPLAY UNTIL TAPE MOVES     @DBOC    00905000
         TM    4(RF),CC           WAS THIS ALREADY THE REWIND  @D61ADAP 00906000
         BZ    AVRTAPF0           YES,                         @D61APAP 00907000
         LA    RF,8(,RF)          ADVANCE TO REW CCW           @D61ADAP 00908000
         BAL   RE,TAPIORTN        REWIND                       @D61ADAP 00909000
*SGLINK  TAPIORTN INPUT=(R2,R4,R9,RE,RF),OUTPUT=R0             @D68ADAP 00910000
         B     AVRTAPFX          0 O.K  =====================> @D61ADAP 00911000
         TM    PBXFLAG3,PBXTERP1 4 DOES TAPE RECOGNIZE VOID    @DA44241 00912000
         BO    AVRTAPF0           YES,                         @D62TAAP 00913000
.*       ASSUME TAPE BECAME UNREADY DUE TO NO DATA ON TAPE     @D61ADAP 00914000
.*       CAN ONLY HAPPEN ON BRAND NEW TAPES                    @D61ADAP 00915000
         OI    PBXFLAG2,PBXNOSVT  DONT DO AVR ANY LONGER       @D61ADAP 00916000
AVRTAPF0 LTR   R0,R0              ANY PERMANENT ERROR          @D61ADAP 00917000
         BNZ   AVRTAPFX           YES, LEAVE SETTING AS IT IS  @D61ADAP 00918000
         LA    R0,MODVCEER        NO, SOME OTHER I/O ERROR     @D61ADAP 00919000
         OI    VCTAFLAG,VCTANVOL  SET VOL1 INVALID             @D61ADAP 00920000
         XC    VCTAVOL1,VCTAVOL1  INVALIDATE VOLID IN TABLE    @D61ADAP 00921000
AVRTAPFX L     RE,AVRTAERE        RESTORE LINK REGISTER        @D61ADAP 00922000
         BR    RE                 O.K  ======================> @D61ADAP 00923000
AVRTAERE DC    F'0'               LINK REGISTER SAVE AREA      @D61ADAP 00924000
         TITLE 'VSE SUPERVISOR     SGSER     UNASSGN DEVICE PROCESSING' 00925000
AVRTUAPR DS    0H'0'                                           @D61ADAP 00926000
         NI    VCTAPROC,XFF-VCTAUASN RESET FUNCTION INDICATION @D61ADAP 00927000
         NI    VCTAFLAG,XFF-VCTARSV RESET DEVICE RESERVED BIT  @D61ADAP 00928490
         LR    RE,R0              SAVE RETURN CODE             @DY45540 00929000
         LR    R0,R3              COPY PUB POINTER             @D61ADAP 00930000
         SH    R0,YPUBTAB         PUB OFFSET                   @D61APAP 00931000
         SRL   R0,3               PUB INDEX                    @D61ADAP 00932000
*        GETFLD FIELD=OWNER,PU=(0) GET OWNERSHIP               @D61ADAP 00933000
         GETFLD FIELD=OWNER,PU=(0) GET OWNERSHIP               @D61ADAP 00934000
         LR    R0,RE              RESTORE RETURN CODE          @DY45540 00935000
         LTR   RF,RF              DOES OWNER EXIST             @D61ADAP 00936000
         BNZ   AVRTUA70           YES, DO READY PROCESSING     @D61ADAP 00937000
         AGO   .SKIP160                                                 00938590
         ICM   RF,15,PBXSIMID     IS THIS A VIRTUAL TAPE       @DY46314 00939180
         BZ    AVRTUA40           NO,                          @D66ADAP 00940000
         USING TACNTADR,RF        TAPE-CONTROL BLOCK BASE      @D66APAP 00941000
         L     RE,AAVRTUA1        GET 31-BIT ADDRESS           @D66ADAP 00942000
         BSM   0,RE               GO INTO 31-BIT MODE          @D66ADAP 00943000
AAVRTUA1 DC    A(AVRTUA20+X'80000000')                         @D66ADAP 00944000
AVRTUA20 TM    TACNSNS+1,X'02'    IS WRITE INHIBITED           @D66ADAP 00945000
         LA    RF,AVRTUA30        BACK INTO 31-BIT MODE        @D66ADAP 00946490
         DROP  RF                 RELEASE TACNTADR BASE        @D66ADAP 00947000
         BSM   0,RF               GET BACK INTO 24-BIT MODE    @D66ADAP 00948000
AVRTUA30 BO    AVRTUA40           YES, NO NEED TO SYNC         @D66ADAP 00949000
         LA    RF,AVRTCCWC        SYNCHRONIZE        CCW       @D66ADAP 00950000
         BAL   RE,TAPIORTN        FORCE SYNCHRONISATION        @D66ADAP 00951000
*SGLINK  TAPIORTN INPUT=(R2,R4,R9,RF),OUTPUT=R0                @D68ADAP 00952000
         B     AVRTUA40         0 CLEAR JOBNAME FROM DISPLAY   @D66ADAP 00953000
         NOP   AVRTUA40         4 ERROR EXIT                   @D66ADAP 00954000
.SKIP160 ANOP                                                           00955490
AVRTUA40 TM    VCTTFEAD,VCTTFMDF  MESSAGE DISPLAY FACILITY     @D66ADAP 00956000
         BZ    AVRTUA50           NO, NOT PRESENT              @D66ADAP 00957000
         TM    IJBAIDID,X'80'     DID USER REQUEST JOB NAME    @DA44471 00958000
         BZ    AVRTUA50           NO,                          @DA44471 00959000
         MVI   RQTTMSGP,X'20'     NORMAL DISPLAY MODE          @DBOC    00960000
         TM    VCTAFLAG,VCTANVOL  IS VOLID INVALID             @DY46187 00961000
         BO    AVRTUA45           YES, DO NOT SHOW PREVIOUS    @DY46187 00962000
         MVC   RQTTMSG1(6),VCTAVOL1 MOVE VOLID TO MESSAGE      @DBOC    00963000
AVRTUA45 MVI   RQTTMSG1+7,C'U'    INDICATE UNASSIGNED          @DY46187 00964000
         MVC   RQTTMSG2(8),AVRTINTV RESET JOB NAME             @DBOC    00965000
         LA    RF,AVRTCCW5        LDSP               CCW       @DA44471 00966000
         BAL   RE,TAPIORTN        LDSP                         @DA44471 00967000
*SGLINK  TAPIORTN INPUT=(R2,R4,R9,RE,RF),OUTPUT=R0             @D68ADAP 00968000
         B     AVRTUA50         0 CLEAR JOBNAME FROM DISPLAY   @DA44471 00969000
         B     AVRTUA50         4 ERROR EXIT                   @DA44471 00970000
AVRTUA50 TM    PBXFLAG2,PBXNOASS  UNASSGN TO BE BYPASSED       @D61ADAP 00971000
         BO    AVRTUA60           YES, DO READY PROCESSING     @D61ADAP 00972000
         TM    PBXFLAG3,PBXONHLD  UNASSGN TO BE BYPASSED       @DA44841 00973000
         BO    AVRTUA60           YES, DO READY PROCESSING     @DA44841 00974000
         LA    RF,AVRTCCW9        UNA                CCW       @D61ADAP 00975000
         BAL   RE,TAPIORTN        UNASSIGN THE DEVICE          @D61ADAP 00976000
*SGLINK  TAPIORTN INPUT=(R2,R4,R9,RE,RF),OUTPUT=R0             @D68ADAP 00977000
         B     AVRTUA60         0 O.K RETURN                   @D61ADAP 00978000
         B     AVRTUA60         4 ERR                          @D61ADAP 00979000
AVRTUA60 OI    PBXFLAG2,PBXNOVOL  INDICATE NOT OWNED VOLUME    @D61ADAP 00980000
         CLI   PUBCHQPT,NOTQUED   IS REQUEST QUEUED TO PUB     @D61ADAP 00981000
         BE    AVRTUA80           NO,                          @D61ADAP 00982000
AVRTUA70 OI    SERFLGPR,SERDORDY  WE NEED TO DO READY PROCESS. @D61ADAP 00983000
         OI    VCTAPROC,VCTAPWTD  TABLE ENTRY MUST BE UPDATED  @D61ADAP 00984000
         B     AVRDCT00                ======================> @D61ADAP 00985000
AVRTUA80 NI    PBXFLAG2,XFF-PBXREADY PREVENT INTERCEPTION      @D51GDAP 00986000
         B     AVRDCT00                ======================> @D61ADAP 00987000
         TITLE 'VSE SUPERVISOR     SGSER     SET UP DCT ENTRY FOR TAPE' 00988000
*                                                              @D51GDAP 00989000
*        TAPE VOLUME RECOGNITION PROCESSING                    @D51GDAP 00990000
*                                                              @D51GDAP 00991000
*SGLINK  AVRUTAPE,INPUT=(R2,R3,R4,R9,RC,RD,RE),WORK=(R5,R8)    @DA44471 00992000
AVRUTAPE TM    PBXFLAG2,PBXNOSIO  VALID CHARACTERISTICS EXISTS @D21LDAP 00993000
         BZR   RE                 YES, ======================> @DA44471 00994000
         ST    R4,PBXVCTE         SAVE VCTE ENTRY ADDRESS      @D61ADAP 00995000
         MVC   RQTOTAPE,RDCOTAPE  COPY DEFAULT SETTING FOR NOW @DBOC    00996000
         MVC   VCTAPUBC,PUBDEVTY  SET PUB DEVICE TYPE IN DCT   @D21LDRP 00997000
         MVC   VCTAEXTC(6),CTAPE  USE CONSTANT FOR NOW         @D52VDAP 00998000
         MVC   RQTOTAPE+VCTTMDR-VCTTADR(1),PBXMDR SET MDR      @D62TAAP 00999000
         MVC   RQTOTAPE+VCTTOBR-VCTTADR(1),PBXOBR+1 SET OBR    @D62TAAP 01000000
         OI    VCTAFLAG,VCTAREMV  INDICATE REMOVABLE MEDIA     @D21LDAP 01001000
         BAL   R8,AVRUPUBX        FILL-IN PUBX INFORMATION     @D52WDAP 01002000
*SGLINK  AVRUPUBX,INPUT=(R2,R8,R9,RC),WORK=R5                  @DAMO014 01003000
         B     AVRUTA10                0 NO SNSID INFO PRESENT @D52WDAP 01004000
         NOP   0                       4 NO RCD CIW  PRESENT   @D52WDAP 01005000
         UNPK  SERIWORK(7),RQTDEVCD(4) 8 GET EXT DEV CODE PRINT@DBOC    01006000
         TR    SERIWORK(6),HEXCHTAB-X'F0' MAKE IT HEX CHARACT. @D62TAAP 01007000
         MVC   VCTAEXTC(6),SERIWORK SET EXTERNAL DEVICE CODE   @D62TAAP 01008000
         MVC   RQTOTAPE+VCTTCUTY-VCTTADR(6),RQTSNID+1 SET INFO @DBOC    01010000
AVRUTA10 MVC   VCTTADR(VCTTRDCL-VCTTADR+VCTEADR),RQTOTAPE COPY @DY46120 01011000
         MVC   VCTTDCLS(2),PBXOBR SET DEVICE CLASS AND TYPE    @DY46120 01012490
         OC    RQTRDC(L'RQTRDC),RQTRDC ANY RDC DATA READ       @DBOC    01013000
         BZ    AVRUTA20           NO, STICK WITH THE DEFAULTS  @D21LDRP 01014000
*HERE    WE WANT THE REAL DEVICE INFORMATION (IF AVAILABLE)    @DY46071 01015000
         MVC   VCTTADR(VCTTRDCL-VCTTADR+VCTEADR),RQTRDC RDC DAT@DY46120 01016000
         OC    VCTTEMCU,VCTTEMCU  IS DEVICE EMULATION ACTIVE   @DY46071 01017000
         BZ    AVRUTA15           NO,                          @DY46071 01018000
         MVC   VCTTCUTY(6),VCTTEMCU USE EMULATED CODE INSTEAD  @DY46071 01019000
AVRUTA15 MVC   PBXMDR(1),VCTTMDR  SAVE REAL MDR DATA IN PUBX   @D62TAAP 01020000
         MVC   PBXOBR+1(1),VCTTOBR SAVE REAL OBR DATA IN PUBX  @D62TAAP 01021000
         MVC   PBXTSPEC(2),VCTTFEAS REAL SUBSYSTEM FACILITIES  @D62TAAP 01022000
         ICM   R8,15,PBXLBINF     GET LIBRARY EXTENTION POINTER@D61ADAP 01023000
         BZ    AVRUTA20           DOES NOT EXIST               @D61ADAP 01024000
         USING TLMADR,R8          LIBRARY EXTENTION BASE       @D61ADAP 01025000
         MVC   TLMLSEQ(4),VCTTLSEQ SEQUENCE NUMBER + SSID      @D62TAAP 01026000
         CLI   TLMLNAME,C' '      IS LIBNAME ALREADY KNOWN     @DGA270  01027000
         BH    AVRUTA20           YES, LEAVE IT UNCHANGED      @DGA270  01028000
         UNPK  SERIWORK(9),VCTTLSEQ(5) UNPAK SEQ.NO+SSID       @D67ADAP 01029000
         TR    SERIWORK(8),HEXCHTAB-X'F0' MAKE IT PRINTABLE    @D67ADAP 01030000
         MVC   TLMLNAME(8),SERIWORK USE THIS AS DEFAULT NAME   @D67ADAP 01031000
         DROP  R8                 RELEASE TLMADR BASE          @D61ADAP 01032000
AVRUTA20 MVC   VCTTDCLS(2),PBXOBR SET FINAL CLASS AND TYPE CODE@DY46252 01033000
         TM    VCTTRDC1,VCTTFEMU  IS THIS AN EMULATED DEVICE   @D66ADAP 01034000
         BZ    AVRUTA30           NO,                          @D66ADAP 01035000
         CLI   VCTTCUMO,X'FF'     IS THIS A VIRTUAL TAPE       @D66ADAP 01036000
         BNE   AVRUTA30           NO,                          @D66ADAP 01037000
         MVC   VCTAEXTC(6),CVTAPE INDICATE VTAP DEVICE         @D66ADAP 01038000
AVRUTA30 MVI   PBXTDEN,ZERO       CLEAR DENSITY SETTING        @DA44364 01039000
         CLI   PUBDEVTY,T3480     IS THIS 3480-TYPE DEVICE     @D21LDAP 01040000
         BE    AVRUTE00           YES, SPECIAL PROCESSING      @D21LDAP 01041000
         CLI   PUBDEVTY,TTPA      IS THIS A TPA DEVICE         @D62TAAP 01042000
         BE    AVRUTD00           YES DO TPA  PROCESSING       @D62TAAP 01043000
         OI    PBXFLAG2,PBXNOASS  BYPASS ASSGN PROCESSING      @DA44471 01044000
         NI    PBXTREC,XFF-PBXT7TRK RESET 7-TRACK BIT IN PUBX  @D21LDAP 01045000
         CLI   PUBDEVTY,T9346     IS THIS THE 9346 TAPE        @D21LDAP 01046000
         BE    AVRUTE70           YES DO 9346 PROCESSING       @D21LDAP 01047000
         OI    PBXTDEN,PBXT1600   INDICATE 1600 BPI DENSITY    @D21LDAP 01048000
         CLI   PUBDEVTY,T9347     IS THIS A 9347 TAPE          @D21LDAP 01049000
         BE    AVRUTE80           YES, DO SPECIAL PROCESSING   @D31KMAP 01050000
         CLI   PUBDEVTY,T2400     IS THIS A 2400 TAPE          @D21LDAP 01051000
         BE    AVRUTB00           YES, DO SPECIAL PROCESSING   @D21LDAP 01052000
         CLI   PUBDEVTY,T3420     IS THIS A 3420 TAPE          @D21LDAP 01053000
         BE    AVRUTC00           YES, DO SPECIAL PROCESSING   @D21LDAP 01054000
         CLI   PBXOBR+1,X'05'     IS THIS A 3410 DEVICE        @DA40741 01055000
         BH    AVRUTA90           NO,  ASSUME 3422 / 3430      @DA40741 01056000
* 3410 TAPE PROCESSING                                         @D21LDAP 01057000
*                                 3410 SPECIAL PROCESSING      @D21LDAP 01058000
*                                 DEVICE DOES EXIST            @D21LDAP 01059000
*                                 DEVICE IS NOT A 7-TRACK      @D21LDAP 01060000
*                                 1600 BPI WILL BE ACCEPTED    @D21LDAP 01061000
AVRUTA40 TM    RQTSNSDT+1,X'60'   DOES DEVICE REALLY EXIST     @DBOC    01062000
         BZ    AVRUTA50           NO,                          @DA44364 01063000
         TM    RQTSNSDT+6,X'20'   DOES 3410 HAVE DUAL DENSITY  @DBOC    01064000
         BZ    AVRUTF00           NO,                          @D21LDAP 01065000
AVRUTA45 OI    PBXTDEN,PBXT0800   INDICATE 800 BPI FACILITY    @D21LDAP 01066000
         B     AVRUTF00                                        @D21LDAP 01067000
         SPACE 1                                                        01068000
AVRUTA50 CLI   PUBOPTN,X'CB'      USER REQUESTED 800 BPI       @DAOM    01069000
         BE    AVRUTA45           YES, HE GOT IT FOR NOW       @DA44364 01070000
         B     AVRUTF00           NO,                          @DA44364 01071000
* 3422 / 3430 TAPE PROCESSING                                  @D21LDAP 01072000
*                                 DEVICE DOES EXIST            @D21LDAP 01073000
*                                 DEVICE IS NOT A 7-TRACK      @D21LDAP 01074000
*                                 1600 BPI WILL BE ACCEPTED    @D21LDAP 01075000
AVRUTA90 OI    PBXTDEN,PBXT6250   6250 BPI  DENSITY STANDARD   @D21LDAP 01076000
         B     AVRUTF00                                        @D21LDAP 01077000
* 2400 TAPE PROCESSING                                         @D21LDAP 01078000
*                                 DEVICE DOES EXIST            @D21LDAP 01079000
*                                 7-TRACK   FEATURE DETERMINED @D21LDAP 01080000
*        THE DUAL DENSITY CANT BE DETERMINED AND IS ASSUMED    @D21LDAP 01081000
*                                 1600 BPI  ASSUMED            @D21LDAP 01082000
AVRUTB00 OI    PBXTDEN,PBXT0800   0800 BPI  ASSUMED            @D21LDAP 01083000
         B     AVRUTF00                                        @D21LDAP 01084000
* 3420 TAPE PROCESSING                                         @D21LDAP 01085000
*                                 DEVICE DOES EXIST            @D21LDAP 01086000
*                                 7-TRACK   FEATURE DETERMINED @D21LDAP 01087000
*                                 1600 BPI DEFAULT SETTING     @D21LDAP 01088000
AVRUTC00 TM    RQTSNSDT+1,X'60'   DOES DEVICE REALLY EXIST     @DBOC    01089000
         BNZ   AVRUTC20           YES,                         @DA44364 01090000
         CLI   PUBOPTN,X'CB'      USER REQUESTED 800 BPI       @DAOM    01091000
         BNE   AVRUTC10           NO,                          @DA44364 01092000
         OI    PBXTDEN,PBXT0800   0800 BPI  ASSUMED            @DA44364 01093000
         B     AVRUTF00                                        @DA44364 01094000
AVRUTC10 CLI   PUBOPTN,X'D3'      USER REQUESTED 6250 BPI      @DAOM    01095000
         BNE   AVRUTF00           NO,                          @DA44364 01096000
         OI    PBXTDEN,PBXT6250   6250 BPI WANTED              @DA44364 01097000
         B     AVRUTF00                                        @DA44364 01098000
AVRUTC20 TM    RQTSNSDT+6,X'08'   IS IT A MODEL 4, 6, 8        @DBOC    01099000
         BZ    AVRUTC30           NO, ITS A MODEL 1, 3, 5      @D21LDAP 01100000
         OI    PBXTDEN,PBXT6250   6250 BPI DEFAULT DENSITY     @D21LDAP 01101000
         TM    RQTSNSDT+6,X'20'   DOES DEVICE HAVE DUAL-DENSITY@DBOC    01102000
         BO    AVRUTF00           YES,                         @D21LDAP 01103000
         NI    PBXTDEN,XFF-PBXT1600 RESET 1600 BPI INDICATOR   @D21LDAP 01104000
         B     AVRUTF00                                        @D21LDAP 01105000
AVRUTC30 TM    RQTSNSDT+6,X'20'   DOES DEVICE HAVE DUAL-DENSITY@DBOC    01106000
         BZ    AVRUTF00           NO,                          @D21LDAP 01107000
         OI    PBXTDEN,PBXT0800   0800 BPI FEATURE DENSITY     @D21LDAP 01108000
         B     AVRUTF00                                        @D21LDAP 01109000
*                                                              @D21LDAP 01110000
*        TPA DEVICE PROCESSING                                 @D21LDAP 01111000
*                                                              @D21LDAP 01112000
AVRUTD00 DS    0H'0'              TPA  DEVICE PROCESSING       @D21LDAP 01113990
         MVI   PBXTREC,PBXT512T+PBXTCTG INITIALIZE RECORDING   @DAOME05 01114980
         MVI   PBXFLAG1,PBXBUFFD+PBXNORDB+PBXDBCCW+PBXFEAT2+PBXFEAT1    01116000
*                                 SET DEFAULT OPTIONS          @DY45988 01117000
         OI    PBXFLAG3,PBXTERP1  INDICATE TRANSIENT ERP       @DA44241 01118000
         TM    RQTSNSDT+1,X'60'   DOES DEVICE REALLY EXIST     @DY45988 01119000
         BZ    AVRUTD20           NO, LEAVE DEFAULTS           @DY45988 01120000
         TM    VCTTFEAD,VCTTFDCM  IS DATA COMPACTION ALLOWED   @DY45988 01121000
         BO    AVRUTD20           YES,                         @DY45988 01122000
         NI    PBXFLAG1,XFF-PBXFEAT1 RESET IDRC SUPPORTED      @DY45988 01123490
AVRUTD20 TM    VCTTFEAD,VCTTFLIO  LIBRARY INTERFACE ONLINE     @D62TAAP 01124000
         BZ    AVRUTD30           NO, OR NOT YET               @D62TAAP 01125000
         OI    PBXFLAG1,PBXFEAT3  INDICATE LIBRARY ONLINE      @D62TAAP 01126000
AVRUTD30 TM    VCTTFS21,VCTTRDBW  DEVICE SUPPORTS READ BACKWARD@D62TAAP 01127000
         BZ    AVRUTD40           NO, OR NOT YET               @D62TAAP 01128000
         NI    PBXFLAG1,XFF-PBXNORDB READ BACKWARDS SUPPORTED  @D62TAAP 01129000
AVRUTD40 CLI   VCTTSDMC,X'20'     IS THIS A 3592 TYPE          @DAOME05 01130590
         BL    AVRUTD60           NO, CERTAINLY NOT            @DY46071 01131180
         CLI   VCTTSDMC,X'22'     SURE ITS A 3592 DEVICE       @DY46071 01132000
         BH    AVRUTD60           NO, DON'T KNOW THIS GUY      @DAOME05 01133390
         BL    AVRUTD50           ITS A 3590-J DEVICE          @DAOME05 01133780
         OI    PBXTREC,PBXT896T   ITS THE 3592 E05 DEVICE      @DAOME05 01134170
AVRUTD50 OI    PBXTREC,PBXT512T   INDICATE 512-TRACK DEVICE    @DY46071 01134560
         B     AVRUTD90           JOIN MAIN PATH               @DY46071 01135000
AVRUTD60 DS    0H'0'              TPA  3590 PROCESSING         @DAOME05 01136390
         NI    PBXTREC,XFF-PBXT512T RESET 512-TRACK CAPABLE    @DY46071 01136780
         CLI   VCTTSDMC,X'14'     IS THIS A 3590-H DEVICE      @DY45988 01137170
         BL    AVRUTD70           NO, CERTAINLY NOT            @DY45988 01137560
         CLI   VCTTSDMC,X'15'     SURE ITS A 3590-H DEVICE     @DY45988 01138000
         BH    AVRUTD90           NO, DON'T KNOW THIS GUY      @DY45988 01139990
         OI    PBXTREC,PBXT384T   INDICATE 384-TRACK CAPABLE   @DY45988 01140980
         B     AVRUTD90           JOIN MAIN LINE               @DY45988 01142000
AVRUTD70 CLI   VCTTSDMC,X'12'     IS THIS A 3590-E DEVICE      @DY45988 01143490
         BL    AVRUTD90           NO, ITS THE 3590-B (128-TRK) @DY45988 01144000
         OI    PBXTREC,PBXT256T   INDICATE 256-TRACK DEVICE    @DY45988 01146000
AVRUTD90 DS    0H'0'                                           @D62TAAP 01147000
         B     AVRUTF00                                        @D21LDAP 01148000
*                                                              @D21LDAP 01149000
*        3424 / 3480 / 3490 / 3490E / 9348 /                   @D21LDAP 01150000
*                                                              @D21LDAP 01151000
AVRUTE00 DS    0H'0'              3480 SPECIAL PROCESSING      @D21LDAP 01152000
         MVI   PBXTREC,ZERO       RESET RECORDING INFORMATION  @DAOM073 01153000
         NI    PBXFLAG1,XFF-PBXFEAT1-PBXFEAT2-PBXFEAT3-PBXNORDB DY45540 01154000
         TM    RQTSNSDT+1,X'60'   DOES DEVICE REALLY EXIST     @DBOC    01155000
         BNZ   AVRUTE20           YES, USE RDC DATA            @DY45540 01156000
         CLI   PBXMDR,X'41'       IS THIS A 3490               @DY45540 01157000
         BL    AVRUTE20           NO, ITS A 3480               @DY45540 01158000
         BE    AVRUTE10           YES, IT IS A 3490            @DY45540 01159000
         CLI   PBXMDR,X'42'       IS THIS A 3490E              @DY45540 01160000
         BNE   AVRUTE20           NO, ITS A 3424 OR 9348       @DY45540 01161000
         OI    PBXTREC,PBXT2XF    INDICATE 2-XF FORMAT         @DY45540 01162000
AVRUTE10 OI    PBXFLAG1,PBXFEAT1+PBXFEAT2 AUTOBLK+IDRC         @D62TAAP 01163000
AVRUTE20 OI    PBXFLAG3,PBXTERP1  INDICATE TRANSIENT ERP       @DA44241 01164000
         OI    PBXFLAG1,PBXBUFFD+PBXDBCCW SET DEFAULTS         @D62TAAP 01165000
         CLI   PBXMDR,X'44'       IS THIS THE 3424 TAPE DRIVE  @D62TAAP 01166000
         BE    AVRUTE50           YES                          @D31KMAP 01167000
         CLI   PBXMDR,X'45'       IS THIS THE 9348 TAPE DRIVE  @D62TAAP 01168000
         BE    AVRUTE60           YES                          @D31KMAP 01169000
*                                                              @D21LDAP 01170000
*        3480/3490(E) TAPE PROCESSING                          @D21LDAP 01171000
*                                                              @D21LDAP 01172000
         OI    PBXTREC,PBXTCTG    SET DEFAULTS AND RESET FEAT. @D3550   01173000
         CLI   VCTTRDCF,X'01'     IS THIS RDC FORMAT 1         @D62TAAP 01174000
         BE    AVRUTE30           YES, CU MAINAINS DEFAULTS    @D62TAAP 01175000
         OI    VCTTFEAD,VCTTFMDF  INDICATE MSG DISPLAY         @D62TAAP 01176000
         OI    VCTTFS20,VCTTDPAT+VCTTDPAR DEFAULT ON 3480/3490 @D62TAAP 01177000
         OI    VCTTFS21,VCTTRDBW+VCTTMOVW+VCTTACCC ON 3480/3490@D62TAAP 01178000
         TM    VCTTFEAD,VCTTFDCM  IS DATA COMPACTION ALLOWED   @D61ADAP 01179000
         BZ    AVRUTE30           NO,  ======================> @D21LDAP 01180000
         OI    PBXFLAG1,PBXFEAT1+PBXFEAT2 IND COMPACTION+BLOCK.@D21LDAP 01181000
AVRUTE30 CLI   PBXMDR,X'42'       IS THIS THE 3490E            @D21LDAP 01182000
         BNE   AVRUTF00           NO                           @D51GDAP 01183000
*                                                              @D21LDAP 01184000
*        3490E TAPE PROCESSING                                 @D21LDAP 01185000
*                                                              @D21LDAP 01186000
         TM    VCTTFEAD,VCTTFLIO  LIBRARY INTERFACE ONLINE     @D61ADAP 01187000
         BZ    AVRUTE40           NO, OR NOT YET               @D61ADAP 01188000
         OI    PBXFLAG1,PBXFEAT3  LIBRARY INTERFACE ONLINE     @D61ADAP 01189000
AVRUTE40 OI    PBXTREC,PBXT2XF    SET 2-XF FORMAT CAPABLE      @D51GDAP 01190000
         OI    PBXFLAG1,PBXFEAT1+PBXFEAT2 IND COMPACTION+BLOCK.@DA44471 01191000
         TM    VCTTRDC1,VCTTFEMU  IS THIS AN EMULATED 3490E    @D21LDAP 01192000
         BZ    AVRUTF00           NO, THEN WE ARE DONE         @D21LDAP 01193000
         B     AVRUTF00           JOIN MAIN LINE               @D21LDAP 01194000
         AGO   .SKIP180                                                 01195490
         CLC   VCTTEMDV(2),AVRC3570 IS THIS THE 3570           @D3570   01196000
         BNE   AVRUTF00           NO,                          @D3570   01197000
         OI    PBXTDEN,PBXT3570   INDICATE 3570 DEVICE         @DAOM073 01198000
*                                                              @D21LDAP 01199000
*        3570  TAPE PROCESSING                                 @D21LDAP 01200000
*                                                              @D21LDAP 01201000
         B     AVRUTF00           NO, OR NOT YET               @D3570   01202000
AVRC3570 DC    XL2'3570'          CONSTANT                     @D3570   01203000
.SKIP180 ANOP                                                           01204490
*                                                              @D21LDAP 01205000
*        3424  TAPE PROCESSING                                 @D21LDAP 01206000
*                                                              @D21LDAP 01207000
AVRUTE50 OI    PBXTDEN,PBXT1600+PBXT6250 1600/6250 BPI         @D21LDAP 01208000
         OI    PBXFLAG2,PBXNOASS  FORCE ASSGN TO BE BYPASSED   @DA44471 01209000
         B     AVRUTF00                                        @D21LDAP 01210000
*                                                              @D31KMAP 01211000
*        9348  TAPE PROCESSING                                 @D31KMAP 01212000
*                                                              @D31KMAP 01213000
AVRUTE60 OI    PBXFLAG1,PBXNORDB  INDICATE NO READ BACKWARDS   @D31KMAP 01214000
         OI    PBXFLAG2,PBXNOASS  FORCE ASSGN TO BE BYPASSED   @DA44471 01215000
         OI    PBXTDEN,PBXT1600+PBXT6250 1600/6250 BPI         @D31KMAP 01216000
         B     AVRUTF00                                        @D21LDAP 01217000
*                                                              @D21FDAP 01218000
*        9346  TAPE PROCESSING                                 @D21FDAP 01219000
*                                                              @D21LDAP 01220000
AVRUTE70 OI    PBXFLAG1,PBXBUFFD+PBXDBCCW SET DEFAULTS         @D62TAAP 01221000
         OI    PBXTREC,PBXT1SER   INDICATE SERPENTINE RECORDING@D21FDAP 01222000
         OI    PBXFLAG1,PBXNORDB  INDICATE NO READ BACKWARDS   @D31KMAP 01223000
         B     AVRUTF00                                        @D21LDAP 01224000
*                                                              @D31KMAP 01225000
*        9347 TAPE PROCESSING                                  @D31KMAP 01226000
*                                                              @D31KMAP 01227000
AVRUTE80 OI    PBXFLAG1,PBXNORDB  INDICATE NO READ BACKWARDS   @D31KMAP 01228000
*                                                              @D31KMAP 01229000
*        GENERAL TAPE EXIT PROCESSING                          @D31KMAP 01230000
*                                                              @D31KMAP 01231000
AVRUTF00 TM    RQTSNSDT+1,X'60'   DOES DEVICE REALLY EXIST     @DBOC    01232000
         BZ    AVRUTF10           NO, IT DOES NOT              @DA41649 01233000
         TM    VCTAFLAG,VCTASHR   IS TAPE ASSIGNED ELSEWHERE   @DA41555 01234000
         BO    AVRUTF20           YES,                         @DA44471 01235000
         NI    PBXFLAG2,XFF-PBXNOSIO CHARACTERISTIC NOW VALID  @DA41649 01236000
         B     AVRUTF20                                        @DA44471 01237000
AVRUTF10 NI    VCTAFLG,XFF-VCTARDY-VCTAFOP NOT OPERATIONAL     @D21LDAP 01238000
*        NI    VCTAFLAG,XFF-VCTANVOL SET OLD VOL1 VALID        @DY46564 01239490
AVRUTF20 BR    RE                      ======================> @DA44471 01240000
         EJECT ,                                               @D21FDAP 01241000
AVRUTXIT TM    PBXFLAG2,PBXREADY  DID WE RESET PBXREADY ALREADY@DA40763 01242000
         BZ    AVRDCT00           YES, =====================>> @DA40763 01243000
         ICM   RA,3,PUBCHQPT      SAVE CURRENT PUB SETTING     @DA40763 01244000
         SVC   33                 PROVIDE FOR PROPER REDISPATCH@D21LDAP 01245000
         TM    PBXFLAG2,PBXREADY  FIRST PASS THROUGH           @D21LDAP 01246000
         BO    AVRUTX35           YES, CHECK FOR USER REQUEST  @D61ADAP 01247000
         TM    VCTAFLG,VCTAFOP    IS DEVICE OPERATIONAL        @D51GDAP 01248000
         BZ    AVRUTX25           NO,                          @D51GDAP 01249000
         TM    PUBCSFLG,OPINTV    IS DEVICE INTERVENTION REQ.  @D52VDGL 01250000
         BO    AVRUTX25           YES                          @D52VDGL 01251000
         TM    VCTAFLAG,VCTASHR   DEVICE ASSIGNED ELSEWHERE    @D51GDAP 01252000
         BZ    AVRDCT00           NO,  =====================>> @D51GDAP 01253000
         CLM   RA,3,PUBCHQPT      DID REQUEST COMPLETE         @D51GDAP 01254000
         BE    RESVCIO            NO,  ====================>>> @D51GDAP 01255000
AVRUTX25 OI    PBXFLAG2,PBXNOVOL  INDICATE NOT OWNED VOLUME    @D51GDAP 01256000
         B     AVRDCT00                =====================>> @D51GDAP 01257000
.*                                                             @D51GDAP 01258000
.*       MAKE SURE USERS REQUEST GETS NOW RESTARTED            @D51GDAP 01259000
.*                                                             @D51GDAP 01260000
AVRUTX35 ICM   RF,15,PBXCCW       ADDRESS OF SET MODE CCW      @D61ADAP 01261000
         BZ    AVRUTX40           NO SUCH CCW YET ALLOCATED    @D41XXAP 01262000
         USING SMCCWADR,RF        SET MODE CCW BASE POINTER    @D51EDAP 01263000
         MVI   SMCCWSET,NOP       FORCE NEW SET MODE           @D41XXAP 01264000
         DROP  RF                 RELEASE SET MODE CCW BASE    @D41XXAP 01265000
AVRUTX40 NI    PBXFLAG2,XFF-PBXREADY INDICATE SVT TASK IS DONE @D51GDAP 01266000
         CLI   PUBCHQPT,NOTQUED   IS REQUEST QUEUED TO PUB     @D51GDAP 01267000
         BE    AVRDCT00           NO,  =====================>> @D51GDAP 01268000
         TM    PBXFLAG2,PBXNOVOL  REALLY ASSIGNED?             @DY46592 01268200
         BZ    AVRUTX50           YES                          @DY46592 01268400
         NI    PBXFLAG2,XFF-PBXNOVOL PREVENT FURTHER INTERCEPT @D51GDAP 01269000
         TM    PBXFLAG2,PBXNOASS  ASSIGN IS NEEDED?            @DY46611 01269300
         BO    AVRUTX50           NO                           @DY46611 01269600
         OI    PBXFLAG3,PBXASINT  INTERCEPT NEXT BUT ONE       @DY46592 01269900
AVRUTX50 LH    RA,PUBCHANN        GET CUU ADDRESS              @D51GDAP 01270490
         STH   RA,CHNADR          SET CUU IN LOW CORE          @D51GDAP 01271000
         L     R9,AINTER          IOINTER BASE ADDRESS         @D21LDAP 01272000
         USING INTRTN,R9          IOINTER BASE POINTER         @D21LDAP 01273000
         BAL   RF,INTERTRN        SET UP CCT POINTER           @D21LDAP 01274000
         B     INITRG                  ====================>>> @D21LDAP 01275000
         DROP  R9                 RELEASE IOINTER BASE POINTER @D21LDAP 01276000
         DROP  R2                 RELEASE RQTE BASE            @DBOC    01277000
         TITLE 'VSE SUPERVISOR     SGSER     VOL1 LABEL PROCESSING    ' 01278000
*                                                                       01279000
*        VOL1 LABEL FOUND PROCESSING ROUTINE                            01280000
*                                                                       01281000
         USING PBXADR,R9          PUBX BASE POINTER            @D61ADAP 01282000
AVRUVOL1 NI    VCTAFLAG,XFF-VCTANVOL-VCTACMSV VOL1 IS VALID    @D66ADAP 01283000
         MVC   VCTAVTOC,AVRSVTOC  MOVE VTOC DASD ADDR TO VCTE  @D35VDEP 01284000
AVRUV020 CLI   PUBDEVTY,TFBA      IS DEVICE FBA                @D35DDEP 01285000
*        BNE   AVRUV040           NO, DONT NEED CI SIZE        @D28ADAP 01286000
         BNE   AVRUV050           NO, DONT NEED CI SIZE        @D28ADAP 01287000
         MVC   VCTAVCI,AVRSBPCI   BLOCKS PER CONTROL INTERVAL  @D35DDEP 01288000
         AGO   .SKIP200                                                 01289490
AVRUV040 LTR   RF,RF              WAS VCTE ACTIVE AND VALID    @D35VDEP 01290000
         BZ    AVRUV060           NO,  ======================> @D35VDEP 01291000
.SKIP200 ANOP                                                           01292490
AVRUV050 CLC   VCTAVOL1,AVRSVOL   WAS VOLUME CHANGED           @D35VDEP 01293000
         BE    AVRUDASD           NO,  ======================> @DA42950 01294000
AVRUV060 BAL   RE,RMSGETP2        GET PUB2 ADDRESS             @D51EDAP 01295000
*SGLINK  RMSGETP2,INPUT=(R3,R6,RE),OUTPUT=R8,WORK=RB           @D369DAP 01296000
         USING PUB2ADR,R8                                      @D35VDEP 01297000
         CLI   PUBDEVTY,T3540     IS IT A DISKETTE D/T3540     @DA40290 01298000
         BE    AVRUV070           YES, THEN OMIT VOLID IN PUB2 @DA40290 01299000
         MVC   P2DVOL,AVRSVOL     INIT. VOLID IN PUB2 TABLE    @D35VDAP 01300000
         DROP  R8                 RELEASE PUB2 BASE POINTER    @D14BDAP 01301000
         BAL   R8,AVRREC00        INDICATE NEW VOLUME MOUNTED  @D51EDAP 01302000
*SGLINK  AVRREC00,INPUT=(R3,R4,R6,R8,R9,RC,RD,RF),WORK=R1      @D28ADAP 01303000
AVRUV070 BAL   RE,AVRDUPCH        MARK DEVICES WITH SAME VOLID @D61ADAP 01304000
         MVC   VCTAVOL1,AVRSVOL   MOVE VOLID TO VCTE           @D35VDEP 01305000
*        B     AVRUDASD                                                 01306000
         TITLE 'VSE SUPERVISOR     SGSER     SET UP DCT ENTRY FOR FBA ' 01307000
AVRUDASD CLI   VCTATYPE,VCTAFBA   IS IT FBA DEVICE             @D51GDAP 01308000
         BNE   AVRUCKD            NO,  ======================> @D21LDAP 01309000
AVRUFBA  LA    RF,DCTFBA          SKELETON OF FBA ENTRY        @D51EDAP 01310000
         USING DVCCNTAB,RF        DVCCNTAB BASE                @D51EDAP 01311000
*        ICM   R8,15,PBXVCTE      VALID CHARACTERISTICS EXISTS @TEST    01312000
*        BNZ   AVRDCT00           YES =======================> @TEST    01313000
         TM    PBXFLAG2,PBXNOSIO  ENTRY NEEDS TO BE UPDATED    @TEST    01314000
         BZ    AVRDCT00           NO, =======================> @TEST    01315000
         ST    R4,PBXVCTE         SAVE VCTE ADDRESS IN PUBX    @TEST    01316000
         MVC   VCTAPUBC(L'DVCCNPCD),DVCCNPCD SET DEVICE CODES  @D51EDAP 01317000
         MVC   VCTACATB(L'VCTACATB),DVCCNOSC SET OS CODES      @D51EDAP 01318000
         MVC   VCTAEXTC(L'VCTAEXTC),DVCCNEXC SET EXTERNAL CODE @D51EDAP 01319000
         MVC   VCTADEVC(VCTFEND-VCTADEVC),DVCCNPCD GET SKELET  @D51EDAP 01320000
         MVC   PBXOBR(2),RDCFAREA+2 SAVE OBR ID IN PUBX        @D61ADAP 01321000
         TM    PBXFLAG1,PBXRONLY  IS THIS READ ONLY DEVICE     @DY45540 01322000
         BZ    AVRUFB10           YES                          @DY45540 01323000
         OI    VCTACDCS,VCTANWRT  INDICATE READ ONLY DEVICE    @DY45540 01324000
AVRUFB10 BAL   R8,AVRUPUBX        FILL PUBX INFORMATION        @D52VDAP 01325000
*SGLINK  AVRUPUBX,INPUT=(R2,R8,R9,RC),WORK=R5                  @DAMO014 01326000
         NOP   0                0 NO SENSE ID INFORMATION AVAIL@D52VDAP 01327000
         NOP   0                4 NO CIW RCD  PRESENT          @D52VDAP 01328000
         BAL   R8,AVRUMDR       8 SET MDR RECORD INFORMATION   @D21IDAP 01329000
         ICM   R1,15,RDCFAREA+10  BLKS/ACCESS POSITION         @D61ADAP 01330000
         BZ    AVRUF050           ZERO, SPECIAL PROCESSING     @D31ODAP 01331000
         NI    PBXFLAG2,XFF-PBXNOSIO PREVENT FURTHER INTERCEPT @TEST    01332000
         DROP  R9                 RELEASE PUBX BASE POINTER    @D31ODAP 01333000
         TM    SUPFLAG,VMSYS      ARE WE RUNNING UNDER VM      @D61BDAP 01334000
         BZ    AVRUFEXT           NO,                          @D61ADAP 01335000
         ICM   R9,15,RDCFAREA+14  BLOCKS UNDER MOVABLE ACCESS  @D61ADAP 01336000
         ICM   R8,15,RDCFAREA+18  BLOCKS UNDER FIXED ACCESS    @D61ADAP 01337000
         AR    R9,R8              TOTAL NUMBER OF BLOCKS       @D31ODAP 01338000
         SLR   R8,R8              CLEAR WORK REG               @D31ODAP 01339000
         DR    R8,R1              PRIMARY CYLINDERS            @D31ODAP 01340000
         LTR   R9,R9              MULTIPLES OF CYLINDER GIVEN  @D61BDAP 01341000
         BZ    AVRUFEXT           YES,                         @D61BDAP 01342000
         MR    R8,R1              MAKE IT MULTIPLE INTEGER     @D31ODAP 01343000
         STCM  R9,15,RDCFAREA+14  SAVE ADJUSTED VALUE IN TABLE @D61ADAP 01344000
         STCM  R8,15,RDCFAREA+18  SET FIXED BLOCKS TO ZERO     @D61ADAP 01345000
AVRUFEXT MVC   VCTAFDCS(1),SSSAREA+26 SAVE CURRENT STATUS      @D31ODAP 01346000
         MVC   VCTFADR(L'RDCFAREA),RDCFAREA MOVE RDC DATA      @D61ADAP 01347000
         UNPK  SERIWORK(7),SIDDEVCD(4) GET EXT DEV CODE PRINT. @D31ODAP 01348000
         TR    SERIWORK(6),HEXCHTAB-X'F0' MAKE IT HEX CHARACTER@D51GDAP 01349000
         MVC   VCTAEXTC(6),SERIWORK MOVE INTO DCT ENTRY        @D51EDAP 01350000
         L     RE,AAVRMINI        GET AVRMINI BASE ADDRESS     @D61ADAP 01351000
         USING AVRMINI,RE         AVRMINI BASE POINTER         @D61ADAP 01352000
         BASSM R8,RE              DO VM SPECIAL PROCESSING     @D61ADAP 01353000
*SGLINK  AVRMINI,INPUT=(R3,R4,R8,RE,RF),WORK=R5                @D68ADAP 01354000
         B     AVRDCT00                ======================> @D68ADAP 01355000
         DROP  RE                 RELEASE AVRMINI BASE POINTER @D61ADAP 01356000
         DROP  RF                 RELEASE DVCCNTAB BASE        @DY46120 01357000
         SPACE 1                                               @D31ODAP 01358000
         USING PBXADR,R9          PUBX BASE POINTER            @D31ODAP 01359000
AVRUF050 CLI   PUBOPTN,PUBOPTVD   IS THIS A VIRTUAL DISK       @D52VDAP 01360000
         BNE   AVRDCT00           NO,                          @D52VDAP 01361000
         MVI   VCTAEXTC+3,C'V'    INDICATE VIRTUAL DISK (FBAV) @D52VDAP 01362000
         XC    VCTFBLKS(VCTFEND-VCTFBLKS),VCTFBLKS CLEAR DATA  @D52VDAP 01363000
         XC    VCTAVOL1,VCTAVOL1  INVALIDATE VOLID IN TABLE    @D52VDAP 01364000
         B     AVRDCT00           DONE,======================> @D31ODAP 01365000
         DROP  R9                 RELEASE PUBX BASE POINTER    @D61ADAP 01366000
         DROP  R4                 RELEASE VCTE BASE POINTER    @D61ADAP 01367000
         TITLE 'VSE SUPERVISOR     SGSER     COMMON TAPE I/O ROUTINE  ' 01368000
.*                                                                      01369000
.*       GENERAL TAPE I/O ROUTINE                                       01370000
.*                                                                      01371000
         USING VCTEADR,R4         VCTE ENTRY BASE              @D61ADAP 01372000
         USING PBXADR,R9          PUBX BASE POINTER            @DA44172 01373000
         USING RQTE,R2            RQT-ENTRY BASE               @DBOC    01374000
*        USING CCWADR,RF          CCW BASE POINTER             @DBOC    01375000
*SGLINK  TAPIORTN INPUT=(R2,R4,R9,RE,RF),OUTPUT=R0             @D68ADAP 01376000
TAPIORTN STM   RE,R1,RQTIOINP     SAVE CALLERS REGISTERS       @D25IDAP 01377000
         MVC   RQTCCB(24),AVRCCB  MOVE CCB SKELETON            @DBOC    01378000
         LA    RE,RQTSNSDT        ADDRESS OF SNS-DATA          @DBOC    01379000
         STCM  RE,7,RQTCCB+17     PROVIDE SNS-DATA ADDRESS     @DBOC    01380000
         XC    RQTCCW,RQTCCW      CLEAR CCW AREA               @DBOC    01381000
         LA    RE,RQTCCW          CCW-AREA ADDRESS             @DBOC    01382000
         SLR   R1,R1              CLEAR REGISTER               @DBOC    01383000
TAPIOR00 MVC   0(8,RE),0(RF)      COPY CCW SKELETON            @DBOC    01384000
         ICM   R1,7,1(RE)         GET I/O AREA OFFSET          @DBOC    01385000
         AR    R1,R2              ADD RQT BEGIN ADDRESS        @DBOC    01386000
         STCM  R1,7,1(RE)         RELOCATE I/O AREA ADDRESS    @DBOC    01387000
         TM    4(RF),X'C0'        ANY CHAINING                 @DBOC    01388000
         BZ    TAPIOR10           NO,                          @DBOC    01389000
         LA    RF,8(,RF)          POINT TO NEXT SOURCE CCW     @DBOC    01390000
         LA    RE,8(,RE)          POINT TO NEXT TARGET CCW     @DBOC    01391000
         B     TAPIOR00           PREPARE NEXT CCW             @DBOC    01392000
TAPIOR10 LA    RF,RQTCCW          POINT TO BEGIN OF CHAIN      @DBOC    01393000
         LR    R1,R3              COPY PUB ADDRESS             @D61ADAP 01394000
         SH    R1,YPUBTAB         GET PUB DISPLACEMENT         @D61ADAP 01395000
         SRL   R1,PUBSLEN         GET PUB INDEX                @D61ADAP 01396000
         STH   R1,RQTCCB+6        SAVE PUB INDEX IN CCB        @D61ADAP 01397000
TAPIORNS LA    R0,3               SET RETRY LIMIT              @D61ADAP 01398000
TAPIORTY LA    R1,RQTCCB          POINT AT SERVICE TASK CCB    @D31ODAP 01399000
         USING CCBADR,R1          NEED ADDRESSIBILITY          @D31ODAP 01400000
         NI    CCBCOM1,XFF-OWNUCRT RESET USER OWN ERROR ROUTINE@DA44172 01401000
         OI    CCBBY3,USENSE      INDICATE SENSE BYTES NEEDED  @D61ADAP 01402000
         OI    CCBCLS,CCBPHYAD    INDICATE PHYSICAL ADDRESSING @D61ADAP 01403000
         ST    RF,CCBCCW          PROVIDE CCW ADDRESS          @D61ADAP 01404000
         AIF   (NOT &VSE280).N280080                           @D68ADAP 01404500
         SVC   15                 EXECUTE CHANNEL PROGRAM      @DBOC    01405000
         AGO   .Y280020                                        @DBOC    01405200
.N280080 ANOP                                                  @DBOC    01405400
         SYSIO (1)                EXECUTE CHANNEL PROGRAM      @DBOC    01405600
.Y280020 ANOP                                                  @DBOC    01405800
         TM    CCBCOM1,TRABIT     REQUEST ALREADY POSTED       @DBOC    01406000
         BO    TAPIORWT           YES, TAKE SHORT PATH         @DBOC    01407000
         LA    RE,SERECBLST       ECB LIST ADDRESS             @DBOC    01408000
TAPIOR20 OC    0(4,RE),0(RE)      IS THIS AN EMPTY SLOT        @DBOC    01409000
         BZ    TAPIOR60           YES, SAVE CCB ADDRESS        @DBOC    01410000
         C     R1,0(RE)           IS THIS A DUPLICATE          @DBOC    01411000
         BE    TAPIOR40           YES, HARD WAIT THE SYSTEM    @DBOC    01412000
         TM    0(RE),X'80'        END OF LIST                  @DBOC    01413000
         BO    TAPIOR40           YES, HARD WAIT THE SYSTEM    @DBOC    01414000
         LA    RE,4(,RE)          ADVANCE ECBLIST POINTER      @DBOC    01415000
         B     TAPIOR20           FIND EMPTY SLOT              @DBOC    01416000
TAPIOR40 BAL   R5,SYSERROR                                     @DBOC    01417000
TAPIOR60 ST    R1,0(RE)           SAVE ADDRESS IN ECBLIST      @DBOC    01418000
         STM   R0,RF,RQTIOREG     SAVE MY CURRENT SETTINGS     @DBOC    01419000
         B     SERTASK1                ======================> @DBOC    01420000
         EJECT ,                                               @DBOC    01421000
TAPIORWT DS    0H'0'              REQUEST COMPLETE PROCESSING  @DBOC    01422000
         OI    CCBCOM1,POSTDE     RESTORE POST AT DE BIT       @DAOM    01423000
         TM    CCBCOM1,DISERR     DID WE GET ANY ERROR         @D61ADAP 01424000
         BO    AVRTAPER           YES,                         @D61ADAP 01425000
         TM    CCBSTA1,UNITEXCP   UNIT EXCEPTION               @D61ADAP 01426000
         BO    TAPIORUX           YES,                         @D61ADAP 01427000
TAPIORC0 SLR   R0,R0              FORCE ZERO RETURN            @DA44634 01428000
         ST    R0,RQTIOINP+8      ENSURE A RETURN CODE OF ZERO @D25IDAP 01429000
         LM    RE,R1,RQTIOINP     RESTORE CALLERS REGISTER     @D25IDAP 01430000
         B     0(,RE)             RETURN====================>> @DA44634 01431000
         DROP  R1                 RELEASE CCB BASE POINTER     @D61ADAP 01432000
TAPIORC4 ST    R0,RQTIOINP+8      SAVE RETURN CODES            @D25IDAP 01433000
         LM    RE,R1,RQTIOINP     RESTORE CALLERS REGISTER     @D25IDAP 01434000
         B     4(,RE)             ERROR ====================>> @DA44634 01435000
TAPIORUX NI    VCTAFLAG,XFF-VCTANVOL SET VOL1 VALID            @D61ADAP 01436000
         XC    VCTAVOL1,VCTAVOL1  INVALIDATE VOLID IN TABLE    @D61ADAP 01437000
         TM    4(RF),CC           IS A COMMAND CHAINED         @D61ADAP 01438000
         BZ    TAPIORTY           NO,  ======================> @D61ADAP 01439000
         LA    RF,8(,RF)          ADVANCE TO NEXT CCW          @D61ADAP 01440000
         B     TAPIORNS           TRY THE REWIND               @D61ADAP 01441000
         SPACE 1                                               @D61ADAP 01442000
         DROP  R9                 RELEASE PUBX BASE POINTER    @D25IDAP 01443000
         DROP  R4                 RELEASE VCTE BASE POINTER    @D25IDAP 01444000
         SPACE 3                                                        01445000
AVRTAPER DS    0H'0'              CKD SPECIAL WORK             @D25IDAP 01446000
         L     RE,AAVRTAER        GET SUBROUTINE BASE ADDRESS  @D25IDAP 01447000
         BR    RE                      ======================> @DA44471 01448000
         DROP  R2                 RELEASE RQT-ENTRY BASE       @DBOC    01449000
         SPACE 1                                               @D21LDAP 01450000
AVRUCKD  DS    0H'0'              CKD SPECIAL WORK             @DFUNC   01451000
         L     RE,AAVRADCT        GET SUBROUTINE BASE ADDRESS  @DA44471 01452000
         BR    RE                      ======================> @DA44471 01453000
         SPACE 1                                               @D21LDAP 01454000
         USING VCTEADR,R4         VCTE BASE POINTER            @D61ADAP 01455000
AVRA3380 NI    VCTAFLAG,XFF-VCTAREMV RESET REMOVABLE BIT       @D51EDAP 01456000
         B     AVRUCK20                                        @D51EDAP 01457000
         SPACE 1                                               @D37ADAP 01458000
AVRAECKD MVI   VCTATYPE,VCTAECKD  INDICATE ECKD DEVICE         @D35VDEP 01459000
         SPACE 1                                               @D25IDAP 01460000
         USING DVCCNTAB,RF        DVCCNTAB BASE                @D51EDAP 01461000
AVRUCK10 NI    VCTAFLAG,XFF-VCTAREMV RESET REMOVABLE BIT       @DA35542 01462000
         TM    DVCCNOSC+1,DCTREMV DEVICE WITH REMOVABLE MEDIA  @DA35542 01463000
         BZ    AVRUCK20           NO, LEAVE VCTAREMV BIT OFF   @DA35542 01464000
         OI    VCTAFLAG,VCTAREMV  YES, SET IN VCTE             @DA35542 01465000
         DROP  RF                 RELEASE DVCCNTAB BASE        @DA44364 01466000
         SPACE 1                                                        01467000
AVRUCK20 L     RE,AAVRUCKM        LOAD AVRUCKMR BASE           @DA44364 01468000
         BR    RE                      ======================> @DA44364 01469000
         SPACE 2                                                        01470000
AVRDEVER DS    0H'0'              ENTRY POINT IN CASE OF ERROR @D37ADAP 01471000
AVRDCT00 L     RE,AAVRDCTP        LOAD AVRDCTPR BASE           @DA44364 01472000
         BR    RE                      ======================> @DA44364 01473000
         SPACE 1                                                        01474000
AVRSSSCK L     RE,AAVRSSSP        LOAD AVRSSSPR BASE           @DAOM    01475000
         BR    RE                      ======================> @DAOM    01476000
         SPACE 1                                                        01477000
         DROP  R4                 RELEASE VCTE BASE POINTER    @D25IDAP 01478000
         TITLE 'VSE SUPERVISOR     SGSER     CACHE SPECIFIC PROCESSING' 01479000
         DROP  ,                  RELEASE ALL REGISTERS                 01480000
         USING SYSS00,R0          LOW CORE BASE                         01481000
         USING PUBADR,R3          PUB BASE POINTER             @D14BDAP 01482000
         USING VCTEADR,R4         VCT ENTRY BASE POINTER       @D25IDAP 01483000
         USING DISP,R6            DISPATCHER BASE                       01484000
         USING PBXADR,R9          PUBX BASE POINTER            @D61ADAP 01485000
         USING SGSERI,RC          SGSERI BASE POINTER          @D35CDFG 01486000
         USING SERTASK,RD         SGSER BASE                            01487000
         USING AVRSSSPR,RE        AVRSSSPR ROUTINE BASE                 01488000
AVRSSSPR DS    0H'0'              ANALYSE SENSE-SUBSYST.STATUS @DA44364 01489000
         TM    PBXFLAG1,PBXBUFFD  IS THIS A BUFFERED DEVICE    @DA44364 01490000
         BZ    AVRDCT00           NO   =====================>> @D31ADAP 01491000
         TM    PBXFLAG,PBXDASD    IS THIS A DASD DEVICE        @D31ADAP 01492000
         BZ    AVRDCT00           NO,  =====================>> @D31ADAP 01493000
         OC    SSSAREA(L'SSSAREA),SSSAREA ANY SUBSYSTEM STATUS @D31ADAP 01494000
         BZ    AVRDCT00           NO,  ======================> @D31ADAP 01495000
         OC    PBXCCW,PBXCCW      HAS PUBX BEEN BUILT ALREADY  @D52WDAP 01496000
         BZ    AVRDCT00           NO,  =====================>> @D52WDAP 01497000
         CLC   SSSAREA+1(1),VCTADVID CU PROVIDED CORRECT CUU   @D52VDAP 01498000
         BNE   AVRCACD0           NO,                          @D52VDAP 01499000
         CLC   SSSAREA+38(2),VCTASSID IS IT SAME SUBSYSTEM     @D52VDAP 01500000
         BNE   AVRCACD0           NO,                          @D52VDAP 01501000
         MVC   AVRMSCUU(2),PUBCHANN PROVIDE CUU INFORMATION    @D52WDAP 01502000
AVRCAC10 MVC   AVRMSINF(1),VCTAFLG SAVE OLD SETTING            @D31ADAP 01503000
         NI    VCTAFLG,VCTAFOP+VCTARDY RESET ALL EXCEPT OP+RDY @D68ADAP 01503500
         MVC   AVRMSINF+1(1),VCTAFLG1 SAVE DC, PPRC, FC STATUS @DA44172 01504000
         TM    SSSAREA+4,X'C0'    IS CACHING ACTIVE /OR PENDING@D31ADAP 01506000
         BNZ   AVRCAC15           NO,                          @D31ADAP 01507990
         OI    VCTAFLG,VCTASACT   INDICATE SUBSYS CACHE ACTIVE @D31ADAP 01508980
AVRCAC15 TM    VCTCFEA4,VCTCF4CF  CACHE FAST WRITE SUPPORTED   @DA41555 01509970
         BZ    AVRCAC25           NO,                          @DA41555 01511000
         TM    SSSAREA+4,X'01'    CACHE FAST WRITE DEACTIVATED @D31ADAP 01512000
         BO    AVRCAC20           YES,                         @D52WDAP 01513000
         OI    VCTAFLG,VCTASFST   INDICATE CACHE FAST WRITE    @D31ADAP 01514000
AVRCAC20 TM    SSSAREA+5,X'D8'    NVS FULLY AVAILABLE          @D52WDAP 01515000
         BNZ   AVRCAC25           NO,                          @D52WDAP 01516000
         OI    VCTAFLG,VCTASNVS   INDICATE NVS AVAILABLE       @D52WDAP 01517000
AVRCAC25 TM    SSSAREA+26,X'C0'   IS DEVICE CACHING            @D31ADAP 01518990
         BNZ   AVRCAC30           NO,                          @D31ADAP 01520000
         OI    VCTAFLG,VCTADACT   INDICATE DEVICE CACHING      @D31ADAP 01521000
AVRCAC30 TM    PBXFLAG1,PBXFEAT1  IS DASD FAST WRITE SUPPORTED @DA44364 01522990
         BZ    AVRCAC35           NO,                          @DA44364 01524000
         TM    SSSAREA+5,X'20'    DASD FAST-WRITE INHIBITED    @DAOM    01525000
         BO    AVRCAC35           YES,                         @DAOM    01526000
         TM    SSSAREA+26,X'30'   IS DASD FAST WRITE ACTIVE    @D52VDAP 01527000
         BNZ   AVRCAC35           NO,                          @D31ADAP 01528000
         OI    VCTAFLG,VCTADFST   INDICATE DASD FAST WRITE     @D31ADAP 01529000
AVRCAC35 XC    AVRMSINF(1),VCTAFLG EXCLUSIVE OR OLD AND NEW    @D31ADAP 01530000
         NI    AVRMSINF,XFF-VCTAFOP-VCTARDY  PURGE NOT NEEDED  @DA44172 01531000
         MVI   AVRMSINF+1,ZERO    SET MESSAGE BYTE TO ZERO     @DA44172 01532000
         NI    PBXFLAG1,XFF-PBXFLCPY RESET FLASHCOPY SUPPORTED @DGA270  01533000
         TM    SSSAREA+27,VCTADXFC DOES DEVICE SUPPORT FL-COPY @DGA270  01534000
         BO    AVRFLCPY           YES,                         @DA44364 01535000
AVRTSTPP TM    VCTCFEA3,VCTCF3PP  PPRC SUPPORTED               @DA44172 01536000
         BO    AVRPPRPR           YES,                         @DA44172 01537000
AVRTSTDC TM    VCTCFEA4,VCTCF4DC  DUAL COPY SUPPORTED          @DA44172 01538000
         BO    AVRDCYPR           YES,                         @DA44364 01539000
         TM    VCTCRDVF,VCTCMIRC  MIRROR CAPABLE DEVICE        @DA44364 01540000
         BO    AVRMIRPR           YES                          @DA44364 01541000
AVRTSTNP DS    0H'0'                                                    01542000
           CLC   PBXLPMSV(1),PBXLPM ANY CHANGES                @D68REEF 01544000
           BE    AVRCAC90         NO,                          @D68REEF 01545000
           SLR   R1,R1            CLEAR REGISTER               @D68REEF 01546000
           ICM   R1,1,PBXLPNP     ANY NON-PREFERRED PATH       @D68REEF 01547000
           BZ    AVRCAC90         NO, SKIP NON-PREFERRED CODE  @D68REEF 01548000
           EX    R1,AVRPAXTM      NON-PREFERRED ENABLED        @D68REEF 01549000
           BZ    AVRPATHPP        NO, BACK TO PREFERRED        @D68REEF 01550000
           MVI   AVRMSINF+1,SW2NPREF SWITCHED TO NON-PREFERRED @D68REEF 01551000
           B     AVRPATHXT        PROVIDE PROPER MSG           @D68REEF 01552000
AVRPATHPP  OC    PBXLPM(1),PBXLPNP FORCE NON-PREFERRED ON      @D68REEF 01553000
           XC    PBXLPM(1),PBXLPNP TO GET THEM TURNED OFF NOW  @D68REEF 01554000
           MVI   AVRMSINF+1,SW2YPREF SWITCHED TO PREFERRED ON  @D68REEF 01555000
AVRPATHXT  MVC   PBXLPMSV,PBXLPM  SAVE CURRENT SETTING         @D68REEF 01556000
           B     AVRCAC90                                      @D68REEF 01557000
           SPACE 1                                             @D68REEF 01558000
AVRPAXTM   TM    PBXLPM,0         TEST FOR NON-PREFERRED       @D68REEF 01559000
.*                                                             @DAOM    01562000
.*       HANDLE FLASH COPY STATUS                              @DAOM    01563000
.*                                                             @DAOM    01564000
AVRFLCPY DS    0H'0'              FLASH-COPY PROCESSING        @DAOM    01565000
         OI    PBXFLAG1,PBXFLCPY  INDICATE FLASH COPY CAPABLE  @DGA270  01566000
         OC    PSFOAREA,PSFOAREA  DID WE READ ANY DATA         @D68PGA  01566300
         BZ    AVRFLC00           NO,                          @D68PGA  01566600
         MVC   VCTAESSF(1),PSFOAREA+32 FLASH COPY FEATURES     @D68ADAP 01567000
AVRFLC00 TM    SSSAREA+8,X'02'    IS FLASH-COPY ACTIVE         @DAOM    01568490
         BO    AVRFLC40           YES,                         @DAOM    01569000
*        TM    VCTAFLG1,VCTAFCPY+VCTAFCNO WAS FL-COPY ACTIVE   @DGA270  01570290
         TM    VCTAFLG1,VCTAFCPY  WAS FL-COPY ACTIVE           @D68PGA  01570580
         BZ    AVRTSTPP           NO, NOTHING TO DO            @DGA270  01571000
         AGO   .SKIP220                                        @D68PGA  01571690
         BO    AVRFLC20           FL-COPY NOCOPY TERMINATED    @DGA270  01572000
.SKIP220 ANOP                                                  @D68PGA  01573270
*        NI    VCTAFLG1,XFF-VCTAFCPY-VCTAFCNO RESET FC STATUS  @DGA270  01573380
         NI    VCTAFLG1,XFF-VCTAFCPY RESET FC STATUS           @D68PGA  01573570
         MVI   AVRMSINF+1,AVRFCPYT INDICATE FLASH COPY TERMINAT@DAOM    01574000
         B     AVRCAC90                                        @DAOM    01575000
         AGO   .SKIP240                                        @D68PGA  01575690
AVRFLC20 MVI   AVRMSINF+1,AVRFCNOT INDICATE FLASH COPY TERMINAT@DAOM    01576000
         NI    VCTAFLG1,XFF-VCTAFCPY-VCTAFCNO RESET FLASH COPY @DGA270  01577000
         B     AVRCAC90                                        @DAOM    01578000
.SKIP240 ANOP                                                  @D68PGA  01578690
AVRFLC40 DS    0H'0'              FL-COPY ACTIVATED PROCESSING @DAOM    01579000
         AGO   .SKIP260                                        @D68PGA  01579690
         MVI   PSFIAREA+6,X'11'   READ RELATIONSHIP FOR DEVICE @D68ADAP 01580000
         LA    RF,AVRDPSF         GET COMMAND CHAIN ADDRESS    @D68ADAP 01581000
         XC    PSFOAREA,PSFOAREA  CLEAR OUTPUT AREA            @D68ADAP 01582000
*HERE WE NEED TO NEED TO ISSUE PSF <READ FEATURE CODE>         @D68ADAP 01583000
         LA    R1,AVRCCB          GET DASD CCB ADDRESS         @DY46139 01584000
         USING CCBADR,R1          CCB BASE POINTER             @DY46139 01585000
         ST    RF,CCBCCW          PROVIDE CCW ADDRESS          @DY46139 01586000
         OI    CCBCOM1,OWNUCRT    USER-OWN ERROR PROCESSING    @DY46139 01587000
         OI    CCBBY3,USENSE      USER WANTS SENSE             @DY46139 01588000
         LA    R0,3               LOAD RETRY COUNTER           @D68ADAP 01589000
AVRFLC60 BAL   RE,AVRDSDIO        READ RELATIONSHIP TABLE      @D68ADAP 01590000
*SGLINK  AVRDSDIO INPUT=(R3,RE)                                @D68ADAP 01591000
         L     RE,AAVRSSSP        RELOAD BASE POINTER          @D68ADAP 01592000
         TM    CCBCOM1,DISERR     DID WE GET ANY ERROR         @D68ADAP 01593000
         BZ    AVRFLC80           NO,                          @D68ADAP 01594000
         BCT   R0,AVRFLC60        TRY AGAIN                    @D68ADAP 01595000
         DROP  R1                 RELEASE AVRCCB BASE          @D68ADAP 01596000
.SKIP260 ANOP                                                  @D68PGA  01596690
AVRFLC80 TM    VCTAFLG1,VCTAFCPY  WAS FLSH-COPY ACTIVE BEFORE  @DAOM    01597000
         BO    AVRTSTPP           YES, NOTHING TO DO           @DGA270  01598000
         OI    VCTAFLG1,VCTAFCPY  INDICATE FLASH-COPY ACTIVE   @DAOM    01600000
         MVI   AVRMSINF+1,AVRFCPYP INDICATE FLASH COPY PENDING @DAOM    01600300
         AGO   .SKIP280                                        @D68PGA  01600790
         TM    PSFOAREA+6,X'20'   IS BACKGROUND COPY PENDING   @DGA270  01601000
         BZ    AVRCAC90           YES, LEAVE THE MESSAGE       @DGA270  01602000
         OI    VCTAFLG1,VCTAFCNO  SET FLASH-COPY NOCOPY INDIC. @DGA270  01603000
         MVI   AVRMSINF+1,AVRFCPYN INDICATE FLASH-NOCOPY PEND. @DGA270  01604000
.SKIP280 ANOP                                                  @D68PGA  01604690
         B     AVRCAC90                                        @DAOM    01605000
.*                                                             @DA44172 01606000
.*       HANDLE DUAL COPY STATUS                               @DA44172 01607000
.*                                                             @DA44172 01608000
AVRDCYPR MVC   AVRMSINF+1(1),SSSAREA+26 CURRENT DEVICE STATUS  @DA44172 01609000
         XC    AVRMSINF+1(1),VCTADVS1 EXCLUSIVE OR NEW AND OLD @DA44172 01610000
         NI    AVRMSINF+1,X'0F'   LIMIT TO DUAL COPY STATUS    @DA44172 01611000
         CLI   AVRMSINF+1,ZERO    ANY CHANGES                  @DA44172 01612000
         BE    AVRCAC90           NO,                          @DA44172 01613000
         TM    VCTADVS1,X'0C'     WAS OLD THE PRIMARY/SECONDARY@D52VDAP 01614000
         BZ    AVRDCY40           NO,                          @D52VDAP 01615000
         MVI   AVRMSINF+1,AVRFSIM DEFAULT TO SIMPLEX FOR NOW   @D52VDAP 01616000
AVRDCY40 NI    VCTAFLAG,XFF-VCTACOPY RESET DUPLEX DEVICE       @D52VDAP 01617000
         NI    VCTAFLG1,XFF-VCTADUAL RESET DUAL COPY ACTIVE    @DA44172 01618000
         TM    SSSAREA+26,X'04'   IS THIS A SECONDARY DEVICE   @D52WDAP 01619000
         BZ    AVRDCY60           NO,                          @D52WDAP 01620000
         NI    PUBJCFLG,XFF-PUBDVCUP FORCE DEVICE DOWN         @D52WDAP 01621000
         OI    VCTAFLAG,VCTACOPY  INDICATE DUPLEX DEVICE       @D52WDAP 01622000
AVRDCY60 TM    SSSAREA+26,X'0C'   IS IT PART OF A DUPLEX PAIR  @D52WDAP 01623000
         BZ    AVRCAC90           NO,                          @D52WDAP 01624000
         OI    VCTAFLG1,VCTADUAL  INDICATE DUAL COPY ACTIVE    @DA44172 01625000
         MVI   AVRMSINF+1,AVRFDX  INDICATE DUPLEX ENTERED      @D52WDAP 01626000
         TM    SSSAREA+26,X'03'   IS DUPLEX PAIR AVAILABLE     @D52WDAP 01627000
         BZ    AVRCAC90           YES,                         @D52WDAP 01628000
         BO    AVRDCY80           PRIMARY FAILED               @D52WDAP 01629000
         MVI   AVRMSINF+1,AVRFFDX2 SECONDARY FAILED            @D52WDAP 01630000
         TM    SSSAREA+26,X'02'   DID SECONDARY FAIL           @D52WDAP 01631000
         BO    AVRCAC90           YES,                         @D52WDAP 01632000
         MVI   AVRMSINF+1,AVRFDPX DUPLEX MODE IS PENDING       @D52WDAP 01633000
         B     AVRCAC90                                        @D52WDAP 01634000
AVRDCY80 MVI   AVRMSINF+1,AVRFFDX1 PRIMARY FAILED              @D52WDAP 01635000
         B     AVRCAC90                                        @D52WDAP 01636000
.*                                                             @D62NDAP 01637000
.*       HANDLE PPRC      STATUS                               @D62NDAP 01638000
.*                                                             @D62NDAP 01639000
         SPACE 2                                                        01640000
AVRPPRPR TM    SSSAREA+8,X'40'    IS PPRC ACTIVE               @DA44172 01641000
         BO    AVRPPR00           YES,                         @DA44172 01642000
         TM    VCTAFLG1,VCTAPPRC  WAS PPRC ACTIVE BEFORE       @DA44172 01643000
         BZ    AVRTSTDC                                        @D68REEF 01644000
AVRPPR00 TM    VCTAFLG1,VCTAPPRC  WAS PPRC ACTIVE              @DA44172 01645000
         BZ    AVRPPR20           NO,                          @DA44172 01646000
         TM    SSSAREA+8,X'40'    IS PPRC STILL ACTIVE         @DA44616 01647000
         BZ    AVRPPR10           NO,                          @DA44616 01648000
         MVC   AVRMSINF+1(1),SSSAREA+26 CURRENT DEVICE STATUS  @DA44616 01649000
         XC    AVRMSINF+1(1),VCTADVS1 EXCLUSIVE OR NEW AND OLD @DA44616 01650000
         NI    AVRMSINF+1,X'03'   LIMIT TO PPRC PAIR STATUS    @DA44616 01651000
         CLI   AVRMSINF+1,ZERO    ANY CHANGES                  @DA44616 01652000
         BE    AVRCAC90           NO,                          @DA44616 01653000
         B     AVRPPR20           YES,                         @DA44616 01654000
AVRPPR10 MVI   AVRMSINF+1,AVRFSIM DEFAULT TO SIMPLEX FOR NOW   @DA44616 01655000
         NI    VCTAFLG1,XFF-VCTAPPRC RESET PPRC ACTIVE         @DA44616 01656000
         NI    VCTAFLG1,XFF-VCTADUAL RESET DUAL COPY ACTIVE    @DA44616 01657000
         NI    VCTAFLAG,XFF-VCTACOPY RESET DUPLEX DEVICE       @DA44616 01658000
         B     AVRCAC90                                        @DA44172 01659000
.*                                                                      01660000
.*       SET PPRC ACTIVE                                                01661000
.*                                                                      01662000
AVRPPR20 OI    VCTAFLG1,VCTAPPRC  INDICATE PPRC IS ACTIVE      @DA44172 01663000
         NI    VCTAFLG1,XFF-VCTADUAL RESET DUAL COPY ACTIVE    @DA44172 01664000
         NI    VCTAFLAG,XFF-VCTACOPY RESET DUPLEX DEVICE       @DA44172 01665000
         TM    SSSAREA+8,X'20'    IS THIS THE SECONDARY DEVICE @DA44172 01666000
         BZ    AVRPPR30           NO,                          @DA44172 01667000
         NI    PUBJCFLG,XFF-PUBDVCUP SET DEVICE DOWN           @DA44172 01668000
         OI    VCTAFLAG,VCTACOPY  INDICATE DUPLEX DEVICE       @DA44172 01669000
AVRPPR30 MVI   AVRMSINF+1,AVRFDX  INDICATE DUPLEX ENTERED      @DA44172 01670000
         TM    SSSAREA+26,X'03'   IS DUPLEX PAIR AVAILABLE     @DA44172 01671000
         BZ    AVRCAC90           YES,                         @DA44172 01672000
         BO    AVRPPR40           PPRC WAS SUSPENDED           @DA44172 01673000
         MVI   AVRMSINF+1,AVRFDPX DUPLEX MODE IS PENDING       @DA44172 01674000
         B     AVRCAC90                                        @DA44172 01675000
AVRPPR40 MVI   AVRMSINF+1,AVRFDCPS PPRC PAIR SUSPENDED         @DA44172 01676000
         B     AVRCAC90                                        @DA44172 01677000
.*                                                             @DA44472 01678000
.*       HANDLE MIRRORED DEVICE                                @DA44364 01679000
.*                                                             @DA44364 01680000
AVRMIRPR MVC   AVRMSINF+1(1),SSSAREA+26 CURRENT DEVICE STATUS  @DA44364 01681000
         NI    AVRMSINF+1,X'03'   LIMIT TO MIRROR STATUS       @DA44364 01682000
         NI    VCTADVS1,X'03'     LIMIT OLD SETTING TO MIRROR  @DA44364 01683000
         SLR   R1,R1              INDICATE NO MESSAGE          @DA44364 01684000
         CLC   AVRMSINF+1(1),VCTADVS1 ANY CHANGES              @DA44364 01685000
         BE    AVRMIR20           NO,                          @DA44364 01686000
         LA    R1,AVRFMIRA        INDICATE MIRRORING OPERATION.@DA44364 01687000
         TM    AVRMSINF+1,X'03'   IS THIS SUSPENDED STATE      @DA44364 01688000
         BZ    AVRMIR20           NO, MIRRORING IS OPERATIONAL @DA44364 01689000
         LA    R1,AVRFMIRS        INDICATE MIRRORING SUSPENDED @DA44364 01690000
         BO    AVRMIR20           YES, MIRRORING SUSPENDED     @DA44364 01691000
         LA    R1,AVRFMIRP        INDICATE MIRRORING PENDING   @DA44364 01692000
         TM    AVRMSINF+1,X'01'   MIRRORING PENDING            @DA44364 01693000
         BO    AVRMIR20           YES,                         @DA44364 01694000
         LA    R1,AVRFMIRF        INDICATE MIRRORING FAILED    @DA44364 01695000
AVRMIR20 STC   R1,AVRMSINF+1      SET MSG ID                   @DA44364 01696000
         B     AVRCAC90                                        @DA44364 01697000
         EJECT ,                                               @DA44364 01698000
AVRCAC90 MVC   VCTASSST(2),SSSAREA+4  SAVE CACHING + NVS STATUS@D52WDAP 01699000
         MVC   VCTADVS1(1),SSSAREA+26 SAVE DEVICE ST. BYTE 26  @D61ADMK 01700000
         MVC   VCTADXS1(1),SSSAREA+27 DEVICE STATUS INFO. OR   @DGA270  01701000
         TM    SSSAREA,X'01'      IN EXTENDED OPERATION MODE   @D61ADMK 01702000
         BO    AVRCAC95           YES, NO MASKING FOR 2ND DEV  @D61ADMK 01703000
         MVC   VCTADVI2(1),SSSAREA+27 SECONDARY DEV.-ID        @D61ADMK 01704000
         NI    SSSAREA+1,X'C0'    CLEAR ALL EXCEPT BIT 0-1     @D61ADMK 01705000
         NI    VCTADVI2,X'3F'     CLEAR BIT 0-1                @D61ADMK 01706000
         OC    VCTADVI2,SSSAREA+1 COPY FIRST 2 BITS FROM PRIM. @D61ADMK 01707000
AVRCAC95 MVC   VCTADVS2(1),SSSAREA+36 SAVE ADDITIONAL STATUS   @D61ADMK 01708000
         OC    AVRMSINF(2),AVRMSINF ANY CHANGES TO BE REPORTED @D52WDAP 01709000
         BZ    AVRDCT00           NO,  =====================>> @D52VDAP 01710000
         TM    VCTAPROC,VCTASTCK  ALREADY IN STATUS CHECK PROC.@D52WDAP 01711000
         BO    AVRDCT00           YES, =====================>> @D52WDAP 01712000
         L     R1,AAVRTAB         POINT AT 1ST VCTE            @D52WDAP 01713000
         LH    R0,AVRCOUNT        GET NO. OF ENTRIES           @D52WDAP 01714000
         DROP  R4                 RELEASE VCTE BASE POINTER    @D52WDAP 01715000
         USING VCTEADR,R1         NEW VCTE BASE POINTER        @D52WDAP 01716000
         LR    RA,R3              SAVE CURRENT PUB POINTER     @D52WDAP 01717000
AVRCACA0 ICM   R3,7,VCTAPUB+1     GET ASSOCIATED PUB POINTER   @D52WDAP 01718000
         BZ    AVRCACXT           NOT YET ALLOCATED            @D52VDAP 01719000
         CLR   R3,RA              IS THIS ORIGINATING PUB      @D52WDAP 01720000
         BE    AVRCACB0           YES, SKIP IT                 @D52WDAP 01721000
         BAL   R8,AVRGPUBX        CALCULATE ASSOCIATED PUBX    @D52WDAP 01722000
*SGLINK  AVRGPUBX,INPUT=(R3,R8,RC),OUTPUT=R9                   @D52VDAP 01723000
         TM    PBXFLAG,PBXDASD    IS THIS A DASD DEVICE        @D52WDAP 01724000
         BZ    AVRCACC0           NO,                          @D52WDAP 01725000
         TM    PBXFLAG1,PBXBUFFD  IS THIS A BUFFERED DEVICE    @D52WDAP 01726000
         BZ    AVRCACC0           NO                           @D52WDAP 01727000
         CLC   SSSAREA+38(2),VCTASSID IS IT SAME SUBSYSTEM     @D61ADAP 01728000
         BNE   AVRCACC0           NO,                          @D61ADAP 01729000
         CLC   VCTAFLG(1),VCTAFLG-VCTEADR(R4) SAME STATUS      @D61ADAP 01730000
         BE    AVRCACC0           YES,                         @D61ADAP 01731000
         OI    VCTAPROC,VCTAPWTD+VCTASTCK NEED TO CHECK STATUS @D52WDAP 01732000
         OI    SERFLGPR,SERDORDY  RE-INITIATE READY PROCESSING @D52WDAP 01733000
AVRCACB0 NI    PUBCSFLG,XFF-OPINTV RESET INTERVENTION REQUIRED @D52WDAP 01734000
AVRCACC0 AH    R1,VCTELEN         BUMP TO NEXT ENTRY           @D52WDAP 01735000
         BCT   R0,AVRCACA0        CHECK WHOLE TABLE            @D52WDAP 01736000
         DROP  R1                 DROP VCTE BASE POINTER       @D52WDAP 01737000
         USING VCTEADR,R4         VCTE STANDARD BASE           @D52WDAP 01738000
AVRCACXT LR    R3,RA              RESTORE ORIGINAL PUB POINTER @D52WDAP 01739000
         B     AVRDCT00                =====================>> @D52WDAP 01740000
AVRCACD0 L     R1,AAVRTAB         POINT TO 1ST VCTE            @D52WDAP 01741000
         LH    R0,AVRCOUNT        GET NO. OF ENTRIES           @D52WDAP 01742000
         DROP  R4                 RELEASE VCTE BASE POINTER    @D52WDAP 01743000
         USING VCTEADR,R1         NEW VCTE BASE POINTER        @D52WDAP 01744000
AVRCACD5 CLC   SSSAREA+1(1),VCTADVID IS THIS THE CORRECT DEV.  @D52WDAP 01745000
         BNE   AVRCACE0           NO,                          @D52WDAP 01746000
         CLC   SSSAREA+38(2),VCTASSID SAME SUBSYSTEM           @D52VDAP 01747000
         BE    AVRCACF0           YES,                         @D52VDAP 01748000
AVRCACE0 AH    R1,VCTELEN         BUMP TO NEXT ENTRY           @D52WDAP 01749000
         BCT   R0,AVRCACD5        CHECK WHOLE TABLE            @D52WDAP 01750000
         B     AVRDCT00                =====================>> @D61ADAP 01751000
AVRCACF0 OI    SERFLGPR,SERDORDY  NEED READY PROCESSING        @D52WDAP 01752000
         OI    VCTAPROC,VCTAPWTD  TABEL ENTRY MUST BE UPDATED  @D52VDAP 01753000
         B     AVRDCT00                =====================>> @D52VDAP 01754000
         DROP  R1                 RELEASE VCTEADR BASE         @D52WDAP 01755000
         DROP  R9                 RELEASE PUBX BASE            @D61ADAP 01756000
         DROP  R3                 RELEASE PUB BASE             @D61ADAP 01757000
         DROP  RE                 RELEASE AVRSSSCK BASE        @D25IDAP 01758000
         EJECT ,                                                        01759000
         USING RQTE,R2            RQT-ENTRY BASE               @DWORM   01760000
         USING PUBADR,R3          PUB BASE POINTER             @DWORM   01761000
         USING VCTEADR,R4         VCTE ENTRY BASE              @DWORM   01762000
         USING AVRASNPR,R8        AVRASNPR BASE POINTER        @DWORM   01763000
         USING PBXADR,R9          PUBX ENTRY BASE              @DWORM   01764000
*SGLINK  AVRASNPR INPUT=(R2,R3,R4,R8,R9,RE),WORK=(R0,R1)       @D68ADAP 01765000
AVRASNPR DS    0H'0'              ASSGN PROCESSING             @DWORM   01766000
         TM    PBXFLAG2,PBXNOVOL  WE HAVE IT ASSGNED ALREADY   @DA44471 01767000
         BZ    AVRASN99           YES,                         @D61ADAP 01768000
         TM    VCTAFLAG,VCTARSV   IS DEVICE TO BE RESERVED     @D61ADAP 01769000
         BO    AVRASN20           YES, GET IT ASSIGNED ANYWAY  @D61ADAP 01770000
         LR    R0,R3              COPY PUB POINTER             @DY46037 01771000
         SH    R0,YPUBTAB         PUB OFFSET                   @DY46037 01772000
         SRL   R0,3               PUB INDEX                    @DY46037 01773000
*        GETFLD FIELD=OWNER,PU=(0) GET OWNERSHIP               @DY46037 01774000
         GETFLD FIELD=OWNER,PU=(0) GET OWNERSHIP               @DY46037 01775000
         LTR   RF,RF              DOES OWNER EXIST             @DY46037 01776000
         BZ    AVRASN99           NO, NO NEED ASSGN IT YET     @DY46037 01777000
AVRASN20 LA    RF,AVRTCCW8        ASN CCW                      @D61ADAP 01778000
         LR    R1,RE              SAVE RETURN ADDRESS          @D68ADAP 01779000
         BAL   RE,TAPIORTN        ASN                          @D61ADAP 01780000
*SGLINK  TAPIORTN INPUT=(R2,R4,R9,RE,RF),OUTPUT=R0             @D68ADAP 01781000
         B     AVRASN40             0 O.K RETURN               @D61ADAP 01782000
         NI    VCTAFLAG,XFF-VCTARSV 4 RESET DEVICE RESERVED    @D61ADAP 01783000
         B     AVRASN60           JOIN MAIN LINE               @D61ADAP 01784000
AVRASN40 NI    PBXFLAG2,XFF-PBXNOVOL INDICATE WE OWN VOLUME    @D61ADAP 01785000
AVRASN60 LR    RE,R1              RESTORE RETURN ADDRESS       @D68ADAP 01786000
AVRASN99 BR    RE                 RETURN TO CALLER                      01787000
         DROP  R2                 RELEASE RQT-ENTRY BASE       @DWORM   01788000
         DROP  R4                 RELEASE VCT-ENTRY BASE       @DWORM   01789000
         DROP  R8                 RELEASE AVRASNPR  BASE       @DWORM   01790000
         DROP  R9                 RELEASE PUBX BASE            @DWORM   01791000
         EJECT ,                                                        01792000
*HERE      DO MESN (MEDIA SENSE PROCESSING) FOR TPA DEVICES    @DWORM   01793000
*          AIF   (NOT &VSE270).N280100                         @DWORM   01794000
           USING RQTE,R2          RQT-ENTRY BASE               @DWORM   01795000
           USING PUBADR,R3        PUB BASE POINTER             @DWORM   01796000
           USING VCTEADR,R4       VCTE ENTRY BASE              @DWORM   01797000
           USING AVRMESNPR,R8     AVRMESNPR BASE POINTER       @DWORM   01798000
           USING PBXADR,R9        PUBX ENTRY BASE              @DWORM   01799000
AVRMESNPR  DS    0H'0'            MEDIUM SENSE ROUTINE         @DWORM   01800000
           STM   RE,R1,AVRMESNSV                               @DWORM   01801000
AVRMESN00  NI    VCTAPROC,XFF-VCTAPWTD RESET WORK TO DO FLAG   @DWORM   01802000
           NI    PBXTDEN,XFF-PBXTWORM-PBXTWOWR RESET OLD SETTNG@DWORM   01803000
           LA    RF,AVRTCCW0      MESN MEDIA SENSE COMMAND     @DWORM   01804000
           BAL   RE,TAPIORTN      MESN                         @DWORM   01805000
*SGLINK  TAPIORTN INPUT=(R2,R4,R9,RE,RF),OUTPUT=R0             @DWORM   01806000
           B     AVRMESN10      0 O.K RETURN                   @DWORM   01807000
           LTR   R0,R0          4 PERMANENT ERROR              @DWORM   01808000
           BNZ   AVRTAP95         YES,                         @DWORM   01809000
           B     AVRMESN99        STRANGE                      @DWORM   01810000
AVRMESNSV  DC    4F'0'            REGISTER SAVE AREA           @DWORM   01811000
MESNMAP    DSECT                                               @DWORM   01812000
MESNSTAT   DC    XL1'00'        0 MEDIUM STATE                 @DWORM   01813000
MESN#NUND  EQU   B'11110000'      NOT UNDEFINED 00=UNDEFINED   @DWORM   01814000
MESN#LDCK  EQU   B'00010000'      1 LOAD CHECK                 @DWORM   01815000
MESN#UNLCK EQU   B'00100000'      2 UNLOAD CHECK               @DWORM   01816000
MESN#PMCK  EQU   B'00110000'      3 PATH MEDIUM CHECK          @DWORM   01817000
MESN#UNL   EQU   B'01000000'      4 UNLOADED                   @DWORM   01818000
MESN#LDG   EQU   B'01010000'      5 LOADING                    @DWORM   01819000
MESN#UNLG  EQU   B'01100000'      6 UNLOADING                  @DWORM   01820000
MESN#RSV   EQU   B'01110000'      7 UNUSED                     @DWORM   01821000
MESN#LNRDY EQU   B'10000000'      8 LOADED-NOT-READY           @DWORM   01822000
MESN#LDRDY EQU   B'10010000'      9 LOADED-READY               @DWORM   01823000
MESN#ASMNT EQU   B'00000001'      1 ASSOCIATED MOUNTED         @DWORM   01824000
MESN#ASNOM EQU   B'00000010'      2 ASSOCIATED NOT MOUNTED     @DWORM   01825000
MESNEMUFLG DC    XL1'00'        1 EMULATION FLAGS              @DWORM   01826000
MESN#EMU   EQU   X'80'            DEVICE EMULATION IS ACTIVE   @DWORM   01827000
MESN#VIRT  EQU   X'40'            DEVICE VIRTUALIZATION ACTIVE @DWORM   01828000
MESN#2NDV  EQU   X'10'            2N MEDIUM/FMT/CL/TYP VALID   @DWORM   01829490
MESNPMID   DC    XL2'00'        2 PRIMARY   MEDIUM-ID          @DWORM   01830000
MESNPFID   DC    XL1'00'        4 PRIMARY   FORMAT-ID          @DWORM   01831000
MESNSMID   DC    XL2'00'        5 SECONDARY MEDIUM-ID          @DWORM   01832000
MESNSFID   DC    XL1'00'        7 SECONDARY FORMAT-ID          @DWORM   01833000
MESNMFLG1  DC    XL1'00'        8 MEDIUM FLAGS 1               @DWORM   01834000
MESN#FREQ  EQU   X'80'            FORMATTING REQUIRED          @DWORM   01835000
MESN#VCRE  EQU   X'40'            VCR IN ERROR                 @DWORM   01836000
MESN#PAR   EQU   X'20'            VOLUME IS PARTITIONED        @DWORM   01837000
MESN#PARE  EQU   X'10'            PARTITION DEFINITION ERROR   @DWORM   01838000
MESN#PPROT EQU   X'02'            PYSICAL WRITE PROTECED       @DWORM   01839000
MESN#LPROT EQU   X'01'            LOGICAL WRITE PROTECED       @DWORM   01840000
MESNMFLG2  DC    XL1'00'        9 MEDIUM FLAGS 2               @DWORM   01841000
MESN#FACC  EQU   X'0C'            FAST ACCESS BITS             @DWORM   01842000
MESNMFLG3  DC    XL1'00'        A MEDIUM FLAGS 3               @DWORM   01843000
MESNMFLG4  DC    XL1'00'        B MEDIUM FLAGS 4               @DWORM   01844000
MESN#WORM  EQU   X'40'            WORM MEDIA IS LOADED         @DWORM   01845000
MESN#WOWR  EQU   X'20'            WORM MEDIA IS WRITABLE       @DWORM   01846000
           DC    XL4'00'        C RESERVED                     @DWORM   01847000
MESNPARNO  DC    XL2'00'       10 PARTITION NUMBER             @DWORM   01848000
MESNKBTRA  DC    XL6'00'       12 KILO-BYTDES TRAVERSED        @DWORM   01849000
MESNMPOS   DC    XL1'00'       18 MEDIUM POSITION              @DWORM   01850000
MESNPPOS   DC    XL1'00'       19 PARTITION POSITION           @DWORM   01851000
MESNCSCAL  DC    XL1'00'       1A CAPACITY SCALING             @DWORM   01852000
MESNOSCAL  DC    XL1'00'       1B OPTIMUM SCALING ARGUMENT     @DWORM   01853000
MESNMSCAL  DC    XL1'00'       1C MAXIMUM SCALING ARGUMENT     @DWORM   01854000
           DC    XL3'00'       1D RESERVED                     @DWORM   01855000
MESNMUCAP  DC    XL4'00'       20 MEDIUM UNCOMPRESSED CAPACITY @DWORM   01856000
MESNPUCAP  DC    XL4'00'       24 PARTITION UNCOMP. CAPACITY   @DWORM   01857000
MESNEXFLG  DC    XL1'00'       28 EXTERNAL VOLID FLAG          @DWORM   01858000
MESN#EVAL  EQU   X'80'            EXTERNAL VOLID FLAGS VALID   @DWORM   01859000
MESN#EEBCD EQU   X'40'            VOLID IS EBCDIC              @DWORM   01860000
MESNPCLTY  DC    XL1'00'       29 PRIMARY VOLUME CLASS/TYPE    @DWORM   01861000
MESNIS3480 EQU   X'00'            CLASS IS 3480 1/2" CART      @DAOME05 01861060
MESNMED1   EQU   X'00'            MEDIA-1 STD LENGTH CART      @DAOME05 01861120
MESNMED2   EQU   X'01'            MEDIA-2 EXT LENGTH CART      @DAOME05 01861180
MESNIS3590 EQU   X'10'            CLASS IS 3590 1/2" CART      @DAOME05 01861240
MESNMED3   EQU   X'10'            MEDIA-3 STD LENGTH CART      @DAOME05 01861300
MESNMED4   EQU   X'11'            MEDIA-4 EXT LENGTH CART      @DAOME05 01861360
MESNIS3592 EQU   X'20'            CLASS IS 3592 1/2" CART      @DAOME05 01861420
MESNMED5   EQU   X'20'            MEDIA-5  STD LENGTH CART     @DAOME05 01861480
MESNMED6   EQU   X'21'            MEDIA-6  STD LENGTH   WORM   @DAOME05 01861540
MESNMED7   EQU   X'22'            MEDIA-7  SHORT LENGTH CART   @DAOME05 01861600
MESNMED8   EQU   X'23'            MEDIA-8  SHORT LENGTH WORM   @DAOME05 01861660
MESNMED9   EQU   X'24'            MEDIA-9  EXT LENGTH   CART   @DAOME05 01861720
MESNMED10  EQU   X'25'            MEDIA-10 EXT LENGTH   WORM   @DAOME05 01861780
MESNISRESV EQU   X'30'            CLASS IS RESERVED            @DAOME05 01861840
MESNINFLG  DC    XL1'00'       2A INTERNAL VOLID FLAG          @DWORM   01862000
MESN#IVAL  EQU   X'80'            INTERNAL VOLID FLAGS VALID   @DWORM   01863000
MESN#IEBCD EQU   X'40'            VOLID IS EBCDIC              @DWORM   01864000
MESNSCLTY  DC    XL1'00'       2B SECONDARY VOLUME CLASS/TYPE  @DWORM   01865000
           DC    XL4'00'       2C RESERVED                     @DWORM   01866000
MESNEXVOL1 DC    CL6'00'       30 EXTERNAL VOLUME IDENTIFIER   @DWORM   01867000
           DC    XL2'00'       36 RESERVED                     @DWORM   01868000
MESNINVOL1 DC    CL6'00'       38 INTERNAL VOLUME IDENTIFIER   @DWORM   01869000
           DC    XL2'00'       3E RESERVED                     @DWORM   01870000
MESNM2UCAP DC    XL4'00'       40 MEDIUM UNCOMPRESSED CAP.     @DWORM   01871000
MESNP2UCAP DC    XL4'00'       44 PARTITION UNCOMPRESSED CAP.  @DWORM   01872000
MESNWWWID  DC    XL12'00'      48 CARTRIDGE UNIQUE WWW-ID      @DWORM   01873000
MESNMOCNT  DC    XL2'00'       54 WORM TAPE MOUNT COUNT        @DWORM   01874000
           DC    XL26'00'      56 RESERVED                     @DWORM   01875000
MESNFACCAP DC    XL4'00'       70 FAST ACCESS  UNCOMP. CAP.    @DWORM   01876000
MESNMAXFIL DC    XL4'00'       74 MAXIMUM FILE COUNT           @DWORM   01877000
MESNMAXWRT DC    XL4'00'       78 MAX BLOCK-SIZE SINCE SYNC    @DWORM   01878000
MESNMAXBLK DC    XL4'00'       7C MAX LOGICAL BLOCK COUNT      @DWORM   01879000
*                              7F LAST BYTE OF MESN DATA       @DWORM   01880000
.*                                                             @DWORM   01881000
.*      BYTES 64-127  OF SENSE MEDIUM INFORMATION NOT YET USED @DWORM   01882000
.*                                                             @DWORM   01883000
           SPACE 1                                             @DWORM   01884000
&SYSECT    CSECT                                               @DWORM   01885000
AVRMESN10  DS    0H'0'            EXAMINE THE MEDIA SENSE DATA @DWORM   01886000
           TM    VCTAPROC,VCTAPWTD  ANOTHER 'READY' RECEIVED   @DWORM   01887000
           BO    AVRMESN00        YES, REPEAT MESN COMMAND     @DWORM   01888000
.*                                                             @DWORM   01889000
.*         EXAMINE MEDIA SENSE DATA NOW                        @DWORM   01890000
.*                                                             @DWORM   01891000
           LA    R1,RQTMESN       ADDRESS OF MEDIA SENSE DATA  @DWORM   01892000
           USING MESNMAP,R1       MEDIUM SENSE BASE POINTER    @DWORM   01893000
*HERE WE NEED TO CHECK AND PROCESS ANSI LABELS                 @DWORM   01894000
           TM    MESNINFLG,MESN#IVAL IS VOLID INFO VALID       @DWORM   01895000
           BZ    AVRMESN30        NO,                          @DWORM   01896000
           MVC   RQTVOL1(4),CVOL1 SET CONSTANT "VOL1"          @DWORM   01897000
           MVC   RQTSVOL(6),MESNINVOL1 ASSUME EBCDIC FOR NOW   @DWORM   01898000
           TM    MESNINFLG,MESN#IEBCD IS IT EBCDIC             @DWORM   01899000
           BO    AVRMESN20        YES,                         @DWORM   01900000
           L     RE,RASLINKA+4    GET ASCII TABLE ADDRESS      @DWORM   01901000
           LTR   RE,RE            IS ASCII TABLE PRESENT       @DWORM   01902000
           BZ    AVRMESN30        NO,                          @DWORM   01903000
           TR    RQTSVOL(6),0(RE) TRANSLATE TO EBCDIC          @DWORM   01904000
AVRMESN20  NI    VCTAFLAG,XFF-VCTANVOL SET VOL1 VALID          @DWORM   01905000
AVRMESN30  DS    0H'0'                                         @DWORM   01906000
           IC    RF,MESNSTAT      GET STATE/ASSOCIATION STATE  @DWORM   01907000
           N     RF,F240          LEAVE STATE INFORMATION ONLY @DWORM   01908000
           SRL   RF,4             REMOVE UNUSED BITS           @DWORM   01909000
           CH    RF,H8            HAS DEVICE BEEN LOADED       @DWORM   01910000
           BL    AVRMESN99        NO,                          @DWORM   01911000
*HERE CHECK MORE DETAILED                                               01912000
           NI    PBXFLAG1,XFF-PBXRONLY RESET PHYSIC.-READ-ONLY @DWORM   01913000
           TM    MESNMFLG1,MESN#PPROT IS IT A READ ONLY CART   @DWORM   01914000
           BZ    AVRMESN35        NO,                          @DWORM   01915000
           OI    PBXFLAG1,PBXRONLY INDICATE READ ONLY CART     @DWORM   01916000
AVRMESN35  TM    MESNMFLG4,MESN#WORM WORM CARTRIDGE MOUNTED    @DWORM   01917000
           BZ    AVRMESN40        NO,                          @DWORM   01918000
           OI    PBXTDEN,PBXTWORM INDICATE WORM DEVICE         @DWORM   01919000
           TM    MESNMFLG4,MESN#WOWR HAS ANY DATA BEEN WRITTEN @DWORM   01920000
           BZ    AVRMESN40        NO,                          @DWORM   01921000
           OI    PBXTDEN,PBXTWOWR INDICATE WORM NON-OVERWRITE  @DWORM   01922000
           LA    RF,VCTTLEN       LENGTH OF TAPE VCT-ENTRY     @DELETE  01923000
           CH    RF,VCTELEN       ENOUGH STORAGE ALLOCATED     @DELETE  01924000
           BH    AVRMESN99        NO, SKIP THE CODE            @DELETE  01925000
           LH    RF,MESNMOCNT     GET WORM MOUNT COUNT         @DWORM   01926000
           STH   RF,VCTTMOCNT     SAVE WORM MOUNT COUNT IN VCT @DWORM   01927000
           MVC   VCTTWWWID,MESNWWWID SAVE CARTRIDGE UNIQUE ID  @DWORM   01928000
AVRMESN40  DS    0H'0'            MEDIUM CLASS/TYPE PROCESSING @DWORM   01929000
           MVC   VCTTMEDIA,CCSTX  INITIALIZE MEDIA TO CSTX     @DWORM   01930490
           LA    RF,MESNPCLTY     POINT TO CLASS/TYPE INFO     @DWORM   01931000
           TM    MESNEMUFLG,MESN#EMU MEDIUM/FORMAT EMULATION   @DWORM   01932000
           BZ    AVRMESN50        NO,                          @DWORM   01933000
           LA    RF,MESNSCLTY     POINT TO CLASS/TYPE INFO     @DWORM   01934000
AVRMESN50  LA    RE,1             ASSUME CST1/MEDIA-1          @DAOME05 01935690
           TM    0(RF),MESNISRESV THIS CLASS=0 OR 3            @DWORM   01936380
           BZ    AVRMESN60        IT IS CLASS=0 3480/3490      @DWORM   01937070
           BO    AVRMESN80        UNKNOWN CLASS LEAVE IT CSTX  @DWORM   01938000
.*         CLASS IS KNOWN TO US                                         01939490
           LA    RE,3             ASSUME CST3/MEDIA-3 FOR NOW  @DWORM   01939980
           TM    0(RF),MESNIS3592 IS THIS CLASS=2              @DWORM   01940470
           BZ    AVRMESN60        NO ITS CLASS=1               @DWORM   01941000
.*         3592  CLASS=2 PROCESSING                            @DWORM   01942000
           IC    RE,0(,RF)        CLEAR REGISTER               @DWORM   01943000
           N     RE,F15           RESET UNUSED INFO            @DWORM   01944000
           C     RE,F6            IS IT GREATER THAN EXPECTED  @DAOME05 01945490
           BNL   AVRMESN80        YES, LEAVE IT CSTX           @DWORM   01946000
           LA    RE,5(,RE)        ADD BASE                     @DWORM   01947490
           B     AVRMESN70        AND SAVE MEDIA TYPE          @DWORM   01948000
.*         3592  CLASS=0/1 PROCESSING                          @DWORM   01949490
AVRMESN60  DS    0H'0'            CLASS-0 / CLASS-1 PROCESSING @DWORM   01949980
           TM    0(RF),X'0F'-MESNMED2  IS IT A KNOWN VALUE     @DWORM   01950470
           BNZ   AVRMESN80        NO,  LEAVE IT CSTX           @DWORM   01950960
           TM    0(RF),MESNMED2   STANDARD LENGTH CART.        @DWORM   01951450
           BZ    AVRMESN70        YES, SAVE CST INFO           @DWORM   01952000
           LA    RE,1(,RE)        INDICATE EXTENDED CART. LEN. @DWORM   01953190
AVRMESN70  CVD   RE,SERIPAK8      CONVERT TO DECIMAL           @DAOME05 01953380
           OI    SERIPAK8+7,X'0F' ADJUST SIGN POSITION         @DAOME05 01953570
           UNPK  VCTTMEDIA+3(2),SERIPAK8+6(2) MAKE IT PRINTABLE@DAOME05 01953760
           CLI   VCTTMEDIA+3,C'0' IS THIS A LEADING ZERO       @DAOME05 01953950
           BNE   AVRMESN80        NO, WE NEED THAT VALUE       @DAOME05 01954140
           MVC   VCTTMEDIA+3(1),VCTTMEDIA+4 OVERWRITE LEAD.ZERO@DAOME05 01954330
           MVI   VCTTMEDIA+4,C' ' BLANK THE SHIFTED CHARACTER  @DAOME05 01954520
           DROP  R1               RELEASE MESNMAP BASE         @DWORM   01955000
AVRMESN80  DS    0H'0'            END OF CLASS/TYPE PROCESSING @DWORM   01956000
AVRMESN99  DS    0H'0'            EXIT PROCESSING              @DWORM   01957000
           LM    RE,R1,AVRMESNSV  RESTORE CALLERS REGISTERS    @DWORM   01958000
           BR    RE                    ======================> @DWORM   01959000
           DROP  R2               RELEASE RQT-ENTRY BASE       @DWORM   01960000
           DROP  R4               RELEASE VCT-ENTRY BASE       @DWORM   01961000
           DROP  R8               RELEASE AVRMESNPR BASE       @DWORM   01962000
           DROP  R9               RELEASE PUBX BASE            @DWORM   01963000
.N280100   ANOP                                                @DWORM   01964000
         TITLE 'VSE SUPERVISOR     SGSER   TAPE ERROR PROCESSING      ' 01965000
.*                                                                      01966000
.*       GENERAL TAPE I/O ERROR ROUTINE                                 01967000
.*                                                                      01968000
.*                                                                      01969000
.*       CHECK FOR NON-DEVICE RELATED ERROR CONDITIONS                  01970000
.*       AND SET THE APPROPRIATE RETURN CODE.                           01971000
.*       IN CASE OF COMMAND REJECT, ADVANCE TO THE NEXT CHAINED         01972000
.*       CCW AND RETRY THE CHANNEL PROGRAM FROM THERE.                  01973000
.*       FOR ALL OTHER ERRORS, RETRY THE OPERATION A LIMITED            01974000
.*       NUMBER OF TIMES BEFORE POSTING A PERMANENT ERROR.              01975000
.*                                                                      01976000
         USING PBXADR,R9          PUBX BASE POINTER            @D61ADAP 01977000
         USING VCTEADR,R4         VCTE BASE POINTER            @D61ADAP 01978000
         USING PUBADR,R3          PUB BASE POINTER             @D14BDAP 01979000
         USING RQTE,R2            RQT-ENTRY BASE               @DBOC    01980000
         USING AVRTAERR,RE        SUBROUTINE BASE              @DA44471 01981000
AVRTAERR CLI   RQTCCB+5,X'FE'     UNIQUE NOT-OPERATIONAL CODE  @D61ADAP 01982000
         BE    AVRTAPNO           YES,                         @D61ADAP 01983000
         OI    VCTAFLG,VCTAFOP+VCTARDY DEVICE IS READY         @D61ADAP 01984000
         CLI   RQTSNSDT,INTVRQD   INTERVENTION REQUIRED        @DBOC    01985000
         BNE   AVRTAE10           NO,                          @DA43896 01986000
AVRTAPIR NI    VCTAFLG,XFF-VCTARDY INDICATE TAPE NOT READY     @D61ADAP 01987000
         LA    R0,MODVCENO        SET RETURN CODE              @D61ADAP 01988000
         OI    VCTAFLAG,VCTANVOL  SET VOL1 INVALID             @D61ADAP 01989000
         B     TAPIORC4           TAKE ERROR EXIT              @DA44634 01990000
AVRTAPNO LA    R0,MODVCNOP        NOT OPERATIONAL RETURN CODE  @D61ADAP 01991000
         NI    VCTAFLG,XFF-VCTARDY-VCTAFOP SET NOT OPERATIONAL @D61ADAP 01992000
         OI    VCTAFLAG,VCTANVOL  SET VOL1 INVALID             @D61ADAP 01993000
         B     TAPIORC4           TAKE ERROR EXIT              @DA44634 01994000
AVRTAPAE LA    R0,MODVCEAE        ASSIGNED ELSEWHERE           @D61ADAP 01995000
         OI    VCTAFLAG,VCTASHR+VCTANVOL SHARED / VOL1 INVALID @D61ADAP 01996000
         NI    VCTAFLAG,XFF-VCTARSV RESET DEVICE RESERVED BIT  @D61ADAP 01997000
         B     TAPIORC4           TAKE ERROR  EXIT             @DA44634 01998000
         SPACE 1                                                        01999000
AVRTAE10 TM    PBXTREC,PBXTCTG    IS THIS A CARTRIDGE          @D62TAAP 02000000
         BZ    AVRTAE40           NO,                          @D62TAAP 02001000
AVRTAE20 CLI   RQTSNSDT+3,X'45'   ASSIGNED ELSEWHERE           @DBOC    02002000
         BE    AVRTAPAE           YES,                         @D61ADAP 02003000
         TM    RQTSNSDT,X'02'     IS THIS A DEFERRED UNIT CHECK@DBOC    02004000
         BZ    AVRTAE40           NO, TEST FOR OTHER CONDITIONS@D61ADAP 02005000
AVRTAE30 BCT   R0,TAPIORTY        RETRY======================> @D61ADAP 02006000
.*                                                             @D61ADAP 02007000
.*       UNRECOVERABLE ERROR CONDITION                         @D61ADAP 02008000
.*                                                             @D61ADAP 02009000
         LA    R0,MODVCEER        ANY OTHER ERROR              @DY45540 02010000
         B     TAPIORC4           TAKE ERROR EXIT              @DA44634 02011000
AVRTAE40 CLI   PUBDEVTY,TTPA      IS THIS A TPA DEVICE         @DA44172 02012000
         BE    AVRTAE60           YES,                         @DA44172 02013000
         TM    RQTSNSDT,COMREJ    WAS COMMAND CHAIN REJECTED   @DBOC    02014000
         BO    AVRTAE50           YES, TRY NEXT CCW            @DA43914 02015000
         CLI   0(RF),RDCOM        DID WE ATTEMPT VOL1 READ     @DA43914 02016000
         BNE   AVRTAE30           NO, RETRY                    @DA43914 02017000
         TM    RQTCCB+4,CHANEND+DEVEND INITIAL SELECTION       @DA43914 02018000
         BZ    AVRTAE30           YES, TRY AGAIN               @DA43914 02019000
         B     TAPIORUX           ASSUME BRAND NEW TAPE        @DA43914 02020000
AVRTAE50 SLR   R0,R0              INDICATE NO PERMANENT ERROR  @D61ADAP 02021000
         TM    4(RF),CC           IS A COMMAND CHAINED         @D61ADAP 02022000
         BZ    TAPIORC4           ERR, ======================> @DA44634 02023000
         LA    RF,8(,RF)          ADVANCE TO NEXT CCW          @D61ADAP 02024000
         B     TAPIORNS           RETRY======================> @D61ADAP 02025000
AVRTAE60 TM    RQTSNSDT+2,X'C0'   IS IT A PERMANENT ERROR      @DBOC    02026000
         BZ    AVRTAE50           YES,                         @DA44172 02027000
         BO    AVRTAE70           IT IS A DELAYED RETRY        @DA44172 02028000
         TM    RQTSNSDT+2,X'80'   IS RETRY POSSIBLE            @DBOC    02029000
         BO    AVRTAE30           YES,                         @DA44172 02030000
         B     AVRTAE50           CONTINUE OUR CHAIN           @DA44172 02031000
AVRTAE70 OI    PUBCSFLG,OPINTV    FORCE DELAYED RETRY          @DA44172 02032000
         B     AVRTAE30           TAKE RETRY EXIT              @DA44172 02033000
         DROP  R2                 RELEASE RQT-ENTRY BASE       @DBOC    02034000
         DROP  R4                 RELEASE VCTE BASE            @DA44172 02035000
         DROP  R9                 RELEASE PUBX BASE POINTER    @DA44172 02036000
         DROP  RE                 RELEASE AVRTAERR BASE        @D25IDAP 02037000
         TITLE 'VSE SUPERVISOR     SGSER   ALLOCATE DCT ENTRY FOR CKD ' 02038000
.********************************************************************** 02039000
.*                                                                      02040000
.* FUNCTION     - ALLOCATE DCT ENTRY ADDRESS                            02041000
.* INPUTS       - R3       = ADDR OF PUB FOR REQUESTED DEVICE           02042000
.*              - SERSNSDT = SENSE DATA READ FROM DEVICE                02043000
.* OUTPUTS      - RF       =DISPLACEMENT TO DCT ENTRY                   02044000
.*              - PUB      =DEVICE TYPE CODE FOR 3340                   02045000
.* EXITS-       - TO DEVICE SPECIFIC CODE                               02046000
.* SUBROUTINES- NONE                                                    02047000
.*                                                                      02048000
.********************************************************************** 02049000
         SPACE 1                                               @D37ADAP 02050000
SERDEVOT DSECT                    DEVICE OFFSET TABLE          @D37ADAP 02051000
SERDCTOF DC    AL2(0)             OFFSET OF DCT ENTRY          @D37ADAP 02052000
SERACTOF DC    AL2(0)             OFFSET OF ACTION TO BE DONE  @D37ADAP 02053000
         SPACE 1                                               @D37ADAP 02054000
&SYSECT  CSECT                                                 @D37ADAP 02055000
         USING PBXADR,R9          PUBX BASE POINTER            @D61ADAP 02056000
         USING VCTEADR,R4         VCTE BASE POINTER            @D61ADAP 02057000
         USING AVRADCT,RE         SUBROUTINE BASE              @DA44471 02058000
         USING DVCCNTAB,RF        DVCCNTAB BASE                @D51EDAP 02059000
AVRADCT  DS    0H'0'              FIND DCT TABLE ENTRY         @DA44471 02060000
         AIF   (NOT &BG31).NRPS010                             @D35VDAP 02061000
         CLI   VCTATYPE,VCTAFBA   IS THIS AN FBA DEVICE        @DA44471 02062000
         BE    AVRUDASD           YES, =====================>> @D68ADAP 02063000
         TM    PUBJCFLG,RPSDASD   DOES DEVICE HAVE RPS         @D35VDAP 02064000
         BZ    AVRNORPS           NO,                          @D35VDAP 02065000
         MVI   VCTATYPE,VCTARPS   DEVICE IS CKD WITH RPS       @D35VDAP 02066000
.NRPS010 ANOP                                                  @D35VDEP 02067000
AVRNORPS LA    RF,SERDSKTB        ADDRESS OF DISKETTE TABLE    @D14BDAP 02068000
         CLI   PUBDEVTY,T3540     IS THIS A DISKETTE           @D14BDAP 02069000
         BE    AVRU3540           YES                          @D14BDAP 02070000
*        TM    PUBDEVTY,X'F0'-TCKD IS THIS A CKD DEVICE        @D37ADAP 02071000
*        BNZ   AVRUDASD           NO,  =====================>> @D52HDAP 02072000
         XR    RF,RF              CLEAR REGISTER               @D37ADAP 02073000
         IC    RF,PUBDEVTY        GET DEVICE TYPE CODE         @D37ADAP 02074000
         N     RF,F15             TURN OFF ZONE BIT            @D37ADAP 02075000
         SLL   RF,2               MULTIPLY WITH FOUR           @D37ADAP 02076000
         A     RF,ASERDEVT        ADD BEGIN ADDRESS            @D37ADAP 02077000
         USING SERDEVOT,RF        OFFSET/ACTION TABLE BASE PNTR@D37ADAP 02078000
AVRU3540 LH    RE,SERACTOF        ACTION OFFSET                @D37ADFG 02079000
         LH    RF,SERDCTOF        GET DCT OFFSET               @D37ADFG 02080000
         A     RF,ADCTTAB         ADDRESS OF DCT TABLE ENTRY   @D21LDAP 02081000
         AR    RE,RD              ADD BASE ADDRESS             @D37ADAP 02082000
         DROP  RE                 RELEASE SUBROUTINE BASE      @DA44471 02083000
         BR    RE                 ACT. ======================> @D37ADAP 02084000
         DROP  RF                 RELEASE DCT ENTRY BASE       @D37ADAP 02085000
         TITLE 'VSE SUPERVISOR     SGSER    UPDATE VCTE ENTRY FOR CKD ' 02086000
.*       ON ENTRY TO AVRUCKMR  VCTAREMV BIT WAS ALREADY SET UP @D21LDAP 02087000
         USING AVRUCKMR,RE        UPDATE CKD ROUTINE BASE      @DA44364 02088000
         USING DVCCNTAB,RF        DVCCNTAB BASE                @DA44364 02089000
AVRUCKMR DS    0H'0'                                                    02090000
*        ICM   R8,15,PBXVCTE      VALID CHARACTERISTICS EXISTS @TEST    02091000
*        BNZ   AVRSSSCK           YES, =====================>> @TEST    02092000
         TM    PBXFLAG2,PBXNOSIO  VALID CHARACTERISTICS EXISTS @TEST    02093000
         BZ    AVRSSSCK           YES, =====================>> @TEST    02094000
         ST    R4,PBXVCTE         SET VCTE ENTRY ADDRESS       @TEST    02095000
         NI    PBXFLAG2,XFF-PBXNOSIO PREVENT INTERCEPT FOR NOW @TEST    02096000
         MVC   VCTADVID(1),SSSAREA+1 INITIALIZE DEVICE ID FIELD@D52WDAP 02097000
         MVC   VCTASSID(2),SSSAREA+38 INITIALIZE SSID          @D52VDAP 02098000
         MVC   VCTAPUBC(L'DVCCNPCD),DVCCNPCD SET DEVICE CODES  @D51EDAP 02099000
         MVC   VCTACATB(L'VCTACATB),DVCCNOSC SET OS CODES      @D51EDAP 02100000
         MVC   VCTAEXTC(L'VCTAEXTC),DVCCNEXC USE CONSTANT      @D51EDAP 02101000
         TM    PBXFLAG1,PBXRONLY  IS THIS READ ONLY DEVICE     @DY45540 02102000
         BZ    AVRUCM00           YES                          @DY45540 02103000
         OI    VCTACDCS,VCTANWRT  INDICATE READ ONLY DEVICE    @DY45540 02104000
AVRUCM00 SLR   R8,R8                                           @D51GDAP 02105000
         ICM   R8,7,RDCCAREA+17   DO WE HAVE VALID DATA        @D51EDAP 02106000
         BNZ   AVRUCM20           YES                          @D51EDAP 02107000
         ICM   R8,15,DVCCNTGC     USE GROSS CAPACITY           @D51GDAP 02108000
         STCM  R8,15,VCTCGCAP     SET GROSS CAPACITY           @D51GDAP 02109000
         SH    R8,DVCCNHR0        SUBTRACT HA+R0 BYTE COUNT    @D51GDAP 02110000
         STCM  R8,3,VCTCR0MX      MAX R0 COUNT                 @D51GDAP 02111000
         MVC   VCTCDCLS(DVCCNTGC-DVCCNCLS),DVCCNCLS            @D51EDAP 02112000
         CLI   PUBDEVTY,T3540     IS THIS A 3540 DISKETTE      @DA40427 02113000
         BE    AVRUCM80           YES,                         @TEST    02114000
         CLI   PUBDEVTY,T3380     IS THIS A 3380 DEVICE        @D51GDAP 02115000
         BE    AVRUCM70           YES, ITS A 3380              @D51GDAP 02116000
         BH    AVRUCM80           ECKD (3390/2105)             @D51GDAP 02117000
*VRUCM10 DS    0H'0'              DEVICE IS A 3540 OR OLD CKD  @TEST    02118000
*        ST    R4,PBXVCTE         SET VCTE ENTRY ADDRESS       @TEST    02119000
         B     AVRUCM80                                        @D51EDAP 02120000
         SPACE 1                                                        02121000
AVRUCM20 DS    0H'0'              DATA HAS BEEN READ           @D51GDAP 02122000
*        ST    R4,PBXVCTE         SET VCTE ENTRY ADDRESS       @TEST    02123000
         MVC   VCTCADR(L'RDCCAREA),RDCCAREA MOVE DATA TO VCTE  @D51EDAP 02124000
         CLI   VCTADTFC,ZERO      IS THIS AN ECKD DEVICE       @D51EDAP 02125000
         BNE   AVRUCM30           NO,                          @D51EDAP 02126000
         MVC   VCTADTFC(1),VCTCDTYP SET DTF DEVICE TYPE CODE   @D51EDAP 02127000
         NI    PBXFLAG,XFF-PBXMSSDV RESET MASS STORAGE DEVICE  @D52VDAP 02128000
         CLI   VCTCMDR,X'31'      IS THIS A 3995 DEVICE        @D52VDAP 02129000
         BNE   AVRUCM30           NO,                          @D52VDAP 02130000
         OI    PBXFLAG,PBXMSSDV   INDICATE MASS STORAGE DEVICE @D52VDAP 02131000
AVRUCM30 MVC   VCTCGCAP(L'VCTCGCAP),DVCCNTGC SET GROSS CAPACITY@D51EDAP 02132000
         UNPK  SERIWORK(7),RDCCAREA+3(4) GET REAL DEVICE CODE  @D51GDAP 02133000
         TR    SERIWORK(6),HEXCHTAB-X'F0' TRANSLATE TO PRINTABL@D51GDAP 02134000
         MVC   VCTAEXTC(6),SERIWORK GET IT IN PRINTABLE FORMAT @D51GDAP 02135000
         MVI   PBXSNSID,XFF       INDICATE VALID ENTRY         @D51EDAP 02136000
         MVC   PBXCUTYP(6),VCTCCUTY GET SENSE ID INFORMATION   @D51EDAP 02137000
         MVC   PBXOBR+1(1),VCTCOBR  SAVE OBR ID IN PUBX        @D51EDAP 02138000
         MVC   PBXMDR(1),VCTCMDR  SAVE MDR ID IN PUBX          @D51EDAP 02139000
         MVC   PBXCUID(1),VCTCCUC SAVE CU-TYPE CODE            @D51EDAP 02140000
         NI    PBXFLAG1,XFF-PBXFEAT1-PBXFEAT2-PBXFEAT3-PBXFLCPY D52VDAP 02141000
         TM    VCTCFEA4,VCTCF4CN+VCTCF4CR CACHING SUPPORTED    @D61ADAP 02142000
         BZ    AVRUCM90           NO                           @D68ADAP 02143000
         OI    PBXFLAG1,PBXBUFFD  INDICATE CACHE CAPABLE       @D31ADAP 02144000
         TM    VCTCFEA4,VCTCF4DF  DASD  FAST WRITE SUPPORTED   @D52VDAP 02145000
         BZ    AVRUCM40           NO                           @D51EDAP 02146000
         OI    PBXFLAG1,PBXFEAT1  INDICATE DASD FAST WRITE     @D52VDAP 02147000
         TM    VCTCFEA4,VCTCF4DC  DUAL COPY SUPPORTED          @D52VDAP 02148000
         BZ    AVRUCM40           NO                           @D51EDAP 02149000
         OI    PBXFLAG1,PBXFEAT3  INDICATE DUAL COPY SUPPORT   @D52VDAP 02150000
AVRUCM40 TM    VCTCFEA4,VCTCF4CF  CACHE FAST WRITE SUPPORTED   @D52VDAP 02151000
         BZ    AVRUCM90           NO                           @D68ADAP 02152000
         OI    PBXFLAG1,PBXFEAT2  INDICATE CACHE FAST WRITE    @D52VDAP 02153000
         B     AVRUCM90                                        @D68ADAP 02154000
         SPACE 1                                                        02155000
AVRUCM70 MVC   VCTCOBR(1),PBXOBR+1  SAVE OBR ID IN VCT ENTRY   @DA41555 02156000
         MVC   VCTCMDR(1),PBXMDR  SAVE MDR ID IN VCT ENTRY     @DA41555 02157000
AVRUCM80 OC    VCTCGCAP(4),VCTCGCAP IS RDC DATA VALID          @DA44364 02158000
         BZ    AVRUCMA0           NO, WE NEED TO DO IT AGAIN   @TEST    02159000
         BAL   R8,AVRUPUBX        FILL PUBX INFORMATION        @DA44364 02160000
*SGLINK  AVRUPUBX,INPUT=(R2,R8,R9,RC),WORK=R5                  @DAMO014 02161000
         B     AVRUCM90          0 NO SNSID INFORMATION AVAIL. @D21IDAP 02162000
         NOP   0                 4 NO CIW RCD  PRESENT         @D52VDAP 02163000
*        ST    R4,PBXVCTE        8 SET VCTE ENTRY ADDRESS      @TEST    02164000
AVRUCM90 L     RE,AAVRMINI       8 GET AVRMINI BASE ADDRESS    @TEST    02165000
         USING AVRMINI,RE         AVRMINI BASE POINTER         @D68ADAP 02166000
         BASSM R8,RE              DO VM SPECIAL PROCESSING     @D68ADAP 02167000
*SGLINK  AVRMINI,INPUT=(R3,R4,R8,RE,RF),WORK=R5                @D68ADAP 02168000
         B     AVRSSSCK                =====================>> @D68ADAP 02169000
         USING AVRUCKMR,RE        UPDATE CKD ROUTINE BASE      @TEST    02170000
AVRUCMA0 OI    PBXFLAG2,PBXNOSIO  CHARACTERISTICS NOT AVAIL.   @TEST    02171000
*        B     AVRUCM90           NO SNSID INFORMATION AVAIL.  @TEST    02172000
         B     AVRSSSCK                =====================>> @TEST    02173000
         DROP  R9                 RELEASE PUBX BASE POINTER    @D21IDAP 02174000
         DROP  RE                 RELEASE AVRUCKMR BASE        @TEST    02175000
         DROP  RF                 RELEASE DVCCNTAB BASE        @D51EDAP 02176000
         TITLE 'VSE SUPERVISOR     SGSER     UPDATE DCT ENTRY FOR CKD ' 02177000
.********************************************************************** 02178000
.*                                                                      02179000
.* FUNCTION- SAVE DCT OFFSET AND CLEAN-UP REQUESTOR TABLE               02180000
.* ENTRY POINT- AVRDCTPR - SAVE DCT OFFSET IN AVR TABLE                 02181000
.*           AVRDCTPR - SET WORK DONE IN VCTE, CLEANUP TABLE            02182000
.* INPUTS-                                                              02183000
.*           R0= RETURN CODE FOR REQUESTOR                              02184000
.*           RQTTAB = REQUEST TABLE TO BE SEARCHED FOR = PUB            02185000
.*           R7= RETURN ADDR                                            02186000
.*           RF= DCT TABLE OFFSET                                       02187000
.* OUTPUTS-  USER WAITING ON VCTE ARE POSTED                            02188000
.*           USER REG 15 (SVER0F) SET TO RETURN CODE                    02189000
.*           REQUEST ELEMENTS ADDED TO RQT FREELIST                     02190000
.* EXITS-    TO CALLER OF AVRUPD                                        02191000
.* REGISTERS-                                                           02192000
.*                                                                      02193000
.*                                                                      02194000
.* SUBROUTINES- NONE                                                    02195000
.*                                                                      02196000
.********************************************************************** 02197000
         USING AVRDCTPR,RE        AVRDCTPR BASE POINTER        @DA44364 02198000
AVRDCTPR NI    VCTAPROC,XFF-VCTAPWIP ENTRY NOW VALID           @DA44364 02199000
         LTR   R2,R2              RQT ENTRY PROCESSING         @D61ADAP 02200000
         BZR   R7                 NO,  ======================> @D61ADAP 02201000
         USING RQTE,R2            RQT ENTRY BASE               @D61ADAP 02202000
         TM    RQTFLG,RQTSET15    SHOULD RETURN CODE BE SET    @D35CDFG 02203000
         BZ    AVRDCT50           NO, READY ALL WAITING TASKS  @D35IDAP 02204000
         CLI   VCTATYPE,VCTATAPE  IS THIS A TAPE DEVICE        @D61ADAP 02205000
         BNE   AVRDCT30           NO, CHECK RETURN CODE        @D61ADAP 02206000
         TM    RQTFLG,RQTOPRSV    WAS THIS A MODVCE RESERVE    @D61ADAP 02207000
         BZ    AVRDCT40           NO,                          @D61ADAP 02208000
         TM    VCTAFLAG,VCTARSV   DID RESERVE WORK PROPERLY    @D356DAP 02209000
         BZ    AVRDCT30           NO,                          @D61ADAP 02210000
         SLR   R0,R0              FORCE ZERO RETURN CODE       @D61ADAP 02211000
         B     AVRDCT40                                                 02212000
AVRDCT30 LTR   R0,R0              IS RETURN CODE = 0           @D356DAP 02213000
         BNZ   AVRDCT40           NO, THEN DONT ALLOW RESERVE  @D356DAP 02214000
         TM    RQTFLG,RQTOPRSV    DID WE RESERVE THE DEVICE    @D356DAP 02215000
         BZ    AVRDCT40           NO, DONT SET 'RESERVED' BIT  @D356DAP 02216000
         TM    VCTAFLAG,VCTARSV   IS DEVICE ALREADY RESERVED   @D356DAP 02217000
         BO    AVRERR1C           YES, SET RETURN CODE         @D356DAP 02218000
         OI    VCTAFLAG,VCTARSV   DEVICE IS NOW RESERVED       @D356DAP 02219000
AVRDCT40 ST    R4,RQTVCTAD        SAVE VCT ENTRY ADDRESS       @D356DAP 02220000
         ST    R0,RQTRETCD        SAVE RETURN CODE             @D61ADAP 02221000
AVRDCT50 BR    R7                 RETURN=====================> @D61ADAP 02222000
         DROP  R2                 RELEASE RQT ENTRY BASE       @D61ADAP 02223000
         DROP  R3                 DROP PUB BASE POINTER        @D14BDAP 02224000
         DROP  R4                 DROP VCTE ENTRY BASE         @D14BDAP 02225000
AVRERR1C LA    R0,MODVCRSV        SET RETURN CODE TO X'1C'     @D356DAP 02226000
         B     AVRDCT40           AND PASS INFORMATION TO USER @D356DAP 02227000
         SPACE 1                                                        02228000
         DROP  RE                 RELEASE AVRDCTPR BASE        @D62NDAP 02229000
         TITLE 'VSE SUPERVISOR     SGSER     SPECIAL MINI-DASD PROCESS' 02230000
         USING PUBADR,R3          PUB BASE POINTER             @D68ADAP 02231000
         USING VCTEADR,R4         VCT ENTRY FOR THIS REQUEST   @D68ADAP 02232000
         USING DVCCNTAB,RF        DVCCNTAB BASE POINTER        @D68ADAP 02233000
         USING AVRMINI,RE         AVRMINI BASE POINTER         @D68ADAP 02234000
*SGLINK  AVRMINI,INPUT=(R3,R4,R8,RE,RF),WORK=R5                @D68ADAP 02235000
AVRMINI  DS    0H                                              @D68ADAP 02236000
         TM    SUPFLAG,VMSYS      ARE WE RUNNING UNDER VM      @D68ADAP 02237000
         BZR   R8                 NO,  ======================> @D68ADAP 02238000
         XC    AVRDIAGB,AVRDIAGB  CLEAR VM COMMUNICATION AREA  @D68ADAP 02239000
         MVC   AVRDIAGB(2),PUBCHANN CUU INTO DIAG COMMAND      @D68ADAP 02240000
         LA    R5,L'AVRDIAGB      LENGTH OF BUFFER             @D68ADAP 02241000
         STH   R5,AVRDIAGB+2      PROVIDE BUFFER LENGTH        @D68ADAP 02242000
         LRA   R5,AVRDIAGB        GET REAL BUFFER ADDRESS      @D68ADAP 02243000
         DC    X'83',X'50',XL2'0210' GET DEVICE DATA           @D68ADAP 02244000
AVRMIN20 LR    R5,R8              SAVE RETURN REGISTER         @D68ADAP 02245000
         BAL   R8,AVRGPUBX        CALCULATE PUBX ADDRESS       @DY45540 02246000
*SGLINK  AVRGPUBX,INPUT=(R3,R8,RC),OUTPUT=R9                   @DY45540 02247000
         USING PBXADR,R9          PUBX BASE POINTER            @DY45540 02248000
         TM    PBXFLAG1,PBXRONLY  DEVICE ADDED FOR READ-ONLY   @D68ADAP 02249000
         BO    AVRMIN40           YES,                         @D68ADAP 02250000
         NI    VCTACDCS,XFF-VCTANWRT ASSUME READ/WRITE MODE    @D68ADAP 02251000
         TM    AVRDIAGB+7,X'80'   IS DEVICE IN READ ONLY MODE  @DY46139 02252000
         BZ    AVRMIN60           NO,                          @DY46139 02253000
AVRMIN40 OI    VCTACDCS,VCTANWRT  INDICATE CKD READ ONLY       @D68ADAP 02254000
*        OI    VCTAFDCS,VCTANWRT  INDICATE FBA READ ONLY       @D68ADAP 02255000
AVRMIN60 LR    R8,R5              RESTORE RETURN REGISTER      @D68ADAP 02256000
         DROP  R9                 RELEASE PUBX BASE            @D68ADAP 02257000
         CLI   PUBDEVTY,TFBA      IS THIS FBA DEVICE           @D68ADAP 02258000
         BER   R8                 YES, ======================> @D68ADAP 02259000
         OC    AVRDIAGB+28(2),AVRDIAGB+28 DID DIAG WORK        @DY46253 02260000
         BZR   R8                 NO,  ======================> @DY46253 02261000
         MVC   VCTCPCYL,AVRDIAGB+28 NUMBER OF CYLINDERS        @D68ADAP 02262000
         BR    R8                      ======================> @D68ADAP 02263000
         SPACE 1                                               @D68ADAP 02264000
         DS    0F                 ENSURE FULLWORD BOUNDARY     @D68ADAP 02265000
AVRDIAGB DC    XL58'00'           BUFFER TO CONTAIN RET INFO   @D68ADAP 02266000
         DROP  R3                 RELEASE PUB BASE             @D14BDAP 02267000
         DROP  R4                 RELEASE VCT ENTRY BASE       @D36IDAP 02268000
         DROP  R6                 RELEASE DISPATCHER BASE      @D61ADAP 02269000
         DROP  RC                 RELEASE SGSERI BASE          @D35CDFG 02270000
         DROP  RD                 RELEASE SGSER BASE           @D61ADAP 02271000
         DROP  RE                 RELEASE AVRMINI BASE         @D61ADAP 02272000
         DROP  RF                 RELEASE DVCCNTAB BASE        @D61ADAP 02273000
         TITLE 'VSE SUPERVISOR     SGSER     GETVCE + AVR SUBROUTINES ' 02274000
.********************************************************************** 02275000
.*                                                                      02276000
.* FUNCTION- PROVIDE VOLUME AND DEVICE INFO TO USER                     02277000
.* ENTRY POINT- SVC99 - FROM DISPATCHER                                 02278000
.* INPUTS-   R1= ADDR OF PARAMETER LIST (DSECT IS AVRILIST)             02279000
.*               NEEDED UNTIL ALL INPUT IS SAVED                        02280000
.*           RA= ADDR OF PIB                                            02281000
.*           RD= BASE ADDRESS                                           02282000
.*           R6= RETURN ADDRESS                                         02283000
.* OUTPUTS-  SVER0F CONTAINS RETURN CODE                                02284000
.*           USER OUTPUT AREA IS FILLED (DSECT IS AVRLIST)              02285000
.* EXITS-    TO DISPATCHER AND USER IF PROCESSING COMPLETES             02286000
.*           TO RESVCX IF ENTRY IS BEING UPDATED BY SERVICE TASK        02287000
.*           TO VALID EXIT IF THAT RTN FAILS(INVALID PARMS)             02288000
.* REGISTERS-R0=RETURN CODE                                             02289000
.*           R1=WORK REG AFTER REQUEST TYPE IS DETERMINED               02290000
.*           R2=DEVICE ID ADDR                                          02291000
.*           R3=PUB ADDR                                                02292000
.*           R4=ADDR OF VCTE ENTRY                                      02293000
.*           R5=PARTITION COMM REGION ADDRESS                           02294000
.*           R7=LINK REG TO SUBROUTINES                                 02295000
.*           R8=LINK TO VALID AND USED AS WORK REG                      02296000
.*           R9=LOGICAL UNIT NO. FOR OUTPUT                             02297000
.*           RC=WORK                                                    02298000
.*           RE=OUTPUT AREA ADDR                                        02299000
.*           RF=OUTPUT LENGTH                                           02300000
.* SUBROUTINES- VALID - TO CHECK THAT OUTPUT IS IN USER PART.           02301000
.*           VALIDSVA - TO CHECK THAT INPUT IN VALID STORAGE            02302000
.*           LNOGIVEN - TO PROCESS LOGICAL UNIT INPUT                   02303000
.*           CUUGIVEN - TO PROCESS CHANNEL/UNIT INPUT                   02304000
.*           VOLGIVEN - TO PROCESS VOLUME ID INPUT                      02305000
.*           FILLAVR  - TO MOVE DATA TO USER OUTPUT AREA                02306000
.*                                                                      02307000
.********************************************************************** 02308000
         USING AVRIADR,R1         GETVCE INPUT LIST            @D35VDEP 02309000
         USING TCBADR,RA          PARTITION CONTROL BLOCK      @D36IDAP 02310000
         USING SVEARA,RB          SAVE AREA BASE POINTER       @D14BDAP 02311000
         USING DISP,R6            DISPATCHER BASE POINTER      @D61ADAP 02312000
         USING SVC99,RC           SVC99 BASE POINTER           @D61ADAP 02313000
SVC99    DC    0H'0'              GETVCE ROUTINE               @D35VDEP 02314000
         LR    RD,RC              SET SVC99 BASE POINTER       @D61NDAP 02315000
         USING SVC99,RD           SVC99 BASE POINTER           @D61NDAP 02316000
         DROP  RC                 RELEASE INITIAL BASE         @D61NDAP 02317000
         N     R1,BIT0OFF         SET 31-BIT OFF               @D66CDAP 02318000
         TM    TCBEXFLG,TCBEXAM   31 BIT MODE                  @D66CDAP 02319000
         BO    SVC99I31           YES,                         @D66CDAP 02320000
         LA    R1,0(,R1)          RESET HIGH ORDER BYTE        @D66CDAP 02321000
SVC99I31 L     RF,ASVC99PR        GET ROUTINE ADDRESS          @D66CDAP 02322000
         BASSM 0,RF                                            @D66CDAP 02323000
ASVC99PR DC    A(SVC99RTN+X'80000000')                         @D66CDAP 02324000
SVC99RTN DS    0H'0'              START WITH 31-BIT MODE       @D66ADAP 02325000
         SLR   RF,RF              CLEAR OUTPUT LENGTH REG      @D35VDEP 02326000
         LR    R0,RF              SET RETURN CODE TO ZERO      @D149DAP 02327000
         LA    R2,AVRILEN(,R1)    GET LENGTH OF PARM LIST      @D35VDEP 02328000
         C     R2,EOVSADR         VALIDATE PARM LIST           @D35VDEP 02329000
         BH    ERR25C             INVALID ADDRESS              @D35VDEP 02330000
         LR    R9,R1              SAVE PARM LIST ADDRESS       @DA44680 02331000
         DROP  R1                 RELEASE AVR BASE             @D36IDAP 02332000
         USING AVRIADR,R9         GETVCE INPUT LIST            @DA44680 02333000
         ICM   R1,M15,AVRIOUT     FIRST BYTE OF OUTPUT AREA    @D149DAP 02334000
         BZ    GETVCE10           AREA OPERAND WAS OMITTED     @D37BDAP 02335000
         IC    RF,AVRILGT         GET OUTPUT LIST LENGTH-1     @D35VDEP 02336000
         TM    AVRIFLG,AVRIALL    DEVICE ALL REQUEST           @D14SSX1 02337000
         BZ    GETVCE05           NO,                          @D14SSX1 02338000
         LH    RF,AVRIDEV+2       GET AREA LENGTH              @D14SSX1 02339000
GETVCE05 LA    R8,ARTID           AR TASK-ID                   @D66CDAP 02340000
         CH    R8,TID             IS REQUESTOR A USER TASK     @D66CDAP 02341000
         BNH   GETVCE10           NO,  SKIP VALIDATION         @DA33216 02342000
         LA    R2,0(RF,R1)        LAST BYTE OF OUTPUT AREA     @DA33314 02343000
         BAL   R8,VALIDSVA        VALIDATE OUTPUT AREA         @D66CDAP 02344000
*SGLINK  VALIDSVA,S,INPUT=(R1,R2,R6,R8),WORK=(R2,R5)           @D66ADAP 02345000
GETVCE10 LR    RE,R1              SAVE ADDR OF OUTPUT AREA     @D35VDEP 02346000
         LR    R1,R9              RESTORE FOR CUUALL           @DA44680 02347000
         SLR   RC,RC              CLEAR WORK REGISTER          @D131DAP 02348000
         IC    RC,AVRIDVTY        GET DEVICE TYPE (IF ANY)     @D131DAP 02349000
         TM    AVRIFLG,AVRIALL    DEVICE ALL REQUEST           @D14SSX1 02350000
         BO    CUUALL             YES, NO FURTHER VALIDATION   @D14SSX1 02351000
         L     R1,AVRIDEV         GET ADDRESS OF DEVICE ID     @DA44680 02352000
         LA    R2,1(,R1)          ASSUME 2 BYTES               @DA44680 02353000
         TM    AVRIFLG,X0F-AVRIVOL DID WE GET VOLID            @D21LDRP 02354000
         BNZ   GETVCE20           NO,                          @D37BDAP 02355000
         LA    R2,5(,R1)          VOLID IS 6 BYTES LONG        @DA44680 02356000
GETVCE20 SLR   R5,R5              INDICATE KEY ZERO            @DA44680 02357000
         BAL   R8,VALREAD         VALIDATE DEVICE IDENTIFIER   @DA44680 02358000
*SGLINK  VALREAD INPUT=(R1,R2,R5,R6,R8),OUTP=R5,WORK=(R2,R3,R4)@DA44680 02359000
         B     ERR25C           0 INVALID ADDRESS              @DA44680 02360000
         B     ERR25C           4 PROTECTION VIOLATION         @DA44680 02361000
         LR    R1,R9            8 RESTORE PARAMETER LIST PNTR. @DA44680 02362000
         DROP  R9                 RELEASE AVRIADR BASE         @DA44680 02363000
         USING AVRIADR,R1         AVRIADR BASE POINTER         @DA44680 02364000
         L     R2,AVRIDEV         GET ADDR OF DEVICE ID        @DA44680 02365000
         L     R5,CRADDR          GET ADDR OF PARTITION COMREG @DA44680 02366000
         USING COMREG,R5          PARTITION COMM REGION        @DA44680 02367000
         TM    AVRIFLG,X0F-AVRIVOL IS IT A VOLID               @D21LDRP 02368000
         BZ    VOLGIVEN           YES, PROCESS IT              @D37BDAP 02369000
         TM    AVRIFLG,AVRITYP    IS IT DEVICE TYPE ONLY       @D21LDRP 02370000
         BO    GETVCE30           YES, BRANCH                  @D21LDRP 02371000
         TM    AVRIFLG,AVRILNO    IS IT A LOGICAL UNIT         @D21LDRP 02372000
         BO    LNOGIVEN           YES, PROCESS IT              @D21LDRP 02373000
         TM    AVRIFLG,AVRICUU    IS IT A DEVICE ADDRESS       @D21LDRP 02374000
         BO    CUUGIVEN           YES, PROCESS IT              @D21LDRP 02375000
GETVCE30 DS    0H                 DEVICE TYPE PROCESSING       @D21LDRP 02376000
         LTR   RE,RE              TRKBAL/TRKCAP ONLY REQUEST   @D131DAP 02377000
         BNZ   GETERR14           NO, INVALID PARAMETER LIST   @D131DAP 02378000
         LTR   RC,RC              IS DEVICE TYPE CODE GIVEN    @D131DAP 02379000
         BNZ   TYPGIVEN           YES,                         @D131DAP 02380000
         B     GETERR14           BAD PARAMETER LIST           @D37BDAP 02381000
         DROP  R1                 R1 IS NOW A FREE WORK REG    @D35VDEP 02382000
GETERR04 LA    R0,AVRNOLNO        LNO NUMBER OR VOLID INVALID  @D14BDAP 02383000
         B     FILLAVR            NO SEVERE ERROR              @D37BDAP 02384000
GETERR08 LA    R0,AVRNOASG        INVALID ASSIGNMENT           @D37BDAP 02385000
         B     GETCLEXT           RETURN TO USER               @D37BDAP 02386000
GETERR0C LA    R0,AVRIGN          DEVICE IS ASSIGNED IGNORE    @D37BDAP 02387000
         B     GETCLEXT           CLEAR USER AREA AND EXIT     @D37BDAP 02388000
GETERR10 LA    R0,AVRNOTUP        DEVICE IS NOT OPERATIONAL    @D37BDAP 02389000
         B     FILLAVR            RETURN TO USER               @D52VDAP 02390000
GETERR14 LA    R0,AVRBPL          PARM LIST INVALID            @D37BDAP 02391000
         B     EXITAVR            RETURN ERROR CODE TO USER    @D14CDOW 02392000
GETERR18 LA    R0,AVRNOTDF        DEVICE IS NOT DASD           @D37BDAP 02393000
         B     GETCLEXT           CLEAR USER AREA AND EXIT     @D37BDAP 02394000
GETERR1C LA    R0,AVRNRDY         DEVICE IS NOT READY          @D37BDAP 02395000
         B     FILLAVR            FILL IN DATA                 @D37BDAP 02396000
GETCLEXT EX    RF,CLRAVR          CLEAR OUTPUT AREA            @D35VDEP 02397000
         B     EXITAVR            RETURN ERROR CODE TO USER    @D35VDEP 02398000
         TITLE 'VSE SUPERVISOR     SGSER     FIND AN AVR ENTRY FOR LNO' 02399000
.********************************************************************** 02400000
.*                                                                      02401000
.* FUNCTION- PROCESS LOGICAL UNIT NUMBER                                02402000
.* ENTRY POINT- LNOGIVEN - FROM GETVCE SVC MAIN RTN                     02403000
.* INPUTS-   R1= ADDR OF GETVCE PARAMETER LIST                 @D21LDRP 02404000
.*           R3= LOGICAL UNIT NUMBER (AS IN CCB)                        02405000
.*           R5= ADDR OF PARTITION COMM. REGION                         02406000
.*           RA= ADDR OF TCB                                            02407000
.*           RF= LENGTH OF USER SUPPLIED AREA-1                         02408000
.* OUTPUTS-  R3= ADDR OF PUB FOR REQUESTED CUU                          02409000
.*           R4= ADDR OF VCTE FOR THIS REQUEST                          02410000
.*           R9= LOGICAL UNIT FOR THIS DEVICE                           02411000
.*           R0= RETURN CODE                                            02412000
.* EXITS-    TO FILLAVR TO OUTPUT USERS DATA (R0= 0|28) BY GETAVRST     02413000
.*           TO GETCLEXT ON AN INVALID INPUT                            02414000
.*           TO RESVCX IF ENTRY IS BEING UPDATED BY SERVICE TSK         02415000
.* REGISTERS-R7=LINK REG TO SUBROUTINES                                 02416000
.*           RC=SGSERI BASE ADDRESS                                     02417000
.* SUBROUTINES- AVRFVCTE- FIND VCT ENTRY ADDRESS FOR DEVICE             02418000
.*           CALCPUB - CALCULATE PUB ADDR FROM LNO                      02419000
.*           AVRCLTST - TEST CLASS PARAMETER AGAINST ACTUAL PUB ENTRY   02420000
.*                                                                      02421000
.********************************************************************** 02422000
         USING   AVRIADR,R1       GETVCE PARAMETER LIST        @D21LDRP 02423000
*        LOGICAL UNIT PROCESSING                               @D35VDEP 02424000
LNOGIVEN EQU   *                  USER SUPPLIED LOGICAL UNIT   @D37BDAP 02425000
         L     RC,BASESERI        ROUTINES CALC PUB, AVRFVCTE  @D35CDFG 02426000
         USING SGSERI,RC          ARE PART OF THE FIXED CODE   @D35CDFG 02427000
         SLR   R3,R3              CLEAR REGISTER               @DY45385 02428000
         ICM   R3,B'0011',0(R2)   GET LNO INFO                 @DY45385 02429000
         BAL   R7,CALCPUB         CALCULATE PUB ADDRESS        @D35VDEP 02430000
*SGLINK  CALCPUB,INPUT=(R3,R6,R7,RC),OUTPUT=(R3,R4),WORK=R8    @D61ADAP 02431000
         B     GETERR14           BAD INPUT PARAMETER          @D37BDAP 02432000
         LTR   R3,R3              IS A PUB ASSIGNED            @D35VDEP 02433000
         BZ    GETERR08           NO PUB ASSIGNED              @D37BDAP 02434000
         BM    GETERR0C           PUB IS ASSIGNED IGNORE       @D37BDAP 02435000
         LH    R9,0(,R2)          SAVE LNO FOR OUTPUT AREA     @D37BDAP 02436000
         LA    R9,0(,R9)          RESET HIGH ORDER BIT         @D37BDAP 02437000
         BAL   R7,AVRFVCTE        CHECK IF DEVICE IN VCT       @D35VDEP 02438000
*SGLINK  AVRFVCTE,INPUT=(R3,R7,RC),OUTPUT=R4,WORK=R8           @D369DAP 02439000
         LTR   R4,R4              IS THERE AN ENTRY FOR DEVICE @D35VDEP 02440000
         BNP   GETERR18           NO, DEVICE IS NOT SUPPORTED  @D37BDAP 02441000
         BAL   R7,AVRCLTST        CHECK FOR VALID CLASS OF ENTR@D21LDRP 02442000
*SGLINK  AVCLTST,INPUT=(R1,R3,R7,RC)                           @D21LDAP 02443000
         B     GETERR18           CLASS NOT CORRECT            @D21LDRP 02444000
         DROP  RC                 RELEASE SGSERI BASE POINTER  @D21LDAP 02445000
         USING VCTEADR,R4         AVR BASE POINTER             @D36IDAP 02446000
         LTR   RE,RE              TRKBAL/TRKCAP REQUEST        @D51GDAP 02447000
         BZ    GETAVR10           YES,                         @D51GDAP 02448000
         EX    RF,CLRAVR          AVOID PAGE FAULTS TILL EXIT  @D35CDFG 02449000
         DROP  R4                 RELEASE AVR BASE             @D36IDAP 02450000
         B     GETAVRST           TEST CURRENT STATE           @D37BDAP 02451000
         DROP  R1                 RELEASE PARAMETER LIST BASE  @D21LDRP 02452000
         TITLE 'VSE SUPERVISOR     SGSER     FIND AN AVR ENTRY FOR PUB' 02453000
.********************************************************************** 02454000
.*                                                                      02455000
.* FUNCTION- PROCESS CHANNEL/UNIT DEVICE ADDRESS                        02456000
.* ENTRY POINT- CUUGIVEN - FROM GETVCE SVC MAIN RTN                     02457000
.* INPUTS-   R1= ADDR OF GETVCE PARAMETER LIST                          02458000
.*           R2= CUU ADDRESS                                            02459000
.*               X'FFF' INDICATES THAT CUU+VOLID FOR ALL DASD           02460000
.*                      (8 BYTES EACH) IS TO BE RETURNED                02461000
.*           R5= ADDR OF PARTITION COMM. REGION                         02462000
.*           RA= ADDR OF TCB                                            02463000
.*           PUB TABLE                                                  02464000
.* OUTPUTS-  R3= ADDR OF PUB FOR REQUESTED CUU                          02465000
.*           R4= ADDR OF VCTE FOR THIS REQUEST                          02466000
.*           R9= LOGICAL UNIT FOR THIS DEVICE                           02467000
.*           R0= RETURN CODE, R9 INVALID IF R0=0                       02468000
.*                               OR IF CUU=X'FFF'                       02469000
.* EXITS-    TO FILLAVR TO OUTPUT USERS DATA (R0= 0|4|28)               02470000
.*           TO GETERR08 ON AN INVALID INPUT                            02471000
.*           TO RESVCX IF ENTRY IS BEING UPDATED BY SERVICE TSK         02472000
.* REGISTERS-R8= WORK REGISTER                                          02473000
.*           R7= LINKAGE REGISTER TO SUBROUTINES                        02474000
.*           RC= SGSERI BASE ADDRESS                                    02475000
.* SUBROUTINES- AVRFVCTE- CHECK IF DEVICE IS SUPPORTED                  02476000
.*           LUBAVR1 - FIND A LNO(IF ANY) FOR THIS DEVICE               02477000
.*           AVRCUUT1 - TO FIND PUB ADDR FROM X'0CUU' FORMAT            02478000
.*                                                                      02479000
.********************************************************************** 02480000
         USING AVRIADR,R1         GETVCE PARAMETER BASE        @D21LDAP 02481000
CUUGIVEN EQU   *                  USER SUPPL CHANNEL, UNIT NO  @D35VDEP 02482000
         L     RC,BASESERI        ROUTINE AVRFVCTE BELONGS TO  @D35CDFG 02483000
         USING SGSERI,RC          FIXED CODE                   @D35CDFG 02484000
         BAL   R7,AVRCUUT1        FIND ASSOCIATED PUB ADDRESS  @D37BDAP 02485000
*SGLINK  AVRCUUT1,INPUT=(R2,R7,RC),OUTPUT=R3                   @D37BDAP 02486000
         B     GETERR08           NO PUB EXISTS FOR GIVEN CUU  @D37BDAP 02487000
         USING PUBADR,R3          PUB BASE POINTER             @D131DAP 02488000
         BAL   R7,AVRFVCTE        FIND ASSOCIATED AVR ENTRY    @D35VDEP 02489000
*SGLINK  AVRFVCTE,INPUT=(R3,R7,RC),OUTPUT=R4,WORK=R8           @D369DAP 02490000
         LTR   R4,R4              WAS AN ENTRY FOUND           @D35VDEP 02491000
         BNP   GETERR18           NO, DEVICE IS NOT SUPPORTED  @D37BDAP 02492000
         USING VCTEADR,R4         AVR BASE POINTER             @D36IDAP 02493000
         BAL   R7,AVRCLTST        CHECK FOR VALID CLASS OF ENTR@D21LDRP 02494000
*SGLINK  AVCLTST,INPUT=(R1,R3,R7,RC)                           @D21LDAP 02495000
         B     GETERR18           CLASS NOT CORRECT            @D21LDRP 02496000
         DROP  RC                 RELEASE SGSERI BASE          @D21LDAP 02497000
         LTR   RE,RE              IS THIS A TRKBAL/TRKCAP ONLY @D21BDOW 02498000
         BZ    GETAVR10           YES, DONT CHECK STATUS       @D21BDOW 02499000
         EX    RF,CLRAVR          AVOID PF'S IN CODE & PAR-LIST@D35CDFG 02500000
         BAL   R7,LUBAVR1         TRY TO FIND A LOGICAL UNIT   @D35VDEP 02501000
*SGLINK  LUBAVR1,INPUT=(R3,R5,R7,RD),OUTPUT=(R8,R9),WORK=(R1,RC)        02502000
GETAVRST TM    VCTAPROC,VCTAPWTD+VCTAPWIP ENTRY BEING UPDATED  @D52VDAP 02503000
         BNZ   GETNOAVR           YES, HAVE TO TRY LATER       @D35VDEP 02504000
         TM    VCTAFLG,VCTAFOP    IS DEVICE OPERATIONAL        @D35VDEP 02505000
         BZ    GETERR10           NO, SET RETURN CODE          @D37BDAP 02506000
         TM    VCTAFLAG,VCTACOPY  IS DEVICE A DUPLEX DEVICE    @D31ODAP 02507000
         BO    GETERR10           YES, TREAT AS NOT OPERATIONAL@D31ODAP 02508000
         TM    VCTAFLG,VCTARDY    IS DEVICE READY              @D35VDEP 02509000
         BZ    GETERR1C           NO, SET RETURN CODE AND FILL @D37BDAP 02510000
         TM    VCTAFLAG,VCTANVOL  IS VOLID VALID               @D35VDEP 02511000
         BO    GETERR04           NO, INDICATE VOLID IS INVALID@D37BDAP 02512000
         B     FILLAVR            FILL OUTPUT AREA             @D35VDEP 02513000
GETNOAVR L     R8,TIBPTR          SET UP POINTER TO TIB        @D36IDAP 02514000
         L     RA,TCBPTR          SET UP POINTER TO TCB        @D36IDAP 02515000
         SLR   R1,R1              INDICATE UNCOND. POSTING     @D36IDAP 02516000
         L     R5,ASRQTAB         RESOURCE DESCRIPTOR TABLE    @D61MPAP 02517000
         LA    R5,SRQAVR-SRQTAB(,R5) AVR WAIT QUEUE            @D61MPAP 02518000
         B     RESVCX             RETRY SVC LATER              @D35VDEP 02519000
*SGLINK  RESVCX,INPUT=(R5,R6)                                  @D369DAP 02520000
GETAVR10 CLI   AVRIVER,ZERO       IS THIS THE INITIAL VERSION  @D131DAP 02521000
         BE    GETERR14           YES, BAD PARAMETER INPUT     @D131DAP 02522000
         B     FILLBAL            PROVIDE TRKBAL/TRKCAP INFO   @D51EDAP 02523000
         SPACE 3                                                        02524000
         DROP  R1                 RELEASE PARAMETER LIST BASE  @D21LDRP 02525000
         DROP  R3                 RELEASE PUB BASE             @D131DAP 02526000
         DROP  R4                 RELEASE AVR BASE             @D36IDAP 02527000
         DROP  R5                 RELEASE COMRG BASE           @D21LDRP 02528000
         TITLE 'VSE SUPERVISOR     SGSER     RETURN CUU+VOLID FOR ALL ' 02529000
.********************************************************************** 02530000
.*                                                                      02531000
.* FUNCTION- RETURN CUU AND VOLID FOR ALL DASD DEVICES, POSSIBLY        02532000
.*            RESTRICTED TO SPECIFIED DEVICE TYPE.                      02533000
.* ENTRY POINT- CUUALL - FROM GETVCE SVC MAIN RTN                       02534000
.* INPUTS-   R1= ADDR OF GETVCE PARAMETER-LIST                          02535000
.*           RE= ADDR OF USER AREA                                      02536000
.*           RF= LENGTH OF USER AREA                                    02537000
.* EXITS-    TO EXITAVR TO RETURN TO USER                               02538000
.*           TO GETERR14 IF PROVIDED AREA LENGTH TOO SMALL,             02539000
.*              R0 CONTAINS REQUIRED LENGTH IN THIS CASE                02540000
.* REGISTERS-R1= ADDR OF GETVCE PARAMETER LIST                          02541000
.*           R3= ADDR OF PUB BELONGING TO VCT ENTRY                     02542000
.*           R4= ADDR OF ACTUAL VCT ENTRY                               02543000
.*           R7= WORK REGISTER                                          02544000
.*           R8= LOOP CONTROL REGISTER                                  02545000
.*           R9= BASE OF FIXED AVR CODE (SGSERI)                        02546000
.*           RA= ADDR OF TCB                                            02547000
.*           RB= TASKS SAVEAREA ADDR                                    02548000
.*           RC= PUB DEVICE TYPE CODE OR ZERO                           02549000
.*           RE= ADDR OF ENTRY TO BE BUILT IN USER AREA                 02550000
.*           RF= WORK REGISTER                                          02551000
.* SUBROUTINES- NONE                                                    02552000
.*                                                                      02553000
.********************************************************************** 02554000
         USING AVRIADR,R1         PARAMETER LIST BASE POINTER  @D14SSX1 02555000
CUUALL   L     R9,BASESERI        SGSERI BASE ADDRESS          @D14SSX1 02556000
         USING SGSERI,R9          SGSERI BASE POINTER          @D14SSX1 02557000
         CLI   AVRIDEV,X'01'      USER REQUESTS ALL DASD'S     @D14SSX1 02558000
         BNE   GETERR14           NO, INVALID PARAMETER LIST   @D14SSX1 02559000
         SPACE 1                                                        02560000
*   CALCULATE MAXIMAL LENGTH REQUIRED FOR USER AREA            @D21LDRP 02561000
         L     R4,AAVRTAB         ADDRESS OF AVR TABLE         @D21LDRP 02562000
         USING VCTEADR,R4         AVR BASE POINTER             @D14SSX1 02563000
         SR    R7,R7              SET INITIAL VALUE            @D21LDRP 02564000
         LH    R8,AVRCOUNT        NO OF VCT ENTRIES FOR LOOP   @D21LDRP 02565000
CUUALL00 CLI   VCTATYPE,VCTATAPE  IS ENTRY FOR TAPE            @D21LDRP 02566000
         BE    CUUALL05           YES, GET NEXT ENTRY          @D21LDRP 02567000
         LA    R7,8(R7)           INCREASE REQUIRED LENGTH     @D21LDRP 02568000
CUUALL05 AH    R4,VCTELEN         POINT TO NEXT VCT ENTRY      @D51EDAP 02569000
         BCT   R8,CUUALL00        LOOP UNTILL ALL PROCESSED    @D21LDRP 02570000
         SPACE 1                                                        02571000
*   CHECK WHETHER USER AREA IS LARGE ENOUGH                    @D21LDRP 02572000
         CLR   RF,R7              DOES ALL DATA FIT IN AREA    @D14SSX1 02573000
         BL    CUUALLER           NO, GIVE RETURN CODE         @D14SSX1 02574000
         BCTR  RF,0               ADJUST LENGTH FOR EXECUTE    @D14SSX1 02575000
         L     R4,AAVRTAB         ADDRESS OF AVR TABLE         @D14SSX1 02576000
         LR    R7,RE              COPY AREA POINTER            @D14SSX1 02577000
         AR    R7,RF              LAST BYTE OF USER AREA       @D14SSX1 02578000
         EX    0,CUUEXCLC         AVOID PAGE FAULTS TILL EXIT  @D14SSX1 02579000
         SPACE 1                                                        02580000
*   LOOP THRU VCT AND FILL USER AREA                           @D21LDRP 02581000
         LH    R8,AVRCOUNT        NO OF VCT ENTRIES            @D14SSX1 02582000
CUUALL10 CLI   VCTATYPE,VCTATAPE  IS ENTRY FOR TAPE            @D21LDRP 02583000
         BE    CUUALL40           YES, SKIP IT                 @D21LDRP 02584000
         L     R3,VCTAPUB         GET PUB ADDRESS              @D66CDAP 02585000
         USING PUBADR,R3          PUB BASE POINTER             @D14SSX1 02586000
         LA    RF,7               ENTRY LENGTH-1               @D14SSX1 02587000
         LTR   RC,RC              DID USER PASS DEVTYPE        @D14SSX1 02588000
         BZ    CUUALL20           NO,                          @D14SSX1 02589000
         CLM   RC,1,PUBDEVTY      CORRECT DEVICE TYPE          @D14SSX1 02590000
         BNE   CUUALL40           NO, GET NEXT ENTRY           @D14SSX1 02591000
CUUALL20 EX    RF,CLRAVR          CLEAR NEXT ENTRY IN USER AREA@D14SSX1 02592000
         MVC   0(2,RE),PUBCHANN   MOVE CUU TO USER OUTPUT AREA @D14SSX1 02593000
         TM    VCTAPROC,VCTAPWTD+VCTAPWIP ENTRY BEING UPDATED  @D52VDAP 02594000
         BNZ   GETNOAVR           YES, WAIT UNTIL COMPLETE     @D21ZDAP 02595000
         TM    VCTAFLG,VCTAFOP+VCTARDY IS DEVICE READY         @D14SSX1 02596000
         BNO   CUUALL30           NO, DONT TRUST VOLID         @D14SSX1 02597000
         TM    VCTAFLAG,VCTACOPY  IS THIS A DUPLEX DEVICE      @D31ODAP 02598000
         BO    CUUALL30           YES, DONT GIVE TO USER       @D31ODAP 02599000
         TM    VCTAFLAG,VCTANVOL  IS VOLID VALID               @D14SSX1 02600000
         BNZ   CUUALL30           NO,                          @D14SSX1 02601000
         MVC   2(6,RE),VCTAVOL1   MOVE VOLID TO OUTPUT AREA    @D14SSX1 02602000
CUUALL30 LA    RE,8(,RE)          UPDATE OUTPUT AREA POINTER   @D14SSX1 02603000
CUUALL40 AH    R4,VCTELEN         POINT TO NEXT VCT ENTRY      @D51EDAP 02604000
         BCT   R8,CUUALL10        LOOP UNTIL ALL PROCESSED     @D14SSX1 02605000
         B     EXITAVR            RETURN TO USER               @D14SSX1 02606000
         SPACE 1                                               @D14SSX1 02607000
CUUALLER ST    R7,SVER00          SET REQUIRED LENGTH IN R0    @D14SSX1 02608000
         B     GETERR14           SET APPROPRIATE RETURN CODE  @D14SSX1 02609000
         SPACE 3                                               @D14SSX1 02610000
         DROP  R1                 RELEASE PARAMETER LIST BASE  @D14SSX1 02611000
         DROP  R3                 RELEASE PUB BASE             @D14SSX1 02612000
         DROP  R4                 RELEASE AVR BASE             @D14SSX1 02613000
         DROP  R9                 RELEASE SGSERI BASE          @D14SSX1 02614000
         TITLE 'VSE SUPERVISOR     SGSER     FIND AVR ENTRY FOR VOLID ' 02615000
.********************************************************************** 02616000
.*                                                                      02617000
.* FUNCTION- PROCESS VOLUME IDENTIFIER INPUT                            02618000
.* ENTRY POINT- VOLGIVEN - FROM GETVCE SVC MAIN RTN                     02619000
.* INPUTS-   R1= ADDR OF INPUT PARAMETER                                02620000
.*           R2= ADDR OF VOLID FIELD                                    02621000
.*           R5= ADDR OF PARTITION COMM. REGION                         02622000
.*           RA= ADDR OF TCB                                            02623000
.*           RC=VSE PUB DEVICE TYPE FOR VOLID MODIFIER                  02624000
.*           PUB TABLE FOR DEVICE TYPE OF EACH DASD                     02625000
.*           VCT FOR VOLIDS OF ALL MOUNTED PACKS                        02626000
.* OUTPUTS-  R3= ADDR OF PUB FOR REQUESTED CUU                          02627000
.*           R4= ADDR OF VCTE FOR THIS REQUEST                          02628000
.*           R9= LOGICAL UNIT FOR THIS DEVICE                           02629000
.*           R0= RETURN CODE, R9 INVALID IF R0=0                       02630000
.* EXITS-    TO FILLAVR TO OUTPUT USERS DATA (R0= 0|4)                  02631000
.* REGISTERS-R8=INDEX OF PUB AND COUNT OF VCT ENTRIES                   02632000
.*           R4= ADDR OF VCT ENTRY BEING SEARCHED                       02633000
.*           R7= LINKAGE REGISTER TO SUBROUTINES                        02634000
.* SUBROUTINES-                                                         02635000
.*           LUBAVR1 - FIND A LNO(IF ANY) FOR THIS DEVICE               02636000
.*                                                                      02637000
.********************************************************************** 02638000
         USING COMREG,R5          PARTITION COMM REGION        @D21LDRP 02639000
         USING AVRIADR,R1         PARAMETER LIST BASE POINTER  @DA38034 02640000
VOLGIVEN EQU   *                  USER SUPPLIED VOLID          @D37BDAP 02641000
         L     R8,BASESERI        GET ADDRESSABILITY           @D35CDFG 02642000
         USING SGSERI,R8          TO SERVICE TASK INTERFACE    @D35CDFG 02643000
         LM    R3,R4,0(R2)        GET USER SUPPLIED VOLID      @D35CDFG 02644000
         LTR   RE,RE              TRKBAL/TRKCAP REQUEST        @D51GDAP 02645000
         BZ    VOLGIV10                                        @D51GDAP 02646000
         EX    RF,CLRAVR          AVOID PAGE FAULTS TILL EXIT  @D35CDFG 02647000
VOLGIV10 STM   R3,R4,VOLGUSER     SAVE USER SUPPLIED VOLID     @D37BDAP 02648000
         XC    VOLGR3R4(8),VOLGR3R4 CLEAR INTERNAL SAVE AREA   @D37BDAP 02649000
         L     R4,AAVRTAB         POINT AT 1ST AVR ENTRY       @D35VDEP 02650000
         USING VCTEADR,R4         AVR BASE POINTER             @D36IDAP 02651000
         LH    R8,AVRCOUNT        SEARCH WHOLE TABLE           @D35VDEP 02652000
         DROP  R8                 RELEASE SGSERI BASE          @D35CDFG 02653000
VOLGIV20 TM    VCTAFLG,VCTAFOP+VCTARDY IS DEVICE READY         @D35VDEP 02654000
         BNO   VOLGIV70           NO, BUMP TO NEXT ENTRY       @D35VDEP 02655000
         TM    VCTAFLAG,VCTACOPY  IS THIS A DUPLEX DEVICE      @D31ODAP 02656000
         BO    VOLGIV70           YES, DONT USE IT             @D31ODAP 02657000
         CLC   VCTAVOL1,VOLGUSER  IS THIS THE RIGHT ENTRY      @D37BDAP 02658000
         BNE   VOLGIV70           NO, BUMP TO NEXT ENTRY       @D35VDEP 02659000
         L     R3,VCTAPUB         LOAD PUB POINTER             @D35VDEP 02660000
         LA    R3,0(R3)           CLEAR HIGH ORDER BYTE        @D35VDDK 02661000
         USING PUBADR,R3          DECLARE PUB BASE             @D35VDDK 02662000
VOLGIV30 LTR   RC,RC              DID USER PASS DEVTYPE        @D21ZDAP 02663000
         BNZ   VOLGIV50           YES, CHECK FOR A MATCH       @DA38034 02664000
         TM    AVRIFLG,AVRIANY    CLASS EQUALS ANY             @DA38034 02665000
         BO    VOLGIV60           PASS THIS ONE TO USER        @DA38034 02666000
         TM    AVRIFLG,AVRITAPE   DID USER WANT A TAPE         @DA38034 02667000
         BZ    VOLGIV40           NO,                          @DA38034 02668000
         CLI   VCTATYPE,VCTATAPE  IS THIS A TAPE DEVICE        @DA38034 02669000
         BE    VOLGIV60           YES                          @DA38034 02670000
         B     VOLGIV70           THATS NOT WHAT I WANT        @DA38034 02671000
.*                                                             @DA38034 02672000
.*       ENTERED IF USER DID WANT DASD ONLY ENTRY              @DA38034 02673000
.*                                                             @DA38034 02674000
VOLGIV40 TM    AVRIFLG,AVRIANY    DOES USER WANT ANYTHING ELSE @DA38034 02675000
         BNZ   VOLGIV70           YES, I WILL NOT HANDLE THIS  @DA38034 02676000
         CLI   VCTATYPE,VCTATAPE  IS THIS A TAPE ENTRY         @DA44498 02677000
         BE    VOLGIV70           YES, USER DOES NOT WANT TAPE @DA44498 02678000
         B     VOLGIV60           YES,                         @DA38034 02679000
VOLGIV50 CLM   RC,1,PUBDEVTY      CORRECT DEVICE TYPE          @D21ZDAP 02680000
         BNE   VOLGIV70           NO, BUMP TO NEXT ENTRY       @D21ZDAP 02681000
VOLGIV60 TM    PUBJCFLG,X'F8'     IS DEVICE DOWN               @D21ZDAP 02682000
         BNZ   VOLGIV80           NO, THIS IS THE ONE          @D21ZDAP 02683000
         OC    VOLGR3R4(4),VOLGR3R4 ALREADY ONE FOUND          @D14CDOW 02684000
         BNZ   VOLGIV70           YES DO NOT OVERWRITE         @D14CDOW 02685000
         STM   R3,R4,VOLGR3R4     SAVE PUB AND AVR-ADDRESS     @D37BDAP 02686000
VOLGIV70 AH    R4,VCTELEN         POINT AT NEXT ENTRY          @D51EDAP 02687000
         BCT   R8,VOLGIV20        PROCESS REST OF TABLE        @D35VDEP 02688000
         LM    R3,R4,VOLGR3R4     CLEAR OR RELOAD R3 AND R4    @D37BDAP 02689000
         LTR   R3,R3              DID WE FIND A PUB            @D37BDAP 02690000
         BZ    GETERR08           VOLUME IS NOT MOUNTED        @D21ZDAP 02691000
         DROP  R1                 RELEASE INPUT PARAMETER BASE @DA38034 02692000
VOLGIV80 BAL   R7,LUBAVR1         CHECK IF DEVICE IS ASSIGNED  @D21ZDAP 02693000
*SGLINK  LUBAVR1,INPUT=(R3,R5,R7,RD),OUTPUT=(R8,R9),WORK=(R1,RC)        02694000
         B     GETAVRST           FILL OUTPUT AREA             @DA44498 02695000
         DROP  R3                 RELEASE PUB BASE             @D36IDAP 02696000
         DROP  R4                 RELEASE AVR BASE             @D36IDAP 02697000
         DC    0F'0'              FORCE ALIGNMENT              @D35CDEP 02698000
MSKDCTIN DC    AL1(0),AL1(STARIDCT),AL2(0) INDICATE DCT GIVEN  @D131DAP 02699000
VOLGR3R4 DC    2F'0'              SAVE AREA FOR R3 AND R4      @D37BDAP 02700000
VOLGUSER DC    CL8'0'             USER SUPPLIED VOLID          @D37BDAP 02701000
         TITLE 'VSE SUPERVISOR     SGSER     FIND DCT ENTRY FOR DEVTYP' 02702000
.**************************************************************@D131DAP 02703000
.*                                                             @D131DAP 02704000
.* FUNCTION- PROCESS DEVTYP IDENTIFIER INPUT                   @D131DAP 02705000
.* ENTRY POINT- TYPGIVEN - FROM GETVCE IF TRKBAL/TRKCAP ONLY   @D131DAP 02706000
.* INPUTS-   R0= RETURN CODE                                   @D131DAP 02707000
.*           R1= ADDRESS OF USERS PARAMETER LIST               @D131DAP 02708000
.*           R5= ADDRESS OF PARTITION COMREG                   @D131DAP 02709000
.*           RA= ADDRESS OF TCB                                @D131DAP 02710000
.*           RC= USERS SUPPLIED PUB-DEVICE-TYPE CODE           @D131DAP 02711000
.* OUTPUTS-  R3= ADDRESS OF ASSOCIATED DCT ENTRY               @D131DAP 02712000
.* EXITS-    GETERR14                                          @D131DAP 02713000
.*           SGSTAR                                            @D131DAP 02714000
.*                                                             @D131DAP 02715000
.*                                                             @D131DAP 02716000
.* SUBROUTINES-                                                @D131DAP 02717000
.*                                                             @D131DAP 02718000
.*                                                             @D131DAP 02719000
.**************************************************************@D131DAP 02720000
         USING AVRIADR,R1         PARAMETER BASE POINTER       @D131DAP 02721000
TYPGIVEN DS    0H'0'              USER SUPPLIED DEVTYP ONLY    @D131DAP 02722000
         CLI   AVRIDVTY,TCKD      IS THIS A CKD DEVICE         @D131DAP 02723000
         BL    GETERR14           NO, BAD INPUT                @D131DAP 02724000
         CLI   AVRIDVTY,TCKD+X0F  THIS IS A CKD DEVICE         @D131DAP 02725000
         BH    GETERR14           NO, BAD INPUT                @D131DAP 02726000
         CLI   AVRIDVTY,TECKD     THIS THIS AN ECKD DEVICE     @D131DAP 02727000
         BE    GETERR14           YES, INVALID REQUEST         @D131DAP 02728000
TYPGIV10 CLI   AVRIVER,ZERO       IS THIS THE INITIAL VERSION  @D131DAP 02729000
         BE    GETERR14           YES, BAD PARAMETER INPUT     @D131DAP 02730000
         L     R4,BASESERI        SGSERI BASE ADDRESS          @D51GDAP 02731000
         USING SGSERI,R4          SGSERI BASE POINTER          @D51GDAP 02732000
         L     R8,AVRCOUNT        GET NUMBER OF ENTRIES        @D51EDAP 02733000
         L     R4,AAVRTAB         ADDRESS OF VCTE ENTRY        @D51EDAP 02734000
         USING VCTEADR,R4         VCT BASE POINTER             @D51EDAP 02735000
TYPGIV20 CLI   VCTATYPE,VCTATAPE  IS ENTRY FOR TAPE            @D21LDRP 02736000
         BE    TYPGIV30           YES, GET NEXT ENTRY          @D21LDRP 02737000
         L     R3,VCTAPUB         INCREASE REQUIRED LENGTH     @D21LDRP 02738000
         USING PUBADR,R3          PUB BASE POINTER             @D51GDAP 02739000
         CLM   RC,1,PUBDEVTY      IS THIS THE RIGHT DEVICE     @D51GDAP 02740000
         BE    FILLBAL            YES,                         @D51GDAP 02741000
TYPGIV30 AH    R4,VCTELEN         POINT TO NEXT VCT ENTRY      @D51EDAP 02742000
         BCT   R8,TYPGIV20        LOOP UNTILL ALL PROCESSED    @D21LDRP 02743000
         B     GETERR14           INVALID SPECIFICATION        @D51EDAP 02744000
         SPACE 1                                                        02745000
         DROP  R3                 RELEASE SGSERI BASE POINTER  @D131DAP 02746000
         DROP  R4                 RELEASE VCT ENTRY BASE       @D51EDAP 02747000
         DROP  R1                 RELEASE AVRIADR BASE         @D131DAP 02748000
         DROP  RA                 RELEASE TCB BASE             @D61NDAP 02749000
         TITLE 'VSE SUPERVISOR     SGSER     COPY INFORMATION TO USER ' 02750000
.********************************************************************** 02751000
.*                                                                      02752000
.* FUNCTION- FILL USERS OUTPUT AREA WITH VOLUME AND DEVICE INFO         02753000
.* ENTRY POINT- FILLAVR - FROM LNOGIVEN,CUUGIVEN,VOLGIVEN ROUTINES      02754000
.* INPUTS-   R0= RETURN CODE                                            02755000
.*           R3= ADDR OF PUB ENTRY                                      02756000
.*           R4= ADDR OF VCT ENTRY FOR THIS REQUEST                     02757000
.*           R9= LOGICAL UNIT FOR THIS DEVICE                           02758000
.*               NEGATIVE IF NOT ASSIGNED                               02759000
.*           RE= ADDR OF USERS OUTPUT AREA                              02760000
.*           RA= ADDR OF TCB                                            02761000
.*           RF= LENGTH OF USER OUTPUT AREA-1                           02762000
.* OUTPUTS-  R0= RETURN CODE                                            02763000
.* EXITS-    TO EXITAVR TO FILL USERS RETURN CODE                       02764000
.* REGISTERS-R1= MOVE LENGTH OF DATA                                    02765000
.*           R4= ADDR OF VCTE AND DCTE CONTAINING DATA FOR USER         02766000
.* SUBROUTINES- NONE                                                    02767000
.*                                                                      02768000
.********************************************************************** 02769000
         USING PUBADR,R3          PUB BASE POINTER             @D35VDEP 02770000
         USING VCTEADR,R4         AVR ENTRY BASE POINTER       @D14COM1 02771000
FILLAVR  EQU   *                  FILL OUTPUT AREA             @D35VDEP 02772000
         LTR   RE,RE              DOES USER WANT OUTPUT        @D37BDAP 02773000
         BZ    FILLBAL            NO, USER WANTS BALANCE       @D37BDAP 02774000
         L     RC,BASESERI        GET BASE OF FIXED CODE       @D35CDFG 02775000
         USING SGSERI,RC          IS NOW ADDRESSABLE           @D35CDFG 02776000
         LA    RA,SVC99WRK        ADDRESS OF WORK AREA         @D61NDAP 02777000
         USING AVRADR,RA          AVRLIST BASE POINTER         @D61NDAP 02778000
         XC    AVRADR(L'SVC99WRK),AVRADR CLEAR WORK AREA       @D61NDAP 02779000
         MVC   AVRPUB(AVRLEN),VCTAPUB MOVE TO WORK AREA        @D61NDAP 02780000
         NI    AVRFLAG,XFF-AVRNLNO RESET LOGICAL UNIT INVALID  @D51EDAP 02781000
         STH   R9,AVRLNO          SAVE LOGICAL UNIT NUMBER     @D14COM1 02782000
         LTR   R9,R9              IS A LOGICAL UNIT ASSIGNED   @D14COM1 02783000
         BNM   FILLAVR4           YES,                         @D14COM1 02784000
         OI    AVRFLAG,AVRNLNO    INDICATE LNO IS INVALID      @D51EDAP 02785000
         LTR   R0,R0              IS RETURN CODE ALREADY SET   @DA36540 02786000
         BNZ   FILLAVR3           YES, DONT CHANGE IT          @DA36540 02787000
         LA    R0,AVRNOLNO        RC= OK BUT AVRLNO  INVALID   @DA30088 02788000
FILLAVR3 XC    AVRLNO,AVRLNO      CLEAR LOGICAL UNIT NUMBER    @D21LDRP 02789000
FILLAVR4 CLI   VCTATYPE,VCTATAPE  IS DEVICE A TAPE             @D61NDAP 02790000
         BE    FILLTAPE           YES,                         @D52VDAP 02791000
         CLI   PUBDEVTY,TFBA      IS DEVICE FBA                @D14COM1 02792000
         BNE   FILLCKD            NO PROCESS CKD DEVICE        @D14COM1 02793000
.*                                                             @D51EDAP 02794000
.*       PREPARE DCT INFORMATION FOR FBA DEVICE FROM VCTE INFO @D51EDAP 02795000
.*                                                             @D51EDAP 02796000
         ICM   R9,15,VCTFBUM      BLOCKS UNDER MOVABLE ACCESS  @D14COM1 02797000
         ICM   R8,15,VCTFBUF      BLOCKS UNDER FIXED ACCESS    @D14COM1 02798000
         ALR   R9,R8              TOTAL NUMBER OF BLOCKS       @D14COM1 02799000
         SLR   R8,R8              CLEAR WORK REG               @D14COM1 02800000
         ICM   R1,15,VCTFBPA      BLKS/ACCESS POSITION         @D14COM1 02801000
         BZ    FILDF010           DIVISOR IS ZERO              @D52VDAP 02802000
         DR    R8,R1              PRIMARY CYLINDERS            @D14COM1 02803000
         AIF   (NOT &VSE280).N280120                                    02804000
         CLM   R9,12,H0           IS CYLINDER NUMBER VALID     @DSCSI   02805000
         BE    FILDF010           YES,                         @DSCSI   02806000
         SLR   R9,R9              CLEAR REGISTER               @DSCSI   02807000
         ICM   R9,3,XFFFF         USE MAXIMUM SUPPORTED        @DSCSI   02808000
.N280120 ANOP                                                           02809000
FILDF010 STCM  R9,3,DCTPCYL       SET HIGH ORDER DCTPCYL VALUE @D14COM1 02810000
         MVC   DCTACYL,VCTFBIA    BLOCKS IN ALTERNATE AREA     @D14COM1 02811000
         SLR   R8,R8              CLEAR WORK REG               @D14COM1 02812000
         LTR   R9,R1              BLKS/ACCESS POSITION         @D52VDAP 02813000
         BZ    FILDF020           NONE YET AVAILABLE           @D61NDAP 02814000
         ICM   R1,15,VCTFBPC      BLKS/CYCLICAL GROUP          @D14COM1 02815000
         DR    R8,R1              CYCLICAL GRPS/ACCESS POS.    @D14COM1 02816000
         AIF   (NOT &VSE280).N280140                                    02817000
         CLM   R9,12,H0           IS TRACK NUMBER VALID        @DSCSI   02818000
         BE    FILDF020           YES,                         @DSCSI   02819000
         SLR   R9,R9              CLEAR REGISTER               @DSCSI   02820000
         ICM   R9,3,XFFFF         USE MAXIMUM SUPPORTED        @DSCSI   02821000
.N280140 ANOP                                                           02822000
FILDF020 STCM  R9,3,DCTTCYL       SET HIGH TRACKS PER CYLINDER @D61NDAP 02823000
         MVC   DCTBTRK,VCTFBPC    BLOCKS PER CYCLICAL GROUP    @D61NDAP 02824000
         MVC   DCTTFIX,VCTFBUF    NUMBER OF FIXED BLOCKS       @D61NDAP 02825000
         MVC   DCTMAXR,VCTFBLKS   BYTES PER BLOCK              @D61NDAP 02826000
         MVC   DCTROH,RDCRCOVH    MOVE LAST PART OF DCT ENTRY  @D61NDAP 02827000
         B     FILLUSER                                        @D14COM1 02828000
FILLTAPE XC    DCTDTFC(DCTEXTCD-DCTDTFC),DCTDTFC CLEAR UNUSED  @D61NDAP 02829000
         MVC   DCTUDCL(2),VCTTDCLS SET DEVICE CLASS/TYPE       @D61NDAP 02830000
         B     FILLUSER           NO MORE DATA EXISTS          @D52VDAP 02831000
FILLCKD  DS    0H'0'              BUILD DCT INFO FOR CKD DEVICE@D51EDAP 02832000
         MVC   DCTUCBC(2),VCTACATB MOVE FEATURE BYTES          @D61NDAP 02833000
         MVC   DCTUDCL(2),VCTCDCLS MOVE CLASS AND UNIT INFO.   @D51EDAP 02834000
         MVC   DCTPCYL,VCTCPCYL   MOVE PRIMARY CYLINDERS       @D51EDAP 02835000
         SLR   R8,R8              CLEAR REGISTER               @D51EDAP 02836000
         SLR   R9,R9              CLEAR REGISTER               @DA40427 02837000
         LH    R1,VCTCTRKC        NUMBER OF TRACKS PER CYLINDER@D51EDAP 02838000
         ICM   R9,3,VCTCALTT      NUMBER OF ALTERNATE TRACKS   @DA40427 02839000
         BZ    FILDC005           DATA NOT AVAILABLE           @DA40427 02840000
         DR    R8,R1              NUMBER OF ALTERNATE CYLINDERS@D51EDAP 02841000
FILDC005 STCM  R9,3,DCTACYL       SET HIGH ALTERNATE CYL VALUE @DA40427 02842000
         MVC   DCTTCYL,VCTCTRKC   MOVE TRACKS PER CYLINDER     @D51EDAP 02843000
         MVI   DCTBTRK,ZERO       CLEAR FIRST BYTE             @D51EDAP 02844000
         MVC   DCTBTRK+1(3),VCTCBTRK BYTES PER TRACK           @D51EDAP 02845000
         XC    DCTTFIX(DCTEXTCD-DCTTFIX),DCTTFIX CLEAR DATA    @D61NDAP 02846000
         L     R7,DCTBTRK         NUMBER OF BYTES PER TRACK    @D51EDAP 02847000
         LTR   R7,R7              IS THIS VALID DATA           @D52VDAP 02848000
         BZ    FILDC020           NO,                          @D52VDAP 02849000
         CLI   VCTCFORM,X'02'     FORMULAR 2 TO BE USED        @D51EDAP 02850000
         BNE   FILDC015           NO,                          @D51EDAP 02851000
         SLR   R1,R1              CLEAR REGISTER               @D51EDAP 02852000
         LR    R9,R1              CLEAR REGISTER               @D51EDAP 02853000
         IC    R1,VCTCCF1         GET CELL SIZE                @D51EDAP 02854000
         IC    R9,VCTCCF2         RECORD GAP IN CELLS          @D51EDAP 02855000
         MR    R8,R1              GAP SIZE (F1*F2)             @D51EDAP 02856000
         SR    R7,R9              DCTBTRK-(F1*F2)              @D51EDAP 02857000
         IC    R1,VCTCCF5         SIZE OF HALF A SUB-BLOCK     @D51EDAP 02858000
         AR    R1,R1              SUB-BLOCK SIZE  (2*F5)       @D51EDAP 02859000
         IC    R8,VCTCCF4         CHECK BYTES PER SUB-BLOCK    @D51EDAP 02860000
         AR    R1,R8              SUB-BLOCK+CHECK BY (2*F5+F4) @D51EDAP 02861000
         SLR   R8,R8              CLEAR REGISTER               @D51EDAP 02862000
         LR    R9,R7              RECORD SIZE MINUS GAP        @D51EDAP 02863000
         DR    R8,R1              SUB-BLOCKS FOR SIGLE RECORD  @D51EDAP 02864000
         LR    R1,R8              SAVE REST                    @D51EDAP 02865000
         SLR   R8,R8              CLEAR REGISTER               @D51EDAP 02866000
         IC    R8,VCTCCF4         CHECK BYTES PER SUB-BLOCK    @D51EDAP 02867000
         MR    R8,R8              FULL SUB-BLOCK CHECK BYTES   @D51EDAP 02868000
         SR    R7,R9              NEW MAX RECSIZE              @D51EDAP 02869000
         IC    R8,VCTCCF4         CHECK BYTES PER SUB-BLOCK    @D51EDAP 02870000
         SR    R7,R8              SUBTRACT CHECK BYTES         @D51EDAP 02871000
         SR    R1,R8              SUBTRACT CHECK BYTES         @D51EDAP 02872000
         BNM   FILDC010           CHECK BYTES FIT IN REST-BLOCK@D51EDAP 02873000
         AR    R1,R8              RESTORE TO REAL REST         @D51EDAP 02874000
         AR    R7,R8              NEW MAX. RECORD SIZE         @D51EDAP 02875000
         SR    R7,R1              NEW MAX. RECORD SIZE         @D51EDAP 02876000
FILDC010 IC    R8,VCTCCF6         BLOCK CHECK+CRC BYTES        @D51EDAP 02877000
         SR    R7,R8              FINAL MAX. RECORD LENGTH     @D51EDAP 02878000
         B     FILDC020                                        @D51EDAP 02879000
FILDC015 SH    R7,VCTCCF23        SUBTRACT RECORD OVERHEAD     @D51EDAP 02880000
FILDC020 STCM  R7,3,DCTMAXR       HIGH BYTE OF MAX RECSIZE     @D51EDAP 02881000
         SLR   R1,R1              CLEAR REGISTER               @D51EDAP 02882000
         LR    R8,R1              CLEAR REGISTER               @D51EDAP 02883000
         CLI   VCTCFORM,X'02'     FORMULAR 2 TO BE USED        @D51EDAP 02884000
         BNE   FILDC025           NO,                          @D51EDAP 02885000
         LR    R9,R8              CLEAR REGISTER               @D51EDAP 02886000
         BCTR  R9,0               INVALIDATE UNUSED INFO       @D51EDAP 02887000
         IC    R9,ZERO            SET TO FFFFFF00              @D51EDAP 02888000
         LR    R8,R9              SET TO FFFFFF00              @D51EDAP 02889000
         B     FILDC035           SKIP UNUSABLE DATA           @D51EDAP 02890000
FILDC025 LH    R9,VCTCCF23        GET NON KEYED OVERHEAD       @D51EDAP 02891000
         ICM   R1,1,VCTCCF1       GET SEGMENT SIZE             @D51EDAP 02892000
         BZ    FILDC030           THIS IS NOT A MODULO DEVICE  @D51EDAP 02893000
         DR    R8,R1              NO. OF SEGMENT + CORRECT.BYTE@D51EDAP 02894000
         LR    R7,R8              SAVE CORRECTION BYTES        @D51EDAP 02895000
         MR    R8,R1              NON KEYED OVERHEAD           @D51EDAP 02896000
         LR    R8,R7              SAVE CORRECTION BYTES        @D51EDAP 02897000
FILDC030 AH    R9,VCTCCF45        ADD KEY OVERHEAD             @D51EDAP 02898000
         SR    R9,R8              KEY + DATA OVERHEAD W/O CORR.@D51EDAP 02899000
         SLL   R9,16              SHIFT INTO PROPER POSITION   @D51EDAP 02900000
         ICM   R9,2,VCTCCF45+1    GET KEY OVERHEAD             @D51EDAP 02901000
         LA    R7,DCTHALF         DEVICE IS CKD                @D51EDAP 02902000
         SLL   R8,8               SHIFT CORRECTION BYTES       @D51EDAP 02903000
         SLR   R9,R8              SUBTRACT CORR. BYTES FROM KEY@D51EDAP 02904000
         SLL   R8,8               SHIFT NOW INTO BYTE 1        @D51EDAP 02905000
FILDC035 ICM   R8,8,VCTCCF1       GET SEGMENT SIZE             @D51EDAP 02906000
         BZ    FILDC040           NO MODULO DEVICE             @D51EDAP 02907000
         LA    R7,DCTTCKD         DEVICE IS A MODULO DEVICE    @D51EDAP 02908000
FILDC040 CLI   VCTATYPE,VCTAECKD  IS THIS ECKD DEVICE          @D51EDAP 02909000
         BNE   FILDC045           NO                           @D51EDAP 02910000
         LA    R7,DCTTECKD        INDICATE ECKD DEVICE         @D51EDAP 02911000
FILDC045 OR    R9,R7              OR THE FLAGS BITS            @D51EDAP 02912000
         ICM   R8,2,DCTDTFC       GET RPS DEVICE TYPE CODE     @D51EDAP 02913000
         BNZ   FILDC050           IS PRE-DEFINED               @D51EDAP 02914000
         ICM   R8,2,VCTCDTYP      USE UNIT TYPE CODE AS DTF    @D51EDAP 02915000
FILDC050 STCM  R9,15,DCTROH       SAVE DATA                    @D61NDAP 02916000
         STCM  R8,15,DCTBYSEG     SAVE DATA                    @D51EDAP 02917000
         MVC   DCTSDST1(10),VCTADVS1 MOVE DEVICE SPECIAL DATA  @D61NDAP 02918000
FILLUSER DS    0H'0'                                                    02919000
         MVC   DCTEXTCD,VCTAEXTC  MOVE EXTERNAL CODE           @DY46120 02920000
         EX    RF,FILLEXUS        MOVE DATA TO USER AREA       @D61NDAP 02921000
         CLI   VCTATYPE,VCTATAPE  IS DEVICE A TAPE             @D61NDAP 02922000
         BE    EXITAVR            YES,                         @D52VDAP 02923000
         B     FILLBAL            ALL DATA WAS PROCESSED NOW   @D51EDAP 02924000
FILLEXUS MVC   0(0,RE),AVRADR     COPY DATA TO USER BUFFER     @D61NDAP 02925000
         DROP  RA                 RELEASE AVRADR BASE POINTER  @D61NDAP 02926000
         SPACE 3                                                        02927000
FILLBAL  EQU   *                  TEST IF SGSTAR FUNCTION      @D37BDAP 02928000
         L     R1,SVER01          RELOAD USERS PARAMETER REG   @D37BDAP 02929000
         USING AVRIADR,R1         INPUT PARAMETER BASE         @D37BDAP 02930000
         LA    R1,0(,R1)          RESET HIGH ORDER BIT         @D66CDAP 02931000
         TM    SVEPSW+4,X'80'     31-BIT MODE                  @D66CDAP 02932000
         BO    FILLB000           YES,                         @D66CDAP 02933000
         ICM   R1,8,H0            ENSURE 24-BIT ADDRESS        @D66ADAP 02934000
FILLB000 CLI   AVRIVER,ZERO       IS THIS THE INITIAL VERSION  @D37BDAP 02935000
         BE    EXITAVR            YES, RETURN TO USER          @D37BDAP 02936000
         CLI   VCTATYPE,VCTAECKD  IS THIS ECKD DEVICE          @D51GDAP 02937000
         BNE   FILLB010           NO                           @D51GDAP 02938000
         CH    R0,H4              IS DEVICE READY              @D51GDAP 02939000
         BH    EXITAVR            NO,                          @D51GDAP 02940000
FILLB010 ICM   R0,15,14(R1)       LOAD DD K R INTO R0          @D37BDAP 02941000
         ICM   R1,15,18(R1)       LOAD FLAG AND BALANCE        @D37BDAP 02942000
         DROP  R1                 RELEASE PARAMETER BASE       @D61NDAP 02943000
         LA    R2,FILLB020        GET CONTINUATION ADDRESS     @D66CDAP 02944000
         BASSM R2,R2              GET INTO 24-BIT MODE         @D66CDAP 02945000
FILLB020 LR    R2,R4              VCTE ENTRY ADDRESS           @D51GDAP 02946000
         STM   R0,R1,SVER00       UPDATE USERS SAVE AREA       @D37BDAP 02947000
         L     RD,ADRSVC75        ADDRESS OF SGSTAR ROUTINE    @D37BDAP 02948000
         USING SVC75,RD           SGSTAR BASE POINTER          @D51GDAP 02949000
         B     STARSV99           TRKCAP/TRKBAL CALCULATION    @D66ADAP 02950000
*SGLINK  STARSV99,INPUT=(R0,R1,R2,RB,RD)                       @D51GDAP 02951000
ADRSVC75 DC    A(SVC75)           ADDRESS OF STAR ROUTINE      @D37BDAP 02952000
         DROP  R3                 RELEASE PUB BASE POINTER     @D131DAP 02953000
         DROP  R4                 RELEASE VCTEADR BASE         @D61NDAP 02954000
         DROP  RB                 RELEASE SAVE AREA BASE       @D37BDAP 02955000
         DROP  RC                 RELEASE SGSERI BASE          @D61NDAP 02956000
         DROP  RD                 RELEASE SVC75 BASE           @D61NDAP 02957000
         SPACE 3                                               @D35VDEP 02958000
.********************************************************************** 02959000
.*                                                                      02960000
.* FUNCTION- FIND A LOGICAL UNIT FOR THIS DEVICE                        02961000
.* ENTRY POINT- LUBAVR1 - FROM CUU AND VOLID PROCESSING                 02962000
.* INPUTS-   R8= INDEX OF PUB FOR REQUESTED DEVICE                      02963000
.*           R7= RETURN ADDRESS                                         02964000
.*           R5= ADDR OF PARTITION COMM. REGION                         02965000
.*           RA= ADDR OF TCB                                            02966000
.* OUTPUTS-  R4= ADDR OF FOUND LUB                                      02967000
.*           R9= NUMBER OF FOUND LOGICAL UNIT                           02968000
.*               NEGATIVE IF DEVICE NOT ASSIGNED                        02969000
.* EXIT-     TO R7                                                      02970000
.*                                                                      02971000
.*           FIND A LOGICAL UNIT FOR THIS DEVICE                        02972000
.* LOGIC-                                                               02973000
.*                                                                      02974000
.* FOUND = NO                                                           02975000
.* GET COUNT OF PROGRAMMER UNITS FOR THIS PARTITION.                    02976000
.* SET R9 TO THE ID OF THE 1ST PROGRAMMER UNIT.                         02977000
.* DO I = 1 TO NO. OF PROG. UNITS UNTIL(FOUND=YES)                      02978000
.*   IF R8 = PROG LUB.PUBINDEX(I) THEN                                  02979000
.*     FOUND = YES                                                      02980000
.*   ELSE                                                               02981000
.*     R9 = ID OF NEXT PROG UNIT.                                       02982000
.*   ENDIF                                                              02983000
.* ENDDO                                                                02984000
.* RETURN WITH R9 =(LNO) OR NOT FOUND CODE                              02985000
.*                                                                      02986000
.* REGISTERS-RC= COUNT OF PROGRAMMER LUBS FOR THIS PARTITION            02987000
.*                                                                      02988000
.********************************************************************** 02989000
         USING SVC99,RD           SVC 99 BASE POINTER          @D51GDAP 02990000
LUBAVR1  EQU   *                  FIND A LUB FOR THIS DEVICE   @D35VDEP 02991000
         LR    R8,R3              HAVE TO CHECK FOR A LUB      @D37BDAP 02992000
         SH    R8,YPUBTAB         GET DISPL. TO PUB            @D37BDAP 02993000
         SRL   R8,PUBSLEN         PUB ENTRY NUMBER             @D51ODGL 02994000
         SLR   R1,R1              CLEAR LUB POINTER            @D35VDEP 02995000
         L     RC,PCBPTR          PCB BASE ADDRESS             @D51IDAP 02996000
         USING PCBADR,RC          PCB BASE POINTER             @D51IDAP 02997000
         L     R9,PCEPIB          POINT TO PIB                 @D51IDAP 02998000
         USING PIBADR,R9          PIB BASE POINTER             @D36IDAP 02999000
         IC    R1,PIBLUBID        GET INDEX OF 1ST PROG. LUB   @D35VDEP 03000000
         AR    R1,R1              1ST PROGRAMMER LUB OFFSET    @D379DAP 03001000
         A     R1,PCEALUB         ADDRESS OF 1ST PROGRAMMER LUB@D379DAP 03002000
         DROP  RC                 RELEASE PCC BASE POINTER     @D51GDAP 03003000
         SLR   RC,RC              CLEAR LOOP COUNTER           @D51IDAP 03004000
         IC    RC,PIBLUBNO        GET NO. OF PROGRAMMER UNITS  @D35VDEP 03005000
         DROP  R9                 RELEASE PIB POINTER          @D36IDAP 03006000
         LA    R9,X'100'          INITIATE R9 TO SYS000        @D379DAP 03007000
LUBAVR2  CLM   R8,1,0(R1)         IS IT FOR THIS DEVICE        @D35VDEP 03008000
         AIF   (&AG1 LE 254).LOD0010                           @D51ODGL 03009000
         BNE   LUBAVR2A           CERTAINLY NOT.               @D51ODGL 03010000
         CLM   R8,2,1(R1)         IS IT REALLY FOR THIS DEVICE?@D51ODGL 03011000
.LOD0010 ANOP                                                  @D51ODGL 03012000
         BER   R7                 YES, ======================> @D35VDEP 03013000
LUBAVR2A DS    0H                                              @D51ODGL 03014000
         LA    R1,2(,R1)          NO, BUMP TO NEXT ENTRY       @D35VDEP 03015000
         LA    R9,1(,R9)          INCR. LOGICAL UNIT NUMBER    @D35VDEP 03016000
         BCT   RC,LUBAVR2         LOOP THRU PROG. UNITS        @D35VDEP 03017000
         LA    RC,LUBAVRCT        GET NO OF SYSTEM LUB ENTRIES @D35VDEP 03018000
         L     R9,PCBPTR          GET PCB ADDRESS              @D51GDAP 03019000
         USING PCBADR,R9                                       @D51GDAP 03020000
LUBAVR3  SLR   R1,R1              CLEAR REGISTER               @D51GDIS 03021000
         IC    R1,LUBAVRTB-1(RC)  PICK UP A SYSTEM LUB INDEX   @D51GDIS 03022000
         AR    R1,R1              SYSTEM LUB OFFSET            @D51GDAP 03023000
         A     R1,PCEALUB         GET LUB ADDRESS              @D35VDEP 03024000
         CLM   R8,1,0(R1)         LNO ASSIGNED TO RIGHT PUB?   @D35VDEP 03025000
         AIF   (&AG1 LE 254).LOD0020                           @D51ODGL 03026000
         BNE   LUBAVR3A           CERTAINLY NOT.               @D51ODGL 03027000
         CLM   R8,2,1(R1)         REALLY RIGHT PUB?            @D51ODGL 03028000
.LOD0020 ANOP                                                  @D51ODGL 03029000
         BE    LUBAVR4            YES,                         @D35VDEP 03030000
LUBAVR3A DS    0H                                              @D51ODGL 03031000
         BCT   RC,LUBAVR3         NO, GO THRU REST OF TABLE    @D35VDEP 03032000
         LR    R9,RC              CLEAR REGISER                @D51IDAP 03033000
         BCTR  R9,0               MAKE VALUE NEGATIVE          @D51GDAP 03034000
         BR    R7                      ======================> @D35VDEP 03035000
         DROP  R9                 RELEASE PIB POINTER          @D51IDAP 03036000
LUBAVR4  SLR   R9,R9              CLEAR REGISTER               @D51GDAP 03037000
         IC    R9,LUBAVRTB-1(RC)  PASS BACK SYSTEM LUB INDEX   @D51GDAP 03038000
         BR    R7                      ======================> @D35VDEP 03039000
.*  THIS TABLE CONTAINS THE LUB INDEX OF ALL SYSTEM-LUBS THAT           03040000
.*  CAN BE PASSED BY THE GETVCE MACRO (IN THE AVRLNO  FIELD)            03041000
LUBAVRTB DC    X'09',X'06',X'0A',X'07',X'08',X'0B',X'0D'       @DA44738 03042000
LUBAVRCT EQU   7                  NO. OF ENTRIES IN LUBAVRTB   @DA44738 03043000
         DROP  R5                 RELEASE COMREG BASE          @D35CDFG 03044000
         SPACE 3                                               @D35CDFG 03045000
.*THE CLRAVR INSTRUCTION AND THE CUUEXCLC INSTRUCTIONS ARE     @D35CDFG 03046000
.*PLACED HERE TO AVOID PAGE FAULTS DURING CRITICAL GETVCE CODE @D35CDFG 03047000
         USING VCTEADR,RE         ADDRESS USER OUTPUT AREA     @D35CDFG 03048000
CLRAVR   XC    VCTEADR,VCTEADR    CLEAR USER OUTPUT AREA       @D35VDEP 03049000
         DROP  RE                                              @D35CDFG 03050000
CUUEXCLC CLC   0(1,RE),0(R7)      REFERENCE WHOLE USER AREA    @D14SSX1 03051000
GETVCEND EQU   *-1                END OF CRITICAL CODE SECTION @D35CDFG 03052000
         SPACE 3                                                        03053000
EXITAVR  EQU   *                  EXIT TO USER                 @D35VDEP 03054000
         L     RA,TCBPTR          GET TCB ADDRESS              @D61NDAP 03055000
         USING TCBADR,RA          TCB BASE POINTER             @D61NDAP 03056000
         L     R8,TCBSAVE         GET ADDR OF USER SAVE AREA   @D36IDAP 03057000
         USING SVEARA,R8          USER SAVE AREA               @D35VDEP 03058000
         ST    R0,SVER0F          PASS BACK RETURN CODE        @D35VDEP 03059000
         BR    R6                 EXIT ====================>>> @D35VDEP 03060000
         DROP  R6                 RELEASE DISP BASE            @D66ADAP 03061000
         DROP  R8                 RELEASE SAVE AREA BASE       @D14SSX1 03062000
         DROP  RA                 RELEASE TCB BASE             @D14SSX1 03063000
         DROP  RD                 RELEASE SVC99 BASE           @D31ADAP 03064000
         TITLE 'VSE SUPERVISOR     SGSER     MODIFY VCT TABLE ENTRY   ' 03065000
.********************************************************************** 03066000
.*                                                                      03067000
.* FUNCTION- SET UP A REQUEST ELEMENT ENTRY THAT CAN BE                 03068000
.*           FURTHER PROCESSED BY THE SERVICE TASK (SVT)                03069000
.* ENTRY POINT- SV101BAL CALLED VIA BALR   RC,RD                        03070000
.* INPUTS-   R0= OPTIONS AND FLAG BYTES                                 03071000
.*           R1= ADDRESS OF PARAMETER LIST                              03072000
.*           RC= LINK REGISTER                                          03073000
.*           RD= SV101BAL BASE ADDRESS                                  03074000
.* OUTPUTS-  RF= RETURN CODE                                            03075000
.* SUBROUTINES-                                                         03076000
.*           AVRFVCTE - CHECK IF DEVICE IS SUPPORTED                    03077000
.*           AVRCUUT1 - TO FIND PUB ADDR FROM X'0CUU' FORMAT            03078000
.*           SERACT   - ACTIVATE SERVICE TASK                           03079000
.*                                                                      03080000
.********************************************************************** 03081000
         USING SV101BAL,RD        SV101BAL BASE POINTER        @D61ADAP 03082000
SV101BAL DS    0H'0'              ENTRY FOR BAL INTERFACE      @D61ADAP 03083000
         LR    RB,RC              SAVE LINK ADDRESS            @D61ADAP 03084000
         LA    RF,XFF             INITIALIZE RETURN CODE       @D61ADAP 03085000
         LR    R2,R1              SAVE PARAMETER ADDRESS       @D61ADAP 03086000
         L     R6,DISPAD          LOAD DISPATCHER BASE ADDRESS @D61ADAP 03087000
         USING DISP,R6            DISP BASE POINTER            @D66ADAP 03088000
SV101B10 L     RC,BASESERI        SGSERI BASE ADDRESS          @D61ADAP 03089000
         USING SGSERI,RC          ADDRESSABLE                  @D61ADAP 03090000
         L     RE,RQTFLPTR        GET A FREE REQUEST ENTRY     @D61ADAP 03091000
         LTR   RE,RE              IS REQUEST ELEMENT AVAILABLE @D61ADAP 03092000
         BP    SV101B20           YES, SET UP REQUEST ENTRY    @D61ADAP 03093000
         SR    R1,R1              INDICATE UNCOND. POSTING     @D61ADAP 03094000
         L     R5,ASRQTAB         RESOURCE DESCRIPTOR TABLE    @D61APAP 03095000
         LA    R5,SRQAVR-SRQTAB(,R5) AVR BOUND QUEUE           @D61APAP 03096000
         BAL   RC,RWAIT               =====================>>> @D61ADAP 03097000
*SGLINK  RWAIT,INPUT=(R1,R5,RC)                                @D61ADAP 03098000
         B     SV101B10                                        @D61ADAP 03099000
         SPACE 3                                               @D61ADAP 03100000
         USING RQTE,RE            REQUEST ELEMENT BASE         @D61ADAP 03101000
SV101B20 LR    R1,R2              RESTORE PARAMETER POINTER    @D61ADAP 03102000
         ST    R0,MODOPTN         SAVE FLAGS AND OPTIONS       @D61ADAP 03103000
         TM    MODOPTN+3,MODVCESH+MODVCEIN INVALID FUNCTIONS   @D61ADAP 03104000
         BNZ   SV101BXT           YES, ERROR                   @D61ADAP 03105000
SV101B30 MVC   RQTFLPTR,RQTNEXT   DEQUEUE FROM FREE CHAIN      @D61ADAP 03106000
         MVI   RQTFLG,RQTISBAL    INDICATE BAL INTERFACE       @D61ADAP 03107990
         LA    RD,SVC101          SET SVC101 BASE POINTER      @D61ADAP 03109000
         USING SVC101,RD          SVC101 BASE POINTER          @D61ADAP 03110000
         B     MODVCEBL                ======================> @D61ADAP 03111000
SV101BXT LR    RC,RB              RESTORE LINK REGISTER        @D61ADAP 03112000
         BSM   0,RC               BACK ====================>>> @D66ADAP 03113000
         DROP  R6                 RELEASE DISP BASE            @D66ADAP 03114000
         DROP  RC                 RELEASE SGSERI BASE          @D61ADAP 03115000
         DROP  RD                 RELEASE SVC101   BASE        @D61ADAP 03116000
         DROP  RE                 RELEASE RQTE BASE            @D61ADAP 03117000
         TITLE 'VSE SUPERVISOR     SGSER     MODIFY AVR TABLE ENTRY   ' 03118000
.********************************************************************** 03119000
.*                                                                      03120000
.* FUNCTION- SET UP A REQUEST ELEMENT ENTRY THAT CAN BE                 03121000
.*           FURTHER PROCESSED BY THE SERVICE TASK (SVT)                03122000
.* ENTRY POINT- SVC101 - FROM DISPACTCHER                               03123000
.* INPUTS-   R0= OPTIONS AND FLAG BYTES                                 03124000
.*           R1= ADDRESS   REGISTER                                     03125000
.*           R6= DISPATCHER BASE ADDRESS                                03126000
.*           RA= ADDRESS OF TCB                                         03127000
.* OUTPUTS-  AVR REQUEST TABLE ENTRY ELEMENT                            03128000
.*           USER REG 15 = RETURN CODE      (INVALID INPUT)             03129000
.* OUTPUTS-  USER IS SET AVRBOUND (NRM AND RESVC EXIT)                  03130000
.*           AVR REQUEST TABLE CONTAINS PUB INDEX,USER TIK(NRM)         03131000
.* REGISTERS-R0= RETURN CODE FOR USER                                   03132000
.*           R2= WORK REG FOR VALIDATION ROUTINES                       03133000
.*           R3= ADDR OF PUB FOR REQUESTED DEVICE                       03134000
.*           R4= ADDR OF VCTE FOR REQUESTED DEVICE                      03135000
.*           R5= ADDR OF PARTITION COMM REGION                          03136000
.*           R7= LINKAGE REGISTER TO SUBROUTINES                        03137000
.*           R8= LINK REG TO VALID AND ADDR OF USER SAVE AREA           03138000
.*           RC= SGSERI BASE ADDRESS                                    03139000
.*           RE= ADDR OF REQUEST ELEMENT. INPUT TO SERVICE TASK         03140000
.* SUBROUTINES-                                                         03141000
.*           AVRFVCTE - CHECK IF DEVICE IS SUPPORTED                    03142000
.*           AVRCUUT1 - TO FIND PUB ADDR FROM X'0CUU' FORMAT            03143000
.*           SERACT   - ACTIVATE SERVICE TASK                           03144000
.*                                                                      03145000
.********************************************************************** 03146000
         USING DISP,R6            DISP BASE POINTER            @D369DAP 03147000
         USING TIBADR,R8          TIB BASE POINTER             @D369DAP 03148000
         USING TCBADR,RA          TCB BASE POINTER             @D36IDAP 03149000
         USING PIBADR,RB          PIB BASE POINTER             @D369DAP 03150000
         USING SVC101,RC          SVC101 BASE                  @D66ADAP 03151000
SVC101   DC    0H'0'              REQUEST TO MODIFY THE VCT    @D35VDEP 03152000
         TM    TCBEXFLG,TCBEXAM   31 BIT MODE                  @D52VDAP 03153000
         NOP   SVC10110           SKIP FOR NOW                 @D52VDAP 03154000
         L     RD,ASV10131        GET 31-BIT BASE ADDRESS      @D66ADAP 03155000
         BASSM RD,RD              GET INTO 31-BIT MODE         @D66ADAP 03156000
ASV10131 DC    AL4(SVC10110+X'80000000') 31-BIT ADDRESS        @D66ADAP 03157000
SVC10110 DS    0H'0'              START 31-BIT MODE PROCESSING @D21LDAP 03158000
         LR    RD,RC              SET SVC101 BASE              @D21LDAP 03159000
         USING SVC101,RD          SVC101 BASE POINTER          @D21LDAP 03160000
         LA    R2,SVTTID          SVT TASK-ID                  @D66CDAP 03161000
         CH    R2,TID             IS IT OUR OWN CALL           @D66CDAP 03162000
         BER   R6                 YES, ====================>>> @D25IDAP 03163000
         AGO   .SKIP290                                                 03164490
*                                                              @D66ADAP 03165000
*        NOOP  ANY MODVCE FROM TAPE SERVER PARTITION           @D66ADAP 03166000
*                                                              @D66ADAP 03167000
         L     RC,IJBSPAVT        SUPVR ADDRESS VECTOR TABLE   @D66ADAP 03168000
         USING SUPAVT,RC          SUPAVT BASE POINTER          @D66ADAP 03169000
         L     RC,ASUPAVTE        ADDRESS OF SUPAVTEX          @D66ADAP 03170000
         USING SUPAVTEX,RC        SUPAVTEX BASE POINTER        @D66ADAP 03171000
         ICM   RC,15,AVTAPANC     COMMUNICATION AREA PRESENT   @D66ADAP 03172000
         BZ    MODVC020           NO,                          @D66ADAP 03173000
         USING VTAPHDR,RC         VIRTUAL TAPE HEADER BASE     @D66ADAP 03174000
         OC    VTAPTIDS,VTAPTIDS  IS TAPE SERVER ACTIVE        @DY46299 03175090
         BZ    MODVC020           NO,                          @DY46299 03175180
         CLC   TID,LTID           DOES REQUESTOR OWN LTA       @DY46299 03175270
         BE    MODVCRC0           YES, PREVENT DEAD-LOCK       @DY46299 03175360
         CLC   VTAPTIDS,TID       TAPE-SERVER IS THE REQUESTOR @D66ADAP 03175450
         BNE   MODVC020           NO,                          @D66ADAP 03176000
MODVCRC0 SLR   RF,RF              FORCE ZERO RETURN CODE       @D66ADAP 03177290
         SLR   R0,R0              NO VCTE ENTRY ADDRESS        @DY46299 03177580
         L     RB,TCBSAVE         GET SAVE AREA ADDRESS        @D66ADAP 03178000
         USING SVEARA,RB          SAVE AREA BASE POINTER       @D66ADAP 03179000
         STM   RF,R0,SVER0F       SET RETURN INFORMATION       @D66ADAP 03180000
         BR    R6                      ====================>>> @D66ADAP 03181000
         DROP  RC                 RELEASE VTAPHDR BASE         @D66ADAP 03182000
         USING PIBADR,RB          PIB BASE POINTER             @D369DAP 03183000
.SKIP290 ANOP                                                  @DA46299 03184490
MODVC020 LR    R2,R1              SAVE PARAMETER ADDRESS       @D61ADAP 03185000
MODVC040 L     RC,BASESERI        SGSERI BASE ADDRESS          @D35CDFG 03186000
         USING SGSERI,RC          ADDRESSABLE                  @D35CDFG 03187000
         L     RE,RQTFLPTR        GET A FREE REQUEST ENTRY     @D35VDEP 03188000
         USING RQTE,RE            REQUEST ELEMENT BASE         @D35VDEP 03189000
         LTR   RE,RE              IS REQUEST ELEMENT AVAILABLE @D35VDEP 03190000
         BP    MODVC060           YES, SET UP REQUEST ENTRY    @D35VDEP 03191000
         SR    R1,R1              INDICATE UNCOND. POSTING     @D36IDAP 03192000
         L     R5,ASRQTAB         RESOURCE DESCRIPTOR TABLE    @D61MPAP 03193000
         LA    R5,SRQAVR-SRQTAB(,R5) AVR BOUND QUEUE           @D61MPAP 03194000
         BAL   RC,RWAIT           WAIT ====================>>> @D61ADAP 03195000
*SGLINK  RWAIT,INPUT=(R1,R5,RC)                                @D61ADAP 03196000
         B     MODVC040           TRY AGAIN                    @D61ADAP 03197000
         SPACE 1                                                        03198000
         DROP  R8                 RELEASE TIB BASE             @D66ADAP 03199000
         SPACE 2                                                        03200000
MODVC060 LR    R1,R2              RESTORE PARAMETER POINTER    @D61ADAP 03201000
         ST    R0,MODOPTN         SAVE FLAGS AND OPTIONS       @D61ADAP 03202000
         TM    MODOPTN+3,MODVCESH USER WANTS SHR INDICATION    @D61ADAP 03203000
         BZ    MODVC080           NO,                          @D61ADAP 03204000
         TM    SYSFLAG2,IPLBIT    DID IPL REQUEST IT           @D61ADAP 03205000
         BZ    ERR21              NO, ======================>> @D61ADAP 03206000
MODVC080 TM    MODOPTN+3,MODVCEIN DEVICE TO BE INSTALLED       @D61ADAP 03207000
         BZ    MODVC100           NO,                          @D61ADAP 03208000
         TM    MODOPTN+3,MODVCEPH DID USER PROVIDE CUU ADDRESS @D61ADAP 03209000
         BZ    ERR21              NO,  =====================>> @D61ADAP 03210000
         TM    MODOPTN+3,MODVCEDT IS DEVICE TYPE SPECIFIED     @D61ADAP 03211000
         BO    ERR21              YES, =====================>> @D61ADAP 03212000
         AIF   (NOT &VSE280).N280160                           @D28DR06 03213000
         TM    IJBFLG08,IJBSAENV  IS THIS STAND ALONE ENVIR.   @D28DR06 03214000
         BZ    MODVC140           NO,                          @D28DR06 03215000
.N280160 ANOP                                                  @D28DR06 03216000
         LA    R2,8-1(,R1)        ASSUME INSTALL PARM LIST     @D61ADAP 03217000
         B     MODVC160           VALIDATE PARAMETER LIST      @D61ADAP 03218000
MODVC100 DS    0H'0'                                           @D61ADAP 03219000
         AGO   .SKIP300                                                 03220680
MODVC100 CLI   MODOPTN+1,RQTOPPLF IS THIS A PLF REQUEST        @D3570   03221000
         BNE   MODVC120           NO,                          @D3570   03222000
         TM    MODOPTN+3,MODVCEDT+MODVCEIN VALID BIT SETTING   @D3570   03223000
         BNZ   ERR21              NO,  =====================>> @D3570   03224000
         TM    MODOPTN+3,MODVCEPH DID USER PROVIDE CUU ADDRESS @D3570   03225000
         BZ    ERR21              NO,  =====================>> @D3570   03226000
         LR    R3,R1              SAVE R1                      @D3570   03227000
         USING MAPPLF,R3          MAPPLF BASE                  @D3570   03228000
         LA    R1,PLFECBA         GET ECB ADDRESS              @D3570   03229000
         LA    R2,3(,R1)          LENGTH OF ECB                @D3570   03230000
         BAL   R8,VALIDSVA        VALIDATE ECB AREA            @D3570   03231000
*SGLINK  VALIDSVA,S,INPUT=(R1,R2,R6,R8),WORK=(R2,R5)           @D3570   03232000
         LR    R1,R3              RESTORE PARM REGISTER        @D3570   03233000
         LA    R2,PLFCBLEN-1(,R1) ACCOUNT FOR PLF PARM LIST    @D3570   03234000
         B     MODVC160           VALIDATE PARAMETER LIST      @D3570   03235000
         DROP  R3                 RELEASE MAPPLF BASE          @D3570   03236000
.SKIP300 ANOP                                                           03237680
MODVC120 TM    MODOPTN+3,MODVCEDT IS DEVICE TYPE SPECIFIED     @D61ADAP 03238000
         BO    MODVC160           YES, VALIDATE 1 BYTE ONLY    @D61DDGL 03239000
MODVC140 LA    R2,2-1(,R1)        TWO BYTES PARAMETER LIST     @D61ADAP 03240000
MODVC160 SLR   R5,R5              USE KEY ZERO PRIVILEGES      @D61ADAP 03241000
         BAL   R8,VALREAD         VALIDATE INPUT AREA          @D61ADAP 03242000
*SGLINK  VALREAD INPUT=(R1,R2,R5,R6,R8),OUTP=R5,WORK=R2,R3,R4  @D61ADAP 03243000
         B     ERR25C           4 INVALID ADDRESS              @D61ADAP 03244000
         B     ERR25C           8 PROTECTION VIOLATION         @D61ADAP 03245000
         LR    R2,R1           12 RESTORE R2 TO POINT TO PARM  @D61ADAP 03246000
         MVC   RQTFLPTR,RQTNEXT   DEQUEUE FROM FREE CHAIN      @D36VDAP 03247000
         MVI   RQTFLG,ZERO        CLEAR FLAG BYTE              @D36VDAP 03248000
         AGO   .SKIP320                                                 03249680
         CLI   MODOPTN+1,RQTOPPLF IS THIS A PLF REQUEST        @D3570   03250000
         BNE   MODVCEBL           NO,                          @D3570   03251000
         LA    R2,PLFCUU-PLFCBID(R1) POINT TO CUU FIELD        @D3570   03252000
.SKIP320 ANOP                                                           03253680
MODVCEBL MVC   RQTOPCMD(1),MODOPTN+1 SAVE COMMAND ID IF ANY    @D61ADAP 03254000
         TM    MODOPTN+3,MODVCERS IS DEVICE TO BE RESERVED     @D61ADAP 03255000
         BZ    MODVC200           NO, TEST RELEASE OPTION      @D61ADAP 03256000
         OI    RQTFLG,RQTOPRSV    FORCE DEVICE TO BE RESERVED  @D356DAP 03257000
MODVC200 TM    MODOPTN+3,MODVCERL IS DEVICE TO BE RELEASED     @D61ADAP 03258000
         BZ    MODVC220           NO, TEST ADDRESSING BITS     @D61ADAP 03259000
         OI    RQTFLG,RQTOPRLS    INDICATE RELEASE REQUESTED   @D61ADAP 03260000
MODVC220 TM    MODOPTN+3,MODVCEDT IS DEVICE TYPE SPECIFIED     @D61ADAP 03261000
         BO    MODTYP10           YES, FIND UNUSED DEVICE      @D356DAP 03262000
         TM    MODOPTN+3,MODVCEPH DID USER PROVIDE CUU ADDRESS @D61ADAP 03263000
         BZ    MODVCLNO           NO, ASSUME LOGICAL ADDRESS   @D36SDAP 03264000
         BAL   R7,AVRCUUT1        SCAN PUB TABLE FOR CUU       @D35VDEP 03265000
*SGLINK  AVRCUUT1,INPUT=(R2,R7,RC),OUTPUT=R3                   @D21LDAP 03266000
         B     MODERR08           ERR  =====================>> @D356DAP 03267000
         USING PUBADR,R3          PUB BASE POINTER             @D61ADAP 03268000
         BAL   R8,AVRGPUBX        CALCULATE PUBX ADDRESS       @D28DR06 03269000
*SGLINK  AVRGPUBX,INPUT=(R3,R8,RC),OUTPUT=R9                   @D28DR06 03270000
         USING PBXADR,R9          PUBX BASE POINTER            @D28DR06 03271000
         TM    MODOPTN+3,MODVCEIN INSTALLATION REQUEST         @D61ADAP 03272000
         BZ    MODVC250           NO PROCEED MAIN LINE         @D28DR06 03273000
         AIF   (NOT &VSE280).N280180                           @D28DR06 03274000
         TM    IJBFLG08,IJBSAENV  IS THIS STAND ALONE ENVIR.   @D28DR06 03275000
         BO    MODVIN00           YES, ======================> @D61ADAP 03276000
         MVI   PBXRCDCC,XFF       WE NEED CONFIGURATION DATA   @D28DR06 03277000
         MVC   PBXPUBCD,PUBDEVTY  PROVIDE DEVICE TYPE CODE     @D28DR06 03278000
         B     MODVC280           PROCEED MAIN PATH            @D28DR06 03279000
         DROP  R9                 RELEASE PBXADR BASE          @D28DR06 03280000
.N280180 ANOP                                                  @D28DR06 03281000
         TITLE 'VSE SUPERVISOR     SGSER     SET UP RQT ENTRY         ' 03282000
MODVC240 DS    0H'0'              NON SA-PROCESSING            @D52VDAP 03283000
         BAL   R8,AVRGPUBX        CALCULATE PUBX ADDRESS       @D52VDAP 03284000
*SGLINK  AVRGPUBX,INPUT=(R3,R8,RC),OUTPUT=R9                   @D52VDAP 03285000
         USING PBXADR,R9          PUBX BASE POINTER            @D52VDAP 03286000
         AGO   .SKIP340                                                 03287680
         CLI   RQTOPCMD,RQTOPPLF  IS THIS A PLF COMMAND        @D3570   03288000
         BNE   MODVC250           NO,                          @D3570   03289000
         TM    PBXTDEN,PBXT3570   IS THIS A 3570 DEVICE        @DAOM073 03290000
         BZ    MODERR08           NO,  ======================> @D3570   03291000
.SKIP340 ANOP                                                           03292680
MODVC250 DS    0H'0'                                                    03293000
         AIF   (NOT &VSE270).N270060                           @D28DR07 03294490
         TM    PBXFLAG,PBXDASD+PBXTAPE IS VCTE ALLOCATED       @D28DR06 03295000
         BZ    MODVC260           NO,                          @D28DR06 03296000
         OC    PBXVCTE,PBXVCTE    VCTE ENTRY AVAILABLE         @TEST    03297000
         BNZ   MODVC270           YES,                         @TEST    03298000
MODVC260 OI    PBXFLAG2,PBXNOSIO  ENFORCE CHARACTERISTICS READ @TEST    03299000
.N270060 ANOP                                                  @D28DR07 03300490
MODVC270 CLI   PBXPVPEN,ZERO      PATH VERIFICATION REQUIRED   @D52VDAP 03301000
         BE    MODVC300           NO, DONT ACTIVATE SNS-TASK   @D52VDAP 03302000
         OI    PBXFLAG3,PBXF3PVT  DO PATH VERIFICATION         @D52VDAP 03303000
         CLC   PBXPVPEN(1),PBXPIM INSTALL PROCESSING           @D61ADAP 03304000
         BNE   MODVC290           NO, DO PATH VERIFICATION     @D61ADAP 03305000
MODVC280 NI    PBXFLAG3,XFF-PBXF3PVT RESET PVT PROCESSING      @D61ADAP 03306000
         OI    PBXFLAG3,PBXF3INS  DO INSTALL PROCESSING        @D61ADAP 03307000
MODVC290 LR    RF,RD              SAVE SVC101 BASE             @D52VDAP 03308000
         L     RD,ASNSINIT        GET SENSE TASK BASE ADDRESS  @D52VDAP 03309000
         USING SNSINIT,RD         SENSE ATSK BASE POINTER      @D52VDAP 03310000
         BAL   R7,SNSACT          ACTIVATE SNS-TASK            @D52VDAP 03311000
*SGLINK  SNSACT,INPUT=(R3,R7,RD),WORK=R8                       @D52VDAP 03312000
         LR    RD,RF              RESTORE SVC101 BASE          @D52VDAP 03313000
         USING SVC101,RD          SVC101 BASE POINTER          @D52VDAP 03314000
MODVC300 BAL   R7,AVRFVCTE        FIND ASSOCIATED VCTE ENTRY   @D35VDEP 03315000
*SGLINK  AVRFVCTE,INPUT=(R3,R7,RC),OUTPUT=R4,WORK=R8           @D369DAP 03316000
         LTR   R4,R4              DID ENTRY EXIST FOR THIS PUB @D35VDEP 03317000
         BNZ   MODVC320           YES, CONTINUE                @D35VDEP 03318000
         TM    MODOPTN+3,MODVCEIN INSTALLATION REQUEST         @D61DDGL 03319000
         BO    MODERR00           YES, ======================> @DA43697 03320000
         B     MODERR08           NO,  ======================> @D61DDGL 03321000
MODVC320 LA    R1,MODOPTN+2-(AVRIFLG-AVRIADR) ADJUST FOR CLASS @D61ADAP 03322000
         BAL   R7,AVRCLTST        CHECK FOR VALID CLASS OF ENTR@D21LDRP 03323000
*SGLINK  AVCLTST,INPUT=(R1,R3,R7,RC)                           @D21LDAP 03324000
         B     MODERR08           ERR  ======================> @D21LDRP 03325000
         USING VCTEADR,R4         VCT ENTRY BASE               @D36IDAP 03326000
         CLI   VCTATYPE,VCTATAPE  IS THIS A TAPE DEVICE        @D61ADAP 03327000
         BE    MODVC340           YES,                         @D61ADAP 03328000
         TM    MODOPTN+3,MODVCERL IS DEVICE TO BE RELEASED     @D61ADAP 03329000
         BZ    MODVC360           NO, PUT ISSUEING TASK IN WAIT@D356DAP 03330000
         TM    VCTAFLAG,VCTARSV   IS DEVICE RESERVED           @D356DAP 03331000
         BZ    MODERR1C           NO,  ======================> @D356DAP 03332000
         NI    VCTAFLAG,XFF-VCTARSV RESET DEVICE RESERVED      @D356DAP 03333000
         B     MODERR00           YES, ======================> @DA43697 03334000
MODVC340 TM    MODOPTN+3,MODVCERS IS DEVICE TO BE RESERVED     @DA44277 03335000
         BZ    MODVC360           NO,                          @D61ADAP 03336000
         OI    VCTAFLAG,VCTARSV   INDICATE TO BE RESERVED      @D61ADAP 03337000
MODVC360 TM    MODOPTN+3,MODVCESH IS THIS SHARED DEVICE        @D61ADAP 03338000
         BZ    MODVC380           NO, TEST IF IT IS RESERVED   @D36SDAP 03339000
         OI    VCTAFLAG,AVRSHR    YES, INDICATE SHARABLE DEVICE@D36SDAP 03340000
MODVC380 TM    VCTAFLAG,VCTACOPY  IS THIS A COPIED DEVICE      @DA37983 03341000
         BO    MODERR00           YES, ======================> @DA43697 03342000
         CLI   PUBDEVTY,XFF       IS THIS AN UNKNOWN DEVICE    @D61DDGL 03343000
         BE    MODERR00           YES, ======================> @DA43697 03344000
         OI    RQTFLG,RQTSET15    INDICATE TASK IS WAITING     @D356DAP 03345490
MODVC400 OI    RQTFLG,RQTINUSE    INDICATE RQT ENTRY IS IN USE @D36SDAP 03346000
         OI    SERFLGPR,SERRQTMV  INDICATE MODVCE PENDING      @D61ADAP 03347490
         AIF   (NOT &VSE280).N280220                           @D68ADAP 03348000
         OI    PBXFLAG3,PBXF3VOL  INDICATE VOL1-PROCESSING     @D68ADAP 03349000
.N280220 ANOP                                                           03350000
         MVC   RQTTID,TID         SAVE TID IN RQT ENTRY        @D36IDAP 03351000
         STH   R3,RQTPUB          SET PUB ADDRESS IN RQT ENTRY @D61ADAP 03352000
         DROP  R9                 RELEASE PUBX BASE POINTER    @D68ADAP 03353000
         AGO   .SKIP360                                                 03354680
         CLI   RQTOPCMD,RQTOPPLF  IS THIS A PLF REQUEST        @D3570   03355000
         BNE   MODVC420           NO,                          @D3570   03356000
         LA    R1,PLFCUU-PLFCBID  GET CUU OFFSET               @D3570   03357000
         SLR   R2,R1              RESTORE PLFINFO ADDRESS      @D3570   03358000
         ST    R2,RQTPLFAD        SAVE PARAMETER LIST ADDRESS  @D3570   03359000
.SKIP360 ANOP                                                           03360520
MODVC420 L     R8,IJBSPAVT        SUPVR ADDRESS VECTOR TABLE   @DY46299 03360550
         USING SUPAVT,R8          SUPAVT BASE POINTER          @DY46299 03360580
         L     R8,ASUPAVTE        ADDRESS OF SUPAVTEX          @DY46299 03360610
         USING SUPAVTEX,R8        SUPAVTEX BASE POINTER        @DY46299 03360640
         ICM   R8,15,AVTAPANC     COMMUNICATION AREA PRESENT   @DY46299 03360670
         BZ    MODVC440           NO,                          @DY46299 03360700
         USING VTAPHDR,R8         VIRTUAL TAPE HEADER BASE     @DY46299 03360730
         OC    VTAPTIDS,VTAPTIDS  IS TAPE SERVER ACTIVE        @DY46299 03360760
         BZ    MODVC440           NO, LET IT GO                @DY46299 03360790
         CLC   TID,LTID           DOES REQUESTOR OWN LTA       @DY46299 03360820
         BE    MODVCRC0           YES, TAPESRVR MIGHT BE WAIT. @DY46299 03360850
         CLC   VTAPTIDS,TID       TAPESRVR IS THE REQUESTOR    @DY46299 03360880
         BE    MODVCRC0           YES,                         @DY46299 03360910
         L     R8,ASVTTIB         GET SVT TIB                  @DY46299 03360940
         USING TIBADR,R8          TIB BASE POINTER             @DY46299 03360970
         CLI   TIBRQID,VDSBND     IS SVT TASK VIRT.-DEVICE BND.@DY46299 03361000
         BNE   MODVC440           NO, PROCEED NORMAL           @DY46299 03361030
         CLI   VCTATYPE,VCTATAPE  MODVCE FOR TAPE              @DY46299 03361060
         BE    MODVC440           YES, WE NEED TO EXECUTE IT   @DY46299 03361090
MODVCRC0 ST    R4,RQTVCTAD        PROVIDE VCTE ADDRESS         @DY46299 03361120
         XC    RQTRETCD,RQTRETCD  FORCE A ZERO RETURN CODE     @DY46299 03361150
         B     MODVC500           PROCEED MAIN LINE            @DY46299 03361180
         DROP  R8                 RELEASE SVTTIB BASE          @DY46299 03361210
.*                                                             @DY46299 03361240
.*       WE SKIP THE MODVCE PROCESS TO ENSURE THAT THE ISSUEING@DY46299 03361270
.*       TASK DOES NOT OCCUPY ANY RESOURCE THAT THE TAPE-SERVER@DY46299 03361300
.*       COULD BE WAITING ON                                   @DY46299 03361330
.*                                                             @DY46299 03361360
MODVC440 BAL   R7,SERACT          ACTIVATE SERVICE TASK        @DY46299 03361390
*SGLINK  SERACT,INPUT=(R6,R7,RC),WORK=(R8,RF)                  @D369DAP 03362000
         TM    RQTFLG,RQTSET15    TASK WANTS TO WAIT           @D61ADAP 03363490
         BZR   R6                 NO,  ====================>>> @D61ADAP 03364000
         AGO   .SKIP380                                                 03365680
         CLI   RQTOPCMD,RQTOPPLF  IS THIS A PLF REQUEST        @D3570   03366000
         BER   R6                 YES, ====================>>> @D3570   03367000
.SKIP380 ANOP                                                           03368680
         LR    R1,RE              WAITING ON RQT ENTRY         @D61APAP 03369000
         L     R5,ASRQTAB         RESOURCE DESCRIPTOR TABLE    @D61MPAP 03370000
         LA    R5,SRQAVR-SRQTAB(,R5) AVR WAIT QUEUE            @D61MPAP 03371000
         BAL   RC,RWAIT           SET TASK AVR BOUND           @D61ADAP 03372000
*SGLINK  RWAIT,INPUT=(R1,R5,RC)                                @D61ADAP 03373000
         DROP  RB                 RELEASE PIB BASE             @D66ADAP 03374000
.*                                                                      03375000
.*       SVT TASK HAS NOW COMPLETED THE REQUEST                         03376000
.*                                                                      03377000
         L     RC,BASESERI        RESTORE SGSERI BASE ADDRESS  @D61ADAP 03378000
MODVC500 L     RF,RQTRETCD        GET RETURN CODE              @D61ADAP 03379000
         TM    RQTFLG,RQTISBAL    IS THIS THE BAL INTERFACE    @D61ADAP 03380000
         BO    MODVCEXT           YES                          @D61ADAP 03381000
         AGO   .SKIP400                                                 03382680
         CLI   RQTOPCMD,RQTOPPLF  IS THIS A PLF REQUEST        @D3570   03383000
         BNE   MODVC520           NO,                          @D3570   03384000
         L     R8,RQTPLFAD        GET ADDRESS OF PARAMETER LIST@D3570   03385000
         USING MAPPLF,R8          PLF PARAMETER LIST           @D3570   03386000
         L     RB,PLFECBA         LOAD ADDRESS OF ECB          @D3570   03387000
         STH   RF,0(RB)           SAVE RETURN CODE             @D3570   03388000
         OI    2(RB),WAITBIT      POST USERS ECB               @D3570   03389000
         LR    RB,RE              SAVE RQT-ENTRY ADDRESS       @D3570   03390000
         L     R8,TIBPTR          GET TIB POINTER              @D3570   03391000
         USING TIBADR,R8          TIB BASE POINTER             @D3570   03392000
         BAL   RF,IOPOST1         POST I/O COMPLETE IF I/O BND @D3570   03393000
*SGLINK  IOPOST1,INPUT=(R6,R8,RF),WORK=RE                      @D3570   03394000
         LR    RE,RB              RESTORE RQT-ENTRY ADDRESS    @D3570   03395000
         B     MODVCEXT           TAKE GENERAL EXIT            @D3570   03396000
         DROP  R8                 RELEASE TIB BASE POINTER     @D3570   03397000
.SKIP400 ANOP                                                           03398680
MODVC520 L     R0,RQTVCTAD        GET VCT ENTRY ADDRESS        @D61ADAP 03399000
         L     RB,TCBSAVE         GET SAVE AREA ADDRESS        @D61ADAP 03400000
         USING SVEARA,RB          SAVE AREA BASE POINTER       @D61ADAP 03401000
         STM   RF,R0,SVER0F       SET RETURN INFORMATION       @D61ADAP 03402000
MODVCEXT LA    R5,ARTID           AR TID                       @DY46496 03403090
         CH    R5,RQTTID          IS IT AR?                    @DY46496 03403180
         BNE   MODVCEX            NO                           @DY46496 03403270
         TM    RQTFLG,RQTSET15    AR CANCELLED?                @DY46496 03403360
         BZR   R6                 YES, LET SVT FREE THE RQTE   @DY46496 03403450
MODVCEX  TM    RQTFLG,RQTISBAL    IS THIS BAL INTERFACE        @DA45062 03403540
         MVC   RQTNEXT,RQTFLPTR   ADD ENTRY TO FREELIST        @D61ADAP 03404000
         ST    RE,RQTFLPTR        STORE NEW FREE LIST POINTER  @D61ADAG 03405000
         BZR   R6                 NO,  ====================>>> @D61ADAG 03406000
         L     RD,ASV101BA        SV101BAL BASE ADDRESS        @D61ADAP 03407000
         USING SV101BAL,RD        SV101BAL BASE POINTER        @D61ADAP 03408000
         B     SV101BXT           RETURN TO CALLER             @D61ADAP 03409000
         DROP  R3                 RELEASE PUB BASE             @D61ADAP 03410000
         DROP  R4                 RELEASE VCT-ENTRY BASE       @D61ADAP 03411000
         DROP  RB                 RELEASE SAVE AREA BASE       @D61ADAP 03412000
         DROP  RD                 RELEASE SV101BAL BASE        @D61ADAP 03413000
         SPACE 5                                                        03414000
MODVCELG EQU   X'00'              LOGICAL DEVICE SPECIFIED     @D35VDAP 03415000
MODVCEPH EQU   X'01'              PHYSICAL DEVICE SPECIFIED    @D35VDAP 03416000
MODVCEDT EQU   X'02'              PUB DEVICE TYPE SPECIFIED    @D356DAP 03417000
MODVCERS EQU   X'10'              RESERVE REQUEST FOR DEVICE   @D356DAP 03418000
MODVCERL EQU   X'20'              RELEASE RESERVED DEVICE      @D356DAP 03419000
MODVCESH EQU   X'40'              DEVICE IS SHARABLE           @D36SDAP 03420000
MODVCEIN EQU   X'80'              INSTALLATION REQUEST FOR DEV.@D61DDGL 03421000
         TITLE 'VSE SUPERVISOR     SGSER     SPECIAL ROUTINES         ' 03422000
         USING SVC101,RD          SVC101 BASE POINTER          @D61ADAP 03423000
MODVCLNO SLR   R3,R3              CLEAR REGISTER               @DY45385 03424000
         ICM   R3,B'0011',0(R2)   GET LNO INFO                 @DY45385 03425000
         BAL   R7,CALCPUB         CONVERT LNO TO PUB ADDRESS   @D61ADAP 03426000
*SGLINK  CALCPUB,INPUT=(R3,R6,R7,RC),OUTPUT=(R3,R4),WORK=R8    @D61ADAP 03427000
         B     MODERR04           ERR  =====================>> @D35VDEP 03428000
         LTR   R3,R3              WAS PUB ASSIGNED TO LUB      @D35VDEP 03429000
         BP    MODVC240           YES, FIND VCT ENTRY          @D35VDEP 03430000
.*       IGN-OR UA-ASSIGNMENT IS TREATED AS INVALID            @D35VDEP 03431000
         B     MODERR04           ERR  =====================>> @D356DAP 03432000
         SPACE 3                                               @D61ADAP 03433000
MODTYP10 SLR   R3,R3              INDICATE SCAN WHOLE PUBTAB   @D356DAP 03434000
         LR    R5,R3              INDICATE NO AVR ENTRY FOUND  @D14BDAP 03435000
         MVI   RQTPUB,XFF         ASSUME NO PUB FOUND          @D61ADAP 03436000
MODTYP20 BAL   R7,SUBTYP00        FIND PUB OF SPECIFIED TYPE   @D356DAP 03437000
*SGLINK  SUBTYP00,INPUT=(R2,R3,R7,RD),OUTPUT=R3                @D369DAP 03438000
         LTR   R3,R3              DID WE FIND A PUB            @D356DAP 03439000
         BZ    MODTYP50           NO, SET PROPER RETURN CODE   @D356DAP 03440000
         USING PUBADR,R3          PUB BASE                     @D61ADAP 03441000
         STH   R3,RQTPUB          INDICATE PUB WAS FOUND       @D61ADAP 03442000
         TM    PUBJCFLG,X'F8'     IS PUB DOWN                  @D356DAP 03443000
         BZ    MODTYP20           YES, DONT USE THIS PUB       @D356DAP 03444000
         BAL   R7,AVRFVCTE        FIND THE ASSOCIATED AVR ENTRY@D356DAP 03445000
*SGLINK  AVRFVCTE,INPUT=(R3,R7,RC),OUTPUT=R4,WORK=R8           @D369DAP 03446000
         LTR   R4,R4              DID WE FIND AN AVR ENTRY     @D356DAP 03447000
         BZ    MODTYP20           NO,                          @D61ADAP 03448000
         USING VCTEADR,R4         AVR ENTRY BASE               @D356DAP 03449000
         TM    VCTAFLAG,VCTARSV+AVRSHR DEVICE RESERVED/SHARED  @D36SDAP 03450000
         BNZ   MODTYP20           YES, TRY TO FIND ANOTHER PUB @D356DAP 03451000
         TM    VCTAFLG,VCTAFOP    IS DEVICE OPERATIONAL        @D356DAP 03452000
         BO    MODTYP30           YES, CHECK FOR USAGE         @D61ADAP 03453000
         TM    SUPFLAG,VMSYS      RUNNING UNDER VM             @D61NDAP 03454000
         BZ    MODTYP20           NO, FIND ANOTHER DEVICE      @D61NDAP 03455000
MODTYP30 LR    R0,R3              COPY PUB POINTER             @D14BDAP 03456000
         SH    R0,YPUBTAB         OFFSET OF PUB WITHIN PUBTAB  @D14BDAP 03457000
         SRL   R0,PUBSLEN         PUB ENTRY NO.                @D51ODGL 03458000
         GETFLD FIELD=OWNER,PU=(0) FIND PUB OWNER              @D14BDAP 03459000
         LTR   RF,RF              IS PUB IN USE                @D14BDAP 03460000
         BZ    MODTYPEX           NO, THATS WHAT I WANT        @D61ADAP 03461000
         LR    R5,R4              SAVE CURRENT VCTE ADDRESS    @D14BDAP 03462000
         B     MODTYP20           TRY TO FIND UNUSED PUB       @D356DAP 03463000
         SPACE 3                                               @D356DAP 03464000
MODTYP50 LTR   R4,R5              DID WE FIND ANY PROPER PUB   @D356DAP 03465000
         BZ    MODTYP60           NO, SET RETURN CODE          @D356DAP 03466000
MODTYPEX OI    VCTAFLAG,VCTARSV   INDICATE DEVICE IS RESERVED  @D356DAP 03467000
         CLI   VCTATYPE,VCTATAPE  IS THIS A TAPE DEVICE        @D61ADAP 03468000
         BE    MODVC400           YES,                         @DA43697 03469000
         SLR   R0,R0              INDICATE NO ERROR            @D356DAP 03470000
         L     R8,TCBSAVE         GET USERS SAVE AREA ADDRESS  @D356DAP 03471000
         USING SVEARA,R8          SAVE AREA BASE               @D356DAP 03472000
         ST    R0,SVER0F          STORE RETURN CODE            @D356DAP 03473000
         ST    R3,SVER00          STORE PUB ADDRESS            @D356DAP 03474000
         B     MODVC400           ACTIVATE SERVICE TASK        @D36SDAP 03475000
*                                 BUT RETURN TO USER           @D356DAP 03476000
         DROP  R8                 RELEASE SAVE AREA BASE       @D356DAP 03477000
MODTYP60 TM    RQTPUB,XFF         DID WE FIND A PUB AT ALL     @D356DAP 03478000
         BO    MODERR08           NO,  ======================> @D356DAP 03479000
         B     MODERR1C                ======================> @D356DAP 03480000
         DROP  R3                 RELEASE PUB BASE             @D356DAP 03481000
         DROP  R4                 RELEASE VCT ENTRY BASE       @D356DAP 03482000
         SPACE 3                                               @D356DAP 03483000
.**************************************************************@D356DAP 03484000
.*                                                             @D356DAP 03485000
.* FUNCTION-    SEARCH PUBTABLE FOR A GIVEN PUB DEVICE         @D356DAP 03486000
.*              TYPE CODE                                      @D356DAP 03487000
.* ENTRY POINT- SUBTYP00 - FROM MODVCE                         @D356DAP 03488000
.* INPUTS-      R2= ADDR OF BYTE CONTAINING PUBDEVTY           @D356DAP 03489000
.*              R3= ZERO IF WHOLE PUB TABLE IS TO BE SCANNED   @D356DAP 03490000
.*                  ADDR OF WHERE TO CONINUE PUB SCAN          @D356DAP 03491000
.*              R7= RETURN ADDRESS                             @D356DAP 03492000
.*              PUB TABLE                                      @D356DAP 03493000
.* OUTPUTS-     R3= ADDR OF PUB FOUND, OR ZERO IF NO PUB FOUND @D356DAP 03494000
.* EXITS-       TO R7                                          @D356DAP 03495000
.* REGISTERS-   NONE                                           @D356DAP 03496000
.* SUBROUTINES- NONE                                           @D356DAP 03497000
.*                                                             @D356DAP 03498000
.**************************************************************@D356DAP 03499000
SUBTYP00 EQU   *                                               @D356DAP 03500000
*SGLINK  SUBTYP00,INPUT=(R2,R3,R7,RD),OUTPUT=R3                @D369DAP 03501000
         LTR   R3,R3              IS SCAN START ADDRESS GIVEN  @D356DAP 03502000
         BNZ   SUBTYP20           YES, CONTINUE AT NEXT PUB    @D356DAP 03503000
         LH    R3,YPUBTAB         GET ADDRESS OF 1ST PUB       @D356DAP 03504000
         USING PUBADR,R3                                       @D356DAP 03505000
SUBTYP10 CLC   PUBDEVTY,0(R2)     MATCHING PUB DEVICE TYPE     @D356DAP 03506000
         BER   R7                 YES, ======================> @D356DAP 03507000
SUBTYP20 LA    R3,NEXTPUB         NO, BUMP TO NEXT PUB         @D356DAP 03508000
         CLI   PUBCHANN,XFF       END OF PUB TABLE             @D356DAP 03509000
         BNE   SUBTYP10           NO, CHECK NEXT PUB           @D356DAP 03510000
         SLR   R3,R3              INDICATE NO PUB FOUND        @D356DAP 03511000
         BR    R7                      ======================> @D356DAP 03512000
         DROP  R3                 DROP PUB BASE                @D356DAP 03513000
         SPACE 3                                               @D356DAP 03514000
.*                                                                      03515000
.*       ERROR EXITS SET UP BY MODVCE                                   03516000
.*                                                                      03517000
MODERR00 SLR   R0,R0              INDICATE NO REAL ERROR       @DA43697 03518000
         B     MODREFRE           FILL RETURN CODE AND RETURN  @DA43697 03519000
MODERR04 LA    R0,MODVCELN        SET RETURN CODE              @D35VDEP 03520000
         B     MODREFRE           FILL RETURN CODE AND RETURN  @D35VDEP 03521000
MODERRD8 L     R6,DISPAD          RESTORE DISPATCHER BASE      @D61DDGL 03522000
MODERR08 LA    R0,MODVCECU        DEVICE NOT SUPPORTED         @D35VDEP 03523000
         SLR   R4,R4              CLEAR VCTE POINTER           @D21LDRP 03524000
         B     MODREFRE           FILL RETURN CODE AND RETURN  @D356DAP 03525000
MODERR1C LA    R0,MODVCRSV        CONFLICT WITH RESERVE OPTION @D356DAP 03526000
MODREFRE ST    R4,RQTVCTAD        OUTPUT ADDR OF VCTE          @D35VDEP 03527000
         ST    R0,RQTRETCD        SET RETURN CODE              @D149DAP 03528000
         B     MODVC500                                        @D149DAP 03529000
         SPACE 1                                               @D66ADAP 03530000
         DROP  R6                 RELEASE DISP BASE            @D66ADAP 03531000
.*                                                             @D61DDGL 03532000
.*  THE DEVICE INSTALLATION PROCESS MUST BE INVOKED VIA        @D61DDGL 03533000
.*  MODVCE CHNUNIT=..,INSTALL=YES                              @D61DDGL 03534000
.*  GENERAL REGISTER R1 IS POINTING TO A PARAMETER LIST        @D61DDAP 03535000
.*  CONSISTING OF:                                             @D61DDAP 03536000
.*  <TWO BYTE CUU> <6 BYTE EXTERNAL DEVICE TYPE CODE>          @D61DDGL 03537000
.*                                                             @D61DDGL 03538000
.*  FUNCTIONAL FLOW:                                           @D61DDGL 03539000
.*  IDENTIFY THE NEW DEVICE                                    @D61DDGL 03540000
.*  CHECK IF CONTROL BLOCKS FIT INTO THE ALLOCATED AREAS(S)    @D61DDGL 03541000
.*  UPDATE THE PUB, PUB2, PUBX AND VCTEADR TABLE ENTRIES       @D61DDGL 03542000
.*                                                             @D61DDGL 03543000
         USING SVC101,RD          SVC101 BASE POINTER          @D61ADAP 03544000
         USING PUBADR,R3          PUB BASE POINTER             @D61DDGL 03545000
MODVIN00 DS    0H                                              @D61DDGL 03546000
         TM    IJBFLG08,IJBSAENV  IS THIS STAND ALONE ENVIR.   @D61DDGL 03547000
         BNO   MODERRD8           NO,  ======================> @D61DDGL 03548000
         CLI   PUBCHQPT,XFF       REQUEST QUEUED TO PUB        @D61DDGL 03549000
         BNE   MODERRD8           YES, ======================> @D61DDGL 03550000
         TM    PUBCSFLG,QEDERR    DEVICE QUEUED IN ERROR       @D61DDGL 03551000
         BNZ   MODERRD8           YES, ======================> @D61DDGL 03552000
*                                                              @D61DDGL 03553000
*        FIND ASSOCIATED DEVICE INFORMATION                    @D61DDGL 03554000
*                                                              @D61DDGL 03555000
         L     R9,ADVCLSTL        PICK ADDR OF DEVICE TABLE    @D61DDAP 03556000
         USING DVCLSTE,R9         DEVICE LIST BASE             @D61DDAP 03557000
         MVC   DEVNAME,2(R2)      ENSURE A MATCH AT END OF LIST@D61DDAP 03558000
         L     R9,ADVCLST         PICK ADDR OF DEVICE TABLE    @D25IDAP 03559000
MODVIN02 CLC   2(6,R2),DEVNAME    COMPARE USER DATA TO TABLE   @D61DDGL 03560000
         BE    MODVIN10           MATCH FOUND                  @D61DDGL 03561000
         LA    R9,DVCLSTN         ADVANCE TO NEXT ENTRY        @D61DDGL 03562000
         B     MODVIN02           CHECK NEXT TABLE ENTRY       @D61DDAP 03563000
         SPACE 1                                                        03564000
.*                                                             @D61DDGL 03565000
.*   WE FOUND NAME OF DEVICE IN DVCLST AND POINT TO ITS ENTRY  @D61DDGL 03566000
.*                                                             @D61DDGL 03567000
MODVIN10 ICM   R5,15,DEVCODE      GET PUBDEVTY AND MODE        @D61DDGL 03568000
         SLR   R4,R4              CLEAR REGISTER               @D61DDGL 03569000
         IC    R4,INDEX           SPECIAL ACTION REQUIRED      @D61DDGL 03570000
         BNZ   MODERRD8           YES, ERROR                   @D25IDAP 03571000
*                                                              @D61DDGL 03572000
*        SURE THAT DEVICE CLASS CODE IS MATCHING               @D61DDGL 03573000
*                                                              @D61DDGL 03574000
MODVNORM CLI   PUBDEVTY,XFF       UNSUPPORTED DEVICE           @D61DDGL 03575000
         BE    MODVIN12           YES,                         @D61DDGL 03576000
.*                                                                      03577000
.*       ASSUME DEVICE WAS CONTAINED IN AUTOMATED INSTALL LIST          03578000
.*       SO ACCEPT WHAT THE USER DID SPECIFY                            03579000
.*                                                                      03580000
         SLR   R7,R7              CLEAR REGISTER               @D61DDAP 03581000
         IC    R7,PUBDEVTY        GET DEVICE TYPE CODE FROM PUB@D61DDAP 03582000
         N     R7,F240            LEAVE DEVICE TYPE ZONE ONLY  @D61DDAP 03583000
         SLR   R8,R8              CLEAR REGISTER               @D61DDAP 03584000
         IC    R8,DEVCODE         GET DEVICE TYPE CODE FROM TAB@D61DDAP 03585000
         N     R8,F240            LEAVE DEVICE TYPE ZONE ONLY  @D61DDAP 03586000
         CR    R7,R8              MATCHING DEV-ZONE            @D61DDAP 03587000
         BNE   MODERRD8           NO,  ======================> @D61DDAP 03588000
.*                                                             @D61DDGL 03589000
.*    CHECK ALLOCATED VERSUS REQUIRED PUB2 ENTRY LENGTH        @D61DDGL 03590000
.*                                                             @D61DDGL 03591000
MODVIN12 LR    R8,R3              COPY PUB POINTER             @D61DDGL 03592000
         SH    R8,YPUBTAB         PUB OFFSET                   @D61DDGL 03593000
         SRL   R8,1               PUB ADDRESS OFFSET           @D61DDGL 03594000
         LR    R0,R8              COPY ADDRESS OFFSET          @D61DDAP 03595000
         A     R8,APB2AREA        ADDRESS OF PUB2 ADDRESS      @D61DDGL 03596000
         L     R2,4(,R8)          NEXT PUB2 ADDRESS            @D61DDAP 03597000
         L     R8,0(,R8)          OUR PUB2 ADDRESS             @D61DDGL 03598000
         USING PUB2ADR,R8         PUB2 BASE POINTER            @D61DDAP 03599000
         SLR   R2,R8              PUB2 LENGTH                  @D61DDAP 03600000
         CH    R2,DEVPUB2L        IS ALLOCATED PUB2 SUFFICIENT @D61DDAP 03601000
         BL    MODERRD8           NO,  ======================> @D61DDGL 03602000
.*                                                             @D61DDGL 03603000
.*    CHECK ALLOCATED VERSUS REQUIRED PUBX ENTRY LENGTH        @D61DDGL 03604000
.*                                                             @D61DDGL 03605000
         LR    R4,R0              COPY PUB ADDRESS OFFSET      @D61DDAP 03606000
         A     R4,APBXAREA        ADDRESS OF PUBX ADDRESS      @D61DDAP 03607000
         L     R4,0(,R4)          PUBX ADDRESS                 @D61DDGL 03608000
         USING PBXADR,R4          PUBX BASE POINTER            @D61DDAP 03609000
         XR    R7,R7              CLEAR REGISTER               @D61DDGL 03610000
         ICM   R7,3,PBXLEN        GET PUBX LENGTH              @D61DDGL 03611000
         LA    R6,PBXTLNG         ASSUME PUBX FOR TAPE         @D61DDGL 03612000
         TM    DEVCODE,X'F0'-TTAPE TAPE TO BE INSTALLED        @D61DDAP 03613000
         BNZ   MODVIC00           NO,                          @D61DDAP 03614000
         TM    DEVCODE,TTAPE      SURE ITS A TAPE              @D61DDGL 03615000
         BO    MODVICLN           YES,                         @D61DDGL 03616000
MODVIC00 LA    R6,PBXDLNG         ASSUME DASD DEVICE           @D61DDGL 03617000
         TM    DEVCODE,X'F0'-TCKD DASD TO BE INSTALLED         @D61DDGL 03618000
         BNZ   MODVIC01           NO,                          @D61DDGL 03619000
         TM    DEVCODE,TCKD       SURE ITS A DASD              @D61DDGL 03620000
         BO    MODVICLN           YES,                         @D61DDGL 03621000
MODVIC01 CLI   DEVCODE,TFBA       IS THIS FBA DEVICE           @D61DDAP 03622000
         BE    MODVICLN           YES,                         @D61DDGL 03623000
         CLI   DEVCODE,T3540      IS THIS A DISKETTE           @D61DDAP 03624000
         BE    MODVICLN           YES,                         @D61DDGL 03625000
         LA    R6,PBXCLNG         LENGTH OF COMMON PUBX        @D61DDGL 03626000
MODVICLN CR    R7,R6              WOULD DATA FIT IN PUBX       @D61DDGL 03627000
         BL    MODERRD8           NO,  ======================> @D61DDGL 03628000
.*                                                             @D61DDGL 03629000
.*    CHECK ALLOCATED VERSUS REQUIRED ERROR ENTRY LENGTH       @D61DDGL 03630000
.*                                                             @D61DDGL 03631000
         L     R1,PBXERBLK        ADDRESS OF ERROR ENTRY       @D61DDGL 03632000
         USING ERBLKADR,R1        ERROR ENTRY BASE             @D61DDGL 03633000
         CLC   ERBLKSNL(1),LSNSINF WOULD SENSE DATA FIT IN AREA@D61DDGL 03634000
         BL    MODERRD8           NO,  ======================> @D61DDGL 03635000
         DROP  R1                 RELEASE ERRROR ENTRY BASE    @D61DDGL 03636000
.*                                                             @D61DDGL 03637000
.*    CHECK FOR LIBRARY MANAGEMENT INFORMATION EXTENTION       @D61DDGL 03638000
.*                                                             @D61DDGL 03639000
         CLI   PBXMDR,X'42'       IS THIS A 3490E              @D62TAAP 03640000
         BNE   MODVIC04           NO,                          @D61DDGL 03641000
         OC    PBXLBINF,PBXLBINF  LIBRARY EXTENTION EXISTS     @D61DDGL 03642000
         BZ    MODERRD8           NO,  ======================> @D61DDGL 03643000
.*                                                             @D61DDGL 03644000
.*    ALL CONTROL BLOCKS ARE SUFFICIENT IN LENGTH              @D61DDGL 03645000
.*    R3 IS A POINTER TO THE PUB ENTRY                         @D61DDGL 03646000
.*    R5 CONTAINS THE SECOND WORD OF THE PUB                   @D61DDGL 03647000
.*    R6 CONTAINS THE OFFSET OF THE ERBLKADR START IN PUBX     @D61DDGL 03648000
.*    R9 IS PTR TO NEW DEVICES DEVICE LIST ENTRY               @D61DDGL 03649000
.*    N O T E:                                                          03650000
.*    PREVENT ANY EXIT TO SET ERROR RETURN CODE UNTIL          @D61DDAP 03651000
.*    ALL CONTROL BLOCKS HAVE BEEN INITIALIZED PROPERLY        @D61DDAP 03652000
.*                                                             @D61DDGL 03653000
MODVIC04 ST    R5,4(,R3)               SET PUBDEVTY AND MODE   @D61DDGL 03654000
*                                                              @D61DDGL 03655000
*        UPDATE PUB2 ENTRY FOR NEW DEVICE                      @D61DDGL 03656000
*                                                              @D61DDGL 03657000
         LR    R5,R8                   COPY PUB2 POINTER       @D61DDAP 03658000
MODVIN22 MVI   0(R5),0                 CLEAR THIS BYTE         @D61DDGL 03659000
         LA    R5,1(,R5)               ADVANCE TO NEXT BYTE    @D61DDGL 03660000
         BCT   R2,MODVIN22             CLEAR ALL BYTES         @D61DDGL 03661000
         CLI   PUBDEVTY,TTAPE          IS THIS A TAPE DEVICE   @D61DDGL 03662000
         BL    MODVIN26                NO,                     @D61DDAP 03663000
         CLI   PUBDEVTY,TTAPE+X'0F'    SURE ITS A TAPE         @D61DDGL 03664000
         BH    MODVIN26                NO, LEAVE P2-FLAG BYTE  @D61DDAP 03665000
         MVC   P2TNAME(L'P2TNAME),DEVERRPH TAPE ERP PHASE ID   @D61DDGL 03666000
         MVI   P2FLAGS,P2STAT2         SET INITIAL FLAG VALUE  @D61DDGL 03667000
         DROP  R8                      RELEASE PUB2 BASE       @D61DDAP 03668000
*                                                              @D61DDGL 03669000
*        UPDATE PUBX ENTRY FOR NEW DEVICE                      @D61DDGL 03670000
*                                                              @D61DDGL 03671000
MODVIN26 ICM   R7,3,PBXSCH             SAVE SUBCHANNEL NUMBER  @D61DDAP 03672000
         ICM   R7,12,PBXLEN            SAVE PUBX LENGTH        @D61DDGL 03673000
         L     RB,PBXERBLK             ADDRESS OF ERROR ENTRY  @D61DDGL 03674000
         L     R8,PBXCCW               SAVE CCW ADDRESS        @D61DDGL 03675000
         L     RF,PBXLBINF             SAVE LIBRARY INFO       @D61DDGL 03676000
         XR    R5,R5                   CLEAR REGISTER          @D61DDAP 03677000
         ICM   R5,3,PBXLEN             LENGTH OF PUBX ENTRY    @D61DDAP 03678000
         LA    R5,0(R5,R4)             POINT BEHIND PUBX       @D61DDAP 03679000
MODVIN32 BCTR  R5,0                    LAST BYTE OF PUBX ENTRY @D61DDAP 03680000
         MVI   0(R5),0                 CLEAR LAST/PREVIOUS BYTE@D61DDAP 03681000
         CR    R5,R4                   ALL BYTES CLEARED       @D61DDGL 03682000
         BH    MODVIN32                NO, NOT YET             @D61DDGL 03683000
         STH   R7,PBXSCH               RESTORE SUBCHANNEL NO.  @D61DDGL 03684000
         STCM  R7,12,PBXLEN            RESTORE PUBX LENGTH     @D61DDGL 03685000
         ST    RF,PBXLBINF             RESTORE LIBRARY INFO    @D61DDGL 03686000
         ST    R8,PBXCCW               RESTORE CCW POINTER     @D61DDGL 03687000
         ST    RB,PBXERBLK             RESTORE ERROR ENTRY     @D61DDGL 03688000
         MVC   PBXFLAG,PUBXFLG         SET PUBX FLAG BYTE      @D61DDGL 03689000
         OI    PBXFLAG3,PBXF3INS       ESA NEEDS INSTALL PROC. @D61DDGL 03690000
         MVI   PBXPVPEN,X'FF'          VERIFY ALL PATHES       @D61DDGL 03691000
         MVC   PBXOBR(2),DEVOBRID      SAVE OBR RECORD ID      @D61DDGL 03692000
         MVC   PBXMDR(1),DEVMDRID      SAVE MDR RECORD ID      @D61DDGL 03693000
         MVI   PBXRCDCC,X'FF'          INVALIDATE RCD COMMAND  @D61DDGL 03694000
         TM    PBXFLAG,PBXTAPE         IS NEW DEVICE A TAPE    @D61DDAP 03695000
         BZ    BLDPBX60                NO, BRANCH              @D61DDGL 03696000
         OI    PBXFLAG2,PBXNOSIO+PBXNOVOL INDICATE NEVER USED  @D61DDGL 03697000
         MVI   PBXACMD,NM3480          ASSUME 3480 3490 TPA DEV@D62TAAP 03698000
         MVI   PBXSCMD,NM3480          SET 3480 MODE BITS      @D61DDGL 03699000
         CLI   PUBDEVTY,TTPA           TPA DEVICE              @D62TAAP 03700000
         BE    BLDPBX45                YES,                    @D62TAAP 03701000
         CLI   PUBDEVTY,T3480          3480 TAPE               @D62TAAP 03702000
         BE    BLDPBX30                YES,                    @D62TAAP 03703000
         OI    PBXFLAG2,PBXNOASS       PREVENT ASSGN PROCESS   @DA44471 03704000
         CLI   PUBDEVTY,T9346          9346 TAPE               @D61DDGL 03705000
         BNE   BLDPBX25                NO, BRANCH              @D61DDGL 03706000
         MVI   PBXACMD,NM9346          SET 9346 'SET MODE'     @D61DDGL 03707000
         MVI   PBXSCMD,NM9346          COMMAND CODE IN PUBX    @D61DDGL 03708000
         OI    PBXFLAG1,PBXNORDB       INDICATE NO READ BACKW. @D61DDGL 03709000
         B     BLDPBX20                                                 03710000
BLDPBX05 OI    PBXFLAG1,PBXNORDB       INDICATE NO READ BACKW. @D61DDGL 03711000
BLDPBX10 OI    PBXTREC,PBXTCTG         INDICATE CARTRIDGE DEV  @D62TAAP 03712000
BLDPBX15 OI    PBXFLAG3,PBXTERP1       INDICATE TRANSIENT ERP  @D62TAAP 03713000
BLDPBX20 OI    PBXFLAG1,PBXBUFFD       INDICATE BUFFERED DEV.  @D61DDGL 03714000
         OI    PBXFLAG1,PBXDBCCW       SET MODE REQUIRES DATA  @D61DDGL 03715000
         MVC   PBXABYT,PUBOPTN         APPEND DATA BYTE FOR    @D61DDGL 03716000
         MVC   PBXSBYT,PUBOPTN         SET MODE COMMAND        @D61DDGL 03717000
         MVI   PUBOPTN,NMODE           RESET MODE IN PUB       @D61DDGL 03718000
         B     BLDPBX60                                        @D61DDGL 03719000
BLDPBX25 MVC   PBXACMD,PUBOPTN         SET ACTUAL AND PERMANENT@D62TAAP 03720000
         MVC   PBXSCMD,PUBOPTN         SAVE MODE IN PUBX       @D62TAAP 03721000
         CLI   PUBDEVTY,T9347          IS THIS A 9347          @D62TAAP 03722000
         BNE   BLDPBX60                NO,                     @D62TAAP 03723000
         OI    PBXFLAG1,PBXNORDB       INDICATE NO READ BACKW. @D62TAAP 03724000
         B     BLDPBX60                                        @D62TAAP 03725000
BLDPBX30 CLI   PBXMDR,X'41'            IS THIS A 3490          @D62TAAP 03726000
         BL    BLDPBX10                NO, ITS A 3480          @D62TAAP 03727000
         BE    BLDPBX35                YES, IT IS A 3490       @D62TAAP 03728000
         CLI   PBXMDR,X'42'            IS THIS A 3490E         @D62TAAP 03729000
         BH    BLDPBX40                NO, ITS A 3424 OR 9348  @D62TAAP 03730000
         OI    PBXTREC,PBXT2XF         INDICATE 2-XF FORMAT    @D62TAAP 03731000
BLDPBX35 OI    PBXFLAG1,PBXFEAT1+PBXFEAT2 AUTOBLK+IDRC         @D62TAAP 03732000
         B     BLDPBX10                JOIN 3480 MAIN PATH     @D62TAAP 03733000
BLDPBX40 OI    PBXFLAG2,PBXNOASS       PREVENT ASSGN PROCESS   @DA44471 03734000
         CLI   PBXMDR,X'45'            IS THIS A 9348          @D62TAAP 03735000
         BNE   BLDPBX15                NO, ITS A 3424          @D62TAAP 03736000
         OI    PBXFLAG1,PBXNORDB       INDICATE NO READ BACKW. @D61DDGL 03737000
         B     BLDPBX15                YES                     @D62TAAP 03738000
BLDPBX45 OI    PBXFLAG1,PBXFEAT1+PBXFEAT2 COMPACT+BLOCKING     @D62TAAP 03739000
         OI    PUBOPTN,X'10'           INHIBIT SUPVR COMMANDS  @D62TAAP 03740000
         B     BLDPBX05                                        @D62TAAP 03741000
         SPACE 3                                                        03742000
BLDPBX60 MVC   PBXCUU,PUBADR           MOVE CUU TO PUBX        @D61DDGL 03743000
         MVC   PBXPUBCD,PUBDEVTY       MOVE DEVICE TYPE CODE   @D61DDGL 03744000
         ICM   R1,3,PBXSCH             GET SUBCHANNEL NUMBER   @D61DDGL 03745000
         ICM   R1,12,H1                SUBCHANNEL-ID WORD      @D61DDAP 03746000
         L     R5,SCHIB$               POINT TO SCHIB AREA     @D61DDGL 03747000
         USING SCHIB,R5                SCHIB BASE POINTER      @D61DDGL 03748000
         STSCH 0(R5)                   STORE SUBCHANNEL        @D61DDGL 03749000
         BC    1,BLDPBX75              NOT OPERATIONAL         @D61DDGL 03750000
         MVC   PBXLPM(1),SCHLPUM       LIMIT TO LAST PATH USED @D61DDGL 03751000
         MVC   PBXCHPID(L'PBXCHPID),SCHCPID0 SET CHPIDS        @D61DDGL 03752000
BLDPBX75 DS    0H                      RESTORE REGISTER 1      @D61DDGL 03753000
         DROP  R5                      DROP SCHIB BASE         @D61DDGL 03754000
*                                                              @D61DDGL 03755000
*        BUILD PREFIX CCW'S IF APPLICABLE                      @D61DDGL 03756000
*                                                              @D61DDGL 03757000
         L     R5,PBXCCW               TAKE PTR TO CCW CHAIN   @D61DDGL 03758000
         TM    PBXFLAG,PBXTAPE         IS THIS A TAPE          @D61DDAP 03759000
         BO    BLDCCWT1                YES,                    @D61DDAP 03760000
         TM    PBXFLAG,PBXDASD         IS THIS A DASD DEVICE   @D61DDGL 03761000
         BZ    BLDAVR                  NO,                     @D61DDGL 03762000
         B     BLDCCWC1                GO TO HANDLE CKD        @D61DDGL 03763000
BLDCCWT1 LA    R7,PBXABYT              ADDRESS OF DATA BYTE    @D61DDGL 03764000
         STCM  R7,M7,CCWI+1            SET I/O AREA ADDRESS    @D61DDGL 03765000
         MVC   0(L'CCWI,R5),CCWI       FORMAT CCW CHAIN        @D61DDGL 03766000
         MVC   8(L'CCWI,R5),CCWI                               @D61DDGL 03767000
         MVC   16(L'CCWI,R5),CCWI                              @D61DDGL 03768000
         MVC   24(L'CCWI,R5),CCWI                              @D61DDGL 03769000
         MVI   28(R5),X00              SET CC AND SLI BIT OFF  @D61DDGL 03770000
         B     BLDAVR                                          @D61DDGL 03771000
CCWI     CCW   NOP,0,CC+SLI,L1                                 @D61DDGL 03772000
         USING DFPCCW,R5               BASE FOR CCW CHAIN      @D61DDGL 03773000
BLDCCWC1 DS    0H                      SET CHAIN FOR CKD       @D61DDGL 03774000
         MVC   DFPCCW(L'BLDCCCH1),BLDCCCH1  FORMAT CCW CHAIN   @D61DDGL 03775000
         LA    R7,FILEMASK             GET FILE MASK ADDR      @D61DDGL 03776000
         STCM  R7,M7,MASKADR           STORE MASK ADDR IN CCW  @D61DDGL 03777000
         B     BLDAVR                                          @D61DDGL 03778000
BLDCCCH1 DS    0CL32                                           @D61DDGL 03779000
         CCW   SEEK,*,CC,6             SEEK CCW                @D61DDAP 03780000
         CCW   SFM,*+5,CC,1            SET FILE MASK CCW       @D61DDAP 03781000
         CCW   TIC,*,0,0               TIC CCW                 @D61DDGL 03782000
         DC    D'0'                    SAVE AREA               @D61DDGL 03783000
         DROP  R5                      DROP BASE FOR CCW CHAIN @D61DDGL 03784000
         DROP  R4                      RELEASE PUBX BASE       @D61DDAP 03785000
DFPCCW   DSECT                                                 @D61DDGL 03786000
DFPCCW1  DS    D                       SEEK CCW                @D61DDGL 03787000
DFPCCW2  DS    D                       SFM CCW                 @D61DDGL 03788000
         ORG   DFPCCW2                                         @D61DDGL 03789000
         DS    AL1                     COMMAND CODE            @D61DDGL 03790000
MASKADR  DS    AL3                     FILE MASK ADDRESS       @D61DDGL 03791000
         DS    AL1                     FLAG                    @D61DDGL 03792000
FILEMASK DS    AL1                     FILE MASK               @D61DDGL 03793000
         DS    AL2                     BYTE COUNT              @D61DDGL 03794000
DFPCCW3  DS    D                       TIC CCW                 @D61DDGL 03795000
DFPSAVE  DS    D                       SAVE AREA               @D61DDGL 03796000
DFPCCWE  EQU   *                       DELIMITER ADDRESS       @D61DDGL 03797000
         SPACE 1                                                        03798000
*        MAPPLF DSECT=YES                                      @DAOM    03799000
         AGO   .NPLF010                                                 03800000
         AIF   (NOT &VSEPLF).NPLF010                                    03801000
         MAPPLF DSECT=YES                                      @DAOM    03802000
         AGO   .YPLF010                                                 03803000
.NPLF010 ANOP                                                           03804000
MAPPLF   DSECT                                                          03805000
PLFCBID  DS    XL3                    EYECATCHER                        03806000
PLFVERS  DS    X                      VERSION ID                        03807000
PLFLEN   DS    XL2                    LENGTH OF CONTROL BLOCK           03808000
PLFCUU   DS    XL2                    CUU ADDRESS                       03809000
PLFVOL1  DS    XL6                    VOL1 LABEL                        03810000
         DS    XL2                    RESERVED                          03811000
PLFECBA  DS    XL4                    POINTER TO ECB                    03812000
PLFREQ   DS    XL2                    REQUEST TYPE                      03813000
PLFRWF   DS    XL1                    READ/WRITE                        03814000
PLFCNT   DS    CL5                    COUNT OF VOLUMES                  03815000
PLFRET   DS    XL4                    RETURN CODE                       03816000
PLFREAS  DS    XL4                    REASON CODE                       03817000
PLFLIBN  DS    CL8                    LIBRARY NAME                      03818000
PLFMEMB  DS    CL8                    LIBR MEMBER                       03819000
PLFSTAT  DS    CL4                    STATUS                            03820000
PLFMED   DS    CL4                    MEDIA TYPE                        03821000
PLFSCT   DS    CL10                   SOURCE CATEGORY                   03822000
PLFTGT   DS    CL10                   TARGET CATEGORY                   03823000
         DS    XL10                   RESERVED                          03824000
PLFCBLEN EQU   *-PLFCBID              LENGTH OF DSECT                   03825000
.YPLF010 ANOP                                                           03826000
&SYSECT  CSECT                                                 @D61DDGL 03827000
.*                                                             @D61DDGL 03828000
.*   SETUP VCTE FOR THE NEW DEVICE                             @D61DDGL 03829000
.*                                                             @D61DDGL 03830000
BLDAVR   L     R6,DISPAD          RELOAD DISPATCHER ADDRESS.   @D61DDGL 03831000
         USING DISP,R6            DISP BASE POINTER                     03832000
         BAL   R7,AVRFVCTE        FIND RELATED VCT ENTRY       @D35VDEP 03833000
*SGLINK  AVRFVCTE,INPUT=(R3,R7,RC),OUTPUT=R4,WORK=R8           @D369DAP 03834000
         SLR   R0,R0              SET RETURN CODE              @D61DDGL 03835000
         LTR   R4,R4              IS VCTE ENTRY PRESENT        @D61DDGL 03836000
         BZ    MODVC240           NO,  ======================> @D61DDGL 03837000
         USING VCTEADR,R4         VCT-ENTRY BASE               @D61DDGL 03838000
         LH    R7,VCTELEN         LENGTH OF VCT-ENTRY          @D61DDGL 03839000
         LA    R5,0(R7,R4)        NEXT VCTE ENTRY ADDRESS      @D61DDGL 03840000
MODVIN42 BCTR  R5,0               POINT TO LAST/PREVIOUS BYTE  @D61DDGL 03841000
         MVI   0(R5),0            SET FIELD TO ZERO            @D61DDGL 03842000
         CR    R5,R4              DID WE CLEAR WHOLE ENTRY     @D61DDGL 03843000
         BH    MODVIN42           NO, NOT YET                  @D61DDGL 03844000
         STH   R7,VCTELEN         SET VCT-ENTRY LENGTH         @D61DDGL 03845000
         ST    R3,VCTAPUB         SET PUB ADDRESS              @D61DDGL 03846000
         B     MODVC240                ======================> @D61ADAP 03847000
         DROP  R9                 DROP DEVICE LIST ENTRY       @D61DDGL 03848000
         DROP  R3                 RELEASE PUB BASE             @D61ADAP 03849000
         DROP  R4                 RELEASE VCT-ENTRY BASE       @D61NDAP 03850000
         SPACE 2                                                        03851000
         DROP  R6                 RELEASE DISPATCHER BASE      @D36IDAP 03852000
         DROP  RA                 RELEASE TCB BASE             @D36IDAP 03853000
         DROP  RE                 RELEASE RQT ENTRY BASE       @D356DAP 03854000
         DROP  RC                 RELEASE SGSERI BASE POINTER  @D36IDAP 03855000
         DROP  RD                 RELEASE SGSER       BASE     @D36IDAP 03856000
         TITLE 'VSE SUPERVISOR     SGSER     FLASH-COPY PROCESSING    ' 03857000
.*                                                             @D25IDAP 03857200
.*       FLASH-COPY PROCESSING ROUTINE                         @D25IDAP 03857400
.*                                                             @D25IDAP 03857600
         USING SGSERI,RC          SGSERI BASE POINTER          @D25IDAP 03858000
         USING SERTASK,RD         SGSER BASE                   @D25IDAP 03859000
         USING SERFLCPY,RF        SERFLCPY BASE POINTER        @D25IDAP 03860000
         USING DISP,R6            DISPATCHER BASE POINTER      @D25IDAP 03861000
SERFLCPY NI    SERFLGPR,XFF-SERRQTIX RESET FLASH-COPY REQUEST  @D25IDAP 03862000
         L     R2,RQTBEGIN        ADDRESS OF REQUEST ENTRY     @D25IDAP 03866000
         USING RQTE,R2            RQT BASE POINTER             @D25IDAP 03867000
SERFL010 TM    RQTFLG,RQTDOIXF+RQTINUSE ACTIVE FLASH-COPY ENTRY@D25IDAP 03868000
         BO    SERFL030           YES,                         @D25IDAP 03869000
SERFL020 LA    R2,RQTEND(R2)      POINT TO NEXT ENTRY          @D25IDAP 03870000
         C     R2,RQTENDAD        WAS THIS THE LAST RQT ENTRY  @DBOC    03871000
         BL    SERFL010           NO, PROCESS NEXT ENTRY       @D25IDAP 03872000
         B     SERTASK1                ======================> @D25IDAP 03873000
SERFL030 NI    RQTFLG,XFF-RQTINUSE WITHDRAW FROM ACTIVE CHAIN  @DBOC    03874000
         LH    R4,RQTTID          GET TID OF SERVICE OWNER     @D25IDAP 03875000
         BAL   R7,AVRSOWNR        SET SERVICE OWNER            @D25IDAP 03876000
*SGLINK  AVRSOWNR,WORK=(R4,R5)                                 @D25IDAP 03877000
         LR    R4,RF              COPY BASE ADDRESS            @D25IDAP 03878000
         DROP  RF                 RELEASE SERFLCPY BASE        @D25IDAP 03879000
         USING SERFLCPY,R4        SERFLCPY BASE POINTER        @D25IDAP 03880000
SERFL040 CDLOAD $IJBESFC,SVA=YES,RETPNF=YES                    @D28ADAP 03881000
         LTR   RF,RF              HAS PHASE ALREADY BEEN LOADED@D25IDAP 03882000
         BZ    SERFL050           YES,                         @D25IDAP 03883000
         AIF   (&VSE280).Y280040                               @D28ADAP 03884490
         CDLOAD $IJBIXFP,SVA=YES,RETPNF=YES                    @D25IDAP 03885000
         LTR   RF,RF              HAS PHASE ALREADY BEEN LOADED@D25IDAP 03886000
         BZ    SERFL050           YES,                         @D25IDAP 03887000
.Y280040 ANOP                                                  @D28ADAP 03888490
         LA    RF,20              INDICATE PHASE NOT FOUND     @D25IDAP 03889000
         B     SERFL060                                        @D25IDAP 03890000
SERFL050 LR    RF,R1              GET ENTRY ADDRESS            @D25IDAP 03891000
         O     RF,BIT0OMSK        GET INTO 31-BIT MODE         @D25IDAP 03892000
         LR    R7,RD              SAVE COMMON BASE ADDRESS     @D25IDAP 03893000
         L     RD,ASERSV18        GET SAVE AREA ADDRESS        @D25IDAP 03894000
         L     R0,AARCOMTB        ADDRESS OF AR-SUP COMREG     @D25IDAP 03895000
         LA    R1,SVTTID          PROVIDE TASK ID              @D25IDAP 03896000
         BASSM RE,RF              DO IXFP PROCESSING           @D25IDAP 03897000
*SGLINK  $IJBESFC,INPUT=(R0,R1,R2,RD,RE,RF),OUTPUT=RF          @D28ADAP 03898000
         LR    RD,R7              RESTORE COMMON BASE ADDRESS  @D25IDAP 03899000
.*                                                             @D25IDAP 03900000
.*       WE NEED TO SET SVT INTO SOME KIND OF BOUND            @D25IDAP 03901000
.*                                                             @D25IDAP 03902000
         SVC   33                 RESTORE SAVE AREA CONTENTS   @D25IDAP 03903000
         CH    RF,H24             WAS PROCESSING TASK ACTIVE   @D25IDAP 03904000
         BE    SERFL040           YES, TRY AGAIN               @D25IDAP 03905000
         OI    SERFLGPR,SERDORDY  ENSURE ENTRIES TO BE UPDATED @D25IDAP 03906000
SERFL060 ST    RF,RQTRETCD        SAVE RETURN CODE             @D25IDAP 03907000
         BAL   R7,AVRRQPST        POST WAITER                  @D25IDAP 03908000
         LR    RF,R4              RESTORE SERFLCPY BASE ADDRESS@D25IDAP 03909000
         B     SERFL020           CHECK OTHER ENTRIES          @D25IDAP 03910000
         SPACE 1                                               @D25IDAP 03911000
         LTORG ,                                               @D25IDAP 03912000
AARCOMTB DC    A(ARCOMTAB)        ADDRESS OF AR-SUP TABLE      @D25IDAP 03913000
         SPACE 1                                               @D25IDAP 03914000
         DROP  R2                 RELEASE RQTE BASE POINTER    @D25IDAP 03915000
         DROP  R6                 RELEASE DISPATCHER BASE      @D25IDAP 03916000
         DROP  RC                 RELEASE SGSERI BASE POINTER  @D25IDAP 03917000
         DROP  RD                 RELEASE SGSER  BASE          @D25IDAP 03918000
         DROP  R4                 RELEASE SERFLCPY BASE        @D25IDAP 03919000
         TITLE 'VSE SUPERVISOR     SGSER     WTO PROCESSING ROUTINE   ' 03920000
         USING SGSERI,RC          SGSERI BASE POINTER          @D61PDAP 03921000
         USING SERTASK,RD         SGSER BASE                   @D61PDAP 03922000
         USING SERMSGRT,RF        SERMSGRT BASE POINTER        @D61PDAP 03923000
         USING DISP,R6            DISPATCHER BASE POINTER      @D61PDAP 03924000
SERMSGRT NI    SERFLGPR,XFF-SERRQTMS RESET MESSAGING REQUEST   @D61PDAP 03925000
.*                                                             @D61PDAP 03926000
.*       MESSAGE PROCESSING SERVICE                            @D61PDAP 03927000
.*                                                             @D61PDAP 03928000
         L     RE,RQTBEGIN        ADDRESS OF REQUEST ENTRY     @D61PDAP 03929000
         USING RQTE,RE            RQT BASE POINTER             @D61PDAP 03930000
SERMSG10 TM    RQTFLG,RQTDOWTO+RQTINUSE ACTIVE MSG ENTRY       @D61PDAP 03931000
         BO    SERMSG30           YES,                         @D61PDAP 03932000
SERMSG20 LA    RE,RQTEND(RE)      POINT TO NEXT ENTRY          @D61PDAP 03933000
         C     RE,RQTENDAD        WAS THIS THE LAST RQT ENTRY  @DBOC    03934000
         BL    SERMSG10           NO, PROCESS NEXT ENTRY       @D61PDAP 03935000
         B     SERTASK1                ======================> @D61PDAP 03936000
SERMSG30 NI    RQTFLG,XFF-RQTINUSE WITHDRAW FROM ACTIVE CHAIN  @DBOC    03937000
         LH    R4,RQTTID          GET TID OF SERVICE OWNER     @D61PDAP 03938000
         BAL   R7,AVRSOWNR        SET SERVICE OWNER            @D61PDAP 03939000
*SGLINK  AVRSOWNR,WORK=(R4,R5)                                 @D61PDAP 03940000
         LR    R7,RE              SAVE RQT ENTRY ADDRESS       @D61PDAP 03941000
         LR    R8,RF              SAVE SERMSGRT BASE           @D61PDAP 03942000
         L     R1,RQTWTOAD        GET WTO LIST FORM ADDRESS    @D61PDAP 03943000
         WTO   MF=(E,(1))         ISSUE WTO NOW                @D61PDAP 03944000
         LR    RE,R7              RESTORE RQT ENTRY ADDRESS    @D61PDAP 03945000
         ST    RF,RQTRETCD        SAVE REURN CODE              @D61PDAP 03946000
         LR    RF,R8              RESTORE SERMSGRT BASE POINTER@D61PDAP 03947000
         MVC   RQTNEXT,RQTFLPTR   ADD ENTRY TO FREELIST        @D61PDAP 03948000
         ST    RE,RQTFLPTR        SET NEW FREE LIST POINTER    @D61PDAP 03949000
         CLC   RQTRETCD(4),F8     WAS WTO SUCCESSFUL           @D61PDAP 03950000
         BL    SERMSG20           YES, CHECK NEXT RQT ENTRY    @D61PDAP 03951000
         TM    IJBFLG08,IJBDEBUG  IS DEBUG ACTIVE              @D61PDAP 03952000
         BZ    SERMSG20           NO,                          @D61PDAP 03953000
         BAL   R5,SYSERROR             ====================>>> @D61PDAP 03954000
         DROP  R6                 RELEASE DISPATCHER BASE      @D61PDAP 03955000
         DROP  RE                 RELEASE RQT ENTRY BASE       @D61PDAP 03956000
         DROP  RC                 RELEASE SGSERI BASE POINTER  @D61PDAP 03957000
         DROP  RD                 RELEASE SGSER  BASE          @D61PDAP 03958000
         AIF   (NOT &SGSER).NPRT020                            @D61PDAP 03959000
         PRINT NOGEN                                           @D31PDAP 03960000
.NPRT020 ANOP                                                  @D37BDAP 03961000
         TITLE 'VSE SUPERVISOR     SGSER     2ND LEVEL DIRECORY UPDATE' 03962000
         SGSLDUP ROUT=UPDSLD      SLD UPDATE SERVICES          @D36SDAP 03963000
         TITLE 'VSE SUPERVISOR     SGSER     PROVIDE PAGEABLE I/O AREA' 03964000
         SGSLDUP IAREA=YES        PROVIDE PAGEABLE I/O AREA    @D36SDAP 03965000
         MEND                                                           03966000
