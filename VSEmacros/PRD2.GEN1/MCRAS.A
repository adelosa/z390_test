         MACRO                                                          00001000
         MCRAS                                                          00002000
         TITLE 'VSE/AF SUPERVISOR   MCRAS    MACHINE CHECK PROCESSING ' 00003000
         GBLB  &BGTT              TASK TIMER SUPPORT           @D14BDFR 00004000
         GBLB  &BGDEBUG                                                 00005000
         GBLB  &MCRAS             MCRAS PRINT CONTROL SWITCH   @D37ZDJR 00006000
         GBLB  &VTAM31            VTAM-31 CHANGES              @DY46396 00006500
         GBLA  &AG1               NUMBER OF PUBS (MORE DEVICES)@D51ODGL 00007000
         LCLA  &MCHSTK            STACK COUNTER FOR MCH STACK  @D31AMTP 00008000
&MCHSTK  SETA  5                  STACK LENGTH                 @D31AMTP 00009000
         AIF   (NOT &MCRAS OR NOT &BGDEBUG).NPRT010            @D37ZDJR 00010000
         PRINT GEN                                             @D37ZDJR 00011000
.NPRT010 ANOP                                                  @D37ZDJR 00012000
         EJECT                                                 @D219DGN 00013000
.*                                                                      00014000
*********************************************************************** 00015000
*                                                                       00016000
.*       IBM VSE / ADVANCED FUNCTIONS                          @D51IDGN 00017000
*        SUPERVISOR - MCRAS - 5686-CF7-06                      @D66GDHH 00018000
.*                                                             @D51IDGN 00019000
         AGO   .CPRIGHT                                        @D51IDGN 00020000
.*                                                             @D51IDGN 00021000
*        THIS MACRO IS "RESTRICTED MATERIALS OF IBM"           @D51IDGN 00022000
*        5686-CF7 (C) COPYRIGHT IBM CORP. 1979, 2004           @D65GDHH 00023000
*        ALL RIGHTS RESERVED                                   @D51IDGN 00024000
*        LICENSED MATERIALS - PROGRAM PROPERTY OF IBM          @D51IDGN 00025000
.*       SEE COPYRIGHT INSTRUCTIONS                            @D51IDGN 00026000
.*                                                                      00027000
.CPRIGHT ANOP                                                           00028000
*                                                                       00029000
*********************************************************************** 00030000
.*                                                                      00031000
*                                                                     * 00032000
*        R E S I D E N T   M A C H I N E   C H E C K   H A N D L E R  * 00033000
*                                                                     * 00034000
*                                                                     * 00035000
* FUNCTION                                                            * 00036000
*    THE FUNCTION OF THIS ROUTINE IS TO DETERMINE THE SEVERITY OF A   * 00037000
*    MACHINE CHECK INTERRUPTION AND SCHEDULE THE PROPER FUNCTIONS.    * 00038000
*                                                                     * 00039000
* ENTRY POINTS                                                        * 00040000
*         MACHEK        ENTERED VIA MACHINE CHECK NEW PSW             * 00041000
* INPUT                                                               * 00042000
*    THE MACHINE CHECK OLD PSW                                        * 00043000
*    INDEPENDENT LOG OUT AREA                                         * 00044000
* OUTPUT                                                              * 00045000
*    LOWCORE MESSAGE                                                  * 00046000
* EXTERNAL REFERENCES                                                 * 00047000
*                                                                     * 00048000
*         LOWCORE  MACHINE CHECK LOG OUT AREA                  @D149DWK 00049000
*         MCOLDP   MACHINE CHECK OLD PSW                              * 00050000
*         RASLADR  RAS LINKAGE AREA                            @D149DWK 00051000
*         RASTAB   RAS TABLE                                   @D149DWK 00052000
*         ERR1F    CANCEL ROUTINE IN SUPERVISOR                       * 00053000
*         DISP     TASK SELECTION ROUTINE IN SUPERVISOR               * 00054000
*         ERA      ENTRY REGISTER SAVE AREA IN SUPERRVISOR            * 00055000
*                                                                     * 00056000
* EXITS,NORMAL                                                        * 00057000
*         VIA R6   EXIT TO TASK SELECTION                             * 00058000
*         MCOLDP   RESUME PRIVILEGED CODE                             * 00059000
*                                                                     * 00060000
* EXITS, ERROR                                                        * 00061000
*         RASFEN00 EMERGENCY CALL FOR $$RAST00                        * 00062000
*                                                                     * 00063000
* TABLES/WORK AREAS,NOT APPLICABLE                                    * 00064000
*                                                                     * 00065000
* ATTRIBUTES                                                          * 00066000
*    REENTRANT,DISABLED,PRIVILEGED,RESIDENT                           * 00067000
*                                                                     * 00068000
* CHARACTER CODE DEPENDENCY  NOT APPLICABLE                           * 00069000
*                                                                     * 00070000
* NOTES   NOT APPLICABLE                                              * 00071000
*                                                                     * 00072000
* APAR INTEGRATION                                                    * 00073000
*      HW TO END SIO LOOP DEFINED (CHANGED DUE TO DEVELOPMENT) @DA24025 00074000
*      REGISTER D INCORRECT LOADED                             @DA24055 00075000
*      EMERGENCY EXITS ACCORDING TO DESCRIPTION                @DA25536 00076000
*      SOFT WAIT WHEN RAS RETRY SIO RECEIVES CC 3              @DA30327 00077000
*      INCORRECT POSTING OF SUCCESSFUL NON DASD RETRIES        @DA33850 00078000
*      CHANNEL CHECK NOT POSTED IN CCB FOR CHNL DAMAGED COND   @DA34523 00079000
*      SVC76 VM-VSE INTERFACE CHANGED                          @DA35277 00080000
*      LOSING DEVICE AFTER INTERFACE CONTROL CHECK             @DA35404 00081000
*      937X SUPPORT                                            @D21MDGN 00082000
*      9377 EXTENDED MACHINE CHECK HANDLING                    @D21IDGN 00083000
*      SUPPORT OF ADVANCED FUNCTION PRINTERS (3800-3/8)        @D21WDRP 00084000
*      FBA RECORDING CORRECTION                                @DA36100 00085000
*      RECOVERY EXTENSION FACILITY SUPPORT                     @D21YDGN 00086000
*      RASTASK SERVICE OWNER NOT CORRECTLY SETUP DURING IPL    @DA37076 00087000
*      3090 PROCESSOR SUPPORT                                  @D21BMGN 00088000
*      POST PUB CHANQ PTR IN DEVICE ERROR BLOCK                @DA37814 00089000
*      SOFTWARE RE-IPL                                         @D31QDHB 00090000
*      SERVICE PROCESSOR DATA TRANSFER SUPPORT                 @D31EMGN 00091000
*      STACK MACHINE CHECKS FOR HANDLING                       @D31AMTP 00092000
*      31-BIT REAL AND XA I/O SUPPORT                          @D51ADTP 00093000
*      HARDWAIT IF NO 2ND TCB SAVE AREA TO SAVE STATUS         @DA39471 00094000
*      WAITFFF AFTER MSG0T10I CHANNEL RECOVERY                 @DY39563 00095000
*      IGNORE 2. CHANNEL CHECK IF PUB IS QUEUED IN ERROR       @DY39598 00096000
*      LOOP ON SIOF RECEIVING CC=1 CUBUSY AFTER UNIT CHECK     @DY39670 00097000
*      LAST 3 APARS MISSING                                    @DY40087 00098000
*      MORE DEVICES SUPPORT                                    @D51ODGL 00099000
*      BATTERY BACKUP                                          @DY41089 00100000
*      LOOP AFTER MSG0T12I ON D/T 3410                         @DY41240 00101000
*      HARDWAIT DUE TO CCB NOT AVAILABLE                       @DY41353 00102000
*      CRW PROCESSING AND LINK INCIDENT RECORD A2              @DA41332 00103000
*      MACHINE CHECK DURING IOPOST PROCESSING                  @DY42754 00104000
*      PREVENT MC STACK OVERFLOW                               @DY42887 00105000
*      VSE/ESA 2.1 INTEGRATION OF SA FUNCTIONS                 @D61DDHH 00106000
*      VSE/ESA 2.1 SUPPORT OF A NON-PDS SYSTEM                 @D61BDHH 00107000
*      SOFTWAIT DUE TO INTERFACE MISMATCH TO VTAM APPENDAGE    @DY43250 00108000
*      VSE/ESA 2.1 MULTIPLE PROCESSOR SUPPORT                  @D61RDHH 00109000
*      SOFTWAIT DUE TO DEADLOCK - RAS TASK WAS WRITING TO THE  @DY43275 00110000
*       CONSOLE WHILE CRT TASK WAS WAITING FOR RAS TO COMPLETE @DY43275 00111000
*      RAS IO REQUEST ENQUEUED AFTER FAILING IO (AFTER DY43275)@DY43346 00112000
*      HWFFF DUE TO REG13 NOT LOADED                           @DY43415 00113000
*      MSG0T10I MAY BE ISSUED INSTEAD OF MSG0T12I              @DY43510 00114000
*      SUPPORT FOR TPA DEVICES (3590)                          @D61SDHH 00115000
*      REMOVAL OF CRW PROCESSING CODE DUPLICATED IN SENSE TASK @DY43697 00116000
*      HW FED IF RAS TRANSIENT PHASE (RASTXX) NOT FOUND        @DY44069 00117000
*      FINAL CORRECTIONS FOR TPA (3590) DEVICES                @DY44201 00118000
*      CONTINUE CRW PROCESSING WHEN SUBCHANNEL IS UNAVAILABLE  @DA44462 00119000
*      PMR REDUCTION ITEMS, EG. - SAVE REGS AT CCENTRY1        @D63JDHH 00120000
*        - SUPPORT ANCILLARY REPORT BIT IN CRW MESSAGES        @D63JDHH 00121000
*      VSE/ESA 2.4 FAMILY API: HW IN CASE OF CLOCK ERROR       @D64ADHH 00122000
*      HARDWAIT - SGSCHED ENTERED WITH PUB ADDRESS = ZEROES    @DY44671 00123000
*      VSE/ESA 2.5                                             @D65EDHH 00124000
*      HW FFF - IFC FOR 3590 WITH SECONDARY ERROR(I/F Inoper.) @DY45540 00125000
*      HARDWAIT - CRW PROCESSING WITH INVALID PUB CHANQ INDEX  @DY45540 00126000
*      LOOP OVER MSCH FOR SUBCHANNEL INSTALLED PARAMETER INIT. @DY45547 00127000
*      SUPPORT FOR MORE TASKS                                  @D66GDHH 00128000
*      SUPPORT FOR OSA-EXPRESS (QDIO) DEVICES                  @D66GDHH 00129000
*      Corrected BO statements                                 @DY45789 00130000
*      Cleanup / Corrections                                   @D68OMHH 00131000
*      CC Handler: Do not switch owner if device is not QEDERR @DY46233 00131500
*      HARDWAIT IJBDISPT: BAD SYSCOM ADDR AFTER EXTERNAL INT   @DY46384 00131700
*      Support for VTAM 31-bit buffers                         @DY46396 00131800
*                                                                     * 00132000
*********************************************************************** 00133000
         SPACE 2                                               @D219DGN 00134000
         DC    C'MCRAS   '                                     @D37ZDJR 00135000
         DC    C'DY46396 '        LAST APAR FIX                @DY46396 00136970
         DC    C'05/03/13'        Date of last update          @DY46233 00137180
         DS    0H                 ALIGN                        @D36ZDJR 00138000
MACHEK   BALR  RB,0               SET MACHINE CHECK BASE       @DA41332 00139000
         USING *,RB                                                     00140000
         SPACE 2                                               @D36IDJR 00141000
MCSTRT   LA    RB,0(,RB)          ENABLE BASE REG FOR 31 BIT   @DA41332 00142000
         L     RF,ASYSCOM         SAVE EXTERNAL INT PARAM      @DY46384 00143190
         LA    RA,A$Y$COM         GET SYSCOM ADDR              @DY46384 00143380
         ST    RA,ASYSCOM         SET SYSCOM ADDR              @DY46384 00143570
*        TDLOCK FUNC=OBTAIN,TYPE=NPRAS,WR1=RA,WR2=RE           @D61RDHH 00143760
         TDLOCK FUNC=OBTAIN,TYPE=NPRAS,WR1=RA,WR2=RE           @D61RDHH 00144000
         L     RA,AMCHSRDA        SET ROUTINE AND DATA BASE    @DA41332 00145000
         USING MACHSRDA,RA        BASE FOR MC SUBROUT AND DATA @DA41332 00146000
         STCTL CRE,CRE,CR14SAV    SAVE CR14 CONTENTS           @DA41332 00147000
         ST    RF,EXTINTP         SAVE EXTERN INTERRUPT PARM   @DY46384 00147500
         BAL   RE,MACHENQ         CALL MACH ENQUEU ROUTINE     @DA41332 00148000
         SPACE 1                                               @DA41332 00149000
***************************************************************@DA41332 00150000
*      CHECK FOR ANY MC SUBCLASS BIT ON                        @DA41332 00151000
***************************************************************@DA41332 00152000
         SPACE 2                                               @DA41332 00153000
         TM    MCICB00,X'FF'      TEST WHETHER AT LEAST ....   @D31EMGN 00154000
         BNZ   MCSYSDMG            ONE MC SUBCLASS HAS   ....  @DA41332 00155000
         TM    MCICB01,X'F0'        BEEN STORED BY HARDWARE    @D31EMGN 00156000
         BZ    EMGEX9             NO, SHOULD NOT OCCUR         @D31EMGN 00157000
         SPACE 1                                               @D319MGN 00158000
***************************************************************@D319MGN 00159000
*      SYSTEM DAMAGE                                           @D319MGN 00160000
***************************************************************@D319MGN 00161000
         SPACE 2                                               @D319MGN 00162000
MCSYSDMG TM    MCICB00,SDBIT      SYSTEM DAMAGE MC             @DA41332 00163000
         BO    EMGEX9             YES, TERMINATE SYSTEM        @CLEANUP 00164000
         SPACE 1                                               @DA41332 00165000
***************************************************************@DA41332 00166000
*   INSTRUCTION PROCESSING DAMAGE                              @DA41332 00167000
***************************************************************@DA41332 00168000
         SPACE 2                                               @DA41332 00169000
         TM    MCICB00,PDBIT      INSTRUCTION PROCESS.DAMAGE   @DA41332 00170000
         BZ    MCWARNG            NO, CHECK FOR NEXT ERROR     @DA41332 00171000
         TM    MCICB01,BUBIT      BACKUP CONDITION             @DA41332 00172000
         BZ    EMGEX9             NO, TERMINATE SYSTEM         @DA41332 00173000
         SPACE 1                                               @D319MGN 00174000
***************************************************************@D319MGN 00175000
*      WARNING CONDITION                                       @D319MGN 00176000
***************************************************************@D319MGN 00177000
         SPACE 2                                               @D319MGN 00178000
MCWARNG  TM    MCICB01,WABIT      IS THE WARNING BIT ON        @D14ADWK 00179000
         BO    EMGEX9             YES, TERMINATE SYSTEM        @D35EDSK 00180000
         SPACE 1                                               @D519DGN 00181000
***************************************************************@D519DGN 00182000
*      CHANNEL SUBSYSTEM DAMAGE                                @D529DGN 00183000
***************************************************************@D519DGN 00184000
         SPACE 2                                               @D519DGN 00185000
         TM    MCICB01,CKBIT      CHANNEL SUBSYSTEM DAMAGE     @DA41332 00186000
         BO    EMGEX9             YES, TERMINATE SYSTEM        @DA41332 00187000
         SPACE 1                                               @DA41332 00188000
***************************************************************@DA41332 00189000
*        TIMER FACILITY DAMAGE                                 @DA41332 00190000
***************************************************************@DA41332 00191000
         SPACE 2                                               @DA41332 00192000
         TM    MCICB00,CDBIT      CLOCK DAMAGE                 @D14ADWK 00193000
         BO    EMGEX9             YES, TERMINATE SYSTEM        @D64ADHH 00194000
         SPACE 2                                               @DY42754 00195000
***************************************************************@D219DGN 00196000
*      EXTERNAL DAMAGE PROCESSING                              @D219DGN 00197000
***************************************************************@D219DGN 00198000
         SPACE 2                                               @D219DGN 00199000
MACHEXDM TM    MCICB00,EDBIT      EXTERNAL DAMAGE OCCURRED     @D21IDGN 00200000
         BZ    MACHCREP           NO, CHECK FOR CH REP PENDING @DA41332 00201000
         TM    MCICB03,EDRBIT     EXTERNAL DAMAGE CODE VALID   @DA41332 00202000
         BZ    MACHCREP           NO, CHECK FOR CH REP PENDING @DA41332 00203000
         SPACE 1                                               @D519DGN 00204000
***************************************************************@D519DGN 00205000
*      CHANNEL REPORT WORD PENDING                             @D529DGN 00206000
***************************************************************@D519DGN 00207000
         SPACE 2                                               @D519DGN 00208000
MACHCREP TM    MCICB01,CPBIT      CHANNEL REPORT PENDING       @DA41332 00209000
         BZ    MACHSPD            NO, CHECK FOR SERV PROC DMG  @DA41332 00210000
         L     RE,RASLINKA        RASLINK ADDRESS              @D61RDHH 00211000
         OI    MCFLAGS-RASLINK(RE),MCCRWP IND.CRW PEND PROCES. @D61RDHH 00212000
         B     MACHSPD            CONTINUE WITH SERV PROC DMG  @DA41332 00213000
         SPACE 2                                               @D529DGN 00214000
         SPACE 1                                               @D319MGN 00215000
***************************************************************@D319MGN 00216000
*      SERVICE PROCESSOR DAMAGE                                @D319MGN 00217000
***************************************************************@D319MGN 00218000
         SPACE 2                                               @D319MGN 00219000
MACHSPD  TM    MCICB01,SPBIT      SERVICE PROCESSOR DAMAGE     @D31EMGN 00220000
         BZ    MACHTHRE           NO, =======>                 @DA41332 00221000
         L     R7,ASPDTTAB        GET ADDRESS OF SPDT TABLE    @D31EMGN 00222000
         USING SPDTTAB,R7         SPDT BASE                    @D31EMGN 00223000
         TM    SPSGFLG2,SPSGERAS  SPDT TASK ENABLED FOR RAS    @D31EMGN 00224000
         BZ    MACHTHRE           NO, =======>                 @DA41332 00225000
         OI    SPSGWOE,SPSGWOE1   SET SERVICE PROCESSOR DAMAGE @D31EMGN 00226000
         TM    SPSGFLG2,SPSGSTIX  SPDT TASK ACTIVE             @D31EMGN 00227000
         BO    MACHTHRE           YES, ======>                 @DA41332 00228000
         DROP  R7                                              @D61RDHH 00229000
         OI    MCDLYFLG,MCDLYSPD  REQUEST DELAYED POSTING      @DY42754 00230000
         L     R7,RASLINKA                    ..               @D61RDHH 00231000
         OI    MCFLAGS-RASLINK(R7),MCDLYP     ..  OF SPD TASK  @D61RDHH 00232000
         SPACE 1                                               @DA41332 00233000
***************************************************************@DA41332 00234000
*   TERMINATE SYSTEM IF MORE THAN 10 MACHINE CHECKS IN 10 MIN  @DA41332 00235000
***************************************************************@DA41332 00236000
         SPACE 2                                               @D36ZDJR 00237000
MACHTHRE TM    MCICB01,CPBIT      CHANNEL REPORT PENDING CHECK @DA41332 00238000
         BO    MACHVALD           YES, BYPASS THRESHOLD CHECK  @DA41332 00239000
         CLC   MCERRCNT,H0        FIRST HARD MACHINE CHECK     @D21MDGN 00240000
         BNE   MCNFRST            NO                           @D21MDGN 00241000
         STCK  TODCLOCK           GET TOD CLOCK VALUE          @DA41332 00242000
         BC    3,EMGEX9           CLOCK ERROR, NOT OPERATIONAL @D21MDGN 00243000
         MVC   MC1TIME,TODCLOCK   SAVE TIME OF FIRST ERROR     @DA41332 00244000
MCNFRST  LH    R8,MCERRCNT        GET MACHINE CHECK COUNT      @D21MDGN 00245000
         LA    R8,1(R8)           INCREMENT COUNT BY ONE       @D21MDGN 00246000
         STH   R8,MCERRCNT        SAVE MACHINE CHECK COUNT     @D21MDGN 00247000
         CLC   MCERRCNT,MCLCNT    COUNT THRESHOLD REACHED      @D21MDGN 00248000
         BL    MACHVALD           NO, CONTINUE                 @DA41332 00249000
         STCK  TODCLOCK           GET TOD CLOCK VALUE          @DA41332 00250000
         BC    3,EMGEX9           CLOCK ERROR, NOT OPERATINAL  @D21MDGN 00251000
         L     R8,TODCLOCK        GET CURRENT TIME             @DA41332 00252000
         S     R8,MC1TIME         CALCULATE ELAPSED TIME       @D21MDGN 00253000
         C     R8,MCLTIME         TIME THRESHOLD REACHED       @D21MDGN 00254000
         BNH   EMGEX9             NO, TERMINATE SYSTEM         @D21MDGN 00255000
         MVC   MCERRCNT,H0        CLEAR COUNT FIELD            @D21MDGN 00256000
         SPACE 1                                               @DA41332 00257000
***************************************************************@DA41332 00258000
*   CHECK MACHINE CHECK VALIDITY FLAGS                         @DA41332 00259000
***************************************************************@DA41332 00260000
         SPACE 2                                               @D36ZDJR 00261000
MACHVALD TM    MCOLDP+1,WAITBIT+NPBIT FROM ALLBOUND            @DA41332 00262000
         BO    MACHSOFT           YES, SOFT MACHINE CHECK      @DA41332 00263000
         TM    MCICB02,WPBIT      IS THE AMWP FIELD VALID      @D14ADWK 00264000
         BZ    MACHHARD           NO  TERMINATE THE SYSTEM     @DA41332 00265000
         TM    MCICB02,MSBIT+PMBIT+IABIT MCOLDPSW VALID        @D14ADWK 00266000
         BNO   MACHHARD           NO, GO TERMINATE SYSTEM      @DA41332 00267000
         TM    MCICB03,GRBIT      GENERAL REGISTERS VALID      @D14ADWK 00268000
         BNO   MACHHARD           NO, GO TERMIANTE SYSTEM      @DA41332 00269000
         TM    MCICB03,FPBIT      FLOAT. POINT REGISTER VALID  @DA41332 00270000
         BNO   MACHHARD           NO, GO TERMINATE SYSTEM      @DA41332 00271000
         TM    IJBFLG06,IJBAMODE  DO WE HAVE ACCESS REGS       @D51KDTP 00272000
         BNO   MACHSTOR           NO, CHECK FOR STORAGE ERROR  @DA41332 00273000
         TM    MCICB04,ARBITVAL   ACCESS REGISTERS VALID       @D51KDTP 00274000
         BZ    MACHHARD           NO, GO TERMINATE SYSTEM      @DA41332 00275000
         SPACE 1                                               @DA41332 00276000
***************************************************************@D529DGN 00277000
*   CHECK FOR STORAGE ERROR CONDITIONS                         @D529DGN 00278000
***************************************************************@D529DGN 00279000
         SPACE 2                                               @D36ZDJR 00280000
MACHSTOR TM    MCICB02,SEBIT+KEBIT STORAGE OR KEY ERROR        @DA41332 00281000
         BZ    MACHSOFT           NO, SOFT CHECK               @DA41332 00282000
         TM    MCICB03,FABIT      IS FAIL. STOR. ADDR. VALID   @D14ADWK 00283000
         BZ    EMGEX9             NO, GO TERMINATE SYSTEM      @D34DDAZ 00284000
         L     R9,FSA             LOAD FAILING STORAGE ADDRESS @D37BDJR 00285000
         N     R9,PADDRMSK        ADJUST TO PAGE BOUNDARY      @D37BDJR 00286000
         L     R7,ASPDTTAB        GET ADDRESS OF SPDT TABLE    @D31EMGN 00287000
         USING SPDTTAB,R7         SPDT BASE                    @D31EMGN 00288000
         TM    SPSGFLG2,SPSGERAS  SPDT TASK ENABLED FOR RAS    @D31EMGN 00289000
         BZ    MACHSTER           NO, =======>                 @D31EMGN 00290000
         C     R9,SPSGSCCB        STORAGE ERROR IN SCCB FRAME  @D31EMGN 00291000
         BNE   MACHSTER           NO, =======>                 @D31EMGN 00292000
         OI    SPSGWOE,SPSGWOE0   SET STORAGE ERROR IN SCCB    @D31EMGN 00293000
         TM    SPSGFLG2,SPSGSTIX  SPDT TASK ACTIVE             @D31EMGN 00294000
         BO    MACHSOFT           YES, ======>                 @DA41332 00295000
         DROP  R7                                              @D61RDHH 00296000
         OI    MCDLYFLG,MCDLYSPD  REQUEST DELAY POST SPD TASK  @DY42754 00297000
         L     R7,RASLINKA        GET ADDRESS OF RASLINK       @D61RDHH 00298000
         OI    MCFLAGS-RASLINK(R7),MCDLYP   REQ DELAYED POST   @D61RDHH 00299000
         B     MACHSOFT           CHECK FOR PROBLEM STATE      @DA41332 00300000
         EJECT                                                 @DA41332 00301000
***************************************************************@DA41332 00302000
*   HANDLE STORAGE ERROR CONDITION                             @DA41332 00303000
.*                                                             @DA41332 00304000
.*  (VSE/ESA 130: THIS CODE HAS BEEN MOVED TO THIS PLACE       @DA41332 00305000
.*     FROM $$RAST03, $$RAST09, $$RAST13)                      @DA41332 00306000
*                                                              @DA41332 00307000
*  REGISTER USAGE:    R1   - WORK REGISTER                     @DA41332 00308000
*                     R3   - FSA                               @DA41332 00309000
*                     R4   - SCB ADDRESS                       @DA41332 00310000
*                     R5   - PCB ADDRESS                       @DA41332 00311000
*                     R7   - WORK REGISTER                     @DA41332 00312000
*                     R8   - SMCOM ADDRESS, WORK REGISTER      @DA41332 00313000
*                     R9   - WORK REGISTER                     @DA41332 00314000
*                                                              @DA41332 00315000
* ************************************************************ @DA41332 00316000
         SPACE 2                                               @DA41332 00317000
MACHSTER L     R3,FSA             GET FAILING STORAGE ADDRESS  @DA41332 00318000
         XC    MCTMPMS1,MCTMPMS1  CLEAR WORK FIELDS FOR MSGS   @DA41332 00319000
         XC    MCTMPLOG,MCTMPLOG  CLEAR WORK FIELDS FOR MSGS   @DA41332 00320000
         LTR   R3,R3              FSA = 0 ?                    @DA41332 00321000
         BZ    MCSTORNX           ..YES, HARD MACHINE CHECK    @DA41332 00322000
         C     R3,IJBEOR          REAL ADDRESS VALID           @DA41332 00323000
         BH    MCSTORNX           .. NO, HARD MACHINE CHECK    @DA41332 00324000
         TM    SUPFLAG,PMRINIT    PMR TABLES ALREADY INITIAL.? @DA41332 00325000
         BNO   MCVAL              .. NO, VIRTUAL = REAL        @DA41332 00326000
         SPACE 1                                               @DA41332 00327000
         LR    R5,R3              LOAD FSA                     @DA41332 00328000
         L     R7,IJBPMCOM        GET A(PMCOM)                 @DA41332 00329000
         USING PMCOM,R7                                        @DA41332 00330000
         N     R5,PMPAGMSK        SET FSA ON PAGE BOUNDARY     @DA41332 00331000
         LH    R7,PMADPFTO        SHIFT VALUE ADDR -> PFT OFFS.@DA41332 00332000
         DROP  R7                 DROP PMCOM BASE              @DA41332 00333000
         SRL   R5,0(R7)           GET OFFSET IN PAGE FRAME TABL@DA41332 00334000
         L     R7,IJBSPAVT        GET A(SUP AVT)               @DA41332 00335000
         USING SUPAVT,R7          ADDRESSABILITY TO SUP AVT    @DA41332 00336000
         L     R7,APFT            GET A(PAGE FRAME TABLE)      @DA41332 00337000
         DROP  R7                 DROP SUPAVT BASE             @DA41332 00338000
         AR    R7,R5              CALC A(PFT ENTRY)            @DA41332 00339000
         ST    R7,MCPFTEA         SAVE A(PFT ENTRY)            @DA41332 00340000
*        AMODESW SET,AMODE=31,WR=(R5)  WE MAY HAVE 31-BIT ADDR @DA41332 00341000
         AMODESW SET,AMODE=31,WR=(R5)  WE MAY HAVE 31-BIT ADDR @DA41332 00342000
*        AMODESW SET,DAT=OFF      PFT POINTER IS A REAL ADDR   @DA41332 00343000
         AMODESW SET,DAT=OFF      PFT POINTER IS A REAL ADDR   @DA41332 00344000
         USING PFTE,R7                                         @DA41332 00345000
         IC    R5,S370FLG         GET THE PFTE FLAG BYTE       @DA41332 00346000
         L     R4,PFTESCB         GET A(SCB)                   @DA41332 00347000
*        AMODESW SET,DAT=ON       SET DAT ON FOR VIRT ADDRESS. @DA41332 00348000
         AMODESW SET,DAT=ON       SET DAT ON FOR VIRT ADDRESS. @DA41332 00349000
         STC   R5,MCPFTEFL        SAVE THE PFTE FLAG BYTE      @DA41332 00350000
         TM    MCPFTEFL,PNRINV    PAGE UNUSED?                 @DA41332 00351000
         BO    MCSTORNX           ..YES, HARD MACHINE CHECK    @DA41332 00352000
         SPACE 1                                               @DA41332 00353000
         USING SCBADR,R4          BASE DSECT                   @DA41332 00354000
MCSTOR10 TM    SCBFLG,SCBDSP      SCB FOR A DATA SPACE?        @DA41332 00355000
         BO    MCDSP              ..YES, SPEC.HANDLING DSPACE  @DA41332 00356000
*        AMODESW SET,DAT=OFF      ADDR(PFTE) IS REAL           @DA41332 00357000
         AMODESW SET,DAT=OFF      ADDR(PFTE) IS REAL           @DA41332 00358000
         LH    R8,PFIXC           SAVE OLD PFIX COUNT          @DA41332 00359000
         MVC   PFIXC,H1           SET TEMP PFIX COUNT 1        @DA41332 00360000
*        AMODESW SET,DAT=ON       SET DAT ON FOR VIRT.ADDRESS. @DA41332 00361000
         AMODESW SET,DAT=ON       SET DAT ON FOR VIRT.ADDRESS. @DA41332 00362000
         LR    R9,R3              LOAD REAL ADDRESS FOR VIRTAD @DA41332 00363000
*        AMODESW CALL,AMODE=31,ADDRESS=VIRTAD,REGS=(R6,R5)     @DA41332 00364000
         AMODESW CALL,AMODE=31,ADDRESS=VIRTAD,REGS=(R6,R5)     @DA41332 00365000
         LTR   RF,RF              OK?                          @DA41332 00366000
         BZ    MCSTORNX           .. NO, HARD MACHINE CHECK    @DA41332 00367000
         ST    RF,MCSAVVAD        SAVE THE VIRTUAL ADDRESS     @DA41332 00368000
*        AMODESW SET,DAT=OFF      PFT POINTER IS A REAL ADDR   @DA41332 00369000
         AMODESW SET,DAT=OFF      PFT POINTER IS A REAL ADDR   @DA41332 00370000
         STH   R8,PFIXC           RESTORE OLD PFIX COUNT       @DA41332 00371000
*        AMODESW SET,DAT=ON       SET DAT ON FOR VIRT.ADDRESS. @DA41332 00372000
         AMODESW SET,DAT=ON       SET DAT ON FOR VIRT.ADDRESS. @DA41332 00373000
*        AMODESW SET,AMODE=24,WR=(R5)  RESET 24-BIT AMODE      @DA41332 00374000
         AMODESW SET,AMODE=24,WR=(R5)  RESET 24-BIT AMODE      @DA41332 00375000
         DROP  R7                 DROP PFTE BASE               @DA41332 00376000
         SPACE 1                                               @DA41332 00377000
* ------------------------------------------------------------ @DA41332 00378000
*  IS VIRT-FSA IN SHARED PART. / PRIVATE PARTITION AREA?       @DA41332 00379000
* ------------------------------------------------------------ @DA41332 00380000
         L     R8,IJBSMCOM        GET A(SMCOM)                 @DA41332 00381000
         USING SMCOM,R8                                        @DA41332 00382000
         C     RF,SMCESVA         NOT HIGHER THAN END(SVA-24)? @DA41332 00383000
         BNH   MCSTORNX           ..YES, HARD MACHINE CHECK    @DA41332 00384000
         C     RF,SMCPRPND        ABOVE PRIVATE PART AREA?     @DA41332 00385000
         BH    MCSTORNX           ..YES, HARD MACHINE CHECK    @DA41332 00386000
         B     MCVAL              DO VALIDATION NOW            @DA41332 00387000
         DROP  R8                 DROP SMCOM BASE              @DA41332 00388000
         SPACE 2                                               @DA41332 00389000
         EJECT                                                 @DA41332 00390000
* ------------------------------------------------------------ @DA41332 00391000
* SPECIAL HANDLING IF FSA BELONGS TO A DATA SPACE              @DA41332 00392000
*                                                              @DA41332 00393000
*  PROBLEM: THE FOLLOWING "TB" INSTRUCTION WILL DESTROY DATA   @DA41332 00394000
*     IN THE DATA SPACE .                                      @DA41332 00395000
*     IF THE DSPACE IS OWNED BY THE ACCESSING TASK THE DATA    @DA41332 00396000
*     CORRUPTION DOES NOT MATTER SINCE THE DSPACE IS DELETED   @DA41332 00397000
*     WHEN THE USERTASK IS CANCELED LATER-ON.                  @DA41332 00398000
*     IF IT IS NOT OWNED BY THE ACCESSING TASK ("TYPE=COMMON"  @DA41332 00399000
*     OR "TYPE=ALL" DATA SPACES) THE DSPACE WILL CONTINUE TO   @DA41332 00400000
*     EXIST WITH PARTLY INVALID DATA.                          @DA41332 00401000
*     TO PREVENT OTHER TASKS FROM WORKING WITH INVALID DATA    @DA41332 00402000
*     THE OWNER TASK WILL BE CANCELLED. THIS WILL DELETE THE   @DA41332 00403000
*     CORRUPTED DATA SPACE.                                    @DA41332 00404000
*                                                              @DA41332 00405000
*  NOTE: FOR VDISKS WE WON'T COME HERE SINCE I/O SIMULATION    @DA41332 00406000
*     FOR VDISKS RUNS IN NON-PROBLEM STATE AND THUS HAS ALREADY@DA41332 00407000
*     FORCED AN HARDWAIT.                                      @DA41332 00408000
*                                                              @DA41332 00409000
* ------------------------------------------------------------ @DA41332 00410000
MCDSP    L     R8,DSCBTIB         GET DSPACE OWNER'S TIB ADDR. @DA41332 00411000
         USING TIBADR,R8          BASE TIB DSECT               @DA41332 00412000
         CLC   TID,TIBRTID        MACH.CHECK.TID = OWNER TID ? @DA41332 00413000
         BE    MCVAL              ..YES, VALIDATE STORAGE      @DA41332 00414000
*                                 ..NO, DSPACE IS NOT DELETED  @DA41332 00415000
*                           WITH CANCEL OF USER TASK. IT MUST  @DA41332 00416000
*                           BE DELETED WITH CANCEL OF OWNER.   @DA41332 00417000
         LH    R0,TIBRTID         LOAD OWNER TID               @DA41332 00418000
         DROP  R8                 RELEASE TIB BASE             @DA41332 00419000
         LH    R8,RID             SAVE RID                     @DA41332 00420000
         XC    RID,RID            CLEAR RID                    @DA41332 00421000
         MVI   RID+1,REENTRID     SET REENTRANT ROUTINE ID     @DA41332 00422000
         LA    R1,FCPU            LOAD CANCEL CODE '1F'        @DA41332 00423000
*        TREADY TASK=(R0),COND=CANCEL,CODE=(R1)  CANCEL TASK   @DA41332 00424000
         TREADY TASK=(R0),COND=CANCEL,CODE=(R1)  CANCEL TASK   @DA41332 00425000
         STH   R8,RID             RESTORE ORIGINAL RID         @DA41332 00426000
         SPACE 1                                               @DA41332 00427000
* ------------------------------------------------------------ @DA41332 00428000
* VALIDATE THE STORAGE BLOCK                                   @DA41332 00429000
* ------------------------------------------------------------ @DA41332 00430000
MCVAL    SLR   R0,R0              CLEAR REGISTER 0             @DA41332 00431000
*        TB    R0,R3              TEST BLOCK                   @DA41332 00432000
         DC    0H'0',AL1(X'B2',X'2C',0,3)       TEST BLOCK     @DA41332 00433000
         BNZ   MCVALF             CC>0 MEANS VALIDATION FAILED @DA41332 00434000
         TM    SUPFLAG,PMRINIT    PMR TABLES ALREADY INITIAL.? @DA41332 00435000
         BO    MCSTRK             ..YES, RESET STORAGE KEY     @DA41332 00436000
         B     MCSTORND           ..NO, DON'T RESET KEY        @DA41332 00437000
         SPACE 1                                               @DA41332 00438000
* ------------------------------------------------------------ @DA41332 00439000
* SINCE VALIDATION WAS SUCCESSFUL, RESET THE STORAGE KEY NOW   @DA41332 00440000
* ------------------------------------------------------------ @DA41332 00441000
MCSTRK   TM    MCICB02,KEBIT      STORAGE KEY ERROR?           @DA41332 00442000
         BNO   MCSTORND           ..NO, NO KEY REPAIR          @DA41332 00443000
         TM    SCBFLG,SCBDSP      SCB FOR A DATA SPACE         @DA41332 00444000
         BO    MCSTORND           ..YES, NO KEY REPAIR         @DA41332 00445000
         TM    SCBFLG,SCBPMRSP    SCB FOR PMR ADDRESS SPACE    @DA41332 00446000
         BO    MCSTORNX           ..YES, HARD MACHINE CHECK    @DA41332 00447000
         SPACE 1                                                        00448000
MCSTRK10 TM    SCBFLG,SCBASP      SCB FOR AN ADDRESS SPACE?    @DA41332 00449000
         BNO   MCSTORNX           ..NO, HARD MACHINE CHECK     @DA41332 00450000
         CLI   SCBID+1,X'40'      SCB OF A STATIC PARTITION    @DA41332 00451000
         BE    MCSTRK20           ..YES, REPAIR STATIC KEY     @DA41332 00452000
         L     R9,MCSAVVAD        GET VIRT ADDRESS             @DA41332 00453000
         C     R9,SCBSPGVE        ADDR WITHIN DYN.SPACE GETVIS?@DA41332 00454000
         BL    MCSTORNX           ..YES, RESET NOT POSSIBLE    @DA41332 00455000
*                                   (DONT KNOW WHAT KEY TO SET)@DA41332 00456000
         LH    R1,SCBDSPIK        GET PIK                      @D61SDHH 00457000
         SRL   R1,2               DIVIDE BY 2                  @D61SDHH 00458000
         A     R1,APCBATAB        POINT TO PCB ADDRESS         @D61SDHH 00459000
         L     R1,0(,R1)          GET PCB ADDRESS              @D61SDHH 00460000
         USING PCBADR,R1                                       @D61SDHH 00461000
         MVC   MCKEY,PCEKEY       GET THE STORAGE KEY          @D61SDHH 00462000
         DROP  R1                                              @D61SDHH 00463000
         B     MCSETKEY           AND SET THE KEY              @DA41332 00464000
         SPACE 1                                               @DA41332 00465000
MCSTRK20 LA    RC,SCBPSTR         LOAD ADDR OF 1ST PIK IN SPACE@DA41332 00466000
         L     R9,MCSAVVAD        GET VIRT ADDRESS             @DA41332 00467000
MCSTRK21 LH    R1,0(RC)           LOAD PIK                     @DA41332 00468000
         CH    R1,H0              ANY PIK THERE?               @DA41332 00469000
         BE    MCVALF             .. NO, REPAIR NOT POSSIBLE   @DA41332 00470000
         SRL   R1,2               DIVIDE PIK BY 2              @D61SDHH 00471000
         A     R1,APCBATAB        POINT TO PCB ADDRESS         @D61SDHH 00472000
         L     R5,0(,R1)          GET PCB ADDRESS              @D61SDHH 00473000
         USING PCBADR,R5          BASE PCB DSECT               @DA41332 00474000
         CR    R9,R3              VIRT=REAL?                   @DA41332 00475000
         BNE   MCSTRK30           .. NO, CHECK VIRT BOUNDARIES @DA41332 00476000
         TM    MCPFTEFL,PFTEREAL  PAGE FRAME FOR REAL PARTITION@DA41332 00477000
         BNO   MCSTRK30           .. NO, CHECK VIRT BOUNDARIES @DA41332 00478000
         C     R9,SMRPBEG         FSA IN THIS REAL PART?       @DA41332 00479000
         BL    MCSTRK40           .. NO, CHECK NEXT PIK        @DA41332 00480000
         C     R9,SMRPEND         FSA IN THIS REAL PART?       @DA41332 00481000
         BNL   MCSTRK40           .. NO, CHECK NEXT PIK        @DA41332 00482000
         B     MCSTRK35           ..YES, GET STORAGE KEY       @DA41332 00483000
MCSTRK30 C     R9,SMVPBEG         VIRT ADDR IN THIS PART?      @DA41332 00484000
         BL    MCSTRK40           .. NO, CHECK NEXT PIK        @DA41332 00485000
         C     R9,SMVPEND         VIRT ADDR IN THIS  PART?     @DA41332 00486000
         BNL   MCSTRK40           .. NO, CHECK NEXT PIK        @DA41332 00487000
MCSTRK35 MVC   MCKEY,PCEKEY       GET THE STORAGE KEY          @D61SDHH 00488000
         DROP  R5                                              @D61SDHH 00489000
         B     MCSETKEY           AND SET IT                   @DA41332 00490000
MCSTRK40 LA    RC,2(,RC)          POINT TO NEXT PIK IN LIST    @DA41332 00491000
         B     MCSTRK21           CHECK BOUNDARIES             @DA41332 00492000
         SPACE 1                                               @DA41332 00493000
MCSETKEY SLR   R8,R8                                           @DA41332 00494000
         IC    R8,MCKEY           LOAD STORAGE KEY             @DA41332 00495000
         N     R3,PADDRMSK        SET TO 4K PAGE BOUNDARY      @DA41332 00496000
*        AMODESW SET,AMODE=31,WR=(R9)  SET TO 31-BIT MODE      @DA41332 00497000
         AMODESW SET,AMODE=31,WR=(R9)  SET TO 31-BIT MODE      @DA41332 00498000
         SSKE  R8,R3              SET THE STORAGE KEY          @DA41332 00499000
*        AMODESW SET,AMODE=24,WR=(R9)  SET TO 24-BIT MODE      @DA41332 00500000
         AMODESW SET,AMODE=24,WR=(R9)  SET TO 24-BIT MODE      @DA41332 00501000
         B     MCSTORND           AND RETURN                   @DA41332 00502000
         DROP  R4                 DROP SCB BASE                @DA41332 00503000
         SPACE 2                                               @DA41332 00504000
* -----------------------------------------------------------  @DA41332 00505000
* MCVALF: THIS SUBROUTINE IS ENTERED IF                        @DA41332 00506000
*         A REPAIR/VALIDATION ACTION WAS NOT POSSIBLE          @DA41332 00507000
*         OR THE "TB" SHOWED THE STORAGE BLOCK TO BE UNUSABLE. @DA41332 00508000
* -----------------------------------------------------------  @DA41332 00509000
MCVALF   EQU   *                                               @DA41332 00510000
         TM    SUPFLAG,PMRINIT    PMR TABLES ALREADY INITIAL.? @DA41332 00511000
         BNO   MCSTORNX           ..NO, HARDWAIT               @DA41332 00512000
*        AMODESW SET,AMODE=31,WR=(R5)  WE MAY HAVE 31-BIT ADDR @DA41332 00513000
         AMODESW SET,AMODE=31,WR=(R5)  WE MAY HAVE 31-BIT ADDR @DA41332 00514000
         L     R8,APMGMDAT        LOAD POINTER TO PAGE MGR.    @DA41332 00515000
         USING PMGMDATA,R8        ADDRESSABILITY TO DATA       @DA41332 00516000
         L     R7,ADRAPDEQ        LOAD ADDRESS OF DEQ ROUTINE  @DA41332 00517000
         LR    R0,R3              LOAD FSA INTO REG. ZERO      @DA41332 00518000
*        AMODESW CALL,REGS=(R7,R7)   BRANCH TO PAGE MGR.ROUTIN @DA41332 00519000
         AMODESW CALL,REGS=(R7,R7)   BRANCH TO PAGE MGR.ROUTIN @DA41332 00520000
         DROP  R8                 DROP PAGE MANAGER BASE       @DA41332 00521000
         L     R7,MCPFTEA              GET A(PFTE) FOR FSA     @DA41332 00522000
*        AMODESW SET,DAT=OFF           A(PFTE) IS REAL         @DA41332 00523000
         AMODESW SET,DAT=OFF           A(PFTE) IS REAL         @DA41332 00524000
         USING PFTE,R7                                         @DA41332 00525000
         OI    S370FLG,DRAP       SET DRAPBIT ON               @DA41332 00526000
         DROP  R7                 DROP PFTE BASE               @DA41332 00527000
*        AMODESW SET,DAT=ON       SET DAT ON FOR VIRT ADDRESS. @DA41332 00528000
         AMODESW SET,DAT=ON       SET DAT ON FOR VIRT ADDRESS. @DA41332 00529000
*        AMODESW SET,AMODE=24,WR=(R5)  RESET 24-BIT MODE       @DA41332 00530000
         AMODESW SET,AMODE=24,WR=(R5)  RESET 24-BIT MODE       @DA41332 00531000
         OI    MCTMPMS1,MCST$RPF  REQUEST MSG 0T15E            @DA41332 00532000
         SPACE 2                                               @DA41332 00533000
* -----------------------------------------------------------  @D61BDHH 00534000
*  HANDLE AN UNRECOVER. STORAGE ERROR IN A NON-PDS ENVIRONMENT @D61BDHH 00535000
* -----------------------------------------------------------  @D61BDHH 00536000
         TM    IJBFLG08,IJBNOPDS  SYSTEM WITH A  PDS?          @D61BDHH 00537000
         BZ    MCVALF10           ..YES, CONTINUE              @D61BDHH 00538000
         SPACE 1                                               @D61BDHH 00539000
         OI    MCTMPMS1,MCST$NVS  REQUEST MSG 0T27E            @D61BDHH 00540000
         L     R5,IJBVSIZE        GET VSIZE VALUE (IN K-BYTES) @D61BDHH 00541000
         SRL   R5,PNSHIFT-10      CALC NUMBER OF PAGES         @D61BDHH 00542000
         BCTR  R5,0               REDUCE BY ONE PAGE           @D61BDHH 00543000
         SLL   R5,PNSHIFT-10      CALC NEW VSIZE VALUE         @D61BDHH 00544000
         ST    R5,IJBVSIZE        SET NEW VSIZE VALUE          @D61BDHH 00545000
         L     R7,IJBSMCOM        GET SMCOM ADDRESS            @D61BDHH 00546000
         USING SMCOM,R7           BASE SMCOM                   @D61BDHH 00547000
         L     R7,SMALCVSZ        GET ALLOC. PART. STORAGE SIZE@D61BDHH 00548000
         DROP  R7                                              @D61BDHH 00549000
         L     R8,IJBDSICB        GET ADDR OF DSPACE INFO BLOCK@D61BDHH 00550000
         LTR   R8,R8              DSPACE SUPPORT AVAILABLE?    @D61BDHH 00551000
         BZ    MCNPDS10           .. NO                        @D61BDHH 00552000
         USING DSINFOTB,R8        BASE DSPACE INFO BLOCK       @D61BDHH 00553000
         L     R8,DSSAVSIZ        GET ACTUAL DSPACE ALLOCAT.   @D61BDHH 00554000
         DROP  R8                                              @D61BDHH 00555000
         AR    R7,R8              CALC SUM OF ALLOC. STORAGE   @D61BDHH 00556000
MCNPDS10 CR    R5,R7              COMPARE NEW VSIZE WITH THIS  @D61BDHH 00557000
         BNL   MCSTORND           STILL HIGH OR EQUAL, OK      @D61BDHH 00558000
         MVI   IJBHWORG,HWORG236  SET HW ORIGINATOR CODE       @D61BDHH 00559000
         B     MCSTORNX           NEW VSIZE IS LOWER -> HW     @D61BDHH 00560000
         SPACE 2                                               @D61BDHH 00561000
* -----------------------------------------------------------  @DA41332 00562000
*         HANDLE FSA IN PFIX-24 AREA                           @DA41332 00563000
* -----------------------------------------------------------  @DA41332 00564000
MCVALF10 L     R8,IJBSMCOM        GET A(SMCOM)                 @D61BDHH 00565000
         USING SMCOM,R8                                        @DA41332 00566000
         C     R3,SMCRBG1         FSA IN PFIX-24 AREA?         @DA41332 00567000
         BL    MCSTORNX           .. BELOW, SHOULD NOT OCCUR   @DA41332 00568000
         C     R3,SMCRND1         FSA IN PFIX-24 AREA?         @DA41332 00569000
         BH    MCVALF40           .. NO, CHECK ALLOCR AREA     @DA41332 00570000
         L     R7,IJBCLIM         GET CLASS LIMITS             @DA41332 00571000
         USING CLIM,R7                                         @DA41332 00572000
         LH    R7,CSPART          GET NUMBER(POSSIBLE PARTS)   @DA41332 00573000
         DROP  R7                 DROP CLIM BASE               @DA41332 00574000
         L     R9,APCBATAB        GET ADDR OF PCBATAB          @DA41332 00575000
MCVALF20 L     R5,0(,R9)          GET A(PCB)                   @DA41332 00576000
         LTR   R5,R5              ADDRESS > 0 ?                @DA41332 00577000
         BZ    MCVALF35           .. NO, CHECK NEXT PCB        @DA41332 00578000
         USING PCBADR,R5                                       @DA41332 00579000
         L     RC,SMAXPFIX        LOAD SMAXPFIX                @DA41332 00580000
         C     RC,SMPFIX          FIX COUNT: MAX > ACT.?       @DA41332 00581000
         BNH   MCVALF35           .. NO, CHECK NEXT PCB        @DA41332 00582000
         BCTR  RC,0               REDUCE BY ONE                @DA41332 00583000
         ST    RC,SMAXPFIX        AND RESTORE                  @DA41332 00584000
         L     RC,SMCPFX1         NUM (AVAIL. FRAMES IN AREA)  @DA41332 00585000
         BCTR  RC,0               REDUCE BY ONE                @DA41332 00586000
         ST    RC,SMCPFX1         AND RESTORE                  @DA41332 00587000
         OI    MCTMPMS1,MCST$PFR  REQUEST MSG 0T20E            @DA41332 00588000
         L     RC,ASYSPCB         GET A(SYSPCB)                @DA41332 00589000
         C     RC,0(,R9)          WAS SYSTEM COUNT REDUCED?    @DA41332 00590000
         BE    MCSTORND           ..YES, MSG BYTE COMPLETE     @DA41332 00591000
         OI    MCTMPMS1,MCST$PAR  ..NO, REQUEST PART-ID INSERT.@DA41332 00592000
         MVC   MCTMPLOG,PCELID     MOVE SYSLOGID               @DA41332 00593000
         B     MCSTORND                                        @DA41332 00594000
MCVALF35 LA    R9,4(,R9)          GOTO NEXT PCB ADDRESS        @DA41332 00595000
         BCT   R7,MCVALF20        PROCESS IT (IF ANY MORE TODO)@DA41332 00596000
         B     MCSTORND           NO MORE PCB ADDRS, LEAVE     @DA41332 00597000
         DROP  R5                 DROP PCB BASE                @DA41332 00598000
         SPACE 1                                               @DA41332 00599000
* -----------------------------------------------------------  @DA41332 00600000
*         HANDLE FSA IN ALLOCR  AREA                           @DA41332 00601000
* -----------------------------------------------------------  @DA41332 00602000
MCVALF40 C     R3,SMCRND2         FSA IN ALLOCR AREA?          @DA41332 00603000
         BH    MCVALF70           .. NO, CHECK PFIX-31 AREA    @DA41332 00604000
         LH    R7,IJBNPART        LOOP OVER STATIC PARTS       @DA41332 00605000
         L     R9,APCBATAB        GET ADDR OF PCBATAB          @DA41332 00606000
MCVALF50 LA    R9,4(,R9)          SKIP SYSTEM PCB              @DA41332 00607000
         L     R5,0(,R9)          GET A(PCB)                   @DA41332 00608000
         USING PCBADR,R5                                       @DA41332 00609000
         C     R3,SMRPBEG         FSA IN STATIC PART           @DA41332 00610000
         BL    MCVALF60           .. NO, NEXT PART             @DA41332 00611000
         C     R3,SMRPEND         FSA IN STATIC PART           @DA41332 00612000
         BNL   MCVALF60           .. NO, NEXT PART             @DA41332 00613000
         OI    MCTMPMS1,MCST$ALI  REQUEST MSG 0T19E            @DA41332 00614000
         MVC   MCTMPLOG,PCELID    MOVE SYSLOGID                @DA41332 00615000
         B     MCSTORND                                        @DA41332 00616000
MCVALF60 BCT   R7,MCVALF50        CHECK NEXT STATIC PART       @DA41332 00617000
         B     MCSTORND                                        @DA41332 00618000
         DROP  R5                 DROP PCB BASE                @DA41332 00619000
         SPACE 1                                               @DA41332 00620000
* -----------------------------------------------------------  @DA41332 00621000
*         HANDLE FSA IN PFIX-31 AREA                           @DA41332 00622000
* -----------------------------------------------------------  @DA41332 00623000
MCVALF70 C     R3,SMCRND3         FSA IN PFIX-31-AREA          @DA41332 00624000
         BH    MCSTORNX           .. HIGHER, SHOULD NOT OCCUR  @DA41332 00625000
         L     R7,IJBCLIM         GET CLASS LIMITS             @DA41332 00626000
         USING CLIM,R7                                         @DA41332 00627000
         LH    R7,CSPART          NUM(POSSIBLE PARTITIONS)     @DA41332 00628000
         DROP  R7                 DROP CLIM BASE               @DA41332 00629000
         L     R9,APCBATAB        GET ADDR OF PCBATAB          @DA41332 00630000
MCVALF80 L     R5,0(,R9)          GET A(PCB)                   @DA41332 00631000
         LTR   R5,R5              ADDRESS > 0 ?                @DA41332 00632000
         BZ    MCVALF95           .. NO, CHECK NEXT PCB        @DA41332 00633000
         USING PCBADR,R5                                       @DA41332 00634000
         L     RC,SMAXPFX3        LOAD SMAXPFIX                @DA41332 00635000
         C     RC,SMPFIX3         FIX COUNT: MAX > ACT.?       @DA41332 00636000
         BNH   MCVALF95           .. NO, CHECK NEXT PCB        @DA41332 00637000
         BCTR  RC,0               REDUCE BY ONE                @DA41332 00638000
         ST    RC,SMAXPFX3        AND RESTORE                  @DA41332 00639000
         L     RC,SMCPFX3         NUM(AVAIL. FRAMES IN AREA )  @DA41332 00640000
         BCTR  RC,0               REDUCE BY ONE                @DA41332 00641000
         ST    RC,SMCPFX3         AND RESTORE                  @DA41332 00642000
         OI    MCTMPMS1,MCST$PFR  REQUEST MSG 0T20E            @DA41332 00643000
         OI    MCTMPMS1,MCST$31   PFIX(ABOVE) COUNT REDUCED    @DA41332 00644000
         L     RC,ASYSPCB         GET A(SYSPCB)                @DA41332 00645000
         C     RC,0(,R9)          WAS SYSTEM COUNT REDUCED?    @DA41332 00646000
         BE    MCSTORND           ..YES, MSG BYTE IS COMPLETE  @DA41332 00647000
         OI    MCTMPMS1,MCST$PAR  REQUEST INSERT OF SYSLOGID   @DA41332 00648000
         MVC   MCTMPLOG,PCELID     MOVE SYSLOGID               @DA41332 00649000
         B     MCSTORND                                        @DA41332 00650000
MCVALF95 LA    R9,4(,R9)          GO TO NEXT PCB ADDRESS       @DA41332 00651000
         BCT   R7,MCVALF80        PROCESS IT (IF ANY MORE TODO)@DA41332 00652000
         B     MCSTORND           NO MORE PCB ADDRS, LEAVE     @DA41332 00653000
         DROP  R5                 DROP BASE OF PCB             @DA41332 00654000
         DROP  R8                 DROP BASE OF SMCOM           @DA41332 00655000
         SPACE 2                                               @DA41332 00656000
MCSTORNX L     R7,RASLINKA        GET ADDRESS OF RASLINK       @D61RDHH 00657000
         OI    MCFLAGS-RASLINK(R7),MCHARD INDIC.HARD WAIT REQ. @D61RDHH 00658000
MCSTORND EQU   *                                                        00659000
*        AMODESW SET,AMODE=24     SET 24-BIT MODE              @DA41332 00660000
         AMODESW SET,AMODE=24     SET 24-BIT MODE              @DA41332 00661000
         L     R7,MCSTKQUE        GET A(CURRENT STACK ENTRY)   @DA41332 00662000
         LTR   R7,R7              ANY MC QUEUED?               @DA41332 00663000
         BZ    MCSTORN1           ..NO                         @DA41332 00664000
         USING MCST$DS,R7         BASE MC DSECT                @DA41332 00665000
         MVC   MCST$MS1,MCTMPMS1  MOVE MESSAGE BYTE            @DA41332 00666000
         MVC   MCST$LOG,MCTMPLOG  MOVE SYSLOGID                @DA41332 00667000
         DROP  R7                 DROP MC DSECT BASE           @DA41332 00668000
MCSTORN1 B     MACHHARD           HARD MACHINE CHECK           @DA41332 00669000
         EJECT                                                 @D61RDHH 00670000
***************************************************************@DA41332 00671000
*   MACHINE CHECK POST PROCESSING SOFT ERROR                   @DA41332 00672000
***************************************************************@DA41332 00673000
         SPACE 2                                               @DA41332 00674000
MACHSOFT OI    MCDLYFLG,MCDLYRAS  REQ DELAYED POST OF RASTASK  @DY42754 00675000
         L     R7,RASLINKA                  GET RASLINK ADDR   @D61RDHH 00676000
         OI    MCFLAGS-RASLINK(R7),MCDLYP   REQ DELAYED POST   @D61RDHH 00677000
         LCTL  CRE,CRE,CR14SAV    RELOAD CR14                  @DA41332 00678000
         L     RF,EXTINTP         GET EXTERNAL INT PARAM       @DY46384 00678500
         TM    IJBFLG06,IJBAMODE  DO WE HAVE ACCESS REGS       @DA41332 00679000
         BNO   MCSNOACC           NO, DON'T LOAD ACCESS REG'S  @DA41332 00680000
         LAM   R0,RF,ARSAVE       RESTORE ACCESS REGISTER      @DA41332 00681000
MCSNOACC LM    R0,RE,GRSAVE       RESTORE GREGS EXCEPT RF      @DY46384 00682490
         LD    R0,FPRSAVE         RESTORE FLOATING POINT REG 0 @DA41332 00683000
         LD    R2,FPRSAVE+8       RESTORE FLOATING POINT REG 2 @DA41332 00684000
         LD    R4,FPRSAVE+16      RESTORE FLOATING POINT REG 4 @DA41332 00685000
         LD    R6,FPRSAVE+24      RESTORE FLOATING POINT REG 6 @DA41332 00686000
.*       DEBUG ALLREGS,XXDBGMC    ALL REGS DEBUG (NOT DONE)    @D61DDHH 00687000
         LA    RC,MCOLDP          GET ADDR OF MC OLD PSW       @D61RDHH 00688000
*        TDLOCK FUNC=RELCOND,TYPE=NPRAS,WR1=R1,WR2=R2,INP=RC   @D61RDHH 00689000
         TDLOCK FUNC=RELCOND,TYPE=NPRAS,WR1=R1,WR2=R2,INP=RC   @D61RDHH 00690000
         ST    RF,ASYSCOM         RESTORE EXT INT PARAM        @DY46384 00690500
         LM    R0,RF,GRSAVE       RESTORE GENERAL PURP REGS    @D61RDHH 00691000
         LPSW  MCOLDP             RESUME INTERRUPTED TASK      @DA41332 00692000
         SPACE 1                                               @DA41332 00693000
***************************************************************@DA41332 00694000
*   MACHINE CHECK POST PROCESSING HARD ERROR                   @DA41332 00695000
***************************************************************@DA41332 00696000
         SPACE 2                                               @DA41332 00697000
MACHHARD L     R7,RASLINKA        GET RASLINK ADDRESS          @D61RDHH 00698000
         MVC   ASYSCOM,EXTINTP     RESTORE EXT INT PARAM       @DY46384 00698500
         TM    MCFLAGS-RASLINK(R7),MCHARD   HARD MACHINE CHECK @D61RDHH 00699000
         BO    EMGEX9             YES, TERMINATE SYSTEM        @DA41332 00700000
         TM    MCOLDP+1,NPBIT     CHECK IF PROBLEM STATE       @DA41332 00701000
         BZ    EMGEX9             NO, TERMINATE SYSTEM         @DA41332 00702000
         SPACE 2                                               @DA41332 00703000
         LCTL  CRE,CRE,CR14SAV    RELOAD CR14                  @DA41332 00704000
         OI    MCDLYFLG,MCDLYRAS  REQ DELAYED POST OF RASTASK  @DY42754 00705000
         OI    MCFLAGS-RASLINK(R7),MCDLYP    REQ DELAYED POST  @D61RDHH 00706000
         LPSW  SOFTPSW            ALLOW HARD MACHINE CHECKS    @D36ZDJR 00707000
         SPACE 1                                               @D36IDJR 00708000
         AIF   (NOT &BGTT).NOTT1  BRANCH IF NO TASK TIMER SUP. @D14BDFR 00709000
MACHTERM TM    ASSFLAG,TTIMESET+TTIMEACT TIMER SET AND ACTIVE  @D14BDFR 00710000
         BZ    MACHTSKT           NO                           @DA41332 00711000
         L     RD,AFLIH           GET BASE FOR FLIH            @DA24055 00712000
         USING FLIH,RD            SET BASE FOR FLIH            @D14BDFR 00713000
         BAL   R9,GENENTTT        HANDLE TASK TIMER            @D14BDDK 00714000
         DROP  RD                 DROP FLIH BASE               @D14BDFR 00715000
MACHTSKT DS    0H                                              @DA41332 00716000
         AGO   .NOTT2                                          @D14BDFR 00717000
.NOTT1   ANOP                                                  @D14BDFR 00718000
MACHTERM DS    0H                                              @DA41332 00719000
.NOTT2   ANOP                                                  @DA41332 00720000
         SGSETUP UPDTIME,NEXTPCB=ASYSPCB,OPTION=OWNER,                 *00721000
               WR1=RC,WR2=R5,WR3=R9                            @DA41332 00722000
         SPACE 2                                               @D14BDWK 00723000
         CLI   RID+D1,DISPID      DISPATCHER INTERRUPTED       @D21MDGN 00724000
         BE    EMGEX9             YES, HARD WAIT               @DA41332 00725000
         TM    IJBFLG06,IJBAMODE  DO WE HAVE ACCESS REGS       @DA41332 00726000
         BNO   MCTNOACC           NO, DON'T LOAD ACCESS REG'S  @DA41332 00727000
         LAM   R0,RF,ARSAVE       RESTORE ACCESS REGISTER      @DA41332 00728000
MCTNOACC LM    R0,RF,GRSAVE       RESTORE GENERAL PURP REGS    @DA41332 00729000
         LD    R0,FPRSAVE         RESTORE FLOATING POINT REG 0 @DA41332 00730000
         LD    R2,FPRSAVE+8       RESTORE FLOATING POINT REG 2 @DA41332 00731000
         LD    R4,FPRSAVE+16      RESTORE FLOATING POINT REG 4 @DA41332 00732000
         LD    R6,FPRSAVE+24      RESTORE FLOATING POINT REG 6 @DA41332 00733000
         STM   R9,RD,ERA          SAVE R9-RD                   @DA41332 00734000
         L     RD,AFLIH           GET BASE FOR FLIH            @D14BDFR 00735000
         USING FLIH,RD            SET BASE FOR FLIH            @D14BDFR 00736000
         L     RB,MCIC            RB=1ST WORD OF INT.CODE      @D36IDJR 00737000
         LA    RC,MCOLDP          INDICATE MC-INTERRUPT        @D36IDJR 00738000
         BAL   R9,GENENT          SAVE INT. STATUS             @D36IDJR 00739000
         SPACE 1                                               @DA41332 00740000
         DROP  RD                 FORGET BASE FOR FLIH         @D36IDJR 00741000
         SPACE 2                                               @D36IDJR 00742000
         L     R6,DISPAD          GET DISPATCHER BASE          @DA41332 00743000
         USING DISP,R6            DISPATCHER BASE              @DA41332 00744000
.*       DEBUG ALLREGS,XXDBGMC    (NOT DONE)                   @D61DDHH 00745000
         B     ERR1F              CANCEL TASK                  @DA41332 00746000
         SPACE 1                                               @D149DWK 00747000
         DROP  R6                 RELEASE DISPATCHER BASE      @DA41332 00748000
         SPACE 2                                               @D36ZDJR 00749000
* EXIT FOR UNRECOVERABLE MACHINE CHECK.                        @D36ZDJR 00750000
* BYTE 1 OF LOWCORE = A                                        @D36ZDJR 00751000
         SPACE 1                                               @D219DGN 00752000
EMGEX9   MVI   SYSS00,C'A'        SET LOWCORE INDICATION       @D14ADWK 00753000
         MVI   SYSS00+1,X'00'     CLEAR UNUSED BYTE 1          @D14ADWK 00754000
         MVI   SYSS00+2,C'A'      RECORDING UNSUCCESSFULL      @DA31910 00755000
         SPACE 1                                               @DA41332 00756000
         CLC   TID,ARTIDH         SYSTEM TASK AFFECTED?        @D66GDHH 00757000
         BNL   EMGEX9A            ..NO, CONTINUE RAS HARDWAIT  @DA41332 00758000
.*       MVI   IJBHWORG,HWORGNNN                               @DA41332 00759000
         B     RASCTHW            GO TO CENTRAL HARD WAIT      @DA41332 00760000
         SPACE 1                                               @DA41332 00761000
EMGEX9A  L     R6,DISPAD          GET DISPATCHER BASE          @DA41332 00762000
         USING DISP,R6            DISPATCHER BASE              @DA41332 00763000
         L     R7,RASLINKA        GET ADDRESS OF RASLINK       @D61RDHH 00764000
         OI    RASFLAGS-RASLINK(R7),RASEMGEX  SET MC EM.EXIT   @D61RDHH 00765000
         MVI   MCNPSW+3,ZERO      INDICATE: MACHINE CHECK      @D36ZDJR 00766000
         BAL   R7,CCPSTRAS        POST RAS TASK READY          @D14BDAP 00767000
         CLI   RID+D1,DISPID      DISPATCHER INTERRUPTED       @D21MDGN 00768000
         BER   R6                 YES, GO TO DISPATCHER        @D21MDGN 00769000
         TM    MCOLDP+1,WAITBIT+NPBIT FROM ALLBOUND            @D21MDGN 00770000
         BOR   R6                 YES, GO TO DISPATCHER        @D21MDGN 00771000
         LM    R0,RF,GRSAVE       RESTORE INT. REGISTERS       @D21MDGN 00772000
         STM   R9,RD,ERA          SAVE R9-RD                   @D21MDGN 00773000
         L     RD,AFLIH           GET BASE FOR FLIH            @D21MDGN 00774000
         USING FLIH,RD            SET BASE FOR FLIH            @D21MDGN 00775000
         L     RA,MACHIND         RA=MACHINE CHECK INDICATOR   @DA39471 00776000
         LA    RC,MCOLDP          INDICATE MC-INTERRUPT        @D21MDGN 00777000
         BAL   R9,TIGENENT        SAVE INT. STATUS             @DA39471 00778000
*SGLINK  TIGENENT,INPUT=(R9,RA,RC,RD),WORK=(RA,RB),OUTPUT=R6   @DA39471 00779000
         DROP  RD                 FORGET BASE FOR FLIH         @D21MDGN 00780000
         L     R5,ASRQTAB         GET ADDRESS OF SRQTAB        @D61RDHH 00781000
         LA    R5,SRQSYS-SRQTAB(,R5) DEACTIVATE TASK           @D61RDHH 00782000
         LR    RF,R6              RETURN TO DISP AFTER UNPOST  @D21MDGN 00783000
.*       DEBUG ALLREGS,XXDBGMC    (NOT DONE)                   @D61DDHH 00784000
         B     UNPOST             SET MC. CH. PART. NONDISP    @D21MDGN 00785000
         SPACE 1                                               @D149DWK 00786000
         DROP  R6                 RELEASE DISPATCHER BASE      @DA41332 00787000
         EJECT                                                 @D149DWK 00788000
************************************************************** @D519DGN 00789000
*        MACHINE CHECK ENQUEUE ROUTINE                       * @D519DGN 00790000
************************************************************** @D519DGN 00791000
         SPACE 2                                               @D31AMTP 00792000
MACHENQ  BALR  RF,0               MACHINE CHECK ENQUEUE ROUT   @DA41332 00793000
         USING *,RF               INFORM ASSEMBLER             @D31AMTP 00794000
         NC    MCSTKBEG,MCSTKBEG  IS STACK INITIALIZED         @DA41332 00795000
         BNZ   MCENQ10            YES,                         @DA41332 00796000
         SPACE 1                                               @DA41332 00797000
*-------------------------------------------------------------*@DA41332 00798000
*        INITIALIZE MACHINE CHECK STACK                        @DA41332 00799000
*-------------------------------------------------------------*@DA41332 00800000
         SPACE 2                                               @DA41332 00801000
         L     R7,RASLINKA        GET ADDRESS OF RASLINK       @D61RDHH 00802000
         L     R7,RASMCSTK-RASLINK(,R7) MC CHECK STACK ADDR.   @D61RDHH 00803000
         LTR   R7,R7              STACK ALREADY ALLOC. BY IPL  @DA41332 00804000
         BNPR  RE                 NO, RETURN                   @DA41332 00805000
         ST    R7,MCSTKBEG        INIT STACK BEGIN ADDRESS     @DA41332 00806000
         ST    R7,MCSTKNXT        INIT NEXT STACK ENTRY TO USE @DA41332 00807000
         LA    R8,MCST$LEN        GET LENGTH OF MC STACK ENTRY @DA41332 00808000
         MH    R8,MCSTKNUM        MULTIPL TIMES NUMB OF STACKS @DA41332 00809000
         AR    R8,R7              GET STACK END ADDRESS + 1    @DA41332 00810000
         ST    R8,MCSTKEND        INIT MC STACK END ADDRESS    @DA41332 00811000
         ST    R8,MCRWSBEG        INIT CRW STACK BEGIN ADDRESS @DA41332 00812000
         ST    R8,MCRWSNXT        INIT NEXT STACK ENTRY TO USE @DA41332 00813000
         LA    R7,MCRW$LEN        GET LENGTH OF CRW STACK ENTR @DA41332 00814000
         MH    R7,MCSTKNUM        MULTIPL TIMES NUMB OF STACKS @DA41332 00815000
         AR    R7,R8              GET STACK END ADDRESS + 1    @DA41332 00816000
         ST    R7,MCRWSEND        INIT CRW STACK END ADDRESS   @DA41332 00817000
MCENQ10  CLC   MCSTKQUE,MCSTKNXT  MC STACK EXHAUSTED           @DA41332 00818000
         BNE   MCENQ20            NO, GO TO ENQUEUE            @DA41332 00819000
         SPACE 1                                               @DA41332 00820000
*-------------------------------------------------------------*@DA41332 00821000
*        MACHINE CHECK STACK EXHAUSTED                         @DA41332 00822000
*-------------------------------------------------------------*@DA41332 00823000
         SPACE 2                                               @DA41332 00824000
         MVI   SYSS00,C'A'        SET LOWCORE INDICATION       @D31AMTP 00825000
         MVI   SYSS00+1,0         CLEAR BYTE                   @D31AMTP 00826000
         MVI   SYSS00+2,C'A'      RECORDING UNSUCCESSFUL       @D31AMTP 00827000
         MVC   SYSS00+4(L'MC$MSG),MC$MSG MOVE IN REASON        @D31AMTP 00828000
         MVI   IJBHWORG,HWORG220  INDICATE TOO MANY MC         @D31AMTP 00829000
         LA    R6,RASWPSW         SUPPORT SPECIAL WAIT PSW     @D31AMTP 00830000
         B     RASCTHW            GO TO CENTRAL HARD WAIT      @DA41332 00831000
         SPACE 1                                               @DA41332 00832000
MC$MSG   DC    C'MACH CHECK OVERFLOW' LOW CORE MESSAGE         @DA41332 00833000
         DS    0H                                              @DA41332 00834000
         SPACE 1                                               @DA41332 00835000
*-------------------------------------------------------------*@DA41332 00836000
*        ENQUEUE MACHINE CHECK STACK ENTRY                     @DA41332 00837000
*-------------------------------------------------------------*@DA41332 00838000
         SPACE 2                                               @DA41332 00839000
MCENQ20  LA    R7,MCSTKQUE        GET RAS MACH CHECK QUEUE ADD @DA41332 00840000
         USING MCST$DS,R7         ESTABLISH MC STACK ENTR BASE @DA41332 00841000
MCENQ25  NC    MCST$NXT,MCST$NXT  LAST ENTRY IN QUEUE          @DA41332 00842000
         BZ    MCENQ30            YES, ENQUEUE AFTER           @DA41332 00843000
         L     R7,MCST$NXT        GET NEXT QUEUE ENTRY         @DA41332 00844000
         B     MCENQ25            CHECK FOR LAST ENTRY         @DA41332 00845000
MCENQ30  MVC   MCST$NXT,MCSTKNXT  ENQUEUE THIS ENTRY           @DA41332 00846000
         L     R7,0(R7)           GET CURRENT QUEUE ADDRESS    @DA41332 00847000
.*       XC    MCST$NXT,MCST$NXT  INDICATE LAST ENTRY IN QUEUE @DA41332 00848000
         LA    R8,MCST$LEN(,R7)   BUMP TO NEXT QUEUE ENTRY     @DA41332 00849000
         CL    R8,MCSTKEND        LAST ENTRY REACHED           @DA41332 00850000
         BL    MCENQ40            NO, CONTINUE                 @DA41332 00851000
         L     R8,MCSTKBEG        WRAP MACHINE CHECK STACK     @DA41332 00852000
         SPACE 1                                               @DA41332 00853000
         DROP  R7                 RELEASE MCH CHECK STACK BASE @DA41332 00854000
         SPACE 1                                               @DA41332 00855000
*-------------------------------------------------------------*@DA41332 00856000
*        STORE MACHINE CHECK INFORMATION INTO CURRENT STACK    @DA41332 00857000
*-------------------------------------------------------------*@DA41332 00858000
         SPACE 2                                               @DA41332 00859000
         USING MCST$DS,R7         ESTABLISH MC STACK ENTR BASE @DA41332 00860000
MCENQ40  DS    0H                                              @DA41332 00861000
         ST    R8,MCSTKNXT        STORE NEXT FREE QUEUE E-ADDR @DA41332 00862000
         MVC   MCST$PIK,PIK       MOVE IN PIK                  @DA41332 00863000
         MVC   MCST$TID,TID       MOVE IN TID                  @DA41332 00864000
         STCK  TODCLOCK           STORE CLOCK AND ...          @DA41332 00865000
         MVC   MCST$TOD,TODCLOCK   MOVE INTO MC STACK          @DA41332 00866000
         SR    R8,R8              CLEAR PTR REG                @DA41332 00867000
         ICM   R8,3,PIK           GET CURRENT PIK              @DA41332 00868000
         SRL   R8,2               GET OFFSET INTO PCBATAB      @DA41332 00869000
         A     R8,APCBATAB         GET PCB TABLE OFFSET        @DA41332 00870000
         L     R8,0(R8)           GET PARTICULAR PCB ADDRESS   @DA41332 00871000
         LTR   R8,R8              PCB ADDRESS                  @DA41332 00872000
         BZ    MCENQ50            NO, USE DEFAULT JOB NAME     @DA41332 00873000
         USING PCBADR,R8          GET PCB BASE                 @DA41332 00874000
         L     R5,PCECOMRA        GET SERVICED OWNER'S COMREG  @DA41332 00875000
         USING COMREG,R5          GET COMREG BASE              @DA41332 00876000
         CLC   PCELID(2),AR       ATTENTION ROUT INTERR        @DA41332 00877000
         BNE   MCENQ60            SET ACTUAL JOB ID PROGR NAME @DA41332 00878000
MCENQ50  MVC   MCST$PRG(8),VSEESA DEFAULT PROGRAM NAME         @DA41332 00879000
         MVC   MCST$JOB(8),VSEESA DEFAULT JOB ID               @DA41332 00880000
         B     MCENQ70            BUILD HEADER                 @DA41332 00881000
         SPACE 1                                               @DA41332 00882000
         DROP  R8                 RELEASE PCB BASE             @DA41332 00883000
         SPACE 1                                               @DA41332 00884000
MCENQ60  MVC   MCST$PRG(8),IJBPHNAM MOVE PROGID INTO STACK     @DA41332 00885000
         MVC   MCST$JOB(8),COMNAME PUT JOB ID INTO STACK       @DA41332 00886000
MCENQ70  MVC   MCST$PSW,MCOLDP    MOVE MACHINE CHECK OLD PSW   @DA41332 00887000
         LA    R1,MCST$IIL        GET HW MC INTERR INFO LENGTH @DA41332 00888000
         LR    R3,R1              COPY LENGTH FOR MVCL INSTR   @DA41332 00889000
         LA    R0,MCST$IC         GET MC INT INFO STCK ADDRESS @DA41332 00890000
         LA    R2,MCIC            GET MC HW INT INFO ADDRESS   @DA41332 00891000
         MVCL  R0,R2              MOVE MC HW INT INFO TO STACK @DA41332 00892000
         BR    RE                 PROCESS MACHINE CHECK        @DA41332 00893000
         SPACE 1                                               @DA41332 00894000
         DROP  R5                 RELEASE COMREG BASE          @DA41332 00895000
         DROP  R7                 RELEASE MCH CHECK STACK BASE @DA41332 00896000
         DROP  RF                 RELEASE MACHENQ ADDRESSAB.   @DA41332 00897000
         SPACE 3                                               @D64IDHH 00898000
***************************************************************@DA41332 00899000
*        RAS MACHINE CHECK CONSTANTS AND WORKAREAS             @DA41332 00900000
***************************************************************@DA41332 00901000
         SPACE 2                                               @DA41332 00902000
AR       DC    C'AR'              SYSLOG ID OF ATTENT ROUTINE  @DA41332 00903000
RASWORK  DC    F'0'               WORKFIELD                    @D35JDJR 00904000
VSEESA   DC    C'VSE/ESA '        DEFAULT JOBNAME              @DA41332 00905000
         SPACE 1                                               @DA41332 00906000
         DS    0D                 DOUBLE WORD ALIGNMENT        @D36ZDJR 00907000
SOFTPSW  DC    X'040C0000'        ALLOW HARD MACHINE CHECKS    @D36ZDJR 00908000
         DC    A(MACHTERM)        CONTINUATION ADDRESS         @DA41332 00909000
         TITLE 'VSE/AF SUPERVISOR   MCRAS   ALLBOUND PROCESSING '       00910000
         EJECT                                                 @DY42754 00911000
***************************************************************@DY42754 00912000
***************************************************************@DY42754 00913000
*        D I S P A T C H E R    A P P E N D A G E              @DY42754 00914000
***************************************************************@DY42754 00915000
***************************************************************@DY42754 00916000
         SPACE 2                                               @DY42754 00917000
MACHALLB L     RB,RASLINKA            GET ADDRESS OF RASLINK   @D61RDHH 00918000
         TM    MCFLAGS-RASLINK(RB),MCDLYP+MCCRWP  ALLB.PR.REQ? @D61RDHH 00919000
         L     RB,RASBASE-RASLINK(,RB) RELOAD BASE ADDRESSS    @D61RDHH 00920000
         BZR   R7                 ..NO, RETURN TO DISP-ALLBOUND@DY42754 00921000
         STM   R0,RF,MCALLBSV     ..YES, SAVE ALL REGISTERS    @DY42754 00922000
         L     RB,RASLINKA            GET ADDRESS OF RASLINK   @D61RDHH 00923000
         TM    MCFLAGS-RASLINK(RB),MCDLYP   DLY MC PR.REQ?     @D61RDHH 00924000
         L     RB,RASBASE-RASLINK(,RB) RELOAD BASE ADDRESS     @D61RDHH 00925000
         BNO   MCALLBNX           ..NO, CHECK FOR OTHER WORK   @DY42754 00926000
         SPACE 1                                               @DY42754 00927000
***************************************************************@DY42754 00928000
*        DELAYED MC PROCESSING                                 @DY42754 00929000
***************************************************************@DY42754 00930000
         SPACE 1                                               @DY42754 00931000
MCDLY00  L     RA,AMCHSRDA        SET ROUTINE AND DATA BASE    @DY42754 00932000
         USING MACHSRDA,RA        BASE FOR MC SUBROUT AND DATA @DY42754 00933000
         TM    MCDLYFLG,MCDLYRAS  POST RAS TASK REQUEST?       @DY42754 00934000
         BZ    MCDLY20            .. NO,CHECK FOR NEXT REQUEST @D64ADHH 00935000
*--------------------------------------------------------------@DY42754 00936000
*        POST RAS TASK                                         @DY42754 00937000
*--------------------------------------------------------------@DY42754 00938000
         NI    MCDLYFLG,XFF-MCDLYRAS ..YES, RESET FLAG         @DY42754 00939000
         BAL   R7,CCPSTRAS         AND POST RAS                @DY42754 00940000
         OI    MCDLYFLG,MCPSTDON   NOTE POSTING DONE           @DY42754 00941000
         SPACE 1                                               @D219DGN 00942000
MCDLY20  TM    MCDLYFLG,MCDLYSPD  POST SERVICE PROCESSOR TASK  @DY42754 00943000
         BZ    MCDLYEND           ..NO, END DELAYED MC PROC.   @DY42754 00944000
*--------------------------------------------------------------@DY42754 00945000
*        POST SERVICE PROCESSOR TASK                           @DY42754 00946000
*--------------------------------------------------------------@DY42754 00947000
         NI    MCDLYFLG,XFF-MCDLYSPD ..YES, RESET FLAG         @DY42754 00948000
         L     R7,ASPDTTAB        GET ADDRESS OF SPDT TABLE    @DY42754 00949000
         USING SPDTTAB,R7         SPDT BASE                    @DY42754 00950000
         OI    SPSGFLG2,SPSGSTIX  SET SPDT TASK ACTIVE         @DY42754 00951000
         OI    SPSGECB+2,X'80'    POST WAIT BIT IN WOEECB      @DY42754 00952000
         L     R8,ASPTTIB         LOAD SPDT TIB ADDRESS        @DY42754 00953000
         DROP  R7                 RELEASE SPDT BASE            @DY42754 00954000
         L     R6,DISPAD          GET DISPATCHER BASE          @DY42754 00955000
         USING DISP,R6            DISPATCHER BASE              @DY42754 00956000
         BAL   RF,POST            POST SPDT TASK               @DY42754 00957000
*SGLINK  POST,INPUT=(R6,R8,RF),WORK=(RE)                       @DY42754 00958000
         DROP  R6                 RELEASE DISPATCHER BASE      @DY42754 00959000
         OI    MCDLYFLG,MCPSTDON  NOTE POSTING DONE            @DY42754 00960000
         SPACE 1                                               @DY42754 00961000
MCDLYEND L     R7,RASLINKA        GET ADDRESS OF RASLINK       @D61RDHH 00962000
         NI    MCFLAGS-RASLINK(R7),XFF-MCDLYP RESET DELAY-     @D61RDHH 00963000
*                                 PROCESSING-FLAG              @D61RDHH 00964000
*--------------------------------------------------------------@DY42754 00965000
*        OTHER ALLBOUND PROCESSING REQUIRED?                   @DY42754 00966000
*--------------------------------------------------------------@DY42754 00967000
MCALLBNX L     R7,RASLINKA        GET ADDRESS OF RASLINK       @D61RDHH 00968000
         TM    MCFLAGS-RASLINK(R7),MCCRWP  CRW PENDING?        @D61RDHH 00969000
         BO    MCCRWALB           ..YES, PROCESS               @DY42754 00970000
MCALBEND LM    R0,RF,MCALLBSV     RESTORE DISP REGISTERS       @DY42754 00971000
         TM    MCDLYFLG,MCPSTDON  WAS ANY POSTING DONE?        @DY42754 00972000
         MVI   MCDLYFLG,X00       CLEAR FLAG BYTE              @DY42754 00973000
         BZR   R7                 ..NO,RETURN TO DISP-ALLBOUND @DY42754 00974000
         L     R6,DISPAD          ..YES,LOAD DISPATCHER BASE   @DY42754 00975000
         BR    R6                 GO TO DISPATCHER             @DY42754 00976000
         SPACE 2                                               @DY42754 00977000
MCALLBSV DC    16F'0'             REGISTER SAVE AREA R0 - R15  @DY42754 00978000
         SPACE 2                                               @DY42754 00979000
*--------------------------------------------------------------@DY42754 00980000
*        FLAG BYTE FOR DELAYED MC PROCESSING                   @DY42754 00981000
*--------------------------------------------------------------@DY42754 00982000
         SPACE 1                                               @DY42754 00983000
MCDLYFLG DC    X'00'              FLAGS FOR DELAYED MC HANDLING@DY42754 00984000
MCDLYRAS EQU   X'80'              POST RAS-TASK                @DY42754 00985000
*        EQU   X'40'              RESERVED                     @D64ADHH 00986000
MCDLYSPD EQU   X'20'              POST SERVICE PROCESSOR TASK  @DY42754 00987000
MCPSTDON EQU   X'01'              ANY POSTING DONE IN ALLBOUND @DY42754 00988000
         SPACE 1                                               @DY42754 00989000
         TITLE 'VSE/AF SUPERVISOR   MCRAS   CRW PROCESSING '            00990000
         EJECT                                                 @D61RDHH 00991000
***************************************************************@D529DGN 00992000
*        DISPATCHER APPENDAGE                                  @D529DGN 00993000
*        FOR CHANNEL REPORT WORD PROCESSING.                   @D529DGN 00994000
*        PROCESS ALL HARDWARE STACKED CRW'S.                   @D529DGN 00995000
***************************************************************@DA41332 00996000
         SPACE 2                                               @DA41332 00997000
MCCRWALB L     RA,AMCHSRDA        SET ROUTINE AND DATA BASE    @DY42754 00998000
         USING MACHSRDA,RA        BASE FOR MC SUBROUT AND DATA @DA41332 00999000
MCALLB00 CLC   MCSTKQUE,MCSTKNXT  MC STACK FULL ?              @DY42887 01000000
         BE    MACHDSPX           ..YES, LEAVE CRWS AT HW/VM   @DY42887 01001000
         CLC   MCRWSQUE,MCRWSNXT  CRW STACK EXHAUSTED          @DY42887 01002000
         BNE   MCALLB10           NO, GO TO ENQUEUE            @DA41332 01003000
.*       B     MCRWSEXH           HARDWAIT, STACK EXHAUSTED    @DA41332 01004000
.*       B     EMGEX9             NO                           @DELETE  01005000
         B     MACHDSPX           ..YES, RETURN TO MACHALLB    @DA41332 01006000
MCALLB10 L     R7,RASLINKA        RESET CRW PROCESSING REQUIR. @D61RDHH 01007000
         NI    MCFLAGS-RASLINK(R7),XFF-MCCRWP   ... INDICATION @D61RDHH 01008000
         LA    R7,MCRWSQUE        GET RAS CRW QUEUE ADDRESS    @DA41332 01009000
         USING MCRW$DS,R7         ESTABLISH CRW STACK BASE     @DA41332 01010000
MCALLB20 NC    MCRW$NXT,MCRW$NXT  LAST ENTRY IN QUEUE          @DA41332 01011000
         BZ    MCCREQ00           YES, ENQUEUE AFTER           @DA41332 01012000
         L     R7,MCRW$NXT        GET NEXT QUEUE ENTRY         @DA41332 01013000
         B     MCALLB20           CHECK IF THIS ENTRY FREE     @DA41332 01014000
         SPACE 1                                               @DA41332 01015000
***************************************************************@DA41332 01016000
*        CRW ENQUEUE PROCESSING                                @DA41332 01017000
***************************************************************@DA41332 01018000
         SPACE 2                                               @DA41332 01019000
MCCREQ00 MVC   MCRW$NXT,MCRWSNXT  ENQUEUE THIS ENTRY           @DA41332 01020000
         L     R7,0(R7)           GET CURRENT QUEUE ENTRY ADD  @DA41332 01021000
         LA    R8,MCRW$LEN(,R7)   BUMP TO NEXT QUEUE ENTRY     @DA41332 01022000
         CL    R8,MCRWSEND        LAST ENTRY REACHED           @DA41332 01023000
         BL    MCCREQ10           NO, ENQUEUE                  @DA41332 01024000
         SPACE 1                                               @DA41332 01025000
         DROP  R7                 RELEASE CRW STACK ENTRY BASE @DA41332 01026000
         SPACE 1                                               @DA41332 01027000
         L     R8,MCRWSBEG        GET CRW QUEUE WRAP ADDRESS   @DA41332 01028000
         USING MCRW$DS,R7         ESTABLISH CRW STACK BASE     @DA41332 01029000
MCCREQ10 ST    R8,MCRWSNXT        STORE NEXT FREE QUEUE E-ADDR @DA41332 01030000
         STCK  TODCLOCK           STORE CLOCK AND ...          @DA41332 01031000
         MVC   MCRW$TOD,TODCLOCK   MOVE INTO MC STACK          @DA41332 01032000
         LA    R2,MCRW$FST        GET ADD OF FRST CRW IN STACK @DA41332 01033000
         LA    R8,MCRW$LST        GET ADD OF LAST CRW IN STACK @DA41332 01034000
         BAL   R5,MACHCRSE        SET RECURSIVE RETURN ADDRESS @DA41332 01035000
         LA    R2,MCRW$ELN(,R2)   BUMP TO NEXT CRW IN STACK    @DA41332 01036000
MACHCRSE XC    0(MCRW$ELN,R2),0(R2) CLEAR CRW FOR NEXT ENQUEUE @DA41332 01037000
         STCRW 0(R2)              STORE CHANNEL REPORT WORD    @DA41332 01038000
         BC    3,EMGEX9           SHOULD NOT OCCUR             @DA41332 01039000
         BC    4,MACHCRSD         LAST CRW ENQ, START PROCESS. @DA41332 01040000
         USING MCRW$ADD,R2        GET CRW BASE                 @DA41332 01041000
.*       TM    MCRW$TYP,CRWR      IS OVERFLOW INDICATED        @DA41332 01042000
.*       BO    EMGEX9             YES, TERMINATE SYSTEM        @DA41332 01043000
         CR    R2,R8              CRW STACK FULL ?             @DA41332 01044000
         BLR   R5                 NO, ENQUEUE NEXT CRW         @DA41332 01045000
         OI    MCRW$MS1,MCRW$OFL  INDICATE SOFTWARE OVERFLOW   @DA41332 01046000
MACHCRST STCRW RASWORK            EMPTY HARDWARE CRW STACK     @DA41332 01047000
         BC    3,EMGEX9           SHOULD NOT OCCUR             @DA41332 01048000
         BC    4,MACHCRSD         LAST CRW ENQ, START PROCESS. @DA41332 01049000
         B     MACHCRST           EMPTY HARDWARE CRW'S         @DA41332 01050000
         SPACE 1                                               @DA41332 01051000
         DROP  R2                 RELEASE CRW BASE             @DA41332 01052000
         SPACE 1                                               @DA41332 01053000
***************************************************************@DA41332 01054000
*        CRW DEQUEUE PROCESSING                                @DA41332 01055000
***************************************************************@DA41332 01056000
         SPACE 2                                               @DA41332 01057000
MACHCRSD LA    R2,MCRW$FST        GET FIRST CRW IN STACK       @DA41332 01058000
         LA    R3,MCRW$LST        POINT TO LAST CRW IN STACK   @DA41332 01059000
         ST    R3,MCRWSLST        SAVE LAST CRW IN STACK POINT @DA41332 01060000
         USING MCRW$ADD,R2        GET CRW BASE ADDRESS         @DA41332 01061000
         SPACE 1                                               @DA41332 01062000
         DROP  R7                 RELEASE CRW STACK BASE       @DA41332 01063000
         SPACE 1                                               @DA41332 01064000
MACHCRDQ MVI   CRWTRSC,X'00'      INITIALIZE WORK FIELD        @DA41332 01065000
         MVN   CRWTRSC,MCRW$RSC   EXTRACT CRW REPORTING SOURCE @DA41332 01066000
         CLI   CRWTRSC,CRWRSCSC   RESOURCE SUBCHANNEL          @DA41332 01067000
.*       B     MACHDSPR           YES, =====>   TEMP: POST RAS @DA41332 01068000
         BE    MACHSCH            YES, =====>                  @D61DDHH 01069000
         CLI   CRWTRSC,CRWRSCCP   RESOURCE CHANNEL PATH        @DA41332 01070000
         BE    MACHCHP            YES, =====>                  @DA41332 01071000
         CLI   CRWTRSC,CRWRSCCS   RESOURCE CHANNEL SUBSYSTEM   @DA41332 01072000
         BE    MACHCHS            YES, =====>                  @DA41332 01073000
         CLI   CRWTRSC,CRWRSCCA   RESOURCE CONFIG ALERT FACIL  @DA41332 01074000
*        BE    MACHCAF            YES, =====>                  @DA41332 01075000
         CLI   CRWTRSC,CRWRSCMA   RESOURCE MONITOR ALERT FACIL @DA41332 01076000
*        BE    MACHMAF            YES, =====>                  @DA41332 01077000
*        B     MACHCRWN           SHOULD NOT OCCUR !!!!!!!!!!  @DA41332 01078000
MACHCRWN LA    R2,MCRW$ELN(,R2)   BUMP TO NEXT CRW IN STACK    @DA41332 01079000
         NC    0(MCRW$ELN,R2),0(R2) IS CRW QUEUE LAST ENTRY ?  @DA41332 01080000
         BZ    MACHDSPR           YES, POST RAS AND RETURN     @DA41332 01081000
         C     R2,MCRWSLST        LAST POSSIBLE CRW PROCESSED  @DA41332 01082000
         BNH   MACHCRDQ           NO, PROCESS NEXT CWR         @DA41332 01083000
         SPACE 1                                               @DA41332 01084000
MACHDSPR BAL   R7,CCPSTRAS        ACTIVATE RAS TASK            @DA41332 01085000
         OI    MCDLYFLG,MCPSTDON  NOTE POSTING DONE            @DY42754 01086000
MACHDSPX B     MCALBEND           RETURN TO MACHALLB           @DY42754 01087000
         SPACE 1                                               @DA41332 01088000
         DROP  R2                 RELEASE CRW BASE             @DA41332 01089000
         EJECT                                                 @DA41332 01090000
***************************************************************@DA41332 01091000
*       SUBCHANNEL RESOURCE PROCESSING                         @DA41332 01092000
*        R2 = ADDRESS OF CRW                                   @DA41332 01093000
*        R7 = BAL REGISTER FOR SUBROUTINES                     @DA41332 01094000
*        R3 = ADDRESS OF CURRENT PUB ENTRY                     @DA41332 01095000
*        R4 = ADDRESS OF CURRENT PUBX ENTRY                    @DA41332 01096000
*        R5 = ADDRESS OF CURRENT PUBX VECTOR ENTRY             @DA41332 01097000
***************************************************************@DA41332 01098000
         SPACE 2                                               @DA41332 01099000
         USING MCRW$ADD,R2        GET CRW BASE ADDRESS         @DA41332 01100000
MACHSCH  MVC   CRWTERC,MCRW$ERC   GET CRW ERROR RECOVERY CODE  @DA41332 01101000
         NI    CRWTERC,X'3F'      RESET ANCILLARY REPORT BIT   @DA41332 01102000
         L     R1,XASUBSCH        GET SUBCHANNEL MASK          @DA41332 01103000
         ICM   R1,3,MCRW$RSU      GET SUBCHANNEL NUMBER        @DA41332 01104000
         STSCH RSCHIB             GET SCHIB OF SUBCHANNEL      @DA41332 01105000
         BC    1,MCSCPI40         BRANCH IF SUBCH. NOT KNOWN   @DA44462 01106000
         CLI   CRWTERC,CRWERCAV   ERC AVAILABLE                @DA41332 01107000
         BE    MACHSCAV           YES, =====>                  @DA41332 01108000
         CLI   CRWTERC,CRWERCIP   ERC INST PARMS INITIALIZED   @DA41332 01109000
         BE    MACHSCPI           YES, =====>                  @DA41332 01110000
         CLI   CRWTERC,CRWERCPM   ERC INST PARMS MODIFIED      @DA41332 01111000
         BE    MACHSCPM           YES, =====>                  @DA41332 01112000
         B     MACHCRWN           SHOULD NOT OCCUR !!!!!!!!!!  @DA41332 01113000
         SPACE 1                                               @DA41332 01114000
*--------------------------------------------------------------@DA41332 01115000
*     SUBCHANNEL AVAILABLE                                     @DA41332 01116000
*--------------------------------------------------------------@DA41332 01117000
         SPACE 2                                               @DA41332 01118000
MACHSCAV B     MACHCRWN           CHECK FOR MORE CRW'S         @DA41332 01119000
         SPACE 1                                               @DA41332 01120000
*--------------------------------------------------------------@DA41332 01121000
*     SUBCHANNEL INSTALLED PARAMETER INITIALIZED               @DA41332 01122000
*--------------------------------------------------------------@DA41332 01123000
         SPACE 2                                               @DA41332 01124000
MACHSCPI TM    RSCHFLGS,RSCHV     IS DEVICE NUMBER VALID       @DA41332 01125000
         BZ    MCSCPI40           NO, SET AFFECT. PUBX NOT.OP. @DA44462 01126000
*                                     AND CALL SENSE TASK      @DA44462 01127000
         MVC   MCRW$DVN,RSCHDEVN  DEVICE NUMBER INTO STACK     @DA41332 01128000
         BAL   R7,MACHSCSN        FIND NEW SUBCHANN CURR PUBX  @DA41332 01129000
         USING PUBADR,R3          GET PUB BASE                 @DA41332 01130000
         USING PBXADR,R4          GET PUBX BASE                @DA41332 01131000
         B     MCSCPI10           NOT FOUND, UPDATE NEW SUBCH  @DA41332 01132000
         CLC   PBXCUU(2),IJBCIDEV CUU OF INTEGRATED CONSOLE    @D61CDHH 01133000
         BE    MACHCRWN           .. YES, DO NOT PROCESS CRW   @D61CDHH 01134000
         MVC   PBXSCH,XFFFF       SET SUBCHANN CURR PUBX NOTOP @DA41332 01135000
         BAL   R9,MCSCPSNS        POST SENSE TASK              @DA44462 01136000
MCSCPI10 BAL   R7,MACHSCDV        GET NEW SUBCHANN NEW PUBX    @DA41332 01137000
         B     MACHCRWN           NOT FOUND, CHECK NEXT CRW    @DA41332 01138000
         CLC   PBXCUU(2),IJBCIDEV CUU OF INTEGRATED CONSOLE    @D61CDHH 01139000
         BE    MACHCRWN           .. YES, DO NOT PROCESS CRW   @D61CDHH 01140000
         MVC   PBXSCH,MCRW$RSU    UPDATE NEW SUBCHANNEL        @DA41332 01141000
         TM    RSCHFLGS,RSCHE     SUBCHANNEL ALREADY ENABLED?  @DY45547 01142000
         BO    MACHCRWN           CHECK FOR MORE CRWS          @DY45547 01143000
         CEJECT 5                                              @DY43697 01144000
*---- SET INTERRUPT SUBCLASS AND ENABLE SUBCHANNEL ----------- @DA44462 01145000
         SPACE 1                                               @DA44462 01146000
         OI    RSCHISC,X'18'      SET INTERRUPT SUBCLASS 3     @DA41332 01147000
         OI    RSCHFLGS,RSCHE     ENABLE SUBCHANNEL            @DA41332 01148000
         L     R1,XASUBSCH        GET SUBCHANNEL MASK          @DA41332 01149000
         ICM   R1,3,MCRW$RSU      GET SUBCHANNEL NUMBER        @DA41332 01150000
*        MSCH  RSCHIB             MODIFY SUBCHANNEL            @DA41332 01151000
MCSCPI35 MSCH  RSCHIB             MODIFY SUBCHANNEL            @DA41332 01152000
         BC    2,MCSCPI35         SUBCHANNEL BUSY              @DA41332 01153000
         BAL   R9,MCSCPSNS        POST SENSE TASK              @DA44462 01154000
         B     MACHCRWN           CHECK NEXT CRW               @DA44462 01155000
         SPACE 1                                               @DA41332 01156000
MCSCPI40 BAL   R7,MACHSCSN        FIND AFFECTED SUBCH'S PUB    @DA41332 01157000
         B     MACHCRWN           NOT FOUND, CHECK NEXT CRW    @DA41332 01158000
         MVC   PBXSCH,XFFFF       SET PUBX NOT OPERATIONAL     @DA41332 01159000
         BAL   R9,MCSCPSNS        POST SENSE TASK              @DA44462 01160000
         B     MACHCRWN           CHECK FOR MORE CRW'S         @DA41332 01161000
         SPACE 1                                               @DY43697 01162000
*---- CALL SENSE TASK ---------------------------------------- @DA44462 01163000
         SPACE 1                                               @DA44462 01164000
MCSCPSNS OI    PBXFLAG3,PBXF3INS  ENTRY: DEVICE INSTALL PROC.  @DA44462 01165000
MCSCPSN1 EQU   *                  ENTRY: CALLER SETS REQUEST   @DA44462 01166000
         L     R6,DISPAD          GET DISPATCHER BASE          @DA44462 01167000
         USING DISP,R6            DISPATCHER BASE              @DA41332 01168000
         L     RD,ASNSINIT        ADDRESS OF SENSE SYSTEM TASK @DA41332 01169000
         BAL   R7,SNSACT-SNSINIT(RD) ACTIVATE SENSE TASK       @DA41332 01170000
*SGLINK  SNSACT,INPUT=(R6,R7,RD),WORK=(R8)                     @DA41332 01171000
         DROP  R6                                              @DA41332 01172000
         BR    R9                 RETURN TO CALLER             @DA44462 01173000
         SPACE 1                                               @DA44462 01174000
         DROP  R3                 RELEASE PUB BASE             @DA41332 01175000
         DROP  R4                 RELEASE PUBX BASE            @DA41332 01176000
         SPACE 1                                               @DA41332 01177000
*--------------------------------------------------------------@DA41332 01178000
*     SUBCHANNEL INSTALLED PARAMETER MODIFIED                  @DA41332 01179000
*--------------------------------------------------------------@DA41332 01180000
         SPACE 2                                               @DA41332 01181000
MACHSCPM TM    RSCHFLGS,RSCHV     IS DEVICE NUMBER VALID       @DA41332 01182000
         BZ    MCSCPI40           NO, SET AFFECT. PUBX NOT.OP. @DA44462 01183000
*                                 AND CALL SENSE TASK          @DA44462 01184000
         MVC   MCRW$DVN,RSCHDEVN  DEVICE NUMBER INTO STACK     @DA41332 01185000
         BAL   R7,MACHSCSN        FIND AFFECTED SUBCH'S PUBX   @DA41332 01186000
         USING PUBADR,R3          GET PUB BASE                 @DA41332 01187000
         USING PBXADR,R4          GET PUBX BASE                @DA41332 01188000
         B     MACHCRWN           SHOULD NOT OCCUR !!!!!!!!!!  @DA41332 01189000
         SPACE 1                                               @DA41332 01190000
         CLC   PBXCUU(2),IJBCIDEV CUU OF INTEGRATED CONSOLE    @D61CDHH 01191000
         BE    MACHCRWN           .. YES, DO NOT PROCESS CRW   @D61CDHH 01192000
         XC    PBXPVPEN,PBXPVPEN  CLEAR PATH MASK MODIFIED     @DA41332 01193000
         MVC   MCSCPMPM,RSCHPAM   GET CURRENT PATH MASK BITS   @DA41332 01194000
         XC    MCSCPMPM,PBXPAM    FIND CHANGED PATH MASK BITS  @DA41332 01195000
         OC    PBXPVPEN,MCSCPMPM  ACCUMULATE CHANGED MASK BITS @DA41332 01196000
         MVC   PBXPAM,RSCHPAM     UPDATE PATH AVAILABLE MASK   @DA41332 01197000
         MVC   RSCHPOM,RSCHPAM    SET POM TO CURR AVAIL CHPID'S@DA41332 01198000
         SPACE 1                                               @DA41332 01199000
         MVC   MCSCPMPM,RSCHPIM   GET CURRENT PATH MASK BITS   @DA41332 01200000
         XC    MCSCPMPM,PBXPIM    FIND CHANGED PATH MASK BITS  @DA41332 01201000
         OC    PBXPVPEN,MCSCPMPM  ACCUMULATE CHANGED MASK BITS @DA41332 01202000
         MVC   PBXPIM,RSCHPIM     UPDATE PATH INSTALLED MASK   @DA41332 01203000
         SPACE 1                                               @DA41332 01204000
         MVC   MCSCPMPM,RSCHLPM   GET CURRENT PATH MASK BITS   @DA41332 01205000
         XC    MCSCPMPM,PBXLPM    FIND CHANGED PATH MASK BITS  @DA41332 01206000
         OC    PBXPVPEN,MCSCPMPM  ACCUMULATE CHANGED MASK BITS @DA41332 01207000
.*A26.04 MVC   PBXLPM,RSCHLPM     UPDATE LOGICAL PATH MASK     @DA41332 01208000
         SPACE 1                                               @DA41332 01209000
         MVC   PBXCHPID,RSCHPID0  UPDATE CHPID STRING          @DA41332 01210000
         SPACE 1                                               @DA41332 01211000
         LA    R5,X'80'           GET BIT SELECT POSITION      @DA41332 01212000
         LA    R6,PBXCHPID        POINT TO CORRESP. STRING POS @DA41332 01213000
MCSCPM10 EX    R5,MCSCPMTM        IS IT THIS PATH AFFECTED     @DA41332 01214000
         BO    MCSCPM20           YES, CONTINUE                @DA41332 01215000
         MVI   0(R6),X'FF'        SET CORRESP. CHPID OFFLINE   @DA41332 01216000
MCSCPM20 SRL   R5,1               SHIFT BIT SELECT POSITION    @DA41332 01217000
         LA    R6,1(,R6)          SHIFT TO NEXT CHPID POSITION @DA41332 01218000
         LTR   R5,R5              LAST POSITION TESTED         @DA41332 01219000
         BNZ   MCSCPM10           NO, CHECK NEXT BIT POSITION  @DA41332 01220000
         OI    PBXFLAG3,PBXF3PVT  INDICATE PATH VERIFICATION   @DA41332 01221000
         BAL   R9,MCSCPSN1        POST SENSE TASK              @DA44462 01222000
         B     MACHCRWN           CHECK FOR MORE CRW'S         @DA41332 01223000
         SPACE 1                                               @DA41332 01224000
.* CPM30 BAL   R7,MACHSCSN        FIND AFFECTED SUBCH'S PUB    @DA44462 01225000
.*       B     MACHCRWN           NOT FOUND, CHECK NEXT CRW    @DA44462 01226000
.*       MVC   PBXSCH,XFFFF       SET PUBX NOT OPERATIONAL     @DA44462 01227000
.*       B     MCSCINST           PERFORM INSTALL PROCESSING   @DA44462 01228000
.*       SPACE 1                                               @DA44462 01229000
MCSCPMPM DC    X'00'              PATH MASK WORK FIELD         @DA41332 01230000
         SPACE 1                                               @DA41332 01231000
MCSCPMTM TM    PBXPIM,0           EXECUTE TO COMPARE PIM       @DA41332 01232000
         SPACE 1                                               @DA41332 01233000
         DROP  R2                 RELEASE CRW BASE             @DA41332 01234000
         DROP  R3                 RELEASE PUB BASE             @DA41332 01235000
         DROP  R4                 RELEASE PUBX BASE            @DA41332 01236000
         EJECT                                                 @DA41332 01237000
***************************************************************@DA41332 01238000
*     CHANNEL PATH RESOURCE PROCESSING                         @DA41332 01239000
***************************************************************@DA41332 01240000
         SPACE 2                                               @DA41332 01241000
         USING MCRW$ADD,R2        GET CRW BASE ADDRESS         @DA41332 01242000
MACHCHP  MVC   CRWTERC,MCRW$ERC   GET CRW ERROR RECOVERY CODE  @DA41332 01243000
         NI    CRWTERC,X'3F'      RESET ANCILLARY REPORT BIT   @DA41332 01244000
         SLR   R1,R1              CLEAR REGISTER               @DA41332 01245000
         IC    R1,MCRW$RCP        GET CHPID                    @DA41332 01246000
         CLI   CRWTERC,CRWERCIN   ERC INITIALIZED              @DA41332 01247000
         BE    MACHCPIN           YES, =====>                  @DA41332 01248000
         CLI   CRWTERC,CRWERCTE   ERC TEMPORARY ERROR          @DA41332 01249000
         BE    MACHCPTE           YES, =====>                  @DA41332 01250000
         CLI   CRWTERC,CRWERCTM   ERC TERMINAL CONDITION       @DA41332 01251000
         BE    MACHCPTM           YES, =====>                  @DA41332 01252000
         CLI   CRWTERC,CRWERCPN   ERC PERM ERROR FAC NOT INIT  @DA41332 01253000
         BE    MACHCPPN           YES, =====>                  @DA41332 01254000
         CLI   CRWTERC,CRWERCPI   ERC PERM ERROR FAC INIT      @DA41332 01255000
         BE    MACHCPPI           YES, =====>                  @DA41332 01256000
         B     MACHCRWN           SHOULD NOT OCCUR !!!!!!!!!!  @DA41332 01257000
         SPACE 1                                               @DA41332 01258000
         DROP  R2                 RELEASE CRW BASE             @DA41332 01259000
         EJECT                                                 @DA41332 01260000
*--------------------------------------------------------------@DA41332 01261000
*     CHANNEL PATH INITIALIZED PROCESSING                      @DA41332 01262000
*--------------------------------------------------------------@DA41332 01263000
         SPACE 2                                               @DA41332 01264000
         CNOP  0,4                GET FULL WORD ALIGNMENT      @DA41332 01265000
MACHCPIN BAL   RD,MCCPIN10        GET SAVE AREA ADDRESS        @DA41332 01266000
MCCPINSV DC    A(RSCHIB)          MSCCHPID ROUT SCHIB ADDRESS  @DA41332 01267000
         DC    15F'0'             MSCCHPID SAVE AREA RE - RC   @DA41332 01268000
MCCPIN10 BAL   RE,MSCCHPID        SRCH ALL PUBS WITH SAME CHPID@DA41332 01269000
*SGLINK  MSCCHPID,INPUT=(R1,RD,RE),OUTPUT=(R1,R2,R3,R4,R5,R9)           01270000
         B     MACHCRWN           CHECK FOR MORE CRW'S         @DA41332 01271000
         SPACE 1                                               @DA41332 01272000
***************************************************************@DA41332 01273000
*        EXIT ROUTINE FROM MSCCHPID TO DO FUNCTION ON          @DA41332 01274000
*            CURRENT PUB / PUBX                                @DA41332 01275000
*                                                              @DA41332 01276000
*          INPUT  :  R1 = SUBCHANNEL                           @DA41332 01277000
*                    R2 = SCHIB                                @DA41332 01278000
*                    R3 = PUB HAVING REQUESTED CHPID           @DA41332 01279000
*                    R4 = PUBX HAVING REQUESTED CHPID          @DA41332 01280000
*                    R5 = LOGICAL PATH MASK FOR REQU. CHPID    @DA41332 01281000
*                    R6 = CHPID STRING POSITION WITHIN PUBX    @DA41332 01282000
*                                                              @DA41332 01283000
*                    R1, R2, R3, R9, RC MUST NOT BE DESTROYED  @DA41332 01284000
*                    BY THIS EXIT ROUTINE                      @DA41332 01285000
***************************************************************@DA41332 01286000
         SPACE 2                                               @DA41332 01287000
         USING RSCHIB,R2          GET SCHIB BASE               @DA41332 01288000
         USING PBXADR,R4          BET PUBX BASE                @DA41332 01289000
         MVC   PBXPAM,RSCHPAM     UPDATE PATH AVAIL MASK       @DA41332 01290000
         MVC   RSCHPOM,RSCHPAM    SET POM TO CURR AVAIL CHPID'S@DA41332 01291000
         MVC   PBXPIM,RSCHPIM     UPDATE PATH INST MASK        @DA41332 01292000
.*A26.04 MVC   PBXLPM,RSCHLPM     UPDATE LOGICAL PATH MASK     @DA41332 01293000
         MVC   PBXCHPID,RSCHPID0  UPDATE CHPID STRING          @DA41332 01294000
         LA    R5,X'80'           LOAD PATH MASK FOR SHIFT     @DA41332 01295000
         LA    R6,PBXCHPID        POINT TO CORRESP. STRING POS @DA41332 01296000
MCCPIN20 EX    R5,MCCPIN40        IS SELECT BIT POS SET TO ONE @DA41332 01297000
         BO    MCCPIN30           YES, CONTINUE                @DA41332 01298000
         MVI   0(R6),X'FF'        SET CORRESP. CHPID OFFLINE   @DA41332 01299000
MCCPIN30 SRL   R5,1               SHIFT BIT SELECT POSITION    @DA41332 01300000
         LA    R6,1(,R6)          SHIFT TO NEXT CHPID POSITION @DA41332 01301000
         LTR   R5,R5              LAST POSITION TESTED         @DA41332 01302000
         BNZ   MCCPIN20           NO, CHECK NEXT BIT POSITION  @DA41332 01303000
         OI    PBXFLAG3,PBXF3INS  INDICATE DEVICE INSTALL      @DA41332 01304000
         L     R6,DISPAD          GET DISPATCHER BASE          @DA41332 01305000
         USING DISP,R6            DISPATCHER BASE              @DA41332 01306000
         L     RD,ASNSINIT        ADDRESS OF SENSE SYSTEM TASK @DA41332 01307000
         BAL   R7,SNSACT-SNSINIT(RD) ACTIVATE SENSE TASK       @DA41332 01308000
*SGLINK  SNSACT,INPUT=(R6,R7,RD),WORK=(R8)                     @DA41332 01309000
         LA    RD,MCCPINSV        RESTORE SAVE AREA ADDRESS    @DA41332 01310000
         DROP  R6                                              @DA41332 01311000
         BR    R9                 RETURN TO MSCCHPID           @DA41332 01312000
         SPACE 1                                               @DA41332 01313000
MCCPIN40 TM    PBXPIM,0           EXECUTE TO COMPARE PIM       @DA41332 01314000
         SPACE 1                                               @DA41332 01315000
         DROP  R2                 RELEASE SCHIB BASE           @DA41332 01316000
         DROP  R4                 RELEASE PUBX BASE            @DA41332 01317000
         EJECT                                                 @DA41332 01318000
*--------------------------------------------------------------@DA41332 01319000
*     CHANNEL PATH TEMPORARY ERROR PROCESSING                  @DA41332 01320000
*--------------------------------------------------------------@DA41332 01321000
         SPACE 2                                               @DA41332 01322000
MACHCPTE B     MACHCRWN           CHECK FOR MORE CRW'S         @DA41332 01323000
         SPACE 1                                               @DA41332 01324000
*--------------------------------------------------------------@DA41332 01325000
*     CHANNEL PATH TERMINAL PROCESSING                         @DA41332 01326000
*--------------------------------------------------------------@DA41332 01327000
         SPACE 2                                               @DA41332 01328000
         CNOP  0,4                GET FULL WORD ALIGNMENT      @DA41332 01329000
MACHCPTM BAL   RD,MCCPTM10        GET SAVE AREA ADDRESS        @DA41332 01330000
         DC    A(RSCHIB)          MSCCHPID ROUT SCHIB ADDRESS  @DA41332 01331000
         DC    15F'0'             MSCCHPID SAVE AREA RE - RC   @DA41332 01332000
MCCPTM10 BAL   RE,MSCCHPID        TURN OF LPM BITS IN ALL DEV  @DA41332 01333000
*SGLINK  MSCCHPID,INPUT=(R1,RD,RE),OUTPUT=(R1,R2,R3,R4,R5,R9)           01334000
         B     MCCPTM50           ALL DONE, RESET CHANNEL PATH @DA41332 01335000
         SPACE 1                                               @DA41332 01336000
***************************************************************@DA41332 01337000
*        EXIT ROUTINE FROM MSCCHPID TO DO FUNCTION ON          @DA41332 01338000
*            CURRENT PUB / PUBX                                @DA41332 01339000
*                                                              @DA41332 01340000
*          INPUT  :  R1 = SUBCHANNEL                           @DA41332 01341000
*                    R2 = SCHIB                                @DA41332 01342000
*                    R3 = PUB HAVING REQUESTED CHPID           @DA41332 01343000
*                    R4 = PUBX HAVING REQUESTED CHPID          @DA41332 01344000
*                    R5 = LOGICAL PATH MASK FOR REQU. CHPID    @DA41332 01345000
*                    R6 = CHPID STRING POSITION WITHIN PUBX    @DA41332 01346000
*                                                              @DA41332 01347000
*                    R1, R2, R3, R9, RC MUST NOT BE DESTROYED  @DA41332 01348000
*                    BY THIS EXIT ROUTINE                      @DA41332 01349000
***************************************************************@DA41332 01350000
         SPACE 2                                               @DA41332 01351000
         USING RSCHIB,R2          GET SCHIB BASE               @DA41332 01352000
         USING PUBADR,R3          GET PUB BASE                 @DA41332 01353000
         USING PBXADR,R4          GET PUBX BASE                @DA41332 01354000
         EX    R5,MCPTX10         IS THIS PATH INSTALLED (PIM) @DA41332 01355000
* ===>   BZ    MCCPTM40           NO, DISCONNECT CHPID         @DA41332 01356000
         EX    R5,MCPTX20         IS THIS PATH ENABLED   (LPM) @DA41332 01357000
         BZ    MCCPTM40           NO, DISCONNECT CHPID         @DA41332 01358000
         TM    RSCHSTB3,RSCHSCSP+RSCHACSA+RSCHACDA I/O IN PROG @DA41332 01359000
         BNZ   MCCPTM20           NO, DISCONNECT CHPID         @DA41332 01360000
         TM    RSCHSTB2,RSCHACR+RSCHACS+RSCHACC+RSCHACH        @DA41332 01361000
*                                 ANY ACTIVITY                 @DA41332 01362000
         BZ    MCCPTM40           NO, DISCONNECT CHPID         @DA41332 01363000
         SPACE 1                                               @DA41332 01364000
MCCPTM20 CSCH                     CLEAR SUBCHANNEL             @DA41332 01365000
         SPACE 1                                               @DA41332 01366000
         CLI   PUBCHQPT,NOTQUED   CHANQ ENTRY STILL QUEUED?    @DY45540 01367000
         BE    MCCPTM40           ..NO                         @DY45540 01368000
         SLR   R8,R8              CLEAR FOR INSERT             @DA41332 01369000
         IC    R8,PUBCHQPT        GET LOW BYTE CHANQ INDEX     @DA41332 01370000
         AIF   (&AG1 LE 254).LOWD010                           @DA41332 01371000
         ICM   R8,2,PUBCHQPH      GET HIGH BYTE OF CHANQ INDEX @DA41332 01372000
.LOWD010 ANOP                                                  @DA41332 01373000
         SLL   R8,CHQSLEN         MAKE CHANQ ENTRY DISPLACEMENT@DA41332 01374000
         A     R8,ACHANQ          ADD BASE OF CHQADR           @DA41332 01375000
         ICM   R8,8,H0            CLEAR HIGH ORDER BYTE        @D68REEF 01376000
         USING CHQADR,R8          GET CHANNEL QUEUE ENTRY BASE @DA41332 01377000
         TM    CHQDEV,CHQDASD+CHQFBA IS THIS DASD DEVICE       @DA41332 01378000
         BZ    MCCPTM30           NO, DISCONNECT CHPID         @DA41332 01379000
         TM    CHQCCBB2,CHNBIT    CHANNEL PROGRAM RETRYABLE    @DA41332 01380000
         BO    MCCPTM30           NO, DISCONNECT CHPID         @DA41332 01381000
         NI    CHQCCSIO,XFF-CHQCCACT-CHQCCLTE RESET ACTIVE BIT @DA41332 01382000
         NI    PUBCSFLG,XFF-DEVBSY RESET DEVICE ACTIVE         @DA41332 01383000
         B     MCCPTM40           NO, DISCONNECT CHPID         @DA41332 01384000
MCCPTM30 MVI   CHQIOINF,ERPXER1B  SET RQEUSET TO BE CANCELLED  @DA41332 01385000
         OI    CHQPROC,CHQDOINT   FORCE DELAYED I/O INT PROC   @DA41332 01386000
         OI    CHQCSW+5,X'04'     INDICATE CHANNEL CNTRL CHECK @DA41332 01387000
         OI    CHQCCBB1,DISERR    INDICATE DISASTER ERROR      @DA41332 01388000
         DROP  R8                 RELEASE CHQ QUEUE ENTRY BASE @DA41332 01389000
         SPACE 1                                               @DA41332 01390000
MCCPTM40 X     R5,MCCPTMDM        BUILD MASK TO DISABLE PATH   @DA41332 01391000
         EX    R5,MCPTX30         RESET LOGICAL PATH MASK PUBX @DA41332 01392000
         EX    R5,MCPTX40         RESET PATH AVAIL MASK PUBX   @DA41332 01393000
*        EX    R5,MCPTX50         RESET PATH INST MASK PUBX    @DA41332 01394000
         BR    R9                 RETURN TO MSCCHPID           @DA41332 01395000
         SPACE 1                                               @DA41332 01396000
MCPTX10  TM    PBXPIM,0           EXECUTE TO COMPARE PIM       @DA41332 01397000
MCPTX20  TM    PBXLPM,0           EXECUTE TO COMPARE LPM       @DA41332 01398000
MCPTX30  NI    PBXLPM,0           EXECUTE TO RESET LPM         @DA41332 01399000
MCPTX40  NI    PBXPAM,0           EXECUTE TO RESET PAM         @DA41332 01400000
*CPTX50  NI    PBXPIM,0           EXECUTE TO RESET PIM         @DA41332 01401000
         SPACE 1                                               @DA41332 01402000
*--------------------------------------------------------------@DA41332 01403000
*     RESET CHANNEL PATH FOR RECOVERY                          @DA41332 01404000
*--------------------------------------------------------------@DA41332 01405000
         SPACE 2                                               @DA41332 01406000
MCCPTM50 RCHP                     RESET CHANNEL PATH           @DA41332 01407000
         BC    1,MACHCRWN         CHANNEL PATH NOT OPERATIONAL @DA41332 01408000
         BC    8,MACHCRWN         CHANNEL PATH RESET STARTED   @DA41332 01409000
         LA    R8,1024            AVOID KEEPING CHANNEL ...    @DA41332 01410000
MCCPTM60 BCT   R8,MCCPTM60          SUBSYSTEM BUSY WITH RCHP   @DA41332 01411000
         B     MCCPTM50           TRY AGAIN                    @DA41332 01412000
         SPACE 1                                               @DA41332 01413000
MCCPTMDM DC    F'255'             MASK TO BUILD DISABLE PATH   @DA41332 01414000
         SPACE 1                                               @DA41332 01415000
         DROP  R2                 RELEASE SCHIB BASE           @DA41332 01416000
         DROP  R3                 RELEASE PUB BASE             @DA41332 01417000
         DROP  R4                 RELEASE PUBX BASE            @DA41332 01418000
         EJECT                                                 @DA41332 01419000
*--------------------------------------------------------------@DA41332 01420000
*     CHANNEL PATH PERMANENT ERROR FACILITY NOT INITIALIZED    @DA41332 01421000
*--------------------------------------------------------------@DA41332 01422000
         SPACE 2                                               @DA41332 01423000
MACHCPPN DS    0H                                              @DA41332 01424000
*        B     MACHCPPI           HANDLE LIKE FAC. INITIALIZED @DA41332 01425000
         SPACE 1                                               @DA41332 01426000
*--------------------------------------------------------------@DA41332 01427000
*     CHANNEL PATH PERMANENT ERROR FACILITY INITIALIZED        @DA41332 01428000
*--------------------------------------------------------------@DA41332 01429000
         SPACE 2                                               @DA41332 01430000
         CNOP  0,4                GET FULL WORD ALIGNMENT      @DA41332 01431000
MACHCPPI BAL   RD,MCCPPI10        GET SAVE AREA ADDRESS        @DA41332 01432000
         DC    A(RSCHIB)          MSCCHPID ROUT SCHIB ADDRESS  @DA41332 01433000
         DC    15F'0'             MSCCHPID SAVE AREA RE - RC   @DA41332 01434000
MCCPPI10 BAL   RE,MSCCHPID        SRCH ALL PUBS WITH SAME CHPID@DA41332 01435000
*SGLINK  MSCCHPID,INPUT=(R1,RD,RE),OUTPUT=(R1,R2,R3,R4,R5,R9)           01436000
         B     MACHCRWN           CHECK FOR MORE CRW'S         @DA41332 01437000
         SPACE 1                                               @DA41332 01438000
***************************************************************@DA41332 01439000
*        EXIT ROUTINE FROM MSCCHPID TO DO FUNCTION ON          @DA41332 01440000
*            CURRENT PUB / PUBX                                @DA41332 01441000
*                                                              @DA41332 01442000
*          INPUT  :  R1 = SUBCHANNEL                           @DA41332 01443000
*                    R2 = SCHIB                                @DA41332 01444000
*                    R3 = PUB HAVING REQUESTED CHPID           @DA41332 01445000
*                    R4 = PUBX HAVING REQUESTED CHPID          @DA41332 01446000
*                    R5 = LOGICAL PATH MASK FOR REQU. CHPID    @DA41332 01447000
*                    R6 = CHPID STRING POSITION WITHIN PUBX    @DA41332 01448000
*                                                              @DA41332 01449000
*                    R1, R2, R3, R9, RC MUST NOT BE DESTROYED  @DA41332 01450000
*                    BY THIS EXIT ROUTINE                      @DA41332 01451000
***************************************************************@DA41332 01452000
         SPACE 2                                               @DA41332 01453000
         USING SCHIB,R2           GET SCHIB BASE               @DA41332 01454000
         USING PBXADR,R4          BET PUBX BASE                @DA41332 01455000
         MVC   PBXPAM,RSCHPAM     UPDATE PATH AVAIL MASK       @DA41332 01456000
         MVC   PBXPIM,RSCHPIM     UPDATE PATH INST MASK        @DA41332 01457000
         MVC   PBXCHPID,RSCHPID0  UPDATE CHPID STRING          @DA41332 01458000
         LA    R5,X'80'           LOAD PATH MASK FOR SHIFT     @DA41332 01459000
         LA    R6,PBXCHPID        POINT TO CORRESP. STRING POS @DA41332 01460000
MCCPPI20 EX    R5,MCCPPI40        IS SELECT BIT POS SET TO ONE @DA41332 01461000
         BO    MCCPPI30           YES, CONTINUE                @DA41332 01462000
         MVI   0(R6),X'FF'        SET CORRESP. CHPID OFFLINE   @DA41332 01463000
MCCPPI30 SRL   R5,1               SHIFT BIT SELECT POSITION    @DA41332 01464000
         LA    R6,1(,R6)          SHIFT TO NEXT CHPID POSITION @DA41332 01465000
         LTR   R5,R5              LAST POSITION TESTED         @DA41332 01466000
         BNZ   MCCPPI20           NO, CHECK NEXT BIT POSITION  @DA41332 01467000
         BR    R9                 RETURN TO MSCCHPID           @DA41332 01468000
         SPACE 1                                               @DA41332 01469000
MCCPPI40 TM    PBXPIM,0           EXECUTE TO COMPARE PIM       @DA41332 01470000
         SPACE 1                                               @DA41332 01471000
         DROP  R2                 RELEASE SCHIB BASE           @DA41332 01472000
         DROP  R4                 RELEASE PUBX BASE            @DA41332 01473000
         EJECT                                                 @DA41332 01474000
***************************************************************@DA41332 01475000
*       CHANNEL SUBSYSTEM RESOURCE PROCESSING                  @DA41332 01476000
***************************************************************@DA41332 01477000
         SPACE 2                                               @DA41332 01478000
         USING MCRW$ADD,R2        GET CRW BASE ADDRESS         @DA41332 01479000
MACHCHS  MVC   CRWTERC,MCRW$ERC   GET CRW ERROR RECOVERY CODE  @DA41332 01480000
         NI    CRWTERC,X'3F'      RESET ANCILLARY REPORT BIT   @DA41332 01481000
         CLI   CRWTERC,CRWERCIF   ERC INFORMATION PENDING      @DA41332 01482000
         BE    MACHCSIF           YES, ====>                   @DA41332 01483000
         B     MACHCRWN           SHOULD NOT OCCUR !!!!!!!!!!  @DA41332 01484000
         SPACE 1                                               @DA41332 01485000
*--------------------------------------------------------------@DA41332 01486000
*       CHANNEL SUBSYSTEM INFORMATION PENDING PROCESSING       @DA41332 01487000
*--------------------------------------------------------------@DA41332 01488000
         SPACE 2                                               @DA41332 01489000
MACHCSIF B     MACHCRWN           CHECK FOR MORE CRW'S         @DA41332 01490000
         SPACE 1                                               @DA41332 01491000
         DROP  R2                 RELEASE CRW BASE             @DA41332 01492000
         EJECT                                                 @DA41332 01493000
***************************************************************@DA41332 01494000
*  FIND PUB AND PUBX ENTRY FOR A SUBCHANNEL OR DEVICE NUMBER   @DA41332 01495000
*                                                              @DA41332 01496000
*        INPUT :                                               @DA41332 01497000
*          R2    = ADDRESS OF CRW (SUBCHANNEL NUMBER)          @DA41332 01498000
*                  DEVICE NUMBER (CUU) IN SCHIB                @DA41332 01499000
*        OUTPUT:                                               @DA41332 01500000
*          R3    = ADDRESS OF PUB FOR THIS SUBCHANNEL          @DA41332 01501000
*          R4    = ADDRESS OF PUBX ENTRY FOR THIS SUBCHANNEL   @DA41332 01502000
*          R5    = ADDRESS OF PUBX VECTOR ENTRY FOR THIS SUBCH @DA41332 01503000
*        RETURN:                                               @DA41332 01504000
*          R7        DEVICE NUMBER OR SUBCHANNEL NOT FOUND     @DA41332 01505000
*          R7   +4   DEVICE NUMBER OR SUBCHANNEL FOUND         @DA41332 01506000
*        WORKREGISTER:                                         @DA41332 01507000
*          R1                                                  @DA41332 01508000
***************************************************************@DA41332 01509000
         SPACE 2                                               @DA41332 01510000
         USING MCRW$ADD,R2        GET CRW BASE ADDRESS         @DA41332 01511000
MACHSCSN LA    R1,MPBXCOMP        LOAD ASSOCIATED COMPARE INST @DA41332 01512000
         B     MACHSCPB           DO SCANNING FOR PUB/PUBX     @DA41332 01513000
MACHSCDV LA    R1,MPUBCOMP        LOAD ASSOCIATED COMPARE INST @DA41332 01514000
MACHSCPB L     R5,APBXAREA        GET PUBX POINTERS            @DA41332 01515000
         LTR   R5,R5              PUBX AVAILABLE ?             @DA41332 01516000
         BZR   R7                 NO, SHOULD NOT OCCUR         @DA41332 01517000
         L     R4,0(,R5)          ADDRESS PUBX ENTRY           @DA41332 01518000
         USING PBXADR,R4          GET PUBX BASE                @DA41332 01519000
         LH    R3,YPUBTAB         POINT TO PUB TABLE           @DA41332 01520000
         USING PUBADR,R3          GET PUB BASE                 @DA41332 01521000
MACHSC10 CLI   PUBCHANN,XFF       END OF PUB REACHED ?         @DA41332 01522000
         BER   R7                 YES, ENTRY NOT FOUND         @DA41332 01523000
         EX    R0,0(,R1)          PUB/PUBX FOUND               @DA41332 01524000
         BE    4(R7)              YES, RETURN DO FUNCTION      @DA41332 01525000
         LA    R3,NEXTPUB         GET NEXT PUB ENTRY           @DA41332 01526000
         LA    R5,4(,R5)          GET NEXT PUBX ENTRY          @DA41332 01527000
         L     R4,0(,R5)          ADDRESS NEXT PUBX ENTRY      @DA41332 01528000
         B     MACHSC10           CONTINUE                     @DA41332 01529000
         SPACE 1                                               @DA41332 01530000
MPUBCOMP CLC   PUBCHANN(2),RSCHDEVN COMPARE DEVICE NUMBER      @DA41332 01531000
MPBXCOMP CLC   PBXSCH,MCRW$RSU      COMPARE SUBCHANNEL NUMBER  @DA41332 01532000
         SPACE 1                                               @DA41332 01533000
         DROP  R2                 RELEASE CRW BASE             @DA41332 01534000
         DROP  R3                 RELEASE PUB BASE             @DA41332 01535000
         DROP  R4                 RELEASE PUBX BASE            @DA41332 01536000
         SPACE 1                                               @DA41332 01537000
AMCHSRDA DC    A(MACHSRDA)        MACHK SUBRT AND DATA ADDRESS @DA41332 01538000
CRWTRSC  DS    0C                 INTERMEDIATE WORK FIELD ...  @DA41332 01539000
CRWTERC  DC    X'00'               TO CONTAIN CRW RSC -ERC     @DA41332 01540000
         DROP  RB                 RELEASE MACHINE CHECK BASE   @DA41332 01541000
         TITLE 'VSE/AF SUPERVISOR   MCRAS    CHANNEL CHECK PROCESSING ' 01542000
*********************************************************************** 01543000
*                                                                     * 01544000
*        R E S I D E N T   C H A N N E L    C H E C K   H A N D L E R * 01545000
*                                                                     * 01546000
* FUNCTION                                                            * 01547000
*    DETERMINE THE SEVERITY OF THE CHANNEL CHECK                      * 01548000
*    DETERMINE IF A DAMAGED CHANNEL EXISTS                            * 01549000
*    FIND AND FILL AN ERBLK FOR INITIAL ERRORS                        * 01550000
*    FIND AND POST THE ERBLK FOR RETRY OF CHANNEL ERRORS              * 01551000
*                                                                     * 01552000
*    THIS ROUTINE WILL GAIN CONTROL FROM EITHER THE SIO OR I/O        * 01553000
*    INTERRUPT ROUTINES WHEN A CHANNEL CHECK OCCURS.  THE ECSW        * 01554000
*    IS INSPECTED TO DETERMINE IF ENOUGH INFORMATION IS VALID TO      * 01555000
*    ISOLATE THE DAMAGE TO EITHER A CHANNEL OR A DEVICE.              * 01556000
*                                                                     * 01557000
*    IF THE DAMAGE CANNOT BE ISOLATED TO A DEVICE, THE ENTIRE         * 01558000
*    CHANNEL IS CONSIDERED DAMAGED.  AN ERBLK IS CREATED WITH THE     * 01559000
*    PUB FIELD OF THE ERBLK CONTAINING THE ADDRESS OF THE DAMAGED     * 01560000
*    CHANNEL.  THE CSW AND ECSW ARE SAVED IN THE ERBLK FOR THE        * 01561000
*    NON-RESIDENT CHANNEL CHECK HANDLER.  IF THE DAMAGE CAN BE        * 01562000
*    ISOLATED TO A DEVICE, THE ENTIRE ERBLK IS FILLED FOR THE         * 01563000
*    NON-RESIDENT CHANNEL CHECK HANDLERS.  IN EITHER CASE THE         * 01564000
*    PROPER FLAGS ARE SET TO INITIATE NON-RESIDENT RECORDING AND      * 01565000
*    RETRY FUNCTIONS.                                                 * 01566000
*                                                                     * 01567000
*    THIS ROUTINE WILL INTERCEPT ALL I/O INTERRUPTS WHEN THE RTA      * 01568000
*    HAS AN I/O REQUEST ACTIVE.  IF THE INTERRUPT BELONGS TO THE      * 01569000
*    RTA, THE ERBLK IS FOUND AND POSTED, THE RAS CCB IS DEQUEUED,     * 01570000
*    AND THE USER'S CCB IS REQUEUED TO THE PUB. IF ANOTHER CHANNEL    * 01571000
*    CHECK HAS OCCURRED, THE NORMAL INTERRUPT ROUTINE IS BYPASSED.    * 01572000
*    THIS PREVENTS POSTING OF THE USER'S CCB AND ALLOWS THE RETRY     * 01573000
*    MODULE TO TRY AGAIN UNDER CONTROL OF A RETRY COUNT.  IF THE      * 01574000
*    RETRY WAS SUCCESSFUL, THE INTERRUPT IS PASSED BACK TO THE        * 01575000
*    NORMAL INTERRUPT HANDLER FOR PROCESSING.                         * 01576000
*    IF THE INTERRUPT DOES NOT BELONG TO THE RTA MODULE, THE          * 01577000
*    INTERRUPT IS PASSED BACK TO THE NORMAL INTERRUPT HANDLER.        * 01578000
*                                                                     * 01579000
*    THIS ROUTINE CAN HANDLE 4 DAMAGED DEVICES, OR 1 DAMAGED          * 01580000
*    CHANNEL AND 3 DAMAGED DEVICES AT ONE TIME.  IF 2 CHANNELS        * 01581000
*    BECOME DAMAGED AT ONE TIME OR THE ERBLK QUEUE OVERFLOWS, AN      * 01582000
*    EXIT IS MADE TO THE EMERGENCY EXIT ROUTINE.                      * 01583000
*                                                                     * 01584000
*    RETRY DASD CHANNEL CHECKS BY RESTARTING THE CHAIN OF CCW'S       * 01585000
*    CANCEL PROBLEM PROGRAMS IF RETRY FAILS                           * 01586000
*    GO TO EMERGENCY EXIT ROUTINE IF RETRY OF SUPERVISOR REQUEST FAILS* 01587000
*                                                                     * 01588000
*                    IF THE RETRY COUNT HAS NOT BEEN REACHED AND THE  * 01589000
*    CHANNEL CHECK OCCURRED ON A SIO INSTRUCTION, A BRANCH TO THE SIO * 01590000
*    INSTRUCTION IS TAKEN.  IF THE CHANNEL CHECK OCCURRED AT          * 01591000
*    INTERRUPT TIME A BRANCH TO RESTART THE OPERATION IS TAKEN.       * 01592000
*                                                                     * 01593000
*    IF 10 RETRY ATTEMPTS FAIL, THE TASK IS CANCELLED.  IF THE        * 01594000
*    REQUEST IS OWNED BY THE SUPERVISOR, THE EMERGENCY EXIT ROUTINE   * 01595000
*    IS ENTERED TO TERMINATE THE SYSTEM.  IF THE RETRY ATTEMPT IS     * 01596000
*    SUCCESSFUL, A MESSAGE WILL BE ISSUED AFTER RECORDING THE ERROR   * 01597000
*    TO ALERT THE OPERATOR THAT A SOFT CHANNEL CHECK OCCURRED.        * 01598000
*                                                                     * 01599000
* ENTRY POINTS                                                        * 01600000
*         CCENTRY1 ENTERED ON THE INITIAL DETECTION OF A CHANNEL CHECK* 01601000
*         CCENTRY2 ENTERED AT INTERRUPT TIME WHEN RTA I/O IS ACTIVE   * 01602000
*                  OR AT SIO TIME FOR A CHANNEL CHECK RETRY REQUEST   * 01603000
*                  IF NO CHANNEL CHECK OCCURED                        * 01604000
*         RASDEQ   ENTRY FROM RTA TO DEQUEUE A CCB                    * 01605000
*                                                                     * 01606000
* INPUT                                                               * 01607000
*    CHANNEL STATUS WORD                                              * 01608000
*    INDEPENDANT CHANNEL LOG OUT (ECSW)                               * 01609000
*    I/O OLD PSW                                                      * 01610000
*                                                                     * 01611000
* OUTPUT                                                              * 01612000
*    ERBLK IN RASERCHN                                                * 01613000
*    INDEPENDENT CHANNEL LOG OUT (ECSW) BIT X'80' IN BYTE 0           * 01614000
*                                                                     * 01615000
* EXTERNAL REFERENCES                                                 * 01616000
*                                                              @D149DWK 01617000
*          AREAS :                                             @D149DWK 01618000
*            CCB (USER CCB)                                    @D149DWK 01619000
*            CHANNEL CONTROL TABLE                             @D149DWK 01620000
*            CHANNEL QUEUE TABLE                               @D149DWK 01621000
*            COMREG                                            @D149DWK 01622000
*            CRT TABLE                                         @D149DWK 01623000
*            INDEPENDANT LOG OUT AREA IN LOW CORE              @D149DWK 01624000
*            INTERUPT INFORMATION IN LOW CORE                  @D149DWK 01625000
*            PUB TABLE                                         @D149DWK 01626000
*            PUBX DEVICE ERROR ENTRY                           @D21WDAP 01627000
*            PUB2 TABLE OF FAILING DEVICE                      @D149DWK 01628000
*            RAS LINKAGE AREA IN LOW CORE                      @D149DWK 01629000
*            RAS TABLE IN MCRAS                                @D149DWK 01630000
*            SYSCOM                                            @D149DWK 01631000
*                                                              @D149DWK 01632000
*          ROUTINES :                                          @D149DWK 01633000
*            CQDSP     INITIALIZE CHANNEL SCHEDULER REGISTERS  @D149DWK 01634000
*            INTEQPST  INSERT ERROR ENTRY INTO RAS CHAIN       @D21WDAP 01635000
*                                                                     * 01636000
* EXITS,NORMAL                                                        * 01637000
*         RASRETRN RESUME I/O INTERRUPT PROCESSING                    * 01638000
*         SGSCHED  EXIT TO RESTART CHANNEL                     @DY44201 01639000
*         SIOSTCAW SIO ROUTINE IN THE SUPERVISOR               @D36IDJR 01640000
*         INITSIO  LABEL IN SUPERVISOR TO REISSUE I/O                 * 01641000
*         VIA R8   RETURN TO RTA AFTER DEQUEUE FUNCTION PERFORMED     * 01642000
*         VIA R6   EXIT TO TASK SELECTION                             * 01643000
*                                                                     * 01644000
* EXITS,ERROR                                                         * 01645000
*         EMGEX5   THE ERBLK QUEUE HAS BEEN EXHAUSTED                 * 01646000
*         EMGEX0   EMERGENCY EXIT FOR UNRECOVERABLE ERROR             * 01647000
*         EMGEX8   EMERGENCY EXIT FOR UNRECOVERABLE ERROR             * 01648000
*                                                                     * 01649000
* TABLES/WORK AREAS  NOT APPLICABLE                                   * 01650000
*                                                                     * 01651000
* ATTRIBUTES                                                          * 01652000
*    REENTRANT,DISABLED,PRIVILEGED,RESIDENT                           * 01653000
*                                                                     * 01654000
* CHARACTER CODE DEPENDENCY  NOT APPLICABLE                           * 01655000
*                                                                     * 01656000
* NOTES                                                               * 01657000
*    REGISTER USAGE                                                   * 01658000
*         R1       CCB ADDRESS                                        * 01659000
*         R2       WORK REGISTER                                      * 01660000
*         R3       ADDRESS OF THE PUB                                 * 01661000
*         R4       CHANNEL QUEUE POINTER                              * 01662000
*         R6       ADDRESS OF TASK SELECTION ROUTINE                  * 01663000
*         R7       LINK REGISTER                                      * 01664000
*         R8       LINK AND EXTENDED LOG ADDRESS                      * 01665000
*         R9       BASE ADDRESS OF I/O INTERRUPT HANDLER              * 01666000
*         RC       WORK REGISTER                                      * 01667000
*         RD       BASE ADDRESS OF EXCP ROUTINES                      * 01668000
*         RE       ADDRESS OF ERBLK WORKFIELD                         * 01669000
*         RF       BASE REGISTER                                      * 01670000
*                                                                     * 01671000
*                                                                     * 01672000
*                                                                     * 01673000
* EXITS,NORMAL                                                        * 01674000
*         SIOSTCAW EXIT TO RETRY SIO FAILURE                   @D36IDJR 01675000
*         INITSIO  EXIT TO RETRY INTERRUPT FAILURE                    * 01676000
*         ERR1B    CANCEL ROUTINE IN SUPERVISOR                       * 01677000
*                                                                     * 01678000
* EXITS,ERROR                                                         * 01679000
*         EMGEX0   UNRECOVERABLE CHANNEL CHECK ON PAGING DEVICE OR    * 01680000
*                  CHANNEL                                            * 01681000
*                                                                     * 01682000
*********************************************************************** 01683000
         SPACE 1                                               @D149DWK 01684000
         USING CCBADR,R1          CCB BASE POINTER             @D36IDJR 01685000
.*DEL    USING CHNTBL,R2          CCT TABLE BASE POINTER       @D61SDHH 01686000
         USING PUBADR,R3          PUB BASE POINTER             @D36IDJR 01687000
         USING CHQADR,R4          CHANQ BASE POINTER           @D36IDJR 01688000
         USING INTRTN,R9          IOINTER BASE POINTER         @D35IDAZ 01689000
         SPACE 1                                               @D36IDJR 01690000
***************************************************************@D149DWK 01691000
*        IDENTIFY SEVERITY OF CHANNEL CHECK                    @D149DWK 01692000
***************************************************************@D149DWK 01693000
         SPACE 2                                               @D36IDJR 01694000
         DS    0H                                              @D64ADHH 01695000
         USING *,RB                                            @DA41332 01696000
         SPACE 1                                               @DA41332 01697000
CCENTRY1 DS    0H                                              @D61DDHH 01698000
*        DEBUG ALLREGS,XXDBGMC    ALL REGS DEBUG               @D61DDHH 01699000
         DEBUG ALLREGS,XXDBGMC    ALL REGS DEBUG               @D61DDHH 01700000
         STM   R0,RF,CCHANSAV     SAVE ALL REGS                @D63JDHH 01701000
         L     RA,ACCHSRDA        SET ROUTINE AND DATA BASE    @DA41332 01702000
         USING CCHKSRDA,RA        BASE FOR CC SUBROUT AND DATA @DA41332 01703000
         SPACE 1                                               @DA41332 01704000
         L     RD,RASLINKA        GET ADDR OF RASLINK          @D61RDHH 01705000
         MVI   RASDMC-RASLINK(RD),XFF  RES.DAM.CHANNEL BYTE    @D61RDHH 01706000
         L     RD,IRB$            POINT TO IRB                 @D51ADTP 01707000
         USING IRB,RD             INFORM ASSEMBLER             @D51ADTP 01708000
         MVC   IRBSAV(16),IRB     SAVE FIRST 16 BYTES FROM IRB @D63JDHH 01709000
         TM    IRBSTB0,IRBL       IS LOGOUT INFO PRESENT       @D51ADTP 01710000
         BNO   EMGEX030           HARDWAIT IF NOT              @D51ADTP 01711000
         MVC   EXCSW(4),IRBESW0   MOVE IN ESW                  @D51ADTP 01712000
         DROP  RD                 CANCEL ADDRESSABILTY         @D51ADTP 01713000
         L     RD,AINTEQS         ADDRESS OF ERROR SUBROUTINES @D14BDWK 01714000
         OI    EXCSW,ECSWSTAT     INVALIDATE ECSW FOR NEXT CC  @D14ADWK 01715000
         TM    ECSWVAL,ECSWVCAK   CCW addr valid?              @DY46396 01716020
         BO    CCHAN005           ..yes                        @DY46396 01716040
         XC    CSW(4),CSW         ..no, clear CCW address      @DY46396 01716060
         B     CCHAN010                                        @DY46396 01716080
CCHAN005 TM    IJBFLG0A,IJB31VBE  31-BIT VTAM BUFFERS ENABLED? @DY46396 01716100
         BZ    CCHAN010           .. no, don't need virt addr  @DY46396 01716120
         LTR   R3,R3              PUB address available?       @DY46396 01716140
         BZ    INITLAST           .. no                        @DY46396 01716160
         LTR   R1,R1              CCB available?               @DY46396 01716180
         BZ    CCEXIT20           .. no                        @DY46396 01716200
         LTR   R4,R4              CHANQ Entry avail?           @DY46396 01716220
         BZ    CCEXIT20           .. no                        @DY46396 01716240
         TM    CHQGRP,CHQGRVTM    Owned by VTAM?               @DY46396 01716260
         BNO   CCHAN010           .. no                        @DY46396 01716280
         L     R0,CSW             Load CCW addr from CSW       @DY46396 01716300
         LR    R12,R9             Save Reg 9                   @DY46396 01716320
         L     R9,ACCWT           Set BaseReg for CCWT routinre@DY46396 01716340
         USING CCWTADR,R9                                      @DY46396 01716360
         BAS   R8,CCWVRETR        TRANSLATE TO USERS CCW-ADDR  @DY46396 01716380
*SGLINK CCWVRETR,INPUT=(R0,R1,R3,R8,R9),OUTPUT=(R0,R1)         @DY46396 01716400
.*         VTAM  REAL CCW ADDRESS IS RETURNED IN R0            @DY46396 01716420
.*         VTAM       CCB ADDRESS IS RETURNED IN R1            @DY46396 01716440
         DROP  R9                                              @DY46396 01716460
         LR    R9,R12             Restore Reg 9                @DY46396 01716480
         USING INTRTN,R9          IOINTER BASE POINTER         @DY46396 01716500
         ST    R0,V31VCCWA        Save virtual CCW addr        @DY46396 01716520
CCHAN010 TM    ECSWTSC,ECSWTNOP   INTERFACE INOPERATIVE        @DA31910 01716540
         BO    CCHAN400           YES    ===================>  @DA31910 01717000
         TM    ECSWVAL,ECSWVUNS   VALID UNIT STATUS            @D14BDWK 01719990
         BO    CCHAN020           YES                          @D14BDWK 01722000
         XC    DEVSTA(1),DEVSTA   CLEAR DEVICE STATUS          @D14BDWK 01723000
CCHAN020 DS    0H                 CHECK FOR PUB AND CHANQ      @D51ADTP 01724000
         LTR   R3,R3              PUB ADDRESS EXISTS           @D35EDSK 01725000
         BZ    INITLAST           NO     ==================>>  @D35EDSK 01726000
         LTR   R4,R4              IS THERE A CHANQ ENTRY       @D36ZDJR 01727000
         BZ    CCEXIT20           NO     ===================>  @D14BDAP 01728000
         SPACE 1                                               @D149DWK 01729000
.*DEL    DROP  R2                 RELEASE CCT BASE             @D61SDHH 01730000
         SPACE 1                                               @D149DWK 01731000
***************************************************************@D149DWK 01732000
*        CHANNEL RECOVERY PROCESSING                           @D149DWK 01733000
*         UNIT ADDRESS VALID                                   @D149DWK 01734000
*         SINGLE DEVICE RECOVERY                               @D149DWK 01735000
***************************************************************@D149DWK 01736000
         SPACE 2                                               @D149DWK 01737000
CCHAN100 L     R6,DISPAD          GET DISPATCHER BASE          @DA41332 01738000
         USING DISP,R6            DISPATCHER BASE              @DA41332 01739000
         TM    PUBCSFLG,QEDERR    IS DEVICE QUEUED IN ERROR    @DA41332 01740000
         BOR   R6                 YES, IGNORE 2. CHANNEL CHECK @DY39598 01741000
         SPACE 1                                               @DA41332 01742000
         DROP  R6                 RELEASE DISPATCHER BASE      @DA41332 01743000
         SPACE 1                                               @DA41332 01744000
         TM    CHQGRP,CHQGRRAS    IS THIS A DASD RETRY REQUEST @D14BDAP 01745000
         BO    CCHAN130           YES                          @D14BDAP 01746000
         CLC   CHQTID,RASTIDH     IS THIS A RAS REQUEST        @D66ODOW 01747000
         BNE   CCHAN130           NO   =====================>  @D14BDWK 01748000
         TM    RTAID,RASRTYID     IS IT A RETRY                @DA33850 01749000
         BO    CCEXIT00           YES   ====================>  @DA33850 01750000
         TM    RTAID,RASRECID     IS IT RECORDING REQUEST      @DA33850 01751000
         BZ    CCEXIT00           NO    ====================>  @DA33850 01752000
CCHAN130 LTR   R1,R1              CCB AVAILABLE                @DY41353 01753000
         BNZ   CCHAN140           YES    ===================>  @DY41353 01754000
         CLC   CHQTID,PMRTIDH     UNRECOVERABLE CC ON PAGING   @D66ODOW 01755000
         BE    CCHAN140           YES    ===================>  @DY41353 01756000
         B     CCEXIT00           IGNORE CC AND EXIT           @DY41353 01757000
CCHAN140 BAL   R7,CCERBL00        ALLOCATE AND SET UP ERBLK    @DY41353 01758000
*SGLINK  CCERBL00,INPUT=(R1,R2,R3,R4,R7,R9),OUTPUT=R2,WORK=R8  @D21YDGN 01759000
         LTR   R2,R2              DID RAS GET OR HAVE ERBLK    @D14BDWK 01760000
         BZ    CCEXIT00           NO     ===================>  @D14BDWK 01761000
         BP    CCHAN150           YES  FIRST CC ON THIS DEVICE @D14BDWK 01762000
         LCR   R2,R2              CC ON RETRY,CORR. ERBLK ADDR.@D14BDWK 01763000
         USING ERBLKADR,R2        ERROR ENTRY BASE POINTER     @D21WDAP 01764000
         TM    CCEQMSG,CCHRD      RETRIES ALLREADY DONE        @DY41353 01765000
         BO    CCEXIT20           YES    ===================>  @D14BDWK 01766000
CCHAN150 L     RD,AINTEQS         ADDRESS OF ERROR SUBROUTINES @D14BDWK 01767000
         LTR   R1,R1              CCB AVAILABLE                @D14ZDWK 01768000
         BZ    CCHAN200           NO     ===================>  @D14BDWK 01769000
         CLC   CHQTID,SNSTIDH     IS IT A SENSE TASK REQUEST   @D66ODOW 01770000
         BE    CCHAN240           YES    ===================>  @D14BDWK 01771000
CCHAN160 TM    CCBCOM1,OWNUCRT    USERS OWN ERROR ROUTINE      @D14BDWK 01772000
         BO    CCHAN240           YES    ===================>  @D14BDWK 01773000
         TM    CHQDEV,CHQDASD+CHQFBA IS THIS A DASD OR FBA     @D14BDAP 01774000
         BZ    CCHAN260           NO     ===================>  @D21YDGN 01775000
         TM    CCBCOM2,CHNBIT     CHANNEL PROGRAM RETRIEABLE   @DA33850 01776000
         BO    CCHAN200           NO     ===================>  @DA33850 01777000
         OI    CCEQFLG,CCDSK      SET DASD CHANNEL CHECK       @D21WDAP 01778000
         IC    R7,CHQERRCT        GET RETRY COUNT FROM CHANQ   @D14BDAP 01779000
         LA    R7,D1(R7)          UPDATE THE COUNT             @D14BDAP 01780000
         STC   R7,CHQERRCT        STORE BACK THE UPDATED COUNT @D14BDAP 01781000
         STC   R7,CCEQRTC         STORE BACK THE UPDATED COUNT @D21WDAP 01782000
         CLI   CCEQRTC,DASDCCL    RETRY COUNT EXHAUSTED        @D21WDAP 01783000
         BH    CCHAN200           YES    ===================>  @D14ZDWK 01784000
         OI    CHQGRP,CHQGRRAS    INDICATE RAS RETRY REQUEST   @D14BDAP 01785000
         NI    PUBCSFLG,XFF-DEVBSY RESET DEVICE BUSY           @D14BDWK 01786000
         NI    CHQCCSIO,ZERO      ENSURE DEVICE RESTART        @D14BDAP 01787000
         L     RD,INITBASE        SET UP SCHEDULER BASE        @DA34523 01788000
         USING SGSCHED,RD         SCHEDULER BASE POINTER       @D14BDFG 01789000
.*DEL    L     R8,CHENTAD         SGSCHED NEEDS CCT POINTER    @D61SDHH 01790000
.*DEL    USING CHNTBL,R8          CCT BASE POINTER             @D61SDHH 01791000
.*DEL    OI    CHNTFLG1,CHNRSTRT  ENFORCE RESTART OF CHANNEL   @D61SDHH 01792000
*        DEBUG ALLREGS,XXDBGMC    ALL REGS DEBUG               @D61DDHH 01793000
         DEBUG ALLREGS,XXDBGMC    ALL REGS DEBUG               @D61DDHH 01794000
         B     SGSCHED            GO TO SCHEDULER              @DY44201 01795000
*SGLINK  SGSCHED,INPUT=(R3,R6,RD)                              @DY44201 01796000
         DROP  RD                 RELEASE SCHEDULER BASE       @D14BDFG 01797000
.*DEL    DROP  R8                 RELEASE CCT BASE             @D61SDHH 01798000
         SPACE 1                                               @D36ZDJR 01799000
***************************************************************@D149DWK 01800000
*        THIS ROUTINE IS ENTERED WHEN THE DASD RETRY COUNT     @D149DWK 01801000
*        IS EXHAUSTED, WHEN USER DOES NOT WANT RETRY OR        @D149DWK 01802000
*        NO RETRY POSSIBLE                                     @D219DGN 01803000
***************************************************************@D149DWK 01804000
         SPACE 2                                               @D149DWK 01805000
CCHAN200 OI    CCEQMSG,CCHRD      INDICATE RETRY UNSUCCESSFUL  @D21WDAP 01806000
CCHAN210 CLC   CHQTID,PMRTIDH     UNRECOVERABLE CC ON PAGING   @D66ODap 01807000
         BE    EMGEX020           YES  TERMINATE               @D14BDWK 01808000
CCHAN220 B     CCHAN250           CONTINUE                     @DY43510 01809000
CCHAN240 OI    CCEQMSG,CCERR      INDICATE CHANNEL ERROR       @D21WDAP 01810000
CCHAN250 XC    CCEQRTC,CCEQRTC    RESET RETRY COUNTER          @D21WDAP 01811000
         L     RD,AINTEQS         GET ADDR OF ERROR SUBROUTINES@DY43415 01812000
         USING INTEQSET,RD        ERROR SUBROUTINE BASE        @DY43415 01813000
         BAL   R7,INTEQPST        INSERT ENTRY INTO RAS QUEUE  @D14BDWK 01814000
*SGLINK  INTEQPST,INPUT=(R2,R7,RD),WORK=(R5,R8,RE)             @D149DWK 01815000
         BAL   R7,CCPSTRAS        ACTIVATE RASTASK             @D14BDWK 01816000
         DROP  RD                 RELEASE ERROR SUBROUTINE BASE@D14BDWK 01817000
         SPACE 1                                               @D149DWK 01818000
***************************************************************@D149DWK 01819000
*        COMMON EXIT ROUTINE FOR CHANNEL CHECK PROCESSING      @D149DWK 01820000
***************************************************************@D149DWK 01821000
         SPACE 2                                               @D149DWK 01822000
CCEXIT00 LA    R0,DEVEND          SET DEVICE STATUS BYTE       @D14BDWK 01823000
         LTR   R1,R1              IS CCB STILL AVAILABLE       @D14BDWK 01824000
         BZ    CCEXIT10           NO, JUST IGNORE THE ERROR    @D14BDAP 01825000
         OI    CCBCOM1,DISERR     POST DISASTER ERROR          @D14BDWK 01826000
         TM    CHQCCBB3,APPEN     DOES APPENDAGE EXIT EXIST    @D14BDAP 01827000
         BO    CCEXIT20           YES                          @D14BDWK 01828000
         CLI   PUBDEVTY,TQDIO     IS THIS A QDIO DEVICE ?      @D66GDHH 01829000
         BE    CCEXIT20           YES (DON'T CANCEL)           @DY45789 01830000
         LA    R0,CHANEND+DEVEND  INDICATE CHANNEL+DEVICE END  @D14BDAP 01831000
CCEXIT10 STC   R0,DEVSTA          SET ENDING STATUS            @D14ZDWK 01832000
         NI    CHNSTA,XFF-CHNCHK  CLEAR CHANNEL CHECK IN CSW   @D14ZDWK 01833000
         OI    CHQPROC,CHQDQUNC   DEQUEUE UNCONDITIONAL        @D14BDWK 01834000
         L     R6,DISPAD          GET DISPATCHER BASE          @DA41332 01835000
         USING DISP,R6            DISPATCHER BASE              @DA41332 01836000
         LTR   R1,R1              IS CCB STILL AVAILABLE       @D14BDWK 01837000
         BNZ   ERR1B                     =================>>>  @D14BDAP 01838000
         SPACE 1                                               @DA41332 01839000
         DROP  R6                 RELEASE DISPATCHER BASE      @DA41332 01840000
         SPACE 1                                               @DA41332 01841000
.*DEL    L     R2,CHENTAD         SGSCHED NEEDS CCT POINTER    @D61SDHH 01842000
CCEXIT20 B     RASRETRN                  ==================>>  @D61SDHH 01843000
***************************************************************@D149DWK 01844000
*        NON-DASD CHANNEL CHECK PROCESSING                     @D149DWK 01845000
*         UNIT ADDRESS VALID                                   @D219DGN 01846000
*         SINGLE DEVICE RECOVERY                               @D149DWK 01847000
**************+************************************************@D149DWK 01848000
         SPACE 2                                               @D149DWK 01849000
CCHAN260 TM    CHQCCSIO,CHQCCCSW  CHANNEL CHECK AT SIO TIME    @D21YDGN 01850000
         BZ    CCHAN270           NO                           @D21YDGN 01851000
         OI    CCEQFLG,CCSIO      INDICATE SIO ERROR           @D21WDAP 01852000
CCHAN270 DS    0H                                              @D51ODGL 01853000
         AIF   (&AG1 LE 254).LOD0000                           @D51ODGL 01854000
.*                                                             @D51ODGL 01855000
.* PUBCHQPT CAN NOT BE X'FF', SINCE R4 CONTAINS VALID CHANQ PTR@D51ODGL 01856000
.*                                                             @D51ODGL 01857000
         MVI   CCEQCQP,X'00'      INDICATE:CHANQ ENTRY EXISTS  @D51ODGL 01858000
.LOD0000 AIF   (&AG1 GT 254).LOD0001                           @D51ODGL 01859000
         MVC   CCEQCQP,PUBCHQPT   STORE CHANQ INDEX            @D51ODGL 01860000
.LOD0001 ANOP                                                  @D51ODGL 01861000
         LA    R4,0(,R4)          CLEAR POSSIBLE REST OF FLPTR @D51ODGL 01862000
         ST    R4,ERRQCHQA        STORE CHANQ ADDRESS          @D51ODGL 01863000
         OI    PUBCSFLG,QEDERR    GATE PUB FOR FURTHER I/O     @D14BDWK 01864000
         L     RD,AINTEQS         GET ADDR OF ERROR SUBROUTINES@DY43415 01865000
         USING INTEQSET,RD        ERROR SUBROUTINE BASE        @DY43415 01866000
         BAL   R7,INTEQPST        INSERT ENTRY INTO RAS QUEUE  @D14BDWK 01867000
*SGLINK  INTEQPST,INPUT=(R2,R7,RD),WORK=(R5,R8,RE)             @D149DWK 01868000
         BAL   R7,CCPSTRAS        POST RASTASK                 @D14BDWK 01869000
         AIF   (NOT &BGDEBUG).NMC010                                    01870000
         LA    R7,8(R2)                                                 01871000
         ST    R7,XXUSAREA                                     @D14BDAP 01872000
*        DEBUG DSPLYDAT,XXDBGMC                                @D61DDHH 01873000
         DEBUG DSPLYDAT,XXDBGMC                                @D61DDHH 01874000
.NMC010  ANOP                                                           01875000
         DROP  RD                 RELEASE ERROR SUBROUTINE BASE@DA34523 01876000
CCRSTRT1 L     RD,INITBASE        SET UP SCHEDULER BASE        @DA34523 01877000
         USING SGSCHED,RD         SCHEDULER BASE POINTER       @DA34523 01878000
.*DEL    L     R8,CHENTAD         SGSCHED NEEDS CCT POINTER    @D61SDHH 01879000
         L     R6,DISPAD          GET DISPATCHER BASE          @DA41332 01880000
         B     SGSCHED                  ===================>>  @DY44201 01881000
*SGLINK  SGSCHED,INPUT=(R3,R6,RD)                              @DY44201 01882000
         SPACE 1                                               @D149DWK 01883000
         DROP  RD                 RELEASE SCHEDULER BASE       @DA34523 01884000
         DROP  R2                 RELEASE ERROR ENTRY BASE     @D14BDWK 01885000
         DROP  R3                 RELEASE PUB BASE             @D14BDWK 01886000
         DROP  R4                 RELEASE CHANQ BASE           @D14BDWK 01887000
         SPACE 1                                               @D219DGN 01888000
         TITLE 'VSE/AF SUPERVISOR   MCRAS    CHANNEL DAMAGE PROCESSING' 01889000
***************************************************************@D149DWK 01890000
*        CHANNEL RECOVERY PROCESSING                           @D149DWK 01891000
*        INTERFACE INOPERATIVE PROCESSING                      @D51ADTP 01892000
***************************************************************@D149DWK 01893000
         SPACE 2                                               @D149DWK 01894000
.*DEL    USING CHNTBL,R2          CHANNEL CONTROL TABLE BASE   @D61SDHH 01895000
CCHAN400 LTR   R3,R3              DO WE HAVE A PUB             @D51ADTP 01896000
         BZ    INITLAST           BRANCH IF NOT                @D51ADTP 01897000
         USING PUBADR,R3          PUB BASE POINTER             @D14BDWK 01898000
         SLR   R5,R5                                           @D21YDGN 01899000
         L     R7,IRB$            POINT TO IRB                 @D51ADTP 01900000
         USING IRB,R7             INFORM ASSEMBLER             @D51ADTP 01901000
.*DEL    DROP  R2                 DROP CCT BASE                @D61SDHH 01902000
         L     R2,SCHIB$          POINT TO SCHIB               @D51ADTP 01903000
         USING SCHIB,R2           INFORM ASSEMBLER             @D51ADTP 01904000
         L     R1,XASUBSCH        GET SUBCHANNEL               @D51ADTP 01905000
         STSCH SCHIB              STORE SUBCHANNEL             @D51ADTP 01906000
         BC    1,EMGEX030         ERROR IF NOT OP              @D51ADTP 01907000
         IC    R5,IRBESW0+1       GET LPU MASK                 @D51ADTP 01908000
         SLR   R6,R6              CLEAR WORK REG               @DA41332 01909000
         SLL   R5,24              SHIFT TO HIGH BYTE           @D51ADTP 01910000
CCHAN40A LTR   R5,R5              IS BIT ON                    @D51ADTP 01911000
         BM    CCHAN40B           BRANCH IF YES                @D51ADTP 01912000
         SLL   R5,1               SHIFT OVER ONE               @D51ADTP 01913000
         LA    R6,1(,R6)          BUMP INDEX REGISTER          @DA41332 01914000
         B     CCHAN40A           LOOP                         @D51ADTP 01915000
CCHAN40B LA    R5,SCHCPID0(R6)    POINT TO CHPID USED          @DA41332 01916000
         DROP  R7                 CANCEL ADDRESSABILITY        @D51ADTP 01917000
         SLR   R1,R1              CLEAR REGISTER               @D51ADTP 01918000
         IC    R1,0(,R5)          GET CHPID                    @D51ADTP 01919000
         CNOP  0,4                GET FULL WORD ALIGNMENT      @DA41332 01920000
         BAL   RD,CCHAN410        GET SAVE AREA ADDRESS        @DA41332 01921000
         DC    A(SCHIB)           MSCCHPID ROUT SCHIB ADDRESS  @DA41332 01922000
         DC    15F'0'             MSCCHPID SAVE AREA RE - RC   @DA41332 01923000
CCHAN410 BAL   RE,MSCCHPID        TURN OF LPM BITS IN ALL DEV  @DA41332 01924000
*SGLINK  MSCCHPID,INPUT=(R1,R2,RD,RE),OUTPUT=(R1,R2,R3,R4,R5,R9)        01925000
         B     CCHAN420           ALL PUBX'S PROCESSED         @DA41332 01926000
         SPACE 1                                               @DA41332 01927000
***************************************************************@DA41332 01928000
*        EXIT ROUTINE FROM MSCCHPID TO DO FUNCTION ON          @DA41332 01929000
*            CURRENT PUB / PUBX                                @DA41332 01930000
*                                                              @DA41332 01931000
*          INPUT  :  R1 = SUBCHANNEL                           @DA41332 01932000
*                    R2 = SCHIB                                @DA41332 01933000
*                    R3 = PUB HAVING REQUESTED CHPID           @DA41332 01934000
*                    R4 = PUBX HAVING REQUESTED CHPID          @DA41332 01935000
*                    R5 = LOGICAL PATH MASK FOR REQU. CHPID    @DA41332 01936000
*                    R6 = CHPID STRING POSITION WITHIN PUBX    @DA41332 01937000
*                                                              @DA41332 01938000
*                    R1, R2, R3, R9, RC MUST NOT BE DESTROYED  @DA41332 01939000
*                    BY THIS EXIT ROUTINE                      @DA41332 01940000
***************************************************************@DA41332 01941000
         SPACE 2                                               @DA41332 01942000
         USING PBXADR,R4          BET PUBX BASE                @DA41332 01943000
         EX    R5,CCHEX10         IS THIS PATH INSTALLED       @DA41332 01944000
         BZR   R9                 NO, RETURN TO MSCCHPID       @DA41332 01945000
         EX    R5,CCHEX20         IS THIS PATH ENABLED         @DA41332 01946000
         BZR   R9                 NO, RETURN TO MSCCHPID       @DA41332 01947000
         EX    R5,CCHEX30         RESET LPM BIT IN PUBX        @DA41332 01948000
         CLI   SCHSTB3,SCHACSA    THIS SUBCHANNEL BUSY         @DA41332 01949000
         BNER  R9                 NO, RETURN TO MSCCHPID       @DA41332 01950000
         HSCH                     HOLD SUBCHANNEL              @DA41332 01951000
         BR    R9                 RETURN TO MSCCHPID           @DA41332 01952000
         SPACE 1                                               @DA41332 01953000
CCHEX10  TM    PBXPIM,0           EXECUTE TO COMPARE PIM       @DA41332 01954000
CCHEX20  TM    PBXLPM,0           EXECUTE TO COMPARE LPM       @DA41332 01955000
CCHEX30  XI    PBXLPM,0           EXECUTE TO RESET LPM         @DA41332 01956000
         SPACE 1                                               @DA41332 01957000
         DROP  R4                 RELEASE PUBX BASE            @DA41332 01958000
         SPACE 1                                               @DA41332 01959000
CCHAN420 LA    RC,RASCHPTB          CHANNEL CONTROL .......    @DA41332 01960000
         LA    RC,0(R1,RC)            TABLE ENTRY ADDRESS      @DA41332 01961000
         USING RCHTDSCT,RC        RAS CHANNEL TABLE ENTRY BASE @DA41332 01962000
CCHAN425 RCHP                     RESET CHANNEL PATH           @D51ADTP 01963000
         BC    1,CCHAN428         CHANNEL PATH NOT OPERATIONAL @D51ADTP 01964000
         BC    8,CCHAN430         BRANCH IF CHANNEL RESET      @D51ADTP 01965000
         LA    R2,1024            AVOID KEEPING CHANNEL ...    @D51ADTP 01966000
CCHAN426 BCT   R2,CCHAN426          SUBSYSTEM BUSY WITH RCHP   @D51ADTP 01967000
CCHAN428 OI    RCHNFLGS,RCHNDMMG  IF NOT, SET CHANNEL DAMAGED  @D51ADTP 01968000
         DROP  R2                 RELEASE SCHIB BASE           @DA41332 01969000
CCHAN430 SLR   R2,R2              INDICATE RECORDING REQUIRED  @DA31910 01970000
         ST    R2,RASWORK1        SET PUB POINTER TO ZERO      @D14BDAP 01971000
         LA    R5,CCHAN540        GET RETURN ADDRESS           @D51ADTP 01972000
         TM    PUBCSFLG,DEVBSY    IS DEVICE BUSY               @D14BDWK 01973000
         BZR   R5                 NO, FINISHED WITH THIS PUB   @D51ADTP 01974000
         TM    PUBCSFLG,QEDERR    IS DEVICE QUEUED IN ERROR    @D14BDWK 01975000
         BOR   R5                 YES, FINISHED WITH THIS PUB  @D51ADTP 01976000
         L     R6,DISPAD          GET DISPATCHER BASE          @DA41332 01977000
         USING DISP,R6            DISPATCHER BASE              @DA41332 01978000
         BAL   R7,CQDSP           SET UP I/O REGISTERS         @D14BDWK 01979000
*SGLINK  CQDSP,INPUT=(R3,R6,R7),OUTPUT=(R1,R4,RA),WORK=R0      @D14BDAP 01980000
         DROP  R6                 RELEASE DISPATCHER BASE      @DA41332 01981000
         L     RA,ACCHSRDA        RELOAD BASE OF ROUTINES/DATA @DA41332 01982000
         USING CHQADR,R4          CHANQ BASE POINTER           @D14BDWK 01983000
         TM    CHQCCSIO,CHQCCACT  HAS DEVICE BEEN STARTED      @D14BDWK 01984000
         BZR   R5                 NO, FINISHED WITH THIS PUB   @D51ADTP 01985000
         LH    RE,PUBCHANN        GET CUU ADDRESS              @D14BDAP 01986000
CCHAN470 DS    0H                 SAVE PUB POINTER             @D51ADTP 01987000
         ST    R3,RASWORK1        SAVE PUB POINTER             @D14BDWK 01988000
         TM    CHQDEV,CHQDASD+CHQFBA IS THIS A DASD DEVICE     @D14BDAP 01989000
         BNZ   CCHAN480           YES, USE DEVICE ERROR ENTRY  @D21WDAP 01990000
         CH    R3,WEPIBPUB        DOES RAS SERVICE THIS DEVICE @D14BDAP 01991000
         BNE   CCHAN480           NO, CERTAINLY NOT            @D14BDAP 01992000
         CLC   CHQTID,RASTIDH     IS THIS A RAS REQUEST        @D66ODOW 01993000
         BNE   CCHAN480           NO                           @D14BDWK 01994000
         TM    RTAID,RASRTYID     IS IT A RETRY                @D14BDWK 01995000
         BZ    CCHAN500           NO                           @D14BDAP 01996000
         B     CCHAN530                                        @D21YDGN 01997000
CCHAN480 BAL   R7,CCERBL00        TRY TO FIND AN ERBLK         @D14BDWK 01998000
*SGLINK  CCERBL00,INPUT=(R1,R2,R3,R4,R7,R9),OUTPUT=R2,WORK=R8  @D219DGN 01999000
         LTR   R2,R2              DID WE GET AN ERROR ENTRY    @D14BDAP 02000000
         BZ    CCHAN490           NO                           @D14BDWK 02001000
         LPR   R2,R2              MAKE ADDRESS POSITIVE        @D14BDAP 02002000
         USING ERBLKADR,R2        ERROR ENTRY BASE             @D14BDAP 02003000
         TM    RCHNFLGS,RCHNDMMG  CHANNEL DAMAGED              @D21YDGN 02004000
         BZ    CCHAN495           NO, TEST IF RETRYABLE        @DA34523 02005000
         OI    CCEQMSG,CCHRD      INDICATE RETRY UNSUCCESSFULL @D21WDAP 02006000
         B     CCHAN500           DON'T RETRY                  @DA34523 02007000
         DROP  R2                 RELEASE ERROR ENTRY BASE     @D21WDAP 02008000
CCHAN490 TM    RCHNFLGS,RCHNDMMG  CHANNEL DAMAGED              @D21YDGN 02009000
         BO    CCHAN500           YES, DON'T RETRY             @DA31910 02010000
CCHAN495 TM    CHQCCBB1,OWNUCRT   USER OWN ERROR ROUTINE       @DA34523 02011000
         BO    CCHAN500           YES                          @D14BDWK 02012000
         TM    CHQDEV,CHQDASD+CHQFBA IS THIS A DASD DEVICE     @D14BDAP 02013000
         BZ    CCHAN500           NO                           @D14BDWK 02014000
         TM    CHQCCBB2,CHNBIT    CHANNEL PROGRAM RETRYABLE    @DA34523 02015000
         BO    CCHAN520           NO                           @D21YDGN 02016000
         NI    PUBCSFLG,XFF-DEVBSY RESET BUSY BIT IN PUB       @D14CDAP 02017000
         NI    CHQCCSIO,ZERO      ENSURE DEVICE RESTART        @D14BDAP 02018000
         SPACE 1                                               @D21YDGN 02019000
CCHAN500 LTR   R2,R2              IS THERE AN ERRQUEUE ....    @D21YDGN 02020000
         BNZ   CCHAN520           BRANCH IF NOT                @D51ADTP 02021000
         SPACE 1                                               @D51ADTP 02022000
***************************************************************@D51ADTP 02023000
*        NO ERROR QUEUE ENTRY - NOT HANDLED BY RAS             @D51ADTP 02024000
***************************************************************@D51ADTP 02025000
         SPACE 1                                               @D51ADTP 02026000
CCHAN510 DS    0H                                              @D21YDRP 02027000
         ICM   R1,7,CHQCCBAD+1    CCB AVAILABLE                @D21YDGN 02028000
         BZ    CCHAN520           NO                           @D21YDGN 02029000
         TM    CCBBY3,APPEN       APPENDAGE ROUTINE PRESENT    @D51GDAP 02030000
         BZ    CCHAN520           NO                           @D21YDGN 02031000
         TM    CHQGRP,CHQGRVTM    IS THIS A VTAM OWNED DEVICE  @D51GDAP 02032000
         BO    CCHAN505           YES                          @D51GDAP 02033000
         LR    RC,R3              GET OFFSET TO PUB ....       @D21YDGN 02034000
         SH    RC,YPUBTAB           OWNERSHIP TABLE  ...       @D21YDGN 02035000
         SRL   RC,2                   OF CURRENT PUB           @D21YDGN 02036000
         A     RC,PBOWNPTR        CURRENT PUB OWNERSHIP TABLE  @D21YDGN 02037000
         TM    0(RC),ISTPBOWN     PUB OWNED BY VTAM            @D21YDGN 02038000
         BZ    CCHAN520           NO                           @D21YDGN 02039000
CCHAN505 MVC   CSW(1),CHQCAWKY    GET STORAGE KEY              @D21YDGN 02040000
         OI    CCBCOM1,TRABIT+DISERR POST CCB TRABIT + ERROR   @DY46396 02041090
         TM    IJBFLG0A,IJB31VBE  31-BIT VTAM BUFFERS ENABLED? @DY46396 02041180
         BZ    CCHAN512           .. no, continue              @DY46396 02041270
         LR    R9,R1              .yes, save addr of copied CCB@DY46396 02041360
         L     R1,CCBVA           Load addr of VTAM CCB        @DY46396 02041450
         OI    CCBCOM1,TRABIT+DISERR POST CCB TRABIT + ERROR   @DY46396 02041540
         MVC   V31CSWSV(4),CSW    ..yes, save orig CSW content @DY46396 02041630
         OC    V31VCCWA,V31VCCWA  Do we have a virt CCW addr?  @DY46396 02041720
         BZ    CCHAN512           .. no                        @DY46396 02041810
         MVC   CSW(4),V31VCCWA    Move virtual addr into CSW   @DY46396 02041900
CCHAN512 ICM   R8,7,CCBCSWW       GET CHANNEL END APPD ADDRESS @D21YDGN 02041990
         LR    RC,R2              SAVE REGISTER 2              @D21YDGN 02043000
         L     R2,RASLINKA        GET RAS LINKAGE AREA ADDRESS @D61RDHH 02044000
         LR    RE,R5              SAVE REGISTER 5              @DY43250 02045000
         LR    R5,R3              COPY PUB ADDRESS             @DY43250 02046000
         SH    R5,YPUBTAB         GET NORMAL PUB INDEX         @DY43250 02047000
         SRL   R5,PUBSLEN-2       ADJUST FOR PUB2 INDEX        @DY43250 02048000
         A     R5,APB2AREA        GET PUB2 INDEX FROM TABLE    @DY43250 02049000
         L     R5,0(,R5)          GET ADDRESS OF PUB2          @DY43250 02050000
         BALR  R7,R8              GO TO VTAM APPENDAGE         @D21YDGN 02051000
         TM    IJBFLG0A,IJB31VBE  31-BIT VTAM BUFFERS ENABLED? @DY46396 02052090
         BZ    CCHAN514           .. no, continue              @DY46396 02052180
         LR    R1,R9              Restore addr of copied CCB   @DY46396 02052270
         MVC   CSW(4),V31CSWSV    Restore orig CSW content     @DY46396 02052360
CCHAN514 LR    R2,RC              RESTORE REGISTER 2           @DY46396 02052450
         LR    R5,RE              RESTORE REGISTER 5           @DY43250 02053000
         NI    PUBCSFLG,XFF-QEDERR RESET QEDERR FOR VTAM       @D21YDGN 02054000
         NI    CHQCCSIO,XFF-CHQCCACT RESET DEVICE RUNNING      @D21YDGN 02055000
         BR    R5                 FINISHED WITH THIS PUB       @D51ADTP 02056000
CCHAN520 OI    CHQPROC,CHQDQUNC   FORCE DEQUEUING              @D21YDGN 02057000
CCHAN530 OI    CHQCCBB1,DISERR    INDICATE DISASTER ERROR      @D21YDGN 02058000
         OC    CHQCSW+4(2),CSW+4  GET CORRECT STATUS BYTES     @DA34523 02059000
         BR    R5                 FINISHED WITH THIS PUB       @D51ADTP 02060000
         SPACE 1                                               @D219DGN 02061000
CCHAN540 DS    0H                 GET PUB POINTER              @D51ADTP 02062000
         ICM   R6,7,RASWORK1+1    PUB POINTER SET?             @DY44671 02063000
         BZ    CCRSTRT1           NONE OF OUR I/O WAS ACTIVE   @D14BDAP 02064000
         L     R6,DISPAD          GET DISPATCHER BASE          @DA41332 02065000
         USING DISP,R6            DISPATCHER BASE              @DA41332 02066000
         BAL   R7,CQDSP           RESTORE I/O POINTERS         @D14BDAP 02067000
*SGLINK  CQDSP,INPUT=(R3,R6,R7),OUTPUT=(R1,R4,RA),WORK=R0      @D14BDAP 02068000
         DROP  R6                 RELEASE DISPATCHER BASE      @DA41332 02069000
         L     RA,ACCHSRDA        RELOAD BASE OF ROUTINES/DATA @DA41332 02070000
         LTR   R2,R2              DID WE GET ERROR ENTRY       @D14BDAP 02071000
         BNP   CCEXIT00           NO, FORCE CANCEL             @D14BDAP 02072000
         USING ERBLKADR,R2        ERROR ENTRY BASE             @D14BDAP 02073000
         TM    CCEQMSG,CCHRD      UNRECOVERABLE ERROR          @D21WDAP 02074000
         BO    CCHAN210           NO     ===================>  @D14BDWK 02075000
         B     CCHAN150                                        @D14BDWK 02076000
         SPACE 1                                               @D149DWK 02077000
         DROP  R1                 RELEASE CCB BASE             @D14BDWK 02078000
         DROP  R2                 RELEASE ERROR ENTRY BASE     @D14BDAP 02079000
         DROP  R3                 RELEASE PUB BASE             @D14BDWK 02080000
         DROP  R4                 RELEASE CHANQ BASE           @D14BDWK 02081000
         DROP  R9                 RELEASE IOINTER BASE         @D14BDWK 02082000
         DROP  RC                 RELEASE RAS CC TABLE BASE    @DA41332 02083000
         SPACE 1                                               @D149DWK 02084000
***************************************************************@D149DWK 02085000
*        THIS ROUTINE IS ENTERED WHEN A RETRY REQUEST FOR      @D149DWK 02086000
*        A CHANNEL CHECK ON DASD IS SUCCESSFULL                @DA33850 02087000
***************************************************************@D149DWK 02088000
         SPACE 2                                               @D149DWK 02089000
         USING CCBADR,R1          CCB BASE POINTER             @D36IDJR 02090000
         USING PUBADR,R3          PUB BASE POINTER             @D36IDJR 02091000
         USING CHQADR,R4          CHANQ BASE POINTER           @D36IDJR 02092000
         USING INTRTN,R9          IOINTER BASE POINTER         @D35IDAZ 02093000
         SPACE 1                                               @D149DWK 02094000
CCENTRY2 DS    0H                                              @D61DDHH 02095000
*        DEBUG ALLREGS,XXDBGMC    ALL REGS DEBUG               @D61DDHH 02096000
         DEBUG ALLREGS,XXDBGMC    ALL REGS DEBUG               @D61DDHH 02097000
         L     RA,ACCHSRDA        SET ROUTINE AND DATA BASE    @DA41332 02098000
         NI    CHQGRP,XFF-CHQGRRAS    RESET DASD RETRY INDIC.  @DA33850 02099000
         BAL   R7,CCERBL00        GET RELATED ERBLK ENTRY      @D14BDWK 02100000
*SGLINK  CCERBL00,INPUT=(R1,R2,R3,R4,R7,R9),OUTPUT=R2,WORK=R8  @D21YDGN 02101000
         LTR   R2,R2              ENTRY STILL AVAILABLE        @D14BDAP 02102000
         BZ    CCEXIT20           NO,  =====================>  @DA41332 02103000
         BP    CCEXIT20           NO,  =====================>  @D14BDAP 02104000
         LPR   R2,R2              CONVERT ADDRESS              @D14BDWK 02105000
         USING ERBLKADR,R2        SET ERBLK BASE               @D14BDWK 02106000
         XC    CCEQRTC,CCEQRTC    RESET RETRY COUNTER          @D21WDAP 02107000
         OI    CCEQMSG,CCRECMSG   SET RECOVERED CHANNEL CHECK  @D21WDAP 02108000
         L     R6,DISPAD          GET DISPATCHER BASE          @DA41332 02109000
         USING DISP,R6            DISPATCHER BASE              @DA41332 02110000
         CLC   DEVSTA(2),NOTOP    NOT OPERATIONAL ON RETRY     @D68OMHH 02111000
         BE    CCSRTY20           YES                          @DA41332 02112000
         DROP  R6                 RELEASE DISPATCHER BASE      @DA41332 02113000
         TM    DEVSTA,UNITCK      UNIT CHECK ON RETRY          @D14BDWK 02114000
         BZ    CCSRTY30           NO                           @D14BDWK 02115000
CCSRTY20 L     R7,ARASTIB             RASTIB ADDRESS           @D14BDWK 02116000
         L     R7,TIBTCB-TIBADR(R7)   RAS TCB ADDRESS          @D14BDWK 02117000
         L     R7,TCBERBLK-TCBADR(R7) RAS ERROR BLOCK ADDRESS  @D14BDWK 02118000
         NI    ERBLKFLG,X'FF'-ERACTIVE RESET ACTIVE INDICATOR  @D14BDWK 02119000
         NI    ERBLKFL1,X'FF'-NEEDRAS  RESET RAS INDICATOR     @D14BDWK 02120000
         DROP  R2                 RELEASE ERBLOC BASE          @D14BDWK 02121000
         USING ERBLKADR,R7        RAS ERBLK BASE               @D14BDWK 02122000
         TM    ERBLKFL1,NEEDRAS   ALLREADY USED                @D14BDWK 02123000
         BO    CCEXIT20           YES IGNORE ERROR =========>  @D14BDWK 02124000
         DROP  R7                 RELEASE RAS ERBLOC BASE      @D14BDWK 02125000
         USING ERBLKADR,R2        I/O ERBLOC BASE              @D14BDWK 02126000
         MVC   0(ERBLKHDL+CCEQLEN,R7),ERBLKPTR SAVE ERBLOC     @D21WDAP 02127000
         LR    R2,R7              USE RAS ERROR BLOCK          @D14BDWK 02128000
         OI    ERBLKFLG,ERACTIVE  SET ACTIVE INDICATOR         @D14BDWK 02129000
         OI    ERBLKFL1,NEEDRAS   SET USED INDICATOR           @D14BDWK 02130000
CCSRTY30 L     RD,AINTEQS         ADDRESS OF ERROR SUBROUTINES @D14BDWK 02131000
         USING INTEQSET,RD        ERROR SUBROUTINE BASE        @D14BDWK 02132000
         BAL   R7,INTEQPST        INSERT ERBLK INTO RAS QUEUE  @D14BDDK 02133000
*SGLINK  INTEQPST,INPUT=(R2,R7,RD),WORK=(R5,R8,RE)             @D149DWK 02134000
         BAL   R7,CCPSTRAS        ACTIVATE RASTASK             @D14BDWK 02135000
         B     CCEXIT20                =====================>  @D14BDWK 02136000
         SPACE 1                                               @D149DWK 02137000
         DROP  R1                 RELEASE CCB BASE             @D14BDWK 02138000
         DROP  R2                 RELEASE ERROR ENTRY BASE     @D14BDAP 02139000
         DROP  R3                 RELEASE PUB BASE             @D14BDWK 02140000
         DROP  R4                 RELEASE CHANQ BASE           @DA33850 02141000
         DROP  R9                 RELEASE IOINTER BASE         @D14BDWK 02142000
         DROP  RD                 RELEASE ERROR SUBROUTINE BASE@DA33850 02143000
      TITLE 'VSE/AF SUPERVISOR   MCRAS   ALLOCATE CHANNEL CHECK ERBLK'  02144000
         EJECT                                                 @D61SDHH 02145000
***************************************************************@D149DWK 02146000
*        ALLOCATE AND BUILD AN ERBLK                           @D149DWK 02147000
***************************************************************@D149DWK 02148000
         SPACE 2                                               @D149DWK 02149000
         USING CCBADR,R1          CCB BASE POINTER             @D36IDJR 02150000
         USING PUBADR,R3          PUB BASE POINTER             @D36IDJR 02151000
         USING CHQADR,R4          CHANQ BASE POINTER           @D36IDJR 02152000
         USING INTRTN,R9          IOINTER BASE POINTER         @D35IDAZ 02153000
         SPACE 1                                               @D149DWK 02154000
CCERBL00 ST    RE,CCERSAVE        SAVE REGISTER 14             @D14BDAP 02155000
         BAL   RE,GETPUBX         POINT TO PUB EXTENSION       @D14BDWK 02156000
*SGLINK  GETPUBX,INPUT=(R3,R9,RE),OUTPUT=(R2)                  @D149DWK 02157000
         ST    R2,CCPBXADR        SAVE PUBX ADDR               @D61SDHH 02158000
         USING PBXADR,R2                                       @D14BDWK 02159000
         L     R2,PBXERBLK        GET ERBLK ADDRESS            @D14BDWK 02160000
         DROP  R2                                              @D61SDHH 02161000
         USING ERBLKADR,R2        DECLARE ERBLK BASE           @D14BDDK 02162000
         TM    ERBLKFL1,XFF-NEEDRAS ANY BIT EXCEPT RAS         @D14BDWK 02163000
         BNZ   CCEREXT0           YES, INDICATE NO ENTRY FOUND @D14BDWK 02164000
         TM    ERBLKFL1,NEEDRAS   IS ENTRY USED BY RAS         @D14BDDK 02165000
         BO    CCEREXTM           YES, MAKE ADDRESS NEGATIVE   @D14BDWK 02166000
         TM    ERBLKFLG,ERACTIVE  ERROR ENTRY ACTIVE           @D14BDWK 02167000
         BNZ   CCEREXT0           YES, INDICATE NO ENTRY FOUND @D14BDWK 02168000
         BAL   R8,CCERQU00        CHECK FOR CC ERROR QUEUE     @D61SDHH 02169000
CCEREXIT L     RE,CCERSAVE        RESTORE REGISTER 14          @D14BDAP 02170000
         BR    R7                        ===================>  @D14BDAP 02171000
CCERSAVE DC    A(0)               SAVE AREA FOR RE             @D14BDAP 02172000
         SPACE 1                                               @D14BDAP 02173000
CCEREXT0 SLR   R2,R2              CLEAR ERROR ENTRY ADDRESS    @D14BDAP 02174000
         B     CCEREXIT                                        @D14BDAP 02175000
CCEREXTM LCR   R2,R2              LOAD COMPLEMENT ADDRESS      @D14BDAP 02176000
         B     CCEREXIT                                        @D14ZDWK 02177000
         SPACE 1                                               @D61SDHH 02178000
***************************************************************@D61SDHH 02179000
*        ALLOCATE CC ERROR STACK ENTRY                         @D61SDHH 02180000
***************************************************************@D61SDHH 02181000
         SPACE 1                                               @D61SDHH 02182000
CCERQU00 CLI   PUBDEVTY,TTPA     TPA DEVICE                    @D61SDHH 02183000
         BNE   CCERST00          .. NO, PLAIN ERROR ENTRY      @D61SDHH 02184000
*        SGCOV MCRAS             TPA COVERAGE POINT 3000       @D61SDHH 02185000
         SGCOV MCRAS                                           @D61SDHH 02186000
         STM   R5,R8,CCERQSAV    SAVE WORK REGS                @DY45540 02187000
         NC    CCSTKBEG,CCSTKBEG CC STACK INITIALIZED          @D61SDHH 02188000
         BNZ   CCERQU20          .. YES                        @D61SDHH 02189000
         L     R5,RASLINKA       GET ADDR OF RASLINK           @D61SDHH 02190000
         L     R5,RASMCSTK-RASLINK(,R5) GET ADDR OF MCSTACK    @D61SDHH 02191000
         LTR   R5,R5             ALREADY ALLOCATED BY IPL      @D61SDHH 02192000
         BZ    CCERQU90          .. NO, PLAIN ERROR ENTRY      @D61SDHH 02193000
         LA    R5,&MCHSTK*(MCST$LEN+MCRW$LEN)(,R5) AFTER MC/CRW@D61SDHH 02194000
         ST    R5,CCSTKBEG       SAVE CC STACK BEGIN ADDRESS   @D61SDHH 02195000
         ST    R5,CCSTKNXT       SET CC STACK NEXT ADDRESS     @D61SDHH 02196000
         LA    R6,CCST$LEN       GET CC STACK ENTRY LENGTH     @D61SDHH 02197000
         MH    R6,MCSTKNUM       MULTIPLY WITH NUM OF ENTRIES  @D61SDHH 02198000
         AR    R5,R6             END OF CC STACK AREA + 1      @D61SDHH 02199000
         ST    R5,CCSTKEND       SAVE CC STACK END ADDRESS     @D61SDHH 02200000
CCERQU20 CLC   CCSTKQUE,CCSTKNXT CC STACK EXHAUSTED            @D61SDHH 02201000
         BNE   CCERQU30          .. NO                         @D61SDHH 02202000
*        SGCOV MCRAS             TPA COVERAGE POINT 3001       @D61SDHH 02203000
         SGCOV MCRAS                                           @D61SDHH 02204000
         SLR   R5,R5             CLEAR CC STACK ADDRESS        @D61SDHH 02205000
         BCTR  R5,0              SET TO FFFFFFFF               @D61SDHH 02206000
         B     CCERQU90          AND PLAIN ERROR ENTRY         @D61SDHH 02207000
CCERQU30 LA    R5,CCSTKQUE       GET CC STACK ADDRESS          @D61SDHH 02208000
         USING CCST$DS,R5        BASE CC STACK DSECT           @D61SDHH 02209000
CCERQU35 NC    CCST$NXT,CCST$NXT LAST ENTRY IN QUEUE           @D61SDHH 02210000
         BZ    CCERQU40          .. YES, ENQUEUE AFTER         @D61SDHH 02211000
         L     R5,CCST$NXT       GET BASE FOR NEXT STACK ENTRY @D61SDHH 02212000
         B     CCERQU35          CHECK FOR LAST ENTRY          @D61SDHH 02213000
CCERQU40 MVC   CCST$NXT,CCSTKNXT ENQUEUE THIS ENTRY            @D61SDHH 02214000
         L     R5,0(R5)          GET CURRENT QUEUE ADDRESS     @D61SDHH 02215000
         LA    R6,CCST$LEN(,R5)  BUMP TO NEXT STACK ENTRY      @D61SDHH 02216000
         CL    R6,CCSTKEND       LAST ENTRY REACHED            @D61SDHH 02217000
         BL    CCERQU50          .. NO                         @D61SDHH 02218000
         L     R6,CCSTKBEG       WRAP CC STACK                 @D61SDHH 02219000
***************************************************************@D219DGN 02220000
*        SET UP CC STACK ENTRY                                 @D219DGN 02221000
***************************************************************@D219DGN 02222000
CCERQU50 XC    CCST$DS(CCST$LEN),CCST$DS  CLEAR CC STACK ENTRY @D61SDHH 02223000
         ST    R6,CCSTKNXT       STORE NEXT FREE CC STACK ENTRY@D61SDHH 02224000
         L     R7,CCPBXADR       GET PUBX ADDRESS              @D61SDHH 02225000
         USING PBXADR,R7         BASE PUBX DSECT               @D61SDHH 02226000
* -- GET TOD, IRB, CUU, DEVICE TYPE AND SUBCHANNEL NUMBER ---  @D61SDHH 02227000
         STCK  CCERQTOD          STORE CLOCK                   @D61SDHH 02228000
         MVC   CCST$TOD,CCERQTOD MOVE CLOCK INTO WORK AREA     @D61SDHH 02229000
         L     R6,IRB$           GET ADDR OF IRB               @D61SDHH 02230000
         USING IRB,R6            BASE IRB DSECT                @D61SDHH 02231000
         MVC   CCST$IRB,IRB      MOVE IN IRB                   @D61SDHH 02232000
         DROP  R6                RELEASE IRB BASE              @D61SDHH 02233000
         MVC   CCST$CUU(2),PUBCHANN COPY CUU                   @D61SDHH 02234000
         MVC   CCST$DT,PBXOBR    COPY PUBX OBR TYPE CODE       @DY44201 02235000
         MVC   CCST$SCI,PBXSCH   COPY SUBCHANNEL NUMBER        @D61SDHH 02236000
* -- GET THE VOLUME SERIAL NUMBER ---------------------------  @D61SDHH 02237000
         LR    R6,R3             COPY PUB POINTER              @D61SDHH 02238000
         SH    R6,YPUBTAB        GET OFFSET IN PUBTAB          @D61SDHH 02239000
         SRL   R6,PUBSLEN-2      ADJUST FOR PUB2 INDEX         @D61SDHH 02240000
         A     R6,APB2AREA       GET PUB2 INDEX FROM TABLE     @D61SDHH 02241000
         L     R6,0(,R6)         GET ADDRESS OF PUB2           @D61SDHH 02242000
         USING PUB2ADR,R6        DECLARE PUB2 BASE             @D61SDHH 02243000
         MVC   CCST$VOL,P2TVOL   SET VOLUME SERIAL NUMBER      @D61SDHH 02244000
         DROP  R6                                              @D61SDHH 02245000
* -- GET THE JOB NAME ---------------------------------------  @D61SDHH 02246000
         MVC   CCST$JOB,CCDJOBNM SET DEFAULT JOB NAME          @D61SDHH 02247000
         CLC   CHQTID,ARTIDH     SYSTEM TASK                   @D66ODOW 02248000
         BNH   CCERQU60          .. YES                        @D61SDHH 02249000
*        SGCOV MCRAS             TPA COVERAGE POINT 3002       @D61SDHH 02250000
         SGCOV MCRAS                                           @D61SDHH 02251000
         LH    R6,CHQTID         GET REQUESTORS TASK ID        @D66ODOW 02252000
         SLL   R6,2              GET OFFSET INTO TIBATAB       @D61SDHH 02253000
         AL    R6,ATIBATAB       POINT TO TIB ADDRESS          @D66GDHH 02254000
         L     R6,0(,r6)         GET TIB ADDRESS               @D66GDHH 02255000
         LTR   R6,R6             TIB ADDRESS PRESENT           @D61SDHH 02256000
         BZ    CCERQU60          ..NO                          @D61SDHH 02257000
         USING TIBADR,R6         BASE TIB DSECT                @D61SDHH 02258000
         LH    R6,TIBPIK         GET PIK                       @D61SDHH 02259000
         DROP  R6                                              @D61SDHH 02260000
         SRL   R6,2              GET PCB ADDRESS OFFSET        @D61SDHH 02261000
         A     R6,APCBATAB       ADDR OF PCB ADDRESS           @D61SDHH 02262000
         ICM   R6,15,0(R6)       PCB ADDRESS PRESENT           @D61SDHH 02263000
         BZ    CCERQU60          .. NO                         @D61SDHH 02264000
         USING PCBADR,R6                                       @D61SDHH 02265000
         L     R6,PCECOMRA       GET COMREG ADDRESS            @D61SDHH 02266000
         DROP  R6                                              @D61SDHH 02267000
         USING COMREG,R6                                       @D61SDHH 02268000
         MVC   CCST$JOB,COMNAME  MOVE JOB NAME                 @D61SDHH 02269000
         DROP  R6                                              @D61SDHH 02270000
* -- GET THE CHPID  -----------------------------------------  @D61SDHH 02271000
CCERQU60 L     R6,IRB$           GET ADDR OF IRB               @D61SDHH 02272000
         USING IRB,R6            BASE IRB DSECT                @D61SDHH 02273000
         TM    IRBESW0+2,X'40'   LPUM VALID                    @D61SDHH 02274000
         BZ    CCERQU70          ..NO                          @D61SDHH 02275000
         SLR   R8,R8             CLEAR WORK REG                @D61SDHH 02276000
         ICM   R8,1,IRBLPUM      GET LPUM                      @D61SDHH 02277000
         BZ    CCERQU70          LPUM 0                        @D61SDHH 02278000
         DROP  R6                                              @D61SDHH 02279000
         SLR   R6,R6             CLEAR WORK REG FOR INDEX      @D61SDHH 02280000
         SLL   R8,24             SHIFT LPUM TO HIGH BYTE       @D61SDHH 02281000
CCERQU65 LTR   R8,R8             IS BIT ON                     @D61SDHH 02282000
         BM    CCERQU68          .. YES                        @D61SDHH 02283000
         SLL   R8,1              SHIFT ONE BIT                 @D61SDHH 02284000
         LA    R6,1(,R6)         BUMP INDEX REGISTER           @D61SDHH 02285000
         B     CCERQU65          CHECK NEXT BIT                @D61SDHH 02286000
CCERQU68 LA    R8,PBXCHPID(R6)   GET ADDR OF AFFECTED CHPID    @D61SDHH 02287000
         MVC   CCST$CHP(1),0(R8) COPY AFFECTED CHPID           @D61SDHH 02288000
         OI    CCST$FLG,CCST$CHV INDICATE CHPID VALID          @D61SDHH 02289000
         DROP  R7                RELEASE PUBX BASE             @D61SDHH 02290000
* -- GET THE CCW ADDRESS AND THE CCW ------------------------  @D61SDHH 02291000
CCERQU70 L     R6,IRB$           GET ADDR OF IRB               @D61SDHH 02292000
         USING IRB,R6                                          @D61SDHH 02293000
         ICM   R6,15,IRBCCW      GET THE IRB CCW ADDRESS       @D61SDHH 02294000
         BZ    CCERQU90          .. NOT AVAILABLE              @D61SDHH 02295000
         ICM   R8,15,CHQCCBAD    GET THE CCB ADDRESS           @D61SDHH 02296000
         ICM   R8,8,H0           CLEAR HIGH ORDER BYTE         @D68REEF 02297000
         LTR   R8,R8             CCB STILL AVAILABLE           @D68ADAP 02298000
         BZ    CCERQU90          .. NOT AVAILABLE              @D61SDHH 02299000
         L     R8,CCBCCW         GET THE CCB CCW ADDRESS       @D61SDHH 02300000
         ICM   R8,8,H0           CLEAR HIGH-ORDER BYTE         @D68REEF 02301000
         TM    CCBCLS,XCPR       EXCP REAL ?                   @D61SDHH 02302000
         BZ    CCERQ71           .. NO                         @D61SDHH 02303000
         OI    CCST$FLG,CCST$XRL SET INDICATION IN CC STACK    @D61SDHH 02304000
         AMODESW SET,DAT=OFF     SET DAT OFF                   @D61SDHH 02305000
CCERQ71  ST    R8,CCCIP          SAVE AS CCW ADDR IN PROGRESS  @D61SDHH 02306000
         SPACE 1                                               @D61SDHH 02307000
         CLR   R8,R6             FINISHED?                     @D61SDHH 02308000
         BE    CCERQ7X           .. YES                        @D61SDHH 02309000
         USING CCWADR,R8         BASE CCW DSECT                @D61SDHH 02310000
CCERQ72  TM    CCWCHAIN,DC       DATA CHAINING ?               @D61SDHH 02311000
         BZ    CCERQ74           .. NO                         @D61SDHH 02312000
         LA    R8,8(,R8)         GET ADDR OF NEXT CCW          @D61SDHH 02313000
         CLR   R8,R6             FINISHED?                     @D61SDHH 02314000
         BE    CCERQ7X           .. YES                        @D61SDHH 02315000
         TM    CCWCODE,X'08'     COULD THIS BE A TIC ?         @D61SDHH 02316000
         BNO   CCERQ72           .. NO, CHECK FOR ANOTHER DC   @D61SDHH 02317000
         TM    CCWCODE,X'07'     IS IT A TIC ?                 @D61SDHH 02318000
         BNZ   CCERQ72           .. NO, CHECK FOR ANOTHER DC   @D61SDHH 02319000
*        SGCOV MCRAS             TPA COVERAGE POINT 3003       @D61SDHH 02320000
         SGCOV MCRAS                                           @D61SDHH 02321000
         L     R8,CCWBUF                                       @D61SDHH 02322000
         LA    R8,0(,R8)         CLEAR HIGH-ORDER BYTE         @D61SDHH 02323000
         CLR   R8,R6             FINISHED?                     @D61SDHH 02324000
         BE    CCERQ7X           .. YES                        @D61SDHH 02325000
         B     CCERQ72           CHECK THIS FOR DC             @D61SDHH 02326000
CCERQ74  TM    CCWCODE,X'08'     COULD IT BE A TIC ?           @D61SDHH 02327000
         BNO   CCERQ76           .. NO                         @D61SDHH 02328000
         TM    CCWCODE,X'07'     IS IT A TIC ?                 @D61SDHH 02329000
         BNZ   CCERQ76           .. NO                         @D61SDHH 02330000
*        SGCOV MCRAS             TPA COVERAGE POINT 3004       @D61SDHH 02331000
         SGCOV MCRAS                                           @D61SDHH 02332000
         L     R8,CCWBUF         GET ADDR OF NEXT CCW          @D61SDHH 02333000
         LA    R8,0(,R8)         CLEAR HIGH-ORDER BYTE         @D61SDHH 02334000
         CLR   R8,R6             FINISHED ?                    @D61SDHH 02335000
         BE    CCERQ7X           .. YES                        @D61SDHH 02336000
         ST    R8,CCCIP          SAVE ADDR OF CURRENT CCW      @D61SDHH 02337000
         B     CCERQ72           CHECK NEXT CCW                @D61SDHH 02338000
CCERQ76  TM    CCWCHAIN,CC       CMD CHAINING                  @D61SDHH 02339000
         BZ    CCERQ7X           .. YES                        @D61SDHH 02340000
         LA    R8,8(,R8)         GET ADDR OF NEXT CCW          @D61SDHH 02341000
         CLR   R8,R6             FINISHED ?                    @D61SDHH 02342000
         BE    CCERQ7X           .. YES                        @D61SDHH 02343000
         ST    R8,CCCIP          SAVE ADDR OF CURRENT CCW      @D61SDHH 02344000
         B     CCERQ72           AND CHECK THIS ONE            @D61SDHH 02345000
         DROP  R6                                              @D61SDHH 02346000
CCERQ7X  L     R8,CCCIP          GET ADDR OF CCW-IN-PROG       @D61SDHH 02347000
         MVC   CCST$CCW(8),0(R8) COPY THE CCW                  @D61SDHH 02348000
         AMODESW SET,DAT=ON      SET DAT ON                    @D61SDHH 02349000
         ST    R8,CCST$CIP       SAVE IN CC STACK              @D61SDHH 02350000
         LA    R8,CCCIP          PERPARE ...                   @D61SDHH 02351000
         SLR   R0,R0             ... FOR GETDADR               @D61SDHH 02352000
         L     R6,DISPAD         GET DISP BASE                 @D61SDHH 02353000
         USING DISP,R6                                         @D61SDHH 02354000
         BAL   R7,GETDADR        CALL SERVICE ROUTINE          @D61SDHH 02355000
*SGLINK  GETDADR,INPUT=(R0,R6,R7,R8),OUTPUT=RF                 @D61SDHH 02356000
         DROP  R6                                              @D61SDHH 02357000
         LTR   RF,RF             VIRT ADDR AVAILABLE?          @D61SDHH 02358000
         BZ    CCERQU90          .. NO                         @D61SDHH 02359000
         ST    RF,CCST$CIV       .. YES, SAVE IT               @D61SDHH 02360000
         DROP  R5                RELEASE CCST$DS BASE          @D61SDHH 02361000
CCERQU90 DS    0H                                              @DY45540 02362000
         B     CCERST00                                        @D61SDHH 02363000
CCERQSAV DC    4F'0'             SAVE AREA                     @DY45540 02364000
CCPBXADR DC    F'0'              SAVE AREA FOR PUBX ADDRESS    @D61SDHH 02365000
CCERQTOD DC    D'0'              TOD CLOCK WORK AREA           @D61SDHH 02366000
CCCIP    DC    F'0'              ADDR OF CCW IN PROG           @D61SDHH 02367000
         DC    X'00'             EXTENSION NEEDED FOR GETDADR  @D61SDHH 02368000
CCDJOBNM DC    C'VSE/ESA '       DEFAULT JOB NAME              @D61SDHH 02369000
         SPACE 1                                               @D149DWK 02370000
***************************************************************@D219DGN 02371000
*        SET UP DEVICE ERROR ENTRY                             @D219DGN 02372000
***************************************************************@D219DGN 02373000
         SPACE 1                                               @D149DWK 02374000
CCERST00 XC    CCEQSTRT(CCEQLEN),CCEQSTRT  CLEAR ERROR ENTRY   @D21WDAP 02375000
         CLI   PUBDEVTY,TTPA     TPA DEVICE                    @D61SDHH 02376000
         BNE   CCERST01          .. NO                         @D61SDHH 02377000
         ST    R5,CCEQRINF       SAVE ADDR OF CC STACK ENTRY   @D61SDHH 02378000
         LM    R5,R8,CCERQSAV     RELOAD REGISTERS             @DY45540 02379000
CCERST01 MVC   CCEQCSW(8),CSW     SAVE CSW IN ERBLK            @D21WDAP 02380000
         MVC   CCEQECSW(3),ECSWSRC SAVE THE EXTENDED CSW       @D21WDAP 02381000
         MVC   CCEQTIDN,CHQTID    SAVE THE REQUESTORS ID       @D66ODOW 02382000
         STH   R3,CCEQPUB         STORE THE PUB POINTER        @D21WDAP 02383000
         AIF   (&AG1 LE 254).LOD0010                           @D51ODGL 02384000
         MVI   CCEQCQP,NOTQUED    INDICATE: NO CHANQ ENTRY     @D51ODGL 02385000
         CLI   PUBCHQPT,NOTQUED   IS THIS REALLY TRUE          @D51ODGL 02386000
         BE    CCERST02           YES.                         @D51ODGL 02387000
         MVI   CCEQCQP,X'00'      NO, IND. CHANQ ENTRY EXISTS  @D51ODGL 02388000
CCERST02 DS    0H                                              @D51ODGL 02389000
.LOD0010 AIF   (&AG1 GT 254).LOD0011                           @D51ODGL 02390000
         MVC   CCEQCQP,PUBCHQPT   STORE CHANQ POINTER          @D51ODGL 02391000
.LOD0011 ANOP                                                  @D51ODGL 02392000
         LA    R4,0(,R4)          CLEAR POSSIBLE REST OF FLPTR @D51ODGL 02393000
         ST    R4,ERRQCHQA        STORE 0 OR CHANQ ADDRESS     @D51ODGL 02394000
         MVC   CCEQDMC(1),CHNADR  SAVE CHANNEL NUMBER          @D21WDAP 02395000
         OI    ERBLKFLG,ERACTIVE  SET ENTRY ACTIVE             @D14BDWK 02396000
         OI    ERBLKFL1,NEEDRAS   INDICATE TO BE USED BY RAS   @D14BDDK 02397000
         L     RE,RASLINKA        TAKE ADDRESS OF RASLINK      @D61RDHH 02398000
         CLI   RASDMC-RASLINK(RE),XFF     CHANNEL DAMAGE COND. @D61RDHH 02399000
         BE    CCIOEL00           NO ALLOCATE IOEL             @D14BDWK 02400000
CCERST10 OI    CCEQFLG,CCDAM      INDICATE CHANNEL DAMMAGE     @D21WDAP 02401000
         SPACE 1                                               @D149DWK 02402000
***************************************************************@D149DWK 02403000
*        ALLOCATE IOEL                                         @D149DWK 02404000
***************************************************************@D149DWK 02405000
         SPACE 2                                               @D149DWK 02406000
CCIOEL00 ST    R3,RASWORK1        SAVE PUB POINTER             @D14BDWK 02407000
         SR    R3,R3              CLEAR WORK REGISTER          @D14BDDK 02408000
         ICM   R3,7,AIOEL+1       POINT TO ACTIVE IOEL         @D14BDDK 02409000
         BZ    CCIOEL10           SKIP IF ADDR ZERO            @D14BDDK 02410000
         MVC   0(16,R3),FLOGA     FILL IOEL FOR XA             @D51ADTP 02411000
CCIOEL10 ST    R3,CCEQIOEL        STORE POINTER TO IOEL        @D21WDAP 02412000
         XC    AIOEL+1(3),AIOEL+1 CLEAR AIOEL                  @D14BDDK 02413000
         ST    R9,CCIOELS9        STORE REGISTER R9            @D61RDHH 02414000
         CLI   IOELPTRS,X'FF'     IOELPTRS TO BE INITIALIZED   @D14BDDK 02415000
         BNE   CCIOEL20           NO                           @D14BDDK 02416000
         L     R9,RASLINKA        LOAD RASLINK BASE ADDRESS    @D61RDHH 02417000
         LA    RE,IOELPTRS        POINT TO FIRST IOEL POINTER  @D14BDDK 02418000
         MVI   0(RE),IOELUSED     INDICATE USE                 @D14BDDK 02419000
CCIOEL15 STCM  R3,7,1(RE)         STORE IOEL ADDRESS           @D14BDDK 02420000
         AH    R3,RASIOELL-RASLINK(R9) NXT IOEL ADDRESS        @D61RDHH 02421000
         LA    RE,4(RE)           POINT TO NEXT IOEL POINTER   @D14BDDK 02422000
         CLI   0(RE),X'FF'        IS IT END OF TABLE           @D14BDDK 02423000
         BNE   CCIOEL15           NO  CONTINUE INITIALIZATION  @D14BDDK 02424000
         L     R9,CCIOELS9        RESTORE REGISTER R9          @D61RDHH 02425000
CCIOEL20 LA    RE,IOELPTRS-4      ADDRESS IOEL POINTERS-4      @D14BDDK 02426000
CCIOEL25 LA    RE,4(RE)           GET NEXT IOEL POINTER        @D14BDDK 02427000
         CLI   0(RE),XFF          IS IT END OF POINTERS        @D14BDDK 02428000
         BE    CCIOEL30           YES                          @D14BDDK 02429000
         TM    0(RE),IOELUSED     IS IOEL ALREADY USED         @D14BDDK 02430000
         BO    CCIOEL25           YES  CHECK NEXT ONE          @D14BDDK 02431000
         OI    0(RE),IOELUSED     USE IT NOW                   @D14BDDK 02432000
         MVC   AIOEL+1(3),1(RE)   MOVE IOEL ADDR INTO LOW CORE @D14BDDK 02433000
CCIOEL30 DS    0H                 GET PUB POINTER              @D51ADTP 02434000
.CCIOEL9 ANOP                                                  @D51ADTP 02435000
         L     R3,RASWORK1        RELOAD PUB POINTER           @D14BDWK 02436000
         BR    R8                 RETURN ====================> @D14BDWK 02437000
         SPACE 1                                               @D149DWK 02438000
         DROP  R1                 RELEASE CCB BASE             @D14BDWK 02439000
         DROP  R2                 RELEASE ERBLK BASE           @D14BDWK 02440000
         DROP  R3                 RELEASE PUB BASE             @D14BDWK 02441000
         DROP  R4                 RELEASE CHANQ BASE           @D14BDWK 02442000
         DROP  R9                 RELEASE IOINTER BASE         @D14BDWK 02443000
         SPACE 1                                               @DA41332 02444000
CCIOELS9 DC    A(0)               SAVE AREA FOR REGISTER R9    @D61RDHH 02445000
         SPACE 1                                               @D61RDHH 02446000
ACCHSRDA DC    A(MACHSRDA)        MACHK SUBRT AND DATA ADDRESS @DA41332 02447000
CCHANSAV DC    16F'0'             CHANNEL CHECK SAVE AREA      @DA41332 02448000
IRBSAV   DC    4F'0'              IRB SAVE AREA                @D63JDHH 02449000
         SPACE 1                                               @DA41332 02450000
         DROP  RB                 RELEASE MACHINE CHECK BASE   @DA41332 02451000
         TITLE 'VSE/ESA COMMON SUBROUTINES AND DATA AREA              ' 02452000
***************************************************************@DA41332 02453000
*        MACHINE CHECK COMMON SUBROUTINES AND DATA AREA        @DA41332 02454000
***************************************************************@DA41332 02455000
         SPACE 2                                               @DA41332 02456000
         USING *,RA                                            @DA41332 02457000
CCHKSRDA DS    0H                 BASE FOR CC SUBROUT AND DATA @DA41332 02458000
MACHSRDA DS    0H                 BASE FOR MC SUBROUT AND DATA @DA41332 02459000
*********************************************************************** 02460000
*        R A S   M O N I T O R   R O U T I N E                        * 02461000
*                                                                     * 02462000
* FUNCTION                                                            * 02463000
*    SCHEDULE I/O REQUESTS FOR THE RTA MODULES                        * 02464000
*    FETCH MODULES INTO THE RTA                                       * 02465000
*                                                                     * 02466000
*    THE RAS MONITOR ACTS AS AN INTERFACE BETWEEN THE RTA AND THE     * 02467000
*   SUPERVISOR.  IT WILL SCHEDULE I/O REQUESTS FROM THE RTA AND       * 02468000
*   RETURN CONTROL TO THE RTA WHEN THE I/O REQUEST IS COMPLETE.       * 02469000
*                                                                     * 02470000
*    WHEN AN RTA MODULE COMPLETES IT'S FUNCTION OR REQUIRES THE       * 02471000
*    SERVICES OF ANOTHER RTA MODULE, THIS ROUTINE WILL FETCH THE      * 02472000
*    MODULE INTO THE RTA.  TO PERFORM THE FETCH, THE ENTRY IN THE     * 02473000
*    LOAD LIST FOR THE MODULE TO BE FETCHED WILL BE EXPANDED INTO     * 02474000
*    AN ABSOLUTE SEEK ADDRESS AND THE MODULE IS READ INTO THE RTA.    * 02475000
*                                                                     * 02476000
*    THIS ROUTINE WILL GAIN CONTROL FROM THE SUPERVISOR AT EXIT       * 02477000
*    TIME WHEN THE RAS ACTIVE BIT IS ON.  IF THE I/O REQUEST HAS      * 02478000
*    COMPLETED, CONTROL IS RETURNED TO THE RTA MODULE.  IF THE I/O    * 02479000
*    REQUEST HAS NOT COMPLETED, THE SUPERVISOR REGAINS CONTROL.       * 02480000
*                                                                     * 02481000
*    IN AN EMERGENCY SITUATION THE NORMAL I/O REQUEST IS BYPASSED AND * 02482000
*    THE ERROR SIO ROUTINE IN THE SUPERVISOR IS USED TO PERFORM THE   * 02483000
*    I/O REQUESTS FOR THE RTA MODULES.                                * 02484000
*                                                                     * 02485000
* ENTRY POINTS                                                        * 02486000
*         RASUPR   FROM SUPERVISOR EXIT ROUTINES WHEN RAS IS ACTIVE   * 02487000
*         RASIOR   FROM RTA MODULES TO REQUEST I/O                    * 02488000
*                                                                     * 02489000
* INPUT                                                               * 02490000
*    REGISTER 3    INDEX TO LOAD LIST ENTRY OF MODULE TO BE FETCHED   * 02491000
*    REGISTER 7    RETURN ADDRESS FOR THE RTA MODULE MAKING REQUEST   * 02492000
*    REGISTER 8    ADDRESS OF THE RTAIOB OF MODULE MAKING REQUEST     * 02493000
*                 (REGISTERS 7 AND 8 ARE TAKEN FROM TRANSAV)          * 02494000
*                                                                     * 02495000
* OUTPUT  NOT APPLICABLE                                              * 02496000
*                                                                     * 02497000
* EXTERNAL REFERENCES                                                 * 02498000
*            LABEL    NAME AND LOCATION                               * 02499000
*         SYSREGS  SAVE AREA FOR SUPERVISOR REGISTERS IN RAS TABLE    * 02500000
*         TRANSAV  SAVE AREA FOR RTA REGISTERS IN RAS TABLE           * 02501000
*         RTAOWN   OWNERSHIP BYTE OF RTA IN RAS TABLE                 * 02502000
*         RTARETRN RETURN TO RTA MODULE VIA RTA FUNCTION              * 02503000
*         RTA      RAS TRANSIENT AREA                                 * 02504000
*         RASCCWS  RAS FETCH CCW CHAIN IN THE RAS TABLE               * 02505000
*         RASTTR   LOAD LIST IN THE RAS TABLE                         * 02506000
*         RASEEK   DATA ADDRESS FOR SEEK CCW IN RAS TABLE             * 02507000
*         CAW      CHANNEL ADDRESS WORD IN LOW CORE                   * 02508000
*         RASRES   DEVICE ADDRESS OF SYSRES IN THE RAS TABLE          * 02509000
*         RASEIO10 ERROR SIO ROUTINE IN RTA FUNCTIONS                 * 02510000
*         RTAID    ID OF I/O REQUEST FOR RTA MODULE IN RAS TABLE      * 02511000
*         RASCCB   RAS CCB IN THE RAS TABLE                           * 02512000
*         RASTIB   RAS CCB TRAFFIC INFORMATION                        * 02513000
*         SYSFLAG3 SYSTEM FLAG BYTE 3 IN SUPERVISOR                   * 02514000
*         CONFIGR  MACHINE CONFIGURATION BYTE IN COMRG                * 02515000
*         LCBYTE   LINKAGE CONTROL BYTE IN COMRG                      * 02516000
*         IONPSW   I/O NEW PSW (ONLY IF EMERGENCY EXIT)               * 02517000
*                                                                     * 02518000
* EXITS,NORMAL                                                        * 02519000
*         RTARETRN RETURN TO RTA MODULE                               * 02520000
*         RTA+10   INITIAL ENTRY TO RTA MODULE                        * 02521000
*                                                                     * 02522000
* EXITS,ERROR                                                         * 02523000
*         EMGEX8   UNRECOVERABLE ERROR ON RAS FETCH REQUEST           * 02524000
*         RASHWTEX HARD WAIT IF EMERGENCY I/O CAUSES IRREC. I/O ERROR * 02525000
*                                                                     * 02526000
* TABLES/WORK AREAS,NOT APPLICABLE                                    * 02527000
*                                                                     * 02528000
* ATTRIBUTES                                                          * 02529000
*    REENTRANT,DISABLED,PRIVILEGED,RESIDENT                           * 02530000
*                                                                     * 02531000
* CHARACTER CODE DEPENDENCY  NOT APPLICABLE                           * 02532000
*                                                                     * 02533000
* NOTES                                                               * 02534000
*    THE RAS MONITOR IS ACTIVE ONLY AFTER A MACHINE CHECK OR A        * 02535000
*    CHANNEL CHECK.  IT REMAINS ACTIVE UNTIL ALL FUNCTIONS HAVE       * 02536000
*    BEEN COMPLETED BY THE RTA MODULES.                               * 02537000
*********************************************************************** 02538000
         SPACE 2                                               @DA41332 02539000
RASUPR   DS    0H                                              @D61DDHH 02540000
*        DEBUG ALLREGS,XXDBGMC    ALL REGS DEBUG               @D61DDHH 02541000
         DEBUG ALLREGS,XXDBGMC    ALL REGS DEBUG               @D61DDHH 02542000
         L     R7,MCSTKQUE        GET MACHINE CHK STACK POINTR @DA41332 02543000
         LTR   R7,R7              ANY MACHINE CHECK QUEUED     @DA41332 02544000
         BZ    RASMON20           NO, CHECK FOR CRW QUEUE      @DA41332 02545000
         ST    R7,RASMCERQ        MAKE ENTRY AVAIL FOR TRANS   @DA41332 02546000
         L     R7,RASLINKA        GET RASLINK ADDRESS          @D61RDHH 02547000
         OI    RASFLAGS-RASLINK(R7),RASMCACT  IND. MACH.CHECK  @D61RDHH 02548000
         B     RASMON70           PROCESS MACHINE CHECK ENTRY  @DA41332 02549000
         SPACE 1                                               @DA41332 02550000
RASMON20 MVC   MCSTKNXT,MCSTKBEG  RESET MC QUEUE TO BEGINNING  @DA41332 02551000
         L     R7,MCRWSQUE        GET MACHINE CRW STACK POINT  @DA41332 02552000
         LTR   R7,R7              ANY MACHINE CHECK QUEUED     @DA41332 02553000
         BZ    RASMON40           NO, CHECK FOR CH CHECK QUEUE @DA41332 02554000
         ST    R7,RASMCERQ        MAKE ENTRY AVAIL FOR TRANS   @DA41332 02555000
         L     R3,RASLINKA        GET RASLINK ADDRESS          @D61RDHH 02556000
         OI    RASFLAGS-RASLINK(R3),RASCRWAC    IND.CRW PROC.  @D61RDHH 02557000
         TM    RASRSFLG-RASLINK(R3),RASDEBUG  RAS DEBUG ACTIVE @D61RDHH 02558000
         BZ    RASMON70           NO, CONTINUE                 @DA41332 02559000
         BAL   R3,RCRWDEBG        GO TO RASDEBUG ROUTINE       @DA41332 02560000
         B     RASMON70           PROCESS CRW ENTRY            @DA41332 02561000
         SPACE 1                                               @DA41332 02562000
RASMON40 MVC   MCRWSNXT,MCRWSBEG  RESET CRW QUEUE TO BEGINNING @DA41332 02563000
         L     R7,AERBLOC         LOAD ERBLOC POINTER          @DA41332 02564000
         USING ERBLOC,R7          DECLARE ERBLOC BASE          @D14BDWK 02565000
         L     R2,RASERCHN        GET FIRST ENTRY IN RAS CHAIN @D14BDWK 02566000
         LTR   R2,R2              IS ANY ERBLK QUEUED          @D14BDWK 02567000
         BNZ   RASMON50           YES  =====================>  @D51IDGN 02568000
         B     RASEND00           GO, DEACTIVATE RAS           @DA41332 02569000
         SPACE 1                                               @DA41332 02570000
         USING ERBLKADR,R2        DECLARE ERROR ENTRY BASE     @D14BDWK 02571000
RASMON50 MVC   WEPIBCSW,CCEQCSW   MOVE CSW                     @D51IDGN 02572000
         MVC   WEPIBIOE,CCEQIOEL  MOVE IOEL ADDRESS            @D21WDAP 02573000
         MVC   WEPIBDMC,CCEQDMC   MOVE CHANNEL INDICATOR       @D21WDAP 02574000
         MVC   WEPIBPUB,CCEQPUB   MOVE PUB ADDRESS             @D21WDAP 02575000
         MVC   WEPIBCQP,CCEQCQP   MOVE CHANQ PRESENT INDICATOR @D51ODGL 02576000
         MVC   WEPIBCQA,ERRQCHQA  MOVE CHANQ PTR OR 0          @D51ODGL 02577000
         MVC   WEPIBRTC,CCEQRTC   MOVE RETRY COUNTER           @D21WDAP 02578000
         MVC   WEPIBMSG,CCEQMSG   MOVE MESSAGE CODE            @D21WDAP 02579000
         MVC   WEPIBRQN,CCEQTIDN  MOVE TASK ID                 @D66ODOW 02580000
         MVC   WEPIBFLG,CCEQFLG   MOVE FLAG BYTE               @D21WDAP 02581000
         MVC   WEPIBESW,CCEQECSW  MOVE ECSW INFORMATION        @D21WDAP 02582000
         MVC   WEPIBQA,CCEQRINF   MOVE ADDR TO CC STACK ENTRY  @D61SDHH 02583000
         MVC   RASERCHN,ERBLKPTR  DEQUEUE ACTIVE ENTRY         @D14BDWK 02584000
         XC    ERBLKPTR,ERBLKPTR  CLEAR CHAIN POINTER          @D14BDWK 02585000
         NI    ERBLKFLG,XFF-ERACTIVE-ERQUEUED  RESET ACTIVE    @D14BDWK 02586000
         NI    ERBLKFL1,XFF-NEEDRAS            INDICATORS      @D14BDWK 02587000
         DROP  R2                 RELEASE ERROR ENTRY BASE     @D14BDWK 02588000
         OC    V31VCCWA,V31VCCWA  Virtual CCW addr for VTAM?   @DY46396 02588100
         BZ    RASMON55           .. no                        @DY46396 02588200
         MVC   WEPIBV31,V31VCCWA  ..yes, move into WEPIB       @DY46396 02588300
         XC    V31VCCWA,V31VCCWA  Clear addr in work field     @DY46396 02588400
RASMON55 DS    0H                                              @DY46396 02588500
         STCK  TODCLOCK           STORE TOD CLOCK              @DA41332 02589000
         MVC   WEPIBTOD(8),TODCLOCK  MOVE INTO WEPIB           @DA41332 02590000
         L     R3,RASLINKA        GET RASLINK ADDRESS          @D61RDHH 02591000
         OI    RASFLAGS-RASLINK(R3),RASCCACT  IND.CHANNEL CK   @D61RDHH 02592000
         TM    RASRSFLG-RASLINK(R3),RASNOMSG  ERROR ON SYSLOG  @D61RDHH 02593000
         BZ    RASMON60           NO                           @DA41332 02594000
         CLC   WEPIBRQN,RASTIDH   CC ON RAS I/O REQUEST        @D66GDHH 02595000
         BNE   RASMON60           NO                           @DA41332 02596000
         SR    R3,R3              CLEAR REGISTER TO            @D14BDWK 02597000
         ICM   R3,3,WEPIBPUB      INSERT PUB ADDRESS           @D14BDWK 02598000
         USING PUBADR,R3          PUB TABLE ENTRY BASE         @D14BDWK 02599000
         CLC   PUBCHANN(2),SYSOCDEV  CC ON SYSLOG              @D14BDWK 02600000
         BNE   RASMON60           NO                           @DA41332 02601000
         DROP  R3                 RELEASE PUB TABLE ENTRY BASE @D14BDWK 02602000
         L     R3,RASLINKA        GET RASLINK ADDRESS          @D61RDHH 02603000
         OI    RASFLAGS-RASLINK(R3),RASEMGEX       IND.EM.CASE @D61RDHH 02604000
         MVI   SYSS00,C'H'        UNRECOVERABLE CC ON SYSLOG   @D14BDWK 02605000
         MVI   SYSS00+1,X'00'     CLEAR UNUSED BYTE 1          @D14BDWK 02606000
         MVI   SYSS00+2,C'A'      RECORDING UNSUCCESFULL       @D14BDWK 02607000
         DROP  R7                 RELEASE ERBLOC BASE          @D14BDWK 02608000
         SPACE 1                                               @D149DWK 02609000
RASMON60 DS    0H                                              @D66GDHH 02610000
.* Next step will be a switch-owner to the task that got the   @DY46233 02610050
.* channel check. This is not done for those channel checks    @DY46233 02610100
.* where the PUB has not been "queued in error", because in    @DY46233 02610150
.* this case the original task may not have existed anymore    @DY46233 02610200
.* when the RAS task was started.                              @DY46233 02610250
.* The PUB has not been set "queued in error" by the resident  @DY46233 02610300
.* ChannelCheck handler, when we had a CC on DASD, or when it  @DY46233 02610350
.* was uncoverable, or when the user has had its own error     @DY46233 02610400
.* handling.                                                   @DY46233 02610450
         LA    R2,RASTID          Preload our Task-Id          @DY46233 02610500
         TM    WEPIBFLG,CCDSK     CC on DASD?                  @DY46233 02610550
         BO    RASMON65           .. yes, run for ourselves    @DY46233 02610600
         CLI   WEPIBMSG,CCHRD     CC unrecoverable?            @DY46233 02610650
         BE    RASMON65           .. yes, run for ourselves    @DY46233 02610700
         CLI   WEPIBMSG,CCERR     User own error handling?     @DY46233 02610750
         BE    RASMON65           .. yes, run for ourselves    @DY46233 02610800
         LH    R2,WEPIBRQN        INSERT REQUESTING TASK ID    @D66GDHH 02611000
RASMON65 DS    0H                                              @DY46233 02611300
*        SGSETUP SWOWNER,STASK=RAS,OPTION=SETOWNER,WR1=R2,WR2=R3        02611600
         SGSETUP SWOWNER,STASK=RAS,OPTION=SETOWNER,WR1=R2,WR2=R3        02612000
         SPACE 1                                               @D149DWK 02613000
RASMON70 DS    0H                                              @D61DDHH 02614000
*        DEBUG ALLREGS,XXDBGMC                                 @D61DDHH 02615000
         DEBUG ALLREGS,XXDBGMC                                 @D61DDHH 02616000
         TM    IJBFLG08,IJBSAENV  IN SA-ENVIRONMENT?           @D61DDHH 02617000
         BNO   RASMON75           .. NO, CONTINUE NORMAL       @D61DDHH 02618000
         TM    IJBFLG08,IJBSVALC  ..YES, SVA LOAD COMPLETE?    @D61DDHH 02619000
         BNO   RASTRSKP               ..YES, SKIP RAS-TRANSIENT@D61DDHH 02620000
RASMON75 CLI   RTAOWN,RASZERO     IS $$RAST00 IN THE RTA       @D61DDHH 02621000
         BE    RASMON90           YES                          @DA41332 02622000
         SR    R3,R3              SET PHASE ID                 @D14BDWK 02623000
RASMON80 STC   R3,RTAOWN          SET NEW OWNER OF RTA         @DA41332 02624000
         BAL   R7,RASFCH00        LOAD R-TRANSIENT             @D31EMGN 02625000
RASMON90 STM   R0,RF,SYSREGS      SAVE SUPERVISOR REGISTERS    @DA41332 02626000
         LM    R0,R4,TRANREGS     LOAD COMMON TRANSIENT REGS   @D14ADWK 02627000
         L     RC,RASLINKA        GET RASLINK ADDRESS          @D61RDHH 02628000
         L     RC,RASTAREA-RASLINK(,RC)   SET BASE FOR THE RTA @D61RDHH 02629000
         USING RTA,RC             RTA BASE POINTER             @D21YDGN 02630000
         B     RTAENTRY           ENTER RAS TRANSIENT          @D367DJR 02631000
         SPACE 1                                               @D149DWK 02632000
         DROP  RC                 RELEASE RAS TRANSIENT BASE   @D21YDGN 02633000
         SPACE 1                                               @D377DJR 02634000
TRANREGS DS    0F                 ALIGN                        @D37BDJR 02635000
         DC    A(SYSS00)          POINTER TO LOW CORE          @D14ADWK 02636000
         DC    A(RASTAB)          POINTER TO RAS-TABLE         @D37BDJR 02637000
         DC    A(RASLINK)         POINTER TO RAS LINKAGE AREA  @D37BDJR 02638000
         DC    A(RFTABLE)         POINTER TO RF-TABLE          @D37BDJR 02639000
         DC    A(SYSCOM)          POINTER TO SYSCOM            @D37BDJR 02640000
         TITLE 'VSE/AF SUPERVISOR   MCRAS TRANSIENT TERMINATION       ' 02641000
***************************************************************@DA41332 02642000
*        RAS TASK - TRANSIENT TERMINATION                      @DA41332 02643000
***************************************************************@DA41332 02644000
         SPACE 2                                               @DA41332 02645000
.* IN A SA-ENVIRONMENT, WHERE THE SVA LOAD IS NOT YET COMPLETE,@D61DDHH 02646000
.* A CHANNEL CHECK OR A MACHINE CHECK WITH SYSTEM TERMINATION  @D61DDHH 02647000
.* REQUIRED RESULTS IN A HARDWAIT.                             @D61DDHH 02648000
RASTRSKP DS    0H                                              @D61DDHH 02649000
*        DEBUG ALLREGS,XXDBGMC                                 @D61DDHH 02650000
         DEBUG ALLREGS,XXDBGMC                                 @D61DDHH 02651000
         TM    RASFLAGS,RASCCACT          CHANNEL CHECK?       @D61DDHH 02652000
         BO    EMGEX010                   .. YES, HARDWAIT     @D61DDHH 02653000
         TM    RASFLAGS,RASMCACT+RASEMGEX MC WITH SYST. TERM.? @D61DDHH 02654000
         BO    RASHWT0A                   .. YES, HARDWAIT     @D61DDHH 02655000
         SPACE 1                                               @D61DDHH 02656000
RASTREND L     R7,RASMCERQ        TEST IF MACHINE CHECK ...    @DA41332 02657000
         LTR   R7,R7                END PROCESSING             @DA41332 02658000
         BZ    RTENDCC            NO, CHECK FOR CC PROCESSING  @D61SDHH 02659000
         CLC   RASMCERQ,MCSTKQUE  MACHINE CHECK TO BE DEQUEUED @DA41332 02660000
         BNE   RTENDCRW           NO, DO CRW DEQUEUE PROCESSNG @DA41332 02661000
         USING MCST$DS,R7         ESTABLISH MC STACK ENTR BASE @DA41332 02662000
         MVC   MCSTKQUE,MCST$NXT  DEQUEUE CURRENT STACK ENTRY  @DA41332 02663000
         XC    MCST$NXT,MCST$NXT  FREE CURRENT STACK ENTRY     @DA41332 02664000
         B     RTENDRET           CHECK FOR MORE WORK TB DONE  @DA41332 02665000
         SPACE 1                                               @DA41332 02666000
         DROP  R7                 RELEASE MCH CHECK STACK BASE @DA41332 02667000
         SPACE 1                                               @DA41332 02668000
         USING MCRW$DS,R7         ESTABLISH CRW STCK ENTR BASE @DA41332 02669000
RTENDCRW NC    MCRWSQUE,MCRWSQUE  ALL CRW'S PROCESSED          @DA41332 02670000
         BZ    RTENDRET           YES,                         @DA41332 02671000
         MVC   MCRWSQUE,MCRW$NXT  DEQUEUE CURRENT STACK ENTRY  @DA41332 02672000
         XC    MCRW$NXT,MCRW$NXT  FREE CURRENT STACK ENTRY     @DA41332 02673000
RTENDRET XC    RASMCERQ,RASMCERQ  INDICATE MACH CHECK HANDLED  @DA41332 02674000
         B     RASUPR             CHECK FOR MORE WORK TB DONE  @DA41332 02675000
         DROP  R7                 RELEASE MCH CRW STACK BASE   @DA41332 02676000
         SPACE 1                                               @DA41332 02677000
RTENDCC  NC    CCSTKQUE,CCSTKQUE  CC STACK ENTRY PROCESSED     @D61SDHH 02678000
         BZ    RASUPR            .. NO                         @D61SDHH 02679000
*        SGCOV MCRAS             TPA COVERAGE POINT 3005       @D61SDHH 02680000
         SGCOV MCRAS                                           @D61SDHH 02681000
         L     R7,CCSTKQUE        GET CURRENT STACK ENTRY ADDR @D61SDHH 02682000
         USING CCST$DS,R7         BASE DSECT                   @D61SDHH 02683000
         MVC   CCSTKQUE,CCST$NXT  DEQUEUE CURRENT STACK ENTRY  @D61SDHH 02684000
         XC    CCST$NXT,CCST$NXT  FREE CURRENT STACK ENTRY     @D61SDHH 02685000
         DROP  R7                                              @D61SDHH 02686000
         B     RASUPR             CHECK FOR MORE WORK          @D61SDHH 02687000
         SPACE 1                                               @DA41332 02688000
         TITLE 'VSE/AF SUPERVISOR   MCRAS  TASK  DEACTIVATION         ' 02689000
***************************************************************@D149DWK 02690000
*        RAS TASK DEACTIVATION                                 @D149DWK 02691000
***************************************************************@D149DWK 02692000
         SPACE 2                                               @D149DWK 02693000
RASEND00 L     R8,RASLINKA        GET RASLINK ADDRESS          @D61RDHH 02694000
         MVI   RASFLAGS-RASLINK(R8),X'00' RESET RAS STATUS FLAG@D61RDHH 02695000
         L     R8,RASSAVA         POINT TO RAS SAVE AREA       @DY39563 02696000
         USING SVEARA,R8          RAS SAVE AREA BASE           @D36IDJR 02697000
         LA    R7,RASUPR          START ADDRESS OF RAS TASK    @D36IDJR 02698000
         STCM  R7,M7,SVEPSW+5     STORE IN RAS PSW             @D36IDJR 02699000
         DROP  R8                 RELEASE RAS SAVE AREA BASE   @D36IDJR 02700000
         L     R6,DISPAD          GET DISPATCHER BASE          @DA41332 02701000
         USING DISP,R6            DISPATCHER BASE              @DA41332 02702000
         SGSETUP UNPOST,STASK=RAS,WR1=R8 DEACTIVATE RASTASK    @D36IDJR 02703000
*        BR    R6                 TASK SELECTION =========>>>  @D14ZDWK 02704000
         SPACE 1                                               @D149DWK 02705000
         DROP  R6                 RELEASE DISPATCHER BASE      @DA41332 02706000
         TITLE 'VSE/AF SUPERVISOR   MCRAS  DEBUG SERVICES             ' 02707000
***************************************************************@D149DWK 02708000
*        RAS DEBUG SERVICES                                    @D149DWK 02709000
***************************************************************@D149DWK 02710000
         SPACE 2                                               @D149DWK 02711000
         USING MCRW$DS,R7         ESTABLISH CRW STCK ENTR BASE @DA41332 02712000
RCRWDEBG LA    R8,RMHDRCRW        GET MESSAGE CCW ADDRESS      @DA41332 02713000
         ST    R8,RASDBIOP        STORE CCW ADDRESS IN PARM    @DA41332 02714000
         LA    R8,RASDBIOP        GET PARAMETER ADDRESS        @DA41332 02715000
         L     R1,RASLINKA        GET RASLINK ADDRESS          @D61RDHH 02716000
         OI    RASRSFLG-RASLINK(R1),RASMSGIO  REQ.CONS.MESSAGE @D61RDHH 02717000
         L     R1,RASTABA-RASLINK(,R1)      GET RASTAB ADDRESS @D61RDHH 02718000
         MVI   LINKFLAG,RASLIO    INDICATE RAS I/O REQUEST     @DA41332 02719000
         BAL   R7,RASTSCAN        GO TO RAS SERVICE ROUTINE    @DA41332 02720000
         L     R7,RASLINKA        GET RASLINK ADDRESS          @D61RDHH 02721000
         NI    RASRSFLG-RASLINK(R7),XFF-RASMSGIO RESET CONS.MSG@D61RDHH 02722000
         L     R7,RASMCERQ        GET CRW STACK POINTER        @DA41332 02723000
         USING MCRW$DS,R7         ESTABLISH CRW STCK ENTR BASE @DA41332 02724000
         LA    R5,MCRW$FST        GET FIRST CRW ADDRESS        @DA41332 02725000
         LA    R6,MCRW$LST        GET ADD OF LAST CRW IN STACK @DA41332 02726000
         DROP  R7                 RELEASE CRW STCK BASE        @DA41332 02727000
         USING MCRW$ADD,R5        GET CRW BASE                 @DA41332 02728000
RCRWDB10 MVI   RASDBWRK,X'00'       INITIALIZE WORKFIELD       @DA41332 02729000
         MVZ   RASDBWRK(1),MCRW$TYP EXTRACT CRW TYPE INFORM.   @DA41332 02730000
         UNPK  RASDBUNP(3),RASDBWRK(2)                         @DA41332 02731000
         TR    RASDBUNP(2),RMDEBTRT                            @DA41332 02732000
         MVC   RMCRWTYP,RASDBUNP                               @DA41332 02733000
         MVI   RASDBWRK,X'00'       INITIALIZE WORKFIELD       @DA41332 02734000
         MVN   RASDBWRK(1),MCRW$RSC EXTRACT CRW REPORT SOURCE  @DA41332 02735000
         UNPK  RASDBUNP(3),RASDBWRK(2)                         @DA41332 02736000
         TR    RASDBUNP(2),RMDEBTRT                            @DA41332 02737000
         MVC   RMCRWRSC,RASDBUNP                               @DA41332 02738000
         MVC   RASDBWRK(1),MCRW$ERC EXTRACT CRW ERR RECOV CODE @DA41332 02739000
         MVI   RMCRWANC,C' '        INIT ANC.REPORT INDICATOR  @D63JDHH 02740000
         TM    RASDBWRK,CRWANCRP    IS THIS AN ANCILL.REPORT?  @D63JDHH 02741000
         BZ    RCRWDB15             .. NO                      @D63JDHH 02742000
         MVI   RMCRWANC,C'X'        SET INDICATOR IN MSG       @D63JDHH 02743000
         NI    RASDBWRK,XFF-CRWANCRP  AND RESET BIT IN ERC     @D63JDHH 02744000
RCRWDB15 UNPK  RASDBUNP(3),RASDBWRK(2)                         @D63JDHH 02745000
         TR    RASDBUNP(2),RMDEBTRT                            @DA41332 02746000
         MVC   RMCRWERC,RASDBUNP                               @DA41332 02747000
         MVC   RASDBWRK(2),MCRW$RSU EXTRACT CRW REP SOURCE ID  @DA41332 02748000
         UNPK  RASDBUNP(5),RASDBWRK(3)                         @DA41332 02749000
         TR    RASDBUNP(4),RMDEBTRT                            @DA41332 02750000
         MVC   RMCRWRSI,RASDBUNP                               @DA41332 02751000
         MVC   RASDBWRK(2),MCRW$DVN EXTRACT CRW ASS DEV NUMBER @DA41332 02752000
         UNPK  RASDBUNP(5),RASDBWRK(3)                         @DA41332 02753000
         TR    RASDBUNP(4),RMDEBTRT                            @DA41332 02754000
         MVC   RMCRWDVN,RASDBUNP                               @DA41332 02755000
         LA    R8,RMTXTCRW        GET MESSAGE CCW ADDRESS      @DA41332 02756000
         ST    R8,RASDBIOP        STORE CCW ADDRESS IN PARM    @DA41332 02757000
         LA    R8,RASDBIOP        GET PARAMETER ADDRESS        @DA41332 02758000
         MVI   LINKFLAG,RASLIO    INDICATE RAS I/O REQUEST     @DA41332 02759000
         L     R7,RASLINKA        GET RASLINK ADDRESS          @D61RDHH 02760000
         OI    RASRSFLG-RASLINK(R7),RASMSGIO   REQ.CONSOLE MSG @D61RDHH 02761000
         BAL   R7,RASTSCAN        GO TO RAS SERVICE ROUTINE    @DA41332 02762000
         L     R7,RASLINKA        GET RASLINK ADDRESS          @D61RDHH 02763000
         NI    RASRSFLG-RASLINK(R7),XFF-RASMSGIO   RES.CONS.MSG@D61RDHH 02764000
         LA    R5,MCRW$ELN(,R5)   BUMP TO NEXT CRW IN STACK    @DA41332 02765000
         CR    R5,R6              IS LAST POSSIBLE CRW REACHED @DA41332 02766000
         BHR   R3                 YES, RETURN TO MAINLINE      @DA41332 02767000
         NC    MCRW$ADD(MCRW$ELN),MCRW$ADD ANY CRW IN STACK ?  @DA41332 02768000
         BNZ   RCRWDB10           YES, PROCESS NEXT CRW        @DA41332 02769000
         BR    R3                 RETURN TO MAINLINE           @DA41332 02770000
         SPACE 1                                               @DA41332 02771000
.*       DROP  R1                 RELEASE RASTAB               @DELETE  02772000
         DROP  R5                 RELEASE CRW BASE             @DA41332 02773000
         SPACE 1                                               @DA41332 02774000
RASDBUNP DC    CL5' '             UNPACK WORK AREA             @DA41332 02775000
RASDBWRK DC    CL3' '             DEBUG WORK AREA              @DA41332 02776000
         SPACE 1                                               @DA41332 02777000
RASDBIOP DS    0F                 RAS I/O PARAMETER AREA       @DA41332 02778000
         DC    F'0'               RAS I/O CCW ADDRESS          @DA41332 02779000
         DC    H'4'               SYSLOG LUB INDEX             @DA41332 02780000
         SPACE 1                                               @DA41332 02781000
RMDEBTRT EQU   *-240              RAS TRANSLATION TABLE ...    @DA41332 02782000
         DC    C'0123456789ABCDEF'  HEX TO PRINTABLE CHARACTER @DA41332 02783000
         SPACE 1                                               @DA41332 02784000
RMHDRCRW CCW   X'09',RMCRWHDR,X'20',L'RMCRWHDR                 @DA41332 02785000
RMTXTCRW CCW   X'09',RMCRWTXT,X'20',RMCTXTLN                   @DA41332 02786000
         SPACE 1                                               @DA41332 02787000
RMCRWHDR DC    C'CRW  TYPE  REPS  ANCREP  ERCC  REPSID   DVNUM'         02788000
*                                                              @D63JDHH 02789000
RMCRWTXT DC    C'      '          CRW CONTENTS                 @DA41332 02790000
RMCRWTYP DC    C'  '              CRW TYPE OF CRW              @DA41332 02791000
         DC    C'    '            FILLER                       @DA41332 02792000
RMCRWRSC DC    C'  '              CRW REPORTING SOURCE CODE    @DA41332 02793000
         DC    C'     '           FILLER                       @D63JDHH 02794000
RMCRWANC DC    C' '               CRW ANCILLARY REPORT INDIC.  @D63JDHH 02795000
         DC    C'      '          FILLER                       @D63JDHH 02796000
RMCRWERC DC    C'  '              CRW ERROR RECOVERY CODE      @DA41332 02797000
         DC    C'    '            FILLER                       @DA41332 02798000
RMCRWRSI DC    C'    '            CRW REPORTING SOURCE ID      @DA41332 02799000
         DC    C'    '            FILLER                       @DA41332 02800000
RMCRWDVN DC    C'    '            CRW ASSOCIATED DEVICE NUMBER @DA41332 02801000
RMCTXTLN EQU   *-RMCRWTXT         LENGTH OF CRW CONTENTS       @DA41332 02802000
         TITLE 'VSE/AF SUPERVISOR   MCRAS    RTA SERVICES             ' 02803000
***************************************************************@DA41332 02804000
*        RAS RTA SERVICES                                      @D36ZDJR 02805000
*                                                              @DA41332 02806000
*                                                              @DA41332 02807000
*                                                              @DA41332 02808000
*                                                              @DA41332 02809000
*                                                              @DA41332 02810000
*                                                              @DA41332 02811000
***************************************************************@DA41332 02812000
         SPACE 2                                               @D36ZDJR 02813000
         USING RASTAB,R1          DECLARE BASE                          02814000
RASTSCAN STM   R0,RF,TRANSAV      SAVE RTA REGISTERS                    02815000
         AIF   (NOT &BGDEBUG).NMC030                           @D14BDAP 02816000
         SLR   R0,R0              CLEAR REGISTER               @D14BDAP 02817000
         IC    R0,LINKFLAG        GET FUNCTION BYTE IN R0      @D14BDAP 02818000
*        DEBUG ALLREGS,XXDBGMC    PROVIDE ALL REGISTERS        @D61DDHH 02819000
         DEBUG ALLREGS,XXDBGMC    PROVIDE ALL REGISTERS        @D61DDHH 02820000
.NMC030  ANOP                                                  @D14BDAP 02821000
         LM    R0,RF,SYSREGS      RESTORE RESIDENT REGISTERS   @D36ZDJR 02822000
         DROP  R1                 DROP BASE FOR RAS-TABLE      @D36IDJR 02823000
         MVC   RASWORK1(L1),LINKFLAG SAVE LINKFLAG             @D14BDWK 02824000
         MVI   LINKFLAG,X00       CLEAR LINKFLAG               @D14BDWK 02825000
         CLI   RASWORK1,RASLFTCH  FETCH REQUEST                @D36ZDJR 02826000
         BE    RASFTCH            YES                          @D36ZDJR 02827000
         CLI   RASWORK1,RASLWAIT  IS REQUEST FOR WAIT          @D36ZDJR 02828000
         BE    RASWAIT            YES,DO THIS FUNCTION         @D36ZDJR 02829000
         CLI   RASWORK1,RASLIO    NORMAL I/O REQUEST           @D36ZDJR 02830000
         BE    RASIORQ            YES                          @D36ZDJR 02831000
         CLI   RASWORK1,RASLEMIO  EMERGENCY I/O                @D36ZDJR 02832000
         BE    RASEMGIO           YES                          @D36ZDJR 02833000
         LA    R5,RTARET          ADDR TO RETURN TO RAS TRANS  @DY44069 02834000
         CLI   RASWORK1,RASLDEQ   DEQUEUE A CCB                @D36ZDJR 02835000
         BE    RASDEQ00           YES                          @D14ZDWK 02836000
*        CLI   RASWORK1,RASLTIME  GETIME REQUEST               @DELETE  02837000
*        BE    RASTIMER           YES,SIMULATE GETIME          @DELETE  02838000
         CLI   RASWORK1,RASLPDEQ  PAGE FRAME DEQUEUE REQUEST   @D36ZDJR 02839000
         BE    RASPDEQ            YES, DEQUEUE ROUTINE         @D35EDSK 02840000
         CLI   RASWORK1,RASLFREE  IS IOEL TO BE FREED          @D14BDDK 02841000
         BE    RASFREE1           YES                          @D14BDDK 02842000
         B     RASTREND           TERMINATE RAS TRANSIENT      @DA41332 02843000
         SPACE 1                                               @D149DWK 02844000
***************************************************************@D149DAP 02845000
*        RAS FETCH                                             @D149DAP 02846000
***************************************************************@D149DAP 02847000
         SPACE 2                                               @D149DWK 02848000
RASFTCH  L     R3,TRANSAV3        LOAD PHASE ID                @D14ZDWK 02849000
         B     RASMON80                =====================>  @D14BDWK 02850000
         TITLE 'VSE/AF SUPERVISOR   MCRAS    FETCH RAS TRANSIENTS     ' 02851000
***************************************************************@D149DWK 02852000
*        FETCH RAS-TRANSIENTS                                  @D149DWK 02853000
***************************************************************@D149DWK 02854000
         SPACE 2                                               @D149DWK 02855000
RASFCH00 LA    RE,3               SET UP RETRY COUNT           @D14BDAP 02856000
         SLL   R3,3               MULTIPLY BY 8                @D14BDWK 02857000
RASFCH10 L     R1,RASLINKA        GET RASLINK ADDRESS          @D61RDHH 02858000
         L     R0,RASTAREA-RASLINK(,R1)    GET LOAD ADDR IN R0 @D61RDHH 02859000
         LA    R1,RASNMTAB(R3)    GET POINTER TO PHASENAME     @D14BDWK 02860000
         SPACE 1                                               @D149DWK 02861000
         LOAD  (1),(0),RET=YES    LOAD RAS TRANSIENT           @D14BDWK 02862000
         SPACE 1                                               @D149DWK 02863000
         LTR   RF,RF              WAS FETCH SUCCESSFUL         @DA41332 02864000
         BZR   R7                 YES    ===================>  @D14BDWK 02865000
         BCT   RE,RASFCH10        RETRY AT LEAST 3 TIMES       @D14BDAP 02866000
         L     RE,RASLINKA        GET ADDRESS OF RASLINK       @D61RDHH 02867000
         TM    RASFLAGS-RASLINK(RE),RASEMGEX   EMERGENCY SIT.  @D61RDHH 02868000
         BO    RASHWT10           YES    ===================>  @D21YDGN 02869000
         TM    RASFLAGS-RASLINK(RE),RASMCACT   MACH.CHK HANDL. @D61RDHH 02870000
         BO    RASHWT0A           YES    ===================>  @D14BDWK 02871000
         TM    RASFLAGS-RASLINK(RE),RASCRWAC   CRW HANDLING    @DY44069 02872000
         BO    RASTREND           YES                          @DY44069 02873000
*                                 NO, MUST BE CC HANDLING      @DY44069 02874000
         CLC   WEPIBRQN,SUPTIDH   CC ON FETCH REQUEST          @D66GDHH 02875000
         BE    EMGEX010           YES SKIP RECORDING           @DY45789 02876000
         BAL   R5,RASFREE1        FREE IOEL ================>  @D14BDWK 02877000
         TM    WEPIBFLG,CCDSK     WAS THIS A DASD              @D21WDAP 02878000
         BO    RASTREND           YES, SKIP RECORDING          @DA41332 02879000
         LH    R3,WEPIBPUB        GET PUB ADDRESS IN R3        @D21WDAP 02880000
         BAL   R5,RASDEQ10        GET ENTRY DEQUEUED           @D14BDAP 02881000
         B     RASTREND           PROCESS NEXT ENTRY IF ANY    @DA41332 02882000
         SPACE 1                                               @D149DWK 02883000
***************************************************************@D149DWK 02884000
*        RETURN TO RAS TRANSIENT AREA AFTER REQUESTED SERVICE  @D219DGN 02885000
***************************************************************@D149DWK 02886000
         SPACE 2                                               @D149DWK 02887000
RTARET   STM   R0,RF,SYSREGS      SAVE RESIDENT REGISTERS      @D14BDAP 02888000
         LM    R0,RF,TRANSAV      RESTORE RTA REGISTERS        @D14BDAP 02889000
         BR    R7                 RETURN TO RTA                @D14BDAP 02890000
         SPACE 1                                               @D149DWK 02891000
***************************************************************@D149DWK 02892000
*        RAS SIMULATED WAIT                                    @D149DWK 02893000
***************************************************************@D149DWK 02894000
         SPACE 2                                               @D149DWK 02895000
RASWAIT  L     R7,RFTABAD         POINT TO RFTABLE             @D36ZDJR 02896000
         USING RFTABLE,R7         RFTABLE BASE POINTER         @D149DWK 02897000
.*       LA    R1,ZEROBYTE-D2     POINT TO DUMMY CCB           @DA41332 02898000
         LA    R1,RASDECB         POINT TO DUMMY ECB           @D68OMHH 02899000
         OI    SYSFLAG3,WAITRAS   INDICATE RAS WAIT            @DA41332 02900000
         TM    RFFLAGS2,RFPTAOWN+RFEREP  RECORDER FILE IN USE  @D149DWK 02901000
         DROP  R7                 RELEASE RFTABLE BASE         @D149DWK 02902000
         BZ    RASWAIT1           NO                           @DA41332 02903000
         SVC   WAIT               ISSUE WAIT                            02904000
RASDECB  DC    F'0'               RAS DUMMY ECB                @D68OMHH 02905000
RASWAIT1 NI    SYSFLAG3,XFF-WAITRAS  RESET RAS WAIT            @DA41332 02906000
         B     RTARET                =======================>  @DA41332 02907000
         SPACE 1                                               @D149DWK 02908000
***************************************************************@D149DAP 02909000
*        RAS NORMAL I/O REQUEST                                @D149DAP 02910000
*        RTACCB ALREADY SET UP                                 @D149DAP 02911000
***************************************************************@D149DAP 02912000
         SPACE 2                                               @D149DWK 02913000
RASIORQ  L     R8,RASLINKA        GET RASLINK ADDRESS          @D61RDHH 02914000
         OI    RASFLAGS-RASLINK(R8),RTAIOA  SET RAS I/O ACTIVE @D61RDHH 02915000
         L     R8,TRANSAV8        GET IOB POINTER              @D36ZDJR 02916000
         L     R1,D0(R8)          GET RTA CCW ADDRESS                   02917000
         LH    R2,D4(R8)          GET RTA LUBNO/PUBADDR        @D35IDAZ 02918000
         ST    R1,RASCCB+8        SET UP THE CCW ADDRESS       @D14BDWK 02919000
         STH   R2,RASCCB+6        PUT LUB NUMBER IN CCB                 02920000
         LA    R1,RASCCB          GET ADDRESS OF RAS CCB                02921000
         TM    RTAID,RASRTYID     IS IT RETRY                  @DM01647 02922000
         BZ    RASIO010           NO,DO NOT MODIFY             @D14BDWK 02923000
         USING CCBADR,R1          SET BASE FOR CCB             @D36IDJR 02924000
         OI    CCBBY3,ERRTIN      DON'T RESET PUB ERROR COUNT  @D35IDSK 02925000
         SH    R2,YPUBTAB         FOR RAS RETRY CONVERT        @D35IDAZ 02926000
         SRL   R2,PUBSLEN         PUB OFFSET TO PUB INDEX      @D51ODGL 02927000
         STH   R2,RASCCB+6         REPLACE LUBNO IN CCB        @D35IDAZ 02928000
         OI    CCBCLS,CCBPHYAD    INDICATE PHYS. ADDRESSING    @D35IDAZ 02929000
         TM    RTAID,RASRTYXR     RETRY FOR EXCP REAL?         @D61SDHH 02930000
         BZ    RASIO010           ..NO                         @D61SDHH 02931000
         OI    CCBCLS,XCPR        ..YES, REQUEST REAL AGAIN    @D61SDHH 02932000
RASIO010 LA    R3,3               SET RETRY COUNT              @DA35277 02933000
         L     R8,RASLINKA        GET RASLINK ADDRESS          @D61RDHH 02934000
         TM    RASRSFLG-RASLINK(R8),RASMSGIO  MESSAGE REQUEST  @DY43346 02935000
         BO    RASIO025           YES, NO HEADQUEUE            @DY43346 02936000
         SYSIO (1)                ISSUE SVC 15 / SVC 7         @DY43346 02937000
         B     RASIO030           IO IS COMPLETE               @DY43346 02938000
RASIO025 EXCP  (1)                ISSUE I/O                    @DY43275 02939000
         WAIT  (1)                                             @DY43275 02940000
         TM    CCBCOM1,DISERR     ANY I/O ERROR POSTED         @D14BDWK 02941000
         BZ    RASIO030           NO                           @D14BDWK 02942000
         BCT   R3,RASIO025        RETRY AT LEAST 3 TIMES       @D14BDWK 02943000
         MVI   IJBHWORG,HWORG084  UNIQUE HARD WAIT ORIGINATOR  @D31QDHB 02944000
         BAL   R5,SYSERROR        SETUP SYSTEM WAIT            @DA35404 02945000
RASIO030 NI    RASFLAGS-RASLINK(R8),XFF-RTAIOA  RAS IO COMPL.? @D61RDHH 02946000
         NI    CCBBY3,XFF-ERRTIN  INDICATE ERROR COUNT RESET   @D35IDSK 02947000
         TM    RTAID,RASRTYID     IS IT RETRY                  @DA33850 02948000
         BZ    RTARET             NO  RTARET ===============>  @DA41332 02949000
         NI    RTAID,X'FF'-RASRTYID-RASRTYXR                   @D61SDHH 02950000
*                                   RESET RAS RETRY INDICATOR  @D61SDHH 02951000
         MVI   WEPIBSTC,WEPIBCCS  INDICATE RETRY SUCCESSFUL    @D21WDAP 02952000
         TM    CCBCOM1,DISERR     ANY I/O ERROR POSTED         @DA33850 02953000
         BZ    RTARET             NO  RTARET ===============>  @DA41332 02954000
         MVI   WEPIBSTC,WEPIBCCR  INDICATE RETRY UNSUCCESSFUL  @D21WDAP 02955000
         B     RTARET             RTARET  ==================>  @DA41332 02956000
         SPACE 1                                               @D149DWK 02957000
         DROP  R1                 DROP BASE FOR CCB            @D36IDJR 02958000
         EJECT                                                 @D149DAP 02959000
***************************************************************@D149DAP 02960000
*        RAS EMERGENCY I/O REQUEST                             @D149DAP 02961000
*        CAW ALREADY SET UP                                    @D149DAP 02962000
***************************************************************@D149DAP 02963000
         SPACE 2                                                        02964000
RASEMGIO DS    0H                                              @D61RDHH 02965000
         CLI   RID+D1,USERTID     (RAS) TASK PROCESSING ?      @D61RDHH 02966000
         BE    RASEMG02           .. YES, CONTINUE             @D61RDHH 02967000
*        DEBUG ALLREGS,XXDBGMC    ALL REGS DEBUG               @D61RDHH 02968000
         DEBUG ALLREGS,XXDBGMC    ALL REGS DEBUG               @D61RDHH 02969000
         AIF   (&BGDEBUG).EIOHW                                @D61RDHH 02970000
         B     RASEIO70           .. RETURN TO RTA             @D61RDHH 02971000
         AGO   .EIONHW                                         @D61RDHH 02972000
.EIOHW   ANOP                                                  @D61RDHH 02973000
         B     RASCTHW            .. GO TO RAS HARDWAIT        @D61RDHH 02974000
.EIONHW  ANOP                                                  @D61RDHH 02975000
RASEMG02 LR    R2,RF              PRESERVE OLD RF              @D61RDHH 02976000
*        TDSERV FUNC=STOP         STOP OTHER CPUS              @D61RDHH 02977000
         TDSERV FUNC=STOP         STOP OTHER CPUS              @D61RDHH 02978000
         LR    RF,R2              RESTORE OLD RF               @D61RDHH 02979000
RASEMG04 L     R4,IJBTDATB        GET PTR TO TD ADDR TABLE     @D61RDHH 02980000
         SLR   R8,R8              SET NUMBER OF ACTIVE CPUS    @D61RDHH 02981000
RASEMG06 LA    R4,4(,R4)          BUMP TO FIRST OR NEXT        @D61RDHH 02982000
         TM    0(R4),X'80'        IS THIS THE LAST ENTRY       @D61RDHH 02983000
         BO    RASEMG08           YES, CHECK IF ALL OTHERS DEAD@D61RDHH 02984000
         L     R2,0(,R4)          TAKE TCPUADR POINTER         @D61RDHH 02985000
         TM    TCPFLG2-TCPUADR(R2),TCPUACT  CPU STILL ACTIVE   @D61RDHH 02986000
         BNO   RASEMG06           BRANCH IF NOT                @D61RDHH 02987000
         LA    R8,1(,R8)          INCREMENT NUMBER OF ACTIVE   @D61RDHH 02988000
         B     RASEMG06           KEEP ON COUNTING             @D61RDHH 02989000
RASEMG08 CL    R8,F1              ONLY OUR ONE LEFT?           @D61RDHH 02990000
         BNE   RASEMG04           BRANCH IF NOT, KEEP WAITING  @D61RDHH 02991000
*                                                              @D61RDHH 02992000
         L     R2,TRANSAV2        GET DEVICE ADDRESS           @D61RDHH 02993000
         BAL   R4,RASSSCH         GET SCH IN R1 AND SETUP ORB  @D51ADTP 02994000
*SGLINK  RASSSCH,INPUT=(R2,R4),WORK=(R8),OUTPUT=(R1)           @D51ADTP 02995000
         LA    R8,RASEIO10        DEVICE AVAILABLE EXIT ADDRESS@DA36100 02996000
         STCK  RASCLK1            STORE CLOCK1                 @DA36100 02997000
RASEMG10 L     R2,TRANSAV2        GET DEVICE ADDRESS           @DA36100 02998000
         STH   R2,CHNADR          SET CUU IN LOW CORE          @DA36100 02999000
RASEMDAV L     R1,XASUBSCH        GET SUBCHANNEL               @D51ADTP 03000000
         L     R2,IRB$            POINT TO IRB                 @D51ADTP 03001000
         USING IRB,R2             INFORM ASSEMBLER             @D51ADTP 03002000
         TSCH  IRB                TEST SUBCHANNEL              @D51ADTP 03003000
         BC    1,RASEIO70         NOT OP ====================> @D51ADTP 03004000
         BC    8,RASEMINT         BRANCH TO CHECK STATUS=====> @D51ADTP 03005000
         TM    IRBSTB2,IRBFC      IS ANY FUNCTION ACTIVE       @D51ADTP 03006000
         BNZ   RASEMDA8           DEVICE IS BUSY               @D51ADTP 03007000
         TM    IRBSTB3,IRBACSA    IS SUBCHANNEL ACTIVE         @D51ADTP 03008000
         BZR   R8                 DEVICE AVAIL===============> @D51ADTP 03009000
RASEMDA8 BAL   R4,RASTIME         PREVENT INFINITE LOOP        @D51ADTP 03010000
         B     RASEMDAV           TRY IF DEVICE NOW AVAILABLE  @D51ADTP 03011000
         DROP  R2                 CANCEL ADDRESSABILITY        @D51ADTP 03012000
RASEMINT DC    0H'0'              INTERRUPT PROCESSING         @DA36100 03013000
         USING IRB,R2             INFORM ASSEMBLER             @D51ADTP 03014000
         MVC   CSW(1),IRBSTB0     MOVE IN KEY                  @D51ADTP 03015000
         MVC   CSW+1(7),IRBCCW+1  MOVE IN CCW, ST AND CNT      @D51ADTP 03016000
         MVC   IOINF(4),TRANSAV2  MOVE IN S/370 CUU            @D51ADTP 03017000
         DROP  R2                 CANCEL ADDRESSABILTY         @D51ADTP 03018000
RASEMIN6 TM    DEVSTA,UNITCK      IS THIS A UNIT CHECK         @DA36100 03019000
         BO    RASDOSNS           YES ISSUE THE SENSE          @DA36100 03020000
         BAL   R4,RASTIME         PREVENT INDEFINITE LOOP      @DA36100 03021000
         B     RASEMG10                                        @DA36100 03022000
RASDOSNS DS    0H                 GET CAW ADDRESS              @D51ADTP 03023000
         L     R3,CAW             SAVE CAW CONTENTS            @DA36100 03024000
         LA    R4,RASSCCW         ADDRESS OF SENSE CCW         @DA36100 03025000
         ST    R4,CAW             STORE SNS-CCW ADDRESS        @DA36100 03026000
         L     R2,ORB$            POINT TO ORB                 @D51ADTP 03027000
         USING ORB,R2             INFORM ASSEMBLER             @D51ADTP 03028000
         STCM  R4,7,ORBCCW+1      MOVE IN CCW ADDRESS          @D51ADTP 03029000
         SSCH  ORB                START SUBCHANNEL             @D51ADTP 03030000
*        DEBUG SIOFLDS,XXDBGMC                                 @D61DDHH 03031000
         DEBUG SIOFLDS,XXDBGMC                                 @D61DDHH 03032000
         STCM  R3,7,ORBCCW+1      RESTORE INITIAL CCW ADDRESS  @D51GDAP 03033000
         ST    R3,CAW             RESTORE CAW                  @D51GDAP 03034000
         DROP  R2                 CANCEL ADDRESSABILITY        @D51ADTP 03035000
         B     RASEMDAV                                        @D51GDAP 03036000
         SPACE 2                                               @D51ADTP 03037000
***************************************************************@D51ADTP 03038000
*        SUBROUTINE TO SUBCHANNEL AND SETUP ORB                @D51ADTP 03039000
***************************************************************@D51ADTP 03040000
         SPACE 1                                               @D51ADTP 03041000
*SGLINK  RASSSCH,ENTRY,INPUT=(R2,R4),WORK=(R8),OUTPUT=(R1)     @D51ADTP 03042000
RASSSCH  LH    R8,YPUBTAB         GET ADDRESS OF PUB TABLE     @D51ADTP 03043000
         USING PUBADR,R8          INFORM ASSEMBLER             @D51ADTP 03044000
RASSSCH4 CH    R2,PUBCHANN        IS RIGHT PUB                 @D51ADTP 03045000
         BE    RASSSCH8           BRANCH IF YES                @D51ADTP 03046000
         LA    R8,NEXTPUB         BUMP TO NEXT PUB             @D51ADTP 03047000
         CLI   PUBCHANN,X'FF'     IS END OF PUB TABLE          @D51ADTP 03048000
         BNE   RASSSCH4           BRANCH IF NOT                @D51ADTP 03049000
         ST    R8,RASSVPUB        SAVE PUB END ADDRESS         @D61RDHH 03050000
         LA    R8,RASPUBX         POINT TO DUMMY PUBX          @D51ADTP 03051000
         B     RASSSCH9           JOIN ROUTINE                 @D51ADTP 03052000
RASSSCH8 ST    R8,RASSVPUB        SAVE PUB ADDRESS             @D61RDHH 03053000
         SH    R8,YPUBTAB         GET PUB OFFSET               @D51ADTP 03054000
         SRL   R8,PUBSLEN-PBXISLEN DIVIDE BY 2                 @D51ODGL 03055000
         L     R1,APBXAREA        GET ADDRESS OF PUBX          @D51ADTP 03056000
         L     R8,0(R8,R1)        GET RIGHT PUBX               @D51ADTP 03057000
         USING PBXADR,R8          INFORM ASSEMBLER             @D51ADTP 03058000
RASSSCH9 L     R1,ORB$            POINT TO ORB                 @D51ADTP 03059000
         USING ORB,R1             INFORM ASSEMBLER             @D51ADTP 03060000
         MVC   ORBLPM,PBXLPM      MOVE IN LPM MASK             @D51ADTP 03061000
         MVC   ORBCCW+1(3),CAW+1  MOVE IN CCW ADDRESS          @D51ADTP 03062000
         MVC   ORBB0,CAW          MOVE IN KEY                  @D51ADTP 03063000
         NI    ORBB0,ORBKEY       GET RID OF BITS              @D51ADTP 03064000
         MVC   ORBIP,RASSVPUB     SET PUB ADDR AS INT PARM     @D61RDHH 03065000
         ST    R2,XAIOREGS+4(4)   SET UP CUU FOR DEBUG         @D51ADAP 03066000
         DROP  R1                 CANCEL ADDRESSABILITY        @D51ADTP 03067000
         L     R1,XASUBSCH        GET SUBCHANNEL MASK          @D51ADTP 03068000
         ICM   R1,3,PBXSCH        GET SUBCHANNEL SET UP        @D51ADTP 03069000
         ST    R1,XASUBSCH        SAVE SUBCHANNEL              @D51ADTP 03070000
         BR    R4                 RETURN TO CALLER             @D51ADTP 03071000
         DROP  R8                 CANCEL ADDRESSABILITY        @D51ADTP 03072000
         DS    0F                 ALIGNMENT                    @D51ADTP 03073000
RASPUBX  EQU   *-(PBXSCH-PBXADR)  DUMMY PUBX                   @D51ADTP 03074000
         DC    X'FFFF00'          HIGH SUBCHANNEL, NO PATHS    @D51ADTP 03075000
RASSVPUB DC    F'0'               SAVE PUB ADDRESS             @D61RDHH 03076000
         EJECT                                                 @DA36100 03077000
RASEIO10 STCK  RASCLK1            STORE CLOCK1                 @DA36100 03078000
         LA    R3,XFF             SET RETRY COUNT              @DA36100 03079000
         LA    R8,RASEIO20        ADJUST DEVICE AVAILABLE EXIT @DA36100 03080000
RASEIO20 L     R1,XASUBSCH        GET SUBCHANNEL               @D51ADTP 03081000
         L     R2,ORB$            POINT TO ORB                 @D51ADTP 03082000
         USING ORB,R2             INFORM ASSEMBLER             @D51ADTP 03083000
         SSCH  ORB                START SUBCHANNEL             @D51ADTP 03084000
         DROP  R2                 CANCEL ADDRESSABILITY        @D51ADTP 03085000
*        DEBUG SIOFLDS,XXDBGMC                                 @D61DDHH 03086000
         DEBUG SIOFLDS,XXDBGMC                                 @D61DDHH 03087000
         BC    2,RASEMG10         BUSY ======================> @DA36100 03088000
         BC    1,RASEIO70         NOT OP ====================> @DA36100 03089000
         BAL   R4,RASTIME         PREVENT INDEFINITE LOOP      @DA36100 03090000
         BC    8,RASEIO40                                      @DA36100 03091000
         L     R2,IRB$            POINT TO IRB                 @D51ADTP 03092000
         USING IRB,R2             INFORM ASSEMBLER             @D51ADTP 03093000
         TSCH  IRB                TEST SUBCHANNEL              @D51ADTP 03094000
         MVC   CSW(1),IRBSTB0     MOVE IN KEY                  @D51ADTP 03095000
         MVC   CSW+1(7),IRBCCW+1  MOVE IN CCW, ST AND CNT      @D51ADTP 03096000
         MVC   IOINF(4),TRANSAV2  MOVE IN S/370 CUU            @D51ADTP 03097000
         DROP  R2                 CANCEL ADDRESSABILITY        @D51ADTP 03098000
         TM    DEVSTA,BUSY        IS THIS SOME KIND OF BUSY    @DA36100 03099000
         BO    RASEMIN6                ======================> @D31AMTP 03100000
         LA    R8,RASEIO70        FORCE ERROR EXIT IF U.C      @DA36100 03101000
RASEIO30 TM    DEVSTA,UNITCK      IS THIS A UNIT CHECK         @DA36100 03102000
         BO    RASDOSNS           YES  ======================> @D51GDAP 03103000
RASEIO40 LA    R8,RASEIO60        SET CONTINUATION ADDRESS     @DA36100 03104000
         B     RASEMDAV                ======================> @DA36100 03105000
RASEIO60 L     R3,TRANSAV7        RETURN ADDRESS               @D14ZDWK 03106000
         LA    R3,D4(R3)          ADJUST FOR GOOD RETURN       @D14ZDWK 03107000
         ST    R3,TRANSAV7        SAVE ADJUSTED RETURN ADDRESS @D14ZDWK 03108000
RASEIO70 B     RTARET             RETURN TO RTA ============>  @DA41332 03109000
         SPACE 1                                               @D149DWK 03110000
RASTIME  STCK  RASCLK2            STORE CLOCK2                 @D14BDDK 03111000
         L     R0,RASCLK2         LOAD SECOND TIME             @D14BDDK 03112000
         S     R0,RASCLK1         SUBTRACT FIRST TIME          @D14BDDK 03113000
         S     R0,TIME60          SUBTRACT 60 SECONDS          @D14BDDK 03114000
         BP    RASEIO70           TIME EXHAUSTED               @D14BDWK 03115000
         SPM   R4                 RESET CONDITION CODE         @D14BDDK 03116000
         BR    R4                 RETURN                       @D14BDWK 03117000
         SPACE 1                                               @D149DWK 03118000
RASSCCW  CCW   4,*,X'30',1        DUMMY SENSE CCW              @DA36100 03119000
RASCLK1  DC    F'0'               FIRST TIME                   @D14BDDK 03120000
RASCLK2  DC    2F'0'              SECOND TIME                  @D14BDDK 03121000
TIME60   DC    F'60'              DELAY OF 60 SECONDS          @D14BDDK 03122000
RASPMASK DC    X'00'              LOCAL PSWMASK                @D31QDAZ 03123000
         EJECT                                                 @D149DWK 03124000
***************************************************************@D149DAP 03125000
*        RAS DEQUEUE I/O REQUEST                               @D149DAP 03126000
*        R3 POINTS TO PUB                                      @D149DAP 03127000
*        R5 RETURN ADDRESS                                     @DY44069 03128000
***************************************************************@D149DAP 03129000
         SPACE 2                                               @D149DWK 03130000
RASDEQ00 ICM   R3,3,WEPIBPUB      GET PUB ADDRESS              @D21WDAP 03131000
         USING PUBADR,R3          SET BASE FOR PUB             @D36IDJR 03132000
RASDEQ10 L     R4,WEPIBCQA        GET CHANQ ADDRESS            @D51ODGL 03133000
         USING CHQADR,R4          SET BASE FOR CHANQ ENTRY     @D51ODGL 03134000
         L     R1,CHQCCBAD        GET CCB ADDRESS              @D14BDAP 03135000
         ICM   R1,8,H0            CLEAR HIGH ORDER BYTE        @D68REEF 03136000
         MVI   DEVSTA,CHANEND+DEVEND FORCE ENDING STATUS       @D14BDWK 03137000
         LH    R7,PUBCHANN        GET CUU IN R7                @D14BDAP 03138000
.*       TM    CHQCCSIO,CHQCCALT  IS THIS ALTERNATE PATH I/O   @DELETE  03139000
.*       BZ    RASDEQ20           NO,                          @DELETE  03140000
.*       LA    R7,NXTCHAN(R7)     GET ALTERNATE ADDRESS        @DELETE  03141000
RASDEQ20 STH   R7,CHNADR          SET CUU IN LOW CORE          @D14BDAP 03142000
         L     R9,AINTER          SET BASE FOR IOINTER         @D36ZDJR 03143000
         USING INTRTN,R9          SET BASE FOR INT.HDLR        @D14BDAP 03144000
         L     R7,RASSAVA         GET PTR TO SYSTEM SAVE       @DM03792 03145000
         USING SVEARA,R7          MAKE SAVE AREA ADDRESSABLE   @D36ZDJR 03146000
.*       LA    R5,RTARET          LOAD RETURN ADDRESS          @DY44069 03147000
         STCM  R5,M7,SVEPSW+5     SET RETURN ADDRESS           @D36ZDJR 03148000
         STM   R9,R8,SVER09       SAVE GEN. REGS. IN SAVEAREA  @D36ZDJR 03149000
         DROP  R7                 DROP RAS SAVE AREA POINTER   @D36ZDJR 03150000
         L     RE,RASLINKA        GET RASLINK ADDRESS          @D61RDHH 03151000
         TM    RASRSFLG-RASLINK(RE),RASBTDEQ     BTAM REQUEST? @D61RDHH 03152000
         BZ    RASDEQ25           NO                           @D14ZDWK 03153000
         NI    RASRSFLG-RASLINK(RE),XFF-RASBTDEQ  RES.BTAM IND.@D61RDHH 03154000
         LA    RE,RASRETRN                                     @D14BDWK 03155000
         B     RASDEQ30                                        @D14BDWK 03156000
RASDEQ25 LA    RE,PSTRESET        FORCE POST PROCESSING        @D14BDAP 03157000
         OI    CHQPROC,CHQDQUNC   DEQUEUE UNCONDITIONAL        @D14BDAP 03158000
         NI    CHQFLG1,XFF-CHQCSQED-CHQCSBSY RESET GATES       @D14BDAP 03159000
         LTR   R1,R1              IS A CCB AVAILABLE           @D14BDAP 03160000
         BNZ   RASDEQ30           YES                          @D14BDAP 03161000
         LA    RE,DEQUNCON        ENTRY NEEDS BE DEQUEUED      @D14BDAP 03162000
RASDEQ30 DS    0H                                              @D51ODGL 03163000
         CLI   PUBCHQPT,NOTQUED   IS OUR REQUEST STILL FIRST   @D51ODGL 03164000
         BE    RASDEQ40           NO, NO CHANQ CHAINED TO PUB  @D63JDHH 03165000
         SLR   R6,R6              CLEAR FOR INSERT             @D63JDHH 03166000
         IC    R6,PUBCHQPT        GET LOW BYTE CHANQ INDEX     @D63JDHH 03167000
         AIF   (&AG1 LE 254).LOD0020                           @D51ODGL 03168000
         ICM   R6,2,PUBCHQPH      GET HIGH BYTE OF CHANQ INDEX @D63JDHH 03169000
.LOD0020 ANOP                                                  @D51ODGL 03170000
         SLL   R6,CHQSLEN         MAKE CHANQ ENTRY DISPLACEMENT@D63JDHH 03171000
         A     R6,ACHANQ          ADD BASE OF CHQADR           @D63JDHH 03172000
         ICM   R6,8,H0            CLEAR HIGH ORDER BYTE        @D68REEF 03173000
         CLM   R6,7,WEPIBCQA+1    COMPARE TO WORK ERROR ENTRY  @D63JDHH 03174000
         BE    RASDEQ40           YES                          @D14BDAP 03175000
RASDEQ32 OI    CHQPROC,CHQDOINT   INDICATE DELAYED PROCESSING  @D51ODGL 03176000
         NI    CHQFLG1,XFF-CHQCSQED-CHQCSBSY RESET GATES       @D63JDHH 03177000
         MVI   CHQIOINF,ERPXPSTR  EXIT ROUTINE ID              @D14BDWK 03178000
         L     R6,DISPAD          LOAD DISPATCHER BASE         @DA41332 03179000
         LR    RE,R6              LOAD INTO REG E              @DA41332 03180000
         B     RASDEQ50                                        @D14BDWK 03181000
RASDEQ40 NI    PUBCSFLG,XFF-DEVBSY-QEDERR RESET GATE IN PUB    @D14BDAP 03182000
         L     R6,DISPAD          GET DISPATCHER BASE          @DA41332 03183000
         USING DISP,R6            DISPATCHER BASE              @DA41332 03184000
         BAL   R7,CQDSP           SET UP I/O REGISTERS         @D14BDWK 03185000
*SGLINK  CQDSP,INPUT=(R3,R6,R7),OUTPUT=(R1,R4,RA),WORK=R0      @D149DWK 03186000
         DROP  R6                 RELEASE DISPATCHER BASE      @DA41332 03187000
RASDEQ50 BAL   RF,INTERTRN        SET UP CCT POINTER           @D14BDWK 03188000
*SGLINK  INTERTRN,INPUT=(R9,RF),OUTPUT=(R2,R5)                 @DA41332 03189000
         BR    RE                      =====================>> @D14BDAP 03190000
*                     EXIT TO     RASRETRN                     @D149DAP 03191000
*                                 PSTRESET                     @D149DAP 03192000
*                                 DEQUNCON                     @D149DAP 03193000
*                                 DISPATCHER                   @D149DWK 03194000
         SPACE 1                                                        03195000
         DROP  R3                 RELEASE PUB ENTRY BASE       @D14ZDWK 03196000
         DROP  R4                 RELEASE CHANNEL ENTRY BASE   @D14ZDWK 03197000
         DROP  R9                 RELEASE INT.HANDLER BASE     @D14ZDWK 03198000
         AGO   .NOGTIME                                        @DA41332 03199000
         SPACE 1                                               @DELETE  03200000
***************************************************************@DELETE  03201000
*        RAS SIMULATE GETIME                                   @DELETE  03202000
***************************************************************@DELETE  03203000
         SPACE 2                                               @DELETE  03204000
RASTIMER SVC   GETIME             ISSUE GETIME                 @DELETE  03205000
         NOPR  R0                 INDICATE WHICH FORMAT        @DELETE  03206000
         ST    R1,TRANSAV9        SAVE TIMER VALUE FOR RTA     @DELETE  03207000
         B     RTARET             RETURN TO RTA                @DELETE  03208000
.NOGTIME ANOP                                                  @DA41332 03209000
         SPACE 1                                               @D149DWK 03210000
***************************************************************@D149DAP 03211000
*        RAS DEQUEUE A DEFECTIVE PAGE FRAME                    @D149DAP 03212000
***************************************************************@D149DAP 03213000
         SPACE 2                                                        03214000
RASPDEQ  L     R8,APMGMDAT        LOAD POINTER TO PAGE MGR.    @D36ZDJR 03215000
         USING PMGMDATA,R8        ADDRESSABILITY TO DATA       @D35EDSK 03216000
         L     R7,ADRAPDEQ        LOAD ADDRESS OF DEQ ROUTINE  @D35EDSK 03217000
         L     R0,TRANSAV0        LOAD FSA INTO REG. ZERO      @D35EDSK 03218000
         AMODESW CALL,REGS=(R7,R7) BRANCH TO PAGE MGR.ROUTINE  @D52VDRP 03219000
         DROP  R8                 DROP BASE REG.               @D35EDSK 03220000
         MVI   RASIND,ZERO        CLEAR INDICATION BYTE        @D35EDSK 03221000
         LTR   R0,R0              CONTENTS OF REG. 0 POSITIVE  @D35EDSK 03222000
         BP    RTARET             YES                          @D36ZDJR 03223000
         OI    RASIND,RASNODEQ    INDICATE NOT DEQUEUED        @D36ZDJR 03224000
         B     RTARET             RETURN                       @D14BDWK 03225000
         SPACE 1                                               @D149DWK 03226000
***************************************************************@D149DAP 03227000
*        RAS FREE IOEL                                         @D149DAP 03228000
***************************************************************@D149DAP 03229000
         SPACE 2                                                        03230000
RASFREE1 L     R2,WEPIBIOE        GET IOEL POINTER             @D21WDAP 03231000
         LTR   R2,R2              IS IOEL AVAILABLE            @D14BDDK 03232000
         BZR   R5                 NO                           @DY44069 03233000
         LA    R7,IOELPTRS        GET ADDR OF FIRST IOEL PTR   @D14BDDK 03234000
RASFREE2 CLM   R2,7,1(R7)         DO POINTERS MATCH            @D14BDDK 03235000
         BE    RASFREE3           YES                          @D14BDDK 03236000
         LA    R7,4(R7)           GET NEXT IOEL POINTER        @D14BDDK 03237000
         CLI   0(R7),XFF          IS IT TABLE END              @D14BDDK 03238000
         BNE   RASFREE2           NO  COMPARE AGAIN            @D14BDDK 03239000
         BR    R5                 RETURN                       @DY44069 03240000
RASFREE3 OC    AIOEL+1(3),AIOEL+1 WAS ANY IOEL IN USE BEFORE   @D14BDDK 03241000
         BNZ   RASFREE4           YES  NO NEED FOR THIS ONE    @D14BDDK 03242000
         MVC   AIOEL+1(3),1(R7)   USE THIS IOEL NOW            @D14BDDK 03243000
         BR    R5                 RETURN                       @DY44069 03244000
         SPACE 1                                               @D319MGN 03245000
RASFREE4 NI    0(R7),XFF-IOELUSED SET IOEL FREE                @D14BDDK 03246000
         BR    R5                 RETURN                       @DY44069 03247000
         SPACE 1                                               @DA41332 03248000
***************************************************************@D149DWK 03249000
*        POST RASTASK IF NOT ACTIVE                            @D149DWK 03250000
***************************************************************@D149DWK 03251000
         SPACE 2                                               @D149DWK 03252000
CCPSTRAS L     R8,RASLINKA        GET RASLINK ADDRESS          @D61RDHH 03253000
         OI    RASFLAGS-RASLINK(R8),RASACT IND. RAS IS ACTIVE  @D61RDHH 03254000
         L     R8,ARASTIB         POINT TO RASTIB              @D14BDWK 03255000
         CLI   TIBRQID-TIBADR(R8),NOTACT  RAS ALREADY ACTIVE   @D14BDWK 03256000
         BNER  R7                 YES RETURN                   @D14BDWK 03257000
         L     R6,DISPAD          GET DISPATCHER BASE          @DA41332 03258000
         USING DISP,R6            DISPATCHER BASE              @DA41332 03259000
*SGLINK  POST,INPUT=(R6,R8,RF),WORK=(RE)                       @D149DWK 03260000
         BAL   RF,POST            POST RASTASK                 @D31EMGN 03261000
         BR    R7                 RETURN TO CALLER             @D14BDWK 03262000
         SPACE 1                                               @DA41332 03263000
         DROP  R6                 RELEASE DISPATCHER BASE      @DA41332 03264000
         EJECT                                                 @DA41332 03265000
***************************************************************@DA41332 03266000
*     FIND SUBCHANNELS WITH SAME CHPID AND RETURN TO FUNCTION  @DA41332 03267000
*                                                              @DA41332 03268000
*          INPUT  :  R1 = CHPID                                @DA41332 03269000
*                    R2 = SCHIB                                @DA41332 03270000
*                    RD = SAVE AREA                            @DA41332 03271000
*                    RE = RETURN REGISTER                      @DA41332 03272000
*                                                              @DA41332 03273000
*          OUTPUT :  R1 = SUBCHANNEL                           @DA41332 03274000
*                    R2 = SCHIB                                @DA41332 03275000
*                    R3 = PUB HAVING REQUESTED CHPID           @DA41332 03276000
*                    R4 = PUBX HAVING REQUESTED CHPID          @DA41332 03277000
*                    R5 = LOGICAL PATH MASK FOR REQU. CHPID    @DA41332 03278000
*                    R9 = ENTRY TO FIND NEXT CHPID             @DA41332 03279000
*                                                              @DA41332 03280000
*          WORK   :  RC                                        @DA41332 03281000
*                                                              @DA41332 03282000
*          RETURN :  RE    = RETURN END OF SCAN                @DA41332 03283000
*                    RE +4 = RETURN CHPID FOUND                @DA41332 03284000
***************************************************************@DA41332 03285000
         SPACE 2                                               @DA41332 03286000
         USING SCHIB,R2           GET SCHIB BASE               @DA41332 03287000
         USING MSCPARM,RD         GET MSCPARM BASE             @DA41332 03288000
MSCCHPID STM   RE,RC,MSCSAVE      SAVE REGISTERS               @DA41332 03289000
         L     R2,MSCSCHIB        GET SCHIB ADDRESS            @DA41332 03290000
         L     RC,APBXAREA        GET PUBX VECTOR TABLE ADDR   @DA41332 03291000
         LH    R3,YPUBTAB         POINT TO PUB TABLE           @DA41332 03292000
         USING PUBADR,R3          BASE PUB DSECT               @DA41332 03293000
         BAL   R9,MSCHPD20        LOAD RETURN TO FIND NXT CHPID@DA41332 03294000
MSCHPD10 LA    R3,NEXTPUB         GET NEXT PUB                 @DA41332 03295000
         LA    RC,4(,RC)          POINT TO NEXT PUBX POINTER   @DA41332 03296000
MSCHPD20 ICM   R4,15,0(RC)        GET PUBX POINTER AND TEST    @DA41332 03297000
         BP    MSCHPD30           NOT LAST PUBX, CONTINUE      @DA41332 03298000
         LM    RE,RC,MSCSAVE      RESTORE REGISTERS            @DA41332 03299000
         BR    RE                 RETURN, END OF SCAN          @DA41332 03300000
         SPACE 1                                               @DA41332 03301000
         USING PBXADR,R4          GET PUBX BASE                @DA41332 03302000
MSCHPD30 TM    PBXFLAG,PBXFBAVD   IS THIS VIRTUAL DISK         @DA41332 03303000
         BO    MSCHPD10           NO, CHECK NEXT PUBX          @DA41332 03304000
         ICM   R1,3,PBXSCH        GET SUBCHANNEL NUMBER        @DA41332 03305000
         ICM   R1,12,H1           GET SUBCHANNEL WORD ID       @DA41332 03306000
         STSCH 0(R2)              STORE SUBCHANNEL             @DA41332 03307000
         BC    1,MSCHPD10         SKIP IF NOT OP / NOT DEFINED @DA41332 03308000
         LA    R6,PBXCHPID        POINT TO CORRESP. STRING POS @DA41332 03309000
         LA    R5,X'80'           LOAD PATH MASK FOR SHIFT     @DA41332 03310000
MSCHPD40 CLC   0(1,R6),MSCSAVR1+3 IS THIS SAME CHPID (REG 1)   @DA41332 03311000
         BNE   MSCHPD50           YES, CONTINUE                @DA41332 03312000
         B     4(RE)              RETURN, CHPID FOUND          @DA41332 03313000
MSCHPD50 SRL   R5,1               SHIFT BIT SELECT POSITION    @DA41332 03314000
         LA    R6,1(,R6)          SHIFT TO NEXT CHPID POSITION @DA41332 03315000
         LTR   R5,R5              LAST POSITION TESTED         @DA41332 03316000
         BNZ   MSCHPD40           NO, CHECK NEXT BIT POSITION  @DA41332 03317000
         B     MSCHPD10           CHECK NEXT PUBX              @DA41332 03318000
         EJECT                                                 @DA41332 03319000
MSCPARM  DSECT                    DSECT FOR SAVEAREA           @DA41332 03320000
MSCSCHIB DS    F                  SCHIB ADDRESS                @DA41332 03321000
MSCSAVE  DS    3F                 REGISTER 14 - 0              @DA41332 03322000
MSCSAVR1 DS    F                  REGISTER 1                   @DA41332 03323000
         DS    11F                REGISTER 2 - 12              @DA41332 03324000
         SPACE 2                                               @DA41332 03325000
&SYSECT  CSECT ,                  REESTABLISH CSECT            @DA41332 03326000
         DROP  R2                 RELEASE SCHIB BASE           @DA41332 03327000
         DROP  R3                 RELEASE PUB BASE             @DA41332 03328000
         DROP  R4                 RELEASE PUBX BASE            @DA41332 03329000
         DROP  RD                 RELEASE MSCPARM BASE         @DA41332 03330000
         SPACE 1                                               @D149DWK 03331000
***************************************************************@D149DWK 03332000
*        CHANNEL CHECK EMERGENCY EXITS                         @D149DWK 03333000
***************************************************************@D149DWK 03334000
         SPACE 2                                               @D149DWK 03335000
EMGEX010 MVI   SYSS00,C'B'        UNRECOVERABLE FETCH I/O ERROR@D14BDWK 03336000
         B     RASHWTCM           SKIP RECORDING               @D14BDWK 03337000
EMGEX020 MVI   SYSS00,C'C'        UNRECOVERABLE CC ON PAGING   @D14BDWK 03338000
         B     RASHWTCM           SKIP RECORDING               @D14BDWK 03339000
EMGEX030 MVI   SYSS00,C'E'        NO ECSW STORED               @D21YDGN 03340000
         B     RASHWTCM           YES, ====================>   @D21YDGN 03341000
         SPACE 1                                               @D149DWK 03342000
***************************************************************@D149DWK 03343000
*        HARD WAIT EXIT                                        @D149DWK 03344000
***************************************************************@D149DWK 03345000
         SPACE 2                                               @D149DWK 03346000
RASHWT0A MVI   SYSS00,C'A'        HW INDICATOR IN LOWCORE      @D14BDWK 03347000
         MVI   MCNPSW+3,X00       MC INDICATOR IN PSW          @D14BDWK 03348000
         B     RASHWT00                                        @D21YDGN 03349000
RASHWTCM MVI   MCNPSW+3,X'0F'     INDICATE: CHANNEL CHECK      @D14BDWK 03350000
RASHWT00 MVI   SYSS00+1,X'00'     CLEAR UNUSED BYTE 1          @D21YDGN 03351000
         MVI   SYSS00+2,C'A'      SET RECORDING UNSUCCESSFULL  @D14BDWK 03352000
RASHWT10 CLI   RTAOWN,RASZERO     IS $$RAST00 IN THE RTA       @D21YDGN 03353000
         BNE   RASHWTEX           NO                           @D14BDWK 03354000
         L     R7,RASLINKA        GET RASLINK ADDRESS          @D61RDHH 03355000
         OI    RASFLAGS-RASLINK(R7),RASSTERM  IND.SYSTEM TERM. @D61RDHH 03356000
         B     RASMON90                 ====================>  @DA41332 03357000
         SPACE 1                                               @DA41332 03358000
RASHWTEX MVI   IJBHWORG,HWORG088  UNIQUE HARD WAIT ORIGINATOR  @D31QDHB 03359000
RASCTHW  LA    R6,RASWPSW         SUPPORT SPECIAL WAIT PSW     @DA41332 03360000
         L     R5,ARASHDWT        GO TO CENTRAL HARD WAIT      @DA41332 03361000
         BR    R5                                              @D31QDHB 03362000
         EJECT                                                 @D64IDHH 03363000
***************************************************************@DA41332 03364000
*        MACHINE CHECK STACK CONTROL                           @DA41332 03365000
***************************************************************@DA41332 03366000
         SPACE 2                                               @DA41332 03367000
         DS    0F                                              @D64IDHH 03368000
MCSTKEYE DC    CL8'RASQUEUE'   EYE-CATCH FOR QUEUE CONTROL INFO@D64IDHH 03369000
MCSTKNUM DC    H'&MCHSTK'      NUM OF MC/CRW/CC QUEUE ENTRIES  @D61SDHH 03370000
         DC    H'0'            RESERVED                        @D64IDHH 03371000
MCSTKQUE DC    A(0)            MC Q: PTR TO 1ST ENTRY IN USE   @DA41332 03372000
MCSTKBEG DC    A(0)            MC Q: PTR TO BEGIN OF QUEUE     @DA41332 03373000
MCSTKEND DC    A(0)            MC Q: PTR TO END OF QUEUE + 1   @DA41332 03374000
MCSTKNXT DC    A(0)            MC Q: PTR TO NEXT FREE Q-ENTRY  @DA41332 03375000
         SPACE 1                                               @DA41332 03376000
***************************************************************@DA41332 03377000
*        CRW STACK CONTROL                                     @DA41332 03378000
***************************************************************@DA41332 03379000
         SPACE 2                                               @DA41332 03380000
MCRWSQUE DC    A(0)            CRW Q: PTR TO 1ST ENTRY IN USE  @DA41332 03381000
MCRWSBEG DC    A(0)            CRW Q: PTR TO BEGIN OF QUEUE    @DA41332 03382000
MCRWSEND DC    A(0)            CRW Q: PTR TO END OF QUEUE + 1  @DA41332 03383000
MCRWSNXT DC    A(0)            CRW Q: PTR TO NEXT FREE Q-ENTRY @DA41332 03384000
MCRWSLST DC    A(0)            CRW Q: PTR TO LAST CRW          @DA41332 03385000
*                                     WITHIN CURRENT Q-ENTRY   @DA41332 03386000
         SPACE 1                                               @D61SDHH 03387000
***************************************************************@D61SDHH 03388000
*        CC  STACK CONTROL                                     @D61SDHH 03389000
***************************************************************@D61SDHH 03390000
         SPACE 2                                               @D61SDHH 03391000
CCSTKQUE DC    A(0)            CC Q: PTR TO 1ST ENTRY IN USE   @D61SDHH 03392000
CCSTKBEG DC    A(0)            CC Q: PTR TO BEGIN OF QUEUE     @D61SDHH 03393000
CCSTKEND DC    A(0)            CC Q: PTR TO END OF QUEUE + 1   @D61SDHH 03394000
CCSTKNXT DC    A(0)            CC Q: PTR TO NEXT FREE Q-ENTRY  @D61SDHH 03395000
         SPACE 1                                               @D61SDHH 03395100
***************************************************************@D61SDHH 03395200
*        VTAM 31-bit support workfields                        @D61SDHH 03395300
***************************************************************@D61SDHH 03395400
V31VCCWA DC    F'0'               VTAM virtual CCW addr        @DY46396 03395500
V31CSWSV DC    F'0'               CSW savearea                 @DY46396 03395600
         SPACE 1                                               @D61SDHH 03395700
         EJECT                                                 @D31AMTP 03396000
***************************************************************@DA41332 03397000
*                                                              @DA41332 03398000
*        RAS SCHIB SUBCHANNEL INFORMATION BLOCK                @DA41332 03399000
*                                                              @DA41332 03400000
***************************************************************@DA41332 03401000
         SPACE 2                                               @DA41332 03402000
         DC    C'RAS-SCHIB '       EYE CATCHER                 @DA41332 03403000
RSCHIB   DS    0F                 SUBCHANNEL INFORMATION BLOCK @DA41332 03404000
*--------------------------------------------------------------@DA41332 03405000
*        PMCW-PATH MANAGEMENT CONTROL WORD                     @DA41332 03406000
*--------------------------------------------------------------@DA41332 03407000
RSCHIP   DC    F'0'               INTERRUPT PARAMETER          @DA41332 03408000
RSCHISC  DC    X'0'               INTERRUPT SUBCLASS CODE      @DA41332 03409000
RSCHFLGS DC    X'0'               FLAGS                        @DA41332 03410000
RSCHE    EQU   X'80'              ENABLED                      @DA41332 03411000
RSCHLM   EQU   X'60'              LIMIT MODE                   @DA41332 03412000
RSCHMM   EQU   X'18'              MEASUREMENT MODE             @DA41332 03413000
RSCHD    EQU   X'04'              MULTIPATH MODE               @DA41332 03414000
RSCHT    EQU   X'02'              TIMING FACILITY              @DA41332 03415000
RSCHV    EQU   X'01'              DEVICE NUMBER VALID          @DA41332 03416000
RSCHDEVN DC    H'0'               DEVICE NUMBER                @DA41332 03417000
RSCHLPM  DC    X'0'               LOGICAL PATH MASK            @DA41332 03418000
RSCHPNOM DC    X'0'               PATH NOT OPERATIONAL MASK    @DA41332 03419000
RSCHLPUM DC    X'0'               LAST PATH USED MASK          @DA41332 03420000
RSCHPIM  DC    X'0'               PATH INSTALLED MASK          @DA41332 03421000
RSCHMBI  DC    H'0'               MEASUREMENT BLOCK INDEX      @DA41332 03422000
RSCHPOM  DC    X'0'               PATH OPERATIONAL MASK        @DA41332 03423000
RSCHPAM  DC    X'0'               PATH AVAILABLE MASK          @DA41332 03424000
RSCHPID0 DC    X'0'               CHPID-0                      @DA41332 03425000
RSCHPID1 DC    X'0'               CHPID-1                      @DA41332 03426000
RSCHPID2 DC    X'0'               CHPID-2                      @DA41332 03427000
RSCHPID3 DC    X'0'               CHPID-3                      @DA41332 03428000
RSCHPID4 DC    X'0'               CHPID-4                      @DA41332 03429000
RSCHPID5 DC    X'0'               CHPID-5                      @DA41332 03430000
RSCHPID6 DC    X'0'               CHPID-6                      @DA41332 03431000
RSCHPID7 DC    X'0'               CHPID-7                      @DA41332 03432000
         DC    F'0'               ZEROS                        @DA41332 03433000
*--------------------------------------------------------------@DA41332 03434000
*        SCSW-SUBCHANNEL STATUS WORDD                          @DA41332 03435000
*--------------------------------------------------------------@DA41332 03436000
RSCHSTB0 DC    X'0'               BYTE ZERO OF SCSW            @DA41332 03437000
RSCHKEY  EQU   X'F0'              KEY BITS                     @DA41332 03438000
RSCHS    EQU   X'08'              SUSPEND CONTROL              @DA41332 03439000
RSCHL    EQU   X'04'              ESW FORMAT                   @DA41332 03440000
RSCHCC   EQU   X'03'              DEFERRED CONDITION CODE      @DA41332 03441000
RSCHSTB1 DC    X'0'               BYTE ONE OF SCSW             @DA41332 03442000
RSCHF    EQU   X'80'              FORMAT OF CCW                @DA41332 03443000
RSCHP    EQU   X'40'              PRE-FETCH                    @DA41332 03444000
RSCHI    EQU   X'20'              INIT-STAT INTERRUPT REQUEST  @DA41332 03445000
RSCHA    EQU   X'10'              ADDRESS LIMIT CHECK CONTROL  @DA41332 03446000
RSCHU    EQU   X'08'              SUPPORT SUSP INTERRUPT       @DA41332 03447000
         EJECT                                                 @DA41332 03448000
*--------------------------------------------------------------@DA41332 03449000
*        SUBCHANNEL CONTROL BITS 13 - 31                       @DA41332 03450000
*--------------------------------------------------------------@DA41332 03451000
RSCHZ    EQU   X'04'              ZERO CONDITION CODE          @DA41332 03452000
RSCHEC   EQU   X'02'              EXTENDED CONTROL             @DA41332 03453000
RSCHN    EQU   X'01'              PATH NOT OPERATIONAL         @DA41332 03454000
RSCHSTB2 DC    X'0'               BYTE TWO OF SCSW             @DA41332 03455000
RSCHFC   EQU   X'70'              FUNCTION CONTROL             @DA41332 03456000
RSCHFCS  EQU   X'40'              START FUNCTION               @DA41332 03457000
RSCHFCH  EQU   X'20'              HALT FUNCTION                @DA41332 03458000
RSCHFCC  EQU   X'10'              CLEAR FUNCTION               @DA41332 03459000
*--------------------------------------------------------------@DA41332 03460000
*        SUBCHANNEL ACTIVITY CONTROL                           @DA41332 03461000
*--------------------------------------------------------------@DA41332 03462000
RSCHACR  EQU   X'08'              RESUME PENDING               @DA41332 03463000
RSCHACS  EQU   X'04'              START PENDING                @DA41332 03464000
RSCHACH  EQU   X'02'              HALT PENDING                 @DA41332 03465000
RSCHACC  EQU   X'01'              CLEAR PENDING                @DA41332 03466000
RSCHSTB3 DC    X'0'               BYTE THREE OF SCSW           @DA41332 03467000
RSCHACSA EQU   X'80'              SUBCHANNEL ACTIVE            @DA41332 03468000
RSCHACDA EQU   X'40'              DEVICE ACTIVE                @DA41332 03469000
RSCHACSP EQU   X'20'              SUSPENDED                    @DA41332 03470000
*--------------------------------------------------------------@DA41332 03471000
*        SUBCHANNEL STATUS CONTROL                             @DA41332 03472000
*--------------------------------------------------------------@DA41332 03473000
RSCHSCAS EQU   X'10'              ALERT STATUS                 @DA41332 03474000
RSCHSCIS EQU   X'08'              INTERMEDIATE STATUS          @DA41332 03475000
RSCHSCPS EQU   X'04'              PRIMARY STATUS               @DA41332 03476000
RSCHSCSS EQU   X'02'              SECONDARY STATUS             @DA41332 03477000
RSCHSCSP EQU   X'01'              STATUS PENDING               @DA41332 03478000
RSCHCCW  DC    A(0)               ADDRESS OF CCW               @DA41332 03479000
RSCDSTAT DC    X'0'               DEVICE STATUS                @DA41332 03480000
RSCSSTAT DC    X'0'               SUBCHANNEL STATUS            @DA41332 03481000
RSCCOUNT DC    H'0'               RESIDUAL COUNT               @DA41332 03482000
*--------------------------------------------------------------@DA41332 03483000
*        MODEL DEPENDENT AREA                                  @DA41332 03484000
*--------------------------------------------------------------@DA41332 03485000
RSCHDA0  DC    F'0'               MODEL DEPENDENT AREA WORD 1  @DA41332 03486000
RSCHDA1  DC    F'0'               MODEL DEPENDENT AREA WORD 2  @DA41332 03487000
RSCHDA2  DC    F'0'               MODEL DEPENDENT AREA WORD 3  @DA41332 03488000
RSCHDA3  DC    F'0'               MODEL DEPENDENT AREA WORD 4  @DA41332 03489000
RSCHLEN  EQU   *-RSCHIB           LENGTH OF RAS SCHIB          @DA41332 03490000
         EJECT                                                 @DA41332 03491000
***************************************************************@DA41332 03492000
*        RAS CHPID CONTROL TABLE                               @DA41332 03493000
***************************************************************@DA41332 03494000
         SPACE 2                                               @DA41332 03495000
RASCHPTB DC    256X'00'           RAS - CHPID TABLE            @D51ADTP 03496000
         SPACE 2                                               @D219DGN 03497000
RCCHNTLN DC    AL2(RCHNTBLN)      CONST OF RAS CC TABLE LENGTH @DA41332 03498000
MAXCHAN  DC    AL1(MAXCHANN),AL1(X'FF') MAXIMUM HARDWARE ....  @DA41332*03499000
                                         SUPPORTED CHANNEL NUMBER       03500000
         SPACE 2                                               @D219DGN 03501000
RCHTDSCT DSECT                    RAS CHANNEL TABLE LAYOUT     @D21YDGN 03502000
RCHNFLGS DC    X'00'              RAS CHANNEL FLAGS            @D21YDGN 03503000
RCHNTBLN EQU   *-RCHNFLGS         LENGTH OF RAS CC TABLE ENTRY @D21YDGN 03504000
RXTDRCOV EQU   X'80'              EXTRN DAMAGE CHANN TO RECOV  @D21YDGN 03505000
RCCHADVC EQU   X'40'              ALL DEVICES ON CHANN AFFECTD @D21YDGN 03506000
RCHNDMMG EQU   X'20'              CHANNEL DAMAGED              @D21YDGN 03507000
&SYSECT  CSECT ,                  REESTABLISH CSECT            @DA41332 03508000
         TITLE 'VSE/AF SUPERVISOR   MCRAS    RAS LINKAGE AREA         ' 03509000
         DS    0D                 ALIGN FOR D-WORD BOUNDARY    @D61RDHH 03510000
         DC    CL8'RASLINK '      EYE CATCHER                  @D61RDHH 03511000
         MAPRASL DSECT=NO         RAS LINKAGE AREA             @D61RDHH 03512000
         SPACE 1                                               @DA41332 03513000
***************************************************************@DA41332 03514000
*        SET NUMBER OF MC EXTENDED LOGOUT AREAS                @DA41332 03515000
***************************************************************@DA41332 03516000
         SPACE 2                                               @DA41332 03517000
         ORG   RASMCELA           ORG TO MCEL AREA IN RASL     @D31AMTP 03518000
         DC    AL1(&MCHSTK+X'80') INDICATE NUMBER OF STACKS    @D31AMTP 03519000
*                                 SO $IPLRT4 CAN ALLOCATE      @D31AMTP 03520000
         ORG   ,                  RESET LOCATION COUNTER       @D31AMTP 03521000
         SPACE 1                                               @DA41332 03522000
***************************************************************@DA41332 03523000
*        SET LENGTH OF MACHINE CHECK STACK AREA                @DA41332 03524000
***************************************************************@DA41332 03525000
         SPACE 2                                               @DA41332 03526000
         ORG   RASMCSTK+1         ORG TO MACH STACK AREA RASL  @DA41332 03527000
         DC    AL3(&MCHSTK*(MCST$LEN+MCRW$LEN+CCST$LEN))       @D61SDHH 03528000
*              LENGTH OF STACK AREA FOR MC, CRW AND CC ENTRIES @D61SDHH 03529000
*              SO $IPLRT4 CAN ALLOCATE THIS AREA               @D61SDHH 03530000
         ORG   ,                  RESET LOCATION COUNTER       @DA41332 03531000
         TITLE 'VSE/AF SUPERVISOR   MCRAS    RAS COMMUNICATION AREA   ' 03532000
***************************************************************@D149DWK 03533000
*        RAS COMMUNICATION AREA                                @D149DWK 03534000
***************************************************************@D149DWK 03535000
         SPACE 2                                               @D149DWK 03536000
         DS    0D                 ALIGN FOR D-WORD BOUNDARY    @D61RDHH 03537000
         DC    CL8'RASTAB  '      EYE-CATCHER                  @D61RDHH 03538000
RASTAB   DS    0D                 ALIGN FOR D-WORD BOUNDARY    @DA41332 03539000
RASMCERQ DC    A(0)               MC/CRW Q-ENTRY TO PROCESS    @D64IDHH 03540000
*                                   BY RAS TRANSIENTS          @D64IDHH 03541000
RASCRWQE DC    A(0)               CRW ENTRY IN CRW Q-ENTRY     @D64IDHH 03542000
*                                   IN PROCESS BY RAS-TRANS.   @D64IDHH 03543000
TPAFLAG  DC    XL1'00'            TPA CC RECOVERY FLAG BYTE    @D61SDHH 03544000
         DC    XL3'00'            RESERVED                     @D61SDHH 03545000
         DC    23A(0)             RESERVED                     @D61SDHH 03546000
         DS    0D                 ALIGN FOR D-WORD BOUNDARY    @DA41332 03547000
RASCCB   DC    H'0'               RESIDUAL COUNT                        03548000
         DC    X'1000'            TRANSMISION INFORMATION      @D14BDAP 03549000
         DC    H'0'               CSW STATUS BYTES                      03550000
         DC    H'6'               SYSRES LUB                            03551000
RASCCBF  DC    X'00'              RAS CCB INDICATOR                     03552000
         DC    AL3(0)             ADDRESS OF CCW'S             @DA41332 03553000
         DC    2H'0'              RESERVED                     @DA41332 03554000
         DC    4D'0'              RESERVED                     @DA41332 03555000
         DC    7X'00'             RESERVED                     @DA41332 03556000
RTAOWN   DC    X'FF'              INDEX INTO TTR TABLE OF OWNER         03557000
         DC    H'0'               RESERVED                     @DA41332 03558000
         DC    H'0'               RESERVED                     @D36IDJR 03559000
         DC    AL4(WEPIBADR)      ADDRESS OF TRANS. ERROR ENTRY@D21WDAP 03560000
         DC    AL4(0)             RESERVED                     @DA41332 03561000
RTAID    DS    X                  RAS I/O REQUEST ID           @D14BDWK 03562000
RASRECID EQU   X'08'              RECORDING REQUEST            @D14BDWK 03563000
RASRTYID EQU   X'04'              CHANNEL RETRY REQUEST        @D14BDWK 03564000
RASRTYXR EQU   X'02'              RETRY FOR EXCP REAL          @D61SDHH 03565000
*                                 (RASRTYID IS ALSO SET)       @D61SDHH 03566000
ERPID    DS    X                  RETURN LOAD INDEX FOR WTOR   @DM01780 03567000
RASRES   DC    H'0'               I/O ADDRESS OF SYSRES                 03568000
RASREC   DC    H'0'               I/O ADDRESS OF SYSREC                 03569000
RASLOG   DC    H'0'               DEVICE ADDRESS OF SYSLOG              03570000
*                                                                       03571000
TRANSAV  DS    0F                 RTA REGISTER SAVE AREA                03572000
TRANSAV0 DC    F'0'               REG0                                  03573000
TRANSAV1 DC    F'0'               REG1                                  03574000
TRANSAV2 DC    F'0'               REG2                                  03575000
TRANSAV3 DC    F'0'               REG3                                  03576000
TRANSAV4 DC    F'0'               REG4                                  03577000
TRANSAV5 DC    F'0'               REG5                                  03578000
TRANSAV6 DC    F'0'               REG6                                  03579000
TRANSAV7 DC    F'0'               REG7                                  03580000
TRANSAV8 DC    F'0'               REG8                                  03581000
TRANSAV9 DC    F'0'               REG9                                  03582000
TRANSAVA DC    F'0'               REGA                                  03583000
TRANSAVB DC    F'0'               REGB                                  03584000
TRANSAVC DC    F'0'               REGC                                  03585000
TRANSAVD DC    F'0'               REGD                                  03586000
TRANSAVE DC    F'0'               REGE                                  03587000
TRANSAVF DC    F'0'               REGF                                  03588000
*                                                                       03589000
SYSREGS  DS    0F                 SYSTEM REGISTER SAVE FOR RTA          03590000
SYSREG0  DC    F'0'               REG0                                  03591000
SYSREG1  DC    F'0'               REG1                                  03592000
SYSREG2  DC    F'0'               REG2                                  03593000
SYSREG3  DC    F'0'               REG3                                  03594000
SYSREG4  DC    F'0'               REG4                                  03595000
SYSREG5  DC    F'0'               REG5                                  03596000
SYSREG6  DC    F'0'               REG6                         @DA41332 03597000
SYSREG7  DC    F'0'               REG7                                  03598000
SYSREG8  DC    F'0'               REG8                                  03599000
SYSREG9  DC    F'0'               REG9                                  03600000
SYSREGA  DC    A(MACHSRDA)        REGA                                  03601000
SYSREGB  DC    F'0'               REGB                         @DA41332 03602000
SYSREGC  DC    F'0'               REGC                                  03603000
SYSREGD  DC    F'0'               REGD                                  03604000
SYSREGE  DC    F'0'               REGE                                  03605000
SYSREGF  DC    F'0'               REGF                         @DA41332 03606000
*                                                                       03607000
LINKFLAG DC    X'00'              MESSAGE AREA                          03608000
SUPLINK  DC    AL3(RASTSCAN)      PTR TO RAS SYSTEM FUNCTION SCAN       03609000
*                                                                       03610000
RASLIO   EQU   X'80'              RTA NORMAL I/O REQUEST                03611000
RASLEMIO EQU   X'40'              RTA EMERGENCY I/O REQUEST             03612000
RASLFTCH EQU   X'20'              RTA FETCH REQUEST                     03613000
RASLWAIT EQU   X'10'              RTA SIMULATED WAIT           @DA41332 03614000
RASLPDEQ EQU   X'08'              RTA DEQUEUE PAGE FRAME       @DA41332 03615000
RASLDEQ  EQU   X'04'              RTA DEQUEUE CCB                       03616000
RASLFREE EQU   X'02'              FREE IOEL AFTER RECORDING    @D14BDDK 03617000
*        EQU   X'01'              RESERVED                     @DA41332 03618000
RASLEXIT EQU   X'00'              RTA EXIT                     @DA41332 03619000
.*                                                                      03620000
.*             CHECK IF HIR STILL NECESSARY (NOT SUPPORTED HARDWARE)    03621000
*                                                                       03622000
HIR      DS    0CL12              HARDWARE INSTR. RETRY ACCUMULATOR     03623000
HIRACNT  DC    H'0'               ACCUMULATED HIR COUNT                 03624000
HIRLCNT  DC    H'8'               THRESHOLD VALUE FOR COUNT             03625000
HIR1TME  DC    F'0'               TIME OF DAY FOR FIRST ERROR OF GROUP  03626000
HIRLTME  DC    F'27464'           TIME THRESHOLD IN CLOCK UNITS         03627000
*                                                                       03628000
ECCMAIN  DS    0CL12              MAIN STORAGE ERROR ACCUMULATORS       03629000
ECMACNT  DC    H'0'               ACCUMULATED ECC CNT FOR MAIN STORAGE  03630000
ECMLCNT  DC    H'16'              INITIAL THRESHOLD COUNT               03631000
ECM1TME  DC    F'0'               TIME OF DAY FOR FIRST ERROR OF GROUP  03632000
ECMLTME  DC    F'27464'           TIME THRESHOLD IN CLOCK UNITS         03633000
*                                                                       03634000
MACHERR  DS    0CL12              MACHINE CHECK ACCUMULATORS   @D21MDGN 03635000
MCERRCNT DC    H'0'               ACCUMULATED MACH. CHECK COUNT@D21MDGN 03636000
MCLCNT   DC    H'10'              INITIAL THRESHOLD COUNT      @D21MDGN 03637000
MC1TIME  DC    F'0'               TIME OF DAY FOR FIRST ERROR  @D21MDGN 03638000
MCLTIME  DC    F'572'             TIME THRESHOLD IN CLOCK UNITS@D21MDGN 03639000
*                                                                       03640000
MCMODE   DC    X'92'              INITIAL MODE SETTING                  03641000
BUFDEL   DC    X'00'              COUNT OF BUFFERS DELETED              03642000
RASMSG1  DC    X'00'              MESSAGE BYTE 1                        03643000
RASMSG2  DC    X'00'              MESSAGE BYTE 2                        03644000
RASMSG3  DC    X'00'              MESSAGE BYTE 3               @DA41332 03645000
RASIND   DC    H'0'               RAS INDICATORS               @D35EDSK 03646000
RASNODEQ EQU   X'80'              MASK IND. PAGEFRAME NOT DEQ. @D35EDSK 03647000
         DC    H'0'               RESERVED                     @D21CDWK 03648000
         DC    A(0)               RESERVED                     @D51GDGN 03649000
*        INTERFACE SEGMENT                                     @D149DWK 03650000
INTERSEG DS    0XL14                                           @DA36100 03651000
FXDLGADD DC    F'0'               ADDRESS OF FIXED LOG OUT     @DA36100 03652000
EXTLGADD DC    F'0'               ADDRESS OF EXTENDED LOG OUT  @DA36100 03653000
INOFN    DC    XL1'00'            SEQUENCE NUMBER REC 1 OF N   @D14ADWK 03654000
ILOGL    DC    XL1'00'            LOGOUT PART OF RECORD 1      @D14ADWK 03655000
IRECL    DC    XL1'00'            TOTAL LENGTH OF RECORD 1     @D14ADWK 03656000
NNOFN    DC    XL1'00'            SEQUENCE NUMBER REC N OF N   @D14ADWK 03657000
NLOGL    DC    XL1'00'            LOGOUT PART OF RECORD N      @D14ADWK 03658000
NRECL    DC    XL1'00'            TOTAL LENGTH OF RECORD N     @D14ADWK 03659000
*                                                              @DA36100 03660000
         DS    0F                                              @DA36100 03661000
MACHIND  DC    C'MACH'            INDICATE MACHINE CHECK       @DA39471 03662000
*                                                                       03663000
*        END RAS COMMUNICATION AREA                            @D149DWK 03664000
         EJECT ,                                               @DA41332 03665000
***************************************************************@D149DWK 03666000
*        ERROR ENTRY USED BY RAS TRANSIENT ROUTINES            @D21WDAP 03667000
*        (LAYOUT MUST MATCH WITH MAPERPIB)                     @D66GDHH 03668000
***************************************************************@D149DWK 03669000
         SPACE 2                                               @D149DWK 03670000
         DS    0F                 FORCE BOUNDARY               @D14BDDK 03671000
WEPIBADR DS    0XL48              SET IMPLICIT LENGTH OF ENTRY @D61SDHH 03672000
WEPIBCSW DC    XL8'00'            CSW+1                        @D14BDAP 03673000
         ORG   WEPIBCSW           OVERLAY KEY IN CSW           @D21WDAP 03674000
WEPIBSTC DC    XL1'00'            CSW-KEY AND FLAG BYTE        @D21WDAP 03675000
WEPIBEND EQU   X'FF'              LAST ERROR ENTRY INDICATOR   @D21WDAP 03676000
*        EQU   X'FE'              NOT USED ANY MORE            @D21WDAP 03677000
WEPIBCNC EQU   X'FD'              CANCEL TASK INDICATOR        @D21WDAP 03678000
WEPIBCCR EQU   X'FC'              UNSUCCESSFUL RETRY INDICATOR @D21WDAP 03679000
WEPIBCCS EQU   X'FB'              SUCCESSFUL RETRIED INDICATOR @D21WDAP 03680000
         ORG   ,                  RESTORE LOCATION POINTER     @D21WDAP 03681000
WEPIBIOE DC    XL4'00'            ADDRESS OF IOEL              @D14BDAP 03682000
         DC    XL1'00'            RESERVED                     @D14BDAP 03683000
WEPIBDMC DC    XL1'00'            DAMAGED CHANNEL ID OR FF     @D14BDAP 03684000
WEPIBPUB DC    XL2'00'            ADDRESS OF FAILING PUB       @D14BDAP 03685000
WEPIBCQP DC    XL1'00'            CHANQ PRESENT INDICATION     @D51ODGL 03686000
WEPIBRTC DC    XL1'00'            RETRY COUNTER                @D14BDWK 03687000
WEPIBMSG DC    XL1'00'            MESSAGE IDENTIFIER           @D14BDWK 03688000
CCOPREP  EQU   X'80'              WAIT FOR OPERATOR RESPONSE   @D21WDAP 03689000
CCDONE   EQU   X'40'              CC HANDLING COMPLETE         @D21WDAP 03690000
CCNODEQ  EQU   X'20'              PUB NOT QUEUED IN ERROR      @D21WDAP 03691000
CCRECMSG EQU   X'03'              RECOVERED CC MESSAGE         @D21WDAP 03692000
CCERR    EQU   X'02'              CHANNEL IN ERROR MESSAGE     @D21WDAP 03693000
CCHRD    EQU   X'01'              UNRECOVERABLE CC MESSAGE     @D21WDAP 03694000
         DC    XL1'00'            RESERVED                     @D66GDHH 03695000
WEPIBFLG DC    XL1'00'            FLAG BYTE                    @D21WDAP 03696000
CCSIO    EQU   X'80'              CHAN CHECK AT INITIAL SELECT.@D21WDAP 03697000
CCDAM    EQU   X'40'              CHANNEL DAMAGE               @D21WDAP 03698000
CCREC    EQU   X'08'              RECORD BUILT OR WRITTEN      @D21WDAP 03699000
CCDSK    EQU   X'02'              CHAN CHECK ON DISK DEVICE    @D21WDAP 03700000
CCSKM    EQU   X'01'              SKIP MESSAGE WRITER          @D21WDAP 03701000
WEPIBESW DC    XL3'00'            ECSW                         @D21WDAP 03702000
WEPIBV31 DC    A(0)               VTAM: Virtual addr of CCW    @DY46396 03703490
WEPIBCQA DC    A(0)               CHANQ ADDRESS                @D51ODGL 03704000
WEPIBTOD DC    2F'0'              TOD CLOCK                    @DA41332 03705000
WEPIBQA  DC    A(0)               ADDR OF CC STACK ENTRY       @D61SDHH 03706000
WEPIBRQN DC    XL2'00'            I/O REQUESTOR TASKID         @D66GDHH 03707000
         DC    XL2'00'            RESERVED                     @D66GDHH 03708000
         DC    X'FFFF'            LAST WORK ERPIB INDICATOR    @DMP..GN 03709000
         EJECT ,                                               @D61SDHH 03710000
***************************************************************@D149DWK 03711000
*        WORK AREAS AND CONSTANTS                              @D149DWK 03712000
***************************************************************@D149DWK 03713000
         SPACE 2                                               @D149DWK 03714000
         DS    0D                 FORCE DW ALIGNMENT           @D367DJR 03715000
RASWPSW  DC    X'000A0000'        HARD WAIT PSW                @DA41332 03716000
         DC    X'00EEEEEE'        HARD WAIT PSW                @DA41332 03717000
         SPACE 1                                               @DA41332 03718000
CR14SAV  DC    F'0'               WORK AREA FOR CONTROL REG 14 @D14BDDK 03719000
EXTINTP  DC    F'0'               EXTERNAL INTERRUPT PARAM     @DY46384 03719500
         SPACE 1                                               @DA41332 03720000
RASSAVA  DC    A(RASSAVAR)        PTR TO RAS SYSSAVE           @DM03792 03721000
         SPACE 1                                               @D377DJR 03722000
TODCLOCK DC    D'0'               TOD CLOCK WORK AREA          @DA41332 03723000
RASWORK1 DC    F'0'               WORKFIELD                    @D36ZDJR 03724000
RASWORK2 DC    2F'0'              WORKFIELD                    @DA34523 03725000
CCCHIO   DC    C'HIO'                                          @D14CDAP 03726000
         SPACE 2                                               @D377DJR 03727000
MCKEY    DC    X'00'              SAVE THE STORAGE KEY         @DA41332 03728000
MCPFTEFL DC    X'00'              SAVE PFTE.S370FLG            @DA41332 03729000
MCTMPMS1 DC    X'00'              TEMP FIELD FOR MCST$MS1      @DA41332 03730000
MCTMPLOG DC    CL2' '             TEMP FIELD FOR MCST$LOG      @DA41332 03731000
MCPFTEA  DC    F'0'               SAVE A(PFTE)                 @DA41332 03732000
MCSAVVAD DC    F'0'               SAVE VIRTUAL ADDR OF FSA     @DA41332 03733000
         SPACE 2                                               @DA41332 03734000
***************************************************************@D149DWK 03735000
*        EQUATES                                               @D149DWK 03736000
***************************************************************@D149DWK 03737000
         SPACE 2                                               @D149DWK 03738000
CLOCKMSK EQU   X'F7'                                           @D35EDSK 03739000
NPBIT    EQU   X'01'              NON-PRIVILEGED BIT IN MC OLD PSW      03740000
DASDCCL  EQU   10                 RETRY LIMIT FOR DASD CHANNEL CHECK    03741000
LOGPEND  EQU   X'04'              LOG OUT IS PENDING                    03742000
RASZERO  EQU   C'Z'               $$RAST00 IS IN CORE          @DM00124 03743000
         EJECT                                                 @DA41332 03744000
***************************************************************@D149DWK 03745000
*        RAS TRANSIENT PHASE NAME TABLE                        @D149DWK 03746000
***************************************************************@D149DWK 03747000
         SPACE 2                                               @D149DWK 03748000
RASNMTAB DS    0F                 RAS PHASE NAME TABLE         @D14BDWK 03749000
         DC    C'$$RAST00'        MC / CC ROOT PHASE           @D14BDWK 03750000
         DC    C'$$RAST01'        MC / CC RECORD BUILDER       @D14BDWK 03751000
         DC    C'$$RAST02'        CC HANDLER NONE RESIDENT     @D14BDWK 03752000
         DC    C'$$RAST03'        MC ECC/EFL ANALISYS          @D14BDWK 03753000
         DC    C'$$RAST04'        MC / CRW PROCESSOR           @D14BDWK 03754000
         DC    C'$$RAST05'        CC HANDLER UR DEVICES        @DA41332 03755000
         DC    C'$$RAST06'        CC HANDLER OCR DEVICES       @D14BDWK 03756000
         DC    C'$$RAST07'        CC TAPE DEVICES              @D14BDWK 03757000
         DC    C'$$RAST08'        MC / CC RECORD WRITER CKD    @D14BDWK 03758000
         DC    C'RESERVED'        RESERVED                     @DA41332 03759000
         DC    C'$$RAST10'        CC MESSAGE WRITER            @D14BDWK 03760000
         DC    C'$$RAST11'        MC MESSAGE WRITER            @D14BDWK 03761000
         DC    C'$$RAST12'        CC TAPE DEVICES              @D14BDWK 03762000
         DC    C'$$RAST13'        MC DYNAMIC PAGE REALLOCATION @D14BDWK 03763000
         DC    C'$$RAST14'        VTAM CHANNEL CHECK           @D14BDWK 03764000
         DC    C'$$RAST15'        VTAM CHANNEL CHECK           @D14BDWK 03765000
         DC    C'$$RAST16'        MC / CC RECORD WRITER FBA    @D14BDWK 03766000
         DC    C'RESERVED'        RESERVED                     @DA41332 03767000
         DC    C'$$RAST18'        CC 3890 DEVICES              @D14BDWK 03768000
         DC    C'RESERVED'        RESERVED                     @DA41332 03769000
         DC    C'$$RAST19'        CC 3480 DEVICES              @D21CDWK 03770000
         DC    C'$$RASTXA'        AFP PRINTER CHANNEL CHECK    @D21WDRP 03771000
         DC    C'$$RAST20'        CC TPA (3590) DEVICES, PART1 @D61SDHH 03772000
         DC    C'$$RAST21'        CC TPA (3590) DEVICES, PART2 @D61SDHH 03773000
         SPACE 1                                               @D149DWK 03774000
***************************************************************@D149DWK 03775000
*        I/O ELEMENT POINTERS                                  @D149DWK 03776000
***************************************************************@D149DWK 03777000
         SPACE 2                                               @D149DWK 03778000
         DS    0F                 FORCE BOUNDARY               @D14BDDK 03779000
IOELPTRS DC    X'FF'              FLAG BYTE OF IOEL POINTER    @D14BDDK 03780000
IOELUSED EQU   X'80'              IOEL USED INDICATOR          @D14BDDK 03781000
         DC    XL3'00'            ADDR BYTES OF IOEL POINTER   @D14BDDK 03782000
         DC    A(0)               2. IOEL POINTER              @D14BDDK 03783000
         DC    A(0)               3. IOEL POINTER              @D14BDDK 03784000
         DC    A(0)               4. IOEL POINTER              @D14BDDK 03785000
         DC    A(0)               5. IOEL POINTER              @D14BDDK 03786000
         DC    X'FF'              END OF IOEL POINTERS         @D14BDDK 03787000
         SPACE 1                                               @D31AMTP 03788000
IOEXTLG  DSECT                    IO EXTENDED LOG OUT AREA     @D21BMGN 03789000
         DS    XL31                                            @D21BMGN 03790000
CCAPRCID DS    X'00'              BFY ACTUAL PROCESSOR IDENT   @D21BMGN 03791000
         SPACE 2                                               @D219DGN 03792000
&SYSECT  CSECT                                                 @D21YDGN 03793000
         SPACE 1                                                        03794000
         TITLE 'VSE/AF SUPERVISOR   MCRAS    RAS TRANSIENT AREA       ' 03795000
***************************************************************@D149DWK 03796000
*        RAS TRANSIENT AREA                                    @D149DWK 03797000
***************************************************************@D149DWK 03798000
         SPACE 2                                               @D149DWK 03799000
         DS    0D                 FORCE DW ALIGNMENT           @DCWRXGN 03800000
         DC    CL16'R-TRANSIENT AREA' EYE CATCHER              @DA41332 03801000
RTA      DS    CL(RTALEN)         RAS TRANSIENT AREA           @DA41332 03802000
RTAENTRY EQU   RTA+10             ENTRY POINT OF RTA           @D35JDJR 03803000
RTARECAR DS    CL200              RTA RECORD BUILD AREA        @D14ADWK 03804000
         TITLE 'VSE/AF SUPERVISOR   MCRAS    DSECTS                   ' 03805000
         EJECT                                                 @DA41332 03806000
***************************************************************@DA41332 03807000
*        RAS MACHINE CHECK QUEUE ENTRY                         @DA41332 03808000
***************************************************************@DA41332 03809000
         SPACE 2                                               @DA41332 03810000
         MAPMCSTK                 DSECT MACH STACK             @DA41332 03811000
         EJECT                                                 @D64IDHH 03812000
***************************************************************@DA41332 03813000
*        RAS CRW QUEUE ENTRY                                   @DA41332 03814000
***************************************************************@DA41332 03815000
         SPACE 2                                               @DA41332 03816000
         MAPCRWST                 DSECT CRW STACK              @DA41332 03817000
         EJECT                                                 @DA41332 03818000
***************************************************************@DA41332 03819000
*        RAS CRW                                               @DA41332 03820000
***************************************************************@DA41332 03821000
         CRW   DSECT=YES          DSECT CHANNEL REPORT WORD    @DA41332 03822000
         EJECT ,                                               @D61SDHH 03823000
***************************************************************@DA41332 03824000
*        RAS CC QUEUE ENTRY                                    @DA41332 03825000
***************************************************************@DA41332 03826000
         MAPCCSTK                 CC STACK ENTRY DSECT         @D61SDHH 03827000
         AIF   (NOT &MCRAS OR NOT &BGDEBUG).NPRT020            @D37ZDJR 03828000
         PRINT NOGEN                                           @D37ZDJR 03829000
.NPRT020 ANOP                                                  @D37ZDJR 03830000
&SYSECT  CSECT ,                  REESTABLISH CSECT            @D61SDHH 03831000
         MEND                                                           03832000
