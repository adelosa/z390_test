         MACRO                                                          00001000
         SGSCHED                                                        00002000
         GBLB  &BGDEBUG   DEBUGGING SERVICES                   @D35IDAP 00003000
         GBLB  &SGSCHED   SGSCHED PRINT CONTROL SWITCH         @D37DDAP 00004000
         GBLB  &VSE270    SGSCHED RELEASE CONTROL SWITCH       @D25IDAP 00006000
         GBLB  &VSE280    SGSCHED RELEASE CONTROL SWITCH       @D28ADAP 00007000
         GBLB  &VSE410    SGSCHED FUNCTION CONTROL SWITCH      @D41ADAP 00007500
         GBLB  &MIRROR    SGSCHED FUNCTION CONTROL SWITCH      @MIRROR  00008000
         GBLB  &TEST      TEST SUPPORT SWITCH                  @DVTEST  00008500
         GBLA  &AG1       NUMBER OF PUBS (FOR MORE DEVICES)    @D51ODGL 00009000
         LCLB  &REEF      REEF SUPPORT                         @D68REEF 00010000
&REEF    SETB  1                                               @D68REEF 00011000
         ACTR  60         LOOP COUNTER                         @DA44680 00012490
***************************************************************@D319DAP 00013000
*                                                              @D319DAP 00014000
*        LICENSED MATERIALS-PROPERTY OF IBM                    @D319DAP 00015000
*        THIS MACRO IS "RESTRICTED MATERIALS OF IBM"           @D319DAP 00016000
         AIF   (&VSE410).Y410000                                        00017550
*        5686-CF7 (C) COPYRIGHT IBM CORP 1979, 2005            @D61SDAP 00017610
         AGO   .N410000                                                 00017670
.Y410000 ANOP                                                           00017730
*        5686-CF8 (C) COPYRIGHT IBM CORP 1979, 2005            @D41ADAP 00017790
.N410000 ANOP                                                           00017850
*        SEE COPYRIGHT INSTRUCTIONS                            @D319DAP 00018000
*                                                              @D319DAP 00019000
***************************************************************@D319DAP 00020000
.* /* START OF SPECIFICATIONS ***************************************** 00021000
.*                                                                      00022000
.*01* MODULE-TYPE = SUPERVISOR GENERATION MACRO                         00023000
.*                                                                      00024000
.*01* DESCRIPTIVE NAME = CHANNEL SCHEDULER                              00025000
.*                                                                      00026000
.*01* NOTES = CHANGE ACTIVITY (NEW MACRO SINCE REL.35)                  00027000
.*                                                                      00028000
.*    SENSE DATA INCORRECT PROVIDED                            @DA33459 00029000
.*    SOFTWAIT WHEN CHANNEL SWITCHING IS USED                  @DA33727 00030000
.*    SYSTEM LOOP OR TASK CANCEL AFTER CUEND+BUSY ON A SIO-CC1 @DA34210 00031000
.*    SYSTEM LOOP WHEN BRINGING VTAM DOWN                      @DA35014 00032000
.*    HQ PRIORITY FOR SNSTASK I/O TO SYSLOG                    @DA35201 00033000
.*    CHANNEL PROGRAM CHECK ON D/T3480                         @DA35678 00034000
.*    3800-03 / 3800-08 SUPPORT                                @D21WDAP 00035000
.*    ENABLE FOR INTERRUPTS IN CASE OF CHANEND ONLY            @D21WDAP 00036000
.*    SPE NEW FUNCTION, SUPPORT FOR D/T9370                    @D21ODAP 00037000
.*    NEW MODE SET IGNORED FOR PREVIOUSLY INITIALIZED TAPES    @DA36437 00038000
.*    INCORRECT DEVICE ADDRESS CALCULATION AFTER 3880 CU BUSY  @DA36686 00039000
.*    CLEAN UP CHANQ IN CASE OF CHANNEL DAMAGE                 @D21YDAP 00040000
.*    PUBSCAN INCOMPLETE AFTER MULTIPLE DEVICE BUSY DETECTION  @DA36907 00041000
.*    BYTE MPX CHANNEL NOT RESTARTED AFTER CHANNEL BUSY        @DA37210 00042000
.*    GETVCE/MODVCE SUPPORT FOR TAPES           (SPE DY37265)  @D21LDAP 00043000
.*    MAINTAIN THE CORRECT ACTIVE OLD TIME STAMP FOR MIH       @DA37824 00044000
.*    PREVENT LOOP IN CASE PRIMARY+ALTERNATE CU IS BUSY        @DA38028 00045000
.*    FORCE MODESET CMD AFTER TAPE VOLUME CHANGE               @DA38216 00046000
.*    DONT TRY ALTERNATE PATH IN CASE IT IS ALREADY DOWN       @DA38767 00047000
.*    CHANNEL NOT RESTARTED AFTER TAPE READY INTERRUPT         @DA38998 00048000
.*    31-BIT REAL AND ESA SUPPORT                              @D51GDAP 00049000
.*    MORE DEVICES SUPPORT                                     @D51ODGL 00050000
.*    HARDWAIT DURING IPL AFTER MSG0I35I DUE TO NO PUBX        @DA40676 00051000
.*    HARDWAIT DUE TO CHANQ ADDR. NOT SET IN ERROR ENTRY       @DA40676 00052000
.*    HARDWAIT FFA OPERAND EXCEPTION ON SSCH INSTRUCTION       @DA41224 00053000
.*    PREVENT SIO'S TO BE ACCOUNTED TWICE IF CSWSTORED         @DA41165 00054000
.*    ENSURE CHANNEL RESTART IN CASE OF PATH SELECTION         @DA41368 00055000
.*    IMPROVE CHANNEL BALANCING                                @DA41534 00056000
.*    ENSURE SNSEMGCY-PROCESS IN CASE OF DEFERRED CSWSTORD     @DA42602 00057000
.*    PREVENT TIGHT SIO LOOP WHILE SNS HAS REQUEST ENQUEUED    @DA43182 00058000
.*    UNIQUELY IDENTIFY DOM REQUEST                            @DA43476 00059000
.*    PREVENT PARTITION HANG IN CASE OF MP BEING ACTIVE        @DA43510 00060000
.*    IMPROPER HANDLING OF AFP INTERCEPT CONDITION             @DA43585 00061000
.*    PREVENT PARTITION HANG IN CASE OF VDISK SUPPORT          @DA43697 00062000
.*    PREVENT 0P31A LOOP ON A 3480/3490 TAPE UNIT              @DA43896 00063000
.*    PREVENT 0P25I PROTECTION CHECK IN CASE OF VDISK          @DA43896 00064000
.*    SENSE-TASK LOOP: 3420 / 3410 BUSY + DEVEND INTERRUPT     @DA43972 00065000
.*    PREVENT PROT.CHECK AND WRITE INHIBIT OUTSIDE LR DOMAIN   @DA44117 00066000
.*    TPA DEVICE SUPPORT                                       @D62TAAP 00067000
.*    COMPLETE DY44117, AVOID WAITFD0 AT IPL                   @DA44136 00068000
.*    PREVENT TAPE  NOT BEING STARTED DUE TO PBXREADY BEING ON @DA44201 00069000
.*    9348 IS NOT A CARTRIDGE DEVICE                           @DA44241 00070000
.*    ENSURE REQUEST REQUEUING                                 @DA44277 00071000
.*    PREVENT PAGE FAULT IN CCW-TRANSLATION DUE TO R1 NOT LOADE@DA44364 00072000
.*    PREVENT ASSGN CCW IN CASE OF AR READ BLOCK COMMAND       @DA44471 00073000
.*    ALLOW SENSE AND NOP AND COMBINATION OF THOSE W/O RESERVE @DA44547 00074000
.*    ENHANCEMENT FOR SIR SMF                                  @DA44680 00075000
.*    ENHANCEMENTS FOR SIR SMF,VSE                             @DA44841 00076000
.*    LET AR TASK ISSUE THE DISBAND FROM GROUP COMMAND         @DA44841 00077000
.*    ENSURE ISSUING TASK TO BE POSTED ON CTC DEP.CMD. PENDING @DY45299 00078000
.*    PREVENT CHANNEL PROGRAM LOOP ON PREFIXED TAPE CCWS       @DY45299 00079000
.*    ENSURE RBL TO BE ISSUED AS SUPVR COMMAND TO PREVENT RESET@DY45383 00080000
.*    ENSURE SVT REQUEST TO BE REQUEUED IN CASE OF BUSY STATUS @DY45507 00081000
.*    ENSURE CAW CONTENTS TO BE SAVED FOR VTAPE PROCESSING     @DY45789 00082000
.*    PREVENT SET MODE TO BE PREFIXED AHEAD A NOP/SNS COMMAND  @DY45817 00083000
.*    ENSURE DISPATCHER EXIT WHEN NO PUB AVAILABLE             @DY46037 00084000
.*    PREVENT TAPES FROM BEING ASSGNED FOR VOLUME COMMAND      @DAOM114 00085000
.*    PROVIDE FOR INTERRUPT PROCESSING ON STATUS PENDING COND. @DAOM114 00086000
.*    DROP OF DISPATCHER EXITS FOR VTAPE PROCESSING            @DY46577 00086500
.*    PBXNOVOL SET BUT ASSIGN CCW NOT ISSUED                   @DY46592 00086700
.*                                                                      00087000
.**** END OF SPECIFICATIONS ***************************************** / 00088000
         SPACE 3                                               @D36IDAP 00089000
         AIF   (NOT &SGSCHED).NPRT010                          @D14BDAP 00090000
         PRINT GEN                                             @D37DDAP 00091000
.NPRT010 ANOP                                                  @D37DDAP 00092000
         DC    C'SGSCHED '                                     @D14BDAP 00093000
         DC    C'DY46592 '        LAST CHANGE ACTIVITY         @DY46592 00094860
         USING SGSCHED,RD         SGSCHED BASE POINTER         @D369DAP 00095000
         USING DISP,R6            DISPATCHER BASE POINTER      @D35IDAP 00096000
         USING PUBADR,R3          PUB BASE POINTER             @D21WDAP 00097000
SGSCHED  DS    0H                 FORCE ALIGNMENT              @D35IDAP 00098000
         TITLE 'VSE SUPERVISOR     SGSCHED     LOCATE NEXT I/O REQUEST' 00099000
         LTR   R3,R3              IS PUB ADDRESS PRESENT       @DY46037 00106000
         BZ    INITENAB           NO,                          @DY46037 00107000
         CLI   PUBCHQPT,NOTQUED   ANY OUTSTANDING REQUESTS              00108000
         BE    INITENAB           NO,                          @D62TAAP 00109000
*        OI    SYSFLAG2,AFTIOINT  SET AFTER INTERRUPT BIT ON   @D28DR06 00110000
INITSIO  BAL   R7,CQDSP           SET UP I/O REGISTERS                  00111000
*SGLINK  CQDSP,INPUT=(R3,R6,R7),OUTPUT=(R1,R4,RA),WORK=R0      @D369DAP 00112000
         USING CCBADR,R1          CCB BASE POINTER             @D35IDAP 00113000
         USING CHQADR,R4          CHANQ BASE POINTER           @D35IDAP 00114000
         USING PIBADR,RA          PIB BASE POINTER             @D35IDAP 00115000
         TM    DEVSTA,BUSY        WAS THIS PENDING STATUS      @DA44277 00116000
         BO    SIOTSTHQ           YES, TRY REQUEUING           @DA44277 00117000
         TM    PUBCSFLG,DEVBSY+QEDERR+OPINTV+PUBLOBSY          @DGA270  00118000
         BNZ   SIOTSTHQ           YES, TRY REQUEUING           @D35IDAP 00119000
         TM    CCBCLS,BTTR        TRANSL.BTAM REQUEST          @D35IDAP 00120000
         BNO   INITEXCP           NO,BRANCH TO START I/O       @D35CDAP 00121000
         L     R9,ACCWT           SET BASE FOR CCWT-MOD                 00122000
         USING CCWTADR,R9                                               00123000
         BAS   R8,CCWTRBT2        TRANSLATE NEW VIRT.CHAN.PRO  @D67..AV 00124000
*        BAL   R8,CCWTRBT2        TRANSLATE NEW VIRT.CHAN.PRO           00125000
*SGLINK  CCWTRBT2,INPUT=(R1,R3,R8,R9,RA),OUTPUT=R1             @D369DAP 00126000
         DROP  R9                 RELEASE CCWTADR BASE         @D35CDAP 00127000
         EJECT ,                                               @D359DAP 00128000
INITEXCP DS    0H'0'              ENTRY POINT FROM SGIOS       @D35IDAP 00129000
         AIF   (NOT &BGDEBUG).NMC020                           @D35IDAP 00130000
         LTR   R1,R1              DO WE HAVE CCB ADDRESS       @D35IDAP 00131000
         BNZ   INITM010           YES, THEN ITS OK             @D35IDAP 00132000
         DEBUG ALLREGS,XXDBGMC    SET UP DEBUG ENTRY           @D61POAP 00133000
         BAL   R5,SYSERROR             ====================>>> @D36IDAP 00134000
.NMC020  ANOP                                                  @D35IDAP 00135000
INITM010 LH    R2,PUBCHANN        SET UP DEVICE ADDRESS        @D35IDAP 00136000
         B     SIOSTART           GET REQUEST STARTED          @D51GDAP 00137000
         SPACE 3                                               @D52VDAP 00138000
INITENAB DS    0H'0'              ENABLE FOR I/O INTERRUPTS    @D62NDAP 00139000
         L     R9,AINTER          IOINTER BASE ADDRESS         @DY46037 00140000
         USING INTRTN,R9          IOINTER BASE POINTER         @DY46037 00141000
         AIF   (&VSE270).Y270010                                        00142000
         TM    SUPVFLAG,MPACT     IS MP ACTIVE                 @D62NDAP 00143000
         BZ    INITEN10           NO                           @D62NDAP 00144000
         DISPMAC FUNC=TPI         SAVE AND SET EXIT            @D62NDAP 00145000
         LTR   RF,RF              DID WE RECEIVE AN INTERRUPT  @D62NDAP 00146000
         BZ    INTRTN             YES, ======================> @D62NDAP 00147000
         BR    R6                 NONE,====================>>> @D62NDAP 00148000
INITEN10 TPI   0                  IS INTERRUPT PENDING         @D62NDAP 00149000
         BNZ   INTRTN             YES, ======================> @D62NDAP 00150000
         BR    R6                 NO,  ====================>>> @D62NDAP 00151000
         AGO   .N270010                                                 00152000
.Y270010 ANOP                                                           00153000
           AIF   (NOT &VSE280).N280040                                  00154000
           TM    SYSFLAG2,SCSIACT SCSI PROCESSING ACTIVE       @DSCSI   00155000
           BZ    INTDSPTPI        NO, CLEAR STACKED INTERRUPTS @DSCSI   00156000
           TPI   0                ANY INTERRUPT PENDING        @DSCSI   00157000
           BZ    INITSCSI         NO, LET SCSI PRESENT ONE     @DSCSI   00158000
           TM    INTIWORD,ADAPTERI IS THIS A THIN INTERRUPT    @DSCSI   00159000
           BZ    INTRTN           NO,  ======================> @DSCSI   00160000
           MVI   RID+1,DISPID     PREVENT STATUS SAVING        @DSCSI   00161000
           LPSW  IONPSW           ALLOW DISP TO STACK IT       @DSCSI   00162000
           DROP  ,                RELEASE ALL REGISTERS        @DSCSI   00163000
.*                                                             @DSCSI   00164000
.*         THE FOLLOWING CODE IS BEING ENTERED IN CASE OF      @DSCSI   00165000
.*         THIN-INTERRUPTS HAVING BEEN RECEIVED FOR PROCESSING @DSCSI   00166000
.*                                                             @DSCSI   00167000
           USING SGSCHED,RD       SGSCHED BASE POINTER         @DSCSI   00168000
           USING DISP,R6          DISPATCHER BASE POINTER      @DSCSI   00169000
           USING SYSS00,R0        LOW CORE BASE POINTER        @DSCSI   00170000
INITSCSI   L     RC,IJBAFCPA      ADDRESS OF FCP COMM. AREA    @DSCSI   00171000
           USING FCPTAB,RC        FCB CNTL.BLOCK BASER         @DSCSI   00172000
           ICM   RC,15,FCSCSIAD   ADDRESS OF $IJBSCSI ENTRY    @DSCSI   00173000
           BZ    INTDSPTPI        VERY STRANGE                 @DSCSI   00174000
           LA    RF,4             OFFS. OF INTERR. HANDL. ENTRY@DSCSI   00175000
           ALR   RF,RC            ADDRESS OF INTERRUPT ENTRY   @DSCSI   00176000
           BASSM RE,RF            EXIT ====================>>> @DSCSI   00177000
*SGLINK    $IJBSCSI,INPUT(RC,RE),OUTPUT(R1,R3,RF)              @DSCSI   00178000
           AIF   (NOT &BGDEBUG).NDBG020                        @DSCSI   00179000
           LA    RE,INTSCSIMAX    FIRST INVALID RETURN CODE    @DSCSI   00180000
           CLR   RF,RE            IS RETURN CODE CORRECT       @DSCSI   00181000
           BL    INTSCSIROK       BRANCH IF RC IS CORRECT      @DSCSI   00182000
           BAL   R5,SYSERROR      HARD/WAIT THE SYSTEM         @DSCSI   00183000
INTSCSIROK DS    0H'0'                                         @DSCSI   00184000
.NDBG020   ANOP                                                @DSCSI   00185000
           SLL   RF,2             MULTIPLY BY FOUR             @DSCSI   00186000
           B     INTSCSIRET(RF)   TAKE SPECIFIED EXIT          @DSCSI   00187000
INTSCSIRET B     INTDSPTPI      0 SCSI IS DONE FOR NOW         @DSCSI   00188000
           B     SSCH2INTER     4 REQUEST COMPLETE EXIT        @DSCSI   00189000
           B     INTSCSIEND     8 NO MORE SCSI REQUEST PENDING @DSCSI   00190000
INTSCSIMAX EQU   (*-INTSCSIRET)/4 MAX. RETURN CODE ALLOWED     @DSCSI   00191000
           DROP  RC               RELEASE FCPTAB BASE          @DSCSI   00192000
           SPACE 2                                             @DSCSI   00193000
INTSCSIEND DS    0H'0'                                         @DSCSI   00194000
           NI    SYSFLAG2,XFF-SCSIACT RESET SCSI ACTIVE BIT    @DSCSI   00195000
.N280040   ANOP                   LET DISP PRESENT THE STACKED          00196000
           B     INTDSPTPI                                     @DSCSI   00197000
           USING PUBADR,R3        PUB BASE POINTER             @DSCSI   00198000
SSCH2INTER DS    0H'0'            PREPARE FOR INT SIMULATION   @DSCSI   00199000
           ST    R3,INTPARM       SAVE INTERRUPT PARAMETER     @DSCSI   00200000
           LH    R2,PUBCHANN      GET CUU ADDRESS              @DSCSI   00201000
           L     R7,ASIMINT       ADDRESS OF SIMULATION ROUTINE@DSCSI   00202000
           USING SIMINTER,R7      SIMINTER BASE POINTER        @DSCSI   00203000
           LA    R9,SIMINT10-SIMINTER GET OFFSET WITHIN SIMINTE@DSCSI   00204000
           ALR   R9,R7            ADD BASE ADDRESS (31-BIT)    @DSCSI   00205000
           BSM   0,R9                  =====================>> @DSCSI   00206000
*SGLINK    SIMINTER,INPUT(R1,R2,R7)                            @DSCSI   00207000
           DROP  R7               RELEASE SIMINTER BASE        @DSCSI   00208000
INTDSPTPI  DS    0H'0'                                         @DSCSI   00209000
         DISPMAC FUNC=TPI              ====================>>> @D27ADAP 00210000
*                         RETURN TO:                           @D27ADAP 00211000
*                         IOINTER WHEN I/O INTERRUPT PENDING,  @D27ADAP 00212000
*                         DISP    OTHERWISE                    @D27ADAP 00213000
.*HERE   IT WOULD BE BETTER TO HAVE DISMAC ALWAYS RETURN       @DSCSI   00214000
         L     R9,AINTER          IOINTER BASE ADDRESS         @DSCSI   00215000
         USING INTRTN,R9          IOINTER BASE POINTER         @DSCSI   00216000
         LTR   RF,RF              DID WE RECEIVE AN INTERRUPT  @DSCSI   00217000
         BZ    INTRTN             YES, ======================> @DSCSI   00218000
         BR    R6                 NONE,====================>>> @DSCSI   00219000
.N270010 ANOP                                                           00220000
         DROP  R9                 RELEASE IOINTER BASE         @DY46037 00221000
         TITLE 'VSE SUPERVISOR     SGSCHED     START I/O ROUTINE      ' 00222000
************************************************************** @D359DAP 00223000
*                                                            * @D359DAP 00224000
*        SIO   ROUTINE                                       * @D359DAP 00225000
*                                                            * @D359DAP 00226000
************************************************************** @D359DAP 00227000
         SPACE 3                                                        00228000
         USING CCBADR,R1          CCB BASE POINTER             @DSCSI   00229000
         USING CHQADR,R4          CHANQ BASE POINTER           @DSCSI   00230000
         USING PIBADR,RA          PIB BASE POINTER             @DSCSI   00231000
SIOSTART NOP   0(,R6)             NOP INSTRUCTION              @D61NDAP 00232000
         L     R7,CCBCCW          LOAD CCW ADDRESS                      00233000
         LA    R7,0(,R7)          CLEAR HIGH ORDER BYTE        @D21ODAP 00234000
         MVZ   DEVZON,PUBDEVTY    RESTORE DEVICE TYPE ZONE              00235000
         LR    R9,R7              SET VIRTUAL=REAL FOR NOW     @DY45540 00236000
         CLC   CHQTID,IORQ4SNS    IS THIS A SNS-TASK REQUEST   @D66ADAP 00237000
         BNE   SIOPREPR           NO,  ====================>>> @D35IDAP 00238000
         L     R8,AMISINTA        LOAD MIH BASE                @DA43182 00239000
         USING MISINTAT,R8        SGMIH BASE POINTER           @DA43182 00240000
         STCK  MIHCACTO           SET NEW START TIME FOR MIH   @DA43182 00241000
         DROP  R8                 RELEASE SGMIH BASE           @DA43182 00242000
SIOSTCAW STCM  R7,7,CAW+1         STORE CCW ADDRESS IN CAW              00243000
SIOSTKEY MVI   CAW,0              CLEAR UNUSED BITS            @D61NDAP 00244000
         MVZ   CAW(L1),CHQCAWKY   MOVE KEY TO CAW              @D36IDAP 00245000
         CLC   PUBCHANN(2),SYSOCDEV REQUEST FOR CONSOLE        @D61CDAP 00246000
         BE    SIOCONS            YES, SPECIAL PROCESSING      @D61CDAP 00247000
SIO      XR    R8,R8              CLEAR REGISTER               @D35IDAP 00248000
         STH   R8,CCBSTA1         CLEAR CCB STATUS BYTES       @D14BDAP 00249000
         TM    CHQGRP,CHQGRINT    CAW SUPPLIED BY REQUESTOR    @DA35678 00250000
         BO    SIONOCLR           YES, DO NOT CLEAR            @DA35678 00251000
         STCM  R8,7,CHQCSW+1      CLEAR CSW IN CHANQ ENTRY     @D36IDAP 00252000
SIONOCLR ST    R8,CHQCSW+4                                     @DA35678 00253000
         MVI   CHQCCSIO,ZERO      CLEAR SIO CONDITION FLAG     @D62TAAP 00254000
         NI    CHQCCBB1,CLRCOM1   RESET COMMUNICATION BYTE 3   @D14BDAP 00255000
         NI    CHQCCBB2,CLRCOM2   RESET COMMUNICATION BYTE 2   @D14BDAP 00256000
         MC    $TRSIO1,$MCSDAID   ALLOW SDAIDS TO INTERCEPT    @D3CZDAP 00257000
         B     SIOGPUBX         0 NORMAL PROCESSING            @D61NDAP 00258000
         CLI   *,XFF            4 SET CONDITION CODE 01        @D52VDAP 00259000
         B     SIOAFTER           SKIP SSCH INSTRUCTION        @D52VDAP 00260000
SIOGPUBX LA    R4,0(,R4)          CLEAR HIGH ORDER BYTE        @DTIMING 00261000
         LR    R0,R3              COPY PUB POINTER             @DA44841 00262000
         SH    R0,YPUBTAB         OFFSET IN PUB TABLE          @DA44841 00263000
         TM    IJBMBADR,X'80'     IS MEASURING ACTIVE          @DTIMING 00264000
         BZ    SIOSMFNO           NO,                          @DTIMING 00265000
         AMODESW SET,AMODE=31,WR=(R8) FORCE 31-BIT MODE        @DA44680 00266000
         LR    R5,R0              COPY PUB OFFSET              @DA44680 00267000
         LA    R5,8(,R5)          ADJUST FOR MBI INDEX 0 UNUSED@DA44680 00268000
         SLL   R5,2               MEASUREMENT BLOCK OFFSET     @DA44680 00269000
         A     R5,IJBMBADR        MEASUREMENT BLOCK ADDRESS    @DA44680 00270000
*        USING SMFBLOCK,R5        SMF- BLOCK ADDRESS           @DA44680 00271000
         L     RE,IJBVSEMB        VSE BUFFER OFFSET            @DA44841 00272000
         LA    RE,0(RE,R5)        VSE MB-ENTRY ADDRESS         @DA44841 00273000
         L     R8,28(RE)          GET OLD SSCH COUNT           @DAOM043 00274000
         A     R8,F1              ADD 1                        @DA44680 00275000
         ST    R8,28(RE)          SAVE UPDATED VALUE FOR VSE   @DAOM043 00276000
.*       ENSURE VSE QUEUING TIME TO BE ACCOUNTED RIGHT NOW     @DTIMING 00277000
         STCK  X'D8'              GET TIME STAMP               @DTIMING 00278000
         ICM   R8,15,X'DA'        GET RESOLUTION BYTES         @DTIMING 00279000
         SRL   R8,3               ADJUST TO 128 USEC RESOLUTION@DTIMING 00280000
         ICM   RF,15,CHQCCBB3+1   GET  ENQUEUING TIME          @DA44680 00281000
         ST    R8,CHQCCBB3+1      SET START TIME               @DTIMING 00282000
         BZ    SIOSMFNO           NO ENQUEUING TIME PRESENT    @DTIMING 00283000
         SLR   R8,RF              TIME DIFFERENCE              @DTIMING 00284000
         AL    R8,24(,RE)         NEW QUEUING TIME             @DTIMING 00285000
         ST    R8,24(,RE)         VSE QUEUING TIME             @DTIMING 00286000
*        DROP  R5                 RELEASE SMF ENTRY BASE       @DA44680 00287000
SIOSMFNO AMODESW SET,AMODE=24,WR=(R5) BACK TO 24-BIT ADDR. MODE@DTIMING 00288000
         LR    RE,R0              GET  PUB OFFSET              @DTIMING 00289000
         SRL   RE,1               DIVIDE BY TWO                @D52HDAP 00290000
         A     RE,APBXAREA        ADDRESS OF PUBX POINTER      @D52HDAP 00291000
         L     RE,0(,RE)          PUBX POINTER                 @D52HDAP 00292000
         USING PBXADR,RE          PUBX BASE POINTER            @D52HDAP 00293000
         OC    PBXSIMAD(4),PBXSIMAD  SIMULATION PROGRAM ACTIVE @D52HDAP 00294000
         BNZ   SIOSIMPR           YES, SPECIAL PROCESSING      @D52HDAP 00295000
         TM    PUBJCFLG,PUBPPD    IS DEVICE OFFLINE            @D21ODAP 00296000
         BO    SIOAFTER           YES, SKIP SIO INSTRUCTION    @D21ODAP 00297000
         TM    IJBOLTEP,OLTAC     IS OLTEP ACTIVE              @D14NDAP 00298000
         BZ    GOLTAPP1           NO,                          @D14NDAP 00299000
         CLC   OLTPIK(2),PIK      IS THIS THE OLTEP PARTITION  @D14NDAP 00300000
         BNE   OLTRET1            NO, DONT HAVE ADDRESSABILITY @D14NDAP 00301000
GOLTAPP1 L     R8,OLTAPP1         GET OLTEP APPENDAGE ADDRESS  @D37BDAP 00302000
*SGLINK  $TRSIO1,INPUT=R2                                      @D3CZDAP 00303000
         BALR  R5,R8              CALL OLTEP IF ACTIVE                  00304000
*SGLINK  OLTAPP1,INPUT=(R1,R2,R5,R8)                           @D369DAP 00305000
         B     OLTRET1          0 GET  I/O INSTRUCTION EXECUTED@D51GDAP 00306000
         B     SIOAFTER         4 SKIP I/O INSTRUCTION         @D51GDAP 00307000
         DC    CL20'XA-SSCH-PROCESSING  '                      @D51GDAP 00308000
OLTRET1  DS    0H                                              @D51GDAP 00309000
         TM    PBXFLAG,PBXDASD    IS DEVICE DASD               @DY45540 00310000
         BZ    SSCH0000           NO,                          @DY45540 00311000
         TM    CHQFLG1,CHQECKD    CONVERTED CHANNEL PROGRAM    @DY45540 00312000
         BO    SSCH0000           YES, WE TOOK ALREADY CARE    @DY45540 00313000
         TM    PBXFLAG1,PBXRONLY  DEVICE IN READ-ONLY MODE     @DY45540 00314000
         BZ    SSCH0000           NO,                          @DY45540 00315000
         BAL   R8,SIORONLY        INHIBIT ANY WRITE ACCESS     @DY45540 00316000
SSCH0000 DS    0H'0'              PROVIDE ORB INFORMATION      @D51GDAP 00317000
         L     R5,ORB$            GET ORB ADDRESS              @D28ADAP 00318000
         USING ORB,R5             ORB BASE POINTER             @D28ADAP 00319000
         STM   R1,R2,XAIOREGS     SAVE REGISTER                @D51GDAP 00320000
         ST    R3,ORBIP           PUB ADDRESS IS INTERRUPT PARM@D51GDAP 00321000
SSCHMIRR MVC   XASUBSC1,PBXSCH    SET SUBCHANNEL NUMBER        @D51GDAP 00322000
         MVC   ORBLPM,PBXLPM      SET LOGICAL PATH MASK        @D51GDAP 00323000
         CLC   CHQTID,IORQ4AR     IS THIS A SYSTEM TASK REQUEST@D66ADAP 00324000
         BH    SSCH0010           NO,                          @D52VDAP 00325000
         TM    CCBBY3,CCWABOVE    CCW ABOVE THE LINE           @D68ADAP 00325300
         BO    SSCH0010           YES, NO PATHING POSSIBLE     @D68ADAP 00325600
         CLI   CCBCCW,ZERO        ANY PATHING INFORMATION      @D52VDAP 00326000
         BE    SSCH0010           NO,                          @D52VDAP 00327000
         MVC   ORBLPM,CCBCCW      GET PATH MASK                @D52VDAP 00328000
SSCH0010 OC    ORBLPM,PBXNOOPR    COPY NOT OPERATIONAL         @D52VDAP 00329000
         XC    ORBLPM,PBXNOOPR    USE OPERATIONAL PATH ONLY    @D52VDAP 00330000
         CLI   PBXPVPEN,ZERO      PATH VERIFICATION REQUIRED   @D52VDAP 00331000
         BE    SSCH0020           NO,                          @D52VDAP 00332000
         CLC   CHQTID,IORQ4SNS    IS THIS A SENSE TASK REQUEST @D66ADAP 00333000
         BNE   SIOPVCHK           NO, ======================>> @DA44201 00334000
SSCH0020 DS    0H'0'                                           @D68REEF 00335000
         AIF   (NOT &REEF).NREF020                             @D68REEF 00336000
         CLI   ORBLPM,ZERO        ANY PATH ACCESSIBLE          @D68REEF 00337000
         BE    SSCHPSEL           NO, PATH SELECTION ROUTINE   @D68REEF 00338000
.NREF020 ANOP                                                           00339000
SSCH0030 L     R8,CAW             GET CAW                      @D52VDAP 00340000
         STCM  R8,7,ORBCCW+1      SET CCW ADDRESS              @D52VDAP 00341000
         STCM  R8,8,ORBB0         STORE THE KEY                @D52VDAP 00342000
         MVC   PBXSSCHM(1),ORBLPM SAVE PATH MASK               @DAOM055 00342500
         NI    ORBB0,ORBKEY       LEAVE KEY BITS ONLY          @DA41224 00343000
         TM    CHQGRP,CHQGRVTM    IS THIS A VTAM REQUEST       @D61PDAP 00344000
         BZ    SSCH0040           NO,                          @D61PDAP 00345000
         MVI   ORBB0,ZERO         ENSURE PROTECTION KEY ZERO   @D61PDAP 00346000
SSCH0040 MVI   ORBB1,0            RESET SPECIAL BITS           @DY45540 00347000
         TM    CCBBY3,CCBCCWF1    IS THIS FORMAT-1 CCW         @DY45540 00348000
         BZ    SSCH0050           NO,                          @DY45540 00349000
         OI    ORBB1,ORBF         INDICATE FORMAT-1 CCW        @DY45540 00350000
SSCH0050 DS    0H'0'              SSCH PROCESSING              @D27XXAP 00352000
         AIF   (NOT &VSE410).N410020                                    00352100
         TM    CCBBY3,IDAWFMT2    USER PASSED FORMAT-2 IDAW'S  @D41ADAP 00352200
         BZ    SSCH0060           NO,                          @D41ADAP 00352300
         OI    ORBB1,ORBH         INDICATE FORMAT-2 IDAW       @D41ADAP 00352400
SSCH0060 DS    0H'0'              SSCH PROCESSING              @D41ADAP 00352500
.N410020 ANOP                                                           00352600
         DROP  R1                 RELEASE CCB BASE             @D52VDAP 00352700
         L     R1,XASUBSCH        SET SSCH PARAMETER           @DY45540 00353000
         LA    R2,ORB             PASS ALONG ORB ADDRESS       @D51GDAP 00354000
         SSCH  0(R2)              START SUBCHANNEL             @D51GDAP 00355000
         LM    R1,R2,XAIOREGS     RESTORE REGISTERS            @D51GDAP 00356000
         DROP  R5                 RELEASE ORB BASE             @DY46037 00357000
         AIF   (NOT &MIRROR).NMIR010                           @MIRROR  00358000
         BAL   R5,SIOMIROR        SAVE CC AND CHECK FOR MIRROR @MIRROR  00359000
.NMIR010 ANOP                                                  @MIRROR  00360000
         EJECT ,                                                        00361000
         USING CCBADR,R1          CCB BASE POINTER             @D52VDAP 00362000
SIOAFTER DS    0H                                              @D51GDAP 00363000
         MC    $TRSIO2,$MCSDAID   ALLOW SDAIDS TO INTERCEPT    @D52VDAP 00364000
         DEBUG SIOFLDS,XXDBGMC                                 @D61POAP 00365000
         PRODEXIT ACTIVATE,ID=POSTSIO                          @D61EDMK 00366000
         BZ    SIOPSTPR           AVAIL======================> @D35IDAP 00367000
         DROP  RE                 RELEASE PUBX BASE POINTER    @D52VDAP 00368000
         L     R9,AINTER          SET BASE FOR I/O INTERRUPT   @D35IDAP 00369000
         USING INTRTN,R9          DECLARE STANDARD ADDRESSING  @D35IDAP 00370000
         BH    SSCHBUSY           SUBCHANNEL BUSY              @D52VDAP 00371000
         BL    SSCHPEND           SUBCHANNEL STATUS PENDING    @D52VDAP 00372000
         B     INTENOP            NOTOP======================> @D35IDAP 00373000
SSCHBUSY OI    CHQCCSIO,CHQCCBSY  INDICATE SUBCHANNEL BUSY     @D52VDAP 00374000
         B     INITENAB           ENABLE FOR INTERRUPT         @D62NDAP 00375000
SSCHPEND OI    CHQCCSIO,CHQCCCSW  INDICATE PENDING STATUS      @D52VDAP 00376000
         L     R2,XASUBSCH        SET SSCH PARAMETER           @AOM1104 00377000
         STM   R2,R3,IOINF        GET CUU ADDRESS              @AOM1104 00378000
         B     INTRTN                  ======================> @AOM1104 00379000
         DROP  R9                 RELEASE IOINTER BASE         @D51GDAP 00380000
         AIF   (NOT &MIRROR).NMIR020                           @MIRROR  00381000
         TITLE 'VSE SUPERVISOR     SGSCHED    MIRROR TAPE PROCESSING  ' 00382000
         USING PBXADR,RE          PBXADR    BASE POINTER       @MIRROR  00383000
SIOMIROR DS    0H'0'                                           @MIRROR  00384000
         TM    PBXFLAG,PBXTAPE    IS THIS A TAPE REQUEST       @MIRROR  00385000
         BZ    SIOMIRET           NO,                          @MIRROR  00386000
         TM    PBXMIFLG,PBXMFACT  IS MIRRORING ACTIVE          @MIRROR  00387000
         BZ    SIOMIRET           NO, NOTHING TO DO            @MIRROR  00388000
         CLC   XASUBSC1,PBXMICPY  DID WE START THE MIRROR DEV. @MIRROR  00389490
         BE    SIOMI010           YES, THEN WE ARE DONE        @MIRROR  00390000
         SPM   R5                 RESTORE CONDITION CODE       @MIRROR  00391000
         BNZR  R5                 FAIL ======================> @MIRROR  00392000
         OI    PBXMIFLG,PBXMFRUN  INDICATE SOURCE STARTED      @MIRROR  00393000
         MVC   XASUBSC1,PBXMICPY  PROVIDE FOR MIRROR I/O       @MIRROR  00394000
         LR    R8,RE              SAVE SOURCE PUBX ADDRESS     @MIRROR  00395000
         L     RE,PBXMIPBX        GET MIRROR PUBX ADDRESS      @MIRROR  00396000
         B     SSCHMIRR           START MIRROR DEVICE NOW      @MIRROR  00397000
SIOMI010 SPM   R5                 RESTORE CONDITION CODE       @MIRROR  00398000
         BNZR  R5                 FAIL ======================> @MIRROR  00399000
         OI    PBXMIFLG,PBXMFRUN  INDICATE MIRROR STARTED      @MIRROR  00400000
         LR    RE,R8              RESTORE SOURCE PUBX          @MIRROR  00401000
SIOMIRET SPM   R5                 RESTORE CONDITION CODE       @MIRROR  00403000
         BR    R5                 RETRN======================> @MIRROR  00404000
         SPACE 1                                               @MIRROR  00405000
         DROP  RE                 RELEASE PDXADR BASE          @MIRROR  00406000
.NMIR020 ANOP                                                  @MIRROR  00407000
           AIF   (NOT &REEF).NREF040                           @D68REEF 00408000
           TITLE 'VSE SUPERVISOR     SGSCHED  PATH SELECTION ROUTINE '  00409000
           USING PBXADR,RE        PBXADR    BASE POINTER       @D68REEF 00410000
SSCHPSEL   DS    0H'0'            PATH SELECTION ROUTINE       @D68REEF 00411000
           SLR   R8,R8            CLEAR REGISTER               @D68REEF 00412000
           ICM   R8,1,PBXLPNP     GET NON-PREFERRED PATHES     @D68REEF 00413000
           BZ    SSCH0030         NO, CANT DO ANYTHING         @D68REEF 00414000
           EX    R8,SSCHEXTM      DID WE ALREADY SWITCH        @D68REEF 00415000
           BNZ   SSCH0030         YES, PROCEED MAIN LINE       @D68REEF 00416000
           CLI   PBXLPM,ZERO      WAS IT A SELECTED PATH       @D68REEF 00417000
           BNE   SSCH0030         YES, NO NEED TO SWITCH       @D68REEF 00418000
           MVC   PBXLPMSV(1),PBXLPM SAVE OLD SETTING           @D68REEF 00419000
           STC   R8,PBXLPM        SWITCH TO NON-PREFERRED      @D68REEF 00420000
           LA    R1,SSCHIPARM     POINT TO INTERRUPT INFO      @D68REEF 00421000
           B     SSCH2INTER       SIMULATE STATE CHANGE        @D68REEF 00422000
           SPACE 1                                             @D68REEF 00423000
SSCHEXTM   TM    PBXLPM,0         TEST FOR NO-PREFERRED PATH   @D68REEF 00424000
SSCHIPARM  DC    XL8'0000000085000000' STATE CHANGE CSW        @D68REEF 00425000
           DROP  RE               RELEASE PDXADR BASE          @D68REEF 00426000
.NREF040 ANOP                                                           00427000
         AIF   (&VSE280).Y280020                                        00428000
         TITLE 'VSE SUPERVISOR     SGSCHED    OPERATION REQUEST BLOCK ' 00429000
         DC    CL8'ORB'           OPERATION REQUEST BLOCK      @D51GDAP 00430000
         ORB   DSECT=NO           GENERATE ORB                 @D51GDAP 00431000
.Y280020 ANOP                                                           00432000
         TITLE 'VSE SUPERVISOR     SGSCHED     CSW-STORED PROCESSOR   ' 00433000
.**************************************************************@D359DAP 00434000
.*                                                             @D359DAP 00435000
.* FUNCTION:                                                   @D359DAP 00436000
.*           PROCESS THE STATUS BYTES STORED AS A RESULT       @D359DAP 00437000
.*           OF A SIO INSTRUCTION                              @D359DAP 00438000
.* ENTRY POINT:                                   AT LABEL     @D359DAP 00439000
.*           1. ENTERED  FROM SIO-ROUTINE            CSWSTORD  @D359DAP 00440000
.* INPUTS:                                                     @D359DAP 00441000
.*           R1= ADDRESS OF CCB                                @D359DAP 00442000
.*           R2= CHANNEL+DEVICE ADDRESS OF SELECTED DEVICE     @D359DAP 00443000
.*           R3= ADDRESS OF PUB                                @D359DAP 00444000
.*           R4= ADDRESS OF CHANQ ENTRY                        @D359DAP 00445000
.*           R6= ADDRESS OF DISPATCHER                         @D359DAP 00446000
.*           R9= IOINTER BASE REGISTER                         @D359DAP 00447000
.*           RB= SUPERVISOR BASE REGISTER                      @D359DAP 00448000
.* OUTPUTS:                                                    @D359DAP 00449000
.*                                                             @D359DAP 00450000
.* EXITS:                                         TO LABEL     @D359DAP 00451000
.*           CHANNEL CHECK HANDLER                   CCENTRY1  @D359DAP 00452000
.*                                                   CHFAIL    @D359DAP 00453000
.*           SIO-ROUTINE                             SIO       @D359DAP 00454000
.* REGISTERS:                                                  @D359DAP 00455000
.*           R1= ADDRESS OF CCB         OR ZERO                @D359DAP 00456000
.*           R2= ADDRESS OF CCT                                @D359DAP 00457000
.*           R4= ADDRESS OF CHANQ ENTRY                        @D359DAP 00458000
.*           R5= ADDRESS OF COMREG                             @D359DAP 00459000
.*           R7= UNPREDICTABLE                                 @D359DAP 00460000
.*           R8= UNPREDICTABLE                                 @D359DAP 00461000
.*           RA= ADDRESS OF PIB                                @D359DAP 00462000
.* SUBROUTINES:                                                @D359DAP 00463000
.*           CQDSP        -SET UP I/O REGISTERS                @D359DAP 00464000
.*                                                             @D359DAP 00465000
.**************************************************************@D359DAP 00466000
         USING INTRTN,R9          DECLARE STANDARD ADDRESSING  @D51GDAP 00467000
CSWSTORD OI    CHQCCSIO,CHQCCCSW  CSW STORED                   @D36SDAP 00468000
         STH   R2,CHNADR          STORE CHANNEL+DEVICE ADDRESS @D35IDAP 00469000
         L     R5,CRADDR          GET POINTER TO COMREG        @D35IDAP 00470000
         XR    R0,R0              CLEAR REGISTER               @D35IDAP 00471000
         AIF   (&VSE280).Y280040                               @DSCSI   00472000
         STH   R0,CSWCNT          CLEAR RESIDUAL COUNT         @D35IDAP 00473000
.Y280040 ANOP                                                  @DSCSI   00474000
         TM    DEVSTA,BUSY        IS THIS AN IMMEDIATE COMMAND @D35IDAP 00475000
         BO    CSWIOPEN           NO, INTERR. WAS PENDING      @D35IDAP 00476000
CSWST010 OI    CHQCCSIO,CHQCCACT  INDICATE I/O IS ONGOING      @DY45299 00477000
         OI    PUBCSFLG,DEVBSY    DEVICE BUSY FROM NOW ON      @D51GDAP 00478000
         SGVSEPT PROBE=2,SAVE=NO  ALLOW PERFORMANCE INTERCEPT  @D51GDAP 00479000
*SGLINK  SGVSEPT,WORK=(RE,RF)                                  @D51GDAP 00480490
         CLC   CHQTID,IORQ4SNS    WAS THIS A SNS TASK REQUEST  @D66ADAP 00481000
         BNE   CSWST020           NO, CONTINUE                 @DA42602 00482000
         OI    CHQCCSIO,CHQCCLTE  INDICATE LONG TIME ENTRY     @DA42602 00483000
         L     R7,AMISINTA        SGMIH BASE ADDRESS           @DA42602 00484000
         USING MISINTAT,R7        SGMIH BASE POINTER           @DA42602 00485000
         STCK  MIHCACTO           SET START TIME FOR MIH       @DA42602 00486000
         DROP  R7                 RELEASE SGMIH BASE           @DA42602 00487000
CSWST020 BAL   R7,SIOJACC         BRANCH TO SIO ACCOUNTING     @DA42602 00488000
*SGLINK  SIOJACC,INPUT=(R3,R4,R7,RA,RD)                        @D14BDAP 00489000
         SGSETUP UPDTIME,WR1=R2,WR2=R5,WR3=R7                  @D51GDAP 00490000
CSWIMDIO L     R7,CAW             LOAD ORIGINAL CCW ADDRESS    @D35IDAP 00491000
         AH    R7,H8              GET NEXT CCW ADDRESS         @D35IDAP 00492000
         STCM  R7,7,CSW+1         AND STORE IN CSW             @DA31877 00493000
         MVZ   CSW(L1),CAW        MOVE KEY TO CSW              @DA31877 00494000
CSWDOINT BAL   RE,GETPUBX         GET PUBX POINTER             @D35IDAP 00495000
*SGLINK  GETPUBX,INPUT=(R3,R9,RE),OUTPUT=R2                    @D21IDAP 00496000
         B     TSTCSW                  =====================>> @D37DDAP 00497000
         SPACE 3                                                        00498000
.*                                                             @D35IDAP 00499000
.*       WE DID RUN ONTO A PENDING INTERRUPT                   @D35IDAP 00500000
.*                                                             @D35IDAP 00501000
CSWIOPEN CLI   PUBDEVTY,TCTCA     IS THIS A CTCA               @DY45299 00502000
         BNE   CSWIOP10           NO, ITS THE 1052             @DY45299 00503000
         CLI   DEVSTA,ATTENT+BUSY DEPENDENT COMMAND PENDING    @DY45299 00504000
         BE    CSWST010           YES, POST THE USER TASK      @DY45299 00505000
CSWIOP10 ST    R0,CSW             CLEAR CCW ADDRESS IN CSW     @DY45299 00506000
         STH   R0,CSWCNT          CLEAR RESIDUAL COUNT         @DSCSI   00507000
         TM    CHNSTA,XFF-PCI-IL  ANY ABNORMAL CHANNEL STATUS  @D37DDAP 00508000
         BNZ   CSWDOINT           YES, ====================>>> @D37DDAP 00509000
         TM    DEVSTA,UNITCK      SOME KIND OF UNIT CHECK      @D37DDAP 00510000
         BO    CSWDOINT           YES, ====================>>> @D37DDAP 00511000
         TM    DEVSTA,ATTENT      WAS ATTENTION PENDING                 00512000
         BNO   CSWCUOK            NO                                    00513000
         CLC   CHQTID,IORQ4CST    IS THIS THE CST TASK         @D66ADAP 00514000
         BNE   CSWCUOK            NO, DONT ACTIVATE ATTENTION  @D35IDAP 00515000
         CLI   PUBDEVTY,T1052     IS THIS A CRT DEVICE         @D37BDAP 00516000
         BE    CSWIOPAT           NO, ITS THE 1052             @D61CDAP 00517000
         TM    SYSFLAG5,X'10'     IS ATTENTION INTERCEPT ACTIVE@D52VDAP 00518000
         BZ    CSWIOPAT           NO,                          @D52VDAP 00519000
         CLI   DEVSTA,ATTENT+BUSY WAS ATTENTION PENDING                 00520000
         BE    CSWDOINT           PROCESS ATTENTION INTERRUPT  @D52VDAP 00521000
CSWIOPAT LR    RC,RD              SAVE SGSCHED BASE            @D61CSAP 00522000
         L     RD,DOCBASE         SGDOC BASE ADDRESS           @D61CSAP 00523000
         USING SGDOC,RD           SGDOC BASE POINTER           @D61CSAP 00524000
         BAL   RE,CSTATTN         INDICATE READ REQUIRED       @D61CSAP 00525000
*SGLINK  CSTATTN,INPUT=(R6,RD,RE),WORK=(R7,R8,RF)              @D61CDAP 00526000
         DROP  RD                 RELEASE SGDOC BASE           @D61CSAP 00527000
         LR    RD,RC              RESTORE SCHEDULER BASE       @D61CDAP 00528000
         USING SGSCHED,RD                                      @D61CDAP 00529000
         B     SIO                     ======================>          00530000
CSWCUOK  DS    0H                                              @D51GDAP 00531000
         MVC   CHQCSW+4(2),DEVSTA SAVE DEVICE STATUS IN CHANQ  @D14CDOW 00532000
         CLI   PUBDEVTY,T3410     IS DEVICE 3410 OR 3420       @D14BDAP 00533000
         BH    CSWDOINT           NO, SKIP                     @D14BDAP 00534000
         CLI   PUBDEVTY,T3420     IS THIS A 3410 OR 3420       @D35ZDAP 00535000
         BL    CSWDOINT           NO,                                   00536000
         CLI   DEVSTA,BUSY+DEVEND 3410 OR 3420 VOLUME CHANGE            00537000
         BNE   CSWDOINT           NO, BRANCH                            00538000
.*       ONLINE COMMAND OR MODVCE COULD HAVE ACTIVATED SVT              00539000
.*       DUE TO WHICH THE SERVICE TASK ISSUED I/O WHICH                 00540000
.*       RETURNED THE VOLUME CHANGE INDICATION.                         00541000
         CLC   CHQTID,IORQ4SVT    IS THIS SERVICE TASK REQUEST @D66ADAP 00542000
         BE    SIO                YES, REPEAT OUR SIO NOW      @D21LDAP 00543000
         CLC   CHQTID,IORQ4SNS    IS THIS SENSE TASK REQUEST   @D66ADAP 00544000
         BE    SIO                YES, REPEAT OUR SIO NOW      @DA43972 00545000
CSWSERAC L     RC,BASESERI        ADDRESS OF PERM SERVICE TASK @D21LDAP 00546000
         BAL   RE,SERADD-SGSERI(RC) ACTIVATE SERVICE TASK      @D21LDAP 00547000
*SGLINK  SERADD,INPUT=(R3,RC,RE),WORK=(R4,R7,R8,RF)            @D21LDAP 00548000
         BAL   RE,RMSGETP2        GO GET PUB2 ADDRESS          @D35IDAP 00549000
*SGLINK  RMSGETP2,INPUT=(R3,R6,RE),OUTPUT=R8,WORK=RB           @D369DAP 00550000
         USING PUB2ADR,R8         SET BASE                     @D35IDAP 00551000
         LR    RB,R2              SAVE CUU ADDRESS             @D21IDAP 00552000
         BAL   RE,GETPUBX         GET PUBX POINTER             @D21KDAP 00553000
*SGLINK  GETPUBX,INPUT=(R3,R9,RE),OUTPUT=R2                    @D21IDAP 00554000
         USING PBXADR,R2          PUBX BASE POINTER            @D21KDAP 00555000
         OI    PBXFLAG2,PBXREADY  INDICATE AVR PROCESSING      @D21IDAP 00556000
         TM    PBXFLAG3,PBXTERP1  RESIDENT TAPE ERP            @DA44241 00557000
         BO    INITENAB           YES,                         @D62NDAP 00558000
         DROP  R2                 RELEASE PUBX BASE POINTER    @D21IDAP 00559000
         LR    R2,RB              RESTORE CUU ADDRESS          @D21IDAP 00560000
         TM    P2FLAGS,P2OPEN     OPENED VOLUME                         00561000
         BO    CSWVOLCH           YES, INDICATE VOLUME CHANGE  @DY45507 00562490
         TM    DEVSTA,BUSY        WAS THIS SOME PENDING STATUS @DY45507 00563000
         BZ    INITENAB           NO, WE NEED TO WAIT          @DY45507 00564000
         B     INITSIO            ENSURE REQUEUING             @DY45507 00565000
CSWVOLCH OI    P2TFLG1,P2TUNSOL+P2TECPT INDICATE VOLUME CHANGE @DY45507 00566000
         B     INTENOP5                =====================>> @D35IDAP 00567000
         DROP  R8                 RELEASE PUB2 BASE POINTER    @D35IDAP 00568000
         DROP  R9                 DROP IOINTER BASE            @D35IDAP 00569000
         TITLE 'VSE SUPERVISOR     SGSCHED    DEVICE INTERCEPT PROCESS' 00570000
************************************************************** @D35IDAP 00571000
*                                                            * @D35IDAP 00572000
*        DEVICE SIMULATION INTERCEPT PROCESSING              * @D35IDAP 00573000
*                                                            * @D35IDAP 00574000
************************************************************** @D35IDAP 00575000
         SPACE 3                                                        00576000
         USING PBXADR,RE          PUBX BASE POINTER            @D52HDAP 00577000
SIOSIMPR TM    PUBJCFLG,PUBPPD    WAS DEVICE OFFLINED          @D61NDAP 00578000
         BO    SIOSIM10           YES, SKIP SIO INSTRUCTION    @D61NDAP 00579000
           AIF   (NOT &VSE280).N280080                                  00580000
           TM    PBXFLAG,PBXDASD+PBXSCSI IS THIS SCSI DEVICE   @DSCSI   00581000
           BNO   SIONOSCSI        NO,                          @DSCSI   00582000
           L     R5,SIOSIMA31     GET 31-BIT ADDRESS           @DSCSI   00583000
           BASSM 0,R5             GET INTO 31-BIT MODE         @DSCSI   00584000
SIOSIMA31  DC    A(SIOSIMIN31+X'80000000')                     @DSCSI   00585000
SIOSIMIN31 L     RC,PBXSIMID      GET SAVE AREA ADDRESS        @DSCSI   00586000
           LR    R2,RE            COPY PUBX ADDRESS            @DSCSI   00587000
           SLR   R0,R0            CLEAR REGISTER               @DSCSI   00588000
           LH    R5,PIK           GET THE PIK                  @DSCSI   00589000
           ICM   R5,4,CHQCAWKY    GET PROTECTION KEY           @DSCSI   00590000
           STM   R0,R6,0(RC)      PASS ALONG PARAMETER R0-R6   @DSCSI   00591000
           LR    R1,RC            COPY PARAMETER ADDRESS       @DSCSI   00592000
           LR    R2,RC            SAVE PARAMETER ADDRESS       @DSCSI   00593000
           L     RC,IJBAFCPA      ADDRESS OF FCP COMM. AREA    @DSCSI   00594000
           USING FCPTAB,RC        FCB CNTL.BLOCK BASER         @DSCSI   00595000
           L     RC,FCSCSIAD      ADDRESS OF $IJBSCSI ENTRY    @DSCSI   00596000
           DROP  RC               RELEASE FCPTAB BASE          @DSCSI   00597000
           BASSM RE,RC            SCSI ====================>>> @DSCSI   00598000
*SGLINK    $IJBSCSI,INPUT(R1,RC,RE),OUTPUT(R1,RF)              @DSCSI   00599000
           LR    R0,R1            SAVE PARAMETER ADDRESS       @DSCSI   00600000
           BAS   RE,SMFENQCMP     END THE ENQUEUING TIME       @AOM085  00600600
           AGO   .SKIP020                                               00601200
           TM    IJBMBADR,X'80'   IS MEASURING ACTIVE          @DSCSI   00602000
           BZ    SIOSCSI10        NO,                          @DSCSI   00603000
           LR    R5,R3            COPY PUB POINTER             @DSCSI   00604000
           SH    R5,YPUBTAB       OFFSET IN PUB TABLE          @DSCSI   00605000
           LA    R5,8(,R5)        ACCOUNT FOR UNUSED ENTRY     @DSCSI   00606000
           SLL   R5,2             MEASUREMENT BLOCK OFFSET     @DSCSI   00607000
           A     R5,IJBMBADR      MEASUREMENT BLOCK ADDRESS    @DSCSI   00608000
*          USING SMFBLOCK,R5      SMF- BLOCK ADDRESS           @DSCSI   00609000
           L     R6,IJBVSEMB      VSE BUFFER OFFSET            @DSCSI   00610000
           LA    R6,0(R6,R5)      VSE MB-ENTRY ADDRESS         @DSCSI   00611000
.*         ENSURE VSE PENDING TIME TO BE ACCOUNTED RIGHT NOW   @DSCSI   00612000
           STCK  X'D8'            GET TIME STAMP               @DSCSI   00613000
           ICM   RE,15,X'DA'      GET RESOLUTION BYTES         @DSCSI   00614000
           SRL   RE,3             ADJUST TO 128 USEC RESOLUTION@DSCSI   00615000
*          DROP  R5               RELEASE SMF ENTRY BASE       @DSCSI   00616000
           ICM   R5,15,CHQCCBB3+1 GET VSE QUEUING TIME         @DSCSI   00617000
           ST    RE,CHQCCBB3+1    SET PENDING TIME             @DSCSI   00618000
           BZ    SIOSCSI10        NO QUEUING TIME PRESENT      @DSCSI   00619000
           SLR   RE,R5            TIME DIFFERENCE              @DSCSI   00620000
           AL    RE,8(,R6)        ADD VSE PENDING TIME         @DSCSI   00621000
           ST    RE,8(,R6)        NEW VSE PENDING TIME         @DSCSI   00622000
SIOSCSI10  DS    0H'0'                                         @DSCSI   00624390
.SKIP020   ANOP                                                         00624780
           LM    R1,R6,4(R2)      RESTORE MY GENERAL REGISTERS @DSCSI   00625170
           LR    RE,R2            RESTORE PUBX ADDRESS         @DSCSI   00625560
           LH    R2,PUBCHANN      RESTORE CUU ADDRESS          @DSCSI   00626000
           AIF   (NOT &BGDEBUG).NDBG040                        @DSCSI   00627000
.*                                                             @DSCSI   00628000
.*               R0=00000000                FUNCTION CODE      @DSCSI   00629000
.*               R1=              CCB       ADDRESS            @DSCSI   00630000
.*               R2=              PUBX      ADDRESS            @DSCSI   00631000
.*               R3=              PUB       ADDRESS            @DSCSI   00632000
.*               R4=              CHANQ     ADDRESS            @DSCSI   00633000
.*               R5=              00KKPPPP  KEY AND PIK        @DSCSI   00634000
.*               R6=              DISP      BASE ADDRESS       @DSCSI   00635000
.*                                                             @DSCSI   00636000
           LA    R5,SIOSCSIMAX    FIRST INVALID RETURN CODE    @DSCSI   00637000
           CLR   RF,R5            IS RETURN CODE CORRECT       @DSCSI   00638000
           BL    SIOSCSIROK       BRANCH IF RC IS CORRECT      @DSCSI   00639000
           BAL   R5,SYSERROR      HARD/WAIT THE SYSTEM         @DSCSI   00640000
SIOSCSIROK DS    0H'0'                                         @DSCSI   00641000
.NDBG040   ANOP                                                @DSCSI   00642000
           L     R9,AINTER        SET BASE FOR I/O INTERRUPT   @DSCSI   00643000
           USING INTRTN,R9        DECLARE STANDARD ADDRESSING  @DSCSI   00644000
           SLL   RF,2             MULTIPLY BY FOUR             @DSCSI   00645000
           LA    R5,SIOSCSIATB    TURN OFF 31-BIT MODE         @DSCSI   00646000
           BSM   0,R5             GET INTO 24-BIT MODE         @DSCSI   00647000
SIOSCSIATB B     SIOSCSIRET(RF)   TAKE SPECIFIED EXIT          @DSCSI   00648000
SIOSCSIRET B     SIOSCSIRUN     0 REQUEST IS RUNNING           @DSCSI   00649000
           B     SIOSCSICSW     4 CSW-STORED CONDITION         @DSCSI   00650000
           B     SIOSCSIBSY     8 REQUEST IS LONG BUSY         @DSCSI   00651000
           B     SIOSCSINOP    12 DEVICE IS NOT OPERATIONAL    @DSCSI   00652000
SIOSCSIMAX EQU   (*-SIOSCSIRET)/4 MAX. RETURN CODE ALLOWED     @DSCSI   00653000
SIOSCSIRUN DS    0H'0'            LONG BUSY PROCESSING         @DSCSI   00654000
           CLR   RF,RF            SET CONDITION CODE CC=00     @DSCSI   00655000
           B     SIOAFTER         JOIN MAIN LINE               @DSCSI   00656000
SIOSCSICSW DS    0H'0'            PREPARE FOR INT SIMULATION   @DSCSI   00657000
           CLR   RF,RF            SET CONDITION CODE CC=00     @DSCSI   00658000
           DEBUG SIOFLDS,XXDBGMC  CREATE THE DEBUG ENTRY       @DSCSI   00659000
*          MC    $TRSIO2,$MCSDAID LET SDAIDS INTERCEPT         @DSCSI   00660000
           L     R7,ASIMINT       ADDRESS OF SIMULATION ROUTINE@DSCSI   00661000
           LR    R1,R0            PROVIDE CSW ADDRESS          @DSCSI   00662000
           BSM   0,R7                  =====================>> @DSCSI   00663000
SIOSCSIBSY DS    0H'0'            LONG BUSY PROCESSING         @DSCSI   00664000
           CLI   *,ZERO           SET CONDITION CODE CC=10     @DSCSI   00665000
           DEBUG SIOFLDS,XXDBGMC  CREATE THE DEBUG ENTRY       @DSCSI   00666000
*          MC    $TRSIO2,$MCSDAID LET SDAIDS INTERCEPT         @DSCSI   00667000
           OI    PUBCSFLG,OPINTV+PUBLOBSY INDICATE LONG BUSY   @DSCSI   00668000
           B     SSCHBUSY         SUBCHANNEL BUSY              @DSCSI   00669000
SIOSCSINOP DS    0H'0'            SCSI IS NOT OPERATIONAL      @DSCSI   00670000
           TM    *,X'91'          SET CONDITION CODE CC=11     @DSCSI   00671000
           DEBUG SIOFLDS,XXDBGMC                               @DSCSI   00672000
*          MC    $TRSIO2,$MCSDAID LET SDAIDS INTERCEPT         @DSCSI   00673000
           NI    CHQGRP,XFF-X'01' RESET PVT WAS DONE BIT       @DSCSI   00674000
           B     INTENOPN            =======================>> @DSCSI   00675000
           DROP  R9               RELEASE IOINTER BASE         @DSCSI   00676000
SIONOSCSI  DS    0H'0'            NON-SCSI VIRTUAL DEVICE      @DSCSI   00677000
.N280080   ANOP                                                         00678010
           AIF   (NOT &TEST).NTST040                           @VTEST   00678020
           TM    PBXFLAG,PBXTAPE  IS THIS A TAPE DEVICE        @VTEST   00678030
           BNO   SIONOTAPE        NO,                          @VTEST   00678040
.*         VTAPE PROCESSING                                    @VTEST   00678050
           L     R5,SIOTSTA31     GET 31-BIT ADDRESS           @VTEST   00678060
           BASSM 0,R5             GET INTO 31-BIT MODE         @VTEST   00678070
SIOTSTA31  DC    A(SIOTSTIN31+X'80000000')                     @VTEST   00678080
SIOTSTIN31 DS    0H'0'            VTAPE INTERCEPT PROCESSING   @VTEST   00678090
           L     RF,IJBSPAVT      SUPVR ADDRESS VECTOR TABLE   @VTEST   00678100
           USING SUPAVT,RF        SUPAVT BASE POINTER          @VTEST   00678110
           L     RF,ASUPAVTE      ADDRESS OF SUPAVTEX          @VTEST   00678120
           USING SUPAVTEX,RF      SUPAVTEX BASE POINTER        @VTEST   00678130
           ICM   RF,15,AVTAPANC   COMMUNICATION AREA PRESENT   @VTEST   00678140
           BZ    SIOTST040        NO, PROCEED MAIN PATH        @VTEST   00678150
           USING VTAPHDR,RF       VTAPE HEADER BASE POINTER    @VTEST   00678160
SIOTST020  L     RF,PBXSIMID      GET SAVE AREA ADDRESS        @VTEST   00678170
           USING TACNTADR,RF      TACNTADR BASE                @VTEST   00678180
           L     R5,TACNV24A      ADDRESS OF 24-BIT GETVIS     @VTEST   00678190
           USING TACXAREA,R5      CONTROL AREA BASE            @VTEST   00678200
           SLR   R0,R0            CLEAR REGISTER               @VTEST   00678210
           ICM   R0,7,CAW+1       GET 1ST CCW ADDRESS W/O KEY  @VTEST   00678225
           ST    R0,TAWRKCCW      SAVE CCW ADDRESS             @VTEST   00678230
           DROP  R5               RELEASE TACXAREA BASE        @VTEST   00678245
           LH    R5,TID           GET THE TID                  @VTEST   00678250
           ICM   R5,4,CHQCAWKY    GET PROTECTION KEY           @VTEST   00678260
           L     R0,AVTAPEPR      GET VTA-TASK BASE ADDRESS    @VTEST   00678270
           LH    R2,PBXCUU        SAVE CUU ADDRESS             @VTEST   00678275
           STM   R0,R3,0(RF)      PASS ALONG PARAMETER R0-R3   @VTEST   00678280
.*                                R0=A(VTAPEPRC)               @VTEST   00678300
.*                                R1=A(CCB)                    @VTEST   00678310
.*                                R2=CUU                       @VTEST   00678320
.*                                R3=A(PUB)                    @VTEST   00678330
           ST    R5,4*R4(,RF)     SAVE KEY AND PIK IN R4 POS.  @VTEST   00678340
.*                                                             @VTEST   00678370
.*         SIMULATE A SSCH CC=00  CONDITION                    @VTEST   00678385
.*                                                             @VTEST   00678390
           CR    R3,R3            SET CONDITION CODE CC=0      @VTEST   00678405
           MC    $TRSIO2,$MCSDAID ALLOW SDAIDS TO INTERCEPT    @VTEST   00678410
           DEBUG SIOFLDS,XXDBGMC  PROVIDE BEBUG INFO           @VTEST   00678430
           OI    CHQCCSIO,CHQCCRUN+CHQCCACT ACTIVE AND RUNNING @VTEST   00678450
           OI    PUBCSFLG,DEVBSY  DEVICE BUSY FROM NOW ON      @VTEST   00678460
           LR    R2,RE            SAVE PUBX ADDRESS            @VTEST   00678462
           BAS   RE,SMFENQCMP     END THE ENQUEUING TIME       @VTEST   00678464
           LR    RE,R2            RESTORE PUBX ADDRESS         @VTEST   00678466
           SGVSEPT PROBE=2,SAVE=YES ALLOW PERFORMANCE INTERCEPT@VTEST   00678470
*SGLINK    SGVSEPT                                             @VTEST   00678480
           BAL   R7,SIOJACC       UPDATE SIO COUNTER           @VTEST   00678490
*SGLINK    SIOJACC,INPUT=(R3,R4,R7,RA,RD)                      @VTEST   00678500
           L     R9,PBXSIMAD      IJBTAPE SIMULATION ROUTINE   @VTEST   00678515
           BASSM R7,R9            IJBTAPE ==================>> @VTEST   00678520
*SGLINK    IJBTAPE,INPUT=(R6,R7,R9,RF),OUTPUT=(R1,R2,R3)       @VTEST   00678530
.*                                                             @VTEST   00678540
.*         HAVE IJBTAPE SIMULATE AND COMPLETE THE I/O OPERATION@VTEST   00678550
.*         AND THEN RETURN WITH THE INTERRUPT STATUS INFO.     @VTEST   00678551
.*                                                             @VTEST   00678552
.*                                R1=A(CSW)                    @VTEST   00678553
.*                                R2=CUU                       @VTEST   00678554
.*                                R3=A(PUB)                    @VTEST   00678555
.*                                                             @VTEST   00678556
           ST    R3,INTPARM       SAVE INTERRUPT PARAMETER     @VTEST   00678560
           L     R7,ASIMINT       ADDRESS OF SIMULATION ROUTINE@VTEST   00678570
           USING SIMINTER,R7      SIMINTER BASE POINTER        @VTEST   00678580
           LA    R9,SIMINT10-SIMINTER OFFSET WITHIN SIMINTER   @VTEST   00678590
           ALR   R9,R7            ADD BASE ADDRESS (31-BIT)    @VTEST   00678600
           BSM   0,R9                  =====================>> @VTEST   00678610
*SGLINK    SIMINTER,INPUT(R1,R2,R7)                            @VTEST   00678620
           DROP  R7               RELEASE SIMINTER BASE        @VTEST   00678630
           SPACE 3                                                      00678635
SIOTST040  LA    R9,SIONOTAPE                                           00678640
           BSM   0,R9             PROCEED IN 24-BIT MODE                00678650
           SPACE 2                                                      00678660
SIONOTAPE  DC    0H'0'                                                  00678670
.NTST040   ANOP                                                         00678680
         CR    R0,R0              SET CONDITION CODE CC=0      @D52HDAP 00679000
         MC    $TRSIO2,$MCSDAID   ALLOW SDAIDS TO INTERCEPT    @D52HDAP 00680000
         OI    CHQCCSIO,CHQCCRUN+CHQCCACT ACTIVE AND RUNNING   @D52HDAP 00681000
         OI    PUBCSFLG,DEVBSY    DEVICE BUSY FROM NOW ON      @D52HDAP 00682000
         SGVSEPT PROBE=2,SAVE=YES ALLOW PERFORMANCE INTERCEPT  @D52VDAP 00683000
*SGLINK  SGVSEPT                                               @D51GDAP 00684490
         BAL   R7,SIOJACC         UPDATE SIO COUNTER           @D52HDAP 00685000
*SGLINK  SIOJACC,INPUT=(R3,R4,R7,RA,RD)                        @D52HDAP 00686000
SIOSIM10 LR    R7,RE              SAVE PUBX POINTER            @DA43697 00687000
         DROP  RE                 RELEASE PBXADR BASE          @DY45789 00688000
         USING PBXADR,R7          PUBX BASE POINTER            @DY45789 00689000
         DROP  R1                 RELEASE CCB BASE POINTER     @DA43697 00694000
         LA    R1,SIOSIMOK        LOAD CONTINUATION ADDRESS    @DA43697 00695000
         DISPMAC FUNC=SDEXIT,INP1=R1,WR1=R5 SAVE CURRENT STATUS@DA43697 00696000
.*                                                                      00697000
.*            REGISTERS WILL BE SAVED IN 2ND SAVE AREA AND              00698000
.*            SVRETURN WILL BE SET FOR THE REQUEST-OWNING TASK.         00699690
.*            THE INSTRUCTION ADDRESS OF THE PSW IN THE 2ND SAVE AREA   00700590
.*            WILL BE MODIFIED BY THE ADDRESS GIVEN IN REGISTER-R1      00701180
.*            THIS IS DONE TO MAKE SURE THAT THE TASK IS ACTIVE AT THE  00702190
.*            TIME WHEN THE ADDRESS IN R1 (SIOSIMOK) IS BEING ENTERED.  00702380
.*            IN ORDER TO MAKE SURE THAT THE GENERAL EXIT IS BEING      00702570
.*            SCHEDULED, WE HAVE TO MAKE THE TASK "READY" OF COURSE.    00702760
.*                                                                      00703000
.*            INPUT:  R1 - ADDRESS OF WHERE TO RETURN                   00704000
.*                    R5 - WORK REGISTER                                00705000
.*                                                                      00706000
SIOSIM20 LR    R1,R4              INDICATE CONDITIONAL POSTING @DA43697 00707000
         LA    R1,0(,R1)          CLEAR HIGH ORDER BYTE        @DA43697 00708000
         L     R5,ASRQTAB         RESOURCE QUEUE BASE ADDRESS  @DA43697 00709000
         LA    R5,SRQVDS-SRQTAB(R5) VIRTUAL DEVICE QUEUE       @DA43697 00710000
         BAL   RF,RPOST           SET TASK READY AGAIN         @DA43697 00711000
*SGLINK  RPOST,INPUT=(R1,R5,R6,RF),WORK=(R5,RE)                @DA43697 00712000
.*                                                                      00713000
.*       SINCE WE HAVE EXPERIENCED CASES WHERE THE                      00714790
.*       INITIAL TASK HAS ALREADY BEEN SET I/O BOUND                    00715580
.*       WE WILL MAKE IT READY NOW IN ORDER TO GET THE                  00716370
.*       DISP-EXIT FOR THIS TASK NVOKED.                                00717160
.*                                                                      00718000
         L     R8,TIBPTR          LOAD TIB POINTER             @D66ADAP 00719000
         BAL   RF,IOPOST1         MAKE TASK READY IF I/O BND   @D66ADAP 00720000
*SGLINK  IOPOST1,INPUT=(R6,R8,RF),WORK=RE                               00721000
         AIF   (NOT &TEST).NTST060                             @DVTEST  00722190
         B     INITENAB            EXIT                        @DVTEST  00722380
         AGO   .YTST020                                        @DVTEST  00722570
.NTST060 ANOP                                                           00722760
         CLI   PBXFLAG,PBXTAPE    IS THIS A VIRTUAL TAPE       @DY45789 00723000
         BNE   INITENAB           NO,  ======================> @DY46037 00724000
         AMODESW SET,AMODE=31,WR=(RF) FORCE 31-BIT MODE        @DY45789 00725000
         L     RF,IJBSPAVT        SUPVR ADDRESS VECTOR TABLE   @D68ADAP 00726080
         USING SUPAVT,RF          SUPAVT BASE POINTER          @D68ADAP 00726120
         L     RF,ASUPAVTE        ADDRESS OF SUPAVTEX          @D68ADAP 00726160
         USING SUPAVTEX,RF        SUPAVTEX BASE POINTER        @D68ADAP 00726200
         ICM   RF,15,AVTAPANC     COMMUNICATION AREA PRESENT   @D68ADAP 00726240
         BZ    SIOSIM40           NO, PROCEED MAIN PATH        @D68ADAP 00726280
         USING VTAPHDR,RF         VTAPE HEADER BASE POINTER    @D68ADAP 00726320
         TM    VTAPHFLG,VTAPTBND  VTA-TASK WAITING FOR TIMER   @D68ADAP 00726360
         BZ    SIOSIM40           NO, PROCEED                  @D68ADAP 00726400
.*                                                             @D68ADAP 00726420
.*       WE NEED TO DELAY THIS REQUEST UNTIL VTA HAS COMPLETED @D68ADAP 00726440
.*       ITS PREVIOUS REQUEST ENQUEUING                        @D68ADAP 00726480
.*                                                             @D68ADAP 00726490
         L     R1,AVTALTCB        VTA TIMER ECB ADDRESS        @DPTF2   00726500
         L     R5,ASRQTAB         RESOURCE TABLE BASE POINTER  @D68ADAP 00726520
         LA    R5,SRQCHQ-SRQTAB(,R5) RESOURCE QUEUE (CHANQ)    @D68ADAP 00726560
         BAL   RF,UNPOST          UNPOST USER TASK             @D68ADAP 00726600
*SGLINK  UNPOST,INPUT=(R5,R6,RF),WORK=(R5,RE)                  @D68ADAP 00726640
SIOSIM40 L     RF,PBXSIMID        GET SAVE AREA ADDRESS        @DY45789 00726720
         USING TACNTADR,RF        TACNTADR BASE                @DY45789 00727000
         L     RF,TACNV24A        ADDRESS OF 24-BIT GETVIS     @DY45789 00728000
         USING TACXAREA,RF        CONTROL AREA BASE            @DY45789 00729000
         SLR   RE,RE              CLEAR REGISTER               @DY45789 00730000
         ICM   RE,7,CAW+1         GET CCW ADDRESS W/O KEY      @DY45789 00731000
         ST    RE,TAWRKCCW        SAVE CCW ADDRESS             @DY45789 00732000
         BR    R6                 GET THE EXIT SCHEDULED       @DY45789 00733000
         DROP  RF                 RELEASE TACXAREA BASE        @DY45789 00734000
.YTST020 ANOP                                                  @DVTEST  00734500
         DROP  R7                 RELEASE PUBX BASE            @DY45789 00735000
         SPACE 2                                                        00736000
.*                                                                      00743000
.*       THE FOLLOWING CODE IS RUNNING AS DISPATCHER EXIT CODE          00744000
.*       AND THAT TASK IS ACTIVE NOW                                    00744500
.*                                                                      00745000
SIOSIMOK DS    0H'0'                                                    00746190
         BAS   RE,SMFENQCMP       INDICATE ENQUEUE COMPLETE    @DAOM085 00746380
         LR    RE,R7              RESTORE PUBX BASE POINTER    @DA43697 00746570
         USING PBXADR,RE          PUBX BASE POINTER            @DA43697 00747000
         L     R1,CHQCCBAD        GET CCB ADDRESS              @DA43697 00748000
         ICM   R1,8,H0            CLEAR HIGH ORDER BYTE        @DA43697 00749000
         USING CCBADR,R1          CCB BASE POINTER             @DA43697 00750000
         TM    PUBJCFLG,PUBPPD    WAS DEVICE OFFLINED          @DA43697 00751000
         BO    SIOAFTER           YES, BYPASS SIMULATION       @DA43697 00752000
         SLR   R0,R0              CLEAR R0                     @D52HDAP 00753000
         AMODESW SET,AMODE=31,WR=(R7) FORCE 31-BIT MODE        @D25IDAP 00754000
         L     R7,PBXSIMID        GET SAVE AREA ADDRESS        @D52HDAP 00755000
         AIF   (&TEST).YTST040                                 @DVTEST  00756490
         CLI   PBXFLAG,PBXTAPE    IS THIS A VIRTUAL TAPE       @DVTA    00757000
         BNE   SIOSIMA0           NO,                          @DVTA    00758000
         USING TACNTADR,R7        TACNTADR BASE                @DVTA    00759000
         L     RF,IJBSPAVT        SUPVR ADDRESS VECTOR TABLE   @PTF2+   00759100
         USING SUPAVT,RF          SUPAVT BASE POINTER          @PTF2+   00759200
         L     RF,ASUPAVTE        ADDRESS OF SUPAVTEX          @PTF2+   00759300
         USING SUPAVTEX,RF        SUPAVTEX BASE POINTER        @PTF2+   00759400
         ICM   RF,15,AVTAPANC     COMMUNICATION AREA PRESENT   @PTF2+   00759500
         BZ    SIOSIM40           NO, PROCEED MAIN PATH        @PTF2+   00759600
         USING VTAPHDR,RF         VTAPE HEADER BASE POINTER    @PTF2+   00759700
         TM    VTAPHFLG,VTAPTBND  VTA-TASK WAITING FOR TIMER   @PTF2+   00759800
         BO    SIOSIM10           YES, WE HAVE TO WAIT         @PTF2+   00759900
         L     R0,AVTAPEPR        GET VTA-TASK BASE ADDRESS    @DVTA    00760000
         LH    RF,TID             GET THE TID                  @DVTA    00761000
         B     SIOSIMB0           JOIN MAIN PATH               @DVTA    00762000
         DROP  R7                 RELEASE TACNTADR BASE        @DY45789 00763000
         DROP  RF                 RELEASE VTAPHDR BASE         @DAOM085 00764290
.YTST040 ANOP                                                  @DTEST   00764580
SIOSIMA0 LH    RF,PIK             GET THE PIK                  @DA43510 00765000
SIOSIMB0 ICM   RF,4,CHQCAWKY      GET PROTECTION KEY           @DA43896 00766000
         STM   R0,R3,0(R7)        PASS ALONG PARAMETER R0-R3   @DA43510 00767000
         ST    RF,16(,R7)         PASS ALONG PARAMETER         @DA43510 00768000
         L     R0,PBXSIMAD        SIMULATION ROUTINE ADDRESS   @D52HDAP 00769000
         LR    R1,R7              SET UP PARAMETER REGISTER    @D52HDAP 00770000
         L     R2,ASIMINT         ADDRESS OF INTERRUPT SIMULATE@D52HDAP 00771000
         L     R9,ADISPEXR        SET EXIT BASE ADDRESS        @D52HDAP 00772000
         L     R8,TIBPTR          GET TIB POINTER              @D52HDAP 00773000
         SLR   R3,R3              CLEAR REGISTER               @D52VDAP 00774000
SIOSIMC0 MVI   RID+1,REENTRID     SET REENTRENT RID            @DVTA    00783000
         BALR  R7,R9              HAVE DISP ENQUEUE THE EXIT   @D52HDAP 00784490
*SGLINK  DISPEXR,INPUT=(R0,R1,R2,R3,R6,R7,R8,R9),OUTPUT=RF,    @D52HDAP*00785000
               WORK=(R1,R3,R5,RA,RC)                           @D52HDAP 00786000
.**************************************************************         00787000
.*       ENQUEUE A NEW GENERAL EXIT ELEMENT INTO THE                    00787200
.*       TID-ASSOCIATED GENERAL DISPATCHER EXIT CHAIN                   00787400
.*                                                                      00787600
.*       R0 - ENTRY-POINT ADDRESS OF EXIT                               00788000
.*       R1 - PARAMETER LIST ADDRESS                                    00789000
.*       R2 - ADDRESS OF WHERE THE EXIT ROUTINE SHOULD RETURN           00790000
.*       R3 - PROGRAM CHECK EXIT ADDRESS                                00791000
.*       R6 - DISPATCHER BASE ADDRESS                                   00792000
.*       R7 - LINK REGISTER                                             00793000
.*       R8 - TIB ADDRESS OF TASK, WHERE TO ADD THE ELEMENT             00794490
.*       R9 - DISPEXRT ROUTINE'S BASE ADDRESS                           00795000
.*OUTPUT:                                                               00796000
.*       RF - GETVIS RETURN CODE (IF GETVIS FAILED)                     00797000
.*            0      OTHERWISE                                          00798000
.*           WORK: R1, R3, R5, RA, RC                                   00799000
.**************************************************************         00800000
         MVI   RID+1,SYSTEMID     SET ROUTINE ID TO SYSTEM     @D52HDAP 00801000
         L     R7,PBXSIMID        GET SAVE AREA ADDRESS        @DA43510 00802000
         LM    R0,R3,0(R7)        RESTORE I/O REGISTERS        @DA43510 00803000
         AMODESW SET,AMODE=24,WR=(RC) GET BACK INTO 24 BIT     @D25IDAP 00835000
         LTR   RF,RF              WAS EXIT ESTABLISHED         @DA43510 00836000
         BZ    SIOPST20           YES,                         @D52VDAP 00837000
*HERE    RF    UNEQUAL ZERO INDICATES GETVIS FAILURE                    00838000
         B     SIOPST20           DONT KNOW WHAT TO DO         @D52HDAP 00839000
         DROP  RE                 RELEASE PBX BASE POINTER     @DA43510 00840000
ASIMINT  DC    A(SIMINTER+X'80000000') ADDR.INTERRPT.SIMULAT   @D66ADAP 00841000
AVTAPEPR DC    A(VTAPEPRC+X'80000000') VTA-SYSTEM TASK ADDRESS @DVTA    00843000
AVTALTCB DC    A(VTALTECB)        ADDRESS OF VTA TIMER ECB     @DPTF2   00844490
         EJECT ,                                                        00845000
************************************************************** @DA44201 00846000
*                                                            * @DA44201 00847000
*        PATH VERIFICATION INITIATION                        * @DA44201 00848000
*                                                            * @DA44201 00849000
************************************************************** @DA44201 00850000
         SPACE 3                                               @DA44201 00851000
         USING PBXADR,RE          PUBX BASE POINTER            @DA44201 00852000
SIOPVCHK DS    0H'0'              CHECK AND INITIATE PVT PROC. @DA44201 00853000
         OI    PBXFLAG3,PBXF3PVT  DO PATH VERIFICATION         @DA44201 00854000
         CLC   PBXPVPEN(1),PBXPIM INSTALL PROCESSING           @DA44201 00855000
         BNE   SIOPV010           NO, DO PATH VERIFICATION     @DA44201 00856000
         NI    PBXFLAG3,XFF-PBXF3PVT RESET PVT PROCESSING      @DA44201 00857000
         OI    PBXFLAG3,PBXF3INS  DO INSTALL PROCESSING        @DA44201 00858000
SIOPV010 L     RD,ASNSINIT        GET SENSE TASK BASE ADDRESS  @DA44201 00859000
         USING SNSINIT,RD         SENSE ATSK BASE POINTER      @DA44201 00860000
         BAL   R7,SNSACT          ACTIVATE SNS-TASK            @DA44201 00861000
*SGLINK  SNSACT,INPUT=(R3,R7,RD),WORK=R8                       @DA44201 00862000
         L     RD,INITBASE        RESTORE SGSCHED BASE ADDRESS @DA44201 00863000
         USING SGSCHED,RD         SGSCHED BASE POINTER         @DA44201 00864000
         B     INITENAB                =====================>> @DA44201 00865000
         DROP  RE                 RELEASE PBX BASE POINTER     @DA44201 00866000
         TITLE 'VSE SUPERVISOR     SGSCHED     SIO POST PROCESSING    ' 00867000
         USING CHQADR,R4          CHANQ BASE POINTER           @DA43510 00868000
************************************************************** @D35IDAP 00869000
*                                                            * @D35IDAP 00870000
*        SIO POST PROCESSING                                 * @D35IDAP 00871000
*                                                            * @D35IDAP 00872000
************************************************************** @D35IDAP 00873000
         SPACE 3                                                        00874000
         USING PBXADR,RE          PUBX BASE POINTER            @D66ADAP 00875000
SIOPSTPR OI    CHQCCSIO,CHQCCRUN+CHQCCACT ACTIVE AND RUNNING   @D35IDAP 00876000
         OI    PUBCSFLG,DEVBSY    DEVICE BUSY FROM NOW ON      @D51GDAP 00877000
         DROP  RE                 RELEASE PUBX BASE            @D66ADAP 00878000
         SGVSEPT PROBE=2,SAVE=NO  ALLOW PERFORMANCE INTERCEPT  @D51GDAP 00879000
*SGLINK  SGVSEPT,WORK=(RE,RF)                                  @D51GDAP 00880490
         CLC   CHQTID,IORQ4SNS    WAS THIS A SNS TASK REQUEST  @D66ADAP 00881000
         BNE   SIOPST10           NO, CONTINUE                 @D14CDOW 00882000
         OI    CHQCCSIO,CHQCCLTE  INDICATE LONG TIME ENTRY     @D14CDOW 00883000
         L     R7,AMISINTA        SGMIH BASE ADDRESS           @D52VDAP 00884000
         USING MISINTAT,R7        SGMIH BASE POINTER           @D14CDOW 00885000
         STCK  MIHCACTO           SET START TIME FOR MIH       @D14CDOW 00886000
         DROP  R7                 RELEASE SGMIH BASE           @D14CDOW 00887000
         B     INITENAB                                        @D62NDAP 00888000
SIOPST10 EQU   *                                               @D14CDOW 00889000
         BAL   R7,SIOJACC         UPDATE SIO COUNTER           @D35IDAP 00890000
*SGLINK  SIOJACC,INPUT=(R3,R4,R7,RA,RD)                        @D14BDAP 00891000
SIOPST20 STH   R2,CHNADR          SET UP LOW CORE PROPERLY     @D35IDAP 00892000
         B     INITENAB                ======================> @D35IDAP 00893000
         SPACE 3                                               @D149DAP 00894000
         TITLE 'VSE SUPERVISOR     SGSCHED     SIO PRE-PROCESSING     ' 00895000
************************************************************** @D359DAP 00896000
*                                                            * @D359DAP 00897000
*        SIO PREPROCESSING ROUTINES                          * @D359DAP 00898000
*                                                            * @D359DAP 00899000
************************************************************** @D359DAP 00900000
         SPACE 3                                                        00901000
         USING CCWADR,R7          REAL CCW BASE                @D35IDAP 00902000
SIOPREPR DS    0H'0'              PRE SIO PROCESSING           @D35IDAP 00903000
         BAL   RE,RMSGETP2        GET PUB2 ADDRESS CALCULATED  @D21WDAP 00904000
*SGLINK  RMSGETP2,INPUT=(R3,R6,RE),OUTPUT=R8,WORK=RB           @D21WDAP 00905000
         USING PUB2ADR,R8         DECLARE BASE FOR PUB2        @D21WDAP 00906000
         TM    P2FLAGS,P2NOSIO+P2DOMSV ERP WANTS CONTROL FIRST @D61CDAP 00907000
         BNZ   SIOTOERP           YES, ======================> @D61CDAP 00908000
SIOPRE00 TM    CHQGRP,CHQGRINT    SYSTEM SUPPLIED CCW'S AVAIL  @D21CDOW 00909000
         BNO   SIOPRE05           NO,                          @D21CDOW 00910000
         DROP  R8                 RELEASE PUB2 BASE POINTER    @D61CDAP 00911000
         L     R8,CHQCAW          GET SYSTEM-PREPARED CAW      @D21CDOW 00912000
         ST    R8,CAW             AND STORE IT TO LOW CORE     @D21CDOW 00913000
         B     SIO                     ======================> @D21CDOW 00914000
         USING PUB2ADR,R8         DECLARE BASE FOR PUB2        @D21WDAP 00915000
SIOPRE05 LA    R7,CCWTOT          CLEAR HIGH ORDER BYTE        @DA23945 00916000
.*                                                             @D359DAP 00917000
.* IF THE USER DID PRIVATE CCW TRANSLATION, THE REAL ADDRESS   @D359DAP 00918000
.* OF THE CHANNEL PROGRAM IS NOT EQUAL TO THE VIRTUAL ADDRESS. @D359DAP 00919000
.* THE REAL ADDRESS IS KEPT IN REG 7 AND USED WHENEVER         @D359DAP 00920000
.* IT IS NEEDED FOR I/O.                                       @D359DAP 00921000
.* THE VIRTUAL ADDRESS IS KEPT IN REGISTER 9 AND USED WHENEVER @D359DAP 00922000
.* AN INSTRUCTION REFERS TO A CCW.                             @D359DAP 00923000
.*                                                             @D359DAP 00924000
         DROP  R7                 DONT USE REAL ADDRESS        @D35CDAP 00925000
         LTR   R9,R7              PROVIDE FOR VIRTUAL = REAL   @DA15980 00926000
         BZ    SIOPPR10           ADDRESS IS ZERO, SKIP VIRTAD @DA15980 00927000
         TM    CCBCLS,XCPR        IT IT A REAL CCW ADDRESS              00928000
         BNO   SIOPPR10           NO, THEN R9 IS VIRTUAL                00929000
         AMODESW CALL,ADDRESS=VIRTAD,REGS=R6                   @D52VDAP 00930000
*SGLINK  VIRTAD,INPUT=(R6,R9),OUTPUT=RF,WORK=R9                @D369DAP 00931000
         L     R6,DISPAD          RESTORE DISPATCHER ADDRESS            00932000
         LTR   R9,RF              SAVE VIRTUAL CCW ADDRESS              00933000
         BZ    ERR38              CCNL ====================>>>          00934000
         USING CCWADR,R9          VIRTUAL CCW BASE             @D35CDAP 00935000
SIOPPR10 TM    CHQDEV,CHQDASD     IS DEVICE DASD OR DISKETTE   @D35IDAP 00936000
         BO    SIOPPR40           YES,                         @D35IDAP 00937690
         CLI   CHQSLUB,SYSIPT     SYSRDR/SYSIPT REQUEST        @D36IDAP 00938380
         BH    SIOPPR40           NO,                                   00939070
         CLI   PUBDEVTY,T2501     IS THIS THE 2501 DEVICE               00940000
         BNE   SIOPPR30           NO, THEN FORCE ERR30         @DA11765 00941000
         TM    CCBCCW,FAST2501    LIOCS READ AHEAD REQUEST              00942000
         BZ    SIOPPR20           NO, NORMAL REQUEST           @DA11765 00943000
         TM    PUBJCFLG,EOF2501   END OF FILE PROCESSED        @DA11765 00944000
         BZ    SIOPPR30           NO, CONTINUE TEST            @DA11765 00945000
         NI    PUBJCFLG,XFF-EOF2501 RESET EOF SWITCH           @DA11765 00946000
         L     R9,AINTER          SET BASE FOR I/O INTERRUPT            00947000
         USING INTRTN,R9          ESTABLISH ADDRESSABILIY               00948000
         BAL   RE,GETPUBX         ADDRESS OF PUBX              @D62TAAP 00949000
*SGLINK  GETPUBX,INPUT(R3,R9,RE),OUTPUT=R2                     @D62TAAP 00950000
         B     PSTRESET           DEQUE=====================>>          00951000
         DROP  R9                 DROP IOINTER BASE REGISTER            00952000
EOF2501  EQU   X'04'              END OF FILE ON 2501 SYSIN    @DA11765 00953000
         USING CCWADR,R9          VIRTUAL CCW BASE             @D35CDAP 00954000
SIOPPR20 NI    PUBJCFLG,XFF-EOF2501 RESET EOF SWITCH           @DA11765 00955000
SIOPPR30 TM    PIBFLG2,JOBDUN     HAS /& BEEN READ             @D51IDAP 00956000
         BO    ERR30              YES, ====================>>> @DA11765 00957000
SIOPPR40 DS    0H'0'              NON SYSIN PROCESSING                  00958190
         AIF   (&VSE410).Y410040                                        00958380
         TM    CCBBY3,OLTP        IS IT AN OLTEP REQUEST                00958570
         BO    SIOSTCAW           YES, ======================>          00959000
.Y410040 ANOP                                                           00959500
         TM    CHQDEV,CHQTAPE     IS DEVICE TAPE               @D62TAAP 00960000
         BO    SIOTAPPR           YES, =====================>> @D62TAAP 00961000
         CLI   CHQERRCT,ZERO      ERROR IN ERP                 @D51ODGL 00962000
         BNE   SIOSTCAW           YES, ======================>          00963000
         SR    R0,R0              SET OFFSET POINTER TO ZERO   @D35IDAP 00964000
         TM    CHQPROC,CHQFILE    IS THIS A CKD SYSFILE REQUEST@D35IDAP 00965000
         BO    SIOSFPRC           YES, ====================>>> @D35IDAP 00966000
         TM    CHQDEV,CHQDASD     IS DEVICE DASD OR DISKETTE   @D51EDAP 00967000
         BZ    SIOSTCAW           NO,  ======================> @D51EDAP 00968000
         LR    RE,R3              COPY PUB POINTER             @D14BDAP 00969000
         SH    RE,YPUBTAB         GET PUB OFFSET               @D14BDAP 00970000
         SRL   RE,PUBSLEN-PBXISLEN DIVIDE BY TWO               @D51ODGL 00971000
         A     RE,APBXAREA        ADDRESS OF PUBX POINTER      @D14BDAP 00972000
         L     RE,0(RE)           ADDRESS OF PUBX              @D14BDAP 00973000
         USING PBXADR,RE          PUBX BASE POINTER            @D14BDAP 00974000
         CLI   PUBDEVTY,TECKD     IS THIS AN ECKD DEVICE       @D51EDAP 00975000
         BNE   SIONECKD           NO                           @D51EDAP 00976000
         OI    CHQCCBB1,POSTDE    FORCE POST AT DEVICE END     @D51GDAP 00977000
         TM    CHQFLG1,CHQECKD    IS THIS A RETRY REQUEST      @D51GDAP 00978000
         BO    SIONECKD           YES, ASSUME AN ERROR         @D51GDAP 00979000
         TM    CHQCCBB2,CHNBIT    IS CHANNEL PROGRAM RETRYABLE @D51GDAP 00980000
         BO    SIONECKD           NO, DONT ALLOW CONVERSION    @D51GDAP 00981000
         ICM   RF,15,PBXCCW       GET ADDRESS INTERNAL CCW     @D52VDAP 00982000
         BZ    SIONECKD           NO, DONT ALLOW CONVERSION    @D52VDAP 00983000
         L     RD,AECKDCON        ADDRESS OF ECKD CONV. ROUTINE@D51EDAP 00984000
         BALR  RC,RD              EXECUTE CONVERSION ROUTINE   @D51EDAP 00985000
         L     RD,INITBASE        RESTORE SGCHED BASE ADDRESS  @D51EDAP 00986000
         AIF   (NOT &BGDEBUG).NMC030                           @D51GDAP 00987000
         L     RC,ECKDSIOT        TOTAL SIO COUNT              @D51GDAP 00988000
         LA    RC,1(,RC)          INCREMENT COUNTER            @D51GDAP 00989000
         ST    RC,ECKDSIOT        STORE NEW TOTAL COUNTER      @D51GDAP 00990000
         LTR   RF,RF              WAS CONVERSION SUCCESSFULL   @DA44117 00991000
         BNZ   SIONECKD           NO,                          @DA44117 00992000
         L     RC,ECKDSIOC        LOAD CONVERSION COUNTER      @D51GDAP 00993000
         LA    RC,1(,RC)          INCREMENT COUNTER            @D51GDAP 00994000
         ST    RC,ECKDSIOC        STORE NEW CONVERSION COUNTER @D51GDAP 00995000
         B     SIOYECKD                                        @D51GDAP 00996000
         DS    0F                                              @D51GDAP 00997000
         DC    CL16'ECKD NO OF SIOS='                          @D51GDAP 00998000
ECKDSIOT DC    AL4(0)             TOTAL NUMBER OF ECKD SIO     @D51GDAP 00999000
         DC    CL16'CONVERTED  SIOS='                          @D51GDAP 01000000
ECKDSIOC DC    AL4(0)             NUMBER OF CONVERTED SIOS     @D51GDAP 01001000
         AGO   .YMC030                                         @D51GDAP 01002000
.NMC030  ANOP                                                  @D51GDAP 01003000
         LTR   RF,RF              WAS CONVERSION SUCCESSFULL   @DA44136 01004000
         BNZ   SIONECKD           NO,                          @DA44136 01005000
.YMC030  ANOP                                                  @D51GDAP 01006000
SIOYECKD OI    CHQFLG1,CHQECKD    INDICATE VSE PREFIXED CCW    @D51GDAP 01007000
         L     RF,PBXCCW          GET ADDRESS OF PROTECT CCW   @D51EDAP 01008000
         ST    RF,CAW             SET UP CAW ACCORDINGLY       @D51EDAP 01009000
         B     SIOSTKEY                ======================> @D51EDAP 01010000
SIONECKD NI    CHQFLG1,XFF-CHQECKD INDICATE NOT CONVERTED      @D51EDAP 01011000
         TM    CHQPROC,CHQDASFP   SET FILE MASK NEEDED         @D35IDAP 01012000
         BO    SIOFPPRC           YES, ====================>>> @D35IDAP 01013000
         B     SIOSTCAW           NO,  ======================> @D35IDAP 01014000
AECKDCON DC    A(ECKDCONV)                                     @D61PDAP 01015000
         DROP  RE                 RELEASE PUBX BASE POINTER    @D41XXAP 01016000
         TITLE 'VSE SUPERVISOR     SGSCHED     FILE PROTECT PROCESSING' 01017000
.*                                                             @D359DAP 01018000
.* IF    (REQUEST EQ SUPERVISOR REQUEST   OR                   @D359DAP 01019000
.*        REQUEST NE DASD-REQUEST         OR                   @D359DAP 01020000
.*        REQUEST EQ ERP-REQUEST          OR                   @D359DAP 01021000
.*        WRITE ON SYSRES=YES             OR                   @D359DAP 01022000
.*        REQUEST EQ SEEK AND CC=OFF) THEN SKIP DASDFP         @D359DAP 01023000
.* ELSE                                                        @D359DAP 01024000
.*                                                             @D359DAP 01025000
.* EVERY DASD PROTECTED CHANNEL CORRESPONDS TO A STRING OF     @D359DAP 01026000
.* SEEK, SET FILE MASK, TIC TO THE USER CCW STRING.            @D359DAP 01027000
.* WHICH WILL BE ADDED IN FRONT OF THE 1. USER CCW             @D359DAP 01028000
.*                                                             @D359DAP 01029000
************************************************************** @D359DAP 01030000
*                                                            * @D359DAP 01031000
*        DASD FILE PROCESSING                                * @D359DAP 01032000
*                                                            * @D359DAP 01033000
************************************************************** @D359DAP 01034000
         SPACE 1                                               @D51EDAP 01035000
         USING PBXADR,RE          PUBX BASE POINTER            @D51EDAP 01036000
SIOFPPRC L     RF,PBXCCW          GET ADDRESS OF PROTECT CCW   @D51EDAP 01037000
         USING FPCCWADR,RF        FILE PROTECT CCW DSECT       @D14BDAP 01038000
         ST    RF,CAW             SET UP CAW ACCORDINGLY                01039000
         MVC   FPCCWSK,CCWTOT     MAKE USERS SEEK 1. CCW                01040000
         MVC   FPCCWSFM,SIOSFMCN  RESTORE SET FILE MASK CCW    @D51GDAP 01041000
         LA    R8,FPCCWMSK        ADDRESS OF FILE MASK         @D51GDAP 01042000
         STCM  R8,7,FPCCWSFM+1    RESTORE ADDRESS              @D51GDAP 01043000
         TM    CCWNEXT,TIC        IS SECOND CCW OF USER A TIC           01044000
         BNO   SIOFP010           NO                           @D14BDAP 01045000
         TM    CCWNEXT,X'0F'-TIC  SURE ITS A TIC COMMAND       @D14BDAP 01046000
         BZ    SIOFP030           YES                          @D14BDAP 01047000
         DROP  R9                 DROP CCW POINTER             @D35CDAP 01048000
         USING CCWADR,R7          REAL CCW BASE                @D35CDAP 01049000
SIOFP010 LA    R8,CCWNEXT         ADDRESS OF USERS SECOND CCW  @D14BDAP 01050000
         DROP  R7                 DROP REAL ADDRESS POINTER    @D35CDAP 01051000
         USING CCWADR,R9          VIRTUAL CCW BASE             @D35CDAP 01052000
SIOFP020 STCM  R8,M7,FPCCWTIC+1   TIC TO USER CCW              @D14BDAP 01053000
         MVC   FPCCWMSK(1),CCBSTA1 SET FILE PROTECTION MASK    @D14BDAP 01054000
         B     SIOSTKEY                ======================>          01055000
         SPACE 3                                                        01056000
SIOFP030 L     R8,CCWNEXT         POINT TO TIC CCW             @D14BDAP 01057000
         B     SIOFP020           STORE THIS ADDRESS           @D14BDAP 01058000
         DROP  RE                 RELEASE PUBX BASE POINTER    @D51GDAP 01059000
         TITLE 'VSE SUPERVISOR     SGSCHED    WRITE INHIBIT PROCESSING' 01061000
************************************************************** @DY45540 01062000
*                                                            * @DY45540 01063000
*        WRITE INHIBIT PROCESSING                            * @DY45540 01064000
*                                                            * @DY45540 01065000
************************************************************** @DY45540 01066000
         SPACE 1                                               @DY45540 01067000
         USING PBXADR,RE          PUBX BASE POINTER            @DY45540 01068000
SIORONLY DS    0H'0'              PREVENT WRITE ACCESS         @DY45540 01069000
         CLC   CHQTID,IORQ4SNS    IS THIS A SNS-TASK REQUEST   @D66ADAP 01070000
         BER   R8                 YES,                         @DY45540 01071000
         CLI   PUBDEVTY,TFBA      IS THIS AN FBA DEVICE        @DY45540 01072000
         BE    SIORO100           YES,                         @DY45540 01073000
         ICM   RF,15,PBXCCW       GET ADDRESS OF PROTECT CCW   @DY45540 01074000
         BZR   R8                 NONE ======================> @DY45540 01075000
         USING FPCCWADR,RF        FILE PROTECT CCW DSECT       @DY45540 01076000
         SLR   R9,R9              CLEAR REGISTER               @DY45540 01077000
         ICM   R9,7,CAW+1         GET CCW REAL ADDRESS         @DY45540 01078000
         CLM   RF,7,CAW+1         IS THIS THE FP-CHAIN ALREADY @DY45540 01079000
         BE    SIORO020           YES, THEN JUST FORCE WRT-INH @DY45540 01080000
         TM    CCBCLS,XCPR        USER TRANSLATED CCW'S        @DY45540 01081000
         BNO   SIORO000           NO, THEN R9 IS CORRECT       @DY45540 01082000
         LR    R5,RF              SAVE FPCCWADR BASE           @DY45540 01083000
         AMODESW CALL,ADDRESS=VIRTAD,REGS=R6                   @DY45540 01084000
*SGLINK  VIRTAD,INPUT=(R6,R9),OUTPUT=RF,WORK=R9                @DY45540 01085000
         L     R6,DISPAD          RESTORE DISPATCHER ADDRESS   @DY45540 01086000
         LTR   R9,RF              UPDATE VIRTUAL CCW POINTER   @DY45540 01087000
         BZ    ERR38              CCNL ====================>>> @DY45540 01088000
         LR    RF,R5              RESTORE FPCCWADR BASE        @DY45540 01089000
SIORO000 MVC   FPCCWSFM,SIOSFMCN  RESTORE SET FILE MASK CCW    @DY45540 01090000
         LA    R5,FPCCWMSK        ADDRESS OF FILE MASK BYTE    @DY45540 01091000
         STCM  R5,7,FPCCWSFM+1    SET ADDRESS IN FP-CCW        @DY45540 01092000
         STCM  R7,M7,FPCCWTIC+1   TIC TO USER CCW              @DY45540 01093000
SIORO020 OI    FPCCWMSK,X'40'     INHIBIT ALL WRITE OPERATIONS @DY45540 01094000
         NI    FPCCWMSK,XFF-X'80' INHIBIT ALL WRITE OPERATIONS @DY45540 01095000
         CLM   RF,7,CAW+1         IS THIS THE FP-CHAIN ALREADY @DY45540 01096000
         BE    SIORO040           YES,                         @DY45540 01097000
         LA    RF,FPCCWSFM        POINT TO SFM CCW             @DY45540 01098000
         DROP  RF                 RELEASE FPCCWADR BASE        @DY45540 01099000
SIORO040 STCM  RF,7,CAW+1         SET UP CAW ACCORDINGLY       @DY45540 01100000
         BR    R8                      ======================> @DY45540 01101000
         SPACE 1                                               @DY45540 01102000
SIORO100 DS    0H'0'              FBA DEVICE PROCESSING        @DY45540 01103000
         ST    R8,SIOROSAV        SAVE CALLING REGISTER        @DY45540 01104000
         TM    CCBCLS,XCPR        USER TRANSLATED CCW'S        @DY45540 01105000
         BNO   SIORO110           NO, THEN R9 IS CORRECT       @DY45540 01106000
         AMODESW CALL,ADDRESS=VIRTAD,REGS=R6                   @DY45540 01107000
*SGLINK  VIRTAD,INPUT=(R6,R9),OUTPUT=RF,WORK=R9                @DY45540 01108000
         L     R6,DISPAD          RESTORE DISPATCHER ADDRESS   @DY45540 01109000
         LTR   R9,RF              WAS ADDRESS VALID            @DY45540 01110000
         BZ    ERR38              NO,  ====================>>> @DY45540 01111000
SIORO110 CLI   CCWCODE,DEFEXNT    IS THIS A DEFINE EXTENT      @DY45540 01112000
         BNE   SIORO120           NO, LET IT GO                @DY45540 01113000
         LA    R8,CCWTOT          COPY CCW POINTER             @DY45540 01114000
         SLR   R0,R0              CLEAR OFFSET POINTER         @DY45540 01115000
         BAL   R7,GETDADR         CALCULATE VIRTUAL EQUIVALENT @DY45540 01116000
*SGLINK  GETDADR,INPUT=(R0,R6,R7,R8),OUTPUT=RF                 @DY45540 01117000
         LTR   R8,RF              WAS REAL ADDR VALID          @DY45540 01118000
         BZ    SIORO120           NO,                          @DY45540 01119000
.* WE BETTER SAVE THE ORIGINAL SETTING                         @DY45540 01120000
         NI    0(R8),X'7F'        INHIBIT WRITE                @DY45540 01121000
         OI    0(R8),X'40'        INHIBIT ALL WRITES           @DY45540 01122000
SIORO120 L     R8,SIOROSAV        SAVE CALLING REGISTER        @DY45540 01123000
         BR    R8                                              @DY45540 01124000
         SPACE 1                                               @DY45540 01125000
         DROP  RE                 RELEASE PUBX BASE POINTER    @DY45540 01126000
         SPACE 1                                               @DY45540 01127000
SIOROSAV DC    F'0'               R8 SAVE AREA                 @DY45540 01128000
         SPACE 1                                               @DY45540 01129000
SIOSFMCN DC    XL8'1F00000060000001' SET FILE MASK SKELETON    @D51GDAP 01130000
         TITLE 'VSE SUPERVISOR     SGSCHED     SYSTEM FILE PROCESSING ' 01131000
.* IT ENTERS HERE IF IT IS A SYSTEM FILE                       @D359DAP 01132000
.* IF JOB CONTROL OPENS I/O IS STARTED AS SOON AS POSSIBLE     @D359DAP 01133000
.* OTHERWISE IT IS CHECKED WITH HELP OF THE DIB ENTRY THAT     @D359DAP 01134000
.* THE CURRENT ADDRESS IS SMALLER THAN THE END ADDRESS         @D359DAP 01135000
.* OF THE EXTENT. FURTHER THE CCHH NUMBER GIVEN IN THE SEARCH  @D359DAP 01136000
.* COMMAND MUST CORRESPOND TO THE ONE IN THE DIB ENTRY         @D359DAP 01137000
.* FOR INPUT THE RECORD NUMBER IN THE SEARCH COMMAND MUST BE   @D359DAP 01138000
.* EQUAL TO THE ONE IN THE DIB ENTRY                           @D359DAP 01139000
.* FOR OUTPUT, THE COMMAND MUST BE WRITE COUNT KEY AND DATA    @D359DAP 01140000
.* AND THE CCHHRKDD MUST CORRESPOND TO THE ONE IN THE DIB.     @D359DAP 01141000
.* THE RECORD NUMBER OF THE SEARCH COMMAND MUST BE ONE LOWER   @D359DAP 01142000
.* THAN THE ONE GIVEN IN THE DIB ENTRY.                        @D359DAP 01143000
************************************************************** @D359DAP 01144000
*                                                            * @D359DAP 01145000
*        SYSFIL PROCESSING                                   * @D359DAP 01146000
*                                                            * @D359DAP 01147000
************************************************************** @D359DAP 01148000
         SPACE 3                                                        01149000
SIOSFPRC L     RF,CRADDR          PERTINENT COMREG ADDRESS              01150000
         USING COMREG,RF          DECLARE BASE                          01151000
         TM    JCSW1,JCOPEN       DID JOB CONTROL ISSUE OPEN            01152000
         BO    SIOSTCAW           YES, ======================>          01153000
         TM    PIBFLG2,JOBDUN     HAS EOJ BEEN POSTED          @D51IDAP 01154000
         BZ    SIOSF010           NO, BYPASS TEST FOR SYSIN             01155000
         CLI   CHQSLUB,SYSIPT     IS REQUEST FOR SYSIN         @D36IDAP 01156000
         BNH   ERR30              YES, ====================>>>          01157000
SIOSF010 BAL   R8,DIBENTRY        GET CORRECT DIB ENTRY ADDRESS         01158000
*SGLINK  DIBENTRY,INPUT=(R1,R8,RD,RF),OUTPUT=R5                @D369DAP 01159000
         USING DIB,R5             DECLARE ADDRESSABILITY                01160000
         DROP  RF                 RELEASE COMREG POINTER       @D35IDAP 01161000
         CLI   PUBDEVTY,T3540     TEST FOR 3540 DEVICE                  01162000
         BE    SIOSF100           YES, BRANCH TO 3540 ROUTINE           01163000
         CLC   CURAD(L7),ENDAD    ADDRESS WITHIN EXTENT                 01164000
         BH    ERR32              NO,  ====================>>>          01165000
         ST    R7,CAW             STORE CCW ADDRESS IN CAW              01166000
         LA    R8,CCWNEXT         LOAD ADDRESS OF SEARCH CCW            01167000
         TM    0(R8),SRCHRPS      IS IT A SEARCH ID COMMAND             01168000
         BO    SIOSF020           YES, CANT BE TIC OR SET SECT.         01169000
         LA    R8,8(R8)           SKIP TIC OR SET SECTOR                01170000
SIOSF020 BAL   R7,GETDADR         GET VIRT.ADDR.OF SEARCHFIELD          01171000
*SGLINK  GETDADR,INPUT=(R0,R6,R7,R8),OUTPUT=RF                 @D369DAP 01172000
         LTR   R8,RF              IS ADDRESS VALID                      01173000
         BZ    ERR32              NO,  ====================>>>          01174000
         LRA   RF,L4(RF)          LAST BYTE OF SEARCH IN STORGE         01175000
         BNZ   ERR32              NO,  ====================>>>          01176000
         MVC   SEARCHFL(L5),0(R8) GET USERS SEARCH ADDRESS     @D14BDAP 01177000
         CLI   CHQSLUB,SYSPCH     IS IT OUTPUT FILE            @D14BDAP 01178000
         BNL   SIOSF030           YES, SPECIAL PROCESSING      @D14BDAP 01179000
         CLC   SEARCHFL(L5),CURAD+2 USER CCHHR MATCHES DIB     @D14BDAP 01180000
         BNE   ERR32              NO,  ====================>>>          01181000
         B     SIOSTKEY                ======================> @D14BDFG 01182000
.*                                                                      01183000
.*       SYSFILE OUTPUT PROCESSING                                      01184000
.*                                                                      01185000
SIOSF030 IC    RF,RECNO           OBTAIN USERS RECORD NUMBER            01186000
         LA    RF,D1(RF)          UDATE RECORD NUMBER                   01187000
         STC   RF,RECNO           STORE UPDATED RECORD NUMBER           01188000
         CLC   SEARCHFL(L5),CURAD+D2  CHECK SEARCH ADDRESS              01189000
         BNE   ERR32                   ====================>>>          01190000
         LA    R8,24(R9)          GET THIRD CCW                         01191000
         CLI   0(R8),SETSECT      IS IT A SET SECTOR COMMAMND           01192000
         BE    SIOSF040                                                 01193000
         TM    0(R8),TIC          IS IT A TIC                  @D14BDAP 01194000
         BNO   SIOSF050           NO                           @D14BDAP 01195000
         TM    0(R8),X'0F'-TIC    SURE ITS A TIC COMMAND       @D14BDAP 01196000
         BNZ   SIOSF050           NO, ITS NOT A TIC            @D14BDAP 01197000
SIOSF040 LA    R8,8(R8)           SKIP TO GET TO WRITE COUNT            01198000
SIOSF050 BAL   R7,GETDADR         GET VIRTUAL ADDR.OF CNTFIELD          01199000
*SGLINK  GETDADR,INPUT=(R0,R6,R7,R8),OUTPUT=RF                 @D369DAP 01200000
         LTR   R8,RF              IS ADDRESS VALID                      01201000
         BZ    ERR32              NO,  ====================>>>          01202000
         LRA   RF,L7(RF)          IS LAST BYTE VALID                    01203000
         BNZ   ERR32              NO,  ====================>>>          01204000
         CLC   CURAD+D2(L8),0(R8) DOES CCHHRKDD MATCH WITH DIB          01205000
         BNE   ERR32              NO,  ====================>>>          01206000
         B     SIOSTKEY                ======================> @D35IDAP 01207000
         DROP  R9                 RELEASE CCW BASE             @DY45540 01208000
         SPACE                                                          01209000
************************************************************** @D359DAP 01210000
*                                                            * @D359DAP 01211000
*        SYSFIL PROCESSING    (3540 DISKETTE)                * @D359DAP 01212000
*                                                            * @D359DAP 01213000
************************************************************** @D359DAP 01214000
         SPACE 3                                                        01215000
SIOSF100 ST    R7,CAW             STORE CCW IN CAW                      01216000
         LR    R8,R7              POINT TO SEEK CCW                     01217000
SIOSF110 TM    4(R8),CC           IS THIS CCW CHAINED                   01218000
         BNO   SIOSTKEY           NO,  ======================>          01219000
         CLI   0(R8),SEEK         IS THIS A SEEK CCW                    01220000
         BE    SIOSF120           YES, CONTINUE                         01221000
         LA    R8,8(R8)           POINT TO NEXT CCW                     01222000
         B     SIOSF110           CONTINUE SEARCH FOR CCW               01223000
SIOSF120 CLC   CURAD+3(L4),ENDAD+3 DID WE REACH END ADDRESS             01224000
         BE    ERR32              YES, ====================>>>          01225000
         LR    R9,R7              SAVE POINTER TO CCW                   01226000
         BAL   R7,GETDADR         GET VERT ADDR OF SEEK ADDR            01227000
*SGLINK  GETDADR,INPUT=(R0,R6,R7,R8),OUTPUT=RF                 @D369DAP 01228000
         LTR   R8,RF              IS ADDRESS VALID                      01229000
         BZ    ERR32              NO,  ====================>>>          01230000
         LRA   RF,4(RF)           IS LAST BYTE VLAID                    01231000
         BNZ   ERR32              NO,  ====================>>>          01232000
         MVC   SEARCHFL+1(L4),0(R8) MOVE SEEK ARGUMENT                  01233000
         CLC   SEARCHFL+1(L4),CURAD+3 SEEK AND DIB EQUAL                01234000
         BNE   ERR32              NO,  ====================>>>          01235000
         B     SIOSTKEY                ======================> @D35IDAP 01236000
         DROP  R5                 RELEASE DIB POINTER          @D36IDAP 01237000
         TITLE 'VSE SUPERVISOR     SGSCHED     CALCULATE DIB ADDRESS  ' 01238000
************************************************************** @D359DAP 01239000
*                                                            * @D359DAP 01240000
*        ALLOCATE DIB-ENTRY                                  * @D359DAP 01241000
*                                                            * @D359DAP 01242000
************************************************************** @D359DAP 01243000
         SPACE 3                                                        01244000
DIBENTRY EQU   *                                                        01245000
         USING COMREG,RF                                                01246000
         L     R5,PCBPTR          GET PCB ADDRESS              @DIB     01247000
         USING PCBADR,R5          PCB BASE POINTER             @DIB     01248000
         L     R5,PCEADIB         GET DIB ADDRESS              @DIB     01249000
         DROP  R5                 RELEASE DIB BASE             @DIB     01250000
*        LH    R5,DIBPT           GET ADDRESS OF DIBTABLE      @DIB     01251000
         LA    R5,DIBLGT(R5)      POINT TO SYSIN DIB ENTRY     @D14CDAP 01252000
         CLI   CCBLNO,SYSPCH      WHICH FILE IS IT             @D14CDAP 01253000
         BLR   R8                 IN   =====================>> @D14CDAP 01254000
         LA    R5,DIBLGT(R5)      POINT TO SYSPCH DIB ENTRY    @D14CDAP 01255000
         BER   R8                 PCH  =====================>> @D14CDAP 01256000
DIBELST  LA    R5,DIBLGT(R5)      POINT TO SYSLST DIB ENTRY    @D14CDAP 01257000
         BR    R8                 LST  =====================>> @D14CDAP 01258000
         DROP  RF                 RELEASE COMREG BASE          @D149DAP 01259000
         TITLE 'VSE SUPERVISOR     SGSCHED     TAPE I/O PRE-PROCESSING' 01260000
************************************************************** @D359DAP 01261000
*                                                            * @D359DAP 01262000
*        SPECIAL TAPE PROCESSING                             * @D359DAP 01263000
*                                                            * @D359DAP 01264000
************************************************************** @D359DAP 01265000
         SPACE 3                                                        01266000
         USING PUB2ADR,R8         DECLARE BASE FOR PUB2        @D35IDAP 01267000
         USING CCWADR,R9          VIRTUAL CCW BASE             @DY45817 01268000
SIOTAPPR DS    0H'0'                                           @D35IDAP 01269000
         CLI   PUBDEVTY,TTPA      IS THIS A TPA DEVICE         @D62NDAP 01270000
         BNE   SIOTAP00           NO,                          @D62NDAP 01271000
         OI    CHQCCBB1,POSTDE    FORCE POST AT DEVICE END     @D62NDAP 01272000
.*                                                                      01273000
.*       CHECK IF WE NEED TO INTERCEPT THIS I/O OPERATION               01274000
.*                                                                      01275000
SIOTAP00 CLI   CCWCODE,NOP        IS THIS A NOP COMMAND        @DY45817 01276000
         BE    SIOTAP05           YES, TEST FOR CHAINING       @DY45817 01277000
         CLI   CCWCODE,SNS        IS THIS A SENSE COMMAND      @DY45817 01278000
         BNE   SIOTAP10           NO, WE NEED TO INTERCEPT     @DY45817 01279000
SIOTAP05 TM    CCWCHAIN,DC+CC     ANY CHAINING                 @DY45817 01280000
         BZ    SIOSTCAW           NO,  ======================> @DY45817 01281000
         TM    CCWCHAIN+8,DC+CC   NEXT COMMAND ALSO CHAINED    @DY45817 01282000
         BNZ   SIOTAP10           YES, WE NEED TO INTERCEPT    @DY45817 01283000
         CLI   CCWCODE+8,NOP      IS NEXT A NOP COMMAND        @DY45817 01284000
         BE    SIOSTCAW           YES, ======================> @DY45817 01285000
         CLI   CCWCODE+8,SNS      IS NEXT A SENSE COMMAND      @DY45817 01286000
         BE    SIOSTCAW           YES, ======================> @DY45817 01287000
SIOTAP10 LR    RB,R3              COPY PUB POINTER             @D21IDAP 01288000
         SH    RB,YPUBTAB         OFFSET IN PUB TABLE          @D21IDAP 01289000
         SRL   RB,PUBSLEN-PBXISLEN DIVIDE BY TWO               @D51ODGL 01290000
         A     RB,APBXAREA        ADDRESS OF PUBX-ADDRESS      @D21IDAP 01291000
         L     RB,0(RB)           ADDRESS OF PUBX              @D21IDAP 01292000
         USING PBXADR,RB          PUBX BASE POINTER            @D21IDAP 01293000
         ICM   RF,15,PBXCCW       PREFIX CCWS ALLOCATED        @D21IDAP 01294000
         BZ    SIOSTCAW           NO,  ======================> @D21IDAP 01295000
         USING SMCCWADR,RF        PREFIX CCW BASE POINTER      @D21IDAP 01296000
         OI    SMCCWSET+4,CC      SET COMMAND CHAINING BIT     @D21LDAP 01297000
         NI    PBXABYT,X'EF'      RESET BIT FOR NOW            @DY45383 01298000
         IC    RE,PBXACMD         GET SET-MODE-CMD DATA BYTE   @D21CDOW 01299000
         TM    PBXFLAG1,PBXDBCCW  DOES SET MODE NEED DATA      @D21FDAP 01300000
         BO    SIOTAP15           YES,                         @D21FDAP 01301000
         IC    RE,PUBOPTN         GET SET-MODE-CMD CODE        @D21CDOW 01302000
SIOTAP15 CLC   CHQTID,IORQ4SVT    SERVICE TASK REQUEST         @D66ADAP 01303000
         BE    SIOSTCAW           YES, ======================> @DA44201 01304000
         TM    PBXFLAG2,PBXREADY+PBXNOVOL SVT-TASK NEEDED 1ST  @DA44201 01305000
         BNZ   SIOTAP90           YES, SPECIAL PROCESSING      @DA44201 01306000
         TM    PBXFLAG3,PBXASINT  ASSIGN WAS OK?               @DY46592 01306200
         BZ    SIOTAP20           YES,                         @DY46592 01306400
         OI    PBXFLAG2,PBXNOVOL  INTERCEPT NEXT IO            @DY46592 01306600
         NI    PBXFLAG3,XFF-PBXASINT    RESET INDICATOR        @DY46592 01306800
SIOTAP20 TM    P2TFLG1,P2TECPT+P2TERP ERP-TASK INVOKATION      @DA44201 01307000
         BZ    SIOTAP40           NO, NORMAL USER REQUEST               01308000
         TM    P2TFLG1,P2TECPT    ERP WANTS TO INTERCEPT                01309000
         BNO   SIOTAP25           NO, ITS AN ERP REQUEST                01310000
.*                                                                      01311000
.*       SET UP ERROR ENTRY TO INDICATE EXCEPTIONAL CONDITION           01312000
.*                                                                      01313000
         L     R9,AINTER          SET BASE FOR I/O INTERRUPT            01314000
         USING INTRTN,R9          RESTORE IOINTEWR BASE                 01315000
         MVC   DEVSTA(L2),NOTOP   SET UP INDICATOR FOR ERP              01316000
         STH   R2,CHNADR          PROVIDE CORRECT I/O ADDRESS  @D35IDAP 01317000
         B     INTTRANS                =====================>>          01318000
         DROP  R9                 RELEASE IOINTER BASE         @D35IDAP 01319000
.*                                                                      01320000
.*       ERP IN PROGRESS BUT NO EXCEPTIONAL CONDITION                   01321000
.*                                                                      01322000
         USING CCWADR,R9          VIRTUAL CCW BASE             @D35CDAP 01323000
SIOTAP25 CLC   CHQTID,IORQ4RAS    RAS RETRY REQUEST            @D66ADAP 01324000
         BE    SIOTAP40           YES, RAS OVERRULES ERP                01325000
         NI    CCBCOM1,CLRCOM1    CLEAR CHAN. SCHED. BITS               01326000
         NI    CCBCOM2,CLRCOM2    IN USER CCB                           01327000
         MVI   CCBSTA1,ZERO       CLEAR DEVICE STATUS IN CCB            01328000
         MVI   CCBSTA2,ZERO       CLEAR CHANNEL STATUS IN CCB           01329000
         TM    P2TFLG1,P2TREST    ERP REQUESTED RESTART                 01330000
         BO    SIOTAP40           YES, RETRY USERS REQUEST NOW @D62TAAP 01331000
.*                                                                      01332000
.*       SET UP ERP RESTART CHAIN                                       01333000
.*                                                                      01334000
         STC   RE,SMCCWSET        UPDATE OPCODE IN SM-CCW      @D21IDAP 01335000
         ST    R7,SMCCWERP        SET TIC TO USER STRING       @D14BDAP 01336000
         MVI   SMCCWERP,TIC       RESTORE TIC COMMAND CODE     @D14BDAP 01337000
         TM    P2TFLG1,P2TREPO+P2TROR REPOSITIONING REQUEST             01338000
         BZ    SIOTAP30           NO,DON'T COPY ERP CCW                 01339000
         MVC   SMCCWERP,P2TWORKA  COPY ERP CCW                 @D14BDAP 01340000
SIOTAP30 LA    RE,P2ORGTIE        POINT TO ORIGINAL TIE BYTE            01341000
         TM    P2TFLG1,P2TIEORG   ORIGINAL TIE FLAG ON                  01342000
         BO    SIOTAP35           YES THEN ADDRESS IS CORRECT           01343000
         LA    RE,1(RE)           NO,  POINT TO OPPOSITE TIE            01344000
SIOTAP35 ST    RE,SMCCWTI         STORE TIE ADDRESS IN CCW2    @D14BDAP 01345000
         MVI   SMCCWTI,TIE        SET UP TIE COMMAND           @D14BDAP 01346000
         TM    SMCCWERP,CONTROL   SOME TYPE OF CONTROL COMMAND @D14BDAP 01347000
         BNO   SIOTAP75           NO, CONTINUE                          01348000
         MVI   SMCCWTI,NOP        NOP TIE COMMAND              @D14BDAP 01349000
         B     SIOTAP75           GO SET UP MODE CCW AND EXIT           01350000
         SPACE 2                                                        01351000
.*                                                                      01352000
.*       HANDLE UNLOAD=REWIND PROCESSING IF ACTIVE                      01353000
.*                                                                      01354000
SIOTAP40 DS    0H                 CHECK FOR UNL=REW OPTION     @DAOM053 01355000
         TM    PBXTFLG1,PBXTNUNL  USER WANTS UNL=REW FOR DEVICE@DAOM053 01356000
         BO    SIOTAREW           YES, CHECK COMMAND           @DAOM053 01357000
         TM    SYSFLAG2,IJBNOUNL  USER REQUESTS UNL=REW        @D21LDAP 01358000
         BZ    SIOTAP50           NO, PROCEED NORMAL           @D21LDAP 01359000
SIOTAREW CLI   CCWCODE,X'0F'      IS THIS AN UNLOAD            @D21LDAP 01360000
         BE    SIOTAP45           YES,                         @D21LDAP 01361000
         TM    CCWCHAIN,DC        IS THIS DATA CHAINING CCW    @D21LDAP 01362000
         BO    SIOTAP50           YES,                         @D21LDAP 01363000
         TM    CCWCHAIN,CC        IS THIS COMMAND CHAINING     @D21LDAP 01364000
         BZ    SIOTAP50           NO,                          @D21LDAP 01365000
         CLI   CCWCODE+8,X'0F'    IS NEXT COMMAND AN UNLOAD    @D21LDAP 01366000
         BNE   SIOTAP50           NO,                          @D21LDAP 01367000
         CLI   CCWCODE,X'03'      IS FIRST COMMAND A NOOP      @D21LDAP 01368000
         BE    SIOTAP45           YES, FORCE REWIND            @D21LDAP 01369000
         CLM   RE,1,CCWCODE       IS 1ST COMAND A SET-MODE     @D21LDAP 01370000
         BNE   SIOTAP50           NO,                          @D21LDAP 01371000
SIOTAP45 MVI   SMCCWSET,REWIND    MAKE IT A REWIND COMMAND     @D21LDAP 01372000
         NI    SMCCWSET+4,XFF-CC  RESET COMMAND CHAINING BIT   @D21LDAP 01373000
         B     SIOTAP75           GET REWIND EXECUTED INSTEAD  @D21LDAP 01374000
.*                                                                      01375000
.*       HANDLE MODE SET PROCESSING                                     01376000
.*                                                                      01377000
         SPACE 2                                                        01378000
SIOTAP50 TM    CCBBY3,X'08'       LABEL PROCESSING ONGOING     @D62TAAP 01379000
         BO    SIOTAP80           YES, SKIP MODE SETTING       @D62TAAP 01380000
         CLC   CHQTID,IORQ4AR     IS THIS SYSTEM TASK REQUEST  @D66ADAP 01381000
         BL    SIOTAP80           YES, SKIP MODE SETTING       @D62TAAP 01382000
         AIF   (&VSE280).Y280060                                        01383000
         CLI   PUBDEVTY,T9347     IS THIS A 9347 DEVICE        @DA36437 01384000
         BNE   SIOTAP55           NO, ISSUE THE MODESET        @DA36437 01385000
         CLM   RE,1,SMCCWSET      HAS MODE BEEN CHANGED        @D21IDAP 01386000
         BE    SIOSTCAW           NO,  ======================> @D21IDAP 01387000
SIOTAP55 DS    0H'0'                                           @DA36437 01388000
.Y280060 ANOP                                                           01389000
         TM    CCWCODE,X'0B'      IS THIS SOME KIND OF SENSE   @DA36437 01390000
         BNZ   SIOTAP65           NO,                          @D62TAAP 01391000
         CLI   CCWCODE,X'24'      IS THIS A READ BUFFERED LOG  @DY45383 01392000
         BNE   SIOTAP60           NO,                          @DY45383 01393000
         OI    PBXABYT,X'10'      PREVENT RBL TO BE RESET      @DY45383 01394000
         B     SIOTAP65           JOIN MAIN PATH               @DY45383 01395000
SIOTAP60 TM    CCWCHAIN,DC+CC     ANY CHAINING                 @D62TAAP 01396000
         BZ    SIOSTCAW           NO,  ======================> @DA21155 01397000
SIOTAP65 CLR   R7,RF              WAS SET MODE CHAINED         @D14BDAP 01398000
         BE    SIOSTCAW           YES, ======================> @DA21155 01399000
         STC   RE,SMCCWSET        UPDATE OPCODE IN SM-CCW      @D21LDAP 01400000
         CLI   PUBDEVTY,TTPA      IS THIS A TPA  DEVICE        @DA44172 01401000
         BE    SIOTPA10           YES SPECIAL PROCESSING       @PTF     01402000
SIOTAP70 ST    R7,SMCCWTI         TIC TO USER STRING           @D14BDAP 01403000
         MVI   SMCCWTI,TIC        RESTORE TIC COMMAND CODE     @D14BDAP 01404000
SIOTAP75 LA    R7,0(,RF)          MODIFY CCW START ADDRESS     @D21CDOW 01405000
         B     SIOSTCAW                ======================> @DA21155 01406000
         SPACE 2                                               @D62TAAP 01407000
SIOTAP80 TM    CHQGRP,CHQGRINT    CAW SUPPLIED BY ERP          @D62TAAP 01408000
         BZ    SIOSTCAW           NO,  ======================> @D62TAAP 01409000
         L     R7,CHQCAW          GET RETRY CCW ADDRESS (REAL) @D62TAAP 01410000
         LA    R7,0(,R7)          CLEAR HIGH ORDER BYTE        @DY45383 01411000
         CLM   RE,1,CCWCODE       IS 1ST COMAND A SET-MODE     @D21LDAP 01412000
         BNE   SIOTAP85           NO,                          @D21LDAP 01413000
         MVC   SMCCWSET(8),CCWCODE MOVE THE SET MODE CCW       @D62TDAP 01414000
         B     SIOTAP65                                        @D62TDAP 01415000
SIOTAP85 LR    R9,R7              ASSUME VIRTUAL=REAL          @D62TAAP 01416000
         TM    CCBCLS,XCPR        USER TRANSLATED CCW'S        @D62TAAP 01417000
         BNO   SIOSTCAW           NO,  ======================> @D62TAAP 01418000
         AMODESW CALL,ADDRESS=VIRTAD,REGS=R6                   @D62TAAP 01419000
*SGLINK  VIRTAD,INPUT=(R6,R9),OUTPUT=RF,WORK=R9                @D62TAAP 01420000
         LTR   R9,RF              UPDATE VIRTUAL CCW POINTER   @D62TAAP 01421000
         BNZ   SIOSTCAW                ======================> @D62TAAP 01422000
         B     ERR38              ERR  ====================>>> @D62TAAP 01423000
         SPACE 2                                                        01424000
.*                                                                      01425000
.*       SVT-TASK NEEDS TO BE INVOKED                                   01426000
.*                                                                      01427000
.*       AN ERP COMMAND (ROD PROCESSING) COULD HAVE INITIATED           01428000
.*       THE FIRST I/O OPERATION AND WAS THUS QUEUED AHEAD OF           01429000
.*       THE SERVICE TASK REQUEST. SO WE HAVE TO LET IT GO 1ST          01430000
SIOTAP90 CLC   CHQTID,IORQ4SVT    PRIVILEGED SYSTEM TASK       @D66ADAP 01431000
         BL    SIOTAP20           YES, LET IT GO               @DA44201 01432000
         CLC   CHQTID,IORQ4AR     IS THIS AR TASK              @D280DR8 01433000
         BNE   SIOTAP95           NO, SVT COMES FIRST          @D280DR8 01434000
         CLI   CCWCODE,X'22'      IS THIS A READ BLOCK         @DAOM114 01435000
         BE    SIOTAP20           YES, LET IT GO               @DA44547 01436000
         CLI   CCWCODE,X'34'      IS THIS A SNPID COMMAND      @DA44841 01437000
         BE    SIOTAP20           YES, LET IT GO               @DA44841 01438000
         CLI   CCWCODE,X'AF'      IS THIS AN UNGROUP COMMAND   @DA44841 01439000
         BE    SIOTAP20           YES, LET IT GO               @DA44841 01440000
SIOTAP95 L     R9,AINTER          SET BASE FOR I/O INTERRUPT   @D21LDAP 01441000
         TM    PBXFLAG2,PBXREADY  READY PROCESSING ONGOING     @D21LDAP 01442000
         BZ    CSWSERAC           NO, ACTIVATE SERVICE TASK    @DA44277 01443000
         B     SIOTSTHQ           ENSURE REQUEUING OF REQUEST  @DA44277 01444000
         SPACE 2                                                        01445000
SIOTPA10 DS    0H'0'              SPECIAL TPA PROCESSING       @PTF     01446000
         OI    PBXABYT,X'10'      INHIBIT SUPVR COMMANDS       @PTF     01447000
         TM    IJBAIDID,X'40'     WTM=NOSYNC WRITE BUFFERED TM @PTF     01448000
         BZ    SIOTAP70           NO, WTM=SYNC                 @PTF     01449000
         TM    PBXABYT,X'20'      BUFFERED WRITE AT ALL        @PTF     01450000
         BO    SIOTAP70           NO, WRITE IMMEDIATE REQUEST  @PTF     01451000
         CLI   CCWCODE,WTM        IS FIRST COMMAND A WRITE TM  @PTF     01453000
         BNE   SIOTAP70           NO,                          @PTF     01454000
SIOTPA20 DS    0H'0'              MODIFY SET-MODE CCW CHAIN    @PTF     01455000
         MVC   SMCCWTI(24),WMRKPARM MAKE TIC A WRITE MARK CCW  @PTF     01456000
         MVC   SMCCWTI+4(1),CCWCHAIN SAVE CHAINING FLAG        @PTF     01457000
         LA    R0,SMCCWNOP        GET ADDRESS OF  NOP CCW      @PTF     01458000
         STCM  R0,7,SMCCWTI+1     SET PARM ADDRESS             @PTF     01459000
         LA    R7,8(,R7)          NEXT CCW ADDRESS             @PTF     01460000
         ST    R7,SMCCWERP        ENSURE TIC TO USER CHAIN     @PTF     01461000
         MVI   SMCCWERP,TIC       MAKE IT A TIC CCW            @PTF     01462000
         LA    R7,0(,RF)          MODIFY CCW START ADDRESS     @PTF     01463000
         B     SIOSTCAW                ======================> @PTF     01464000
WMRKPARM DC    3D'0'              ALIGN ON DW-BOUNDARY         @PTF     01465000
         ORG   WMRKPARM           OVERLAY                      @PTF     01466000
         CCW   X'4B',0,32,8       WRITE MARK CCW               @PTF     01467000
         CCW   TIC,0,0,0          TIC TO USERS CHAIN           @PTF     01468000
         DC    XL8'0120000102000000' WRITE MARK (TAPE MARK)    @PTF     01469000
         ORG   ,                  END OF OVERLAY               @PTF     01470000
         DROP  R8                 RELEASE PUB2 BASE            @D61NDAP 01471000
         DROP  R9                 RELEASE IOINTER BASE         @DA44471 01472000
         DROP  RF                 RELEASE SMCCW BASE POINTER   @D14BDAP 01473000
         DROP  RB                 RELEASE PUBX BASE POINTER    @D14BDAP 01474000
         TITLE 'VSE SUPERVISOR     SGSCHED     UNSUPPORTED DEVICE CODE' 01475000
************************************************************** @D21WDAP 01476000
*                                                            * @D21WDAP 01477000
*        SIO INTERCEPT PROCESSING                            * @D61CDAP 01478000
*                                                            * @D21WDAP 01479000
************************************************************** @D21WDAP 01480000
         SPACE 3                                                        01481000
         USING PUB2ADR,R8         DECLARE BASE FOR PUB2        @D21WDAP 01482000
SIODOMID DC    CL4'DOM'           ID TO IDENTIFY DOM REQUEST   @D61NDAP 01483000
SIOTOERP DS    0H'0'                                           @D21WDAP 01484000
         CLC   CHQTID,IORQ4ERP    IS THIS ERP REQUEST          @D66ADAP 01485000
         BE    SIOPRE00           YES, ======================> @D61CDAP 01486000
         LR    RF,R8              SAVE PUB2 POINTER            @DA43585 01487000
         L     R9,AINTER          SET BASE FOR I/O INTERRUPT   @D21WDAP 01488000
         USING INTRTN,R9          RESTORE IOINTEWR BASE        @D21WDAP 01489000
         XC    CSW(8),CSW         INDICATE SIO INTERCEPT       @D21WDAP 01490000
         STH   R2,CHNADR          PROVIDE CORRECT I/O ADDRESS  @D21WDAP 01491000
         BAL   RE,GETPUBX         ADDRESS OF PUBX              @D21WDAP 01492000
*SGLINK  GETPUBX,INPUT(R3,R9,RE),OUTPUT=R2                     @D21WDAP 01493000
         USING PBXADR,R2          PUBX BASE POINTER            @D21WDAP 01494000
         L     R2,PBXERBLK        ADDRESS OF DEVICE ERR. ENRTY @D21WDAP 01495000
         USING ERBLKADR,R2        ERROR ENTRY BASE POINTER     @D21WDAP 01496000
         MVC   SIOUNSV1(ERRQCSW-ERRQLSNS),ERRQLSNS SAVE PART1  @D21WDAP 01497000
         MVC   SIOUNSV2(ERRQSNSM),ERRQSNS SAVE SENSE BYTES     @D21WDAP 01498000
         L     RD,AINTEQS         I/O ERROR ROUTINE ADDRESS    @D21WDAP 01499000
         USING INTEQSET,RD        I/O ERROR ROUTINE BASE       @D21WDAP 01500000
         BAL   R7,INTEQSET        GET AND FILL ERROR ENTRY     @D21WDAP 01501000
*SGLINK  INTEQSET,INPUT=(R1,R3,R4,R6,R7,R9,RD)                         *01502000
               WORK=(R8,RE),OUTPUT=(R2,R5)                     @D61NDAP 01503000
         DROP  R8                 RELEASE PUB2 BASE POINTER    @D61NDAP 01504000
         ST    R4,ERRQCHQA        SAVE CHANQ ENTRY ADDRESS     @DA40954 01505000
         L     RD,INITBASE        RESTORE SGSCHED BASE ADDRESS @D21WDAP 01506000
         USING SGSCHED,RD         SGSCHED BASE POINTER         @D21WDAP 01507000
         TM    P2FLAGS-PUB2ADR(RF),P2DOMSV IS THIS A DOM       @D61NDAP 01508000
         BZ    SIOERP20           NO,                          @D61NDAP 01509000
         TM    P2FLAGS-PUB2ADR(RF),P2NOSIO+P2DOMSV ERP WANTS IT@D61NDAP 01510000
         BO    SIOERP20           YES,                         @D61NDAP 01511000
         MVC   ERRQCSW+1(3),SIODOMID INDICATE DOM REQUEST      @D61NDAP 01512000
         NI    PUBCSFLG,XFF-QEDERR RESET GATING BITS           @D61NDAP 01513000
SIOERP20 NI    P2FLAGS-PUB2ADR(RF),XFF-P2DOMSV-P2NOSIO         @DA43585 01514000
         AIF   (&AG1 LE 254).LOD0020                           @D51ODGL 01515000
         LA    R1,0(,R1)          CLEAR HIGH ORDER BYTE        @D51ODGL 01516000
.LOD0020 AIF   (&AG1 GT 254).LOD0021                           @D51ODGL 01517000
         ICM   R1,8,PUBCHQPT      GET CHANNEL QUEUE POINTER    @D21WDAP 01518000
.LOD0021 ANOP                                                  @D51ODGL 01519000
         ST    R1,ERRQCCB+(ERRQCQPT-ERRQCCB) PROVIDE CHQPT+CCB @D21WDAP 01520000
         STCM  R4,7,ERRQCHQA+1    SAVE CHANQ ADDRESS           @DA40954 01521000
         MVI   ERRQFLG,RTYERR+OCCUP INDICATE RETRY IS POSSIBLE @D21WDAP 01522000
         MVC   ERRQLSNS(ERRQCSW-ERRQLSNS),SIOUNSV1 RESTORE     @D21WDAP 01523000
         SLR   RE,RE              CLEAR REGISTER               @D21WDAP 01524000
         IC    RE,ERBLKSNL        NUMBER OF SENSE BYTES        @D21WDAP 01525000
         BCTR  RE,0               ADJUST FOR EXECUTE           @D21WDAP 01526000
         EX    RE,SIOUNSEX        MOVE SENSE DATA TO ERR. BLOCK@D21WDAP 01527000
         B     INTEEXIT                =====================>> @D62TAAP 01528000
         SPACE 1                                                        01529000
SIOUNSEX MVC   ERRQSNS(0),SIOUNSV2 RESTORE SENSE BYTES         @D21WDAP 01530000
SIOUNSV1 DC    XL(ERRQCSW-ERRQLSNS)'00' SAVED PROCESSING INFO  @D21WDAP 01531000
SIOUNSV2 DC    XL(ERRQSNSM)'00'   SAVED SENSE DATA             @D21WDAP 01532000
         SPACE 1                                                        01533000
         DROP  R2                 RELEASE ERROR ENTRY BASE     @D21WDAP 01534000
         DROP  R9                 RELEASE IOINTER BASE         @D21WDAP 01535000
         TITLE 'VSE SUPERVISOR     SGSCHED   CONSOLE INTERCEPT ROUTINE' 01536000
************************************************************** @D359DAP 01537000
*                                                            * @D359DAP 01538000
*        CONSOLE INTERCEPT ROUTINE                           * @D359DAP 01539000
*                                                            * @D359DAP 01540000
************************************************************** @D359DAP 01541000
         SPACE 3                                                        01542000
SIOCONS  CLC   CHQTID,IORQ4SNS    IS THIS A SENSE TASK REQUEST @D66ADAP 01543000
         BE    SIOXRETN           YES,                         @D61CDAP 01544000
         L     R8,SIOXCEPT        LOAD BASE REGISTER           @D21LDAP 01545000
         BALR  R5,R8              PROVIDE FOR INTERCEPTION     @D21LDAP 01546000
SIOXRETN TM    IJBOPMOD,IJBOPDIS  IS CONSOLE DISCONNECTED      @DA40677 01547000
         BZ    SIO                NO,                          @D14BDAP 01548000
         AIF   (NOT &VSE280).N280140                           @DSCSI   01549000
         XC    CSW(8),CSW         CLEAR CSW                    @DSCSI   01550000
.N280140 ANOP                                                  @DSCSI   01551000
         MVI   DEVSTA,CHANEND+DEVEND CHANNEL+DEVICE END        @D14BDAP 01552000
         MVI   CHNSTA,ZERO        CLEAN CHANNEL STATUS         @D14BDAP 01553000
         MVI   IOINF+1,XFF        INDICATE SIMULATED INTERRUPT @D31YDAP 01554000
         CLI   *,XFF              SET CONDITION CODE CC=01     @D52VDAP 01555000
         MC    $TRSIO2,$MCSDAID   ALLOW SDAIDS TO INTERCEPT    @D52VDAP 01556000
         DEBUG SIOFLDS,XXDBGMC    PROVIDE FOR DEBUG ENTRY      @D61POAP 01557000
         L     R9,AINTER          IOINTER BASE ADDRESS         @D52VDAP 01558000
         B     CSWSTORD                ======================> @D51GDAP 01559000
SIOXCEPT DC    A(SIOXRETN)        INTERCEPT ADDRESS            @D21LDAP 01560000
         TITLE 'VSE SUPERVISOR     SGSCHED     SMF TIME MEASURING     ' 01560030
SMFENQCMP  DS    0H'0'            COMPLETE ENQUEUING TIME      @DAOM085 01560060
           TM    IJBMBADR,X'80'   IS MEASURING ACTIVE          @DAOM085 01560090
           BZ    SMFENQXIT        NO,                          @DAOM085 01560120
           STM   R0,R5,SMFENQSAV  SAVE REGISTER CONTENTS       @DAOM085 01560150
           L     R5,ASMFENQM31    GET 31-BIT ADDRESS           @DAOM085 01560180
           BASSM 0,R5             GET INTO 31-BIT MODE         @DAOM085 01560210
ASMFENQM31 DC    A(SMFENQ020+X'80000000')                      @DAOM085 01560240
SMFENQ020  LR    R5,R3            COPY PUB POINTER             @DAOM085 01560270
           SH    R5,YPUBTAB       OFFSET IN PUB TABLE          @DAOM085 01560300
           LA    R5,8(,R5)        ACCOUNT FOR UNUSED ENTRY     @DAOM085 01560330
           SLL   R5,2             MEASUREMENT BLOCK OFFSET     @DAOM085 01560360
           A     R5,IJBMBADR      MEASUREMENT BLOCK ADDRESS    @DAOM085 01560390
*          USING SMFBLOCK,R5      SMF- BLOCK ADDRESS           @DAOM085 01560420
           L     R2,IJBVSEMB      VSE BUFFER OFFSET            @DAOM085 01560450
           LA    R2,0(R2,R5)      VSE MB-ENTRY ADDRESS         @DAOM085 01560480
.*         ENSURE VSE PENDING TIME TO BE ACCOUNTED RIGHT NOW   @DAOM085 01560510
           STCK  X'D8'            GET TIME STAMP               @DAOM085 01560540
           ICM   R1,15,X'DA'      GET RESOLUTION BYTES         @DAOM085 01560570
           SRL   R1,3             ADJUST TO 128 USEC RESOLUTION@DAOM085 01560600
*          DROP  R5               RELEASE SMF ENTRY BASE       @DAOM085 01560630
           ICM   R5,15,CHQCCBB3+1 GET VSE QUEUING TIME         @DAOM085 01560660
           ST    R1,CHQCCBB3+1    STORE START PENDING TIME     @DAOM085 01560690
           BZ    SMFENQ040        NO QUEUING TIME PRESENT      @DAOM085 01560720
           SLR   R1,R5            TIME DIFFERENCE              @DAOM085 01560750
           AL    R1,8(,R2)        ADD ACCUMULATED PENDING TIME @DAOM085 01560780
           ST    R1,8(,R2)        NEW VSE PENDING TIME         @DAOM085 01560810
SMFENQ040  LM    R0,R5,SMFENQSAV  RESTORE MY GENERAL REGISTERS @DAOM085 01560840
SMFENQXIT  BSM   0,RE             RETURN TO CALLER             @DAOM085 01560870
           SPACE 1                                             @DAOM085 01560900
SMFENQSAV  DC    6F'0'            SAVE AREA                    @DAOM085 01560930
         TITLE 'VSE SUPERVISOR     SGSCHED     SIO ACCOUNTING ROUTINE ' 01561000
************************************************************** @D359DAP 01562000
*                                                            * @D359DAP 01563000
*        UPDATE SIO ACCOUNTING INFORMATION                   * @D359DAP 01564000
*                                                            * @D359DAP 01565000
************************************************************** @D359DAP 01566000
         SPACE 3                                                        01567000
SIOJACC  DS    0H'0'                                           @D35IDAP 01568000
         TM    CHQFLG1,CHQDIDJA   WAS SIO ALREADY COUNTED      @D52VDAP 01569000
         BOR   R7                 YES, ======================> @D52VDAP 01570000
         STM   R7,R9,ACCTSVRG     SAVE REGISTERS               @D51GDAP 01571000
         L     R9,PIBPTR2         GET PIB2PTR (SERVICE OWNER)  @DA42095 01572000
         USING PIB2ADR,R9         PIB2 BASE POINTER            @DA42095 01573000
         L     R9,PIBPCB          PCB BASE ADDRESS             @DA42095 01574000
         USING PCBADR,R9          PCB BASE POINTER             @D51GDAP 01575000
         L     R7,PCBTSIO         GET USAGE COUNTER            @D51GDAP 01576000
         AH    R7,H1              INCREMENT USAGE COUNTER      @D51GDAP 01577000
         ST    R7,PCBTSIO         STORE UPDATED VALUE          @D51GDAP 01578000
.*                                                             @D359DAP 01579000
.* THIS ACCOUNTING ROUTINE COUNTS THE NUMBER OF SIO'S PER      @D359DAP 01580000
.* DEVICE AND STORES THE CUMULATIVE COUNT AS WELL AS THE DEVICE@D359DAP 01581000
.* ADDRESS (CUU) IN A TABLE. THERE IS ONE TABLE PER PARTITION. @D359DAP 01582000
.*                                                             @D359DAP 01583000
         TM    SUPVFLAG,JAACT     IS SIO TO BE ACCOUNTED       @D14BDAP 01584000
         BZ    SIOJA030           NO,                          @D51IDAP 01585000
         TM    SYSFLAG2,IPLBIT    IPL IN PROCESS               @DA40676 01586000
         BO    SIOJA030           YES, PUBX MAY NOT BE PRESENT @DA40676 01587000
         CLI   CHQSLUB,SYSUSE     IS IT SYSUSE REQUEST         @D35IDAP 01588000
         BE    SIOJA030           YES,                         @D51IDAP 01589000
         L     R7,TIBPTR          LOAD TIB POINTER             @D36IDAP 01590000
         USING TIBADR,R7                                       @D36IDAP 01591000
         TM    TIBFLAG2,OVHIND    TO BE ACCOUNTED AS OVERHEAD  @DA26641 01592000
         BO    SIOJA030           YES, RETURN                  @D149DAP 01593000
         OI    CHQFLG1,CHQDIDJA   INDICATE SIO WAS COUNTED     @DA14439 01594000
         LR    R8,R3              COPY PUB POINTER             @D14BDAP 01595000
         SH    R8,YPUBTAB         OFFSET WITHIN PUB TABLE      @D14BDAP 01596000
         SRL   R8,PUBSLEN-PBXISLEN OFFSET IN PUBX ADDR.TABLE   @D51ODGL 01597000
         A     R8,APBXAREA        ADDRESS OF PUBX ADDRESS ENTRY@D14BDAP 01598000
         L     R8,0(R8)           ADDRESS OF PUBX              @D14BDAP 01599000
         USING PBXADR,R8          PUBX BASE POINTER            @D14BDAP 01600000
         DROP  R7                 RELEASE TIB BASE             @D14BDAP 01601000
         LA    R7,PBXJACNT        POINT TO SIO COUNT FIELD     @D14BDAP 01602000
         TM    PBXFLAG1,PBXSHR    ONLY 1 PARTITION OWNS DEVICE @D14BDAP 01603000
         BZ    SIOJA020           YES,                         @D14BDAP 01604000
         L     R7,PBXJAOFF        DEVICES OFFSET IN TABLE      @D14BDAP 01605000
         A     R7,PCBCNT          ADDRESS OF SIO COUNT FIELD   @D14BDAP 01606000
         DROP  R8                 RELEASE PUBX POINTER         @D51IDAP 01607000
         DROP  R9                 RELEASE PCB BASE             @D51GDAP 01608000
SIOJA020 L     R8,0(R7)           GET OLD SIO COUNT            @D14BDAP 01609000
         LA    R8,1(,R8)          INCREASE SIO COUNT           @D14BDAP 01610000
         ST    R8,0(R7)           STORE NEW SIO COUNT          @D14BDAP 01611000
SIOJA030 LM    R7,R9,ACCTSVRG     RESTORE REGISTERS            @D51IDAP 01612000
         BR    R7                      ======================> @D35IDAP 01613000
ACCTSVRG DC    3F'0'              SAVE AREA R7,R8              @D51IDAP 01614000
         TITLE 'VSE SUPERVISOR     SGSCHED     I/O REQUEST REQUEUING  ' 01615000
************************************************************** @D359DAP 01616000
*                                                            * @D359DAP 01617000
*        DO REQUEUING IF HEAD QUEUE IS WAITING               * @D359DAP 01618000
*                                                            * @D359DAP 01619000
************************************************************** @D359DAP 01620000
         SPACE 3                                                        01621000
SIOTSTHQ LA    RC,SIOTSTHQ      LOAD BASE REGISTER             @DAOM085 01622190
         USING SIOTSTHQ,RC      SIOTSTHQ BASE POINTER          @DAOM085 01622380
         CLI   CHQCHAIN,XFF     ANY OTHER REQUESTS QUEUED      @D35IDEP 01622570
         BE    SIOTHQ50         NO,                            @DA44277 01623000
         SLR   RE,RE            CLEAR NEXT REQUEST POINTER     @DA35201 01624000
         IC    RE,CHQCHNLO      GET INDEX TO NEXT REQUEST      @D51ODGL 01625000
         AIF   (&AG1 LE 254).LOD0030                           @D51ODGL 01626000
         ICM   RE,2,CHQCHNHI    INCLUDING HIGH BYTE            @D51ODGL 01627000
.LOD0030 ANOP                                                  @D51ODGL 01628000
         SLL   RE,CHQSLEN       DISPLACEMENT WITHIN CHANQ      @D35IDEP 01629000
         A     RE,ACHANQ        ADDRESS OF NEXT REQUEST        @D35IDEP 01630000
         ICM   RE,8,H0          CLEAR HIGH ORDER BYTE          @D68REEF 01631000
         TM    CHQFLG1-CHQADR(RE),CHQHQA IS NEXT A HEAD QUEUE  @D35IDAP 01632000
         BZ    SIOTHQ50         NO,                            @DA44277 01633000
         TM    CHQCCSIO,CHQCCACT DID WE START THE DEVICE       @DA35201 01634000
         BZ    SIOTHQ10         NO, TRY TO REQUEUE             @DA44277 01635000
         TM    CHQPROC,CHQDQUNC TO BE DEQUEUED UNCONDITIONALLY @D35IDEP 01636000
         BO    SIOTHQ10         YES, REQUEUE IS POSSIBLE       @D35IDEP 01637000
         TM    PUBCSFLG,QEDERR  IS PUB QUEUED IN ERROR         @D35IDAP 01638000
         BZ    SIOTHQ50         NO,                            @DA44277 01639000
SIOTHQ10 TM    CHQFLG1,CHQHQA   IS 1ST REQUEST A HQ            @D35IDEP 01640000
         BZ    SIOTHQ20         NO, DO REQUEUE I/O REQUESTS    @D35IDEP 01641000
         SLR   R1,R1            CLEAR WORK REGISTER            @D35IDEP 01642000
         SLR   R7,R7            CLEAR WORK REGISTER            @D35IDEP 01643000
         ICM   R1,3,CHQTID      SYSTEM TASK ID OF 1ST REQUEST  @D66ADAP 01644000
         ICM   R7,3,CHQTID-CHQADR(RE) ID OF 2ND REQUEST        @D66ADAP 01645000
         L     R9,IOSBASE       SGIOS BASE ADDRESS             @D21ODAP 01650000
         USING SGIOS,R9         SGIOS BASE POINTER             @D21ODAP 01651000
         IC    R1,HQUPRI(R1)    GET I/O PRIORITY OF 1ST        @D35IDEP 01652000
         IC    R7,HQUPRI(R7)    GET I/O PRIORITY OF 2ND        @D35IDEP 01653000
         CR    R1,R7            IS 1ST OF HIGHER PRIORITY      @D35IDEP 01654000
         BNH   SIOTHQ50         YES,                           @DA44277 01655000
         DROP  R9               RELEASE SGIOS BASE POINTER     @D21ODAP 01656000
SIOTHQ20 TM    PUBCSFLG,QEDERR  IS DEVICE QUEUED IN ERROR      @D36IDAP 01657000
         BZ    SIOTHQ30         NO, UNCONDITIONAL DEQUEUE      @D36IDAP 01658000
         OI    CHQFLG1,CHQCSQED INDICATE WAS QUEUED IN ERROR   @D35IDAP 01659000
SIOTHQ30 TM    PUBCSFLG,DEVBSY  IS DEVICE STILL BUSY           @D35IDAP 01660000
         BZ    SIOTHQ40         NO, ALL STATUS IS SAVED        @D35IDAP 01661000
         OI    CHQFLG1,CHQCSBSY SAVE PUB BUSY STATUS           @D35IDAP 01662000
SIOTHQ40 NI    PUBCSFLG,XFF-DEVBSY-QEDERR-OPINTV-PUBLOBSY RSET @D35IDAP 01663000
         IC    R1,PUBCHQPT      SAVE CURRENT CHANQ POINTER     @D35IDAP 01664000
         IC    R7,CHQCHNLO      GET NEXT IN CHAIN POINTER      @D51ODGL 01665000
         STC   R7,PUBCHQPT      MAKE NEXT IN CHAIN THE CURRENT @D35IDAP 01666000
         AIF   (&AG1 LE 254).LOD0040                           @D51ODGL 01667000
         ICM   R1,2,PUBCHQPH    GET CURRENT ENTRY HIGH BYTE    @D51ODGL 01668000
         IC    R7,CHQCHNHI      GET NEXT IN CHAIN HIGH BYTE    @D51ODGL 01669000
         STC   R7,PUBCHQPH      MAKE NEXT IN CHAIN THE CURRENT @D51ODGL 01670000
         IC    R7,CHQCHNHI-CHQADR(RE) GET NEW CURRENT HIGH     @D51ODGL 01671000
         STC   R7,CHQCHNHI      SAVE IN OLD CURRENT HIGH       @D51ODGL 01672000
         STCM  R1,2,CHQCHNHI-CHQADR(RE) SAVE OLD CURRENT HIGH  @D51ODGL 01673000
.LOD0040 ANOP                                                  @D51ODGL 01674000
         IC    R7,CHQCHNLO-CHQADR(RE) GET OLD CURRENT          @D51ODGL 01675000
         STC   R7,CHQCHNLO      SAVE IN OLD CURRENT            @D51ODGL 01676000
         STC   R1,CHQCHNLO-CHQADR(RE) SAVE IN NEW CURRENT      @D51ODGL 01677000
         NI    DEVSTA,XFF-BUSY  RESET BUSY TO PREVENT LOOP     @DA44277 01678000
         B     INITSIO               ========================> @D35IDEP 01679000
SIOTHQ50 TM    DEVSTA,BUSY      DID WE PROCESS PENDING INTERRPT@DA44277 01680000
         BZ    INITENAB         NO,  ========================> @DA44277 01681000
         NI    DEVSTA,XFF-BUSY  RESET BUSY                     @DA44277 01682000
         TM    PUBCSFLG,DEVBSY+QEDERR+OPINTV+PUBLOBSY          @DGA270  01683000
         BNZ   INITENAB         YES, ========================> @DA44277 01684000
         B     INITSIO               ========================> @DA44364 01685000
         SPACE 3                                                        01686000
         DROP  R1               RELEASRE CCB BASE                       01687000
         DROP  R3               RELEASE PUB BASE                        01688000
         DROP  R4               RELEASE CHANQ BASE                      01689000
         DROP  RA               RELEASE PIB BASE                        01690000
         DROP  R6               RELEASE DISP BASE                       01691000
         DROP  RC               RELEASE SIOTSTHQ BASE                   01692290
         DROP  RD               RELEASE SGSCHED BASE           @DAOM085 01692580
         TITLE 'VSE SUPERVISOR     SGECKD      ECKD CONVERSION ROUTINE' 01693000
         SGECKD                                                @D51GDAP 01694000
         AIF   (NOT &SGSCHED).NPRT020                          @D37DDAP 01695000
         PRINT NOGEN                                           @D37DDAP 01696000
.NPRT020 ANOP                                                  @D37DDAP 01697000
         MEND                                                           01698000
