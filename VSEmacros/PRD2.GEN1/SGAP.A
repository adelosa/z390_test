         MACRO                                                          00001000
         SGAP                                                           00002000
***************************************************************         00003000
*                                                             *         00004000
.*       IBM DISK OPERATING SYSTEM                            *         00005000
*        SUPERVISOR - SGAP - 5686-CF7-06                      *         00006000
.*                                                            *         00007000
*        LICENSED MATERIALS - PROPERTY OF IBM                 *         00008000
*        "RESTRICTED MATERIALS OF IBM"                        *         00009000
*        5686-CF7                                             *         00010000
*        (C) COPYRIGHT IBM CORP. 1977, 2004                   *         00011000
*                                                             *         00012000
***************************************************************         00013000
         GBLA  &NPART             NUMB.PARTITIONS              @D34UDFR 00014000
         GBLA  &NCLASS            NUMB.DYNAMIC CLASSES         @D51IDIS 00015000
         GBLB  &SGAP              PRINT OPTION                 @D37ZDFG 00016000
         GBLB  &BGDEBUG                                        @D66ODOW 00017000
         LCLA  &Y                                              @D34UDFR 00018000
.* /* START OF SPECIFICATIONS ***************************************** 00019000
.*                                                                      00020000
.*01* MODULE-TYPE = SUPERVISOR GENERATION MACRO                         00021000
.*                                                                      00022000
.*01* DESCRIPTIVE NAME = ASYNCHRONOUS PROCESSING ROUTINES               00023000
.*                                                                      00024000
.*01* NOTES = CHANGE ACTIVITY                                           00025000
.*    TASKING EXTENSIONS, SUPPORT OF EOT CLEANUP ROUTINES, ... @D149DFR 00026000
.*    NEW MODULE - FIRST RELEASE 34                            @D34RDFG 00027000
.*    DO NOT CLEAR EXIT FLAG AND SAVE AREA PTR. IN COMSVCE     @DA30165 00028000
.*    TERMINATOR PARAMETER LIST INCOMPLETE                     @D149DIS 00029000
.*    CNCLEXIT: VARIOUS PROBLEMS IN VTAM ABEND HANDLING        @DA30518 00030000
.*    TERMRTRN: REG. RB NOT SET FOR VSMDELAY AFTER TERM.CANCEL @DA29656 00031000
.*    NOOLTLTA: PROCESS 3800 TRANSIENT FOR SUBTASK,CANCEL ONLY @D14BDIS 00032000
.*    SOFTWAIT ON SHUTD REPLY FOR NCCF                         @DY33986 00033000
.*    SOEMI CLEANUP ROUTINE CALL, IF FLAGGED END AVAILABLE     @DY34091 00034000
.*    DLIEOTX: PROCESS PRINTER AUTOMATIC CLOSE                 @D21DDIS 00035000
.*    CALL VTAM CLEANUP ROUTINE FOE EACH OPEN ACB              @DY34811 00036000
.*    TASK TIMER EXIT ROUTINE NEVER ENTERED                    @DY34897 00037000
.*    MSG0S04I ILLEGAL SVC21 WHEN RUNNING WITH AN OC EXIT ROUT @DY35478 00038000
.*    DELAY ISTAPCKU ACTIVATION DURING TERMINATION PROCESSING  @DY36477 00039000
.*    OLTEP END OF TASK CLEANUP                                @DY37776 00040000
.*    DUMP/EOT INITIALIZATION AND RETURN REMOVED FROM          @D31EDOW 00041000
.*    SGAP BASE, NEW SUPERVISOR/DUMP INTERFACE DECLARED        @D31EDOW 00042000
.*    SOFTWARE RE-IPL                                          @D31QDHB 00043000
.*    INITEOT: IAF   HOOK                                      @D31ZDIS 00044000
.*    CPU TIMER ROUTINES MOVED TO MACRO SGTSLICE               @D51IDIS 00045000
.*    5.1 EXTENSION FOR CICS (EXITS MOVED TO SGEXIT)           @D51HDOW 00046000
.*    MORE PARTITION SUPPORT                                   @D51IDIS 00047000
.*    ESA/370 SUPPORT                                          @D51ADTP 00048000
.*    INCORRECT TASK TERMINATION, WHEN MULTY TASK TERM. REQUEST@DY38731 00049000
.*    SCLP SUPPORT                                             @D31EMIS 00050000
.*    QUIESCE I/O BEFORE END-OF-TASK                           @D51IDIS 00051000
.*    31 BIT ADDRESSING ADAPTAIONS                             @D52VDIS 00052000
.*    DATA SPACE SUPPORT                                       @D52GDIS 00053000
.*    VENDOR SUPPORT                                           @D52YDIS 00054000
.*    AB EXIT ACTIVATION: ADD. MSG INFO NOT AVAILABLE FOR      @KX40453 00055000
.*                        OLD AB EXIT SAVE AREA        D52GDIS @KX40453 00056000
.*    ENQUEUE / DEQUEUE ROUTINES INCLUDED INTO SGAP MACRO      @D52VDIS 00057000
.*    HW DUE TO MODE SWITCH IN SUBRTN CALLED WITH BAL @D52VDOW @KX40539 00058000
.*    NO ADD.MSG INFORMATION MOVED INTO AB SAVE AREA,          @KX40555 00059000
.*       IF STXIT ...,OPTION=DUMP SPECIFIED           @D52GDIS @KX40555 00060000
.*    ADAPT TO NEW PHO INTERFACE                      @D35EDRP @KY30133 00061000
.*    INITIATE PCK MESSAGE, WHEN DUMP CANCELLED       @D14BDFR @KX40960 00062000
.*    ATTACH: TRANSFER SECOND AB EXIT, IF ATTACHING            @KD40187 00063000
.*            TASK DEFINED AN OPTION=EARLY EXIT       @D52VDIS @KD40187 00064000
.*    SGAPCONT: RESET ADDITIONAL MSG INFO FOR OLD LAYOUT       @KD40187 00065000
.*    WAITM IN AMODE 31: INTRODUCE PCK ADDR FOR PARAMETER LIST @KD40187 00066000
.*    PROGRAM CHECK X'0029', CONTROL REG5=0 FOR SYSTEM TASKS   @DY42602 00067000
.*    PROBLEM DETERMINATION SUPPORT (TRACE)                    @D61FDIS 00068000
.*    CONSOLE SUPPORT                                          @D61CDIS 00069000
.*    LINKAGE STACK SUPPORT                                    @D61PDIS 00070000
.*    TRACE: SUBTASKING NOT CONSIDERED                         @KXA0065 00071000
.*    SVC 7: CHECK IF ANY DISPATCHER EXITS PENDING             @KXA1724 00072000
.*    ESA EXPLOITATION                                         @D64XDIS 00073000
.*    ESA FAMILY API                                           @D64ADIS 00074000
.*    PRINTER HANG AFTER CANCEL AR IF BUFFER LOAD ONGOING      @DY44456 00075000
.*    SVC 38 - GETVIS ERROR: PCBNTASK COUNT WRONG FOR ATTACHX  @D64ADIS 00076000
.*    MORE THAN 255 TASKS                                      @D66ODOW 00077000
.*    ICCF HIGHTASK GETS ILLEGAL SVC AFTER PAGEFAULT IN IJBMCBE@DY45580 00078000
.*    NAME/TOKEN SERVICE                                       @D67CDOW 00079000
.*    SVC 38 PARAM CHECK FOR SVA; NOT PARTITION SPACE DY45639  @DY46001 00080000
.*    SAME TID FOR 2 DIFFERENT SUBTASKS                        @DY46206 00081000
.*    EZA API CLEANUP ROUTINE                                  @D68IDMZ 00082490
.*    INDICATION FOR POWER: OPERATOR CANCEL DURING BRING UP    @DY46408 00082690
.*    CROSS MEMORY CLEANUP MUST BE CALLED FOR MAINTASK ONLY    @DY46432 00082790
.*    SUPPORT DB2 AUTOCOMMIT FOR BATCH APPLICATIONS            @DY46455 00082890
.**** END OF SPECIFICATIONS ***************************************** / 00083000
         SPACE 2                                               @D35EDFR 00084000
         AIF   (NOT &SGAP).NPRT010                             @D61NDIS 00085000
         PRINT GEN                                             @D37ZDFG 00086000
.NPRT010 ANOP                                                  @D37ZDFG 00087000
         DC    CL8'SGAP'                                                00088000
         DC    CL10'@DY46455  '                                         00089770
         SPACE 1                                               @D35BDIS 00090000
         ENTRY SGAP                                            @D36ZDAZ 00091000
SGAP     BR    RC                BRANCH TO SVC ROUTINE         @D34RDFG 00092000
         USING SGAP,RD           COMMON BASE WITHIN SGAP       @D34RDFG 00093000
         USING DISP,R6           DISPATCHERS BASE              @D35EDFR 00094000
         USING TIBADR,R8         TASK INFORMATION BLOCK BASE   @D36IDFR 00095000
         USING TCBADR,RA         TASK CONTROL BLOCK BASE       @D36IDFR 00096000
         USING SVEARA,RB         TASK SAVEAREA BASE            @D36IDFR 00097000
 TITLE 'VSE SUPERVISOR   SGAP                     TERMINATION ROUTINES' 00098000
         SPACE 4                                               @D35EDFR 00099000
*********************************************************************** 00100000
*                                                                     * 00101000
* TERMINATOR:  CANCEL EXIT ROUTINE                                    * 00102000
*                                                                     * 00103000
*********************************************************************** 00104000
*                                                                     * 00105000
*        ENTERED : FROM DISPATCHER VIA DISPATCHER EXIT FLAG           * 00106000
*                                                                     * 00107000
*        FUNCTION:                                                    * 00108000
*            CONTROL OF TASKS (JOBS) TERMINATION.THIS INCLUDES SPECIAL* 00109000
*            ACTIONS FOR COMPONENTS (EG. TP, VSAM) AS WELL AS         * 00110000
*            * ACTIVATION/DEACTIVATION OF THE SVA RESIDENT TERMINATOR * 00111000
*              (MESSAGE WRITER WITH DUMP)                             * 00112000
*            * QUIESCING OF LTA I/O REQUESTS                          * 00113000
*            * ACTIVATION OF USER ABEND PROCESSING                    * 00114000
*            * ACTIVATION/DEACTIVATION OF THE SVA RES. EOT ROUTINES   * 00115000
*            * RESET OF SPECIAL FUNCTIONS(PHO,...)                    * 00116000
*            * FREEING OF SYSTEM RESOURCES(LTA,SEIZE,...) ETC.        * 00117000
.*                                                                    * 00118000
.*       FOLLOWIG ROUTINES ARE INVOLVED IN EOT PROCESSING:            * 00119000
.*       *   RESIDENT TERMINATOR ROUTINE                              * 00120000
.*       *   SVA RESIDENT TERMINATOR ROUTINE (MESSAGE WRITTER & DUMP) * 00121000
.*       *   LTA/SVA RESIDENT SUBSYSTEM EOT CLEANUP ROUTINES          * 00122000
.*       *   SVA RESIDENT EOT ROUTINE                                 * 00123000
.*       SINCE TASKS NORMAL SAVEAREA IS NOT AVAILABLE,STATUS OF       * 00124000
.*       THE RESIDENT TERMINATOR ROUTINE CAN NOT BE SAVED, THEREFORE  * 00125000
.*       A RETURN TO THE SECOND PART OF THE RESIDENT TERMINATOR       * 00126000
.*       ROUTINE IS SUPPORTED USING FLAGS.                            * 00127000
.*       FIRST ENTRY POINT TO RES. TERMINATOR IS AT LABEL DOCANCEL    * 00128000
.*       ACTIVATION/DEACTIVATION OF THE SVA RESIDENT TERMINATOR IS    * 00129000
.*       DONE BY THE ROUTINES INITTERM/TERMRTRN                       * 00130000
.*       TERMRTRN RETURNS TO THE MAIN PATH AT LABEL SETEOJSW          * 00131000
.*       REENTRY POINT OF RES. TERMINATOR IS AT LABEL CONTTERM        * 00132000
.*       ACTIVATION/DEACTIVATION OF THE SVA RESIDENT EOT ROUTINE IS   * 00133000
.*       DONE BY THE ROUTINES INITEOT/EOTRTRN                         * 00134000
.*                                                                    * 00135000
.*       FLAG LOCATED IN TIBFLAG :                                    * 00136000
.*           FETCHEOJ = ON ; CAUSES DISPATCHER TO GO TO CANCEL EXIT;  * 00137000
.*                           USED TO INITIALIZE TERMINATOR PROCESSING * 00138000
.*                           OR  TO REENTER RESIDENT TERMINATOR       * 00139000
.*       FLAG LOCATED IN TCBFLAG2 :                                   * 00140000
.*           CNCLRTRN = ON ; IN COMBINATION WITH FETCHEOJ ON CAUSES   * 00141000
.*                           RESIDENT TERMINATOR TO CONTINUE AT LABEL * 00142000
.*                           CONTTERM (REENTRY POINT)                 * 00143000
.*       FLAG LOCATED IN TIBFLAG1 :                                   * 00144000
.*           TERMACT= ON ;   INDICATES THAT THE SVA RESIDENT          * 00145000
.*                           TERMINATOR IS ACTIVE                     * 00146000
.*                           PREVENTS ADDRESS VALIDATION, GIVING      * 00147000
.*                           TERMINATOR ROUTINE AN LTA LIKE STATUS.   * 00148000
.*           EOTACT = ON ;   INDICATES THAT THE SVA RESIDENT EOT      * 00149000
.*                           ROUTINE IS ACTIVE                        * 00150000
.*           EOTINPR= ON ;   INDICATES THAT EOT CLEANUP PROCESSING OR * 00151000
.*                           THE SVA RESIDENT EOT ROUTINE IS ACTIVE   * 00152000
.*                           PREVENTS ADDRESS VALIDATION, GIVING.     * 00153000
.*                           EOT ROUTINES AN LTA LIKE STATUS.         * 00154000
.*                                                                    * 00155000
.* DESCRIPTION OF FUNCTIONS:                                          * 00156000
.*                                                                    * 00157000
.* AS THE FIRST STEP IN TASKS TERMINATION THE RESIDENT TERMINATOR IS  * 00158000
.* ACTIVATED,THEN THE SVA RESIDENT TERMINATOR IS CALLED.              * 00159000
.* IN CASE THE SVA RESIDENT TERMINATOR IS OCCUPIED BY ANY OTHER TASK  * 00160000
.* THE TERMINATING TASK WILL BE SET TO TERMINATOR BOUND WAIT STATE.   * 00161000
.* THE SVA-RESIDENT TERMINATOR WILL NOT BE CALLED IN CASE OF          * 00162000
.*    * NORMAL EOJ                                                    * 00163000
.*    * ABNORMAL END OF IPL                                           * 00164000
.*    * CANCEL OF SVA-RESIDENT TERMINATOR ITSELF                      * 00165000
.* AFTER RETURN FROM SVA-RES.TERMINATOR CANCEL IS PROPAGATED:         * 00166000
.* WHEN A MAINTASK WITH SUBTASKS HAS TO BE TERMINATED, OR IT IS A     * 00167000
.* CANCEL ALL REQUEST THE RDYCNCL ROUTINE IS CALLED TO PERFORM CANCEL * 00168000
.* PROPAGATION.                                                       * 00169000
.*                                                                    * 00170000
.* REENTRY POINT OF RESIDENT TERMINATOR:                              * 00171000
.*                                                                    * 00172000
.* LTA I/O IS QUIESCED AND THE LTA FREED WHEN NECESSARY.THIS MEANS:   * 00173000
.*    * WHEN THE LTA IS OCCUPIED BY A TERMINATING TASK AND THERE IS   * 00174000
.*      ANY LTA I/O UNPROCESSED YET, TASK WILL SET TO I/O BOUND WAIT  * 00175000
.*      AND CONTROL WILL RETURN TO DISPATCHER. WITHOUT SUCH I/O       * 00176000
.*      THE LTA WILL BE FREED.                                        * 00177000
.* WHEN THERE ARE SUBTASKS ATTACHED YET A MAINTASK IS SET TO WAIT     * 00178000
.* IN ORDER TO ALLOW  TERMINATION OF SUBTASKS PRIOR TO MAINTASKS      * 00179000
.* TERMINATION.                                                       * 00180000
.* IN THE NEXT STEP TASKS ABEND EXIT ROUTINE IS ACTIVATED:            * 00181000
.*    * UNLESS IT IS A TERMINATION DUE TO NORMAL EOJ,DETACH,CANCEL OR * 00182000
.*      DUMP REQUEST ANY USER ABEND ROUTINE IS ACTIVATED BY SETTING   * 00183000
.*      UP SAVEAREAS AND RETURN TO TASK SELECTION.                    * 00184000
.*      AFTER PROCESSING THE USER ABEND ROUTINE PART 1 OF THE RESIDENT* 00185000
.*      TERMINATOR WILL BE PERFORMED AGAIN.                           * 00186000
.*      THE USER'S AB EXIT ROUTINE IS NOT REENTERED AT SECOND TIME.   * 00187000
.* IF NO USER ABEND ROUTINE HAS TO BE ACTIVATED TERMINATION CONTINUES * 00188000
.* AT LABEL RESRESET RELEASING SYSTEM RESOURCES.                      * 00189000
.* EOT CLEANUP PROCESSING: IT CONSISTS OF SUBSEQUENT NON RECURSIVE    * 00190000
.* CALLS TO THE DIFFERENT LTA-OR SVA RESIDENT CLEANUP ROUTINES. TASKS * 00191000
.* SAVAREA IS USED TO  PROVIDE LINKAGE TO THE ROUTINES VIA NORMAL     * 00192000
.* TASK SELECTION.                                                    * 00193000
.*   * ANY LTA RESIDENT OLD EOJ ROUTINES (&&BSTCNL,$$BTOLTP,$$BPCLOS, * 00194000
.*     $$BACLOS ARE CALLED INTO THE LTA (IF NECESSARY) SIMULATING     * 00195000
.*     SVC 02 REQUESTS.                                               * 00196000
.*   * ANY SVA RESIDENT EOT CLEANUP ROUTINES  ARE CALLED SETTING UP A * 00197000
.*     PSW WITH THE ENTRY POINT ADDRESS OF THE CLEANUP ROUTINE.       * 00198000
.* AT THE END OF THE RESIDENT TERMINATOR PROCESSING THE SVA RESIDENT  * 00199000
.* EOT ROUTINE IS ACTIVATED IF IT IS FREE. OTHERWISE TASK WILL SET TO * 00200000
.* EOTBND WAIT STATE.                                                 * 00201000
*                                                                     * 00202000
*********************************************************************** 00203000
         SPACE 2                                               @D35EDFR 00204000
*SGLINK  CNCLEXIT,S,INPUT=(R6,R8,RA,RB)                                 00205000
CNCLEXIT L     RD,APBASE          LOAD AP BASE ADDR.           @D36IDFR 00206000
*        DISPMAC FUNC=CNCLEXIT    CANCEL PROCESS               @D61RDIS 00207000
         DISPMAC FUNC=CNCLEXIT    CANCEL PROCESS               @D61RDIS 00208000
         TM    TCBFLAG6,TCBPSTAC  VENDOR EXIT ACTIVE ?         @D61EDIS 00209000
         BZ    CNCLEXIV           NO, SKIP                     @D61EDIS 00210000
         EJECT ,                                               @D64ADIS 00211000
*--------------------------------------------------------------         00212000
* $IJBVEND  - VENDOR INTERFACE CLEAN UP                                 00213000
*             INPUT:  RA - TCB ADDRESS OF CURRENT TASK                  00214000
*                     RE - RETURN ADDRESS                               00215000
*                     RD - $IJBVEND BASE ADDRESS                        00216000
*                     RF - FUNCTION CODE                                00217000
*             OUTPUT: RF - RETURN CODE (= 0)                            00218000
*             AMODE:  ANY                                               00219000
*             $IJBVEND HAS TO RETURN WITH THE AMODE OF THE CALLER       00220000
*--------------------------------------------------------------         00221000
         L     RF,ASVASVDL        PTR.TO SVA ROUT.ADDR.TABLE   @D61EDIS 00222000
         ICM   RF,15,AIJBVEND-SVASVDL(RF) GET ROUTINE ADDRESS  @D61EDIS 00223000
         BZ    CNCLEXIV           BRANCH IF NOT AVAILABLE      @D61EDIS 00224000
         DROP  RD                                              @D61EDIS 00225000
         LR    RD,RF              INITIALIZE $IJBVEND BASE     @D61EDIS 00226000
         LA    RF,12              SET FUNCTION CODE            @D61EDIS 00227000
         BASSM RE,RD              CALL ROUTINE                 @D64ADIS 00228000
         L     RD,APBASE          GET TASK SELEKTION BASE      @D61EDIS 00229000
         USING SGAP,RD                                         @D61EDIS 00230000
         L     R6,DISPAD          RESTORE DISPATCHER BASE      @D61EDIS 00231000
         L     R8,TIBPTR          RESTORE TIB ADDRESS          @D61EDIS 00232000
         L     RA,TCBPTR          RESTORE TCB ADDRESS          @D61EDIS 00233000
         L     RB,TCBSAVE         RESTORE SAVE AREA ADDRESS    @D61EDIS 00234000
         EJECT ,                                               @D61EDIS 00235000
*--------------------------------------------------------------         00236000
* CNCLEXIV  - CHECK, IF SYSTEM TASK CANCEL PROCESS NECESSARY            00237000
*--------------------------------------------------------------         00238000
CNCLEXIV DS    0H                                              @D61EDIS 00239000
         LR    RF,R6              SET RETURN FROM ERRGO3       @D61PDIS 00240000
         TM    TIBFLAG4,TIBSYSDT  SYSTEM TASK CNCL PROCESS ... @D61PDIS 00241000
*                                 ... NOT YET COMPLETE ?       @D61PDIS 00242000
         BO    ERRGO3             YES, DO SPECIAL CANCEL       @D61PDIS 00243000
*SGLINK  ERRGO3,INPUT=(R6,R8,RF)                                        00244000
         L     R5,PCBPTR          GET CURRENT PCB ADDRESS      @D51IDIS 00245000
         USING PCBADR,R5                                       @D51IDIS 00246000
         TM    PCEFLAG,PCEDYNP+PCEPREP INITIALIZATION ?        @D51IDIS 00247000
         BO    INITEOTD           YES, PROCESS INITIALIZATION  @D51IDIS 00248000
*SGLINK  INITEOTD,INPUT=(R5,R6,R8,RA,RB,RD)                             00249000
         DROP  R5                 RELEASE PCB POINTER          @D51IDIS 00250000
         TM    TCBFLAG2,CNCLRTRN  INITIAL ENTRY TO CNCLEXIT?   @D14BDFR 00251000
         BO    CONTTERM           NO,GOTO SECOND REENTRY POINT @D14BDFR 00252000
         EJECT ,                                               @D52VDIS 00253000
*********************************************************************** 00254000
*                                                                     * 00255000
* TERMINATOR:  REENTRY POINT OF PART 1 OF RESIDENT TERMINATOR ROUTINE * 00256000
*                                                                     * 00257000
*********************************************************************** 00258000
         TM    TIBFLAG3,TIBPHRQ   DYNCLASS ID=HOLD ISSUED ?    @D51IDIS 00259000
         BZ    DOCANCX0           NO --->                      @D61PDIS 00260000
         L     RC,ASVC43          GET SVC 43 BASE ADDRESS      @D51IDIS 00261000
         L     RF,AS43FRRET                                    @D66ODOW 00262000
         BSM   0,RF               ENTER SVC43 IN 31BIT MODE    @D66ODOW 00263000
AS43FRRET DC   A(S43FRRET+X'80000000')                         @D66ODOW 00264000
*SGLINK  S43FRRET,INPUT=(R6,R8,RC)                                      00265000
*                                 SERVICE RETURNS TO DISPATCHER@D51IDIS 00266000
         SPACE 2                                               @D51IDIS 00267000
*--------------------------------------------------------------         00268000
* DOCANCX0 - RE-ESTABLISH USER ENVIRONMENT, CONTROL REGISTERS           00269000
*            WILL BE UPDATED DURING NEXT DISPATCHER CYCLE               00270000
*--------------------------------------------------------------         00271000
DOCANCX0 DS    0H                                              @D61PDIS 00272000
         L     R5,TCBATCBE        GET ADDR. OF TCB EXTENSION   @D61PDIS 00273000
*        AMODESW SET,AMODE=31,WR=(9)                           @D61PDIS 00274000
         AMODESW SET,AMODE=31,WR=(9)                           @D61PDIS 00275000
         USING TCBXADR,R5                                      @D61PDIS 00276000
         TM    TCBXFLG1,TCBXSALA SYSTEM ENVIRONMENT ACTIVE     @D61PDIS 00277000
         BZ    DOCANCL0           NO --->                      @D61PDIS 00278000
* RID=DISPID OR SYSTEMID, SET UP FIRST SAVE AREA                        00279000
* ROUTINE MAY BE IN RID=REENTRID AFTERWARDS, I.E. IN CASE AN INTERRUPT  00280000
* OCCURS THE 2ND SAVE AREA IS USED. THAT'S WHY CR2 AND CR8 MUST BE      00281000
* LOADED                                                                00282000
         MVC   TCBX1CR2(4),TCBXSDUC RESTORE TASK'S DU-AL       @D61ADMZ 00283000
         STCTL CR8,CR8,TCBX1CR8     GET SYSTEM RELATED 2ND HALF@D61ADMZ 00284000
         MVC   TCBX1CR8(2),TCBXSEAX   RESTORE TASK'S EAX       @D61ADMZ 00285000
         LCTL  CR8,CR8,TCBX1CR8     GET SYSTEM RELATED 2ND HALF@D61ADMZ 00286000
         LCTL  CR2,CR2,TCBX1CR2     RESTORE TASK'S DUCT        @D61ADMZ 00287000
         NI    TCBXFLG1,X'FF'-TCBXSALA-TCBXDRSA RESET IND.     @D64XDIS 00288000
         DROP  R5                                              @D61PDIS 00289000
DOCANCL0 DS    0H                                              @D51IDIS 00290000
*        AMODESW SET,AMODE=24,WR=(9)                           @D61PDIS 00291000
         AMODESW SET,AMODE=24,WR=(9)                           @D61PDIS 00292000
         TM    TIBFLAG,RETRYSVC   TASK HAS BEEN SET TO RESVC?  @D36IDFR 00293000
         BZ    DOCANCL1           NO --->                      @D36IDFR 00294000
         BAL   R5,SETRESVC        SETUP TASK TO REISSUE SVC    @D36IDFR 00295000
*SGLINK  SETRESVC,INPUT=(R5,R6,R8,RA,RB),WORK=R9                        00296000
         EJECT ,                                               @D61NDIS 00297000
*--------------------------------------------------------------         00298000
* DOCANCL1 - DUMP OR EOT CANCELLED ?                                    00299000
*--------------------------------------------------------------         00300000
DOCANCL1 L     R9,ATERMBAS        GET COMMON BASE ADDR         @D31EDOW 00301000
         USING TERMBASE,R9        ESTABLISH BASE               @D31EDOW 00302000
         TM    TIBFLAG1,TERMACT+EOTACT TERM.OR EOT CANCELLED?  @D31EDOW 00303000
         BZ    DOCANCL2           NO --->                      @D36BDFR 00304000
         L     RC,ASVC03                                       @D36IDFR 00305000
         L     RD,IOSBASE         GET IOS BASE ADDRESS         @D51IDIS 00306000
         USING SVC03,RC                                        @D36IDFR 00307000
         BAL   R7,SVC03LTA        QUIESCE LTA'S I/O            @D51IDIS 00308000
*SGLINK  SVC03LTA,INPUT=(R6,R7,R8,RA,RC,RD),WORK=(R1,R2,R3,R4,R5,RE,RF) 00309000
         DROP  RC                                              @D36IDFR 00310000
         L     RD,APBASE          GET SGAP BASE ADDRESS        @D51IDIS 00311000
         TM    TIBFLAG1,TERMACT   TERMINATOR CANCELLED         @D36BDFR 00312000
         BO    TERMCNCL           YES,GO TO RELEASE TERMINATOR @D14BDFR 00313000
*SGLINK  TERMCNCL,INPUT=(R6,R8,R9,RA,RD),WORK=(R5,R7,RB,RF),OUTPUT=(RB) 00314000
         ICM   R7,15,EOTOWNSA     LOAD SAVE AREA PTR., AVAIL.? @D51IDIS 00315000
         BZ    DOCANC02           NO, DO NOT SAVE FOR DUMP     @D51IDIS 00316000
         MVC   SVEPSW-SVEARA(L72,R7),SVEPSW SAVE FOR TERMINATOR@D14BDFR 00317000
DOCANC02 DS    0H                                              @D51IDIS 00318000
         BAL   R7,EOTCNCL         FREE EOT                     @D36BDFR 00319000
         DROP  R9                                              @D31EDOW 00320000
         EJECT ,                                               @D52VDIS 00321000
*--------------------------------------------------------------         00322000
* DOCANCL2 - ACF/VTAM HOOK                                              00323000
*--------------------------------------------------------------         00324000
DOCANCL2 DS    0H                                              @D36BDFR 00325000
         TM    TIBFLAG3,VTACTCKU+VTDELCKU                      @DY36477 00326000
*                                 ISTAPCKU ROUTINE TO BE ACTIV.@DY36477 00327000
         BNZ   DOCANCV1           SKIP IF YES                  @DY36477 00328000
         TM    VTAMFLG,VTAPP+VTURX+VTSVC   VTAM PROCESS ACTIVE @DA30518 00329000
         BZ    DOCANCL3           SKIP IF NOT                  @DA24952 00330000
         OI    VTAMFLG,VTABEND+VTCDLY SET ABEND+CANCEL DELAY   @DA24952 00331000
         OI    TIBFLAG,APSEXFLG   SCHEDULE VTAM AP EXIT        @DA24952 00332000
         NI    TIBFLAG,XFF-FETCHEOJ RESET CANCEL EXIT          @DA24952 00333000
         BR    R6                 BACK TO DISPATCHER           @DA24952 00334000
         SPACE 2                                               @D52VDIS 00335000
*--------------------------------------------------------------         00336000
* DOCANCV1 - RESET DELAYED VTAM ISTAPCKU ACTIVATION                     00337000
*--------------------------------------------------------------         00338000
DOCANCV1 DS    0H                                              @DY36477 00339000
         TM    TIBFLAG3,VTDELCKU  ACTIVATION ALREADY DELAYED ? @DY36477 00340000
         BO    DOCANCL3           SKIP IF YES                  @DY36477 00341000
         NI    TIBFLAG,XFF-APSEXFLG RESET DISPATCHER EXIT      @DY36477 00342000
         NI    TIBFLAG3,XFF-VTACTCKU RESET ACTIVATION INDICATOR@DY36477 00343000
         OI    TIBFLAG3,VTDELCKU    SET ACT.OF ISTAPCKU DELAYED@DY36477 00344000
         EJECT ,                                               @D52VDIS 00345000
*--------------------------------------------------------------         00346000
* DOCANCL3 - RESET PHO APPENDAGE AND DO IMPLICIT TPOUT                  00347000
*--------------------------------------------------------------         00348000
DOCANCL3 DS    0H                                              @DA24952 00349000
         TM    TIBFLAG1,PHOACT    PHO ACTIVE FOR TASK          @D36IDFR 00350000
         DROP  R8                                              @D66ODOW 00351000
         L     R8,APMGMDAT                                     @D35EDRP 00352000
         USING PMGMDATA,R8                                     @D35EDRP 00353000
         BNO   NOPHORES           NO --->                      @D36IDFR 00354000
         L     R7,ARESPHO         GET ADDR OF RTN              @D35EDRP 00355000
         LR    R2,RD              GET SGAP BASE ADDRESS        @KY30133 00356000
         DROP  RD                                              @KY30133 00357000
         USING SGAP,R2            SET TEMP. SGAP BASE          @KY30133 00358000
         SLR   RD,RD              INPUT FOR RESPHO             @KY30133 00359000
         BASSM R7,R7               DISALLOW PHO FOR THIS TASK  @D64ADIS 00360000
*SGLINK  RESPHO,INPUT=(R7,R8,RD)                                        00361000
         B     PHORESND           RETURN WITH OFFSET 0 O.K.    @KY30133 00362000
*                                 RETURN WITH OFFSET 4 ERROR   @KY30133 00363000
         MVI   IJBHWORG,HWORG224  SET HARDWAIT ORIGINATOR CODE @KY30133 00364000
         BAL   R5,SYSERROR        HARDWAIT                     @KY30133 00365000
*--------------------------------------------------------------         00366000
PHORESND DS    0H                                              @KY30133 00367000
         LR    RD,R2              RESET COMMON SGAP BASE       @KY30133 00368000
         DROP  R2                 DROP TEMP. SGAP BASE         @KY30133 00369000
         USING SGAP,RD                                         @KY30133 00370000
NOPHORES DS    0H                                              @D36IDFR 00371000
         L     R7,ASCANPGT        GET ADDR OF RTN              @D35EDRP 00372000
         BASSM R7,R7               SCAN PAGETAB                @D64ADIS 00373000
*SGLINK  SCANPGT,INPUT=(R6,R7,R8)                                       00374000
         CLC   TID,TPTID          IS IT TPIN REQUESTOR         @D66ODOW 00375000
         BNE   NOREACT            NO --->                      @D36IDFR 00376000
         L     R2,ASVC089         GET ENTRY ADDR AND           @D35IDRP 00377000
         BSM   0,R2               DO IMPLICITE TPOUT           @D64ADIS 00378000
*SGLINK  SVC089,INPUT=(R6)                                              00379000
         DROP  R8                                              @D66ODOW 00380000
         SPACE 2                                                        00381000
NOREACT  L     R8,TIBPTR          RELOAD TIB POINTER           @D36IDFR 00382000
         USING TIBADR,R8                                       @D36IDFR 00383000
         EJECT ,                                               @D52VDIS 00384000
*--------------------------------------------------------------         00385000
*          - IF OPERATOR CANCEL, DO VSAM CLEAN UP                       00386000
*--------------------------------------------------------------         00387000
         CLI   TIBCNCL,CANCX08    PFLUSH ?                     @D64ADIS 00388000
         BE    VSCLCHCK           YES, TEST MORE               @D64ADIS 00389000
         CLI   TIBCNCL,CANCX24    OPERATOR CANCEL?             @D35ZDFR 00390000
         BNE   NOVSM              NO, DONT TEST MORE           @DA08344 00391000
VSCLCHCK DS    0H                                              @D64ADIS 00392000
         CLI   TIBCNCL2,ZERO      SECOND CANCEL?               @D36IDFR 00393000
         BNE   NOVSM              YES,DONT TEST MORE           @D36IDFR 00394000
         L     R7,CRADDR          LOAD ADDRESS OF PART.COMREG  @DA08344 00395000
***************************************************************@D149DIS 00396000
* * * *  THE FOLLOWING ETSS MC REPLACES THE COMREG ADDRESS IN  @D35ZDUL 00397000
* * * *  THE REGISTER OF THE PRECEDING LOAD INSTRUCTION BY THE @D35ZDUL 00398000
* * * *  PSEUDO PARTITION COMREG ADDRESS IF THE CANCELED TASK  @D35ZDUL 00399000
* * * *  IS AN ETSS PSEUDO PARTITION.                          @D35ZDUL 00400000
*>>>>>>  RETURNS WITH RID = SYSTEMID                                    00401000
***************************************************************@D149DIS 00402000
         MC    4,4                REPLACE COMREG ADDR FOR PS P @D35ZDUL 00403000
         USING COMREG,R7                                       @D35IDAP 00404000
         MVI   RID+1,DISPID       ALLOW PAGE FAULTS            @D14BDFR 00405000
         TM    OPTNBYTE,ANCHTBIT  IS ANCHORTABLE CREATED       @DA08344 00406000
         BZ    NOVSM              NO --->                      @D61NDIS 00407000
         L     R7,PPEND           GET END OF PARTITION         @DA08344 00408000
         DROP  R7                                              @D36IDFR 00409000
         LA    R7,1(,R7)          GET START OF ANCHOR TABLE    @DA08344 00410000
         L     R5,PCBPTR          RESTORE PCB POINTER          @D14BDFR 00411000
         L     RC,PIBPTR2         GET CURRENT PIB2 ADDRESS     @D61IDIS 00412000
         TM    ANCHAMFF-VSAMTAB(R7),X'01' VSAM DEL. BIT ON?    @D36IDFR 00413000
         BZ    NOVSM              NO, CONTINUE WITH TERMINATION@D61RDIS 00414000
*SGLINK  VSMDELAY,INPUT=(R5,R6,R8,RA,RB,RC,RD)                          00415000
*        DISPMAC FUNC=VSMDELAY    PROCESS REDISPATCH           @D61RDIS 00416000
         DISPMAC FUNC=VSMDELAY    PROCESS REDISPATCH           @D61RDIS 00417000
         L     R6,DISPAD          GET DISPATCHER BASE ADDRESS  @D61RDIS 00418000
         B     DISPRET            RETURN POINT IN CASE OF IOINT@D61RDIS 00419000
         SPACE 2                                               @D61NDIS 00420000
*--------------------------------------------------------------         00421000
*          - IF TASK SEIZES SYSTEM, POST WAITERS                        00422000
*--------------------------------------------------------------         00423000
         USING SGAP,RD                                         @D61NDIS 00424000
NOVSM    DS    0H                                              @D64ADIS 00425000
         TM    TIBFLAG3,SEIZEBIT  SYSTEM SEIZED BY THIS TASK   @D61NDIS 00426000
         BZ    NOVSM1             NO --->                      @D36IDFR 00427000
         NI    TIBFLAG3,XFF-SEIZEBIT RESET SEIZE INDICATOR     @D14BDFR 00428000
         L     R5,ASRQTAB         GET ADDRESS OF SRQTAB        @D61RDIS 00429000
         LA    R5,SRQSEIZE-SRQTAB(,R5)                         @D61RDIS 00430000
         BAL   RF,RPOST           POST ALL SEIZED TASKS        @D36IDFR 00431000
*SGLINK  RPOST,INPUT=(R5,R6,RF),WORK=(R5,RE)                            00432000
*--------------------------------------------------------------         00433000
* NOVSM1   - IF AB EXIT ACTIVE, RESET EXIT                              00434000
*                  IF CURRENT TASK IS MAINTASK, FORCE EOJ               00435000
*--------------------------------------------------------------         00436000
NOVSM1   DS    0H                                              @D35EDFR 00437000
         MVI   RID+1,REENTRID     ALLOW PAGE FAULTS            @D64ADIS 00438000
         DROP  RD                                              @D64ADIS 00439000
         L     RD,ASGEXIT         GET BASE ADDR. OF AB EXIT CHK@D64ADIS 00440000
         L     RD,ACHKEXIT-SGEXIT(,RD) ...                     @D64ADIS 00441000
         BASSM R9,RD              CALL ROUTINE                 @D64ADIS 00442000
*SGLINK CHKEXIT,INPUT=(R6,R8,R9,RA,RD),WORK=(R0,R1,R7)                  00443000
*        OUTPUT: FLAG BYTE TCBEXIFL                                     00444000
         L     RD,APBASE          GET SGAP BASE ADDRESS        @D64ADIS 00445000
         USING SGAP,RD                                         @D64ADIS 00446000
         MVI   RID+1,SYSTEMID     RESTORE RID                  @D64ADIS 00447000
         TM    TCBEXIFL,TCBEXIAC  AB EXIT ACTIVE ?             @D64ADIS 00448000
         BZ    NOABTERM           NO, NORMAL PROCESS           @D64ADIS 00449000
         TM    TCBEXIFL,TCBEXINI  NEW INTERFACE USED ?         @D64ADIS 00450000
         BO    NOABTERM           YES, DO NOT FORCE EOJ        @D64ADIS 00451000
         CLC   TID(2),IJBHMTID    IS IT SUBTASK                @D51IDIS 00452000
         BH    NOABTERM           YES, DO NOT FORCE EOJ        @D64ADIS 00453000
         CLC   TID,ARTIDH         IS IT SYSTEM TASK            @D66ODOW 00454000
         BNH   NOABTERM           YES, DO NOT FORCE EOJ        @D64ADIS 00455000
         L     RF,CRADDR          CURRENT COMREG               @D37CDFG 00456000
         OI    JCSW1-COMREG(RF),JOBEND   FORCE END OF JOB      @D37CDFG 00457000
         EJECT ,                                               @D52VDIS 00458000
*--------------------------------------------------------------         00459000
* NOABTERM - ACTIVATE MESSAGE WRITER / DUMP ROUTINE                     00460000
*--------------------------------------------------------------         00461000
NOABTERM DS    0H                                              @D64ADIS 00462000
         TM    SYSFLAG2,IPLBIT    IPL CANCELLED?               @D14BDFR 00463000
         BO    SETEOJSW           YES, --->                    @D64ADIS 00464000
*SGLINK  SETEOJSW,INPUT=(R6,R8,RA,RB,RD)                                00465000
         TM    TCBEXIFL,TCBEXIEX+TCBEXIEA ESTAEX OR EARLY AB ? @D64ADIS 00466000
         BNZ   CONTT2ND           YES, DO NOT CALL DUMP ROUTINE@D64ADIS 00467000
         TM    TIBFLAG4,TIBDMPCN  S/PDUMP CANCELLED ?          @KX40960 00468000
         BO    SETEOJSW           YES, DO NOT ACTIVATE DUMP    @KX40960 00469000
*SGLINK  SETEOJSW,INPUT=(R6,R8,RA,RB,RD)                                00470000
         L     R9,ATERMBAS        GET COMMON BASE ADDR         @D64ADIS 00471000
         USING TERMBASE,R9                                     @D64ADIS 00472000
         CLI   TIBCNCL2,ZERO      IS IT MULTIPLE CANCEL        @D14BDFR 00473000
         BNE   SKIPTEOJ           YES,DO NOT TEST FOR EOJ      @D14BDFR 00474000
         TM    TCBEXITG,TCBABDMP  DUMP BEFORE ESTAEX REQUIRED ?@D64ADIS 00475000
         BO    INITERMB           YES, ACTIVATE DUMP ROUTINE   @D64ADIS 00476000
*SGLINK  INITERMB,INPUT=(R6,R8,R9,RA,RD)                                00477000
         CLI   TIBCNCL,NORMEOJ    IS IT EOJ?                   @D14BDFR 00478000
         BE    SETEOJSW           YES,DO NOT ACT.TERMINATOR    @D36IDFR 00479000
*SGLINK  SETEOJSW,INPUT=(R6,R8,RA,RB,RD)                                00480000
SKIPTEOJ DS    0H                                              @D61HDIS 00481000
         TM    TCBEXIFL,TCBEXIDU+TCBEXIMS DUMP OUTPUT WANTED ? @D64ADIS 00482000
         BNZ   INITERMB           YES, ACTIVATE DUMP ROUTINE   @D64ADIS 00483000
*SGLINK  INITERMB,INPUT=(R6,R8,R9,RA,RD)                                00484000
         TM    TCBEXIFL,TCBEXIND  STXIT OPTION=NODUMP ?        @D64ADIS 00485000
         BZ    INITERMB           NO, ACTIVATE DUMP ROUTINE    @D64ADIS 00486000
*SGLINK  INITERMB,INPUT=(R6,R8,R9,RA,RD)                                00487000
         CLI   TIBCNCL,CANCX17    IS IT MAINTASK CANCEL REQ.   @D14BDFR 00488000
         BE    INITERMB           YES, ACTIVATE TERMINATOR     @D61HDIS 00489000
*SGLINK  INITERMB,INPUT=(R6,R8,R9,RA,RD)                                00490000
         CLI   TIBCNCL,CANCX18    IS IT DUMP REQUEST           @D14BDFR 00491000
         BE    INITERMB           YES, ACTIVATE TERMINATOR     @D61HDIS 00492000
*SGLINK  INITERMB,INPUT=(R6,R8,R9,RA,RD)                                00493000
         CLI   TIBCNCL,CANCX23    IS IT SIMPLE CANCEL REQUEST  @D14BDFR 00494000
         BE    INITERMB           YES, ACTIVATE TERMINATOR     @D61HDIS 00495000
*SGLINK  INITERMB,INPUT=(R6,R8,R9,RA,RD)                                00496000
         DROP  R9                                              @D61HDIS 00497000
         EJECT ,                                               @D52VDIS 00498000
*--------------------------------------------------------------         00499000
* SETEOJSW - MAINTASK HAS TO PROPAGATE CANCEL OF SUBTASKS               00500000
*            ENTRY POINT AFTER DUMP PROCESS (RETURN FROM TERMRETB)      00501000
*--------------------------------------------------------------         00502000
*SGLINK  SETEOJSW,S,INPUT=(R6,R8,RA,RB,RD)                              00503000
SETEOJSW DS    0H                                              @D61NDIS 00504000
         LA    R1,CANCX1C         CODE FOR CANCEL ALL          @D36IDFR 00505000
         TM    TCBFLAG2,CNCLALL   CANCEL TO BE PROPAGATED?     @D36IDFR 00506000
         BO    CRDYCNCL           YES,GOTO PROPAGATE CANCEL    @D36IDFR 00507000
         CLC   TID(2),IJBHMTID    IS IT MAINTASK               @D51IDIS 00508000
         BNH   SETEOJSY           YES                          @D64ADIS 00509000
SETEOJMV DS    0H                                              @D64ADMS 00510000
         L     R9,ASGMVSAP        GET MVS API BASE ADDRESS     @D64ADIS 00511000
         USING SGMVSAPI,R9                                     @D64ADIS 00512000
         B     DETMVS             MVS DETACH                   @D64ADIS 00513000
         DROP  R9                                              @D64ADIS 00514000
SETEOJSY DS    0H                                              @D64ADIS 00515000
         CLC   TID,ARTIDH         IS IT MAIN-TASK              @D66ODOW 00516000
         BNH   CONTTERM           NO, DO NOT WAIT FOR SUBS     @D36IDFR 00517000
         CLC   PCBLCTSS-PCBADR(2,R9),H0   SUBTASK ATTACHED?    @D66ODOW 00518000
         BE    CONTTERM           NO,DO NOT PROPAGATE          @D36IDFR 00519000
         LA    R1,CANCX1D         CODE FOR MAINTASK TERMINATION@D36IDFR 00520000
CRDYCNCL DS    0H                                              @D64ADIS 00521000
         L     R9,PCBPTR          LOAD PCB POINTER             @D64ADIS 00522000
         BAL   R7,RDYCNCL         GOTO PROPAGATE CANCEL        @D64ADIS 00523000
*SGLINK  RDYCNCL,INPUT=(R1,R6,R7,R9),WORK=(R5,R8,RE,RF)                 00524000
         L     R8,TIBPTR          RELOAD TIB POINTER           @D36IDFR 00525000
         L     R9,PCBPTR          GET CURRENT PCB ADDRESS      @D64ADMS 00526000
         USING PCBADR,R9                                       @D64ADMS 00527000
         TM    PCBFLAG,PCBMVSEM   MVS EMULATION MODE ACTIVE ?  @D64ADMS 00528000
         DROP  R9                                              @D64ADMS 00529000
         BO    SETEOJMV           YES, CALL DETMVS             @D64ADMS 00530000
         EJECT ,                                               @D14BDIS 00531000
         SPACE 2                                               @D14BDIS 00532000
*********************************************************************** 00533000
*                                                                     * 00534000
* TERMINATOR:  REENTRY POINT OF PART 2 OF RESIDENT TERMINATOR ROUTINE * 00535000
*                                                                     * 00536000
*********************************************************************** 00537000
         SPACE 2                                               @D35EDFR 00538000
CONTTERM DS    0H                                              @D64ADIS 00539000
         NI    TCBEXITG,XFF-TCBABDMP RESET DUMP INDICATION     @D64ADIS 00540000
CONTT2ND DS    0H                                              @D64ADIS 00541000
         MVI   RID+1,SYSTEMID     INDICATE NO PAGE FAULTS      @D64ADIS 00542000
         L     R9,PCBPTR          LOAD PCB POINTER             @D64ADIS 00543000
         OI    TCBFLAG2,CNCLRTRN  TURN ON CANCEL RETURN FLAG   @D61NDIS 00544000
         OI    TIBFLAG,FETCHEOJ   TURN ON DISPATCH.EXIT FLAGS  @D61NDIS 00545000
         NI    TIBFLAG4,XFF-TIBDMPCN RESET INDICATION          @KX40960 00546000
         NI    TCBFLAG2,XFF-OPENSVA-CNCLALL                    @D14BDFR 00547000
         CLC   TID,ARTIDH         IS IT SYSTEM TASK            @D66ODOW 00548000
         BNH   CONTTER0           YES --->                     @D14BDFR 00549000
         NI    TIBFLAG1,XFF-SYSACT RESET PRIV.STATUS FLAG      @D14BDFR 00550000
*--------------------------------------------------------------         00551000
* CONTTER0 - QUIECE LTA'S I/O AND FREE LTA                              00552000
*--------------------------------------------------------------         00553000
CONTTER0 TM    TIBFLAG1,LTAOWNER  LTA OCCUPIED BY THIS TASK    @D36IDFR 00554000
         BZ    CONTTER1           NO --->                      @D36IDFG 00555000
         L     RC,ASVC03                                       @D36IDFR 00556000
         L     RD,IOSBASE         GET IOS BASE ADDRESS         @D51IDIS 00557000
         USING SVC03,RC                                        @D36IDFR 00558000
         BAL   R7,SVC03LTA        QUIESCE LTA I/O-S.           @D35EDFR 00559000
*SGLINK  SVC03LTA,INPUT=(R6,R7,R8,RA,RC,RD),WORK=(R1,R2,R3,R4,R5,RE,RF) 00560000
         L     RD,APBASE          GET SGAP BASE ADDRESS        @D51IDIS 00561000
         L     RC,CRADDR          LOAD COMREG POINTER          @D36IDFR 00562000
         USING COMREG,RC                                       @D36IDFR 00563000
         MVI   LIOCSCOM,ZERO      RESET LIOCSCOM BYTE 1        @D36IDFR 00564000
         MVI   LIOCSCOM+1,ZERO    RESET LIOCSCOM BYTE 2        @D36IDFR 00565000
         DROP  RC                                              @D36IDFR 00566000
         XC    IJBLPBDV,IJBLPBDV  REALLOW SCHEDULING OF DEVICE @DY44456 00567000
***                               ...AFTER CANCEL OF BUFFER-LOAD PHASE  00568000
         TM    TCBEXIFL,TCBEXIEX  ESTAEX EXIT ?                @D64ADIS 00569000
         BO    CONTTER1           YES, DELAY FREELTA INTO      @D64ADIS 00570000
***                               ...ESTAEX ACTIVATION                  00571000
         BAL   R7,FREELTA         FREE LOGICAL TRANSIENT AREA  @D35EDFR 00572000
*SGLINK  FREELTA,INPUT=(R6,R7,R8,RA),WORK=(R5,RE,RF)                    00573000
         EJECT ,                                               @D52VDIS 00574000
*--------------------------------------------------------------         00575000
* CONTTER1 - DO SPECIAL CLEAN UP FOR SVCS                               00576000
*--------------------------------------------------------------         00577000
CONTTER1 DS    0H                                              @D31ZDIS 00578000
***                               NAME/TOKEN SERVICE CANCELLED          00579000
         L     RC,ASVC79X         GET BASE OF NT-CLEANUP RTN   @D67CDOW 00580000
         USING SVC79,RC                                        @D67CDOW 00581000
         LA    R4,NT_CLEAN_P1     GET RTN ADDRESS              @D67CDOW 00582000
         O     R4,BIT0ON          FORCE 31 BIT MODE            @D67CDOW 00583000
         BASSM R4,R4              CALL ROUTINE                 @D67CDOW 00584000
         DROP  RC                                              @D67CDOW 00585000
         TM    TCBDYNFL,TCBDACT   IJBDCTL ROUTINE CANCELLED ?  @D51IDIS 00586000
         BZ    CONTTER3           NO, CONTINUE                 @D51IDIS 00587000
         L     RC,ASVC43          GET SVC 43 ADDRESS           @D51IDIS 00588000
         L     RF,AS43SVACL                                    @D66ODOW 00589000
         BASSM RF,RF              RESTORE SAVE AREA ADDRESS    @D66ODOW 00590000
*SGLINK S43SVACL,INPUT=(RA,RC,RF),WORK=(R2,R5,RE)              @D51IDIS 00591000
         LA    RF,CONTTER3        ENTER                        @D66ODOW 00592000
         BSM   0,RF               ... 24 BIT MODE              @D66ODOW 00593000
AS43SVACL DC   A(S43SVACL+X'80000000')                         @D66ODOW 00594000
CONTTER3 DS    0H                                              @D51IDIS 00595000
         TM    TCBEXIFL,TCBEXIEA+TCBEXIEX EARLY/ESTAEX EXIT ?  @D64ADIS 00596000
         BNZ   POSTABND           YES, ACIVATE IT              @D64ADIS 00597000
*--------------------------------------------------------------         00598000
* CONTTER4 - MAINTASK HAS TO WAIT FOR CANCEL OF SUBTASKS                00599000
*--------------------------------------------------------------         00600000
CONTTER4 DS    0H                                              @D64ADIS 00601000
         CLC   TID,ARTIDH         IS IT SYSTEM TASK            @D66ODOW 00602000
         BNH   CONTTER2           YES --->                     @D36IDFG 00603000
         TM    TCBFLAG2,TCBWSTT      THIS TASK MUST WAIT       @D64ADIS 00604000
         BO    CONTTERX           YES                          @D64ADIS 00605000
         CLC   TID(2),IJBHMTID    IS IT MAINTASK               @D51IDIS 00606000
         BH    CONTTER2           NO, DO NOT WAIT FOR SUBS     @D35EDFR 00607000
         L     R9,PCBPTR          LOAD PCB POINTER             @D36IDFR 00608000
         USING PCBADR,R9                                       @D36IDFR 00609000
         CLC   PCBLCTSS,H0        SUBTASK ATTACHED?            @D66ODOW 00610000
         BE    CONTTER2           NO,GOTO TERMINATE MAINTASK   @D36IDFR 00611000
         DROP  R9                                              @D14BDFR 00612000
CONTTER5 DS    0H                                              @D64ADIS 00613000
         NI    TCBFLAG2,XFF-TCBWSTT RESET FLAG BYTE            @D64ADIS 00614000
         L     R5,ASRQTAB         GET ADDRESS OF SRQTAB        @D61RDIS 00615000
         LA    R5,SRQCNCL-SRQTAB(,R5) INDICATE TASK CANCEL BND @D61RDIS 00616000
         LR    RF,R6              SETUP EXIT ADDRESS           @D36IDFR 00617000
         B     UNPOST             MAKE TASK UNDISPATCHABLE     @D36IDFR 00618000
*SGLINK  UNPOST,INPUT=(R5,R6,RF),WORK=(R5,RE)                           00619000
         SPACE 2                                               @D64ADIS 00620000
*--------------------------------------------------------------         00621000
* CONTTERX - WAIT FOR TERMINATION OF ATTACHED TASKS                     00622000
*--------------------------------------------------------------         00623000
CONTTERX DS    0H                                              @D64ADIS 00624000
         L     R9,ASGMVSAP        GET MVS API BASE ADDRESS     @D64ADIS 00625000
         USING SGMVSAPI,R9                                     @D64ADIS 00626000
         B     CONTTMVS                                        @D64ADIS 00627000
         DROP  R9                                              @D64ADIS 00628000
         EJECT ,                                               @D52VDIS 00629000
*--------------------------------------------------------------         00630000
* POSTABND - PROCESS AB EXIT ACTIVATION                                 00631000
*--------------------------------------------------------------         00632000
POSTABND DS    0H                                              @D61NDIS 00633000
         MVI   RID+1,REENTRID     IDENTIFY REENTRABLE ROUTINE  @D61NDIS 00634000
         NI    TCBFLAG2,XFF-CNCLRTRN                           @D14BDFR 00635000
         NI    TIBFLAG,XFF-FETCHEOJ RESET DISPATCHER EXIT FLAG @D36IDFR 00636000
         MVI   TIBCNCL2,ZERO      RESET SECOND CANCEL CODE     @D14BDFR 00637000
         CLC   TID(2),IJBHMTID    IS IT MAINTASK               @D51IDIS 00638000
         BH    POSTABN1           NO, DO NOT CHANGE JCL FLAG   @D61NDIS 00639000
         CLC   TID,ARTIDH         IS IT SYSTEM TASK            @D66ODOW 00640000
         BNH   POSTABN1           YES, DO NOT RESET EOJ IND    @D61NDIS 00641000
         L     R2,CRADDR          LOAD COMREG POINTER          @D14BDFR 00642000
         USING COMREG,R2                                       @D14BDFR 00643000
         NI    JCSW1,XFF-JOBEND   RESET END OF JOB FLAG        @D14BDFR 00644000
         DROP  R2                                              @D14BDFR 00645000
POSTABN1 DS    0H                                              @D61NDIS 00646000
         L     RD,ASGEXIT         GET BASE ADDR. OF AB EXIT INI@D64ADIS 00647000
         L     RD,ABROUTAD-SGEXIT(,RD) ...                     @D64ADIS 00648000
         BSM   0,RD                                            @D51HDOW 00649000
*SGLINK  ABROUT,INPUT=(R8,RA,RD)                                        00650000
         EJECT ,                                               @D52VDIS 00651000
*--------------------------------------------------------------         00652000
* CONTTER2 - ACTIVATE AB EXIT, IF AVAILABLE                             00653000
*--------------------------------------------------------------         00654000
         USING SGAP,RD                                         @D51HDOW 00655000
CONTTER2 MVI   RID+1,REENTRID     IDENTIFY REENTRABLE ROUTINE  @D35EDFR 00656000
*        AMODESW SET,AMODE=31,WR=(14)                          @D64XDIS 00657000
         AMODESW SET,AMODE=31,WR=(14)                          @D64XDIS 00658000
         CLI   TIBCNCL,NORMEOJ    IS IT EOJ?                   @D36IDFR 00659000
         BE    RESRESET           YES,GOTO RESET RESOURCES     @D36IDFR 00660000
         CLI   TIBCNCL,CANCX17    IS IT MAINTASK CANCEL REQ.   @D14BDFR 00661000
         BE    RESRESET           YES, DO NOT ACTIVATE AB ROUT.@D36IDFR 00662000
         CLI   TIBCNCL,CANCX18    IS IT DUMP REQUEST           @D14BDFR 00663000
         BE    RESRESET           YES, DO NOT ACTIVATE AB ROUT.@D36IDFR 00664000
         CLI   TIBCNCL,CANCX23    IS IT SIMPLE CANCEL REQUEST  @D14BDFR 00665000
         BE    RESRESET           YES, DO NOT ACTIVATE AB ROUT.@D36IDFR 00666000
         TM    TCBEXIFL,TCBEXIMS+TCBEXIND+TCBEXIDU AB EXIT ?   @D64ADIS 00667000
         BNZ   POSTABND           YES, ACIVATE IT              @D64ADIS 00668000
         L     R3,TCBECB                                       @D36IDFR 00669000
         LTR   R3,R3              IS THERE AN ECB?             @D36IDFR 00670000
         BZ    RESRESET           NO,GOTO RESET RESOURCES      @D369DFR 00671000
         BM    RESRESET           YES, BUT MVS ECB             @D64ADIS 00672000
         OI    2(R3),ABNECB       POST ATTACHMENT ECB ABNORM.  @D36IDFR 00673000
*        B     RESRESET           GOTO RESET RESOURCES         @D61NDIS 00674000
         EJECT ,                                               @D14BDIS 00675000
         SPACE 2                                               @D14BDIS 00676000
*********************************************************************** 00677000
*                                                                     * 00678000
* TERMINATOR: RESET FLAGS, FREE RESOURCES                             * 00679000
*                                                                     * 00680000
*********************************************************************** 00681000
         SPACE 2                                               @D35EDFR 00682000
RESRESET DS    0H                 CLEAR EXIT INFORMATION       @D61PDOW 00683000
*--------------------------------------------------------------         00684000
*          - SAVE CONTROL REGISTERS INTO SAACOMM                        00685000
*            AND SET UP HOME SPACE ENVIRONMENT                          00686000
*            AMODE 31                                                   00687000
*--------------------------------------------------------------         00688000
         L     R4,SCBPTR          GET SCB ADDRESS              @D64XDIS 00689000
         USING SCBADR,R4                                       @D64XDIS 00690000
         L     R2,TCBATCBE        GET SYS TASK TCB EXT         @D64XDIS 00691000
         USING TCBXADR,R2         ADDR SYS. TASK TCB EXT.      @D64XDIS 00692000
         MVC   TCBX1CR1,SCBRSTO                                @D64XDIS 00693000
         MVC   TCBX1CR7,SCBRSTO                                @D64XDIS 00694000
         MVC   TCBX1CRD,SCBRSTO                                @D64XDIS 00695000
         DROP  R4                                              @D64XDIS 00696000
         L     R5,PCBPTR          POINT TO PART.CONTR.BLOCK    @D64XDIS 00697000
         USING PCBADR,R5                                       @D64XDIS 00698000
         LH    R4,PCBPIK                                       @D64XDIS 00699000
         SRL   R4,4               ASN = PIK /16                @D64XDIS 00700000
         STH   R4,TCBX1CR3+2                                   @D64XDIS 00701000
         STH   R4,TCBX1CR4+2                                   @D64XDIS 00702000
         DROP  R2                                              @D64XDIS 00703000
         DROP  R5                                              @D64XDIS 00704000
*        AMODESW SET,AMODE=24,WR=(14)                          @D64XDIS 00705000
         AMODESW SET,AMODE=24,WR=(14)                          @D64XDIS 00706000
         EJECT ,                                               @D14BDIS 00707000
*--------------------------------------------------------------         00708000
*          - RESET USER EXITS                                           00709000
*            AMODE 24                                                   00710000
*--------------------------------------------------------------         00711000
         CLC   TID,ARTIDH         IS IT SYSTEM TASK            @D66ODOW 00712000
         BNH   JSTEPEN2           YES,GOTO COMPLETE SYSTSK PROC@D64ADIS 00713000
         MC    $TRCAN1,$MCSDAID   CALL SDAID CANCEL TRACE      @D35ADFR 00714000
         CLC   TID(2),IJBHMTID    IS IT MAINTASK               @D51IDIS 00715000
         BH    JSTEPEN2           NO,GOTO COMPLETE SUBTSK PROCE@D64ADIS 00716000
         L     R2,CRADDR          LOAD COMREG POINTER          @D14BDFR 00717000
         USING COMREG,R2                                       @D14BDFR 00718000
         NI    JCSW8,XFF-IJBSKPAB RESET INDICATION             @D64ADIS 00719000
         CLI   TIBCNCL2,ZERO      IS IT DOUBLE CANCEL          @D14BDFR 00720000
         BNE   FLAGEOJ            YES,INDICATE END OF JOB      @D14BDFR 00721000
         CLI   TIBCNCL,NORMEOJ    IS IT SIMPLE EOJ REQUEST?    @D36IDFR 00722000
         BE    JSTEPEND           YES,INDICATE END OF JOB STEP @D35EDFR 00723000
         CLI   TIBCNCL,CANCX18    IS IT DUMP REQUEST?          @D36IDFR 00724000
         BE    JSTEPEND           YES,DO NOT CHANGE EOJ INDIC. @D35EDFR 00725000
FLAGEOJ  OI    JCSW1,JOBEND       TURN ON END OF JOB FLAG      @D14BDFR 00726000
JSTEPEND ICM   R2,15,JAPART       POINT TO JA TABLE, AVAIL. ?  @D51IDIS 00727000
         BZ    JSTEPEN1           NO, SKIP UPDATE              @D51IDIS 00728000
         USING ACCTABLE,R2        STORE TERMINATION CODE INTO  @D14BDFR 00729000
         MVC   ACCTCNCL(L1),TIBCNCL   JOB ACCOUNTING TABLE     @D36IDFR 00730000
         DROP  R2                                              @D61NDIS 00731000
JSTEPEN1 DS    0H                                              @D51IDIS 00732000
         L     RD,ASGEXIT         GET EXIT BASE ADDRESS        @D61CSIS 00733000
         USING SGEXIT,RD                                       @D61CDIS 00734000
         BAS   R5,OCCLEAN         CLEAN UP OF OC EXIT          @D64ADIS 00735000
*SGLINK  OCCLEAN,INPUT=(R5,RA,RD),WORK=(R0,R1,RF)                       00736000
         L     RD,APBASE          REESTABLISH SGAP BASE        @D61CSIS 00737000
         USING SGAP,RD                                         @D61CSIS 00738000
JSTEPEN2 DS    0H                                              @D64ADIS 00739000
         L     R9,ASGEXIT         GET SGEXIT BASE ADDRESS      @D64ADIS 00740000
         L     R5,ARESEXIT-SGEXIT(,R9) GET ROUTINE ADDR        @D64ADIS 00741000
         BASSM R9,R5              RESET AB/IT/PC EXITS         @D64ADIS 00742000
*SGLINK RESEXIT,INPUT=(R5,R9,RA)                                        00743000
         L     RC,ASVC79X         GET BASE OF NT-CLEANUP RTN   @D67CDOW 00744000
         USING SVC79,RC                                        @D67CDOW 00745000
         LA    R7,NT_CLEAN_P2     GET RTN ADDRESS              @D67CDOW 00746000
         O     R7,BIT0ON          FORCE 31 BIT MODE            @D67CDOW 00747000
         BASSM R7,R7              CALL ROUTINE                 @D67CDOW 00748000
         DROP  RC                                              @D67CDOW 00749000
*        B     ENDTERM                                                  00750000
*SGLINK  ENDTERM,INPUT=(R6,R8,RA,RD),WORK=(R1,R5,R7,RB,RC,RE,RF)        00751000
 TITLE 'VSE SUPERVISOR   SGAP            END-OF-TASK CLEAN UP ROUTINES' 00752000
*********************************************************************** 00753000
*                                                                     * 00754000
* TERMINATOR:  PROCESS EOJ TRANSIENTS AND SVA RESIDENT EOT ROUTINE    * 00755000
*                                                                     * 00756000
*********************************************************************** 00757000
         SPACE 2                                               @D35EDFR 00758000
*SGLINK  ENDTERM,S,INPUT=(R6,R8,RA,RD),WORK=(R1,R5,R7,RB,RC,RE,RF)      00759000
ENDTERM  MVI   RID+1,REENTRID     IDENTIFY REENTRABLE ROUTINE  @D36BDFR 00760000
         NI    TCBFLAG2,XFF-CNCLRTRN-SVPCCNCL RESET TERM.RETURN@D64ADMS 00761000
*                                 AND SPECIAL SAVE AREA FLAG   @D64ADMS 00762000
         NI    TIBFLAG,XFF-FETCHEOJ RESET DISPATCHER EXIT FLAG @D14BDFR 00763000
*--------------------------------------------------------------         00764000
*          - SET UP HOME SPACE ENVIRONMENT                              00765000
*--------------------------------------------------------------         00766000
*        AMODESW SET,AMODE=31,WR=(2)                           @D64XDIS 00767000
         AMODESW SET,AMODE=31,WR=(2)                           @D64XDIS 00768000
         L     R2,TCBATCBE        GET SYS TASK TCB EXT         @D64XDIS 00769000
         USING TCBXADR,R2         ADDR SYS. TASK TCB EXT.      @D64XDIS 00770000
         L     R5,SCBPTR          GET SCB ADDRESS              @D64XDIS 00771000
         USING SCBADR,R5                                       @D64XDIS 00772000
         MVC   TCBX1CR1,SCBRSTO                                @D64XDIS 00773000
         MVC   TCBX1CR7,SCBRSTO                                @D64XDIS 00774000
         MVC   TCBX1CRD,SCBRSTO                                @D64XDIS 00775000
         L     R5,PCBPTR          GET PCB ADDRESS              @D64XDIS 00776000
         USING PCBADR,R5                                       @D64XDIS 00777000
         LH    R5,PCBPIK                                       @D64XDIS 00778000
         DROP  R5                                              @D64XDIS 00779000
         SRL   R5,4               ASN = PIK /16                @D64XDIS 00780000
         STH   R5,TCBX1CR3+2                                   @D64XDIS 00781000
         STH   R5,TCBX1CR4+2                                   @D64XDIS 00782000
         DROP  R2                                              @D64XDIS 00783000
*        AMODESW SET,AMODE=24,WR=(2)                           @D64XDIS 00784000
         AMODESW SET,AMODE=24,WR=(2)                           @D64XDIS 00785000
         EJECT ,                                               @D64XDIS 00786000
*                                                                       00787000
*--------------------------------------------------------------         00788000
* $IJBLSTK  - GIVE TASK EMPTY LINKAGE STACK                             00789000
*             INPUT:  R8 - TIB ADDRESS                                  00790000
*                     RA - TCB ADDRESS                                  00791000
*                     RE - RETURN ADDRESS                               00792000
*                     RC - $IJBLSTK BASE ADDRESS                        00793000
*                     RF - FUNCTION CODE (=4)                           00794000
*             AMODE:  31                                                00795000
*             $IJBLSTK WILL LOAD A NEW LINKAGE STACK ADDRESS            00796000
*             INTO CONTROL REGISTER 15 AND HAS TO                       00797000
*             RETURN WITH THE AMODE OF THE CALLER                       00798000
*--------------------------------------------------------------         00799000
         STM   R0,RF,SVCWORK      SAVE REGISTER                @D64XDIS 00800000
         L     RC,ASVASVDL        PTR.TO SVA ROUT.ADDR.TABLE   @D61PDOW 00801000
         L     RC,AIJBLSTK-SVASVDL(,RC) GET ROUTINE ADDRESS    @D61PDOW 00802000
         LA    RF,4               SET UP FUNCTION CODE         @D61PDOW 00803000
         OI    TIBFLAG4,TIBDSAPA  SET DATA SPACE APPENDAGE ACT.@D61PDOW 00804000
         BASSM RE,RC              CALL ROUTINE                 @D64ADIS 00805000
         LM    R0,RF,SVCWORK      SAVE REGISTER                @D61PDOW 00806000
         NI    TIBFLAG4,XFF-TIBDSAPA  RESET ACTIVE INDICATION  @D61PDOW 00807000
         SPACE 2                                               @D64XDIS 00808000
*--------------------------------------------------------------         00809000
*           - CROSS-MEMORY CLEAN-UP                                     00810000
*--------------------------------------------------------------         00811000
         CLC   TID(2),IJBHMTID    IS IT MAINTASK               @DY46432 00812190
         BH    ENDTERMX           NO,BRANCH AROUND MAINT.PROC. @DY46432 00812380
         L     RC,ASVASVDL        PTR.TO SVA ROUT.ADDR.TABLE   @D64XDIS 00812570
         ICM   RC,15,AIJBXCUP-SVASVDL(RC)  GET ROUTINE ADDRESS @D64XDIS 00813000
         BZ    XMEMNOCL           NOT AVAILABLE -->>           @DY46432 00814490
         SR    RF,RF              SET UP FUNCTION CODE         @D64XDIS 00815000
         OI    TIBFLAG4,TIBDSAPA  SET DATA SPACE APPENDAGE ACT.@D64XDIS 00816000
         BASSM RE,RC              CALL ROUTINE                 @D64XDIS 00817000
XMEMNOCL DS    0H                                              @DY46432 00817500
         LM    R0,RF,SVCWORK      SAVE REGISTER                @D64XDIS 00818000
         NI    TIBFLAG4,XFF-TIBDSAPA  RESET ACTIVE INDICATION  @D64XDIS 00819000
         EJECT ,                                               @D61NDIS 00820000
*--------------------------------------------------------------         00821000
* ENDTERMX - CONSOLE SUPPORT CLEAN UP                                   00822000
*--------------------------------------------------------------         00823000
ENDTERMX DS    0H                                              @D61PDIS 00824000
         L     RD,DOCBASE         GET CONSOLE SUPPORT BASE     @D61CDIS 00825000
         USING SGDOC,RD                                        @D61CDIS 00826000
         BAL   RE,DOCEOT          CALL CLEAN UP ROUTINE        @D61CDIS 00827000
         DROP  RD                                              @D61CDIS 00828000
         L     RD,APBASE          GET SGAP BASE ADDRESS        @D61CDIS 00829000
         USING SGAP,RD                                         @D61CDIS 00830000
         L     R8,TIBPTR          RESTORE TIB POINTER          @D37CDFG 00831000
         L     RA,TCBPTR          RESTORE TCB POINTER          @D61CDIS 00832000
         L     RC,ASVASVDL        PTR.TO SVA ROUT.ADDR.TABLE   @D14BDFR 00833000
         USING SVASVDL,RC                                      @D14BDFR 00834000
         L     RB,TCBSAVE         LOAD SAVE AREA POINTER       @D14BDFR 00835000
         L     R5,PCBPTR          POINT TO PART.CONTR.BLOCK    @D14BDFR 00836000
         USING PCBADR,R5                                       @D14BDFR 00837000
         L     R7,CRADDR          POINT TO PART.COMM.REGION    @D36BDFR 00838000
         USING COMREG,R7                                       @D36BDFR 00839000
         L     R1,TCBEOTAD        LOAD CONTINUATION ADDRESS    @D14BDFR 00840000
         LTR   R1,R1              AND                          @D14BDFR 00841000
         BNZR  R1                 GOTO CONTINUE EOT PROCESSING @D14BDFR 00842000
         OI    TIBFLAG1,EOTINPR   INDICATE EOT CLEANUP IN PROC.@D14BDFR 00843000
*--------------------------------------------------------------         00844000
*          - TRACE CLEAN UP                                             00845000
*--------------------------------------------------------------         00846000
         CLC   TID(2),IJBHMTID    IS IT MAINTASK               @D61HDIS 00847000
         BH    ENDTERNM           NO,BRANCH AROUND MAINT.PROC. @D61HDIS 00848000
         L     R9,ATERMBAS        GET COMMON BASE ADDR         @D61HDIS 00849000
         USING TERMBASE,R9        ESTABLISH BASE               @D61HDIS 00850000
         CLC   PCBATRAX,F0        TRACE ACTIVE ?               @KXA0065 00851000
         BNE   TERMSTOP           YES, STOP PARTITION TRACE    @KXA0065 00852000
*SGLINK  TERMSTOP,INPUT=(R6,R8,R9,RA,RD)                                00853000
         DROP  R9                                              @D61HDIS 00854000
*--------------------------------------------------------------         00855000
*          - DB2 CLEAN UP (MAIN-TASK ONLY)                              00856000
*--------------------------------------------------------------         00857000
         L     R9,PCBAPCBX        GET ADDR OF PCB-EXTENSION    @D65CDOW 00858000
         L     RE,AENDTERMY                                    @D65CDOW 00859000
         BSM   0,RE               ENTER 31 BIT MODE            @D65CDOW 00860000
AENDTERMY DC   A(ENDTERMY+X'80000000')                         @D65CDOW 00861000
ENDTERMY DS    0H                                              @D65CDOW 00862000
         USING PCBXADR,R9                                      @D65CDOW 00863000
         ICM   RE,15,PCBXDB2C     GET ENTRY TO DB2-CLEANUP-RTN @D65CDOW 00864000
         BZ    ENDTERNL           NOT AVAILABLE --->           @D65CDOW 00865000
         L     R1,TCBATCBE        GET TCB EXTENSION            @DY46455 00865200
         USING TCBXADR,R1                                      @DY46455 00865400
         OI    TCBXFLG2,TCBXDB2C  ALLOW XMOVE IN TASK TERM.    @DY46455 00865600
         DROP  R1                 RELEASE TCB EXTENSION        @DY46455 00865800
         L     R1,PCBXDB2A        GET DB2-MAIN-CB              @D65CDOW 00866000
         XC    PCBXDB2C,PCBXDB2C  CLEAR DB2                    @D65CDOW 00867000
         XC    PCBXDB2A,PCBXDB2A  ... FIELDS IN PCBX           @D65CDOW 00868000
         DROP  R9                                              @D65CDOW 00869000
         LA    R9,CALLEOTR        SET CONTINUATION ADDR        @D65CDOW 00870000
***                               ...AND FORCE 24BIT MODE               00871000
         ST    R1,SVER0A          PASS ADDR TO CLEANUP RTN     @D65CDOW 00872000
         SLR   R1,R1              INIT NO CONTINUATION ADDRESS @D65CDOW 00873000
         BSM   0,R9               GOTO ACTIVATE RTN            @D65CDOW 00874000
ENDTERNL DS    0H                                              @D65CDOW 00874100
         L     R9,TCBATCBE        GET TCB EXTENSION            @DY46449 00874200
         USING TCBXADR,R9                                      @DY46449 00874300
         NI    TCBXFLG2,XFF-TCBXDB2C RESET DB2 CLEANUP ACTIVE  @DY46449 00874400
         DROP  R9                 RELEASE TCB EXTENSION        @DY46449 00874500
         EJECT ,                                               @D52VDIS 00875000
*--------------------------------------------------------------         00876000
* ENDTERNM - VTAM CLEAN UP                                              00877000
*--------------------------------------------------------------         00878000
         LA    R9,ENDTERNM        ENTER                        @D65CDOW 00880000
         BSM   0,R9               ..... 24BIT MODE             @D65CDOW 00881000
ENDTERNM DS    0H                                              @D61HDIS 00882000
         MVI   TIBTFLAG,ZERO      RESET TRACE INDICATORS       @D61HDIS 00883000
         L     RE,AVTAMEOT        ADDRESS OF VTAM CLEANUP ROUT.@D64ADIS 00884000
         L     R9,IJBTCAVT        POINT TO VTAM VECTOR         @D61PDIS 00885000
         USING ISTAVT,R9                                       @D61PDIS 00886000
         CLC   TID(2),ISTTSKID    VTAM MAIN TASK TERMINATING   @D61PDIS 00887000
         BNE   TSTVTOPN           SKIP IF NOT                  @D36IDFG 00888000
         NI    IJBTCAVT,XFF-IJBTCACT MARK VTAM ...             @D61PDIS 00889000
         MVC   ISTTSKID(2),H0                  ... INACTIVE    @D61PDIS 00890000
         DROP  R9                                              @D61PDIS 00891000
TSTVTOPN DS    0H                                              @D64ADIS 00892000
         LA    R1,RESVTOPN        SET UP CONTINUATION ADDRESS  @D64ADIS 00893000
         LTR   RE,RE              IS CLEANUP ROUTINE AVAILABLE @D64ADIS 00894000
         BNZ   CALLEOTR           YES,GOTO ACTIVATE ROUTINE    @D64ADIS 00895000
         LA    R1,0               REDRIVE VTAM CLEANUP PROCESS @D64ADIS 00896000
         TM    TIBFLAG2,VTOPEN    VTAM ACTIVE FOR THIS TASK    @D64ADIS 00897000
         BZ    RESVTAOT           NO  --->                     @D36BDFR 00898000
         TM    IJBTCAVT,IJBTCACT  VTAM INACTIVE ?              @D61PDIS 00899000
         BZ    RESVTOPN           NO, SKIP VTAM CLEAN UP       @D61PDIS 00900000
         LA    RE,$STCNL          MOVE NAME OF TRANSIENT       @DA38731 00901000
         B     SIMSVC02           LOAD AND EXECUTE             @D14BDFR 00902000
RESVTOPN NI    TIBFLAG2,XFF-VTOPEN RESET VTAM USER FLAG        @D14BDFR 00903000
         NI    TIBFLAG,XFF-APSEXFLG RESET VTAM APS EXIT FLAG   @DY32827 00904000
RESVTAOT XC    AOTADR(16),AOTADR  RESET TASKS AOT ENTRY        @D36BDFR 00905000
         NI    TIBFLAG3,XFF-VTDELCKU RESET ISTAPCKU DELAY IND. @DY36477 00906000
         EJECT ,                                               @D64ADIS 00907000
*--------------------------------------------------------------         00908000
*          - CICS MAINTASK CLEAN UP                                     00909000
*--------------------------------------------------------------         00910000
         CLC   TID(2),IJBHMTID    IS IT MAINTASK               @D52VDIS 00911000
         BH    CICSEOTX           NO,BRANCH AROUND MAINT.PROC. @D52VDIS 00912000
         TM    PCBSSFLG,CICS      IS IT CICS MAIN CTL.TASK     @D52VDIS 00913000
         BZ    CICSEOTX                                        @D14BDFR 00914000
         LA    R1,CICSEOTR        EXIT ADDRESS AFTER CLEANUP   @D14BDFR 00915000
         L     RE,ACICSEOT        ADDRESS OF CICS CLEANUP ROUT.@D14BDFR 00916000
         LTR   RE,RE              IS CLEANUP ROUTINE AVAILABLE @D14BDFR 00917000
         BNZ   CALLEOTR           YES,GOTO ACTIVATE ROUTINE    @D14BDFR 00918000
CICSEOTR DS    0H                                              @D52VDIS 00919000
         NI    PCBSSFLG,XFF-CICS  RESET CICS SUBSYSTEM FLAG    @D14BDFR 00920000
         EJECT ,                                               @D52VDIS 00921000
*--------------------------------------------------------------         00922000
* CICSEOTX - DL/I CLEAN UP                                              00923000
*--------------------------------------------------------------         00924000
CICSEOTX TM    TCBFLAG3,DLIMT     IS IT DL/I MAINTASK          @D14CDFG 00925000
         BZ    DLIEOTX            NO --->                      @D14BDFR 00926000
         LA    R1,DLIEOTR         EXIT ADDRESS AFTER CLEANUP   @D14BDFR 00927000
         ICM   RE,15,ADLIEOT      ADDRESS OF DL/I CLEANUP ROUT.@D67BDOW 00928000
         BNZ   CALLEOTR           AVAIL, GOTO ACTIVATE ROUTINE @D14BDFR 00929000
DLIEOTR  NI    TCBFLAG3,XFF-DLIMT RESET DL/I SUBSYSTEM FLAG    @D14CDFG 00930000
*--------------------------------------------------------------         00931000
* DLIEOTX  - 3800 PRINTER CLEAN UP                                      00932000
*--------------------------------------------------------------         00933000
DLIEOTX  TM    DEVFLG1,OPN3800+IJBACRPR  PRINTER OPENED        @D21DDIS 00934000
         BZ    NOAPRTOP           NO  --->                     @D14BDIS 00935000
         SR    R1,R1              RESET TASKS R0               @D14BDIS 00936000
         ST    R1,SVER00                                       @D14BDIS 00937000
         LA    RE,$PCLOS          MOVE NAME OF TRANSIENT       @DA38731 00938000
         BAL   R1,SIMSVC02        LOAD AND EXECUTE             @D36BDIS 00939000
*--------------------------------------------------------------         00940000
* NOAPRTOP - EZA API CLEANUP                                            00941000
.* DURING EZA CLEANUP IN A PARTITION, THE TCPIP PARTITION IS CALLED     00941100
.* FOR CLEANUP. AFTER COMPLETION, TCPIP POSTS THE EZA CLEANUP ROUTINE.  00941200
.* SINCE WE ARE IN TASK TERMINATION, TCBXEZAC IS SET TO ALLOW THE       00941300
.* XMOVE POST FUNCTION. THE TCPIP HOOK IN THE EZA CLEANUP ROUTINE,      00941400
.* THAT COMMUNICATES WITH THE TCPIP PARTITION, SETS A TIMER. SO IN      00941500
.* CASE THE XMOVE POST DOES NOT TAKE PLACE, THE CLEANUP ROUTINE ENDS    00941600
.* CAUSED BY THE TIMER. OTHERWISE THE TASK WOULD WAIT FOREVER.          00941700
.* SINCE AT THIS POINT IN TASK TERMINATION CANCEL IS NOT POSSIBLE,      00941800
.* THERE WOULD BE NO CHANCE TO TERMINATE THE TASK/PARTITION.            00941900
*--------------------------------------------------------------         00942000
NOAPRTOP DS    0H                                              @D67BDOW 00943000
         ICM   RE,15,IJBEZAPA    EZA API ACTIVE                @D68IDMZ 00944590
         BZ    NOEZAACL          NO, SKIP CLEANUP              @D68IDMZ 00945180
         L     R1,TCBATCBE       GET TCBX                      @D68IDMZ 00945770
         OI    TCBXFLG2-TCBXADR(R1),TCBXEZAC EZA CLEANUP ACTIVE@D68IDMZ 00946360
         LA    R1,DOEZACL        EXIT ADDRESS AFTER CLEANUP    @D68IDMZ 00946950
         ICM   RE,15,AIJBEZAC    GET ADDR OF CLEANUP ROUTINE   @D68IDMZ 00947540
         BNZ   CALLEOTR          YES,GOTO ACTIVATE ROUTINE     @D68IDMZ 00948130
DOEZACL  DS    0H                                              @D68IDMZ 00948720
         L     R1,TCBATCBE       RESET EZA CLEANUP ACTIVE..    @D68IDMZ 00949310
         NI    TCBXFLG2-TCBXADR(R1),X'FF'-TCBXEZAC ..INDICATION@D68IDMZ 00949900
         CLC   TID(2),IJBHMTID   IS IT MAINTASK                @D68IDMZ 00950490
         BH    NOEZAACL          NO, DO NOT RESET EZA ANCHOR   @D68IDMZ 00951080
         SR    R1,R1             MAINTASK ..                   @D68IDMZ 00951670
         ST    R1,IJBEZAPA       .. RESET EZA PART ANCHOR      @D68IDMZ 00952260
*--------------------------------------------------------------         00954000
* NOEZAACL - OSA EXPRESS CLEANUP                                        00955000
*--------------------------------------------------------------         00956000
NOEZAACL DS    0H                                              @D61IDIS 00957000
         CLI   TCBNOSAX,X00      DOES TASK OWN AN OSAX CARD    @D67BDOW 00958000
         BE    NOOSAXCL          NO, SKIP CLEAN-UP             @D67BDOW 00959000
         LA    R1,DOSAXCL        EXIT ADDRESS AFTER CLEANUP    @D67BDOW 00960000
         ICM   RE,15,AIJBOSAX    CLEAN UP ROUTINE AVAILABLE    @D67BDOW 00961000
         BNZ   CALLEOTR          YES,GOTO ACTIVATE ROUTINE     @D67BDOW 00962000
DOSAXCL  MVI   TCBNOSAX,X00      CLEAN UP DONE                 @D67BDOW 00963000
*--------------------------------------------------------------         00964000
* NOOSAXCL - REXX CLEAN UP                                              00965000
*--------------------------------------------------------------         00966000
NOOSAXCL DS    0H                                              @D68IDMZ 00967490
*        AMODESW SET,AMODE=31,WR=(14)                          @D61PDIS 00968000
         AMODESW SET,AMODE=31,WR=(14)                          @D61PDIS 00969000
         L     R1,TCBATCBE        GET ADDR. OF TCB EXTENSION   @D61IDIS 00970000
         USING TCBXADR,R1                                      @D61IDIS 00971000
         XC    TCBXRXEO(4),TCBXRXEO  CLEAR REXX ANCHOR         @D61IDIS 00972000
         DROP  R1                                              @D61IDIS 00973000
*        AMODESW SET,AMODE=24,WR=(14)                          @D61PDIS 00974000
         AMODESW SET,AMODE=24,WR=(14)                          @D61PDIS 00975000
         EJECT ,                                               @D52VDIS 00976000
*--------------------------------------------------------------         00977000
*          - MAINTASK CLEAN UP ROUTINES                                 00978000
*--------------------------------------------------------------         00979000
         CLC   TID(2),IJBHMTID    IS IT MAINTASK               @D51IDIS 00980000
         BH    NOMTEOJ            NO,BRANCH AROUND MAINT.PROC. @D14BDFR 00981000
         NI    DEVFLG1,XFF-OPN3800-IJBACRPR  RESET INDICATOR   @D21DDIS 00982000
         NI    TIBFLAG2,XFF-PWRMTASK                           @D36BDFR 00983000
*--------------------------------------------------------------         00984000
* OLTEPAGN - OLTEP CLEAN UP                                             00985000
*--------------------------------------------------------------         00986000
OLTEPAGN TM    IJBOLTEP,MAKENEG   IS IT OLTEP                  @DY37776 00987000
         BNO   NOOLTLTA           NO  --->                     @D36BDFR 00988000
         CLC   OLTPIK+1(1),PCEKEY                              @D51IDIS 00989000
         BNE   NOOLTLTA                                        @D36BDFR 00990000
         LA    RE,$TOLTP          MOVE NAME OF TRANSIENT       @DA38731 00991000
         LA    R1,OLTEPAGN        LOAD RETURN ADDRESS          @DY37776 00992000
         B     SIMSVC02           CALL OLTEP TERMINATION ROUT  @DY37776 00993000
*--------------------------------------------------------------         00994000
* NOOLTLTA - TAPE CLEAN UP                                              00995000
*--------------------------------------------------------------         00996000
NOOLTLTA TM    IJBIJJT,TAPEOPND   TAPE OPENED                  @D51HDOW 00997000
         BZ    IJJTEOTX           NO, --->                     @D14BDFR 00998000
         LA    R1,IJJTEOTR        EXIT ADDRESS AFTER CLEANUP   @D14BDFR 00999000
         L     RE,AIJJTEOT        ADDRESS OF ICCF CLEANUP ROUT.@D14BDFR 01000000
         LTR   RE,RE              IS CLEANUP ROUTINE AVAILABLE @D14BDFR 01001000
         BNZ   CALLEOTR           YES,GOTO ACTIVATE ROUTINE    @D14BDFR 01002000
IJJTEOTR NI    IJBIJJT,XFF-TAPEOPND RESET TAPE OPEN INDICATOR  @D51HDOW 01003000
*--------------------------------------------------------------         01004000
* IJJTEOTX - RESET DSPACE VALUE                                         01005000
*--------------------------------------------------------------         01006000
IJJTEOTX DS    0H                                              @D52VDIS 01007000
         XC    PCBDSPAC(4),PCBDSPAC CLEAR DSPACE VALUE         @D61HDIS 01008000
         EJECT ,                                               @D52VDIS 01009000
*--------------------------------------------------------------         01010000
* NOMTEOJ  - ICCF MAINTASK CLEAN UP (NO RUNNING IN A SUBTASK)           01011000
*--------------------------------------------------------------         01012000
NOMTEOJ  DS    0H                                              @D52VDIS 01013000
         TM    TCBFLAG3,ICCFMT    IS IT ICCF MAINTASK          @D52VDIS 01014000
         BNO   NOICCFP            NO  --->                     @D31EMIS 01015000
         LA    RE,$DTS04          MOVE NAME OF TRANSIENT       @DA38731 01016000
         BAL   R1,SIMSVC02        LOAD AND EXECUTE             @D36GDFR 01017000
         NI    TCBFLAG3,XFF-ICCFMT RESET ICCF SUBSYSTEM FLAG   @D52VDIS 01018000
         NI    PCBSSFLG,XFF-ICCF  RESET ICCF SUBSYSTEM FLAG    @D52VDIS 01019000
*--------------------------------------------------------------         01020000
* NOICCFP  - SOEMI CLEAN UP                                             01021000
*--------------------------------------------------------------         01022000
NOICCFP  DS    0H                                              @D21EMIS 01023000
         TM    TCBFLAG3,SOEMI     SOEMI SUBSYSTEM ACTIVE       @D52VDIS 01024000
         BZ    VSAMEOT            NO  --->                     @DY34091 01025000
         LA    R1,SOEMEOT         EXIT ADDRESS FOR CLEANUP ROUT@DY34091 01026000
         L     RE,ASOEMEOT        ADDR. OF SOEMI CLEANUP ROUT. @DY34091 01027000
         LTR   RE,RE              IS CLEANUP ROUTINE AVAILABLE @DY34091 01028000
         BNZ   CALLEOTR           YES,GOTO ACTIVATE ROUTINE    @DY34091 01029000
SOEMEOT  NI    TCBFLAG3,XFF-SOEMI RESET SOEMI SUBSYSTEM FLAG   @DY34091 01030000
*--------------------------------------------------------------         01031000
* VSAMEOT  - VSAM CLEAN UP                                              01032000
*--------------------------------------------------------------         01033000
VSAMEOT  DS    0H                                              @D61CDIS 01034000
         CLC   TID,ARTIDH         IS IT SYSTEM TASK            @D66ODOW 01035000
         BNH   NOVSYS             YES, DO NOT PROCESS ACLOSE   @D61CDIS 01036000
         TM    TCBFLAGS,VSMOPEN   VSAM OPEN ACTIVE             @D61CDIS 01037000
         BZ    RESVSMFL           NO  --->                     @D36BDFR 01038000
         LA    R1,RESVSMFL        EXIT ADDRESS FOR CLEANUP ROUT@D14BDFR 01039000
         L     RE,AVSAMEOT        ADDRESS OF VSAM CLEANUP ROUT.@D14BDFR 01040000
         LTR   RE,RE              IS CLEANUP ROUTINE AVAILABLE @D14BDFR 01041000
         BNZ   CALLEOTR           YES,GOTO ACTIVATE ROUTINE    @D14BDFR 01042000
         LA    RE,4               SET 4 INTO TASKS REGISTER RF @D36BDFR 01043000
         ST    RE,SVER0F                                       @D36BDFR 01044000
         LA    RE,$ACLOS          MOVE NAME OF TRANSIENT       @DA38731 01045000
         B     SIMSVC02           LOAD AND EXECUTE             @D36BDFR 01046000
         SPACE 2                                                        01047000
RESVSMFL NI    TCBFLAGS,XFF-ACLOSE-VSMOPEN RESET VSAM FLAGS    @D14BDFR 01048000
         EJECT ,                                               @D52VDIS 01049000
*--------------------------------------------------------------         01050000
*          - ICCF PSEUDO (INTERACTIVE) PARTITION CLEAN UP               01051000
*--------------------------------------------------------------         01052000
NOVSYS   DS    0H                                              @D61CDIS 01053000
         TM    TIBFLAG2,ICCFPP    IS IT ICCF PSEUDO PART.      @D14BDFR 01054000
         BZ    ICCFEOTX           NO  --->                     @D14BDFR 01055000
         L     R7,CRADDR          POINT TO PART.COMM.REGION    @D36BDFR 01056000
         MC    4,4                REPLACE COMREG ADDR FOR ICCF @D14BDFR 01057000
*>>>>>>  RETURNS WITH RID = SYSTEMID                                    01058000
         MVI   RID+1,REENTRID     ICCF MC RETURNS RID=SYSTEMID @D14BDFG 01059000
         TM    IJBIJJT,TAPEOPND   TAPE OPENED                  @D51HDOW 01060000
         BZ    IJJTAPEX           NO, --->                     @D14BDFR 01061000
         LA    R1,IJJTAPER        EXIT ADDRESS AFTER CLEANUP   @D14BDFR 01062000
         L     RE,AIJJTEOT        ADDRESS OF TAPE CLEANUP ROUT.@D14BDFR 01063000
         LTR   RE,RE              IS CLEANUP ROUTINE AVAILABLE @D14BDFR 01064000
         BNZ   CALLEOTR           YES,GOTO ACTIVATE ROUTINE    @D14BDFR 01065000
IJJTAPER L     R7,CRADDR          POINT TO PART.COMM.REGION    @D36BDFR 01066000
         MC    4,4                REPLACE COMREG ADDR FOR ICCF @D14BDFR 01067000
*>>>>>>  RETURNS WITH RID = SYSTEMID                                    01068000
         MVI   RID+1,REENTRID     ICCF MC RETURNS RID=SYSTEMID @D14BDFG 01069000
         NI    IJBIJJT,XFF-TAPEOPND RESET TAPE OPEN INDICATOR  @D51HDOW 01070000
         DROP  R7                                              @D52VDIS 01071000
IJJTAPEX LA    R1,ICCFEOTR        EXIT ADDRESS AFTER CLEANUP   @D14BDFR 01072000
         L     RE,AICCFEOT        ADDRESS OF ICCF CLEANUP ROUT.@D14BDFR 01073000
         LTR   RE,RE              IS CLEANUP ROUTINE AVAILABLE @D14BDFR 01074000
         BNZ   CALLEOTR           YES,GOTO ACTIVATE ROUTINE    @D14BDFR 01075000
ICCFEOTR DS    0H                                              @D52VDIS 01076000
         SLR   R1,R1              INDICATE ICCFPP TO BE RESET  @D52VDIS 01077000
         L     RF,ADISPICP        GET ICCFPP RESET ROUTINE ADDR@D52VDIS 01078000
         BALR  R7,RF              CALL ICCFPP RESET ROUTINE    @D52VDIS 01079000
*SGLINK  DISPICP,INPUT=(R1,R6,R7,R8,RF),WORK=(R1,RF)                    01080000
         EJECT ,                                               @D61NDIS 01081000
*--------------------------------------------------------------         01082000
* ICCFEOTX - LIBRARIAN CLEAN UP                                         01083000
*--------------------------------------------------------------         01084000
ICCFEOTX TM    TIBFLAG2,LIBRSERA  IS IT LIBRARIAN ?            @D14BDIS 01085000
         BZ    LIBREOTX           NO --->                      @D14BDIS 01086000
         LA    R1,LIBREOTR        EXIT ADDRESS AFTER CLEANUP   @D14BDIS 01087000
         L     RE,ALIBREOT        ADDRESS OF LIBR CLEANUP ROUT.@D14BDIS 01088000
         LTR   RE,RE              IS CLEANUP ROUTINE AVAILABLE @D14BDIS 01089000
         BNZ   CALLEOTR           YES,GOTO ACTIVATE ROUTINE    @D14BDIS 01090000
LIBREOTR NI    TIBFLAG2,XFF-LIBRSERA   RESET LIBRARIAN FLAG    @D14BDIS 01091000
LIBREOTX DS    0H                                              @D52SDIS 01092000
*--------------------------------------------------------------         01093000
*          - SECURITY CLEAN UP                                          01094000
*--------------------------------------------------------------         01095000
         L     RD,ASVC108X        GET SECURITY BASE ADDRESS    @D52SDIS 01096000
         BAL   R7,SCYEOT-SVC108(,RD) CALL SECURITY EOT ROUTINE @D52SDIS 01097000
*SGLINK  SCYEOT,INPUT=(R6,R7,R8,RA,RD),WORK=(R1,RE,RF)                  01098000
         L     RD,APBASE          RESTORE SGAP BASE ADDRESS    @D61NDIS 01099000
*--------------------------------------------------------------         01100000
*          - LE/370 CLEAN UP                                            01101000
*--------------------------------------------------------------         01102000
         XC    TCBLECAV(4),TCBLECAV  GET LE/370 CEL ANCHOR     @D61IDIS 01103000
         TM    SYSFLAG2,IPLBIT    IPL CANCELLED?               @D52SDIS 01104000
         BO    IPLERROR           YES --->                     @D36BDFR 01105000
*SGLINK  GETEOTA1,S,INPUT=(R6,R8,RA,RB,RC,RD)                           01106000
GETEOTA1 DS    0H                                              @D51IDIS 01107000
         LA    R1,GETEOTAD        SETUP                        @D14BDFR 01108000
         ST    R1,TCBEOTAD              CONTINUATION ADDRESS   @D14BDFR 01109000
GETEOTAD L     RB,AEOTASK                                      @D36BDFR 01110000
         LTR   RB,RB              EOT LOADED INTO SVA ?        @D36BDFR 01111000
         BZ    IPLERROR           NOT AVAILABLE --->           @D61NDIS 01112000
         L     R6,ADISPSER        GET ADDRESS OF DISP.SERVICES @D52GDIS 01113000
         LA    R0,28              SET FUNCTION CODE            @D61PDIS 01114000
         BASSM R7,R6               RESET MSG INFORMATION       @D64ADIS 01115000
*SGLINK DISPSE28,INPUT=(R0,R6,R7,R8,RA),WORK=(R0,R2,RF)                 01116000
         L     R6,DISPAD          RESTORE DISPATCHER BASE      @D52GDIS 01117000
         L     R9,ATERMBAS        GET COMMON BASE ADDR         @D31EDOW 01118000
         USING TERMBASE,R9        ESTABLISH ADDRESSABILITY     @D31EDOW 01119000
         B     INITEOT            INITIALIZE EOT PROCESS       @D61NDIS 01120000
*SGLINK  INITEOT,INPUT=(R6,R8,R9,RA,RB,RD)                              01121000
         DROP  R9                                              @D31EDOW 01122000
         EJECT ,                                               @D64ADIS 01123000
*--------------------------------------------------------------         01124000
* IPLERROR - SYSTEM ERROR                                               01125000
*--------------------------------------------------------------         01126000
IPLERROR MVI   HWIDBYTE,HWIPLERR  HARD WAIT IPL CODE TO SYSCOM @D36BDFR 01127000
         MVC   IJBHWC(1),TIBCNCL  CANCEL CODE TO SYSCOM        @D36BDFR 01128000
         MVI   IJBHWORG,HWORG136  UNIQUE HARD WAIT ORIGINATOR  @D31QDHB 01129000
         CLI   TIBCNCL,ERR47E     CANCEL CODE 47 ?             @D61PDIS 01130000
         BNE   HARDWAIT           NO, PROCESS SYSTEM ERROR     @D61PDIS 01131000
         ICM   R9,15,TCBDMPIP     ADD. CANCEL INFO. AVAILABLE ?@D61PDIS 01132000
         BZ    HARDWAIT           NO, PROCESS SYSTEM ERROR     @D61PDIS 01133000
         ST    R9,IJBCC47I        SAVE ADDRESS OF CNCL INFO.   @D61PDIS 01134000
         B     HARDWAIT                                        @D36BDFR 01135000
         EJECT ,                                               @D52VDIS 01136000
*--------------------------------------------------------------         01137000
* SIMSVC02 - GENERAL SVC 2 SIMULATION AND CLEAN UP ACTIVATION           01138000
*--------------------------------------------------------------         01139000
SIMSVC02 DS    0H                                              @DA38731 01140000
         ST    RE,SVER01          STORE PTR TO TRANSIENT NAME  @DA38731 01141000
         LA    RE,SIMSVC2         ADDRESS OF SIMULATED SVC 2   @DA38731 01142000
         B     CALLEOT0           BRANCH AROUND NEXT STMNTS    @D14BDFR 01143000
         SPACE 2                                                        01144000
CALLEOTR ST    RE,SVER0F          STORE ENTRY POINT ADDRESS    @D14BDFR 01145000
         LA    RE,CALLSEOT        ADDRESS OF SIM.EOT ROUT.CALL @D14BDFR 01146000
CALLEOT0 MVC   SVEPSW(4),PSWFRAME COPY STANDARD PSW FRAME      @D14BDFR 01147000
         TM    PCBFLAG,PERACT     TEST PER BIT IN PCBFLAG      @D14BDFR 01148000
         BZ    CALLEOT1           PER BIT NOT ON   --->        @D14BDFR 01149000
         OI    SVEPSW,PERMASK     ENABLE PROGR.EVENT RECORDING @D14BDFR 01150000
CALLEOT1 ST    R1,TCBEOTAD        SETUP CONTINUATION ADDRESS   @D14BDIS 01151000
         ST    RE,SVEPSW2         ENTRY POINT OF CLEANUP ROUT. @D14BDFR 01152000
         TM    TIBFLAG2,ICCFPP    IS IT ICCF PSEUDO PART.      @D14BDIS 01153000
         BZ    CALLEOTN           NO  --->                     @D14BDIS 01154000
         MVZ   SVEPSW+1(1),SVPPKEY SET ICCF PP KEY INTO PSW    @D14BDIS 01155000
         BR    R6                 GOTO DISPATCH EOJ            @D36BDFR 01156000
         SPACE 2                                                        01157000
CALLEOTN MVZ   SVEPSW+1(1),PCEKEY SET USER KEY INTO PSW        @D14BDIS 01158000
         BR    R6                 GOTO DISPATCH EOJ            @D14BDIS 01159000
         DROP  R5                                              @D14BDFR 01160000
         DROP  RC                                              @D14BDFR 01161000
         EJECT ,                                               @D64ADIS 01162000
*--------------------------------------------------------------         01163000
* LTARTRN  - PROCESS LTA RETURN                                         01164000
*            CLEAN-UP TRANSIENTS HAVE TO RETURN VIA                     01165000
*            SVC 2 FOR $$BEOJ4.                                         01166000
*            CALLED BY: SVC 2 ROUTINE                                   01167000
*--------------------------------------------------------------         01168000
*SGLINK  LTARTRN,S,INPUT=(R6,R8,RA,RD),WORK=(R7)                        01169000
LTARTRN  BAL   R7,FREELTA         FREE LOGICAL TRANSIENT AREA  @D35EDFR 01170000
*SGLINK  FREELTA,INPUT=(R6,R7,R8,RA),WORK=(R5,RE,RF)                    01171000
         B     ENDTERM            GOTO CONTINUE EOT PROCESSING @D14BDFR 01172000
*SGLINK  ENDTERM,INPUT=(R6,R8,RA,RD),WORK=(R1,R5,R7,RB,RC,RE,RF)        01173000
         SPACE 2                                               @D64ADIS 01174000
*--------------------------------------------------------------         01175000
* EOTRTRN  - ANCHOR TO EOT TERMINATION ROUTINE                          01176000
*--------------------------------------------------------------         01177000
EOTRTRN  L     R9,ATERMBAS        GET BASE FOR SUBROUTINES     @D31EDOW 01178000
         USING TERMBASE,R9        ESTABLISH ADDRESSABILITY     @D31EDOW 01179000
         B     EOTRTRNB           ENTER EOT TERMINATION RTN    @D31EDOW 01180000
         DROP  R9                                              @D31EDOW 01181000
         EJECT ,                                                        01182000
*---------------------------------------------------------------------- 01183000
* INITEOTD - CALLED FOR DYNAMIC PARTITION INITIALIZATION                01184000
*---------------------------------------------------------------------- 01185000
*SGLINK  INITEOTD,S,INPUT=(R5,R6,R8,RA,RB,RD)                           01186000
INITEOTD DS    0H                                              @D51IDIS 01187000
         TM    TIBFLAG1,EOTACT    EOT CANCELLED?               @D51IDIS 01188000
         BO    INITEO0D           YES --->                     @D51IDIS 01189000
         MVI   RID+1,REENTRID     IDENTIFY REENTRABLE ROUTINE  @D51IDIS 01190000
         OI    TIBFLAG1,EOTINPR   INDICATE EOT CLEANUP IN PROC.@D51IDIS 01191000
         NI    TCBFLAG2,XFF-CNCLRTRN RESET TERM.RETURN FLAG    @D51IDIS 01192000
         NI    TIBFLAG,XFF-FETCHEOJ RESET DISPATCHER EXIT FLAG @D51IDIS 01193000
         L     RC,ASVASVDL        PTR.TO SVA ROUT.ADDR.TABLE   @D51IDIS 01194000
         B     GETEOTA1           CONTINUE WITH END-OF-TASK    @D51IDIS 01195000
*SGLINK  GETEOTA1,INPUT=(R6,R8,RA,RB,RC,RD)                             01196000
         SPACE 2                                                        01197000
*---------------------------------------------------------------------- 01198000
* INITEO0D - CALLED, IF END-OF-TASK ROUTINE CANCELLED                   01199000
*---------------------------------------------------------------------- 01200000
INITEO0D DS    0H                                              @D51IDIS 01201000
         L     R9,ATERMBAS        GET COMMON BASE ADDR         @D51IDIS 01202000
         USING TERMBASE,R9        ESTABLISH BASE               @D51IDIS 01203000
         ICM   R7,15,EOTOWNSA     LOAD SAVE AREA PTR., AVAIL.? @D51IDIS 01204000
         BZ    EOTCNCLD           NO, DO NOT SAVE FOR DUMP     @D51IDIS 01205000
*SGLINK  EOTCNCLD,INPUT=(R5,R6,R8,R9,RA,RB,RD)                          01206000
         MVC   SVEPSW-SVEARA(L72,R7),SVEPSW SAVE FOR TERMINATOR@D51IDIS 01207000
         B     EOTCNCLD           FREE EOT                     @D51IDIS 01208000
*SGLINK  EOTCNCLD,INPUT=(R5,R6,R8,R9,RA,RB,RD)                          01209000
         DROP  R6                                              @D64ADIS 01210000
         DROP  R8                                              @D64ADIS 01211000
         DROP  R9                                              @D51IDIS 01212000
         DROP  RA                                              @D64ADIS 01213000
         DROP  RB                                              @D64ADIS 01214000
         DROP  RD                                              @D64ADIS 01215000
 TITLE 'VSE SUPERVISOR   SGAP               CONSTANTS WITHIN SGAP BASE' 01216000
*--------------------------------------------------------------         01217000
* TERMINATOR ROUTINES' CONSTANTS                                        01218000
*--------------------------------------------------------------         01219000
ASVC03   DC    A(SVC03)                                        @D36BDFR 01220000
ASVC43   DC    A(SVC43)           SVC 43 ADDRESS               @D51IDIS 01221000
ASVC79X  DC    A(SVC79)           SVC 79 ADDRESS               @D67CDOW 01222000
ASVC108X DC    A(SVC108)          SVC 108 ADDRESS              @D52VDIS 01223000
ASVC133  DC    A(SVC133)          SVC 133 ADDRESS              @D64XDIS 01224000
ASVC150  DC    A(SVC150)          SVC 150 ADDRESS              @D64ADIS 01225000
ATERMBAS DC    A(TERMBASE)        COMMON SUBROUTINE'S BASE     @D31EDOW 01226000
PSWFRAME DS    0CL4                                            @D14BDFR 01227000
         DC    AL1(ENABLE+DATMASK),AL1(ECBIT+MCBIT+PPBIT),H'0' @D14BDFR 01228000
$STCNL   DC    C'$$BSTCNL'           $$BSTCNL                  @DA38731 01229000
$TOLTP   DC    C'$$BTOLTP'           $$BTOLTP                  @DA38731 01230000
$PCLOS   DC    C'$$BPCLOS'           $$BPCLOS                  @DA38731 01231000
$DTS04   DC    C'$$BDTS04'           $$BDTS04                  @DA38731 01232000
$ACLOS   DC    C'$$BACLOS'           $$BACLOS                  @DA38731 01233000
*--------------------------------------------------------------         01234000
* >>>>>>>>>>>>> END OF SGAP BASE REGISTER RANGE <<<<<<<<<<<<<<<         01235000
*--------------------------------------------------------------         01236000
 TITLE 'VSE SUPERVISOR   SGAP                     TERMINATION SERVICES' 01237000
         USING DISP,R6                                         @D64ADIS 01238000
         USING TIBADR,R8                                       @D64ADIS 01239000
         USING TCBADR,RA                                       @D64ADIS 01240000
         USING SVEARA,RB                                       @D64ADIS 01241000
**********************************************************************  01242000
*                                                                     * 01243000
* TERMINATOR:  SVC06 OR CANCEL MACRO ROUTINE                          * 01244000
*                                                                     * 01245000
*********************************************************************** 01246000
*                                                                     * 01247000
*        INITIALIZES PROGRAM REQUEST CANCEL :                         * 01248000
*                                                                     * 01249000
*        SUBTASK ISSUED CANCEL                : CANCELCODE X'23'      * 01250000
*        MAINTASK W/O SUBTASKS ISSUED CANCEL  : CANCELCODE X'23'      * 01251000
*        MAINTASK WITH SUBTASKS ISSUED CANCEL : CANCELCODE X'17'      * 01252000
*                                                                     * 01253000
*        INPUT REGISTER :                                             * 01254000
*        R0 TO INDICATE SIMPLE CANCEL OR CANCEL ALL (SUBTASKS ONLY)   * 01255000
*                                                                     * 01256000
*        EXIT: TO LABEL ERR23 RESP. ERR17 IN DISP                     * 01257000
*                                                                     * 01258000
*        AMODE = ANY, RMODE = ANY                                       01259000
*********************************************************************** 01260000
         SPACE 2                                               @D35EDFR 01261000
         USING SVC06,RD                                        @D14BDFR 01262000
SVC06    LTR   R0,R0              IS IT CANCEL ALL?            @D35EDFR 01263000
         BNZ   SVC06ALL           YES, SELFTERMINATION REQUEST @D36IDFR 01264000
         TM    TIBFLAG1,LTAACT    REQUEST FROM LTA             @D36IDFR 01265000
         BO    ERR09              YES, SERVER REQUEST CANCEL   @D36IDFR 01266000
         TM    TCBFLAG2,OPENSVA   REQUEST FROM SVA OPEN        @D36IDFR 01267000
         BO    ERR09              YES, SERVER REQUEST CANCEL   @D36IDFR 01268000
         CLC   TID(2),IJBHMTID    IS IT MAINTASK               @D51IDIS 01269000
         BH    ERR23              NO, SIMPLE SELFTERM.REQUEST  @D36IDFR 01270000
SVC06M   L     R9,PCBPTR          LOAD PCB POINTER             @D36IDFR 01271000
         CLC   PCBLCTSS-PCBADR(2,R9),H0 SUBTASKS ATTACHED?     @D66ODOW 01272000
         BE    ERR23              NO,EXIT TO ERR23             @D36IDFR 01273000
         B     ERR17              EXIT TO ERR17                @D36IDFR 01274000
SVC06ALL DS    0H                                              @D51IDIS 01275000
         CLC   TID(2),IJBHMTID    IS IT MAINTASK               @D51IDIS 01276000
         BNH   SVC06M             YES --->                     @D36IDFR 01277000
         OI    TCBFLAG2,CNCLALL   REQUEST CANCEL PROPAGATION   @D36IDFR 01278000
         B     ERR23              EXIT TO ERR23                @D36IDFR 01279000
         DROP  RD                                              @D14BDFR 01280000
         EJECT ,                                               @D64ADIS 01281000
*********************************************************************** 01282000
*                                                                     * 01283000
* TERMINATOR: SVC 14 OR EOJ MACRO ROUTINE                             * 01284000
*                                                                     * 01285000
*********************************************************************** 01286000
*                                                                     * 01287000
*    FUNCTION:                                                        * 01288000
*        INITIATES END OF JOB PROCESSING                              * 01289000
*        RETURNS TO RESIDENT TERMINATOR FROM SVA RES.EOT CLEANUP ROUT.* 01290000
*                                                                     * 01291000
*        AMODE = ANY, RMODE = 24                                      * 01292000
*********************************************************************** 01293000
         SPACE 2                                               @D14BDFR 01294000
         USING SVC14,RC                                        @D61IDIS 01295000
SVC14    DS    0H                                              @D52VDIS 01296000
         TM    TIBFLAG1,EOTINPR+TERMACT EOJ FROM DUMP OR       @D52VDIS 01297000
*                                 EOT CLEANUP ROUTINE          @D52VDIS 01298000
         BNZ   SVC14EOT           YES, CONTINUE CLEAN UP       @D61IDIS 01299000
*        AMODESW SET,AMODE=31,WR=(9)                           @D61PDIS 01300000
         AMODESW SET,AMODE=31,WR=(9)                           @D61PDIS 01301000
         L     RD,TCBATCBE        GET ADDR. OF TCB EXTENSION   @D61IDIS 01302000
         USING TCBXADR,RD                                      @D61IDIS 01303000
         ICM   RD,15,TCBXRXEO     RETURN TO REXX REQUIRED ?    @D61IDIS 01304000
         BZ    ERR10              NO, GOTO INITIALIZE EOJ PROC.@D14BDFR 01305000
         DROP  RD                                              @D61IDIS 01306000
         MVC   SVEPSW(8),SVEPSW-SVEARA(RD) PROVIDE CORRET PSW  @D61IDIS 01307000
         BR    R6                 RETURN TO DISPATCHER         @D61IDIS 01308000
         EJECT ,                                               @D61NDIS 01309000
*--------------------------------------------------------------         01310000
* SVC14EOT - RETURN TO DUMP INTERFACE ROUTINES                          01311000
*            OR TO CLEAN UP PROCESS                                     01312000
*--------------------------------------------------------------         01313000
SVC14EOT DS    0H                                              @D61IDIS 01314000
         L     RD,APBASE          LOAD SGAP BASE               @D61IDIS 01315000
         USING SGAP,RD                                         @D61IDIS 01316000
         L     R9,ATERMBAS        GET BASE FOR SUBROUTINES     @D52VDIS 01317000
         USING TERMBASE,R9        ESTABLISH ADDRESSABILITY     @D52VDIS 01318000
         TM    TIBFLAG1,TERMACT   EOJ FROM DUMP ROUTINE        @D52VDIS 01319000
         BO    TERMRETB           YES, PROCESS RETURN FROM DUMP@D52VDIS 01320000
*SGLINK  TERMRETB,INPUT=(R6,R8,R9,RA,RD),WORK=(R5,R7,RF),OUTPUT=(RB)    01321000
         DROP  R9                                              @D31EDOW 01322000
         TM    TIBFLAG1,LTAOWNER  EOJ FROM LTA ?               @D14BDIS 01323000
         BZ    ENDTERM            NO,  CONTINUE PROCESSING     @D14BDIS 01324000
*SGLINK  ENDTERM,INPUT=(R6,R8,RA,RD),WORK=(R1,R5,R7,RB,RC,RE,RF)        01325000
         LA    R7,ENDTERM         RETURN ADDR. FOR FREELTA     @D14BDIS 01326000
         B     FREELTA            GOTO FREE LTA                @D14BDIS 01327000
*SGLINK  FREELTA,INPUT=(R6,R7,R8,RA),WORK=(R5,RE,RF)           @D149DIS 01328000
         DROP  R6                                              @D64ADIS 01329000
         DROP  R8                                              @D64ADIS 01330000
         DROP  RA                                              @D64ADIS 01331000
         DROP  RB                                              @D64ADIS 01332000
         DROP  RC                                              @D61IDIS 01333000
         DROP  RD                                              @D14BDFR 01334000
 TITLE 'VSE SUPERVISOR   SGAP          EOT INITIALIZATION AND RETURN'   01335000
         USING DISP,R6                                         @D64ADIS 01336000
         USING TIBADR,R8                                       @D64ADIS 01337000
         USING TCBADR,RA                                       @D64ADIS 01338000
         USING SVEARA,RB                                       @D64ADIS 01339000
         USING SGAP,RD                                         @D64ADIS 01340000
*********************************************************************** 01341000
*                                                                     * 01342000
* TERMINATOR:  EOT INITIALIZATION ROUTINE                             * 01343000
*                                                                     * 01344000
*********************************************************************** 01345000
*                                                                     * 01346000
*        ENTERED FROM CANCEL EXIT                                     * 01347000
*        FUNCTION:                                                    * 01348000
*           ENQUEUES EOT ROUTINE                                      * 01349000
*           EXCHANGES SAVEAREAS                                       * 01350000
*           ACTIVATES EOT ROUTINE CODE IN SVA                         * 01351000
*                                                                     * 01352000
*********************************************************************** 01353000
         SPACE 4                                                        01354000
TERMBASE DS    0H                 BASE POINTER                 @D31EDOW 01355000
         USING SGAP,RD                                         @D31EDOW 01356000
         USING TERMBASE,R9                                     @D31EDOW 01357000
*SGLINK  INITEOT,S,INPUT=(R6,R8,R9,RA,RB,RD)                            01358000
INITEOT  DS    0H                                              @D51IDIS 01359000
         MVI   RID+1,REENTRID     IDENTIFY REENTRABLE ROUTINE  @D51IDIS 01360000
         L     RC,ASVC03                                       @D51IDIS 01361000
         L     RD,IOSBASE         GET IOS BASE ADDRESS         @D51IDIS 01362000
         USING SVC03,RC                                        @D51IDIS 01363000
         BAL   R7,SVC03EOT        QUIESCE PARTITION'S I/O      @D51IDIS 01364000
*SGLINK  SVC03EOT,INPUT=(R6,R7,R8,RA,RC,RD),WORK=(R1,R2,R3,R4,R5,RE,RF) 01365000
         DROP  RC                                              @D51IDIS 01366000
         L     RD,APBASE          GET SGAP BASE ADDRESS        @D51IDIS 01367000
         L     R5,ASRQTAB         GET ADDRESS OF SRQTAB        @D61RDIS 01368000
         LA    R5,SRQEOT-SRQTAB(,R5) POINT TO EOT ROUTINE QUEUE@D61RDIS 01369000
         USING RQADR,R5                                        @D52VDIS 01370000
         TM    RSCDESC,FREEBIT    EOT ROUTINE AVAILABLE        @D66ODOW 01371000
         BO    OCCUPEOT           YES,GOTO ACTIVATE EOT ROUT.  @D66ODOW 01372000
         OI    TCBFLAG2,CNCLRTRN  TURN ON CANCEL RETURN FLAG   @D14BDFR 01373000
         OI    TIBFLAG,FETCHEOJ   TURN ON DISPATCH.EXIT FLAGS  @D14BDFR 01374000
         LR    RF,R6                                           @D36BDFR 01375000
         B     UNPOST             GOTO SETUP TASK TO WAIT      @D36BDFR 01376000
*SGLINK  UNPOST,INPUT=(R5,R6,RF),WORK=(R5,RE)                           01377000
         EJECT ,                                               @D52VDIS 01378000
*------------------------------------------------------------           01379000
* OCCUPEOT - ACTIVATE EOT ROUTINE                                       01380000
*------------------------------------------------------------           01381000
OCCUPEOT DS    0H                                              @D52VDIS 01382000
         MVC   RSCDESC,TID        CLOSE GATE AND SET RES OWNER @D66ODOW 01383000
         DROP  R5                                              @D52VDIS 01384000
         MVC   TIBCNCL2(1),TIBCNCL3 RESTORE TERM.CANCEL CODE   @D14BDFR 01385000
         MVI   TIBCNCL3,ZERO      RESET THIRD  CANCEL CODE     @D14BDFR 01386000
         OI    TIBFLAG1,EOTACT    INDICATE TASK IS EOT OWNER   @D36BDFR 01387000
         OI    DISPHIFL,EOTACT    INDICATE TASK IS EOT OWNER   @D51IDIS 01388000
*        DISPMAC FUNC=EOT         PROCESS EOT HIGH PRIO.REQUEST@D61RDIS 01389000
         DISPMAC FUNC=EOT         PROCESS EOT HIGH PRIO.REQUEST@D61RDIS 01390000
         ST    R8,EOTTIB          SAVE TASKS TIB ADDRESS       @D51IDIS 01391000
         L     R0,TCBSAVE         SAVE TASKS                   @D36BDFR 01392000
         ST    R0,EOTOWNSA           SAVEAREA POINTER          @D36BDFR 01393000
         ST    RB,TCBSAVE         ACTIVATE EOT SAVEAREA        @D36BDFR 01394000
         LA    R0,SVEARA+120      START ADDRESS OF EOT ROUTINE @D36BDFR 01395000
         ST    R0,SVEPSW2         EOT ROUTINE ENTRY POINT      @D36BDFR 01396000
         MVC   SVEPSW(4),PSWFRAME COPY STANDARD PSW FRAME      @D14BDFR 01397000
         L     R5,PCBPTR          POINT TO PCB                 @D14BDFR 01398000
         USING PCBADR,R5                                       @D14BDFR 01399000
         TM    PCBFLAG,PERACT     TEST PER BIT IN PCBFLAG      @D14BDFR 01400000
         BZR   R6                 PER BIT NOT ON   --->        @D61NDIS 01401000
         OI    SVEPSW,PERMASK     ENABLE PROGR.EVENT RECORDING @D14BDFR 01402000
         BR    R6                 RETURN TO DISPATCHER         @D61NDIS 01403000
         DROP  R5                                              @D14BDFR 01404000
         EJECT ,                                               @D14BDIS 01405000
*********************************************************************** 01406000
*                                                                     * 01407000
* TERMINATOR:  EOT TERMINATION ROUTINE                                * 01408000
*                                                                     * 01409000
*********************************************************************** 01410000
*                                                                     * 01411000
*        ENTERED FROM SVC11 FROM SVC39 AND FROM CANCEL EXIT           * 01412000
*                                                                     * 01413000
*        FUNCTION:                                                    * 01414000
*           DEQUEUES EOT ROUTINE                                      * 01415000
*           RESETS EOT OWNER INDICATOR IN TIB                         * 01416000
*           RESTORES USER SAVEAREA POINTER                            * 01417000
*                                                                     * 01418000
*********************************************************************** 01419000
         SPACE 2                                               @D35EDFR 01420000
*SGLINK  EOTRTRN,S,INPUT=(R6,R7,R8,R9,RA,RD),WORK=(R5,RE,RF)            01421000
EOTRTRNB DS    0F                                              @D51IDIS 01422000
         MVI   TIBCNCL2,ZERO      RESET SECOND CANCEL CODE     @D36BDFR 01423000
         XC    TCBEOTAD(4),TCBEOTAD RESET CONTINUATION ADDRESS @D14BDFR 01424000
         NI    TIBFLAG1,XFF-EOTINPR RESET EOT IN PROGRESS FLAG @D14BDFR 01425000
         CLC   TID,ARTIDH         IS IT USER TASK              @D66ODOW 01426000
         BNH   EOTCNCL0           NO,GOTO RESTORE SAVEAREA PTR.@D51IDIS 01427000
         CLC   TID(2),IJBHMTID    IS IT MAINTASK               @D51IDIS 01428000
         BH    EOTCNCL0           NO,GOTO RESTORE SAVEAREA PTR.@D51IDIS 01429000
         L     R5,PCBPTR          GET TASKS SAVEAREA POINTER   @D51IDIS 01430000
         USING PCBADR,R5              FROM SMCB AND            @D51IDIS 01431000
         MVC   TCBSAVE+1(3),SMPSAVE+1 STORE IT TO TCB          @D36BDFR 01432000
         TM    PCEFLAG,PCEDYNP    DYNAMIC PARTITION ?          @D51IDIS 01433000
         BO    EOTDYNP            YES, CHECK FOR PREPARATION   @D51IDIS 01434000
         EJECT ,                                               @D52YDIS 01435000
*--------------------------------------------------------------         01436000
* EOTRESE0  - CLEAR CANCEL CODE AND RESET VENDOR INTERFACES             01437000
*--------------------------------------------------------------         01438000
EOTRESE0 DS    0H                                              @D52VDIS 01439000
         DROP  R5                                              @D51IDIS 01440000
         STM   R0,RF,EOTSPSAV     SAVE REGISTERS               @D61PDIS 01441000
         MVI   TIBCNCL,ZERO       RESET CANCEL CODE            @D51IDIS 01442000
*--------------------------------------------------------------         01443000
* $IJBVEND  - RESET VENDOR INTERFACES FOR THIS TASK                     01444000
*             INPUT:  RA - TCB ADDRESS OF CURRENT TASK                  01445000
*                     RE - RETURN ADDRESS                               01446000
*                     RD - $IJBVEND BASE ADDRESS                        01447000
*                     RF - FUNCTION CODE                                01448000
*             OUTPUT: RF - RETURN CODE (= 0)                            01449000
*             AMODE:  ANY                                               01450000
*             $IJBVEND HAS TO RETURN WITH THE AMODE OF THE CALLER       01451000
*--------------------------------------------------------------         01452000
         L     RF,ASVASVDL        PTR.TO SVA ROUT.ADDR.TABLE   @D52YDIS 01453000
         ICM   RF,15,AIJBVEND-SVASVDL(RF) GET ROUTINE ADDRESS  @D52YDIS 01454000
         BZ    EOTRESE2           BRANCH IF NOT AVAILABLE      @D52YDIS 01455000
         DROP  RD                                              @D52YDIS 01456000
         LR    RD,RF              INITIALIZE $IJBVEND BASE     @D52YDIS 01457000
         LA    RF,4               SET FUNCTION CODE            @D61EDIS 01458000
         BASSM RE,RD              CALL ROUTINE                 @D64ADIS 01459000
         L     RD,APBASE          RESTORE SGAP BASE ADDRESS    @D52YDIS 01460000
         USING SGAP,RD                                         @D52YDIS 01461000
         L     R9,ATERMBAS        RESTORE BASE REGISTER        @D51IDIS 01462000
         LM    R0,RF,EOTSPSAV     RESTORE REGISTERS            @D61PDIS 01463000
*--------------------------------------------------------------         01464000
* EOTRESE2  - RESET ESA RELATED INFORMATION                             01465000
*--------------------------------------------------------------         01466000
EOTRESE2 DS    0H                                              @D52YDIS 01467000
         L     R6,ADISPSER        GET ADDRESS OF DISP.SERVICES @D61PDIS 01468000
         LA    R0,32              SET FUNCTION CODE            @D61PDIS 01469000
         BASSM R7,R6               RESET MSG INFORMATION       @D64ADIS 01470000
*SGLINK DISPSE32,INPUT=(R0,R6,R7,R8,RA),WORK=(R0,R2,RF)                 01471000
         LM    R0,RF,EOTSPSAV     RESTORE REGISTERS            @D61PDIS 01472000
         EJECT ,                                               @D64XDIS 01473000
*------------------------------------------------------------           01474000
*          - RESET ESA ENVIRONMENT                                      01475000
*------------------------------------------------------------           01476000
         LA    RF,EOTRESE5        GET ADDR OF CONTINUATION     @D64XDIS 01477000
         O     RF,BIT0OMSK        GET ADDR OF CONTINUATION     @D64XDIS 01478000
         BSM   0,RF               PASS CONTROL 31-BIT MODE     @D64XDIS 01479000
EOTRESE5 DS    0H                                              @D61RDIS 01480000
         L     RF,TCBATCBE-TCBADR(,RA)                         @D64XDIS 01481000
         XC    TCBX1CR8-TCBXADR(2,RF),TCBX1CR8-TCBXADR(RF) TASK IS      01482000
*                                 DISPATCHED WITH EAX=0        @D64XDIS 01483000
         STCTL CR2,CR8,DISPSCR2   GET CONTROL REGISTER 2 - 8   @D64XDIS 01484000
         XC    DISPSCR2,DISPSCR2  CLEAR OUT DUCT ADDRESS       @D64XDIS 01485000
         XC    DISPSCR8(2),DISPSCR8  CLEAR OUT EAX ADDRESS     @D64XDIS 01486000
         LCTL  CR2,CR8,DISPSCR2   RESTORE CONTROL REGISTER 2-8 @D64XDIS 01487000
*------------------------------------------------------------           01488000
*          - FREE EOT ROUTINE AND POST ANY WAITERS                      01489000
*            AMODE 31                                                   01490000
*------------------------------------------------------------           01491000
         NI    TIBFLAG1,XFF-EOTACT RESET EOT ACTIVE FLAG       @D61RDIS 01492000
         NI    DISPHIFL,XFF-EOTACT  RESET INDICATION           @D51IDIS 01493000
*        DISPMAC FUNC=EOT         PROCESS EOT HIGH PRIO.REQUEST         01494000
         DISPMAC FUNC=EOT         PROCESS EOT HIGH PRIO.REQUEST@D61RDIS 01495000
         L     R5,ASRQTAB         GET ADDRESS OF SRQTAB        @D61RDIS 01496000
         LA    R5,SRQEOT-SRQTAB(,R5)  FREE EOT ROUTINE AND POST@D61RDIS 01497000
         BAL   RF,RPOST                HIGHEST PRIORITY WAITER @D36BDFR 01498000
*SGLINK  RPOST,INPUT=(R5,R6,RF),WORK=(R5,RE)                            01499000
         L     RF,PCBPTR          GET CURRENT PCB ADDRESS      @D64ADIS 01500000
         USING PCBADR,RF                                       @D64ADIS 01501000
         TM    PCBFLAG,PCBMVSEM   MVS EMULATION MODE ACTIVE ?  @D64ADIS 01502000
         BO    EOTRESE3           NO, SKIP                     @D64ADIS 01503000
         DROP  RF                                              @D64ADIS 01504000
         LA    RF,EOTRESER        GET ADDR OF CONTINUATION     @D64ADIS 01505000
         BSM   0,RF               PASS CONTROL 24-BIT MODE     @D64ADIS 01506000
EOTRESER DS    0H                                              @D61RDIS 01507000
         CLC   TID,ARTIDH         IS IT SYSTEM TASK OR AR      @D66ODOW 01508000
         BH    EOTRESE1           NO, CHECK IF CLASSTAB AVAIL. @D51IDIS 01509000
         CR    R6,R7              CALLED FROM SVC11            @D14BDFR 01510000
         BNER  R7                 NO, GOTO PROC.CANCEL OF EOT  @D14BDFR 01511000
         L     RC,TCBSTADR        POINT TO TASKS TERM. ROUTINE @D14BDFR 01512000
         BR    RC                 GOTO DEACTIVATE TASKS        @D14BDFR 01513000
         EJECT ,                                               @D64ADIS 01514000
*------------------------------------------------------------           01515000
* EOTCNCL0 - RESTORE TASK'S SAVE AREA ADDRESS AND FREE EOT              01516000
*------------------------------------------------------------           01517000
EOTCNCL0 DS    0H                                              @D52GDIS 01518000
         MVC   TCBSAVE+1(3),EOTOWNSA+1 RESTORE TASKS SAVEAR.PTR@D52GDIS 01519000
         B     EOTRESE0           FREE EOT                     @D52GDIS 01520000
         SPACE 2                                               @D52VDIS 01521000
*--------------------------------------------------------------         01522000
* EOTRESE3 - PROCESS MVS CLEAN-UP, FREE MVS CONTROL BLOCKS              01523000
*            AMODE 31                                                   01524000
*--------------------------------------------------------------         01525000
EOTRESE3 DS    0H                                              @D64ADIS 01526000
         L     R5,TCBATCBE        ADDRESS OF TCBX              @D64ADIS 01527000
         USING TCBXADR,R5                                      @D64ADIS 01528000
         TM    TCBXSAUS,TCBXXSAU  SAVE AREA OCCUPIED ?         @D64ADIS 01529000
         BZ    EOTRESEG           NO,  --->                    @D64ADIS 01530000
*        MVI   IJBHWORG,HWORG256  SET HARDWAIT ORIGINATOR CODE @D64ADIS 01531000
         STCM  R5,B'1111',*+8                                  @D64ADIS 01532000
         BAL   R5,SYSERROR                                     @D64ADIS 01533000
         DC    X'00000000'                                     @D64ADIS 01534000
EOTRESEG DS    0H                                              @D64ADIS 01535000
         OI    TCBXSAUS,TCBXXSAU  SET SAVE AREA IN USE         @D64ADIS 01536000
         STM   R0,RF,TCBXXSA      SAVE REGISTERS               @D64ADIS 01537000
         CLC   TID(2),IJBHMTID    IS IT MAINTASK               @D64ADIS 01538000
         BH    EOTRESE4           NO, DEALLOCATE CONTROL BLOCKS@D64ADIS 01539000
         USING PCBADR,RF                                       @D64ADIS 01540000
         NI    PCBFLAG,XFF-PCBMVSEM RESET FLAG                 @D64ADIS 01541000
         DROP  R5                                              @D64ADIS 01542000
         DROP  RF                                              @D64ADIS 01543000
*--------------------------------------------------------------         01544000
* EOTRESE4 - CALL MVS DETACH PROCESS (AMODE 24)                         01545000
*            INPUT:  RA - TCB ADDRESS                                   01546000
*--------------------------------------------------------------         01547000
EOTRESE4 DS    0H                                              @D64ADIS 01548000
         LA    RF,EOTRES14        GET ADDR OF CONTINUATION     @D64ADIS 01549000
         BSM   0,RF               PASS CONTROL 24-BIT MODE     @D64ADIS 01550000
EOTRES14 DS    0H                                              @D64ADIS 01551000
         L     R9,ASGMVSAP                                     @D64ADIS 01552000
         BAL   R4,DETMVSXX-SGMVSAPI(,R9) MVS DETACH HANDLING   @D64ADIS 01553000
         EJECT ,                                               @D64ADIS 01554000
*--------------------------------------------------------------         01555000
*          - SMCBEM MAY DESTROY ALL REGISTERS, EXCEPT RA                01556000
*            INPUT:  RA - TCB ADDRESS                                   01557000
*--------------------------------------------------------------         01558000
*        SMCBEM FUNC=DEALL        DEALLOCATE CONTROL BLOCKS    @D64ADIS 01559000
         SMCBEM FUNC=DEALL        DEALLOCATE CONTROL BLOCKS    @D64ADIS 01560000
         L     RD,APBASE          RESTORE SGAP BASE ADDRESS    @D64ADIS 01561000
         USING SGAP,RD                                         @D64ADIS 01562000
         L     R9,ATERMBAS        RESTORE BASE REGISTER        @D64ADIS 01563000
         LA    RF,EOTRES24        GET ADDR OF ...              @D64ADIS 01564000
         O     RF,BIT0OMSK                ... CONTINUATION     @D64ADIS 01565000
         BSM   0,RF               PASS CONTROL 31-BIT MODE     @D64ADIS 01566000
EOTRES24 DS    0H                                              @D64ADIS 01567000
         L     R5,TCBATCBE        ADDRESS OF TCBX              @D64ADIS 01568000
         USING TCBXADR,R5                                      @D64ADIS 01569000
         TM    TCBXSAUS,TCBXXSAU  SAVE AREA OCCUPIED ?         @D64ADIS 01570000
         BO    EOTRES0G           NO,  --->                    @D64ADIS 01571000
*        MVI   IJBHWORG,HWORG256  SET HARDWAIT ORIGINATOR CODE @D64ADIS 01572000
         STCM  R5,B'1111',*+8                                  @D64ADIS 01573000
         BAL   R5,SYSERROR                                     @D64ADIS 01574000
         DC    X'00000000'                                     @D64ADIS 01575000
EOTRES0G DS    0H                                              @D64ADIS 01576000
         LM    R0,RF,TCBXXSA      RESTORE REGISTERS            @D64ADIS 01577000
         NI    TCBXSAUS,XFF-TCBXXSAU  RESET SAVE AREA IN USE   @D64ADIS 01578000
         LA    RF,EOTRESER        GET ADDR OF CONTINUATION     @D64ADIS 01579000
         BSM   0,RF               PASS CONTROL 24-BIT MODE     @D64ADIS 01580000
         DROP  R5                                              @D64ADIS 01581000
         EJECT ,                                               @D64ADIS 01582000
*------------------------------------------------------------           01583000
* EOTCNCL  - RESTORE TASK'S SAVE AREA ADDRESS AND FREE EOT              01584000
*            ENTRY POINT, IF EOT CANCELLED                              01585000
*            AMODE 24                                                   01586000
*------------------------------------------------------------           01587000
EOTCNCL  DS    0H                                              @D64ADIS 01588000
         MVC   TCBSAVE+1(3),EOTOWNSA+1 RESTORE TASKS SAVEAR.PTR@D64ADIS 01589000
         NI    TIBFLAG1,XFF-EOTACT RESET EOT ACTIVE FLAG       @D64ADIS 01590000
         NI    DISPHIFL,XFF-EOTACT  RESET INDICATION           @D64ADIS 01591000
*        DISPMAC FUNC=EOT         PROCESS EOT HIGH PRIO.REQUEST@D64ADIS 01592000
         DISPMAC FUNC=EOT         PROCESS EOT HIGH PRIO.REQUEST@D64ADIS 01593000
         L     R5,ASRQTAB         GET ADDRESS OF SRQTAB        @D64ADIS 01594000
         LA    R5,SRQEOT-SRQTAB(,R5)  FREE EOT ROUTINE AND POST@D64ADIS 01595000
         BAL   RF,RPOST                HIGHEST PRIORITY WAITER @D64ADIS 01596000
*SGLINK  RPOST,INPUT=(R5,R6,RF),WORK=(R5,RE)                            01597000
         BR    R7                 GOTO PROC.CANCEL OF EOT      @D64ADIS 01598000
         EJECT ,                                               @D51IDIS 01599000
*------------------------------------------------------------- @D51IDIS 01600000
* EOTCNCLD - CHECK IF DYNAMIC PARTITION PREPARATION CANCELED   @D51IDIS 01601000
*------------------------------------------------------------- @D51IDIS 01602000
*SGLINK  EOTCNCLD,S,INPUT=(R5,R6,R8,R9,RA,RB,RD)                        01603000
EOTCNCLD DS    0H                                              @D51IDIS 01604000
         MVC   TCBSAVE+1(3),EOTOWNSA+1 RESTORE TASKS SAVEAR.PTR@D51IDIS 01605000
         USING PCBADR,R5                                       @D51IDIS 01606000
         NI    PCEFLAG,XFF-PCEPREP RESET PREPARATION IND.      @D51IDIS 01607000
         OI    PCEFLAG,PCEICNCL   INDICATE INITIAL. CANCELED   @D51IDIS 01608000
         OI    PCEFLAG1,PCEDOCL   PROCESS CLEAN UP             @D51IDIS 01609000
         OI    PCEFLAG,PCECLEAN   INDICATE CLEAN UP IN PROCESS @D51IDIS 01610000
         DROP  R5                                              @D51IDIS 01611000
         NI    TIBFLAG1,XFF-EOTACT RESET EOT ACTIVE FLAG       @D51IDIS 01612000
         NI    DISPHIFL,XFF-EOTACT  RESET INDICATION           @D52VDIS 01613000
*        DISPMAC FUNC=EOT         PROCESS EOT HIGH PRIO.REQUEST@D61RDIS 01614000
         DISPMAC FUNC=EOT         PROCESS EOT HIGH PRIO.REQUEST@D61RDIS 01615000
         L     R5,ASRQTAB         GET ADDRESS OF SRQTAB        @D61RDIS 01616000
         LA    R5,SRQEOT-SRQTAB(,R5)  FREE EOT ROUTINE AND POST@D61RDIS 01617000
         BAL   RF,RPOST                HIGHEST PRIORITY WAITER @D51IDIS 01618000
*SGLINK  RPOST,INPUT=(R5,R6,RF),WORK=(R5,RE)                            01619000
         L     RC,FSVCBASE        GET SGTINF BASE ADDRESS      @D51IDIS 01620000
         USING SGTINF,RC              FROM SMCB AND            @D51IDIS 01621000
         L     RD,FSVCBAS2        GET 2. SGTINF ADDRESS        @D51IDIS 01622000
         B     TINFTWIC           DEACTIVATE PARTITION         @D51IDIS 01623000
         DROP  RC                                              @D51IDIS 01624000
         EJECT ,                                               @D51IDIS 01625000
*------------------------------------------------------------- @D51IDIS 01626000
* EOTRESE1 - CHECK IF CLASS TABLE TO BE REMOVED                @D51IDIS 01627000
*------------------------------------------------------------- @D51IDIS 01628000
EOTRESE1 DS    0H                                              @D51IDIS 01629000
         CR    R6,R7              CALLED FROM SVC11            @D51IDIS 01630000
         BNER  R7                 NO, RETURN TO CALLER         @D51IDIS 01631000
         L     R2,CRADDR          POINT TO PART.COMM.REGION    @D51IDIS 01632000
         USING COMREG,R2                                       @D51IDIS 01633000
         TM    POWFLG2,POWINTER   VSE/POWER IN TERMINATION ?   @D51IDIS 01634000
         BZR   R6                 NO, RETURN TO DISPATCHER     @D51IDIS 01635000
         NI    POWFLG2,XFF-POWINTER RESET FLAG                 @D51IDIS 01636000
         DROP  R2                                              @D51IDIS 01637000
         ICM   R1,15,IJBCLTAB     CLASS TABLE AVAILABLE ?      @D51IDIS 01638000
         BZR   R6                 NO, RETURN TO DISPATCHER     @D51IDIS 01639000
         L     RC,ASVC43          GET SVC43 BASE               @D51IDIS 01640000
         L     RF,AS43RESET                                    @D66ODOW 01641000
         BSM   0,RF               ENTER SVC43 IN 31BIT MODE    @D66ODOW 01642000
*SGLINK S43RESET,INPUT=(R6,RC)                                          01643000
AS43RESET DC   A(S43RESET+X'80000000')                         @D66ODOW 01644000
         EJECT ,                                                        01645000
*------------------------------------------------------------- @D51IDIS 01646000
* EOTDYNP  - CHECK IF PREPARATION IS TO BE DONE                @D51IDIS 01647000
*------------------------------------------------------------- @D51IDIS 01648000
EOTDYNP  DS    0H                                              @D51IDIS 01649000
         USING PCBADR,R5                                       @D51IDIS 01650000
         TM    PCEFLAG,PCEPREP    PREPARATION TO BE DONE ?     @D51IDIS 01651000
         BZ    EOTDYNP0           NO, RETURN TO MAIN PATH      @D51IDIS 01652000
         STM   R7,RF,EOTSPSAV     SAVE REGISTERS 7 TO F        @D51IDIS 01653000
         L     RB,TCBSAVE         GET SAVE AREA ADDRESS        @D51IDIS 01654000
         L     RC,ASVC43          GET ROUTINE'S BASE ADDRESS   @D51IDIS 01655000
         L     R9,AS43PREPE                                    @D66ODOW 01656000
         DROP  R9                                              @D51IDIS 01657000
         BASSM R9,R9              ENTER PREPAPRATION           @D66ODOW 01658000
*SGLINK S43PREPE,INPUT=(R5,R6,R9,RB,RC),WORK=(R7,R8,RA,RD,RE,RF)        01659000
         L     RD,APBASE          RESTORE SGAP BASE            @D51IDIS 01660000
         L     R9,ATERMBAS        RESTORE BASE REGISTER        @D51IDIS 01661000
         USING TERMBASE,R9                                     @D51IDIS 01662000
         LA    RF,EOTDYNPR        ENTER                        @D66ODOW 01663000
         BSM   0,RF               ... 24BIT MODE               @D66ODOW 01664000
AS43PREPE DC   A(S43PREPE+X'80000000')                         @D66ODOW 01665000
EOTDYNPR DS    0H                                              @D66ODOW 01666000
         LM    R7,RF,EOTSPSAV     RESTORE REGISTER 7 TO F      @D51IDIS 01667000
         B     EOTRESE0           RETURN TO MAIN PATH          @D51IDIS 01668000
         SPACE 2                                               @D51IDIS 01669000
*------------------------------------------------------------- @D51IDIS 01670000
* EOTDYNP0 - CHECK IF INITIALIZATION IS CANCELLED              @D51IDIS 01671000
*------------------------------------------------------------- @D51IDIS 01672000
EOTDYNP0 DS    0H                                              @D51IDIS 01673000
         CLI   TIBCNCL,NORMEOJ    TASK CANCELLED ?             @D51IDIS 01674000
         BE    EOTRESE0           NO, RETURN TO MAIN PATH      @D51IDIS 01675000
         TM    PCEFLAG,PCEINIT    INITIALIZATION CANCELLED ?   @D51IDIS 01676000
         BZ    EOTRESE0           NO, RETURN TO MAIN PATH      @D51IDIS 01677000
         OI    PCEFLAG,PCEICNCL   INDICATE INIT. CANCELLED     @D51IDIS 01678000
         OI    PCEFLAG1,PCEDOCL   PROCESS CLEAN UP             @D51IDIS 01679000
         CLI   TIBCNCL,CANCX24    OPERATOR CANCEL?             @DY46408 01679200
         BNE   EOTRESE0           NO                           @DY46408 01679400
         OI    PCEFLAG,PCEIOPCN   OPERATOR CANCEL FOR POWER    @DY46408 01679600
         B     EOTRESE0           RETURN TO MAIN PATH          @D51IDIS 01680000
         DROP  R5                                              @D51IDIS 01681000
         DROP  R6                                              @D52VDIS 01682000
         DROP  R8                                              @D52VDIS 01683000
         DROP  R9                                              @D64ADIS 01684000
         DROP  RA                                              @D52VDIS 01685000
         DROP  RB                                              @D52VDIS 01686000
         DROP  RD                                              @D52VDIS 01687000
         SPACE 2                                               @D14BDIS 01688000
         DS    0F                                              @D14BDIS 01689000
         DC    CL8'EOT SAVE'      IDENTIFY EOT OWNER SAVE AREA @D14BDIS 01690000
EOTOWNSA DC    F'0'               SAVE LOCATION FOR SAVEAR.PTR.@D36BDFR 01691000
EOTSPSAV DC    16F'0'             REGISTER SAVE AREA           @D61NDIS 01692000
 TITLE 'VSE SUPERVISOR   SGAP         DUMP INITIALIZATION AND RETURN'   01693000
*********************************************************************** 01694000
* INITERMB - TERMINATOR:  MESSAGE WRITER / DUMP / TRACE                 01695000
*                         INITIALIZATION / TERMINATION ROUTINES         01696000
*--------------------------------------------------------------         01697000
* INITERMB - MESSAGE WRITER / DUMP / TRACE INITIALIZATION               01698000
*            ENTERED FROM PDUMP, SDUMP, SDUMPX, CANCEL EXIT             01699000
*            AND FROM TRACE ROUTINES                                    01700000
*                                                                       01701000
*            FUNCTION:                                                  01702000
*              - ENQUEUES TERMINATOR (MESSAGE WRITER AND DUMP)          01703000
*              - REPLACES USER SAVEAREA POINTER                         01704000
*                BY TERMINATOR SAVEAREA PTR.                            01705000
*              - ACTIVATES SVA RESIDENT TERMINATOR ROUTINE              01706000
*            INPUT: R6 - DISPATCHER BASE ADDRESS                        01707000
*                   R8 - TIB ADDRESS                                    01708000
*                   R9 - BASE ADDRESS                                   01709000
*                   RA - TCB ADDRESS                                    01710000
*                   RD - SGAP BASE ADDRESS                              01711000
*            EXIT TO DISPATCHER                                         01712000
**********************************************************************  01713000
         USING DISP,R6                                         @D52VDIS 01714000
         USING TIBADR,R8                                       @D52VDIS 01715000
         USING TERMBASE,R9                                     @D64ADIS 01716000
         USING TCBADR,RA                                       @D52VDIS 01717000
         SPACE 2                                               @D35EDFR 01718000
*SGLINK  INITERMB,S,INPUT=(R6,R8,R9,RA,RD)                              01719000
INITERMB DS    0H                                              @D52VDIS 01720000
         NI    TIBFLAG4,XFF-TIBDMPCN RESET DUMP CNCL INDICATION@KX40960 01721000
         ICM   RB,15,TERMDSAV     FIRST CALL OF DUMP ROUTINE ? @D52VDIS 01722000
         BNZ   INITERNF           NO, SKIP INITIALIZATION      @D52VDIS 01723000
         L     RB,ASVASVDL        PTR.TO SVA ROUT.ADDR.TABLE   @D52VDIS 01724000
         L     RB,ATERM-SVASVDL(,RB)  GET DUMP ROUTINES SAACOMM@D52VDIS 01725000
         ST    RB,TERMDSAV         SAVE ADDRESS                @D52VDIS 01726000
INITERNF DS    0H                                              @D52VDIS 01727000
         L     RC,PCBPTR          GET CURRENT PCB ADDRESS      @D52VDIS 01728000
         USING PCBADR,RC                                       @D52VDIS 01729000
         MVI   RID+1,REENTRID     IDENTIFY REENTRANT ROUTINE   @D52VDIS 01730000
         LA    R7,RWAIT           SET TASK TO WAIT             @D61HDIS 01731000
         TM    TIBTFLAG,TIBTTSTR+TIBTTSTP+TIBTTPER TRACE ?     @D61HDIS 01732000
         BNZ   INITERXP           YES, USE UNPOST, IF WAIT     @D61HDIS 01733000
         LA    R7,UNPOST          SET TASK TO WAIT             @D61HDIS 01734000
         TM    TIBTFLAG,TIBTSDMP+TIBTPDMP PDUMP/SDUMP CALL ?   @D61HDIS 01735000
         BZ    INITERXP           NO, USE UNPOST, IF WAIT      @D61HDIS 01736000
         LA    R7,RESVCX          ASSUME PDUMP/SDUMP, RESVCX   @D61HDIS 01737000
         EJECT ,                                               @D52VDIS 01738000
*--------------------------------------------------------------         01739000
* INITERXP - PARTITION GATING FOR DUMP ROUTINE                          01740000
*--------------------------------------------------------------         01741000
INITERXP DS    0H                                              @D52VDIS 01742000
         LA    R5,SRQPTERM        POINT TO PART. TERM. QUEUE   @D52VDIS 01743000
         DROP  RC                                              @D61HDIS 01744000
         LA    RC,INITERNF        GET CONT. ADDR. FOR RWAIT    @D61HDIS 01745000
         USING RQADR,R5                                        @D52VDIS 01746000
         LR    RF,R6              EXIT ADDR.FOR UNPOST         @D36IDFR 01747000
         TM    RSCDESC,FREEBIT    TERMINATOR AVAILABLE         @D66ODOW 01748000
         BNOR  R7                 NO,SETUP TASK TO REISSUE SVC @D66ODOW 01749000
*SGLINK  UNPOST,INPUT=(R5,R6,RF),WORK=(R5,RE)                           01750000
         L     RC,PCBPTR          GET CURRENT PCB ADDRESS      @D61HDIS 01751000
         USING PCBADR,RC                                       @D61HDIS 01752000
         MVC   RSCDESC,TID        CLOSE TERMINATOR GATE AND    @D66ODOW 01753000
***                               ... SET RESOURCE OWNER                01754000
         DROP  R5                                              @D52VDIS 01755000
         L     R1,PCBSAAPT        GET PARTITION'S SAACOMM ADDR.@D52GDIS 01756000
         USING SAACOMM,R1                                      @D52VDIS 01757000
         CLC   0(1,R1),SAAPLEQ-1(R1) INSURE AREA IN STORAGE    @D52GDIS 01758000
         LA    R0,SAAPLEQ         GET TOTAL LENGTH OF SAACOMM  @D52GDIS 01759000
         STH   R0,SAATLEN         SAVE LENGTH                  @D52GDIS 01760000
         MVC   SAANAME,TERMSAAN   SET FIRST PART OF NAME       @D52GDIS 01761000
         EJECT ,                                               @D52VDIS 01762000
*--------------------------------------------------------------         01763000
*          - INITIALIZE SAACOMM                                         01764000
*--------------------------------------------------------------         01765000
         OI    TIBFLAG1,TERMACT   INDICATE TASK IS TERM.OWNER  @D36IDFR 01766000
         USING SAACOMM,R1                                      @D52VDIS 01767000
         MVI   SAAFLAG1,SAAIUSE   SET IN USE INDICATOR         @D52VDIS 01768000
         MVC   SAANAME+2(2),PCELID  MOVE SYSLOG ID             @D52VDIS 01769000
         TM    TIBTFLAG,TIBTTSTR+TIBTTSTP+TIBTTPER TRACE ?     @D61HDIS 01770000
         BNZ   INITERXT           YES, USE UNPOST, IF WAIT     @D61HDIS 01771000
         TM    TIBTFLAG,TIBTSDMP+TIBTPDMP PDUMP/SDUMP CALL ?   @D61HDIS 01772000
         BNZ   INITERXS           YES, CHECK FOR PDUMP/SDUMP   @D52GDIS 01773000
         MVI   SAAFLAG,ZERO       CLEAR FLAG                   @D52GDIS 01774000
         OI    SAAFLAG1,SAAABEND   SET ABEND DUMP INDICATION   @D52VDIS 01775000
         MVC   SAACCL1(1),TIBCNCL  SAVE FIRST CANCEL CODE      @D52VDIS 01776000
         MVC   SAACCL2(1),TIBCNCL2 SAVE SECOND CANCEL CODE     @D52VDIS 01777000
         MVI   TIBCNCL2,ZERO      FREE SECOND CANCEL CODE      @D36IDFR 01778000
         NI    TIBFLAG,XFF-FETCHEOJ RESET DISPATCHER EXIT FLAG @D36IDFR 01779000
INITTER2 L     R0,INTINFO         LAST INTERRUPTION CODE       @D14BDFR 01780000
INITTERT DS    0H                                              @D61HDIS 01781000
         ST    R0,SAAINTC         SAVE FOR AB-EXIT             @D52VDIS 01782000
         OI    SAAFLAG,SAAPPA     PP SAVE AREA AVAILABLE       @D52VDIS 01783000
         L     R0,TCBSAVE         LOAD CURRENT SAVEAREA PTR.   @D52VDIS 01784000
         TM    TIBFLAG1,LTAOWNER+LTAACT LTA ACT. FOR THIS TASK?@D36BDFR 01785000
         BNO   INITTER1           NO,ZERO OUT SECOND POINTER   @D36BDFR 01786000
         OI    SAAFLAG,SAALTA     SET LTA  SAVE AREA AVAILABLE @D52VDIS 01787000
         ST    R0,SAALTAPT        SETUP SECOND PTR.IN PAR.LIST @D52VDIS 01788000
         L     RF,ASYSPCB         LOAD ATTENTION PCB POINTER   @D51IDIS 01789000
         L     RF,PCEPIB-PCBADR(,RF) LOAD AR PIB POINTER       @D51IDIS 01790000
         L     R0,PIBSAV2N-PIBADR(,RF)   USER PTR.FROM ATT.PIB @D51IDIS 01791000
         EJECT ,                                               @D52GDIS 01792000
*--------------------------------------------------------------         01793000
* INITTER1 - EXCHANGE SAVE AREA POINTERS                                01794000
*--------------------------------------------------------------         01795000
INITTER1 DS    0H                                              @D52VDIS 01796000
         ST    R0,SAAPPSPT        STORE PP SAVE AREA ADDRESS   @D52VDIS 01797000
         OI    SAAFLAG1,SAAARA    INDICATE AR SAVE AREA AVAIL. @D52GDIS 01798000
         L     RF,TCBARSAV        GET AR SAVE AREA ADDRESS     @D61PDIS 01799000
         MVC   SAAARSAV(64),0(RF) MOVE AR AREA TO SAACOMM      @D52GDIS 01800000
         LA    RF,SAARSAVE        GET SAVE AREA ADDRESS        @D52VDIS 01801000
         ST    RF,TCBSAVE         TERMINATOR SAVEAREA          @D52VDIS 01802000
         BAL   R4,TERMSPSV        MOVE SPEC SAVE AREA, IF AVAIL@KX40960 01803000
*SGLINK TERMSPSV,INPUT=(R1,R4,R8),WORK=(R7)                             01804000
         NOP   *                  SPEC. SAVE AREA MOVED        @KX40960 01805000
*--------------------------------------------------------------         01806000
* INITTER4 - EXCHANGE SAVE AREA POINTERS                                01807000
*--------------------------------------------------------------         01808000
INITTER4 DS    0H                                              @D52GDIS 01809000
         TM    SAAFLAG1,SAAABEND  ABEND DUMP ?                 @KX40555 01810000
         BZ    INITTER5           NO, SKIP MESSAGE MOVE        @KX40555 01811000
         LA    R5,SAADMSGI        POINT TO ADDITIONAL MSG INFO @D52GDIS 01812000
         DROP  R6                                              @D61PDIS 01813000
         L     R6,ADISPSER        GET ADDRESS OF DISP.SERVICES @D52GDIS 01814000
         LA    R0,24              SET FUNCTION CODE            @D61PDIS 01815000
         BASSM R7,R6               MOVE  MSG INFORMATION       @D64ADIS 01816000
*SGLINK DISPSMIF,INPUT=(R0,R5,R6,R7,R8,RA),WORK=(R0,R2,RF)              01817000
*                 R7 + 0 - MSG INFO MOVED                      @D52GDIS 01818000
*                 R7 + 4 - NO MSG INFO AVAILABLE               @D52GDIS 01819000
         B     INITTERD           INDICATE ADD. INFO. AVAILABLE@D64ADIS 01820000
         L     RF,TCBSAVE         RESTORE TERMINATOR SAVEAREA  @D52GDIS 01821000
         L     R6,DISPAD          RESTORE DISPATCHER BASE      @D52GDIS 01822000
         USING DISP,R6                                         @D52GDIS 01823000
INITTER5 DS    0H                                              @KX40555 01824000
         LA    R0,TIBFLAG4-2      GET DUMP CNCL ECB ADDRESS    @D52GDIS 01825000
         ST    R0,SAACNECB        AND SAVE IT IN SAACOMM       @D52GDIS 01826000
         EJECT ,                                               @D64XDIS 01827000
*--------------------------------------------------------------         01828000
*          - SAVE CONTROL REGISTERS INTO SAACOMM                        01829000
*            AND SET UP HOME SPACE ENVIRONMENT                          01830000
*--------------------------------------------------------------         01831000
*        AMODESW SET,AMODE=31,WR=(2)                           @D64XDIS 01832000
         AMODESW SET,AMODE=31,WR=(2)                           @D64XDIS 01833000
         L     R2,TCBATCBE        GET SYS TASK TCB EXT         @D64XDIS 01834000
         USING TCBXADR,R2                                      @D64XDIS 01835000
         NI    TCBXFLG1,XFF-TCBXFRRA SET FRR INACTIVE          @D64ADIS 01836000
         MVC   SAACRSAV(64),TCBX1CR0 MOVE APPL.S CONTROL REG.S @D64XDIS 01837000
         CLC   TCBX1CR1(4),TCBX1CR7 PASN=SASN ?                @D64XDIS 01838000
         BNE   INITTEXM           NO, X-MEMORY MODE            @D64XDIS 01839000
         CLC   TCBX1CR1(4),TCBX1CRD PASN=HASN ?                @D64XDIS 01840000
         BE    TERMABND           YES, EXECUTING IN HOME SPACE @D64XDIS 01841000
INITTEXM DS    0H                                              @D64XDIS 01842000
         L     R5,SCBPTR          GET SCB ADDRESS              @D64XDIS 01843000
         USING SCBADR,R5                                       @D64XDIS 01844000
         MVC   TCBX1CR1,SCBRSTO                                @D64XDIS 01845000
         MVC   TCBX1CR7,SCBRSTO                                @D64XDIS 01846000
         MVC   TCBX1CRD,SCBRSTO                                @D64XDIS 01847000
         LH    R4,PCBPIK                                       @D64XDIS 01848000
         SRL   R4,4               ASN = PIK /16                @D64XDIS 01849000
         STH   R4,TCBX1CR3+2                                   @D64XDIS 01850000
         STH   R4,TCBX1CR4+2                                   @D64XDIS 01851000
         DROP  R2                                              @D64XDIS 01852000
         DROP  R5                                              @D64XDIS 01853000
         EJECT ,                                               @D52VDIS 01854000
*--------------------------------------------------------------         01855000
* TERMABND - PREPARE DUMP SAVE AREA                                     01856000
*            INPUT: R1 - PARTITION'S SAACOMM ADDRESS                    01857000
*                   R6 - DISPATCHER BASE ADDRESS                        01858000
*                   R8 - TIB ADDRESS                                    01859000
*                   R9 - BASE ADDRESS                                   01860000
*                   RA - TCB ADDRESS                                    01861000
*                   RB - MASTER SAACOMM ADDRESS                         01862000
*                   RC - PCB ADDRESS                                    01863000
*                   RF - DUMP ROUTINE'S SAVE AREA ADDRESS               01864000
*            AMODE: ANY                                                 01865000
*--------------------------------------------------------------         01866000
TERMABND DS    0H                                              @D52VDIS 01867000
*        DISPMAC FUNC=TERMH       SET TASK TO HIGH PRIORITY    @D61RDIS 01868000
         DISPMAC FUNC=TERMH                                    @D61RDIS 01869000
         USING SVEARA,RF                                       @D52VDIS 01870000
         L     R0,SAADSTRT-SAACOMM(,RB) GET START ADDRESS      @D52VDIS 01871000
         ST    R0,SVEPSW2         TERMINATOR ENTRY POINT       @D52VDIS 01872000
         ST    R1,SVER00          SAVE SAACOMM ADDRESS         @D52VDIS 01873000
         LA    R0,TERMSERV        GET TERMINATOR SERVICE ADDR. @D52VDIS 01874000
         ST    R0,SVER01          SAVE ADDRESS IN REG. 1       @D52VDIS 01875000
         USING SGAP,RD                                         @D52VDIS 01876000
         MVC   SVEPSW(4),PSWFRAME COPY STANDARD PSW FRAME      @D14BDFR 01877000
         DROP  RD                                              @D52VDIS 01878000
         NI    TIBTFLAG,XFF-TIBTTACT RESET TRACE               @KXA0065 01879000
         TM    TCBEXIFL,TCBEXIMS  ONLY MESSAGE TO BE PRINTED ? @D64ADIS 01880000
         BZ    INITTER3           NO, SKIP                     @D64ADIS 01881000
         OI    SAAFLAG1,SAANODMP  INDICATE MSG REQ'D TO DUMP   @D52VDIS 01882000
INITTER3 DS    0H                 POINT TO PCB                 @D52VDIS 01883000
         TM    PCBFLAG,PERACT     TEST PER BIT IN PCBFLAG      @D14BDFR 01884000
         BZR   R6                 PER BIT NOT ON   --->        @D14BDFR 01885000
         OI    SVEPSW,PERMASK     ENABLE PROGR.EVENT RECORDING @D14BDFR 01886000
         BR    R6                 GOTO DISPATCH TERMINATOR/DUMP@D35EDFR 01887000
         DROP  R6                                              @D52VDIS 01888000
         DROP  RC                                              @D52VDIS 01889000
         DROP  RF                                              @D52VDIS 01890000
         EJECT ,                                               @D64ADIS 01891000
*--------------------------------------------------------------         01892000
* INITTERD - MSG INFO MOVED                                             01893000
*--------------------------------------------------------------         01894000
INITTERD DS    0H                                              @D64ADIS 01895000
         OI    SAAFLAG1,SAAMSGI   INDICATE ADD. INFO. AVAILABLE@D64ADIS 01896000
         LA    R0,28              SET FUNCTION CODE            @D64ADIS 01897000
         BASSM R7,R6               RESET MSG INFORMATION       @D64ADIS 01898000
*SGLINK DISPSE28,INPUT=(R0,R6,R7,R8,RA),WORK=(R0,R2,RF)                 01899000
*                 R7 + 0 - MSG INFO MOVED                      @D64ADIS 01900000
*                 R7 + 4 - NO MSG INFO AVAILABLE               @D64ADIS 01901000
         L     RF,TCBSAVE         RESTORE TERMINATOR SAVEAREA  @D64ADIS 01902000
         L     R6,DISPAD          RESTORE DISPATCHER BASE      @D64ADIS 01903000
         B     INITTER5           RETURN TO MAIN PATH          @D64ADIS 01904000
         EJECT ,                                               @D64ADIS 01905000
*--------------------------------------------------------------         01906000
* INITERXS - SET PDUMP / SDUMP INDICATIONS                              01907000
*--------------------------------------------------------------         01908000
INITERXS DS    0H                                              @D52GDIS 01909000
         MVI   SAAFLAG,SAASDUMP   ASSUME SDUMP REQUEST         @D52GDIS 01910000
         NI    TIBFLAG2,XFF-SVPCCNCL SPEC.SAVE AREA NOT VALID  @KX40960 01911000
         TM    TIBTFLAG,TIBTSDMP  CALLED BY SDUMP ?            @D52GDIS 01912000
         BO    INITTER2           YES, RETURN TO MAIN PATH     @D52GDIS 01913000
         MVI   SAAFLAG,SAAPDUMP   SET PDUMP REQUEST            @D52GDIS 01914000
         B     INITTER2           RETURN TO MAIN PATH          @D52GDIS 01915000
         EJECT ,                                               @D61HDIS 01916000
*--------------------------------------------------------------         01917000
* INITERXT - SET TRACE INDICATIONS                                      01918000
*--------------------------------------------------------------         01919000
INITERXT DS    0H                                              @D61HDIS 01920000
         NI    TIBFLAG2,XFF-SVPCCNCL SPEC.SAVE AREA NOT VALID  @D61HDIS 01921000
         TM    TIBTFLAG,TIBTTPER  PER  REQUEST ?               @D61HDIS 01922000
         BZ    INITERX0           NO, CHECK FOR START REQUEST  @D61HDIS 01923000
         MVI   SAATFLAG,SAATPER   ASSUME PER   REQUEST         @D61HDIS 01924000
         MVC   SAAPERAD(4),SVCWORK GET PER ADDRESS             @D61HDIS 01925000
         MVC   SAAPERCD(1),SVCWORK+4 GET PER CODE              @D61HDIS 01926000
         MVC   SAAPERAC(1),SVCWORK+5 GET PER ACCESS ID         @D61HDIS 01927000
         TM    TIBTFLAG,TIBTTSVC  PER  REQUEST ?               @D61HDIS 01928000
         BZ    INITTER2           RETURN TO MAIN PATH          @D61HDIS 01929000
         L     R0,SVCWORK+8       GET SVC INTERRUPT INFO.      @D61HDIS 01930000
         B     INITTERT           RETURN TO MAIN PATH          @D61HDIS 01931000
         SPACE 2                                               @D61HDIS 01932000
INITERX0 DS    0H                                              @D61HDIS 01933000
         MVI   SAATFLAG,SAATSTRT  ASSUME START REQUEST         @D61HDIS 01934000
         TM    TIBTFLAG,TIBTTSTR  START REQUEST ?              @D61HDIS 01935000
         BO    INITTER2           YES, RETURN TO MAIN PATH     @D61HDIS 01936000
         MVI   SAATFLAG,SAATSTOP  ASSUME STOP  REQUEST         @D61HDIS 01937000
         B     INITTER2           RETURN TO MAIN PATH          @D61HDIS 01938000
         DROP  R1                                              @D52VDIS 01939000
         DROP  R8                                              @KX40960 01940000
         DROP  RA                                              @D52VDIS 01941000
         SPACE 2                                               @D61NDIS 01942000
*--------------------------------------------------------------         01943000
*          - DUMP / TERMINATOR WORK AREAS                               01944000
*--------------------------------------------------------------         01945000
TERMDSAV DC    A(0)               DUMP'S PHASE START           @D52VDIS 01946000
TERMSCSA DC    A(0)               SAACOMM ADDRESS OF PARTITION @D52VDIS 01947000
*                                 THAT OWNS THE SYSTEM RESOURCE@D52VDIS 01948000
TERMSAAN DC    C'SA  '            FIRST PART OF SAACOMM NAME   @D52GDIS 01949000
         EJECT ,                                               @D52VDIS 01950000
*--------------------------------------------------------------         01951000
* TERMRETB - NORMAL RETURN FROM SVA RES.MESSAGE WRITER                  01952000
*            ENTERED FROM SVC 14                                        01953000
*            FUNCTION:                                                  01954000
*              - DEQUEUES TERMINATOR, IF NECESSARY                      01955000
*              - RESTORES SAVE AREA POINTER, ETC.                       01956000
*            INPUT:  R6 - DISPATCHER BASE ADDRESS                       01957000
*                    R8 - TIB ADDRESS                                   01958000
*                    R9 - BASE ADDRESS                                  01959000
*                    RA - TCB ADDRESS                                   01960000
*                    RD - SGAP BASE ADDRESS                             01961000
*            OUTPUT: RB - SAVE AREA ADDRESS                             01962000
*            WORK:   R5, R7, RF                                         01963000
*--------------------------------------------------------------         01964000
         USING DISP,R6                                         @D52VDIS 01965000
         USING TIBADR,R8                                       @D52VDIS 01966000
         USING TCBADR,RA                                       @D52VDIS 01967000
*SGLINK  TERMRETB,S,INPUT=(R6,R8,R9,RA,RD),WORK=(R5,R7,RF),OUTPUT=(RB)  01968000
TERMRETB DS    0H                                              @D52VDIS 01969000
         LR    R7,R1              SAVE REGISTER 1              @D52VDIS 01970000
         L     RF,PCBPTR          GET CURRENT PCB ADDRESS      @D52VDIS 01971000
         USING PCBADR,RF                                       @D52VDIS 01972000
         L     R1,PCBSAAPT        GET SAACOMM ADDRESS          @D52VDIS 01973000
         USING SAACOMM,R1                                      @D52VDIS 01974000
         CLC   0(1,R1),SAAPLEQ-1(R1) INSURE AREA IN STORAGE    @D52VDIS 01975000
         LA    R5,TERMRE31        GET CONTINUATION ADDRESS     @D64XDIS 01976000
         O     R5,BIT0OMSK           ... AND SWITCH TO 31 BIT  @D64ADIS 01977000
         BSM   0,R5                                            @D64XDIS 01978000
TERMRE31 DS    0H                                              @D64XDIS 01979000
         L     R5,TCBATCBE        GET SYS TASK TCB EXT         @D64XDIS 01980000
         USING TCBXADR,R5                                      @D64XDIS 01981000
         MVC   TCBX1CR0(64),SAACRSAV RESTORE CONTROL REGISTERS @D64XDIS 01982000
         DROP  R5                                              @D64XDIS 01983000
         LA    R5,TERMRE24        GET CONTINUATION ADDRESS     @D64XDIS 01984000
         BSM   0,R5                                            @D64XDIS 01985000
TERMRE24 DS    0H                                              @D64XDIS 01986000
         NI    TIBFLAG4,XFF-TIBDMPCN RESET INDICATIONS         @D52VDIS 01987000
         TM    SAAFLAG1,SAANGETV  GETVIS ERROR OCCURRED ?      @D52VDIS 01988000
         BO    TERMGERR           YES, CALL DUMP AGAIN WITH    @D52VDIS 01989000
*                                 MASTER SAACOMM               @D52VDIS 01990000
TERMRETL DS    0H                                              @D52VDIS 01991000
         L     RB,SAAPPSPT        GET SAVE AREA POINTER        @D52VDIS 01992000
         TM    SAAFLAG,SAALTA     LTA OWNER ?                  @D52VDIS 01993000
         BZ    TERMRETN           NO, USE SAVE AREA ADDRESS    @D52VDIS 01994000
         L     RB,SAALTAPT        USE LTA'S SAVE AREA INSTEAD  @D52VDIS 01995000
TERMRETN DS    0H                                              @D52VDIS 01996000
         CLC   PCBATRAX(4),F0     TRACE ACTIVE ?               @D61HDIS 01997000
         BE    TERMNOTR           NO, SKIP                     @D61HDIS 01998000
         OI    TIBTFLAG,TIBTTACT  SET TRACE ACTIVE             @KXA0065 01999000
TERMNOTR DS    0H                                              @D61HDIS 02000000
         TM    PCBSAAPT,PCBMSAAE  SYSTEM GATING USED ?         @D52VDIS 02001000
         BZ    TERMRET1           NO, FREE PARTITION GATE      @D52VDIS 02002000
         DROP  RF                                              @D52VDIS 02003000
         EJECT ,                                               @D52VDIS 02004000
*--------------------------------------------------------------         02005000
*          - POST SYSTEM GATE AND CONTINUE WITH                         02006000
*            PARTITION'S SAACOMM, IF AVAILABLE                          02007000
*--------------------------------------------------------------         02008000
         L     R5,ASRQTAB         GET ADDRESS OF SRQTAB        @D61RDIS 02009000
         LA    R5,SRQTERM-SRQTAB(,R5)  SET SYSTEM GATE         @D61RDIS 02010000
         BAL   RF,RPOST           POST HIGHEST PRIORITY WAITER @D52VDIS 02011000
*SGLINK  RPOST,INPUT=(R5,R6,RF),WORK=(R5,RE)                            02012000
         NI    TIBDMFLG,XFF-TIBTERMX RESET DISPATCHER EXIT     @D52GDIS 02013000
         NI    DISPHIFL,XFF-TERMACT  RESET INDICATION          @D52VDIS 02014000
         NI    TIBFLAG4,XFF-TIBDMPHI RESET INDICATION          @D52VDIS 02015000
         MVI   SAAFLAG1,ZERO      RESET FLAGS                  @D52VDIS 02016000
         L     RF,PCBPTR          GET CURRENT PCB ADDRESS      @D52VDIS 02017000
         USING PCBADR,RF                                       @D52VDIS 02018000
         SLR   RE,RE              SET SAACOMM ADDRESS IN PCB ..@D52VDIS 02019000
         L     R5,TERMSCSA        GET PARTITION'S SAACOMM ADDR.@D52VDIS 02020000
         ST    RE,TERMSCSA        CLEAR SAACOMM ADDRESS        @D52VDIS 02021000
         ST    R5,PCBSAAPT        SAVE SAACOMM ADDR. IN PCB    @D52VDIS 02022000
         MVI   SAAFLAG,ZERO       RESET MASTER SAACOMM FLAGS   @D52VDIS 02023000
         MVI   SAATFLAG,ZERO      RESET FLAGS                  @D61HDIS 02024000
         LR    R1,R5              SWITCH TO PARTITION'S SAACOMM@D52VDIS 02025000
         CLC   0(1,R1),SAAPLEQ-1(R1) INSURE AREA IN STORAGE    @D52VDIS 02026000
         EJECT ,                                               @D52VDIS 02027000
*--------------------------------------------------------------         02028000
* TERMRET1 - POST PARTITION GATE                                        02029000
*--------------------------------------------------------------         02030000
TERMRET1 DS    0H                                              @D52VDIS 02031000
         MVI   SAAFLAG1,ZERO      RESET FLAGS                  @D52VDIS 02032000
         LA    R5,SRQPTERM        SET PARTITION GATE           @D52VDIS 02033000
         DROP  RF                                              @D52VDIS 02034000
         BAL   RF,RPOST           POST HIGHEST PRIORITY WAITER @D52VDIS 02035000
*SGLINK  RPOST,INPUT=(R5,R6,RF),WORK=(R5,RE)                            02036000
         NI    TIBFLAG1,XFF-TERMACT RESET TERM. OWNER FLAG     @D36IDFR 02037000
*        DISPMAC FUNC=TERML       SET TASK TO LOW  PRIORITY    @D61RDIS 02038000
         DISPMAC FUNC=TERML                                    @D61RDIS 02039000
         ST    RB,TCBSAVE          LOAD RB PROPERLY            @DA29656 02040000
*--------------------------------------------------------------         02041000
         ICM   RF,15,TCBFREX      GET ADDRESS OF FRR STACK     @D64XDIS 02042000
         BZ    TERMRE01           FRR STACK EMPTY -->>>        @D64XDIS 02043000
         USING FRRS,RF                                         @D64XDIS 02044000
         L     R5,FRRSCURR        GET ADDR. OF FIRST FREE ENTRY@D64XDIS 02045000
         C     R5,FRRSEMP         STACK EMPTY ?                @D64XDIS 02046000
         BE    TERMRE01           YES, SKIP                    @D64XDIS 02047000
         DROP  RF                                              @D64XDIS 02048000
         L     RF,TCBATCBE        GET ADDR. OF TCB EXTENSION   @D64XDIS 02049000
         USING TCBXADR,RF                                      @D64XDIS 02050000
         OI    TCBXFLG1,TCBXFRRA  SET FRR ACTIVE               @D64XDIS 02051000
         DROP  RF                                              @D64XDIS 02052000
TERMRE01 DS    0H                                              @D64XDIS 02053000
*--------------------------------------------------------------         02054000
         L     RF,TCBARSAV        GET AR SAVE AREA ADDRESS     @D61PDIS 02055000
         MVC   0(64,RF),SAAARSAV  RESTORE AR SAVE AREA         @D52GDIS 02056000
         MVC   INTINFO(4),SAAINTC RESET INTERRUPTION CODE      @D52VDIS 02057000
         TM    VTAMFLG,VTAPDEL    VTAM AP PROC.TO BE ACTIVATED @D36IDFR 02058000
         BZ    TERMNOVT           NO --->                      @D36IDFR 02059000
         NI    VTAMFLG,XFF-VTAPDEL RESET AP DELAY INDICATOR    @D36IDFR 02060000
         OI    TIBFLAG,APSEXFLG   TURN ON DISPATCHER EXIT FLAG @D36IDFR 02061000
         EJECT ,                                               @D52VDIS 02062000
*--------------------------------------------------------------         02063000
* TERMNOVT - PROCESS RETURN TO PDUMP/SDUMP OR TERMINATOR                02064000
*--------------------------------------------------------------         02065000
TERMNOVT DS    0H                                              @D36IDFR 02066000
         USING SGAP,RD                                         @D52VDIS 02067000
         MVI   SAAFLAG,ZERO       RESET FLAGS                  @D61HDIS 02068000
         MVI   SAATFLAG,ZERO      RESET FLAGS                  @D61HDIS 02069000
         DROP  R1                                              @D61HDIS 02070000
         LR    R1,R7              RESTORE REGISTER 1           @D52VDIS 02071000
         TM    TIBTFLAG,XFF-TIBTTACT   TERMINATION IN PROCESS? @KXA0065 02072000
         BZ    SETEOJSW          YES,CONTINUE TASKS TERMINATION@D52VDIS 02073000
*SGLINK  SETEOJSW,INPUT=(R6,R8,RA,RB,RD)                                02074000
         TM    TIBTFLAG,TIBTTSTP  TRACE STOP REQUESTED ?       @D61HDIS 02075000
         BO    ENDTERM           YES,CONTINUE CLEAN UP PROCESS @D61HDIS 02076000
*SGLINK  ENDTERM,INPUT=(R6,R8,RA,RD)                                    02077000
         DROP  RD                                              @D52VDIS 02078000
         TM    TIBCNCL,XFF        TERMINATOR CANCELLED?        @D14BDFR 02079000
         BNM   NOTRMCNC           NO, DO NOT INITIATE CANCEL   @D61HDIS 02080000
         OI    TIBFLAG,FETCHEOJ   ACTIVATE CANCEL EXIT         @D14BDFR 02081000
         TM    TIBTFLAG,TIBTSDMP+TIBTPDMP PDUMP/SDUMP CALL ?   @D61HDIS 02082000
         BZ    NODELCNL           NO,DO NOT SET SPECIAL CANCEL @D61HDIS 02083000
         OI    TIBFLAG4,TIBDMPCN  INDICATE S/PDUMP CANCELLED   @KX40960 02084000
NODELCNL DS    0H                                              @D51IDIS 02085000
         MVI   TIBTFLAG,ZERO      RESET TRACE ROUTINE IND.     @D61HDIS 02086000
NOTRMCNC DS    0H                                              @D61HDIS 02087000
*        AMODESW SET,AMODE=31,WR=(2)                           @D64ADIS 02088000
         AMODESW SET,AMODE=31,WR=(2)                           @D64ADIS 02089000
         CLC   TID(2),IJBHMTID    IS IT MAINTASK               @D51IDIS 02090000
         BH    TERMNOOC           NO, DO NOT TEST FOR OC       @D36IDFR 02091000
         L     R7,PCBPTR          LOAD PCB POINTER             @D36IDFR 02092000
         ICM   R7,15,PCBOCPTR-PCBADR(R7) GET OC EXIT BLOCK ADDR@D64ADIS 02093000
         BZ    TERMNOOC           NOT AVAILABLE -> SKIP        @D64ADIS 02094000
         USING EXITBLK,R7                                      @D64ADIS 02095000
         TM    EXITFLG,DELINT     OC TO BE PROCESSED ?         @D64ADIS 02096000
         BZ    TERMNOOC           NO, DO NOT CHANGE TIBFLAG    @D64ADIS 02097000
         NI    EXITFLG,XFF-DELINT RESET DEL.OC.IND.            @D64ADIS 02098000
         OI    TIBFLAG,OCPEND     FLAG OC INTERRUPT PENDING    @D36IDFR 02099000
         DROP  R7                                              @D64ADIS 02100000
TERMNOOC DS    0H                                              @D36IDFR 02101000
         L     R7,TCBATCBE        GET ADDRESS OF TCB EXTENSION @D64ADIS 02102000
         USING TCBXADR,R7                                      @D64ADIS 02103000
         ICM   R7,B'1111',TCBXTQCA GET ADDRESS OF IT EXIT BLOCK@D64ADOW 02104000
         BZ    TERMSPER           NO TIMER EXIT DELAYED        @D64ADIS 02105000
         USING EXITBLK,R7                                      @D64ADIS 02106000
         TM    EXITFLG,DELINT     IT INTERRUPT TO BE PROCESSED?@D64ADIS 02107000
         BZ    TERMSPER           NO, DO NOT CHANGE TIBFLAG    @D61HDIS 02108000
         NI    EXITFLG,XFF-DELINT RESET DELAYED INT. IND.      @D51HDOW 02109000
         OI    TIBFLAG,CDELEX     FLAG IT INTERRUPT PENDING    @D36IDFR 02110000
         DROP  R7                                              @D64ADIS 02111000
         EJECT ,                                               @D52VDIS 02112000
*--------------------------------------------------------------         02113000
* TERMSPER - SVC OR PCK FLIH CODE TO BE PROCESSED AFTER                 02114000
*            TRACE ROUTINE ?                                            02115000
*--------------------------------------------------------------         02116000
TERMSPER DS    0H                                              @D61HDIS 02117000
         L     R5,INTINFO         SAVE INTERRUPT INFORMATION   @D61HDIS 02118000
         TM    TIBTFLAG,TIBTTPCK  PCK TO BE PROCESSED ?        @D61HDIS 02119000
         BO    TERMSPCK           YES, PROCESS PCK INTERRUPT   @D61HDIS 02120000
         TM    TIBTFLAG,TIBTTSVC  SVC TO BE PROCESSED ?        @D61HDIS 02121000
         BO    TERMSSVC           YES, PROCESS SVC INTERRUPT   @KXA0065 02122000
         NI    TIBTFLAG,TIBTTACT  RESET TRACE ROUTINE IND.     @KXA0065 02123000
         BR    R6                 NO,DO NOT PROCESS SVC INT.   @D61HDIS 02124000
*--------------------------------------------------------------         02125000
* TERMSSVC - CONTINUE WITH SVC FLIH PROCESS                             02126000
*--------------------------------------------------------------         02127000
TERMSSVC DS    0H                                              @KXA0065 02128000
         ST    R5,SVCINF          RESTORE INTERRUPT INFORMATION@D61HDIS 02129000
         MVC   ERA(8),SCNPSW      CONTINUE WITH SVC NEW PSW    @D61HDIS 02130000
         LA    R2,SVOLDP          GET ADDRESS OF SVC OLD PSW   @D61HDIS 02131000
         B     TERMSRET           RESTORE REGISTERS            @D61HDIS 02132000
         SPACE 2                                               @D61HDIS 02133000
*--------------------------------------------------------------         02134000
* TERMSPCK - CONTINUE WITH PCK FLIH PROCESS                             02135000
*--------------------------------------------------------------         02136000
TERMSPCK DS    0H                                              @D61HDIS 02137000
         ST    R5,PGMINF          RESTORE INTERRUPT INFORMATION@D61HDIS 02138000
         NI    PGMINF+3,X'7F'     RESET PER INDICATOR          @D61HDIS 02139000
         MVC   ERA(8),PCNPSW      CONTINUE WITH PCK NEW PSW    @D61HDIS 02140000
         LA    R2,PCOLDP          GET ADDRESS OF PCK OLD PSW   @D61HDIS 02141000
         NI    TIBTFLAG,TIBTTACT  RESET TRACE ROUTINE IND.     @D64XDIS 02142000
         CLI   PGMINTC+1,X'9C'    SPACE SWITCH EVENT ?         @D64XDIS 02143000
         BE    DISP               YES, DISPATCH USER CODE      @D64XDIS 02144000
         EJECT ,                                               @D64ADIS 02145000
*--------------------------------------------------------------         02146000
* TERMSRET - RESTORE STATUS OF INTERRUPTED APPLICATION                  02147000
*--------------------------------------------------------------         02148000
TERMSRET DS    0H                                              @D61PDIS 02149000
         NI    TIBTFLAG,TIBTTACT  RESET TRACE ROUTINE IND.     @KXA0065 02150000
         USING SVEARA,RB                                       @D64XDIS 02151000
         CLC   SVEARA(1),SVEEND-1 GET SAVE AREA INTO STORAGE   @D61HDIS 02152000
         MVC   0(8,R2),SVEPSW     RESTORE OLD PSW              @D61PDIS 02153000
         L     R2,TCBATCBE        GET ADDR. OF TCB EXTENSION   @D61PDIS 02154000
         USING TCBXADR,R2                                      @D61PDIS 02155000
         LCTL  CR1,CRF,TCBX1CR1   SET CONTROL REGISTER 15      @D64XDIS 02156000
*--------------------------------------------------------------         02157000
*          - ACTIVATE TASKS PROCESSING                                  02158000
*          - LOAD FLOATING POINT REGISTERS                              02159000
*          - LOAD ACCESS REGISTERS AND GENERAL PURPOSE REGISTERS        02160000
*          - ENTRY POINT FOR SPECIAL TRACE FUNCTIONS                    02161000
*--------------------------------------------------------------         02162000
         LD    FPR0,SVEFP0        RESTORE FLPT REGISTER 0      @D64ADIS 02163000
         LD    FPR2,SVEFP2        RESTORE FLPT REGISTER 2      @D64ADIS 02164000
         LD    FPR4,SVEFP4        RESTORE FLPT REGISTER 4      @D64ADIS 02165000
         LD    FPR6,SVEFP6        RESTORE FLPT REGISTER 6      @D64ADIS 02166000
*--------------------------------------------------------------         02167000
* RETURN   - LOAD ACCESS REGISTERS AND GENERAL PURPOSE REGISTERS        02168000
*--------------------------------------------------------------         02169000
RETURN   DS    0H                                              @D64ADIS 02170000
         L     R9,TCBARSAV        GET AR SAVE AREA POINTER     @D64ADIS 02171000
         LAM   R0,RF,0(R9)        RESTORE ACCRESS REGISTERS    @D64ADIS 02172000
         LM    R9,R8,SVER09       LOAD TASKS GENERAL REGISTERS @D64ADIS 02173000
         MVI   RID+1,USERTID      IDENTIFY TASK PROCESSING     @D64ADIS 02174000
DISP300  DS    0H                                              @D64ADIS 02175000
         NOP   0                  DISPATCHER EXIT ...          @D64ADIS 02176000
         NOP   0                             ...        ...    @D64ADIS 02177000
         NOP   0                             ... VENDOR ...    @D64ADIS 02178000
         NOP   0                                       ... HOOK@D64ADIS 02179000
*        DEBUG ERAPSW,XXDBGMC                                  @D64ADIS 02180000
         DEBUG ERAPSW,XXDBGMC                                  @D64ADIS 02181000
         LPSW  ERA                ACTIVATE TASKS PROC.VIA LPSW @D64ADIS 02182000
         DROP  R2                                              @D64ADIS 02183000
         DROP  R6                                              @D52VDIS 02184000
         DROP  R8                                              @D52VDIS 02185000
         DROP  R9                                              @D31EDOW 02186000
         DROP  RB                                              @D61HDIS 02187000
         DROP  RA                                              @D52VDIS 02188000
         EJECT ,                                               @D52VDIS 02189000
*--------------------------------------------------------------         02190000
* TERMGERR - DUMP ROUTINE RETURNS WITH GETVIS ERROR VIA SVC 14          02191000
*          - THE GETVIS ERROR INDICATION WILL NOT BE SET INTO           02192000
*            THE MASTER SAACOMM                                         02193000
*--------------------------------------------------------------         02194000
         USING SAACOMM,R1                                      @D52VDIS 02195000
         USING DISP,R6                                         @D52VDIS 02196000
         USING TIBADR,R8                                       @D52VDIS 02197000
         USING TERMBASE,R9                                     @D31EDOW 02198000
         USING TCBADR,RA                                       @D52VDIS 02199000
TERMGERR DS    0H                                              @D52VDIS 02200000
         NI    SAAFLAG1,XFF-SAANGETV  RESET GETVIS ERROR IND.  @D52VDIS 02201000
         USING PCBADR,RF                                       @D52VDIS 02202000
         TM    PCBSAAPT,PCBMSAAE  SYSTEM GATING USED ?         @D52VDIS 02203000
         BO    TERMRETL           YES, MUST BE AN ERROR        @D52VDIS 02204000
*                                 CONTINUE WITH NORMAL PROCESS @D52VDIS 02205000
         DROP  RF                                              @D52VDIS 02206000
*--------------------------------------------------------------         02207000
*          - CALL DUMP ROUTINE AGAIN WITH MASTER SAACOMM, IF            02208000
*            DUMP ROUTINE GOT A GETVIS ERROR                            02209000
*--------------------------------------------------------------         02210000
         L     RB,TERMDSAV        GET MASTER SAACOMM ADDRESS   @D52VDIS 02211000
         LA    R7,RWAIT           CALL ROUTINE, IF WAIT        @D52VDIS 02212000
         BAL   R4,INITERG         OCCUPY MASTER SAACOMM        @D52VDIS 02213000
*SGLINK INITERG,INPUT=(R1,R4,R6,R7,R8,R9,RB),                          *02214000
               OUTPUT=(RC),WORK=(R5,RE,RF)                              02215000
         MVC   SAANAME-SAACOMM(4,RB),SAANAME MOVE SAACOMM NAME @D52VDIS 02216000
*                 DO NOT CHANGE MASTER SAACOMM LENGTH (SAATLEN)@D52VDIS 02217000
         MVC   SAAFLAG-SAACOMM(SAAINLEQ,RB),SAAFLAG            @D52VDIS 02218000
*                                     MOVE INDEPENDENT PART    @D52VDIS 02219000
         MVC   SAACNECB-SAACOMM(SAAINLE2,RB),SAACNECB          @D52VDIS 02220000
*                                     MOVE INDEPENDENT PART    @D52VDIS 02221000
         L     RF,TCBSAVE         GET DUMP ROUTINE'S S.AREA PTR@D52VDIS 02222000
         LR    R1,RB              MASTER SAACOMM IS NOW ACTIVE @D52VDIS 02223000
         B     TERMABND           CALL DUMP ROUTINE AGAIN      @D52VDIS 02224000
         DROP  R1                                              @D52VDIS 02225000
         DROP  R6                                              @D52VDIS 02226000
         DROP  R8                                              @D52VDIS 02227000
         DROP  R9                                              @D52VDIS 02228000
         DROP  RA                                              @D52VDIS 02229000
         EJECT ,                                               @KX40960 02230000
*--------------------------------------------------------------         02231000
* INITERG  - TRY TO OCCUPY DUMP ROUTINE'S SYSTEM GATE                   02232000
*            INPUT:  R1 - PARTITION'S SAACOMM ADDRESS                   02233000
*                    R4 - RETURN ADDRESS                                02234000
*                    R6 - DISPATCHER BASE ADDRESS                       02235000
*                    R7 - ROUTINE TO BE EXECUTED, IF RESOURCE           02236000
*                         OCCUPIED                                      02237000
*                    R8 - TIB ADDRESS                                   02238000
*                    R9 - BASE REGISTER                                 02239000
*                    RB - MASTER SAACOMM ADDRESS                        02240000
*            OUTPUT: RC - PCB ADDRESS                                   02241000
*            WORK:   R5, RE, RF                                         02242000
*--------------------------------------------------------------         02243000
         USING DISP,R6                                         @D52VDIS 02244000
         USING TIBADR,R8                                       @D52VDIS 02245000
         USING TERMBASE,R9                                     @D52VDIS 02246000
*SGLINK INITERG,S,INPUT=(R1,R4,R6,R7,R8,R9,RB),                        *02247000
               OUTPUT=(RC),WORK=(R5,RE,RF)                              02248000
INITERG  DS    0H             ENTRY POINT IF DUMP GETVIS ERROR @D52VDIS 02249000
         LA    RC,INITERG         RETURN ADDRESS, IF RWAIT     @D52VDIS 02250000
         L     R5,ASRQTAB         GET ADDRESS OF SRQTAB        @D61RDIS 02251000
         LA    R5,SRQTERM-SRQTAB(,R5)  SET SYSTEM GATE         @D61RDIS 02252000
         USING RQADR,R5                                        @D52VDIS 02253000
         LR    RF,R6              EXIT ADDR.FOR UNPOST         @D52VDIS 02254000
         TM    RSCDESC,FREEBIT    TERMINATOR AVAILABLE         @D66ODOW 02255000
         BNOR  R7                 NO,SETUP TASK TO WAIT        @D66ODOW 02256000
*SGLINK  UNPOST,INPUT=(R5,R6,RF),WORK=(R5,RE)                           02257000
         MVC   RSCDESC,TID        CLOSE TERMINATOR GATE AND    @D66ODOW 02258000
***                               ... SET RESOURCE OWNER                02259000
         OI    TIBFLAG4,TIBDMPHI  RUN DUMP WITH HIGH PRIO.     @D52VDIS 02260000
         OI    DISPHIFL,TERMACT   INDICATE TASK IS TERM. OWNER @D52VDIS 02261000
         OI    TIBFLAG1,TERMACT   INDICATE TASK IS TERM.OWNER  @D36IDFR 02262000
         ST    R8,TERMTIB         SAVE TASKS TIB ADDRESS       @D52VDIS 02263000
         USING SAACOMM,R1                                      @D52VDIS 02264000
         OI    SAAFLAG,SAASYS     INDICATE MASTER SAACOMM USED @D52VDIS 02265000
         ST    R1,TERMSCSA        SAVE SAACOMM ADDRESS         @D52VDIS 02266000
         DROP  R1                                              @D52VDIS 02267000
         L     RB,TERMDSAV                                     @D52VDIS 02268000
         L     RC,PCBPTR                                       @D52VDIS 02269000
         USING PCBADR,RC                                       @D52VDIS 02270000
         ST    RB,PCBSAAPT        CURRENT SAACOMM = MASTER     @D52VDIS 02271000
         OI    PCBSAAPT,PCBMSAAE  INDICATE SYSTEM ...          @D52VDIS 02272000
*                                 GATING NEC., PARTITION'S ... @D52VDIS 02273000
*                                 SAACOMM ADDRESS IN TERMSCSA  @D52VDIS 02274000
         CLC   0(1,RB),SAAPLEQ-1(RB) INSURE AREA IN STORAGE    @D52VDIS 02275000
         BR    R4                 RETURN TO CALLER             @D52VDIS 02276000
         DROP  R6                                              @D52VDIS 02277000
         DROP  R8                                              @D52VDIS 02278000
         DROP  R9                                              @D52VDIS 02279000
         DROP  RC                                              @D52VDIS 02280000
         EJECT ,                                               @D14BDIS 02281000
*--------------------------------------------------------------         02282000
* TERMSPSV - MOVE SPECIAL SAVE AREA INTO SAACOMM, IF AVAILABLE          02283000
*            INPUT:  R1 - SAACOMM ADDRESS                               02284000
*                    R4 - RETURN ADDRESS                                02285000
*                    R8 - TIB ADDRESS                                   02286000
*            RETURN: R4 + 0 -> SPEC. SAVE AREA MOVED                    02287000
*                    R4 + 4 -> SPEC. SAVE AREA NOT MOVED                02288000
*            WORK:   R7                                                 02289000
*--------------------------------------------------------------         02290000
         USING SAACOMM,R1                                      @D52VDIS 02291000
         USING TIBADR,R8                                       @KX40960 02292000
*SGLINK TERMSPSV,S,INPUT=(R1,R4,R8),WORK=(R7)                           02293000
TERMSPSV DS    0H                                                       02294000
         TM    TIBFLAG2,SVPCCNCL  SUPVR.SERV.OR APPEND.CANCEL? @KX40960 02295000
         BZ    4(,R4)             NO, RETURN TO CALLER         @KX40960 02296000
         NI    TIBFLAG2,XFF-SVPCCNCL                           @KX40960 02297000
         L     R7,ASVPCSAV        ADDR.TO BE SET INTO THIRD PTR@KX40960 02298000
         USING SVPCSAVE,R7                                     @KX40960 02299000
         CLC   SVPCTID(2),TID     MATCHING TASK ID ?           @KX40960 02300000
         BNE   4(,R4)             NO, RETURN TO CALLER         @KX40960 02301000
         MVC   SAASSAVE(80),0(R7) SAVE SPECIAL SAVE AREA       @KX40960 02302000
         OI    SAAFLAG,SAAPCA     SET SPEC.SAVE AREA AVAILABLE @KX40960 02303000
         BR    R4                 RETURN TO CALLER             @KX40960 02304000
         DROP  R1                                              @KX40960 02305000
         DROP  R7                                              @KX40960 02306000
         DROP  R8                                              @KX40960 02307000
         EJECT ,                                               @D14BDIS 02308000
*--------------------------------------------------------------         02309000
* TERMCNCL - ABNORMAL RETURN FROM SVA RESIDENT MESSAGE WRITTER          02310000
*            ENTERED FROM CANCEL EXIT                                   02311000
*            FUNCTION:                                                  02312000
*              - SET CANCEL INFORMATION                                 02313000
*              - RETURN TO DUMP ROUTINE                                 02314000
*            INPUT:  R6 - DISPATCHER BASE ADDRESS                       02315000
*                    R8 - TIB ADDRESS                                   02316000
*                    R9 - BASE ADDRESS                                  02317000
*                    RA - TCB ADDRESS                                   02318000
*                    RD - SGAP BASE ADDRESS                             02319000
*--------------------------------------------------------------         02320000
         USING DISP,R6                                         @D52VDIS 02321000
         USING TIBADR,R8                                       @D52VDIS 02322000
         USING TERMBASE,R9                                     @D52VDIS 02323000
         USING TCBADR,RA                                       @D52VDIS 02324000
*SGLINK  TERMCNCL,S,INPUT=(R6,R8,R9,RA,RD)                              02325000
TERMCNCL DS    0H                                              @D51IDIS 02326000
         NI    TIBFLAG,XFF-FETCHEOJ RESET DISPATCHER EXIT FLAG @D14BDFR 02327000
         MVI   RID+1,REENTRID     IDENTIFY REENTRANT ROUTINE   @D52VDIS 02328000
         L     RC,PCBPTR          GET CURRENT PCB ADDRESS      @D52VDIS 02329000
         USING PCBADR,RC                                       @D52VDIS 02330000
         L     R1,PCBSAAPT        GET SAACOMM ADDRESS          @D52VDIS 02331000
         USING SAACOMM,R1                                      @D52VDIS 02332000
         CLC   0(1,R1),SAAPLEQ-1(R1) INSURE AREA IN STORAGE    @D52VDIS 02333000
         TM    SAAFLAG,SAACNCL    SECONDARY CANCEL IN PROCESS ?@D52VDIS 02334000
         BO    TERMIERR           YES, CONTINUE WITH TERMINAT. @KX40960 02335000
         MVI   TIBCNCL3,ZERO      RESET THIRD  CANCEL CODE     @KX40960 02336000
         OI    SAAFLAG,SAACNCL    REQUEST DUMP TO TERMINATE    @D52VDIS 02337000
         MVC   SAACCL3(1),TIBCNCL   SAVE TERMINATOR CANC.CODE  @D52GDIS 02338000
         TM    SAAFLAG,SAAPDUMP+SAASDUMP RETURN FROM P/SDUMP ? @D52GDIS 02339000
         BNZ   TERMCNC0           YES, SAACCL3 IS OK           @D52GDIS 02340000
         TM    SAATFLAG,SAATSTRT+SAATSTOP+SAATPER TRACE REQ. ? @D61HDIS 02341000
         BNZ   TERMCNC0           YES, SAACCL3 IS OK           @D61HDIS 02342000
         MVC   SAACCL3(1),TIBCNCL2  SAVE TERMINATOR CANC.CODE  @KX40960 02343000
TERMCNC0 DS    0H                                              @D52GDIS 02344000
         L     RB,TERMDSAV        GET MASTER SAACOMM ADDRESS   @D52VDIS 02345000
         L     RF,TCBSAVE         ADDRESS OF TERMINATOR SAVEAR.@D52VDIS 02346000
         BAL   R4,TERMSPSV        MOVE SPEC SAVE AREA, IF AVAIL@KX40960 02347000
*SGLINK TERMSPSV,INPUT=(R1,R4,R8),WORK=(R7)                             02348000
         B     TERMCNC1           SPEC. SAVE AREA MOVED        @KX40960 02349000
         MVC   SAASSAVE(80),0(RF) SAVE DUMP'S SAVE AREA        @KX40960 02350000
         MVI   SAASSRID,ZERO       SAVE RID OF ...             @KX40960 02351000
         MVI   SAASSRID+1,USERTID          ... INTERRUPTED TASK@KX40960 02352000
         MVC   SAASSTID(2),TID     SAVE TID OF INTERRUPTED TASK@KX40960 02353000
         MVC   SAASSINF(4),INTINFO SAVE LAST INTERRUPTION CODE @KX40960 02354000
         OI    SAAFLAG,SAAPCA     SET SPEC.SAVE AREA AVAILABLE @KX40960 02355000
         EJECT ,                                               @D61NDIS 02356000
*--------------------------------------------------------------         02357000
* TERMCNC1 - SYSTEM GATING USED ?                                       02358000
*--------------------------------------------------------------         02359000
TERMCNC1 DS    0H                                              @KX40960 02360000
         TM    PCBSAAPT,PCBMSAAE  SYSTEM GATING USED ?         @D52VDIS 02361000
         BZ    TERMABND           NO, ACTIVATE DUMP ROUTINE    @D52VDIS 02362000
         DROP  RC                                              @D52VDIS 02363000
         NI    TIBDMFLG,XFF-TIBTERMX RESET DISPATCHER EXIT     @D52GDIS 02364000
         OI    TIBFLAG4,TIBDMPHI  RUN DUMP WITH HIGH PRIO.     @D52VDIS 02365000
         OI    DISPHIFL,TERMACT   INDICATE TASK IS TERM. OWNER @D52VDIS 02366000
         ST    R8,TERMTIB         SAVE TASKS TIB ADDRESS       @D52VDIS 02367000
         B     TERMABND           GOTO REENTER MESSAGE WRITTER @D52VDIS 02368000
         SPACE 2                                               @D52VDIS 02369000
*--------------------------------------------------------------         02370000
* TERMIERR - SECONDARY CANCEL OF DUMP ROUTINE                           02371000
*--------------------------------------------------------------         02372000
TERMIERR DS    0H                                              @KX40960 02373000
         MVC   TIBCNCL3(1),TIBCNCL2 SAVE TERMINATOR CANC.CODE  @D14BDFR 02374000
         B     TERMRETB           CONTINUE WITH TERMINATOR     @KX40960 02375000
*SGLINK  TERMRETB,INPUT=(R6,R8,R9,RA,RD),WORK=(R5,R7,RF),OUTPUT=(RB)    02376000
         DROP  R1                                              @D52VDIS 02377000
         DROP  R6                                              @D52VDIS 02378000
         DROP  R8                                              @D52VDIS 02379000
         DROP  R9                                              @D52VDIS 02380000
         DROP  RA                                              @D52VDIS 02381000
         EJECT ,                                               @D61HDIS 02382000
*--------------------------------------------------------------         02383000
* TERMSTRT - PROCESS TRACE START REQUEST                                02384000
*            ENTERED FROM SVC 133                                       02385000
*            FUNCTION:                                                  02386000
*              - PROVIDE START INFORMATION IN SAACOMM                   02387000
*              - CALL $IJBSDMP ROUTINE                                  02388000
*            INPUT:  R6 - DISPATCHER BASE ADDRESS                       02389000
*                    R8 - CURRENT TIB ADDRESS                           02390000
*                    R9 - BASE ADDRESS (TERMBASE)                       02391000
*                    RA - CURRENT TCB ADDRESS                           02392000
*                    RD - SGAP BASE ADDRESS                             02393000
*            RETURN: DISPATCHER AFTER RETURN FROM $IJBSDMP              02394000
*--------------------------------------------------------------         02395000
         USING TERMBASE,R9                                     @D61HDIS 02396000
         USING TIBADR,R8                                       @D61HDIS 02397000
*SGLINK  TERMSTRT,S,INPUT=(R6,R8,R9,RA,RD)                              02398000
TERMSTRT DS    0H                                              @D61HDIS 02399000
         OI    TIBTFLAG,TIBTTSTR SET START INDICATOR           @D61HDIS 02400000
         B     INITERMB          CALL DUMP ROUTINE             @D61HDIS 02401000
*SGLINK  INITERMB,S,INPUT=(R6,R8,R9,RA,RD)                              02402000
         DROP  R8                                              @D61HDIS 02403000
         DROP  R9                                              @D61HDIS 02404000
         EJECT ,                                               @D61HDIS 02405000
*--------------------------------------------------------------         02406000
* TERMSTOP - PROCESS TRACE STOP REQUEST                                 02407000
*            ENTERED FROM MAINTASK CLEAN UP (ENDTERM)                   02408000
*            FUNCTION:                                                  02409000
*              - PROVIDE STOP INFORMATION IN SAACOMM                    02410000
*              - CALL $IJBSDMP ROUTINE                                  02411000
*            INPUT:  R6 - DISPATCHER BASE ADDRESS                       02412000
*                    R8 - CURRENT TIB ADDRESS                           02413000
*                    R9 - BASE ADDRESS (TERMBASE)                       02414000
*                    RA - CURRENT TCB ADDRESS                           02415000
*                    RD - SGAP BASE ADDRESS                             02416000
*            RETURN: DISPATCHER AFTER RETURN FROM $IJBSDMP              02417000
*--------------------------------------------------------------         02418000
         USING TERMBASE,R9                                     @D61HDIS 02419000
         USING TIBADR,R8                                       @D61HDIS 02420000
*SGLINK  TERMSTOP,S,INPUT=(R6,R8,R9,RA,RD)                              02421000
TERMSTOP DS    0H                                              @D61HDIS 02422000
         OI    TIBTFLAG,TIBTTSTP SET STOP INDICATOR            @D61HDIS 02423000
         B     INITERMB          CALL DUMP ROUTINE             @D61HDIS 02424000
*SGLINK  INITERMB,S,INPUT=(R6,R8,R9,RA,RD)                              02425000
         DROP  R8                                              @D61HDIS 02426000
         DROP  R9                                              @D61HDIS 02427000
         EJECT ,                                               @D61HDIS 02428000
*--------------------------------------------------------------         02429000
* TERMTRAC - PROCESS PER INTERRUPT                                      02430000
*            ENTERED FROM PROGRAM CHECK HANDLER (SGPCK)                 02431000
*            FUNCTION:                                                  02432000
*              - PROVIDE PER INFORMATION IN SAACOMM                     02433000
*              - CALL $IJBSDMP ROUTINE                                  02434000
*            INPUT:  R6 - DISPATCHER BASE ADDRESS                       02435000
*                    R9 - BASE ADDRESS (TERMBASE)                       02436000
*                    RA - CURRENT TCB ADDRESS                           02437000
*                    RD - SGAP BASE ADDRESS                             02438000
*            RETURN: DISPATCHER AFTER RETURN FROM $IJBSDMP              02439000
*--------------------------------------------------------------         02440000
         USING TERMBASE,R9                                     @D61HDIS 02441000
         USING TCBADR,RA                                       @D61HDIS 02442000
*SGLINK  TERMTRAC,S,INPUT=(R6,R9,RA,RD)                                 02443000
TERMTRAC DS    0H                                              @D61HDIS 02444000
         L     R8,TIBPTR             GET CURRENT TIB ADDRESS   @D61HDIS 02445000
         USING TIBADR,R8                                       @D61HDIS 02446000
         OI    TIBTFLAG,TIBTTPER SET PER INDICATOR             @D61HDIS 02447000
         MVC   SVCWORK(4),PERADDR    GET PER ADDRESS           @D61HDIS 02448000
         MVC   SVCWORK+4(1),PERCODE  GET PER CODE              @D61HDIS 02449000
         MVC   SVCWORK+5(1),ACCIDPER GET PER ACCESS ID         @D61HDIS 02450000
         CLI   PGMINTC+1,X'80'       PCK + PER INTERRUPT ?     @D61HDIS 02451000
         BNE   TERMTRA0              YES, SPECIAL PROCESS      @D61HDIS 02452000
         CLC   SCNPSW(8),PCOLDP      SVC + PER INTERRUPT ?     @D61HDIS 02453000
         BNE   INITERMB              NO, CALL DUMP ROUTINE     @D61HDIS 02454000
*SGLINK  INITERMB,S,INPUT=(R6,R8,R9,RA,RD)                              02455000
         L     RB,TCBSAVE            GET CURRENT SAVE AREA ADDR@D61HDIS 02456000
         USING SVEARA,RB                                       @D61HDIS 02457000
         MVC   SVEPSW(8),SVOLDP      SAVE PSW ADDRESS          @D61HDIS 02458000
         MVC   SVCWORK+8(4),SVCINF   GET SVC INTERRUPT INFO.   @D61HDIS 02459000
         OI    TIBTFLAG,TIBTTSVC     SET SVC TO BE PROCESSED   @D61HDIS 02460000
         B     INITERMB          CALL DUMP ROUTINE             @D61HDIS 02461000
*SGLINK  INITERMB,S,INPUT=(R6,R8,R9,RA,RD)                              02462000
         SPACE 2                                               @D61HDIS 02463000
*--------------------------------------------------------------         02464000
* TERMTRA0 - SPECIAL PROCESS FOR PROGRAM CHECK WITH                     02465000
*            PER INTERRUPT, CONTINUE WITH PROGRAM CHECK                 02466000
*            HANDLER AFTER RETURN FROM TRACE ROUTINE                    02467000
*--------------------------------------------------------------         02468000
TERMTRA0 DS    0H                                              @D61HDIS 02469000
         OI    TIBTFLAG,TIBTTPCK     SET PCK TO BE PROCESSED   @D61HDIS 02470000
         B     INITERMB          CALL DUMP ROUTINE             @D61HDIS 02471000
*SGLINK  INITERMB,S,INPUT=(R6,R8,R9,RA,RD)                              02472000
         DROP  R8                                              @D61HDIS 02473000
         DROP  R9                                              @D61HDIS 02474000
         DROP  RA                                              @D61HDIS 02475000
         DROP  RB                                              @D61HDIS 02476000
         EJECT ,                                               @D61HDIS 02477000
*--------------------------------------------------------------         02478000
* TERMPDMP - PROCESS PDUMP REQUEST                                      02479000
*            ENTERED FROM SVC 2 ROUTINE (SGCFCH)                        02480000
*            FUNCTION:                                                  02481000
*              - PROVIDE PER INFORMATION IN SAACOMM                     02482000
*              - CALL $IJBSDMP ROUTINE                                  02483000
*            INPUT:  R6 - DISPATCHER BASE ADDRESS                       02484000
*                    R8 - CURRENT TIB ADDRESS                           02485000
*                    R9 - BASE ADDRESS (TERMBASE)                       02486000
*                    RA - CURRENT TCB ADDRESS                           02487000
*                    RD - SGAP BASE ADDRESS                             02488000
*            RETURN: DISPATCHER AFTER RETURN FROM $IJBSDMP              02489000
*--------------------------------------------------------------         02490000
         USING TERMBASE,R9                                     @D61HDIS 02491000
         USING TIBADR,R8                                       @D61HDIS 02492000
*SGLINK  TERMPDMP,S,INPUT=(R6,R8,R9,RA,RD)                              02493000
TERMPDMP DS    0H                                              @D61HDIS 02494000
         OI    TIBTFLAG,TIBTPDMP SET PDUMP INDICATOR           @D61HDIS 02495000
         B     INITERMB          CALL DUMP ROUTINE             @D61HDIS 02496000
*SGLINK  INITERMB,S,INPUT=(R6,R8,R9,RA,RD)                              02497000
         DROP  R8                                              @D61HDIS 02498000
         DROP  R9                                              @D61HDIS 02499000
         SPACE 2                                               @D61HDIS 02500000
*--------------------------------------------------------------         02501000
* TERMSDMP - PROCESS SDUMP REQUEST                                      02502000
*            ENTERED FROM SVC 123 ROUTINE (SGAP)                        02503000
*            FUNCTION:                                                  02504000
*              - PROVIDE PER INFORMATION IN SAACOMM                     02505000
*              - CALL $IJBSDMP ROUTINE                                  02506000
*            INPUT:  R6 - DISPATCHER BASE ADDRESS                       02507000
*                    R8 - CURRENT TIB ADDRESS                           02508000
*                    R9 - BASE ADDRESS (TERMBASE)                       02509000
*                    RA - CURRENT TCB ADDRESS                           02510000
*                    RD - SGAP BASE ADDRESS                             02511000
*            RETURN: DISPATCHER AFTER RETURN FROM $IJBSDMP              02512000
*--------------------------------------------------------------         02513000
         USING TERMBASE,R9                                     @D61HDIS 02514000
         USING TIBADR,R8                                       @D61HDIS 02515000
*SGLINK  TERMSDMP,S,INPUT=(R6,R8,R9,RA,RD)                              02516000
TERMSDMP DS    0H                                              @D61HDIS 02517000
         OI    TIBTFLAG,TIBTSDMP SET SDUMP INDICATOR           @D61HDIS 02518000
         B     INITERMB          CALL DUMP ROUTINE             @D61HDIS 02519000
*SGLINK  INITERMB,S,INPUT=(R6,R8,R9,RA,RD)                              02520000
         DROP  R8                                              @D61HDIS 02521000
         DROP  R9                                              @D61HDIS 02522000
         EJECT ,                                               @D52VDIS 02523000
*--------------------------------------------------------------         02524000
* TERMSERV - TERMINATOR / DUMP SERVICES                                 02525000
*            ENTERED BY DUMP ROUTINE OR DISPATCHER EXIT                 02526000
*              (ENABLED FOR INTERRUPT EXCEPT DISPATCHER EXIT)           02527000
*            INPUT:  R0 - FUNCTION CODE                                 02528000
*                         = 0 CHECK IF DUMP ROUTINE CANCELLED           02529000
*                         = 4 RESET DUMP ROUTINE TO LOW PRIORITY        02530000
*                    RE - RETURN ADDRESS                                02531000
*                    RF - BASE ADDRESS                                  02532000
*            OUTPUT: RF - IF R0=0, RF = 0 - NO CANCELATION              02533000
*                                  RF = 4 - CANCEL OCCURRED             02534000
*            WORK:   R0, R1, R2                                         02535000
*--------------------------------------------------------------         02536000
         USING TERMSERV,RF                                     @D52VDIS 02537000
*SGLINK  TERMSERV,S,INPUT=(R0,RF),WORK=(R0,R1,R2),OUTPUT=(RF)           02538000
TERMSERV DS    0H                                              @D52VDIS 02539000
         L     R1,TIBPTR             GET CURRENT TIB ADDRESS   @D52VDIS 02540000
         LTR   R0,R0                 DUMP TO BE CANCELLED      @D52VDIS 02541000
         BZ    TERMSERC              YES, SET CANCEL INDICATION@D52VDIS 02542000
*--------------------------------------------------------------         02543000
*          - RESET DUMP TO LOW PRIORITY, IF NECESSARY                   02544000
*            THIS IS DONE BY A DISPATCHER EXIT, BECAUSE                 02545000
*            THIS ROUTINE IS ENABLED FOR INTERRUPTS                     02546000
*--------------------------------------------------------------         02547000
         USING TIBADR,R1                                       @D52GDIS 02548000
         TM    TIBFLAG4,TIBDMPHI     TASK SET TO HIGH PRIORITY?@D52GDIS 02549000
         BZR   RE                    NO, RETURN TO CALLER      @D52GDIS 02550000
         OI    TIBDMFLG,TIBTERMX     SET DISPATCHER EXIT       @D52GDIS 02551000
*--------------------------------------------------------------         02552000
*          - INTERRUPTS MAY OCCUR HERE (E.G. ASYNCH. CANCEL)            02553000
*            THEREFORE IT IS NECESSARY TO RESET TIBTERMX                02554000
*            DURING RETURN FROM DUMP ROUTINE PROCESS                    02555000
*--------------------------------------------------------------         02556000
         OI    TIBFLAG,TIBDELMV      SET GENERAL DELAYED MOVE  @D52GDIS 02557000
         BR    RE                    RETURN TO CALLER          @D52GDIS 02558000
         DROP  R1                                              @D52GDIS 02559000
         DROP  RF                                              @D52GDIS 02560000
         EJECT ,                                               @D52GDIS 02561000
*--------------------------------------------------------------         02562000
* TERMSRES - SET DUMP ROUTINE TO ITS NORMAL PRIORITY                    02563000
*            CALLED AS DISPATCHER EXIT (DISABLED)                       02564000
*            INPUT: R6 - DISPATCHER ADDRESS                             02565000
*                   R8 - TIB ADDRESS                                    02566000
*            EXIT : DISPATCHER                                          02567000
*--------------------------------------------------------------         02568000
         USING DISP,R6                                         @D52GDIS 02569000
         USING TIBADR,R8                                       @D52GDIS 02570000
TERMSRES DS    0H                                              @D52VDIS 02571000
         TM    TIBFLAG4,TIBDMPHI     TASK SET TO HIGH PRIORITY?@D52VDIS 02572000
         BZR   R6                    NO, RETURN TO DISPATCHER  @D52GDIS 02573000
         NI    TIBFLAG4,XFF-TIBDMPHI SET TO LOW PRIORITY       @D52VDIS 02574000
         NI    DISPHIFL,XFF-TERMACT  RESET INDICATION          @D52VDIS 02575000
*        DISPMAC FUNC=TERML       SET TASK TO LOW  PRIORITY    @D61RDIS 02576000
         DISPMAC FUNC=TERML                                    @D61RDIS 02577000
         BR    R6                    RETURN TO CALLER          @D52GDIS 02578000
         DROP  R6                                              @D52GDIS 02579000
         DROP  R8                                              @D52GDIS 02580000
         EJECT ,                                               @D61NDIS 02581000
*--------------------------------------------------------------         02582000
* TERMSERC - CHECK, IF DUMP TO BE CANCELLED                             02583000
*--------------------------------------------------------------         02584000
         USING TIBADR,R1                                       @D52VDIS 02585000
TERMSERC DS    0H                                              @D52VDIS 02586000
         SLR   RF,RF                 SET RETURN CODE 0         @D52GDIS 02587000
         TM    TIBFLAG4,TIBDMPCN     DUMP TO BE CANCELLED ?    @D52VDIS 02588000
         BZR   RE                    RETURN TO CALLER          @D52GDIS 02589000
         NI    TIBFLAG4,XFF-TIBDMPCN RESET INDICATION          @KD40187 02590000
         LA    RF,4                  SET RETURN CODE 4         @D52GDIS 02591000
         L     R2,TIBPCB             GET CURRENT PCB ADDRESS   @D52GDIS 02592000
         USING PCBADR,R2                                       @D52GDIS 02593000
         L     R2,PCBSAAPT           GET CURRENT SAACOMM ADDR. @D52GDIS 02594000
         USING SAACOMM,R2                                      @D52GDIS 02595000
         OI    SAAFLAG,SAACNCL       SET CANCEL INDICATION     @D52VDIS 02596000
         MVC   SAACCL3(1),TIBCNCL   SAVE TERMINATOR CANC.CODE  @D52GDIS 02597000
         TM    SAAFLAG,SAAPDUMP+SAASDUMP RETURN FROM P/SDUMP ? @D52GDIS 02598000
         BNZR  RE                   YES, SAACCL3 IS OK         @D52GDIS 02599000
         TM    SAATFLAG,SAATPER+SAATSTRT+SAATSTOP TRACE REQU.? @D61HDIS 02600000
         BNZR  RE                   YES, SAACCL3 IS OK         @D61HDIS 02601000
         MVC   SAACCL3(1),TIBCNCL3  SAVE TERMINATOR CANC.CODE  @KX40960 02602000
         MVI   TIBCNCL3,ZERO      RESET THIRD  CANCEL CODE     @KX40960 02603000
         BR    RE                    RETURN TO CALLER          @D52VDIS 02604000
         DROP  R1                                              @D52VDIS 02605000
         DROP  R2                                              @D52VDIS 02606000
 TITLE 'VSE SUPERVISOR   SGAP         SEIZE/RELEASE ROUTINES'           02607000
*********************************************************************** 02608000
*                                                                     * 02609000
* SVC 22: SEIZE/RELEASE PROCESSING                                    * 02610000
*                                                                     * 02611000
*********************************************************************** 02612000
* >>>>>>> TRY TO AVOID SVC 22, BECAUSE DEADLOCKS MAY OCCUR <<<<<<<<<< * 02613000
*                                                                     * 02614000
*    FUNCTION:                                                        * 02615000
*        1. CALLER IS ENQUED/DEQUEUED ON AN INTERNAL (SEIZE-) GATE    * 02616000
*        2. CALLERS PSW IS ENABLED/DISABLED DEPENDENT UPON THE SETTING* 02617000
*           OF REGISTER 0                                             * 02618000
*        3. THE USER KEY IS STORED IN CALLERS PSW IF R0 CONTAINS A    * 02619000
*           NEGATIVE VALUE                                            * 02620000
*                                                                     * 02621000
*        AMODE = 24,  RMODE = 24                                      * 02622000
*********************************************************************** 02623000
         SPACE 2                                               @D35EDFR 02624000
         USING DISP,R6                                         @D64ADIS 02625000
         USING TIBADR,R8                                       @D64ADIS 02626000
         USING SVEARA,RB                                       @D64ADIS 02627000
         USING SVC22,RD                                        @D14BDFR 02628000
SVC22    TM    SVEPSW+1,KEY0      IS PSW KEY ZERO?             @D365DFR 02629000
         BNZ   ERR21              NO,ILLEGAL SVC               @D365DFR 02630000
         L     R5,ASRQTAB         GET ADDRESS OF SRQTAB        @D61RDIS 02631000
         LA    R5,SRQSEIZE-SRQTAB(,R5) POINT TO SEIZE QUEUE    @D61RDIS 02632000
         USING RQADR,R5                                        @D52VDIS 02633000
         TM    RSCDESC,FREEBIT    GATE AVAILABLE               @D66ODOW 02634000
         BNO   SVC22SR            SKIP IF NO                   @D66ODOW 02635000
         LTR   R0,R0              PSW KEY TO BE SET?           @D365DFR 02636000
         BM    ERR21              YES,ERROR;CANNOT RELEASE!    @D365DFR 02637000
         LR    RF,R6              SETUP EXIT ADDRESS           @D14BDFR 02638000
         OI    TIBFLAG3,SEIZEBIT  FLAG SEIZING TASK            @D14BDFR 02639000
         MVC   RSCDESC,TID        CLOSE GATE AND SET RES OWNER @D66ODOW 02640000
*--------------------------------------------------------------         02641000
* SVC22ED  - TEST IF USER WANTS TO ENABLE/DISABLE                       02642000
*--------------------------------------------------------------         02643000
SVC22ED  N     R0,F255            DOES USER WANT TO DISABLE    @D365DFR 02644000
         BNZ   SVC22E             NO,GOTO ENABLE               @D365DFR 02645000
         NI    SVEPSW,DISABLE     SET SYSTEM MASK TO DISABLE   @D365DFR 02646000
         BR    RF                 EXIT TO DISPATCHER           @D365DFR 02647000
         EJECT ,                                               @D52VDIS 02648000
*--------------------------------------------------------------         02649000
* SVC22SR  - IF OTHER TASK HOLDS SEIZE, WAIT                            02650000
*            ELSE POST WAITERS AND FREE GATE                            02651000
*--------------------------------------------------------------         02652000
SVC22SR  DS    0H                                              @D52VDIS 02653000
         TM    TIBFLAG3,SEIZEBIT    SEIZED BY THIS TASK?       @D14BDFR 02654000
         BNO   RESVCX             NO, SETUP TASK TO WAIT       @D365DFR 02655000
*SGLINK  RESVCX,INPUT=(R5,R6),WORK=(R8,RF)                     @D149DIS 02656000
         NI    TIBFLAG3,XFF-SEIZEBIT RESET SEIZE FLAG          @D14BDFR 02657000
         BAL   RF,RPOST           POST ALL SEIZED TASKS        @D365DFG 02658000
         LR    RF,R6              SETUP EXIT ADDRESS           @D365DFR 02659000
*SGLINK  RPOST,INPUT=(R5,R6,RF),WORK=(R5,RE)                            02660000
         DROP  R5                                              @D52VDIS 02661000
*--------------------------------------------------------------         02662000
* SVC22K   - SET USER KEY, IF DESIRED                                   02663000
*--------------------------------------------------------------         02664000
SVC22K   LTR   R0,R0              PSW KEY TO BE SET?           @D365DFR 02665000
         BNM   SVC22ED            NO,DO NOT SET USER KEY       @D365DFR 02666000
         N     R0,F255            DOES USER WANT TO DISABLE    @D365DFR 02667000
         BZ    ERR21              YES,ERROR;CANNOT ENABLE!     @D365DFR 02668000
         L     R5,PCBPTR          GET PCB POINTER              @D51IDIS 02669000
         USING PCBADR,R5                                       @D51IDIS 02670000
         MVZ   SVEPSW+1(1),PCEKEY SET USER KEY                 @D51IDIS 02671000
         DROP  R5                                              @D51IDIS 02672000
*--------------------------------------------------------------         02673000
* SVC22E   - ENABLE PSW                                                 02674000
*--------------------------------------------------------------         02675000
SVC22E   OI    SVEPSW,ENABLE      ENABLE                       @D365DFR 02676000
         BR    RF                 EXIT TO DISPATCHER           @D365DFR 02677000
         DROP  R6                                              @D64ADIS 02678000
         DROP  R8                                              @D64ADIS 02679000
         DROP  RB                                              @D64ADIS 02680000
         DROP  RD                                              @D14BDFR 02681000
         EJECT                                                          02682000
*********************************************************************** 02683000
*                                                                     * 02684000
* SDUMP(X) ROUTINE                                                    * 02685000
*                                                                     * 02686000
*********************************************************************** 02687000
*                                                                     * 02688000
*     FUNCTION      :    PROVIDE A FAST DUMP OF VIRTUAL STORAGE       * 02689000
*                        WHICH CONTAINS USER DATA AND SYSTEM DATA     * 02690000
*                        INTO A DUMP LIBRARY OR TO SYSLST. IT         * 02691000
*                        DUMPS ADDRESS RANGES OF THE PRIMARY ADDRESS  * 02692000
*                        AND IT DUMPS STORAGE RANGES OF THE DATA      * 02693000
*                        SPACE TO WHICH ADDRESSABILITY VIA AN ALET    * 02694000
*                        OR VIA A STOKEN EXISTS.                      * 02695000
*     INPUT REGISTER:                                                 * 02696000
*     R1 ADDRESS OF PARAMETER LIST                                      02697000
*                                                                     * 02698000
*        AMODE = ANY, RMODE = ANY, AR ASC MODE FOR SDUMPX             * 02699000
*********************************************************************** 02700000
         SPACE 2                                                        02701000
SDUMPCO  EQU   123                SDUMP SVC NUMBER             @D52GDIS 02702000
SVC123   DS    0H                                              @D52GDIS 02703000
         L     RD,APBASE          LOAD SGAP BASE               @D52GDIS 02704000
         USING SGAP,RD                                         @D52GDIS 02705000
         L     R9,ATERMBAS        LOAD BASE ADDRESS OF ...     @D52GDIS 02706000
         USING TERMBASE,R9        ... DUMP INITIALIZATION ROUT.@D52GDIS 02707000
         B     TERMSDMP           CALL ROUTINE                 @D61HDIS 02708000
*SGLINK  TERMSDMP,INPUT=(R6,R8,R9,RA,RD)                                02709000
         DROP  R9                                              @D61FDIS 02710000
         DROP  RD                                              @D36ZDFR 02711000
 TITLE 'VSE SUPERVISOR   SGAP         JCL AND SUBSYTEM INTERFACES'      02712000
         SPACE 2                                                        02713000
*********************************************************************** 02714000
*                                                                     * 02715000
* JOB CONTROL USER INTERFACE ROUTINE                                  * 02716000
*                                                                     * 02717000
*********************************************************************** 02718000
*                                                                     * 02719000
*     FUNCTION      :    DURING JCL 'EXEC <PROGRAM>' PROCESSING       * 02720000
*                        JOB CONTROL WILL GIVE CONTROL TO THE         * 02721000
*                        PROGRAM VIA SVC 133. BEFORE THIS SVC         * 02722000
*                        RETURNS TO THE PROGRAM A FEW                 * 02723000
*                        INITIALIZATION ROUTINES ARE TO BE CALLED.    * 02724000
*                                                                     * 02725000
* $$$$ CHECK, IF ICCF HAS TO BE ADAPTED !!!                             02726000
*                                                                     * 02727000
*     INPUT REGISTER: R7 = FUNCTION CODE IN LOW ORDER BYTE              02728000
*                     RF = PROGRAM ADDRESS TO BE CALLED,                02729000
*                          HIGH ORDER BIT HOLDS AMODE                   02730000
*                                                                     * 02731000
*        AMODE = 24, RMODE = 24, PRIMARY ASC MODE                     * 02732000
*                                                                     * 02733000
*     FUNCTION CODES:                                                 * 02734000
*                                                                     * 02735000
*********************************************************************** 02736000
         SPACE 2                                                        02737000
         SYSSERV ID=EQUCPGM                                    @D61HDIS 02738000
*------- END OF PARAMETER LIST --------------------------------         02739000
         SPACE 2                                                        02740000
IJBSUP50 CSECT                  RESUME CSECT                   @D61HDIS 02741000
         EJECT ,                                                        02742000
         USING DISP,R6                                         @D61HDIS 02743000
         USING SVC133,RC                                       @D61HDIS 02744000
*--------------------------------------------------------------         02745000
* SVC133   - INITIALIZE PROGRAM                                         02746000
*--------------------------------------------------------------         02747000
SVC133   DS    0H                                              @D61HDIS 02748000
         L     R9,CRADDR         LOAD COMREG POINTER           @D61HDIS 02749000
         USING COMREG,R9                                       @D61HDIS 02750000
         TM    JCSW5,JCLACTIV    REQUEST FROM JCL              @D61HDIS 02751000
         BNO   ERR21             NO, INVALID SVC               @D61HDIS 02752000
         NI    JCSW5,XFF-JCLACTIV RESET JCL ACTIVE INDICATION  @D61HDIS 02753000
         USING SVEARA,RB                                       @D61HDIS 02754000
         L     R1,SVER07         GET PARAMETER LIST ADDRESS    @D61HDIS 02755000
         LA    R2,JCWELNEQ-1     GET LENGTH OF PARAMETER LIST  @D61HDIS 02756000
         AR    R2,R1             GET END ADDRESS OF USER INPUT @D61HDIS 02757000
         BAL   R8,VALID          VALIDATE USER AREA            @D61HDIS 02758000
*SGLINK  VALID,INPUT=(R1,R2,R6,R8),WORK=(R2),OUTPUT=(R5)       @D61HDIS 02759000
         USING JCWEXEP,R1                                      @D61HDIS 02760000
         MVC   SVEPSW2(4),SVER0F  SET UP PROGRAM'S PSW         @D61HDIS 02761000
         NI    SVER0F,XFF-X'80'   RESET HIGH ORDER BIT         @D61HDIS 02762000
         MVC   IJBPHNAM(8),JCWEPHSN MOVE PROGRAM'S PHASE NAME  @D61HDIS 02763000
         DROP  R9                                              @D61HDIS 02764000
         DROP  RB                                              @D61HDIS 02765000
         USING TCBADR,RA                                       @D61HDIS 02766000
         L     R8,TIBPTR         GET TIB ADDRESS               @D61HDIS 02767000
         USING TIBADR,R8                                       @D61HDIS 02768000
*--------------------------------------------------------------         02769000
*           - RESET ESA RELATED INFORMATION                             02770000
*--------------------------------------------------------------         02771000
         L     R6,ADISPSER        GET ADDRESS OF DISP.SERVICES @D61PDIS 02772000
         LA    R0,32              SET FUNCTION CODE            @D61PDIS 02773000
         BASSM R7,R6               RESET MSG INFORMATION       @D64ADIS 02774000
*SGLINK DISPSE32,INPUT=(R0,R6,R7,R8,RA),WORK=(R0,R2,RF)                 02775000
         L     R6,DISPAD          RESTORE DISPATCHER BASE      @D61PDIS 02776000
         EJECT ,                                               @D61NDIS 02777000
*--------------------------------------------------------------         02778000
*          - CHECK FOR ADDITIONAL PARAMETERS                            02779000
*--------------------------------------------------------------         02780000
         L     R5,PCBPTR          GET PCB ADDRESS              @D61HDIS 02781000
         USING PCBADR,R5                                       @D61HDIS 02782000
         TM    JCWEFLAG,JCWEDSPF  DSPACE SPECIFIED ?           @D61HDIS 02783000
         BZ    SVC133DS           NO, SKIP DSPACE SETTING      @D61HDIS 02784000
         MVC   PCBDSPAC(4),JCWEDSPC MOVE DSPACE VALUE (4K ENT) @D61HDIS 02785000
SVC133DS DS    0H                                              @D61HDIS 02786000
         MVC   PCB#SUBT,JCWEMAXT  MAX NBR OF S-TASKS OF NXT JOB@D66ODOW 02787000
         DROP  R5                                              @D61NDIS 02788000
         LA    R9,4               INDICATE PARALLEL APPL.      @D61RDIS 02789000
         TM    JCWEFLAG,JCWENPAF  NON-PARALLEL APPLICATION ?   @D61RDIS 02790000
         BZ    SVC133TD           NO, SKIP TD PROCESS          @D61RDIS 02791000
         SLR   R9,R9              INDICATE NON-PARALLEL APPL.  @D61RDIS 02792000
SVC133TD DS    0H                                              @D61HDIS 02793000
*        DISPMAC FUNC=SVC133                                   @D61RDIS 02794000
         DISPMAC FUNC=SVC133                                   @D61RDIS 02795000
         TM    JCWEFLAG,JCWEMVSF  MVS EMULATION MODE SPECIFIED @D61HDIS 02796000
         BZ    SVC133MV           NO, SKIP MVS EMULATION PROC. @D61HDIS 02797000
         DROP  R1                                              @D61HDIS 02798000
         DROP  RC                                              @D61NDIS 02799000
         EJECT ,                                               @D64ADIS 02800000
*--------------------------------------------------------------         02801000
*          - INITIALIZE MVS EMULATION ENVIRONMENT VIA SMCBEM            02802000
*            SMCBEM MAY DESTROY ALL REGISTERS, EXCEPT RA                02803000
*            INPUT:  RA - TCB ADDRESS                                   02804000
*            OUTPUT: RF - RETURN CODE                                   02805000
*--------------------------------------------------------------         02806000
*        SMCBEM FUNC=ALLOC        ALLOCATE CONTROL BLOCKS      @D64ADIS 02807000
         SMCBEM FUNC=ALLOC        ALLOCATE CONTROL BLOCKS      @D64ADIS 02808000
         L     R6,DISPAD          RESTORE DISPATCHER BASE      @D61NDIS 02809000
         L     RD,APBASE          LOAD SGAP BASE               @D64XDIS 02810000
         USING SGAP,RD                                         @D64XDIS 02811000
         L     RC,ASVC133         LOAD SVC 133 BASE ADDRESS    @D64XDIS 02812000
         USING SVC133,RC                                       @D64XDIS 02813000
         LTR   RF,RF              RETURN CODE ZERO ?           @D61NDIS 02814000
         BNZ   SVC133ER           NO, ILLEGAL SVC              @D64XDIS 02815000
         L     R5,PCBPTR          GET PCB ADDRESS              @D61HDIS 02816000
         USING PCBADR,R5                                       @D61HDIS 02817000
         OI    PCBFLAG,PCBMVSEM   SET MVS EMULATION MODE ACTIVE@D61NDIS 02818000
         L     R8,TIBPTR          RESTORE TIB ADDRESS          @D61NDIS 02819000
         L     RA,TCBPTR          RESTORE TCB ADDRESS          @D61NDIS 02820000
         DROP  R5                                              @D61NDIS 02821000
         DROP  RC                                              @D64XDIS 02822000
         DROP  RD                                              @D64XDIS 02823000
         EJECT ,                                               @D61NDIS 02824000
SVC133MV DS    0H                                              @D61HDIS 02825000
*--------------------------------------------------------------         02826000
* $IJBLSTK  - SET INITIAL VALUES FOR LINK STACK SUPPORT                 02827000
*             SET INITIAL VALUES FOR CONTROL REGS IN TCBX1XRS           02828000
*             INPUT:  R8 - TIB ADDRESS                                  02829000
*                     RA - TCB ADDRESS                                  02830000
*                     RE - RETURN ADDRESS                               02831000
*                     RC - $IJBLSTK BASE ADDRESS                        02832000
*                     RF - FUNCTION CODE (=8)                           02833000
*             AMODE:  31                                                02834000
*             WORK:   DO NOT DESTROY R6, R8, RA                         02835000
*             $IJBLSTK WILL LOAD THE DUMMY LINKAGE STACK ADDRESS        02836000
*             INTO CONTROL REGISTER 15 AND HAS TO                       02837000
*             RETURN WITH THE AMODE OF THE CALLER                       02838000
*--------------------------------------------------------------         02839000
         L     RC,ASVASVDL        PTR.TO SVA ROUT.ADDR.TABLE   @D61PDOW 02840000
         L     RC,AIJBLSTK-SVASVDL(,RC) GET ROUTINE ADDRESS    @D61PDOW 02841000
         LA    RF,8               SET UP FUNCTION CODE         @D61PDOW 02842000
         OI    TIBFLAG4,TIBDSAPA  SET DATA SPACE APPENDAGE ACT.@D61PDOW 02843000
         BASSM RE,RC              CALL ROUTINE                 @D64ADIS 02844000
         NI    TIBFLAG4,XFF-TIBDSAPA  RESET ACTIVE INDICATION  @D61PDOW 02845000
         L     R6,DISPAD          RESTORE DISPATCHER BASE      @D61PDOW 02846000
         L     RB,TCBSAVE         RESTORE DISPATCHER BASE      @D61PDOW 02847000
         USING SVEARA,RB                                       @D61HDIS 02848000
         L     R1,SVER07         GET PARAMETER LIST ADDRESS    @D61HDIS 02849000
         USING JCWEXEP,R1                                      @D61HDIS 02850000
         TM    JCWEFLAG,JCWECPGF  TRACE REQUESTED ?            @D61HDIS 02851000
         BZR   R6                 RETURN TO DISPATCHER         @D61HDIS 02852000
         DROP  R1                                              @D61HDIS 02853000
         DROP  RB                                              @D61HDIS 02854000
*--------------------------------------------------------------         02855000
*          - INITIALIZE AND CALL PROBLEM DETERMINATION ROUTINE          02856000
*--------------------------------------------------------------         02857000
         L     RD,APBASE          LOAD SGAP BASE               @D61HDIS 02858000
         USING SGAP,RD                                         @D61HDIS 02859000
         L     R9,ATERMBAS        LOAD BASE ADDRESS OF ...     @D61HDIS 02860000
         USING TERMBASE,R9        ... DUMP INITIALIZATION ROUT.@D61HDIS 02861000
         B     TERMSTRT           CALL TRACE START ROUTINE     @D61HDIS 02862000
*SGLINK  TERMSTRT,INPUT=(R6,R8,R9,RA,RD)                                02863000
         DROP  R8                                              @D61HDIS 02864000
         DROP  R9                                              @D61HDIS 02865000
         DROP  RA                                              @D61HDIS 02866000
         DROP  RD                                              @D61HDIS 02867000
         EJECT ,                                                        02868000
*--------------------------------------------------------------         02869000
* SVC133ER - ERROR DURING MVS CONTROL BLOCK ALLOCATION                  02870000
*--------------------------------------------------------------         02871000
         USING SVC133,RC                                       @D64XDIS 02872000
SVC133ER DS    0H                                              @D64XDIS 02873000
         L     R6,ADISPSER      ADDR OF DISP SERVICES          @D64XDIS 02874000
         USING DISPSERV,R6                                     @D64XDIS 02875000
         LA    RB,ERR47E        LOAD CANCEL CODE               @D64XDIS 02876000
         LA    R1,S133MSG       CANCEL INFO (ABEND CODE)       @D64XDIS 02877000
         LA    R0,4             REQ CANCEL SERVICE             @D64XDIS 02878000
*        AMODESW CALL,REGS=(R7,R6) CANCEL USER                          02879000
         AMODESW CALL,REGS=(R7,R6)                             @D64XDIS 02880000
         DROP  R6                                              @D64XDIS 02881000
         DROP  RC                                              @D64XDIS 02882000
         SPACE 2                                               @D64XDIS 02883000
S133MSG  DC    A(S133MSGL)      DEFINE INPUT FOR CANCEL RTN    @D64XDIS 02884000
         DC    F'33'             REASON CODE                   @D64XDIS 02885000
         DC    CL8'NUCLEUS'                                    @D64XDIS 02886000
         DC    C'MVS CONTROL BLOCK ALLOCATION/UPDATE ERROR'    @D64XDIS 02887000
S133MSGL EQU   *-4-S133MSG      GET MESSAGE LENGTH             @D64XDIS 02888000
         EJECT ,                                                        02889000
*********************************************************************** 02890000
*                                                                     * 02891000
* CICS/VSE SVC (FUTURE INTERFACE)                                     * 02892000
*                                                                     * 02893000
*********************************************************************** 02894000
*                                                                     * 02895000
*     FUNCTION      :    SVC 150 WILL CALL A CICS/VSE SVA             * 02896000
*                        APPENDAGE ROUTINE .                          * 02897000
*                                                                     * 02898000
*     INPUT REGISTER: R0 = FUNCTION CODE                                02899000
*                     R1 = SVC PARAMETER LIST                           02900000
*                                                                       02901000
*     INPUT FOR CICS ROUTINE: R1 - SVC PARAMETER LIST                   02902000
*                             R3 - MVS CVT ADDRESS                      02903000
*                             R4 - MVS TCB ADDRESS                      02904000
*                             R5 - SVRB ADDRESS                         02905000
*                             R6 - SVC ENTRY POINT ADDRESS              02906000
*                             R7 - ASCB ADDRESS                         02907000
*                             RE - RETURN ADDRESS                       02908000
*                                                                     * 02909000
*        AMODE = ANY, RMODE = ANY, PRIMARY ASC MODE                   * 02910000
*                                                                     * 02911000
*********************************************************************** 02912000
         SPACE 2                                                        02913000
         USING DISP,R6                                         @D61NDIS 02914000
         USING TCBADR,RA                                       @D61NDIS 02915000
         USING SVC150,RC                                       @D61NDIS 02916000
*--------------------------------------------------------------         02917000
* SVC150   - INITIALIZE PROGRAM                                         02918000
*--------------------------------------------------------------         02919000
SVC150   DS    0H                                              @D61NDIS 02920000
         L     R5,PCBPTR          GET PCB ADDRESS              @D61NDIS 02921000
         USING PCBADR,R5                                       @D61NDIS 02922000
         TM    PCBFLAG,PCBMVSEM   MVS SIMULATION ACTIVE ?      @D61NDIS 02923000
         BZ    ERR21              NO, ILLEGAL SVC              @D61NDIS 02924000
         TM    PCBSSFLG,CICS      CICS ACTIVE ?                @D61NDIS 02925000
         BZ    ERR21              NO, ILLEGAL SVC              @D61NDIS 02926000
         DROP  R5                                              @D61NDIS 02927000
         L     R5,S15031BA        GET 31 BIT ADDRESS FOR SWITCH@D61NDIS 02928000
         BSM   0,R5               SWITCH TO 31 BIT MODE        @D61NDIS 02929000
         EJECT ,                                               @D61NDIS 02930000
*--------------------------------------------------------------         02931000
* S15031B  - CHECK FUNCTION CODE                                        02932000
*            AMODE 31                                                   02933000
*--------------------------------------------------------------         02934000
S15031B  DS    0H                                              @D61NDIS 02935000
         L     RB,TCBSAVE         GET 1ST SAVE AREA ADDRESS    @D61NDIS 02936000
         USING SVEARA,RB                                       @D61NDIS 02937000
         L     R7,ASVASVDL        PTR.TO SVA ROUT.ADDR.TABLE   @D61NDIS 02938000
         ICM   R7,15,ADFHCSVC-SVASVDL(R7) GET CICS ROUT.ADDRESS@D61NDIS 02939000
         BZ    ERR21              NOT AVAIL.  -> ERROR         @D61NDIS 02940000
         L     R9,SVEPSW+4        GET ADDRESS OF SVC OLD PSW   @D64ADIS 02941000
         N     R9,BIT0OFF         CLEAR HIGH ORDER BIT         @D64ADIS 02942000
         LA    R7,SVC150OS        GET ADDRESS OF SVC 150 RETURN@D64ADIS 02943000
         CR    R9,R7              RETURN FROM SVC 150 ?        @D64ADIS 02944000
         BE    SVC150US           YES, PROCESS RETURN          @D64ADIS 02945000
         DROP  R6                                              @D64ADIS 02946000
         DROP  RA                                              @D64ADIS 02947000
         DROP  RB                                              @D64ADIS 02948000
         DROP  RC                                              @D64ADIS 02949000
         EJECT ,                                               @D61NDIS 02950000
*--------------------------------------------------------------         02951000
*          - SET UP PSW AND REGISTERS                                   02952000
*--------------------------------------------------------------         02953000
*          - SMCBEM MAY DESTROY ALL REGISTERS                           02954000
*            INPUT:  NONE                                               02955000
*            OUTPUT: RF = RETURN CODE                                   02956000
*--------------------------------------------------------------         02957000
*        SMCBEM FUNC=UPDATE       UPDATE CONTROL BLOCKS        @D64ADIS 02958000
         SMCBEM FUNC=UPDATE       UPDATE CONTROL BLOCKS        @D64ADIS 02959000
         L     R6,DISPAD          GET DISPATCHER BASE ADDRESS  @D64ADIS 02960000
         USING DISP,R6                                         @D64ADIS 02961000
         L     RD,APBASE          GET SGAP BASE ADDRESS        @D64ADIS 02962000
         USING SGAP,RD                                         @D64XDIS 02963000
         L     RC,ASVC133         GET SVC 133 BASE ADDRESS     @D64XDIS 02964000
         USING SVC133,RC                                       @D64XDIS 02965000
         LTR   RF,RF              INVALID NESTING LEVEL ?      @D64ADIS 02966000
         BNZ   SVC133ER           YES, ILLEGAL SVC             @D64XDIS 02967000
         L     RC,ASVC150         GET SVC 150 BASE ADDRESS     @D61NDIS 02968000
         USING SVC150,RC                                       @D61NDIS 02969000
         L     RA,TCBPTR          GET ADDRESS OF TCB           @D64ADIS 02970000
         USING TCBADR,RA                                       @D64ADIS 02971000
         L     RB,TCBSAVE         GET 1ST SAVE AREA ADDRESS    @D64ADIS 02972000
         USING SVEARA,RB                                       @D64ADIS 02973000
         L     R5,CVTPTR          GET CVT ADDRESS              @D61NDIS 02974000
         ST    R5,SVER03          SET CVT ADDRESS              @D61NDIS 02975000
         L     R5,PSATOLD         GET TCB ADDRESS              @D61NDIS 02976000
         ST    R5,SVER04          SET TCB ADDRESS              @D61NDIS 02977000
         USING TCB,R5                                          @D64ADIS 02978000
         L     R5,TCBRBP          GET ADDRESS OF CURRENT RB    @D64ADIS 02979000
         DROP  R5                                              @D64ADIS 02980000
         ST    R5,SVER05          SET RB  ADDRESS              @D61NDIS 02981000
         L     R7,ASVASVDL        PTR.TO SVA ROUT.ADDR.TABLE   @D64ADIS 02982000
         ICM   R7,15,ADFHCSVC-SVASVDL(R7) GET CICS ROUT.ADDRESS@D64ADIS 02983000
         ST    R7,SVER06          SET SVC ENTRY POINT          @D61NDIS 02984000
         ST    R7,SVEPSW2         SET SVC ENTRY POINT INTO PSW @D61NDIS 02985000
         MVC   SVEPSW(4),S150FRAM SET FIRST PART OF PSW        @D61NDIS 02986000
         L     R5,PSAAOLD         GET ASCB ADDRESS             @D61NDIS 02987000
         ST    R5,SVER07          SET ASCB ADDRESS             @D61NDIS 02988000
         LA    R5,SVC150RT        GET RETURN ADDRESS           @D61NDIS 02989000
         ST    R5,SVER0E          SET RETURN ADDRESS           @D61NDIS 02990000
         EJECT ,                                               @D61NDIS 02991000
*--------------------------------------------------------------         02992000
* SVC150PR - CHECK PER BIT SETTING                                      02993000
*--------------------------------------------------------------         02994000
SVC150PR DS    0H                                              @D64ADIS 02995000
         L     R5,PCBPTR          POINT TO PCB                 @D61NDIS 02996000
         USING PCBADR,R5                                       @D61NDIS 02997000
         TM    PCBFLAG,PERACT     TEST PER BIT IN PCBFLAG      @D61NDIS 02998000
         BZ    SVC150XT           PER BIT NOT ON   --->        @D61NDIS 02999000
         OI    SVEPSW,PERMASK     ENABLE PROGR.EVENT RECORDING @D61NDIS 03000000
SVC150XT DS    0H                                              @D64ADIS 03001000
*        DISPMAC FUNC=SVC150      INITIATE PARALLEL PROCESS    @D64ADIS 03002000
         DISPMAC FUNC=SVC150      INITIATE PARALLEL PROCESS    @D64ADIS 03003000
*        SERVICE WILL RETURN TO DISPATCHER                     @D64ADIS 03004000
         DROP  R5                                              @D61NDIS 03005000
         DROP  R6                                              @D64ADIS 03006000
         DROP  RA                                              @D64ADIS 03007000
         DROP  RB                                              @D64ADIS 03008000
         DROP  RC                                              @D64ADIS 03009000
         DROP  RD                                              @D64XDIS 03010000
         EJECT ,                                               @D61NDIS 03011000
*--------------------------------------------------------------         03012000
* SVC150US - RESTORE REGISTERS AND RETURN TO SVC 150 CALLER             03013000
*            AMODE 31                                                   03014000
*--------------------------------------------------------------         03015000
SVC150US DS    0H                                              @D61NDIS 03016000
         L     R5,PSATOLD         GET TCB ADDRESS              @D61NDIS 03017000
         USING TCB,R5                                          @D64ADIS 03018000
         L     R5,TCBRBP          GET ADDRESS OF CURRENT RB    @D64ADIS 03019000
         USING RBBASIC,R5                                      @D64ADIS 03020000
         ST    R0,RBGRS0          SET UP ...                   @D64ADIS 03021000
         ST    R1,RBGRS1             ... RETURN ...            @D64ADIS 03022000
         ST    RF,RBGRS15                   ... REGISTERS      @D64ADIS 03023000
         DROP  R5                                              @D64ADIS 03024000
*--------------------------------------------------------------         03025000
*          - SET UP PSW AND REGISTERS                                   03026000
*--------------------------------------------------------------         03027000
*          - SMCBEM MAY DESTROY ALL REGISTERS                           03028000
*            INPUT:  NONE                                               03029000
*            OUTPUT: RF = RETURN CODE                                   03030000
*--------------------------------------------------------------         03031000
*        SMCBEM FUNC=UPDATER      UPDATE CONTROL BLOCKS        @D64ADIS 03032000
         SMCBEM FUNC=UPDATER      UPDATE CONTROL BLOCKS        @D64ADIS 03033000
         L     R6,DISPAD          GET DISPATCHER BASE ADDRESS  @D64ADIS 03034000
         USING DISP,R6                                         @D64ADIS 03035000
         L     RD,APBASE          GET SGAP BASE ADDRESS        @D64ADIS 03036000
         USING SGAP,RD                                         @D64XDIS 03037000
         L     RC,ASVC133         GET SVC 133 BASE ADDRESS     @D64XDIS 03038000
         USING SVC133,RC                                       @D64XDIS 03039000
         LTR   RF,RF              INVALID NESTING LEVEL ?      @D64ADIS 03040000
         BNZ   SVC133ER           YES, ILLEGAL SVC             @D64ADIS 03041000
         L     RC,ASVC150         GET SVC 150 BASE ADDRESS     @D61NDIS 03042000
         USING SVC150,RC                                       @D61NDIS 03043000
         B     SVC150PR           RETURN TO SVC 150 ISSUER     @D64ADIS 03044000
         DROP  R6                                              @D64ADIS 03045000
         DROP  RC                                              @D61NDIS 03046000
         DROP  RD                                              @D64XDIS 03047000
         EJECT ,                                               @D64ADIS 03048000
*--------------------------------------------------------------         03049000
* SVC150RT - RETURN FROM CICS SVC ROUTINE                               03050000
*--------------------------------------------------------------         03051000
SVC150RT DS    0F                                              @D64ADIS 03052000
         SVC   150                RETURN TO SVC FLIH           @D61NDIS 03053000
SVC150OS DS    0H                 RETURN OLD PSW ADDRESS       @D64ADIS 03054000
         SPACE 2                                               @D61NDIS 03055000
         DS    0F                                              @D64XDIS 03056000
         MAPCICSI                                              @D64ADIS 03057000
S15031BA DC    A(X'80000000'+S15031B)    AMODE 31 ROUTINE ADDR.@D61NDIS 03058000
S150FRAM DS    0CL4                                            @D61NDIS 03059000
         DC    AL1(ENABLE+DATMASK),AL1(ECBIT+MCBIT),H'0'       @D61NDIS 03060000
 TITLE 'VSE SUPERVISOR   SGAP         ENQ/DEQ SERVICES'                 03061000
         SPACE 2                                                        03062000
*********************************************************************** 03063000
* SVC42 / SVC 41 - ENQ / SEQ SERVICES                                   03064000
*--------------------------------------------------------------         03065000
* SVC42    - ENQ MACRO ROUTINE                                          03066000
*        AMODE = ANY, RMODE = ANY                                       03067000
*********************************************************************** 03068000
         SPACE 1                                                        03069000
         USING SVC42,RC                                        @D52VDIS 03070000
SVC42    DS    0H                                                       03071000
         L     RD,EQDQBASE        GET COMMON BASE              @D52VDIS 03072000
         USING ENQDEQ,RD                                       @D52VDIS 03073000
         BAL   R7,ENQDEQ .        VALIDATE RCB AND GET TASKS ECB        03074000
*SGLINK ENQDEQ,INPUT=(R0,R6,R7,RA,RD),WORK=(R1,R2,R5,R8,RF),           X03075000
               OUTPUT=(R1,R3)                                           03076000
         DROP  RD                                              @D52VDIS 03077000
         USING RCBADR,R1                                                03078000
         TS    RCBQUE .           IS RESOURCE AVAILABLE                 03079000
         BNZ   SVC42A .           IF NOT - DETERMINE OWNER              03080000
         ST    R3,RCBECB31  .     PUT TASKS ECB ADDRESS IN RCB @D52VDOW 03081000
         BR    R6                 EXIT TO DISPATCHER           @D52VDOW 03082000
         SPACE 2                                                        03083000
*--------------------------------------------------------------         03084000
* SVC42A   - RESOURCE NOT AVAILABLE, DETERMINE OWNER                    03085000
*--------------------------------------------------------------         03086000
         USING DISP,R6                                         @D52VDIS 03087000
SVC42A   L     R2,RCBECB31        GET OWNER ECB ADDR FROM RCB  @D52VDOW 03088000
         N     R2,BIT0OFF                                      @D52VDOW 03089000
         LTR   R2,R2                                           @D52VDOW 03090000
         BZ    SVC42B             MUST BE MAINTASK                      03091000
         TM    D2(R2),TRABIT .    HAS OWNER TERMINATED                  03092000
PCKSVC42 EQU   *                  PROGRAM CHECH IF R2 INVALID  @DA11215 03093000
         BO    ERR21              IF SO - ILLEGAL SVC          @D52VDOW 03094000
SVC42B   CR    R2,R3 .            IS OWNER ENQUEUEING                   03095000
         BE    ERR21              IF SO - ILLEGAL SVC          @D52VDOW 03096000
         OI    RCBFLG,WANTBIT .   INDICATE RESOURCE WANTED              03097000
         DROP  R1                 RCBADR,R1                    @D52VDIS 03098000
         L     R5,ASRQTAB         GET ADDRESS OF SRQTAB        @D61RDIS 03099000
         LA    R5,SRQENQ-SRQTAB(,R5)  POINT TO WAIT QUEUE      @D61RDIS 03100000
         LR    R1,R2        .     GET OWNER ECB                @D36IDFG 03101000
*                                 TO PREVENT DEADLOCK IN CASE THE OWNER 03102000
*                                 TERMINATES WITHOUT DEQING THE RSC     03103000
         B     RESVCX             SET UP TO REDRIVE THE SVC    @D36IDFG 03104000
*SGLINK RESVCX,INPUT=(R5,R6),WORK=(R8,RF)                      @D149DIS 03105000
         DROP  R6                                              @D36ZDFR 03106000
         DROP  RC                 BASE ADDRESS OF SVC 42       @D52VDIS 03107000
         EJECT ,                                                        03108000
*********************************************************************** 03109000
* SVC41    - DEQ MACRO ROUTINE                                          03110000
*        AMODE = ANY, RMODE = ANY                                       03111000
*********************************************************************** 03112000
         SPACE 1                                                        03113000
         USING DISP,R6                                         @D52VDIS 03114000
         USING SVC41,RC                                        @D52VDIS 03115000
SVC41    DS    0H                                              @D52VDOW 03116000
         L     RD,EQDQBASE        GET COMMON BASE              @D52VDIS 03117000
         USING ENQDEQ,RD                                       @D52VDIS 03118000
         BAL   R7,ENQDEQ .        VALIDATE RCB AND GET TASKS ECB        03119000
*SGLINK ENQDEQ,INPUT=(R0,R6,R7,RA,RD),WORK=(R1,R2,R5,R8,RF),           X03120000
               OUTPUT=(R1,R3)                                           03121000
         DROP  RD                                              @D52VDIS 03122000
         USING RCBADR,R1                                                03123000
         L     R2,RCBECB31        GET OWNER ECB ADDR FROM RCB  @D52VDOW 03124000
         N     R2,BIT0OFF         RESET HIGH ORDER BIT         @D52VDOW 03125000
         CR    R2,R3 .            IS OWNER DEQUEUEING                   03126000
         BE    SVC41A .           IF SO - OK                            03127000
         USING TCBADR,RA                                       @D52VDIS 03128000
         TM    TCBABEX,EXITACT    IS DEQ IN AB ROUTINE         @D64ADIS 03129000
         BOR   R6                 IF SO - IGNORE THE DEQ       @D52VDOW 03130000
         B     ERR21              IF NOT - ILLEGAL SVC         @D52VDOW 03131000
         DROP  RA                                              @D52VDIS 03132000
         SPACE 2                                                        03133000
*--------------------------------------------------------------         03134000
* SVC41A   - OWNER ISSUES DEQ                                           03135000
*--------------------------------------------------------------         03136000
SVC41A   EQU *                                                          03137000
         MVI   RCBQUE,ZERO        RESET TS BYTE IN RCB                  03138000
         TM    RCBFLG,WANTBIT .   RESOURCE WANTED BY A TASK             03139000
         BZR   R6                 IF NOT - EXIT TO DISPATCHER  @D36IDJO 03140000
         NI    RCBFLG,UNPOST1 .   TURN OFF WANTBIT IN RCB      @DA01532 03141000
         DROP  R1                 RCB ADDRESS                  @D52VDIS 03142000
         LR    R1,R2              LOAD ECB POINTER             @D36IDFR 03143000
         L     R5,ASRQTAB         GET ADDRESS OF SRQTAB        @D61RDIS 03144000
         LA    R5,SRQENQ-SRQTAB(,R5)  POINT TO WAIT QUEUE      @D61RDIS 03145000
         LR    RF,R6              EXIT TO TASK SELECTION       @D52VDOW 03146000
         B     RPOST              REMOVE WANTERS FROM WAIT     @D52VDOW 03147000
*SGLINK RPOST,INPUT=(R1,R5,R6,RF),WORK=(R5,RE)                          03148000
         DROP  R6                                              @D52VDIS 03149000
         DROP  RC                 BASE ADDRESS OF SVC 42       @D52VDIS 03150000
         SPACE 2                                                        03151000
EQDQBASE DC    A(ENQDEQ)          SUBROUTINE'S BASE ADDRESS    @D52VDIS 03152000
         EJECT ,                                                        03153000
*--------------------------------------------------------------         03154000
* ENQDEQ.. - COMMON ENQ/DEQ SUBROUTINE                                  03155000
*            INPUT:  R0 - RCB ADDRESS                                   03156000
*                    R6 - DISPATCHER BASE ADDRESS                       03157000
*                    R7 - RETURN ADDRESS                                03158000
*                    RA - TCB ADDRESS                                   03159000
*                    RD - SUBROUTINE'S BASE ADDRESS                     03160000
*            OUTPUT: R1 - VALIDATED RCB ADDRESS                         03161000
*                    R3 - TCBECB ADDRESS                                03162000
*            WORK:   R1, R2, R5, R8, RF                                 03163000
*            RETURN: AMODE 31                                           03164000
*--------------------------------------------------------------         03165000
         USING DISP,R6                                         @D52VDIS 03166000
         USING TCBADR,RA                                       @D52VDIS 03167000
         USING ENQDEQ,RD                                       @D52VDIS 03168000
*SGLINK ENQDEQ,S,INPUT=(R0,R6,R7,RA,RD),WORK=(R1,R2,R5,R8,RF),         X03169000
               OUTPUT=(R1,R3)                                           03170000
ENQDEQ   LA    R7,0(,R7)          CLEAR FIRST BYTE OF RET REG  @KX40539 03171000
         LR    R1,R0 .            POINT R1 TO FIRST BYTE OF RCB         03172000
         N     R1,BIT0OFF         RESET FIRST BIT              @D52VDOW 03173000
         LA    R2,RCBLNG          GET LENGTH OF RCB            @KD40187 03174000
         AR    R2,R1              POINT R2 TO LAST BYTE OF RCB @KD40187 03175000
         TM    TCBEXFLG,TCBEXAM   CALLER IN 31 BIT MODE        @D52VDOW 03176000
         BO    ENQDEQ1            YES, SWITCH TO 31BIT MODE    @D52VDOW 03177000
         LA    R1,0(,R1)          24 BIT MODE -> CLEAR 1ST BYTE@D52VDOW 03178000
         LA    R2,0(,R2)          24 BIT MODE -> CLEAR 1ST BYTE@KD40187 03179000
ENQDEQ1  DS    0H                                              @KD40187 03180000
*        AMODESW SET,AMODE=31,WR=(R8)                                   03181000
         AMODESW SET,AMODE=31,WR=(R8)                          @D52VDOW 03182000
         BAL   R8,VALID .         VALIDATE RCB ADDRESS                  03183000
*SGLINK  VALID,INPUT=(R1,R2,R6,R8),WORK=(R2),OUTPUT=(R5)                03184000
         L     R5,ASRQTAB         GET ADDRESS OF SRQTAB        @D61RDIS 03185000
         LA    R5,SRQG41-SRQTAB(,R5)  POINT TO WAIT QUEUE      @D61RDIS 03186000
         USING RQADR,R5                                        @D61RDIS 03187000
         TM    RSCDESC,FREEBIT                                 @D66ODOW 03188000
         BNO   RESVCX             ENQUEUE AND RE-SVC           @D66ODOW 03189000
*SGLINK RESVCX,INPUT=(R5,R6),WORK=(R8,RF)                      @D149DIS 03190000
         DROP  R5                                              @D61RDIS 03191000
*--------------------------------------------------------------         03192000
*          - OCCUPY RESORCE                                             03193000
*--------------------------------------------------------------         03194000
         MVI   RID+D1,G41BND      IDENTIFY USED RESOURCE       @D61RDIS 03195000
         L     R3,TCBECB          PICK UP ECB ADDRESS          @D36IDFG 03196000
         LTR   R3,R3                                           @D36IDFR 03197000
         BM    ERR21              MVS ECB ->> ILLEGAL SVC      @D64ADIS 03198000
         BNZR  R7                 RETURN TO MAINLINE IF PRESENT         03199000
         CLC   TID,IJBHMTID       IS THIS A MAINTASK ?         @D51IDOW 03200000
         BH    ERR21              NO - MUST HAVE AN ECB        @D52VDOW 03201000
         BR    R7 .               RETURN TO MAINLINE                    03202000
         DROP  R6                 BASE ADDRESS OF DISPATCHER   @D52VDIS 03203000
         DROP  RA                 ADDRESS OF TCBADR            @D36SDJO 03204000
         DROP  RD                 BASE ADDRESS OF ENQ/DEQ ROUT.         03205000
 TITLE 'VSE SUPERVISOR   SGAP         SUBTASK MANAGEMENT'               03206000
         SPACE 2                                               @D35EDFR 03207000
*********************************************************************** 03208000
*                                                                     * 03209000
* SVC38 OR ATTACH MACRO ROUTINE                                       * 03210000
*                                                                     * 03211000
*********************************************************************** 03212000
*                                                                       03213000
* THE ATTACH SERVICE IS CALLED BY ANOTHER SUB- OR MAINTASK              03214000
* TO INITIATE ANOTHER SUBTASK.                                          03215000
*                                                                       03216000
* REGISTERS 0 AND 1 ARE USED TO PASS PARAMETERS.                        03217000
*  OLD INTERFACE:                                                       03218000
*   R0 CONTAINS ADDRESS OF SUBTASK SAVEAREA                             03219000
*   R1 CONTAINS POINTER TO THE FOLLOWING PARAMETER LIST:                03220000
*                                                                       03221000
*     BYTE | CONTENTS                                                   03222000
*     -----+-----------------------------------------------------       03223000
*       0  | SUBTASK'S ENTRY POINT ADDRESS                              03224000
*       4  | SUBTASK'S ECB ADDRESS          OR ZERO                     03225000
*       8  | SUBTASK'S AB SAVE AREA ADDRESS OR ZERO                     03226000
SVC38LB0 EQU   11                 LAST BYTE OF OLD PARML       @D52GDIS 03227000
*                                                                       03228000
*  NEW INTERFACE IF R0 = R1 :                                           03229000
*   R1 CONTAINS POINTER TO THE FOLLOWING PARAMETER LIST:                03230000
*                                                                       03231000
*     BYTE | CONTENTS                                                   03232000
*     -----+-----------------------------------------------------       03233000
*       0  | SUBTASK'S ENTRY POINT ADDRESS                              03234000
*       4  | SUBTASK'S ECB ADDRESS                    OR ZERO           03235000
*       8  | SUBTASK'S AB SAVE AREA ADDRESS           OR ZERO           03236000
*      12  | FLAG BYTE                                                  03237000
SVC38FRT EQU   X'01'              RETURN=YES                   @D14BDFR 03238000
SVC38FSS EQU   X'02'              SYSTEM SAVEAREA              @D14BDFR 03239000
SVC38FNA EQU   X'04'              TASK NAME                    @D14BDFR 03240000
SVC38FAL EQU   X'08'              COPY DU-AL                   @D52GDIS 03241000
SVC38FNN EQU   X'10'              TASK NAME IN 31 BIT AREA     @D52GDIS 03242000
*      13  | 24 BIT ADDRESS OF SUBTASK SAVE AREA/NAME OR ZERO           03243000
SVC38LB1 EQU   15                 LAST BYTE OF EXTENDED PARML  @D52GDIS 03244000
*      16  | 31 BIT ADDRESS OF SUBTASK SAVE AREA/NAME OR ZERO           03245000
SVC38LB2 EQU   19                 LAST BYTE OF NEW PARML       @D52GDIS 03246000
*                                                                       03247000
*        AMODE = ANY, RMODE = ANY                                     * 03248000
*        SUBTASK SAVE AREA: RMODE = 24                                * 03249000
*********************************************************************** 03250000
         EJECT ,                                               @D52GDIS 03251000
*--------------------------------------------------------------         03252000
* SVC38    - ATTACH MAIN ROUTINE                                        03253000
*--------------------------------------------------------------         03254000
         USING DISP,R6                                         @D61NDIS 03255000
         USING TIBADR,R8                                       @D61NDIS 03256000
         USING TCBADR,RA                                       @D61NDIS 03257000
         USING SVEARA,RB                                       @D61NDIS 03258000
         USING SVC38,RD                                        @D61NDIS 03259000
SVC38    DS    0H                                              @D36IDFR 03260000
         LR    RD,RC              GET BASE REGISTER            @D61NDIS 03261000
         LA    RE,SVC38PAR        DUMMY PARAMETER              @D14BDFR 03262000
         L     R5,TCBEXFLG        GET ADDRESSING MODE OF CALLER@D52VDIS 03263000
*        AMODESW SET,AMODE=(5),WR=(15)                         @D52VDIS 03264000
         AMODESW SET,AMODE=(5),WR=(15)                         @D52VDIS 03265000
         LA    R2,SVC38LB0        GET OLD LENGTH               @D52GDIS 03266000
         LR    R7,R0              SAVE USER SAVEAREA POINTER   @D14BDFR 03267000
         CR    R1,R0              OLD INTERFACE SPECIFIED      @D14BDFR 03268000
         BNE   SVC38INC           YES,USE DUMMY PARAMETER      @D52GDIS 03269000
         LA    RE,12(,R1)         POINT TO PARAMETER EXTENSION @D14BDFR 03270000
         L     R7,0(,RE)          SAVEAREA/NAME POINTER        @D14BDFR 03271000
PC2SVC38 EQU   *                                               @D14BDFR 03272000
         N     R7,ADDRMSK         CLEAR HIGH ORDER BYTE        @D52GDIS 03273000
         LA    R2,SVC38LB1        GET EXTENDED LENGTH          @D52GDIS 03274000
         TM    0(RE),SVC38FNN     NEW PARML SPECIFIED ?        @D52GDIS 03275000
         BZ    SVC38INC           YES, USE EXTENDED LAYOUT     @D52GDIS 03276000
         LA    R2,SVC38LB2        GET NEW LENGTH               @D52GDIS 03277000
*--------------------------------------------------------------         03278000
* SVC38INC - VALIDATE PARAMETER LIST ADDRESS                            03279000
*--------------------------------------------------------------         03280000
SVC38INC DS    0H                                              @D52GDIS 03281000
         LA    R1,0(,R1)          CLEAR HIGH ORDER BYTE/BIT    @D52GDIS 03282000
         AR    R2,R1              POINT TO END OF PARML        @D52GDIS 03283000
         CLC   0(1,R1),0(R2)      BRING PARML INTO STORAGE     @D52GDIS 03284000
PCKSVC38 EQU   *                                               @D52GDIS 03285000
         TM    0(RE),SVC38FNN     NEW PARML SPECIFIED ?        @D52GDIS 03286000
         BZ    SVC38OLD           YES, USE EXTENDED LAYOUT     @D52GDIS 03287000
         L     R7,16(,R1)         POINT TO NAME FIELD (ANY)    @D52GDIS 03288000
SVC38OLD LM    R1,R3,0(R1)        LOAD PARAMETERS              @D14BDFR 03289000
         EJECT ,                                               @D51IDIS 03290000
*--------------------------------------------------------------         03291000
*          - VALIDATE ENTRY POINT ADDRESS (RMODE=ANY)                   03292000
*--------------------------------------------------------------         03293000
         LA    R4,0(,R2)          SUBTASKS ECB POINTER TO R4   @D36IDFR 03294000
         LA    R3,0(,R3)          SUBTASKS AB SAVE.PTR.TO R3   @D36IDFR 03295000
         LR    R2,R1              SETUP PARAM.FOR VALID.ROUT.  @D36IDFR 03296000
         LR    R0,R1              SAVE ENTRY POINT             @D64ADIS 03297000
         BAL   R8,VALIDSVA        VALIDATE ENTRY POINT ADDRESS @DY46001 03298000
*SGLINK  VALID,INPUT=(R1,R2,R6,R8),WORK=(R2),OUTPUT=(R5)                03299000
         TM    TCBMVSIS-TCBADR(RA),TCBMVSSA  MVS SIMULATION ?  @D64ADIS 03300000
         BO    SVC38AM            YES, USE ADDRESS FROM INPUT  @D64ADIS 03301000
         LR    R0,R1              USE ENTRY POINT WITH ...     @D52VDIS 03302000
*                                  ... CLEARED HIGH BYTE/BIT   @D52VDIS 03303000
SVC38AM  DS    0H                                              @D64ADIS 03304000
         TM    TCBMVSIS-TCBADR(RA),TCBMVSSA  MVS SIMULATION ?  @D64ADMK 03305000
         BO    SVC38A             YES, SKIP VALIDATION         @D64ADMK 03306000
         TM    0(RE),SVC38FSS+SVC38FNA NAME/SAVEAREA SPECIFIED @D14BDFR 03307000
         BM    SVC38A             NO,USE SYSTEM SAVE&SYS.NAME  @D14BDFR 03308000
         LR    R1,R7              LOAD NAME/SAVEAREA PTR       @D14BDFR 03309000
         BZ    SVC38USA           YES, WRITE VALID.FOR SAVEAREA@D14BDFR 03310000
         LA    R2,7(,R1)          GET END ADDRESS OF NAME FIELD@D52VDIS 03311000
         BAL   R8,VALIDSVA                                     @D14BDFR 03312000
         LA    R7,0(,R7)          CLEAR HIGH BIT/BYTE          @D64ADIS 03313000
         B     SVC38A                                          @D14BDFR 03314000
         SPACE 2                                                        03315000
*--------------------------------------------------------------         03316000
* SVC38USA - VALIDATE SAVE AREA (RMODE=24)                              03317000
*--------------------------------------------------------------         03318000
SVC38USA DS    0H                                              @D52VDIS 03319000
*        AMODESW SET,AMODE=24,WR=(15)                          @D52VDIS 03320000
         AMODESW SET,AMODE=24,WR=(15)                          @D52VDIS 03321000
         LA    R2,SVEEND-SVEARA-1(,R1) POINT TO END OF SAVEAR. @D36ZDFR 03322000
         BAL   R8,VALID           VALIDATE SUBTASKS SAVE AREA  @D14BDFR 03323000
*SGLINK  VALID,INPUT=(R1,R2,R6,R8),WORK=(R2),OUTPUT=(R5)                03324000
         LR    R7,R1              ADDRESS WITH ZERO HIGH BYTE  @D14BDFR 03325000
         L     R5,TCBEXFLG        GET ADDRESSING MODE OF CALLER@D52VDIS 03326000
*        AMODESW SET,AMODE=(5),WR=(15)                         @D52VDIS 03327000
         AMODESW SET,AMODE=(5),WR=(15)                         @D52VDIS 03328000
         EJECT ,                                               @D52VDIS 03329000
*--------------------------------------------------------------         03330000
* SVC38A   - VALIDATE ECB ADDRESS (RMODE=ANY)                           03331000
*--------------------------------------------------------------         03332000
SVC38A   LTR   R1,R4              ECB PARAMETER PRESENT?       @D14BDFR 03333000
         BZ    SVC38B             BR IF ECB PARAMETER NOT PRESENT       03334000
         LA    R2,D3(,R1)         SETUP PARAM.FOR VALID.ROUT.  @D36IDFR 03335000
         BAL   R8,VALID           VALIDATE ECB ADDRESS         @D14BDFR 03336000
*SGLINK  VALID,INPUT=(R1,R2,R6,R8),WORK=(R2),OUTPUT=(R5)                03337000
         LA    R4,0(,R4)          CLEAR HIGH BIT/BYTE          @D64ADIS 03338000
*--------------------------------------------------------------         03339000
* SVC38B   - VALIDATE ABSAVE ADDRESS (RMODE=ANY)                        03340000
*            IF ATTACHING TASK USES NEW ABSAVE LAYOUT                   03341000
*               OR ATTACH WAS CALLED IN AMODE 31                        03342000
*            THEN USE NEW ABSAVE LENGTH                                 03343000
*            ELSE USE OLD ABSAVE LENGTH                                 03344000
*--------------------------------------------------------------         03345000
SVC38B   LTR   R1,R3              AB SAVEAREA PTR.PRESENT      @D36IDFR 03346000
         BZ    SVC38C             BR IF ABSAVE PARAMETER NOT PRESENT    03347000
         TM    TCBEXITG,TCBABSPC  CALLER HAS NO AB EXIT ?      @D64ADIS 03348000
         BZ    SVC38C             BR IF AB EXIT  NOT PRESENT   @D64ADIS 03349000
         LA    R3,0(,R3)          CLEAR HIGH BIT/BYTE          @D64ADIS 03350000
         LA    R2,SVULNGTH-1      ASSUME NEW LENGTH            @KD40187 03351000
         TM    TCBEXFLG,TCBEXAM   CALLER IN AMODE 31 ?         @D52VDIS 03352000
         BO    SVC38B1            YES, USE LENGTH OF NEW LAYOUT@D52VDIS 03353000
         TM    TCBEXITG,TCBABS31  CALLER'S AB EXIT AMODE=ANY ? @D64ADIS 03354000
         BO    SVC38B1            BR IF AB EXIT  NOT PRESENT   @D64ADIS 03355000
         LA    R2,SVUOLDLN-1      USE OLD LENGTH               @KD40187 03356000
         O     R3,BIT0OMSK        INDICATE OLD LAYOUT USED     @D52VDIS 03357000
SVC38B1  DS    0H                                              @D52VDIS 03358000
         AR    R2,R1              R2 = ADDR.LAST BYTE OF ABSAVE@D52VDIS 03359000
         BAL   R8,VALID           VALIDATE AB SAVE AREA ADDRESS@D14BDFR 03360000
*SGLINK  VALID,INPUT=(R1,R2,R6,R8),WORK=(R2),OUTPUT=(R5)                03361000
*--------------------------------------------------------------         03362000
*          - END OF USER AREA VALIDATION                                03363000
*--------------------------------------------------------------         03364000
         EJECT ,                                               @D52VDIS 03365000
*--------------------------------------------------------------         03366000
* SVC38C   - SCAN FOR AN AVAILABLE SUBTASK                              03367000
*--------------------------------------------------------------         03368000
SVC38C   DS    0H                                              @D64ADIS 03369000
         L     RF,SVC38C31        GET CONTINUATION ADDRESS     @D66ODOW 03370000
         BSM   0,RF               SWITCH TO 31 BIT MODE        @D64ADIS 03371000
SVC38C31 DC    A(SVC38C32+X'80000000')                         @D66ODOW 03372000
SVC38C32 DS    0H                                              @D66ODOW 03373000
         L     R9,PCBPTR          LOAD ADDRESS OF PART.CTL.BL. @D36IDFR 03374000
         USING PCBADR,R9                                       @D36IDFR 03375000
         LR    RC,R7              SAVE SUBTASK'S SAVE AREA/NAME@D66ODOW 03376000
         CLC   PCBNTASK,PCB#SUBT  ALL TASKS ATTACHED?          @D66ODOW 03377000
         BNL   SVC38WTP           YES, WAIT                    @D14BDFR 03378000
         SPACE 1                                                        03379000
         ICM   R8,B'1111',AFREETIB GET TIB FROM FREE-CHAIN     @D66ODOW 03380000
         BNZ   SVC38C35           TIB AVAILABLE --->           @D66ODOW 03381000
         L     R2,AFRESLOT        ADDR(NEXT FREE TIBTABLE SLOT)@D66ODOW 03382000
         CLI   0(R2),XFF          POINTING TO END INDICATOR    @D66ODOW 03383000
         BE    SVC38WTS           YES, WAIT FOR TASK DETACHED  @D66ODOW 03384000
         LH    R5,PCBNTASK        INCREASE                     @D66ODOW 03385000
         LA    R5,1(,R5)          ... NUMBER                   @D66ODOW 03386000
         STH   R5,PCBNTASK        ... ALLOCATED SUBTASKS       @D66ODOW 03387000
         B     SVC38GVS           NO, GET STORAGE FOR NEW SUBT @D66ODOW 03388000
SVC38C35 DS    0H                                              @D66ODOW 03389000
         LH    R2,PCBNTASK        INCREASE                     @D66ODOW 03390000
         LA    R2,1(,R2)          ... NUMBER                   @D66ODOW 03391000
         STH   R2,PCBNTASK        ... ALLOCATED SUBTASKS       @D66ODOW 03392000
         L     R2,TIBFCHN         NEXT IN FREE-CHAIN           @D66ODOW 03393000
         ST    R2,AFREETIB        ... TO CHAIN HEADER          @D66ODOW 03394000
         LH    R2,TIBRTID         GET (TID*4) =                @D66ODOW 03395000
         SLL   R2,2               ... OFFSET INTO TIBATAB      @D66ODOW 03396000
         AIF   (NOT &BGDEBUG).S38NODB                          @D66ODOW 03397000
         L     R5,ATIBATAB                                     @D66ODOW 03398000
         ALR   R5,R2                                           @D66ODOW 03399000
         L     R5,0(,R5)                                       @D66ODOW 03400000
         CR    R5,R8                                           @D66ODOW 03401000
         BE    SVC38C38                                        @D66ODOW 03402000
         BAL   R5,SYSERROR                                     @D66ODOW 03403000
SVC38C38 DS    0H                                              @D66ODOW 03404000
.S38NODB ANOP                                                  @D66ODOW 03405000
         DROP  R9                                              @D61NDIS 03406000
         DROP  RA                                              @D52VDIS 03407000
         EJECT ,                                               @D61RDIS 03408000
*--------------------------------------------------------------         03409000
* SET UP THE TIB AND TCB OF THE SUBTASK                                 03410000
*--------------------------------------------------------------         03411000
         L     R5,TIBTCB          POINT TO TCB OF SUBTASK      @D14BDFR 03412000
         L     R9,TIBTSCT         POINT TO TSCT OF SUBTASK     @D61RDIS 03413000
         USING TCBADR,R5                                       @D14BDFR 03414000
         XC    0(TIBLNG,R8),0(R8) CLEAR TIB                    @D52GDIS 03415000
         ST    R9,TIBTSCT         RESTORE  TSCT OF SUBTASK     @D61RDIS 03416000
         L     R9,TCBATCBE        SAVE TCB EXTENSION ADDRESS   @D61PDIS 03417000
         L     R7,TCBSTSAA        GET  SAVE AREA POINTER       @D52VDIS 03418000
         L     RF,TCBTDSE         GET TDSE ADDRESS             @D52GDIS 03419000
         L     R1,TCBARSAV        AR SAVE AREA ADDR., AVAIL.?  @D61NDIS 03420000
         XC    0(TCBARSLN,R1),0(R1) CLEAR AR SAVE AREA         @D52GDIS 03421000
         XC    0(TDSELEN,RF),0(RF) CLEAR TDSE                  @D52GDIS 03422000
*  CLEAR TCB                                                            03423000
         XC    0(256,R5),0(R5)             CLEAR ...           @D64ADMZ 03424000
         XC    256(256,R5),256(R5)           .......           @D64ADMZ 03425000
         XC    512(STCBLNG-512,R5),512(R5)   ... TCB           @D64ADMZ 03426000
         ST    RF,TCBTDSE         SET TDSE ADDRESS             @D64ADMZ 03427000
*  CLEAR TCBX                                                           03428000
         USING TCBXADR,R9                                      @D61PDIS 03429000
         L     RF,TCBXLSTK        GET ADDR OF LINKAGE STACK    @D64ADMZ 03430000
         XC    TCBXSEAX,TCBXSEAX  CLEAR TCB ...                @D61PDOW 03431000
         XC    TCBXSAUS(256),TCBXSAUS ...EXTENSION             @D64ADIS 03432000
         XC    TCBXSAUS+256(256),TCBXSAUS+256                  @D64ADIS 03433000
         XC    TCBXSAUS+512(TCBXEND-TCBXSAUS-512),TCBXSAUS+512 @D64ADIS 03434000
         DROP  R9                                              @D61NDIS 03435000
         EJECT ,                                               @D52VDIS 03436000
*--------------------------------------------------------------         03437000
* SVC38CC  - RETURN FROM SAVE AREA, TIB AND TCB ALLOCATION              03438000
*            INPUT:  R0 = ENTRY POINT ADDRESS                           03439000
*                    R1 = ADDRESS OF AR SAVE AREA                       03440000
*                    R2 = OFFSET INTO TIBATAB                           03441000
*                    R3 = ABSAVE ADDRESS                                03442000
*                    R4 = ECB ADDRESS                                   03443000
*                    R5 = SUBTASK'S TCB ADDRESS                         03444000
*                    R6 = DISPATCHER BASE ADDRESS                       03445000
*                    R7 = SUBTASK'S SAVE AREA ADDRESS (SYSTEM)          03446000
*                    R8 = SUBTASK'S TIB ADDRESS                         03447000
*                    R9 = ADDRESS OF TCB EXTENSION                      03448000
*                    RA = CURRENT TCB ADDRESS                           03449000
*                    RB = CURRENT SAVE AREA ADDRESS                     03450000
*                    RC = ADDRESS OF NAME FIELD OR USER'S SAVE AREA     03451000
*                    RD = BASE ADDRESS                                  03452000
*                    RE = ADDRESS OF PARAMETER LIST EXTENSION           03453000
*                    RF = ADDR OF LINKAGE STACK                         03454000
*            AMODE:  31                                                 03455000
*--------------------------------------------------------------         03456000
SVC38CC  DS    0H                                              @D52VDIS 03457000
         ST    R9,TCBATCBE        SAVE TCB EXTENSION ADDRESS   @D61NDIS 03458000
         ST    R1,TCBARSAV        SAVE AR SAVE AREA ADDRESS    @D61NDIS 03459000
         USING TCBXADR,R9                                      @D61NDIS 03460000
         LA    R1,TCBXARS2        GET ADDRESS OF 2. AR SAVE A. @D61NDIS 03461000
         ST    R1,TCBAR2SV        SAVE 2. AR SAVE AREA ADDRESS @D52GDIS 03462000
         LA    R1,TCBXLNGE        TCB EXTENSION LENGTH         @D61PDIS 03463000
         STH   R1,TCBXLNG         SAVE TCB LENGTH FIELD        @D61PDIS 03464000
         ST    RF,TCBXLSTK        PROVIDE ADDR OF LINK. STACK  @D64ADMZ 03465000
         LR    RF,R2              SAVE INDEX INTO TIBATAB      @D52GDIS 03466000
         LA    R1,STCBLNG         TCB LENGTH TO R1             @D52VDIS 03467000
         STH   R1,TCBLNGTH        SAVE TCB LENGTH FIELD        @D52VDIS 03468000
         ST    R7,TCBSTSAA        SAVE SAVE AREA POINTER       @D52VDIS 03469000
         EJECT ,                                               @D52VDIS 03470000
*--------------------------------------------------------------         03471000
*          - SYSTEM SUPPLIED SAVE AREA TO BE USED ?                     03472000
*--------------------------------------------------------------         03473000
         TM    0(RE),SVC38FSS     SAVE AREA TO BE ALLOCATED ?  @D52VDIS 03474000
         BO    SVC38CC0           YES, USE ALLOCATED AREA      @D52VDIS 03475000
         LR    R7,RC              GET USER DEFINED SAVE AREA   @D52VDIS 03476000
SVC38CC0 DS    0H                                              @D52VDIS 03477000
         ST    R8,TCBTIB          TIB POINTER TO TCB           @D52VDIS 03478000
         LA    R1,TCBSSAVE        POINT TO SYSTEM SAVEAREA     @D52VDIS 03479000
         ST    R1,TCBSAV2           AND SETUP POINTER IN TCB   @D52VDIS 03480000
         SRL   R2,2               ID OF TASK                   @D52VDIS 03481000
         STH   R2,TIBRTID         STORE IT TO TIB              @D52VDIS 03482000
         STH   R2,TCBXTID         ...AND TO TCB EXTENSION      @D65CDOW 03483000
         DROP  R9                 RELEASE TCB EXTENSION        @D65CDOW 03484000
         MVI   TIBRQID,NOTACT     SET TIB INACTIVE             @D52GDIS 03485000
         ST    R5,TIBTCB          TCB POINTER TO TIB           @D52VDIS 03486000
         LR    R2,RF              RESTORE INDEX INTO TIBATAB   @D61EDIS 03487000
         STM   R0,RF,TCBSSAV      SAVE REG.S IN SUBTASK'S TCB  @D61EDIS 03488000
         EJECT ,                                               @D52VDIS 03489000
*--------------------------------------------------------------         03490000
* $IJBVEND  - INITIALIZE VENDOR INTERFACES FOR ATTACHED TASK            03491000
*             INPUT:  RA - TCB ADDRESS OF ATTACHED TASK                 03492000
*                     RE - RETURN ADDRESS                               03493000
*                     RD - $IJBVEND BASE ADDRESS                        03494000
*                     RF - FUNCTION CODE                                03495000
*             OUTPUT: RF - RETURN CODE (GETVIS RETURN CODE)             03496000
*             AMODE:  ANY                                               03497000
*             $IJBVEND HAS TO RETURN WITH THE AMODE OF THE CALLER       03498000
*--------------------------------------------------------------         03499000
         L     RF,ASVASVDL        PTR.TO SVA ROUT.ADDR.TABLE   @D61EDIS 03500000
         ICM   RF,15,AIJBVEND-SVASVDL(RF) GET ROUTINE ADDRESS  @D61EDIS 03501000
         BZ    SVC38DV            BRANCH IF NOT AVAILABLE      @D61EDIS 03502000
         LR    RA,R5              GET SUBTASK'S TCB ADDRESS    @D61EDIS 03503000
         LR    RD,RF              INITIALIZE $IJBVEND BASE     @D61EDIS 03504000
         LA    RF,10              SET FUNCTION CODE            @D61EDIS 03505000
         BASSM RE,RD               CALL ROUTINE                @D64ADIS 03506000
         L     R5,TIBTCB          GET SUBTASK'S TCB ADDRESS    @D61EDIS 03507000
         LTR   RF,RF              ALLOCATION ERROR             @D61EDIS 03508000
         LM    R0,RF,TCBSSAV      RESTORE REGISTERS            @D61EDIS 03509000
         BNZ   SVC38ER0           CONTINE WITH ERROR ROUTINE   @D61EDIS 03510000
         EJECT ,                                               @D52VDIS 03511000
*--------------------------------------------------------------         03512000
* SVC38DV  - ALLOCATE / INITIALIZE SIMULATED CONTROL BLOCKS             03513000
*--------------------------------------------------------------         03514000
SVC38DV  DS    0H                                              @D52VDIS 03515000
         L     R9,PCBPTR          GET CURRENT PCB ADDRESS      @D61NDIS 03516000
         USING PCBADR,R9                                       @D61NDIS 03517000
         TM    PCBFLAG,PCBMVSEM   MVS EMULATION MODE ACTIVE ?  @D61NDIS 03518000
         BZ    SVC38NOE           NO, SKIP                     @D61NDIS 03519000
         DROP  R9                                              @D61NDIS 03520000
         LR    RA,R5              GET SUBTASK'S TCB ADDRESS    @D61NDIS 03521000
*--------------------------------------------------------------         03522000
*          - SMCBEM MAY DESTROY ALL REGISTERS, EXCEPT RA                03523000
*            INPUT:  RA - TCB ADDRESS OF SUBTASK                        03524000
*            OUTPUT: RF - RETURN CODE                                   03525000
*--------------------------------------------------------------         03526000
*        SMCBEM FUNC=ALLOC        ALLOCATE CONTROL BLOCKS      @D64ADIS 03527000
         SMCBEM FUNC=ALLOC        ALLOCATE CONTROL BLOCKS      @D64ADIS 03528000
         LR    R5,RA              RESTORE SUBTASK'S TCB ADDR.  @D61EDIS 03529000
         LTR   RF,RF              ALLOCATION ERROR             @D61EDIS 03530000
         LM    R0,RF,TCBSSAV      RESTORE REGISTERS            @D61EDIS 03531000
         BNZ   SVC38ER0           CONTINE WITH ERROR ROUTINE   @D61EDIS 03532000
         EJECT ,                                               @D64ADIS 03533000
*--------------------------------------------------------------         03534000
* SVC38NOE - ALLOCATE / INITIALIZE DATA SPACE TABLES (ALCOPY=YES)       03535000
*            INPUT   R5 = SUBTASK'S TCB ADDRESS                         03536000
*                    R6 = DISPATCHER BASE ADDRESS                       03537000
*                    R7 = SUBTASK'S SAVE AREA ADDRESS                   03538000
*                    R8 = SUBTASK'S TIB ADDRESS                         03539000
*                    RD = BASE ADDRESS                                  03540000
*                    RE = ADDRESS OF PARAMETER LIST EXTENSION           03541000
*                    RF = OFFSET INTO TIBATAB                           03542000
*            WORK:   R1, R9, RF                                         03543000
*--------------------------------------------------------------         03544000
SVC38NOE DS    0H                                              @D52VDIS 03545000
         LA    R0,8               INDICATE ALCOPY=YES          @D64ADIS 03546000
         TM    0(RE),SVC38FAL     DU-AL TO BE COPIED ?         @D52GDIS 03547000
         BO    SVC38DA            YES, PASS INDICATION         @D64ADIS 03548000
         LA    R0,0               INDICATE ALCOPY=NO           @D64ADIS 03549000
SVC38DA  DS    0H                                              @D64ADIS 03550000
         L     RF,ASVASVDL        PTR.TO SVA ROUT.ADDR.TABLE   @D52GDIS 03551000
         L     RF,AIJBDSPA-SVASVDL(,RF) GET DS ROUTINE ADDRESS @D52GDIS 03552000
*--------------------------------------------------------------         03553000
*           - ALLOCATE DATA SPACE TABLES VIA $IJBDSPA                   03554000
*             INPUT:  R0 - = 0 - ALCOPY=NO  REQUESTED                   03555000
*                            8 - ALCOPY=YES REQUESTED                   03556000
*                     R8 - TIB ADDRESS OF ATTACHED TASK                 03557000
*                     RE - RETURN ADDRESS                               03558000
*                     RF - $IJBDSPA BASE ADDRESS                        03559000
*             OUTPUT: RF - RETURN CODE                                  03560000
*                          0 = ALLOCATION SUCCESSFUL                    03561000
*                          NOT ZERO = SYSTEM GETVIS RETURN CODE         03562000
*             WORK:   R0 - R7, RD                                       03563000
*             AMODE:  31                                                03564000
*             $IJBDSPA HAS TO RETURN WITH THE AMODE OF THE CALLER       03565000
*--------------------------------------------------------------         03566000
         OI    TIBFLAG4,TIBDSAPA  SET DATA SPACE APPENDAGE ACT.@D52GDIS 03567000
         BASSM RE,RF              CALL ROUTINE                 @D64ADIS 03568000
         NI    TIBFLAG4,XFF-TIBDSAPA  RESET ACTIVE INDICATION  @D52GDIS 03569000
*--------------------------------------------------------------         03570000
*           - RETURN FROM DATA SPACE TABLE ALLOCATION ROUTINE           03571000
*--------------------------------------------------------------         03572000
         L     R5,TIBTCB          GET SUBTASK'S TCB ADDRESS    @D52GDIS 03573000
         LTR   RF,RF              ALLOCATION ERROR             @D52GDIS 03574000
         LM    R0,RF,TCBSSAV      RESTORE REGISTERS            @D61EDIS 03575000
         BNZ   SVC38ERE           CONTINE WITH ERROR ROUTINE   @D52GDIS 03576000
         EJECT ,                                               @D61EDIS 03577000
*--------------------------------------------------------------         03578000
*          - CONTINUE AFTER SAVE AREA, TIB AND TCB ALLOCATION           03579000
*            INPUT:  R0 = ENTRY POINT ADDRESS                           03580000
*                    R3 = ABSAVE ADDRESS                                03581000
*                    R4 = ECB ADDRESS                                   03582000
*                    R5 = SUBTASK'S TCB ADDRESS                         03583000
*                    R6 = DISPATCHER BASE ADDRESS                       03584000
*                    R7 = SUBTASK'S SAVE AREA ADDRESS                   03585000
*                    R8 = SUBTASK'S TIB ADDRESS                         03586000
*                    RA = CURRENT TCB ADDRESS                           03587000
*                    RB = CURRENT SAVE AREA ADDRESS                     03588000
*                    RC = ADDRESS OF NAME FIELD                         03589000
*                    RD = BASE ADDRESS                                  03590000
*                    RE = ADDRESS OF PARAMETER LIST EXTENSION           03591000
*--------------------------------------------------------------         03592000
         LH    R1,PIK                                          @D64ADIS 03593000
         STH   R1,TIBPIK          SETUP TIBPIK FIELD           @D36IDFR 03594000
         L     R9,PCBPTR          RESTORE CURRENT PCB POINTER  @D52GDIS 03595000
         USING PCBADR,R9                                       @D61NDIS 03596000
         ST    R9,TIBPCB          SETUP PCB POINTER IN TIB     @D36IDFR 03597000
         MVC   TIBSCB,PCBASCB     SCB POINTER OF ACTIVE SPACE  @D14NDFG 03598000
         CLC   PCBATRAX(4),F0     TRACE ACTIVE ?               @KXA0065 03599000
         BE    SVC38DNT           NO, SKIP                     @KXA0065 03600000
         OI    TIBTFLAG,TIBTTACT  SET TRACE ACTIVE             @KXA0065 03601000
SVC38DNT DS    0H                                              @KXA0065 03602000
         TM    0(RE),SVC38FNA+SVC38FSS USER SAVEAREA SPECIFIED @D14BDFR 03603000
         BM    SVC38SSA           USE TCB SAVE WITHOUT USER NAM@D52VDIS 03604000
         BO    SVC38SUN           USE TCB SAVE WITH USER NAME  @D14BDFR 03605000
*--------------------------------------------------------------         03606000
* SVC38SAV - RETURN FROM SVC38SSA AND SVC38SUN ROUTINES                 03607000
*--------------------------------------------------------------         03608000
SVC38SAV ST    R7,TCBSAVE         SUBT.SAVEAREA ADDR.TO TCB    @D14BDFR 03609000
         LTR   R4,R4              ECB POINTER PRESENT?         @D14BDFR 03610000
         BZ    NOSTECB            NO,BRANCH AROUND NEXT STMNT. @D14BDFR 03611000
         TM    TCBMVSIS-TCBADR(RA),TCBMVSSA  MVS SIMULATION ?  @D64ADIS 03612000
         BZ    SVC38VEC           NO, UNPOST VSE ECB           @D64ADIS 03613000
SVC38MNP DS    0H                                              @D64ADIS 03614000
         L     R9,0(,R4)          GET MVS ECB CONTENTS         @D64ADIS 03615000
         LR    R2,R9              SAVE IT                      @D64ADIS 03616000
         SLL   R2,2               UNPOST MVS ...               @D64ADIS 03617000
         SRL   R2,2                        ...                 @D64ADIS 03618000
         CS    R9,R2,0(R4)                 ... ECB             @D64ADIS 03619000
         BNE   SVC38MNP           ECB NOT UPDATED -> AGAIN     @D64ADIS 03620000
         O     R4,BIT0OMSK        INDICATE MVS ECB             @D64ADIS 03621000
         B     NOSTECB            SAVE IT IN TCB               @D64ADIS 03622000
         SPACE 2                                               @D64ADIS 03623000
SVC38VEC DS    0H                                              @D64ADIS 03624000
         NI    2(R4),UNPOST2      UNPOST THE ECB               @D14BDFR 03625000
NOSTECB  ST    R4,TCBECB          PUT ECB ADDR IN SUBTASK TCB  @D14BDFR 03626000
         LH    R4,TID             STORE ID OF ATTACHING TASK   @D14BDFR 03627000
         STH   R4,FATHERID            INTO SUBTASKS TCB        @D14BDFR 03628000
         DROP  R5                                              @D14BDFR 03629000
         EJECT ,                                               @D51IDIS 03630000
         USING TCBADR,RA                                       @D14BDFR 03631000
*--------------------------------------------------------------         03632000
*          - SET UP THE SAVE AREA OF THE SUBTASK                        03633000
*            SUBTASK RECEIVES CONTROL WITH THE AMODE OF THE CALLER      03634000
*            SUBTASK'S PSW = PASSED ENTRY POINT INCLUDING AMODE         03635000
*            SUBTASK'S SVETID = TASK ID OF SUBTASK                      03636000
*            SUBTASK'S R1  = ADDRESS OF ATTACHING TASK'S SAVE AREA      03637000
*            IF RETURN=YES,                                             03638000
*               SUBTASK'S RE  = ADDRESS OF DETACH ROUTINE               03639000
*               SUBTASK'S RF  = ADDRESS OF ENTRY POINT,                 03640000
*                               HIGH ORDER BIT GIVES AMODE              03641000
*            NEW INTERFACE:                                             03642000
*               ATTACHING TASK'S R1 = SUBTASK SAVE AREA                 03643000
*                                  (SYSTEM DEFINED SAVE AREA)           03644000
*            OLD INTERFACE:                                             03645000
*               ATTACHING TASK'S R0 = BYTE BEYOND SUBTASK'S SAVE AREA   03646000
*               ATTACHING TASK'S R1 = POSITIVE                          03647000
*--------------------------------------------------------------         03648000
         MVC   SVEPSW-SVEARA(SVEEND-SVEPSW,R7),SVEPSW          @D36IDFR 03649000
         TM    TCBEXFLG,TCBEXAM   CALLER IN 31 BIT MODE ?      @D52VDIS 03650000
         BZ    SVC38N31           NO, CALL SUBTASK IN AMODE 24 @D52VDIS 03651000
         TM    TCBMVSIS,TCBMVSSA  IS IT MVS SIM                @D64ADIS 03652000
         BO    SVC38N31           YES, USE GIVEN MODE          @D64ADIS 03653000
         O     R0,BIT0OMSK        --> CALL SUBTASK IN AMODE 31 @D52VDIS 03654000
SVC38N31 DS    0H                                              @D52VDIS 03655000
         ST    R0,SVEPSW2-SVEARA(,R7) ENTRY POINT ADDRESS      @D14BDFR 03656000
         TM    0(RE),SVC38FRT     RETURN PARAMETER SPECIFIED   @D14BDFR 03657000
         BZ    SVC38NOR           NO, DO NOT SETUP RETURN REGS @D14BDFR 03658000
         TM    TCBMVSIS,TCBMVSSA  IS IT MVS SIM                @D64ADIS 03659000
         BZ    SVC38S22           MVS SIMULATION               @D64ADIS 03660000
         L     R9,ASGMVSAP        GET MVS API BASE ADDRESS     @D64ADIS 03661000
         USING SGMVSAPI,R9                                     @D64ADIS 03662000
         BAL   R4,SVC38S00        CALL MVS ATTACH SERVICE ROUT.@D64ADIS 03663000
*SGLINK SVC38S00,INPUT=(R4,R5,R7,R9,RA,RB),WORK=(R2,R3,RF)              03664000
         DROP  R9                                              @D64ADIS 03665000
SVC38S22 DS    0H                                              @D64ADIS 03666000
         ST    R0,SVER0F-SVEARA(,R7) ENTRY POINT ADDR. TO R15  @D14BDFR 03667000
         LA    R0,SVDETACH        POINT TO DETACH CALL         @D14BDFR 03668000
         TM    TCBEXFLG,TCBEXAM   CALLER IN 31 BIT MODE ?      @D64ADIS 03669000
         BZ    SVC38S23           NO, RETURN       IN AMODE 24 @D64ADIS 03670000
         O     R0,BIT0OMSK        --> RETURN       IN AMODE 31 @D64ADIS 03671000
SVC38S23 DS    0H                                              @D64ADIS 03672000
         ST    R0,SVER0E-SVEARA(,R7) RETURN ADDRESS            @D14BDFR 03673000
SVC38NOR LH    R0,TIBRTID         INSERT SUBTASKS ID           @D14BDFR 03674000
         STH   R0,SVETID-SVEARA(,R7) TID TO SUBTASK SAVEAREA   @D14BDFR 03675000
         TM    TCBMVSIS,TCBMVSSA  IS IT MVS SIM ?              @D64ADIS 03676000
         BO    SVC38E             YES, REG.1 IS ALREADY SET    @D64ADIS 03677000
         ST    RB,SVER01-SVEARA(,R7) REQ-S SAVE.PTR IN SUBS R1 @D36IDFR 03678000
         TM    0(RE),SVC38FSS     SYSTEM SAVEAREA  SPECIFIED   @D14BDFR 03679000
         BZ    SVC38NSS           NO, SUPPORT OLD INTERFACE    @D14BDFR 03680000
         ST    R7,SVER01          SUB SAVEAREA PTR TO MAIN R1  @D14BDFR 03681000
         B     SVC38AB                                         @D14BDFR 03682000
         EJECT ,                                               @D52VDIS 03683000
*--------------------------------------------------------------         03684000
* SVC38NSS - RETURN USER SPECIFIED SAVE AREA END ADDRESS + 1            03685000
*--------------------------------------------------------------         03686000
SVC38NSS LA    R0,SVEEND-SVEARA(,R7) BYTE BEYOND SUB. SAVEAREA @D36IDFR 03687000
         ST    R0,SVER00          PUT THIS ADDR IN REQ.TASK R0 @D36ZDFR 03688000
         NI    SVER01,MAKEPOS     ENSURE REQ-S R1 NOT NEGATIVE @D36ZDFR 03689000
         SPACE 1                                               @D369DFR 03690000
*--------------------------------------------------------------         03691000
* SVC38AB  - IF ABSAVE PARAMETER WAS PASSED SETUP AB EXIT FOR SUBTASK   03692000
*            R3 - AB EXIT SAVE AREA (ABSAVE) ADDRESS                    03693000
*                 = 0 - NO ABSAVE SPECIFIED                             03694000
*                 < 0 - OLD ABSAVE LAYOUT                               03695000
*                 > 0 - NEW ABSAVE LAYOUT                               03696000
*            R5 - TCB ADDRESS OF ATTACHED SUBTASK                       03697000
*            RA - TCB ADDRESS OF ATTACHING TASK                         03698000
*            RB - SAVE AREA ADDRESS OF ATTACHING TASK                   03699000
*--------------------------------------------------------------         03700000
SVC38AB  LTR   R3,R3              AB SAVEAREA POINTER PRESENT? @D35IDFR 03701000
         BZ    SVC38E             BR IF NOT PRESENT                     03702000
         L     R9,ASGEXIT         GET SGEXIT BASE ADDRESS      @D64ADIS 03703000
         USING SGEXIT,R9                                       @D64ADIS 03704000
         L     R9,ASUBABEX        GET SUBABEX ADDRESS          @D64ADIS 03705000
         BASSM R9,R9              CALL AB EXIT INITIALIZATION  @D64ADIS 03706000
*SGLINK SUBABEX,INPUT=(R3,R5,R9,RA,RB),OUTPUT=(RF)                      03707000
         DROP  R9                                              @D64ADIS 03708000
         LTR   RF,RF              GETVIS RETURN CODE ?         @D64ADIS 03709000
         BNZ   SVC38ERE           YES, CALL ERROR ROUTINE      @D64ADIS 03710000
*--------------------------------------------------------------         03711000
* SVC38E  - UPDATE STATISTIC COUNTERS                                   03712000
*--------------------------------------------------------------         03713000
SVC38E   DS    0H                                              @D51IDIS 03714000
         L     R3,IJBCLIM         GET ADDRESS OF LIMITS TABLE  @D51IDIS 03715000
         LH    R1,CATASK-CLIM(,R3) GET NO. OF CURR.ACTIVE TASKS@D51IDIS 03716000
         LA    R1,1(,R1)          INCREASE COUNT               @D51IDIS 03717000
         STH   R1,CATASK-CLIM(,R3) SAVE COUNT                  @D51IDIS 03718000
         LH    R4,CACTTS-CLIM(,R3) GET MAX.NO. OF ATT. TASKS   @D51IDIS 03719000
         SR    R1,R4              MAX. COUNT UPDATE NECESSARY ?@D51IDIS 03720000
         BNP   SVC38E1            NO, SKIP UPDATE              @D51IDIS 03721000
         LA    R4,1(,R4)          INCREASE COUNT               @D51IDIS 03722000
         STH   R4,CACTTS-CLIM(,R3) SAVE COUNT                  @D51IDIS 03723000
         EJECT ,                                               @D64ADIS 03724000
*--------------------------------------------------------------         03725000
* SVC38E1 - INSERT TASKS DISPATCHING SLOT TO LOWEST SUBTASK PRIORITY    03726000
*--------------------------------------------------------------         03727000
SVC38E1  DS    0H                                              @D51IDIS 03728000
         L     R9,PCBPTR          RESTORE CURRENT PCB POINTER  @D64ADIS 03729000
         USING PCBADR,R9                                       @D64ADIS 03730000
         LH    R1,PCBLCTSS        UPDATE                       @D51IDIS 03731000
         LA    R3,1(,R1)          ... NUMBER OF SUBTASKS       @D66ODOW 03732000
         STH   R3,PCBLCTSS        ....  IN PCB                 @D66ODOW 03733000
         TM    SUPVFLAG,M255TASK  MORE THAN 255 TASKS SPECIFIED@D66ODOW 03734000
         BO    SVC38E5                                         @D66ODOW 03735000
         L     R3,IJBCLIM         GET ADDRESS OF LIMITS TABLE  @D66ODOW 03736000
         CLC   CDEFSTPP-CLIM(2,R3),PCB#SUBT MORE THAN 31 S-TASK@D66ODOW 03737000
         BL    SVC38E5            YES, SKIP UPDATE TID-STRING  @D66ODOW 03738000
         LA    R3,TIDSTR(R1)                                   @D14BDFR 03739000
         LA    R1,1(,R1)                NUMBER OF SUBTASKS     @D36IDFR 03740000
         LA    R4,TIDSTR(R1)                                   @D14BDFR 03741000
         IC    R1,TIDSTR-TIDSTR(,R3) SHIFT MAINTASKS TIDSTR BYT@D14BDFR 03742000
         STC   R1,TIDSTR-TIDSTR(,R4) ONE POS.TO THE RIGHT      @D14BDFR 03743000
         MVC   TIDSTR-TIDSTR(1,R3),TIBRTID+1 INSERT TASKS ID   @D66ODOW 03744000
SVC38E5  DS    0H                                              @D66ODOW 03745000
         MVI   TIBRQID,READY      INDICATE TASK IS READY TO RUN@D66ODOW 03746000
         L     R4,PCBIMASK     *###   TEMP CODE                @D66ODOW 03747000
         L     RF,BIT0ON       *###   TEMP CODE                @D66ODOW 03748000
SVC38E5X DS    0H                                              @D66ODOW 03749000
         SRL   RF,1            *###   TEMP CODE                @D66ODOW 03750000
         LTR   RF,RF           *###   TEMP CODE                @D66ODOW 03751000
         BZ    SVC38E5Y        *###   TEMP CODE                @D66ODOW 03752000
         OR    R4,RF           *###   TEMP CODE                @D66ODOW 03753000
         C     R4,PCBIMASK     *###   TEMP CODE                @D66ODOW 03754000
         BE    SVC38E5X        *###   TEMP CODE                @D66ODOW 03755000
         ST    RF,TIBIMASK     *###   TEMP CODE                @D66ODOW 03756000
         ST    R4,PCBIMASK     *###   TEMP CODE                @D66ODOW 03757000
SVC38E5Y DS    0H                                              @D66ODOW 03758000
*        DISPMAC FUNC=ATTACH,INP1=R8,INP2=R9                   @D61RDIS 03759000
         DISPMAC FUNC=ATTACH,INP1=R8,INP2=R9                   @D61RDIS 03760000
         EJECT ,                                               @D61PDIS 03761000
*--------------------------------------------------------------         03762000
* SVC38LNK  - INITIALIZE CONTROL REGISTER SAVE AREA                     03763000
*             INPUT:  R5 - TCB ADDRESS OF ATTACHED TASK                 03764000
*                     R6 - DISPATCHER BASE ADDRESS                      03765000
*                     R8 - TIB ADDRESS OF ATTACHED TASK                 03766000
*--------------------------------------------------------------         03767000
SVC38LNK DS    0H                                              @D61PDIS 03768000
         LR    RA,R5              TCB OF ATTACHED TASK         @D61PDOW 03769000
*--------------------------------------------------------------         03770000
* $IJBLSTK  - SET INITIAL VALUES FOR LINK STACK SUPPORT                 03771000
*             SET INITIAL VALUES FOR CONTROL REGS IN TCBX1CRS           03772000
*             INPUT:  R8 - TIB ADDRESS OF ATTACHED TASK                 03773000
*                     RA - TCB ADDRESS OF ATTACHED TASK                 03774000
*                     RE - RETURN ADDRESS                               03775000
*                     RC - $IJBLSTK BASE ADDRESS                        03776000
*                     RF - FUNCTION CODE (=8)                           03777000
*             AMODE:  31                                                03778000
*             WORK:   DO NOT DESTROY R6, R8                             03779000
*--------------------------------------------------------------         03780000
         L     RC,ASVASVDL        PTR.TO SVA ROUT.ADDR.TABLE   @D61PDOW 03781000
         L     RC,AIJBLSTK-SVASVDL(,RC) GET ROUTINE ADDRESS    @D61PDOW 03782000
         LA    RF,8               SET UP FUNCTION CODE         @D61PDOW 03783000
         OI    TIBFLAG4,TIBDSAPA  SET DATA SPACE APPENDAGE ACT.@D61PDOW 03784000
         BASSM RE,RC              CALL ROUTINE                 @D64ADIS 03785000
         NI    TIBFLAG4,XFF-TIBDSAPA  RESET ACTIVE INDICATION  @D61PDOW 03786000
         L     RA,TCBPTR          GET TCB ADDRESS OF CURRENT TS@D64ADIS 03787000
         TM    TCBMVSIS,TCBMVSSA  IS IT MVS SIM ?              @D64ADIS 03788000
         BZR   R6                 NO, RETURN TO DISPATCHER     @D64ADIS 03789000
         LA    RF,0               SET RETURN CODE              @D64ADIS 03790000
SVC38MVR DS    0H                                              @D64ADIS 03791000
         L     R9,ASGMVSAP        GET MVS API BASE ADDRESS     @D64ADIS 03792000
         USING SGMVSAPI,R9                                     @D64ADIS 03793000
         B     SGMAPIEX           RETUN TO MVS SERVICE ROUTINE @D64ADIS 03794000
         DROP  R8                                              @D52VDIS 03795000
         DROP  R9                                              @D64ADIS 03796000
         DROP  RA                                              @D14BDFR 03797000
         EJECT ,                                               @D52VDIS 03798000
*--------------------------------------------------------------         03799000
* SVC38... - SUBROUTINES                                                03800000
*--------------------------------------------------------------         03801000
         USING TIBADR,R8                                       @D52VDIS 03802000
         USING PCBADR,R9                                       @D52VDIS 03803000
         USING TCBADR,RA                                       @D52VDIS 03804000
*--------------------------------------------------------------         03805000
* SVC38WTS - INDICATE NO SUBTASKS AVAILABLE                             03806000
*            INPUT:  R6 = DISPATCHER BASE ADDRESS                       03807000
*                    R9 = PCB ADDRESS                                   03808000
*                    RB = SAVE AREA ADDRESS                             03809000
*                    RD = BASE ADDRESS                                  03810000
*--------------------------------------------------------------         03811000
SVC38WTS DS    0H                                              @D64ADIS 03812000
         LA    RF,8               SET RETURN CODE              @D64ADIS 03813000
         TM    TCBMVSIS,TCBMVSSA  IS IT MVS SIM ?              @D64ADIS 03814000
         BO    SVC38MVR           YES, RETURN                  @D64ADIS 03815000
         LA    R1,SPVECB          INIT.R1 WITH SUB.AVAIL.ECB   @D14BDFR 03816000
         B     SVC38WT            GOTO SETUP TASK TO WAIT      @D14BDFR 03817000
         SPACE 2                                               @D64ADIS 03818000
SVC38WTP DS    0H                                              @D64ADIS 03819000
         LA    RF,8               SET RETURN CODE              @D64ADIS 03820000
         TM    TCBMVSIS,TCBMVSSA  IS IT VSE ATTACH ?           @D64ADIS 03821000
         BO    SVC38MVR           NO, CONTINUE WITH MVS RETURN @D64ADIS 03822000
         L     R1,PCEPIB2         GET PIB2 ADDRESS             @D51IDIS 03823000
         LA    R1,SPVECBX-PIB2ADR(,R1)                         @D51IDIS 03824000
SVC38WT  NI    2(R1),UNPOST1      UNPOST THE ECB               @D14BDFR 03825000
         ST    R1,SVER01          PUT ECB ADDR.IN MAINTASKS R1 @D369DFR 03826000
         OI    SVER01,MAKENEG     MAKE MAINTASKS R1 NEGATIVE   @D369DFR 03827000
         BR    R6                 GO TO TASK SELECTION         @D52GDIS 03828000
         DROP  R9                                              @D61NDIS 03829000
         EJECT ,                                               @D52VDIS 03830000
*--------------------------------------------------------------         03831000
* SVC38SSA - PREPARE SUBTASK NAME IN SUBTASK SAVE AREA                  03832000
*            INPUT:  R7 = ADDRESS OF SUBTASK'S SAVE AREA                03833000
*                    R8 = TIB ADDRESS                                   03834000
*                    RD = BASE ADDRESS                                  03835000
*--------------------------------------------------------------         03836000
SVC38SSA DS    0H                                              @D52VDIS 03837000
         LH    RC,TIBRTID         GET TASKS ID                 @D52VDIS 03838000
         CVD   RC,SVEPSW-SVEARA(R7) CONV.IT TO PACKED DEC.     @D52VDIS 03839000
         OI    7+SVEPSW-SVEARA(R7),M15          GET IT NUMERIC @D52VDIS 03840000
         MVC   0(8,R7),SUBTNAME   MOVE NAME PART WITH MASK     @D52VDIS 03841000
         ED    4(4,R7),SVEPSW-SVEARA+6(R7) EDIT IT             @D52VDIS 03842000
         B     SVC38SAV           RETURN TO MAIN PATH          @D52VDIS 03843000
         SPACE 4                                               @D51IDIS 03844000
*--------------------------------------------------------------         03845000
* SVC38SUN - MOVE USER NAME TO TCB SUBTASK SAVE AREA                    03846000
*            INPUT:  R7 = ADDRESS OF SUBTASK'S SAVE AREA                03847000
*                    R8 = TIB ADDRESS                                   03848000
*                    RC = POINTER TO NAME FIELD                         03849000
*                    RD = BASE ADDRESS                                  03850000
*--------------------------------------------------------------         03851000
SVC38SUN MVC   0(8,R7),0(RC)      MOVE USER NAME INTO TCB SAVE @D52VDIS 03852000
         B     SVC38SAV           RETURN TO MAIN PATH          @D52VDIS 03853000
         EJECT ,                                               @D51IDIS 03854000
*--------------------------------------------------------------         03855000
* SVC38GVS - ALLOCATE SUBTASK SAVE AREA, IF REQUIRED                    03856000
*            INPUT:  R2 = ADDR OF FREE SLOT IN TIBATAB                  03857000
*                    R6 = DISPATCHER BASE ADDRESS                       03858000
*                    RA = CURRENT TCB ADDRESS                           03859000
*                    RB = CURRENT SAVE AREA ADDRESS                     03860000
*                    RC = POINTER TO SAVE AREA / NAME FIELD             03861000
*                    RD = BASE ADDRESS                                  03862000
*                    RE = ADDRESS OF PARAMETER LIST EXTENSION           03863000
*            OUTPUT: R1 = AR SAVE AREA ADDRESS                          03864000
*                    R2 = OFFSET INTO TIBATAB                           03865000
*                    R5 = SUBTASK'S TCB ADDRESS                         03866000
*                    R7 = SUBTASK'S SAVE AREA ADDRESS                   03867000
*                    R8 = SUBTASK'S TIB ADDRESS                         03868000
*                    R9 = 2. AR SAVE AREA ADDRESS                       03869000
*                    RF = TDSE ADDRESS                                  03870000
*--------------------------------------------------------------         03871000
SVC38GVS DS    0H                                              @D14BDFR 03872000
         LR    R5,R0              SAVE ENTRY POINT             @D14BDFR 03873000
         SLR   R8,R8              INDICATE NO TIB AVAILABLE    @D68CDOW 03874000
         LA    R0,SVEEND-SVEARA   GET SAVE AREA LENGTH         @D52VDIS 03875000
*        SGETVIS SPID=SPSAV,PFIX=NO,ADDRESS=(1),LENGTH=(0)              03876000
         SGETVIS SPID=SPSAV,PFIX=NO,ADDRESS=(1),LENGTH=(0)     @D52VDIS 03877000
         LTR   RF,RF              SAVE AREA ALLOCATED ?        @D52VDIS 03878000
         BNZ   SVC38ER0           NO, RETURN TO CALLER         @D52VDIS 03879000
         LR    R7,R1              SAVE POINTER TO SAVE AREA    @D52VDIS 03880000
         EJECT ,                                               @D52VDIS 03881000
*---------------------------------------------------------------------  03882000
*  - ALLOCATE SUBTASK'S 31 BIT CONTROL BLOCKS                           03883000
*      TCB EXTENSION, TDSE, LINKAGE STACK, TSCT                         03884000
*---------------------------------------------------------------------  03885000
         LA    R0,TCBXLNGR+TDSELENR+64+LSTLNGR GET LENGTH OF ..@D64ADMZ 03886000
*                            31 BIT CB +64 BYTE FOR TDSE ALIGN.@D61NDIS 03887000
         L     R1,ADPCRADR              GET CB INTERFACE AREA  @D61RDIS 03888000
         LH    R1,DPTSCLNG-DPCRADR(,R1) GET LENGTH OF TSCT     @D61RDIS 03889000
         LA    R1,16(,R1)              + 16 BYTE FOR TSC ALIGN.@D61RDIS 03890000
         AR    R0,R1                   GET TOTAL LENGTH        @D61RDIS 03891000
*        SGETVIS SPID=SPTIB,PFIX=YES,ADDRESS=(1),LENGTH=(0),LOC=ANY     03892000
         SGETVIS SPID=SPTIB,PFIX=YES,ADDRESS=(1),LENGTH=(0),LOC=ANY     03893000
         LTR   RF,RF              TIB AVAILABLE                @D14BDFR 03894000
         BNZ   SVC38ERR           NO, GOTO SETUP TASK TO WAIT  @D14BDFR 03895000
         LR    R9,R1              LOAD TCBX POINTER            @D61PDIS 03896000
         EJECT ,                                               @D52VDIS 03897000
*--------------------------------------------------------------         03898000
*          - ALLOCATE SUBTASK TIB AND TCB,                              03899000
*            AR SAVE AREA AND ESA CONTROL BLOCKS                        03900000
*--------------------------------------------------------------         03901000
         LA    R0,TIBLNG+STCBLNG+TCBARSLN                      @D61NDIS 03902000
*                                 GET LENGTH OF ...            @D52GDIS 03903000
*                                 ... TIB, TCB AND ESA AREAS   @D52GDIS 03904000
*        SGETVIS SPID=SPTIB,PFIX=YES,ADDRESS=(1),LENGTH=(0)             03905000
         SGETVIS SPID=SPTIB,PFIX=YES,ADDRESS=(1),LENGTH=(0)    @D14BDIS 03906000
         LTR   RF,RF              TIB AVAILABLE                @D14BDFR 03907000
         BNZ   SVC38ERX           NO, GOTO SETUP TASK TO WAIT  @D61PDIS 03908000
         L     R2,AFRESLOT        ADDR(NEXT FREE TIBTABLE SLOT)@DY46206 03909000
         CLI   0(R2),XFF          POINTING TO END INDICATOR    @DY46206 03910000
         BE    SVC38ERW           YES, WAIT FOR TASK DETACHED  @DY46206 03911000
         LR    R8,R1              LOAD TIB POINTER             @D14BDIS 03912000
         EJECT ,                                               @D52VDIS 03913000
*--------------------------------------------------------------         03914000
*          - INITIALIZE SUBTASK'S TIB AND TCB                           03915000
*--------------------------------------------------------------         03916000
         ST    R8,0(,R2)          SETUP TIB ADDRESS TABLE      @D66ODOW 03917000
         LA    RF,4(,R2)          POINT TO                     @D66ODOW 03918000
         ST    RF,AFRESLOT        ...NEXT SLOT                 @D66ODOW 03919000
         SL    R2,ATIBATAB        OFFSET INTO TIBATAB          @D66ODOW 03920000
         LR    R0,R5              RESTORE ENTRY POINT          @D14BDFR 03921000
         LA    R5,TIBLNG(,R8)     SETUP TCB POINTER            @D51IDIS 03922000
         DROP  RA                                              @D51IDIS 03923000
         USING TCBADR,R5                                       @D51IDIS 03924000
         LA    RF,TCBXLNGR(,R9)   GET ADDRESS OF TDSE          @D64XDIS 03925000
         BCTR  RF,0               ALIGN TDSE ...               @D52GDIS 03926000
         SRL   RF,6                      ... TO ...            @D52GDIS 03927000
         A     RF,F1                        ... 64 BYTE ...    @D52GDIS 03928000
         SLL   RF,6                         ... BOUNDARY ...   @D52GDIS 03929000
         ST    RF,TCBTDSE         SAVE TDSE ADDRESS            @D52GDIS 03930000
         LA    RF,TDSELENR(,RF)   ADDR OF LINKAGE STACK        @D64ADIS 03931000
         L     R1,ADPCRADR              GET DISP INTERFACE ADDR@D61RDIS 03932000
         LH    R1,DPTSCLNG-DPCRADR(,R1) GET LENGTH OF TDSE     @D61RDIS 03933000
         LA    R1,LSTLNGR(,RF)    ALIGN TSCT ...               @D61RDIS 03934000
         BCTR  R1,0                          ...               @D52GDIS 03935000
         SRL   R1,4                      ... TO ...            @D61RDIS 03936000
         A     R1,F1                        ... 16 BYTE ...    @D61RDIS 03937000
         SLL   R1,4                         ... BOUNDARY ...   @D61RDIS 03938000
         ST    R1,TIBTSCT         SAVE TSCT ADDRESS            @D61RDIS 03939000
         LA    R1,STCBLNG(,R5)    POINT TO AR SAVE AREA        @D61PDIS 03940000
         B     SVC38CC            INITIALIZE TIB TCB           @D52VDIS 03941000
         DROP  R5                                              @D52VDIS 03942000
         EJECT ,                                               @D51IDIS 03943000
*--------------------------------------------------------------         03944000
* SVC38ERE  - ALLOCATION OF DATA SPACE AREAS FAILED                     03945000
*             INPUT: R5 = SUBTASK'S TCB ADDRESS                         03946000
*                    R6 = DISPATCHER BASE ADDRESS                       03947000
*                    RD = BASE ADDRESS                                  03948000
*                    RE = ADDRESS OF PARAMETER LIST EXTENSION           03949000
*--------------------------------------------------------------         03950000
SVC38ERE DS    0H                                              @D61NDIS 03951000
         L     R9,PCBPTR          GET CURRENT PCB ADDRESS      @D61NDIS 03952000
         USING PCBADR,R9                                       @D61NDIS 03953000
         TM    PCBFLAG,PCBMVSEM   MVS EMULATION MODE ACTIVE ?  @D61NDIS 03954000
         BZ    SVC38ER0           NO, SKIP                     @D61NDIS 03955000
         DROP  R9                                              @D61NDIS 03956000
         LR    RA,R5              GET SUBTASK'S TCB ADDRESS    @D61EDIS 03957000
*--------------------------------------------------------------         03958000
*          - SMCBEM MAY DESTROY ALL REGISTERS, EXCEPT RA                03959000
*            INPUT:  RA - TCB ADDRESS OF SUBTASK                        03960000
*--------------------------------------------------------------         03961000
*        SMCBEM FUNC=DEALL        DEALLOCATE CONTROL BLOCKS    @D64ADIS 03962000
         SMCBEM FUNC=DEALL        DEALLOCATE CONTROL BLOCKS    @D64ADIS 03963000
         USING TCBADR,RA                                       @D14BDFR 03964000
         LM    R0,RF,TCBSSAV      RESTORE REGISTERS            @D61EDIS 03965000
         B     SVC38ER0           CONTINUE WITH ERROR PROCESS  @D61NDIS 03966000
         SPACE 3                                               @D51IDIS 03967000
*--------------------------------------------------------------         03968000
* SVC38ERW  - NO TIBATAB ENTRY AVAILABLE ANYMORE                        03969000
*             INPUT: R1 = ADDRESS OF TIB,TCB,ESA AREAS                  03970000
*                    R6 = DISPATCHER BASE ADDRESS                       03971000
*                    R7 = ADDRESS OF SUBTASK'S SAVE AREA                03972000
*                    R9 = ADDRESS OF TCB EXTENSION                      03973000
*                    RA = CURRENT TCB ADDRESS                           03974000
*                    RB = CURRENT SAVE AREA ADDRESS                     03975000
*                    RD = BASE ADDRESS                                  03976000
*                    RE = ADDRESS OF PARAMETER LIST EXTENSION           03977000
*--------------------------------------------------------------         03978000
SVC38ERW DS    0H                                              @DY46206 03979000
         LA    R0,TIBLNG+STCBLNG+TCBARSLN                      @DY46206 03980000
*                                 GET LENGTH OF ...                     03981000
*                                 ... TIB, TCB AND ESA AREAS            03982000
*        SFREEVIS ADDRESS=(1),LENGTH=(0)                                03983000
         SFREEVIS ADDRESS=(1),LENGTH=(0)                       @DY46206 03984000
         SPACE 3                                                        03985000
*--------------------------------------------------------------         03986000
* SVC38ERX  - ALLOCATION OF TIB, TCB, ... FAILED                        03987000
*             INPUT: R2 = OFFSET INTO TIBATAB                           03988000
*                    R6 = DISPATCHER BASE ADDRESS                       03989000
*                    R7 = ADDRESS OF SUBTASK'S SAVE AREA                03990000
*                    R9 = ADDRESS OF TCB EXTENSION                      03991000
*                    RA = CURRENT TCB ADDRESS                           03992000
*                    RB = CURRENT SAVE AREA ADDRESS                     03993000
*                    RD = BASE ADDRESS                                  03994000
*                    RE = ADDRESS OF PARAMETER LIST EXTENSION           03995000
*--------------------------------------------------------------         03996000
SVC38ERX DS    0H                                              @D52VDIS 03997000
         LA    R0,TCBXLNGR+TDSELENR+64+LSTLNGR LENGTH OF CBS   @D64XDIS 03998000
         L     R1,ADPCRADR              GET CB INTERFACE AREA  @D61RDIS 03999000
         LH    R1,DPTSCLNG-DPCRADR(,R1) GET LENGTH OF TSCT     @D61RDIS 04000000
         LA    R1,16(,R1)              + 16 BYTE FOR TSC ALIGN.@D61NDIS 04001000
         AR    R0,R1                   GET TOTAL LENGTH        @D61RDIS 04002000
*        SFREEVIS ADDRESS=(9),LENGTH=(0)                                04003000
         SFREEVIS ADDRESS=(9),LENGTH=(0)                       @D61NDIS 04004000
         SPACE 3                                               @D51IDIS 04005000
*--------------------------------------------------------------         04006000
* SVC38ERR  - ALLOCATION OF TCB EXTENSION, TDSE, ... FAILED             04007000
*             INPUT: R2 = OFFSET INTO TIBATAB                           04008000
*                    R6 = DISPATCHER BASE ADDRESS                       04009000
*                    R7 = ADDRESS OF SUBTASK'S SAVE AREA                04010000
*                    RA = CURRENT TCB ADDRESS                           04011000
*                    RB = CURRENT SAVE AREA ADDRESS                     04012000
*                    RD = BASE ADDRESS                                  04013000
*                    RE = ADDRESS OF PARAMETER LIST EXTENSION           04014000
*--------------------------------------------------------------         04015000
SVC38ERR DS    0H                                              @D52VDIS 04016000
         LA    R0,SVEEND-SVEARA   GET SAVE AREA LENGTH         @D52VDIS 04017000
*        SFREEVIS ADDRESS=(7),LENGTH=(0)                                04018000
         SFREEVIS ADDRESS=(7),LENGTH=(0)                       @D52VDIS 04019000
         SPACE 3                                               @D52VDIS 04020000
*--------------------------------------------------------------         04021000
* SVC38ER0 - ENTRY POINT, IF SAVE AREA OR DS TABLE ALLOCATION FAILS     04022000
*--------------------------------------------------------------         04023000
SVC38ER0 DS    0H                                              @D52VDIS 04024000
         LTR   R8,R8              TIB ASSIGNED                 @D68CDOW 04025000
         BZ    SVC38ER2           NO                           @D68CDOW 04026000
         L     R9,AFREETIB        ENQ IN FREE TIB CHAIN        @D68CDOW 04027000
         ST    R8,AFREETIB        INSERT DETACHING TASK        @D68CDOW 04028000
         ST    R9,TIBFCHN         COMPLETE FREE TIB CHAIN      @D68CDOW 04029000
SVC38ER2 DS    0H                                              @D68CDOW 04030000
         L     R9,PCBPTR          RESTORE CURRENT PCB POINTER  @D52GDIS 04031000
         USING PCBADR,R9                                       @D61NDIS 04032000
         LH    R1,PCBNTASK        REDUCE NUMBER OF             @D14BDFR 04033000
         BCTR  R1,R0                 USED TASKS                @D14BDFR 04034000
         STH   R1,PCBNTASK           IN PCB                    @D14BDFR 04035000
         B     SVC38WTS           NO, CONTINUE WITH MAINLINE   @D66ODOW 04036000
         DROP  R8                                              @D52VDIS 04037000
         DROP  R9                                              @D36IDFR 04038000
         DROP  RA                                              @D52VDIS 04039000
         DROP  RB                                              @D61NDIS 04040000
         DROP  RD                                              @D61NDIS 04041000
         EJECT                                                          04042000
*********************************************************************** 04043000
*                                                                     * 04044000
* SVC39 OR DETACH MACRO ROUTINE                                       * 04045000
*                                                                     * 04046000
*********************************************************************** 04047000
*                                                                     * 04048000
* REGISTER 1 IS USED TO PASS A PARAMETER                              * 04049000
*   <R1>= 0 : SUBTASK ISSUES A REQUEST TO DETACH ITSELF               * 04050000
*   <R1>= SAVEAREA POINTER : REQUEST TO DETACH THE OWNER OF SAVEAREA  * 04051000
*       ISSUER OF THIS TYPE OF REQUEST MUST BE EITHER THE MAINTASK    * 04052000
*       OR THE SUBTASK ATTACHING TASK                                 * 04053000
*                                                                     * 04054000
*        AMODE = ANY, RMODE = ANY                                     * 04055000
*        SUBTASK SAVE AREA: RMODE = 24                                * 04056000
*********************************************************************** 04057000
         SPACE 2                                               @D35EDFR 04058000
         USING DISP,R6                                         @D61NDIS 04059000
         USING TIBADR,R8                                       @D61NDIS 04060000
         USING TCBADR,RA                                       @D61NDIS 04061000
         USING SVC39,RD                                        @D61NDIS 04062000
SVC39    DS    0H                                              @D61NDIS 04063000
         LR    RD,RC              GET BASE REGISTER            @D61NDIS 04064000
         TM    TIBFLAG1,EOTACT    REQUEST FROM EOT OWNER?      @D61NDIS 04065000
         BO    DETACHOK           YES, TERMINATE TASK          @D35EDFR 04066000
         SPACE 1                                               @D369DFR 04067000
*--------------------------------------------------------------         04068000
*          - DETACH ISSUED BY MAINTASK ?                                04069000
*            ENTERED, IF SVC 39 CALLED BY USER PROGRAM                  04070000
*--------------------------------------------------------------         04071000
         LTR   R1,R1              SAVE PARAMETER SPECIFIED?    @D369DFR 04072000
         BZ    ST$$DET            NO,MUST BE DET.FOR CURR.TASK @D36IDFR 04073000
         USING SVEARA,R1                                       @D36ZDFR 04074000
         LH    R2,SVETID          R2 CONTAINS TID OF SUBTASK   @D14BDFR 04075000
PCKSVC39 EQU   *                  PROGR.CHECK ADDRESS          @D14BDFR 04076000
         L     R7,IJBCLIM                                      @D66ODOW 04077000
         CH    R2,CSTASK-CLIM(,R7) VALID TASK-ID               @D66ODOW 04078000
         BH    SVC39ERR           NO, ILLEGAL SVC              @D64ADIS 04079000
         CH    R2,IJBHMTID        TID GT HIGHEST MAINTASK ID?  @D51IDIS 04080000
         BNH   SVC39ERR           NO, ILLEGAL SVC              @D64ADIS 04081000
         DROP  R1                                              @D36IDFR 04082000
         USING SVEARA,RB                                       @D36IDFR 04083000
         SLL   R2,2               OFFSET INTO TIB TABLE        @D66ODOW 04084000
         AL    R2,ATIBATAB        ENTRY IN TIB TABLE           @D66ODOW 04085000
         ICM   R8,15,0(R2)        POINTER TO SUBTASKS TIB      @D66ODOW 04086000
         BZ    SVC39ERR           NO, ILLEGAL SVC              @D64ADIS 04087000
         L     RA,TIBTCB          POINTER TO SUBTASKS TCB      @D36IDFR 04088000
         CLC   TID(2),IJBHMTID    DETACH ISSUED BY MAINTASK?   @D51IDIS 04089000
         BNH   SVC39MT            YES,DO NOT TEST FATHER ID    @D36IDFR 04090000
         CLC   TID,FATHERID       REQ FROM ATTACHING TASK      @D66ODOW 04091000
         BNE   SVC39EXI           NO,IGNORE DETACH             @D64ADIS 04092000
         EJECT ,                                               @D51IDIS 04093000
*--------------------------------------------------------------         04094000
* SVC39MT  - LOOK FOR THE CORRECT SUBTASK                               04095000
*--------------------------------------------------------------         04096000
         SPACE 1                                               @D369DFR 04097000
SVC39MT  DS    0H                                              @D64ADIS 04098000
         L     R9,ASGMVSAP        GET MVS API BASE ADDRESS     @D64ADIS 04099000
         USING SGMVSAPI,R9                                     @D64ADIS 04100000
         BAL   R7,SVC39MVS        CONTINUE MVS DETACH PROCESS  @D64ADIS 04101000
*SGLINK SVC39MVS,INPUT=(R6,R7,R8,R9,RA),WORK=(R2,R5,RF)                 04102000
         DROP  R9                                              @D64ADIS 04103000
         C     R1,TCBSAVE         IS IT THE SAVEAREA LOOKED FOR@D64ADIS 04104000
         BE    SVC39OK            YES --->                     @D36IDFR 04105000
         TM    TIBFLAG1,LTAACT    TASK ACTIVE IN LTA           @D36IDFR 04106000
         BZ    SVC39EXI           NO, IGNORE DETACH            @D64ADIS 04107000
         L     R2,ASYSPCB         POINT TO AR PCB              @D51IDIS 04108000
         L     R2,PCEPIB-PCBADR(,R2) POINT TO AR PIB           @D51IDIS 04109000
         C     R1,PIBSAV2N-PIBADR(,R2) IS IT THE RIGHT SAVEAR. @D51IDIS 04110000
         BNE   SVC39EXI           NO, IGNORE DETACH            @D64ADIS 04111000
SVC39OK  CLI   TIBCNCL,ZERO       SUBTASK ALREADY CANCELING    @D36IDFR 04112000
         BNE   SVC39EXI           YES, IGNORE DETACH           @D64ADIS 04113000
*--------------------------------------------------------------         04114000
*          - PROTECT SUBTASKS OF OTHER PARTITIONS                       04115000
*--------------------------------------------------------------         04116000
         LH    R2,PIK             LOAD PIK                     @D36IDFR 04117000
         CH    R2,TIBPIK          SUB BELONGS TO THIS PART.?   @D36IDFR 04118000
         BNE   SVC39EXI           YES, IGNORE DETACH           @D64ADIS 04119000
         MVI   TIBCNCL,NORMEOJ    INDICATE DETACH REQUEST      @D36IDFR 04120000
         NI    TCBRFLAG,XFF-TCBRCVAL ...AND NO REASON CODE     @D67BDOW 04121000
         OI    TIBFLAG,FETCHEOJ   SET EOJ IN PROGRESS          @D36IDFR 04122000
         BAL   RF,SETREADY        GOTO MAKE TASK READY         @D64ADIS 04123000
*SGLINK  SETREADY,INPUT=(R6,R8,RF),WORK=(RE)                            04124000
SVC39EXI DS    0H                                              @D64ADIS 04125000
         LA    RF,0               SET RETURN CODE              @D64ADIS 04126000
SVC39EXE DS    0H                                              @D64ADIS 04127000
         L     RA,TCBPTR          GET TCB ADDRESS OF CURRENT TS@D64ADIS 04128000
         TM    TCBMVSIS,TCBMVSSA  IS IT MVS SIM ?              @D64ADIS 04129000
         BZR   R6                 NO, RETURN TO DISPATCHER     @D64ADIS 04130000
         L     R9,ASGMVSAP        GET MVS API BASE ADDRESS     @D64ADIS 04131000
         USING SGMVSAPI,R9                                     @D64ADIS 04132000
         B     SGMAPIEX           RETUN TO MVS SERVICE ROUTINE @D64ADIS 04133000
         DROP  R9                                              @D64ADIS 04134000
         SPACE 2                                               @D52VDIS 04135000
SVC39ERR DS    0H                                              @D64ADIS 04136000
         LA    RF,8               SET RETURN CODE              @D64ADIS 04137000
         B     SVC39EXE           RETURN                       @D64ADIS 04138000
         SPACE 2                                               @D52VDIS 04139000
*--------------------------------------------------------------         04140000
* ST$$DET  - PROCESS DETACH OF CURRENT TASK                             04141000
*--------------------------------------------------------------         04142000
ST$$DET  DS    0H                                              @D51IDIS 04143000
         CLC   TID(2),IJBHMTID    DETACH ISSUED BY MAINTASK ?  @D51IDIS 04144000
         BNH   SVC39ERR           YES,ILLEGAL SVC              @D64ADIS 04145000
         MVI   TIBCNCL,NORMEOJ    INDICATE DETACH REQUEST      @D36IDFR 04146000
         NI    TCBRFLAG,XFF-TCBRCVAL ...AND NO REASON CODE     @D67BDOW 04147000
         OI    TIBFLAG,FETCHEOJ   SET EOJ IN PROGRESS          @D36IDFR 04148000
         L     RD,APBASE          GET SGAP BASE ADDRESS        @D61NDIS 04149000
         USING SGAP,RD                                         @D61NDIS 04150000
         B     CNCLEXIT           GOTO PROCESS EOJ FIRST       @D35EDFR 04151000
*SGLINK  CNCLEXIT,INPUT=(R6,R8,RA,RB,RD)                                04152000
         SPACE 2                                               @D14BDIS 04153000
*--------------------------------------------------------------         04154000
* DETACHOK - PROCESS DETACH                                             04155000
*            ENTERED, IF SVC 39 CALLED BY END-OF-TASK ROUTINE           04156000
*--------------------------------------------------------------         04157000
DETACHOK DS    0H                                              @D61NDIS 04158000
         LR    R1,RD              SAVE SVC 39 BASE ADDRESS     @D61NDIS 04159000
         L     RD,APBASE          GET SGAP BASE ADDRESS        @D61NDIS 04160000
         L     R9,ATERMBAS        COMMON BASE ADDR             @D61NDIS 04161000
         USING TERMBASE,R9                                     @D31EDOW 04162000
         BAL   R7,EOTRTRNB        FREE EOT ROUTINE             @D52GDIS 04163000
*SGLINK  EOTRTRN,INPUT=(R6,R7,R8,R9,RA,RD),WORK=(R5,RE,RF)              04164000
         LR    RD,R1              RESTORE SVC 39 BASE ADDRESS  @D64ADIS 04165000
         USING SVC39,RD                                        @D64ADIS 04166000
         ICM   RF,15,PSATOLD      GET TCB ADDRESS              @D64ADIS 04167000
         BZ    DETACHXX           NOT AVAILABLE                @D64ADIS 04168000
         USING TCB,RF                                          @D64ADIS 04169000
         OI    TCBFBYT1,TCBEOT    INDICATE END-OF-TASK PROCESS.@D64ADIS 04170000
         DROP  RF                                              @D64ADIS 04171000
DETACHXX DS    0H                                              @D64ADIS 04172000
         LA    RF,DETACHOS       GET CONTINUATION ADDRESS      @D64ADIS 04173000
         O     RF,BIT0OMSK       CONTINUE IN ...               @D64ADIS 04174000
         BSM   0,RF                      ... 31 BIT MODE       @D64ADIS 04175000
         DROP  R9                                              @D31EDOW 04176000
         EJECT ,                                               @D51IDIS 04177000
*--------------------------------------------------------------         04178000
* DETACHOS - GET TASKS ECB ADDRESS AND                                  04179000
*            POST TASKS OF PARTITION WAITING FOR                        04180000
*--------------------------------------------------------------         04181000
DETACHOS DS    0H                                              @D64ADIS 04182000
         L     R1,TCBECB          ECB POINTER IN R1            @D36IDFR 04183000
         LTR   R1,R1              IS THERE AN ECB?             @D369DFR 04184000
         BZ    SVC39E             NO, DO NOT READY TASKS       @D369DFR 04185000
         OI    2(R1),TRABIT       POST THE ECB                          04186000
         SR    R2,R2              POINT R2 TO                  @D36IDFR 04187000
         ST    R2,TCBECB          CLEAR ECB ADDRESS            @D36IDFR 04188000
         L     R5,ASRQTAB         GET ADDRESS OF SRQTAB        @D61RDIS 04189000
         LA    R5,SRQWAIT-SRQTAB(,R5)  POINT TO I/O BOUND QUEUE@D61RDIS 04190000
         BAL   RF,RPOST           POST TASKS WAITING FOR ECB   @D36IDFR 04191000
*SGLINK  RPOST,INPUT=(R5,R6,RF),WORK=(R5,RE)                            04192000
         LTR   R1,R1              IS THERE AN ECB?             @D64ADIS 04193000
         BM    SVC39E             YES, BUT MVS ECB             @D64ADIS 04194000
         L     R5,ASRQTAB         GET ADDRESS OF SRQTAB        @D61RDIS 04195000
         LA    R5,SRQENQ-SRQTAB(,R5) POINT TO ENQ WAIT QUEUE   @D61RDIS 04196000
         BAL   RF,RPOST           POST TASKS WAITING FOR RCB'S @D36IDFR 04197000
*SGLINK  RPOST,INPUT=(R5,R6,RF),WORK=(R5,RE)                            04198000
         EJECT ,                                               @D51IDIS 04199000
*--------------------------------------------------------------         04200000
* SVC39E   - POST SUPERVISOR ECB AND READY MAINTASKS                    04201000
*            WAITING FOR THIS ECB                                       04202000
*          - FIND PPRTYOWN BELONGING TO SUBTASK                         04203000
*          - READY MAINTASKS WITH HIGHER PRIORITY                       04204000
*            WAITING FOR SUPERVISOR ECB                                 04205000
*--------------------------------------------------------------         04206000
SVC39E   TM    SPVECB+2,TRABIT   TRABIT ON IN SPVECB           @DA08715 04207000
         BO    SVC39E1            YES,NO TASK CAN WAIT FOR     @D36IDFR 04208000
         OI    SPVECB+2,TRABIT   POST SUBTASK AVAILABLE ECB    @DM01394 04209000
         LA    R1,SPVECB          ADDRESS OF SUPERVISOR ECB    @DM01394 04210000
         BAL   R7,RPOSTALL        POST ALL TASKS WAITING FOR   @D36IDFR 04211000
*SGLINK  RPOSTALL,INPUT=(R1,R6,R7,R8),WORK=(R4,R5,RE,RF)                04212000
SVC39E1  L     R5,PIBPTR2                                      @D51IDIS 04213000
         USING PIB2ADR,R5                                      @D51IDIS 04214000
         TM    SPVECBX+2,TRABIT                                @D36IDFR 04215000
         BO    SVC39B                                          @D36IDFR 04216000
         OI    SPVECBX+2,TRABIT                                @D36IDFR 04217000
         LA    R1,SPVECBX                                      @D36IDFR 04218000
         DROP  R5                                              @D36IDFR 04219000
         L     R5,ASRQTAB         GET ADDRESS OF SRQTAB        @D61RDIS 04220000
         LA    R5,SRQWAIT-SRQTAB(,R5)                          @D61RDIS 04221000
         BAL   RF,RPOST                                        @D36IDFR 04222000
*SGLINK  RPOST,INPUT=(R5,R6,RF),WORK=(R5,RE)                            04223000
SVC39B   DS    0H                                              @D51IDIS 04224000
         L     RE,IJBCLIM         GET ADDRESS OF LIMITS TABLE  @D51IDIS 04225000
         LH    R4,CATASK-CLIM(,RE) GET NO. OF CURR.ACTIVE TASKS@D51IDIS 04226000
         BCTR  R4,0               DECREASE COUNT               @D51IDIS 04227000
         STH   R4,CATASK-CLIM(,RE) SAVE COUNT                  @D51IDIS 04228000
         L     R4,AFREETIB        GET FREE TIB CHAIN HEADER    @D66ODOW 04229000
         ST    R8,AFREETIB        INSERT DETACHING TASK        @D66ODOW 04230000
         ST    R4,TIBFCHN         COMPLETE FREE TIB CHAIN      @D66ODOW 04231000
         SLR   R2,R2                                           @D14BDFR 04232000
         STH   R2,TIBPIK          RESET TIBPIK FIELD           @D14BDFR 04233000
         SPACE 1                                                        04234000
         L     R4,PIBPTR2         POINT TO PIB2                @D66ODOW 04235000
         LH    R4,PIBMTID-PIB2ADR(,R4) GET ID OF MAIN TASK     @D66ODOW 04236000
         SLL   R4,2               OFFSET INTO TIBATAB          @D66ODOW 04237000
         AL    R4,ATIBATAB        TIBATAB ENTRY                @D66ODOW 04238000
         L     R4,0(,R4)          MAINTASKS TIB ADDR           @D66ODOW 04239000
         L     R5,PCBPTR          POINTER TO PART.CTL.BLOCK    @D36IDFR 04240000
         USING PCBADR,R5                                       @D36IDFR 04241000
         LH    R3,PCBLCTSS        NUMBER OF SUBTASKS           @D14BDFR 04242000
         LA    R1,TIDSTR(R3)      POINTER TO MAINTASKS ID, USED@D14BDFR 04243000
***                               ...IF SUPERVISOR WITH 255 TASKS ONLY  04244000
         BCTR  R3,R0              REDUCE NUMBER OF SUBTASKS    @D14BDFR 04245000
         STH   R3,PCBLCTSS                                     @D14BDFR 04246000
         LH    R3,PCBNTASK        GET NUMBER OF SUBTASKS       @D14BDFR 04247000
         BCT   R3,SUBATYET        BRANCH IF SUBTASKS ATTACHED  @D34UDFR 04248000
         EJECT ,                                               @D51IDIS 04249000
*--------------------------------------------------------------         04250000
*          - IF WAS LAST SUBTASK ATTACHED AND                           04251000
*            IF MAINTASK IS CANCEL BOUND,                               04252000
*               READY MAINTASK                                          04253000
*--------------------------------------------------------------         04254000
         CLI   TIBRQID-TIBADR(R4),CNCLBND MAIN WAITING FOR SUBS@D14BDFR 04255000
         BNE   SUBATYET           NO,DO NOT POST MAINTASK      @D36IDFR 04256000
         LR    R8,R4                                           @D14BDFR 04257000
         BAL   RF,POST            MAKE TASK READY              @D36IDFR 04258000
*SGLINK  POST,INPUT=(R6,R8,RF),WORK=(RE)                                04259000
         L     R8,TIBPTR                                       @D36IDFR 04260000
SUBATYET STH   R3,PCBNTASK        REDUCE NUMBER OF TASKS BY ONE@D14BDFR 04261000
         DROP  R5                                              @D36IDFR 04262000
         CLI   TIBRQID,CONDRDY    ANY RESERVATIONS MADE ?      @D61RDIS 04263000
         MVI   TIBRQID,NOTACT                                  @D61RDIS 04264000
         BNE   SVC39NEW                                        @D61RDIS 04265000
         L     R5,TIBCHAIN                                     @D61RDIS 04266000
         USING RQADR,R5                                        @D61RDIS 04267000
         TM    RSCDESC,FREEBIT                                 @D66ODOW 04268000
         BNO   SVC39NEW                                        @D66ODOW 04269000
         CLI   RQCHAIN,TIBAVAIL                                @D61RDIS 04270000
         BNE   SVC39NEW                                        @D61RDIS 04271000
         BAL   RF,RPOST2                                       @D61RDIS 04272000
         DROP  R5                                              @D61RDIS 04273000
SVC39NEW DS    0H                                              @D61RDIS 04274000
         L     R5,PCBPTR          RESTORE PCB ADDRESS          @D61RDIS 04275000
         USING PCBADR,R5                                       @D66ODOW 04276000
         TM    SUPVFLAG,M255TASK  MORE THAN 255 TASKS          @D66ODOW 04277000
         BO    SVC39NEX           YES, SKIP                    @D66ODOW 04278000
         L     R4,IJBCLIM         GET ADDRESS OF LIMITS TABLE  @D66ODOW 04279000
         CLC   CDEFSTPP-CLIM(2,R4),PCB#SUBT MORE THAN 31 S-TASK@D66ODOW 04280000
         BL    SVC39NEX           YES, SKIP UPDATE TID-STRING  @D66ODOW 04281000
         LH    R4,TIBRTID         GET TASK'S TASK ID           @D61RDIS 04282000
         SLR   R2,R2              CLEAR REGISTER FOR INSERT    @D61RDIS 04283000
SVC39NEL DS    0H                                              @D61RDIS 04284000
         LR    RF,R2              SAVE TID BEFORE INSERT       @D61RDIS 04285000
         IC    R2,TIDSTR-TIDSTR(,R1) REPLACE TID               @D61RDIS 04286000
         STC   RF,TIDSTR-TIDSTR(,R1) BY PREVIOUS ONE           @D61RDIS 04287000
         BCTR  R1,R0              POINT TO NEXT TASK ID        @D61RDIS 04288000
         CR    R4,R2              IS IT CURRENT TASK'S ID ?    @D61RDIS 04289000
         BNE   SVC39NEL           NO, PROCESS NEXT ENTRY       @D61RDIS 04290000
SVC39NEX DS    0H                                              @D66ODOW 04291000
         EJECT ,                                               @D61RDIS 04292000
         L     RF,PCBIMASK                                     @D66ODOW 04293000
         X     RF,TIBIMASK        MAKE TASK NUMBER FREE        @D66ODOW 04294000
         ST    RF,PCBIMASK                                     @D66ODOW 04295000
*        DISPMAC FUNC=DETACH,INP1=R5,INP2=R8                   @D61RDIS 04296000
         DISPMAC FUNC=DETACH,INP1=R5,INP2=R8                   @D61RDIS 04297000
         B     SVC39EXI           RETURN TO DISPATCHER         @D64ADIS 04298000
         DROP  R5                                              @D64ADIS 04299000
         DROP  R8                                              @D64ADIS 04300000
         DROP  RD                                              @D61RDIS 04301000
         EJECT ,                                               @D61RDIS 04302000
         SPACE 2                                               @D61RDIS 04303000
*********************************************************************** 04304000
*                                                              @D33PADO 04305000
* SVC78:   CHAP ROUTINE                                        @D33PADO 04306000
*                                                              @D33PADO 04307000
*        AMODE = ANY, RMODE = ANY                                       04308000
*********************************************************************** 04309000
         SPACE 2                                               @D33PADO 04310000
         USING DISP,R6                                         @D61RDIS 04311000
         USING TIBADR,R8                                       @D61RDIS 04312000
         USING SVC78,RC                                        @D61RDIS 04313000
SVC78    DS    0H                 SVC FROM MAIN TASK           @D51IDIS 04314000
         CLC   TID(2),IJBHMTID    SVC FROM MAINTASK            @D51IDIS 04315000
         BNHR  R6                 BRANCH IF YES                @D36IDFR 04316000
*        DISPMAC FUNC=CHAP                                     @D61RDIS 04317000
         DISPMAC FUNC=CHAP                                     @D61RDIS 04318000
         BR    R6                 RETURN TO DISPATCHER         @D61RDIS 04319000
         DROP  R6                                              @D61RDIS 04320000
         DROP  R8                                              @D61RDIS 04321000
         DROP  RC                                              @D61RDIS 04322000
         EJECT ,                                               @D51IDIS 04323000
         SPACE 2                                               @D35EDFR 04324000
***************************************************************         04325000
*        SUBTASK FIELDS AND WORK AREAS                                  04326000
*--------------------------------------------------------------         04327000
*        QUEUE OF ATTACHED/DETACHED SUBTASKS AND RELATED FIELDS         04328000
***************************************************************         04329000
         SPACE 1                                               @D35EDFR 04330000
SPTIB    CRSPID  NAME=IPTIB       NAME OF GETVIS SUBPOOL       @D51IDIS 04331000
SPSAV    CRSPID  NAME=IPSAV       NAME OF GETVIS SUBPOOL       @D52IDIS 04332000
AFREETIB DC    A(0)               ANCHOR TO FREE TIB CHAIN     @D66ODOW 04333000
AFRESLOT DC    A(0)               FIRST FREE SLOT FOR SUBTASK  @D66ODOW 04334000
***                               .... IN TIBATAB                       04335000
SVC38PAR DC    X'00'                    DUMMY PARAMETER        @D14BDFR 04336000
SUBTNAME DC    X'E3C1E2D240212020'      MASK FOR SUBTASK NAME  @D14BDFR 04337000
ASVC78   DC    A(SVC78)          ADDRESS OF CHAP ROUTINE       @D61RDIS 04338000
 TITLE 'VSE SUPERVISOR   SGAP                       WAIT/POST ROUTINES' 04339000
         USING DISP,R6                                         @D52VDIS 04340000
         USING TIBADR,R8                                       @D52VDIS 04341000
         USING TCBADR,RA                                       @D52VDIS 04342000
         USING SVEARA,RB                                       @D52VDIS 04343000
*********************************************************************** 04344000
*                                                                     * 04345000
* SVC 7: WAIT FOR CCB,ECB,TECB,XECB TO BE POSTED                      * 04346000
*                                                                     * 04347000
*        AMODE = ANY, RMODE = ANY                                       04348000
*********************************************************************** 04349000
         SPACE 2                                               @D35EDFR 04350000
         USING CCBADR,R1          USE CCB POINTER              @D34RDFG 04351000
         USING SVC07,RD                                        @D14BDFR 04352000
SVC07    MVI   RID+1,RESVCID      REISSUE SVC AFTER PAGE FAULT @D36BDFR 04353000
         L     R5,TCBEXFLG        GET ADDRESSING MODE OF CALLER@D52VDIS 04354000
*        AMODESW SET,AMODE=(5),WR=(15)                         @D52VDIS 04355000
         AMODESW SET,AMODE=(5),WR=(15)                         @D52VDIS 04356000
SVC07NX  DS    0H                                              @D52VDIS 04357000
         TM    CCBCOM1,TRABIT     I/O ALREADY COMPLETED        @D36IDFR 04358000
PCKSVC07 EQU   *                  PROGRAMCHECK MAY OCCUR AT THIS ADDR.  04359000
         BOR   R6                 YES,EXIT TO DISPATCHER       @D52VDIS 04360000
         LA    R1,0(,R1)          RESET HIGH ORDER BYTE / BIT  @D52VDIS 04361000
         ST    R1,TIBSTATE        STORE CCB/ECB/TECB POINTER   @D36IDFR 04362000
         DROP  R1                 RELEASE CCB POINTER          @D34RDFG 04363000
*        AMODESW SET,AMODE=24,WR=(15)                          @D52VDIS 04364000
         AMODESW SET,AMODE=24,WR=(15)                          @D52VDIS 04365000
         L     R1,SVEPSW2         UPDATE TASKS PSW             @D36IDFR 04366000
         SH    R1,INTINFO            TO                        @D36IDFR 04367000
         S     R1,F8                 REISSUE                   @D36IDFR 04368000
         ST    R1,SVEPSW2            SVC                       @D36IDFR 04369000
SETIOBND DS    0H                                              @D61RDIS 04370000
         TM    TIBFLAG,TIBDELMV   DISPATCHER EXITS PENDING ?   @KXA1724 04371000
         BZ    SETIOBN1           NO, WAIT TO BE POSTED        @KXA1724 04372000
         TM    TIBDMFLG,TIBCMVEX+TIBSFLEX+TIBXPCEX             @KXA1724 04373000
         BNZR  R6                 YES, PROCESS EXITS FIRST     @KXA1724 04374000
SETIOBN1 DS    0H                                              @KXA1724 04375000
         CLI   TIBRQID,CONDRDY                                 @KXA1724 04376000
         BE    POSTFRST                                        @D14BDFR 04377000
SVC07RET MVI   TIBRQID,WAITBND    SET TASK TO WAIT-BOUND       @D14BDFR 04378000
         LR    RE,R8              GET TIB ADDRESS              @D52VDIS 04379000
         LR    RF,R6              GET RETURN FROM UNPOSTPT     @D52VDIS 04380000
         B     UNPOSTPT           UNPOST TASK                  @D52VDIS 04381000
*SGLINK UNPOSTPT,INPUT=(R6,RE,RF),WORK=(R5,RE)                          04382000
         EJECT ,                                               @D52VDIS 04383000
*--------------------------------------------------------------         04384000
* POSTFRST - POST ANY WAITERS FOR RESOURCE DEFINED IN TIBCHAIN          04385000
*--------------------------------------------------------------         04386000
POSTFRST L     R5,TIBCHAIN                                     @D14BDFR 04387000
         USING RQADR,R5                                        @D14BDFR 04388000
         TM    RSCDESC,FREEBIT                                 @D66ODOW 04389000
         BNO   SVC07RET                                        @D66ODOW 04390000
         CLI   RQCHAIN,TIBAVAIL                                @D14BDFR 04391000
         BNE   SVC07RET                                        @D14BDFR 04392000
         LA    RF,SVC07RET                                     @D14BDFR 04393000
         B     RPOST2                                          @D14BDFR 04394000
         DROP  RD                                              @D14BDFR 04395000
         DROP  R5                                              @D14BDFR 04396000
         EJECT                                                          04397000
*********************************************************************** 04398000
*                                                                     * 04399000
* SVC29 OR WAITM ROUTINE                                              * 04400000
*                                                                     * 04401000
*********************************************************************** 04402000
*                                                                     * 04403000
*      FUNCTION: SCAN ECB ADDRESS LIST, IF POSTED ECB FOUND           * 04404000
*                STORE ADDRESS OF POSTED ECB IN USERS R1 AND          * 04405000
*                RETURN TO USER.  IF POSTED ECB NOT FOUND,            * 04406000
*                MAKE TASK I/O BOUND AND RETURN TO TASK SELECTION     * 04407000
*                                                                     * 04408000
*        AMODE = ANY, RMODE = ANY                                     * 04409000
*********************************************************************** 04410000
         SPACE 2                                               @D35EDFR 04411000
         USING SVC29,RD                                        @D14BDFR 04412000
SVC29    MVI   RID+1,RESVCID      IDENT. ROUTINE  TO RE-SVC    @DM11597 04413000
         ICM   R5,15,TCBEXFLG     GET ADDRESSING MODE          @D52VDIS 04414000
         BM    SVC29AY            CALLER IN 31 BIT MODE ===>>  @D52VDIS 04415000
PDECBT   CLI   0(R1),LISTEND      END OF LIST?                 @D369DFR 04416000
PCKSV29A EQU   *                  PROGR.CHECK MAY OCCUR HERE   @D369DFR 04417000
         BNE   PDECBW             YES, NO ECB HAS BEEN POSTED  @D369DFR 04418000
         L     R3,0(,R1)          GET ECB ADDRESS              @D369DFR 04419000
PCKSV29E EQU   *                  PROGR.CHECK MAY OCCUR HERE   @KD40187 04420000
         TM    2(R3),TRABIT       HAS ECB BEEN POSTED?         @D369DFR 04421000
PCKSV29B EQU   *                  PROGR.CHECK MAY OCCUR HERE   @D369DFR 04422000
         BO    PDECBP             YES, NOTIFY USER             @D369DFR 04423000
         LA    R1,4(,R1)          BUMP TO NEXT LIST ENTRY               04424000
         B     PDECBT             INVESTIGATE THIS ENTRY                04425000
         EJECT ,                                                        04426000
*--------------------------------------------------------------         04427000
* SVC29AY - LOOP THROUGH ECB LIST                                       04428000
*--------------------------------------------------------------         04429000
SVC29AY  DS    0H                                              @D52VDIS 04430000
*        AMODESW SET,AMODE=31,WR=(15)                          @D52VDIS 04431000
         AMODESW SET,AMODE=31,WR=(15)                          @D52VDIS 04432000
SVC29LP  DS    0H                                              @D52VDIS 04433000
         L     R3,0(,R1)          GET ECB ADDRESS              @D52VDIS 04434000
PCKSV29D EQU   *                  PROGR.CHECK MAY OCCUR HERE   @KD40187 04435000
         TM    2(R3),TRABIT       HAS ECB BEEN POSTED?         @D52VDIS 04436000
PCKSV29C EQU   *                  PROGR.CHECK MAY OCCUR HERE   @D52VDIS 04437000
         BO    SVC29RT            YES, NOTIFY USER             @D52VDIS 04438000
         TM    0(R1),X'80'        END OF LIST?                 @D52VDIS 04439000
         LA    R1,4(,R1)          BUMP TO NEXT LIST ENTRY      @D52VDIS 04440000
         BZ    SVC29LP            NO, CHECK NEXT ENTRY         @D52VDIS 04441000
*--------------------------------------------------------------         04442000
*          - RETURN TO 24 BIT MODE                                      04443000
*--------------------------------------------------------------         04444000
*        AMODESW SET,AMODE=24,WR=(15)                          @D52VDIS 04445000
         AMODESW SET,AMODE=24,WR=(15)                          @D52VDIS 04446000
         EJECT ,                                               @D52VDIS 04447000
*--------------------------------------------------------------         04448000
* PDECBW  - IF NO ECB WAS POSTED,                                       04449000
*             SET USER BOUND                                            04450000
*         - RETURN TO TASK SELECTION                                    04451000
*--------------------------------------------------------------         04452000
PDECBW   DS    0H                                              @D36IDFG 04453000
         SLR   R1,R1              INDICATE UNCONDITIONAL       @D36IDFR 04454000
         ST    R1,TIBSTATE             POSTING REQUIRED        @D36IDFR 04455000
         OI    TIBFLAG,RETRYSVC   SETUP DISPATCHER TO RETRY SVC@D36IDFR 04456000
         L     RD,ASVC07                                       @D14BDFR 04457000
         USING SVC07,RD                                        @D14BDFR 04458000
         B     SETIOBND           SET TASK TO WAIT BOUND       @D14BDFR 04459000
         SPACE 1                                                        04460000
ASVC07   DC    A(SVC07)                                        @D14BDFR 04461000
         SPACE 2                                                        04462000
         USING SVC29,RD                                        @D14BDFR 04463000
*--------------------------------------------------------------         04464000
* SVC29RT  - RETURN TO 24 BIT MODE                                      04465000
*--------------------------------------------------------------         04466000
SVC29RT  DS    0H                                              @D52VDIS 04467000
*        AMODESW SET,AMODE=24,WR=(15)                          @D52VDIS 04468000
         AMODESW SET,AMODE=24,WR=(15)                          @D52VDIS 04469000
*--------------------------------------------------------------         04470000
* PDECBP  - A POSTED ECB HAS BEEN FOUND.                                04471000
*           STORE ECB ADDRESS IN USER'S R1, RETURN TO DISP              04472000
*--------------------------------------------------------------         04473000
PDECBP   ST    R3,SVER01          STORE ECB ADDRES IN USERS R1          04474000
         BR    R6                 RETURN TO USER VIA DISP      @D14BDFR 04475000
         DROP  RD                                              @D14BDFR 04476000
         EJECT                                                          04477000
*********************************************************************** 04478000
*                                                                     * 04479000
* SVC40 OR POST ROUTINE                                               * 04480000
*                                                                     * 04481000
*********************************************************************** 04482000
*                                                                     * 04483000
*     FUNCTION      :    POST THE ECB WHOSE ADDRESS IS IN R1          * 04484000
*                        IF SAVE PARAMETER NOT SPECIFIED :            * 04485000
*                         GET ALL TASKS WAITING FOR THAT ECB OUT OF THE 04486000
*                         WAIT STATE                                  * 04487000
*                        IF SAVE PARAMETER SPECIFIED     :            * 04488000
*                         FIND TASK WHOSE SAVEAREA ADDRESS IS GIVEN   * 04489000
*                         BY PARAMETER AND GET IT OUT OF WAIT STATE   * 04490000
*     INPUT REGISTER:                                                 * 04491000
*     R0 SAVE AREA ADDRESS IF SAVE PARAMETER SPECIFIED,OTHERWISE 0      04492000
*     R1 ECB ADDRESS                                                    04493000
*                                                                     * 04494000
*        AMODE = ANY, RMODE = ANY                                     * 04495000
*********************************************************************** 04496000
         SPACE 2                                                        04497000
         USING SVC40,RD                                        @D14BDFR 04498000
SVC40    DS    0H                                              @D52VDIS 04499000
         L     R5,TCBEXFLG        GET ADDRESSING MODE OF CALLER@D52VDIS 04500000
*        AMODESW SET,AMODE=(5),WR=(15)                         @D52VDIS 04501000
         AMODESW SET,AMODE=(5),WR=(15)                         @D52VDIS 04502000
         LA    R1,0(,R1)                                       @D52VDIS 04503000
         LA    R2,3(,R1)          LOAD LAST BYTE OF ECB        @D32DUHK 04504000
         BAL   R8,VALID           VALIDATE THE ECB ADDRESS     @DM14275 04505000
*SGLINK  VALID,INPUT=(R1,R2,R6,R8),WORK=(R2),OUTPUT=(R5)                04506000
         EJECT ,                                               @D52VDIS 04507000
*--------------------------------------------------------------         04508000
* SVC40B  - POST ECB AND DO SPECIAL PROCESSING FOR VTAM APPLICATIONS    04509000
*--------------------------------------------------------------         04510000
SVC40B   OI    2(R1),TRABIT       POST THE ECB                 @D36IDFR 04511000
*        AMODESW SET,AMODE=24,WR=(15)                          @D52VDIS 04512000
         AMODESW SET,AMODE=24,WR=(15)                          @D52VDIS 04513000
         L     R8,TIBPTR          POINT TO TIB                 @D36IDFR 04514000
         TM    TIBFLAG2-TIBADR(R8),VTOPEN IS IT VTAM USER      @D14BDFR 04515000
         BZ    NOVTPOWR           NO,DO NOT TEST FOR POWER     @D36IDFR 04516000
         L     R8,PCBPTR          POINT TO PCB                 @D36IDFR 04517000
         TM    PCBSSFLG-PCBADR(R8),PWR IS IT POWER PARTITION   @D36IDFR 04518000
         BZ    NOVTPOWR           NO,DO NOT POST MAIN ECB      @D36IDFR 04519000
         L     R8,APOWTB          POINT TO POWER TABLE         @D36IDFR 04520000
         OI    PAEB+2-PADS(R8),TRABIT POST POWER MAIN ECB      @D36IDFR 04521000
         L     R8,PIBPTR2         POINT TO PIB2                @D51IDIS 04522000
         LH    R8,PIBMTID-PIB2ADR(,R8) GET ID OF POWER MAINTASK@D51IDIS 04523000
         BAL   RF,IOPOST0         POST MAINTASK FROM IO-BOUND  @D36IDFR 04524000
*SGLINK  IOPOST0,INPUT=(R6,R8,RF),WORK=(R8,RE)                          04525000
NOVTPOWR DS    0H                                              @D36IDFR 04526000
         LTR   RB,R0              WAS SAVE PARAMETER SPECIFIED @DF01199 04527000
         BNE   YESSAVE            YES, POST ONLY ONE TASK               04528000
         L     R5,ASRQTAB         GET ADDRESS OF SRQTAB        @D61MPIS 04529000
         LA    R5,SRQWAIT-SRQTAB(,R5) POINTER TO WAIT QUEUE    @D61MPIS 04530000
         LR    RF,R6              SETUP RETURN ADDRESS         @D36IDFR 04531000
         B     RPOST              POST TASKS WAITING FOR ECB   @D36IDFG 04532000
*SGLINK  RPOST,INPUT=(R5,R6,RF),WORK=(R5,RE)                            04533000
         EJECT ,                                               @D52VDIS 04534000
*--------------------------------------------------------------         04535000
* YESSAVE  - SAVE PARAMETER WAS SPECIFIED                               04536000
*--------------------------------------------------------------         04537000
YESSAVE  DS    0H                                              @D36IDFR 04538000
         LA    RB,0(,RB)          RESET FIRST BYTE OF INPUT REG@D36IDFR 04539000
         LA    R2,2               SET REPEAT CNT FOR MAINTSK   @DA23269 04540000
         LH    R8,SVETID          LOAD SUBTASKS ID FROM SAVEAR.@D14BDFR 04541000
PCKSVC40 EQU   *                  PROGR.CHECK ADDRESS          @DA23269 04542000
         L     R9,IJBCLIM                                      @D66ODOW 04543000
         CH    R8,CSTASK-CLIM(,R9) HIGHER THAN MAX SUB TASK    @D66ODOW 04544000
         BH    MAINTST              YES , HANDLE AS MAINTASK   @DA23269 04545000
         CH    R8,IJBHMTID        LOWER THAN SUBTASK           @D51IDIS 04546000
         BNH   MAINTST              YES , HANDLE AS MAINTASK   @DA23269 04547000
YESSAVMT SLL   R8,2               TID * 4                      @D66ODOW 04548000
         AL    R8,ATIBATAB        ADDR OF TIB POINTER          @D66ODOW 04549000
         ICM   R8,15,0(R8)        TASK ATTACHED                @D66ODOW 04550000
         BZ    MAINTST            NO, GOTO TEST MAINTASK       @D14BDFR 04551000
         L     RA,TIBTCB          LOAD TCB POINTER FROM TIB    @D36IDFR 04552000
         C     RB,TCBSAVE         IS IT THE RIGHT SAVEAREA     @D36IDFR 04553000
         BE    YESSAVOK           YES,GOTO COMPARE PIK         @DA23269 04554000
         TM    TIBFLAG1,LTAACT    IS TASK ACTIVE IN THE LTA    @D36IDFR 04555000
         BZ    TSTTRM             NO, GO TEST TERMINATOR ACTIVE@DA25342 04556000
         L     RA,ASYSPCB         POINT TO AR PCB              @D51IDIS 04557000
         L     RA,PCEPIB-PCBADR(,RA) POINT TO AR PIB           @D51IDIS 04558000
         C     RB,PIBSAV2N-PIBADR(,RA)  IDENT.BY ITS SAVE PAR. @D51IDIS 04559000
         BE    YESSAVOK           YES , CONTINUE               @DA23269 04560000
TSTTRM   TM    TIBFLAG1,TERMACT   IS TASK ACTIVE IN TERMINATOR @DA25342 04561000
         BZ    MAINTST            NO, GO TEST MAINTASK         @DA25342 04562000
         L     RA,TIBPCB          GET PCB ADDRESS              @D52VDIS 04563000
         L     RA,PCBSAAPT-PCBADR(,RA) GET SAACOMM ADDRESS     @D52VDIS 04564000
         C     RB,SAAPPSPT-SAACOMM(,RA)  IS IT RIGHT SAVEAREA  @D52VDIS 04565000
         BE    YESSAVOK           YES,GOTO POST TASK           @DA25342 04566000
MAINTST  L     R9,PIBPTR2         LOAD CURRENT PIB2            @D51IDIS 04567000
         USING PIB2ADR,R9                                      @D51IDIS 04568000
         LH    R8,PIBMTID         LOAD MAINTASK ID             @DA23269 04569000
         DROP  R9                                              @DA23269 04570000
         BCT   R2,YESSAVMT        GO REPEAT ROUTINE            @DA23269 04571000
         B     ERR21                                           @DA23269 04572000
         EJECT ,                                               @D52VDIS 04573000
*--------------------------------------------------------------         04574000
* YESSAVOK - POST TASK, IF REQUIRED                                     04575000
*--------------------------------------------------------------         04576000
YESSAVOK CLC   TIBRPIK(2),PIK     DOES IT BELONG TO SAME PART. @D36IDFR 04577000
         BNE   ERR21              NO, CANCEL                   @D36IDFR 04578000
         CLI   TIBRQID,WAITBND    IS TASK WAIT BOUND           @D14BDFR 04579000
         BNER  R6                 NO, CANNOT WAIT FOR THIS ECB @D14BDFR 04580000
         L     RF,TIBSTATE        LOAD BOUND INFORMATION       @D36IDFR 04581000
         LTR   RF,RF              IS IT AN ECB POINTER         @D36IDFR 04582000
         BZ    YESSAVPT           NO ,GOTO READY TASK          @D36IDFR 04583000
         CR    R1,RF              WAITING FOR SPECIFIED ECB    @D36IDFR 04584000
         BNER  R6                 NO, DO NOT READY TASK        @D14BDFR 04585000
YESSAVPT DS    0H                                              @D52VDIS 04586000
         LR    RE,R8              GET TIB ADDRESS              @D52VDIS 04587000
         LR    RF,R6              SET RETURN FROM RPOSTPST     @D52VDIS 04588000
         B     RPOSTPST           POST TASK / PARTITION        @D52VDIS 04589000
*SGLINK RPOSTPST,INPUT=(R6,RE,RF),WORK=(R5,RE)                          04590000
         DROP  R6                                              @D61HDIS 04591000
         DROP  R8                                              @D36ZDFR 04592000
         DROP  RA                                              @D36ZDFR 04593000
         DROP  RB                                              @D36ZDFR 04594000
         DROP  RD                 BASE ADDRESS OF ENQ/DEQ ROUT.         04595000
         AIF   (NOT &SGAP).NPRT020                             @D61NDIS 04596000
         PRINT NOGEN                                           @D37ZDFG 04597000
.NPRT020 ANOP                                                  @D37ZDFG 04598000
         MEND                                                           04599000
