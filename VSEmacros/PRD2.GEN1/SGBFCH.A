         MACRO                                                          00001007
         SGBFCH                                                         00002007
         GBLB  &BGFSTAT                                                 00003007
         GBLB  &BGDSHR                                         @D36SDVB 00004007
         GBLB  &SGBFCH                                         @D37ZDVB 00005007
         ACTR  2000                                            @D14CDHD 00006007
         AIF   (NOT &SGBFCH).NOPRINT                           @D61NDVB 00007007
         PRINT GEN                                             @D37ZDVB 00008007
.NOPRINT ANOP                                                  @D37ZDVB 00009007
*--------------------------------------------------------------@D35NDVB 00010007
*                                                              @D35NDVB 00011007
.*       IBM DISK OPERATING SYSTEM                             @D35NDVB 00012007
*        SUPERVISOR - SGBFCH - 5686-066                        @D61NDMZ 00013007
.*                                                             @D35NDVB 00014007
*        LICENSED MATERIALS - PROPERTY OF IBM                  @D35NDVB 00015007
*        THIS MACRO IS "RESTRICTED MATERIALS OF IBM"           @D31UDMZ 00016007
*        5686-066 (C) COPYRIGHT IBM CORP. 1977, 1995           @D61DDMZ 00017007
*        SEE COPYRIGHT INSTRUCTIONS                            @D31UDMZ 00018007
*                                                              @D35NDVB 00019007
*--------------------------------------------------------------@D35NDVB 00020007
 TITLE 'DOS SUPERVISOR     SGBFCH    PROGRAM_FETCH            ** 03/28/*00021007
               00 **'                                          @DY45348 00022007
         SPACE 2                                                        00023007
.* /* START OF SPECIFICATIONS ***************************************** 00024007
.*                                                                      00025007
.*01* MODULE NAME = SGBFCH                                              00026007
.*                                                                      00027007
.*01* MODULE TYPE = SUPERVISOR GENERATION MACRO                         00028007
.*                                                                      00029007
.*01* DESCRIPTIVE NAME = PHASE FETCH AND I/O ROUTINES FOR PROGRAM FETCH 00030007
.*                                                                      00031007
.*01* CHANGE ACTIVITY = AS FOLLOWS                                      00032007
.*            NEW MODULE -- FIRST RELEASE 35                            00033007
.*              E SUPPORT                                      @D35EDVB 00034007
.*              E SUPPORT                                      @D35EDJB 00035007
.*              FBM SUPPORT                                    @D35DDVB 00036007
.*              FBM SUPPORT                                    @D35DDJB 00037007
.*              370 SUPPORT                                    @D35CDVB 00038007
.*              VMLE SUPPORT                                   @D35NDVB 00039007
.*            AF REL 1.2 :                                     @D369DVB 00040007
.*              DASD SHARING SUPPORT                           @D36SDVB 00041007
.*              MORE TASKS                                     @D36IDVB 00042007
.*              CONCATENATED LIBRARIES                         @D36JDVB 00043007
.*            AF REL 1.3 :                                     @D37CDVB 00044007
.*              IPCS HOOKS                                     @D37CDVB 00045007
.*              EXEC SIZE=PHASENAME                            @D37CDVB 00046007
.*            AF REL 1.4 :                                     @D14ZDVB 00047007
.*              SECURITY HOOKS                                 @D14BDVB 00048007
.*              NEW LIBRARIAN                                  @D14CDVB 00049007
.*            MULTIPLE VIRTUAL MEMORIES                        @DMVMPFG 00050007
.*            AF REL 2.1.1:                                    @DA33314 00051007
.*              4K PAGE SIZE FOR /370 AND VM MODE              @DA33314 00052007
.*              2.1.3.                                         @D21ZDVB 00053007
.*            INCORRECT SECTOR CALCULATION WHEN CYL.# OVER 255 @DA34985 00054007
.*  MSG0P77I AFTER LTA LOAD REQ FOR NON-$$B PHASE WITH SEC=YES @DA35100 00055007
.*  FBA DEF EXTENT DATA END ADDRESS ONE BLOCK TO HIGH.         @DA34905 00056007
.*  PHASE LOADPOINT VALIDATION FOR SDAID AREA                  @DA35849 00057007
.*  64K RLD INTEGRATED                                         @DA35913 00058007
.*  HIPROG CAN BE SET INCORRECTLY WITH MULTIPHASE FETCH        @DA36525 00059007
.*  TEST WHETHER LIBRARY BLOCK IS IN SPACE RECLAMATION CHAIN   @DA36475 00060007
.*  TO AVOID THAT DELETED PHASES WILL BE FOUND OR INSERTED     @DA36475 00061007
.*  PHASES WILL NOT BE FOUND                                   @DA36475 00062007
.*  SOFTWARE RE-IPL                                            @D31QDHB 00063007
.*  AF 5.1.0 RSE (NEW STORAGE LAYOUT)                          @D51GDMZ 00064007
.*  AF 5.1.0 MORE PARTITION SUPPORT AND CHANGED LIBR CONTR. BL.@D51IDMZ 00065007
.*  AF 5.1.0 LOAD PHASES IN PFIX'D AREA OF SVA                 @D51KDMZ 00066007
.*  AF 5.2.0 31 BIT SUPPORT                                    @D52VDMZ 00067007
.*    PTMS FOR AF 5.2.0                                        @KX40110 00068007
.*  AF 6.1.0 SUPPORT                                           @D61DDMZ 00069007
.*  AF 6.4.0 SUPPORT FOR API - MVS PLATFORM                    @D64ADVB 00070007
.*  HW FFF, SINCE IJSYSRS LIB TABLE REUSED TOO SOON            @DY44738 00071007
.*  UPDATE PHASE LOAD LIST ALSO FOR LOAD REQUEST IN PART.GETVIS@DY45348 00071107
.*  MISSING PHASE NAME IN PHASE-NOT-FOUND MESSAGE              @DY45682 00071209
.* A000000-999999                                              @D35EDVB 00071309
.*** END OF SPECIFICATIONS *******************************************/ 00071409
         SPACE 2                                                        00071509
*---------------------------------------------------------------------* 00071609
*    THE FOLLOWING AREAS ARE RESERVED FOR THE DIRECTORY SEARCH @D379DVB 00071709
*    TASK AND THE PROGRAM FETCH TASK.                          @D379DVB 00071809
*    ... IDRA CONTAINS THE DIRECTORY BLOCK AND ITS LENGTH IS   @D149DVB 00071909
*        GENERATED EQUAL TO 'MAXLENLB' .                       @D149DVB 00072009
*        IN 370_MODE IT MUST BE START ON PAGE BOUNDARY         @D149DVB 00072109
*    ... FRLDBUF CONTAINS THE RLD BLOCKS                       @DA33314 00073007
*        ITS SIZE IS EQUAL TO 'MAXLENLB' .                     @DA33314 00074007
*        ADDITIONALLY IT IS USED AS GENERATION AREA FOR THE    @D379DVB 00075007
*        TXT_CCW CHAIN.                                        @D379DVB 00076007
*---------------------------------------------------------------------* 00077007
         SPACE 2                                                        00078007
         ORG   SYSS00+((*+MAXLENLB-1-SYSS00)/MAXLENLB)*MAXLENLB         00079007
         SPACE 1                                                        00080007
*-------------------------------------------------------------*@D14CDVB 00081007
         SPACE 1                                                        00082007
FDIRBUF  DS    0D                 BUFFER FOR DIRECTORY BLOCKS           00083007
FTPAGBEG EQU   *                                                        00084007
         ORG   FDIRBUF+MAXLENLB                                @D14CDVB 00085007
EFDIRBUF EQU   *                                                        00086007
         SPACE 1                                                        00087007
*-------------------------------------------------------------*@D14CDVB 00088007
         SPACE 1                                                        00089007
FCIFBUF  DS    0D                 BUFFER FOR LIB. CONTROL INFO @D14CDHD 00090007
         ORG   FCIFBUF+MAXLENLB                                @D14CDHD 00091007
*-------------------------------------------------------------*@D14CDVB 00092007
         SPACE 1                                                        00093007
FRLDBUF  DS    0D                                              @D36JDVB 00094007
         ORG   FRLDBUF+MAXLENLB                                @D14CDVB 00095007
ERLDBUF  EQU   *                                                        00096007
         SPACE 1                                                        00097007
*-------------------------------------------------------------*@D14CDVB 00098007
         SPACE 1                                                        00099007
FSTCCW   DS    0D                 GENERATION AREA FOR TXT CCWS         *00100007
                                  USED BY PROGRAM FETCH                 00101007
         DS    1024X                                           @D64ADVB 00102007
         ORG   *-8                                             @D14CDVB 00103007
EIDALBF1 DS    D                                               @D14CDVB 00104007
ENDBUF1  EQU   *                                               @D14CDVB 00105007
         SPACE 1                                               @D14CDVB 00106007
*-------------------------------------------------------------*@D14CDVB 00107007
*      NLIB INTERFACE TABLES                                  *@D14CDVB 00108007
*      --> ARE USED AS ADDITIONAL GENERATION AREA              @D14CDVB 00109007
*          AFTER INITIALISATION OF LIBRARIAN CONTROL TABLES    @D14CDVB 00110007
*-------------------------------------------------------------*@D14CDVB 00111007
         SPACE 1                                               @D14CDVB 00112007
         DS    0F                                              @D14CDVB 00113007
SYSTAB   DC    C'IJSYSRS '         LIBRARY_DEF_TAB             @D14CDVB 00114007
         DC    XL(LDTELEN-L'LDTEFNME)'0'                       @D14CDVB 00115007
         ORG   SYSTAB+LDTESDTX-INLCLDTE                        @D14CDVB 00116007
         DC    A(SYSLIB)                                       @D14CDVB 00117007
         DC    A(SEXTTAB)                                      @D14CDVB 00118007
         SPACE 1                                               @D14CDVB 00119007
         DS    0F                                              @D14CDVB 00120007
SYSLIB   DC    CL8'SYSLIB'         SUBLIBRARY_DEF_TAB          @D14CDVB 00121007
         DC    XL(SDTELEN-8)'0'                                @D14CDVB 00122007
         SPACE 1                                               @D14CDVB 00123007
         DS    0F                                              @D14CDVB 00124007
SEXTTAB  DC    XL(EDTELEN)'0'      EXTTAB(SYSLIB)              @D14CDVB 00125007
         ORG   SEXTTAB+EDTEHIDA-INLCEDTE                       @D14CDVB 00126007
         DC    XL4'00FFFFFFFF'                                 @D14CDVB 00127007
         ORG   SEXTTAB+EDTEDDTX-INLCEDTE                       @D14CDVB 00128007
         DC    A(SDEVTAB)                                      @D14CDVB 00129007
         DC    A(0)                                            @D14CDVB 00130007
         SPACE 1                                               @D14CDVB 00131007
NLIBLBPT DS    0H                  LIBRARY_PTR_TAB             @D14CDVB 00132007
         DS    0F                                              @D14CDVB 00133007
SDEVTAB  DC    XL(DDTELEN)'0'      DEVTAB(SYSLIB)              @D14CDVB 00134007
         DC    XL(LPTBLDT-LPTHEADR-DDTELEN)'0'                 @D14CDVB 00135007
         DC    A(SYSTAB)                                       @D14CDVB 00136007
         DC    XL(LPTBSDT-LPTBLDT-L'LPTBLDT)'0'                @D14CDVB 00137007
         DC    A(SYSLIB)                                       @D14CDVB 00138007
         SPACE 1                                               @D14CDVB 00139007
*-------------------------------------------------------------*@D14CDVB 00140007
         SPACE 1                                               @D14CDVB 00141007
         ORG   *-8                                             @D14CDVB 00142007
EIDALBUF DS    D                                                        00143007
ENDBUF   EQU   *                                               @D14CDVB 00144007
         SPACE 1                                               @D14CDVB 00145007
*-------------------------------------------------------------*@D14CDVB 00146007
         EJECT                                                          00147007
*---------------------------------------------------------------------* 00148007
*        PROLOGUE:     FGETTXT                                          00149007
*        ROUTINE NAME: FGETTXT   ( PROGRAM FETCH )                      00150007
*        MACRO :       SGBFCH                                           00151007
*        FUNCTION:     READS REQUESTED PHASE INTO PARTITION OR @D149DVB 00152007
*                      PARTITION GETVIS AREA, OR INTO SVA, OR  @D149DVB 00153007
*                      INTO A-, B-, OR C-TRANSIENT AREA.       @D149DVB 00154007
*                      PROVIDES LOAD / ENTRY POINTS.           @D149DVB 00155007
*                      RELOCATES ADDRESS CONSTANTS.            @D149DVB 00156007
*        CALLER:       FETCH-BASE ( IN MACRO SGDFCH )                   00157007
*        OPERATION:                                                     00158007
*            RELOCATE LOAD- AND ENTRY- POINT                   @D149DVB 00159007
*            CALCULATE RELOCATION FACTOR                       @D149DVB 00160007
*            IF RELOC_FACTOR ¬= 0 & PHASE = RELOCATABLE        @D149DVB 00161007
*               THEN GET #(RLD_ITEMS)                          @D149DVB 00162007
*               ELSE #(RLD_S) := 0                             @D149DVB 00163007
*            ENDIF                                             @D149DVB 00164007
*            IF LOAD FROM LINK_VIO                             @D149DVB 00165007
*            THEN CALL VIOTXT                                  @D149DVB 00166007
*            ELSE DO                                           @D149DVB 00167007
*            IF LOAD INTO REAL STORAGE                         @D149DVB 00168007
*               THEN DFCBSW2 := REALMASK                       @D149DVB 00169007
*            ENDIF                                             @D149DVB 00170007
*            IF ¬ SYSTEM_TASK REQUEST                          @D149DVB 00171007
*               THEN CALL FPGVALID    / VALIDITION OF PHASE'S..@D149DVB 00172007
*            ENDIF                    / ...ADDRESS SPACE      /@D149DVB 00173007
*            CALL FPGMREAD (TXT)      / BUILD TXT_FRPL)       /@D149DVB 00174007
*            IF #(RLD_S) > 0                                   @D149DVB 00175007
*               THEN CALL FPGMREAD (RLD) / BUILD RLD_FRPL     /@D149DVB 00176007
*               CALL FPGMREAD (RLD)   / PREPARE READ FOR RLD  /@D149DVB 00177007
*            ENDIF                                             @D149DVB 00178007
*            IF STORAGE IS TO BE PFIXED                        @D51KDMZ 00179007
*               THEN CALL PMR TO PFIX PHASE AREA              /@D51KDMZ 00180007
*            ENDIF                                             @D51KDMZ 00181007
*            DO WHILE PHASE_NOT_PROCESSED                      @D149DVB 00182007
*               DETERMINE CONTIGUOUS PART OF PHASE             @D149DVB 00183007
*               IF DFCBSW2 = ¬REALMASK AND DFCBSW2 ¬= PFIXPND  @D51KDMZ 00184007
*                 THEN CALL PGMTAB    / BUILD TFIX_INTERF_TAB /@D149DVB 00185007
*                 DO UNTIL TFIX_TAB IS PROCESSED               @D149DVB 00186007
*                  CALCULATE PAGES COMPLETELY USED BE LOAD     @D149DVB 00187007
*                  CALL FREEPDS                                @D149DVB 00188007
*                  CALL TFIX                                   @D149DVB 00189007
*                 ENDIF                                        @D149DVB 00190007
*               ENDIF                                          @D149DVB 00191007
*               DETERMINE #(LOG_RECORDS),LEN(TXT(LAST_RECORD)),@D149DVB 00192007
*                         ADDR (INPUT AREA)                    @D149DVB 00193007
*               CALL FPGMREAD         / READ TXT_PART         /@D149DVB 00194007
*               IF #(RLD_ITEMS) > 0                            @D149DVB 00195007
*                  THEN CALL RELADDR  / RELOCATE ADDRESS_CONST/@D149DVB 00196007
*               ENDIF                                          @D149DVB 00197007
*               IF DFCBSW2 = ¬ REALMASK AND DFCBSW2 ¬= PFIXPND @D51KDMZ 00198007
*                  THEN CALL TFREE    / TFREE THE TFIXED AREA /@D149DVB 00199007
*               ENDIF                                          @D149DVB 00200007
*              ENDDO                                           @D149DVB 00201007
*            ENDDO                                             @D149DVB 00202007
*            ENDIF (LINKVIO)                                   @D149DVB 00203007
*            CLEAR PFIX INDICATION                             @D51KDMZ 00204007
*            RETURN;                                           @D149DVB 00205007
*        INPUT:        ---> REFERENCED DATA                             00206007
*        OUTPUT:       PHASE                                            00207007
*                      RELOCATION FACTOR                                00208007
*        CALLED ROUTINES:                                               00209007
*                      READ, RELLPT, RELADDR , VALID(EXTERNAL),         00210007
*                      TFIX (EXTERNAL), TFREE(EXTERNAL),                00211007
*                      FREEPDS (EXTERNAL),                     @D149DVB 00212007
*                      FPGMREAD, FPGVALID, FPGTAB              @D149DVB 00213007
*        RETURN:       NORMAL -- CALLER ( FETCH BASE )                  00214007
*        ERROR EXITS:  NONE                                    @D149DVB 00215007
*        REFERENCED DATA:                                               00216007
*                      LIB_DEF_TAB (READ,EXTERNAL)                      00217007
*                      FCHWORK (UPDATE)                                 00218007
*                      FCB (UPDATE)                                     00219007
*                      CHAIN (READ)                                     00220007
*                      COMREG, SYSCOM, TIB, TCB (READ,EXTERNAL)@D149DVB 00221007
*        AMODE         AMODE 31                                @D64ADMZ 00222007
*---------------------------------------------------------------------* 00223007
         SPACE 2                                               @D14CDVB 00224007
*SGLINK  FGETTXT,INPUT=(RA,RB,RD,RE)                           @D369DVB 00225007
         DS    0D                                              @D14CDVB 00226007
         DC    CL8'*SGBFCH*'                                   @D37ZDVB 00227007
         DC    CL8'DY45348 '         LAST APAR FIXED           @DY45348 00228007
         DC    CL8'FGETTXT '                                   @D14CDVB 00229007
         DC    CL8'03/28/00'          MM/DD/YY                 @DY45348 00230007
         EJECT                                                 @D14CDVB 00231007
*                                                              @D14CDHD 00232007
*  ESTABLISH BASE REG. AND ADDRESSABILITY TO TCB AND SGAFCH;   @D14CDHD 00233007
*  SWITCH TO SAVE AREA DGETTXT                                 @D14CDHD 00234007
*                                                              @D14CDHD 00235007
         SPACE 1                                                        00236007
FGETTXT  DS    0H                                                       00237007
         SLR   RF,RF               PROVIDE RETURN CODE         @D14CDVB 00238007
         STM   RE,RC,ORG14(RD)     STORE REGISTERS             @D14CDVB 00239007
         BALR  R9,0                EXECUTED IN AMODE 31, NO CC @D36IDVB 00240007
         USING *,R9                )             <- BASE       @D36IDVB 00241007
         USING DFCB,RB             )  ESTABLISH  <- DATA AREA  @D36IDVB 00242007
         USING TCBADR,RA           ADDRESSIBILTY <- TCB =10    @D36IDVB 00243007
         LA    R2,DGETTXT          LOCAL SAVE AREA                      00244007
         ST    RD,OPRESA(R2)       ) CHAIN SAVE AREA POINTERS  @D36JDVB 00245007
         LR    RD,R2               STANDARD SAVE AREA POINTER  @D36JDVB 00246007
         SPACE 1                                                        00247007
*                                                              @D14CDHD 00248007
*  PFWKRELF = RELOCATION FACTOR                                @D14CDHD 00249007
*  DFWKEPNT = RELOCATED ENTRY POINT                            @D14CDHD 00250007
*  DFWKLPNT = RELOCATED LOAD POINT                             @D14CDHD 00251007
*  PFWKLTXT =          "                                       @D14CDHD 00252007
*  PFWKETXT = @END OF PHASE ( ONE BYTE AFTER ! )               @D14CDHD 00253007
*  PFWKHTXT = @END OF PHASE (       "          )               @D14CDHD 00254007
*                                                              @D14CDHD 00255007
         SPACE 1                                                        00256007
         L     RF,DARELLPT         GET ENTRY POINT FOR RELLPT  @D367DVB 00257007
*SGLINK RELLPT,INPUT=(RA,RD,RE),OUTPUT=(R0,R1,R4),WORK=(R2,R3,R5,R6)    00258007
*        AMODESW CALL,REGS=(RE,RF) RELOCATE LP AND EP          @D64ADVB 00259007
         AMODESW CALL,REGS=(RE,RF) RELOCATE LP AND EP          @D64ADVB 00260007
         SPACE 1                                                        00261007
         SLR   R3,R3                                           @D365DVB 00262007
         TM    DFWKESWT,RELTYP     RELOCATABLE PHASE           @D14CDVB 00263007
         BZ    FPGM10              NO --->                              00264007
         AR    R4,R1               GET RELOCATION FACTOR                00265007
         BZ    FPGM10              ZERO (NO RLD PROCESSING)             00266007
         ICM   R3,3,DFWKERLD       GET NUMBER OF RLDS          @DA35913 00267007
*        LH    R3,DFWKERLD         GET NUMBER OF RLDS          @D14CDVB 00268007
FPGM10   STH   R3,PFWKPRLD         ... TO BE TO PROCESS        @D14CDVB 00269007
         ST    R4,PFWKRELF         STORE RELOCATION FACTOR     @D36JDVB 00270007
         L     R2,DFWKEPLN         PHASE LENGTH...             @D14CDVB 00271007
         ALR   R2,R1               ... + LOAD ADDRESS                  *00272007
                                   ... =: END ADDR (PHASE) +1  @D14CDVB 00273007
         ST    R0,DFWKEPNT         STORE EP AND                @D36JDVB 00274007
         ST    R1,DFWKLPNT           LP IN FCHWORK             @D36JDVB 00275007
         ST    R1,PFWKLTXT         PROVIDE LOAD_POINT ...      @D14CDVB 00276007
         ST    R2,PFWKETXT         ... END_ADDRESS ...         @D14CDVB 00277007
         ST    R2,PFWKHTXT         ... IN WORK FIELDS          @D14CDVB 00278007
         AIF   (NOT &BGFSTAT).FSTZZ1                           @D35ZDVB 00279007
         SPACE 1                                                        00280007
*                                                              @D14CDHD 00281007
*  IF &BGFSTAT=ON AND PHASE LENGTH > 64 K                      @D14CDHD 00282007
*     THEN  FGT64K = FGT64K+1                                  @D14CDHD 00283007
*                                                              @D14CDHD 00284007
         SPACE 1                                                        00285007
         LR    R4,R2                                                    00286007
         SLR   R4,R1               LENGTH OF PHASE             @D35ZDVB 00287007
         LA    RF,1                                            @D36ZDVB 00288007
         SLL   RF,16               64K CONSTANT                @D36ZDVB 00289007
         CLR   R4,RF                                           @D35ZDVB 00290007
         BNH   FPGM12                                          @D35ZDVB 00291007
         L     R4,FGT64K           )                           @D35ZDVB 00292007
         LA    R4,1(R4)            ) UPDATE COUNTER            @D35ZDVB 00293007
         ST    R4,FGT64K           )                           @D35ZDVB 00294007
FPGM12   EQU   *                                               @D35ZDVB 00295007
.FSTZZ1  ANOP                                                  @D35ZDVB 00296007
         SPACE 1                                                        00297007
*                                                              @D14CDHD 00298007
*  SETTING OF THE REALMASK FLAG                                @D14CDHD 00299007
*                                                              @D14CDHD 00300007
*      - STANDALONE ENVIRONMENT ->   DON'T SET IT              @D14CDHD 00301007
*      - VIO             -------->   DON'T SET IT              @D14CDHD 00302007
*      - TRANSIENT/SDAID LOAD --->   SET IT                    @D14CDHD 00303007
*      - REQ. IS IN VIRTUAL MODE  --->  DON'T SET IT           @D14CDHD 00304007
*      - IPL IN PROGRESS -------->   SET IT                    @D14CDHD 00305007
*      - SVA LOAD        -------->   DON'T SET IT              @D14CDHD 00306007
*                                                              @D14CDHD 00307007
         SPACE 1                                               @D14CDVB 00308007
         TM    IJBFLG08,IJBSAENV   SA ENVIRONMENT              @D61DDMZ 00309007
         BO    FPGM20              YES ->                      @D61DDMZ 00310007
         SPACE 1                                               @D14CDVB 00311007
         TM    DFCBSW2,FLNKVIO     VIO ON LINK_LIBRARY         @D14CDVB 00312007
         BO    FPGM20              YES --->                    @D14CDVB 00313007
         SPACE 1                                               @D14CDVB 00314007
         L     R5,IJBSMCOM         ADDRESS SMCOM               @D51GDMZ 00315007
         USING SMCOM,R5                                        @D51GDMZ 00316007
         CL    R2,SMCSSEND         TRANSIENT/SDAID LOAD        @D51GDMZ 00317007
         BL    FPGM15              YES -->                     @D52VDMZ 00318007
         L     R4,PIBPTR2          GET REQUESTOR'S PIB2 PTR    @D51IDMZ 00319007
         USING PIB2ADR,R4                                      @D51IDMZ 00320007
         L     R4,PIBPCB           REQUESTOR'S PCB POINTER     @D51IDMZ 00321007
         USING PCBADR,R4                                       @D51IDMZ 00322007
         L     R4,PCEPIB           REQUESTOR'S PIB POINTER     @D51IDMZ 00323007
         USING PIBADR,R4                                       @D51IDMZ 00324007
         TM    PIBDATFL,PIBTRAM    REQUESTED IN VIRTUAL MODE   @D51IDMZ 00325007
         BO    FPGM20              YES --->                    @D14CDVB 00326007
         DROP  R4                                              @D36IDVB 00327007
         TM    SYSFLAG2,IPLBIT     LOAD REQUEST DURING IPL              00328007
         BO    FPGM15              YES --->                             00329007
*                                                              @D51GDMZ 00330007
*  SVA LOAD IF :   SMCSVA   <= LOADPOINT <= SMCESVA            @D52VDMZ 00331007
*           OR :   SMCSVA31 <= LOADPOINT                       @D52VDMZ 00332007
*                                                              @D51GDMZ 00333007
         CL    R1,SMCSVA           LOAD IN SVA                 @D51GDMZ 00334007
         BL    FPGM15              NO, IN REAL PARTITION       @D51GDMZ 00335007
         CL    R1,SMCESVA          LOAD IN SVA 24 BIT          @D52VDMZ 00336007
         BNH   FPGM20              YES --->                    @D51GDMZ 00337007
         CL    R1,SMCSVA31         LOAD IN SVA 31 BIT          @D52VDMZ 00338007
         BNL   FPGM20              YES --->                    @D51GDMZ 00339007
         DROP  R5                                              @D51GDMZ 00340007
FPGM15   OI    DFCBSW2,REALMASK    LOAD INTO REAL PARTITION    @D64ADVB 00341007
         SPACE 1                                                        00342007
*                                                              @D14CDHD 00343007
*  IF NO SYSTEM REQUEST OR ATTENTION TASK                      @D14CDHD 00344007
*     THEN VALIDATE SPACE WHERE PHASE SHOULD BE LOADED         @D14CDHD 00345007
*                                                              @D14CDHD 00346007
         SPACE 1                                               @D14CDVB 00347007
FPGM20   TM    DFWKSWRQ,SYSAMASK   REQUEST BY SYSTEM           @D64ADVB 00348007
         BZ    FPGM21              NO,VALIDATION REQUIRED      @D61DDMZ 00349007
         TM    IJBFLG08,IJBSAENV   SYSTEM TASK IN SA ENV.      @D61DDMZ 00350007
         BZ    FPGM25              NO  -> LOAD PHASE           @D61DDMZ 00351007
         B     FPGMSA              YES -> MOVE PHASE           @D61DDMZ 00352007
FPGM21   DS    0H                                              @D61DDMZ 00353007
*SGLINK  FPGVALID,INPUT=(R1,R2,R7,R9,RA),WORK=(R2,R3,R4,R5,R6,R7,R8)    00354007
         BAL   LINK2,FPGVALID      VALIDATE ADDRESS RANGE ...          *00355007
                                   .... OF REQUESTED PHASE     @D14CDVB 00356007
         SPACE 1                                               @D14CDVB 00357007
* CHECK FOR MISMATCH BETWEEN LOADPOINT/END OF PHASE AND RMODE           00358007
         SPACE 1                                                        00359007
         TM    DFWKEMVS,SDLERMOD   PHASE HAS RMODE ANY         @D52VDMZ 00360007
         BO    FPGM23              YES, NO MISMATCH WITH LOADP.@D52VDMZ 00361007
         CL    R1,ADDRMSK          LOADPOINT > 16MB - 1        @KX40110 00362007
         BH    FPGM22              YES,MISMATCH                @D52VDMZ 00363007
         L     R3,DFWKEPLN         GET PHASE LENGTH            @D52VDMZ 00364007
         AR    R3,R1               CALCULATE END ADDRESS..     @D52VDMZ 00365007
         BCTR  R3,0                .. OF PHASE                 @D52VDMZ 00366007
         CL    R3,ADDRMSK          END ADDRESS <=16MB - 1      @KX40110 00367007
         BNH   FPGM23              YES, CONTINUE               @D61FDMZ 00368007
         SPACE 1                                               @D14CDVB 00369007
FPGM22   DS    0H                  CHECK IF MOVE MODE PHASE    @D61FDMZ 00370007
         TM    DFWKEMVS,SDLECLM    IS IT MOVE MODE PHASE       @D61FDMZ 00371007
         BZ    FRMODERR            NO, THEN IT'S MODE VIOLATION@D61FDMZ 00372007
         L     R3,IJBSMCOM         ADDRESS OF SMCOM            @D61FDMZ 00373007
         USING SMCOM,R3                                        @D61FDMZ 00374007
         CL    R1,SMCSVA31         LOAD IN SVA 31 BIT          @D61FDMZ 00375007
         BL    FRMODERR            NO, THEN IT'S MODE VIOLATION@D61FDMZ 00376007
         DROP  R3                  RELEASE SMCOM               @D61FDMZ 00377007
         SPACE 1                                                        00378007
FPGM23   DS    0H                                              @D52VDMZ 00379007
         TM    IJBFLG08,IJBSAENV   SA ENVIRONMENT              @D61DDMZ 00380007
         BZ    FPGM24              NO  -> ONLINE               @D61DDMZ 00381007
FPGMSA   DS    0H                                              @D52VDMZ 00382007
*-------------------------------------------------------------*         00383007
*     MOVE PHASE FROM SVA TO THE SPECFIED LOCATION            *@D61DDMZ 00384007
* I)   CALCULATE BEGIN OF PHASE IN SVA                        *@D61DDMZ 00385007
*      ENTRYPOINT IN SVA - (ENTRYPOINT-LOADPOINT)             *@D61DDMZ 00386007
* II)  MOVE PHASE TO SPECIFIED LOADPOINT                      *@D61DDMZ 00387007
*      NOTE, THAT THE RELOCATABLE ITEMS IN THE PHASE ARE      *@D61DDMZ 00388007
*      ALREADY RELOCATED.                                     *@D61DDMZ 00389007
*-------------------------------------------------------------*         00390007
         L     R3,DFWKEPNT         GET ENTRY POINT             @D61DDMZ 00391007
         S     R3,DFWKLPNT         R3 = DELTA EP-LP            @D61DDMZ 00392007
         L     R4,DFWKEVLE         ENTRY POINT IN SVA          @D61DDMZ 00393007
         SR    R4,R3               R4=BEGIN OF PHASE IN SVA    @D61DDMZ 00394007
         L     R2,DFWKLPNT         ACTUAL LOADPOINT            @D61DDMZ 00395007
         L     R3,DFWKEPLN         PHASE LENGTH                @D61DDMZ 00396007
         LR    R5,R3               PHASE LENGTH                @D61DDMZ 00397007
         MVCL  R2,R4               MOVE TEXT BYTES             @D61DDMZ 00398007
         B     FPGMEXIT            EXIT                        @D61DDMZ 00399007
         SPACE 1                                                        00400007
FPGM24   DS    0H                                              @D61NDMZ 00401007
         TM    DFCBSW2,FLNKVIO     VIO ON LINK_LIBRARY         @D14CDVB 00402007
         BZ    FPGMLIB             NO  --->                    @D14CDVB 00403007
*-------------------------------------------------------------*@D149DVB 00404007
*     HANDLE VIO READ  -->  RESULTS IN MVC AND RETURN         *@D149DVB 00405007
*-------------------------------------------------------------*@D149DVB 00406007
         SPACE 1                                               @D14CDVB 00407007
         CL    R1,DFWKELPL         SAME LOAD POINT             @D21ZDVB 00408007
         BNE   FVLDERR             NO --->    ERROR            @D21ZDVB 00409007
         L     R4,DFWKERBA         PROVIDE RELATIVE BYTE ADDRESS OF... *00410007
                                   ... VIO_LINK PHASE          @D14CDVB 00411007
         L     R3,DFWKASLB         ADDRESS (VIORB(LINK_DIR))   @D14CDVB 00412007
         LR    R5,R1               ADDRESS (LP (PHASE))        @D14CDVB 00413007
         L     R6,DFWKEPLN         LENGTH OF PHASE             @D14CDVB 00414007
         LA    RF,FPGM240                                               00415007
         LA    R2,FPGM241                                               00416007
         BSM   R2,RF               SAVE CURRENT MODE AND ..    @D64ADMZ 00417007
*                                  SWITCH TO AMODE 24 FOR VIO  @D64ADMZ 00418007
FPGM240  DS    0H                                              @D64ADMZ 00419007
*        VIO   MOVE,FROM=(3,4),TO=(5),LEN=(6)   GET TXT        @D14CDVB 00420007
         VIO   MOVE,FROM=(3,4),TO=(5),LEN=(6)                  @D14CDVB 00421007
         BSM   0,R2                SWITCH BACK TO ORIGINAL MODE@D64ADMZ 00422007
FPGM241  DS    0H                                              @D64ADMZ 00423007
         LTR   RF,RF               TEST COMPLETION CODE        @D14CDVB 00424007
         BZ    FPGMEXIT            SUCCESSFULL --->    EXIT    @D14CDVB 00425007
         B     FPGMLKER            =====>   ERROR_HANDLER      @D14CDVB 00426007
*-------------------------------------------------------------*@D149DVB 00427007
         SPACE 1                                                        00428007
*                                                              @D14CDHD 00429007
*  BUILD TXT FRPL                                              @D14CDHD 00430007
*                                                              @D14CDHD 00431007
         SPACE 1                                                        00432007
FPGMLIB  EQU   *                                               @D14CDVB 00433007
FPGM25   LA    R1,FBLDTXT          TXT ID                      @D14CDVB 00434007
*SGLINK  FPGMREAD,INPUT=(R1,R7,R9,RA,RB,RD),OUTPUT=(R1,RF),WORK=(RE)    00435007
         BAL   LINK2,FPGMREAD      REQUEST TXT RPL                      00436007
         SPACE 1                                                        00437007
*                                                              @D14CDHD 00438007
*  IF RELOCATION WILL BE DONE                                  @D14CDHD 00439007
*     THEN BUILD RLD FRPL AND READ FIRST RLD BLOCK             @D14CDHD 00440007
*                                                              @D14CDHD 00441007
         SPACE 1                                                        00442007
         CH    RF,PFWKPRLD         ANY RLD ITEMS AVAILABLE     @D36JDVB 00443007
         BE    FPGM26              NO --->                     @D51KDMZ 00444007
         LA    R1,FBLDRLD          RPL ID                      @D14CDVB 00445007
*SGLINK  FPGMREAD,INPUT=(R1,R7,R9,RA,RB,RD),OUTPUT=(R1,RF),WORK=(RE)    00446007
         BAL   LINK2,FPGMREAD      REQUEST RLD RPL                      00447007
         BAL   LINK2,FPGMREAD      READ FIRST RLD BLOCK                 00448007
         SPACE 1                                                        00449007
FPGM26   DS    0H                                              @D51KDMZ 00450007
         SPACE 1                                                        00451007
*      **************************************************      @D51KDMZ 00452007
*      * BEFORE READING THE FIRST CONTIGOUS PART, CHECK *      @D51KDMZ 00453007
*      * IF THE STORAGE FOR THE PHASE IS TO BE PFIX'D.  *      @D51KDMZ 00454007
*      * THE STORAGE IS ONLU PFIX'D IF:                 *      @D51KDMZ 00455007
*      *   DFWKFLAG.SVAUPD = ON (SVA UPDATE REQUESTED)  *      @D51KDMZ 00456007
*      *   DFWKESWT.SDLESVPF (PHASE CARD WITH PFIX REQ.)*      @D51KDMZ 00457007
*      **************************************************      @D51KDMZ 00458007
         SPACE 1                                                        00459007
         TM    DFWKFLAG,SVAUPD     IS SVA LOAD REQUESTED ?     @D51KDMZ 00460007
         BZ    FPGM30              NO => SKIP PFIXING          @D51KDMZ 00461007
         TM    DFWKESWT,SDLESVPF   IS PFIX REQ. FOR THIS PHASE?@D51KDMZ 00462007
         BZ    FPGM30              NO => SKIP PFIXING          @D51KDMZ 00463007
         SPACE 1                                                        00464007
*                                                              @D51KDMZ 00465007
*  INPUT FOR PFIX ROUTINE SVAFX2ND                             @D52VDMZ 00466007
*                                                              @D51KDMZ 00467007
*  R1 -> ----------------  A : FIRST BYTE OF AREA TO BE PFIX'D @D51KDMZ 00468007
*        | A | B | X'FF'|  B : LENGTH OF AREA - 1              @D51KDMZ 00469007
*        ----------------  X'FF' : END INDICATOR               @D51KDMZ 00470007
*  R3 = ADDR(SAVE AREA IN CURRENT TCB (TCB OF PRG FETCH TASK)  @D52VDMZ 00471007
*                                                              @D51KDMZ 00472007
*  IF THE LOADPOINT OF THE PHASE IS IN SVA 24 BIT, THE PFIX'D  @D52VDMZ 00473007
*  STORAGE IS REQUESTED IN THE 24 BIT AREA (RLOC=BELOW),       @D52VDMZ 00474007
*  OTHERWISE IT CAN BE LOCATED ANYWHERE (RLOC=ANY).            @D52VDMZ 00475007
*                                                              @D51KDMZ 00476007
*  OUTPUT                                                      @D51KDMZ 00477007
*  RF = 0 : PFIX DONE                                          @D51KDMZ 00478007
*  RF > 0 : PFIX FAILED                                        @D51KDMZ 00479007
*                                                              @D51KDMZ 00480007
*                                                              @D51KDMZ 00481007
         L     R1,DFWKLPNT         STORE LOAD POINT IN     ... @D51KDMZ 00482007
         ST    R1,FPFXBEG          ... PFIX TABLE              @D51KDMZ 00483007
         L     R1,DFWKEPLN         STORE PHASE LENGTH ...      @D51KDMZ 00484007
         BCTR  R1,0                ... MINUS 1        ...      @D51KDMZ 00485007
         ST    R1,FPFXLNG          ... IN PFIX TABLE           @D51KDMZ 00486007
         LA    R1,FPFXBEG          ADDR OF PFIX TABLE          @D51KDMZ 00487007
         L     R3,TCBPTR           TCBPTR OF PROGRAM FETCH TASK@D52VDMZ 00488007
         LA    R3,SVCSV3-TCBADR-16(,R3) ADDR SAVE AREA         @D52VDMZ 00489007
         L     R5,IJBSMCOM                                     @D52VDMZ 00490007
         USING SMCOM,R5            ADDR SMCOM                  @D52VDMZ 00491007
         CLC   DFWKLPNT,SMCESVA    LOAD POINT IN SVA 24 BIT    @D52VDMZ 00492007
         DROP  R5                                              @D52VDMZ 00493007
         BH    FPGM26A             NO, MUST BE IN SVA 31 BIT   @D52VDMZ 00494007
*        SPFIX ADDRESS=(1),RETURN=YES,RLOC=BELOW,SAVE=(3)      @D52VDMZ 00495007
         SPFIX ADDRESS=(1),RETURN=YES,RLOC=BELOW,SAVE=(3)      @D52VDMZ 00496007
         B     FPGM26B             CONTINUE                    @D52VDMZ 00497007
FPGM26A  DS    0H                                              @D52VDMZ 00498007
*        SPFIX ADDRESS=(1),RETURN=YES,RLOC=ANY,SAVE=(3)        @D52VDMZ 00499007
         SPFIX ADDRESS=(1),RETURN=YES,RLOC=ANY,SAVE=(3)        @D52VDMZ 00500007
FPGM26B  DS    0H                                              @D52VDMZ 00501007
         LTR   RF,RF               ERROR DURING PFIX ?         @D51KDMZ 00502007
         BZ    FPGM28              PFIX OK                     @D51KDMZ 00503007
         CH    RF,H12              WAS IT INVALID ADDRESS      @D51KDMZ 00504007
         BNE   FPFXERR             NO, NOT ENOUGH REAL STORAGE @D51KDMZ 00505007
         LA    R5,60               YES, INVALID ADDRESS        @D51KDMZ 00506007
         B     FPGMTAB                                         @D51KDMZ 00507007
FPGM28   OI    DFCBSW2,PFIXPND     INDICATE PFIX PENDING       @D64ADVB 00508007
*      **************************************************      @D149DVB 00509007
*      *                                                *      @D14CDHD 00510007
*      *   --->  ENTRY POINT TO READ A CONTIGUOUS PART  *      @D14CDHD 00511007
*      *                                                *      @D14CDHD 00512007
*      **************************************************      @D149DVB 00513007
         SPACE 1                                                        00514007
*                                                              @D14CDHD 00515007
*  IF #CONT. BLOCKS = 0 THEN GOTO FPGMERT                      @D14CDHD 00516007
*                                                              @D14CDHD 00517007
         SPACE 1                                               @D14CDHD 00518007
FPGM30   L     R1,DSRPLTXT         ADDR (TXT_RPL)              @D14CDVB 00519007
         LH    R5,DFWKECON         #(CONTIGUOUS BLOCKS)...     @D14CDVB 00520007
         LTR   R5,R5               IF NOT POSITIV              @D14CDVB 00521007
         BNP   FPGMERT             =====> ERROR                @D14CDVB 00522007
         USING DRPL,R1                                         @D14CDVB 00523007
         MH    R5,DRPLGRL          ...* LEN(LB)                @D14CDVB 00524007
         AL    R5,PFWKLTXT         ...+ LOAD_ADDRESS                   *00525007
                                   =:   END_ADDRESS(CONT.PART) @D14CDVB 00526007
         L     R3,PFWKETXT                                     @D14CDVB 00527007
         LR    R6,R5               ENDADDR (CONTIGUOUS PART)   @D52VDMZ 00528007
         CLR   R5,R3               REST OF PHASE CONTIGUOUS    @D14CDBC 00529007
         BL    FPGM40              NO -->                      @D14CDVB 00530007
         SPACE 1                                               @D14CDHD 00531007
*                                                              @D14CDHD 00532007
* THE CONTIGUOUS PART INCLUDES NOW THE END OF PHASE AND        @D14CDHD 00533007
* COMPRISES DFWKECON BLOCKS, WHEREAS THE TEXT IN THE LAST BLOCK@D52VDMZ 00534007
* CAN BE LESS THAN THE THE LOGICAL BLOCK LENGTH.               @D52VDMZ 00535007
* TEST, WHETHER CIF WILL BE WRITTEN OUTSIDE THE PHASE;         @D14CDHD 00536007
* THIS CAN HAPPEN, IF THE CONTINOUS PART CONTAINS MORE         @D14CDHD 00537007
* THAN ONE LIBRARY BLOCK AND THE LAST TXT BLOCK HAS FEWER      @D14CDHD 00538007
* BYTES THAN THE CIF HAS (CIF OF LAST BUT ONE BLOCK WOULD      @D52VDMZ 00539007
* BE WRITTEN OUTSIDE THE PHASE. THE LAST BLOCK IS NEVER A      @D52VDMZ 00540007
* PROBLEM SINCE IT IS WRITTEN IN A SPECIAL AREA AND THEN MOVED @D52VDMZ 00541007
* INTO THE PHASE AREA)                                         @D52VDMZ 00542007
*                                                              @D14CDHD 00543007
         L     R8,DFWKALIB               ADDR (LIB_DEF_TAB)    @D52VDMZ 00544007
         USING INLCLDTE,R8                                     @D52VDMZ 00545007
         LH    R8,LDTELBCF         ...                         @D52VDMZ 00546007
         DROP  R8                                              @D52VDMZ 00547007
         SPACE 1                                               @D14CDHD 00548007
         S     R3,PFWKLTXT         R3=PFWKETXT-PFWKLTXT        @D14CDHD 00549007
         SR    R2,R2                                           @D14CDHD 00550007
         SR    R4,R4                                           @D14CDHD 00551007
         LH    R4,DRPLGRL          LENGTH OF TXT IN LB         @D14CDHD 00552007
         DR    R2,R4               (PFWKETXT-PFWKLTXT)/LB LEN. @D14CDHD 00553007
         CR    R2,R8               REST < CIF LENGTH ?         @D14CDHD 00554007
         BNL   FPGM38              NO --->                     @D14CDHD 00555007
         LTR   R2,R2               REST = 0 ?                  @D14CDHD 00556007
         BZ    FPGM38              YES --->                    @D14CDHD 00557007
         LTR   R3,R3               MORE THAN ONE TXT LB ?      @D14CDHD 00558007
         BZ    FPGM38              NO --->                     @D14CDHD 00559007
         L     R5,PFWKETXT                                     @D14CDHD 00560007
         SR    R5,R2               R5=PFWKETXT-REST. REST READ.@D14CDHD 00561007
         LR    R6,R5               .. IN DURING NEXT CYCLET    @D52VDMZ 00562007
         B     FPGM40                                          @D14CDHD 00563007
FPGM38   L     R3,PFWKETXT                                     @D14CDVB 00564007
         LR    R6,R3               END OF PHASE =:...          @D14CDVB 00565007
         LR    R5,R3               ... ADDR OF CONTIGUOUS PART @D14CDVB 00566007
         DROP  R1                                              @D14CDVB 00567007
         SPACE 1                                                        00568007
*                                                              @D14CDHD 00569007
*  PFWKETXT = END OF PHASE                                     @D14CDHD 00570007
*  PFWKCTXT = END OF CONT. PART THAT CAN BE READ WITHIN CURRENT@D14CDHD 00571007
*             READ CYCLE (DETERMINED BY NO OF CONT. BLOCKS AND @D52VDMZ 00572007
*             CIF NOT WRITTEN OUTSIDE THE PHASE AREA)          @D52VDMZ 00573007
*                                                              @D14CDHD 00574007
         SPACE 1                                               @D14CDHD 00575007
FPGM40   ST    R6,PFWKCTXT                                     @D14CDVB 00576007
         SPACE 1                                                        00577007
*      **************************************************      @D149DVB 00578007
*      *                                                *      @D14CDHD 00579007
*      *   --->  ENTRY POINT IF THERE HAVEN'T BEEN      *      @D14CDHD 00580007
*      *         ENOUGH FIX TABLE ENTRIES               *      @D14CDHD 00581007
*      *                                                *      @D14CDHD 00582007
*      **************************************************      @D149DVB 00583007
         SPACE 1                                                        00584007
*                                                              @D14CDHD 00585007
*  PFWKHTXT<=PFWKCTXT                                          @D14CDHD 00586007
*  PFWKHTXT = PFWKLTXT + NO OF LB TEXT BLOCKS SUCH AS THERE IS          00587007
*             AN ENTRY IN THE FIX TABLE FOR ALL AFFECTED PAGES          00588007
*  PFWKHTXT = PFWKCTXT IF THERE IS AN ENTRY IN THE FIX TABLE FOR ALL    00589007
*                      PAGES OF THE CONTIGUOUS AREA                     00590007
*                                                                       00591007
*  PFWKMTXT < PFWKHTXT IF NOT ALL PAGES IN THE FIX TABLE COULD BE FIXED 00592007
*  PFWKMTXT = PFWKLTXT + NO OF TEXT BLOCKS SUCH AS THE FIXED AREA       00593007
*             IS NOT EXCEEDED                                           00594007
         SPACE 1                                               @D14CDHD 00595007
FPGM45   ST    R5,PFWKMTXT                                     @D14CDBC 00596007
         ST    R5,PFWKHTXT                                     @D14CDVB 00597007
FPGM50   TM    DFCBSW2,REALMASK+PFIXPND IF LOAD FOR REAL AREA OR AREA  *00598007
                                     IS PFIX'D  ...            @D64ADVB 00599007
         BNZ   FPGM70                .. SKIP TFIX PART         @D51KDMZ 00600007
         SPACE 1                                                        00601007
*                                                              @D14CDHD 00602007
*  BUILD FIX TABLE,                                            @D14CDHD 00603007
*  SET PFWKHTXT=PFWKMTXT=@AFTER LAST TXT BYTE FOR WHICH A FIX  @D14CDHD 00604007
*  ENTRY EXISTS - IF NOT ENOUGH FIX TABLE ENTRIES ARE AVAILABLE@D14CDHD 00605007
*                                                              @D14CDHD 00606007
         SPACE 1                                               @D14CDHD 00607007
         L     RF,DAFPGTAB                                     @D14CDVB 00608007
         BALR  RE,RF               DETERMINE LENGTH OF TFIXED SPACE... *00609007
                                   ...AND BUILD TFIX_TABLE     @D14CDVB 00610007
         AIF   (NOT &BGFSTAT).FSTZZ2                           @D35ZDVB 00611007
         SPACE 1                                                        00612007
*                                                              @D14CDHD 00613007
*  IF &BGFSTAT=ON THEN  FLCRTFX = FLCRTFX+#FIXED PAGES         @D14CDHD 00614007
*                                          (NOT EXACTLY)       @D14CDHD 00615007
*                                                              @D14CDHD 00616007
         SPACE 1                                               @D14CDHD 00617007
         L     R3,PFWKLTXT                                     @D14CDVB 00618007
         L     R4,PFWKHTXT                                     @D14CDVB 00619007
         SLR   R4,R3               LENGTH OF PART OF PHASE     @D35ZDVB 00620007
         SRL   R4,11               :2K                         @D35ZDVB 00621007
         L     R3,FLCRTFX          )                           @D35ZDVB 00622007
         ALR   R3,R4               ) UPDATE LOCAL COUNTER      @D35ZDVB 00623007
         ST    R3,FLCRTFX          )        # OF REQUIRED PAGES@D35ZDVB 00624007
.FSTZZ2  ANOP                                                  @D35ZDVB 00625007
         SPACE 1                                                        00626007
*                                                              @D14CDHD 00627007
*  TO PREVENT READ IN FROM THE PAGE DATA SET, MARK ALL PAGES   @D14CDHD 00628007
*  WHICH WILL BE COMPLETELY OVERWRITTEN BY THE SUBSEQUENT      @D14CDHD 00629007
*  READ REQUEST                                                @D14CDHD 00630007
*                                                              @D14CDHD 00631007
         SPACE 1                                               @D14CDHD 00632007
         L     R8,APMGMDAT         ADDRESS OF PGM DATA AREA             00633007
         ALR   R0,R6               CALCULATE                            00634007
         BCTR  R0,0                     FIRST PAGE AND LAST PAGE        00635007
         LCR   R6,R6                    THAT ARE COMPLETELY             00636007
         NR    R1,R6                    COVERED BY THE SUBSEQUENT       00637007
         BCTR  R1,0                     FETCH REQUEST AND NEED NO READ  00638007
*                                       IN FROM THE PDS                 00639007
         CLR   R0,R1               ANY PAGE FREEPDS ABLE                00640007
         BNL   FPGM60              NO -->                      @D14CDBC 00641007
         USING PMGMDATA,R8         ADDRESSIBILITY TO DATA AREA          00642007
         L     LINK2,AFREEPDS      ENTRY POINT OF FREEPDS               00643007
*SGLINK  FREEPDS,INPUT=(R0,R1,R7:LINK,R8:APMGMDAT),AMODE=31             00644007
*        AMODESW CALL,REGS=(LINK2,LINK2)                                00645007
         AMODESW CALL,REGS=(LINK2,LINK2)                       @D52VDMZ 00646007
         DROP  R8                                                       00647007
         SPACE 1                                                        00648007
         SPACE 1                                                        00649007
*      **************************************************      @D149DVB 00650007
*      *                                                *      @D14CDHD 00651007
*      *   --->  ENTRY POINT IF NOT ALL PAGES COULD     *      @D14CDHD 00652007
*      *         BE FIXED                               *      @D14CDHD 00653007
*      *                                                *      @D14CDHD 00654007
*      **************************************************      @D149DVB 00655007
         SPACE 1                                                        00656007
*                                                              @D14CDHD 00657007
*  TFIXIDEN = TFIXIDEN + 1                                     @D14CDHD 00658007
*  SET FIX FLAG                                                @DA33314 00659007
*  FTFRSAV = FTFXPTR                                           @D14CDHD 00660007
*  CALL TFIX                                                   @D14CDHD 00661007
*                                                              @D14CDHD 00662007
         SPACE 1                                                        00663007
FPGM60   LH    R5,TFIXIDEN         )                           @D14CDVB 00664007
         LA    R5,D1(R5)           )  UPDATE TFIXIDEN                   00665007
         STH   R5,TFIXIDEN         )                                    00666007
         OI    DFCBSW2,FIXTXT      INDICATE TFIXED PAGES       @DA33314 00667007
         L     R1,FTFXPTR          GET ACTUAL START ADDRESS            *00668007
                                   OF TFIX TABLE                        00669007
         ST    R1,FTFRSAV          AND SAVE IT                          00670007
         L     R8,APMGMDAT         ADDRESS OF PGM DATA AREA             00671007
         USING PMGMDATA,R8         ADDRESSIBILITY TO DATA AREA          00672007
         L     LINK2,ATFIX         GET ENTRY POINT TFIX                 00673007
*SGLINK  TFIX,INPUT=(R1,R7:LINK,R8:APMGMDAT),OUTPUT=(R1),WORK=(R0,R2,R3*00674007
               R4,R5,R6,R7,RA,RB,RC,RD),AMODE=31                        00675007
*        AMODESW CALL,REGS=(LINK2,LINK2)                       @D52VDMZ 00676007
         AMODESW CALL,REGS=(LINK2,LINK2)                       @D52VDMZ 00677007
         B     FPGM100             CONDITIONAL TFIX                     00678007
         B     FPGMERR             ERROR CONDITION                      00679007
         DROP  R8                                                       00680007
         L     RD,DGETSAB          )                           @D365DVB 00681007
         L     RA,ORG10(RD)        )    PROVIDE REGS           @D365DVB 00682007
         L     RB,ORG11(RD)        )                           @D365DVB 00683007
         LA    RD,DGETTXT          PROVIDE MODULE SAVEAREA     @D365DVB 00684007
         SPACE 1                                                        00685007
*                                                              @D14CDHD 00686007
*  SET NOCONTLD FLAG IF CURRENT READ IN DOES NOT INCLUDE       @D14CDHD 00687007
*  END OF PHASE                                                @D14CDHD 00688007
*                                                              @D14CDHD 00689007
         SPACE 1                                                        00690007
         L     R5,PFWKHTXT         GET HIGH LOAD ADDRESS       @D36JDVB 00691007
FPGM70   L     R1,DSRPLTXT         ADDR (TXT_RPL)              @D14CDVB 00692007
         USING DRPL,R1                                                  00693007
         NI    DFCBSW3,XFF-NOCONTLD CLEAR NON_CONTIGUOUS FLAG  @D64ADVB 00694007
         CL    R5,PFWKETXT         CONTIGUOUS TXT              @D14CDVB 00695007
         BNL   FPGM75              YES -->                     @D14CDVB 00696007
         OI    DFCBSW3,NOCONTLD    INDICATE NON_CONTIGUOUS REQ @D64ADVB 00697007
         SPACE 1                                                        00698007
*                                                              @D14CDHD 00699007
*  DRPLLBL = #BYTES IN LAST BLOCK ( FOR CURRENT READ REQ. )    @D14CDHD 00700007
*  DPRLINP = CURRENT LOAD POINT                                @D14CDHD 00701007
*  DRPNRC  = #LB'S TO READ IN WITH CURRENT READ REQ.           @D14CDHD 00702007
*                                                              @D14CDHD 00703007
         SPACE 1                                                        00704007
FPGM75   SLR   R4,R4               ZERO FOR DIVIDE             @D14CDVB 00705007
         L     R3,PFWKLTXT         END OF CONTIG. PART (TXT) - @D14CDBC 00706007
         SLR   R5,R3               - ACTUAL LOAD ADDR (TXT)            *00707007
                                   =: LEN (READ_IN AREA)       @D14CDBC 00708007
         LH    R2,DRPLGRL          LEN (LOG_RECORD)            @D14CDVB 00709007
         DR    R4,R2               NUMBER OF LB_RECORDS        @D14CDVB 00710007
PCKLBF20 EQU   *                                               @D14CDVB 00711007
         LTR   R4,R4               ANY REMAINDER                        00712007
         BZ    FPGM80              NO --->                              00713007
         LA    R5,1(R5)            INCREASE NUMBER OF RECORDS  @D14CDVB 00714007
         LR    R2,R4               LEN(LAST_RECORD) = LEN(LOGICAL_     *00715007
                                                  _RECORD)     @D14CDVB 00716007
FPGM80   STH   R2,DRPLLBL          ... VALUE IN TXT_FRPL       @D14CDVB 00717007
         ST    R3,DRPLINP          ACTUAL LOAD  ADDR...        @D14CDVB 00718007
         STH   R5,DRPNRC           ... NUMBER(TXT_LBS)...      @D14CDVB 00719007
         DROP  R1                  ... INTO FRPL               @D14CDVB 00720007
         SPACE 1                                               @D149DVB 00721007
*                                                              @D14CDHD 00722007
*  READ TXT  ( PFWKLTXT - PFWKMTXT )                           @D14CDHD 00723007
*                                                              @D14CDHD 00724007
         SPACE 1                                                        00725007
*SGLINK  FPGMREAD,INPUT=(R1,R7,R9,RA,RB,RD),OUTPUT=(R1,RF),WORK=(RE)    00726007
         BAL   LINK2,FPGMREAD      READ TEXT                            00727007
         AIF   (NOT &BGFSTAT).FSTZZ3                           @D35ZDVB 00728007
         SPACE 1                                               @D149DVB 00729007
*                                                              @D14CDHD 00730007
*  IF &BGFSTAT = ON                                            @D14CDHD 00731007
*     THEN FLCSTFX = #FIXED PAGES IF FLCSTFX = 0               @D14CDHD 00732007
*                  = (FLCSTFX + #FIXED PAGES)/2  OTHERWISE     @D14CDHD 00733007
*                                                              @D14CDHD 00734007
         SPACE 1                                                        00735007
         L     R1,PFWKLTXT                                     @D36ZDVB 00736007
         L     R2,PFWKMTXT                                     @D36ZDVB 00737007
         SLR   R2,R1               LENGTH OF PART OF PHASE     @D35ZDVB 00738007
         SRL   R2,11               :2K                         @D35ZDVB 00739007
         L     R1,FLCSTFX          )                           @D35ZDVB 00740007
         ALR   R2,R1               ) UPDATE LOCAL COUNTER      @D35ZDVB 00741007
         LTR   R1,R1               )                           @D35ZDVB 00742007
         BZ    *+8                 )   DIVIDE BY 2             @D35ZDVB 00743007
         SRL   R2,1                )     IF ALREADY INIT.      @D35ZDVB 00744007
         ST    R2,FLCSTFX          )                           @D35ZDVB 00745007
.FSTZZ3  ANOP                                                  @D35ZDVB 00746007
         SPACE 1                                                        00747007
*                                                              @D14CDHD 00748007
*  RELOCATE ALL ADDRESS CONSTANTS WHICH ARE READ IN            @D14CDHD 00749007
*                                                              @D14CDHD 00750007
         SPACE 1                                                        00751007
DEMONHK1 EQU   *                   LABEL FOR DEMON                      00752007
*SGLINK  RELADDR,INPUT=(R8,R9,RB),WORK=(R0,R1,R2,R3,R4,R5,R6)  @D369DVB 00753007
         BAL   LINK1,RELADDR       RELOCATE ADDRESS CONSTANTS           00754007
         LTR   R5,RF               ANY ERROR                   @D14CDVB 00755007
         BNZ   FPGMTAB             YES --->                    @D14CDVB 00756007
         TM    DFCBSW2,REALMASK+PFIXPND IF LOAD FOR REAL AREA OR ...   *00757007
                                   .. PFIX WAS DONE, NO ...... @D64ADVB 00758007
         BNZ   FPGM85              .. TFREE NECESSARY          @D51IDMZ 00759007
         SPACE 1                                                        00760007
*                                                              @D14CDHD 00761007
*  IF REALMASK FLAG SET THEN                                   @D14CDHD 00762007
*     - CALL TFREE                                             @D14CDHD 00763007
*     - TFIXIDEN = TFIXIDEN - 1                                @D14CDHD 00764007
*     - RESET FIX FLAG                                         @DA33314 00765007
*                                                              @D14CDHD 00766007
         SPACE 1                                                        00767007
         L     R1,FTFRSAV          START OF ACTUAL TFIXTAB              00768007
         L     R8,APMGMDAT                                              00769007
         USING PMGMDATA,R8         ESTABLISH ADDRESSIBILITY             00770007
         L     LINK2,ATFREEPH      ENTRY POINT OF TFREE SERVICE@D365DVB 00771007
*SGLINK  TFREE,INPUT=(R1,R7:LINK,R8:APMGMDAT),WORK=(R0),AMODE=31        00772007
*        AMODESW CALL,REGS=(LINK2,LINK2)                                00773007
         AMODESW CALL,REGS=(LINK2,LINK2)                       @D52VDMZ 00774007
         LH    R1,TFIXIDEN         )                                    00775007
         BCTR  R1,0                ) RESET TFIXIDEN                     00776007
         STH   R1,TFIXIDEN         )                                    00777007
         NI    DFCBSW2,XFF-FIXTXT  RESET TFIXED PAGES INDICATOR@DA33314 00778007
         DROP  R8                                                       00779007
         SPACE 1                                                        00780007
*                                                              @D14CDHD 00781007
*  PFWKLTXT = PFWKMTXT                                         @D14CDHD 00782007
*  PFWKMTXT = PFWKHTXT                                         @D14CDHD 00783007
*                                                              @D14CDHD 00784007
         SPACE 1                                                        00785007
FPGM85   L     R0,PFWKMTXT         HIGH_LOAD ADDRESS OF TFIXED @D14CDVB 00786007
         ST    R0,PFWKLTXT         ...AREA =: NEW LOW_LOAD ADDR@D14CDVB 00787007
         L     R1,PFWKHTXT         HIGH_LOAD ADDRESSES         @D14CDVB 00788007
         ST    R1,PFWKMTXT         HIGH_LOAD ADDR OF TFIXED AREA       *00789007
                                   ... = HIGHEST LOAD ADDR     @D14CDVB 00790007
         SPACE 1                                                        00791007
*                                                              @D14CDHD 00792007
*  IF NOT ALL PAGES OF THE FIX TABLE COULD BE FIXED            @D14CDHD 00793007
*     THEN STORE BACK SAVED ENTRY OF FIX TABLE AND GOTO FPGM60 @D14CDHD 00794007
*                                                              @D14CDHD 00795007
         SPACE 1                                                        00796007
         CLR   R0,R1                   CONDITIONAL TFIXED               00797007
         BE    FPGM90              NO --->                     @D14CDVB 00798007
         L     R1,FTFXSAV          GET POINTER TO SAVED ENTRY  @D14CDVB 00799007
         L     R0,FTENSAV          GET SAVED ENTRY ...         @D14CDVB 00800007
         ST    R0,0(,R1)           ... AND STORE IT BACK       @D52VDMZ 00801007
         B     FPGM60              MORE TFIXED --->            @D14CDVB 00802007
         SPACE 1                                                        00803007
*                                                              @D14CDHD 00804007
*  IF NOT ENOUGH FIX TABLE ENTRIES HAVE BEEN AVAILABLE         @D14CDHD 00805007
*     THEN R5 = MAXIMAL POSSIBLE HTXT VALUE; GOTO FPGM45       @D14CDHD 00806007
*                                                              @D14CDHD 00807007
         SPACE 1                                                        00808007
FPGM90   L     R5,PFWKCTXT         END_ADDR (CONTIGUOUS PART)..@D14CDVB 00809007
         CLR   R1,R5               CONTIGUOUS PART PROCESSED   @D14CDBC 00810007
         BL    FPGM45              NO --->                     @D14CDBC 00811007
         SPACE 1                                                        00812007
*                                                              @D14CDHD 00813007
*  IF THERE IS STILL ANOTHER CONTIGUOUS PART TO READ           @D14CDHD 00814007
*     THEN GOTO FPGM30                                         @D14CDHD 00815007
*                                                              @D14CDHD 00816007
         SPACE 1                                                        00817007
         L     R2,PFWKETXT         FOR PFWKHTXT - PFWKSTXT     @D14CDBC 00818007
         L     R5,PFWKHTXT          - COMPARISON               @D14CDBC 00819007
         CLR   R5,R2               END LAST LB < END OF PHASE  @D14CDBC 00820007
         BL    FPGM30              YES--->       MORE TO DO    @D14CDBC 00821007
         SPACE 1                                               @D14CDVB 00822007
*                                                              @D14CDHD 00823007
*  RETURN                                                      @D14CDHD 00824007
*                                                              @D14CDHD 00825007
         SPACE 1                                                        00826007
FPGMEXIT DS    0H                                              @D51KDMZ 00827007
         NI    DFCBSW2,XFF-PFIXPND CLEAR PFIXPND.IT MIGHT HAVE BEEN SET*00828007
                                   DUR. CURR. GETTEXT REQUEST  @D64ADVB 00829007
         SPACE 1                                                        00830007
         L     RD,OPRESA(RD)       REQUESTOR'S SAVE AREA ADDR  @D14CDVB 00831007
         LM    RE,RC,ORG14(RD)     RESTORE REGISTERS           @D14CDVB 00832007
*        AMODESW RETURN,REG=(RE)   ==========>  RETURN         @D64ADVB 00833007
         AMODESW RETURN,REG=(RE)   ==========>  RETURN         @D64ADVB 00834007
         SPACE 2                                               @D14CDVB 00835007
*-------------------------------------------------------------*@D149DVB 00836007
*    CONDITIONAL TFIX:                                        *@D149DVB 00837007
*        AT LEAST ONE PAGE COULD NOT BE TFIXED                *@D149DVB 00838007
*        PREPARATIONS ARE DONE TO TFIX THE NON_TFIXED PAGE(-S)*@D149DVB 00839007
*        LATER --- AFTER THE THE PROCESS_CYCLE OF THE NOW     *@D149DVB 00840007
*        TFIXED PAGES                                         *@D14CDVB 00841007
*-------------------------------------------------------------*@D149DVB 00842007
         SPACE 1                                                        00843007
FPGM100  EQU   *                                                        00844007
         SPACE 1                                               @D14CDVB 00845007
*                                                              @D14CDHD 00846007
*  REESTABLISH RA,RB WHICH ARE DESTROYED BY TFIX               @D14CDHD 00847007
*                                                              @D14CDHD 00848007
         SPACE 1                                                        00849007
*        SGCOV FETCHS,MC=20         CONDITIONAL TFIX           @D61NDVB 00850007
         SGCOV FETCHS,MC=20         CONDITIONAL TFIX           @D61NDVB 00851007
         L     RD,DGETSAB           ADDR (LOCAL SAVE_AREA)     @D14CDVB 00852007
         L     RA,ORG10(RD)         ADDR (USER_TCB)            @D14CDVB 00853007
         L     RB,ORG11(RD)         ADDR (FETCH_DATA_SECTION)  @D14CDVB 00854007
         LA    RD,DGETTXT           GET MODULE SAVEAREA        @D367DVB 00855007
         AIF   (NOT &BGFSTAT).FSTZZ4                           @D35ZDVB 00856007
         SPACE 1                                               @D14CDVB 00857007
*                                                              @D14CDHD 00858007
*  IF &BGFSTAT = ON THEN FNTFIXNR = FNTFIXNR + 1               @D14CDHD 00859007
*                                                              @D14CDHD 00860007
         SPACE 1                                                        00861007
         L     R2,FNTFIXNR         )                           @D35ZDVB 00862007
         LA    R2,1(R2)            ) UPDATE TOTAL NOT FULLY    @D35ZDVB 00863007
         ST    R2,FNTFIXNR         )        TFIX NR            @D35ZDVB 00864007
         SPACE 1                                               @D14CDVB 00865007
*                                                              @D14CDHD 00866007
*  SET FTFXSAV = @1.FIX TABLE ENTRY, WHOSE PAGE IS NOT FIXED;  @D14CDHD 00867007
*      FTENSAV = 1. FIX TABLE ENTRY, WHOSE PAGE IS NOT FIXED;  @D14CDHD 00868007
*  CLEAR FIX TABLE ENTRY (@FTFXSAV) TO INDICATE END OF FIX     @D14CDHD 00869007
*  TO THE TFREE ROUTINE;                                       @D14CDHD 00870007
*                                                              @D14CDHD 00871007
         SPACE 1                                                        00872007
.FSTZZ4  ANOP                                                  @D35ZDVB 00873007
         ST    R1,FTFXSAV          SAVE POINTER TO TFIXTAB ENTR         00874007
         L     R2,0(R1)            SAVE TFIXTAB ENTRY                   00875007
         ST    R2,FTENSAV            FOR NEXT TFIX/TFREE LOOP           00876007
         SLR   R2,R2                 AND ZERO                  @D365DVB 00877007
         ST    R2,0(R1)              ENTRY FOR TFREE I/F                00878007
         SPACE 1                                               @D14CDVB 00879007
*                                                              @D14CDHD 00880007
*  IF PFWKMTXT = @AFTER LAST TXT BLOCK, FOR WHICH STORAGE IS   @D14CDHD 00881007
*                FIXED                                         @D14CDHD 00882007
*                                                              @D14CDHD 00883007
         SPACE 1                                                        00884007
         L     R0,FTFRSAV          GET CURRENT TFIXTAB PTR              00885007
         LR    R2,R1               SAVE NEXT TFIXTAB POINTER            00886007
         SLR   R1,R0               #(TFIXED-PAGES) * 8         @D52VDMZ 00887007
         L     R7,PAGESIZE         DETERMINE ...               @D14CDVB 00888007
         SRL   R7,10               ... SHIFT VALUE ...         @D14CDVB 00889007
         IC    R7,FSHIFTAB(R7)     ... RELATED TO PAGE SIZE    @D14CDVB 00890007
         BCTR  R7,0                DIVIDED BY ..               @D14CDVB 00891007
         BCTR  R7,0                ..8 (CONSIDERING THE LENGTH OF       00892007
         BCTR  R7,0                     ... TFIX_TAB ENTRY)    @D52VDMZ 00893007
         SLL   R1,0(R7)            CALCULATE END_ADDR (PHASE_PART)     *00894007
                                   ...  THOSE AREA IS TFIXED   @D14CDVB 00895007
         L     R5,PFWKLTXT                                     @D36JDVB 00896007
         ALR   R5,R1               ...  AND CAN BE LOADED      @D14CDVB 00897007
         N     R5,PADDRMSK         ALIGN ON PAGE BOUNDARY      @D14CDVB 00898007
         LR    R6,R5                                           @D14CDVB 00899007
         SL    R5,PFWKLTXT         LENGTH OF READIN AREA       @D14CDVB 00900007
         L     R7,DSRPLTXT         ADDR (TEXTRPL)              @D14CDVB 00901007
         USING DRPL,R7             ESTABLISH ADDRESSIBILITY    @D14CDVB 00902007
         LH    R8,DRPLGRL          LEN (LOGICAL RECORD (TXT))  @D14CDVB 00903007
         SLR   R4,R4                                           @D14CDVB 00904007
         DR    R4,R8               NUMBER OF LB 'S ...         @D14CDVB 00905007
         MH    R5,DRPLGRL          ... THAT FIT IN USABLE AREA @D14CDVB 00906007
         AL    R5,PFWKLTXT         MEDIUM_LOAD ADDRESS TO BE CONSIDERD *00907007
                                   ... AS HIGH_END ADDRESS     @D14CDVB 00908007
         ST    R5,PFWKMTXT         ... FOR CURRENT READ CYCLE  @D14CDVB 00909007
         SPACE 1                                               @D14CDVB 00910007
*                                                              @D14CDHD 00911007
*  FTFXPTR = @LAST FIX TABLE ENTRY, FOR WHICH STORAGE WAS FIXED@D14CDHD 00912007
*            - MUST BE FIXED AGAIN FOR NEXT READ REQUEST       @D14CDHD 00913007
*                                                              @D14CDHD 00914007
         SPACE 1                                                        00915007
         SL    R2,F8               PAGE MUST BE TFIXED AGAIN...        *00916007
                                   ... DURING NEXT READ CYCLE  @D52VDMZ 00917007
         DROP  R7                                              @D14CDVB 00918007
         ST    R2,FTFXPTR          PROVIDE ADDR(TFIX_TAB_ENTRY)...     *00919007
                                   ... FOR NEXT TFIX CYCLE     @D14CDVB 00920007
         B     FPGM70              =====>    NORMAL PROCESSING @D14CDVB 00921007
         SPACE 1                                               @D14CDVB 00922007
*-------------------------------------------------------------*@D149DVB 00923007
         EJECT                                                 @D14CDVB 00924007
*-------------------------------------------------------------*@D149DVB 00925007
*                                                              @D149DHD 00926007
*  SUBROUTINE:    F P G V A L I D                              @D149DVB 00927007
*                                                              @D149DHD 00928007
*  MACRO:         SGBFCH                                       @D149DVB 00929007
*                                                              @D149DHD 00930007
*  FUNCTION:      VALIDATION OF STORAGE AREA USED BY PHASE     @D149DVB 00931007
*                                                              @D149DHD 00932007
*  INPUT:         R1:     LOAD ADDRESS OF PHASE                @D149DVB 00933007
*                 R2:     END ADDRESS OF PHASE                 @D149DVB 00934007
*                                                              @D149DHD 00935007
*  ALGORITHM:     TRANSIENT LOAD:                              @D149DVB 00936007
*                      IF IPL THEN RETURN WITHOUT VALIDATION;  @D149DVB 00937007
*                      CHECK IF LP - END OF PHASE INSIDE LTA;  @D149DVB 00938007
*                                                              @D149DHD 00939007
*                 LOAD IN SVA OR SYSTEM GETVIS AREA:           @D149DVB 00940007
*                      CHECK IF LP - END OF PHASE INSIDE SVA;  @D149DVB 00941007
*                      ( NO DISTINCTION BETWEEN SVA / SYSTEM   @D149DBC 00942007
*                      GETVIS; OVERWRITE OF SVA HEADER NOT     @D149DBC 00943007
*                      CHECKED!)                               @D149DVB 00944007
*                                                              @D149DHD 00945007
*                 LOAD IN PARTITION:                           @D149DBC 00946007
*                      CHECK IF LP - END OF PHASE INSIDE       @D149DVB 00947007
*                      PARTITION WITHOUT PART. GETVIS AREA;    @D149DBC 00948007
*                                                              @D149DHD 00949007
*                 LOAD IN PARTITION GETVIS AREA:               @D149DVB 00950007
*                      CHECK IF LP - END OF PHASE INSIDE       @D149DVB 00951007
*                      THE PART. GETVIS AREA AND IF THE        @D149DBC 00952007
*                      GETVIS_CONTROL_TABLE IS NOT OVERWRITTEN;@D149DVB 00953007
*                                                              @D149DHD 00954007
*  OUTPUT:        PARTLOAD SET                                 @DY45348 00955007
*                 ONLY IF PARTITION LOAD                       @D149DHD 00956007
*                 HIPHAS:      @END OF PHASE                   @D149DHD 00957007
*                 IJBHPHLA:    END ADDRESS OF HIGHEST LOADED   @D51IDMZ 00958007
*                              PHASE                           @D51IDMZ 00959007
*                                                              @D149DHD 00960007
*  ERROR HANDLING:                                             @D149DHD 00961007
*                 FVLDERR:  -  IF TRANSIENT LOAD, BUT TASK DOES@D149DHD 00962007
*                              NOT OWN THE LTA                 @D149DHD 00963007
*                           -  IF TRANSIENT LOAD AND SECURITY  @D149DHD 00964007
*                              ACTIVE AND PHASE DOES NOT START @D149DHD 00965007
*                              WITH $$B...                     @D149DHD 00966007
*                           -  INVALID ADDRESS FOR LP          @D149DHD 00967007
*                           -  IF SVA LOAD AND                 @D149DHD 00968007
*                              END OF PHASE >= VIO_POOL BEGIN  @D149DHD 00969007
*                                                              @D149DHD 00970007
*                 FVLDNFIT: -  IF TRANSIENT LOAD AND           @D149DHD 00971007
*                              END OF PHASE > LTA END          @D149DHD 00972007
*                           -  IF LP - END OF PHASE NOT INSIDE @D149DHD 00973007
*                              PARTITION AND KEY MISMATCH FOR  @D149DHD 00974007
*                              AT LEAST ONE PAGE OF THE AREA   @D149DHD 00975007
*                           -  IF LOAD IN PART. GETVIS AREA AND@D149DHD 00976007
*                              END OF PHASE >= GETVIS_CTL._TAB @D149DHD 00977007
*                           -  IF PARTITION LOAD AND           @D149DHD 00978007
*                              END OF PHASE >= START OF GETVIS @D149DHD 00979007
*                                                              @D149DHD 00980007
*  EXITS:         NORMAL TO CALLER, IF NO ERROR                @D149DHD 00981007
*                 TO LABEL FVLDERR, FVLDNFIT IF ERROR          @D149DHD 00982007
*                                                              @D149DHD 00983007
*  CALLED BY:     FGETTXT                                      @D149DVB 00984007
*                                                              @D149DHD 00985007
*  CALLING SEQUENCE:  BAL LINK2,FPGVALID                       @D149DHD 00986007
*                                                              @D149DHD 00987007
*  CALLS ROUTINE:     VALWRITE                                 @D149DVB 00988007
*                                                              @D149DHD 00989007
*  RETURN CODES:      NONE                                     @D149DHD 00990007
*                                                              @D149DHD 00991007
*-------------------------------------------------------------*@D149DVB 00992007
         SPACE 1                                               @D14CDVB 00993007
*SGLINK  FPGVALID,INPUT=(R1,R2,R7,R9,RA),WORK=(R2,R3,R4,R5,R6,R7,R8)    00994007
FPGVALID L     R6,DISPAD           GET POINTER TO DISPATCHER   @D14CDVB 00995007
         USING DISP,R6                                         @D36IDVB 00996007
         SLR   RF,RF                                           @D14CDVB 00997007
FVLD10   BCTR  R2,0                LAST BYTE OF PHASE          @D14CDVB 00998007
         LR    R3,R2               SAVE END ADDRESS            @D14CDVB 00999007
         SPACE 1                                               @D14CDHD 01000007
*                                                              @D14CDHD 01001007
*  IF NO TRANSIENT LOAD THEN GOTO FVLD20                       @D14CDHD 01002007
*                                                              @D14CDHD 01003007
         SPACE 1                                               @D14CDHD 01004007
         L     R4,IJBSMCOM         ADDRESS SMCOM               @D51GDMZ 01005007
         USING SMCOM,R4                                        @D51GDMZ 01006007
         CL    R1,SMCSSEND         OUTSIDE SUP. / SDAID AREA?  @D51GDMZ 01007007
         BH    FVLD20              YES -->                              01008007
         CL    R1,SMCSSBEG         INSIDE SDAID AREA           @D51GDMZ 01009007
         DROP  R4                                              @D51GDMZ 01010007
         BL    FVLD12              NO  -->                     @DA35849 01011007
         L     R4,TCBSAVE          GET SAVE AREA POINTER       @DA35849 01012007
         USING SVEARA,R4           BASE FOR SAVE AREA          @DA35849 01013007
         TM    SVEPSWKY,KEY0       REQUESTOR HAS KEY 0         @DA35849 01014007
         BZR   LINK2               YES,---> NO VALIDATION      @DA35849 01015007
         DROP  R4                                              @DA35849 01016007
         B     FVLDERR             ======>  EXIT ERROR         @DA35849 01017007
FVLD12   EQU   *                                               @DA35849 01018007
         SPACE 1                                               @D37ZDVB 01019007
*-------------------------------------------------------------*@D14CDHD 01020007
*             VALIDATION OF TRANSIENTS                        *@D14CDHD 01021007
*-------------------------------------------------------------*@D14CDHD 01022007
         SPACE 1                                              *@D14CDHD 01023007
         TM    SYSFLAG2,IPLBIT     IPL IN PROGRESS                      01024007
         BOR   LINK2               YES ---> (NO CHECKING DONE) @D14CDVB 01025007
         L     R3,TCBTIB           POINTER TO FETCH TASK TIB   @D36IDVB 01026007
         USING TIBADR,R3                                       @D36IDVB 01027007
         TM    TIBFLAG1,LTAOWNER   DOES TASK OWN THE LTA       @D36IDVB 01028007
         BZ    FVLDERR             =====>  EXIT ERROR          @D14CDVB 01029007
         TM    SYSFLAG2,IJBSEC     SECURITY CHECK ACTIVE       @D14CDVB 01030007
         BZ    FVLD15              NO                          @D14CDVB 01031007
         TM    DFWKSWRQ,SVC02REQ   SVC 2 REQUEST               @D64ADVB 01032007
         BZ    FVLD15              NO                          @DA35100 01033007
         CLC   DFWKNAME(3),CON$$BN LTA_PHASE STARTS WITH $$B   @D14BDVB 01034007
         BNE   FVLDSECT            =====>  EXIT ERROR          @D21ZDVB 01035007
FVLD15   L     R3,ALTA             BEG_ADDR (LTA)              @D14CDVB 01036007
         CLR   R1,R3               LOAD_ADDR < BEG_ADDR(LTA)   @D14CDVB 01037007
         BL    FVLDERR             =====>   YES: ERROR EXIT    @D14CDVB 01038007
         LA    R3,LEN$$B(R3)       BEG_ADDR (LTA) + LEN (LTA)  @D14CDVB 01039007
         CLR   R3,R2               END_ADDR  > END_ADDR LTA)   @D14CDVB 01040007
         BHR   LINK2               =====>   NO: RETURN         @D14CDVB 01041007
         B     FVLDNFIT            =====> ERROR PHS NOT FIT    @D14CDBC 01042007
         SPACE 1                                               @D14CDVB 01043007
*-------------------------------------------------------------*@D14CDHD 01044007
*  VALIDATION OF PARTITION / SVA 24/31 (INCL. SYSTEM GETVIS)  *@D52VDMZ 01045007
*  NO VALIDATION IS DONE FOR CDLOADRQ, MVSCDLD AND MVSCSALD   *@D64ADVB 01046007
*-------------------------------------------------------------*@D14CDHD 01047007
         SPACE 1                                              *@D14CDHD 01048007
FVLD20   DS    0H                                              @D64ADVB 01049007
         CLI   DFWKRQFM,CDLOADRQ   CDLOAD REQUEST              @D64ADVB 01050007
         BER   LINK2               YES, ==========> OK, RETURN @D64ADVB 01051007
         CLI   DFWKRQFM,MVSCDLD    MVS LOAD REQUEST            @D64ADVB 01052007
         BER   LINK2               YES, ==========> OK, RETURN @D64ADVB 01053007
         CLI   DFWKRQFM,MVSCSALD   MVS LOAD REQUEST FOR CSA    @D64ADVB 01054007
         BER   LINK2               YES, ==========> OK, RETURN @D64ADVB 01055007
         CLI   DFWKRQFM,MVSLOAD    MVS LOAD REQUEST VIA ADDR   @D64ADVB 01056007
         BER   LINK2               YES, ==========> OK, RETURN @D64ADVB 01057007
         LH    R5,PIK              VALIDATION WITH PARTIT KEY  @D14CDVB 01058007
         TM    DFWKFLAG,SVAUPD     SVA LOAD REQUESTED          @D14CDVB 01059007
         BZ    FVLD30              NO --->                     @D14CDVB 01060007
         SLR   R5,R5               VALIDITION WITH KEY ZERO    @D14CDVB 01061007
FVLD30   LR    R4,R5               SAVE R5 INPUT FOR VALWRITE  @D14CDBC 01062007
         LR    R2,R1               ADDR (START  OF PHASE)      @D52VDMZ 01063007
*SGLINK  VALWRITE,INPUT=(R1,R2,R5,R6,R8),OUTPUT=(R5),WORK=(R2) @D149DBC 01064007
         BAL   LINK1,VALWRITE      VALIDATE KEY                @D52VDMZ 01065007
         B     FVLDERR             =====>  ERROR EXIT ADDRESS  @D14CDVB 01066007
         B     FVLDERR             =====>  ERROR EXIT PROTECT. @D14CDVB 01067007
         LR    R5,R4               RESTORE VALIDATION KEY      @D14CDBC 01068007
         LR    R2,R3               ADDR (LAST BYTE OF PHASE)   @D14CDVB 01069007
*SGLINK  VALWRITE,INPUT=(R1,R2,R5,R6,R8),OUTPUT=(R5),WORK=(R2) @D149DVB 01070007
         BAL   LINK1,VALWRITE      VALIDATE PHASE ADDR RANGE   @D14CDVB 01071007
         B     FVLDNFIT            ==> ERROR EX ADDR PHS ¬ FIT @D14CDBC 01072007
         B     FVLDNFIT            ==> ERROR EX PROT PHS ¬ FIT @D14CDBC 01073007
         LR    R2,R3               ADDR (LAST BYTE OF PHASE)   @D14CDVB 01074007
         SPACE 1                                               @D14CDHD 01075007
*                                                              @D14CDHD 01076007
*  IF LOAD IN PARTITION OR PARTITION GETVIS THEN GOTO FVLD40   @D14CDHD 01077007
*                                                              @D14CDHD 01078007
         SPACE 1                                               @D14CDHD 01079007
         L     R5,IJBSMCOM         ADDRESS SMCOM               @D51GDMZ 01080007
         USING SMCOM,R5                                        @D51GDMZ 01081007
         CL    R1,SMCESVA          LOAD INTO SVA 24 BIT        @D52VDMZ 01082007
         BH    FVLD3000            NO --->                     @D52VDMZ 01083007
*                                                              @D14CDHD 01084007
*  LOAD IN SVA OR SYSTEM GETVIS (24 BIT)                       @D52VDMZ 01085007
*  IF END OF PHASE < START OF VIO-POOL THEN RETURN ELSE ERROR  @D14CDHD 01086007
*                                                              @D14CDHD 01087007
         SPACE 1                                               @D14CDHD 01088007
         CL    R2,AVPBEG           LOAD INTO VIO_POOL          @D14CDVB 01089007
         BLR   LINK2               =====>  NO                  @D14CDVB 01090007
         B     FVLDERR             =====>  ERROR  EXIT         @D14CDVB 01091007
         SPACE 1                                               @D14CDHD 01092007
FVLD3000 DS    0H                  CHECK FOR LOAD IN SVA 31 BIT@D52VDMZ 01093007
         CLC   SMCESV31,SMCSVA31   DOES SVA 31 BIT EXIST       @D52VDMZ 01094007
         BNH   FVLD40              NO, MUST BE PARTITION       @D52VDMZ 01095007
         CL    R1,SMCSVA31         LOAD IN SVA 31 BIT          @D52VDMZ 01096007
         BNLR  LINK2               YES                         @D52VDMZ 01097007
         DROP  R5                                              @D51GDMZ 01098007
         SPACE 1                                               @D14CDHD 01099007
*                                                              @D14CDHD 01100007
*  LOAD IN PARTITION OR PARTITION GETVIS:                      @D14CDHD 01101007
*  IF PARTITION GETVIS_CONTROL_TABLE NOT YET INITIALIZED       @D14CDHD 01102007
*     THEN GOTO FVLD50                                         @D14CDHD 01103007
*                                                              @D14CDHD 01104007
         SPACE 1                                               @D14CDHD 01105007
FVLD40   L     R3,DFWKCOMG         ADDR (COMREG)               @D14CDVB 01106007
         USING COMREG,R3                                       @D14CDVB 01107007
         L     R4,PPEND            END_ADDR OF USER SPACE IN...        *01108007
                                   ... THE PARTITION           @D14CDVB 01109007
         AH    R4,H1               BEG_ADDR(GETVIS_AREA(PART)) @D51GDMZ 01110007
         L     R5,IJBGVCTL         ADDR (GETVIS_CONTROL_TABLE) @D14CDVB 01111007
         LTR   R5,R5               ALREADY INITIALIZED         @D14CDVB 01112007
         BZ    FVLD50              NO --->                     @D14CDVB 01113007
         SPACE 1                                               @D14CDHD 01114007
*                                                              @D14CDHD 01115007
*  IF LOAD IN PART. GETVIS AND END OF PHASE < GETVIS_CONTR_TAB @D14CDHD 01116007
*    THEN RETURN                                               @D14CDHD 01117007
         SPACE 1                                               @D14CDHD 01118007
         CLR   R1,R4               LOAD INTO GETVIS_AREA       @D14CDVB 01119007
         BL    FVLD50              NO --->                     @D14CDVB 01120007
         CLR   R2,R5               GETVIS_CON_TAB OVERWRITTEN  @D14CDVB 01130007
         BNL   FVLDNFIT            YES, DO NOT LOAD            @DY45348 01131007
         OI    DFCBSW2,PARTLOAD    MAKE ENTRY IN IJBPHLST      @DY45348 01132007
         BR    LINK2               RETURN                      @DY45348 01132107
         SPACE 1                                               @D14CDHD 01132207
*                                                              @D14CDHD 01132307
*  LOAD IN PARTITION:                                          @D14CDHD 01132407
*  IF END OF PHASE < START OF GETVIS AREA                      @D14CDHD 01132507
*     THEN HIPHAS = END OF PHASE; SET PARTLOAD FLAG;           @D14CDHD 01132607
*          IF END OF PHASE > END OF LAST PHASE LOADED          @D51IDMZ 01132707
*            THEN IJBHPHLA = END OF PHASE                      @D51IDMZ 01132807
*          RETURN                                              @D51IDMZ 01132907
*                                                              @D14CDHD 01133007
         SPACE 1                                               @D14CDHD 01134007
FVLD50   CLR   R2,R4               LOAD INTO USER_PART_AREA    @D14CDVB 01135007
         BNL   FVLDNFIT            =====>    NO                @D14CDBC 01136007
         ST    R2,HIPHAS           SAVE END ADDR OF PHASE      @D14CDVB 01137007
         OI    DFCBSW2,PARTLOAD    LOAD IN USER PARTITION      @D64ADVB 01138007
         C     R2,IJBHPHLA         END ADDR LESS THAN END ...  @D51IDMZ 01139007
         BL    FVLDEXIT            .. ADDR OF LAST PHASE       @D51IDMZ 01140007
         ST    R2,IJBHPHLA         NEW HIGHEST PHASE ADDRESS   @D51IDMZ 01141007
FVLDEXIT BR    LINK2               =====>    RETURN            @D14CDVB 01142007
         DROP  R3,R6                                           @D14CDVB 01143007
         EJECT                                                          01144007
*-------------------------------------------------------------*@D149DVB 01145007
*     FPGMREAD SUBROUTINE                                     *@D149DVB 01146007
*-------------------------------------------------------------*@D149DVB 01147007
         SPACE 2                                                        01148007
*SGLINK  FPGMREAD,INPUT=(R1,R7,R9,RA,RB,RD),OUTPUT=(R1,RF),WORK=(RE)    01149007
FPGMREAD DS    0H                  ENTRY POINT                          01150007
         L     RF,DAREAD           GET ENTRY POINT OF READ     @D367DVB 01151007
*SGLINK  FREAD,INPUT=(R1,RA,RB,RD,RE),OUTPUT=(R1,RF)           @D369DVB 01152007
*        AMODESW CALL,REGS=(RE,RF)                             @D64ADVB 01153007
         AMODESW CALL,REGS=(RE,RF)                             @D64ADVB 01154007
         LTR   RF,RF               TEST RETURN CODE            @D367DVB 01155007
         BZR   LINK2               =====>     RETURN (ALL OK)  @D14CDVB 01156007
         SPACE 2                                               @D14CDVB 01157007
*-------------------------------------------------------------*@D149DVB 01158007
*     ERROR HANDLING ROUTINE                                  *@D149DVB 01159007
.* ERROR HANDLING ROUTINE FOR ERRORS DETECTED BOTH IN FREAD    @D52VDMZ 01160007
.* AND FGETTXT                                                 @D52VDMZ 01161007
*-------------------------------------------------------------*@D149DVB 01162007
         SPACE 2                                               @D14CDVB 01163007
         LR    R5,RF                                           @D14CDVB 01164007
FPGMTAB  B     FPGMTAB(R5)                                     @D14CDVB 01165007
         B     FPGMERV             4 :  CIL I/O --> CANCEL TSK @D14CDVB 01166007
         NOP   FPGMEREX            N.A. (SCIL I/O ERROR)       @D14CDVB 01167007
         B     FPGMHWT             12:  INTERFACE ERROR        @D14CDVB 01168007
         B     FPGMHWT             16:  TFIX ERROR             @D14CDVB 01169007
         B     FPGMRBAX            20:  RBA IN INVALID EXTENT  @D14CDVB 01170007
         B     FPGMERLB            24:  END_OF_LB CHAIN        @D14CDVB 01171007
         B     FPGMERLB            28:  INVALID LB_CIF         @D14CDVB 01172007
         B     FPGMHWT             32:  N/A  PHASE NOT FOUND   @D14CDVB 01173007
         B     FPGMRLDX            36:  RLD OUTSIDE PHASE      @D14CDVB 01174007
         B     FVLDNFIT            40:  PHS DOES NOT FIT       @D14CDBC 01175007
         B     FPGNTFD             44:  ID MISMATCH  -  PHASE  @D14CDHD*01176007
                                        IS ALREADY DELETED     @D14CDHD 01177007
         B     FPGMHWT             48:  N/A                    @D14CDHD 01178007
         B     FPGMHWT             52:  N/A                    @D51KDMZ 01179007
         B     FPGMPFX             56:  ERROR DURING PFIX      @D51KDMZ 01180007
         B     FPGMHWT             60:  INVALID ADDR DURING PFX@D51KDMZ 01181007
         B     FPGMRMD             64:  LP / RMODE MISMATCH    @D52VDMZ 01182007
         SPACE 1                                               @D14CDHD 01183007
FPGNTFD  MVI   DFWKRCOD,PHNTFND4                               @D14CDHD 01184007
         SPACE 1                                               @D14CDHD 01185007
*                                                              @D14CDHD 01186007
* DEACTIVATE USER DE IF ONE EXISTS                             @D14CDHD 01187007
*                                                              @D14CDHD 01188007
         SPACE 1                                               @D14CDHD 01189007
         L     R2,DFWKUSEN         USER DE?                    @D14CDHD 01190007
         LTR   R2,R2                                           @D14CDHD 01191007
         BZ    FPGMEREX            NO  --->                    @D14CDHD 01192007
         OI    DFWKESWT,ACTIVE+NOTFND                          @D14CDHD 01193007
         TM    DFWKFLAG,SDLFORM    USER-DE IN SDL FORM?        @D14CDHD 01194007
         BZ    FPGNTUS             NO  --->                    @D14CDHD 01195007
         USING INLCSDLE,R2                                              01196007
         OI    SDLEFLG,ACTIVE+NOTFND                           @D14CDHD 01197007
         DROP  R2                                              @D14CDHD 01198007
         B     FPGMEREX                                        @D14CDHD 01199007
         USING DIRECTRY,R2                                              01200007
FPGNTUS  OI    DIRC,ACTIVE+NOTFND                              @D14CDHD 01201007
         DROP  R2                                              @D14CDHD 01202007
         B     FPGMEREX                                        @D14CDHD 01203007
         SPACE 1                                               @D14CDHD 01204007
FVLDSECT SLR   R0,R0                                           @D21ZDVB 01205007
         BCTR  R0,0               R0 MUST BE NEGATIVE          @D21ZDVB 01206007
         LA    R5,ORG14(,RD)      USED AS REGISTER SAVE AREA   @D21ZDVB 01207007
         LA    R1,DFWKALIB        ADDRESS OF PARM LIST         @D21ZDVB 01208007
         LR    R6,RD              SAVE ADDR(ACTUAL SAVE AREA)  @D21ZDVB 01209007
         SPACE 1                                               @D21ZDVB 01210007
*   INTERFACE TO  SCYSVC :                                     @D21ZDVB 01211007
*           INPUT  R0 = 0 SECURITY CHECK MUST BE PERFORMED     @D21ZDVB 01212007
*                     > 0 AUTHORITY CHECK REQUIRED (THAT MEANS @D21ZDVB 01213007
*                            THE CUMULATED ACCCESS RIGHTS OF   @D21ZDVB 01214007
*                            LOT ENTRIES)                      @D21ZDVB 01215007
*                     < 0 RECORDING DUE TO SECURITY VIOLATION  @D21ZDVB 01216007
*                  R1 = ADDRESS (PARAMETER LIST)               @D21ZDVB 01217007
*                       PARAMETER LIST = < ADDR(LIB.DEF.TAB)   @D21ZDVB 01218007
*                                         ,ADDR(SLIB.DEF.TAB)  @D21ZDVB 01219007
*                                         ,ADDR(PHASENAME) >   @D21ZDVB 01220007
*                  R5 = SAVE AREA ADDRESS                      @D21ZDVB 01221007
*                  RA = TCB ADDRRESS OF LOAD/FETCH REQUESTOR   @D21ZDVB 01222007
*                  RC = RETURN ADDRESS                         @D21ZDVB 01223007
*                  RD = BASE REGISTER OF SCYSVC ROUTINE        @D21ZDVB 01224007
*           OUTPUT RF = RETURN CODE                            @D21ZDVB 01225007
         SPACE 1                                               @D21ZDVB 01226007
         L     RD,AFCHDAT         ADDR FETCH DATA SECTION      @D64ADMZ 01227007
         USING DFCB,RD                                         @D64ADMZ 01228007
         L     RC,DASCYSVC        ADDR OF SEC. ROUTINE         @D64ADMZ 01229007
         DROP  RD                 RELEASE FETCH DATA SECTION   @D64ADMZ 01230007
         L     RD,ASGSVCX2        BASE OF SECURITY ROUTINE     @D64ADMZ 01231007
         BASSM RC,RC              LOGGING OF SECURITY VIOLATION@D21ZDVB 01232007
         LR    RD,R6                                           @D21ZDVB 01233007
         SPACE 1                                               @D21ZDVB 01234007
         LA    R5,52               LOAD  INTERNAL RET CODE     @D21ZDVB 01235007
         MVI   DFWKRCOD,SECURT20   INDICATE SECURITY VIOLATION @D21ZDVB 01236007
         B     FPGMEREX            --->                        @D21ZDVB 01237007
         SPACE 1                                               @D21ZDVB 01238007
FPGMPFX  DS    0H                                              @D51KDMZ 01239007
         MVI   DFWKRCOD,PFXERR32   INDICATE PFIX ERROR         @D51KDMZ 01240007
         B     FPGMEREX            --->                        @D51KDMZ 01241007
         SPACE 1                                               @D21ZDVB 01242007
FPGMRMD  DS    0H                                              @D52VDMZ 01243007
         MVI   DFWKRCOD,RMDERR36   INDICATE LP/RMODE MISMATCH  @D52VDMZ 01244007
         B     FPGMEREX            --->                        @D52VDMZ 01245007
         SPACE 1                                               @D21ZDVB 01246007
FVLDNFIT LA    R5,40               LOAD  INTERNAL RET CODE     @D14CDBC 01247007
         MVI   DFWKRCOD,NVANFT28   INDICATE PHS NOT FIT        @D14CDBC 01248007
         B     FPGMEREX            --->                        @D14CDVB 01249007
         SPACE 1                                               @D14CDVB 01250007
FPGMRLDX TM    DFWKRQFM,MVSXXXX    MVS LOAD SIMULATION         @D64ADVB 01251007
         BNO   FVLDERR             NO,  ---> INVALID ADDRESS   @D64ADVB 01252007
         MVI   DFWKRCOD,RLDOUT44   RC = RLD OUTSIDE PHASE      @D64ADVB 01253007
         B     FPGMEREX            --->                        @D64ADVB 01254007
         SPACE 1                                               @D14CDBC 01255007
FVLDERR  LA    R5,36               LOAD  INTERNAL RET CODE     @D14CDVB 01256007
         MVI   DFWKRCOD,NVADDR16   INDICATE NO VALID ADDRESS   @D14CDVB 01257007
         B     FPGMEREX            --->                        @D14CDVB 01258007
         SPACE 1                                               @D14CDBC 01259007
FPGMRBAX TM    DFWKRQFM,MVSXXXX    MVS LOAD SIMULATION         @D64ADVB 01260007
         BNO   FPGMERLB            NO,  ---> INVAL LIB STRUCT  @D64ADVB 01261007
         MVI   DFWKRCOD,RBAOUT40   RC = RBA OUT OF EXTENT      @D64ADVB 01262007
         B     FPGMEREX            --->                        @D64ADVB 01263007
         SPACE 1                                               @D14CDBC 01264007
FPGMERLB MVI   DFWKRCOD,NVALIB12   INDICATE RETURN CODE        @D14CDVB 01265007
         B     FPGMEREX            --->                        @D14CDVB 01266007
         SPACE 1                                               @D14CDVB 01267007
FPGMERV  MVI   DFWKRCOD,FIOERR8    INDICATE FETCH I/O ERROR    @D14CDVB 01268007
FPGMEREX DS    0H                                              @D14CDVB 01269007
         LM    R1,R4,DFWKALIB      SAVE TCB_CONTENT            @D14CDHD 01270007
         STC   R5,DFWKANAM-1       PROVIDE RC                  @D14CDVB 01271007
         MVC   DFWKALIB(7),0(R2)   PROVIDE FIRST 7 CHARACTERS...       *01272007
                                   ... OF SUBLIBRARY NAME      @D14CDVB 01273007
         MVC   DFWKANAM(L'DFWKNAME),DFWKNAME                   @D14CDVB 01274007
         LA    R0,DFWKALIB         ADDR OF DISPLAY AREA        @D14CDVB 01275007
         ST    R0,XXUSAREA         ... TO DEBUG AREA           @D14CDVB 01276007
         DEBUG DSPLYDAT,XXDBGMC                                @D61NDMZ 01277007
         STM   R1,R4,DFWKALIB      RESET ADDR (SUBLIB) AND             *01278007
                                   ...   ADDR(PHASENAME)       @D14CDVB 01279007
         STM   R1,R2,TCBCINF       STORE TCBCASLB,TCBCALIB     @DY45682 01280009
         LA    RE,TCBCSNAM         STORE                       @DY45682 01280109
         ST    RE,TCBCANAM         ...TCBCANAM                 @DY45682 01280209
         MVC   0(L'DFWKNAME,RE),0(R3) SAVE PHASE NAME FOR DUMP @DY45682 01280309
         LH    R0,DFCBERRP         UPDATE...                   @D21ZDVB 01281007
         AH    R0,H1               ...  ERROR                  @D14CDVB 01282007
         STH   R0,DFCBERRP         ...      COUNTER            @D14CDVB 01283007
         ST    R5,DFCBSTPF         SAVE ERROR INDICATION       @D14CDVB 01284007
         L     RD,OPRESA(RD)                                   @D14CDVB 01285007
         MVI   ORG15+3(RD),4       SET INTERNAL RETURN CODE    @D14CDVB 01286007
         LM    RE,RC,ORG14(RD)     RESTORE REGISTERS           @D14CDVB 01287007
*        AMODESW RETURN,REG=(RE)   ==========>  RETURN         @D64ADVB 01288007
         AMODESW RETURN,REG=(RE)   ==========>  RETURN         @D64ADVB 01289007
         SPACE 1                                                        01290007
*-------------------------------------------------------------*@D149DVB 01291007
         SPACE 1                                                        01292007
FPGMERT  LA    R5,28               R5 CODE (INVALID LB_CIF)    @D14CDBC 01293007
         B     FPGMTAB             --->                        @D14CDVB 01294007
         SPACE 1                                                        01295007
*-------------------------------------------------------------*@D149DVB 01296007
         SPACE 1                                                        01297007
FPGMERR  LA    R5,16               HARDWAIT DUE TO TFIX I/F    @D14CDVB 01298007
         L     RD,DGETSAB          SAVE_AREA OF PROGRAM-FETCH-         *01299007
                                                -TASK          @D14CDVB 01300007
         LM    RA,RB,ORG10(RD)     SET STANDARD REGISTERS      @D14CDVB 01301007
         LA    RD,DGETTXT          PROVIDE MODULE SAVEAREA     @D14CDVB 01302007
         SPACE 1                                               @D14CDVB 01303007
FPGMHWT  LA    RF,HARDWAIT                                     @D14CDVB 01304007
         MVI   HWIDBYTE,HWFCHIO                                @D14CDVB 01305007
         STC   R5,DFWKPHPT+7       PROVIDE RC                  @D64ADVB 01306007
         MVC   DFWKPHPT(7),HARDNAME SET HARDWAIT               @D14CDVB 01307007
         LA    R0,DFWKPHPT         ADDR OF DISPLAY AREA        @D14CDVB 01308007
         ST    R0,XXUSAREA         ... TO DEBUG AREA           @D14CDVB 01309007
         DEBUG DSPLYDAT,XXDBGMC                                @D61NDMZ 01310007
         L     R6,DISPAD                                       @D36IDVB 01311007
         LM    R8,RE,DFCBSAV+OFS8                              @D36IDVB 01312007
         MVI   IJBHWORG,HWORG164   UNIQUE HARD WAIT ORIGINATOR @D31QDHB 01313007
         BR    RF                  =====> HARDWAIT X'FFE'      @D14CDVB 01314007
         SPACE 1                                               @D14CDVB 01315007
*-------------------------------------------------------------*@D51KDMZ 01316007
         SPACE 1                                               @D14CDVB 01317007
FPFXERR  LA    R5,56               ERROR DURING PFIX           @D51KDMZ 01318007
         B     FPGMTAB             --->                        @D51KDMZ 01319007
         SPACE 1                                                        01320007
FRMODERR LA    R5,64               LP / RMODE MISMATCH         @D52VDMZ 01321007
         B     FPGMTAB             --->                        @D52VDMZ 01322007
         SPACE 1                                                        01323007
*-------------------------------------------------------------*@D149DVB 01324007
         SPACE 1                                               @D14CDVB 01325007
FPGMLKER LR    R5,RF               SAVE RC                     @D14CDVB 01326007
         MVI   DFWKRCOD,NVALIB12   SET ERROR RETURN CODE       @D14CDVB 01327007
BRPGMLNK B     BRPGMLNK(RF)                                    @D14CDVB 01328007
         B     FPGMHWT             4 : N/A                     @D14CDVB 01329007
         B     FLNKERLB            8 : UNRECOVERABLE ERROR     @D14CDVB 01330007
         B     FPGMHWT             12: INVALID  INPUT          @D14CDVB 01331007
         SPACE 1                                               @D14CDVB 01332007
FLNKERLB EQU   *                                               @D14CDVB 01333007
         L     R2,LINKNAME         ADDR ( VIO_LINK)            @D14CDVB 01334007
         ST    R2,DFWKALIB         ... INTO                    @D14CDVB 01335007
         ST    R2,DFWKASLB         ... FCHWORK                 @D14CDVB 01336007
         B     FPGMEREX            ---->                       @D14CDVB 01337007
         SPACE 1                                               @D14CDVB 01338007
*-------------------------------------------------------------*@D14CDVB 01339007
         SPACE 1                                                        01340007
DGETSAB  DC    A(DBASTXT)          STANDARD SAVE AREA                   01341007
FMASK    DC    XL4'0103070F'       MASK FOR ICM/STCM                    01342007
         SPACE 1                                                        01343007
*-------------------------------------------------------------*@D14CDVB 01344007
         EJECT                                                          01345007
*-------------------------------------------------------------*         01346007
*        PROLOGUE:     RELADDR                                          01347007
*        ROUTINE NAME: RELADDR                                          01348007
*        MACRO:        SGBFCH                                           01349007
*        FUNCTION:     RELOCATES THE ADDRESS CONSTANTS OF THE           01350007
*                      REQUESTED PHASE.                                 01351007
*                      MUST BE EXECUTED PARTIALLY IN AMODE 31, TO       01352007
*                      RELOCATE ADDRESS CONSTANSTS ABOVE 16 MB.         01353007
*                      SETS UP READ FOR RLD ITEMS IF REQUIRED.          01354007
*                      THE RELOCATION IS ONLY PERFORMED FOR             01355007
*                      SUCH ADDRESS CONSTANTS LOCATED IN THE            01356007
*                      THE ADDRESS SPACE ALREADY READ IN.               01357007
*        CALLER:       FGTTEXT ( PROGRAM FETCH )                        01358007
*        OPERATION: DO WHILE RLD_SWITCH = ON                   @D149DVB 01359007
*                      IF RLD BUFFER EMPTY                     @D149DVB 01360007
*                         THEN READ NEXT RLD_LB                @D149DVB 01361007
*                         INITIALIZE RLD_ADDRESS               @D149DVB 01362007
*                      ENDIF                                   @D149DVB 01363007
*                      IF RLD_ITEM EXISTS                      @D149DVB 01364007
*                         THEN RELOCATE ADDRESS(RLD_ITEM)      @D149DVB 01365007
*                         IF ADDRESS ALREADY READ_IN           @D149DVB 01366007
*                            THEN RELOCATE ADDRESS_CONSTANT    @D149DVB 01367007
*                         ENDIF                                @D149DVB 01368007
*                         ELSE RLD_SWITCH = OFF                @D149DVB 01369007
*                      ENDIF                                   @D149DVB 01370007
*                    ENDO                                      @D149DVB 01371007
*                    RETURN;                                   @D149DVB 01372007
*        INPUT:        FCHWORK ( #(RLDS) NOT PROCESSED,                 01373007
*                                @(NEXT RLD),RELOCATION FACTOR )        01374007
*                      FICB ( @(FDIRBUF) )                              01375007
*        OUTPUT:       RELOCATED ADDRESS CONSTANTS.                     01376007
*                      R15   RETURN CODE                       @D149DVB 01377007
*        CALLED ROUTINES:                                               01378007
*                      FREAD                                            01379007
*        RETURN:       CALLER                                           01380007
*        ERROR EXITS:  NONE                                             01381007
*        REFERENCED DATA:                                               01382007
*                      FCHWORK (UPDATE)                                 01383007
*                      FICB (READ)                                      01384007
*-------------------------------------------------------------*         01385007
         SPACE 1                                                        01386007
*SGLINK  RELADDR,INPUT=(R8,R9,RB),WORK=(R0,R1,R2,R3,R4,R5,R6),         *01387007
               OUTPUT=(RF)                                     @D14CDVB 01388007
         SPACE 1                                               @D369DVB 01389007
RELADDR  DS    0H                  ENTRY POINT                          01390007
         SR    R2,R2               CLEAR REGISTER              @DA35913 01391007
         ICM   R2,3,PFWKPRLD       GET NUMBER OF NOT YET PROC. @DA35913 01392007
*        LH    R2,PFWKPRLD         GET NUMBER OF RLDS ITEMS NOT YET     01393007
*                                     PROCESSED                @D36JDVB 01394007
         LTR   R2,R2               ALL PROCESSED                        01395007
         BZR   LINK1               =====>  YES : RETURN        @D14CDVB 01396007
         L     R3,PFWKNRLD         GET ADDRESS OF NEXT RLD     @D36JDVB 01397007
         L     R5,PFWKRELF         GET RELOCATION FACTOR       @D36JDVB 01398007
         SPACE 1                                                        01399007
         SPACE 1                                                        01400007
FRADD00  L     R4,PFENDRLD         ADDRESS OF END OF RLD-BUF   @D14CDVB 01401007
         CLR   R3,R4               GREATER THEN END OF FDIRBUF          01402007
         BL    FRADD10             NO --->                              01403007
         SPACE 1                                                        01404007
*---- READ NEXT RLD BLOCK ------------------------------------*@D149DVB 01405007
         SPACE 1                                                        01406007
* SWITCH BACK TO AMODE 24. AMODE 31 MAY CAUSE PROBLEMS.                 01407007
         L     R3,PFBEGRLD         SET POINTER TO NEXT RLD     @D14CDVB 01408007
         ST    R3,PFWKNRLD           AND STORE IT              @D36JDVB 01409007
         L     R1,DSRPLRLD         GET RPL POINTER                      01410007
*SGLINK  FPGMREAD,INPUT=(R1,R7,R9,RA,RB,RD),OUTPUT=(R1,RF),WORK=(RE)    01411007
         BAL   LINK2,FPGMREAD      REQUEST NEXT RLD BLOCK               01412007
         SPACE 1                                                        01413007
*---- GET USERS ADCON ----------------------------------------*@D149DVB 01414007
         SPACE 1                                                        01415007
FRADD10  L     R4,D0(R3)           GET RLD ITEM                         01416007
         LTR   R4,R4               CHECK IF REAL ITEM                   01417007
         BNZ   FRADD20             YES --->                             01418007
         LR    R2,R4               RESET RLD COUNTER TO ZERO TO STOP    01419007
         B     FRADD60                       FURTHER RELOCATION         01420007
FRADD20  DS    0H                                              @D52VDMZ 01421007
         LR    R1,R4               GET RLD ITEM IN R1          @D52VDMZ 01422007
         N     R1,ADDRMSK          CLEAR FLAG BYTE             @D52VDMZ 01423007
         ALR   R1,R5               RELOCATE ADCON POINTER               01424007
         SRL   R4,L27              GET OBJECT LENGTH OF ADCON           01425007
         IC    R6,FMASK(R4)         AND GET RELATED MASK FOR           &01426007
                                    STM / ICM INSTRUCTIONS              01427007
         ALR   R4,R1               GET END ADDRESS OF ADCON             01428007
         CL    R4,DFWKLPNT         CHECK IF ...                @D14CDVB 01429007
         BL    FRADDERR              ...RLD ITEM POINTS        @D14CDVB 01430007
         CL    R4,PFWKETXT           ...OUTSIDE THE PHASE      @D14CDVB 01431007
         BNL   FRADDERR              ...--->  ERROR            @D14CDVB 01432007
         CL    R4,PFWKMTXT         IS ADCON ALREADY LOADED     @D36JDVB 01433007
         BNL   FRADD50             NO --->                              01434007
         SPACE 1                                                        01435007
*---- RELOCATE USERS ADCON  ----------------------------------*@D149DVB 01436007
         SPACE 1                                                        01437007
         EX    R6,FIADCON          GET USERS ADCON                      01438007
PCKADR1F EQU   *                   PROGRAM CHECK IF INVALID             01439007
         LR    R0,R5               PROVIDE RELOCATION FACTOR            01440007
         TM    D0(R3),FRLDADD      CHECK FOR ADD                        01441007
         BZ    FRADD30             YES --->                             01442007
         LCR   R0,R0               SET RELOC FACTOR NEGATIVE            01443007
FRADD30  ALR   R4,R0               RELOCATE  ADCON                      01444007
         EX    R6,FSADCON          STORE RELOCATED ADCON                01445007
         LA    R3,D4(R3)           BUMP TO NEXT RLD ITEM                01446007
         BCT   R2,FRADD00          REPEAT IF MORE RLDS                  01447007
FRADD50  ST    R3,PFWKNRLD         STORE POINTER TO NEXT RLD   @D36JDVB 01448007
FRADD60  STH   R2,PFWKPRLD         SAVE REMAINING RLD COUNTER  @D36JDVB 01449007
         B     FRADDEXT            =====>     RETURN           @D52VDMZ 01450007
         SPACE 1                                                        01451007
FRADDERR LA    RF,36               INTERNAL RETURN CODE        @D14CDVB 01452007
FRADDEXT DS    0H                                              @D52VDMZ 01453007
         BR    LINK1               =====>  ERROR EXIT:                 *01454007
                                             INVALID ADDRESS   @D14CDVB 01455007
         SPACE 1                                                        01456007
*-------------------------------------------------------------*@D149DVB 01457007
FIADCON  ICM   R4,M0,D0(R1)        INSERT USER ADCON                    01458007
FSADCON  STCM  R4,M0,D0(R1)        RESTORE RELOCATED ADCON              01459007
         DROP  R9,RA,RB                                        @D14CDVB 01460007
         SPACE 1                                                        01461007
*-------------------------------------------------------------*@D149DVB 01462007
 TITLE 'DOS SUPERVISOR     SGBFCH    I/O_LAYER                ** 94/03/*01463007
               10 **'                                          @D52VDMZ 01464007
*-------------------------------------------------------------*         01465007
*        PROLOGUE :    FREAD                                            01466007
*        ROUTINE NAME: FREAD ( I/O LAYER )                              01467007
*        MACRO:        SGBFCH                                           01468007
*        FUNCTION:     PERFORMS THE I/O REQUEST OR PROVIDES A           01469007
*                      FRPL. THE I/O REQUEST IS DETERMINED BY A         01470007
*                      FRPL (EITHER DIRECTORY/RLD BLOCK IN THE          01471007
*                      FDIRBUF OR TEXT INTO REQUESTOR'S SPACE)          01472007
*        CALLER:       SCANDIR, RELADDR, FGETTXT                        01473007
*        OPERATION:                                                     01474007
*                SELECT                                        @D149DVB 01475007
*                  WHEN REQUEST_ID =  BUILD DO:                @D149DVB 01476007
*                    CALL FEXTTAB  / ADDR(EXTTAB,DEVTAB) /     @D149DVB 01477007
*                    GET DEVICE_TABLE                          @D149DVB 01478007
*                    INITIALIZE THE FRPL                       @D149DVB 01479007
*                    PROVIDE ADDR(FRPL)                        @D149DVB 01480007
*                  WHEN REQUEST_ID =  DIR DO:                  @D149DVB 01481007
*                    GET ACTUAL RBA                            @D149DVB 01482007
*                    IF 1RST DIR_REQUEST                       @D149DVB 01483007
*                      THEN CALL SCANSLD   / PROVIDE RBA /     @D149DVB 01484007
*                    ENDIF                                     @D149DVB 01485007
*                    SELECT_DIR                                @D149DVB 01486007
*                      WHEN PHASE NOT FOUND                    @D149DVB 01487007
*                         THEN RC = ¬ FOUND AND RETURN         @D149DVB 01488007
*                      WHEN SLD INVALID                        @D149DVB 01489007
*                         THEN GET NUMBER OF INDEX LEVELS      @D149DVB 01490007
*                         GET RBA (INDEX)                      @D149DVB 01491007
*                         DO WHILE INDEX NUMBER > 1 AND ¬EOS   @D149DVB 01492007
*                            CALL REQIO (RBA)                  @D149DVB 01493007
*                            CALL SCANLIB /POSTS END_OF_SEARCH/@D149DVB 01494007
*                            GET RBA (NEXT LOWER INDEX LEVEL)  @D149DVB 01495007
*                            REDUCE INED NUMBER                @D149DVB 01496007
*                         ENDDO                                @D149DVB 01497007
*                      WHEN SLD VALID THEN GET RBA (DIR        @D149DVB 01498007
*                    ENDSELECT_DIR                             @D149DVB 01499007
*                    CALL FEXTTAB (RBA)                        @D149DVB 01500007
*                    CALL REQIO          / READ DIR_LB /       @D149DVB 01501007
*                  WHEN REQUEST_ID  = RLD   DO:                @D149DVB 01502007
*                    IF 1RST RLD REQUEST                       @D149DVB 01503007
*                      THEN PROVIDE RBA(FIRST RLD_ITEM)        @D149DVB 01504007
*                    ENDIF                                     @D149DVB 01505007
*                    CALL FEXTTAB  / ADDR(DEVTAB,EXTTAB)     / @D149DVB 01506007
*                    CALL FEXTTXT  / ADDR(EXXTAB_TXT)        / @D149DVB 01507007
*                    IF TXT_IO = ¬DONE                         @D149DVB 01508007
*                      AND TXT_RBA SAME DEVICE AS RLD_RBA      @D149DVB 01509007
*                         THEN  SET DELAYED-RLD_IO             @D149DVB 01510007
*                           CALL REQDSK                        @D149DVB 01511007
*                         ELSE  CALL REQIO      / READ RLD_LB/ @D149DVB 01512007
*                    ENDIF                                     @D149DVB 01513007
*                  WHEN REQUEST_ID  = TXT  DO:                 @D149DVB 01514007
*                    IF 1RST TXT REQUEST                       @D149DVB 01515007
*                      THEN PROVIDE RBA(FIRST TXT_LB)          @D149DVB 01516007
*                    ENDIF                                     @D149DVB 01517007
*                    CALL FEXTTAB    / ADDR(DEVTAB,EXTTAB)   / @D149DVB 01518007
*                    DO WHILE TXT_REQUEST NOT YET PROCESSED    @D149DVB 01519007
*                      CALL CREAGEN  / ADDR_RANGE OF CCW_AREA/ @D149DVB 01520007
*                      DO WHILE CCW_AREA = ¬ FULL              @D149DVB 01521007
*                        CALL REQCCW   / ADDR OF NEXT CCW    / @D149DVB 01522007
*                        GENERATE CCW                          @D149DVB 01523007
*                        IF 370_MODE AND NOT_REAL_MODE         @D149DVB 01524007
*                          THEN IF IDAL REQUIRED               @D149DVB 01525007
*                           THEN CALL REQIDAL                  @D149DVB 01526007
*                           SET IDAL BIT AND ADDR (IDAL)       @D149DVB 01527007
*                           LRA (READ_IN_AREA) FOR IDAWS       @D149DVB 01528007
*                          ELSE  LRA READ_IN_AREA FOR CCW      @D149DVB 01529007
*                        ENDIF                                 @D149DVB 01530007
*                      ENDO                                    @D149DVB 01531007
*                      IF LAST TXT_LB PROCESSING               @D149DVB 01532007
*                         THEN IF LEN(LAST TXT LB) < LEN(LBCIF)@D149DVB 01533007
*                               THEN CALL REQLBLK              @D149DVB 01534007
*                               ELSE CALL REQFBA               @D149DVB 01535007
*                               SET LEN_CCW (FRPLLBL)          @D149DVB 01536007
*                              ENDIF                           @D149DVB 01537007
*                         ELSE                                 @D149DVB 01538007
*                      ENDIF                                   @D149DVB 01539007
*                      IF DELAYED_RLD_IO                       @D149DVB 01540007
*                         THEN  CHAIN RLD_CCW PROGRAM          @D149DVB 01541007
*                         RESET DELAYED_RLD_IO                 @D149DVB 01542007
*                      ENDIF                                   @D149DVB 01543007
*                      CALL REQIO                              @D149DVB 01544007
*                    ENDDO                                     @D149DVB 01545007
*                ENDSELECT                                     @D149DVB 01546007
*                END;                                          @D149DVB 01547007
*        INPUT:        REG 1 : ADDR OF FRPL OR PARAMETER       @D149DVB 01548007
*                                             ID =  0 BUILD    @D149DVB 01549007
*                                             ID =  4 TEXT     @D149DVB 01550007
*                                             ID =  8 RLD      @D149DVB 01551007
*                                             ID =  12 DIR     @D149DVB 01552007
*        OUTPUT:       READ AND / OR                                    01553007
*                      RETURN CODE                                      01554007
*        CALLED ROUTINES:                                               01555007
*                      REQIO, SETSCTR, CREAGEN, SCANSLD        @D149DVB 01556007
*                      SCANLIB, REQIDAL, FEXTTAB, REQDSK       @D149DVB 01557007
*        RETURN:       CALLER                                           01558007
*        ERROR EXITS:  NONE                                             01559007
*        REFERENCED DATA:                                               01560007
*                      DEVTAB, EXTTAB (READ,EXTERNAL)          @D149DVB 01561007
*                      CHAIN (READ)                                     01562007
*                      FICB, FRPL, FCHWORK (UPDATE)                     01563007
*-------------------------------------------------------------*         01564007
         SPACE 2                                                        01565007
*-------------------------------------------------------------*         01566007
*        MODULE ENTRY CODE                                    *         01567007
*-------------------------------------------------------------*         01568007
         SPACE 1                                                        01569007
*SGLINK  FREAD,INPUT=(R1,RA,RB,RD,RE),OUTPUT=(R1,RF)           @D369DVB 01570007
         SPACE 1                                                        01571007
         DS    0F                                              @D21ZDVB 01572007
         DC    CL8'FREAD   '                                   @D14CDVB 01573007
         DC    CL8'94/03/10'                                   @D61NDVB 01574007
FREAD    DS    0H                                                       01575007
         SLR   RF,RF               SET RETURN CODE TO ZERO     @D367DVB 01576007
         STM   RE,RC,ORG14(RD)     SAVE REGS IN PROVIDED S-AREA@D367DVB 01577007
         BALR  R9,0                LOAD BASE                            01578007
         USING *,R9                )               <- BASE              01579007
         LA    R9,0(,R9)           CLEAR 1ST BYTE, BECAUSE OF SWITCH   *01580007
                                   TO AMODE 31                 @D52VDMZ 01581007
         USING DFCB,RB             )  ESTABLISH    <- DATA AREA@D36IDVB 01582007
         USING TCBADR,RA           ) ADDRESSIBILTY <- TCB=10   @D36IDVB 01583007
FREADBS  L     R2,ONXTSA(RD)       GET ADDR (NEXT SAVE_AREA)   @D14CDVB 01584007
         ST    RD,OPRESA(R2)       SAVE ADDR(CURRENT SAVE_AREA)@D14CDVB 01585007
         LR    RD,R2               ESTABLISH MODULE SAVE_AREA  @D14CDVB 01586007
         ST    RF,ORG15(,RD)       RC = 0 IN MODULE SAVE AREA  @D21ZDVB 01587007
         SPACE 1                                                        01588007
*--- CHECK FRPL  ---------------------------------------------*@D149DVB 01589007
         SPACE 1                                                        01590007
         USING INLCLDTE,R4                                     @D14CDVB 01591007
         USING INLCEDTE,R3                                     @D14CDVB 01592007
         USING INLCDDTE,R2         ESTABLISH DEVTAB DSECT      @D14CDVB 01593007
         USING DRPL,R1             ESTABLISH FRPL DSECT                 01594007
         ST    R1,ORG1(RD)         )                           @D365DVB 01595007
         LH    R7,DRPLID           GET FRPL REQUEST TYPE                01596007
         B     FRDTAB(R7)                                               01597007
FRDTAB   B     FRDBUILD            REQUEST FOR BUILD           @D14CDVB 01598007
         B     FRDTXT              REQUEST FOR TEXT                     01599007
         B     FRDRLD              REQUEST FOR RLD BLOCK                01600007
         B     FRDDIR              REQUEST FOR DIRECTORY BLOCK          01601007
         SPACE 1                                                        01602007
*-------------------------------------------------------------*@D149DVB 01603007
         EJECT                                                          01604007
*-------------------------------------------------------------*         01605007
*        ERROR EXITS OF ROUTINE FREAD                         *         01606007
*-------------------------------------------------------------*         01607007
         SPACE 1                                                        01608007
         DS    0H                                                       01609007
FDIRNTFD LA    RF,32               INDICATE NOT_FOUND RC=32    @D14CDVB 01610007
         B     FRDERRZ             --->                        @D14CDVB 01611007
FRDERR44 DS    0H                                              @D61NDVB 01612007
*        SGCOV FETCHS,MC=32        LIBID MISMATCH / LIB UPDATE @D61NDVB 01613007
         SGCOV FETCHS,MC=32                                    @D61NDVB 01614007
         LA    RF,44               RC = 44  ID MISMATCH        @D14CDHD 01615007
         B     FRDERRZ                                         @D14CDHD 01616007
FRDERR48 LA    RF,48               RC = 48  INTERNAL ERROR     @D14CDHD 01617007
         B     FRDERRZ                                         @D14CDHD 01618007
FRDERR28 LA    RF,4                RC = 28                     @D14CDBC 01619007
FRDERR24 LA    RF,4(RF)            RC = 24                     @D14CDVB 01620007
FRDERR20 LA    RF,4(RF)            RC = 20                     @D14CDVB 01621007
FRDERRX  LA    RF,16(RF)           RC = 16 -- TFIX INTERFACE   @D14CDVB 01622007
FRDERRZ  L     RD,OPRESA(RD)       REQUESTORS SAVE AREA ADDR   @D14CDVB 01623007
         ST    RF,ORG15(RD)        RC INTO REQUESTORS SA       @D14CDVB 01624007
         LM    RE,RC,ORG14(RD)     RELOAD REGISTERS            @D14CDVB 01625007
*        AMODESW RETURN,REG=(RE)   ==========>  RETURN         @D64ADVB 01626007
         AMODESW RETURN,REG=(RE)   ==========>  RETURN         @D64ADVB 01627007
         SPACE 2                                                        01628007
*-------------------------------------------------------------*         01629007
*        MODULE EXIT CODE                                     *         01630007
*-------------------------------------------------------------*         01631007
         SPACE 2                                                        01632007
FRDEXIT  DS    0H                                                       01633007
         L     RD,OPRESA(RD)       RESTORE SAVE AREA POINTER   @D367DVB 01634007
FRDEXT1  EQU   *                                                        01635007
         LM    RE,RC,ORG14(RD)     RELOAD REGISTERS            @D367DVB 01636007
*        AMODESW RETURN,REG=(RE)   ==========>  RETURN         @D64ADVB 01637007
         AMODESW RETURN,REG=(RE)   ==========>  RETURN         @D64ADVB 01638007
         SPACE 2                                                        01639007
*-------------------------------------------------------------*         01640007
         EJECT                                                          01641007
*-------------------------------------------------------------*         01642007
*     FRPL BUILD REQUEST                                      *@D149DVB 01643007
*-------------------------------------------------------------*         01644007
         SPACE 2                                                        01645007
FRDBUILD DS    0H                  ENTRY POINT                          01646007
         SLR   R0,R0                                           @D14CDVB 01647007
         BAL   LINK1,FEXTBLD                                   @D14CDVB 01648007
*---*    L     R4,DFWKALIB         ADDR (LIB_DEF_TAB)                  *01649007
                  ====================> DO NOT DESTROY R4 ===> @D14CDVB 01650007
*                                                              @D14CDHD 01651007
*  ESTABLISH ADDRESSABILITY TO THE FRPL INITIALIZATION TABLE   @D14CDHD 01652007
*                                                              @D14CDHD 01653007
         L     R7,DRPLID                                       @D14CDVB 01654007
         L     R1,FRPLTAB(R7)      GET RELATED FRPL ADDRESS AND        *01655007
                                     USE STANDARD DSECT        @D14CDVB 01656007
         SL    R7,F4               FRPLID - 4                  @D14CDHD 01657007
         SRL   R7,2                   : 4                      @D61NDVB 01658007
         MH    R7,FTBENTRY            * LENGTH OF ENTRY        @D61NDVB 01659007
*                                  = OFFS. OF DEVTYPE IN TABENT@D61NDVB 01660007
         LR    R5,RF                                           @D14CDHD 01661007
         IC    R5,DDTEDEV          GETVCE CODE                 @D14CDVB 01662007
         ALR   R5,R5                  * 2                      @D14CDVB 01663007
         ALR   R5,R5                  * 2                      @D14CDVB 01664007
         L     R5,FTBDEV(R5)       ADDRESS OF DEV_TAB          @D14CDVB 01665007
         ALR   R5,R7                  + FRPLID =: ENTRY ADDRESS@D14CDVB 01666007
*                                  = ADDRESS OF SELECTED TABENT@D61NDVB 01667007
         USING FTBACCW,R5                                      @D14CDVB 01668007
         SPACE 1                                                        01669007
*--- INITIALIZE THE FRPL -------------------------------------*@D149DVB 01670007
         SPACE 1                                                        01671007
FRDBD13  STH   RF,DRPPHBL          INIT OP_CODE AND FBA_EXPON. @D14CDVB 01672007
         ST    RF,DRPLADA          CLEAR RBA FIELD             @D14CDVB 01673007
         LH    R0,FTBACCW          OFFSET OF CCW PROGRAM...    @D14CDVB 01674007
         STH   R0,DRPOCCW                     ... INTO FRPL    @D14CDVB 01675007
         MVI   DRPNRC+1,1          NUMBER OF REQ RECORDS = 1   @D14CDVB 01676007
         IC    RF,LDTELBSZ         L' LB OUT OF LIB_DEF_TAB    @D14CDVB 01677007
         LA    R0,1                PROVIDE REAL...             @D14CDVB 01678007
         SLL   R0,0(RF)            ... LB LENGTH...            @D14CDVB 01679007
         STH   R0,DRPLNLB          ==> L(PHYS_BLOCK)           @D14CDVB 01680007
         LA    R6,MAXLENLB         MAXIMAL SUPPORTED LB_LEN... @D14CDVB 01681007
         CLR   R0,R6               ... LESS THAN L(PHYS_BLOCK) @D14CDVB 01682007
         BH    FRDERRX             =====>    ERROR             @D14CDVB 01683007
         L     R6,FTBAMOD          ADDR OF GEN_MODEL / READ CCW@D14CDVB 01684007
         STH   R0,CCWLNG-CCWADR(R6) LENGTH INTO MODEL/READ CCW @D14CDVB 01685007
         SH    R0,LDTELBCF         - L(LBCIF)                  @D14CDVB 01686007
         STH   R0,DRPLGRL          ==> L(LOG-RECORD)           @D14CDVB 01687007
         AL    R0,DRPLINP          + ADDR (INPUT AREA)         @D14CDVB 01688007
         ST    R0,DRPLCIF          ==> ADDR(CIF)               @D14CDVB 01689007
         L     R7,FTBADEXT         ADDRESS OF DEF-EXT DATA/SEEK@D61NDVB 01690007
         ST    R7,DRPADEXT                 ... IN RPL          @D61NDVB 01691007
         L     R7,FTBADCHR         ADDRESS OF SEARCH           @D61NDVB 01692007
         ST    R7,DRPACHR                  ... IN RPL          @D61NDVB 01693007
         L     R7,FTBADLOC         ADDRESS OF LOCATE           @D61NDVB 01694007
         ST    R7,DRPALOC                  ... IN RPL          @D61NDVB 01695007
         CLI   DDTEDEV,AVRECKD     REQUEST FOR ECKD DEVICE     @D61NDVB 01696007
         BE    FRDBD20             YES --->                    @D61NDVB 01697007
         CLI   DDTEDEV,AVRFBA      REQUEST FOR FBM DEVICE      @D14CDVB 01698007
         BE    FRDBD15             YES --->                    @D61NDVB 01699007
         L     R7,FTBADBBC                                     @D61NDVB 01700007
         SLR   R0,R0               CLEAR BBCC                  @D61NDVB 01701007
         ST    R0,0(,R7)           ....        IN RPL          @D61NDVB 01702007
         B     FRDBD20                                         @D61NDVB 01703007
FRDBD15  L     R7,DDTEBLZ          PHYSICAL BLOCKSIZE FOR FBM  @D14CDVB 01704007
         SRL   R7,10                                           @D14CDVB 01705007
         IC    R7,FSHIFTAB-DFCB(RB,R7) SHIFT VALUE OF BLKSIZE  @D14CDVB 01706007
         SLR   RF,R7               2** AS MULTIPLIER FOR FBM...@D14CDVB 01707007
         STC   RF,DRPPHBL          .....INTO FRPL              @D14CDVB 01708007
FRDBD20  CLI   DRPLID+1,TXTRQID    TXT PROCESSING              @D14CDVB 01709007
         BNE   FRDBD30             NO  --->                    @D14CDVB 01710007
         ST    R6,DRPLAGM          ADDR(GEN_MOD) INTO FRPL     @D14CDVB 01711007
         OI    DFCBSW3,TXTIOPND    INDICATE TXT_I/O_PENDING    @D64ADVB 01712007
         LH    R0,FTBFLAG          SPECIAL INFORMATION...      @D14CDVB 01713007
         STH   R0,DRPLFLG                                      @D14CDVB 01714007
*                                                              @D14CDHD 01715007
*  PROVIDE ADDR(TIC FSTCCW) INTO FRPL                          @D14CDHD 01716007
*                                                              @D14CDHD 01717007
         L     R7,FTBVADR                                      @D14CDVB 01718007
         ST    R7,DRPLTIC                                      @D14CDVB 01719007
*                                                              @D14CDHD 01720007
         DROP  R5                                              @D14CDVB 01721007
         L     R0,PFSTDBEG         END_ADDR(RLD_BUFFER)        @D14CDVB 01722007
         SH    R0,LDTELBCF         - LEN(LBCF)                 @D14CDVB 01723007
         ST    R0,PFENDRLD         =: END_ADDR(RLD ITEMS)      @D14CDVB 01724007
         LA    R5,2                MAXIMUM NUMBER OF PAGES AFFECTED    *01725007
                                   ... BY ONE LB               @D14CDVB 01726007
         LH    R7,DRPLNLB                                      @D14CDVB 01727007
         CL    R7,PAGESIZE         LEN (LB) <  PAGESIZE        @D14CDVB 01728007
         BNH   FRDBD25             YES --->                    @D14CDVB 01729007
         LA    R5,1(R5)            ADJUST MAX_NUMBER OF IDAW_S @D14CDVB 01730007
FRDBD25  STH   R5,DRPNIDAW         ...                         @D14CDVB 01731007
         ALR   R5,R5                                           @D14CDVB 01732007
         ALR   R5,R5               * 4                         @D14CDVB 01733007
         STH   R5,DRPLIDAL         LENGTH OF IDAW_LIST         @D14CDVB 01734007
FRDBD30  L     RD,OPRESA(RD)       REQUESTORS SAVE AREA ADDRESS@D14CDVB 01735007
         ST    R1,ORG1(RD)         RETURN ADDR(FRPL)           @D14CDVB 01736007
         B     FRDEXT1             =====>                      @D14CDVB 01737007
         DROP  R4     <=================== R4 AVAILABLE =====< @D14CDVB 01738007
         SPACE 1                                                        01739007
*-------------------------------------------------------------*@D14CDVB 01740007
         EJECT                                                 @D14CDVB 01741007
*-------------------------------------------------------------*         01742007
*        READ DIRECTORY BLOCK                                           01743007
*-------------------------------------------------------------*         01744007
         SPACE 1                                                        01745007
         USING INLCLDTE,R4                                     @D14CDVB 01746007
FRDDIR   DS    0H                                                       01747007
         LA    RE,DFICBR                                       @D14CDVB 01748007
         LH    R5,DRPOCCW          PROVIDE ADDRESS...          @D14CDVB 01749007
         LA    R5,FCCWDIR(R5)      ...OF CCW PROGRAM...        @D14CDVB 01750007
         ST    R5,DFICBCCW(RE)     ...INTO CCB                 @D14CDVB 01751007
         L     R0,DRPLADA          GET RBA                     @D14CDVB 01752007
         LTR   R0,R0               ALREADY INITIALIZED?        @D14CDVB 01753007
         BNZ   FDIR080             YES -->                     @D14CDVB 01754007
         SPACE 1                                               @D149DVB 01755007
*---- SCAN SLD   ----------------------------------------------@D149DVB 01756007
         SPACE 1                                               @D149DVB 01757007
*SGLINK  SCANSLD,INPUT=(R2,R3,R8,R9,RB),WORK=(R0,R6,R7),               *01758007
               OUTPUT=(R5)                                     @D14CDVB 01759007
         BAL   LINK1,SCANSLD       SCAN SECOND LEVEL DIRECTORY         *01760007
                                   ... AND GET DISK ADDRESS    @D14CDVB 01761007
         B     FDIR080             SUCCESSFULL                 @D14CDVB 01762007
*---->   B     FDIR010             NOT FOUND --> DIR. SEARCH   @D14CDVB 01763007
         SPACE 1                                               @D149DVB 01764007
*---- SCAN INDEX ----------------------------------------------@D149DVB 01765007
         SPACE 1                                               @D149DVB 01766007
FDIR010  EQU   *                                               @D14CDVB 01767007
         USING INLCSDTE,R5         ADDRESSIBILITY TO SUBLIB    @D14CDVB 01768007
         SLR   R6,R6                                           @D14CDVB 01769007
         IC    R6,SDTEXLEV         NUMBER OF INDEX_LEVELS INCLUDING    *01770007
                                   DIRECTORY ENTRY LEVEL       @D14CDVB 01771007
         DROP  R5                                              @D14CDVB 01772007
         SPACE 1                                               @D14CDVB 01773007
FDIR020  BCTR  R6,0                REDUCE NUMBER OF HIGHER...          *01774007
                                   ...INDEX LEVELS             @D14CDVB 01775007
FDIR025  LTR   R6,R6               ANY MORE INDEX LEVELS       @D14CDVB 01776007
         BNP   FDIR080             ALL PROCESSED --->          @D14CDVB 01777007
FDIR030  BAL   LINK1,FEXTTAB       PROVIDE ADDR (EXTTAB)       @D14CDVB 01778007
         LA    RE,DFICBR                                       @D14CDVB 01779007
*SGLINK  REQIO,INPUT=(R1,R8,R9,RD,RE),OUTPUT=(RF),WORK=(R0)    @D149DVB 01780007
         BAL   LINK1,REQIO         PERFORM I/O                 @D14CDVB 01781007
         LTR   RF,RF               ANY ERROR                   @D14CDVB 01782007
         BNZ   FDIRERR             YES --> (TRY TO RESTART )   @D14CDVB 01783007
         BAL   LINK1,CHECKID       IF ID'S MATCH THEN          @D14CDHD 01784007
         LA    R0,DENTEHLX         SEARCH_TYPE = INDEX         @D14CDVB 01785007
         L     RF,DASCNLIB         ENTRY POINT OF SCANLIB ROUT @D14CDVB 01786007
         BALR  RE,RF               SCAN                        @D14CDVB 01787007
         B     FDIRTABX(RF)        BR_TAB FOR RETURN CODES     @D14CDVB 01788007
FDIRTABX B     FDIR070             ENTRY FOUND IN LB           @D14CDVB 01789007
         B     FDIRNTFD            NOT FOUND                   @D14CDVB 01790007
         B     FDIR030             NEXT BLOCK ON SAME LEVEL    @D14CDVB 01791007
         B     FDIR070             ENTRY FOUND IN LB           @D14CDVB 01792007
         B     FRDERR28            ERROR EXIT --->             @D14CDVB 01793007
         B     FRDERR48            FETCH INTERNAL ERROR        @D14CDHD 01794007
         USING INLCMBRX,R5                                     @D14CDVB 01795007
FDIR070  L     R0,MBRXLBBN         PRBA TO NEXT LOWER INDEX OR         *01796007
                                   ...DIRECTORY LEVEL          @D14CDVB 01797007
         ST    R0,DRPLADA          ...INTO FRPL                @D14CDVB 01798007
         B     FDIR020             REPEAT ON NEXT LOWER INDEX...       *01799007
                                   ...LEVEL  (IF ANY)          @D14CDVB 01800007
         SPACE 1                                               @D149DVB 01801007
*---- READ DIRECTORY BLOCK -----------------------------------*@D149DVB 01802007
         SPACE 1                                               @D149DVB 01803007
FDIR080  BAL   LINK1,FEXTTAB       PROVIDE ADDR (EXTTAB)       @D14CDVB 01804007
         LA    RE,DFICBR                                       @D36JDVB 01805007
*SGLINK  REQIO,INPUT=(R1,R8,R9,RD,RE),OUTPUT=(RF),WORK=(R0)    @D149DVB 01806007
         BAL   LINK1,REQIO         PERFORM I/O REQUEST                  01807007
         LTR   RF,RF                                           @D14CDHD 01808007
         BNZ   FRDERRZ                                         @D21ZDVB 01809007
         BAL   LINK1,CHECKID       CHECK LIBRARY ID'S;         @D14CDHD 01810007
         B     FRDEXIT             NORMAL RETURN               @D14CDHD 01811007
         SPACE 1                                               @D149DVB 01812007
*-------------------------------------------------------------*@D149DVB 01813007
*     ERROR HANDLING FOR HIGHER INDEX:                         @D149DVB 01814007
*     ===>  RESTRICT READ OPERATIONS ON DIRECTORY ONLY         @D149DVB 01815007
*-------------------------------------------------------------*@D149DVB 01816007
         SPACE 1                                               @D149DVB 01817007
FDIRERR  SLR   RF,RF                                           @D14CDVB 01818007
         L     R2,OPRESA(RD)       RESET ...                   @D14CDVB 01819007
         ST    RF,ORG15(R2)        ... RC IN SAVE_AREA         @D14CDVB 01820007
FDIR050  L     R5,DFWKASLB         ADDR (SUBLIB DEF TAB)       @D14CDVB 01821007
         USING INLCSDTE,R5                                     @D14CDVB 01822007
         MVC   DRPLADA,SDTEDRBA+2  SCAN FROM BEGIN OF DIRECTORY@D14CDVB 01823007
         DROP  R4,R5                                           @D14CDVB 01824007
         AIF   (NOT &BGDSHR).NOSHR70                           @D14CDHD 01825007
         NI    SLDFLAG,XFF-SLDIND  RESET INDICATOR FOR DIR.    @D14CDHD*01826007
                                   BLOCK FOUND IN SLD          @D14CDHD 01827007
.NOSHR70 ANOP                                                  @D14CDHD 01828007
         B     FDIR080             ---> (DIRECTORY SCAN ONLY)  @D14CDVB 01829007
         SPACE 1                                               @D149DVB 01830007
*-------------------------------------------------------------*@D149DVB 01831007
         EJECT                                                          01832007
*                                                              @D14CDHD 01833007
***************************************************************@D14CDHD 01834007
*                                                             *@D14CDHD 01835007
*  SUBROUTINE:     C H E C K I D                              *@D14CDHD 01836007
*                                                             *@D14CDHD 01837007
*  MODUL:          SGBFCH                                     *@D14CDHD 01838007
*                                                             *@D14CDHD 01839007
*  FUNCTION:       CHECKS THE ID OF A DIRECTORY BLOCK AGAINST *@D14CDHD 01840007
*                  THE ID IN THE SUBLIB_DEF_TAB,              *@D14CDHD 01841007
*                  MAKES THE NECESSARY THINGS IF THEY MISMATCH*@D14CDHD 01842007
*                  RETURNS OTHERWISE                          *@D14CDHD 01843007
*                  CHECKS WHETHER A LB IS IN SPACE RECLAMATION*@DA36475 01844007
*                  CONTINUE WITH ID CHECK IF NOT, START WITH  *@DA36475 01845007
*                  INDEX OR SEQUENTIAL SEARCH OTHERWISE       *@DA36475 01846007
*                                                             *@D14CDHD 01847007
*  INPUT:          PFBEGDIR:   START OF DIRECTORY BLOCK       *@D14CDHD 01848007
*                  IDERR:      FLAG IN DFCBSW1                *@D14CDHD 01849007
*                              =1 INDICATES, THAT ID MISMATCH *@D14CDHD 01850007
*                                 OR FLAGGED LB OCCURRED      *@DA36475 01851007
*                                 DURING DIRECTORY READ       *@DA36475 01852007
*                              =0 OTHERWISE                   *@D14CDHD 01853007
*                                                             *@D14CDHD 01854007
*                                                             *@D14CDHD 01855007
*  OUTPUT:         IDERR:      = 1  IF ID'S MISMATCH OR       *@DA36475 01856007
*                                   FLAGGED LB AND            *@DA36475 01857007
*                                   IDERR=0 AS INPUT          *@D14CDHD 01858007
*                                                             *@D14CDHD 01859007
*  EXITS:          RETURNS TO CALLER IF LB NOT FLAGGED        *@DA36475 01860007
*                  AND ID'S MATCH                             *@DA36475 01861007
*                                                             *@D14CDHD 01862007
*                  IF LB FLAGGED, SLDIND SET AND SHARED LIB   *@DA36475 01863007
*                  - FRDERR44:  --> UPDATE SLD                *@DA36475 01864007
*                                                             *@DA36475 01865007
*                  IF LB FLAGGED, SLDIND AND IDERR NOT SET    *@DA36475 01866007
*                  - FDIR050:   THE DIRECTORY READ WILL BE    *@DA36475 01867007
*                               RESTARTED BY READING THE DIR. *@DA36475 01868007
*                               BLOCKS SEQUENTIALLY           *@DA36475 01869007
*                                                             *@DA36475 01870007
*                  IF LB FLAGGED,SLDIND SET AND LIB NOT SHARED*@DA36475 01871007
*                  - FDIR050:   THE DIRECTORY READ WILL BE    *@DA36475 01872007
*                               RESTARTED BY READING THE DIR. *@DA36475 01873007
*                               BLOCKS SEQUENTIALLY           *@DA36475 01874007
*                                                             *@DA36475 01875007
*                  IF ID'S MISMATCH AND SLDIND SET            *@D14CDHD 01876007
*                  - FRDERR44:  --> UPDATE SLD                *@D14CDHD 01877007
*                                                             *@D14CDHD 01878007
*                  IF ID'S MISMATCH AND IDERR SET             *@D14CDHD 01879007
*                  - FRDERR28:  -->'INVALID LIBRARY STRUCTURE'*@D14CDHD 01880007
*                                                             *@D14CDHD 01881007
*                  IF ID'S MISMATCH AND IDERR NOT SET         *@D14CDHD 01882007
*                  - FDIR050:   THE DIRECTORY READ WILL BE    *@D14CDHD 01883007
*                               RESTARTED BY READING THE DIR. *@D14CDHD 01884007
*                               BLOCKS SEQUENTIALLY           *@D14CDHD 01885007
*                                                             *@D14CDHD 01886007
*                                                             *@D14CDHD 01887007
*  CHANGED REGISTERS:  R2, R5, R7                             *@D14CDHD 01888007
*                                                             *@D14CDHD 01889007
*  CALLED BY:      FRDDIR                                     *@D14CDHD 01890007
*                                                             *@D14CDHD 01891007
*  CALLS ROUTINE:  NONE                                       *@D14CDHD 01892007
*                                                             *@D14CDHD 01893007
***************************************************************@D14CDHD 01894007
*                                                              @D14CDHD 01895007
CHECKID  EQU   *                                               @D14CDHD 01896007
*                                                              @D14CDHD 01897007
*  CHECK WHETHER LB IS IN SPACE RECLAMATION CHAIN              @DA36475 01898007
*                                                              @D14CDHD 01899007
         L     R7,PFBEGDIR    @START OF DIR BUFFER             @D14CDHD 01900007
         AH    R7,DRPLGRL     + OFFSET TO CONTROL INFO         @D14CDHD 01901007
         USING INLCLBCF,R7                                     @D14CDHD 01902007
         TM    LBCFFLG2,LBCFMDEL  LB IN RECLAMATION CHAIN ...  @DA36475 01903007
*                                 FOR THE PRESENT ONLY SET ... @DA36475 01904007
*                                 ON DIRECTORY LEVEL           @DA36475 01905007
         BZ    CHECKID2           NO, CONTINUE WITH ID CHECK.  @DA36475 01906007
         AIF   (NOT &BGDSHR).NOSHR74                           @DA36475 01907007
         TM    SLDFLAG,SLDIND     LB FOUND BY SLD SEARCH ?     @DA36475 01908007
         BZ    CHECKID1           NO, START SEQU. DIR SEARCH   @DA36475 01909007
         L     R5,DFWKALIB        LOAD ADDRESS OF LDT          @DA36475 01910007
         USING INLCLDTE,R5                                     @DA36475 01911007
         TM    LDTEINFO,LDTESHRD  LIBRARY ON SHARED DASD ?     @DA36475 01912007
         BO    FRDERR44           YES => UPDATE SLD ....       @DA36475 01913007
*                                        AND SCAN BY INDEX     @DA36475 01914007
.NOSHR74 ANOP                     NO DASD SHARING              @DA36475 01915007
         B     CHECKID1           NO  => SEQUENTIAL SEARCH     @DA36475 01916007
*                                                              @D14CDHD 01917007
*  CHECK ID'S AND RETURN IF THEY MATCH                         @D14CDHD 01918007
*                                                              @D14CDHD 01919007
CHECKID2 L     R7,LBCFIDEN    ID OF DIR BLOCK                  @DA36475 01920007
         DROP  R7                                              @D14CDHD 01921007
         L     R5,DFWKASLB                                     @D14CDHD 01922007
         USING INLCSDTE,R5                                     @D14CDHD 01923007
         L     R2,SDTEIDEN    ID OF SUBLIB_DEF_TAB             @D14CDHD 01924007
         DROP  R5                                              @D14CDHD 01925007
         CR    R7,R2          ID'S MATCH ?                     @D14CDHD 01926007
         BER   LINK1          YES --->  RETURN                 @D14CDHD 01927007
         AIF   (NOT &BGDSHR).NOSHR72                           @D14CDHD 01928007
*                                                              @D14CDHD 01929007
*  CHECK IF DIRECTORY BLOCK FOUND BY SLD CHECK                 @D14CDHD 01930007
*                                                              @D14CDHD 01931007
         TM    SLDFLAG,SLDIND                                  @D14CDHD 01932007
         BO    FRDERR44                                        @D14CDHD 01933007
.NOSHR72 ANOP                                                           01934007
*                                                              @D14CDHD 01935007
*  IF IDERR SET, THEN GOTO DIRIDERR                            @D14CDHD 01936007
*                                                              @D14CDHD 01937007
CHECKID1 TM    DFCBSW1,IDERR                                   @D64ADVB 01938007
         BO    FRDERR28         --->  'INVALID LIB. STRUCTURE' @D14CDHD 01939007
*                                                              @D14CDHD 01940007
*  SET IDERR AND AND READ DIRECTORY SEQUENTIALLY               @D14CDHD 01941007
*                                                              @D14CDHD 01942007
         OI    DFCBSW1,IDERR                                   @D64ADVB 01943007
         B     FDIR050           ---> SEQUENTIAL SEARCH        @D14CDHD 01944007
         EJECT                                                          01945007
*-------------------------------------------------------------*         01946007
*        READ RELOCATION (RLD)                                          01947007
*-------------------------------------------------------------*         01948007
         SPACE 1                                                        01949007
FRDRLD   EQU   *                                               @D14CDHD 01950007
         USING DRPL,R1                                         @D14CDHD 01951007
         L     R0,DRPLADA          GET DISK ADDRESS            @D14CDVB 01952007
         LTR   R0,R0               ALREADY INITIALIZED                  01953007
         BNZ   FRLD20              YES -->                     @D14CDVB 01954007
         SPACE 1                                                        01955007
* -- INITIALIZATION ------------------------------------------*         01956007
         SPACE 1                                                        01957007
         LA    R4,DFWKERDA         RLD PROCESSING              @D14CDVB 01958007
         LH    R0,0(R4)            OFFSET OF 1ST RLD           @DA33314 01959007
         CH    R0,DRPLGRL          GREATER THE LOG_RECORD LEN  @D14CDVB 01960007
         BNL   FRDERR28            =====> ERROR_28             @D14CDVB 01961007
         AL    R0,PFBEGRLD         +  BEGIN ADDR OF RLD_BUF    @D14CDVB 01962007
         ST    R0,PFWKNRLD         ADDR (1ST RLD-ITEM)         @DA33314 01963007
         L     R0,2(R4)            RBA (RLD)                   @DA33314 01964007
         LTR   R0,R0               AVAILABLE                   @D14CDVB 01965007
         BNP   FRDERR28            =====> NO: ERROR_28         @D14CDVB 01966007
         ST    R0,DRPLADA          PROVIDE RBA                 @D14CDVB 01967007
         SPACE 1                                                        01968007
* -- SET UP ADDR TO DEVTAB EXTTAB AND LIB_DEF_TAB  -----------*@D14CDVB 01969007
         SPACE 1                                                        01970007
FRLD20   BAL   LINK1,FEXTTAB       PROVIDE ADDR (EXTTAB)       @D14CDVB 01971007
FRLD30   TM    DFCBSW3,TXTIOPND    TXT_I/O STILL OUTSTANDING   @D64ADVB 01972007
         BZ    FRLD50              NO -->                               01973007
         BAL   LINK1,FEXTTXT       PROVIDE ADDR (EXTTAB(TXT))  @D14CDVB 01974007
         CLC   EDTEPUB,EDTEPUB-INLCEDTE(R4) RLD_LB AND TXT_LB...       *01975007
                                   ...ON SAME DEVICE           @D14CDVB 01976007
         BNE   FRLD50              NO -->   NO DELAYED_RLD_I/O @D14CDVB 01977007
         CLI   DDTEDEV,AVRFBA      FBM DEVICE ?                @D14CDBC 01978007
         BE    FRLD35              YES ---->                   @D61NDVB 01979007
         CLI   DDTEDEV,AVRECKD     ECKD DEVICE ?               @D61NDVB 01980007
         BNE   FRLD40              NO ----->                   @D14CDBC 01981007
FRLD35   CLR   R3,R4               SAME EXTEND ?               @D14CDBC 01982007
         BNE   FRLD50              NO --->                     @D14CDBC 01983007
FRLD40   OI    DFCBSW3,RLDIODLD    INDICATE DELAYED_RLD_I/O    @D64ADVB 01984007
         SPACE 1                                               @D149DVB 01985007
* --- PREPARE DELAYED RLD I/O --------------------------------*@D149DVB 01986007
         SPACE 1                                               @D149DVB 01987007
*SGLINK REQDSK,INPUT=(R1,R2,R3,R7,R9,RB),OUTPUT=(R6,RF),               *01988007
               WORK(R0,R4,R5,RC)                               @D61NDVB 01989007
         BAL   LINK2,REQDSK        PROVIDE DISK ADDRESS        @D14CDVB 01990007
         SPACE 1                                               @D14CDVB 01991007
         CLI   DDTEDEV,AVRRPS      IS IT RPS DEVICE ?          @D14CDVB 01992007
         BL    FRDEXIT             NO =====>                   @D52VDMZ 01993007
*SGLINK  SETSCTR,INPUT=(R2,R6,R7,R9)                           @D14CDVB 01994007
         BAL   LINK2,SETSCTR       PROVIDE SECTOR NUMBER       @D14CDVB 01995007
         B     FRDEXIT             =====>    ERROR EXIT                *01996007
                                             BRANCHED BY REQDSK@D14CDVB 01997007
         SPACE 1                                                        01998007
* --- PREPARE FOR IMMEDIATE RLD I/O --------------------------*@D14CDVB 01999007
         SPACE 1                                                        02000007
FRLD50   LH    R4,DRPOCCW          ADDR(CCW STRING) VIA FRPL   @D14CDVB 02001007
         LA    R4,FCCWRLD(R4)      ADDR (ACTUAL CCW_PROG)      @D14CDVB 02002007
         LA    RE,DFICBP           GET RELATED CCB             @D36JDVB 02003007
         ST    R4,DFICBCCW(RE)     STORE POINTER TO CCW STRING @D36JDVB 02004007
*SGLINK  REQIO,INPUT=(R1,R8,R9,RD,RE),OUTPUT=(RF),WORK=(R0)    @D149DVB 02005007
         BAL   LINK1,REQIO         PERFORM I/O                          02006007
         LTR   RF,RF                                           @D14CDHD 02007007
         BNZ   FRDEXIT                                         @D14CDHD 02008007
*                                                              @D14CDHD 02009007
*  CHECK ID OF RLD BLOCK AGAINST ID OF PHASE (IN DE)           @D14CDHD 02010007
*                                                              @D14CDHD 02011007
         L     R7,PFBEGRLD         @RLD BUFFER                 @D14CDHD 02012007
         AH    R7,DRPLGRL          @CONTROL INFO               @D14CDHD 02013007
         USING INLCLBCF,R7                                     @D14CDHD 02014007
         L     R7,LBCFIDEN         ID OF RLD BLOCK             @D14CDHD 02015007
         DROP  R7                                              @D14CDHD 02016007
         L     R0,DFWKLBID         ID OF PHASE (IN DE)         @D14CDHD 02017007
         CR    R0,R7               IF ID'S DON'T MATCH         @D14CDHD 02018007
         BNE   FRDERR44            THEN RETURN WITH RF=36      @D14CDHD 02019007
         B     FRDEXIT                                         @D14CDHD 02020007
         SPACE 1                                               @D149DVB 02021007
*-------------------------------------------------------------*@D149DVB 02022007
         SPACE 2                                                        02023007
*------------------------------------------------------------*          02024007
*        TEXT READ  (TXT)                                               02025007
*------------------------------------------------------------*          02026007
         SPACE 1                                               @D14CDVB 02027007
FRDTXT   DS    0H                                                       02028007
         USING DRPL,R1                                                  02029007
         L     R0,DRPLADA          GET DISK ADDRESS            @D14CDVB 02030007
         LTR   R0,R0               ALREADY INITIALIZED                  02031007
         BNZ   FTXT20              YES --->                    @D14CDVB 02032007
         SPACE 1                                                        02033007
*---  INITIALISATION OF DISK ADDRESS FOR TXT CCW ------------*          02034007
         SPACE 1                                                        02035007
         LA    R5,DFWKERBA         ADDRESS RBA(TXT)            @D14CDVB 02036007
         L     R0,0(R5)            PROVIDE RBA                 @DA33314 02037007
         LTR   R0,R0               AVAILABLE                   @D14CDVB 02038007
         BNP   FRDERR28            =====> NO: ERROR_28         @D14CDVB 02039007
         ST    R0,DRPLADA          ... RBA(TXT)                @DA33314 02040007
         SPACE 1                                                        02041007
* -- SET UP ADDR TO DEVTAB EXTTAB AND LIB_DEF_TAB  -----------*@D14CDVB 02042007
         SPACE 1                                                        02043007
FTXT20   BAL   LINK1,FEXTTAB       PROVIDE ADDR (EXTTAB)       @D14CDVB 02044007
         SPACE 1                                                        02045007
* --- GENERATION OF THE CCWS FOR READ-IN OF TXT --------------*         02046007
         SPACE 1                                                        02047007
FTXT30   LH    R4,DRPNRC           NUMBER OF RECORDS           @D14CDVB 02048007
         L     R5,DRPLINP          GET POINTER TO INPUT AREA   @D14CDVB 02049007
         SPACE 1                                                        02050007
* --- PROVIDE GENERATION AREA ( DO NOT DESTROY R4 OR R5 ) ----*         02051007
         SPACE 1                                                        02052007
*SGLINK  CREAGEN,INPUT=(R8,R9,RB),WORK=(RE),OUTPUT=(R0,R6,R7)  @D52VDMZ 02053007
FTXT40   BAL   LINK1,CREAGEN       PROVIDE END ADDRESS(GEN-AREA)...    *02054007
                                   ... BUILD ADD_GEN_AREA      @D14CDVB 02055007
         SPACE 1                                                        02056007
*--- CCW GENERATION LOOP ( DO NOT DESTROY R6 / R7) -----------*         02057007
         SPACE 1                                                        02058007
*SGLINK  REQCCW,INPUT=(R0,R7,R8,R9)                            @D52VDMZ 02059007
FTXT50   BAL   LINK1,REQCCW        MORE SPACE FOR CCW GENERATION        02060007
         B     FTXT240             NO ---> (PERFORM I/O AND GENERATE   *02061007
                                         NEW CCW'S AND IDAL'S) @D61NDVB 02062007
         L     R8,DRPLAGM          ADDRESS OF GENERATION MODEL @D14CDVB 02063007
         L     R0,4(R8)            )                           @D14CDVB 02064007
         ST    R0,4(R6)            )   MOVE SECOND PART        @D14CDVB 02065007
         L     R0,8(R8)            )   MOVE TIC CCW            @D14CDVB 02066007
         ST    R0,8(R6)            )                           @D14CDVB 02067007
         USING CCWADR,R6                                       @D14CDVB 02068007
         LR    R3,R5               COPY VIRTUAL LOAD ADDRESS   @D14CDVB 02069007
         LR    R0,R5                                           @D14CDVB 02070007
         AH    R3,DRPLNLB          ADD LB_LENGTH               @D14CDVB 02071007
         C     R3,PFWKMTXT         IF LAST BLOCK EXCEEDS FIXED @D52VDMZ 02072007
         BNH   FTXT51              TEXT AREA THEN CONSIDER     @D52VDMZ 02073007
         L     R3,PFWKMTXT         ONLY ACT. TEXT BYTES        @D52VDMZ 02074007
FTXT51   DS    0H                                              @D52VDMZ 02075007
         BCTR  R3,0                ADDRESS (LAST LB_BYTE)      @D14CDVB 02076007
FTXT52   DS    0H                                              @D51GDTP 02077007
         N     R0,PXADDR2K         ALIGN ON 2K BOUNDARY        @D51GDTP 02078007
         N     R3,PXADDR2K         ALIGN ON 2K BOUNDARY        @D51GDTP 02079007
         LRA   R8,0(R5)            REAL ADDRESS OF TEXT AREA   @D51GDTP 02080007
         BNZ   FRDERRX             =====>  ERROR EXIT          @D14CDVB 02081007
         CLR   R0,R3               TEXT RECORD INSIDE 2K BLOCK @D52VDMZ 02082007
         BNE   FTXT55              NO => 2 IDAWS REQUIRED      @D52VDMZ 02083007
*---IDAL PROCESSING  ( ONE IDAW) -----------------------------*         02084007
         LA    R7,4(,R7)           ONLY ONE IDAW REQUIRED      @D51GDTP 02085007
         ST    R8,0(,R7)           SET UP IDAL                 @D51GDTP 02086007
         B     FTXT60              SET UP CCW                  @D51GDTP 02087007
         SPACE 1                                                        02088007
*---IDAL PROCESSING  ( TWO IDAWS) ----------------------------*         02089007
         SPACE 1                                                        02090007
FTXT55   ST    R8,0(R7)            LOWER ADDR INTO 1_ST IDAW   @D51GDTP 02091007
         LRA   R8,0(R3)            REAL ADDR OF 2_ND PART      @D14CDVB 02092007
         BNZ   FRDERRX             =====>    ERROR EXIT        @D14CDVB 02093007
         ST    R8,4(R7)            ADDR INTO 2_ND IDAW         @D14CDVB 02094007
.* IF NO OF IDAW'S > 2 (DRPNIDAW) INSER LOGIC HERE             @D52VDMZ 02095007
FTXT60   ST    R7,CCWBUF           ADDR(IDAL) INTO READ_CCW    @D52VDMZ 02096007
         OI    CCWCHAIN,IDAL       IDAL BIT INTO READ_CCW      @D14CDVB 02097007
*SGLINK  REQIDAL,INPUT=(R1,R6,R7,R8,R9),OUTPUT=(R7)            @D52VDMZ 02098007
         BAL   LINK1,REQIDAL       MORE IDAW GENERATION SPACE  @D14CDVB 02099007
         SPACE 1                                                        02100007
*-------------------------------------------------------------*@D149DVB 02101007
         SPACE 1                                                        02102007
.FAFVM60 ANOP                                                  @D14CDVB 02103007
FTXT70   MVC   CCWCODE,DRPLCMD     READ_OP_CODE IN CCW         @D14CDVB 02104007
         AH    R5,DRPLGRL          NEXT INPUT ADDRESS          @D14CDVB 02105007
         ST    R5,DRPLCIF          CURRENT LBCIF ADDRESS       @D14CDVB 02106007
         LR    RE,R6               ADDR (READ_CCW) IS SAVED    @D14CDVB 02107007
         LA    R6,L'CCWTOT(R6)     ADDR (NEXT READ_CCW)        @D14CDVB 02108007
         LA    R0,L'CCWTOT(R6)     ADDR (NEXT TIC_CCW)         @D14CDVB 02109007
         BCT   R4,FTXT50           DECREASE LB_BLOCK  COUNTER  @D14CDVB 02110007
         SPACE 1                                                        02111007
* -- END OF CCW GENERATION LOOP ------------------------------*         02112007
         SPACE 1                                                        02113007
* -- PREPARE READLENGTH OF LAST CCW --------------------------*@D14CDVB 02114007
         SPACE 1                                               @D14CDVB 02115007
         DROP  R6                                              @D14CDVB 02116007
         USING CCWADR,RE                                       @D14CDVB 02117007
*SGLINK  REQLBLK INPUT=(R1,R6,R7,R9,RA,RB,RE),WORK=(R0,R2,R3)  @D52VDMZ 02118007
         BAL   LINK1,REQLBLK       ADJUST CHANNEL PGM          @D21ZDVB 02119007
*                                                                       02120007
FTXT170  NI    CCWCHAIN,XFF-CC-DC  RESET CC BIT TO RLD-READ    @D21ZDVB 02121007
         TM    DFCBSW3,RLDIODLD    DELAYED RLD READ?           @D64ADVB 02122007
         BNO   FTXT200             NO --->                     @D14CDHD 02123007
         OI    CCWCHAIN,CC         SET CC TO RLD CHAIN         @D14CDHD 02124007
         DROP  RE                                              @D14CDVB 02125007
         SPACE 1                                                        02126007
* --- PREPARE FOR I/O ----------------------------------------*         02127007
         SPACE 1                                                        02128007
FTXT200  LH    R3,DRPOCCW          OFFSET (CCW-CHAIN)          @D14CDVB 02129007
         LA    R3,FCCWTXT(R3)      GET POINTER TO  CCW STRING           02130007
         LA    RE,DFICBP           GET RELATED CCB             @D36JDVB 02131007
         ST    R3,DFICBCCW(RE)     CONNECT CCB TO STRING       @D36JDVB 02132007
         SPACE 1                                                        02133007
*SGLINK  REQIO,INPUT=(R1,R8,R9,RD,RE),OUTPUT=(RF),WORK=(R0,R6) @D149DVB 02134007
         BAL   LINK1,REQIO         DO I/O                               02135007
         NI    DFCBSW3,XFF-TXTIOPND-RLDIODLD          RESET ALL:       *02136007
                                   ...DELAYED RLD, TXT I/O PND @D64ADVB 02137007
         LTR   RF,RF               ANY ERROR                   @D35CDVB 02138007
         BNZ   FRDEXIT             =====>     YES: EXIT        @D21ZDVB 02139007
         TM    DFCBSW3,LASTBLKM    LAST TXT LB MOVE REQUIRED   @D64ADVB 02140007
         BZ    FTXTID              NO   --->                   @D21ZDVB 02141007
         BAL   LINK1,REQLBLK2      MOVE LAST BLOCK             @D21ZDVB 02142007
*                                                              @D14CDHD 02143007
*  CHECK ID OF LB AGAINST ID OF DIRECTORY ENTRY                @D14CDHD 02144007
*                                                              @D14CDHD 02145007
FTXTID   L     R8,DRPLCIF          @CONTROL INFO               @D14CDHD 02146007
         USING INLCLBCF,R8                                     @D14CDHD 02147007
         L     R2,LBCFIDEN         ID OF LB                    @D14CDHD 02148007
         L     R3,DFWKLBID         ID OF DIRECTORY ENTRY       @D14CDHD 02149007
         CR    R2,R3               ID MISMATCH ?               @D14CDHD 02150007
         BNE   FRDERR44            YES  ---> PHASE NOT FOUND   @D21ZDVB 02151007
         TM    DFCBSW2,LASTTBL     CIF OF LAST TXT BLOCK ?     @D64ADVB 02152007
         BZ    FTXT220             NO  --->                    @D14CDHD 02153007
         TM    LBCFFLG2,LBCFMDEL   PHASE ALREADY DELETED ?     @D14CDHD 02154007
         BO    FRDERR44            YES  ---> PHASE NOT FOUND   @D21ZDVB 02155007
         DROP  R8                                              @D14CDHD 02156007
         SPACE 1                                                        02157007
FTXT220  STH   R4,DRPNRC                                       @D14CDVB 02158007
         LTR   R4,R4               MORE LB_TXT TO PROCESS      @D14CDVB 02159007
         BP    FTXT40              YES - REPEAT                @D14CDVB 02160007
         B     FRDEXIT             =====>                      @D21ZDVB 02161007
         SPACE 1                                                        02162007
FTXT240  LH    R0,DRPNRC           ADJUST DRPNRC               @D61NDVB 02163007
         SLR   R0,R4               ... TO CURRENT NUMBER OF    @D61NDVB 02164007
         STH   R0,DRPNRC           ... GENERATED CCW-S (ECKD)  @D61NDVB 02165007
         B     FTXT170             ----------->                @D61NDVB 02166007
         SPACE 1                                                        02167007
         DROP  R3                                              @D14CDVB 02168007
*-------------------------------------------------------------*@D149DVB 02169007
         EJECT                                                 @D149DVB 02170007
*-------------------------------------------------------------*@D149DVB 02171007
*        MODULE PROLOGUE: FEXTTAB                              @D149DVB 02172007
*        ROUTINE NAME: FEXTTAB                                 @D149DVB 02173007
*        MACRO:        SGBFCH                                  @D149DVB 02174007
*        FUNCTION:     PROVIDES ADDR OF ACTUAL EXTTAB  AND     @D149DVB 02175007
*                      RELATED DEVTAB                          @D149DVB 02176007
*        CALLER:       FREAD                                   @D149DVB 02177007
*        INPUT:        DRPLDA                                  @D149DVB 02178007
*        OUTPUT:       R3:  ADDR(EXTTAB)                       @D149DVB 02179007
*                      R2:  ADDR(DEVTAB)                       @D149DVB 02180007
*                      R4:  ADDR(EXTTAB(TXT))  ==> EP(FEXTTXT )@D149DVB 02181007
*        CALLING SEQUENCE:                                     @D149DVB 02182007
*                  (1) BAL    LINK1,FEXTTAB                    @D149DVB 02183007
*                  (2) BAL    LINK1,FEXTTXT    ==> EXTTAB(TXT) @D149DVB 02184007
*        RETURN CODES: NONE                                    @D149DVB 02185007
*        CALLED ROUTINES: NONE                                 @D149DVB 02186007
*        RETURN:       CALLER                                  @D149DVB 02187007
*        ERROR EXITS:  FRDERR20                                @D149DVB 02188007
*        REFERENCED DATA: EXTTAB(READ,EXTERN), FCHWORK (READ)  @D149DVB 02189007
*-------------------------------------------------------------*@D149DVB 02190007
         SPACE 1                                               @D149DVB 02191007
FEXTTXT  LA    RF,FEXT050          ENTRY TXT--RLD              @D14CDVB 02192007
         L     R0,DFWKERBA         RBA(TXT)                    @D14CDVB 02193007
         B     FEXT000             --->                        @D14CDVB 02194007
FEXTTAB  L     R0,DRPLADA          CURRENT RBA                 @D14CDVB 02195007
FEXTBLD  LA    RF,FEXT040          ENTRY                       @D14CDVB 02196007
FEXT000  L     R4,DFWKALIB         ADDRESS OF LIB_DEF_TAB      @D14CDVB 02197007
         USING INLCLDTE,R4                                     @D14CDVB 02198007
         L     R3,LDTEEDTX         ADDRESS OF EXTTAB           @D14CDVB 02199007
         USING INLCEDTE,R3                                     @D14CDVB 02200007
FEXT010  CL    R0,EDTELODA         RBA INSIDE EXTENT           @D14CDVB 02201007
         BL    FEXT020             NO  --->                    @D14CDVB 02202007
         CL    R0,EDTEHIDA         RBA INSIDE EXTENT           @D14CDVB 02203007
         BNHR  RF                  YES --->                    @D14CDVB 02204007
FEXT020  L     R3,EDTENEXT         ADDR (NEXT EXTTAB)          @D14CDVB 02205007
         LTR   R3,R3               ANY AVAILABLE               @D14CDVB 02206007
         BNM   FEXT010             YES -->                     @D14CDVB 02207007
         SLR   RF,RF                                           @D14CDVB 02208007
         B     FRDERR20            =====>    (ERROR)           @D14CDVB 02209007
FEXT040  L     R2,EDTEDDTX         ADDRESS OF RELATED DEVTAB   @D14CDVB 02210007
         ST    R2,ORG2(RD)         SAVE ADDR (DEVTAB)          @D14CDVB 02211007
         ST    R3,ORG3(RD)         SAVE ADDR (EXTTAB)          @D14CDVB 02212007
         SLR   RF,RF                                           @D14CDVB 02213007
         BR    LINK1               =====>     RETURN           @D14CDVB 02214007
FEXT050  LR    R4,R3                                           @D14CDVB 02215007
         L     R3,ORG3(RD)         RESET ORIGINAL ADDR (EXTTAB)@D14CDVB 02216007
         SLR   RF,RF                                           @D14CDVB 02217007
         BR    LINK1               =====>     RETURN           @D14CDVB 02218007
         DROP  R4                                              @D14CDVB 02219007
         SPACE 1                                               @D149DVB 02220007
*-------------------------------------------------------------*@D149DVB 02221007
         EJECT                                                          02222007
*-------------------------------------------------------------*         02223007
*        MODULE PROLOGUE: SCANSLD                                       02224007
*        ROUTINE NAME: SCANSLD                                          02225007
*        MACRO:        SGBFCH                                           02226007
*        FUNCTION:     SEARCHES THE 2ND LEVEL DIRECTORY -IF ANY-        02227007
*                      FOR THE REQUESTED PHASENAME                      02228007
*                      AND RETURNS THE RBA OF THE RELATED      @D149DVB 02229007
*                      RECORD CONTAINING THE DIRECTORY ENTRY   @D149DVB 02230007
*        CALLER:       FREAD                                            02231007
*        OPERATION: PROVIDE RBA OF START(SUBLIB)               @D149DVB 02232007
*                   IF NO SLD AT ALL OR SLD IN BACK LEVEL STATE@D149DHD 02233007
*                      THEN RETURN WITH OFFSET 8               @D149DVB 02234007
*                   GO THROUGH SLD AND DO                      @D149DVB 02235007
*                      DRPLADA=RBA OF CURRENT SLD_ENTRY        @D149DVB 02236007
*                      IF PHASENAME <= SLD.ENTRY.NAME          @D149DVB 02237007
*                         THEN INDICATE DIR. BLOCK FOUND       @D14CDHD 02238007
*                              IN SLD BY SETTING SLDIND AND    @D14CDHD 02239007
*                              RETURN WITH OFFSET 0            @D149DVB 02240007
*                    ENDDO                                     @D149DVB 02241007
*                    IF SLD IS INCOMPLETE                      @D149DVB 02242007
*                       THEN RETURN WITH OFFSET 8              @D149DHD 02243007
*                       ELSE RETURN WITH OFFSET 4              @D149DVB 02244007
*        INPUT:        PHASENAME IN TCB_FCHWORK                @D149DVB 02245007
*        OUTPUT:       RBA                                     @D149DVB 02246007
*        CALLING SEQUENCE:                                     @D149DVB 02247007
*                      BAL    LINK1,SCANSLD                    @D149DVB 02248007
*                      B      LABEL1   / SUCCESSFULL         / @D149DVB 02249007
*                      B      LABEL2   / PHASE NOT FOUND     / @D14CDHD 02250007
*                                        SEARCH DIRECTORY      @D14CDHD 02251007
*        RETURN CODES: NONE                                             02252007
*        CALLED ROUTINES:                                               02253007
*                      NONE                                             02254007
*        RETURN:       CALLER                                           02255007
*        ERROR EXITS:  NONE                                             02256007
*        REFERENCED DATA:                                               02257007
*                      SUBLIB DEFINITION TABLE (READ)          @D149DVB 02258007
*                      SLD (READ)                              @D149DVB 02259007
*                      FCHWORK (UPDATE)                                 02260007
*-------------------------------------------------------------*         02261007
         SPACE 2                                                        02262007
*SGLINK  SCANSLD,INPUT=(R2,R3,R8,R9,RB),WORK=(R0,R5,R7),               *02263007
               OUTPUT=(R5)                                     @D14CDVB 02264007
SCANSLD  DS    0H                                                       02265007
         AIF   ( NOT &BGDSHR).NDSHR65                          @D14CDVB 02266007
         NI    SLDFLAG,XFF-SLDIND  RESET INDICATOR 'DIR. BLOCK @D14CDHD*02267007
                                   FOUND IN SLD                @D14CDHD 02268007
.NDSHR65 ANOP                                                  @D14CDVB 02269007
         L     R5,DFWKASLB         ADDRESS OF ACTUAL SUBLIB    @D14CDVB 02270007
         USING INLCSDTE,R5                                     @D14CDVB 02271007
         MVC   DRPLADA,SDTEXRBP    RBA OF HIGHEST INDEX_LB -- OR 1ST   *02272007
                                   DIR_LB AS SEARCH ADDRESS    @D14CDVB 02273007
         L     R0,DRPLADA                                      @D14CDVB 02274007
         L     R7,SDTESLDA         ADDRESS OF SLD              @D14CDVB 02275007
         LTR   R7,R7               IF ANY SDL AT ALL           @D14CDVB 02276007
         BZ    4(LINK1)            =====>   NO SDL AT ALL      @D14CDVB 02277007
         AIF   ( NOT &BGDSHR).NDSHR50                          @D14CDVB 02278007
         TM    MULTFLAG,MULTON     MULTIPHASE REQUEST          @D14CDHD 02279007
         BO    4(LINK1)            ====>    NO SLD SEARCH      @D14CDHD 02280007
         TM    SLDFLAG,SLDBACKL    SLD IN BACK LEVEL STATE ?   @D14CDHD 02281007
         BO    4(LINK1)            =====>   RETURN             @D14CDHD 02282007
.NDSHR50 ANOP                                                  @D14CDVB 02283007
         SPACE 1                                               @D14CDVB 02284007
         LH    R6,SDTENSLD         # SLD ENTRIES               @D14CDVB 02285007
         USING INLCSLDE,R7                                     @D14CDVB 02286007
         SPACE 1                                               @D14CDVB 02287007
*---- FIND REQUESTED PHASE NAME IN SLD -----------------------*@D14CDVB 02288007
         SPACE 1                                               @D14CDVB 02289007
SCANLOOP EQU   *                                               @D14CDVB 02290007
         L     R0,SLDEPRBA         CURRENT RBA...              @D14CDVB 02291007
         ST    R0,DRPLADA          ... AS FIRST DIR_LB ADDR    @D14CDVB 02292007
         CLC   SLDEKEY,DFWKNAME    PHASENAME IN RECORD WHERE THE SLD...*02293007
                                   ... ENTRY POINTS TO         @D14CDVB 02294007
PCKLBF30 EQU   *                                               @D14CDVB 02295007
         BL    SCANXT              =====>  LB FOUND: RETURN    @D14CDVB 02296007
         AIF   ( NOT &BGDSHR).NDSHR60                          @D14CDVB 02297007
         OI    SLDFLAG,SLDIND      INDICATE DIR. BLOCK FOUND   @D14CDHD*02298007
                                   IN SLD                               02299007
.NDSHR60 ANOP                                                  @D14CDVB 02300007
         BR    LINK1                                                    02301007
SCANXT   LA    R7,SLDELEN(R7)      BUMP TO NEXT SLD_ENTRY...   @D14CDVB 02302007
         BCT   R6,SCANLOOP         ... AND RETRY               @D14CDVB 02303007
         SPACE 1                                               @D14CDVB 02304007
*---- TEST FOR INCOMPLETE SLD --------------------------------*@D14CDVB 02305007
         SPACE 1                                               @D14CDVB 02306007
         MVC   DRPLADA,SDTEXRBP    RBA OF HIGHEST INDEX_LB     @D14CDHD 02307007
         B     4(LINK1)            =====>  RETURN NO PHASE FND @D14CDVB 02308007
         SPACE 1                                               @D14CDVB 02309007
         DROP  R5,R7                                           @D14CDVB 02310007
         SPACE 1                                                        02311007
*-------------------------------------------------------------*@D14CDVB 02312007
         EJECT                                                          02313007
*-------------------------------------------------------------*@D14CDVB 02314007
*        PROLOGUE :    DATA TYPE  P F G E N C C W              @D14CDVB 02315007
*                      CREATION ROUTINE                        @D14CDVB 02316007
*        ROUTINE NAME: CREAGEN                                 @D14CDVB 02317007
*        MACRO:        SGBFCH                                  @D14CDVB 02318007
*        FUNCTION:     DETERMINES CCW-GENERATION AREA FOR      @D14CDVB 02319007
*                      TXT READ. WHEN LIBRARY CONTROL BLOCKS   @D14CDVB 02320007
*                      ARE PROVIDED BY LIBR, THE AREA IN FETCH @D14CDVB 02321007
*                      IS USED AS GENERATION AREA. THE AREA IS @D14CDVB 02322007
*                      FILLED TOP-DOWN WITH CCWS AND BOTTOM-UP @D14CDVB 02323007
*                      WITH IDALS.                             @D14CDVB 02324007
*        CALLER:       FREAD                                   @D14CDVB 02325007
*        INPUT:        SEE REFERENCED DATA                     @D14CDVB 02326007
*        OUTPUT:       R0 --- ADDRESS OF FIRST TIC_CCW         @D14CDVB 02327007
*                      R6 --- ADDRESS OF FIRST READ_CCW        @D14CDVB 02328007
*                      R7 --- ADDRESS OF FIRST IDAW            @D14CDVB 02329007
*        CALLING SEQUENCE:                                     @D14CDVB 02330007
*                      BAL   LINK1,CREAGEN                     @D14CDVB 02331007
*        RETURN CODES: NONE                                    @D14CDVB 02332007
*        CALLED ROUTINES:                                      @D14CDVB 02333007
*                      NONE                                    @D14CDVB 02334007
*        RETURN:       CALLER                                  @D14CDVB 02335007
*        ERROR EXITS:  NONE                                    @D14CDVB 02336007
*        REFERENCED DATA:                                      @D14CDVB 02337007
*                      FCHWORK (READ)                          @D14CDVB 02338007
*                      PFGENCB (UPDATE)                        @D14CDVB 02339007
*-------------------------------------------------------------*@D14CDVB 02340007
         SPACE 1                                               @D14CDVB 02341007
*SGLINK  CREAGEN,INPUT=(R8,R9,RB),WORK=(RE),OUTPUT=(R0,R6,R7)  @D14CDVB 02342007
CREAGEN  DS    0H                                              @D14CDVB 02343007
         L     RE,PFBEGRLD         START_ADDR (RLD_BUF)        @D14CDVB 02344007
         USING FRLDBUF,RE                                      @D14CDVB 02345007
         LA    R6,FSTCCW           RESET ADDRESSES TO ...      @D14CDVB 02346007
         LA    R7,EIDALBUF         ... STANDARD VALUES         @D14CDVB 02347007
         TM    SYSFLAG2,IPLBIT     IPL IN PROCESS              @DY44738 02348007
         BZ    FTST010             NO, REUSE AREA              @DY44738 02349007
.* THE AREA MIGHT BE REUSED TOO SOON: THE DIR TASK WORKS WITH           02350007
.* THE INTERNAL TABLES AND SAVES THE INFO IN THE TCB FETCH WORK AREA.   02351007
.* THE CORRESPONDING READ (FCH TASK) IS STARTED AFTER IPL. THEN THE     02352007
.* AREA IS USED FOR CCW GENERATION, BUT THE READ IS DONE WITH THESE     02353007
.* TABLES SINCE TCB POINTS TO IT. BUT THE GAP IS SMALL AND SHOULDN'T    02354007
.* CAUSE A PROBLEM.                                                     02355007
         LA    R7,EIDALBF1         DO NOT REUSE INTERNAL TABLE @D52VDMZ 02356007
         DROP  RE                                              @D14CDVB 02357007
FTST010  ST    R6,PFSTDBEG         BEG_ADDR (GEN_AREA)         @D14CDVB 02358007
         LA    R0,8(R6)            INITIALIZE FOR TESTING      @D14CDVB 02359007
         BR    LINK1               =====>  RETURN              @D14CDVB 02360007
         SPACE 1                                               @D14CDVB 02361007
*-------------------------------------------------------------*@D14CDVB 02362007
         EJECT                                                          02363007
*-------------------------------------------------------------*         02364007
*        PROLOGUE :    DATA TYPE  P F G E N C C W              @D149DVB 02365007
*                      UPDATE   ROUTINE                        @D149DVB 02366007
*        ROUTINE NAME: REQCCW                                           02367007
*        MACRO:        SGBFCH                                           02368007
*        FUNCTION:     TESTS IF SPACE IS AVAILABLE FOR GENERATION       02369007
*                      OF TEXT CCW S.                                   02370007
*                      IF NO SPACE CAN BE PROVIDED A SPECIAL            02371007
*                      RETURN IS DONE.                                  02372007
*        CALLER:       FREAD                                            02373007
*        INPUT:        REG 0 ADDR OF NEXT TIC_CCW              @D149DVB 02374007
*                      REG 7 ADDR OF NEXT IDAW                 @D149DVB 02375007
*        CALLING SEQUENCE:                                     @D149DVB 02376007
*                      BAL    LINK1,REQCCW                     @D149DVB 02377007
*                      B      XXXX      LABEL FOR NO GEN_SPACE @D149DVB 02378007
*                      B      YYYY      INSTRUCTION SEQUENCE   @D149DVB 02379007
*                                       FOR CCW_GENERATION     @D149DVB 02380007
*        RETURN CODES: NONE                                             02381007
*        CALLED ROUTINES:                                               02382007
*                      NONE                                             02383007
*        RETURN:       CALLER                                           02384007
*        ERROR EXITS:  FRDERRX                                 @D149DVB 02385007
*        REFERENCED DATA:                                               02386007
*-------------------------------------------------------------*         02387007
         SPACE 2                                                        02388007
*SGLINK  REQCCW,INPUT=(R0,R7,R8,R9),WORK=(R3)                  @D52VDMZ 02389007
REQCCW   DS    0H                                                       02390007
         SPACE 1                                               @D21ZDVB 02391007
.* R3<= R7 MEANS: A CCW (AND TIC CCW) AND AN IDAL CAN BE       @D52VDMZ 02392007
.* CREATED FOR ONE MORE RECORD. IN THE CALCULATION A TIC CCW   @D52VDMZ 02393007
.* OF 8 BYTE IS USED, ALTHOUGH ONLY 4 BYTES ARE USED.          @D52VDMZ 02394007
         LR    R3,R0               R3=BEGIN ADDR OF TIC CCW    @D52VDMZ 02395007
         LA    R3,8(,R3)           R3 POINTS BEHIND TIC CCW    @D52VDMZ 02396007
         CLR   R3,R7               TIC CCW OVERWRITES IDALS    @D36JDVB 02397007
         BNH   4(LINK1)            NO , CONTINUE GENERATION    @D52VDMZ 02398007
         BR    LINK1               YES, STOP GENERATION        @D14CDVB 02399007
         SPACE 1                                               @D14CDVB 02400007
*-------------------------------------------------------------*@D14CDVB 02401007
         EJECT                                                          02402007
*------------------------------------------------------------*          02403007
*        PROLOGUE :    DATA TYPE  P F G E N C C W              @D149DVB 02404007
*                      IDAL     ROUTINE                        @D149DVB 02405007
*        ROUTINE NAME: REQIDAL                                          02406007
*        MACRO:        SGBFCH                                           02407007
*        FUNCTION:     TESTS IF SPACE IS AVAILABLE FOR GENERATION       02408007
*                      OF IDAW S.                                       02409007
*        CALLER:       FREAD                                            02410007
*        OPERATION:    FIND NEXT FREE SPACE FOR TWO IDAW S.             02411007
*                      THE AREA MAY BE THE INITIAL IDAW AREA OR THE     02412007
*                      CCW GENERATION AREA.                             02413007
*                      THE GENERATION IS DONE 'DOWNWARDS'.              02414007
*                      |.. CCW GENERATION-->    <---IDAW GENERATION...| 02415007
*        INPUT:        REG 7 CURRENT IDAW POINTER                       02416007
*                      REG 6 ACTUAL GEN_CCW ADDRESS            @D149DVB 02417007
*        OUTPUT:       REG 7 NEW IDAW POINTER                           02418007
*        CALLING SEQUENCE:                                     @D149DVB 02419007
*                      BAL   LINK1,REQIDAL                     @D149DVB 02420007
*        RETURN CODES: NONE                                             02421007
*        CALLED ROUTINES:                                               02422007
*                      NONE                                             02423007
*        RETURN:       CALLER                                           02424007
*        ERROR EXITS:  NONE                                             02425007
*        REFERENCED DATA: NONE                                 @D149DVB 02426007
*-------------------------------------------------------------*         02427007
         SPACE 2                                                        02428007
*SGLINK  REQIDAL,INPUT=(R1,R6,R7,R8,R9),OUTPUT=(R7)            @D149DVB 02429007
REQIDAL  DS    0H                                                       02430007
         SH    R7,DRPLIDAL         GET NEXT IDAW POINTER       @D365DVB 02431007
         CLR   R7,R6               IDAL OVERWRITES CCWS        @D36JDVB 02432007
         BHR   LINK1               =====>  CONTINUE GENERATION @D14CDVB 02433007
         LR    R7,R6               FORCE END OF GENERATION     @D36JDVB 02434007
         BR    LINK1               =====>                      @D14CDVB 02435007
         SPACE 1                                               @D14CDVB 02436007
*-------------------------------------------------------------*@D14CDVB 02437007
         EJECT                                                          02438007
         AGO   .NGEN250                                        @D21ZDVB 02439007
*------------------------------------------------------------* @D149DVB 02440007
*        PROLOGUE :    DATA TYPE  P F G E N C C W              @D149DVB 02441007
*                      FBA ADJUST SUBROUTINE                   @D149DVB 02442007
*        ROUTINE NAME: REQFBA                                  @D149DVB 02443007
*        MACRO:        SGBFCH                                  @D149DVB 02444007
*        FUNCTION:     ADJUSTS FBM CHANNEL PROGRAM             @D149DVB 02445007
*        OPERATION:    IF DEVICE = FBM                         @D149DVB 02446007
*                         THEN DO                              @D149DVB 02447007
*                           MOVE LAST READ_CCW AND TIC TO ...  @D149DVB 02448007
*                                SPECIAL  AREA                 @D149DVB 02449007
*                           COMMAND CHAIN SECOND LAST READ_CCW @D149DVB 02450007
*                           PROVIDE TIC TO MOVED READ_CCW      @D149DVB 02451007
*                         ELSE                                 @D149DVB 02452007
*                      ENDIF                                   @D149DVB 02453007
*                      RETURN;                                 @D149DVB 02454007
*        INPUT:        REG 2    ADDR (2ND LAST READ CCW)       @D149DVB 02455007
*                      REG E    ADDR (LAST READ CCW)           @D149DVB 02456007
*        OUTPUT:       NONE                                    @D149DVB 02457007
*        CALLING SEQUENCE:                                     @D149DVB 02458007
*                      BAL   LINK1,REQFBA                      @D149DVB 02459007
*        RETURN CODES: NONE                                    @D149DVB 02460007
*        CALLED ROUTINES:                                      @D149DVB 02461007
*                      NONE                                    @D149DVB 02462007
*        RETURN:       CALLER                                  @D149DVB 02463007
*        ERROR EXITS:  NONE                                    @D149DVB 02464007
*        REFERENCED DATA: NONE                                 @D149DVB 02465007
*-------------------------------------------------------------*@D149DVB 02466007
         SPACE 2                                                        02467007
*SGLINK  REQFBA,INPUT=(R2,R8,R9,RB,RE)                         @D149DVB 02468007
REQFBA   DS    0H                                              @D14CDVB 02469007
         CLI   DRPLCMD,RDFB        FBM DEVICE                  @D14CDVB 02470007
         BNER  LINK1               =====>  NO, RETURN          @D14CDVB 02471007
         NI    CCWCHAIN-CCWADR(R2),XFF-DC  CLEAR DATA CHAINING @D14CDHD 02472007
         OI    CCWCHAIN-CCWADR(R2),CC+SLI  COMMAND CHAIN 2ND LAST ..   *02473007
                                   ... READ_CCW                @D14CDHD 02474007
         LA    R2,PFFBAMOD         TARGET AREA                 @D14CDVB 02475007
         MVC   0(2*L'FMODFBA,R2),0(RE)  MOVE LAST READ_TIC CCW @D14CDVB 02476007
         LA    R2,PFLOCMOD         ADDR (LOCATE_CCW)           @D14CDVB 02477007
         USING CCWADR,RE                                       @D14CDVB 02478007
         ST    R2,CCWBUF           TIC TO LOCATE_CCW           @D14CDVB 02479007
         MVI   CCWCODE,TIC             OP_CODE                 @D14CDVB 02480007
         LH    R0,DRPNRC           NO (PROCESSED LOGIC RECORD) @D14CDVB 02481007
         BCTR  R0,0                ...  - 1                    @D14CDVB 02482007
         AL    R0,DRPLADA          ...  + RELATIVE LB NUMBER   @D14CDVB 02483007
         L     R3,ORG3(RD)         ADDR (EXTTAB)               @D14CDVB 02484007
         USING INLCEDTE,R3                                     @D14CDHD 02485007
         S     R0,EDTELODA                                     @D14CDVB 02486007
         DROP  R3                                              @D14CDHD 02487007
         IC    R2,DRPPHBL          2** VALUE OF FBM BLOCK      @D14CDVB 02488007
         SLL   R0,0(R2)            LOG_REC_# ** 2              @D14CDVB 02489007
         ST    R0,PFLOCDAT+LGBLA   =: PHYSICAL BLOCK NR        @D14CDVB 02490007
         LA    R0,1                ONE LOGICAL RECORD MUST BE...       *02491007
                                   ...  PROCESSED              @D14CDVB 02492007
         SLL   R0,0(R2)            LOG_REC_# ** 2              @D14CDVB 02493007
         STH   R0,PFLOCDAT+NRBLCK  #(LOG_BLOCKS) STILL TO ...          *02494007
                                                 ...READ_IN    @D14CDVB 02495007
         BR    LINK1               =====>                      @D14CDVB 02496007
         SPACE 1                                               @D14CDVB 02497007
         DROP  RE                                              @D14CDVB 02498007
         SPACE 1                                               @D14CDVB 02499007
*-------------------------------------------------------------*@D14CDVB 02500007
         EJECT                                                          02501007
.NGEN250 ANOP                                                  @D21ZDVB 02502007
***************************************************************@D149DVB 02503007
*                                                             *@D14CDHD 02504007
*        SUBROUTINE:   R E Q L B L K                          *@D149DVB 02505007
*                                                             *@D14CDHD 02506007
*        PROLOGUE :    DATA TYPE  PFGENCCW                    *@D149DVB 02507007
*                      PROVIDE RBA (LAST TXT_LB) SUBROUTINE   *@D149DVB 02508007
*                                                             *@D14CDHD 02509007
*        MACRO:        SGBFCH                                 *@D149DVB 02510007
*                                                             *@D14CDHD 02511007
*        FUNCTION:     ESTABLISH THE CCW-CHAIN TO READ THE    *@D149DVB 02512007
*                      CONTROL INFORMATION INTO FCIFBUF AND   *@D14CDHD 02513007
*                      CHAINS IT WITH THE TXT READING CCW'S   *@D14CDHD 02514007
*                      OTHERWISE                              *@D14CDHD 02515007
*                                                             *@D14CDHD 02516007
*        OPERATION:    DFCBSW2.LASTTBL = OFF                  *@D21ZDVB 02517007
*                      IF LAST LB OF CONTIGUOUS PART IS READ  *@D21ZDVB 02518007
*                         THEN DFCBSW2.LASTTBL = ON           *@D21ZDVB 02519007
*                         ELSE                                *@D21ZDVB 02520007
*                      RESET IDAL IN LAST CCW                 *@D21ZDVB 02521007
*                      PROVIDE CIF BUFFER ADDRESS IN LAST CCW *@D21ZDVB 02522007
*                      IF DELAYED RLD PROCESSING              *@D21ZDVB 02523007
*                         THEN COMMAND CHAIN RLD              *@D21ZDVB 02524007
*                              CHANNEL PROGRAM                *@D21ZDVB 02525007
*                         ELSE                                *@D21ZDVB 02526007
*                      DFCBSW3.LASTBLKM = ON                  *@D21ZDVB 02527007
*                      RETURN                                 *@D21ZDVB 02528007
*               REQLBLK2:                                     *@D21ZDVB 02529007
*                      DFCBSW3.LASTBLKM = OFF                 *@D21ZDVB 02530007
*                      MOVE TXT_LB FROM CIF BUFFER TO         *@D21ZDVB 02531007
*                              REQUESTOR AREA WITH CORRECT LEN*@D21ZDVB 02532007
*                      RETURN;                                *@D149DVB 02533007
*        INPUT:                                               *@D21ZDVB 02534007
*                      REG 6    ADDR (TIC CCW)                *@D149DVB 02535007
*                      REG 8    LEN (LBCIF)                   *@D149DVB 02536007
*                      REG E    ADDR (LAST READ CCW)          *@D149DVB 02537007
*        CHANGED REGISTERS:  R0, R2, R3, R5                   *@D21ZDVB 02538007
*        CALLS ROUTINE:      NONE                             *@D149DVB 02539007
*        ERROR EXITS:        NONE                             *@D149DVB 02540007
*-------------------------------------------------------------*@D149DVB 02541007
         SPACE 2                                                        02542007
*SGLINK  REQLBLK INPUT=(R1,R6,R7,R9,RB,RE),WORK=(R0,R2,R3)     @D149DVB 02543007
REQLBLK  DS    0H                                              @D14CDVB 02544007
         NI    DFCBSW2,XFF-LASTTBL RESET INDICATOR FOR LAST TEXT LB    *02545007
                                   OF ONE CONTIGUOUS PART      @D21ZDVB 02546007
         TM    DFCBSW3,NOCONTLD    CONTIGUOUS PHASE OR LAST PART OF    *02547007
                                   ... OF A UNCONTIGUOUS PHASE @D64ADVB 02548007
         BO    RQLBLK10            NO --->                     @D21ZDVB 02549007
         OI    DFCBSW2,LASTTBL     SET INDICATOR FOR LAST TEXT LB      *02550007
                                   OF ONE CONTIGUOUS PART      @D21ZDVB 02551007
         USING CCWADR,RE                                       @D14CDVB 02552007
         SPACE 1                                               @D14CDHD 02553007
*                                                              @D14CDHD 02554007
*  PUT ADDRESS OF CIF-BUFFER START IN READ CCW                 @D14CDHD 02555007
*                                                              @D14CDHD 02556007
         SPACE 1                                               @D14CDHD 02557007
RQLBLK10 L     R3,PFBEGCIF                                     @D21ZDVB 02558007
         NI    CCWCHAIN,XFF-IDAL                               @D14CDHD 02559007
         STCM  R3,M7,1(RE)         ADDR (DATA AREA)            @D14CDHD 02560007
         SPACE 1                                               @D14CDHD 02561007
*  UPDATE DRPLCIF                                              @D14CDHD 02562007
         SPACE 1                                               @D14CDHD 02563007
         LH    R3,DRPLGRL                                      @D14CDHD 02564007
         AL    R3,PFBEGCIF         ADDR(CIF_BUF) + LEN (LOGICAL BLOCK) *02565007
                                   = ADDR (LBCIF)              @D14CDVB 02566007
         ST    R3,DRPLCIF                                      @D14CDVB 02567007
         SPACE 1                                               @D14CDVB 02568007
*  SET/CLEAR COMMAND CHAINING TO RLD-CHAIN                     @D14CDHD 02569007
         SPACE 1                                               @D14CDVB 02570007
         OI    DFCBSW3,LASTBLKM    SET MOVE MODE FOR LAST BLOCK@D64ADVB 02571007
         BR    LINK1               =====>                      @D21ZDVB 02572007
*                                                              @D14CDHD 02573007
*  MOVE BYTES FROM CIF-AREA INTO TXT-AREA                      @D14CDHD 02574007
*                                                              @D14CDHD 02575007
         SPACE 1                                               @D14CDHD 02576007
REQLBLK2 DS    0H                  2ND ENTRY POINT             @D21ZDVB 02577007
         NI    DFCBSW3,XFF-LASTBLKM RESET MOVE TXT LB SWITCH   @D64ADVB 02578007
         L     R2,PFWKMTXT         COMPUTE TXT-START FOR MOVE  @D14CDHD 02579007
         LH    R3,DRPLLBL          R3=LENGTH OF OUTPUT AREA    @D14CDHD 02580007
         SR    R2,R3               START ADDR. OF OUTPUT AREA  @D14CDHD 02581007
         L     R6,PFBEGCIF         START ADDR. OF INPUT AREA   @D21ZDVB 02582007
         LR    R7,R3               R5=LENGTH OF INPUT AREA     @D21ZDVB 02583007
         MVCL  R2,R6                                           @D21ZDVB 02584007
         BR    LINK1               =====>                      @D21ZDVB 02585007
         DROP  RE                                                       02586007
         SPACE 1                                               @D14CDVB 02587007
*-------------------------------------------------------------*@D14CDVB 02588007
         EJECT                                                          02589007
*-------------------------------------------------------------*         02590007
*        ROUTINE PROLOGUE: REQIO                                        02591007
*        ROUTINE NAME: REQIO  (I/O LAYER)                               02592007
*        MACRO:        SGBFCH                                           02593007
*        FUNCTION:     ISSUES THE SYSIO FOR EXECUTION OF THE            02594007
*                      CHANNEL PROGRAM. THE INTERFACE IS THE CCB.       02595007
*        CALLER:       FREAD                                            02596007
*        OPERATION: PROVIDE LUB_INDEX IN RELATED CCB           @D149DVB 02597007
*                   CALL REQDSK  / PROVIDE DISK ADDRESS DATA  /@D149DVB 02598007
*             LAB1: PERFORM SYSIO                              @D149DVB 02599007
*                   IF ¬UNRECOVERABLE I/O_ERROR                @D149DVB 02600007
*                     THEN IF DEVICE = CKD                     @D149DVB 02601007
*                           THEN IF EOC_CONDITION              @D149DVB 02602007
*                                  THEN CALL REQEOC            @D149DVB 02603007
*                                  GOTO LAB1 /RESTART CCW_PROG/@D149DVB 02604007
*                                ENDIF                         @D149DVB 02605007
*                          ENDIF                               @D149DVB 02606007
*                          IF TXT_REQUEST                      @D149DVB 02607007
*                           THEN RESET TIC_ADDR                @D149DVB 02608007
*                           ENDIF                              @D149DVB 02609007
*                          ENDIF                               @D149DVB 02610007
*                          RETURN (RC=0)                       @D149DVB 02611007
*                     ELSE INDICATE I/O ERROR                  @D149DVB 02612007
*                          IF TXT_REQUEST                      @D149DVB 02613007
*                            THEN IF RLD_BUF OVERWRITTEN       @D149DVB 02614007
*                                 THEN GOTO LAB1 /RESTART RLD/ @D149DVB 02615007
*                                 ENDIF                        @D149DVB 02616007
*                           ENDIF                              @D149DVB 02617007
*                           IF ERROR ON SCIL & REQ = SYS TASK  @D149DVB 02618007
*                              THEN HARDWAIT X'FFE'            @D149DVB 02619007
*                              ELSE RETURN (RC=4)              @D149DVB 02620007
*                           ENDIF                              @D149DVB 02621007
*                   ENDIF;                                     @D149DVB 02622007
*        INPUT:        SEE REFERENCED DATA                              02623007
*        OUTPUT:       REQUESTED INPUT BLOCK IN READ-IN AREA            02624007
*        CALLED ROUTINES:                                               02625007
*                      REQDSK, REQEOC, SETSCTR (RPS ONLY)      @D149DVB 02626007
*        RETURN:       CALLER                                           02627007
*        ERROR EXIT:   HARDWAIT  X'FFE'                        @D149DVB 02628007
*                      FRDERRX                                 @D149DVB 02629007
*        REFERENCED DATA:                                               02630007
*                      DISK ADDRESS DATA (READ)                @D149DVB 02631007
*                      RE  ---> RELATED CCB                    @D36JDVB 02632007
*                      DEVTAB, EXTTAB (READ)                   @D149DVB 02633007
*                      FRPL (UPDATE)                           @D14CDVB 02634007
*-------------------------------------------------------------*         02635007
         SPACE 1                                                        02636007
*SGLINK  REQIO,INPUT=(R1,R8,R9,RD,RE),OUTPUT=(RF),WORK=(R0)    @D149DVB 02637007
REQIO    DS    0H                  ENTRY POINT                          02638007
         ST    R4,ORG4(RD)                                     @D14CDVB 02639007
         ST    R5,ORG5(RD)                                     @D14CDVB 02640007
         ST    R6,ORG6(RD)                                     @D14CDVB 02641007
         L     R2,ORG2(RD)         ADDR (DEVTAB)               @D14CDVB 02642007
         L     R3,ORG3(RD)         ADDR (EXTTAB)               @D14CDVB 02643007
         USING INLCDDTE,R2                                     @D14CDHD 02644007
         USING INLCEDTE,R3                                     @D14CDHD 02645007
         LH    R4,DFICBLUB-1(RE)   GET CURRENT BIT SETTING     @D51GDAP 02646007
         N     R4,CCBPXMSK         RESET ALL UNUSED BITS       @D51GDAP 02647007
         LH    R0,EDTEPUB          GET PUB INDEX               @D51GDAP 02648007
         OR    R0,R4               OR INDEX TO CCB BITS        @D51GDAP 02649007
         STH   R0,DFICBLUB-1(RE)   SET PUB INDEX INTO CCB      @D51GDAP 02650007
         SPACE 1                                                        02651007
*SGLINK REQDSK,INPUT=(R1,R2,R3,R7,R9,RB),OUTPUT=(R6,RF),               *02652007
               WORK(R0,R4,R5,RC)                               @D61NDVB 02653007
         BAL   LINK2,REQDSK        UPDATE DISK ADDRESS PACKAGE          02654007
FRQ25    EQU   *                                                        02655007
         SPACE 1                                               @D14CDVB 02656007
*---IF RPS DEVICE INITIALIZE SECTOR VALUE --------------------*@D14CDVB 02657007
         SPACE 1                                               @D14CDVB 02658007
         CLI   DDTEDEV,AVRRPS      IS IT RPS DEVICE            @D14CDVB 02659007
         BL    FRQ30               NO --->                     @D52VDMZ 02660007
*SGLINK  SETSCTR,INPUT=(R2,R6,R7,R9)                           @D14CDVB 02661007
         BAL   LINK2,SETSCTR       PROVIDE SECTOR NUMBER       @D14CDVB 02662007
FRQ30    EQU   *                                               @D14CDVB 02663007
         SPACE 1                                               @D14CDVB 02664007
*-------------------------------------------------------------*@D14CDVB 02665007
         SPACE 1                                               @D14CDVB 02666007
         AIF   (NOT &BGFSTAT).FSTZZ90                          @D14CDVB 02667007
         LA    R0,1                                            @D35ZDVB 02668007
         LA    R2,FLCTXIO                                      @D35ZDVB 02669007
         CLI   DRPLID+D1,X'04'     REQUEST FOR TXT READ IN     @D35ZDVB 02670007
         BE    FRQUP               --->                        @D35ZDVB 02671007
         LA    R2,FLCRLIO                                      @D35ZDVB 02672007
         CLI   DRPLID+1,X'08'      REQUEST FOR RLD             @D35ZDVB 02673007
         BE    FRQUP               --->                        @D35ZDVB 02674007
         LA    R2,FLCDRIO                                      @D35ZDVB 02675007
FRQUP    AL    R0,0(R2)            )                           @D35ZDVB 02676007
         ST    R0,0(R2)            ) UPDATE LOCAL I/O COUNTER  @D35ZDVB 02677007
         SPACE 1                                               @D14CDVB 02678007
.FSTZZ90 ANOP                                                  @D35ZDVB 02679007
         LR    R1,RE               POINTER TO CCB ( I/O I/F )  @D36JDVB 02680007
         SYSIO (1)                 SVC 15                               02681007
         SPACE 1                                               @D14CDVB 02682007
         L     R1,ORG1(RD)         ADDR (FRPL)                 @D14CDVB 02683007
         L     R2,ORG2(RD)         ADDR (DEVTAB)               @D14CDVB 02684007
         L     R3,ORG3(RD)         ADDR (EXTTAB)               @D14CDVB 02685007
         TM    DFICBERR(RE),DISERR UNRECOVERABLE I/O ERROR     @D379DVB 02686007
         BO    FRQERR              YES --->                             02687007
         SPACE 1                                               @D14CDVB 02688007
         CLI   DRPLID+1,TXTRQID    READ OF TXT_LB'S            @D61NDVB 02689007
         BNE   FRQ35               NO --->                     @D61NDVB 02690007
         SPACE 1                                               @D14CDVB 02691007
*                                                              @D14CDHD 02692007
*  NORMAL UPDATE OF DRPLADA AND DFWKECON                       @D14CDHD 02693007
*                                                              @D14CDHD 02694007
         SPACE 1                                               @D14CDVB 02695007
         L     R5,DRPLCIF                                      @D14CDHD 02696007
         USING INLCLBCF,R5                                     @D14CDHD 02697007
         LH    R0,LBCFCONT                                     @D14CDHD 02698007
         STH   R0,DFWKECON                                     @D14CDHD 02699007
FRQ35    L     R5,DRPLCIF                                      @D14CDHD 02700007
         L     R4,LBCFLBNF                                     @D14CDHD 02701007
         ST    R4,DRPLADA                                      @D14CDHD 02702007
         DROP  R5                                              @D14CDHD 02703007
*                                                              @D14CDHD 02704007
.*  EOC CONDITION IS ONLY APPLICABLE FOR TXT PROCESSING        @D61NDVB 02705007
.*  ON CKD OR RPS DEVICES                                      @D61NDVB 02706007
         TM    DFICBEOC(RE),EOC    END OF CYLINDER             @D14CDVB 02707007
         BZ    FRQ40               NO  --->                    @D14CDVB 02708007
*SGLINK  REQEOC,INPUT=(R6,R7,R9,RB,RD,RE),WORK=(R0,R4,R5)      @D14CDVB 02709007
         BAL   LINK2,REQEOC        HANDLE EOC CONDITION        @D14CDVB 02710007
         B     FRQ25               --->   RESTART REST OF CCWS @D14CDVB 02711007
         SPACE 1                                                        02712007
FRQ40    CLI   DRPLID+1,TXTRQID    READ OF TXT_LB'S            @D61NDVB 02713007
         BNE   FRQEXIT             NO --->                     @D61NDVB 02714007
         TM    DFCBSW3,RLDIODLD    DELAYED RLD_IO              @D64ADVB 02715007
         BZ    FRQ45               NO --->                     @D14CDVB 02716007
         L     R7,DSRPLRLD         ADDR (RLD_RPL)              @D14CDVB 02717007
         L     R5,DRPLCIF-DRPL(R7) ADDR (LB_CIF)               @D14CDVB 02718007
         USING INLCLBCF,R5                                     @D14CDVB 02719007
         L     R0,LBCFLBNF         RBA OF NEXT LB...           @D14CDVB 02720007
         ST    R0,DRPLADA-DRPL(R7) ... FOR SUBSEQUENT RLD_REQ  @D14CDVB 02721007
         DROP  R5                                              @D14CDVB 02722007
FRQ45    L     R7,PFSTDBEG         ADDR OF CCW GENERATION AREA @D14CDVB 02723007
         L     R5,DRPLTIC          ADDR (TIC_CCW)              @D14CDVB 02724007
         ST    R7,0(R5)            TIC ADDRESS TO STANDARD...  @D14CDVB 02725007
         MVI   0(R5),TIC            ...CCW GENERATION AREA     @D14CDVB 02726007
FRQEXIT  L     R4,ORG4(RD)                                     @D14CDVB 02727007
         L     R5,ORG5(RD)                                     @D14CDVB 02728007
         L     R6,ORG6(RD)                                     @D14CDVB 02729007
         BR    LINK1               =====>  RETURN              @D14CDVB 02730007
         SPACE 1                                               @D149DVB 02731007
*-------------------------------------------------------------*@D149DVB 02732007
         SPACE 1                                                        02733007
FRQERR   DS    0H                                              @D37CDVB 02734007
*        SGCOV FETCHS,MC=31        I/O ERROR                   @D61NDVB 02735007
         SGCOV FETCHS,MC=31                                    @D61NDVB 02736007
         LA    RF,4                INDICATE CIL I/O ERROR      @D37CDVB 02737007
         L     R5,DFWKASLB         ADDR (SUBLIB_DEF_TAB)       @D14CDVB 02738007
         USING INLCSDTE,R5                                     @D14CDVB 02739007
         OI    SDTESTAT,SDTEIOER   INDICATE I/O ERROR          @D14CDVB 02740007
         DROP  R5                                              @D14CDVB 02741007
         CLI   DRPLID+1,TXTRQID    READ OF TXT_LB'S            @D61NDVB 02742007
         BNE   FRQER20             NO --->                     @D61NDVB 02743007
         L     R5,DFICBNXT(RE)     GET ADDRESS                 @D365DVB 02744007
         LA    R5,0(R5)                OF INTERRUPTED          @D365DVB 02745007
         SL    R5,F8                   CCW                     @D365DVB 02746007
         CL    R5,PFBEGRLD         EQUAL TO START OF RLD BUFFER@D14CDVB 02747007
         BNE   FRQER20             NO --->                     @D365DVB 02748007
         CLI   0(R5),READDATA      VALID CCW                   @D365DVB 02749007
         BE    FRQER20             YES --->                    @D365DVB 02750007
         CLI   0(R5),LOCT          VALID CCW                   @D14CDVB 02751007
         BE    FRQER20             YES --->                    @D14CDVB 02752007
         SLR   RF,RF               CLEAR RC                    @D365DVB 02753007
         LR    R5,RF                                           @D14CDVB 02754007
         IC    R5,DDTEDEV          DEVICE CODE                 @D14CDVB 02755007
         SLL   R5,2                 * 4                        @D14CDVB 02756007
         L     R5,PRLDCHN-4(R5)    START OF ACTUAL RLD_CCW_PROG@D14CDVB 02757007
FRQER10  ST    R5,DFICBCCW(RE)     ... INTO CCB                @D14CDVB 02758007
         B     FRQ25               --->  RESTART REST OF CCWS  @D14CDVB 02759007
FRQER20  TM    DFWKFLAG,FLRETCOD   REURN CODES REQUESTED       @D14CDVB 02760007
         BO    FRQER30             YES --->                    @D14CDVB 02761007
         L     R5,LPBPTR           ADDR(LIB_PTR_TAB)           @D14CDVB 02762007
         LTR   R5,R5               IF LPBPTR < 0 THEN USE      @D14CDHD 02763007
         BP    FRQER25                FETCH INTERNAL LIB. PTR  @D14CDHD 02764007
         L     R5,DALIBTAB                                     @D14CDHD 02765007
         USING INLCLPT,R5                                      @D14CDVB 02766007
FRQER25  L     R5,LPTBSDT          ADDR(SYSLIB-DEF_TAB)        @D14CDVB 02767007
         CL    R5,DFWKASLB         SYSLIB REQUEST              @D14CDVB 02768007
         BNE   FRQER30             =====> YES : CANCEL CONDIT. @D14CDVB 02769007
         L     R5,TIBPTR           ACTIVE TIB                  @D365DVB 02770007
         USING TIBADR,R5                                       @D365DVB 02771007
         TM    DFWKSWRQ,SYSAMASK   REQUESTOR SYSTEM TASK       @D64ADVB 02772007
         BO    FRQER40             YES -->                     @D365DVB 02773007
FRQER30  L     R2,OPRESA(RD)       GET REQUESTORS S.A.         @D14CDVB 02774007
         ST    RF,ORG15(R2)        PROVIDE RC                  @D14CDVB 02775007
         B     FRQEXIT             =====>                      @D14CDVB 02776007
         DROP  R5                                              @D365DVB 02777007
FRQER40  MVI   HWIDBYTE,HWFCHIO    FFE                         @D365DVB 02778007
         MVI   DFCBSTPF+3,8        INDICATE SCIL I/O ERROR     @D365DVB 02779007
         MVI   IJBHWORG,HWORG168   UNIQUE HARD WAIT ORIGINATOR @D31QDHB 02780007
         B     HARDWAIT            =====>    HARDWAIT FFE      @D14CDVB 02781007
         SPACE 1                                               @D14CDVB 02782007
*-------------------------------------------------------------*@D14CDVB 02783007
         EJECT                                                          02784007
*-------------------------------------------------------------*@D149DVB 02785007
*        ROUTINE PROLOGUE: REQEOC                              @D149DVB 02786007
*        ROUTINE NAME: REQEOC (I/O LAYER)                      @D149DVB 02787007
*        MACRO:        SGBFCH                                  @D149DVB 02788007
*        FUNCTION:     HANDLES EOC CONDITION FOR CKD LIBRARY   @D149DVB 02789007
*        CALLER:       REQIO                                   @D149DVB 02790007
*        OPERATION: GET  ADDRESS OF NEXT CCW                   @D149DVB 02791007
*                   IF 370-MODE                                @D149DVB 02792007
*                          THEN PROVIDE VIRTUAL ADDRESS        @D149DVB 02793007
*                   ENDIF                                      @D149DVB 02794007
*                   CALCULATE NEXT CYL NUMBER                  @D149DVB 02795007
*                   PROVIDE CCHHR IN DFICBC..                  @D149DVB 02796007
*                   GET ADDRESS OF INTERRUPTED CCW             @D149DVB 02797007
*                   IF TXT PROCESSING                          @D149DVB 02798007
*                          THEN IF 370-MODE                    @D149DVB 02799007
*                               THEN REAL ADDR OF INTERR. CCW  @D149DVB 02800007
*                               ENDIF                          @D149DVB 02801007
*                          SET TIC_ADDRESS TO INTERR. CCW      @D149DVB 02802007
*                   ENDIF                                      @D149DVB 02803007
*                   RETURN                                     @D149DVB 02804007
*        INPUT:        REG 14  RELATED CCB                     @D149DVB 02805007
*                      REG 6   ADDRESS OF SEARCH (CCHH)        @D61NDVB 02806007
*        OUTPUT:       UPDATED CCW PROGRAM                     @D149DVB 02807007
*        CALLING SEQUENCE:                                     @D149DVB 02808007
*                      BAL    LINK2,REQEOC                     @D149DVB 02809007
*                      B      XXXX          LABEL FOR RESTART  @D149DVB 02810007
*        CALLED ROUTINES:                                      @D149DVB 02811007
*                      GETADR (370-MODE)                       @D149DVB 02812007
*        RETURN:       CALLER                                  @D149DVB 02813007
*        ERROR EXITS:  FRDERRX (370-MODE)                      @D149DVB 02814007
*        REFERENCED DATA: RE --> RELATED CCB                   @D149DVB 02815007
*-------------------------------------------------------------*@D149DVB 02816007
         SPACE 1                                                        02817007
*SGLINK  REQEOC,INPUT=(R6,R7,R9,RB,RD,RE),WORK=(R0,R4,R5)      @D61NDVB 02818007
REQEOC   DS    0H                                                       02819007
*        SGCOV FETCHS,MC=30        EOC CONDITION               @D61NDVB 02820007
         SGCOV FETCHS,MC=30                                    @D61NDVB 02821007
         L     RF,DFICBNXT(RE)     ADDR (NEXT_CCW)             @D14CDVB 02822007
         SL    RF,F8               - 8 =: ADDR(INTERRUPTED CCW)@D14CDVB 02823007
         LA    R4,0(RF)                                        @D14CDVB 02824007
         SLR   RF,RF               RESET RC=0                  @D14CDVB 02825007
         LH    R0,CC@(,R6)         GET CYLINDER VALUE          @D61NDVB 02826007
         AH    R0,H1               INCREMENT CYLINDER VALUE    @D14CDVB 02827007
         STH   R0,CC@(,R6)         STORE BBCC VALUE            @D61NDVB 02828007
         LA    R0,256                                          @D14CDVB 02829007
         ST    R0,HH@(,R6)         SET NEW HHR VALUE           @D61NDVB 02830007
         L     R5,DRPLTIC          ADDR (TIC_CCW)              @D14CDVB 02831007
         USING CCWADR,R5                                       @D14CDVB 02832007
         ST    R4,CCWBUF           CONNECT BROKEN CCW STRING   @D14CDVB 02833007
         MVI   CCWCODE,TIC                                     @D14CDVB 02834007
         BR    LINK2               =====>   RESTART INTERRUPTED        *02835007
                                             CCW_POGRAM        @D14CDVB 02836007
         SPACE 1                                                        02837007
         DROP  R5                                              @D14CDVB 02838007
         SPACE 1                                               @D14CDVB 02839007
*---------------------------------------------------------------------* 02840007
         EJECT                                                          02841007
*-------------------------------------------------------------*@D149DVB 02842007
*        PROLOGUE :    DATA TYPE  FOR                          @D149DVB 02843007
*                      D I S K  A D D R E S S  D A T A         @D149DVB 02844007
*        ROUTINE NAME: REQDSK (I/O LAYER)                      @D149DVB 02845007
*        MACRO:        SGBFCH                                  @D149DVB 02846007
*        FUNCTION:     CONVERTS  R B A _ ADDRESS INTO          @D149DVB 02847007
*                         CCHHR FORMAT FOR CKD                 @D149DVB 02848007
*                         DEF_EXT AND LOCATE_DATA FOR FBM      @D149DVB 02849007
*        CALLER:       FRLD, REQIO                             @D149DVB 02850007
*        OPERATION: IF DEVICE = FBM                            @D149DVB 02851007
*                     THEN DO:                                 @D149DVB 02852007
*                        GET PH_BL := LOG_RECORDS/PHYS_BLOCKS  @D149DVB 02853007
*                        #FBM_BL := PH_BL * #LOG_REC           @D149DVB 02854007
*                        START(DEF_EXT) := START(SUBLIB)       @D149DVB 02855007
*                        START(LOCATE) := RBA * PH_BL          @D149DVB 02856007
*                        END(DEF_EXT):= #FBM_BL+START(LOCATE)-1@DA34905 02857007
*                        NEXT RBA := RBA + #LOG_REC            @D149DVB 02858007
*                        NBLOCKS(LOCATE) := #FBM_BL            @D149DVB 02859007
*                     ELSE DO:                                 @D149DVB 02860007
*                        R := RBA MOD (BLOCKS/TRACK)           @D149DVB 02861007
*                        IF R = 0                              @D149DVB 02862007
*                           THEN R = BLOCKS/TRACK              @D149DVB 02863007
*                                    / HIGHEST BLOCK-NR /      @D149DVB 02864007
*                           INT (RBA/(BLOCKS/TRACK)) :=        @D149DVB 02865007
*                                 INT (RBA/(BLOCKS/TRACK)) - 1 @D149DVB 02866007
*                        ENDIF                                 @D149DVB 02867007
*                        HH11 := INT (RBA/(BLOCKS/TRACKS))     @D149DVB 02868007
*                        CC11 := INT (HH11/(TRACKS/CYL))       @D149DVB 02869007
*                        HH11 := HH11 MOD (TRACKS/CYL)         @D149DVB 02870007
*                        HH := HH(START (SUBLIB) ) + HH11      @D149DVB 02871007
*                        CC := CC(START (SUBLIB) ) + CC11      @D149DVB 02872007
*                   ENDIF                                      @D149DVB 02873007
*                   RETURN                                     @D149DVB 02874007
*        INPUT:        REG 1 FRPL ADDRESS                      @D149DVB 02875007
*                      REG 2 DEVTAB ADDRESS                    @D149DVB 02876007
*                      REG 3 EXTTAB ADDRESS                    @D149DVB 02877007
*                      RBA ADDRESS                             @D149DVB 02878007
*        OUTPUT:       DISK ADDRESS DATA                       @D149DVB 02879007
*                      REG 6 :  ADDRESS OF LOCATE/SEARCH DATA  @D61NDVB 02880007
*                      REG F :  0                              @D149DVB 02881007
*        CALLING SEQUENCE:                                     @D149DVB 02882007
*                      BAL    LINK2,REQDSK                     @D149DVB 02883007
*        CALLED ROUTINES: NONE                                 @D149DVB 02884007
*        RETURN:       CALLER                                  @D149DVB 02885007
*        ERROR EXITS:  FRDERR24                                @D149DVB 02886007
*        REFERENCED DATA:                                      @D149DVB 02887007
*                      RBA - FIELD                             @D149DVB 02888007
*                      DISK ADDRESS DATA                       @D149DVB 02889007
*-------------------------------------------------------------*@D149DVB 02890007
         SPACE 2                                                        02891007
*SGLINK REQDSK,INPUT=(R1,R2,R3,R7,R9,RB),OUTPUT=(R6,RF),               *02892007
               WORK=(R0,R4,R5,RC)                              @D61NDVB 02893007
REQDSK   DS    0H                                                       02894007
         L     R5,DRPLADA          ACTUAL RBA                  @D14CDVB 02895007
         LTR   R5,R5               INVALID RBA ADDR            @D14CDVB 02896007
         BZ    FRDERR28            =====>                      @D14CDVB 02897007
         CL    R5,EOLBCHN          END OF LB_CHAIN             @D14CDVB 02898007
         BE    FRDERR24            =====> END_OF_LB CHAIN      @D14CDVB 02899007
         CLI   DDTEDEV,AVRFBA      REQUEST FOR FBM DEVICE      @D14CDVB 02900007
         BNE   FRQDS050            NO --->                     @D14CDVB 02901007
         SPACE 1                                               @D14CDVB 02902007
*-------------------------------------------------------------*@D14CDVB 02903007
*        PROVIDE DEF_EXT- AND LOCATE_DATA                     *@D14CDVB 02904007
*-------------------------------------------------------------*@D14CDVB 02905007
*        SGCOV FETCH,MC=30         FBA                         @D61NDVB 02906007
         SGCOV FETCH,MC=30                                     @D61NDVB 02907007
         L     R6,DRPALOC          ADDRESS (LOCATE DATA)       @D61NDVB 02908007
         L     RF,DRPADEXT         ADDRESS (DEF_EXT_DATA)      @D61NDVB 02909007
         IC    RC,DRPPHBL          2** VALUE OF FBM BLOCK      @D14CDVB 02910007
         L     R4,EDTESTRX         GET PHYSICAL BEG OF LIB EXT @D14CDVB 02911007
         ST    R4,DSEXTBL-DSDEFEXT(,RF) =:BEG OF DEFINE EXTENT @D14CDVB 02912007
         S     R5,EDTELODA         RBA IN CURRENT EXTENT       @D14CDVB 02913007
         SLL   R5,0(RC)            ... ** 2 ...                @D14CDVB 02914007
         ST    R5,LGBLA(,R6)       ...FOR LOCATE DATA          @D61NDVB 02915007
         LH    R4,DRPNRC           #(LOG_REC)...               @D14CDVB 02916007
         SLL   R4,0(RC)            ...  ** 2 ...               @D14CDVB 02917007
         STH   R4,NRBLCK(,R6)      =: #(PHYSICAL BLOCKS)       @D61NDVB 02918007
         ALR   R5,R4               BEG(LOG_BL_#) + #(PHYS_BL)  @D14CDBC 02919007
         BCTR  R5,0                -1 FOR CORRECT FBA VALUE    @DA34905 02920007
         CLI   DRPLID+1,TXTRQID    TXT REQUEST                 @D61NDVB 02921007
         BNE   FRQDS030            NO --->                     @D14CDVB 02922007
         TM    DFCBSW3,RLDIODLD    DELAYED RLD I/O             @D64ADVB 02923007
         BZ    FRQDS030            NO  --->                    @D14CDBC 02924007
         CL    R5,DSEXTEND-DSDEFEXT(,RF) IS RLD IN FRONT OF TXT@D61NDVB 02925007
         BNH   FRQDS040            YES ---->                   @D14CDBC 02926007
FRQDS030 EQU   *                                               @D14CDBC 02927007
         ST    R5,DSEXTEND-DSDEFEXT(RF)  = DEF_EXTENT_DATA(END_ADDR)...*02928007
                                   ... AS LOGICAL_BLOCK_#      @D14CDVB 02929007
FRQDS040 SLR   RF,RF                                           @D14CDVB 02930007
         BR    LINK2               =====>   RETURN             @D14CDVB 02931007
         SPACE 1                                               @D14CDVB 02932007
*-------------------------------------------------------------*@D14CDVB 02933007
*        CONVERSION INTO CKD FORM AND CALCULATION OF CCHHR     @D14CDVB 02934007
*-------------------------------------------------------------*@D14CDVB 02935007
FRQDS050 EQU   *                   NOTE: TXT REQ CONTAINS ZERO @D21ZDVB 02936007
         L     R6,DRPACHR          ADDRESS (SEARCH DATA)       @D61NDVB 02937007
         LA    R5,1(R5)            CONSIDER START OF CKD EXTENTS...    *02938007
                                   ... ALWAYS ON RECORD_NR 1   @D14CDVB 02939007
         SL    R5,EDTELODA         RBA IN CURRENT EXTENT       @D14CDVB 02940007
         SLR   R4,R4                                           @D14CDVB 02941007
         LH    R0,DDTEBLTR         #BLOCKS/TRACK               @D14CDVB 02942007
         DR    R4,R0               : =>BLOCK MOD(TRACK)        @D14CDVB 02943007
PCKLBF40 EQU   *                                               @D14CDVB 02944007
         LTR   R4,R4               CHECK FOR R = 0             @D14CDVB 02945007
         BNZ   FRQDS060            NO --->                     @D14CDVB 02946007
         LR    R4,R0               R := HIGHEST BLOCK NR       @D14CDVB 02947007
         BCTR  R5,0                ADJUST TO HIGHEST BLOCK NR  @D14CDVB 02948007
FRQDS060 STC   R4,R@(,R6)              ... R VALUE             @D61NDVB 02949007
         SLR   R4,R4                                           @D14CDVB 02950007
         LR    R0,R4                                           @D14CDVB 02951007
         LH    RC,DDTETRCY         #TRACKS/CYL                 @D14CDVB 02952007
         AH    R5,EDTESTRX+2       + HH (LIBRARY START)        @D14CDVB 02953007
         CLR   R5,RC               TRACK OVERFLOW              @D14CDVB 02954007
         BL    FRQDS070            NO --->                     @D14CDVB 02955007
         DR    R4,RC               : => R4 =: HH  R5 =: CC     @D14CDVB 02956007
PCKLBF50 EQU   *                                               @D14CDVB 02957007
         LR    R0,R5               R0 := CC VALUE              @D14CDVB 02958007
         LR    R5,R4               R5 := HH VALUE              @D14CDVB 02959007
FRQDS070 AH    R0,EDTESTRX         + CC (LIBRARY START)        @D14CDVB 02960007
         STH   R5,HH@(,R6)                   ...HH VALUE       @D61NDVB 02961007
         STH   R0,CC@(,R6)                   ...CC VALUE       @D61NDVB 02962007
         SPACE 1                                               @D61NDVB 02963007
         CLI   DDTEDEV,AVRECKD     REQUEST FOR ECKD            @D61NDVB 02964007
         BNE   FRQDS100            NO --->                     @D14CDVB 02965007
         SPACE 1                                               @D61NDVB 02966007
*-------------------------------------------------------------*@D61NDVB 02967007
*        PROVIDE EXTENT DEFINITION AND LOCATE DATA             @D61NDVB 02968007
*-------------------------------------------------------------*@D61NDVB 02969007
*        SGCOV FETCH,MC=31         ECKD                        @D61NDVB 02970007
         SGCOV FETCH,MC=31                                     @D61NDVB 02971007
         L     RF,DRPADEXT         ADDRESS (DEF_EXT_DATA)      @D61NDVB 02972007
         L     R4,EDTESTRX         PROVIDE LOWER LIMIT         @D61NDVB 02973007
         ST    R4,PFXECBEG-PFDEFXEC(,RF) ... AS CCHH           @D61NDVB 02974007
         L     R4,EDTEENDX         PROVIDE UPPER LIMIT         @D61NDVB 02975007
         ST    R4,PFXECEND-PFDEFXEC(,RF) ... AS CCHH           @D61NDVB 02976007
         L     RF,DRPALOC          ADDRESS (LOCATE_DATA)       @D61NDVB 02977007
         L     R4,XLOCCCHH-PFLOCXET(,RF) PROVIDE SEEK ADDRESS  @D61NDVB 02978007
         ST    R4,XLOCSEEK-PFLOCXET(,RF)  ... AS CCHH          @D61NDVB 02979007
         LH    R4,DRPNRC           #(LOG_REC)...               @D61NDVB 02980007
         STC   R4,XLOCNBR-PFLOCXET(,RF)      ... LOCATE        @D61NDVB 02981007
         SPACE 1                                               @D61NDVB 02982007
*-------------------------------------------------------------*@D14CDVB 02983007
FRQDS090 SLR   RF,RF               RE ESTABLISH RC = 0         @D21ZDVB 02984007
         BR    LINK2               =====>    RETURN            @D14CDVB 02985007
*-------------------------------------------------------------*@D14CDVB 02986007
FRQDS100 SLR   RF,RF               RE ESTABLISH RC = 0         @D61NDVB 02987007
*        SGCOV FETCH,MC=32         CKD/RPS                     @D61NDVB 02988007
         SGCOV FETCH,MC=32                                     @D61NDVB 02989007
         BR    LINK2               =====>    RETURN            @D61NDVB 02990007
         SPACE 1                                                        02991007
*-------------------------------------------------------------*@D14CDVB 02992007
         EJECT                                                          02993007
*--------------------------------------------------------------*        02994007
*        MODULE PROLOGUE: SETSCTR                                       02995007
*        ROUTINE NAME: SETSCTR                                          02996007
*        MACRO:        SGBFCH                                           02997007
*        FUNCTION:     DETERMINES THE SECTOR VALUE FOR RPS              02998007
*        CALLER:       FREAD                                            02999007
*        OPERATION: 1. GET (PHYSICAL) BLOCKLENGTH & DEVICE TYPE         03000007
*                   2. ESTABLISH ADDRESSIBILITY TO EXTN ROUTINE         03001007
*                   2. CALL SCVRTBAL.                                   03002007
*                   3. RE-ESTABLISH REGISTERS .                         03003007
*                   4. RETURN WITH SECTOR VALUE.                        03004007
*        INPUT:        FRPL ( --> BLOCKLENGTH )                         03005007
*                      EXTTAB( --> DEVICE TYPE )                        03006007
*                      BLOCK NUMBER ( IN REG 0 )                        03007007
*        OUTPUT:       SECTOR VALUE IN R0                               03008007
*        RETURN CODES: NONE                                             03009007
*        CALLED ROUTINES:                                               03010007
*                      SECTVAL                                          03011007
*        RETURN:       CALLER                                           03012007
*        ERROR EXITS:  NONE                                             03013007
*        REFERENCED DATA:                                               03014007
*                      EXTTAB(READ, EXTERNAL)                           03015007
*                      FRPL (READ)                                      03016007
*        NOTE:         THE EXRNAL INTERFACE TO SCVRTBAL MUST BE         03017007
*                      CONSIDERED.                                      03018007
*                      INPUT -  REG 0 --- BLOCKLENGTH 2 BYTES           03019007
*                                     --- BLOCKNUMBER 2 BYTES           03020007
*                               REG 1 --- DEVICE TYPE 1 BYTE            03021007
*                                     --- A(SECTVAL) 3 BYTES            03022007
*                      OUTPUT   REG 0 --- SECTOR VALUE                  03023007
*                      LINKAGE  REG 7                                   03024007
*        REGISTER CONVENTIONS:  R0   RECORD NUMBER                      03025007
*                               R1   FRPL                               03026007
*-------------------------------------------------------------*         03027007
         SPACE 1                                                        03028007
*SGLINK  SETSCTR,INPUT=(R2,R6,R7,R9)                           @D14CDVB 03029007
SETSCTR  DS    0H                                                       03030007
         ST    R7,ORG7(RD)         SAVE RETURN ADDRESS         @D14CDVB 03031007
         SLR   R0,R0               CLEAR REGISTER              @DA34985 03032007
         IC    R0,R@(,R6)          GET BLOCK NUMBER            @D61NDVB 03033007
         ICM   R0,M12,DRPLNLB      LEN(LB) INTO I/F REG        @D14CDVB 03034007
         L     R1,ARPSR            INCLUDE ADDRESS OF CONVERT ROUTINE   03035007
         ICM   R1,M8,DDTETYP       SET DEVICE TYPE             @D14CDVB 03036007
         L     R7,ASCVRTBA         GET ADDR OF SECTOR CON. RTN.@D52VDMZ 03037007
*        AMODESW CALL,REGS=(R7,R7)                                      03038007
         AMODESW CALL,REGS=(R7,R7)                             @D52VDMZ 03039007
         USING DRPL,R1             RE-ESTABLISH ADDR TO FRPL            03040007
         STC   R0,SECT@(,R6)       PROVIDE SECTOR VALUE        @D61NDVB 03041007
         LM    RF,R3,ORG15(RD)     RESTORE REGISTER ...        @D14CDVB 03042007
         L     R7,ORG7(RD)         .... VALUES                 @D14CDVB 03043007
         BR    LINK2               =====>   RETURN             @D14CDVB 03044007
         SPACE 1                                               @D14CDVB 03045007
*-------------------------------------------------------------*@D14CDVB 03046007
         EJECT                                                          03047007
*-------------------------------------------------------------*@D14CDVB 03048007
*        MODULE PROLOGUE: SCANLIB                              @D14CDVB 03049007
*        ROUTINE NAME: SCANLIB                                 @D14CDVB 03050007
*        MACRO:        SGBFCH                                  @D14CDVB 03051007
*        FUNCTION:  SEARCHES THE DIR_LB FOR REQUESTED PHASE-   @D14CDVB 03052007
*                   NAME AND RETURNS THE RBA OF RELATED LB     @D14CDVB 03053007
*                   CONTAINING THE DIRECTORY ENTRY             @D14CDVB 03054007
*        CALLER:       FREAD,....                              @D14CDVB 03055007
*        OPERATION: PROVIDE ADDR(DIR_LB)                       @D14CDVB 03056007
*                   PROVIDE OFFSET OF LBCF IN DIR_LB           @D14CDVB 03057007
*                   LOAD VARIABLES FOR TYPE SCAN               @D14CDVB 03058007
*                   DO WHILE LB ¬= PROCESSED                   @D14CDVB 03059007
*                     / NEITHER FOUND NOR NTFOUND NOR EOB /    @D14CDVB 03060007
*                     SELECT                                   @D14CDVB 03061007
*                       CASE EOB THEN RC = 8                   @D14CDVB 03062007
*                       CASE TYPE_NAME > 'PHASE' OR MEMBER_    @D14CDVB 03063007
*                          _NAME > SEARCH_NAME                 @D14CDVB 03064007
*                           THEN RC = 4                        @D14CDVB 03065007
*                       CASE TYPE_NAME = 'PHASE'               @D14CDVB 03066007
*                           THEN LOAD VARIABLES WITH DIR_SCAN  @D14CDVB 03067007
*                           RC = 12                            @D14CDVB 03068007
*                       CASE MEMBER_NAME = SEARCH_NAME         @D14CDVB 03069007
*                           THEN RC = 0                        @D14CDVB 03070007
*                       CASE MEMBER_NAME < SEARCH_NAME         @D14CDVB 03071007
*                            OR TYPE_NAME < 'PHASE'            @D14CDVB 03072007
*                           THEN BUMP TO NEXT LB_ENTRY         @D14CDVB 03073007
*                     ENDSELECT                                @D14CDVB 03074007
*                   ENDDO                                      @D14CDVB 03075007
*                   RETURN                                     @D14CDVB 03076007
*        INPUT:        PHASENAME IN TCB_FCHWORK                @D14CDVB 03077007
*                      R0 := SEARCH TYPE                       @D14CDVB 03078007
*                      R1 := ADDR (FRPL)                       @D14CDVB 03079007
*        OUTPUT:       R0 := LEN(RECORD_LENGTH IN LB)          @D14CDVB 03080007
*                      R3 := ADDRESS OF LENGTH FIELD           @D14CDVB 03081007
*                      R5 := ADDRESS OF INDEX / DIR ENTRY      @D14CDVB 03082007
*        CALLING SEQUENCE:                                     @D14CDVB 03083007
*                      L      RF,DASCNLIB                      @D14CDVB 03084007
*                      BALR   RE,RF                            @D14CDVB 03085007
*                      B      PHASE_FOUND                      @D14CDVB 03086007
*                      B      PHASE_NOT_FOUND                  @D14CDVB 03087007
*                      B      PHASE_NEXT_BLOCK                 @D14CDVB 03088007
*                      B      INDEX_FOUND                      @D14CDVB 03089007
*                      B      ERROR_28                         @D14CDVB 03090007
*                      B      BACK LEVEL SLD                   @D14CDHD 03091007
*        RETURN CODES: REG 15 : =                              @D14CDVB 03092007
*                             0  PHASENAME FOUND               @D14CDVB 03093007
*                             4  PHASENAME NOT FOUND           @D14CDVB 03094007
*                             8  READ NEXT LB                  @D14CDVB 03095007
*                            12  INDEXNAME FOUND               @D14CDVB 03096007
*                            16  ERROR                         @D14CDVB 03097007
*                            20  FIRST DE IN LB FOUND BY SLD   @D14CDHD 03098007
*                                SCAN > REQ. PHASE NAME        @D14CDHD 03099007
*        CALLED ROUTINES: NONE                                 @D14CDVB 03100007
*        RETURN:       CALLER                                  @D14CDVB 03101007
*        ERROR EXITS:  NONE                                    @D14CDVB 03102007
*        REFERENCED DATA:  LIB_DEF_TAB (READ)                  @D14CDVB 03103007
*                      FRPL (READ)                             @D14CDVB 03104007
*                      FCHWORK (READ)                          @D14CDVB 03105007
*-------------------------------------------------------------*@D14CDVB 03106007
         SPACE 1                                               @D14CDVB 03107007
*SGLINK  SCANLIB,INPUT=(),WORK=(),OUTPUT=()                    @D14CDVB 03108007
         DROP  R9                                              @D14CDVB 03109007
SCANLIB  DS    0H                                              @D14CDVB 03110007
         ST    RE,ORG14(RD)        SAVE REG, DO NOT DESTROY ...        *03111007
                                   ... SAVE AREA CONTENT (RF)  @D21ZDVB 03112007
         STM   R0,RC,ORG0(RD)      SAVE REGS                   @D21ZDVB 03113007
         USING SCANLIB,RF          SET BASE REG TO ENTRY POINT @D14CDVB 03114007
         AIF   (NOT &BGDSHR).NOSHR32                           @D14CDHD 03115007
         LR    RE,RB               GET ADDRESSABILITY TO THE   @D14CDHD 03116007
         DROP  RB                                              @D14CDHD 03117007
         USING DFCB,RE             FETCH WORK AREA             @D14CDHD 03118007
         OI    SLDFLAG,SLDGREAT    INDICATOR FOR SLD BACK LEVEL@D14CDHD 03119007
.NOSHR32 ANOP                                                  @D14CDHD 03120007
         USING INLCLBCF,R3                                     @D14CDVB 03121007
         L     R3,DRPLCIF          ADDR (LBCIF)                @D14CDVB 03122007
         L     R5,DRPLINP          START ADDR OF DIR_LB        @D14CDVB 03123007
         SLR   R2,R2                                           @D14CDVB 03124007
         LR    RC,R2                                           @D14CDVB 03125007
         LA    RB,ASCADR00         ADDR (SEARCH_TYP_DIR)       @D14CDVB 03126007
         CH    R0,HDNTEDIR         DIR_SEARCH_OPTION           @D14CDVB 03127007
         BE    SCNLB000            ---> YES                    @D14CDVB 03128007
         LA    RB,4(RB)            ADDR (SEARCH_TYP_IND)       @D14CDVB 03129007
SCNLB000 LA    R0,1                LENGTH FIELD = 1 BYTE       @D14CDVB 03130007
         LR    R1,R0               ICM_MASK FOR 1 BYTE = 1     @D14CDVB 03131007
         TM    LBCFFLG2,LBCFSRLI   LENGTH FIELD INDICATION     @D14CDVB 03132007
         BZ    SCNLB010            ---> IF 1BYTE LENGTH        @D14CDVB 03133007
         ALR   R0,R0               LENGTH FIELD = 2 BYTES      @D14CDVB 03134007
         ALR   R1,R0               ICM_MASK FOR 2 BYTES = 3    @D14CDVB 03135007
SCNLB010 SLR   R3,R0               ADDRESS OF NEXT  LENGTH FIELD...    *03136007
                                   ...IN THE LB                @D14CDVB 03137007
         EX    R1,SCNLBICM         LENGTH OF ENTRY             @D14CDVB 03138007
         LTR   R2,R2               EMPTY LB_BLOCK              @D14CDVB 03139007
         BZ    SCNLBEOB            YES --->                    @D14CDVB 03140007
         TM    DENTDEF1-DENTNAM(R5),DENTETYP  FIRST ENTRY TYP  @D14CDVB 03141007
         BZ    SCNLBERD            =====>                      @D14CDVB 03142007
SCNLB020 LA    R4,DENTETYP                                     @D14CDVB 03143007
         LA    R6,TYPENAME                                     @D14CDVB 03144007
         L     RB,0(RB)                                        @D14CDVB 03145007
         LM    R7,RB,0(RB)         VARIABLES FOR TYPE SCAN     @D14CDVB 03146007
SCNLB025 EX    R4,SCNLBTST         TEST ENTRY TYPE             @D14CDVB 03147007
PCKADR1D EQU   *                                               @D14CDVB 03148007
*                                                              @D14CDHD 03149007
         AIF   (&BGDSHR).SHR10                                 @D14CDHD 03150007
         BZR   R7                                              @D14CDHD 03151007
         AGO   .NOSHR33                                        @D14CDHD 03152007
.SHR10   ANOP                                                  @D14CDHD 03153007
         BO    SCNLB027                                        @D14CDHD 03154007
         TM    SLDFLAG,SLDIND      CURRENT BLOCK FOUND BY SLD? @D14CDHD 03155007
         BZR   R7                  NO                          @D14CDHD 03156007
         TM    DENTDEF1-DENTNAM(R5),DENTEHLX   INDEX BLOCK     @D14CDHD*03157007
                                   FOUND BY SLD SCAN ?                  03158007
         BZR   R7                  NO                          @D14CDHD 03159007
         B     SCNLSLD             RETURN WITH RC 20           @D14CDHD 03160007
.NOSHR33 ANOP                                                  @D14CDHD 03161007
*                                                              @D14CDHD 03162007
SCNLB027 CLC   0(L'DFWKNAME,R5),0(R6)                          @D14CDVB 03163007
         BHR   R9                  =====>  EXIT                @D14CDVB 03164007
         BER   RA                  FOUND                       @D14CDVB 03165007
         AIF   (NOT &BGDSHR).NOSHR34                           @D14CDHD 03166007
         NI    SLDFLAG,XFF-SLDGREAT IF THE 'LOWER PART' IS     @D14CDHD*03167007
                             NEVER EXECUTED, THEN THE SLD COULD        *03168007
                             BE IN BACK LEVEL STATE                     03169007
.NOSHR34 ANOP                                                  @D14CDHD 03170007
         BR    R8                  LOW                         @D14CDVB 03171007
SCNLB030 L     R4,ORG0(RD)         SEARCH_OPTION               @D14CDVB 03172007
         L     RA,ORG10(RD)        ADDR (FETCH_WORK)           @D14CDVB 03173007
         LA    R6,DFWKNAME         SEARCH_NAME                 @D14CDVB 03174007
         L     RB,4(RB)                                        @D14CDVB 03175007
         LM    R7,RB,0(RB)         VARIABLES FOR DIR SCAN      @D14CDVB 03176007
SCNLB040 ALR   R5,R2               BUMP TO NEXT ENTRY          @D14CDVB 03177007
         SLR   R3,R0               ADDRESS OF NEXT  LENGTH FIELD...    *03178007
                                   ...IN THE LB                @D14CDVB 03179007
         EX    R1,SCNLBICM         LENGTH OF ENTRY             @D14CDVB 03180007
         LTR   R2,R2               EOB CONDITION               @D14CDVB 03181007
         BP    SCNLB025            --->     SEARCH FURTHER DIR @D14CDVB 03182007
         B     SCNLBEOB            YES --->                    @D14CDVB 03183007
         SPACE 1                                               @D14CDVB 03184007
SCNLB050 CL    R5,SCNBUFFA         BEGIN OF LB                 @D21ZDVB 03185007
         BNE   SCNLB060            NO   --->                   @D21ZDVB 03186007
         EX    R1,SCNLBICM         LENGTH OF ENTRY             @D21ZDVB 03187007
         ALR   R5,R2               ADDRESS OF FIRST MEMBER ENTRY FROM  *03188007
                                   ...WHICH MUST BE SEARCHED   @D21ZDVB 03189007
         B     SCNLBRET            --->                        @D21ZDVB 03190007
SCNLB060 ALR   R3,R0               ADDR PRECEEDING LENGT FIELD @D21ZDVB 03191007
         EX    R1,SCNLBICM         LENGTH OF ENTRY             @D21ZDVB 03192007
         SLR   R5,R2               ADDRESS OF PRECEEDING ENTRY FROM    *03193007
                                   ...WHICH MUST BE SEARCHED   @D21ZDVB 03194007
         B     SCNLBRET            --->                        @D21ZDVB 03195007
         SPACE 1                                               @D21ZDVB 03196007
*-------------------------------------------------------------*@D21ZDVB 03197007
         SPACE 1                                               @D21ZDVB 03198007
SCNLNTFD EQU   *                                               @D14CDHD 03199007
         AIF   (NOT &BGDSHR).NOSHR36                           @D14CDHD 03200007
         TM    SLDFLAG,SLDIND      DIR. BLOCK FOUND BY SLD SCAN@D14CDHD 03201007
         BZ    SCNLNOTF            NO  ---->                   @D14CDHD 03202007
         TM    SLDFLAG,SLDGREAT    'GREATER' LB FOUND?         @D14CDHD 03203007
         BO    SCNLSLD             YES -> MAY BE BACK LEVEL SLD@D14CDHD 03204007
.NOSHR36 ANOP                                                  @D14CDHD 03205007
         B     SCNLNOTF                                        @D14CDHD 03206007
         SPACE 1                                               @D14CDVB 03207007
         AIF   (NOT &BGDSHR).NOSHR31                           @D14CDHD 03208007
SCNLSLD  OI    SLDFLAG,SLDBACKL    SET SLDBACKL FLAG TO AVOID  @D14CDHD*03209007
                                   FURTHER SLD SEARCH                   03210007
         LA    RC,4                MIGHT BE BACK LEVEL SLD     @D14CDHD 03211007
.NOSHR31 ANOP                                                  @D14CDHD 03212007
SCNLBERD LA    RC,4(RC)            ERROR                       @D14CDVB 03213007
SCNLBHMK LA    RC,4(RC)            INDEX NAME FOUND            @D14CDVB 03214007
SCNLBEOB LA    RC,4(RC)            EOB CONDITION               @D14CDVB 03215007
SCNLNOTF LA    RC,4(RC)            NOT FOUND CONDITION         @D14CDVB 03216007
SCNLBRET EQU   *                                               @D14CDVB 03217007
         LR    RF,RC               PROVIDE RC                  @D14CDVB 03218007
         AIF   (NOT &BGDSHR).NOSHR35                           @D14CDHD 03219007
         DROP  RE                                              @D14CDHD 03220007
.NOSHR35 ANOP                                                  @D14CDHD 03221007
         LM    R6,RC,ORG6(RD)      RESTORE PASSED REGISTER     @D21ZDVB 03222007
         L     R1,ORG1(RD)              ......                 @D14CDVB 03223007
         L     R2,ORG2(RD)              ......                 @D14CDVB 03224007
         L     RE,ORG14(RD)             ......                 @D21ZDVB 03225007
         BR    RE                       =====>                 @D14CDVB 03226007
         SPACE 1                                               @D14CDVB 03227007
*-------------------------------------------------------------*@D14CDVB 03228007
         SPACE 1                                               @D14CDVB 03229007
SCNLBICM ICM   R2,0,0(R3)                                      @D14CDVB 03230007
SCNLBTST TM    DENTDEF1-DENTNAM(R5),0                          @D14CDVB 03231007
         SPACE 1                                               @D14CDVB 03232007
TYPENAME DC    CL8'PHASE'                                      @D14CDVB 03233007
HDNTEDIR DC    AL2(DENTEDIR)                                   @D14CDVB 03234007
SCNBUFFA DC    A(FDIRBUF)                                      @D21ZDVB 03235007
         DROP  R1,R2,R3,RF,RA                                  @D14CDVB 03236007
         SPACE 1                                               @D14CDVB 03237007
*-------------------------------------------------------------*@D14CDVB 03238007
   TITLE 'DOS SUPERVISOR   SGBFCH  HIPROG UPDATE SERVICE         ** 94/*03239007
               03/10 **'                                       @D14CDVB 03240007
*-------------------------------------------------------------*         03241007
*  MODULE PROLOGUE: MULTIPHS                                            03242007
*    ROUTINE NAME: MULTIPHS                                             03243007
*    MODULE:       SGBFCH                                               03244007
*    FUNCTION:     SCANS THE SPECIFIED LIBRARY FOR THE LARGEST          03245007
*                  MEMBER OF A MULTIPHASE PROGRAM AND UPDATES           03246007
*                  THE HIPROG VALUE OF THE CORRESPONDING                03247007
*                  PARTITION COMMUNICATION REGION.                      03248007
*    CALLER:       FETCH BASE                                           03249007
*    OPERATION: IF SIZE=PHASENAME OR PHASE = VIO(LINK)         @D149DVB 03250007
*                  THEN HIPROG = LOAD_ADDR(PHASE)+BEGADDR(PART)@D149DVB 03251007
*                  ELSE IF PHASE = SVA_PHASE                   @D149DVB 03252007
*                         THEN HIPROG = BEGADDR(PART)+PAGESIZE @D149DVB 03253007
*                         ELSE DO                              @D149DVB 03254007
*                         GET ADDR(CHAIN_ENTRY)                @D149DVB 03255007
*                         BUILD FRPL                           @D149DVB 03256007
*                         DEFINE PHASE_SET BY CUT_OFF THE      @D149DVB 03257007
*                                 PHASENAME TO FOUR BYTES      @D149DVB 03258007
*                     L1: READ DIR_LB VIA FRPL                 @D149DVB 03259007
*                         CALL SCANLIB   /*SCAN FOR PHASENAME*/@D149DVB 03260007
*                         DO WHILE ¬END_OF_PHASE_SER           @D149DVB 03261007
*                           GET FIRST/NEXT DIRECTORY_ENTRY     @D149DVB 03262007
*                           IF NEXT_LB_COND GOTO L1            @D149DVB 03263007
*                           CALL CALCHPROG                     @D149DVB 03264007
*                         ENDDO                                @D149DVB 03265007
*                         ENDDO (ELSE)                         @D149DVB 03266007
*                      ENDIF                                   @D149DVB 03267007
*               ENDIF                                          @D149DVB 03268007
*               RETURN ;                                       @D149DVB 03269007
*    INPUT:     SEE REFERENCED DATA                            @D149DVB 03270007
*    OUTPUT:    UPDATED HIPROG VALUE IN COMREG                          03271007
*    RETURN CODES: NONE                                                 03272007
*    CALLED ROUTINES: READ                                              03273007
*    RETURN:       CALLER                                               03274007
*    ERROR EXITS:  NONE                                        @D149DVB 03275007
*    REFERENCED DATA:                                                   03276007
*                  SUBLIB_DEF_TAB (READ,EXTERNAL)              @D149DVB 03277007
*                  FCHWORK (READ,UPDATE)                                03278007
*                  CHAIN (READ,UPDATE)                                  03279007
*                  FCB (READ)                                           03280007
*                  COMREG(UPDATE)                                       03281007
*-------------------------------------------------------------*         03282007
         SPACE 2                                                        03283007
*SGLINK  MULTIPHS,INPUT=(RA,RB,RD,RE)                          @D369DVB 03284007
         DS    0H                                              @D14CDVB 03285007
         DC    CL8'MULTIPHS'                                   @D14CDVB 03286007
         DC    CL8'94/04/10'                                   @D64ADVB 03287007
MULTIPHS DS    0H                                                       03288007
         SLR   RF,RF                                           @D14CDVB 03289007
         STM   RE,R9,ORG14(RD)                                 @D367DVB 03290007
         BALR  R9,0                LOAD BASE REGISTER          @D36IDVB 03291007
         USING *,R9                )             <- BASE       @D36IDVB 03292007
         USING DFCB,RB             )  ESTABLISH  <- DATA AREA  @D36IDVB 03293007
         USING TCBADR,RA           )  BILITY     <- TCB        @D36IDVB 03294007
         LA    R2,DMULTSA          LOCAL SAVE AREA                      03295007
         ST    RD,OPRESA(R2)       ) CHAIN SAVE AREA POINTERS  @D367DVB 03296007
         LR    RD,R2               STANDARD SAVE AREA POINTER  @D367DVB 03297007
         L     R2,DFWKCOMG         ADDR (COMREG)               @D14CDVB 03298007
         USING COMREG,R2                                       @D14CDVB 03299007
         SPACE 1                                               @D14CDVB 03300007
*-------------------------------------------------------------*@D14CDVB 03301007
*    CHECK FOR LINK_PHASE ON VIO OR SIZE=PHASENAME            *@D14CDVB 03302007
*-------------------------------------------------------------*@D14CDVB 03303007
         SPACE 1                                               @D14CDVB 03304007
         TM    DFCBSW2,FLNKVIO    SYSLINK_VIO PHASE            @D14CDVB 03305007
         BO    FMULT010           YES -->                      @D14CDVB 03306007
         TM    DFWKFLAG,SIZNAME   SIZE = PHASENAME REQUEST     @D37CDVB 03307007
         BZ    NOTSIZE            NO -->                       @D37CDVB 03308007
FMULT010 LA    R6,DFWKESWT-(UPHAFLG-INLCUPHA)                  @D14CDVB 03309007
*SGLINK  CLPHASLN,INPUT=(R2,R6,R7,R9,RA),WORK=(R4)             @D149DVB 03310007
         BAL   LINK2,CLPHASLN     CALCULATE HIGH ADDRESS       @D14CDVB 03311007
         B     MULTIRTN           --->                         @D37CDVB 03312007
         SPACE 1                                               @D14CDVB 03313007
NOTSIZE  TM    DFWKESWT,SVAPHASE  IS PHASE IN SVA ?                     03314007
         BZ    NOTSVA4            NO  --->                              03315007
         L     R1,DFWKOV          GET PARTITION START ADDRESS           03316007
         AL    R1,PAGESIZE          ) ADD PAGESIZE             @D14CDVB 03317007
         ST    R1,HIPROG            ) AND STORE IT                      03318007
         B     MULTIRTN           ---> RETURN                           03319007
         DROP  R2                                              @D14CDVB 03320007
         SPACE 1                                               @D14CDVB 03321007
*-------------------------------------------------------------*@D14CDVB 03322007
         SPACE 1                                               @D14CDVB 03323007
NOTSVA4  L     R4,DFWK1STL        ADDR (ACTUAL CHAIN ENTRY)    @D14CDVB 03324007
         LA    R1,FBLDDIR         DIR ID                       @D14CDVB 03325007
*SGLINK  MLTREAD,INPUT=(R1,R6,R9,RA,RB,RD),OUTPUT=(R1,RF),WORK=(RE)     03326007
         BAL   LINK3,MLTREAD      BUILD FRPL                            03327007
*                                 AT THIS POINT REG15 = X'0'   @D14CDVB 03328007
         ST    RF,DFWKNAME+4      LAST FOUR BYTES IN NAME_FIELD...     *03329007
                                           ...==>   X'00'      @D14CDVB 03330007
         NI    DFCBSW1,XFF-IDERR  CLEAR IDERR FLAG             @D64ADVB 03331007
FMULT055 EQU   *                                                        03332007
         L     R1,DSRPLDIR                                     @D14CDVB 03333007
         BAL   LINK3,MLTREAD      READ DIRECTORY                        03334007
         SPACE 1                                               @D149DVB 03335007
*-------------------------------------------------------------*@D149DVB 03336007
*      SCAN DIRECTORY BLOCK                                   *@D149DVB 03337007
*-------------------------------------------------------------*@D149DVB 03338007
         SPACE 1                                               @D149DVB 03339007
         LA    R0,DENTEDIR        SEARCH_OPTION = DIR          @D14CDVB 03340007
         L     RF,DASCNLIB        ENTRY POINT TO SCANLIB       @D14CDVB 03341007
         BALR  RE,RF              SCAN FOR PHASENAME           @D14CDVB 03342007
         B     FMULTABX(RF)       BR_TAB FOR RETURN CODES      @D14CDVB 03343007
FMULTABX B     FMULT070           ENTRY FOUND IN LB            @D14CDVB 03344007
         B     FMULT070           NOT FOUND                    @D14CDVB 03345007
         B     FMULT055           NEXT BLOCK ON SAME LEVEL     @D14CDVB 03346007
         B     FMULT070           ENTRY FOUND IN LB            @D14CDVB 03347007
         B     FMULT075           ERROR CONDITION              @D14CDHD 03348007
         AIF   (NOT &BGDSHR).NOSHR29                           @D14CDHD 03349007
         B     FMULT070           1. DE IN LB > REQ. DE        @D14CDHD 03350007
         AGO   .NOSHR25                                                 03351007
.NOSHR29 ANOP                                                           03352007
*                                                                       03353007
         LA    RF,48              RETURN WITH INTERNAL ERROR   @D14CDHD 03354007
         B     MLTERROR                                        @D14CDHD 03355007
.NOSHR25 ANOP                                                           03356007
FMULT075 LA    RF,4(RF)                                        @D14CDVB 03357007
         B     MLTERROR           ERROR CONDITION              @D14CDVB 03358007
FMULT070 LR    R1,R0              LENGTH OF LENGTH_FIELD       @D14CDVB 03359007
         ALR   R1,R0              * 2                          @D14CDVB 03360007
         BCTR  R1,0               -1  =:  ICM _ MASK FOR LENGTH@D14CDVB 03361007
         USING INLCDENT,R5                                     @D14CDVB 03362007
FMULT080 TM    DENTDEF1,DENTEDIR  DIRECTORY ENTRY              @D14CDVB 03363007
         BZ    FMULT100           NO  --->  TEST IF MORE PHASE...      *03364007
                                            ENTRIES AVAILABLE  @D14CDVB 03365007
         CLC   DFWKNAME(4),0(R5)  FIRST 4 CHARS. MATCH ?       @D14CDVB 03366007
         BNE   MULTIRTN           NO  --->  EXIT               @D14CDVB 03367007
         SPACE 1                                               @D14CDVB 03368007
*SGLINK  CALCHPRG,INPUT=(R5,R7,R9,RA),WORK=(R2,R4,R6)          @D149DVB 03369007
         BAL   LINK2,CALCHPRG     CALCULATE HIPROG                      03370007
FMULT090 SLR   R3,R0              ADDRESS OF NEXT  LENGTH FIELD...     *03371007
                                  ...IN THE LB                 @D14CDVB 03372007
         SLR   R2,R2              CLEAR R2 FOR ICM_INSTR.      @D14CDVB 03373007
         EX    R1,FMULTICM        LENGTH OF ENTRY              @D14CDVB 03374007
         LTR   R2,R2              EOB CONDITION                @D14CDVB 03375007
         BZ    FMULT055           YES, BRANCH                  @DA36525 03376007
         ALR   R3,R0              POINT BACK TO ORIGIN LENGTH  @DA36525 03377007
         EX    R1,FMULTICM        LENGTH OF ENTRY              @DA36525 03378007
         ALR   R5,R2              BUMP TO NEXT DIR ENTRY       @DA36525 03379007
         SLR   R3,R0              NEXT LENGTH FIELD AGAIN      @DA36525 03380007
         B     FMULT080           ----->                       @D14CDVB 03381007
         SPACE 1                                               @D14CDVB 03382007
FMULT100 CLC   TYPEHASE,0(R5)     MORE PHASE ENTRIES           @D14CDVB 03383007
         BE    FMULT090           ----->                       @D14CDVB 03384007
         DROP  R5                                              @D14CDVB 03385007
         SPACE 1                                               @D149DVB 03386007
*-------------------------------------------------------------*@D149DVB 03387007
*      EXIT                                                   *@D149DVB 03388007
*-------------------------------------------------------------*@D149DVB 03389007
         SPACE 1                                               @D14CDVB 03390007
MULTIRTN L     RD,DMULTSA+OPRESA   RESTORE SAVE AREA POINTER   @D14CDVB 03391007
         LM    RE,R9,ORG14(RD)     RELOAD REGISTERS            @D367DVB 03392007
*        AMODESW RETURN,REG=(RE)   ==========>  RETURN         @D64ADVB 03393007
         AMODESW RETURN,REG=(RE)   ==========>  RETURN         @D64ADVB 03394007
         SPACE 1                                               @D149DVB 03395007
FMULTICM ICM   R2,0,0(R3)                                      @D14CDVB 03396007
TYPEHASE DC    CL8'PHASE'                                      @D14CDVB 03397007
         SPACE 1                                               @D14CDVB 03398007
*-------------------------------------------------------------*@D149DVB 03399007
         EJECT                                                 @D149DVB 03400007
*-------------------------------------------------------------*@D149DVB 03401007
*        MODULE PROLOGUE: CALCHPRG                             @D149DVB 03402007
*        ROUTINE NAME: CALCHPRG                                @D149DVB 03403007
*        MACRO:        SGBFCH                                  @D149DVB 03404007
*        FUNCTION:  UPDATES COMREG.HIPROG                      @D149DVB 03405007
*        CALLER:    MULTIPHS                                   @D149DVB 03406007
*        OPERATION: SEARCH PHASE_VIF IN DIRECTORY_ENTRY        @D149DVB 03407007
*                   IF ¬ PHASE_VIF THEN RETURN                 @D149DVB 03408007
*                      ELSE DO                                 @D149DVB 03409007
*                      SELECT                                  @D149DVB 03410007
*                        CASE PHASE ¬ RELOCATABLE              @D149DVB 03411007
*                             THEN A=LEN(PHASE)                @D149DVB 03412007
*                        CASE PHASE RELOCATABLE                @D149DVB 03413007
*                             THEN A=LEN(PHASE)+OVERW(LOADADDR)@D149DVB 03414007
*                        CASE PHASE SELFRECOCATABLE            @D149DVB 03415007
*                             THEN A=OVERW(LOADADDR)           @D149DVB 03416007
*                      ENDSELECT                               @D149DVB 03417007
*                      IF A+LOADADDR(PHASE,DE) > HIPROG        @D149DVB 03418007
*                         THEN HIPROG = A+LOADADDR(PHASE,DE)   @D149DVB 03419007
*                      ENDDO                                   @D149DVB 03420007
*                   RETURN;                                    @D149DVB 03421007
*        INPUT:     DIRECTORY_ENTRY                            @D149DVB 03422007
*        OUTPUT:    HIPROG                                     @D149DVB 03423007
*        CALLING SEQUENCE:                                     @D149DVB 03424007
*                   BAL  LINK2,CALCHPRG                        @D149DVB 03425007
*        OR         BAL  LINK2,CLPHASLN  /* SECONDARY ENTRY  */@D149DVB 03426007
*        RETURN CODES: NONE                                    @D149DVB 03427007
*        CALLED ROUTINES: NONE                                 @D149DVB 03428007
*        RETURN:       CALLER                                  @D149DVB 03429007
*        ERROR EXITS:  NONE                                    @D149DVB 03430007
*        REFERENCED DATA:  DIRECTORY ENTRY (READ)              @D149DVB 03431007
*                      COMREG(HIPROG)(UPDATE,EXTERNAL)         @D149DVB 03432007
*-------------------------------------------------------------*@D14CDVB 03433007
         SPACE 1                                               @D14CDVB 03434007
*SGLINK  CALCHPRG,INPUT=(R5,R7,R9,RA),WORK=(R2,R4,R6)          @D149DVB 03435007
CALCHPRG DS    0H                                              @D14CDVB 03436007
         L     R2,DFWKCOMG        ADDR(PART_COMREG)            @D14CDVB 03437007
         USING COMREG,R2                                       @D14CDVB 03438007
         USING INLCDENT,R5                                     @D14CDVB 03439007
         TM    DENTDEF3,DENTVIF   ANY PHASE AREA AVAILABLE     @D14CDVB 03440007
         BZR   LINK2              =====>    NO : DO NOT CONSIDER       *03441007
                                            MEMBER             @D14CDVB 03442007
         LH    R6,DENTVIFL        LEN(COMMON_PART OF DIR_ENT)  @D14CDVB 03443007
         ALR   R6,R5              + ADDR(DIR_ENTRY)                    *03444007
                                  =: ADDR(FIRST VIF)           @D14CDVB 03445007
         USING INLCUPHA,R6                                     @D14CDVB 03446007
         L     R4,DSPHASID        PHASE IDENTIFIER             @D14CDVB 03447007
CLNXTVIR CL    R4,UPHAEID         VIF = PHASE_TYPE             @D14CDVB 03448007
         BE    CLPHASLN           YES -->                      @D14CDVB 03449007
         AH    R4,UPHAELEN        GO TO NEXT VIF               @D14CDVB 03450007
         TM    UPHAEAT1,DENTVIF   AT LEAST ONE MORE VIF        @D14CDVB 03451007
         BO    CLNXTVIR           YES --->                     @D14CDVB 03452007
         BR    LINK2              =====> DO NOT CONSIDER MEMBER@D14CDVB 03453007
         SPACE 1                                               @D14CDVB 03454007
*SGLINK  CLPHASLN,INPUT=(R2,R6,R7,R9,RA),WORK=(R4)             @D149DVB 03455007
CLPHASLN L     R4,UPHAPLN         R4 : LENGTH OF PHASE         @D14CDVB 03456007
         TM    UPHAFLG,UPHABSR+UPHABRL PHASE NOT RELOCATABLE   @D14CDVB 03457007
         BZ    ADDLPNT            YES --->                     @D14CDVB 03458007
         AL    R4,DFWKOV          ADD PROGRAM START AREA       @D14CDVB 03459007
         TM    UPHAFLG,UPHABSR    IS PHASE SELFRELOCATABLE ?   @D14CDVB 03460007
         BO    ADDLPNT            YES --->                     @D14CDVB 03461007
         SL    R4,UPHASTR         SUBTRACT FROM LOADPOINT      @D14CDVB 03462007
ADDLPNT  AL    R4,UPHALPT         ADD LOAD POINT OF PHASE      @D14CDVB 03463007
         BCTR  R4,0               R4 : END ADDR OF PHASE       @D14CDVB 03464007
         L     R6,HIPROG          GET OLD HIPROG OUT OF COMREG @D14CDVB 03465007
         CLR   R4,R6              IS IT GREATER ?              @D14CDVB 03466007
         BNHR  LINK2              =====>   YES, THEN RETURN    @D14CDVB 03467007
         ST    R4,HIPROG          NO, THEN SET NEW HIPROG VALUE@D14CDVB 03468007
         BR    LINK2              ====>    RETURN              @D14CDVB 03469007
         DROP  R2,R5,R6                                        @D14CDVB 03470007
         SPACE 1                                               @D14CDVB 03471007
*-------------------------------------------------------------*@D14CDVB 03472007
         SPACE 2                                               @D14CDVB 03473007
*-------------------------------------------------------------*@D14CDVB 03474007
*      READ DIRECTORY ENTRY/BUILD FRPL SUBROUTINE                       03475007
*-------------------------------------------------------------*@D14CDVB 03476007
         SPACE 1                                               @D14CDVB 03477007
*SGLINK  MLTREAD,INPUT=(R1,R6,R9,RA,RB,RD),OUTPUT=(R1,RF),WORK=(RE)     03478007
MLTREAD  DS    0H                                              @D36JDVB 03479007
         AIF   (NOT &BGDSHR).NOSHRM1                                    03480007
         OI    MULTFLAG,MULTON                                 @D14CDHD 03481007
.NOSHRM1 ANOP                                                           03482007
         L     RF,DAREAD          GET @ OF READ ROUTINE        @D367DVB 03483007
*SGLINK  FREAD,INPUT=(R1,RA,RB,RD,RE),OUTPUT=(R1,RF)           @D369DVB 03484007
*        AMODESW CALL,REGS=(RE,RF)                             @D64ADVB 03485007
         AMODESW CALL,REGS=(RE,RF)                             @D64ADVB 03486007
         AIF   (NOT &BGDSHR).NOSHRM2                                    03487007
         NI    MULTFLAG,XFF-MULTON                             @D14CDHD 03488007
.NOSHRM2 ANOP                                                           03489007
         LTR   RF,RF              TEST RETURN CODE             @D367DVB 03490007
         BZR   LINK3              =====>    RETURN ALL RIGHT   @D14CDVB 03491007
         SPACE 1                                               @D14CDVB 03492007
*-------------------------------------------------------------*@D14CDVB 03493007
*      ERROR ROUTINE                                                    03494007
*-------------------------------------------------------------*@D14CDVB 03495007
MLTERROR LR    R5,RF                                           @D14CDVB 03496007
MLTBRTAB B     MLTBRTAB(R5)                                    @D14CDVB 03497007
         B     MLTERV               4: PCIL I/O                @D14CDVB 03498007
         B     MLTHWT               8: N/A                     @D14CDVB 03499007
         B     MLTHWT              12: INTERFACE---> HARD WAIT @D14CDVB 03500007
         B     MLTHWT              16: TFIX                    @D14CDVB 03501007
         B     MLTCHLB             20:  RBA IN INVALID EXTENT  @D14CDVB 03502007
         B     MULTIRTN            24:  END_OF_LB CHAIN                *03503007
                                   =====>    ALL DONE          @D14CDVB 03504007
         B     MLTERLB             28:  INVALID LIB. STRUCTURE @D14CDVB 03505007
         B     MLTERLB             32:  N/A PHASE NOT FOUND    @D14CDVB 03506007
         B     MLTHWT              36:  INVALID ADDRESS        @D14CDHD 03507007
         B     MLTHWT              40:  PHASE DOES NOT FIT     @D14CDHD 03508007
         B     MLTHWT              44:  NOT USED               @D14CDHD 03509007
         B     MLTHWT              48:  INTERAL ERROR          @D14CDHD 03510007
         SPACE 1                                               @D14CDVB 03511007
         USING DRPL,R1                                         @D14CDVB 03512007
MLTCHLB  L     R0,DRPLADA          IF ...                      @D14CDVB 03513007
         CL    R0,EOLBCHN          ... END_OF_LB_CHAIN...      @D14CDVB 03514007
         BE    MULTIRTN            =====>     RETURN ALL DONE  @D14CDVB 03515007
         SPACE 1                                               @D14CDVB 03516007
         AIF   (NOT &BGDSHR).NOSHR41                           @D14CDHD 03517007
.NOSHR41 ANOP                                                  @D14CDHD 03518007
         SPACE 1                                                        03519007
MLTERLB  MVI   DFWKRCOD,NVALIB12   NO VALID LIBRARY STRUCTURE  @D14CDVB 03520007
         B     MLTERX              --->                        @D14CDVB 03521007
         SPACE 1                                               @D14CDVB 03522007
MLTERV   MVI   DFWKRCOD,FIOERR8    FETCH I/O ERROR             @D14CDVB 03523007
MLTERX   EQU   *                                               @D14CDVB 03524007
         LM    R1,R4,DFWKALIB      SAVE TCB_CONTENT            @D14CDVB 03525007
         STC   R5,DFWKANAM-1       PROVIDE RC                  @D14CDVB 03526007
         MVC   DFWKALIB(7),0(R2)   PROVIDE FIRST 7 CHARACTERS...       *03527007
                                   ... OF SUBLIBRARY NAME      @D14CDVB 03528007
         MVC   DFWKANAM(L'DFWKNAME),DFWKNAME                   @D14CDVB 03529007
         LA    R0,DFWKALIB         ADDR OF DISPLAY AREA        @D14CDVB 03530007
         ST    R0,XXUSAREA         ... TO DEBUG AREA           @D14CDVB 03531007
         DEBUG DSPLYDAT,XXDBGMC                                @D61NDMZ 03532007
         STM   R1,R4,DFWKALIB      RESET ADDR (SUBLIB) AND             *03533007
                                   ...   ADDR(PHASENAME)       @D14CDVB 03534007
         STM   R1,R2,TCBCINF       STORE TCBCASLB,TCBCALIB     @DY45682 03534109
         LA    RE,TCBCSNAM         STORE                       @DY45682 03535109
         ST    RE,TCBCANAM         ...TCBCANAM                 @DY45682 03535209
         MVC   0(L'DFWKNAME,RE),0(R3) SAVE PHASE NAME FOR DUMP @DY45682 03535309
         AH    R0,DFCBERRD         UPDATE...                   @D14CDVB 03536007
         AH    R0,H1               ...  ERROR                  @D14CDVB 03537007
         STH   R0,DFCBERRD         ...      COUNTER            @D14CDVB 03538007
         ST    R5,DFCBSTDR         SAVE ERROR INDICATION       @D14CDVB 03539007
         L     RD,OPRESA(RD)                                   @D14CDVB 03540007
         MVI   ORG15+3(RD),4       SET INTERNAL RETURN CODE    @D14CDVB 03541007
         LM    RE,RC,ORG14(RD)     RESTORE REGISTERS           @D14CDVB 03542007
*        AMODESW RETURN,REG=(RE)   ==========>  RETURN         @D64ADVB 03543007
         AMODESW RETURN,REG=(RE)   ==========>  RETURN         @D64ADVB 03544007
         SPACE 1                                                        03545007
MLTHWT   LA    RF,HARDWAIT                                     @D14CDVB 03546007
         MVI   HWIDBYTE,HWFCHIO                                @D14CDVB 03547007
         STC   R5,DFWKPHPT+7       PROVIDE RC                  @D64ADVB 03548007
         MVC   DFWKPHPT(7),HARDNAME SET HARDWAIT               @D14CDVB 03549007
         LA    R0,DFWKPHPT         ADDR OF DISPLAY AREA        @D14CDVB 03550007
         ST    R0,XXUSAREA         ... TO DEBUG AREA           @D14CDVB 03551007
         DEBUG DSPLYDAT,XXDBGMC                                @D61NDMZ 03552007
         L     R6,DISPAD                                       @D36IDVB 03553007
         LM    R8,RE,DFCBSAV+OFS8                              @D36IDVB 03554007
         MVI   IJBHWORG,HWORG172   UNIQUE HARD WAIT ORIGINATOR @D31QDHB 03555007
         BR    RF                  =====> HARDWAIT X'FFE'      @D14CDVB 03556007
         SPACE 1                                                        03557007
*-------------------------------------------------------------*@D149DVB 03558007
         SPACE 1                                                        03559007
MLTNTFND LA    R5,32               RC = 32 --- NOT FOUND COND  @D14CDVB 03560007
         B     MLTBRTAB                                        @D14CDVB 03561007
         DROP  R9,RA,RB,R1                                     @D14CDVB 03562007
         SPACE 1                                               @D14CDVB 03563007
*-------------------------------------------------------------*@D14CDVB 03564007
         EJECT                                                 @D14CDVB 03565007
*-------------------------------------------------------------*@D149DVB 03566007
*                                                              @D14CDHD 03567007
*        ROUTINE NAME: F P G T A B                             @D149DVB 03568007
*                                                              @D14CDHD 03569007
*        MACRO:        SGBFCH                                  @D149DVB 03570007
*                                                              @D14CDHD 03571007
*        FUNCTION:     BUILDS THE FIX TABLE                    @D149DVB 03572007
*                                                              @D14CDHD 03573007
*        CALLER:       FGETTXT                                 @D149DVB 03574007
*                                                              @D14CDHD 03575007
*        INPUT:        PFWKLTXT:  @ 1. BYTE TO FIX             @D149DVB 03576007
*                      PFWKCTXT:  @ AFTER LAST BYTE TO FIX     @D149DVB 03577007
*                                                              @D14CDHD 03578007
*        OUTPUT:       THE FIX TABLE POINTED TO BY FTFXPTR;    @D149DVB 03579007
*                      A ZERO ENTRY INDICATES END OF FIX TABLE;@D14CDHD 03580007
*                                                              @D14CDHD 03581007
*                      R0 = CURRENT LOAD POINT (PFWKLTXT)      @D149DVB 03582007
*                      R1 = PFWKCTXT,IF FIX TABLE LARGE ENOUGH @D149DVB 03583007
*                                                              @D14CDHD 03584007
*                      ONLY IF THE FIX TABLE IS NOT LARGE      @D14CDHD 03585007
*                      ENOUGH TO MAKE AN ENTRY FOR EACH PAGE:  @D14CDHD 03586007
*                      R1 = PFWKHTXT = PFWKMTXT                @D14CDHD 03587007
*                      PFWKHTXT = @AFTER LAST TXT BLOCK, FOR   @D14CDHD 03588007
*                                 WHICH AN ENTRY COULD BE DONE @D14CDHD 03589007
*                      PFWKMTXT =             "                @D14CDHD 03590007
*                      R6 = PAGESIZE                           @D149DBC 03591007
*                                                              @D14CDHD 03592007
*        CALLING SEQUENCE:                                     @D149DVB 03593007
*                   L       RF,DAFPGTAB                        @D149DVB 03594007
*                   BALR    RE,RF                              @D149DVB 03595007
*                                                              @D14CDHD 03596007
*        RETURN CODES:    NONE                                 @D149DVB 03597007
*                                                              @D14CDHD 03598007
*        CALLED ROUTINES: NONE                                 @D149DVB 03599007
*                                                              @D14CDHD 03600007
*        EXITS:           RETURN TO CALLER                     @D149DVB 03601007
*                                                              @D14CDHD 03602007
*        CHANGED REGISTERS:  R0, R1, R2, R3, R4, R5, R6, R7    @D149DVB 03603007
*                                                              @D14CDHD 03604007
*        ERROR HANDLING:  NONE                                 @D149DVB 03605007
*                                                              @D14CDHD 03606007
*        REFERENCED DATA:                                      @D149DVB 03607007
*                   NPSQE, NDEACTP, IJBAPNO (EXTERNAL,READ)    @D149DVB 03608007
*                   PFWKLTXT, PFWKCTXT, FRPL (READ)            @D149DVB 03609007
*                   PFWKHTXT, PFWKMTXT (UPDATE)                @D149DVB 03610007
*-------------------------------------------------------------*@D149DVB 03611007
         SPACE 1                                                        03612007
FPGTAB   DS    0H                                              @D14CDVB 03613007
         USING *,RF                                            @D14CDVB 03614007
         USING DFCB,RB             ESTABLISH     <- DATA AREA  @D14CDVB 03615007
         USING TCBADR,RA           ADDRESSIBILTY <- TCB =10    @D14CDVB 03616007
         SPACE 1                                               @D14CDVB 03617007
*                                                              @D14CDHD 03618007
*  COMPUTE  R1 = #PAGES WHICH COULD THEORETICALLY BE FIXED     @D14CDHD 03619007
*                (AT LEAST 2)                                  @D14CDHD 03620007
*                                                              @D14CDHD 03621007
         SPACE 1                                               @D14CDVB 03622007
         L     R1,NPSQE            NUMBER OF FREE PAGE FRAMES  @D51GDMZ 03623007
         SLR   R3,R3                                           @D14CDVB 03624007
         IC    R3,NDEACTP          NUMBER OF DEACTIVATED CLASS.+ NO OF  03625007
         AH    R3,IJBAPNO          ACTIVE CLASSES (INCL.STATIC PART.S) *03626007
                                   ASSUMED LESS THEN 256 PARTS @D51IDMZ 03627007
         BCTR  R3,0                                            @D14CDVB 03628007
         LTR   R3,R3               ANYTHING TO ADJUST          @D14CDVB 03629007
         BNP   FPGTAB20            NO --->                     @D14CDVB 03630007
FPGTAB05 LR    R2,R1               #(PAGES) USED FOR REQUEST   @D14CDVB 03631007
         SRL   R2,1                 :==>                       @D14CDVB 03632007
         ALR   R1,R2                   MAX ( C**N * #(FREE_    @D14CDVB 03633007
         SRL   R1,1                             _PAGE_FRAMES), @D14CDVB 03634007
         BCT   R3,FPGTAB05                   5 PAGE_FRAMES)    @D14CDVB 03635007
FPGTAB10 LA    R0,5                    WHERE C = 3/4           @D14CDVB 03636007
         CLR   R1,R0                     N = #(ACT.+DEACT.PART)@D14CDVB 03637007
         BNL   FPGTAB20                                        @D14CDVB 03638007
         LR    R1,R0                                           @D14CDVB 03639007
         SPACE 1                                               @D14CDVB 03640007
*           FTFXTAB                                                     03641007
*           -----------                                                 03642007
*           | A1 | A1 | A1: 1ST BYTE ROUNDED ON LOWER PAGE BDY          03643007
*           ----------                                                  03644007
*           | A2 | A2 | A2: A1 + PAGE SIZE                              03645007
*           -----------                                                 03646007
*           .         .                                                 03647007
*           .         .                                                 03648007
*           -----------                                                 03649007
*           | A64| A64| A64:A63 + PAGE SIZE                             03650007
*           ----------                                                  03651007
*           |  0 |    |                                                 03652007
*           ----------                                                  03653007
*                                                              @D14CDHD 03654007
*  FTFXEND = MIN( END OF FIX TABLE,                            @D14CDHD 03655007
*                 START OF FIX TABLE + ENTRY LENGTH * R1 )     @D14CDHD 03656007
*                                                              @D14CDHD 03657007
         SPACE 1                                               @D14CDVB 03658007
FPGTAB20 ALR   R1,R1               PAGE_VALUE ...              @D14CDVB 03659007
         ALR   R1,R1               ... * 8 ...                 @D52VDMZ 03660007
         ALR   R1,R1               ...     =: LENGTH OF FIXTAB @D52VDMZ 03661007
         LA    R5,FTFXTAB          START ADDRESS OF FIXTAB     @D14CDVB 03662007
         ST    R5,FTFXPTR          AND SAVE IT                 @D14CDVB 03663007
         ALR   R1,R5               GET THEORETICAL SIZE        @D14CDVB 03664007
         LA    R0,FTFXZER          END OF FIXTAB               @D14CDVB 03665007
         CLR   R1,R0                                           @D14CDVB 03666007
         BNH   FPGTAB30                                        @D14CDVB 03667007
         LR    R1,R0                                           @D14CDVB 03668007
         SPACE 1                                               @D14CDVB 03669007
FPGTAB30 ST    R1,FTFXEND          STORE CALCULATED SIZE       @D14CDVB 03670007
         SPACE 1                                               @D14CDVB 03671007
*                                                              @D14CDHD 03672007
*  COMPUTE  R3 = LOAD ADDRESS ROUNDED ON LOWER PAGE BOUNDARY   @D52VDMZ 03673007
*           R4 = END ADDRESS ROUNDED ON LOWER PAGE BOUNDARY    @D52VDMZ 03674007
*                                                              @D14CDHD 03675007
         SPACE 1                                               @D14CDVB 03676007
         L     R3,PFWKLTXT         GET LOW LOAD...             @D52VDMZ 03677007
         L     R4,PFWKCTXT         ... AND HIGH END OF TXT     @D14CDVB 03678007
         LR    R0,R3               SAVE LOW LOAD ADDRESS       @D14CDVB 03679007
         LR    R1,R4               SAVE HIGH END OF TEXT       @D14CDVB 03680007
         BCTR  R4,0                R4 = END ADDRESS            @D52VDMZ 03681007
         L     R6,PAGESIZE         PAGE SIZE                   @D14CDVB 03682007
         N     R3,PADDRMSK         ROUND ON LOWER PAGE BOUNDARY@D52VDMZ 03683007
         N     R4,PADDRMSK         ROUND ON LOWER PAGE BOUNDARY@D52VDMZ 03684007
         SPACE 1                                               @D14CDVB 03685007
*                                                              @D14CDHD 03686007
*  MAKE ENTRIES:  R5 --->  PAGE ADDRESS | PAGE ADDRESS         @D52VDMZ 03687007
*  INTO THE FIX TABLE UNTIL AN ENTRY FOR THE HIGHEST PAGE ADDR @D52VDMZ 03688007
*  (R4), IS DONE OR END OF FIX TABLE IS REACHED                @D14CDHD 03689007
*                                                              @D14CDHD 03690007
         SPACE 1                                               @D14CDVB 03691007
FPGTAB40 ST    R3,0(,R5)           PAGE ADDR IN ...            @D52VDMZ 03692007
         ST    R3,4(,R5)           ... TFIX_TABLE              @D52VDMZ 03693007
         LA    R5,8(R5)            ADDR (NEXT TABLE ENTRY)     @D52VDMZ 03694007
         ALR   R3,R6               LAST ADDRESS + LEN(PAGE)            *03695007
                                   ... =: INTERMEDIATE HIGH END@D52VDMZ 03696007
         CLR   R3,R4               ALL SPACE ALREADY TFIXED    @D52VDMZ 03697007
         BH    FPGTAB60            YES --->                    @D14CDVB 03698007
         CL    R5,FTFXEND          END OF TABLE REACHED        @D14CDVB 03699007
         BL    FPGTAB40            NO  --->                    @D14CDVB 03700007
         SPACE 1                                               @D14CDVB 03701007
*                                                              @D14CDHD 03702007
*  INDICATE END OF CURRENT FIX TABLE ENTRIES BY MAKING A ZERO  @D14CDHD 03703007
*  ENTRY                                                       @D14CDHD 03704007
*                                                              @D14CDHD 03705007
         SPACE 1                                               @D14CDVB 03706007
FPGTAB60 SLR   R2,R2                                           @D14CDVB 03707007
         ST    R2,0(R5)            INDICATE LAST TABLE ENTRY   @D14CDVB 03708007
         SPACE 1                                               @D14CDVB 03709007
*                                                              @D14CDHD 03710007
*  RETURN, IF AN ENTRY FOR ALL PAGES COULD BE DONE             @D14CDHD 03711007
*  R3 = @ AFTER LAST FIXED BYTE                                @D52VDMZ 03712007
*  R1 = END ADDRESS + 1                                        @D52VDMZ 03713007
*                                                              @D14CDHD 03714007
         SPACE 1                                               @D14CDVB 03715007
         CLR   R3,R1               TOTAL PART CAN BE READ IN   @D14CDVB 03716007
         BNLR  RE                  =====>   YES, RETURN        @D14CDVB 03717007
         SPACE 1                                               @D14CDVB 03718007
*                                                              @D14CDHD 03719007
*  THERE IS'NT AN ENTRY FOR EACH PAGE#, BECAUSE  END OF FIX    @D14CDHD 03720007
*  TABLE WAS REACHED EARLIER;                                  @D14CDHD 03721007
*  SET PFWKHTXT = PFWKMTXT = @ AFTER THE LAST TXT BLOCK FOR    @D14CDHD 03722007
*                            WHICH A FIX TABLE ENTRY EXISTS    @D14CDHD 03723007
*                                                              @D14CDHD 03724007
         SPACE 1                                               @D14CDVB 03725007
         SLR   R3,R0               LENGTH (FIXED_PART (PHASE)) @D52VDMZ 03726007
         L     R7,DSRPLTXT         ADDR (TXT_RPL)              @D14CDVB 03727007
         USING DRPL,R7             ESTABLISH ADDRESSIBILITY    @D14CDVB 03728007
         LH    R4,DRPLGRL          LENGTH (LOGICAL_RECORD)     @D14CDVB 03729007
         DR    R2,R4                                           @D14CDVB 03730007
         MH    R3,DRPLGRL          ADJUST ON #(RECORDS)        @D14CDVB 03731007
         LR    R1,R3               RELOAD INTERFACE REG        @D14CDVB 03732007
         ALR   R1,R0               ADDR (HIGH_TXT)             @D14CDVB 03733007
         ST    R1,PFWKHTXT         STORE HIGH TXT ADDRESS      @D14CDVB 03734007
         ST    R1,PFWKMTXT         STORE HIGH TXT ADDRESS      @D14CDVB 03735007
         BR    RE                  =====>    RETURN            @D14CDVB 03736007
         DROP  RA,RB,RF,R7                                     @D14CDVB 03737007
         SPACE 1                                               @D14CDVB 03738007
*-------------------------------------------------------------*@D14CDVB 03739007
         SPACE 2                                               @D14CDVB 03740007
FTPAGEND EQU   *                                                        03741007
LFTPAGE  EQU   FTPAGEND-FTPAGBEG                                        03742007
         SPACE 2                                                        03743007
         AIF   (NOT &SGBFCH).PRTGEN                            @D37ZDVB 03744007
         PRINT  NOGEN                                          @D37ZDVB 03745007
.PRTGEN  ANOP                                                  @D37ZDVB 03746007
         MEND                                                           03747007
