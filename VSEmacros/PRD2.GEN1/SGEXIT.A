         MACRO                                                          00001000
         SGEXIT &DSECT=NO                                               00002000
*********************************************************************** 00003000
.*       IBM DISK OPERATING SYSTEM                                    * 00004000
*        SUPERVISOR - SGEXIT - 5686-CF7-06                            * 00004000
*                                                                     * 00004000
*        LICENSED MATERIALS - PROPERTY OF IBM                         * 00005000
*        "RESTRICTED MATERIALS OF IBM"                                * 00006000
*        5686-CF7                                                     * 00007000
*        (C) COPYRIGHT IBM CORP. 1977, 2004                           * 00007000
*                                                                     * 00009000
*********************************************************************** 00010000
         GBLB  &BGTT          TASK TIMER                       @D33PAGA 00011000
         GBLB  &BGDEBUG       DEBUG OPTION                     @D37ZDFG 00012000
         GBLB  &SGEXIT        COMPONENT NAME FOR PRINT OPTION  @D51HDOW 00013000
         LCLC  &CS                                             @D64ADOW 00014000
         LCLC  &BL                                             @D64ADOW 00015000
.* /* START OF SPECIFICATIONS ***************************************** 00016000
.*                                                             @D35EDJO 00017000
.*01* MODULE-TYPE = MACRO                                      @D35EDJO 00018000
.*                                                             @D35EDJO 00019000
.*01* DESCRIPTIVE NAME = USER EXIT ROUTINES                    @D51HDOW 00020000
.*    FOLLOWING SVC'S ARE HANDLED                                       00021000
.*                                                                      00022000
.*     SVC16 (STXIT PC)                                                 00023000
.*     SVC17 (EXIT PC)                                                  00024000
.*     SVC18 (STXIT IT)                                                 00025000
.*     SVC19 (EXIT IT)                                                  00026000
.*     SVC20 (STXIT OC)                                                 00027000
.*     SVC21 (EXIT OC)                                                  00028000
.*     SVC37 (STXIT AB)                                                 00029000
.*     SVC95 (EXIT AB)                                                  00030000
.*                                                             @D35EDJO 00031000
.*01* CHANGE ACTIVITY = AS FOLLOWS                             @D35EDJO 00032000
.*     OC-EXIT EXTENSION FOR CICS (5.1.0)                      @D51HDOW 00033000
.*     REGISTER USAGE IN COMMON SVC EXIT ROUTINE (COMSTXIT)    @DY40651 00034000
.*     STXIT ..AMODE=ANY IN 24 BIT MODE INCORRECT     @D52VDOW:@KX40492 00035000
.*     MULTIPLE ERRORS                                @D52VDOW:@KX41420 00036000
.*     QUALITY ACTION                                 @D52VDOW:@KD40113 00037000
.*     ASSURE CORRECT KEY/STATE FOR AB-EXIT                    @DY42706 00038000
.*     LINKAGE STACK SUPPORT                                   @D61PDOW 00039000
.*     DON'T MODIFY ACTIVE INDICATOR WITH EXIT DELETION        @DY43182 00040000
.*     DON'T MODIFY USER SAVE AREA WHEN PROCESSING EXIT MACRO  @DY43275 00041000
.*     VSE/ESA 2.3  FAMILY API SUPPORT                         @D64ADVB 00042000
.*     CANCEL LOOP DUE TO INVALID FREEVIS REQ IN RELEASE TIQE  @DY45636 00043000
.*     LOOP IN RESEXIT RTN DUE TO INCORRECT FESTAE HANDLING    @DY45636 00043000
.*     ...IN COMEXIT ROUTINE                                   @DY45636 00043000
.*     IEXT SUBPOOL CREATED FOR ATTCHING TASK                  @DY45636 00043000
.*     MORE THAN 255 TASKS                                     @D66ODOW 00043000
.*     HW FFB DUE TO EXIT-CB NOT INITIALIZED PROPERLY          @DY45712 00043000
.*     PROG-CHK IN TIMER EXIT RTN DUE TO R1 NOT LOADED CORRECT @DY45785 00043000
.*     SOLVE PROBLEM OF CORRUPTED MVS-SCB CHAIN (TCBSTABB)     @D66XXOW 00043000
.*     SAVE CANCEL CODE IN AB-EXIT SAVE AREA                   @D67QDOW 00043000
.*     FED DUE TO INCORRECT LINK STACK HANDLING AT ESTAEX DEFIN@DY45947 00043000
.*     NAME/TOKEN SERVIVE                                      @D67CDOW         
.*     SAVE CONTROL REGISTER IN SDWA FOR DEBUGGING             @DY46084 00044000
.*     CR8 (EAX) DESTROYED AFTER RETRY OF ESTAEX TYPE EXIT RTN @DY46192 00044000
.*     SECURITY VIOLATION NOT RECOVERED DUE TO SDWACLUP SET    @DY46116 00044000
.*     CR8 (EAX) DESTROYED AFTER SVC 95                        @DY46135 00044000
.** END OF SPECIFICATIONS ************************************          00045000
         AIF   (NOT &SGEXIT).NOPRINT                           @D64ADVB 00046000
         PRINT GEN                                             @D37ZDOW 00047000
.NOPRINT ANOP                                                  @D37ZDOW 00048000
&CS      SETC  'S'                                             @D64ADOW 00049000
&BL      SETC  ' '                                             @D64ADOW 00050000
         AIF   ('&DSECT' EQ 'YES').DSECT10                     @D64ADOW 00051000
&CS      SETC  'C'                                             @D64ADOW 00052000
&BL      SETC  ''                                              @D64ADOW 00053000
         DS    0F                                                               
         DC    CL8'SGEXIT  '                                            00054000
         DC    CL10'04/30/2004'   LAST DEVELOPMENT/APAR CHANGE          00055860
         SPACE 2                                                        00056000
         DS    0F                                              @D64ADOW 00057000
.DSECT10 ANOP                                                  @D64ADOW 00058000
         SPACE 2                                                        00059000
*********************************************************************** 00060000
*                                                                     * 00061000
*        MACRO BASE                                                   * 00062000
*        SVC ENTRY ADDR                                               * 00063000
*        ADDRESSES TO SUBROUTINES WITH OWN BASE ADDR                  * 00064000
*                                                                     * 00065000
*********************************************************************** 00066000
         SPACE                                                          00067000
SGEXIT   DC    X'07FC0000'        SVC ENTRY AND ALIGNMENT      @D64ADOW 00068000
         SPACE                                                          00069000
ACOMSTXI D&CS A&BL.(COMSTXIT+X'80000000')                      @D64ADOW 00070000
AEXITPRE D&CS A&BL.(EXITPREP+X'80000000')                      @D64ADOW 00071000
ACOMEXIT D&CS A&BL.(COMEXIT+X'80000000')                       @D64ADOW 00072000
ACOMEREX D&CS A&BL.(COMERR47+X'80000000')                      @D64ADOW 00073000
ACOMER48 D&CS A&BL.(COMERR48+X'80000000')                      @D64ADOW 00074000
AEXITGVI D&CS A&BL.(EXITGVIS+X'80000000')                      @D64ADOW 00075000
ARESUSPB D&CS A&BL.(RESUSPB+X'80000000')                       @D64ADOW 00076000
ABROUTAD D&CS A&BL.(ABROUT+X'80000000')                        @D64ADOW 00077000
ACHKEXIT D&CS A&BL.(CHKEXIT+X'80000000')                       @D64ADOW 00078000
ACURLSTK D&CS A&BL.(CCURLSTK+X'80000000')                      @D64ADOW 00079000
ACORLSTK D&CS A&BL.(CCORLSTK+X'80000000')                      @D64ADOW 00080000
ARESEXIT D&CS A&BL.(RESEXIT+X'80000000')                       @D64ADOW 00081000
ASUBABEX D&CS A&BL.(SUBABEXT+X'80000000')                      @D64ADOW 00082000
APROGUSP D&CS A&BL.(PROGUSPB+X'80000000')                      @D64ADOW 00083000
AFREMSCB D&CS A&BL.(FREEMSCB+X'80000000')                      @D64ADOW 00084000
AFRRISVC D&CS A&BL.(FRRILSVC+X'80000000')                      @D64ADOW 00085000
ASGTIMX  D&CS A&BL.(SGTIMERX+X'80000000')                      @D64ADOW 00086000
ACHKDLAY D&CS A&BL.(CHKDELAY+X'80000000')                      @D64ADOW 00087000
         AIF   ('&DSECT' EQ 'YES').DSECT20                     @D64ADOW 00088000
         EJECT                                                          00089000
*********************************************************************** 00090000
*                                                                     * 00091000
****     PC EXIT SERVICES      **************************************** 00092000
*                                                                     * 00093000
* SVC 16: DEFINE PC- EXIT                                             * 00094000
*            STORE THE ADDRESS OF THE USER'S PC ROUTINE AND SAVE AREA * 00095000
*            ADDRESS IN THE PC OPTION TABLE.                          * 00096000
*         RESET PC-EXIT                                               * 00097000
*                                                                     * 00098000
*********************************************************************** 00099000
         SPACE 1                                               @D35EDFR 00100000
         USING DISP,R6                                         @D35EDJO 00101000
         USING TCBADR,RA                                       @D36ZDFG 00102000
         USING SVEARA,RB                                       @D36ZDFG 00103000
         USING SGEXIT,RD          ESTABLISH BASE               @D51HDOW 00104000
SVC16    DS    0H                                              @D64ADMK 00105000
         L     R4,SVC16A10        GET CONTINUATION ADDR        @D64ADOW 00106000
         BSM   0,R4               GOTO 31 BIT MODE             @D64ADVB 00107000
SVC16A10 DC    A(X'80000000'+SVC16L10) AMODE 31 RTN ADDR       @D64ADOW 00158000
SVC16L10 DS    0H                                              @D64ADMK 00108000
         TM    TCBEXFLG,TCBEXAM   CALLER IN 31 BIT MODE        @DY45712 00829000
         BO    SVC16L12           YES,                         @DY45712 00830000
         ICM   R0,8,H0            CLEAR BYTE 0                 @DY45712         
         ICM   R1,8,H0            ... IN BOTH INPUT REGISTERS  @DY45712         
SVC16L12 DS    0H                                              @DY45712 00108000
         ICM   R7,B'1111',TCBPCEX GET ADDR OF FIRST PC-EXIT    @D64ADMK 00109000
         BNZ   SVC16L20           BRANCH IF ALLOCATED          @D64ADOW 00110000
         LTR   R0,R0              RESET REQUIRED               @D64ADOW 00111000
         BZ    EXIT               YES, NOTHING TO DO           @D64ADOW 00112000
         CR    R0,R1              LIST SUPPLIED                @DY45712         
         BNE   SVC16L15           NO                           @DY45712         
         ICM   RF,15,4(R1)        RESET REQUIRED               @DY45712         
PCKSV16A DS    0H                 PROGRAM CHECK POSSIBLE       @DY45712         
         BZ    EXIT               YES, NOTHING TO DO           @DY45712         
SVC16L15 DS    0H                                              @DY45712         
         LA    R0,EXPCLEN         LENGTH OF EXIT CONTROL BLOCK @D64ADOW 00113000
         SLR   RF,RF              SET FCT CODE                 @D64ADOW 00114000
         L     RC,AEXITGVI        GET BASE OF COMMON ROUTINE   @D64ADOW 00115000
         BASSM R8,RC              ALLOCATE PC-EXIT BLOCK       @D64ADOW 00116000
*SGLINK  EXITGVIS,INPUT=(R0,R8,RA,RC,RF),OUTPUT=(R1,RF),WORK=R0         00117000
         LTR   RF,RF              STORAGE AVAILABLE            @D64ADMK 00118000
         BNZ   SVC16ER2           SPACE EXHAUSTED              @D64ADOW 00119000
         LR    R7,R1                                           @D64ADOW 00120000
         USING EXITBLK,R7                                      @DY45712 00124000
         MVI   EXITFLG1,EXPCTYPE  INDICATE PC-TYPE EXIT        @DY45712 00144000
         ST    R7,TCBPCEX         SAVE ADDR OF EXIT-BLOCK      @D64ADMK 00121000
         LM    R0,R1,SVER00       RESTORE R0/R1 FROM SAVE-AREA @D64ADOW 00122000
         TM    TCBEXFLG,TCBEXAM   CALLER IN 31 BIT MODE        @DY45712 00829000
         BO    SVC16L20           YES,                         @DY45712 00830000
         ICM   R0,8,H0            CLEAR BYTE 0                 @DY45712         
         ICM   R1,8,H0            ... IN BOTH INPUT REGISTERS  @DY45712         
SVC16L20 DS    0H                                              @D64ADMK 00123000
         OC    EXITADR,EXITADR    ANY PC/ESPIE EXIT DEFINED    @DY45712 00125000
         BNZ   SVC16L30           YES, CHECK FOR VSE EXIT      @DY45712 00126000
         LTR   R0,R0              RESET REQUEST                @DY45712 00130000
         BZ    EXIT               YES, NOTHING TO DO           @DY45712 00131000
         CR    R0,R1              LIST SUPPLIED                @DY45712         
         BNE   SVC16L25           NO                           @DY45712         
         ICM   RF,15,4(R1)        RESET REQUIRED               @DY45712         
PCKSV16B DS    0H                 PROGRAM CHECK POSSIBLE       @DY45712         
         BZ    EXIT               YES, NOTHING TO DO           @DY45712         
SVC16L25 DS    0H                                              @DY45712 00123000
         MVI   EXITFLG2,EXVSEPC   INDICATE VSE-PC-EXIT         @DY45712 00145000
SVC16L30 DS    0H                                              @D66ODOW 00123000
         CLI   EXITFLG2,EXVSEPC   REALLY A VSE-PC-EXIT CB      @D64ADOW 00127000
         BNE   SVC16ER1           NO, CANCEL                   @D64ADOW 00128000
         TM    TCBEXITF,TCBITACT+TCBOCACT+TCBPOACT+TCBEXACT    @D64ADOW 00132000
***                               IT|OC|ETXR|POST EXIT ACTIVE  @D64ADOW 00133000
         BNZ   ERR21              YES, ---> CANCEL             @D64ADOW 00134000
         SLR   R5,R5              CALLER IS SVC16              @D64ADOW 00136000
         SLR   R4,R4              INITIALIZE NO LIST SUPPLIED  @D64ADOW 00137490
         L     RC,ACOMSTXI        GET BASE OF COMMON ROUTINE   @D64ADOW 00138000
         BASSM R9,RC              BRANCH TO COMMON ROUTINE     @D64ADOW 00139000
*SGLINK COMSTXIT,INPUT=(R0,R1,R4,R5,R7,R9,RA,RC),                      X00140000
               OUTPUT=(R6,RB),WORK=(R2,R5,R8,RF)                        00141000
         B     EXIT               RETURN                       @D64ADMK 00146000
         SPACE                                                          00147000
SVC16ER1 DS    0H                                              @D64ADOW 00148000
         L     R1,S16ERR0A        GET ADDITIONAL ERROR INFO    @D64ADOW 00149000
         B     SVC16ERR           CANCEL WITH ERR47            @D64ADOW 00150000
SVC16ER2 DS    0H                                              @D64ADOW 00151000
         ST    RF,SVER0F          GETVIS RETURN CODE TO R15    @D64ADOW 00152000
         L     R1,S16ERR06        GET ADDITIONAL ERROR INFO    @D64ADOW 00153000
SVC16ERR DS    0H                                              @D64ADOW 00154000
         L     RC,ACOMEREX        ADDR OF ERROR EXIT           @D64ADOW 00155000
         BSM   0,RC               CANCEL WITH ERR47            @D64ADOW 00156000
         SPACE                                                          00159000
S16ERR06 DC    A(NUCRSN06)        SGETVIS FOR EXIT BLOCK NOT   @D64ADOW 00160000
*                                 ... SUCCESSFULL, RETURN CODE          00161000
*                                 ... PASSED TO CALLER IN REG 15        00162000
*                                 ... ISSUED IN SGEXIT AND SGSVCX       00163000
S16ERR0A DC    A(NUCRSN0A)        STXIT MACRO REJECTED BECAUSE @D64ADOW 00164000
*                                 ... ALREADY ESPIE DEFINED             00165000
*                                 ... ISSUED IN SGEXIT                  00166000
         DROP  R6                                              @D64ADOW 00167000
         DROP  R7                                              @D64ADMK 00168000
         DROP  RA                                              @D64ADOW 00169000
         DROP  RB                                              @D64ADOW 00170000
         DROP  RD                                              @D64ADOW 00171000
         EJECT                                                          00172000
*********************************************************************** 00173000
*                                                                     * 00174000
* SVC 17: PROVIDES A RETURN FROM THE USER'S PC ROUTINE TO THE PROGRAM * 00175000
*         INTERRUPTED DUE TO A PROGRAM CHECK.                         * 00176000
*                                                                     * 00177000
*********************************************************************** 00178000
         SPACE 1                                                        00179000
         USING DISP,R6                                         @D64ADOW 00180000
         USING TCBADR,RA                                       @D64ADOW 00181000
         USING SGEXIT,RD          ESTABLISH BASE               @D64ADOW 00182000
SVC17    DS    0H                                              @D64ADMK 00183000
         ICM   R7,B'1111',TCBPCEX SET POINTER TO TASK'S ENTRY  @D64ADMK 00184000
         BZ    ERR21              CANCEL IF NOT AVAILABLE      @D64ADOW 00185000
         DROP  R6                                              @D64ADOW 00186000
         USING EXITBLK,R7                                      @D64ADOW 00187000
         L     R4,SVC17A10        GET CONTINUATION ADDR        @D64ADOW 00188000
         BSM   0,R4               GOTO 31 BIT MODE             @D64ADVB 00189000
SVC17L10 DS    0H                                              @D64ADOW 00190000
         LA    R4,TCBPCACT        INDICATE STXIT PC REQUEST    @D61PDOW 00191000
         L     RC,ACOMSTXI        ADDR OF SUBROUTINE           @D64ADOW 00192000
         L     R1,ACOMEXIT        ...                          @D64ADOW 00193000
         BASSM R9,R1              CALL COMMON EXIT CODE        @D64ADOW 00194000
*SGLINK COMEXIT,INPUT=(R4,R6,R7,R9,RA,RB,RC),                          X00195000
               WORK=(R0,R1,R2,R3,R4,R5,R8,RF)                           00196000
         LTR   R7,R7              EXIT BLOCK AVAILABLE (IF     @D64ADOW 00197000
***                               PROCESSING ESPIE, EXIT-BLOCK ALREADY  00198000
***                               FREED)                                00199000
         BZ    EXIT               NO --->                      @D64ADOW 00200000
         ICM   R5,B'1111',EXITADR RESET PERFORMED IN MEANTIME  @D64ADOW 00201000
         BNZ   EXIT               NO --->                      @D64ADOW 00202000
         SLR   R0,R0              INDICATE RESET               @D64ADOW 00203000
*     R5 ALREADY INDICATES PC EXIT REQUEST                                      
         L     RC,ACOMSTXI        GET BASE OF COMMON ROUTINE   @D64ADOW 00204000
         BASSM R9,RC              BRANCH TO COMMON ROUTINE     @D64ADOW 00205000
*SGLINK COMSTXIT,INPUT=(R0,R1,R4,R5,R7,R9,RA,RC),                      X00206000
               OUTPUT=(R6,RB),WORK=(R2,R5,R8,RF)                        00207000
         DROP  R7                                              @D64ADOW 00208000
         B     EXIT               EXIT TO DISPATCHER           @D61NDOW 00209000
         SPACE                                                          00210000
SVC17A10 DC    A(X'80000000'+SVC17L10) AMODE 31 RTN ADDR       @D64ADOW 00211000
         DROP  RA                                              @D64ADOW 00212000
         DROP  RD                                              @D64ADOW 00213000
         EJECT                                                          00214000
*********************************************************************** 00215000
*                                                                     * 00216000
*        PROGRAM CHECK EXIT WHEN USER ROUTINE IS AVAILABLE.           * 00217000
*           ENTERED FROM PROGRAM CHECK HANDLER (MACRO SGPCK)          * 00218000
*           IF NO PROG CHECK EXIT ACTIV                               * 00219000
*                                                                     * 00220000
*********************************************************************** 00221000
         SPACE 1                                               @D35EDFR 00222000
         USING DISP,R6                                         @D64ADOW 00223000
         USING TCBADR,RA                                       @D64ADOW 00224000
         USING SVEARA,RB                                       @D64ADOW 00225000
         USING SGEXIT,RD                                       @D64ADOW 00226000
PCROUT   DS    0H                                              @D14BDFR 00227000
*SGLINK  PCROUT,S,INPUT=(R3,R6,RA,RB,RD)                                00228000
*        DEBUG XXDUMPNR,XXDBGMC   SWITCH TO NEXT DEBUG AREA             00229000
         DEBUG XXDUMPNR,XXDBGMC                                @D61RDOW 00230000
*END OF DEBUG MACRO                                                     00231000
         MVI   RID+1,REENTRID     INDICATE ROUT.TO BE REENTRNT       EM 00232000
         OI    TCBEXITG,TCBSFORC  INITIALIZE SYSTEM FORCED ABEN@D64ADOW 00233000
         TM    TCBEXFLG,TCBEXHPS  IS HASN=PASN=SASN            @D64ADOW 00234000
         BNO   ERR20              NO, CANCEL USER              @D64ADOW 00235000
         TM    SVEPSWMK,SVESSMOD  CALLER IN PRIMARY OR AR MODE @D64ADOW 00236000
         BO    ERR20              NO, CANCEL USER              @D64ADOW 00237000
         L     R7,TCBPCEX         GET POINTER TO PC EXIT CHAIN @D64ADMK 00238000
         USING EXITBLK,R7                                      @D64ADMK 00239000
         CLC   PIK,ATTNPIK        IS IT ATTENTION TASK         @D51HDOW 00240000
         BE    PCROUT2            YES,GOTO ACTIVATE ATT.EXIT   @D36IDFR 00241000
         TM    EXITKEY,KEY0       SHOULD EXIT ROUT.RUN WITH 0  @D64ADOW 00242000
         BZ    PCROUT1            YES,DO NOT COMPARE KEYS      @D14BDFR 00243000
         CLC   SVEPSW+1(1),EXITKEY IS IT THE RIGHT PROT.KEY    @D51HDOW 00244000
         BNE   ERR20              NO,DO NOT TAKE EXIT          @D14BDFR 00245000
PCROUT1  L     R8,TIBPTR          LOAD TIB POINTER             @D36IDFR 00246000
         USING TIBADR,R8                                       @D52VDOW 00247000
         TM    TIBFLAG1,PRIVILEG  PROGRAM CHECK IN PRIV.ROUT.? @D36IDFR 00248000
         DROP  R8                                              @D52VDOW 00249000
         BNZ   ERR20              YES, DON'T TAKE USER EXIT    @D35EDFR 00250000
         TM    TCBEXITF,TCBABACT+TCBPOACT+TCBEXACT ANY         @D64ADOW 00251000
***                               ... AB|POST|ETXR EXIT ACTIVE?         00252000
         BNZ   ERR20              YES, SKIP PC EXIT            @D64ADOW 00253000
         TM    VTAMFLG,VTURX      IF VTAM USER EXIT IS RUNNING @D14BDFR 00254000
         BNZ   ERR20              DO NOT TAKE PC EXIT          @DM08378 00255000
PCROUT2  DS    0H                                              @D64ADMK 00256000
         CLI   EXITFLG2,EXESPIE   IS THIS MVS/ESPIE EXIT       @D64ADOW 00257000
         BNE   PCROUT5            NO, GO TO ACTIVATE EXIT      @D64ADOW 00258000
         SLR   R4,R4                                           @D64ADOW 00259000
         ICM   R4,B'1000',PGMINTC+1 PROG CHK INTERRUPTION CODE @D64ADOW 00260000
         N     R4,BIT0OFF         RESET PER INDICATOR          @D64ADOW 00261000
         SRL   R4,24              SHIFT VALUE TO BYTE 3        @D64ADOW 00262000
         CH    R4,H16             IS IT SEGM.TRANS.EXCEPTION   @D65CDOW         
         BNE   PCROUT3            NO --->                      @D65CDOW         
         LA    R4,PROTEX          SIMULATE PROTECTION EXCEPTION@D65CDOW 00260000
PCROUT3  DS    0H                                              @D64ADMK 00264000
         L     R5,EXESMASK        GET PROG INTERRUPT MASK      @D64ADOW 00263000
PCROUT4  DS    0H                                              @D64ADMK 00264000
         SLL   R5,1               SHIFT ONE POSITION           @D64ADOW 00265000
         BCT   R4,PCROUT4         LOOP TILL RIGHT BIT FIRST    @D64ADOW 00266000
         LTR   R5,R5              EXCEPTION TO BE HANDLED      @D64ADOW 00267000
         BNM   ERR20              NO, --->                     @D64ADOW 00268000
PCROUT5  DS    0H                                              @D64ADOW 00269000
         L     RC,ASVC79P         GET BASE OF NT-CLEANUP RTN   @D67CDOW         
         USING SVC79,RC                                        @D67CDOW         
         LA    R4,NT_CLEAN_P1     GET RTN ADDRESS              @D67CDOW         
         O     R4,BIT0ON          FORCE 31 BIT MODE            @D67CDOW         
         BASSM R4,R4              CALL NT CLEAN UP RTN PART 1  @D67CDOW         
         DROP  RC                                              @D67CDOW         
         NI    TCBEXITG,XFF-TCBSFORC RESET SYS FORCED ABEND    @D64ADOW 00270000
         L     R4,EXITSAV         GET PC EXIT SAVEAREA POINTER @D36IDFR 00271000
         LA    RE,TCBPCACT        PC-EXIT ACTIVE INDICATOR     @D61NDOW 00272000
         L     RC,ACOMSTXI        ADDR OF SUBROUTINE           @D64ADOW 00273000
         L     R1,AEXITPRE        ...                          @D64ADOW 00274000
         BASSM R5,R1              CALL EXIT PREPARATION        @D64ADOW 00275000
*SGLINK  EXITPREP,INPUT=(R0:ONLY_AB,R3,R4,R5,R7,RA,RB,RC,RE),          X00276000
               WORK=(R1,R8,R9,RE,RF)                                    00277000
         B     EXIT               RETURN TO DISPATCHER         @D64ADOW 00278000
ASVC79P  DC    A(SVC79)           SVC 79 BASE ADDR             @D67CDOW         
         DROP  R6                                              @D64ADMK 00279000
         DROP  R7                                              @D64ADMK 00280000
         DROP  RA                                              @D64ADMK 00281000
         DROP  RB                                              @D64ADMK 00282000
         DROP  RD                                              @D64ADOW 00283000
         SPACE 3                                                        00284000
***************************************************************         00285000
*                                                             *         00286000
*        ESPIE EXIT RETRY ENTRY                               *         00287000
*                                                             *         00288000
***************************************************************         00289000
         SPACE 1                                                        00290000
PCRETRY  SVC   17                                              @D64ADOW 00291000
         EJECT ,                                               @D149DIS 00292000
*********************************************************************** 00293000
*                                                                     * 00294000
****     IT EXIT SERVICES     ***************************************** 00295000
*                                                                     * 00296000
* SVC 18: DEFINE IT-EXIT                                              * 00297000
*            STORE THE ADDRESS OF THE USER'S IT ROUTINE AND SAVE AREA * 00298000
*            ADDRESS IN THE IT OPTION TABLE.                          * 00299000
*         RESET IT-EXIT                                               * 00300000
*                                                                     * 00301000
*********************************************************************** 00302000
         SPACE 1                                                        00303000
         USING TCBADR,RA                                       @D64ADOW 00304000
         USING SVEARA,RB                                       @D64ADOW 00305000
         USING SGEXIT,RD                                       @D64ADOW 00306000
SVC18    DS    0H                                              @D36IDFR 00307000
         L     R4,SVC18A10        GET CONTINUATION ADDR        @D64ADOW 00308000
         BSM   0,R4               GOTO 31 BIT MODE             @D64ADVB 00309000
SVC18L10 DS    0H                                              @D64ADOW 00310000
         L     RD,ASGTIMX         BASE OF STIMER/STIMERM       @D64ADOW 00311000
         USING SGTIMERX,RD                                     @D64ADOW 00312000
         TM    TCBMVSIS,TCBMVSSA  MVS SVC = STIMER/STIMERM     @D64ADVB 00313000
         BO    STIMSET            YES, ==========>             @D64ADVB 00314000
         L     RD,ASGEXIT         REESTABLISH SVC18 BASE       @D64ADOW 00315000
         USING SGEXIT,RD                                       @D64ADOW 00316000
         SPACE 1                                                        00317000
         TM    TCBEXFLG,TCBEXAM   CALLER IN 31 BIT MODE        @DY45712 00829000
         BO    SVC18L12           YES,                         @DY45712 00830000
         ICM   R0,8,H0            CLEAR BYTE 0                 @DY45712         
         ICM   R1,8,H0            ... IN BOTH INPUT REGISTERS  @DY45712         
SVC18L12 DS    0H                                              @DY45712 00108000
         L     RC,TCBATCBE        ADDR OF TCBX                 @D64ADVB 00318000
         USING TCBXADR,RC                                      @D64ADVB 00319000
         L     R7,TCBXTAVS        ADDR OF VSE TIQE             @D64ADVB 00320000
         LTR   R0,R0              STXIT-RESET                  @D64ADVB 00321000
         BZ    SVC18RES           YES, --------->              @D64ADVB 00322000
         CR    R0,R1              LIST SUPPLIED                @DY45712         
         BNE   SVC18L15           NO                           @DY45712         
         ICM   RF,15,4(R1)        RESET REQUIRED               @DY45712         
PCKSVC18 DS    0H                 PROGRAM CHECK POSSIBLE       @DY45712         
         BZ    SVC18RES           YES, --------->              @DY45712         
SVC18L15 DS    0H                                              @DY45712         
         LTR   R7,R7              ALREADY AVAILABLE            @D64ADVB 00323000
         BNZ   SVC18L20           YES, --------->              @D64ADVB 00324000
         LA    R0,EXTILEN         LENGTH OF EXIT CONTROL BLOCK @D64ADOW 00325000
         SLR   RF,RF              SET FCT CODE                 @D64ADOW 00326000
         L     RC,AEXITGVI        GET BASE OF COMMON ROUTINE   @D64ADOW 00327000
         BASSM R8,RC              ALLOCATE IT-EXIT BLOCK       @D64ADOW 00328000
*SGLINK  EXITGVIS,INPUT=(R0,R8,RA,RC,RF),OUTPUT=(R1,RF),WORK=R0         00329000
         USING SGEXIT,RD                                       @D64ADVB 00330000
         L     RC,TCBATCBE        RESTORE TCBX ADDR            @D64ADVB 00331000
         LTR   RF,RF              SUCCESSFULL                  @D64ADVB 00332000
         BNZ   SVC18ER1           NO,  =========>  CANCEL      @D64ADVB 00333000
         LR    R7,R1              EXIT BLOCK ADDR TO CORRECT RE@D64ADVB 00334000
         USING EXITBLK,R7                                      @D64ADOW 00335000
         ST    R7,TCBXTAVS        ADDR OF VSE TIQE             @D64ADVB 00336000
         DROP  RC                                              @D64ADVB 00337000
SVC18L20 DS    0H                                              @D64ADVB 00338000
         MVI   EXITFLG1,EXTITYPE  ITS A TIMER EXIT             @DY45785 00346000
         MVI   TIQTYPE,TIQVSE     ... A VSE TIMER              @DY45785 00347000
         LM    R0,R1,SVER00       PROVIDE ORIGINAL R0 , R1     @D64ADVB 00339000
         SLR   R5,R5              INDICATE CALLER IS SVC 18    @D64ADOW 00340000
         SLR   R4,R4              INITIALIZE NO LIST SUPPLIED  @D64ADOW 00341490
         L     RC,ACOMSTXI        GET BASE OF COMMON ROUTINE   @D64ADMK 00342000
         BASSM R9,RC              BRANCH TO COMMON ROUTINE     @D64ADMK 00343000
*SGLINK COMSTXIT,INPUT=(R0,R1,R4,R5,R7,R9,RA,RC),                      X00344000
               OUTPUT=(R6,RB),WORK=(R2,R5,R8,RF)                        00345000
         DROP  R7                                              @D64ADOW 00348000
         B     EXIT               EXIT TO DISPATCHER           @D64ADVB 00349000
         SPACE 1                                                        00350000
SVC18RES DS    0H                 RESET TIMER EXIT (R0 = 0)    @D64ADVB 00351000
         LTR   R7,R7              EXIT BLOCK AVAILABLE         @D64ADVB 00352000
         BZ    EXIT               YES, EXIT TO DISPATCHER      @D64ADVB 00353000
         SLR   R5,R5              INDICATE CALLER IS SVC 18    @D64ADOW 00354000
         L     RC,ACOMSTXI        GET BASE OF COMMON ROUTINE   @D64ADMK 00355000
         BASSM R9,RC              BRANCH TO COMMON ROUTINE     @D64ADMK 00356000
*SGLINK COMSTXIT,INPUT=(R0,R1,R4,R5,R7,R9,RA,RC),                      X00357000
               OUTPUT=(R6,RB),WORK=(R2,R5,R8,RF)                        00358000
         B     EXIT               EXIT TO DISPATCHER           @D64ADVB 00359000
         SPACE                                                          00360000
SVC18ER1 DS    0H                                              @D64ADVB 00361000
         ST    RF,SVER0F          GETVIS RETURN CODE TO R15    @D64ADOW 00362000
         L     R1,S18ERR06        GET ADDITIONAL ERROR INFO    @D64ADOW 00363000
*        B     SVC18ERR           CANCEL WITH ERR47            @D64ADOW 00364000
         SPACE                                                          00365000
SVC18ERR DS    0H                                              @D64ADMK 00366000
         L     RC,ACOMEREX        ADDR OF ERROR EXIT           @D64ADMK 00367000
         BSM   0,RC               CANCEL WITH ERR47            @D64ADMK 00368000
         SPACE                                                          00369000
SVC18A10 DC    A(X'80000000'+SVC18L10) AMODE 31 RTN ADDR       @D64ADOW 00370000
         SPACE                                                          00371000
S18ERR06 DC    A(NUCRSN06)        SGETVIS FOR EXIT BLOCK NOT   @D64ADOW 00372000
*                                 ... SUCCESSFULL, RET CODE OF SGETVIS  00373000
*                                 ... PASSED TO CALLER IN REG 15        00374000
*                                 ... ISSUED IN SGEXIT AND SGSVCX       00375000
         DROP  RA                                              @D64ADMK 00376000
         DROP  RB                                              @D64ADMK 00377000
         DROP  RD                                              @D64ADOW 00378000
         EJECT                                                          00379000
*********************************************************************** 00380000
*                                                                     * 00381000
* SVC 19: PROVIDE A RETURN FROM THE USER'S IT ROUTINE TO THE PROGRAM. * 00382000
*                                                                     * 00383000
*********************************************************************** 00384000
         SPACE 1                                                        00385000
         USING DISP,R6                                         @D64ADOW 00386000
         USING TCBADR,RA                                       @D64ADOW 00387000
         USING SGEXIT,RD                                       @D64ADOW 00388000
SVC19    DS    0H                                              @D64ADVB 00389000
         L     R4,SVC19A10        GET CONTINUATION ADDR        @D64ADOW 00390000
         BSM   0,R4               GOTO 31 BIT MODE             @D64ADVB 00391000
SVC19L10 DS    0H                                              @D64ADOW 00392000
         LA    R4,TCBITACT        INDICATE IT REQUEST          @D61PDOW 00393000
         L     RC,TCBATCBE        ADDR (TCBX)                  @D64ADVB 00394000
         USING TCBXADR,RC                                      @D64ADVB 00395000
         ICM   R7,B'1111',TCBXTQCA GET CURRENT EXIT BLOCK      @D64ADVB 00396000
         BZ    ERR21              NOT AVAILABLE ---> CANCEL    @D64ADOW 00397000
         XC    TCBXTQCA,TCBXTQCA  NO TIMER ROUTINE ACTIVE      @D64ADOW 00398000
         USING EXITBLK,R7                                      @D64ADOW 00399000
         L     RC,ACOMSTXI        ADDR OF SUBROUTINE           @D64ADOW 00400000
         L     R1,ACOMEXIT        ...                          @D64ADOW 00401000
         BASSM R9,R1              CALL COMMON EXIT ROUTINE     @D64ADOW 00402000
*SGLINK COMEXIT,INPUT=(R4,R6,R7,R9,RA,RB,RC),                          X00403000
               WORK=(R0,R1,R2,R3,R4,R5,R8,RF)                           00404000
         L     RC,TCBATCBE        RESTORE TCBX ADDR            @D64ADVB 00405000
SVC19L20 DS    0H                                              @DY45525 00408000
         CLI   TIQTYPE,TIQVSE     VSE TIQE                     @D64ADVB 00406000
         BE    SVC19L80           YES, --->                    @D64ADVB 00407000
         L     R9,TCBXTASI        HANDLING                     @D64ADOW 00409000
         LA    R9,0(,R9)          ... STIMERM                  @D64ADOW 00410000
         CR    R7,R9              ... REQUEST                  @D64ADOW 00411000
         BNE   SVC19L30           YES, --->                    @D64ADOW 00412000
         OC    TIQOUTT,TIQOUTT    ALREADY NEW TIMER EXIT DEFINE@D64ADOW 00413000
         BNZ   SVC19L80           YES,                         @D64ADOW 00414000
SVC19L30 DS    0H                 RESET STIMERM TIQE           @D64ADOW 00415000
         L     RD,ASGTIMX         GET BASE OF SGTIMERX         @D64ADOW 00416000
         USING SGTIMERX,RD                                     @D64ADOW 00417000
         BAS   R9,DEQTIQE         DEQ STIMER/STIMERM EXIT FROM @D64ADOW 00418000
***                               TCBX (TCBXTASI,TCBXTAMU)              00419000
*SGLINK DEQTIQE,INPUT=(R7,R9,RA,RC,RD),WORK=(R0,R1,R2,RF)               00420000
         L     RD,ASGEXIT         RELOAD BASE                  @D64ADOW 00421000
         USING SGEXIT,RD                                       @D64ADOW 00422000
SVC19L80 DS    0H                                              @D64ADOW 00423000
         L     RD,ASGTIMX         GET BASE OF SGTIMERX         @D64ADOW 00424000
         USING SGTIMERX,RD                                     @D64ADOW 00425000
         BAS   R9,FNDTILOW        FIND TIQE WITH LOWEST EXP TIM@D64ADOW 00426000
*SGLINK FNDTILOW,INPUT=(R9,RA,RD),OUTPUT=(R7)                           00427000
         LTR   R7,R7              ANY TIQE FOUND               @D64ADOW 00428000
         BZ    EXIT               NO, EXIT TO DISPATCHER       @D64ADOW 00429000
         L     RD,ASGEXIT         RELOAD BASE                  @D64ADOW 00430000
         USING SGEXIT,RD                                       @D64ADOW 00431000
         STCK  CLOCK              GET CURRENT TIME             @D64ADOW 00432000
         CLC   TIQOUTT,CLOCK      NEXT TIMER INTERVALL ALSO    @D64ADOW 00433000
***                               EXPIRED                               00434000
         BNL   SVC19L90           NO --->                      @D64ADOW 00435000
         ST    R7,TCBXTQCA        EXIT TO BECOME ACTIVE        @D64ADOW 00436000
         XC    TIQOUTT,TIQOUTT    INDICATE INTERVALL EXPIRED   @D64ADOW 00437000
         L     R8,TIBPTR          GET TIB POINTER              @D64ADOW 00438000
         LM    R3,R4,EXITADR                                   @D64ADOW 00439000
         B     ITROUT80           PROCESS NEXT EXIT            @D64ADOW 00440000
*SGLINK  ITROUT,INPUT=(R3,R4,R6,R7,R8,RA,RD)                            00441000
SVC19L90 DS    0H                                              @D64ADOW 00442000
         L     RD,ASGTIMX         GET BASE OF SGTIMERX         @D64ADOW 00443000
         USING SGTIMERX,RD                                     @D64ADOW 00444000
         BAS   R9,ENQTICHN        ENQ TASK INTO TIMER CHAIN    @D64ADOW 00445000
*SGLINK ENQTICHN,INPUT=(R7,R9,RA,RD)                                    00446000
         DROP  RD                                              @D64ADOW 00447000
         B     EXIT               EXIT TO DISPATCHER           @D64ADOW 00448000
         SPACE 1                                                        00449000
SVC19A10 DC    A(X'80000000'+SVC19L10) AMODE 31 RTN ADDR       @D64ADOW 00450000
         SPACE 1                                                        00451000
         DROP  R6                 RESET ADDR TO DISPATCHER     @D64ADVB 00452000
         DROP  R7                 RESET ADDR FOR TIQE          @D64ADVB 00453000
         DROP  RA                 RESET ADDR FOR TCB           @D64ADOW 00454000
         DROP  RC                                              @D64ADOW 00455000
         EJECT                                                          00456000
*********************************************************************** 00457000
*                                                                     * 00458000
*        IT EXIT WHEN USER ROUTINE IS AVAILABLE.                      * 00459000
*           CALLED BY EXTERNAL INTERRUPT HANDLER (MACRO SMICR)        * 00460000
*                                                                     * 00461000
*********************************************************************** 00462000
         SPACE 1                                                        00463000
         USING DISP,R6                                         @D64ADOW 00464000
         USING EXITBLK,R7         PROVIDE ADDR FOR TIQE        @D64ADVB 00465000
         USING TIBADR,R8                                       @D64ADOW 00466000
         USING TCBADR,RA                                       @D64ADOW 00467000
         USING SGEXIT,RD                                       @D64ADVB 00468000
ITROUT   DS    0H                                              @D64ADOW 00469000
*SGLINK  ITROUT,S,INPUT=(R3,R4,R6,R7,R8,RA,RD)                          00470000
         MVI   RID+1,REENTRID     INDICATE ROUT.TO BE REENTRNT @D64ADOW 00471000
         L     RB,TCBSAVE         GET SAVE AREA ADDR           @D64ADOW 00472000
         USING SVEARA,RB                                       @D64ADOW 00473000
         TM    TIBFLAG,RETRYSVC   TASK IS SET UP FOR RESVC     @D64ADOW 00474000
         BZ    ITROUT20           NO --->                      @D64ADOW 00475000
         BAS   R5,SETRESVC        SETUP PSW TO REISSUE SVC     @D64ADOW 00476000
*SGLINK  SETRESVC,INPUT=(R5,R6,R8,RA,RB),WORK=R9                        00477000
ITROUT20 DS    0H                                              @D64ADOW 00478000
         TM    TIQTYPE,TIQWAIT    SELECTED TIQE WITH WAIT=YES  @D64ADOW 00479000
         BO    ITROUT60           YES, DO SPECIAL PROCESSING   @D64ADOW 00480000
         LA    RE,TCBITACT        IT-EXIT ACTIVE INDICATOR     @D64ADOW 00481000
         L     RC,ACOMSTXI        ADDR OF SUBROUTINE           @D64ADOW 00482000
         L     R1,AEXITPRE        ....                         @D64ADOW 00483000
         BASSM R5,R1              CALL EXIT PREPARATION        @D64ADOW 00484000
*SGLINK  EXITPREP,INPUT=(R0:ONLY_AB,R3,R4,R5,R7,RA,RB,RC,RE),          X00485000
               WORK=(R1,R8,R9,RE,RF)                                    00486000
         L     R5,TCBATCBE                                     @D64ADOW 00487000
         USING TCBXADR,R5                                      @D64ADOW 00488000
         TM    TCBXFLG3,TCBXTIMW  TIMER WITH WAIT=YES SPECIFIED@D64ADOW 00489000
         DROP  R5                                              @D64ADOW 00490000
         BNO   ITROUT30           NO,                          @D64ADOW 00491000
         CLI   EXITSACT,X00       YES, (NOTE: TASK IS IN WAIT  @D64ADOW 00492000
***                               STATE IF NO OTHER ASYNCHRONOUS        00493000
***                               EXIT ACTIVE)                          00494000
         BNE   ITROUT30                                        @D64ADOW 00495000
         OI    EXITFLG,EXITTIMW   INDICATE EXIT SAVE AREA      @D64ADOW 00496000
***                               CONTAINS 'WAIT' STATUS.               00497000
ITROUT30 DS    0H                                              @D64ADOW 00498000
         CLI   TIQTYPE,TIQVSE     IS IT A VSE TIMER            @D64ADVB 00499000
         BE    EXIT               YES, --->                    @D64ADVB 00500000
***                                                                     00501000
***      SET UP MVS EXIT I/F                                            00502000
***                                                                     00503000
         LA    R9,XRTIMXIT        RETURN ADDRESS FOR TIMER     @D64ADVB 00504000
         ST    R9,SVER0E          ... IN REG 14                @D64ADVB 00505000
         L     R9,TIQAUSA         ADDR OF 72-BYTE SAVE AREA    @D64ADVB 00506000
         ST    R9,SVER0D          ... IN REG 13                @D64ADVB 00507000
         LA    R9,MVSSALN(,R9)    PARAMETER AREA ADDRESS       @D64ADVB 00508000
         ST    R9,SVER01          ... IN REG 1                 @D64ADVB 00509000
         MVC   0(L'TIQIDEN,R9),TIQIDEN SET UP PARAMETER        @D64ADVB 00510000
         MVC   4(L'TIQPARM,R9),TIQPARM ... LIST                @D64ADVB 00511000
         B     EXIT               RETURN TO DISPATCHER         @D64ADOW 00512000
ITROUT60 DS    0H                 TIME INTERVAL EXPIRED FOR    @D64ADOW 00513000
***                               STIMER/STIMERM WITH WAIT=YES          00514000
         L     RC,PCBPTR                                       @D64ADOW 00515000
         USING PCBADR,RC                                       @D64ADOW 00516000
         ICM   RC,B'1111',PCBOCPTR                             @D64ADOW 00517000
         BZ    ITROUT70           NO OC EXIT DEFINED           @D64ADOW 00518000
         DROP  RC                                              @D64ADOW 00519000
         TM    EXITFLG-EXITBLK(RC),EXITTIMW OC EXIT ACTIVATED  @D64ADOW 00520000
***                               WHILE TASK IN WAIT DUE TO             00521000
***                               STIMER/STIMERM JUST PROCESSED         00522000
         BNO   ITROUT70           NO,                          @D64ADOW 00523000
         OI    EXITFLG,DELINT     DELAY TIMER EXIT             @D64ADOW 00524000
         B     EXIT                                            @D64ADOW 00525000
ITROUT70 DS    0H                                              @D64ADOW 00526000
         L     RC,TCBATCBE        GET TCBX ADDR                @D64ADOW 00527000
         USING TCBXADR,RC                                      @D64ADOW 00528000
         USING SVUARA,R4          TIMER SAVE AREA              @D64ADOW 00529000
         MVC   INTINFO(4),SVUPSW  RESTORE INTERRUPT INFO       @D64ADOW 00530000
         MVC   TCBMVSIS(4),SVUPSW+4  ...                       @D64ADOW 00531000
         MVC   SVEPSW(8),SVUAPSW  ... PSW                      @D64ADOW 00532000
         MVC   SVER00(36),SVUR00  ... REG 0 - 8                @D64ADOW 00533000
         MVC   SVER09(28),SVUR09  ... REG 9 - 15               @D64ADOW 00534000
         L     R9,TCBARSAV        ...                          @D64ADOW 00535000
         MVC   0(64,R9),SVUAREG   ... ACC REG 0 - 15           @D64ADOW 00536000
         NI    TCBXFLG3,XFF-TCBXTIMW NO TIMER WITH WAIT=YES DEF@D64ADOW 00537000
         B     ITROUT90                                        @D64ADOW 00538000
ITROUT80 DS    0H                                              @D64ADOW 00539000
         LTR   R3,R3              EXIT RTN OR TECB             @D64ADOW 00540000
         BZ    ITROUT90           NO, GO TO NEXT TIQE          @D64ADOW 00541000
         LTR   R4,R4              TECB ?                       @D64ADOW 00542000
         BNZ   ITROUT20           NO, SCHEDULE NEXT TIMER EXIT @D64ADOW 00543000
         OI    2(R3),TRABIT       POST TECB AND GOTO NEXT TIQE @D64ADOW 00544000
         XC    EXITADR,EXITADR    CLEAR TECB ADDR              @D64ADOW 00545000
ITROUT90 DS    0H                                              @D64ADOW 00546000
         XC    TCBXTQCA,TCBXTQCA  NO EXIT ACTIVE               @D64ADOW 00547000
         B     SVC19L20           CHECK FOR NEXT TIQE          @D64ADOW 00548000
         DROP  R6                                              @D64ADOW 00549000
         DROP  R7                                              @D64ADOW 00550000
         DROP  R8                                              @D64ADOW 00551000
         DROP  RA                                              @D64ADOW 00552000
         DROP  RB                                              @D64ADOW 00553000
         DROP  RC                                              @D64ADOW 00554000
         DROP  RD                                              @D64ADOW 00555000
         SPACE 3                                                        00556000
*********************************************************************** 00557000
*                                                                     * 00558000
* XRTIMXIT: RETURN FROM MVS TIMER EXIT ROUTINE                        * 00559000
*                                                                     * 00560000
*********************************************************************** 00561000
         SPACE 1                                                        00562000
XRTIMXIT DS    0H                 ENTRY POINT                  @D64ADVB 00563000
*                                 ... MVS TIMER EXIT ROUTINE            00564000
         SVC   19                 RESET REAL TIMER EXIT        @D64ADVB 00565000
         EJECT                                                          00566000
*********************************************************************** 00567000
*                                                                     * 00568000
****     OC EXIT SERVICES     ***************************************** 00569000
*                                                                     * 00570000
* SVC 20: DEFINE OC-EXIT                                              * 00571000
*            STORE THE ADDRESS OF THE USER'S OC ROUTINE AND SAVE AREA * 00572000
*            ADDRESS IN THE OC TABLE.                                 * 00573000
*         RESET OC-EXIT                                               * 00574000
*                                                                     * 00575000
*********************************************************************** 00576000
         SPACE 1                                                        00577000
         USING DISP,R6                                         @D64ADOW 00578000
         USING TCBADR,RA                                       @DY45502 01115000
         USING SVEARA,RB                                       @D64ADOW 00579000
         USING SGEXIT,RD                                       @D64ADOW 00580000
SVC20    DS    0H                                              @D51IDOW 00581000
         L     R4,SVC20A00        GET CONTINUATION ADDR        @D64ADOW 00607000
         BSM   0,R4               GOTO 31 BIT MODE             @D64ADVB 00608000
SVC20A00 DC    A(X'80000000'+SVC20L00) AMODE 31 RTN ADDR       @D64ADOW 00646000
SVC20L00 DS    0H                                              @D64ADOW 00609000
         L     R3,PCBPTR          POINT TO PCB                 @D51HDOW 00582000
         CLC   TID,IJBHMTID       IS IT MAINTASK               @D51IDOW 00583000
         BNH   SVC20L10           YES,ALLOW OC EXIT            @D36IDFR 00584000
         TM    TCBAUTHF,TCBVEND   IS REQUESTOR A VENDOR        @DY45502 01122000
         BO    SVC20L10           YES, ALLOW OC EXIT           @DY45502 01123000
         TM    PCBSSFLG-PCBADR(R3),VTAM IS VTAM REQUESTOR      @D51HDOW 00585000
***                               (VTAM IS ALLOWED TO DEFINE THE OC     00586000
***                               EXIT UNDER A SUBTASK. NEVERTHELESS    00587000
***                               THE OC EXIT IS DISPATCHED UNDER       00588000
***                               CONTROL OF THE MAINTASK)              00589000
         BZ    ERR21              NO,ILLEGAL SVC               @D36IDFR 00590000
SVC20L10 DS    0H                                              @D64ADOW 00591000
         TM    TCBEXFLG,TCBEXAM   CALLER IN 31 BIT MODE        @DY45712 00829000
         BO    SVC20L12           YES,                         @DY45712 00830000
         ICM   R0,8,H0            CLEAR BYTE 0                 @DY45712         
         ICM   R1,8,H0            ... IN BOTH INPUT REGISTERS  @DY45712         
SVC20L12 DS    0H                                              @DY45712 00108000
         ICM   R7,B'1111',PCBOCPTR-PCBADR(R3) OC ENTRY IN PCB  @D64ADOW 00592000
         BNZ   SVC20L20           YES, TAKE IT                 @D64ADOW 00593000
         LTR   R0,R0              RESET REQUIRED               @D64ADOW 00594000
         BZ    EXIT               YES, NOTHING TO DO           @D64ADOW 00595000
         CR    R0,R1              LIST SUPPLIED                @DY45712         
         BNE   SVC20L15           NO                           @DY45712         
         ICM   RF,15,4(R1)        RESET REQUIRED               @DY45712         
PCKSV20A DS    0H                 PROGRAM CHECK POSSIBLE       @DY45712         
         BZ    EXIT               YES, NOTHING TO DO           @DY45712         
SVC20L15 DS    0H                                              @DY45712         
         LA    R0,EXOCLEN         LENGTH OF EXIT CONTROL BLOCK @D64ADOW 00596000
         SLR   RF,RF              SET FCT CODE                 @D64ADOW 00597000
         L     RC,AEXITGVI        GET BASE OF COMMON ROUTINE   @D64ADOW 00598000
         BASSM R8,RC              ALLOCATE OC-EXIT BLOCK       @D64ADOW 00599000
*SGLINK  EXITGVIS,INPUT=(R0,R8,RA,RC,RF),OUTPUT=(R1,RF),WORK=R0         00600000
         LTR   RF,RF              STORAGE AVAILABLE            @D64ADMK 00601000
         BNZ   SVC20ERR           SPACE EXHAUSTED              @D64ADOW 00602000
         LR    R7,R1              SET CORRECT EXIT BLOCK ADDR  @D64ADOW 00603000
         USING EXITBLK,R7                                      @DY45712 00610000
         MVI   EXITFLG1,EXOCTYPE  THIS IS A OC-EXIT-BLOCK      @DY45712 00625000
         ST    R7,PCBOCPTR-PCBADR(,R3) OC ENTRY IN PCB         @D64ADOW 00604000
         LM    R0,R1,SVER00       RELOAD USERS REGISTER        @D64ADOW 00605000
         TM    TCBEXFLG,TCBEXAM   CALLER IN 31 BIT MODE        @DY45712 00829000
         BO    SVC20L20           YES,                         @DY45712 00830000
         ICM   R0,8,H0            CLEAR BYTE 0                 @DY45712         
         ICM   R1,8,H0            ... IN BOTH INPUT REGISTERS  @DY45712         
SVC20L20 DS    0H                                              @D64ADOW 00606000
         SLR   R4,R4              INDICATE NO LIST SUPPLIED    @D64ADOW 00611000
         LTR   R0,R0              RESET REQUIRED               @D64ADOW 00612000
         BZ    SVC20L40           YES, --->                    @D64ADOW 00613000
         CR    R0,R1              LIST SUPPLIED                @D64ADOW 00615000
         BNE   SVC20L40           NO, --->                     @D64ADOW 00616000
         LR    R4,R1              LOAD LIST ADDR               @D64ADOW 00617000
         ICM   R5,15,4(R4)        RESET REQUIRED               @DY45712 00628000
PCKSV20C DS    0H                 PROGRAM CHECK POSSIBLE       @DY45712         
         BZ    SVC20L40           YES, --->                    @DY45712 00613000
         TM    0(R4),X01          MSGPARM OR MSGDATA SPECIFIED @DY45712 00628000
.*                                00 AND 02 REPRESENT MSG*=NO           00629000
.*                                01 AND 03 REPRESENT MSG*=YES          00630000
PCKSV20B DS    0H                 PROGRAM CHECK POSSIBLE       @DY45712         
         BZ    SVC20L40           NO, --->                     @DY45712 00631000
         TM    0(R4),X04          MSGPARM SPECIFIED            @DY45712 00632000
         BO    SVC20L35           YES, --->                    @DY45712 00633000
         OI    EXITFLG1,EXOCSAV   INDICATE MSGDATA=YES         @DY45712 00634000
         B     SVC20L40                                        @DY45712 00635000
SVC20L35 DS    0H                                              @DY45712 00636000
         OI    EXITFLG1,EXOCPARM  INDICATE MSGPARM=YES         @DY45712 00637000
SVC20L40 DS    0H                                              @D64ADOW 00618000
         SLR   R5,R5              CALLER IS SVC20              @DY45712 00614000
         L     RC,ACOMSTXI        GET BASE OF COMMON ROUTINE   @D64ADMK 00619000
         BASSM R9,RC              BRANCH TO COMMON ROUTINE     @D64ADMK 00620000
*SGLINK COMSTXIT,INPUT=(R0,R1,R4,R5,R7,R9,RA,RC),                      X00621000
               OUTPUT=(R6,RB),WORK=(R2,R5,R8,RF)                        00622000
         B     EXIT               RETURN TO DISPATCHER         @D61NDOW 00639000
*                                                                               
SVC20ERR DS    0H                 SPACE EXHAUSTED              @D64ADOW 00640000
         ST    RF,SVER0F          GETVIS RETURN CODE TO R15    @D64ADOW 00641000
         L     R1,S20ERR06        GET ADDITIONAL ERROR INFO    @D64ADOW 00642000
         L     RC,ACOMEREX        ADDR OF ERROR EXIT           @D64ADOW 00643000
         BSM   0,RC               CANCEL WITH ERR47            @D64ADMK 00644000
*                                                                       00645000
S20ERR06 DC    A(NUCRSN06)        SGETVIS FOR EXIT BLOCK NOT   @D64ADOW 00648000
*                                 ... SUCCESSFULL, RETURN CODE          00649000
*                                 ... PASSED TO CALLER IN REG 15        00650000
*                                 ... ISSUED IN SGEXIT AND SGSVCX       00651000
         DROP  R6                                              @D64ADOW 00652000
         DROP  R7                                              @D61NDOW 00653000
         DROP  RA                                              @DY45502 01115000
         DROP  RB                                              @D64ADOW 00654000
         DROP  RD                                              @D64ADOW 00655000
         EJECT                                                          00656000
*********************************************************************** 00657000
*                                                                     * 00658000
* SVC 21: PROVIDE A RETURN FROM THE USER'S OC ROUTINE TO THE PROGRAM. * 00659000
*                                                                     * 00660000
*********************************************************************** 00661000
         SPACE 1                                                        00662000
         USING DISP,R6                                         @D64ADOW 00663000
         USING TCBADR,RA                                       @D64ADOW 00664000
         USING SGEXIT,RD                                       @D64ADOW 00665000
SVC21    DS    0H                                              @D51IDOW 00666000
         CLC   TID,IJBHMTID       IS IT MAINTASK               @D51IDOW 00667000
         BH    ERR21              NO,ILLEGAL SVC               @D36IDFR 00668000
         L     R7,PCBPTR          POINT TO                     @D36IDFR 00669000
         ICM   R7,B'1111',PCBOCPTR-PCBADR(R7) OC ENTRY IN PCB  @D64ADOW 00670000
         BZ    ERR21                                           @D64ADOW 00671000
         USING EXITBLK,R7                                      @D64ADOW 00672000
         L     R4,SVC21A10        GET CONTINUATION ADDR        @D64ADOW 00673000
         BSM   0,R4               GOTO 31 BIT MODE             @D64ADVB 00674000
SVC21L10 DS    0H                                              @D64ADOW 00675000
         LA    R4,TCBOCACT        INDICATE OC REQUEST          @D61PDOW 00676000
         L     RC,ACOMSTXI        ADDR OF SUBROUTINE           @D64ADOW 00677000
         L     R1,ACOMEXIT        ...                          @D64ADOW 00678000
         BASSM R9,R1              CALL COMMON EXIT RTN         @D64ADOW 00679000
*SGLINK COMEXIT,INPUT=(R4,R6,R7,R9,RA,RB,RC),                          X00680000
               WORK=(R0,R1,R2,R3,R4,R5,R8,RF)                           00681000
         BAS   R3,OCCL2ND         CHECK IF FREEVIS REQUIRED    @D61CDOW 00682000
*SGLINK  OCCL2ND,INPUT=(R3,RD),WORK=(R0,R1,R2,R4,RF),OUTPUT=(R2,R4)     00683000
         ICM   R5,B'1111',EXITADR RESET PERFORMED IN MEANTIME  @D64ADOW 00684000
         BNZ   SVC21L20           NO                           @D64ADOW 00685000
*    R5 IS ALRAEDY SET FOR STXIT OC                                             
         SLR   R0,R0              INDICATE RESET               @D64ADOW 00686000
         L     RC,ACOMSTXI        GET BASE OF COMMON ROUTINE   @D64ADOW 00687000
         BASSM R9,RC              BRANCH TO COMMON ROUTINE     @D64ADOW 00688000
*SGLINK COMSTXIT,INPUT=(R0,R1,R4,R5,R7,R9,RA,RC),                      X00689000
               OUTPUT=(R6,RB),WORK=(R2,R5,R8,RF)                        00690000
SVC21L20 DS    0H                                              @D64ADOW 00691000
         L     RC,TCBATCBE        GET TCBX ADDR                @D64ADOW 00692000
         USING TCBXADR,RC                                      @D64ADOW 00693000
         ICM   R4,B'1111',TCBXTQCA CURRENTLY ACTIVE TIMER      @D64ADOW 00694000
         USING EXITBLK,R4                                      @D64ADOW 00695000
         BZ    EXIT                                            @D64ADOW 00696000
         TM    EXITFLG,DELINT     WAS INTERRUPT DELAYED        @D64ADOW 00697000
         BNO   EXIT               NO, DISPATCHER               @D64ADOW 00698000
         L     R8,TIBPTR                                       @D64ADOW 00699000
         USING TIBADR,R8                                       @D64ADOW 00700000
         NI    EXITFLG,XFF-DELINT SETUP DISPATCHER             @D64ADOW 00701000
         OI    TIBFLAG,CDELEX     ... EXIT                     @D64ADOW 00702000
         DROP  R4                                              @D64ADOW 00703000
         DROP  R8                                              @D64ADOW 00704000
         DROP  RC                                              @D64ADOW 00705000
         B     EXIT               EXIT TO DISPATCHER           @D61NDOW 00706000
SVC21A10 DC    A(X'80000000'+SVC21L10) AMODE 31 RTN ADDR       @D64ADOW 00707000
         DROP  R6                                              @D64ADOW 00708000
         DROP  R7                                              @D64ADOW 00709000
         DROP  RA                                              @D64ADOW 00710000
         DROP  RD                                              @D64ADOW 00711000
         EJECT                                                          00712000
*********************************************************************** 00713000
*                                                                     * 00714000
*        TERMINATOR SUBROUTINE TO CLEAR OC EXIT AREAS                 * 00715000
*           CALLED FROM TERMINATION PROCESS (MACRO SGAP)              * 00716000
*                                                                     * 00717000
*********************************************************************** 00718000
         SPACE 1                                                        00719000
         USING TCBADR,RA                                       @D64ADOW 00720000
         USING SGEXIT,RD                                       @D64ADOW 00721000
OCCLEAN  DS    0H                                              @D61CDOW 00722000
*SGLINK  OCCLEAN,S,INPUT=(R5,RA,RD),WORK=(R0,R1,RF)                     00723000
***  CALLED WITH BAS INTRUCTION                                         00724000
         STM   R2,RE,SVCWORK     FREE UP SOME WORK REGISTER    @D64ADOW 00725000
         L     R3,OCCLA010       GET CONTINUATION ADDR         @D64ADOW 00726000
         BSM   0,R3              GOTO 31 BIT MODE              @D64ADOW 00727000
OCCLL010 DS    0H                                              @D64ADOW 00728000
         BAS   R3,OCCL2ND        CHECK IF MSGPARM=YES SPECIFIED@D61CDOW 00729000
*SGLINK  OCCL2ND,INPUT=(R3,RD),WORK=(R0,R1,R2,R4,RF),OUTPUT=(R2,R4)     00730000
         LTR   R7,R4             GET ADDR OF OC-EXIT-BLOCK     @D64ADOW 00731000
         BZ    OCCLL020          NOT AVAILABLE --->            @D64ADOW 00732000
         USING EXITBLK,R7                                      @D64ADOW 00733000
         NI    EXITADR,XFF-EXITACT MAKE SURE THAT DELETE WILL  @D64ADOW 00734000
***                              BE EXECUTED                            00735000
         DROP  R7                                              @D64ADOW 00736000
         SLR   R0,R0             REQUEST RESET                 @D64ADOW 00737000
         SLR   R5,R5             INDICATE STXIT OC SERVICE     @DY45712 00737000
         L     RC,ACOMSTXI        GET BASE OF COMMON ROUTINE   @D64ADOW 00738000
         BASSM R9,RC              BRANCH TO COMMON ROUTINE     @D64ADOW 00739000
*SGLINK COMSTXIT,INPUT=(R0,R1,R4,R5,R7,R9,RA,RC),                      X00740000
               OUTPUT=(R6,RB),WORK=(R2,R5,R8,RF)                        00741000
OCCLL020 DS    0H                                              @D64ADOW 00742000
         LM    R2,RE,SVCWORK     RESTORE REGISTER              @D64ADOW 00743000
         BSM   0,R5              RETURN                        @D64ADOW 00744000
OCCLA010 DC    A(OCCLL010+X'80000000')                         @D64ADOW 00745000
         DROP  RA                                              @D64ADOW 00746000
*                                                                       00747000
OCCL2ND  DS    0H                                              @D61CDOW 00748000
*SGLINK  OCCL2ND,S,INPUT=(R3,RD),OUTPUT=(R2,R4),WORK=(R0,R1,R2,R4,RF)   00749000
         L     R2,PCBPTR         GET PCB POINTER               @D61CDOW 00750000
         USING PCBADR,R2                                       @D61CDOW 00751000
         ICM   R4,B'1111',PCBOCPTR GET OC EXIT-BLOCK ADDR      @D64ADOW 00752000
         BZR   R3                NOT AVAILABLE, RETURN         @D64ADOW 00753000
         USING EXITBLK,R4                                      @D61CDOW 00754000
         TM    EXITFLG1,EXOCPARM MSGPARM=YES SPECIFIED         @D61CDOW 00755000
         BNOR  R3                NO, --->                      @D61CDOW 00756000
         ICM   R1,B'1111',EXITDATA GET POINTER TO MSG DATA     @D61CDOW 00757000
         BZR   R3                                              @D61CDOW 00758000
         LH    R0,EXITDLEN       GET LENGTH OF MSG DATA        @D61CDOW 00759000
*** FREEVIS FOR MSGPARM AREA                                            00760000
*        SFREEVIS LENGTH=(0),ADDRESS=(1)                                00761000
         SFREEVIS LENGTH=(0),ADDRESS=(1)                       @D61CDOW 00762000
*END OF SFREEVIS MACRO                                                  00763000
         SPACE                                                          00764000
         BR    R3                CONTINUE AT CORRECT PLACE     @D61CDOW 00765000
         DROP  R2                                              @D61CDOW 00766000
         DROP  R4                                              @D61CDOW 00767000
         DROP  RD                                              @D64ADOW 00768000
         EJECT                                                          00769000
*********************************************************************** 00770000
*                                                                     * 00771000
*        OC EXIT WHEN USER ROUTINE IS AVAILABLE.                      * 00772000
*           CALLED BY DISPATCHER (MACRO DISP)                         * 00773000
*                                                                     * 00774000
*********************************************************************** 00775000
         SPACE 1                                               @D35EDFR 00776000
         USING DISP,R6                                         @D64ADOW 00777000
         USING TIBADR,R8                                       @D52VDOW 00778000
         USING TCBADR,RA                                       @D64ADOW 00779000
         USING SGEXIT,RD                                       @D64ADOW 00780000
OCROUT   DS    0H                 ENTRY FOR OC-EXIT            @D61NDOW 00781000
*SGLINK  OCROUT,S,INPUT=(R3,R4,R6,R7,R8,RA,RD)                          00782000
         MVI   RID+1,REENTRID     INDICATE ROUT.TO BE REENTRNT @D36IDFR 00783000
         L     RB,TCBSAVE         GET POINTER TO PP SAVE AREA  @D36IDFR 00784000
         TM    TIBFLAG,RETRYSVC   TASK IS SET UP FOR RESVC     @D36IDFR 00785000
         BZ    OCROUT2            NO --->                      @D64ADOW 00786000
         BAS   R5,SETRESVC        SETUP PSW TO REISSUE SVC     @D36IDFR 00787000
*SGLINK  SETRESVC,INPUT=(R5,R6,R8,RA,RB),WORK=R9                        00788000
OCROUT2  DS    0H                                              @D61NDOW 00789000
         LA    RE,TCBOCACT        OC-EXIT ACTIVE INDICATOR     @D61NDOW 00790000
         L     RC,ACOMSTXI        ADDR OF SUBROUTINE           @D64ADOW 00791000
         L     R1,AEXITPRE        ...                          @D64ADOW 00792000
         USING EXITBLK,R7                                      @D64ADOW 00793000
         BASSM R5,R1              CALL EXIT PREPARATION        @D64ADOW 00794000
*SGLINK  EXITPREP,INPUT=(R0:ONLY_AB,R3,R4,R5,R7,RA,RB,RC,RE),          X00795000
               WORK=(R1,R8,R9,RE,RF)                                    00796000
         L     R5,TCBATCBE                                     @D64ADOW 00797000
         USING TCBXADR,R5                                      @D64ADOW 00798000
         TM    TCBXFLG3,TCBXTIMW  TIMER WITH WAIT=YES SPECIFIED@D64ADOW 00799000
         DROP  R5                                              @D64ADOW 00800000
         BNO   EXIT               NO,                          @D64ADOW 00801000
         CLI   EXITSACT,X00       YES, TASK IS IN WAIT STATE   @D64ADOW 00802000
***                               WHEN NO OTHER ASYNCHRONOUS EXIT ACTIV 00803000
         BNE   EXIT                                            @D64ADOW 00804000
         OI    EXITFLG,EXITTIMW   INDICATE EXIT SAVE AREA      @D64ADOW 00805000
***                               CONTAINS EXCHANGED STATUS             00806000
         B     EXIT               RETURN TO DISPATCHER         @D64ADOW 00807000
         DROP  R6                                              @D64ADOW 00808000
         DROP  R7                                              @D64ADOW 00809000
         DROP  R8                                              @D52VDOW 00810000
         DROP  RA                                              @D64ADOW 00811000
         DROP  RD                                              @D64ADOW 00812000
         EJECT ,                                               @D14BDIS 00813000
*********************************************************************** 00814000
*                                                                     * 00815000
****     AB EXIT SERVICES      **************************************** 00816000
*                                                              @D33DDJO 00817000
*  SVC 37:  STORE THE ADDRESS OF THE USER'S AB ROUTINE         @D33DDJO 00818000
*                                                              @D33DDJO 00819000
*********************************************************************** 00820000
         USING DISP,R6                                         @D64ADMK 00821000
         USING TCBADR,RA                                       @D64ADMK 00822000
         USING SVEARA,RB                                       @D64ADMK 00823000
         USING SGEXIT,RD                                       @D64ADOW 00824000
         SPACE                                                          00825000
SVC37    DS    0H                                              @D52VDOW 00826000
         TM    TCBFLAG6,TCBPSTAC  VENDOR EXIT ACTIVE           @D64ADOW 00827000
         BO    ERR21              YES, ILLEGAL SVC             @D64ADOW 00828000
         TM    TCBEXFLG,TCBEXAM   CALLER IN 31 BIT MODE        @D52VDOW 00829000
         BNO   SVC37L05           NO, INPUT ARE 3BYTE ADDRESSES@D52VDOW 00830000
         L     R2,SVC37A05        GET CONTINUATION ADDR        @D64ADOW 00831000
         BSM   0,R2               GOTO 31 BIT MODE             @D64ADVB 00832000
SVC37L05 DS    0H                                              @D64ADOW 00833000
         LR    R4,R0              CLEAR FIRST BYTE/BIT         @D64ADOW 00834000
         LA    R0,0(,R4)          ...                          @D64ADOW 00835000
         LA    R1,0(,R1)          ...                          @D64ADOW 00836000
         SLR   R4,R4              INDICATE NO PARAMETER LIST   @D51HDOW 00837000
         LTR   R0,R0              RESET EXIT REQUIRED          @KD40113 00838000
         BZ    SVC37L10           IF ZERO, GOTO RESET AB EXIT  @KD40113 00839000
         CR    R0,R1              ANY OPTION SPEC.POSSIBLE     @D14CDFR 00840000
         BE    SVC37VLS           YES, VALIDATE LIST           @D14CDFR 00841000
         TM    TCBEXFLG,TCBEXAM   CALLER IN 31 BIT MODE        @KX41420 00842000
         BO    ERR45              YES, CANCEL                  @KX41420 00843000
         LR    R9,R0                                           @D52VDOW 00844000
         LA    R0,0(,R9)          CLEAR FIRST BIT/BYTE         @D52VDOW 00845000
         LA    R1,0(,R1)          CLEAR FIRST BIT/BYTE         @D52VDOW 00846000
SVC37L10 DS    0H                                              @D64ADMK 00847000
         L     R2,SVC37A11        GET CONTINUATION ADDR        @D64ADOW 00848000
         BSM   0,R2               GOTO 31 BIT MODE             @D64ADVB 00849000
SVC37L20 DS    0H                                              @D64ADOW 00850000
         L     R7,TCBABEX         GET FIRST AB EXIT BLK ADDR   @D64ADMK 00851000
         LA    R7,0(,R7)                                       @D64ADOW 00852000
         TM    TCBABEX,EXITACT    ANY AB-TYPE EXIT ACTIVE      @D64ADOW 00853000
         BO    SVC37ER3           YES, REJECT STXIT (SET&RESET)@D64ADOW 00854000
         LTR   R0,R0              RESET REQUIRED               @D64ADOW 00855000
         BZ    SVC37RES           GOTO RESET                   @D64ADOW 00856000
         CLI   TCBEXITF,X00       PC|OC|IT|POST|ETXR EXIT ACTIV@D64ADOW 00857000
         BNE   SVC37ER4           YES, DON'T ALLOW STXIT AB SET@D64ADOW 00858000
         L     RF,TCBATCBE        GET CURRENT LINK STCK        @D64ADOW 00858300
         L     RF,TCBX1CRF-TCBXADR(,RF) ... ENTRY ADDRESS      @D64ADOW 00858600
         L     RC,ACURLSTK        GET BASE OF SUBROUTINE       @D64ADOW 00859000
         BASSM R8,RC              RETRIEVE CURRENT LS ENTRY ADD@D64ADOW 00860000
*SGLINK CCURLSTK,INPUT=(R8,RA,RC,RF),OUTPUT=RC                          00861490
         USING LSTKEDSC,RC                                     @D64ADOW 00862000
         TM    LSTKET,LSTKHTST    IS IT A HEADER               @D64ADOW 00863000
         BNZ   SVC37ER2           NO, LINKAGE STACK NOT EMPTY  @D64ADOW 00864000
         DROP  RC                                              @D64ADOW 00865000
         LTR   R4,R4              ANY OPTION SPECIFIED         @D64ADOW 00866000
         BZ    SVC37L30           NO, --->                     @D64ADOW 00867000
         BAS   R9,SVC37SUS        EARLY ONLY ALLOWED FOR SUBSYS@D64ADOW 00868000
SVC37L30 DS    0H                                              @D64ADOW 00869000
         LTR   RE,R7              COPY EXIT BLOCK ADDR         @D64ADOW 00870000
         BZ    SVC37L50           NO EXIT BLOCK DEFINED        @D64ADOW 00871000
         USING EXITBLK,R7                                      @D64ADMK 00872000
         ICM   R2,15,EXITADR      GET EXIT ADDR                @D64ADOW 00873000
         BZ    SVC37L80           NOT USED, TAKE EXIT BLOCK    @D64ADOW 00874000
SVC37L35 DS    0H                 ...EXIT BLOCK IS IN USE      @D64ADMK 00875000
         ICM   R8,B'1111',PSATOLD MVS EMULATION ACTIVE         @D64ADOW 00876000
         BZ    SVC37L37           NO, --->                     @D64ADOW 00877000
         SLR   R9,R9                                           @D64ADOW 00878000
         ICM   R9,7,TCBSTABB-TCB(R8) GET FIRST SCB IN CHAIN    @D64ADOW 00879000
         BNZ   SVC37ER1           ESTAEX/FESTAE DEF'D --> CNCL @D64ADOW 00880000
SVC37L37 DS    0H                                              @D64ADMK 00881000
         CLI   EXITFLG2,EXESTAEX  ESTAEX ALREADY DEFINED       @D64ADOW 00882000
         BE    SVC37ER1           YES, STXIT AB NOT ALLOWED    @D64ADOW 00883000
         CLI   EXITFLG2,EARLYAB   EARLY AB EXIT BLOCK          @D64ADOW 00884000
         BE    SVC37L40           YES, --->                    @D64ADOW 00885000
***                               FIRST EXIT BLOCK IS A NORMAL AB EXIT  00886000
         LTR   R4,R4              REQUEST TO DEFINE EARLY AB   @D64ADOW 00887000
         BZ    SVC37L80           NO, OVERWRITE CURRENT ENTRY  @D64ADOW 00888000
         TM    0(R4),EARLY        REALY EARLY REQUIRED         @D51HDOW 00889000
         BNO   SVC37L80           NO OVERWRITE ENTRY           @D61NDOW 00890000
         B     SVC37L50           YES A NEW EXIT BLOCK REQUIRED@D64ADOW 00891000
SVC37L40 DS    0H                 FIRST IS EARLY AB EXIT BLOCK @D64ADMK 00892000
         LTR   R4,R4              REQUEST TO DEFINE EARLY      @D64ADOW 00893000
         BZ    SVC37L45           NO, CONTINUE CHECKING        @D64ADOW 00894000
         LA    RF,4               SET ERROR RET.CODE (MODIFY)  @D14CDIS 00895000
         TM    0(R4),EARLY        REALY EARLY REQUIRED         @D51HDOW 00896000
         BO    SVC37RET           YES, NOT ALLOWED             @D61NDOW 00897000
SVC37L45 DS    0H                 EXIT BLOCK IS IN USE         @D64ADMK 00898000
         ICM   R7,15,EXITNEXT     GET SECONDARY AB EXIT BLOCK  @D64ADOW 00899000
         BNZ   SVC37L80           AVAILABLE, TAKE IT           @D64ADOW 00900000
SVC37L50 DS    0H                                              @D64ADMK 00901000
         LR    R9,R0              SAVE R0                      @D64ADMK 00902000
         LR    R2,R1              SAVE R1                      @D64ADMK 00903000
         LA    R0,EXABLEN         LENGTH OF EXIT CONTROL BLOCK @D64ADOW 00904000
         SLR   RF,RF              SET FUNCTION CODE            @D64ADOW 00905000
         L     RC,AEXITGVI        GET BASE OF COMMON ROUTINE   @D64ADOW 00906000
         BASSM R8,RC              ALLOCATE AB-EXIT BLOCK       @D64ADOW 00907000
*SGLINK  EXITGVIS,INPUT=(R0,R8,RA,RC,RF),OUTPUT=(R1,RF),WORK=R0         00908000
         LTR   RF,RF              STORAGE AVAILABLE            @D64ADMK 00909000
         BNZ   SVC37ER0           SPACE EXHAUSTED              @D64ADOW 00910000
         LTR   RE,RE              ANY EXIT BLOCK DEFINED       @D64ADOW 00911000
         BZ    SVC37L65           NO CHAIN TO TCB              @D64ADOW 00912000
         CLI   EXITFLG2-EXITBLK(RE),EARLYAB IS EARLY DEFINED   @D64ADOW 00913000
         BNE   SVC37L60           NO THAN EARLY AB REQ NOW --> @D64ADOW 00914000
         ST    R1,EXITNEXT-EXITBLK(,RE) NEW TO BOTTOM OF CHAIN @D64ADOW 00915000
         B     SVC37L70                                        @D64ADOW 00916000
SVC37L60 DS    0H                                              @D64ADMK 00917000
         ST    RE,EXITNEXT-EXITBLK(,R1) OLD TO BOTTOM OF CHAIN @D64ADOW 00918000
SVC37L65 DS    0H                                              @D64ADMK 00919000
         L     RF,BIT0ON          KEEP ACTIV BIT               @D64ADOW 00920000
         N     RF,TCBABEX         ...                          @D64ADOW 00921000
         OR    R1,RF              ...                          @D64ADOW 00922000
         ST    R1,TCBABEX         NEW TO TOP OF CHAIN          @D64ADOW 00923000
SVC37L70 DS    0H                                              @D64ADMK 00924000
         LR    R7,R1              GET EXIT BLOCK ADDR          @D64ADMK 00925000
         LR    R0,R9              RESTORE R0                   @D64ADMK 00926000
         LR    R1,R2              RESTORE R1                   @D64ADMK 00927000
SVC37L80 DS    0H                                              @D64ADMK 00928000
         L     R5,F1              INDICATE SVC37 CALLER        @D64ADMK 00929000
         L     RC,ACOMSTXI        GET BASE OF COMMON ROUTINE   @D64ADMK 00930000
         BASSM R9,RC              BRANCH TO COMMON ROUTINE     @D64ADMK 00931000
*SGLINK COMSTXIT,INPUT=(R0,R1,R4,R5,R7,R9,RA,RC),                      X00932000
               OUTPUT=(R6,RB),WORK=(R2,R5,R8,RF)                        00933000
         MVI   EXITFLG1,EXABTYPE  INDICATE STXIT AB EXIT       @D64ADOW 00934000
         MVI   EXITFLG2,ABWDUMP   INDICATE NORMAL AB EXIT      @D64ADOW 00935000
         L     RC,TCBATCBE        GET TCBX ADDR                @D64ADOW 00936000
         USING TCBXADR,RC                                      @D64ADOW 00937000
         L     RF,TCBX1CRF        GET CURRENT LINK STACK ENTRY @D61PDOW 00938000
         ST    RF,EXABLSTK        ... TO EXIT BLOCK - LINKAGE  @D64ADOW 00939000
***                               STACK IS EMPTY IN THIS MOMENT         00940000
         MVC   EXABPKM(4),TCBX1CR3 SAVE CURRENT PKM AND SASN   @D64ADOW 00941000
         MVC   EXABEAX(2),TCBX1CR8 SAVE CURRENT EAX            @D64ADOW 00942000
         MVC   EXABPASN(2),TCBX1CR4+2 SAVE CURRENT PASN        @D64ADOW 00943000
         DROP  RC                                              @D64ADOW 00944000
         LTR   R4,R4              PARAMETER LIST SPECIFIED     @D61NDOW 00945000
         BNZ   SVC37L83           YES, --->                    @D64ADOW 00946000
SVC37L81 DS    0H                                              @D64ADOW 00947000
         TM    TCBEXITH,TCBESTSV  ESTAE-ENVIRONMENT SUSPENDED  @D65CDOW         
         BO    EXIT               YES, DON'T USE AT ATTACH     @D65CDOW         
         OI    TCBEXITG,TCBABSPC  AB-EXIT FOR ATTACH AVAILABLE @D64ADOW 00948000
         TM    EXITFLG,EXITANY    EXIT WITH AMODE 31           @D64ADOW 00949000
         BNO   EXIT               NO --->                      @D64ADOW 00950000
         OI    TCBEXITG,TCBABS31                               @D64ADOW 00951000
         B     EXIT               NO, EXIT TO DISPATCHER       @D61NDOW 00952000
SVC37L83 DS    0H                                              @D64ADOW 00953000
         TM    0(R4),MSGONLY      TERMINATION MSG TO BE PRINTED@D61NDOW 00954000
         BNO   SVC37L85           NO,                          @D61NDOW 00955000
         MVI   EXITFLG2,PRTMSG                                 @D64ADMK 00956000
         B     SVC37L81                                        @D61NDOW 00957000
SVC37L85 DS    0H                                              @D61NDOW 00958000
         TM    0(R4),NODUMP       IS 'NODUMP' REQUIRED         @D61NDOW 00959000
         BNO   SVC37L90           NO, --->                     @D61NDOW 00960000
         MVI   EXITFLG2,SKIPMSG   TURN ON SKIPMSG INDICATOR    @D64ADMK 00961000
         B     SVC37L81                                        @D61NDOW 00962000
SVC37L90 DS    0H                                              @D61NDOW 00963000
         TM    0(R4),EARLY        IS EARLY ABEND EXIT TO BE SET@D61NDOW 00964000
         BNO   SVC37L81           NO, 'DUMP IS REQUIRED        @D64ADOW 00965000
         MVI   EXITFLG2,EARLYAB   EARLY ABEND INDICATOR        @D64ADOW 00966000
         SLR   RF,RF              SET RET.CODE (SUCCESS)       @D61NDOW 00967000
SVC37RET ST    RF,SVER0F          STORE RETURN CODE            @D14CDIS 01043000
         B     EXIT               EXIT TO DISPATCHER           @D61NDOW 01044000
         SPACE 2                                                        00969000
SVC37VLS DS    0H                                              @D51HDOW 00970000
         LR    R4,R1              COPY PARAMETER LIST ADDR     @D51HDOW 00971000
         LA    R2,15(,R1)         LAST BYTE OF PARAMETER LIST  @D51HDOW 00972000
         BAS   R8,VALIDSVA        VALIDATE PARAMETER LIST      @D37CDFR 00973000
*SGLINK  VALIDSVA,INPUT=(R1,R2,R6,R8),WORK=(R2,R5)             @D37CDFR 00974000
         TM    0(R4),X80          NEW PARAMETER LIST FORMAT    @D51HDOW 00975000
         BO    SVC37V20           YES,                         @D52VDOW 00976000
.*                                OLD LIST FORMAT ONLY IN 24 BIT MODE   00977000
         TM    TCBEXFLG,TCBEXAM   CALLER IN 31 BIT MODE        @D52VDOW 00978000
         BO    ERR45              YES, CANCEL                  @D52VDOW 00979000
         L     R8,0(,R4)          LOAD ENTRY POINTER           @D52VDOW 00980000
         L     R1,4(,R4)          LOAD SAVEAREA POINTER        @D52VDOW 00981000
         B     SVC37V40                                        @D52VDOW 00982000
SVC37V20 DS    0H                                                       00983000
         L     R8,4(,R4)          LOAD ENTRY POINTER           @D52VDOW 00984000
         L     R1,8(,R4)          LOAD SAVEAREA POINTER        @D51HDOW 00985000
SVC37V40 LA    R0,0(,R8)          CLEAR FIRST BYTE/BIT         @KD40113 00986000
.***                 NOTE : EXIT ADDR 0 IS ALSO RESET                   00987000
         LA    R1,0(,R1)          CLEAR FIRST BIT/BYTE         @D52VDOW 00988000
         TM    TCBEXFLG,TCBEXAM   CALLER IN 31 BIT MODE        @DX41420 00989000
         BNO   SVC37L10           NO , -->                     @D64ADOW 00990000
         TM    0(R4),X03          AMODE=ANY SPECIFIED          @KD40113 00991000
.*                                01 AND 02 REPRESENT AMODE=ANY         00992000
.*                                00 AND 03 REPRESENT AMODE=24          00993000
.*                                          I.E. SMALL SAVE AREA USED   00994000
         BNM   ERR45              NO, CANCEL                   @KD40113 00995000
         B     SVC37L10           RETURN                       @D64ADOW 00996000
         SPACE 2                                                        00997000
SVC37SUS DS    0H                                              @D14BDFR 00998000
         TM    0(R4),EARLY        IS EARLY ABEND EXIT TO BE SET@D51HDOW 00999000
         BNOR  R9                 NO, --->                     @D61NDOW 01000000
         TM    TCBEXITH,TCBESTSV  ESTAE-ENVIRONMENT SUSPENDED  @D65CDOW         
         BO    SVC37ER5           YES, CANCEL                  @D65CDOW         
         CLI   TCBAUTHF,ZERO      IS IT A SUBSYST.TASK REQUEST @D14BDFR 01001000
         BNZR  R9                 YES, GOTO PROCESS IT         @D64ADOW 01002000
         L     RF,PCBPTR          POINT TO PCB                 @D14BDFR 01003000
         USING PCBADR,RF                                       @D14BDFR 01004000
         TM    PCBSSFLG,XFF       REQ. FROM OTHER SUBSYSTEM    @D52VDOW 01005000
         BNZR  R9                 YES, OK                      @D64ADOW 01006000
         DROP  RF                                              @D14BDFR 01007000
         LA    RF,12              SET ERROR RET.CODE(NO SUBSYS)@D14CDIS 01008000
         B     SVC37RET           NO, SETUP RETURN CODE        @D14CDIS 01009000
         SPACE 2                                                        01010000
SVC37RES DS    0H                 REQUEST RESET (R0 = 0)       @D51HDOW 01011000
         LTR   R7,R7              ANY EXIT BLOCK DEFINED       @D64ADOW 01012000
         BZ    EXIT               NO --->                      @D64ADOW 01013000
         CLI   EXITFLG2,EXESTAEX  ESTAEX ALREADY DEFINED       @D64ADOW 01014000
         BE    SVC37ER1           YES, STXIT AB NOT ALLOWED    @D64ADOW 01015000
         CLI   EXITFLG2,EARLYAB   IS THIS AN EARLY AB EXIT BLK @D64ADOW 01016000
         BNE   SVC37R10           NO, PROCESS                  @D64ADOW 01017000
         LA    RF,8               SET ERROR RET.CODE (RESET)   @D14CDIS 01018000
         ICM   R7,15,EXITNEXT     GET SECONDARY AB-EXIT        @D64ADOW 01019000
         BZ    SVC37RET           NO RESET FOR EARLY AB ALLOWED@D61NDOW 01020000
SVC37R10 DS    0H                                              @D64ADOW 01021000
         L     RF,TCBATCBE        GET ADDR OF TCB EXTENSION    @D61NDOW 01022000
         USING TCBXADR,RF                                      @D61NDOW 01023000
         L     R2,TCBX1CRF        GET CURRENT LINK STACK ENTRY @D61PDOW 01024000
         DROP  RF                                              @D64ADOW 01025000
         USING LSTKEDSC,R2                                     @D64ADOW 01026000
         TM    LSTKET,LSTKHTST    IS IT A HEADER               @D64ADOW 01027000
         BNZ   SVC37ER2           NO, LINKAGE STACK NOT EMPTY  @D64ADOW 01028000
         LA    R8,LSTKEDS1-LSTKHDR DISP TO DESCRIPTOR OF HEADER@D61PDOW 01029000
         SLR   R2,R8                                           @D61PDOW 01030000
         USING LSTKHDR,R2                                      @D64ADOW 01031000
         ICM   R2,15,LSTKBSEA     GET BACKWARD POINTER         @D61PDOW 01032000
         BM    SVC37ER2           AVAILABLE, STACK NOT EMPTY   @D64ADOW 01033000
         DROP  R2                                              @D64ADOW 01034000
         L     RC,ACOMSTXI        GET BASE OF COMMON ROUTINE   @D64ADOW 01035000
***                               R0 = 0 ---> RESET EXIT                01035500
         BASSM R9,RC              BRANCH TO COMMON ROUTINE     @D64ADOW 01036000
*SGLINK COMSTXIT,INPUT=(R0,R1,R4,R5,R7,R9,RA,RC),                      X01037000
               OUTPUT=(R6,RB),WORK=(R2,R5,R8,RF)                        01038000
         NI    TCBEXITG,XFF-TCBABSPC-TCBABS31 NO AB-EXIT       @D64ADOW 01039000
***                               AVAILABLE FOR ATTACH FROM NOW         01040000
         B     EXIT                                            @D64ADOW 01041000
         SPACE 2                                                        01045000
SVC37ER5 DS    0H                                              @D65CDOW 01060000
         L     R1,S37ERR73        CANCEL INFORMATION           @D65CDOW 01061000
         B     SVC37ERR           CANCEL WITH ERR47            @D65CDOW 01062000
         SPACE                                                          01059000
SVC37ER4 DS    0H                                              @D64ADOW 01046000
         L     R1,S37ERR0B        CANCEL INFORMATION           @D64ADOW 01047000
         TM    TCBEXITF,TCBPCACT  PC-EXIT ACTIVE               @D64ADOW 01048000
***                               (STXIT PC OR ESPIE)                   01049000
         BO    SVC37ERR           YES --->                     @D64ADOW 01050000
         L     R1,S37ERR0C        CANCEL INFORMATION           @D64ADOW 01051000
         TM    TCBEXITF,TCBOCACT  OC-EXIT ACTIVE               @D64ADOW 01052000
         BO    SVC37ERR           YES --->                     @D64ADOW 01053000
         L     R1,S37ERR0D        CANCEL INFORMATION           @D64ADOW 01054000
         TM    TCBEXITF,TCBITACT  IT-EXIT ACTIVE               @D64ADOW 01055000
         BO    SVC37ERR           YES --->                     @D64ADOW 01056000
         L     R1,S37ERR0E        POST OR ETXR EXIT ACTIVE     @D64ADOW 01057000
         B     SVC37ERR           CANCEL --->                  @D64ADOW 01058000
         SPACE                                                          01059000
SVC37ER3 DS    0H                                              @D61PDOW 01060000
         L     R1,S37ERR08        CANCEL INFORMATION           @D61NDOW 01061000
         B     SVC37ERR           CANCEL WITH ERR47            @D64ADOW 01062000
         SPACE                                                          01063000
SVC37ER2 DS    0H                                              @D61PDOW 01064000
         L     R1,S37ERR04        CANCEL INFORMATION           @D61NDOW 01065000
         B     SVC37ERR           CANCEL WITH ERR47            @D64ADMK 01066000
         SPACE                                                          01067000
SVC37ER1 DS    0H                                              @D64ADOW 01068000
         L     R1,S37ERR33        GET ADDITIONAL ERROR INFO    @D64ADOW 01069000
         B     SVC37ERR           CANCEL WITH ERR47            @D64ADMK 01070000
         SPACE                                                          01071000
SVC37ER0 DS    0H                                              @D64ADVB 01072000
         ST    RF,SVER0F          GETVIS RETURN CODE TO R15    @D64ADOW 01073000
         L     R1,S37ERR06        GET ADDITIONAL ERROR INFO    @D64ADOW 01074000
*        B     SVC37ERR           CANCEL WITH ERR47            @D64ADMK 01075000
         SPACE                                                          01076000
SVC37ERR DS    0H                                              @D61PDOW 01077000
         L     RC,ACOMEREX        ADDR OF ERROR EXIT           @D64ADOW 01078000
         BSM   0,RC               CANCEL WITH ERR47            @D64ADMK 01079000
         SPACE                                                          01080000
SVC37A05 DC    A(X'80000000'+SVC37L05) AMODE 31 RTN ADDR       @D64ADOW 01081000
SVC37A11 DC    A(X'80000000'+SVC37L20) AMODE 31 RTN ADDR       @D64ADOW 01082000
         SPACE                                                          01083000
S37ERR04 DC    A(NUCRSN04)        STXIT MACRO ISSUED AND       @D64ADOW 01084000
*                                 ... LINKAGE STACK NOT EMPTY           01085000
S37ERR06 DC    A(NUCRSN06)        SGETVIS FOR EXIT BLOCK NOT   @D64ADOW 01086000
*                                 ... SUCCESSFULL, RETURN CODE          01087000
*                                 ... PASSED TO CALLER IN REG 15        01088000
S37ERR08 DC    A(NUCRSN08)        STXIT AB NOT ALLOWED BECAUSE @D64ADOW 01089000
*                                 ... AB-TYPE EXIT ACTIVE               01090000
S37ERR0B DC    A(NUCRSN0B)        STXIT AB NOT ALLOWED BECAUSE @D64ADOW 01091000
*                                 ... PC-TYPE EXIT ACTIVE               01092000
S37ERR0C DC    A(NUCRSN0C)        STXIT AB NOT ALLOWED BECAUSE @D64ADOW 01093000
*                                 ... OC-TYPE EXIT ACTIVE               01094000
S37ERR0D DC    A(NUCRSN0D)        STXIT AB NOT ALLOWED BECAUSE @D64ADOW 01095000
*                                 ... IT-TYPE EXIT ACTIVE               01096000
S37ERR0E DC    A(NUCRSN0E)        STXIT AB NOT ALLOWED BECAUSE @D64ADOW 01097000
*                                 ... POST OR ETXR EXIT ACTIVE          01098000
S37ERR33 DC    A(NUCRSN33)        STXIT MACRO REJECTED BECAUSE @D64ADOW 01099000
*                                 ... ALREADY ESTAEX USED               01100000
S37ERR73 DC    A(NUCRSN73)        STXIT MACRO REJECTED BECAUSE @D65CDOW 01099000
*                                 ... ESTAE-ENVIRONMENT SUSPENDED       01100000
         DROP  R6                                              @D64ADMK 01101000
         DROP  R7                                              @D64ADMK 01102000
         DROP  RA                                              @D64ADMK 01103000
         DROP  RB                                              @D64ADMK 01104000
         DROP  RD                                              @D64ADOW 01105000
         EJECT                                                          01106000
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *  @D35EDJO 01107000
*                                                              @D35EDJO 01108000
*   SVC 95:  EXIT AB.                                          @D35EDJO 01109000
*            RETURN FROM ABNORMAL TERMINATION ROUTINE.                  01110000
*                                                              @D35EDJO 01111000
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *  @D35EDJO 01112000
         SPACE 1                                                        01113000
         USING DISP,R6                                         @D64ADOW 01114000
         USING TCBADR,RA                                       @D64ADOW 01115000
         USING SGEXIT,RD                                       @D64ADOW 01116000
SVC95    DS    0H                                              @D51IDOW 01117000
         L     R5,PCBPTR           POINTER TO PCB              @D36GDOW 01118000
         USING PCBADR,R5                                       @D36GDOW 01119000
         CLC   TID,IJBHMTID        IS IT MAINTASK?             @D51IDOW 01120000
         BNH   SVC95L20            YES, SKIP MT-STATUS CHECK ->@D36GDOW 01121000
         ICM   R7,B'1111',TCBLECAV IS LE PROCESSING            @D65CDOW         
         BNZ   SVC95L20            YES, RELY ON LE             @D65CDOW 01125490
         TM    TCBAUTHF,TCBVEND    IS REQUESTOR A VENDOR       @D64ADOW 01122000
         BO    SVC95L10            YES, PERFORM MT STATUS CHECK@D64ADOW 01123000
         TM    PCBSSFLG,CICS+PWR   IS IT CICS OR POWER         @D65CDOW 01124000
         BZ    ERR21               NO , NOT ALLOWED            @D65CDMZ 01125490
SVC95L10 DS    0H                  CHECK MT STATUS <===        @D64ADOW 01126000
         L     R7,PIBPTR2                                      @D51IDOW 01127000
         USING PIB2ADR,R7                                      @D51IDOW 01128000
         LH    R7,PIBMTID          GET MAINTAK ID              @D52VDOW 01129000
         DROP  R7                                              @D36GDOW 01130000
         SLL   R7,2                GET                         @D66ODOW         
         AL    R7,ATIBATAB         ...TIB                      @D66ODOW         
         L     R7,0(,R7)           ... OF MAINTASK             @D66ODOW         
         USING TIBADR,R7                                       @D36GDOW 01133990
         TM    TIBCNCL,XFF         IS RELATED MAINTASK EITHER  @D52VDOW 01134980
***                                IN NORMAL PROCESSING (TIBCNCL = 00)  01135970
***                                OR IN AB-TYPE EXIT (TIBCNCL = FF)    01136960
***                                THIS CHECK AVOIDS THAT A SUBTASK     01137950
***                                RECOVERS ALTHOUGH MAINTASK WANTS     01138940
***                                TERMINATION                          01139930
         BM    ERR21                                           @D52VDOW 01140920
         DROP  R7                                              @D36GDOW 01144990
SVC95L20 DS    0H                                              @D64ADOW 01145980
         TM    TCBEXIFL,TCBSTXIT   AB-EXIT CURRENTLY ACTIVE    @D64ADOW 01146970
         BZ    ERR21               NO --->                     @D64ADOW 01148000
         L     R4,SVC95A30         GET CONTINUATION ADDR       @D64ADOW 01149000
         BSM   0,R4                GOTO 31 BIT MODE            @D64ADVB 01150000
SVC95L30 DS    0H                                              @D64ADOW 01151000
         L     R7,TCBABEX          GET EXIT BLK ADDR           @D64ADOW 01151300
         USING EXITBLK,R7                                      @D64ADMK 01151600
         NI    TCBABEX,XFF-EXITACT RESET EXIT ACTIVE BIT       @D64ADMK 01152000
         NI    EXITADR,XFF-EXITACT RESET EXITACT IN EXIT CB    @D61NDOW 01153000
         MVC   TCBEXITF,EXITSACT   RESTORE STACKED EXIT        @D61NDOW 01154000
         MVI   EXITSACT,X00        ... AND CLEAR INDICATOR     @D64ADOW 01155000
         CLC   TID,IJBHMTID        IS IT MAINTASK?             @D65CDOW 01120000
         BH    SVC95L40            NO,                         @D65CDOW 01121000
         NI    PCBFLAG1,XFF-OPCANCLD INITIALIZE INDICATOR      @D65CDOW 04160000
SVC95L40 DS    0H                                              @D64ADOW 01157000
         DROP  R5                                              @D65CDOW 01143000
         TM    TCBEXITF,TCBPOACT+TCBEXACT ANY POST|ETXR EXIT AC@D64ADOW 01158000
         BNZ   SVC95ER1            YES, --->                   @D64ADOW 01159000
         CLI   TCBEXITF,X00        ANY IT|OC|PC EXIT ACTIVE    @D64ADOW 01160000
         BE    SVC95L50            NO, CONTINUE                @D64ADOW 01161000
         BAS   RE,SVC95DEA         DEACTIVATE STACKED EXIT     @D64ADOW 01162000
*SGLINK SVC95DEA,INPUT=(RA,RD,RE)                                       01163000
         B     SVC95L40                                        @D64ADOW 01166000
SVC95L50 DS    0H                                              @D64ADOW 01167000
         MVI   TCBEXIFL,X00        RESET TERMINATOR IF-FLAG    @D64ADOW 01168000
         NI    TCBEXITG,TCBABSPC+TCBABS31 KEEP AB EXIT         @D64ADOW 01169000
***                                ... DEFINED INDICATOR                01170000
         L     R8,TCBATCBE                                     @D64ADOW 01171000
         USING TCBXADR,R8                                      @D64ADOW 01172000
         XC    PTCBEACT,PTCBEACT   NO AB-TYPE EXIT ACTIVE      @D64ADOW 01173000
         XC    PTCBEXSA,PTCBEXSA   ...                         @D64ADOW 01174000
         XC    PTCBEXFA,PTCBEXFA   ...                         @D64ADOW 01175000
         MVC   TCBX1CR3(4),EXABPKM PKM AND SASN FROM EXIT DEF  @DY46135 02299000
         MVC   TCBX1CR8(2),EXABEAX ALSO EAX                    @DY46135 02300000
         MVC   TCBX1CR4+2(2),EXABPASN AND PASN                 @DY46135 02301000
         DROP  R7                                              @DY46135 01156000
         TM    TCBXFLG1,TCBXGETF  GETFLD FIELD=ALET PERFORMED  @DY46135         
         BNO   SVC95L60           NO, --->                     @DY46135         
         MVC   TCBX1CR8(2),CSYSEAX SETUP EAX IN SAVE AREA      @DY46135         
SVC95L60 DS    0H                                              @DY46135 03705000
         DROP  R8                                              @D61NDOW 01176000
         L     R8,TIBPTR           GET TIB POINTER             @D64ADOW 01177000
         USING TIBADR,R8                                       @D36GDOW 01178000
         MVI   TIBCNCL,ZERO        RESET CANCEL CODE           @D36ZDOW 01179000
         SPACE                                                          01180000
         STM   R0,RF,SVCWORK       SAVE REGISTER               @D61PDOW 01181000
         L     RC,ASVASVDL         PTR TO SVA ROUT.ADDR.TABLE  @D61PDOW 01182000
         L     RC,AIJBLSTK-SVASVDL(,RC) GET ROUTINE ADDR       @D61PDOW 01183000
         LA    RF,4                SET UP FUNCTION CODE        @D61PDOW 01184000
         BASSM RE,RC               RELEASE RECOVERY LINK STACK @D64ADOW 01185000
***                                AND GIVE TASK EMPTY LINKAGE STACK    01186000
*SGLINK $IJBLSTK,INPUT=(R8:TIB_ADDR,RA:TCB_ADDR,RE:RETURN ADDR,        X01187000
               RC:$IJBLSTK_ENTRY_ADDR,RF:FCT_CODE)                      01188000
         LM    R0,RF,SVCWORK       RESTORE REGISTER            @D61PDOW 01189000
         SPACE                                                          01190000
         SLR   RF,RF               SELECT FUNCTION             @D64ADOW 01191000
         L     RC,ACHKDLAY         RESCHEDULE DELAYED VTAM     @D64ADOW 01192000
         BASSM RE,RC               ... AND/OR TIMER EXITS      @D64ADOW 01193000
*SGLINK CHKDELAY,INPUT=(R8,RC,RE,RF),WORK=(R4)                          01194000
         B     EXIT                EXIT TO DISPATCHER          @D61NDOW 01195000
         DROP  R8                                              @D52VDOW 01196000
         SPACE 3                                                        01197000
SVC95DEA DS    0H                                              @D64ADOW 01198000
*SGLINK SVC95DEA,S,INPUT=(RA,RD,RE)                                     01199000
*** TCBEXITF INDICATES EXIT TO BE HANDLED AND CONTAINS NEXT STACKED     01200000
*** EXIT AT RETURN                                                      01201000
         STM   R0,RF,SVCWORK       SAVE REGISTER               @D64ADOW 01202000
         CLI   TCBEXITF,TCBPCACT   PC-TYPE EXIT ACTIVE         @D64ADOW 01203000
         BE    SVC95D70            YES,                        @D64ADOW 01204000
         CLI   TCBEXITF,TCBOCACT   OC-TYPE EXIT ACTIVE         @D64ADOW 01205000
         BE    SVC95D50            YES,                        @D64ADOW 01206000
***                                NO, HANDLING TIMER EXIT              01207000
         L     RC,TCBATCBE         GET TCBX ADDR               @D64ADOW 01208000
         USING TCBXADR,RC                                      @D64ADOW 01209000
         L     R7,TCBXTQCA         GET ACTIVE TIQE             @D64ADOW 01210000
         XC    TCBXTQCA,TCBXTQCA   CLEAR PTR TO ACTIVE TIQE    @D64ADOW 01211000
         USING EXITBLK,R7                                      @D64ADOW 01212000
         MVC   TCBEXITF,EXITSACT   RESTORE STACKED EXIT        @D64ADOW 01213000
         MVI   EXITSACT,X00        ... AND CLEAR               @D64ADOW 01214000
         NI    EXITADR,XFF-EXITACT EXIT IS NOT ACTIVE ANYMORE  @D64ADOW 01215000
         CLI   TIQTYPE,TIQVSE      VSE TIQE                    @D64ADOW 01216000
         BE    SVC95D40                                        @D64ADOW 01217000
         L     R9,TCBXTASI        HANDLING                     @D64ADOW 01218000
         LA    R9,0(,R9)          ... STIMERM                  @D64ADOW 01219000
         CR    R7,R9              ... REQUEST                  @D64ADOW 01220000
         BNE   SVC95D10           YES, --->                    @D64ADOW 01221000
         OC    TIQOUTT,TIQOUTT    ALREADY NEW TIMER EXIT DEFINE@D64ADOW 01222000
         BNZ   SVC95D20           YES,                         @D64ADOW 01223000
SVC95D10 DS    0H                 RESET STIMERM TIQE           @D64ADOW 01224000
         L     RD,ASGTIMX         GET BASE OF SGTIMERX         @D64ADOW 01225000
         USING SGTIMERX,RD                                     @D64ADOW 01226000
         BAS   R9,DEQTIQE         DEQ STIMER/STIMERM EXIT FROM @D64ADOW 01227000
***                               TCBX (TCBXTASI,TCBXTAMU)              01228000
*SGLINK DEQTIQE,INPUT=(R7,R9,RA,RC,RD),WORK=(R0,R1,R2,RF)               01229000
         L     RD,ASGEXIT         RELOAD BASE                  @D64ADOW 01230000
         USING SGEXIT,RD                                       @D64ADOW 01231000
SVC95D20 DS    0H                                              @D64ADOW 01232000
         L     RD,ASGTIMX         GET BASE OF SGTIMERX         @D64ADOW 01233000
         USING SGTIMERX,RD                                     @D64ADOW 01234000
         BAS   R9,FNDTILOW        FIND TIQE WITH LOWEST EXP TIM@D64ADOW 01235000
*SGLINK FNDTILOW,INPUT=(R9,RA,RD),OUTPUT=(R7)                           01236000
         L     RD,ASGEXIT         RELOAD BASE                  @D64ADOW 01237000
         USING SGEXIT,RD                                       @D64ADOW 01238000
         LTR   R7,R7              ANY TIQE FOUND               @D64ADOW 01239000
         BZ    SVC95D90           NO, --->                     @D64ADOW 01240000
         L     RD,ASGTIMX         GET BASE OF SGTIMERX         @D64ADOW 01241000
         USING SGTIMERX,RD                                     @D64ADOW 01242000
         BAS   R9,ENQTICHN        ENQ TASK INTO TIMER CHAIN    @D64ADOW 01243000
*SGLINK ENQTICHN,INPUT=(R7,R9,RA,RD)                                    01244000
         L     RD,ASGEXIT         RELOAD BASE                  @D64ADOW 01245000
         USING SGEXIT,RD                                       @D64ADOW 01246000
         B     SVC95D90                                        @D64ADOW 01247000
SVC95D40 DS    0H                                              @D64ADOW 01248000
         ICM   R0,B'1111',EXITADR  EXIT DELETED IN MEANTIME    @D64ADOW 01249000
         BNZ   SVC95D90            NO, ALL DONE                @D64ADOW 01250000
         B     SVC95D80                                        @D64ADOW 01251000
         DROP  R7                                              @D64ADOW 01252000
         DROP  RC                                              @D64ADOW 01253000
SVC95D50 DS    0H                                              @D64ADOW 01254000
         L     R5,PCBPTR           GET PCB POINTER             @D64ADOW 01255000
         USING PCBADR,R5                                       @D64ADOW 01256000
         L     R7,PCBOCPTR                                     @D64ADOW 01257000
         USING EXITBLK,R7                                      @D64ADOW 01258000
         MVC   TCBEXITF,EXITSACT   RESTORE STACKED EXIT        @D64ADOW 01259000
         MVI   EXITSACT,X00        ... AND CLEAR INDICATOR     @D64ADOW 01260000
         NI    EXITADR,XFF-EXITACT EXIT IS NOT ACTIVE ANYMORE  @D64ADOW 01261000
         BAS   R3,OCCL2ND          FREEVIS FOR MSGPARM AREA?   @D64ADOW 01262000
*SGLINK  OCCL2ND,INPUT=(R3,RD),WORK=(R0,R1,R2,R4,RF),OUTPUT=(R2,R4)     01263000
         ICM   R0,B'1111',EXITADR  EXIT DELETED IN MEANTIME    @D64ADOW 01264000
         BNZ   SVC95D90            NO, ALL DONE                @D64ADOW 01265000
         B     SVC95D80                                        @D64ADOW 01266000
         DROP  R5                                              @D64ADOW 01267000
         DROP  R7                                              @D64ADOW 01268000
SVC95D70 DS    0H                                              @D64ADOW 01269000
         L     R7,TCBPCEX          CURRENT PC-EXIT CB ADDR     @D64ADOW 01270000
         USING EXITBLK,R7                                      @D64ADOW 01271000
         MVC   TCBEXITF,EXITSACT   RESTORE STACKED EXIT        @D64ADOW 01272000
         MVI   EXITSACT,X00        ... AND CLEAR INDICATOR     @D64ADOW 01273000
         NI    EXITADR,XFF-EXITACT EXIT IS NOT ACTIVE ANYMORE  @D64ADOW 01274000
         ICM   R0,B'1111',EXITADR  EXIT DELETED IN MEANTIME    @D64ADOW 01275000
         BNZ   SVC95D90            NO, PROCESSING COMPLETE     @D64ADOW 01276000
         CLI   EXITFLG2,EXESPIE    ESPIE EXIT                  @D64ADOW 01277000
         BNE   SVC95D80            NO, --->                    @D64ADOW 01278000
         SPACE                                                          01279000
         LA    R0,EPIEEND-EPIE     LENGTH OF EPIE              @D64ADOW 01280000
         L     R1,EXITSAV          GET EPIE ADDR               @D64ADOW 01281000
         LA    RF,20               SETUP FUNCTION CODE FREEMAIN@D64XDOW 01282000
         L     RC,AEXITGVI         GET SUBRTN ADDR             @D64XDOW 01283000
         BASSM R8,RC               FREE EPIE                   @D64XDOW 01284000
*SGLINK  EXITFVIS,INPUT=(R0,R1,R8,RA,RC,RF),OUTPUT=RF,WORK=R0           01285000
         SPACE                                                          01286000
         LH    R0,EXITLENG         GET LENGTH OF CONTROL BLOCK @D64ADOW 01287000
         L     R3,EXITNEXT         DEQUEUE EXIT CB             @D64ADOW 01288000
         ST    R3,TCBPCEX          ...                         @D64ADOW 01289000
         DROP  R7                                              @D64ADOW 01290000
*** FREEVIS FOR ESPIE CONTROL BLOCK                                     01291000
*        SFREEVIS ADDRESS=(R7),LENGTH=(0)                               01292000
         SFREEVIS ADDRESS=(R7),LENGTH=(0)                      @D64ADOW 01293000
***END OF SFREEVIS MACRO                                                01294000
         B     SVC95D90                                        @D64ADOW 01295000
SVC95D80 DS    0H                                              @D64ADOW 01296000
         SLR   R0,R0               INDICATE RESET              @D64ADOW 01297000
         L     RC,ACOMSTXI         GET BASE OF COMMON ROUTINE  @D64ADOW 01298000
         BASSM R9,RC               BRANCH TO COMMON ROUTINE    @D64ADOW 01299000
*SGLINK COMSTXIT,INPUT=(R0,R1,R4,R5,R7,R9,RA,RC),                      X01300000
               OUTPUT=(R6,RB),WORK=(R2,R5,R8,RF)                        01301000
SVC95D90 DS    0H                                              @D64ADOW 01302000
         LM    R0,RF,SVCWORK       RESTORE REGISTER            @D64ADOW 01303000
         BR    RE                  RETURN                      @D64ADOW 01304000
         SPACE                                                          01305000
SVC95ER1 DS    0H                                              @D61PDOW 01310000
         L     R1,S95ERR01        CANCEL INFORMATION           @D61NDOW 01311000
SVC95ERR L     RC,ACOMEREX        ADDR OF ERROR EXIT           @D64ADOW 01312000
         BSM   0,RC               CANCEL WITH ERR47            @D64ADMK 01313000
         SPACE                                                          01314000
S95ERR01 DC    A(NUCRSN50)        EXIT AB NOT ALLOWED WHEN     @D64ADOW 01315000
*                                 ... POST OR ETXR EXIT ACTIVE          01316000
         SPACE                                                          01319000
         DROP  R6                                              @D64ADOW 01320000
         DROP  RA                                              @D64ADOW 01321000
         DROP  RD                                              @D33DDJO 01322000
         SPACE                                                          01323000
SVC95A30 DC    A(X'80000000'+SVC95L30) AMODE 31 RTN ADDR       @D64ADOW 01324000
         EJECT                                                          01325000
*********************************************************************** 01326000
*                                                                     * 01327000
*        CHECK IF SPECIFIED PARTITION OPERATES IN TERMINATING         * 01328000
*        SERVER PARTITION                                             * 01329000
*                                                                     * 01330000
*  INPUT  R1  POINTER TO PARAMETER LIST                               * 01331000
*                 H(# OF LX VALUES),H(PIK OF PARTITION TO BE CHECKED) * 01332000
*                 H(LX-1)                                             * 01333000
*                 .                                                   * 01334000
*                 H(LX-N)                                             * 01335000
*         R10 TCB PTR                                                 * 01336000
*         R13 ROUTINE BASE                                            * 01337000
*         R14 RETURN ADDRESS                                          * 01338000
*                                                                     * 01339000
*  ROUTINE IS CALLED WITH BASSM RE,RD                                 * 01340000
*  SVCWORKA IS FREE FOR USE IN SUBROUTINE                             * 01341000
*  NO REGISTER WILL BE DESTROYED                                      * 01342000
*  ADDRESSABILITY BY MEANS OF SUPAVTEX                                * 01343000
*                                                                     * 01344000
*********************************************************************** 01345000
         SPACE 1                                                        01346000
         USING TCBADR,RA                                       @D64XDOW 01347000
         USING XMEMCHK,RD                                      @D64XDOW 01348000
XMEMCHK  DS    0H                                              @D64XDOW 01349000
         STM   R0,RF,SVCWORKA     SAVE REGISTER                @D64XDOW 01350000
         LH    R5,2(,R1)          GET PIK OF REQUESTED PARTITIO@D64XDOW 01351000
         SRL   R5,2               GET PCB ADDR OF              @D64XDOW 01352000
         A     R5,APCBATAB        ... OF REQUESTED             @D64XDOW 01353000
         L     R5,0(,R5)          ... PARTITION                @D64XDOW 01354000
         USING PCBADR,R5                                       @D64ADOW 01355000
         SLR   R8,R8              REQUEST HIGHEST PRTY         @D66ODOW 01357000
XMEMC010 DS    0H                                              @D64XDOW 01358000
*        DISPMAC FUNC=TIB,SFUNC=NEXTLOW,INP1=R8,INP2=R5,ERREXIT=XMEMHWT 01359000
         DISPMAC FUNC=TIB,SFUNC=NEXTLOW,ERREXIT=XMEMHWT        @D66ODOW 01360000
         LTR   R8,R8                                           @D66ODOW 01361000
         BZ    XMEMC100                                        @D66ODOW 01362000
         USING TIBADR,R8                                       @D64XDOW 01363000
         TM    TIBFLAG5,TIBXMEMC  ALREADY XMEM CANCEL ONGOING  @D64XDOW 01364000
         BO    XMEMC010           YES, --->                    @D66ODOW 01365000
         L     RC,TIBTCB          TCB OF TASK TO BE CHECKED    @D64XDOW 01367000
         L     RC,TCBATCBE-TCBADR(,RC) ... ITS TCBX ADDR       @D64XDOW 01368000
         USING TCBXADR,RC                                      @D64XDOW 01369000
         L     RC,TCBX1CRF        GET PTR TO ACTUAL LS ENTRY   @D64XDOW 01370000
***                               ...ADDR OF TASK                       01371000
         USING LSTKEDSC,RC                                     @D64XDOW 01372000
XMEMC020 DS    0H                                              @D64XDOW 01373000
         LH    R2,0(,R1)          GET LOOP COUNTER FOR LX-#'S  @D64XDOW 01374000
         LA    R4,2+2(,R1)        ADDR OF FIRST LX-NUMBER      @D64XDOW 01375000
         TM    LSTKET,LSTKHTST    IS THIS A HEADER ENTRY       @D64XDOW 01376000
         BNZ   XMEMC040           NO --->                      @D64XDOW 01377000
         LA    R9,L'LSTKTHDY      LENGTH OF FIRST PART OF HEADE@D64XDOW 01378000
         SLR   RC,R9              BACK TO HEADER               @D64XDOW 01379000
         USING LSTKHDR,RC                                      @D64XDOW 01380000
         ICM   RC,B'1111',LSTKBSEA GET ENTRY DESCRIPTOR OF     @D64XDOW 01381000
***                               ...PREVIOUS STATUS ENTRY              01382000
         BNM   XMEMC010           NOT AVAILABLE I.E LX NUMBER  @D68DDMZ 01383000
***                               ...NOT USED IN THIS TASK --->         01384000
         N     RC,XMEMCMSK        MAKE ADDRESS                 @D64XDOW 01385000
XMEMC040 DS    0H                                              @D64XDOW 01386000
         USING LSTKEDSC,RC                                     @D64XDOW 01387000
         TM    LSTKET,LSTKPENT    IS THIS A PC ENTRY           @D64XDOW 01388000
         BNO   XMEMC300           NO, ---> PREVIOUS LS ENTRY   @D64XDOW 01389000
         LA    R9,LSTATLN1        LENGHT OF STATUS ENTRY W/O   @D64XDOW 01390000
***                               ... ENTRY DESCRIPTOR                  01391000
         LR    R7,RC              COPY ENTRY DESCRIPTOR ADDR   @D64XDOW 01392000
         SLR   R7,R9              BACK TO STATUS ENTRY         @D64XDOW 01393000
         USING LSTKSTAT,R7                                     @D64XDOW 01394000
XMEMC050 DS    0H                                              @D64XDOW 01395000
         CLC   LSTKPCN+1(2),0(R4) IS THIS SPECIFYED LX-#       @D64XDOW 01396000
         DROP  R7                                              @D64XDOW 01397000
         DROP  RC                                              @D64XDOW 01398000
         BNE   XMEMC200                                        @D64XDOW 01399000
***                           ASSUMPTION : NO X-MEMORY SUPPORT FOR      01400000
***                                        SYSTEM TASKS AVAILABLE       01401000
         TM    TIBCNCL,XFF    NORMAL PROCESSING OR AB-EXIT ACTV@D64XDOW 01402000
         BM    XMEMC400       NO (ALREADY CANCEL ONGOING) ---> @D64XDOW 01403000
         MVI   TIBCNCL,CANCX4A    SETUP CANCEL CODE            @D64XDOW 01404000
***                               IN X-MEMORY MODE                      01405000
         L     R9,TIBTCB          GET TCB OF TASK TO BE CNCL'D @D64XDOW 01409000
         NI    TCBRFLAG-TCBADR(R9),XFF-TCBRCVAL NO REASON CODE @D67BDOW         
***                                                                     01406000
***      BUILD ADDITIONAL CANCEL INFO FOR CANCEL CODE 4A                01407000
***                                                                     01408000
         L     RC,TCBATCBE-TCBADR(,R9) ... AND ITS TCBX ADDR   @D64XDOW 01410000
         USING TCBXADR,RC                                      @D64XDOW 01411000
         TM    TCBXSAUS,TCBXXSAU  SAVE AREA USED               @D64XDOW 01412000
         BNO   XMEMC070           NO, TAKE IT                  @D64XDOW 01413000
         BAS   R5,SYSERROR                                     @D64XDOW 01414000
         DC    C'TCBX SAVEAREA NOT FREE'                       @D66ODOW 01415000
XMEMC070 DS    0H                                              @D64XDOW 01416000
         OI    TCBXSAUS,TCBXXSAU  SAVE AREA IS USED            @D64XDOW 01417000
         LA    R7,TCBXXSA         POINT TO ERROR MSG TEXT      @D64XDOW 01418000
         O     R7,BIT0ON          ... INDICATE AREA IN TCBX    @D64XDOW 01419000
         USING MAPDMPIF,R7                                     @D64XDOW 01420000
         XC    CANC4ALN(L'CANC4ALN+L'CANC4AFX),CANC4ALN        @D64XDOW 01421000
         LA    RB,L'CANC4AFX      GET LENGTH OF ADDITIONAL INFO@D64XDOW 01422000
         O     RB,BIT0ON          ... INDICATE AREA IN TCBX    @D64XDOW 01423000
         ST    RB,CANC4ALN        ...                          @D64XDOW 01424000
         L     RB,CRADDR          GET COMREG OF SERVER PART    @D64XDOW 01425000
         USING COMREG,RB                                       @D64ADOW 01426000
         MVC   CANC4AJN,COMNAME   MOVE JOBNAME TO MSG INFO     @D64XDOW 01427000
         DROP  RB                                              @D64XDOW 01428000
         L     RB,PCBPTR          PCB OF SERVER                @D64ADOW 01429000
         MVC   CANC4ALG,PCELID-PCBADR(RB) ... AND PART ID      @D64XDOW 01430000
         ST    R7,TCBDMPIP-TCBADR(,R9) ADDR OF ADD CANCEL INFO @D64XDOW 01431000
         OI    TIBFLAG4,TIBDMPMI  INDICATE ADD CANC INFO AVAILA@D64XDOW 01432000
         DROP  RC                                              @D64XDOW 01433000
XMEMC090 DS    0H                                              @D64XDOW 01434000
         OI    TIBFLAG,FETCHEOJ   REQUEST CANCEL EXIT          @D64XDOW 01435000
         OI    TIBFLAG5,TIBXMEMC  DON'T ALLOW ESTAEX-TYPE EXIT @D64XDOW 01436000
         L     R6,DISPAD          GET DISPATCHER ADDR          @D64XDOW 01437000
         USING DISP,R6                                         @D64XDOW 01438000
         BAS   RF,SETREADY        READY TASK AND FORCE SIGP    @D64XDOW 01439000
***                               IF NECESSARY                          01440000
*SGLINK SETREADY,INPUT=(R6,R8,RF),WORK=RE                               01441000
         B     XMEMC010           PROCESS NEXT TASK            @D66ODOW 01442000
         DROP  R6                                              @D64XDOW 01442000
XMEMC100 DS    0H                                              @D64XDOW 01443000
         LM    R0,RF,SVCWORKA     RESTORE CALLERS REGISTER     @D64XDOW 01447000
         BSM   0,RE               RETURN TO CALLER             @D64XDOW 01448000
         SPACE 3                                                        01449000
XMEMC200 DS    0H                                              @D64XDOW 01450000
         LA    R4,2(,R4)          GOTO NEXT LX                 @D64XDOW 01451000
         BCT   R2,XMEMC050        ---> IF NOT ALL LX PROCESSED @D64XDOW 01452000
XMEMC300 DS    0H                                              @D64XDOW 01453000
         LA    R9,LSTAT                                        @D64XDOW 01454000
         SLR   RC,R9              PREVIOUS ENTRY DESCIPTOR     @D64XDOW 01455000
         B     XMEMC020           ---> CHECK NEXT LS ENTRY     @D64XDOW 01456000
         SPACE 3                                                        01457000
XMEMC400 DS    0H                                              @D64XDOW 01458000
         MVI   TIBCNCL2,CANCX4A   KEEP FIRST CANCEL CODE       @D64XDOW 01459000
         B     XMEMC090           ---> CONT CANCEL PREPARATION @D64XDOW 01460000
         SPACE                                                          01461000
XMEMHWT  DS    0H                                              @D66ODOW 01458000
         BAS   R5,SYSERROR                                     @D66ODOW 01414000
         DC    C'INCONSISTENT CONTROL BLOCK STRUCTURE'         @D66ODOW         
         SPACE                                                          01461000
XMEMCMSK DC    A(LSTKMASK)                                     @D64XDOW 01462000
         DROP  R5                                              @D64XDOW 01463000
         DROP  R8                                              @D64XDOW 01464000
         DROP  RA                                              @D64XDOW 01465000
         DROP  RD                                              @D64XDOW 01466000
         EJECT                                                          01467000
*********************************************************************** 01468000
*                                                                     * 01469000
*        RETURN FROM ESTAEX TYPE EXIT ROUTINE                         * 01470000
*                                                                     * 01471000
*        INPUT:  RF   RETRY/PERCOLATION INDICATOR IF NO SDWA          * 01472000
*                                                                     * 01473000
*********************************************************************** 01474000
         SPACE 1                                                        01475000
ESTFRRRT DS    0H                 RETURN FROM FRR EXIT RTN     @D64ADOW 01476000
.**      ASSUMPTION : FRR IS ALWAYS IN KEY 0                            01477000
         BASR  RF,0               SETUP BASE ADDR              @D64ADOW 01478000
         USING *,RF                                            @D64ADOW 01479000
         L     RE,ESTFRRA1        GOTO 31                      @D64ADOW 01480000
         BSM   0,RE               ... BIT                      @D64ADOW 01481000
ESTFRRL1 DS    0H                 ... MODE                     @D64ADOW 01482000
         DROP  RF                                              @D64ADOW 01483000
         L     RE,TCBPTR                                       @D64ADOW 01484000
         L     RE,TCBATCBE-TCBADR(,RE)                         @D64ADOW 01485000
         NI    TCBXFLG1-TCBXADR(RE),XFF-TCBXFRRA FRR NOT ACTIVE@D64ADOW 01486000
ESTAEXRT DS    0H                 ENTRY FROM ESTAEX-TYPE EXIT  @D64ADOW 01487000
         LR    RE,RF              SAVE RETRY/PERCOLATION INDICA@D64ADOW 01488000
         SLR   RF,RF              SUPPLY CORRECT FCT CODE      @D64ADOW 01489000
         SVC   79                 RETURN FROM ESTAEX TYPE EXIT @D64ADOW 01490000
*                                                                       01491000
ESTFRRA1 DC    A(ESTFRRL1+X'80000000')                         @D64ADOW 01492000
         SPACE 5                                                        01493000
*********************************************************************** 01494000
*                                                                     * 01495000
*        ILLEGAL SVC WHILE FRR DEFINED                                * 01496000
*                                                                     * 01497000
*********************************************************************** 01498000
         SPACE 1                                                        01499000
FRRILSVC DS    0H                                              @D64ADOW 01500000
         LA    R1,D2C5R401        GET ADDITIONAL ERROR INFO    @D64ADOW 01501000
         SLR   R2,R2              NO MACRO NAME                @D64ADOW 01502000
         SLR   R6,R6              INDICATE NO SUB-REASON CODE  @D64ADOW 01503000
         L     RC,ASGEXIT         GET COMMON CANCEL EXIT       @D64ADOW 01504000
         L     RC,ACOMER48-SGEXIT(,RC) ... ADDRESS             @D64ADOW 01505000
         BSM   0,RC               CANCEL WITH ERR48            @D64ADOW 01506000
         EJECT                                                          01507000
*********************************************************************** 01508000
*        AB EXIT CHECK ROUTINE                                        * 01509000
*                                                                     * 01510000
*        INPUT   R6  DISPAD WHEN CALLED FROM SGAP                     * 01511000
*                    ELSE 0                                           * 01512000
*                R8  TIBADR                                           * 01513000
*                R9  RETURN ADR                                       * 01514000
*                RA  TCBADR                                           * 01515000
*                RD  BASE REGISTER                                    * 01516000
*                                                                     * 01517000
*                                                                     * 01518000
**   CALLED IN 31 BIT MODE                                            * 01519000
*********************************************************************** 01520000
         SPACE                                                          01521000
         USING TIBADR,R8                                       @D64ADOW 01522000
         USING TCBADR,RA                                       @D64ADOW 01523000
         USING CHKEXIT,RD                                      @D64ADOW 01524000
CHKEXIT  DS    0H                                              @D64ADMK 01525000
*SGLINK CHKEXIT,S,INPUT=(R6,R8,R9,RA,RD)                                01526000
         STM   R0,RF,SVCWORK      SAVE ALL REGISTER            @D64ADOW 01527000
         L     RC,TCBATCBE        GET ADDR OF TCB-EXTENSION    @D64ADOW 01528000
         USING TCBXADR,RC                                      @D64ADOW 01529000
         OC    PTCBAPTC,PTCBAPTC  FIELD ALREADY INITIALIZED    @D64ADOW 01530000
         BNZ   CHKEX020           YES, --->                    @D64ADOW 01531000
         ST    RC,PTCBAPTC        NO POINT TO TCBX             @D64ADOW 01532000
CHKEX020 DS    0H                                              @D64ADOW 01533000
         L     RC,PTCBAPTC        GET PSEUDO TCB-EXTENSION     @D64ADOW 01534000
         SLR   R7,R7              INIT NO AB-TYPE EXIT CB      @D64ADOW 01535000
         SLR   R9,R9              INIT NO AB-TYPE EXIT ACTIVE  @D64ADOW 01536000
         LTR   R6,R6              TERMINATOR THE REQUESTOR     @D64ADOW 01537000
         BZ    CHKEX060           NO, --->                     @D64ADOW 01538000
         TM    TCBEXIFL,TCBEXABO  AB-EXIT AFTER PERCOLATE      @D64ADOW 01539000
         BO    CHKEXRET           YES, EXIT PREP ALREADY DONE  @D64ADOW 01540000
         TM    TCBEXITH,TCBESTSV  ESTAE-ENVIRONMENT SUSPENDED  @D65CDOW         
         BO    CHKSUSPD           YES, DO SPECIAL PROCESSING   @D65CDOW         
CHKEX022 DS    0H                 RETURN FROM SPEC PROCESSING  @D65CDOW         
         ICM   R7,15,TCBABEX      IS ANY ESTAEX-TYPE EXIT ACTIV@D64ADOW 01541000
         BNM   CHKEX040           NO -->                       @D64ADOW 01542000
         L     R9,PTCBEACT        CB OF EXIT CURRENTLY ACTIVE  @D64ADOW 01543000
         LA    R7,0(,R7)          CLEAR FIRST BIT              @D64ADOW 01544000
         LTR   R7,R7              ESTAEX EXIT DEFINED          @D64ADOW 01545000
         BZ    CHKEX040           NO --->                      @D64ADOW 01546000
         USING EXITBLK,R7                                      @D64ADOW 01547000
         TM    EXITADR,EXITACT    IS 1ST ESTAEX/STXIT ACTIVE   @D64ADOW 01548000
         BNO   CHKEX040           NO --->                      @D64ADOW 01549000
         LA    R8,CHKEX030        LOAD BR-ADDR FOR ESTAEX      @D65CDOW         
         TM    EXITFLG2,EXVSEAB   IS THIS STXIT TYPE           @D64ADOW 01550000
         BZ    CHKEX025           NO --->                      @D65CDOW 01551000
         LA    R8,CHKEXFIN        LOAD BR-ADDR FOR STXIT       @D65CDOW         
***                               ... DO FINAL CANCEL                           
CHKEX025 DS    0H                 ESTAEX CANCELED              @D65CDOW 01555000
         CR    R9,R7              WAS STXIT LAST SELECTED      @D64ADOW 01552000
         BER   R8                 YES, --->                    @D65CDOW 01553000
         B     CHKEX040                                        @D65CDOW 01549000
CHKEX030 DS    0H                 ESTAEX CANCELED              @D65CDOW 01555000
         ICM   RE,B'1111',PSATOLD MVS EMULATION ACTIVE         @D65CDOW 01567000
         BZ    CHKEX040           NO,                          @D65CDOW 01568000
         LA    RE,EXABMSCB        ADDR OF MVS-SCB              @D65CDOW 01568000
         USING SCB,RE                                          @D65CDOW 01568000
         OI    SCBFLGS2,SCBINUSE  SETON INDICATOR              @D65CDOW 01568000
         DROP  RE                                              @D65CDOW 01568000
***                                                                     01554000
CHKEX040 DS    0H                                              @D64ADOW 01555000
         MVI   PTCBEXFL,X00       INITIALIZE INTERFACE         @D64ADOW 01556000
         XC    PTCBESEL,PTCBESEL  ... AREAS                    @D64ADOW 01557000
         L     RF,TCBATCBE        GET CURRENT LINK STCK        @D64ADOW 01557300
         L     RF,TCBX1CRF-TCBXADR(,RF) ... ENTRY ADDRESS      @D64ADOW 01557600
         L     RC,ASGEXIT         GET ADDR OF                  @D64ADOW 01558000
         L     RC,ACURLSTK-SGEXIT(,RC) ... SUBROUTINE          @D64ADOW 01559000
         BASSM R8,RC              CHECK FOR CURR LINK STACK LEV@D64ADOW 01560000
*SGLINK CCURLSTK,INPUT=(R8,RA,RC,RF),OUTPUT=RC                          01561490
         L     R8,TIBPTR          RELOAD TIB POINTER           @D64ADOW 01562000
         LR    RE,RC              SAVE LINK STACK ADDR         @D64ADOW 01563000
         L     RC,TCBATCBE        RELOAD                       @D64ADOW 01564000
         L     RC,PTCBAPTC        ... PSEUDO TCB-EXTENSION     @D64ADOW 01565000
         ST    RE,PTCBEXSL        SAVE LINK STACK ADDR IN TCBX @D64ADOW 01566000
         ICM   RE,B'1111',PSATOLD MVS EMULATION ACTIVE         @D64ADOW 01567000
         BZ    CHKEX050           NO,                          @D64ADOW 01568000
         L     RE,TCBRBP-TCB(,RE) GET CURRENT RB/SVRB          @D64ADOW 01569000
CHKEX050 DS    0H                                              @D64ADOW 01570000
         ST    RE,PTCBEXRL        SAVE RB ADDR IN TCBX         @D64ADOW 01571000
CHKEX060 DS    0H                                              @D64ADOW 01572000
         MVI   TCBEXIFL,X00       INITIALIZE FLAG BYTE         @D64ADOW 01573000
         ICM   R1,15,TCBFREX      GET FRR CHAIN                @D64ADOW 01574000
         BZ    CHKEX080           NO FRR STACK --->            @D64ADOW 01575000
         USING FRRS,R1                                         @D64ADOW 01576000
         L     R7,FRRSCURR        GET ADDR OF FRR STACK ENTRY  @D64ADOW 01577000
         C     R7,FRRSEMP         IS FRR STACK EMPTY           @D64ADOW 01578000
         DROP  R1                                              @D64ADOW 01579000
         BNE   CHKSETFR           BRANCH IF FRR AVAILABLE      @D64ADOW 01580000
CHKEX080 DS    0H                                              @D64ADOW 01581000
         L     R7,TCBABEX         GET FIRST ESTAEX TYPE EXIT   @D64ADOW 01582000
         LA    R7,0(,R7)                                       @D64ADOW 01583000
         LTR   R7,R7                                           @D64ADOW 01584000
         BZ    CHKEX140           NO ESTAE-TYPE CHECK FOR ARR  @D64ADOW 01585000
***                               OR FESTAE                             01586000
         USING EXITBLK,R7                                      @D64ADOW 01587000
         CLI   EXITFLG2,EXESTAEX  IS THIS AN ESTAEX EXIT       @D64ADOW 01588000
         BNE   CHKEX140           NO, ITS AN AB-TYPE           @D64ADOW 01589000
         CLC   PTCBEXSL,EXABLSTK  ESTAEX DEFINED AT CURRENT    @D64ADOW 01590000
***                               LINKAGE STACK LEVEL                   01591000
         BE    CHKEX100           YES, --->                    @D64ADOW 01592000
         L     R9,PTCBEXSL        GET LINK STACK ENTRY         @D64ADOW 01593000
         USING LSTKEDSC,R9                                     @D64ADOW 01594000
         TM    LSTKET,LSTKHTST    IS THIS A HEADER ENTRY       @D64ADOW 01595000
         BNZ   CHKEX140                                        @D64ADOW 01596000
         L     R9,EXABLSTK        GET LINK STACK AT ESTAEX DEF @D64ADOW 01597000
         TM    LSTKET,LSTKHTST    IS THIS A HEADER ENTRY       @D64ADOW 01598000
         DROP  R9                                              @D64ADOW 01599000
         BNZ   CHKEX140           NO,  CHECK FOR FESTAE/ARR    @D64ADOW 01600000
CHKEX100 DS    0H                                              @D64ADOW 01601000
         ICM   RE,B'1111',PSATOLD MVS EMULATION ACTIVE         @D64ADOW 01602000
         BZ    CHKSETES           NO, SETUP ESTAEX             @D64ADOW 01603000
         SLR   R4,R4                                           @D64ADOW 01604000
         ICM   R4,7,TCBSTABB-TCB(RE) GET FIRST SCB IN CHAIN    @D64ADOW 01605000
CHKEX111 BZ    CHKSETESX          MVS CHAIN EMPTY, TAKE ESTAEX @D66XXOW         
.**                  THIS IS A SYTEM ERROR EITHER IN CICS OR VSE                
.**                  NEVERTHELESS WE TRY TO CONTINUE PROCESSING                 
         CLC   0(1,R4),SCBXPTR+3-SCB(R4) FORCE PROG CHK IF INV @D66XXOW         
PCKFAPI1 DS    0H                    PROG CHK ADDR FOR SGPCK   @D66XXOW         
         TM    SCBFLGS3-SCB(R4),SCBBRNTR IS THIS A FESTAE      @D64ADOW 01606000
         BO    CHKSETFE           YES, SET UP FESTAE           @D64ADOW 01607000
         B     CHKSETES           SET UP ESTAEX                @D64ADOW 01608000
         DROP  R7                                              @D64ADOW 01609000
CHKEX140 DS    0H                                              @D64ADOW 01610000
         ICM   RE,B'1111',PSATOLD GET MVS TCB ADDR             @D64ADOW 01611000
         BZ    CHKEX180           NOT AVAILABLE --->           @D64ADOW 01612000
         SLR   R4,R4                                           @D64ADOW 01613000
         ICM   R4,7,TCBSTABB-TCB(RE) FIRST MVS-SCB IN CHAIN    @D64ADOW 01614000
         BZ    CHKEX180           NO FESTAE DEFINED            @D64ADOW 01615000
         CLC   0(1,R4),SCBXPTR+3-SCB(R4) FORCE PROG CHK IF INV @D66XXOW         
PCKFAPI2 DS    0H                    PROG CHK ADDR FOR SGPCK   @D66XXOW         
         USING SCB,R4                                          @D64ADOW 01616000
         TM    SCBFLGS3,SCBBRNTR  IS THIS A FESTAE             @D64ADOW 01617000
         BNO   CHKEX180           NO --->                      @D64ADOW 01618000
         SLR   R9,R9                                           @D64ADOW 01619000
         ICM   R9,B'0111',SCBOWNRA GET RELATED RB ADDR         @D64ADOW 01620000
         LA    RE,RBPRFXLN        COMPUTE ADDR OF PREFIX       @D64ADOW 01621000
         SLR   R9,RE              ... OF THIS RB               @D64ADOW 01622000
         L     RE,RBXSB-RBPREFIX(,R9) GET XSB ADDR             @D64ADOW 01623000
PCKFAPI3 DS    0H                    PROG CHK ADDR FOR SGPCK   @D66XXOW         
         USING XSB,RE                                          @D64ADOW 01624000
         CLC   PTCBEXSL,XSBSEL    RB DEFINED AT CURRENT LINKAGE@D64ADOW 01625000
***                               STACK LEVEL                           01626000
PCKFAPI4 DS    0H                    PROG CHK ADDR FOR SGPCK   @D66XXOW         
         BE    CHKSETFE           YES, SET UP FESTAE           @D64ADOW 01627000
         L     R9,PTCBEXSL        GET LINK STACK ENTRY         @D64ADOW 01628000
         USING LSTKEDSC,R9                                     @D64ADOW 01629000
         TM    LSTKET,LSTKHTST    IS THIS A HEADER ENTRY       @D64ADOW 01630000
         BNZ   CHKEX180                                        @D64ADOW 01631000
         L     R9,XSBSEL          GET LINK STACK AT RB DEFINITI@D64ADOW 01632000
         TM    LSTKET,LSTKHTST    IS THIS A HEADER ENTRY       @D64ADOW 01633000
         DROP  R9                                              @D64ADOW 01634000
         BZ    CHKSETFE           YES, SETUP FESTAE            @D64ADOW 01635000
         DROP  R4                                              @D64ADOW 01636000
         DROP  RE                                              @D64ADOW 01637000
CHKEX180 DS    0H                                              @D64ADOW 01638000
         BAS   RE,CHKFARR         CHECK FOR ARR                @D64ADOW 01639000
*SGLINK CHKFARR,INPUT=(RA,RE),WORK=(R2,R4,R5),OUTPUT=R9                 01640000
         B     CHKSETAR           ARR FOUND                    @D64ADOW 01641000
*        B     *+4                NO ARR                       @D64ADOW 01642000
***                                                                     01643000
***                               OF CURRENT LS LEVEL                   01644000
         BAS   R9,CHKNLSTK        GOTO NEXT LINK STACK ENTRY   @D64ADOW 01645000
*SGLINK CHKNLSTK,INPUT=(R9,RA,RD)                                       01646000
         B     CHKEX080           HANDLE NEXT LINKAGE STACK ENT@D64ADOW 01647000
*        B     CHKEX200           NO FURTHER LINKAGE STACK ENTR@D64ADOW 01648000
***                                                                     01649000
CHKEX200 DS    0H                 CHECK FOR STXIT TYPE EXIT    @D64ADOW 01650000
         L     R7,TCBABEX         ANY AB-EXIT AVAILABLE        @D64ADOW 01651000
         LA    R7,0(,R7)          ...                          @D64ADOW 01652000
         LTR   R7,R7              ...                          @D64ADOW 01653000
         BZ    CHKEX250           NO,                          @D64ADOW 01654000
         USING EXITBLK,R7                                      @D64ADOW 01655000
         ICM   RE,B'1111',EXITADR REALLY DEFINED               @D64ADOW 01656000
         BZ    CHKEX250           NO,                          @D64ADOW 01657000
         BM    CHKEXFIN           ALREADY ACTIVE --->          @D64ADOW 01658000
***                               REQUEST FINAL CANCEL                  01659000
CHKEX210 DS    0H                                              @D65CDOW 01650000
         L     RE,CRADDR          GET COMMUNICATION REGION ADDR@D64ADOW 01660000
***                               (NOT FROM PSEUDO PARTITION)           01661000
         TM    JCSW8-COMREG(RE),IJBSKPAB SKIP AB-EXIT REQUIRED @D64ADOW 01662000
         BO    CHKEX250           YES DON'T EXECUTE EXIT       @D64ADOW 01663000
         ST    R7,PTCBESEL        AB-EXIT IS SELECTED          @D64ADOW 01664000
         MVI   TCBEXIFL,TCBEXIEA  INDICATE EARLY AB            @D64ADOW 01665000
         CLI   EXITFLG2,EARLYAB   IS IT REALY EARLY            @D64ADOW 01666000
         BE    CHKEX250           YES, --->                    @D64ADOW 01667000
         MVI   TCBEXIFL,TCBEXIND  INDICATE OPTION=NODUMP       @D64ADOW 01668000
         CLI   EXITFLG2,SKIPMSG   IS IT REALY NODUMP           @D64ADOW 01669000
         BE    CHKEX250           YES, --->                    @D64ADOW 01670000
         MVI   TCBEXIFL,TCBEXIMS  INDICATE OPTION=MSGONLY      @D64ADOW 01671000
         CLI   EXITFLG2,PRTMSG    IS IT REALY MSGONLY          @D64ADOW 01672000
         DROP  R7                                              @D64ADOW 01673000
         BE    CHKEX250           YES, --->                    @D64ADOW 01674000
         MVI   TCBEXIFL,TCBEXIDU  INDICATE OPTION=DUMP         @D64ADOW 01675000
CHKEX250 DS    0H                                              @D64ADOW 01676000
         LTR   R6,R6             CALLED BY TERMINATOR          @D64ADOW 01677000
         BZ    CHKEXRET          NO, CALLED BY PERCOLATE --->  @D64ADOW 01678000
*                                                                       01679000
         TM    TCBEXIFL,TCBEXIEX ESTAEX-TYPE EXIT SELECTED     @D64ADOW 01680000
         BO    CHKEX260          YES, SKIP CLEAN-UP            @D64ADOW 01681000
*                                                                       01682000
         L     R8,CHKCLEAN       GET SUBROUTINE ADDR           @D64ADOW 01683000
         BASR  R7,R8             ETXR/POST EXIT CLEAN-UP       @D64ADOW 01684000
         L     R8,TIBPTR         RELOAD TIB POINTER            @DY46135 01562000
*                                                                       01685000
*        DISPMAC FUNC=FREELOCK   FREE LOCKS                             01686000
         DISPMAC FUNC=FREELOCK                                 @D64ADOW 01687000
*                                                                       01688000
CHKEX260 DS    0H                                              @D64ADOW 01689000
***                                                                     01690000
***      SETUP SYSTEM/USER COMPLETION CODE AND REASON CODE              01691000
***      IN MVS TCB                                                     01692000
***                                                                     01693000
         SLR   R1,R1              INITIALIZE NO REASON CODE SET@D64ADOW 01694000
         LA    R5,SVCWORKA        GET A WORK AREA              @D64ADMK 01695000
         L     R6,ADISPSER        GET ADDRESS OF DISP.SERVICES @D64ADMK 01696000
         LA    R0,24              GET FUNCTION CODE            @D64ADMK 01697000
         BASSM R7,R6              RETRIEVE MSG INFO            @D64ADOW 01698000
*SGLINK  DISPSE24,INPUT=(R0:FCT_CODE,R5,R6:DISPSERV_BASE,              X01699000
               R7:RETURN_ADDR,R8:TIB_ADDR,RA:TCB_ADDR),                X01700000
               WORK=(R0,R2,RF)                                          01701000
         B     CHKEX280           RETURN IF MSG MOVED          @D64ADMK 01702000
         B     CHKEX320           RETURN IF MSG NOT MOVED      @D64ADMK 01703000
***END OF BRANCH TABLE                                                  01704000
CHKEX280 DS    0H                                              @D64ADMK 01705000
         ICM   R9,B'1111',PSATOLD GET MVS TCB ADDR             @D64ADOW 01706000
         BZ    CHKEX500           NOT AVAILABLE --->           @D64ADOW 01707000
         USING TCB,R9                                          @D64ADOW 01708000
         CLI   TIBCNCL,CANCX49    ABEND MACRO                  @D64ADOW 01709000
         BNE   CHKEX290           NO,                          @D64ADOW 01710000
         USING MAPDMPIF,R5        ADDRESSING (LAYOUT OF WORKARE@D64ADMK 01711000
         L     RB,CANC49AB        SYSTEM/USER COMPLETION CODE  @D64ADMK 01712000
         TM    CANC49FL,C49VALRS  VALID REASON CODE            @D64ADOW 01713000
         BNO   CHKEX490           NO, --->                     @D64ADOW 01714000
         LA    R1,1               INDICATE VALID REASON CODE   @D64ADOW 01715000
         L     R6,CANC49RS        REASON CODE                  @D64ADMK 01716000
         B     CHKEX490           --->                         @D64ADOW 01717000
CHKEX290 DS    0H                                              @D64ADMK 01718000
         CLI   TIBCNCL,CANCX48    NEW MVS LIKE CANCEL CODE     @D64ADOW 01719000
         BNE   CHKEX300           NO,                          @D64ADOW 01720000
         L     RB,CANC48AB        SYSTEM/USER COMPLETION CODE  @D64ADMK 01721000
         TM    CANC48FL,C48VALRS  VALID REASON CODE            @D64ADOW 01722000
         BNO   CHKEX490           NO, --->                     @D64ADOW 01723000
         LA    R1,1               INDICATE VALID REASON CODE   @D64ADOW 01724000
         L     R6,CANC48RC        REASON CODE                  @D64ADMK 01725000
         B     CHKEX490           --->                         @D64ADOW 01726000
CHKEX300 DS    0H                                              @D64ADMK 01727000
         CLI   TIBCNCL,CANCX47    IS IT ERR 47                 @D64ADOW 01728000
         BNE   CHKEX310           NO,                          @D64ADOW 01729000
***                               YES, SUPPLY SYSTEM COMPLETION         01730000
***                                    CODE 2C5 OR 0D6                  01731000
         L     R6,CANC47AB        REASON CODE FOR ERR47        @D64ADMK 01732000
         C     R6,ANRSN03         INVALID PC NUMBER            @D64ADOW 01733000
         BNE   CHKEX470           NO --->                      @D64ADOW 01734000
         SLR   R6,R6              SUPPLY REASON CODE 0         @D64ADOW 01735000
         LH    RB,CHKAB0D6        GET SYSTEM COMPLETION CODE   @D64ADOW 01736000
         B     CHKEX480                                        @D64ADOW 01737000
ANRSN03  DC    A(NUCRSN03)                                     @D64ADOW 01738000
CHKEX310 DS    0H                                              @D64ADMK 01739000
         CLI   TIBCNCL,CANCX46    IS IT ERR 46                 @D64ADOW 01740000
         BNE   CHKEX330           NO,                          @D64ADOW 01741000
         TM    CANC46FL,CANC46DP  WAS DSPSERV MACRO TERMINATED @D64ADOW 01742000
         BNO   CHKEX330           NO --->                      @D64ADOW 01743000
         LH    RB,CHKAB01D                                     @D64ADOW 01744000
         L     R6,CANC46RS        REASON CODE FOR ERR46        @D64ADMK 01745000
         B     CHKEX475           --->                         @D64ADOW 01746000
         DROP  R5                                              @D64ADMK 01747000
         DROP  R9                                              @D64ADMK 01748000
CHKEX320 DS    0H                                              @D64ADMK 01749000
         ICM   R9,B'1111',PSATOLD GET MVS TCB ADDR             @D64ADOW 01750000
         BZ    CHKEX500           NOT AVAILABLE --->           @D64ADOW 01751000
         USING TCB,R9                                          @D64ADOW 01752000
CHKEX330 DS    0H                                              @D64ADMK 01753000
         SLR   RB,RB             INITIALIZE WORK               @D64ADOW 01754000
         SLR   R6,R6             ... REGISTER                  @D64ADOW 01755000
***                                                                     01756000
***      SET UP MVS SYSTEM ABEND (COMPLETION) CODES                     01757000
***                                                                     01758000
         TM    TCBEXITG,TCBDTACH  DETACH BY OWNING TASK        @D64ADOW 01759000
         BNO   CHKEX350           NO --->                      @D64ADOW 01760000
         LH    RB,CHKAB13E        MVS ABEND CODE 13E (STAE=NO) @D64ADOW 01761000
         TM    TCBEXITG,TCBDSTAE  DETACH WITH STAE=YES         @D64ADOW 01762000
         BNO   CHKEX340           NO, --->                     @D64ADOW 01763000
         LH    RB,CHKAB33E        MVS ABEND CODE 33E (STAE=YES)@D64ADOW 01764000
CHKEX340 DS    0H                                              @D64ADMK 01765000
         B     CHKEX485           --->                         @D64ADOW 01766000
CHKEX350 DS    0H                                              @D64ADMK 01767000
         CLI   TIBCNCL,NORMEOJ    NORMAL EOJ                   @D64ADOW 01768000
         BE    CHKEX500           YES DO NOT SET MVS ABEND CODE@D64ADOW 01769000
         CLI   TIBCNCL,CANCX23    CANCEL ALL REQ               @D64ADOW 01770000
         BE    CHKEX360           YES, CHECK IF ABEND CODE SET @D64ADOW 01771000
         CLI   TIBCNCL,CANCX17    CANCEL ALL REQ               @D64ADOW 01772000
         BNE   CHKEX370           NO, --->                     @D64ADOW 01773000
CHKEX360 DS    0H                                              @D64ADMK 01774000
         ICM   R6,B'0111',TCBCMPC IS ABEND CODE SET            @D64ADOW 01776000
         BNZ   CHKEX500           YES, DO NOT OVERWRITE        @D64ADOW 01777000
         B     CHKEX470                                        @D64ADOW 01778000
CHKEX370 DS    0H                                              @D64ADMK 01779000
         CLI   TIBCNCL,CANCX20    CANCELED DUE TO PROG CHECK   @D64ADOW 01780000
         BNE   CHKEX390           NO --->                      @D64ADOW 01781000
         SLR   R0,R0                                           @D64ADOW 01782000
         IC    R0,INTINFO+3       GET PROG INTERRUPTION CODE   @D64ADOW 01783000
         LR    RB,R0              ...                          @D64ADOW 01784000
         N     RB,CHKPROGM        ... W/O PER BIT              @D64ADOW 01785000
         LR    R6,RB              SETUP REASON CODE            @D64ADOW 01786000
         CH    RB,H16             LIMIT FOR SPEC MVS ABEND CODE@D64ADOW 01787000
***                               ... IS SEGM TRANSL EXCEPTION @D64ADOW 01788000
         BH    CHKEX385           ... ---> IF HIGHER           @D64ADOW 01789000
         BNE   CHKEX380           ... 0CN IF NOT SEGM TRANS EXC@D64ADOW 01790000
         LA    RB,X04             ... 0C4 FOR SEGM TRANSL EXCEP@D64ADOW 01791000
CHKEX380 DS    0H                                              @D64ADOW 01792000
         AH    RB,CHKAB0C0        ... COMPLETE MVS ABEND CODE  @D64ADOW 01793000
         B     CHKEX480                                        @D64ADOW 01794000
CHKEX385 DS    0H                                              @D64ADOW 01795000
         LH    RB,CHKAB0D8        GET APPROPRIATE SYS-CMPL-CODE@D64ADOW 01796000
         CLM   R6,B'0001',CHKCC1C SPACE SWITCH EXCEPTION       @D64ADOW 01797000
         BE    CHKEX485           YES, NO RSN CODE --->        @D64ADOW 01798000
         LH    RB,CHKAB0D5        GET APPROPRIATE SYS-CMPL-CODE@D64ADOW 01799000
         CLM   R6,B'0001',CHKCC20 AFX TRANSLATION EXCEPTION    @D64ADOW 01800000
         BE    CHKEX485           YES, NO REASON CODE --->     @D64ADOW 01801000
         CLM   R6,B'0001',CHKCC21 ASX TRANSLATION EXCEPTION    @D64ADOW 01802000
         BE    CHKEX485           YES, NO REASON CODE --->     @D64ADOW 01803000
         LH    RB,CHKAB0D6        GET APPROPRIATE SYS-CMPL-CODE@D64ADOW 01804000
         CLM   R6,B'0001',CHKCC22 LX TRANSLATION EXCEPTION     @D64ADOW 01805000
         BE    CHKEX480           YES, SET RSN CODE --->       @D64ADOW 01806000
         CLM   R6,B'0001',CHKCC23 EX TRANSLATION EXCEPTION     @D64ADOW 01807000
         BE    CHKEX480           YES, SET RSN CODE --->       @D64ADOW 01808000
         LR    R6,R0              PROG INT CODE IS RSN CODE    @D64ADOW 01809000
         B     CHKEX470           SUPPLY 2C5 RSN=200000XX      @D64ADOW 01810000
***                                                                     01811000
CHKCC1C  DC    X'1C'                                           @D64ADOW 01812000
CHKCC20  DC    X'20'                                           @D64ADOW 01813000
CHKCC21  DC    X'21'                                           @D64ADOW 01814000
CHKCC22  DC    X'22'                                           @D64ADOW 01815000
CHKCC23  DC    X'23'                                           @D64ADOW 01816000
***                                                                     01817000
CHKEX390 DS    0H                                              @D64ADMK 01818000
         CLI   TIBCNCL,IOERR      I/O ERROR                    @D64ADMK 01819000
         BNE   CHKEX400           NO --->                      @D64ADOW 01820000
         LH    RB,CHKAB0F2        MVS ABEND CODE               @D64ADOW 01821000
CHKEX395 DS    0H                                              @DY45849 01818000
         TM    TCBRFLAG,TCBRCVAL  REASON CODE SPECIFIED        @DY45849         
         BNO   CHKEX485           NO --->                      @DY45849         
         ICM   R6,7,TCBRCODE      GET REASON CODE              @DY45849         
         B     CHKEX480           --->                         @DY45849 01822000
CHKEX400 DS    0H                                              @D64ADMK 01823000
         CLI   TIBCNCL,CANCX08    PFLUSH OF POWER PARTITION    @D64ADMK 01824000
         BE    CHKEX410           YES, HANDLE LIKE OP CANCEL   @D64ADOW 01825000
         CLI   TIBCNCL,CANCX24    OPERATOR CANCEL              @D64ADMK 01826000
         BNE   CHKEX420           NO --->                      @D64ADOW 01827000
CHKEX410 DS    0H                                              @D64ADMK 01828000
         LH    RB,CHKAB122        OP CANCEL, DUMP=YES          @D64ADOW 01829000
         LH    R0,RID             GET CURRENT RID              @D64ADOW 01830000
         L     RE,CRADDR          GET COMMUNICATION REGION ADDR@D64ADOW 01831000
         MC    4,4                ... IF ICCF PSEUDO PARTITION @D64ADOW 01832000
         STH   R0,RID             ... REPAIR RID               @D64ADOW 01833000
         TM    JCSW4-COMREG(RE),OPTDUMP                        @D64ADOW 01834000
         BO    CHKEX395                                        @D64ADOW 01835000
         TM    TEMOPT-COMREG(RE),OPTPDUMP                      @D64ADOW 01836000
         BO    CHKEX395                                        @D64ADOW 01837000
         TM    TEMOPT2-COMREG(RE),OPTSDUMP                     @D64ADOW 01838000
         BO    CHKEX395                                        @D64ADOW 01839000
         LH    RB,CHKAB222        OP CANCEL, DUMP=NO           @D64ADOW 01840000
         B     CHKEX395           --->                         @D64ADOW 01841000
CHKEX420 DS    0H                                              @D64ADMK 01842000
         CLI   TIBCNCL,CANCX15    PAGE FAULT IN DISABLED STATE @D64ADMK 01843000
         BNE   CHKEX430           NO --->                      @D64ADOW 01844000
         LH    RB,CHKAB0C0        MVS ABEND CODE               @D64ADOW 01845000
         LA    RB,4(,RB)          ...                          @D64ADOW 01846000
         LA    R6,X11             REASON CODE                  @D64ADOW 01847000
         B     CHKEX480           --->                         @D64ADOW 01848000
CHKEX430 DS    0H                                              @D64ADMK 01849000
         CLI   TIBCNCL,CANCX21    ILLEGAL SVC                  @D64ADOW 01850000
         BE    CHKEX460                                        @D64ADOW 01851000
         CLI   TIBCNCL,CANCX45    MODE VIOLATION               @D64ADOW 01852000
         BNE   CHKEX470                                        @D64ADOW 01853000
         TM    INTINFO,XF0        BAKR/PC CANCELED?            @D64ADOW 01854000
         BNO   CHKEX460           NO --->                      @D64ADOW 01855000
         ICM   R6,B'0111',INTINFO+1 GET BAKR/PC INFO           @D64ADOW 01856000
         OC    R6,CHKBAKRM        INDICATE BAKR                @D64ADOW 01857000
         CLI   INTINFO,XFF        PC CANCELED                  @D64ADOW 01858000
         BNE   CHKEX470           NO, --->                     @D64ADOW 01859000
         OC    R6,CHKPCMSK        INDICATE PROG-CALL           @D64ADOW 01860000
         B     CHKEX470                                        @D64ADOW 01861000
CHKEX460 DS    0H                                              @D64ADMK 01862000
         ICM   R6,B'0001',INTINFO+3 GET SVC INTERRUPTION CODE  @D64ADOW 01863000
         TM    TCBMVSIS,TCBMVSSA  SIMULATED SVC (NATIVE OR FAM)@D64ADOW 01864000
         BNO   CHKEX470                                        @D64ADOW 01865000
         ICM   R6,B'0010',INTINFO+3 GET SVC INTERRUPTION CODE  @D64ADOW 01866000
         ICM   R6,B'0001',TCBMVSIS+3 GET MVS-SVC-CODE          @D64ADOW 01867000
CHKEX470 DS    0H                                              @D64ADMK 01868000
         LH    RB,CHKAB2C5        GET VSE SPECIFIC ABEND CODE  @D64ADOW 01869000
CHKEX475 DS    0H                                              @D64ADMK 01870000
         ICM   R6,B'1000',TIBCNCL COMPLETE REASON CODE         @D64ADOW 01871000
CHKEX480 DS    0H                                              @D64ADMK 01872000
         LA    R1,1               INDICATE VALID REASON CODE   @D64ADOW 01873000
CHKEX485 DS    0H                                              @D64ADMK 01874000
         SLL   RB,12              ABEND CODE INTO RIGHT POSITIO@D64ADMK 01875000
CHKEX490 DS    0H                                              @D64ADMK 01876000
         STCM  RB,B'0111',TCBCMPC SYSTEM/USER COMPL CODE TO    @D64ADOW 01877000
***                               MVS TCB                               01878000
         NI    TCBCMPF,XFF-TCBRV316 INITIALIZE INDICATOR       @D64ADOW 01879000
         LTR   R1,R1              REASON CODE SET              @D64ADOW 01880000
         BZ    CHKEX500           NO, --->                     @D64ADOW 01881000
         OI    TCBCMPF,TCBRV316   INDICATE REASON CODE IS VALID@D64ADOW 01882000
         ST    R6,TCBARC          REASON CODE TO MVS-TCB       @D64ADOW 01883000
         DROP  R9                                              @D64ADOW 01884000
CHKEX500 DS    0H                                              @D64ADOW 01885000
         DROP  RD                                              @D64ADOW 01886000
         LR    RB,RD              SAVE CURRENT BASE            @D64ADOW 01887000
         L     R9,ASGMVSAP        GET BASE FOR SUBROUTINE      @D64ADOW 01888000
         USING SGMVSAPI,R9                                     @D64ADOW 01889000
         LA    RF,SGMAPICL        ADDR OF SUBROUTINE           @D64ADOW 01890000
         O     RF,BIT0ON          FORCE 31 BIT MODE            @D64ADOW 01891000
         BASSM R8,RF              CALL MVS-API CLEAN-UP        @D64ADOW 01892000
*SGLINK SGMAPICL,INPUT=(R8,R9,RA),WORK=(R1,R13,R14,R15)                 01893000
         DROP  R9                                              @D64ADOW 01894000
         LR    RD,RB              RESTORE BASE                 @D64ADOW 01895000
         USING CHKEXIT,RD                                      @D64ADOW 01896000
CHKEXRET DS    0H                                              @D64ADOW 01897000
         NI    TCBEXIFL,XFF-TCBEXABO                           @D64ADOW 01898000
         LM    R0,RF,SVCWORK      RESTORE REGISTER             @D64ADOW 01899000
         BSM   0,R9               RETURN                       @D64ADOW 01900000
*                                                                       01901000
CHKEXFIN DS    0H                                              @D64ADOW 01902000
         MVI   TCBEXIFL,TCBEXIAC  REQUEST FINAL CANCEL         @D64ADOW 01903000
         LTR   R7,R7              ANY EXIT SPECIFIED           @D64ADOW 01904000
         BZ    CHKEX250           NO                           @D64ADOW 01905000
         USING EXITBLK,R7                                      @D64ADOW 01906000
         CLI   EXITFLG2,EARLYAB   EARLY AB DEFINED             @D64ADOW 01907000
         BE    CHKEXF10           YES --->                     @D64ADOW 01908000
         CLI   EXITFLG2,PRTMSG    MSGONLY  DEFINED             @D64ADOW 01909000
         BNE   CHKEX250           NO --->                      @D64ADOW 01910000
CHKEXF10 DS    0H                                              @D64ADOW 01911000
         MVI   TCBEXIFL,TCBEXINI  NEW INTERFACE USED           @D64ADOW 01912000
         B     CHKEX250                                        @D64ADOW 01913000
         DROP  R7                                              @D64ADOW 01914000
*                                                                       01915000
CHKSETFR DS    0H                 SET UP FRR                   @D64ADOW 01916000
         ST    R7,PTCBESEL        CURRENT STACK ENTRY TO TCB   @D64ADOW 01917000
         MVI   PTCBEXFL,TCBEXFRR  INDICATE FRR SELECTED        @D64ADOW 01918000
         B     CHKSET10                                        @DY44889 01919490
CHKSETAR DS    0H                 SET UP ARR                   @D64ADOW 01920000
         ST    R9,PTCBESEL        SAVE ETE ADDR                @D64ADOW 01921000
         MVI   PTCBEXFL,TCBEXARR  INDICATE ARR SELECTED        @D64ADOW 01922000
         B     CHKSET10                                        @D64ADOW 01923000
CHKSETFE DS    0H                 SET UP FESTAE                @D64ADOW 01924000
         SLR   R9,R9                                           @D64ADOW 01925000
         ICM   R9,B'0111',SCBOWNRA-SCB(R4) GET RB ADDR RELATED @D64ADOW 01926000
***                               TO FESTAE                             01927000
         ST    R9,PTCBESEL        SAVE RB ADDR                 @D64ADOW 01928000
         MVI   PTCBEXFL,TCBEXFES  INDICATE FESTAE SELECTED     @D64ADOW 01929000
         TM    RBSTAB1-RBSECT(R9),RBFTSVRB FESTAE IN CICS-SVC  @D64ADOW 01930000
         BNO   CHKSET60           NO, DON'T PERFORM FESTAE     @D64ADOW 01931000
         B     CHKSET10                                        @D64ADOW 01932000
CHKSETESX DS   0H                                              @D66XXOW 01933000
         OI    PTCBFLG1,TCBXPONY  ALLOW ONLY PERCOLATE         @D66XXOW         
CHKSETES DS    0H                 SET UP ESTAEX                @D64ADOW 01933000
         ST    R7,PTCBESEL        EXIT BLOCK ADDR TO TCB       @D64ADOW 01934000
         MVI   PTCBEXFL,TCBEXABT  INDICATE ESTAEX SELECTED     @D64ADOW 01935000
*        B     CHKSET10                                        @D64ADOW 01936000
CHKSET10 DS    0H                                              @D64ADOW 01937000
         NI    PTCBESEL,X7F       ENSURE BIT0 OFF              @D64ADOW 01940000
         MVI   TCBEXIFL,TCBEXIEX  INDICATE ESTAE-TYPE EXIT     @D64ADOW 01941000
***                                                                     01942000
***      CHECK SELECTED ERROR RECOVERY ROUTINE                          01943490
***           IS CALLED RECURSIVE                                       01943980
***           CAN HANDLE THE TERMINATION CONDITION                      01944470
***                                                                     01945000
         L     R7,PTCBESEL       GET RELATED BLOCK ADDR        @D64ADOW 01946000
         C     R7,PTCBEACT       SAME AB-TYPE EXIT CALLED      @D64ADOW 01947000
***                              RECURSIVE (AB-CONDITION IN AB-TYPE     01948000
***                              EXIT AND NO NEWER AB-TYPE EXIT DEF'D)  01949000
         BE    CHKSET60          YES, DON'T EXECUTE ONCE MORE  @D64ADOW 01950000
         L     R4,CRADDR         GET COMMUNICATION REGION ADDR @D64ADOW 01951000
***                              (NOT FROM PSEUDO PARTITION)            01952000
         TM    JCSW8-COMREG(R4),IJBSKPAB SKIP AB-EXIT PROC REQD@D64ADOW 01953000
         BO    CHKSET60           YES DON'T EXECUTE EXIT       @D64ADOW 01954000
         TM    TCBEXITG,TCBDTACH DETACH BY OWNING TASK         @D64ADOW 01955000
         BNO   CHKSET30          NO --->                       @D64ADOW 01956000
         TM    TCBEXITG,TCBDSTAE DETACH WITH STAE=YES          @D64ADOW 01957000
         BO    CHKSET55          YES, PERFORM AB-TYPE EXIT     @DY45037 01958490
         B     CHKSET40          NO, CHECK FOR TERM=YES        @D64ADOW 01959000
CHKSET30 DS    0H                                              @D64ADOW 01960000
         CLI   TIBCNCL,NORMEOJ   NORMAL EOJ                    @D64ADOW 01961000
         BE    CHKSET60          YES, DO NOT PERFORM ESTAEX    @D64ADOW 01962000
***                              TYPE EXIT                              01963000
         CLI   TIBCNCL,CANCX24   OPERATOR CANCEL               @D64ADOW 01964000
         BE    CHKSET40          YES, --->                     @D64ADOW 01965000
         CLI   TIBCNCL,CANCX08   POWER PFLUSH                  @D64ADOW 01966000
         BE    CHKSET40          YES,                          @D64ADOW 01967000
         CLI   TIBCNCL,CANCX1D   CANCEL DUE TO MT TERMINATION  @D64ADOW 01968000
         BNE   CHKEX250          NO, EXIT WILL BE PERFORMED    @D64ADOW 01969000
CHKSET40 DS    0H                                              @D64ADOW 01970000
         CLI   PTCBEXFL,TCBEXFES FESTAE TO BE SCHEDULED        @D64ADOW 01971000
         BNE   CHKSET50          NO, --->                      @D64ADOW 01972000
         TM    RBSFLG3-RBSECT(R7),SCBTERMI TERM=YES SPECIFIED  @D64ADOW 01973000
         BO    CHKSET55          YES, SCHEDULE FESTAE          @DY45037 01974490
         B     CHKSET60          NO, DO NOT PERFORM EXIT       @D64ADOW 01975000
CHKSET50 DS    0H                                              @D64ADOW 01976000
         CLI   PTCBEXFL,TCBEXABT ESTEAX TO BE SCHEDULED        @D64ADOW 01977000
         BNE   CHKSET55          NO, SCHEDULE EXIT             @DY45037 01978490
         TM    EXABFLG-EXITADR(R7),EXABTERM TERM=YES SPECIFIED @D64ADOW 01979000
         BNO   CHKSET60          NO, SKIP EXIT                 @DY45037 01980030
CHKSET55 DS    0H                                              @DY45037 01980060
         OI    PTCBFLG1,TCBXPONY ALLOW ONLY PERCOLATE          @DY45037 01980090
         B     CHKEX250                                        @DY45037 01980120
***                                                                     01980200
***      PERCOLATE SELECTED RECOVERY ROUTINE                            01980400
***                                                                     01980600
CHKSET60 DS    0H                DON'T SCHEDULE SELECTED EXIT  @D64ADOW 01981000
         LA    R0,SDWATLEN+72    SDWA + NORMAL SAVE AREA       @D64ADOW 01982000
         CLI   PTCBEXFL,TCBEXFES FESTAE SELECTED               @D64ADOW 01983000
         BNE   CHKSET70          NO, --->                      @D64ADOW 01984000
         L     RE,PSATOLD        GET MVS TCB                   @D64ADOW 01985000
         SLR   R4,R4                                           @D64ADOW 01986000
         ICM   R4,B'0111',TCBSTABB-TCB(RE) GET CURRENT SCB PTR @D64ADOW 01987000
         BNZ   CHKSET65                                        @D66XXOW         
.**                  MVS CHAIN EMPTY SHOULD NOT OCCUR                           
.**                  NEVERTHELESS WE TRY TO TERMINATE PARTITION                 
         OI    PTCBFLG1,TCBXPONY ALLOW ONLY PERCOLATE          @D66XXOW 01980090
         B     CHKSET99                                        @D66XXOW         
CHKSET65 DS    0H                                              @D66XXOW 01980060
         L     R9,SCBCHAIN-SCB(,R4) GET NEXT IN CHAIN          @D64ADOW 01988000
PCKFAPI5 DS    0H                    PROG CHK ADDR FOR SGPCK   @D66XXOW         
         XC    SCBCHAIN-SCB(8,R4),SCBCHAIN-SCB(R4) DEACTIVATE  @D64ADOW 01989000
***                              AND DEQUEUE MVS-SCB                    01990000
         STCM  R9,7,TCBSTABB-TCB(RE) ENQUEUE ON TOP OF CHAIN   @D64ADOW 01991000
         B     CHKSET99          LOOK FOR NEXT ESTAE TYPE EXIT @D64ADOW 01992000
CHKSET70 DS    0H                                              @D64ADOW 01993000
         CLI   PTCBEXFL,TCBEXFRR FRR SELECTED                  @D64ADOW 01994000
         BNE   CHKSET80          NO,  --->                     @D64ADOW 01995000
         L     R9,TCBFREX        GET TASKS FRR STACK           @D64ADOW 01996000
         USING FRRS,R9                                         @D64ADOW 01997000
         LA    R0,FRRSESZE+FRRSEXSZ                            @D64ADOW 01998000
         LR    R4,R7             COPY CURRENT FRR ENTRY        @D64ADOW 01999000
         SLR   R4,R0             GET PREVIOUS FRR STACK ENTRY  @D64ADOW 02000000
         ST    R4,FRRSCURR       ... AND MAKE IT CURRENT       @D64ADOW 02001000
         C     R4,FRRSEMP        FRR STACK EMPTY               @D64ADOW 02002590
         BE    CHKSET75          YES--->                       @D64ADOW 02003180
         USING FRRSENTR,R4                                     @D64ADOW 02004000
         TM    FRRSFLG4,FRRSEUT  NEXT FRR WITH EUT=YES         @D64ADOW 02005000
         BO    CHKSET77          YES, KEEP EUT INDICATION      @D64ADOW 02006000
         B     CHKSET76          NO, RESET EUT INDICATION      @D64ADOW 02007000
         DROP  R4                                              @D64ADOW 02008000
CHKSET75 DS    0H                                              @D64ADOW 02009000
         L     R4,TCBATCBE       GET TCBX ADDR                 @D64ADOW 02010000
         NI    TCBXFLG1-TCBXADR(R4),XFF-TCBXFRRA IND NO FRR DEF@D64ADOW 02011000
CHKSET76 DS    0H                                              @D64ADOW 02012000
         NI    PSAMFLGS,X7F      RESET EUT INDICATOR           @D64ADOW 02013000
         NI    TCBEXITH,XFF-TCBEUTIN ... AND IN TCB            @D65CDOW 02014000
CHKSET77 DS    0H                                              @D64ADOW 02015000
         DROP  R9                                              @D64ADOW 02016000
         LA    R0,SDWATLEN+304   SDWA + FRR SAVE AREA          @D64ADOW 02017000
         B     CHKSET99          LOOK FOR NEXT ESTAE TYPE EXIT @D64ADOW 02018000
CHKSET80 DS    0H                                              @D64ADOW 02019000
         CLI   PTCBEXFL,TCBEXARR ARR SELECTED                  @D64ADOW 02020000
         BNE   CHKSET90          NO, --->                      @D64ADOW 02021000
         BAS   R9,CHKNLSTK       GOTO PREVIOUS LINK STACK ENTRY@D64ADOW 02022000
*SGLINK CHKNLSTK,INPUT=(R9,RA,RD)                                       02023000
         B     CHKSET99          LOOK FOR NEXT ESTAE TYPE EXIT @D64ADOW 02024000
         B     CHKSET99          LOOK FOR NEXT ESTAE TYPE EXIT @D64ADOW 02025000
***END OF BRANCH TABLE                                                  02026000
CHKSET90 DS    0H                ITS A ESTAEX, PERFORM         @D64ADOW 02027000
***                              PERCOLATE FOR AB-TYPE EXIT             02028990
         USING EXITBLK,R7        ADDRESSABILITY                @D64ADMK 02030000
         NI    EXITADR,XFF-EXITACT                             @D64ADOW 02031000
         LA    R4,TCBABEX        CHAINING ADDR                 @D64ADOW 02032000
         L     RC,ASGEXIT        EXIT CONTROL BLOCK            @D64ADOW 02033590
         L     RC,ARESUSPB-SGEXIT(,RC) ... TO FREE-CHAIN       @D64ADOW 02034180
         BASSM R8,RC             ...  AND RESET USP-BIT        @D64ADOW 02035000
*SGLINK RESUSPB,INPUT=(R4,R7,R8,RA,RC),OUTPUT=(R7)                      02036000
         L     R8,TIBPTR         RELOAD TIB POINTER            @D64ADOW 02037000
         L     RC,TCBATCBE       RELOAD                        @D64ADOW 02038000
         L     RC,PTCBAPTC       ...PSEUDO TCB-EXTENSION       @D64ADOW 02039000
         DROP  R7                                              @D64ADOW 02040000
CHKSET99 DS    0H                                              @D64ADOW 02041000
         SLR   R9,R9             CLEAR LAST ACTIVE EXIT PTR    @D64ADOW 02042000
         XC    PTCBEACT,PTCBEACT AVOID CREATE PSEUDO-TCBX      @D64ADOW 02043000
***                              (CASE WHERE AB-TYPE EXIT TERMINATES    02043200
***                               AND NO NESTED AB-TYPE EXIT DEFINED.   02043400
***                               IN THIS CASE THE FIRST ERROR IS       02043600
***                               OVERWRITTEN BY THE NEW ONE)           02043800
         ICM   R1,B'1111',PTCBASDW GET ACTUAL SDWA ADDR        @D64ADOW 02044000
         BZ    CHKEX060          NOT AVAIALBLE, CHK FOR NEXT   @D64ADOW 02045000
         LA    RF,20             SETUP FUNCTION CODE FREEMAIN  @D64XDOW 02046000
         L     RC,ASGEXIT        GET BASE OF                   @D64XDOW 02047000
         L     RC,AEXITGVI-SGEXIT(,RC) ... SUBROUTINE          @D64XDOW 02048000
         BASSM R8,RC              FREE SPACE                   @D64XDOW 02049000
*SGLINK  EXITFVIS,INPUT=(R0,R1,R8,RA,RC,RF),OUTPUT=RF,WORK=R0           02050000
         L     R8,TIBPTR         RELOAD TIB POINTER            @D64ADOW 02051000
         L     RC,TCBATCBE       RELOAD                        @D64ADOW 02052000
         L     RC,PTCBAPTC       ...PSEUDO TCB-EXTENSION       @D64ADOW 02053000
         XC    PTCBASDW,PTCBASDW CLEAR POINTER                 @D64ADOW 02054000
         B     CHKEX060          LOOK FOR NEXT ESTAE TYPE EXIT @D64ADOW 02055000
         SPACE                                                                  
CHKSUSPD DS    0H                                              @D65CDOW         
         ICM   R7,B'1111',TCBABEX AB-EXIT DEFINED              @D65CDOW         
         BZ    CHKSUSP5          NO, --->                      @D65CDOW         
         LA    R7,0(,R7)                                       @D65CDOW         
         USING EXITBLK,R7                                      @D65CDOW         
         ICM   RE,B'1111',EXITADR EXIT REALLY DEFINED          @D65CDOW         
         BP    CHKEX210          YES, SELECT IT                @D65CDOW         
         LH    R0,EXITLENG                                     @D65CDOW 04593000
*** FREEVIS FOR EXIT CONTROL BLOCK                                      04594000
*        SFREEVIS LENGTH=(0),ADDRESS=(7)                                04595000
         SFREEVIS LENGTH=(0),ADDRESS=(7)                       @D65CDOW 04596000
*END OF SFREEVIS MACRO                                                  04597000
CHKSUSP5 DS    0H                                              @D65CDOW         
         L     RE,TCBSAVEX       GET SAVED ENV ANCHOR          @D65CDOW         
         ST    RE,TCBABEX        ...AND RESTORE IT             @D65CDOW         
         XC    TCBSAVEX,TCBSAVEX ...AND CLEAR SAVE AREA        @D65CDOW         
         IC    RE,TCBEXITH       GET SAVED AB-EXIT INFO FOR    @D65CDOW         
         N     RE,CHKSMSK1       ...ATTACH                     @D65CDOW         
         NI    TCBEXITH,XF8      ...AND CLEAR SAVEAREA         @D65CDOW         
         IC    R8,TCBEXITG       GET CONTENT OF FLAG BYTE      @D65CDOW         
         OR    R8,RE             RESTORE AB-EXIT INFO          @D65CDOW         
         STC   R8,TCBEXITG       ... FOR ATTACH                @D65CDOW         
         B     CHKEX022          RETURN TO MAINLINE            @D65CDOW         
CHKSMSK1 EQU   F3                                              @D65CDOW         
         DROP  R7                                              @D65CDOW         
         DROP  R8                                              @D64ADOW 02056000
         DROP  RC                                              @D64ADOW 02057000
         EJECT                                                          02058000
*********************************************************************** 02059000
*                                                                     * 02060000
*        STEP TO PREVIOUS RB                                          * 02061000
*                PREVIOUS LINKAGE STACK                               * 02062000
*                   --->  IF CURRENT RB CREATED WITH CURRENT LINKAGE  * 02063000
*                            STACK PERFORM CLEANUP FOR CURRENT RB     * 02064000
*                            AND RETURN                               * 02065000
*                   --->  IF RECOVERY LINKAGE STACK EMPTY CALL        * 02066000
*                            IJBLSTK TO FREE RECOVERY LINKAGE STACK   * 02067000
*                            AND RE-ESTABLISH NORMAL LINKAGE STACK    * 02068000
*                   --->  SAVE PREVIOUS LINKAGE STACK ENTRY ADDR      * 02069000
*                            TO PTCBEXSL                              * 02070000
*                   --->  SAVE PREVIOUS RB ADDR                       * 02071000
*                            TO PTCBEXRL                              * 02072000
*                                                                     * 02073000
*********************************************************************** 02074000
CHKNLSTK DS    0H                 GO TO PREVIOUS LINK STACK ENT@D64ADOW 02075000
*SGLINK CHKNLSTK,S,INPUT=(R9,RA,RD)                                     02076000
         STM   R0,RF,SVCWORKA     SAVE SOME WORK REGISTER      @D64ADOW 02077000
CHKNLS00 DS    0H                                              @D64ADOW 02078000
         ICM   R9,B'1111',PSATOLD GET MVS TCB ADDR             @D64ADOW 02079000
         BZ    CHKNLS10           NOT AVAILABLE --->           @D64ADOW 02080000
         L     R9,TCBRBP-TCB(,R9) GET CURRENT RB/SVRB          @D64ADOW 02081000
         TM    RBSTAB1-RBSECT(R9),RBFTSVRB IS THIS A SVRB      @D64ADOW 02082000
         BNO   CHKNLS10           NO --->                      @D64ADOW 02083000
         L     R6,TCBATCBE        GET ADDR                     @D64ADOW 02084000
         USING TCBXADR,R6         ... OF                       @D64ADOW 02085000
         L     R6,PTCBAPTC        ... PSEUDO TCBX              @D64ADOW 02086000
         LA    RE,RBPRFXLN        COMPUTE ADDR OF PREFIX       @D64ADOW 02087000
         SLR   R9,RE              ... OF THIS RB               @D64ADOW 02088000
         L     RE,RBXSB-RBPREFIX(,R9) GET XSB ADDR             @D64ADOW 02089000
         USING XSB,RE                                          @D64ADOW 02090000
         CLC   PTCBEXSL,XSBSEL    RB DEFINED AT CURRENT LINKAGE@D64ADOW 02091000
***                               STACK LEVEL                           02092000
         BNE   CHKNLS10           NO, STAY WITH CURRENT RB/SVRB@D64ADOW 02093000
         DROP  R6                                              @D64ADOW 02094000
         DROP  RE                                              @D64ADOW 02095000
*        SMCBEM FUNC=CLEANUP      DEACTIVATE LATEST SVRB                02096000
         SMCBEM FUNC=CLEANUP                                   @D64ADOW 02097000
***END OF SMCBEM MACRO                                                  02098000
         L     RD,SVCWORKA+13*4   RELOAD BASE ADDR             @D64ADOW 02099000
         L     R9,PSATOLD         GET MVS TCB ADDR             @D64ADOW 02100000
         L     R9,TCBRBP-TCB(,R9) GET CURRENT RB/SVRB          @D64ADOW 02101000
         L     R6,TCBATCBE        GET ADDR                     @D64ADOW 02102000
         USING TCBXADR,R6         ... OF                       @D64ADOW 02103000
         L     R6,PTCBAPTC        ... PSEUDO TCBX              @D64ADOW 02104000
         ST    R9,PTCBEXRL        SAVE NEW RB ADDR IN PTCBX    @D64ADOW 02105000
         DROP  R6                                              @D64ADOW 02106000
         B     CHKNLS30           ---> EXIT                    @D64ADOW 02107000
CHKNLS10 DS    0H                                              @D64ADOW 02108000
         L     R6,TCBATCBE        GET ADDR                     @D64ADOW 02109000
         USING TCBXADR,R6         ... OF                       @D64ADOW 02110000
         L     R6,PTCBAPTC        ... PSEUDO TCBX              @D64ADOW 02111000
         L     R2,PTCBEXSL        GET CURRENT LINK STACK ENTRY @D64ADOW 02112000
         USING LSTKEDSC,R2                                     @D64ADOW 02113000
         TM    LSTKET,LSTKBENT    PC OR BRANCH STATE ENTRY     @D64ADOW 02114000
         BNO   CHKNLS50           BRANCH IF LINK STACK HEADER  @D64ADOW 02115000
***                               OF FIRST SECTION                      02116000
         LA    R4,LSTAT           GET LENGTH OF STATUS ENTRY   @D64ADOW 02117000
         SLR   R2,R4              BACK TO PREVIOUS ENTRY DESCRI@D64ADOW 02118000
         TM    LSTKET,LSTKBENT    IS NEW ENTRY ALSO PC/BRANCH  @D64ADOW 02119000
         BO    CHKNLS20           YES, RETURN                  @D64ADOW 02120000
***                               NO, ITS A HEADER OF A SECTION         02121000
         LR    R5,R2                                           @D64ADOW 02122000
         LA    R4,L'LSTKTHDY      BACK TO START OF HEADER      @D64ADOW 02123000
         SLR   R5,R4              ...                          @D64ADOW 02124000
         USING LSTKHDR,R5                                      @D64ADOW 02125000
         ICM   R4,B'1111',LSTKBSEA GET PTR TO PREVIOUS SECTION @D64ADOW 02126000
         BNM   CHKNLS20           NOT AVAILABLE --->           @D64ADOW 02127000
         N     R4,CHKNLSMK        RESET UNUSED BITS            @D64ADOW 02128000
         LR    R2,R4              NEW LINK STACK ENTRY         @D64ADOW 02129000
CHKNLS20 DS    0H                                              @D64ADOW 02130000
         ST    R2,PTCBEXSL        SAVE THE LINK STACK ENTRY    @D64ADOW 02131000
CHKNLS30 DS    0H                                              @D64ADOW 02132000
         LM    R0,RF,SVCWORKA     RESTORE REGISTER             @D64ADOW 02133000
         BR    R9                 RETURN                       @D64ADOW 02134000
CHKNLS50 DS    0H                 NO FURTHER LINK STACK ENTRY  @D64ADOW 02135000
         TM    TCBFLAG5,TCBRSIND  REC LINKAGE STACK ACTIVE     @D64ADOW 02136000
         BNO   CHKNLS90           NO, --->                     @D64ADOW 02137000
         L     R8,TIBPTR                                       @D64ADOW 02138000
         L     RC,ASVASVDL         PTR TO SVA ROUT.ADDR.TABLE  @D61PDOW 02139000
         L     RC,AIJBLSTK-SVASVDL(,RC) GET ROUTINE ADDR       @D61PDOW 02140000
         LA    RF,20               SET UP FUNCTION CODE        @D61PDOW 02141000
         BASSM RE,RC               RELEASE RECOVERY LINK STACK @D64ADOW 02142000
***                                AND GIVE TASK EMPTY LINKAGE STACK    02143000
*SGLINK $IJBLSTK,INPUT=(R8:TIB_ADDR,RA:TCB_ADDR,RE:RETURN ADDR,        X02144000
               RC:$IJBLSTK_ENTRY_ADDR,RF:FCT_CODE)                      02145000
         L     R6,TCBATCBE        GET CURRENT                  @D64ADOW 02146000
         L     R2,TCBX1CRF-TCBXADR(,R6) ... LS ENTRY           @D64ADOW 02147000
         B     CHKNLS20           --->                         @D64ADOW 02148000
CHKNLS90 DS    0H                                              @D64ADOW 02149000
         LM    R0,RF,SVCWORKA     RESTORE REGISTER             @D64ADOW 02150000
         B     4(,R9)             RETURN                       @D64ADOW 02151000
         DROP  R2                                              @D64ADOW 02152000
         DROP  R5                                              @D64ADOW 02153000
         DROP  R6                                              @D64ADOW 02154000
         EJECT                                                          02155000
*********************************************************************** 02156000
*                                                                     * 02157000
*        CHECK IF CURRENT LINKAGE STACK OWNS ARR                      * 02158000
*                                                                     * 02159000
*********************************************************************** 02160000
CHKFARR  DS    0H                 GO TO PREVIOUS LINK STACK ENT@D64ADOW 02161000
*SGLINK CHKFARR,S,INPUT=(RA,RE),WORK=(R2,R4,R5),OUTPUT=R9               02162000
         L     R2,TCBATCBE        GET ADDR OF                  @D64ADOW 02163000
         L     R2,PTCBAPTC-TCBXADR(,R2)  ... PSEUDO TCBX       @D64ADOW 02164000
         L     R2,PTCBEXSL-TCBXADR(,R2) GET CURRENT LS LEVEL   @D64ADOW 02165000
         USING LSTKEDSC,R2                                     @D64ADOW 02166000
         TM    LSTKET,LSTKPENT    IS THIS A PC-STATE ENTRY     @D64ADOW 02167000
         DROP  R2                                              @D64ADOW 02168000
         BNO   4(,RE)             NO,                          @D64ADOW 02169000
         LA    R9,LSTATLN1        GET ADDR OF STATUS ENTRY     @D64ADOW 02170000
         LR    R4,R2              ...                          @D64ADOW 02171000
         SLR   R4,R9              ...                          @D64ADOW 02172000
         USING LSTKSTAT,R4                                     @D64ADOW 02173000
         SLR   R9,R9                                           @D64ADOW 02174000
         ICM   R9,7,LSTKPCN       GET LX FROM PC NUMBER        @D64ADOW 02175000
         SLL   R9,2               GET DISPL IN LINKAGE TABLE   @D64ADOW 02176000
         L     R5,PCBPTR          GET PCB ADDR                 @D64ADOW 02177000
         USING PCBADR,R5                                       @D64ADOW 02178000
         L     R5,PCBAPCBX        GET PCB EXTENSION            @D64ADOW 02179000
         USING PCBXADR,R5                                      @D64ADOW 02180000
         A     R9,PCBXVALT        GET ADDR OF LINKAGE TABLE    @D64ADOW 02181000
         DROP  R5                                              @D64ADOW 02182000
         ICM   R9,B'1111',0(R9)   GET REAL ADDR OF ENTRY TABLE @D64ADOW 02183000
         BM    4(,RE)             INVALID IN MEANTIME --->     @D64ADOW 02184000
         N     R9,CHKNMSK         ...                          @D64ADOW 02185000
         LR    R2,R6              SAVE WORK REG                @D64ADOW 02186000
         LR    R5,RF              ...                          @D64ADOW 02187000
         LA    R6,VIRTAD          GET ADDR OF VIRTAD RTN       @D64ADOW 02188000
         BASSM R6,R6              TRANSLATE REAL TO VIRTUAL    @D64ADOW 02189000
*SGLINK VIRTAD,INPUT=(R6,R9),OUTPUT=RF                                  02190000
         LR    R9,RF              VIRTUAL ADDR TO CORRECT REG  @D64ADOW 02191000
         LR    R6,R2              RESTORE REGISTER             @D64ADOW 02192000
         LR    RF,R5              ...                          @D64ADOW 02193000
         SR    R5,R5                                           @D64ADOW 02194000
         IC    R5,LSTKPCN+3       GET EX                       @D64ADOW 02195000
         SLL   R5,5               GET DISPL IN ENTRY TABLE     @D64ADOW 02196000
         AR    R9,R5              VIRT ADDR OF ENTRY TAB ENTRY @D64ADOW 02197000
         USING ETE,R9                                          @D64ADOW 02198000
         ICM   R5,B'1111',ETEPARM GET ADDR OF LATENT PAR AREA  @D64ADOW 02199000
         BZ    4(,RE)             NO --->                      @D64ADOW 02200000
         USING LPA,R5                                          @D64ADOW 02201000
         ICM   R5,15,LPARR        IS ARR AVAILABLE             @D64ADOW 02202000
         BZ    4(,RE)             NO, --->                     @D64ADOW 02203000
         BR    RE                 YES                          @D64ADOW 02204000
         DROP  R4                                              @D64ADOW 02205000
         DROP  R5                                              @D64ADOW 02206000
         DROP  R9                                              @D64ADOW 02207000
         DROP  RA                                              @D65CDOW 02207000
         DROP  RD                                              @DY44889 02207500
         EJECT                                                          02208000
***      MVS ABEND CODES                                                02209000
         DS    0H                                              @D64ADMK 02210000
CHKAB01D DC    AL2(ABND01D)                                    @D64ADOW 02211000
CHKAB0C0 DC    AL2(ABND0C0)                                    @D64ADOW 02212000
CHKAB0D5 DC    AL2(ABND0D5)                                    @D64ADOW 02213000
CHKAB0D6 DC    AL2(ABND0D6)                                    @D64ADOW 02214000
CHKAB0D8 DC    AL2(ABND0D8)                                    @D64ADOW 02215000
CHKAB0F2 DC    AL2(ABND0F2)                                    @D64ADOW 02216000
CHKAB122 DC    AL2(ABND122)                                    @D64ADOW 02217000
CHKAB13E DC    AL2(ABND13E)                                    @D64ADOW 02218000
CHKAB222 DC    AL2(ABND222)                                    @D64ADOW 02219000
CHKAB2C5 DC    AL2(ABND2C5)                                    @D64ADOW 02220000
CHKAB33E DC    AL2(ABND33E)                                    @D64ADOW 02221000
         SPACE 3                                                        02222000
***      CONSTANTS                                                      02223000
         DS    0F                                              @D64ADOW 02224000
CHKABMSK DC    X'FF000FFF'                                     @D64ADOW 02225000
CHKNMSK  DC    X'7FFFFFC0'                                     @D64ADOW 02226000
CHKNLSMK DC    A(LSTKMASK)                                     @D64ADOW 02227000
CHKBAKRM DC    X'00E00000'                                     @D64ADOW 02228000
CHKPCMSK DC    X'00F00000'                                     @D64ADOW 02229000
CHKPROGM DC    X'0000007F'                                     @D64ADOW 02230000
         SPACE 3                                                        02231000
***      SUBROUTINE ADDRESSES                                           02232000
         DS    0F                                              @D64ADOW 02233000
CHKCLEAN DC    A(ABCLEANX)         ETXR/POST EXIT CLEAN-UP     @D64ADOW 02234000
         EJECT                                                          02235000
*********************************************************************** 02236000
*                                                                     * 02237000
*        AB EXIT WHEN USER ROUTINE AVAILABLE                          * 02238000
*           CALLED IN 31 BIT MODE                                     * 02239000
*                                                                     * 02240000
*********************************************************************** 02241000
         SPACE 1                                                        02242000
         USING TIBADR,R8                                       @D64ADOW 02243000
         USING TCBADR,RA                                       @D64ADOW 02244000
         USING ABROUT,RD                                       @D64ADOW 02245000
ABROUT   DS    0H                 ENTRY FROM SGAP (AB-EXIT)             02246000
*SGLINK  ABROUT,S,INPUT=(R8,RA,RD)                                      02247000
         CLI   TCBEXIFL,TCBEXIEX  ESTAEX ?                     @D64ADMK 02248000
         BE    ABESTAEX           YES, --> ESTAEX PREPARATION  @D64ADMK 02249000
***                                                                     02250000
***      ACTIVATE STXIT AB                                              02251000
***                                                                     02252000
         STM   R0,RF,SVCWORKA     SAVE CURRENT REGISTER        @D64ADOW 02253000
         L     R9,ASGMVSAP        GET BASE FOR SUBROUTINE      @D64ADOW 02254000
         USING SGMVSAPI,R9                                     @D64ADOW 02255000
         LA    RF,CLEANEX         ADDR OF SUBROUTINE           @D64ADOW 02256000
         O     RF,BIT0ON          FORCE 31 BIT MODE            @D64ADOW 02257000
         BASSM R7,RF              CALL ETXR/POST-EXIT CLEANUP  @D64ADOW 02258000
*SGLINK SGMAPICL,INPUT=(R7,R9,RA),WORK=(R1,R2,R5,R6,R8,RE,RF)           02259000
         DROP  R9                                              @DY45037 02259500
         LM    R0,RF,SVCWORKA     RESTORE REGISTER             @D64ADOW 02260000
*                                                                       02261000
         L     R7,TCBABEX         GET AB EXIT BLOCK ADDR       @D64ADMK 02262000
         USING EXITBLK,R7                                      @D64ADMK 02263000
         LM    R3,R4,EXITADR      GET AB ROUTINE & SAVE AREA   @D64ADMK 02264000
         USING SVUARA,R4                                       @D52GDIS 02265000
         SLR   R2,R2              CLEAR ADDITIONAL ERROR INFO  @D64ADOW 02266000
         TM    EXITFLG,EXITMSAV   NEW AB EXIT SAVE AREA LAYOUT?@D64ADOW 02267000
         BZ    ABROUT40           NO, RESET AB INFO IF ANY     @KD40187 02268000
         TM    EXITFLG,EXITMSGM   ADDITIONAL AB INFO ALREADY   @D64ADOW 02269000
         BO    ABROUT60           ... MOVED --->               @D64ADOW 02270000
         DROP  R7                                              @D64ADMK 02271000
         LA    R2,1               MOVE AND CLEAR ADD ERROR INFO@D64ADOW 02272000
         SPACE                                                          02273000
ABROUT40 DS    0H                                              @D64ADOW 02274000
         L     R9,AAMOVMSG        GET SUBROUTINE BASE          @D64ADOW 02275000
         BASR  RE,R9                                           @D64ADOW 02276000
*SGLINK ABMOVMSG,INPUT=(R2,R4,R8,R9,RA,RE),WORK=(R0,R2,R5,R6,R7,RF)     02277000
         L     R7,TCBABEX         RELOAD EXIT BLOCK ADDR       @D64ADMK 02278000
         USING EXITBLK,R7                                      @D64ADOW 02279000
ABROUT60 DS    0H                                              @D64ADOW 02280000
         L     RB,TCBSAVE         LOAD SAVE AREA POINTER       @D36IDFR 02281000
         SR    R0,R0              CLEAR REGISTER               @D35EDFR 02282000
         IC    R0,TIBCNCL         INSERT CANCEL CODE AND       @D36IDFR 02283000
         MVI   TIBCNCL,XFF        INDICATE AB IS ACTIVE        @D36IDFR 02284000
         L     R1,TCBATCBE        GET TCBX ADDR                @D64ADOW 02285000
         USING TCBXADR,R1                                      @D64ADOW 02286000
         DROP  R1                                              @D64ADOW 02287000
         LA    RE,TCBABACT        AB-EXIT ACTIV INDICATOR      @D61NDOW 02288000
         L     RC,ASGEXIT         GET BASE FOR SUBROUTINE      @D64ADOW 02289000
         L     R1,AEXITPRE-SGEXIT(,RC) ...                     @D64ADOW 02290000
         L     RC,ACOMSTXI-SGEXIT(,RC) ..                      @D64ADOW 02291000
         BASSM R5,R1              CALL EXIT PREPARATION        @D64ADOW 02292000
*SGLINK  EXITPREP,INPUT=(R0:ONLY_AB,R3,R4,R5,R7,RA,RB,RC,RE),          X02293000
               WORK=(R1,R8,R9,RE,RF)                                    02294000
         DROP  R4                                              @D64ADOW 02295000
         OI    TCBABEX,EXITACT    FLAG EXIT ROUT.TO BE ACTIVE  @D64ADMK 02296000
         L     RC,TCBATCBE        TCB EXTENSION ADDR           @D64ADOW 02297000
         USING TCBXADR,RC                                      @D64ADOW 02298000
         MVC   TCBX1CR3(4),EXABPKM RESTORE PKM AND SASN        @D64ADOW 02299000
         MVC   TCBX1CR8(2),EXABEAX RESTORE EAX                 @D64ADOW 02300000
         MVC   TCBX1CR4+2(2),EXABPASN RESTORE PASN             @D64ADOW 02301000
ABROUTEX DS    0H                                              @D64ADOW 02302000
         SLR   R4,R4                                           @D64ADOW 02303000
         ICM   R4,3,TCBX1CR3+2    GET SASN                     @D64ADOW 02304000
         L     R6,AABSEGMT        GET SUB-RTN ADDR             @D64ADOW 02305000
         BASR  R8,R6              GET RELATED SEGMENT-TAB ORIGI@D64ADOW 02306000
*SGLINK ABSEGMTO,INPUT=(R4,R6,R8,RA),OUTPUT=(R2,R4),WORK=(R3,R7)        02307000
         ST    R2,TCBX1CR7        UPDATE CR7                   @D64ADOW 02308000
         SLR   R4,R4                                           @D64ADOW 02309000
         ICM   R4,3,TCBX1CR4+2    GET PASN                     @D64ADOW 02310000
         L     R6,AABSEGMT        GET SUB-RTN ADDR             @D64ADOW 02311000
         BASR  R8,R6              GET RELATED SEGMENT-TAB ORIGI@D64ADOW 02312000
*SGLINK ABSEGMTO,INPUT=(R4,R5,R8,RA),OUTPUT=(R2,R4),WORK=(R3,R7)        02313000
         ST    R2,TCBX1CR1        UPDATE CR1                   @D64ADOW 02314000
         LRA   R7,0(,R4)          GET REAL ASTE ADDR           @D64ADOW 02315000
         N     R7,ABROUTMK        ... AS PASTEO                @D64ADOW 02316000
         ST    R7,TCBX1CR5        .. TO CR5                    @D64ADOW 02317000
         TM    SYSFLAG2,IPLBIT    IPL IN PROCESS               @D64ADOW 02318000
         BNO   EXIT               NO  ---> EXIT TO DISP        @D64ADOW 02319000
         CLC   TCBX1CR1,TCBX1CR7  CHECK HASN=SASN=PASN         @D64ADOW 02320000
         BNE   ABROUTHW           NE ---> HARDWAIT             @D64ADOW 02321000
         CLC   TCBX1CR1,TCBX1CRD  ...                          @D64ADOW 02322000
         BE    EXIT               EQUAL ---> EXIT TO DISP      @D64ADOW 02323000
ABROUTHW DS    0H                                              @D64ADOW 02324000
         STCM  R5,B'1111',*+8                                  @D64ADOW 02325000
         BAS   R5,SYSERROR                                     @D64ADOW 02326000
         DC    X'00000000'                                     @D64ADOW 02327000
         DS    0F                                              @D64ADOW 02328000
ABROUTMK DC    X'7FFFFFC0'                                     @D64ADOW 02329000
         DROP  R7                                              @D64ADOW 02330000
         DROP  R8                                              @D64ADOW 02331000
         DROP  RC                                              @D64ADOW 02332000
         EJECT                                                          02333000
****************************************************************        02334000
*                                                              *        02335000
*        ACTIVATE ESTAEX                                       *        02336000
*                 ARR                                          *        02337000
*                 FRR                                          *        02338000
*                 FESTAE                                       *        02339000
*                                                              *        02340000
****************************************************************        02341000
         SPACE                                                          02342000
ABESTAEX DS    0H                                              @D64ADMK 02343000
         L     RC,TCBATCBE        GET ADDR OF                  @D64ADOW 02344000
         USING TCBXADR,RC         ... PSEUDO                   @D64ADOW 02345000
         L     RC,PTCBAPTC        ... TCB-EXTENSION            @D64ADOW 02346000
         ICM   R5,B'1111',PTCBEACT AB-COND IN AN AB-TYPE EXIT  @D64ADOW 02347000
         BZ    ABEST020           NO --->                      @D64ADOW 02348000
         L     R9,PTCBESEL        GET SELECTED EXIT            @D64ADOW 02349000
         L     RB,PTCBEXSL        ... CURRENT                  @D64ADOW 02350000
         L     R3,PTCBEXRL        ... EXIT                     @D64ADOW 02351000
         IC    R4,PTCBEXFL        ... INDICATIONS              @D64ADOW 02352000
         LR    R5,RC              SAVE CURRENT PSEUDO TCBX     @D64ADOW 02353000
         LA    R0,PTCBLENG        LENGTH OF PSEUDO TCBX        @D64ADOW 02354000
         LA    RF,16              SETUP FUNCTION CODE          @D64ADOW 02355000
***                               SYSTEM GETVIS, LOC=ANY                02356000
         L     RC,ASGEXIT         GET BASE OF                  @D64ADOW 02357000
         L     RC,AEXITGVI-SGEXIT(,RC) ... SUBROUTINE          @D64ADOW 02358000
         BASSM R8,RC              RETRIEVE STOR FOR PSEUDO TCBX@D64ADOW 02359000
*SGLINK  EXITGVIS,INPUT=(R0,R8,RA,RC,RF),OUTPUT=(R1,RF),WORK=R0         02360000
         L     RC,TCBATCBE        RELOAD ADDR OF               @D64ADOW 02361000
         L     RC,PTCBAPTC        ... TCB-EXTENSION            @D64ADOW 02362000
         LTR   RF,RF                                           @D64ADOW 02363000
         BZ    ABEST010           STORAGE RETRIEVED --->       @D64ADOW 02364000
         OI    PTCBFLG1,PTCBNPSD  NO STORAGE AVAILABLE FOR     @DY44889 02365590
***                               PSEUDO-TCBX. SKIP ALL AB-TYPE EXIT    02366180
***                               RTN'S OF THIS NESTING LEVEL. PASS     02366770
***                               LATEST ERROR TO NEXT AB-TYPE EXIT RTN 02367360
         B     ABEST020                                        @D64ADOW 02367950
ABEST010 DS    0H                                              @D64ADMK 02369000
         LR    RC,R1              GET START-                   @D64ADOW 02370000
         LA    R0,PTCBPFIX        ... ADDR OF NEW              @D64ADOW 02371000
         SLR   RC,R0              ... PSEUDO TCBX              @D64ADOW 02372000
         ST    R5,PTCBAPTC        REMEMBER PREVIOUS PSEUDO TCBX@D64ADOW 02373000
         ST    R9,PTCBESEL        PASS CURRENT                 @D64ADOW 02374000
         ST    RB,PTCBEXSL        ... EXIT                     @D64ADOW 02375000
         ST    R3,PTCBEXRL        ... INDICATIONS              @D64ADOW 02376000
         STC   R4,PTCBEXFL        ... TO NEW PSEUDO TCBX       @D64ADOW 02377000
         L     R1,TCBATCBE        LET TCBX POINT               @D64ADOW 02378000
         ST    RC,PTCBAPTC-TCBXADR(,R1) .. TO NEW PSEUDO TCBX  @D64ADOW 02379000
ABEST020 DS    0H                                              @D64ADOW 02380000
***                                                                     02381000
***      SAVE STATUS WHEN AB CONDITION IS RAISED                        02382000
***                                                                     02383000
         L     R8,TIBPTR                                       @D64ADOW 02384000
         USING TIBADR,R8                                       @D64ADOW 02385000
         IC    R8,TIBCNCL         GET CANCEL CODE              @D64ADOW 02386000
         DROP  R8                                              @D64ADOW 02387000
         STC   R8,PTCBEXCC        SAVE VSE-CANCEL CODE         @D64ADOW 02388000
         MVC   PTCBEXEI(1),TCBEXITF SAVE EXIT INDICATOR        @D64ADOW 02389000
         NI    TCBEXITF,TCBPOACT+TCBEXACT KEEP ETXR/POST-EXIT  @D64ADOW 02390000
***                               ... INDICATOR TO AVOID SCHEDULING     02391000
***                               ... OF NEXT ETXR/POST EXIT            02392000
         OI    TCBEXITF,TCBABACT  SET AB-EXIT INDICATOR        @D64ADOW 02393000
         L     RB,TCBSAVE         GET USER SAVE AREA           @D64ADMK 02394000
         USING SVEARA,RB                                       @D64ADMK 02395000
         MVC   PTCBEXPS(8),SVEPSW SAVE FAILING PSW             @D64ADOW 02396000
         MVC   PTCBINFO(4),INTINFO SAVE INTERRUPTION CODE      @D64ADOW 02397000
         MVC   PTCBMVSI(4),TCBMVSIS ...                        @D64ADOW 02398000
         L     RF,TCBATCBE        GET CURRENT LINK STCK        @D64ADOW 02398300
         L     RF,TCBX1CRF-TCBXADR(,RF) ... ENTRY ADDRESS      @D64ADOW 02398600
         L     RC,ASGEXIT         GET ADDR OF                  @D64ADOW 02399000
         L     RC,ACURLSTK-SGEXIT(,RC) ... SUBROUTINE          @D64ADOW 02400000
         BASSM R8,RC              CHECK FOR CURR LINK STACK LEV@D64ADOW 02401000
*SGLINK CCURLSTK,INPUT=(R8,RA,RC,RF),OUTPUT=RC                          02402490
         LR    R8,RC              SAVE OUTPUT (CURRENT LS LEVEL@D64ADOW 02403000
         L     RC,TCBATCBE        RELOAD                       @D64ADOW 02404000
         L     RC,PTCBAPTC        ... PSEUDO TCB-EXTENSION     @D64ADOW 02405000
         ST    R8,PTCBEXLI        SAVE LINKAGE STACK LEVEL     @D64ADOW 02406000
         ICM   R8,B'1111',PSATOLD MVS EMULATION ACTIVE         @D64ADOW 02407000
         BZ    ABEST030           NO,                          @D64ADOW 02408000
         L     R8,TCBRBP-TCB(,R8) GET CURRENT RB/SVRB          @D64ADOW 02409000
ABEST030 DS    0H                                              @D64ADOW 02410000
         ST    R8,PTCBEXRL        SAVE RB ADDR IN TCBX         @D64ADOW 02411000
         L     R8,TCBATCBE        ADDR OF TCB EXTENSION        @D64ADOW 02412000
         MVC   PTCBEXPK(4),TCBX1CR3-TCBXADR(R8) SAVE PKM,SASN  @D64ADOW 02413000
         MVC   PTCBEXEA(2),TCBX1CR8-TCBXADR(R8) SAVE EAX       @D64ADOW 02414000
         MVC   PTCBEXPA(2),TCBX1CR4+2-TCBXADR(R8) SAVE PASN    @D64ADOW 02415000
         LA    R7,TCBABEX-(EXITNEXT-EXITADR) ANCHOR TO         @D64ADOW 02416000
***                               AB-TYPE EXITS (STXIT AB, ESTAEX)      02417000
         SLR   R2,R2              SET INDICATOR ONLY RESET     @D64ADOW 02418000
***                               ADDITIONAL ERROR INFO                 02419000
ABEST040 DS    0H                                              @D64ADOW 02420000
         USING EXITBLK,R7                                      @D64ADOW 02421000
         L     R7,EXITNEXT        NEXT AB-TYPE EXIT BLOCK      @D64ADOW 02422000
         LA    R7,0(,R7)                                       @D64ADOW 02423000
         LTR   R7,R7              END OF CHAIN                 @D64ADOW 02424000
         BZ    ABEST050           YES, --->                    @D64ADOW 02425000
         CLI   EXITFLG2,EXESTAEX  IS IT A ESTAEX               @D64ADOW 02426000
         BE    ABEST040           YES                          @D64ADOW 02427000
***                               NO, SAVE ERROR INFO INTO SAVE AREA    02428000
***                               ... OF EXIT DEFINED WITH STXIT AB     02429000
         L     R4,EXITSAV         GET EXIT SAVE AREA ADDR      @D64ADOW 02430000
         USING SVUARA,R4                                       @D64ADOW 02431000
***                               SAVE FROM TIME OF FAILURE             02432000
         MVC   EXITSPSW,SVEPSW    ... PSW                      @D64ADOW 02433000
         MVC   EXITSACT,TCBEXITF  ... EXIT INDICATOR           @DY45190 02433500
         MVC   SVUR00(36),SVER00  ... REG 0 TILL REG 8         @D64ADOW 02434000
         MVC   SVUR09(28),SVER09  ... REG 9 TILL REG 15        @D64ADOW 02435000
         L     R8,INTINFO         ... INTERRUPT INFORMATION    @D64ADOW 02436000
         ST    R8,SVUPSW          ...                          @D64ADOW 02437000
         TM    EXITFLG,EXITMSAV   EXIT WITH EXTENDED SAVE AREA @D64ADOW 02438000
         BNO   ABEST050           NO, --->                     @D64ADOW 02439000
         L     R8,TCBARSAV        ... MOVE ACCESS              @D64ADOW 02440000
         MVC   SVUAREG,0(R8)      ... REGISTER                 @D64ADOW 02441000
         OI    EXITFLG,EXITMSGM   INDICATE MESSAGE MOVED       @D64ADOW 02442000
         LA    R5,SVUABINF        ADD CANCEL INFO IN SAVE AREA @D64ADOW 02443000
         DROP  R4                                              @D64ADOW 02444000
         DROP  R7                                              @D64ADOW 02445000
         DROP  RB                                              @D64ADOW 02446000
         SPACE                                                          02447000
         L     R8,TIBPTR          GET TIB OF CURRENT TASK      @D64ADOW 02448000
         L     R6,ADISPSER        GET ADDRESS OF DISP.SERVICES @D64ADMK 02449000
         LA    R0,24              GET FUNCTION CODE            @D64ADMK 02450000
         BASSM R7,R6              RETRIEVE MSG INFO            @D64ADOW 02451000
*SGLINK  DISPSE24,INPUT=(R0:FCT_CODE,R5,R6:DISPSERV_BASE,              X02452000
               R7:RETURN_ADDR,R8:TIB_ADDR,RA:TCB_ADDR),                X02453000
               WORK=(R0,R2,RF)                                          02454000
         B     ABEST050           RETURN IF MSG MOVED          @D64ADOW 02455000
*        B     ABEST050           RETURN IF MSG NOT MOVED      @D64ADOW 02456000
***END OF BRANCH TABLE                                                  02457000
         SPACE                                                          02458000
***                                                                     02459000
***      CHECK IF RETRY ALLOWED OR PERCOLATE REQUIRED                   02460000
***                                                                     02461000
ABEST050 DS    0H                                              @D64ADOW 02462000
         TM    PTCBEXEI,TCBPOACT+TCBEXACT ANY POST|ETXR EXIT AC@D64ADOW 02463000
         BNZ   ABEST060          YES, --->                     @D64ADOW 02464000
         TM    TCBEXITG,TCBDTACH DETACH BY OWNING TASK         @D64ADOW 02465000
         BO    ABEST060          YES, --->                     @D64ADOW 02466000
         CLI   PTCBEXCC,CANCX24  OPERATOR CANCEL               @D64ADOW 02467000
         BE    ABEST060           YES -->                      @D64ADOW 02468000
         CLI   PTCBEXCC,CANCX08  POWER PFLUSH                  @D64ADOW 02469000
         BE    ABEST060           YES -->                      @D64ADOW 02470000
*        CLI   PTCBEXCC,CANCX0B  CANCEL REQ DUE TO SEC VIOLATIO@DY46116 02471000
*        BE    ABEST060          YES,                          @DY46116 02472000
         CLI   PTCBEXCC,CANCX1D                                @D64ADOW 02475000
         BNE   ABEST070           NO --->                      @D64ADOW 02476000
ABEST060 DS    0H                                              @D64ADMK 02477000
         OI    PTCBFLG1,TCBXPONY  ALLOW ONLY PERCOLATE. IF     @D64ADOW 02478000
***                               PERCOLATE IS SET, DO NOT RESET FOR    02479000
***                               FURTHER CANCEL CONDITIONS             02480000
ABEST070 DS    0H                                              @D64ADMK 02481000
         NI    TCBEXITG,XFF-TCBDSTAE-TCBDTACH                  @D64ADOW 02482000
***                                                                     02483000
***      PREPARE SDWA                                                   02484000
***                                                                     02485000
         ICM   R1,B'1111',PTCBSDWA MASTER SDWA ALREADY AVAILABL@D64ADMK 02486000
         BNZ   ABEST100           YES, --->                    @D64ADOW 02487000
         LA    RF,16              FCT CODE FOR SGETVIS         @D64ADOW 02488000
***                               LOC=ANY, SYSTEM GETVIS                02489000
         LA    R0,SDWATLEN                                     @D64ADOW 02490000
         L     RC,ASGEXIT         GET BASE OF                  @D64ADOW 02491000
         L     RC,AEXITGVI-SGEXIT(,RC) ... SUBROUTINE          @D64ADOW 02492000
         BASSM R8,RC              RETRIEVE STORAGE(MASTER SDWA)@D64ADOW 02493000
*SGLINK  EXITGVIS,INPUT=(R0,R8,RA,RC,RF),OUTPUT=(R1,RF),WORK=R0         02494000
         L     RC,TCBATCBE        ADDR OF                      @D64ADOW 02495000
         L     RC,PTCBAPTC        ... PSEUDO TCB-EXTENSION     @D64ADOW 02496000
         LTR   RF,RF              SDWA RETRIEVED               @D64ADMK 02497000
         BNZ   ABEST200           NO                           @D64ADMK 02498000
         ST    R1,PTCBSDWA        STORE SDWA PTR               @D64ADMK 02499000
         USING SDWA,R1            ADDRESSABILITY               @D64ADMK 02500000
         B     ABEST150                                        @D64ADOW 02502000
         SPACE                                                          02503000
ABEST100 DS    0H                                              @D64ADMK 02504000
         LR    R8,R1              COPY SDWA ADDR               @D64ADOW 02505000
         LA    R9,SDWATLEN        LENGTH OF SDWA               @D64ADOW 02506000
         SLR   RF,RF              INITIALIZE FOR CLEAR         @D64ADOW 02507000
         MVCL  R8,RE              CLEAR SDWA                   @D64ADOW 02508000
ABEST150 DS    0H                                              @D64ADMK 02509000
         L     R5,AABSDWAI        GET SUBROUTINE BASE          @D64ADOW 02510000
         BASR  R8,R5              INITIALIZE SDWA POINTERS     @D64ADOW 02511000
*SGLINK ABSDWAIN,S,INPUT=(R1,R4,R8),WORK=(RB,RF)                        02512000
         SPACE                                                          02513000
         L     R4,AABFILLS        GET SUBROUTINE BASE          @D64ADOW 02514000
         BASR  R3,R4              FILL SDWA WITH ERROR INFORMAT@D64ADOW 02515000
*SGLINK ABFILLSD,INPUT=(R1,R3,R4,RA,RC),                               X02516000
               WORK=(R0,R2,R5,R6,R7,R8,R9,RB,RE,RF)                     02517000
         SPACE                                                          02518000
         DROP  R1                                              @D64ADMK 02519000
ABEST200 DS    0H                 ENTRY POINT FROM PERCOLATE   @D64ADOW 02520000
         CLI   PTCBEXFL,TCBEXFRR  FRR TO BE ACTIVATED          @D64ADOW 02521000
         BE    ABEST205           YES--->                      @D64ADOW 02522000
         L     R8,AACLEANX        GET SUBROUTINE ADDR          @D64ADOW 02523000
         BASR  R7,R8              ETXR/POST EXIT CLEAN-UP      @D64ADOW 02524000
*                                                                       02525000
*        DISPMAC FUNC=FREELOCK    FREE LOCKS                            02526000
         DISPMAC FUNC=FREELOCK                                 @D64ADOW 02527000
*                                                                       02528000
         L     R8,TIBPTR                                       @D64XDOW 02529000
         USING TIBADR,R8                                       @D64XDOW 02530000
         TM    TIBFLAG1,LTAOWNER  LTA OCCUPIED BY TASK         @D64ADOW 02531000
         BNO   ABEST205           NO --->                      @D64ADOW 02532000
         L     R6,DISPAD          SETUP INPUT REGISTER         @D64ADOW 02533000
         USING DISP,R6                                         @D64ADOW 02534000
         BAS   R7,FREELTA         FREE LTA                     @D64ADOW 02535000
*SGLINK FREELTA,INPUT=(R6,R7,R8,RA),WORK=(R5,RE,RF)                     02536000
         DROP  R6                                              @D64ADOW 02537000
         DROP  R8                                              @D64ADOW 02538000
ABEST205 DS    0H                                              @D64ADOW 02539000
         L     R7,PTCBESEL        FRR STACK ENTRY IF FRR       @D64ADOW 02540000
***                               OR EXIT BLOCK ADDR IF ESTAEX          02541000
***                               OR RB ADDR IF FESTAE                  02542000
***                               OR ETE ADDR IF ARR                    02543000
***                               SET UP TASK SAVE AREA                 02544000
         ST    R7,PTCBEACT        STXIT AB BECOMES ACTIVE      @D64ADOW 02545000
         MVC   PTCBEXSA,PTCBEXSL  ...                          @D64ADOW 02548000
         MVC   PTCBEXRA,PTCBEXRL  ...                          @D64ADOW 02549000
         MVC   PTCBEXFA,PTCBEXFL  ...                          @D64ADOW 02550000
         TM    PTCBFLG1,PTCBNPSD  COULD ERROR BE SAVED IN      @DY44889 02551490
***                               ... NEW PSEUDO TCB EXTENSION          02552000
         BO    ABEST700           NO, SKIP NESTED ESTAEX-TYPE  @DY44889 02553490
***                               ...ESTAEX-TYPE EXIT AND PERCOLATE     02554000
***                               ...TO NEXT ESTAEX-TYPE EXIT           02555000
         L     RB,TCBSAVE         GET USER SAVE AREA           @D64ADMK 02563000
         USING SVEARA,RB                                       @D64ADOW 02564000
         MVI   SVEPSW,ENABLE+DATMASK MAKE 1ST PSW-BYTE CORRECT @D64ADMK 02565000
         MVI   SVEPSW+3,X00       MAKE PSW BYTE 3 CORRECT      @D64ADMK 02566000
         L     R9,TCBARSAV        GET ADDR OF ACC REG SAVEAREA @D64ADOW 02567000
         XC    0(TCBARSLN,R9),0(R9) ... AND CLEAR AREA         @D64ADOW 02568000
         CLI   PTCBEXFA,TCBEXABT  ESTAEX TO BE ACTIVATED       @D64ADOW 02569000
         BNE   ABEST300           NO, --->                     @D64ADOW 02570000
***                                                                     02571000
***      PROCESS ESTAEX                                                 02572000
***                                                                     02573000
         USING EXITBLK,R7                                      @D64ADOW 02574000
         L     R4,EXITADR         GET EXIT ADDRESS             @D64ADMK 02575000
         MVC   EXITSPSW,PTCBEXPS  SAVE PSW TO EXIT BLOCK       @D64ADOW 02576000
         MVC   EXITSLSK,PTCBEXLI  ... CURRENT LINK STACK       @D64ADOW 02577000
         ICM   R8,B'1111',PSATOLD MVS EMULATION ACTIVE         @D64ADOW 02578000
         BZ    ABEST210           NO --->                      @D64ADOW 02579000
         NI    EXITSFLG,XFF-EXFESDEF                           @D64ADOW 02580000
         L     R8,TCBRBP-TCB(,R8) GET CURRENT RB ADDR          @D64ADOW 02581000
         ST    R8,EXITSRB         SAVE CURRENT RB ADDR         @D64ADOW 02582000
         OC    RBSEXIT-RBSECT(4,R8),RBSEXIT-RBSECT(R8) FESTEA  @D64ADOW 02583000
****                              ALREADY DEFINED                       02584000
         BZ    ABEST210           NO --->                      @D64ADOW 02585000
         OI    EXITSFLG,EXFESDEF  INDICATE FESTAE DEFINED      @D64ADOW 02586000
ABEST210 DS    0H                                              @D64ADOW 02587000
         MVC   EXITSACT(1),PTCBEXEI SAVE INTERRUPTED EXIT INDIC@D64ADOW 02588000
         MVC   SVEPSW+1(1),EXITKEY PREPARE PSW WITH STATE AND  @D64ADMK 02589000
***                               KEY FROM THAT AT EXIT DEFINITION      02590000
         MVC   SVEPSW+2(2),PTCBEXPS+2 COPY ASC MODE AND        @D64ADOW 02591000
***                               PROGRAM MASK FROM TIME OF ERROR       02592000
         NI    SVEPSW+2,X3F       FORCE PRIMARY ASC MODE       @D64ADOW 02593000
         TM    EXITASCM,X40       ESTAEX GIVEN IN AR-MODE      @D64ADOW 02594000
         BZ    ABEST220           NO --->                      @D64ADOW 02595000
         OI    SVEPSW+2,X40       SET AR MODE                  @D64ADOW 02596000
ABEST220 DS    0H                                              @D64ADOW 02597000
         OI    EXITADR,EXITACT    SET EXIT ACTIVE              @D64ADMK 02598000
         O     R4,BIT0ON          DISPATCH EXIT IN 31 BIT MODE @D64ADOW 02599000
         L     R8,TCBATCBE        GET TCBX ADDR                @D64ADOW 02600000
         DROP  RC                                              @D64ADOW 02601000
         USING TCBXADR,R8                                      @D64ADOW 02602000
         MVC   TCBX1CR3(4),EXABPKM SET CORRECT PKM AND SASN    @D64ADOW 02603000
         MVC   TCBX1CR8(2),EXABEAX SET CORRECT EAX             @D64ADOW 02604000
         MVC   TCBX1CR4+2(2),EXABPASN SET CORRECT PASN         @D64ADOW 02605000
         DROP  R8                                              @D64ADOW 02606000
         USING TCBXADR,RC                                      @D64ADOW 02607000
         LM    R2,R3,EXABPARM     ESTAEX PARAMETER             @D64ADOW 02608000
         LA    RE,EXABPARM        ADDRESS OF PARAM FIELD       @D64ADOW 02609000
         DROP  R7                                              @D64ADOW 02610000
         B     ABEST600                                        @D64ADOW 02611000
ABEST300 DS    0H                                              @D64ADOW 02612000
         CLI   PTCBEXFA,TCBEXFRR  FRR TO BE ACTIVATED          @D64ADOW 02613000
         BNE   ABEST400           NO, --->                     @D64ADOW 02614000
***                                                                     02615000
***      PROCESS FRR                                                    02616000
***                                                                     02617000
         ICM   RF,B'1111',PTCBSDWA SDWA AVAILABLE              @D64ADOW 02618000
         BZ    ABEST700           NO PERCOLATE TO NEXT ESTAEX  @D64ADOW 02619000
         XC    PTCBEXSV,PTCBEXSV  CLEAR SAVE AREA              @D64ADOW 02620000
         USING FRRSENTR,R7                                     @D64ADOW 02621000
         ICM   R4,B'1111',FRRSFRRA GET FRR ADDRESS WITH AMODE  @D64ADOW 02622000
***                               AT FRR DEFINITION                     02623000
         BNM   ABEST310                                        @D64ADOW 02624000
         OI    PTCBEXSV,X80       REMEMBER AMODE WAS 31        @D64ADOW 02625000
ABEST310 DS    0H                                              @D64ADOW 02626000
         MVC   PTCBEXSV+1(1),FRRSFLG3 SAVE ASC MODE FROM SETFRR@D64ADOW 02627000
         LA    R9,FRRSESZE                                     @D64ADOW 02628000
         AR    R9,R7              GET FRR ENTRY EXTENSION      @D64ADOW 02629000
         USING FRRSXENT,R9                                     @D64ADOW 02630000
         LA    R2,FRRSPARM        GET ADDR OF PARAM            @D64ADOW 02631000
         SLR   R3,R3                                           @D64ADOW 02632000
         MVI   SVEPSW,DATMASK     ENTER FRR IN DISABLED STATE  @D64ADOW 02633000
         TM    PTCBEXPS,ENABLE    ENABLED AT TIME OF ERROR     @D64ADOW 02634000
         BZ    ABEST320           NO --->                      @D64ADOW 02635000
         OI    SVEPSW,ENABLE      YES, FRR RUNS ENABLED        @D64ADOW 02636000
ABEST320 DS    0H                                              @D64ADOW 02637000
         MVI   SVEPSW+1,X0C       SUPERVISOR STATE AND KEY 0   @D64ADOW 02638000
         MVI   SVEPSW+2,X00       SET PROGRAM MASK ZERO        @D64ADOW 02639000
**                                ... AND PRIMARY ASC MODE              02640000
         TM    FRRSFLG3,X02       AR MODE AT FRR DEFINITION    @D64ADOW 02641000
         BZ    ABEST325                                        @D64ADOW 02642000
         MVI   SVEPSW+2,X40       SET PROGRAM MASK ZERO        @D64ADOW 02643000
**                                ... AND AR-MODE                       02644000
ABEST325 DS    0H                                              @D64ADOW 02645000
         L     R8,TCBATCBE        GET TCBX ADDR                @D64ADOW 02646000
         MVC   TCBX1CR8-TCBXADR(2,R8),FRREAX SET CORRECT EAX   @D64ADOW 02647000
         MVC   PTCBEXSV+2(2),FRREAX ... AND SAVE IT            @D64ADOW 02648000
         MVC   PTCBEXSV+4(4),FRRLS  ... AND SAVE LINK STACK    @D64ADOW 02649000
         LH    R5,FRRSSAS         GET SASN FROM TIME OF FRR DEF@D64ADOW 02650000
         LH    RE,FRRSPAS         GET PASN FROM TIME OF FRR DEF@D64ADOW 02651000
         TM    FRRSFLG4,FRRSFULL  MODE=FULLXM SPECIFIED        @D64ADOW 02652000
         BO    ABEST330           YES                          @D64ADOW 02653000
         LH    RE,PIK             GET CURRENT PARTITION ID     @D64ADOW 02654000
         SRL   RE,4               ... AND RETRIEVE SASN=HASN   @D64ADOW 02655000
         LR    R5,RE              ... AND RETRIEVE PASN=HASN   @D64ADOW 02656000
ABEST330 DS    0H                                              @D64ADOW 02657000
         STH   R5,TCBX1CR3+2-TCBXADR(,R8) SET UP SASN          @D64ADOW 02658000
         STH   RE,TCBX1CR4+2-TCBXADR(,R8) SET UP PASN          @D64ADOW 02659000
         SLR   R5,R5              GET PKM FROM TIME            @D64ADOW 02660000
         ICM   R5,12,FRRSKM       ... OF FRR DEFINITION        @D64ADOW 02661000
         TM    FRRSFLG4,FRRSFULL  MODE=FULLXM SPECIFIED        @D64ADOW 02662000
         BO    ABEST350           YES                          @D64ADOW 02663000
         SLR   RE,RE                                           @D64ADOW 02664000
         L     R5,PSATOLD         GET MVS TCB                  @D64ADOW 02665000
         IC    RE,TCBPKF-TCB(,R5) GET STORAGE KEY OF TASK      @D64ADOW 02666000
         SRL   RE,4               RETRIEVE PKM FOR TASK        @D64ADOW 02667000
         L     R5,BIT0ON          ...                          @D64ADOW 02668000
         SRL   R5,0(RE)           ...                          @D64ADOW 02669000
ABEST350 DS    0H                                              @D64ADOW 02670000
         STCM  R5,12,TCBX1CR3-TCBXADR(R8) PKM TO CR3           @D64ADOW 02671000
         MVC   PTCBEXSV+8(8),TCBX1CR3-TCBXADR(R8) SAVE PKM,    @D64ADOW 02672000
***                               SASN AND PASN                         02673000
         LA    RE,FRRSPARM        ADDR OF PARAM AREA           @D64ADOW 02674000
         DROP  R7                                              @D64ADOW 02675000
         DROP  R9                                              @D64ADOW 02676000
         B     ABEST600                                        @D64ADOW 02677000
ABEST400 DS    0H                                              @D64ADMK 02678000
         CLI   PTCBEXFA,TCBEXARR  ARR TO BE ACTIVATED          @D64ADOW 02679000
         BNE   ABEST500           NO, --->                     @D64ADOW 02680000
***                                                                     02681000
***      PROCESS ARR                                                    02682000
***                                                                     02683000
         USING ETE,R7                                          @D64ADOW 02684000
         L     R9,ETEPARM                                      @D64ADOW 02685000
         USING LPA,R9                                          @D64ADOW 02686000
         L     R4,LPARR           GET ARR ADDR                 @D64ADOW 02687000
         O     R4,BIT0ON          DISPATCH EXIT IN 31 BIT MODE @D64ADOW 02688000
         DROP  R9                                              @D64ADOW 02689000
         L     R9,PTCBEXSA        GET LINK STACK OF ARR        @D64ADOW 02690000
         LA    RE,LSTATLN1        LENGTH OF ENTRY MIN DESCRIPTO@D64ADOW 02691000
         SLR   R9,RE              BACK TO BEGIN OF ENTRY       @D64ADOW 02692000
         USING LSTKSTAT,R9                                     @D64ADOW 02693000
         LH    R3,PIK             GET CURRENT PARTITION ID     @D64ADOW 02694000
         SRL   R3,4               ... AND RETRIEVE HASN        @D64ADOW 02695000
         CH    R3,LSTKPASN        HASN=PASN, I.E. PC GIVEN     @D64ADOW 02696690
***                               ... IN X-MEMORY MODE                  02697380
         BNE   ABEST700           NO, SKIP ARR                 @DY44889 02698070
         CH    R3,LSTKSASN        HASN=SASN                    @D64ADOW 02699000
         BNE   ABEST700           NO, SKIP ARR                 @DY44889 02701990
ABEST420 DS    0H                                              @D64ADOW 02704000
         L     R8,AABSETAR        GET ROUTINE BASE             @D64ADOW 02705000
         BASR  RE,R8              SET UP ARR ENVIRONMENT       @D64ADOW 02706000
         LA    RE,LSTKMARE        POINT TO MODIFIABLE AREA     @D64ADOW 02707000
         LM    R2,R3,LSTKMARE     GET MODIFIABLE AREA          @D64ADOW 02708000
         DROP  R7                                              @D64ADOW 02709000
         DROP  R9                                              @D64ADOW 02710000
         B     ABEST600           --->                         @D64ADOW 02711000
***                                                                     02712000
***      PROCESS FESTAE                                                 02713000
***                                                                     02714000
ABEST500 DS    0H                 MUST BE FESTAE               @D64ADOW 02715000
         L     R4,RBSEXIT-RBSECT(,R7) GET FESTAE ENTRY POINT   @D64ADOW 02716000
         L     RE,RBSXPARM-RBSECT(,R7) PARAM IN 31 BIT MODE    @D64ADOW 02717000
         TM    RBSFLGS2-RBSECT(R7),RBSAMODE FESTAE IN 31BIT MOD@D64ADOW 02718000
         BO    ABEST510           YES --->                     @D64ADOW 02719000
         SLR   RE,RE              INITIALIZE                   @D64ADOW 02720000
         ICM   RE,7,RBSPARMA-RBSECT(R7) PARAM IN 24 BIT MODE   @D64ADOW 02721000
ABEST510 DS    0H                                              @D64ADOW 02722000
         LR    R2,RE              ... COPY PARAM ADDR          @D64ADOW 02723000
         SLR   R3,R3              NO AR VALUE FOR PARAM        @D64ADOW 02724000
         L     R8,TCBATCBE        GET TCBX ADDR                @D64ADOW 02725000
         MVI   SVEPSW+1,X0C       SUPERVISOR STATE AND KEY 0   @D64ADOW 02726000
         MVC   TCBX1CR3-TCBXADR(2,R8),PTCBEXPK SET PKM FROM    @D64ADOW 02727000
***                               ... TIME OF ERROR                     02728000
         LH    R9,PIK             GET HASN OF TASK             @D64ADOW 02729000
         SRL   R9,4               ...                          @D64ADOW 02730000
         STH   R9,TCBX1CR3+2-TCBXADR(,R8) SET UP SASN          @D64ADOW 02731000
         STH   R9,TCBX1CR4+2-TCBXADR(,R8) SET UP PASN          @D64ADOW 02732000
         TM    RBSFLGS2-RBSECT(R7),RBSAMODE IS 31 BIT MODE REQD@D64ADOW 02733000
         BNO   ABEST540           NO, --->                     @D64ADOW 02734000
         O     R4,BIT0ON          FORCE 31 BIT MODE            @D64ADOW 02735000
ABEST540 DS    0H                                              @D64ADOW 02736000
         MVC   SVEPSW+2(2),PTCBEXPS+2 PROG MASK AT TIME OF ERRO@D64ADOW 02737000
         NI    SVEPSW+2,X3F       FORCE PRIMARY ASC MODE       @D64ADOW 02738000
         LA    R0,RBSECT-RBPREFIX ADDRESS PREFIX OF RB         @D64ADOW 02739000
         LR    R5,R7              ...                          @D64ADOW 02740000
         SLR   R5,R0              ...                          @D64ADOW 02741000
         L     R9,RBXSB-RBPREFIX(,R5) GET XSB ADDR             @D64ADOW 02742000
         MVC   TCBX1CR8-TCBXADR(2,R8),XSBEAX-XSBBEGIN(R9) EAX  @D64ADOW 02743000
***      B     ABEST600                                                 02743300
***                                                                     02743600
ABEST600 DS    0H                                              @D64ADMK 02744000
         L     R8,TIBPTR                                       @D64XDOW 02745000
         USING TIBADR,R8                                       @D64XDOW 02746000
         TM    TIBFLAG5,TIBXMEMC  TASK CANCELED IN X-MEMORY MOD@D64XDOW 02747000
         DROP  R8                                              @D64XDOW 02748000
         BNO   ABEST610           NO --->                      @D64XDOW 02749000
         L     R8,TCBATCBE        GET TCB-EXTENSION ADDR       @D64XDOW 02750000
         CLC   TCBX1CR3+2-TCBXADR(2,R8),TCBX1CR4+2-TCBXADR(R8) @D64XDOW 02751000
***                               ... IS PASN=SASN                      02752000
         BNE   ABEST700           NO ---> SKIP AB-TYPE EXIT    @D64XDOW 02753000
         LH    RF,PIK             GET PARTITION ID             @D64XDOW 02754000
         SRL   RF,4               ... AND RETRIEVE HASN        @D64XDOW 02755000
         CH    RF,TCBX1CR4+2-TCBXADR(,R8) IS HASN=PASN=SASN    @D64XDOW 02756000
         BNE   ABEST700           NO ---> SKIP AB-TYPE EXIT    @D64XDOW 02757000
ABEST610 DS    0H                                              @D64XDOW 02758000
         ICM   R8,B'1111',PTCBSDWA MASTER SDWA PRESENT         @D64ADOW 02759000
         BZ    ABEST660           NO, --->                     @D64ADOW 02760000
         LA    RF,8               FCT CODE FOR SGETVIS         @D64ADOW 02761000
***                               LOC=ANY, PARTKEY                      02762000
         LTR   R4,R4              31 BIT MODE EXIT             @D64ADOW 02763000
         BM    ABEST620           YES ,--->                    @D64ADOW 02764000
         LA    RF,12              FCT CODE FOR SGETVIS         @D64ADOW 02765000
***                               LOC=BELOW,PARTKEY                     02766000
ABEST620 DS    0H                                              @D64ADMK 02767000
         LA    R0,SDWATLEN+72                                  @D64ADMK 02768000
         CLI   PTCBEXFA,TCBEXFRR  FRR TO BE ACTIVATED          @D64ADOW 02769000
         BNE   ABEST630           NO, --->                     @D64ADOW 02770000
         LA    R0,SDWATLEN+304                                 @D64ADOW 02771000
ABEST630 DS    0H                                              @D64ADMK 02772000
         LR    R5,R0              SAVE LENGTH                  @D64ADOW 02773000
         LR    R9,RC              SAVE TCBX ADDR               @D64ADOW 02774000
         L     RC,ASGEXIT         GET BASE OF                  @D64ADOW 02775000
         L     RC,AEXITGVI-SGEXIT(,RC) ... SUBROUTINE          @D64ADOW 02776000
         BASSM R8,RC              RETRIEVE STORAGE FOR SDWA    @D64ADOW 02777000
*SGLINK  EXITGVIS,INPUT=(R0,R8,RA,RC,RF),OUTPUT=(R1,RF),WORK=R0         02778000
         LR    RC,R9              RESTORE TCBX ADDR            @D64ADOW 02779000
         LTR   RF,RF              SDWA RETRIEVED               @D64ADOW 02780000
         BZ    ABEST640           YES, --->                    @D64ADOW 02781000
         CLI   PTCBEXFA,TCBEXFRR  FRR TO BE ACTIVATED          @D64ADOW 02782000
         BNE   ABEST660           NO, --->                     @D64ADOW 02783000
         B     ABEST700           YES, PERCOLATE TO NEXT ESTAEX@D64ADOW 02784000
ABEST640 DS    0H                                              @D64ADMK 02785000
         L     R8,PTCBSDWA        ADDR OF MASTER SDWA          @D64ADOW 02786000
         ST    R1,PTCBASDW        SAVE SDWA TO BE PASSED TO EXI@D64ADOW 02787000
         LR    R0,R1              COPY TO ADDR                 @D64ADOW 02788000
         LA    R1,SDWATLEN        GET LENGTH                   @D64ADOW 02789000
         LR    R9,R1              ...                          @D64ADOW 02790000
         MVCL  R0,R8              COPY SDWA                    @D64ADOW 02791000
         L     R1,PTCBASDW        RELOAD SDWA ADDR             @D64ADOW 02792000
         USING SDWA,R1                                         @D64ADOW 02793000
         MVI   SDWASPID,XF1       SUBPOOL ID AND LENGTH        @D64ADOW 02794000
         STCM  R5,B'0111',SDWALNTH ... TO SDWA                 @D64ADOW 02795000
         L     R5,AABSDWAI        GET SUBROUTINE BASE          @D64ADOW 02796000
         BASR  R8,R5              INITIALIZE SDWA POINTERS     @D64ADOW 02797000
*SGLINK ABSDWAIN,S,INPUT=(R1,R5,R8),WORK=(RB,RF)                        02798000
         L     RB,TCBSAVE         RESTORE TASK SAVE AREA ADDR  @D64ADOW 02799000
         ST    RE,SDWAPARM        PARAM ADDR TO SDWA           @D64ADMK 02800000
         LA    R9,SDWATLEN(,R1)                                @D64ADOW 02801000
         ST    R1,SVER01          USER REG 1 POINTS TO SDWA    @D64ADMK 02802000
         LA    R0,ABYESDWA        INDICATE SDWA                @D64ADOW 02803000
         LA    RE,SVER0D          TARGET FOR ARR/FESTAE/ESTAEX @D64ADOW 02804000
***                               ... TO CONTAIN SAVE AREA ADDR         02805000
         CLI   PTCBEXFA,TCBEXFRR  FRR TO BE ACTIVATED          @D64ADOW 02806000
         BNE   ABEST650           NO, --->                     @D64ADOW 02807000
         LA    RE,SVER00          TARGET FOR FRR               @D64ADOW 02808000
***                               ... TO CONTAIN SAVE AREA ADDR         02809000
         XC    SDWACTL1(8),SDWACTL1 CLEAR BC-MODE PSW'S        @D64ADOW 02810000
         XC    SDWACTL2(8),SDWACTL2 ...                        @D64ADOW 02811000
         DROP  R1                                              @D64ADOW 02812000
ABEST650 DS    0H                                              @D64ADMK 02813000
         ST    R9,0(,RE)          SAVE AREA ADDR TO            @D64ADOW 02814000
***                               ... USER REG 0 OR 13                  02815000
         B     ABEST670                                        @D64ADOW 02816000
ABEST660 DS    0H                 NO SDWA PRESENT              @D64ADMK 02817000
         L     R9,PSATOLD         MVS TCB ADDR                 @D64ADMK 02818000
         USING TCB,R9                                          @D64ADOW 02819000
         SLR   R0,R0                                           @D64ADOW 02820000
         ICM   R0,B'0111',TCBCMPC SYSTEM AND USER ABEND CODE   @D64ADOW 02821000
         DROP  R9                                              @D64ADMK 02822000
         ST    R0,SVER01          ... TO SAVE AREA             @D64ADOW 02823000
         LA    R0,ABNOSDWA        INDICATE NO SDWA             @D64ADOW 02824000
ABEST670 DS    0H                                              @D64ADOW 02825000
         L     RE,AESTAEXR        SETUP RETURN ADDR            @D64ADMK 02826000
         L     R9,TCBARSAV        GET ACC REG SAVE AREA ADDR   @D64ADOW 02827000
         CLI   PTCBEXFA,TCBEXFRR  FRR TO BE ACTIVATED          @D64ADOW 02828000
         BNE   ABEST680           NO --->                      @D64ADOW 02829000
         L     RE,AESTFRRR        RET ADDR IF FRR              @D64ADOW 02830000
         XC    0(64,R9),0(R9)     CLEAR A-REG SAVE AREA        @D64ADOW 02831000
         B     ABEST681                                        @D64ADOW 02832000
ABEST680 DS    0H                                              @D64ADOW 02833000
         ST    R0,SVER00          SET SDWA PRESENCE INDICATOR  @D64ADMK 02834000
         ST    R3,8(,R9)          PASS ALET IN ACC REG 2       @D64ADOW 02835000
ABEST681 DS    0H                                              @D64ADOW 02836000
         ST    RE,SVER0E          SET UP RETURN ADDR           @D64ADMK 02837000
         ST    R2,SVER02          PASS PARAM IN REG 2          @D64ADOW 02838000
         ST    R4,SVEPSW2         STORE ROUTINE ADDRESS TO PSW @D64ADMK 02839000
         ST    R4,SVER0F          ... AND TO USER REG 15       @D64ADMK 02840000
         OI    TCBABEX,EXITACT    SET ANY AB-TYPE EXIT ACTIVE  @D64ADMK 02841000
         L     R9,PCBPTR          POINT TO PCB                 @D64ADMK 02842000
         USING PCBADR,R9                                       @D64ADMK 02843000
         TM    PCBFLAG,PERACT     TEST PER BIT IN PCBFLAG      @D64ADMK 02844000
         BZ    ABEST690           PER BIT NOT ON   --->        @D64ADMK 02845000
         DROP  R9                                              @D64ADMK 02846000
         OI    SVEPSW,PERMASK     ENABLE PROGR.EVENT RECORDING @D64ADMK 02847000
ABEST690 DS    0H                                              @D64ADMK 02848000
         L     R8,TIBPTR                                       @D64ADOW 02849000
         USING TIBADR,R8                                       @D64ADOW 02850000
         STM   R0,RF,SVCWORKA     SAVE CURRENT REGISTER        @D64ADOW 02851000
         L     R9,ASGMVSAP        GET BASE FOR SUBROUTINE      @D64ADOW 02852000
         USING SGMVSAPI,R9                                     @D64ADOW 02853000
         LA    RF,CLEANEX         ADDR OF SUBROUTINE           @D64ADOW 02854000
         O     RF,BIT0ON          FORCE 31 BIT MODE            @D64ADOW 02855000
         BASSM R7,RF              CALL ETXR/POST-EXIT CLEANUP  @D64ADOW 02856000
*SGLINK SGMAPICL,INPUT=(R7,R9,RA),WORK=(R1,R2,R5,R6,R8,RE,RF)           02857000
         DROP  R9                                              @D64ADOW 02859000
         LM    R0,RF,SVCWORKA     RESTORE REGISTER             @D64ADOW 02859500
         MVI   TIBCNCL,XFF        INDICATE AB TYPE EXIT ACTIVE @D64ADOW 02860000
         L     R6,ADISPSER        GET ADDRESS OF DISP.SERVICES @D52GDIS 02861000
         LA    R0,28              GET FUNCTION CODE            @D61CDOW 02862000
         BASSM R7,R6              RESET ADDITIONAL CANCEL INFO @D64ADOW 02863000
*SGLINK  DISPSE28,INPUT=(R0:FCT_CODE,R6:DISPSERV_BASE,                 X02864000
               R7:RETURN_ADDR,R8:TIB_ADDR,RA:TCB_ADDR),                X02865000
               WORK=(R0,R2,RF)                                          02866000
         DROP  R8                                              @D64ADOW 02867000
         L     RC,TCBATCBE        LOAD TCBX ADDR               @D64ADOW 02868000
         B     ABROUTEX           GOTO SETUP CR1 AND CR7       @D64ADOW 02869000
         DROP  RC                                              @D64ADOW 02870000
***                                                                     02871000
***      PERCOLATE THE EXIT WHICH GOT THE ABNORMAL TERMINATION          02872000
***      CONDITION                                                      02873000
***                                                                     02874000
ABEST700 DS    0H                                              @D64ADOW 02875000
         USING TCBXADR,RC                                      @DY44889 02876990
         SLR   RF,RF              RF=0 AND NO SDWA --> PERCOLAT@D64ADOW 02878000
         ICM   R7,B'1111',PTCBASDW SDWA AVAILABLE              @D64ADOW 02879000
         BZ    ABRETURN           NO --->                      @D64ADOW 02880000
         USING SDWA,R7                                         @D64ADOW 02881000
         MVI   SDWARCDE,SDWACWT   REQ PERCOLATE                @D64ADOW 02882000
         CLI   PTCBEXFA,TCBEXFRR  FRR SKIPPED?                 @D64ADOW 02883000
         BNE   ABRETURN           NO --->                      @D64ADOW 02884000
         OI    SDWAERRC,SDWASKIP  INDICATE FRR SKIPPED         @D64ADOW 02885000
         B     ABRETURN                                        @D64ADOW 02886000
         DROP  R7                                              @D64ADOW 02888000
         DROP  RA                                              @D64ADOW 02889000
         DROP  RB                                              @D64ADMK 02890000
         DROP  RC                                              @DY44889 02890500
         EJECT                                                          02891000
*********************************************************************** 02892000
*        PERCOLATE/RETRY ROUTINE FOR ESTAE-TYPE EXIT ROUTINES         * 02893000
*                                                                     * 02894000
*        INPUT   RA  TCB POINTER                                      * 02895000
*                RD  ROUTINE BASE ADDR                                * 02896000
*                RF  PERCOLATE/RETRY INDICATOR (IF NO SDWA)           * 02897000
*                                                                     * 02898000
**   CALLED IN 31 BIT MODE                                            * 02899000
**   EXIT TO                                                          * 02900000
**        DISPATCHER (EXIT OR ERRGO)                                  * 02901000
*********************************************************************** 02902000
         SPACE                                                          02903000
         USING TCBADR,RA                                       @D64ADOW 02904000
ABRETURN DS    0H                                              @D64ADMK 02905000
         L     RC,TCBATCBE        GET ADDR OF                  @D64ADOW 02906000
         USING TCBXADR,RC         ... PSEUDO                   @D64ADOW 02907000
         L     RC,PTCBAPTC        ... TCB-EXTENSION            @D64ADOW 02908000
***                                                                     02909000
***            REMOVE ALL ESTAEX AND FESTAE EXITS DEFINED WHILE         02910000
***            CURRENT AB-TYPE EXIT WAS ACTIVE                          02911000
***            (FESTAE ARE ONLY RECOGNIZED WHEN DEFINED AFTER           02912000
***             AN ESTAEX, IN GENERAL ITS UP TO THE USER TO             02913000
***             HANDLE FESTAE CORRECTLY)                                02914000
***  NOTE: NESTED FRR'S ARE NOT DELETED BECAUSE WE ASSUME THAT PROGRAMS 02914300
***         DEFINING FRR WILL ALSO DELETE THEM BEFORE PERCOLATR/RETRY   02914600
***                                                                     02915000
ABRET010 DS    0H                                              @D64ADOW 02916000
         L     R7,TCBABEX         ANY ESTAEX DEFINED           @D64ADOW 02917000
         LA    R7,0(,R7)          ...                          @D64ADOW 02918000
         LTR   R7,R7              ...                          @D64ADOW 02919000
         BZ    ABRET040           NO, --->                     @D64ADOW 02920000
         USING EXITBLK,R7                                      @D64ADOW 02921000
         CLI   EXABEXIN,TCBABACT  WAS ESTAEX DEFINED WHILE     @D64ADOW 02922000
***                               CURRENT EXIT ACTIV                    02923000
         BNE   ABRET040           NO, --->                     @D64ADOW 02924000
         CLC   EXABACTV,PTCBEACT  ... REALLY                   @D64ADOW 02925000
         BNE   ABRET040           NO, --->                     @D64ADOW 02926000
         LA    R3,EXABMSCB        GET RELATED SCB ADDR         @D64ADOW 02927000
         ICM   R9,B'1111',PSATOLD FAMILY API ACTIVE            @D64ADOW 02928000
         BZ    ABRET020           N0 --->                      @D64ADOW 02929000
         SLR   R8,R8                                           @D64ADOW 02930000
         ICM   R8,B'0111',TCBSTABB-TCB(R9) 1ST IN MVS SCB CHAIN@D64ADOW 02931000
         BZ    ABRET020           SHOULD NOT OCCUR, TAKE ESTAEX@D999999 02933000
         CLR   R8,R3              WAS THIS A ESTAEX            @D64ADOW 02932000
         BE    ABRET020           YES, --->                    @D64ADOW 02933000
.*** DEACTIVATION OF FESTAE POSSIBLE BECAUSE NO IT/OC EXIT ACTIVATED            
.*** WHILE AB-EXIT ACTIVE                                                       
         L     R4,SCBCHAIN-SCB(,R8) REMOVE SCB FROM CHAIN      @D64ADOW 02934000
PCKFAPI6 DS    0H                 PROG CHK ADDR FOR SGPCK      @D66XXOW         
         XC    SCBCHAIN-SCB(8,R8),SCBCHAIN-SCB(R8) ...         @D64ADOW 02935000
         STCM  R4,B'0111',TCBSTABB-TCB(R9) ...                 @D64ADOW 02936000
         B     ABRET010           CHECK FOR NEXT ESTAEX/FESTAE @D64ADOW 02937000
ABRET020 DS    0H                                              @D64ADOW 02938000
.***                              EXIT IS DEFINITLY NOT ACTIV           02939000
         LA    R4,TCBABEX         CHAINING ADDR                @D64ADOW 02940000
         L     RC,ASGEXIT         EXIT CONTROL BLOCK           @D64ADOW 02941590
         L     RC,ARESUSPB-SGEXIT(,RC) ... TO FREE-CHAIN       @D64ADOW 02942180
         BASSM R8,RC              ...  AND RESET USP-BIT       @D64ADOW 02943000
*SGLINK RESUSPB,INPUT=(R4,R7,R8,RA,RC),OUTPUT=(R7)                      02944000
         L     RC,TCBATCBE        RELOAD PSEUDO                @D64ADOW 02945000
         L     RC,PTCBAPTC        ... TCB-EXTENSION            @D64ADOW 02946000
         DROP  R7                                              @D64ADOW 02947000
         B     ABRET010           CHECK NEXT ESTAEX            @D64ADOW 02948000
ABRET040 DS    0H                                              @D64ADOW 02949000
         L     R7,PTCBEACT        GET EXIT RELATED CNTRL BLOCK @D64ADOW 02950000
         ICM   R4,15,PTCBASDW     GET SDWA PTR                 @D64ADMK 02951000
         BNZ   ABRET050           SDWA AVAILABLE --->          @D64ADOW 02952000
         C     RF,F4              DOES REC RTN REQ'S RETRY     @D64ADOW 02953000
         BE    ABRET060           YES, CONTINUE CHECK          @D64ADOW 02954000
         B     ABPERCOL           NO , GOTO PERCOLATE          @D64ADOW 02955000
ABRET050 DS    0H                                              @D64ADMK 02956000
         USING SDWA,R4            GET SDWA PTR                 @D64ADMK 02957000
         CLI   SDWARCDE,SDWACWT   DOES EXIT INDICATE PERCOLATE?@D64ADMK 02958000
         BE    ABPERCOL           YES, PERCOLATE               @D64ADMK 02959000
ABRET060 DS    0H                                              @D64ADMK 02960000
         TM    PTCBFLG1,TCBXPONY  IS RETRY INHIBITED?          @D64ADMK 02961000
         BNO   ABRETRY            NO, ACTIVATE RETRY ROUTINE   @D64ADMK 02962000
         DROP  R4                                              @D64ADOW 02963000
         EJECT                                                          02964000
*********************************************************************** 02965000
*                                                                     * 02966000
*        PERFORM PERCOLATE                                            * 02967000
*        INPUT  R4   SDWA ADDR OR ZERO                                * 02968000
*               R7   EXIT CB RELATED TO ACTIVE ESTAEX-TYPE EXIT       * 02969000
*               RA   TCB ADDR                                         * 02970000
*               RC   PSEUDO TCBX ADDR                                 * 02971000
*               RD   BASE ADDR                                        * 02972000
*                                                                     * 02973000
*********************************************************************** 02974000
ABPERCOL DS    0H                                              @D64ADMK 02975000
         CLI   PTCBEXFA,TCBEXFES  WAS LAST EXIT FESTAE         @D64ADOW 02976000
         BNE   ABPRC020           NO, -->                      @D64ADOW 02977000
         L     RE,PSATOLD         GET MVS TCB                  @D64ADOW 02978000
         SLR   R6,R6                                           @D64ADOW 02979000
         ICM   R6,B'0111',TCBSTABB-TCB(RE) GET MVS-SCB ADDR    @D64ADOW 02980000
         BZ    ABPRC080           SHOULD NOT OCCUR             @D66XXOW         
         CLC   0(1,R6),SCBXPTR+3-SCB(R6) FORCE PROG CHK IF INV @D66XXOW         
PCKFAPI7 DS    0H                    PROG CHK ADDR FOR SGPCK   @D66XXOW         
         LA    R3,RBSCBB-RBSECT(,R7) CURRENTLY ACTIVE SCB      @D64ADOW 02981000
         CR    R3,R6              MUST BE EQUAL UNLESS FESTAE  @D64ADOW 02982000
***                               WAS DELETED WHILE IT WAS ACTIV        02983000
         BNE   ABPRC080                                        @D64ADOW 02984000
         L     R9,SCBCHAIN-SCB(,R6) GET NEXT IN CHAIN          @D64ADOW 02985000
         XC    SCBCHAIN-SCB(8,R6),SCBCHAIN-SCB(R6) DEACTIVATE  @D64ADOW 02986000
***                               AND DEQUEUE MVS-SCB                   02987000
         STCM  R9,7,TCBSTABB-TCB(RE) ENQUEUE ON TOP OF CHAIN   @D64ADOW 02988000
         B     ABPRC080                                        @D64ADOW 02989000
ABPRC020 DS    0H                                              @D64ADMK 02990000
         CLI   PTCBEXFA,TCBEXFRR  WAS LAST EXIT FRR            @D64ADOW 02991000
         BNE   ABPRC040           NO,  --->                    @D64ADOW 02992000
         L     R9,TCBFREX         GET TASKS FRR STACK          @D64ADOW 02993000
         USING FRRS,R9                                         @D64ADOW 02994000
         LA    R0,FRRSESZE+FRRSEXSZ                            @D64ADOW 02995000
         LR    R6,R7              COPY CURRENT FRR ENTRY       @D64ADOW 02996000
         SLR   R6,R0              GET PREVIOUS FRR STACK ENTRY @D64ADOW 02997000
         ST    R6,FRRSCURR        ... AND MAKE IT CURRENT      @D64ADOW 02998000
         C     R6,FRRSEMP        FRR STACK EMPTY               @D64ADOW 02999590
         BE    ABPRC030          YES -->                       @D64ADOW 03000180
         USING FRRSENTR,R6                                     @D64ADOW 03001000
         TM    FRRSFLG4,FRRSEUT  NEXT FRR WITH EUT=YES         @D64ADOW 03002000
         BO    ABPRC034          YES, KEEP EUT INDICATION      @D64ADOW 03003000
         B     ABPRC032          NO, RESET EUT INDICATION      @D64ADOW 03004000
         DROP  R6                                              @D64ADOW 03005000
ABPRC030 DS    0H                                              @D64ADOW 03006000
         L     R6,TCBATCBE       GET TCBX ADDR                 @D64ADOW 03007000
         NI    TCBXFLG1-TCBXADR(R6),XFF-TCBXFRRA IND NO FRR DEF@D64ADOW 03008000
ABPRC032 DS    0H                                              @D64ADOW 03009000
         NI    PSAMFLGS,X7F      RESET EUT INDICATOR           @D64ADOW 03010000
         NI    TCBEXITH,XFF-TCBEUTIN ... AND IN TCB            @D65CDOW 03011000
ABPRC034 DS    0H                                              @D64ADOW 03012000
         DROP  R9                                              @D64ADOW 03013000
         B     ABPRC080                                        @D64ADOW 03014000
ABPRC040 DS    0H                                              @D64ADMK 03015000
         CLI   PTCBEXFA,TCBEXARR  WAS LAST EXIT ARR            @D64ADOW 03016000
         BNE   ABPRC060           NO, --->                     @D64ADOW 03017000
         MVC   PTCBEXSL,PTCBEXSA  SETUP LINK STACK LEVEL FOR   @D64ADOW 03018000
***                               SUBROUTINE                            03019000
***                                                                     03020000
***      CHECK FOR NEXT LOWER AB-TYPE EXIT                              03021000
***                                                                     03022000
         L     R9,ASGEXIT                                      @D64ADOW 03023000
         LR    R6,RD              SAVE CURRENT BASE            @D64ADOW 03024000
         L     RD,ACHKEXIT-SGEXIT(,R9) GET SUBROUTINE BASE     @D64ADOW 03025000
         USING CHKEXIT,RD         SET UP SUBROUTINE BASE       @D64ADOW 03026000
         BAS   R9,CHKNLSTK        GOTO PREVIOUS LINK STACK ENTR@D64ADOW 03027000
*SGLINK CHKNLSTK,INPUT=(R9,RA,RD)                                       03028000
         DC    X'47000000'                                     @D64ADOW 03029000
         DC    X'47000000'                                     @D64ADOW 03030000
***END OF BRANCH TABLE                                                  03031000
***                                                                     03032000
         LR    RD,R6              RELOAD BASE                  @D64ADOW 03033000
         USING ABROUT,RD          RE-ESTABLISH BASE            @D64ADOW 03034000
         B     ABPRC080                                        @D64ADOW 03035000
ABPRC060 DS    0H                                              @D64ADMK 03036000
         USING EXITBLK,R7         ADDRESSABILITY               @D64ADMK 03037000
         NI    EXITADR,XFF-EXITACT RESET ACTIV INDICATOR       @D64ADOW 03038000
         DROP  R7                                              @D64ADOW 03039000
         LA    R4,TCBABEX         CHAINING ADDR                @D64ADOW 03040000
         L     RC,ASGEXIT         EXIT CONTROL BLOCK           @D64ADOW 03041590
         L     RC,ARESUSPB-SGEXIT(,RC) ... TO FREE-CHAIN       @D64ADOW 03042180
         BASSM R8,RC              ...  AND RESET USP-BIT       @D64ADOW 03043000
*SGLINK RESUSPB,INPUT=(R4,R7,R8,RA,RC),OUTPUT=(R7)                      03044000
         L     RC,TCBATCBE        RELOAD ADDR OF               @D64ADOW 03045000
         L     RC,PTCBAPTC        ... TCB-EXTENSION            @D64ADOW 03046000
ABPRC080 DS    0H                                              @D64ADMK 03047000
***                                                                     03048000
***      COPY USER SUPPLIED INFO FROM SDWA TO MASTER SDWA               03049000
***                                                                     03050000
         ICM   R6,B'1111',PTCBSDWA GET ADDR OF MASTER SDWA     @D64ADOW 03051000
         USING SDWA,R6                                         @D64ADOW 03052000
         BZ    ABPRC120                                        @D64ADOW 03053000
         ICM   R1,B'1111',PTCBASDW GET ACTIVE SDWA             @D64ADOW 03054000
         BZ    ABPRC120                                        @D64ADOW 03055000
         MVC   SDWAABCC(4),SDWAABCC-SDWA(R1) COPY USER MODIFIED@D64ADOW 03056490
***                               ...AREAS SDWAREQ (DUMP INDICATOR)     03057000
***                               ...      SDWARCF (VALID RSN CODE IND) 03058000
***                               ...      SDWACMPC (COMPLETION CODE)   03059000
         OC    SDWAERRC,SDWAERRC-SDWA(R1) COPY FLAG BYTE       @D64ADOW 03060000
         L     R8,SDWAXPAD        ADDR OF MASTER SDWA PTRS     @D64ADOW 03061000
         USING SDWAPTRS,R8                                     @D64ADOW 03062000
         L     R8,SDWASRVP        ADDR OF MASTER SDWARC1       @D64ADOW 03063000
         USING SDWARC1,R8                                      @D64ADOW 03064000
         L     R2,SDWAXPAD-SDWA(,R1) ACT SDWA PTRS             @D64ADOW 03065000
         USING SDWAPTRS,R2                                     @D64ADOW 03066000
         L     R2,SDWASRVP        ACTUAL SDEARC1               @D64ADOW 03067000
         DROP  R2                                              @D64ADOW 03068000
         TM    SDWACCRC-SDWARC1(R2),SDWAREAF RSNCODE MODIFIED  @D64ADOW 03069000
         BNO   ABPRC090           NO,                          @D64ADOW 03070000
         OI    SDWACMPF,SDWARCF   INDICATE REASON CODE SET     @D64ADOW 03071000
         MVC   SDWAHRC(4),SDWAHRC-SDWARC1(R2) COPY REASON CODE @D64ADOW 03072000
ABPRC090 DS    0H                                              @D64ADMK 03073000
         MVC   SDWACCRC(1),SDWACCRC-SDWARC1(R2) COPY INDICATORS@DY45037 03073500
         DROP  R6                                              @D64ADOW 03074000
         DROP  R8                                              @D64ADOW 03075000
***                                                                     03076000
***      FREE SPACE OF ACTUAL SDWA                                      03077000
***                                                                     03078000
         LA    R0,SDWATLEN+72     NORMAL SDWA SIZE             @D64ADOW 03079000
***                               (FIELD MAY BE OVERWRITTEN)            03080000
         CLI   PTCBEXFA,TCBEXFRR  DEALING WITH FRR             @D64ADOW 03081000
         BNE   ABPRC100                                        @D64ADOW 03082000
         LA    R0,SDWATLEN+304    SDWA SIZE FOR FRR            @D64ADOW 03083000
ABPRC100 DS    0H                                              @D64ADMK 03084000
         LA    RF,20              SETUP FUNCTION CODE FREEMAIN @D64XDOW 03085000
         L     RC,ASGEXIT         GET BASE OF                  @D64XDOW 03086000
         L     RC,AEXITGVI-SGEXIT(,RC) ... SUBROUTINE          @D64XDOW 03087000
         BASSM R8,RC              FREE SPACE                   @D64XDOW 03088000
*SGLINK  EXITFVIS,INPUT=(R0,R1,R8,RA,RC,RF),OUTPUT=RF,WORK=R0           03089000
         L     RC,TCBATCBE        RELOAD                       @D64XDOW 03090000
         L     RC,PTCBAPTC        ...PSEUDO TCB-EXTENSION      @D64XDOW 03091000
         XC    PTCBASDW,PTCBASDW CLEAR POINTER                 @D64ADOW 03092000
ABPRC120 DS    0H                                              @D64ADMK 03093000
***                                                                     03094000
***      CHECK FOR NEXT ESTAEX-TYPE EXIT                                03095000
***                                                                     03096000
         SLR   R6,R6              INDICATE REQUESTOR IS PERCOL @D64ADOW 03097000
         L     R8,TIBPTR          GET CURRENT TIB PTR          @D64ADOW 03098000
         LR    R2,RD              SAVE BASE ADDR               @D64ADOW 03099000
         L     RD,ASGEXIT         GET BASE FOR                 @D64ADOW 03100000
         L     RD,ACHKEXIT-SGEXIT(,RD) ... SUBROUTINE          @D64ADOW 03101000
         BASSM R9,RD              CHECK FOR NEXT EXIT          @D64ADOW 03102000
*SGLINK CHKEXIT,INPUT=(R6,R8,R9,RA,RD)                                  03103000
         LR    RD,R2              RESTORE BASE ADDR            @D64ADOW 03104000
***                                                                     03105000
***      IF THE SELECTED AB-TYPE EXIT WAS TERMINATED PRIOR (INSPECT     03106000
***      PREVIOUS PSEUDO TCBX) PERCOLATE THIS EXIT.                     03107190
***      IF NO PSEUDO-TCBX COULD BE CREATED SKIP ALL EXITS OF CURRENT   03107380
***      NESTING LEVEL                                                  03107570
***                                                                     03108000
         C     RC,TCBATCBE        ANY NESTING LEVEL ACTIVE     @D64ADOW 03109000
         BE    ABPRC200           NO, --->                     @D64ADOW 03110000
         L     R5,PTCBAPTC        GET PREVIOUS PSEUDO TCBX     @D64ADOW 03111000
         L     R7,PTCBESEL        EXIT RELATED CB OF NEXT EXIT @D64ADMK 03112000
         L     R1,PTCBEXSL        ...                          @D64ADOW 03113000
         L     R9,PTCBEXRL        ...                          @D64ADOW 03114000
         IC    R4,PTCBEXFL        ...                          @D64ADOW 03115000
         C     R7,PTCBEACT-TCBXADR(,R5) WAS SELECTED EXIT      @D64ADOW 03116000
***                               ACTIVE AT LAST NESTING LEVEL          03117000
         ST    R7,PTCBEACT        EXIT BECOMES CURRENT         @D64ADMK 03118000
         ST    R1,PTCBEXSA        ...                          @D64ADOW 03119000
         ST    R9,PTCBEXRA        ...                          @D64ADOW 03120000
         STC   R4,PTCBEXFA        ...                          @D64ADOW 03121000
         BE    ABPRC130           YES, SKIP EXIT AND FREE      @DY44889 03122090
***                               ... PSEUDO TCBX                       03122180
         TM    PTCBFLG1,PTCBNPSD  NEW PSEUDO-TCB RETRIEVED     @DY44889 03122270
         BO    ABEST700           NO, PERCOLATE THE EXIT       @DY44889 03122360
         B     ABPRC200           DRIVE EXIT                   @DY44889 03122450
ABPRC130 DS    0H                 FREE-UP AREAS AND PERCOLATE  @DY44889 03122540
         L     R4,PTCBSDWA        GET SDWA RELATED TO MOST     @D64ADOW 03123000
***                               ... RECENT ERROR                      03124000
         ICM   R1,B'1111',PTCBSDWA-TCBXADR(R5) MASTER SDWA     @D64ADOW 03125000
***                               AVAILABLE IN PREVIOUS PSEUDO TCBX     03126000
         BZ    ABPRC140           NO                           @D64ADOW 03127000
         LA    R0,SDWATLEN                                     @D64ADOW 03128000
*** FREEVIS FOR MASTER SDWA OF PREVIOUS PSEUDO TCBX                     03129000
*        SFREEVIS ADDRESS=(1),LENGTH=(0)                                03130000
         SFREEVIS ADDRESS=(1),LENGTH=(0)                       @D64ADOW 03131000
*END OF SFREEVIS MACRO                                                  03132000
         SPACE                                                          03133000
ABPRC140 DS    0H                                              @D64ADOW 03134000
         ST    R4,PTCBSDWA-TCBXADR(,R5) PASS NEWEST SDWA TO    @D64ADOW 03135000
***                               ... NEXT AB-TYPE EXIT                 03136000
         ICM   R1,B'1111',PTCBASDW-TCBXADR(R5) RELEASE ACTIVE  @D64ADOW 03137000
         BZ    ABPRC160           ... SDWA                     @D64ADOW 03138000
*** FREE SPACE FOR ACTUAL SDWA                                          03139000
         LA    R0,SDWATLEN+72                                  @D64ADOW 03140000
         CLI   PTCBEXFA-TCBXADR(R5),TCBEXFRR DEALING WITH FRR  @D64ADOW 03141000
         BNE   ABPRC150           NO, --->                     @D64ADOW 03142000
         LA    R0,SDWATLEN+304                                 @D64ADOW 03143000
ABPRC150 DS    0H                                              @D64ADMK 03144000
         LA    RF,20             SETUP FUNCTION CODE FREEMAIN  @D64XDOW 03145000
         L     RC,ASGEXIT        GET BASE OF                   @D64XDOW 03146000
         L     RC,AEXITGVI-SGEXIT(,RC) ... SUBROUTINE          @D64XDOW 03147000
         BASSM R8,RC              FREE SPACE                   @D64XDOW 03148000
*SGLINK  EXITFVIS,INPUT=(R0,R1,R8,RA,RC,RF),OUTPUT=RF,WORK=R0           03149000
         L     RC,TCBATCBE       RELOAD                        @D64XDOW 03150000
         L     RC,PTCBAPTC       ...PSEUDO TCB-EXTENSION       @D64XDOW 03151000
         XC    PTCBASDW-TCBXADR(4,R5),PTCBASDW-TCBXADR(R5)     @D64ADOW 03152000
ABPRC160 DS    0H                                              @D64ADMK 03153000
         L     R4,TCBATCBE        GET NORMAL TCBX ADDR         @D64ADOW 03154000
         ST    R5,PTCBAPTC-TCBXADR(,R4) POINT TO NEW ACTIVE    @D64ADOW 03155000
***                               ... PSEUDO TCBX                       03156000
         TM    PTCBFLG1,TCBXPONY  ONLY PERCOLOATE ALLOWD       @D64ADOW 03157000
         BNO   ABPRC180           NO, --->                     @D64ADOW 03158000
         OI    PTCBFLG1-TCBXADR(R5),TCBXPONY PROPAGATE INDICATO@D64ADOW 03159000
ABPRC180 DS    0H                                              @D64ADMK 03160000
         MVC   PTCBEXCC-TCBXADR(PTCBEND-PTCBEXCC,R5),PTCBEXCC  @D64ADOW 03161000
***                               COPY STATUS INFORMATION OF MOST       03162000
***                               RECENT ERROR TO CURRENT PSEUDO TCBX   03163000
         LA    R4,PTCBPFIX        LENGTH OF PSEUDO-TCBX PREFIX @D64ADOW 03164000
         LR    R1,RC              COPY CURRENT PSEUDO TCBX ADDR@D64ADOW 03165000
         AR    R1,R4              GET RELATED STORAGE ADDR     @D64ADOW 03166000
         LA    R0,PTCBLENG        LENGTH OF RELATED STORAGE    @D64ADOW 03167000
*** FREEVIS FOR PSEUDO TCBX                                             03168000
*        SFREEVIS ADDRESS=(1),LENGTH=(0)                                03169000
         SFREEVIS ADDRESS=(1),LENGTH=(0)                       @D64ADMK 03170000
*END OF SFREEVIS MACRO                                                  03171000
         SPACE                                                          03172000
         LR    RC,R5              COPY PSEUDO TCBX ADDR        @DY44889 03172500
         B     ABEST700           PERFORM PERCOLATION          @D64ADOW 03173000
ABPRC200 DS    0H                                              @D64ADMK 03174000
         CLI   TCBEXIFL,TCBEXIEX  IS NEXT ESTAEX/ARR/FRR/FESTAE@D64ADOW 03175000
         BNE   ABPRC300           NO, ---> ITS VSE-AB EXIT     @D64ADOW 03176000
         ICM   RF,B'1111',PTCBSDWA GET SDWA PTR                @D64ADOW 03177000
         BNP   ABEST200           NOT AVAILABLE --->           @D64ADMK 03178000
         USING SDWA,RF                                         @D64ADOW 03179000
         OI    SDWAERRC,SDWAPERC  ESTAE-TYPE EXIT ENTERED THRU @D64ADOW 03180000
***                               ... PERCOLATE                         03181000
         DROP  RF                                              @D64ADOW 03182000
         B     ABEST200           SET ENVIRONMENT FOR THIS EXIT@D64ADMK 03183000
***                                                                     03184000
***      FINAL PERCOLATION OR SCHEDULE AB-EXIT AFTER PERCOLATE          03185000
***                                                                     03186000
ABPRC300 DS    0H                 NO FURTHER ESTAEX-TYPE EXIT  @D64ADOW 03187000
         L     R8,TIBPTR                                       @D64ADOW 03188000
         USING TIBADR,R8                                       @D64ADOW 03189000
         OI    TCBEXIFL,TCBEXABO  INDICATE PERFORM ONLY AB-EXIT@D64ADOW 03190000
         L     RB,TCBSAVE         GET SAVE AREA ADDR           @D64ADOW 03191000
         USING SVEARA,RB                                       @D64ADOW 03192000
         CLI   TIBCNCL,XFF        ALREADY ESTAEX TYPE EXIT     @D64ADOW 03193000
***                               EXECUTED?                             03194000
         MVC   TIBCNCL,PTCBEXCC   PREPARE CANCEL CODE          @DY45190 03194500
         BE    ABPRC310           YES, --->                    @D64ADOW 03195000
***                               NO: CASE WHERE ESTAEX-TYPE            03196000
***                               EXIT DEFINED BUT NOT SCHEDULED        03197000
***                               (IN ABESTAEX ROUTINE)                 03197500
         IC    RF,TIBCNCL         PREPARE R15 WITH ACTUAL CC   @D67BDOW         
         MVC   SVEPSW(8),PTCBEXPS RESTORE FAILING PSW          @D64ADOW 03198000
         MVC   INTINFO(4),PTCBINFO RESTORE INTINFO FROM FAILURE@D64ADOW 03199000
         MVC   TCBMVSIS(4),PTCBMVSI ...                        @D64ADOW 03200000
         B     ABPRC320                                        @D64ADOW 03201000
ABPRC310 DS    0H                 AB EXIT (STXIT) IF ANY       @D64ADOW 03202000
         LA    RF,CANCX1D         PREPARE R15 WITH CC 1D       @DY45190 03203090
         CLI   TIBCNCL,CANCX1D    CANCEL DUE TO MOTHER TASK TRM@DY45190 03203180
         BE    ABPRC311           YES, CC IS 1D ...            @DY45190 03203270
         LA    RF,NORMEOJ         NO, CC IS 10 IF NO AB-EXIT   @DY45190 03203360
ABPRC311 DS    0H                                              @DY45190 03203450
         ICM   R6,B'1111',PTCBSDWA GET MASTER SDWA             @D64ADOW 03204000
         BZ    ABPRC320                                        @D64ADOW 03205000
         USING SDWA,R6                                         @D64ADOW 03206000
         TM    SDWACMPF,SDWAREQ   DUMP REQUIRED                @D64ADOW 03207000
         DROP  R6                                              @D64ADOW 03208000
         BZ    ABPRC320                                        @D64ADOW 03209000
         OI    TCBEXITG,TCBABDMP  FORCE DUMP                   @D64ADOW 03210000
ABPRC320 DS    0H                 AB EXIT (STXIT) IF ANY       @D64ADOW 03211000
         TM    TCBEXIFL,TCBEXIEA  AB OPTION=EARLY              @D64ADOW 03212000
         BO    ABPRC350           YES,                         @D64ADOW 03213000
         TM    TCBEXIFL,TCBEXIND+TCBEXIMS+TCBEXIDU ANY STXIT AB@D64ADOW 03214000
         BNZ   ABPRC330           YES --->                     @DY45190 03215190
         STC   RF,TIBCNCL                                      @DY45190 03215380
         NI    TCBRFLAG,XFF-TCBRCVAL NO REASON CODE            @D67BDOW         
         NI    TCBABEX,X7F        RESET ACTVE FLAG             @D65CDOW         
         B     ABPRC360                 ->                     @DY45190 03215570
ABPRC330 DS    0H                 AB EXIT (STXIT) IF ANY       @DY45190 03215760
         MVI   TCBEXIFL,TCBEXIND+TCBEXABO SUPPRESS MSG AND DUMP@D64ADOW 03216000
ABPRC350 DS    0H                                              @D64ADOW 03217000
         L     R7,TCBABEX         GET AB-EXIT BLOCK            @D64ADOW 03220000
         USING EXITBLK,R7                                      @D64ADOW 03221000
         L     R4,EXITSAV         GET EXIT SAVE AREA ADDR      @D64ADOW 03222000
         USING SVUARA,R4                                       @D64ADOW 03223000
***                               RESTORE STATUS FROM FAILURE           03224000
         MVC   SVEPSW(8),EXITSPSW ... PSW                      @D64ADOW 03225000
         MVC   TCBEXITF,EXITSACT  ... EXIT ACTIVE INDICATOR    @DY45190 03226490
         MVI   EXITSACT,X00       ... AND CLEAR                @DY45190 03226980
         MVI   PTCBEXEI,X00       .......INDICATOR             @D64ADOW 03227470
         MVC   SVER00(36),SVUR00  ... REG 0 TILL REG 8         @D64ADOW 03228000
         MVC   SVER09(28),SVUR09  ... REG 9 TILL REG 15        @D64ADOW 03229000
         L     R9,SVUPSW          ... INTERRUPT                @D64ADOW 03230000
         ST    R9,INTINFO         ...... INFORMATION           @D64ADOW 03231000
         TM    EXITFLG,EXITMSAV                                @D64ADOW 03232000
         BNO   ABPRC360                                        @D64ADOW 03233000
         L     R9,TCBARSAV        ... ACCESS                   @D64ADOW 03234000
         MVC   0(64,R9),SVUAREG   ...... REGISTER              @D64ADOW 03235000
         DROP  RB                                              @D64ADOW 03236000
ABPRC360 DS    0H                                              @D64ADOW 03237000
         SLR   RB,RB                                           @D64ADOD 03238490
         IC    RB,TIBCNCL         GET CANCEL CODE              @D64ADOW 03239000
         MVI   TIBCNCL,X00        CLEAR FIRST CANCEL CODE      @D64ADOW 03240490
         L     R6,DISPAD          GET DISPATCHER ADDR          @D64ADOW 03241000
         LR    RF,R6              ... AND EXIT ADDR FOR ERRGO  @D64ADOW 03242000
         USING DISP,R6                                         @D64ADOW 03243000
         B     ERRGO              DO FINAL CANCEL              @D64ADOW 03244000
*SGLINK ERRGO,INPUT=(R6,R8,RF)                                          03245000
         DROP  R4                                              @D64ADOW 03246000
         DROP  R6                                              @D64ADOW 03247000
         DROP  R7                                              @D64ADOW 03248000
         DROP  R8                                              @D64ADOW 03249000
         EJECT                                                          03250000
*********************************************************************** 03251000
*                                                                     * 03252000
*        PERFORM RETRY                                                * 03253000
*                                                                     * 03254000
*        INPUT  R0   ADDR OF RETRY ROUTINE IF R4 = 0                  * 03255000
*               R4   SDWA ADDR OR ZERO                                * 03256000
*               R7   EXIT CB RELATED TO ACTIVE ESTAEX TYPE EXIT       * 03257000
*               RA   TCB ADDR                                         * 03258000
*               RC   PSEUDO TCBX ADDR                                 * 03259000
*               RD   BASE ADDR                                        * 03260000
*********************************************************************** 03261000
         USING SDWA,R4                                         @D64ADMK 03262000
ABRETRY  DS    0H                 EXIT COMPLETES WITH RETRY    @D64ADMK 03263000
         SPACE                                                          03264000
         L     RB,TCBSAVE         GET USER SAVE AREA           @D64ADMK 03265000
         USING SVEARA,RB          ADDRESSABILITY               @D64ADMK 03266000
***                                                                     03267000
***      SET UP REGISTER FOR RETRY ROUTINE                              03268000
***                                                                     03269000
         SLR   R8,R8              CLEAR REG TO                 @D64ADOW 03270000
         SLR   R9,R9              ... INITIALIZE AREAS         @D64ADOW 03271000
         L     RE,SDWAXPAD        ADDRESS OF SDWAPTRS          @D64ADOW 03272000
         USING SDWAPTRS,RE                                     @D64ADOW 03273000
         L     RE,SDWASRVP        ADDRESS OF SDWARC1           @D64ADOW 03274000
         USING SDWARC1,RE                                      @D64ADOW 03275000
         LTR   R4,R4              WAS SDWA PRESENT             @D64ADOW 03276000
         BNZ   ABRTY010           YES, --->                    @D64ADOW 03277000
         N     R0,BIT0OFF         RESET BIT 0                  @D64ADOW 03278000
         ST    R0,SVER0F          ADDR OF RETRY ROUTINE        @D64ADOW 03279000
         LA    R2,12              INDICATE SDWA                @D64ADOW 03280000
         ST    R2,SVER00          ... NOT AVAILABLE            @D64ADOW 03281000
         ST    R8,SVER02          CLEAR REG 2                  @D64ADOW 03282000
         B     ABRTY030                                        @D64ADOW 03283000
ABRTY010 DS    0H                                              @D64ADMK 03284000
         ST    R4,SVER01          INITIALIZE WITH SDWA ADDR    @D64ADOW 03285000
         L     R0,SDWARTYA        LOAD RETRY ADDRESS           @D64ADOW 03286000
         N     R0,BIT0OFF         RESET BIT 0                  @D64ADOW 03287000
         ST    R0,SVER0F          ADDR OF RETRY RTN TO REG 15  @D64ADOW 03288000
         CLI   PTCBEXFA,TCBEXFRR  WAS LAST EXIT A FRR          @D64ADOW 03289000
         BE    ABRTY080           YES, --->                    @D64ADOW 03290000
         TM    SDWAACF2,SDWAUPRG+SDWAFREE  RETREGS=NO,FEESDWA=NO       X03291000
                                                               @D64ADOW 03292000
         BNZ   ABRTY020           NO, --->                     @D64ADUL 03293000
         ST    R8,SVER00          CLEAR REG 0                  @D64ADOW 03294000
         L     R1,TCBARSAV        GET AR SAVE AREA             @D64ADOW 03295000
         STM   R8,R9,4*0(R1)      CLEAR AR 0 AND 1             @D64ADOW 03296000
         STM   R8,R9,4*14(R1)     CLEAR AR 14 AND 15           @D64ADOW 03297000
         B     ABRTY100                                        @D64ADOW 03298000
ABRTY020 DS    0H                                              @D64ADMK 03299000
         TM    SDWAACF2,SDWAUPRG  RETREGS=YES                  @D64ADMK 03300000
         BO    ABRTY080           YES, --->                    @D64ADOW 03301000
***                               PROCESS RETREGS=NO,FREESDWA=YES       03302000
         LA    R1,20              RETREGS=YES,FREESDWA=NO      @D64ADMK 03303000
         ST    R1,SVER00          CONTROL INFO FOR RETRY ROUT. @D64ADMK 03304000
         ST    R8,SVER02          CLEAR REG 2                  @D64ADOW 03305000
ABRTY030 DS    0H                                              @D64ADMK 03306000
         SLR   R3,R3              INITIALIZE                   @D64ADOW 03307000
         CLI   PTCBEXFA,TCBEXARR  WAS LAST EXIT AN ARR         @D64ADOW 03308000
         BNE   ABRTY040           NO --->                      @D64ADOW 03309000
         L     R1,PTCBEXSA        GET LINKAGE STACK ENTRY      @D64ADOW 03310000
         LA    R5,LSTATLN1        BACK TO                      @D64ADOW 03311000
         SLR   R1,R5              ... BEGIN OF STATE ENTRY     @D64ADOW 03312000
         USING LSTKSTAT,R1                                     @D64ADOW 03313000
         LM    R2,R3,LSTKMARE     GET MODIFIABLE AREA          @D64ADOW 03314000
         DROP  R1                                              @D64ADOW 03315000
         B     ABRTY070                                        @D64ADOW 03316000
ABRTY040 DS    0H                                              @D64ADOW 03317000
         CLI   PTCBEXFA,TCBEXABT  WAS LAST EXIT AN ESTAEX      @D64ADOW 03318000
         BNE   ABRTY060           NO --->                      @D64ADOW 03319000
         USING EXITBLK,R7                                      @D64ADOW 03320000
         LM    R2,R3,EXABPARM     ADDR OF PARAM                @D64ADOW 03321000
         DROP  R7                                              @D64ADOW 03322000
         B     ABRTY070                                        @D64ADOW 03323000
ABRTY060 DS    0H                 LAST EXIT WAS FESTAE         @D64ADOW 03324000
         ICM   R2,B'0111',RBSPARMA-RBSECT(R7) GET SPECIFIED PAR@D64ADOW 03325000
         BNZ   ABRTY070           SPECIFIED --->               @D64ADOW 03326000
         LA    R2,RBFEPARM-RBSECT(,R7) ELSE DEFAULT PARAM      @D64ADOW 03327000
ABRTY070 DS    0H                                              @D64ADOW 03328000
         ST    R2,SVER01          PARAM TO REG 1               @D64ADOW 03329000
         L     R1,TCBARSAV        GET AR SAVE AREA             @D64ADOW 03330000
         ST    R3,4*1(,R1)        SETUP AR 1                   @D64ADOW 03331000
         ST    R8,4*0(,R1)        CLEAR AR 0                   @D64ADOW 03332000
         STM   R8,R9,4*14(R1)     CLEAR AR 14 AND 15           @D64ADOW 03333000
         B     ABRTY100                                        @D64ADOW 03334000
ABRTY080 DS    0H                                              @D64ADMK 03335000
         MVC   SVER00(36),SDWASR00 RESTORE REGISTER            @D64ADMK 03336000
         MVC   SVER09(28),SDWASR09 ... FROM SDWA               @D64ADMK 03337000
         L     R2,TCBARSAV        GET ACC REG SAVE AREA        @D64ADOW 03338000
         MVC   0(64,R2),SDWAARSV  SETUP ACC REG                @D64ADOW 03339000
         CLI   PTCBEXFA,TCBEXFRR  WAS LAST EXIT A FRR          @D64ADOW 03340000
***                               ... IF FRR SDWA ALWAYS AVAILABLE      03341000
         BNE   ABRTY100           NO --->                      @D64ADOW 03342000
         TM    SDWARETF,SDWART15  RETRY15=YES                  @D64ADOW 03343000
         DROP  RE                                              @D64ADOW 03344000
         BO    ABRTY100           YES, --->                    @D64ADOW 03345000
         ST    R0,SVER0F          PASS ENTRY POINT OF RETRY RTN@D64ADOW 03346000
         ST    R8,4*15(,R2)       CLEAR AR15                   @D64ADOW 03347000
ABRTY100 DS    0H                                              @D64ADMK 03348000
***                                                                     03349000
***      SET UP ENVIRONMENT FOR RETRY ROUTINE                           03350000
***                                                                     03351000
         ST    R0,SVEPSW2                                      @D64ADOW 03352000
         MVI   SVEPSW+3,X00       MAKE PSW BYTE 3 CORRECT      @D64ADOW 03353000
         CLI   PTCBEXFA,TCBEXABT  PROCESSING ESTAEX            @D64ADOW 03354000
         BNE   ABRTY200           NO --->                      @D64ADOW 03355000
         USING EXITBLK,R7         ADDRESSABILITY TO EXIT BLOCK @D64ADOW 03356000
         L     R1,EXABACTV        SAVE ADDR OF EXIT-ACTIVE     @D64ADOW 03357000
         ST    R1,PTCBEXSL        ... FOR LATER USE            @D64ADOW 03358000
         NI    EXITADR,XFF-EXITACT CLEAR EXIT ACTIVE BIT       @D64ADOW 03359000
         MVC   SVEPSW+1(1),EXITKEY GET KEY AND STATE AS IT WAS @D64ADOW 03360000
***                               AT ESTAEX DEFINITION                  03361000
***      SET UP CROSS MEMORY ENVIRONMENT AS IT WAS AT EXIT DEFINITION   03362000
         L     R1,TCBATCBE        ADDR OF TCBX                 @D64ADOW 03363000
         DROP  RC                                              @D64ADOW 03364000
         USING TCBXADR,R1                                      @D64ADOW 03365000
         MVC   TCBX1CR3(4),EXABPKM SET PKM AND SASN            @D64ADOW 03366000
         MVC   TCBX1CR4+2(2),EXABPASN PASN                     @D64ADOW 03367000
         MVC   TCBX1CR8(2),EXABEAX EAX                         @D64ADOW 03368000
***                                                                     03369000
         OI    SVEPSW2,X80        31 BIT MODE                  @D64ADOW 03370000
         MVC   SVEPSW+2(1),EXITASCM  ASC MODE AND PROG MASK AS @D64ADOW 03371000
***                               IT WAS AT EXIT DEFINITION             03372000
         MVI   SVEPSW,X07         ENABLED PSW WITH DATON       @D64ADOW 03373000
         MVC   TCBX1CRF,EXABLSTK  LS FROM ESTAEX DEFINITION    @D64ADOW 03374000
         DROP  R1                                              @D64ADOW 03375000
         USING TCBXADR,RC                                      @D64ADOW 03376000
         L     R2,EXITADR         GET EXIT ADDR, ZERO IF EXIT  @D64ADOW 03377000
***                               ... ALREADY DELETED                   03378000
         LTR   R4,R4              SDWA AVAILABLE               @D64ADOW 03379000
         BZ    ABRTY500           NO --->                      @D64ADOW 03380000
         LTR   R2,R2              EXIT DELETED IN MEANTIME     @D64ADOW 03381000
         BNZ   ABRTY500           NO, --->                     @D64ADOW 03382000
         L     R1,SDWAXPAD        LIST OF EXTENSIONS PTR       @D64ADMK 03383000
         USING SDWAPTRS,R1                                     @D64ADMK 03384000
         L     R1,SDWASRVP        LOAD 1ST REC EXTENSION PTR   @D64ADMK 03385000
         USING SDWARC1,R1                                      @D64ADMK 03386000
         OI    SDWARETF,SDWAREMR  REMOVE EXIT BLOCK            @D64ADOW 03387000
         DROP  R1                                              @D64ADOW 03388000
         DROP  R7                                              @D64ADOW 03389000
         B     ABRTY500                                        @D64ADOW 03390000
ABRTY200 DS    0H                                              @D64ADOW 03391000
         CLI   PTCBEXFA,TCBEXFRR  PROCESSING FRR               @D64ADOW 03392000
         BNE   ABRTY300           NO --->                      @D64ADOW 03393000
         TM    SDWAACF2,SDWARERR  RETRY=ERROR REQ'D            @D64ADOW 03394000
         BO    ABRTYER1           YES, ---> CANCEL             @D64ADOW 03395000
         USING FRRSENTR,R7                                     @D64ADOW 03396000
         LA    R1,FRRSESZE        LENGTH OF FRR ENTRY          @D64ADOW 03397000
         AR    R1,R7              ADDR OF FRR EXTENSION        @D64ADOW 03398000
         USING FRRSXENT,R1                                     @D64ADOW 03399000
         MVI   SVEPSW,DATMASK     ENTER RETRY RTN DISABLED     @D64ADOW 03400000
         TM    PTCBEXPS,ENABLE    ENABLED AT FRR ENTRY         @D64ADOW 03401000
         BZ    ABRTY210           NO --->                      @D64ADOW 03402000
         OI    SVEPSW,ENABLE      YES, RETRY RTN RUNS ENABLED  @D64ADOW 03403000
ABRTY210 DS    0H                                              @D64ADOW 03404000
         MVI   SVEPSW+1,X0C       SUPERVISOR STATE AND KEY 0   @D64ADOW 03405000
***                                                                     03406000
***      SET UP CROSS MEMORY ENVIRONMENT                                03407000
***                                                                     03408000
         L     R8,TCBATCBE        GET ADDR OF TCBX             @D64ADOW 03409000
         MVC   TCBX1CR3-TCBXADR(8,R8),PTCBEXSV+8               @D64ADOW 03410000
***                               SETUP PKM, SASN AND PASN              03411000
         MVC   TCBX1CR8-TCBXADR(2,R8),PTCBEXSV+2 EAX FROM      @D64ADOW 03412000
***                               ... FRR DEFINITION                    03413000
         MVC   TCBX1CRF-TCBXADR(4,R8),PTCBEXSV+4 LINKSTACK FROM@D64ADOW 03414000
***                               ... FRR DEFINITION                    03415000
         MVI   SVEPSW+2,X00       PRIMARY ASC MODE, PROG MASK 0@D64ADOW 03416000
         TM    PTCBEXSV+1,X02     SETFRR IN AR-MODE            @D64ADOW 03417000
         BNO   ABRTY220           NO, --->                     @D64ADOW 03418000
         MVI   SVEPSW+2,X40       AR-MODE, PROG MASK 0         @D64ADOW 03419000
ABRTY220 DS    0H                                              @D64ADOW 03420000
         TM    PTCBEXSV,X80       31 BIT MODE REQUIRED         @D64ADOW 03421000
         BNO   ABRTY230           NO, --->                     @D64ADOW 03422000
         OI    SVEPSW2,X80                                     @D64ADOW 03423000
ABRTY230 DS    0H                                              @D64ADOW 03424000
         DROP  R1                                              @D64ADOW 03425000
         L     R1,SDWAXPAD        FORCE                        @D64ADOW 03426000
         USING SDWAPTRS,R1                                     @D64ADOW 03427000
         L     R1,SDWASRVP        ... DELETION                 @D64ADOW 03428000
         USING SDWARC1,R1                                      @D64ADOW 03429000
         OI    SDWAACF2,SDWAFREE  ... OF SDWA FOR FRR          @D64ADOW 03430000
         DROP  R1                                              @D64ADOW 03431000
         DROP  R7                                              @D64ADOW 03432000
         B     ABRTY500                                        @D64ADOW 03433000
ABRTY300 DS    0H                                              @D64ADOW 03434000
         CLI   PTCBEXFA,TCBEXARR  PROCESSING ARR               @D64ADOW 03435000
         BNE   ABRTY400           NO --->                      @D64ADOW 03436000
         MVI   SVEPSW,ENABLE+DATMASK ENABLED FOR I/O AND EXT IN@D64ADOW 03437000
         OI    SVEPSW2,X80        31 BIT MODE                  @D64ADOW 03438000
         L     R8,AABSETAR        GET ROUTINE BASE             @D64ADOW 03439000
         BASR  RE,R8              SET UP ARR ENVIRONMENT       @D64ADOW 03440000
         L     RE,TCBATCBE        ADDR OF NORMAL TCBX          @D64ADOW 03441000
         MVC   TCBX1CRF-TCBXADR(4,RE),PTCBEXSA ARR RELATED LS  @D64ADOW 03442000
         B     ABRTY500                                        @D64ADOW 03443000
ABRTY400 DS    0H                 PROCESSING FESTAE            @D64ADOW 03444000
         MVI   SVEPSW+1,X0C       SUPERVISOR STATE AND KEY 0   @D64ADOW 03445000
         SLR   R1,R1                                           @D64ADOW 03446000
         ICM   R1,B'0011',PTCBEXPK GET PKM FROM TIME-OF-ERROR  @D64ADOW 03447000
         DROP  RC                                              @D64ADOW 03448000
         L     RE,TCBATCBE        ADDR OF TCBX                 @D64ADOW 03449000
         USING TCBXADR,RE                                      @D64ADOW 03450000
         STH   R1,TCBX1CR3        ... TO CR3                   @D64ADOW 03451000
         ICM   R1,B'0011',PIK     GET PART-ID                  @D64ADOW 03452000
         SRL   R1,4               GET TASKS HASN               @D64ADOW 03453000
         STH   R1,TCBX1CR3+2      SET SASN = HASN              @D64ADOW 03454000
         MVC   TCBX1CR7(4),TCBX1CRD ...                        @D64ADOW 03455000
         STH   R1,TCBX1CR4+2      SET PASN = HASN              @D64ADOW 03456000
         MVC   TCBX1CR1(4),TCBX1CRD ...                        @D64ADOW 03457000
         DROP  RE                                              @D64ADOW 03458000
         USING TCBXADR,RC                                      @D64ADOW 03459000
         L     R1,PTCBEACT        GET RB ADDR                  @D64ADOW 03460000
         TM    RBSFLGS2-RBSECT(R1),RBSAMODE IS 31 BIT MODE REQD@D64ADOW 03461000
         BNO   ABRTY420           NO, --->                     @D64ADOW 03462000
         OI    SVEPSW2,X80        FORCE 31 BIT MODE            @D64ADOW 03463000
ABRTY420 DS    0H                                              @D64ADOW 03464000
         MVI   SVEPSW+2,X00          INITIALIZE PSW BYTE 2     @D64ADOW 03465000
         MVC   SVEPSW+2(1),PTCBEXPS+2 PROGRAM MASK AS IT WAS   @D64ADOW 03466000
         NI    SVEPSW+2,X3F          ... AT TIME-OF-ERROR      @D64ADOW 03467000
***                                  ... AND ASC MODE = PRIMARY         03468000
         MVI   SVEPSW,X07            ENABLED PSW WITH DATON    @D64ADOW 03469000
         LA    R0,RBSECT-RBPREFIX ADDRESS PREFIX OF RB         @D64ADOW 03470000
         SLR   R1,R0              ...                          @D64ADOW 03471000
         L     R1,RBXSB-RBPREFIX(,R1) GET XSB ADDR             @D64ADOW 03472000
         DROP  RC                                              @D64ADOW 03473000
         USING TCBXADR,RE                                      @D64ADOW 03474000
         MVC   TCBX1CR8(2),XSBEAX-XSBBEGIN(R1) SETUP EAX       @D64ADOW 03475000
         MVC   TCBX1CRF(4),XSBSEL-XSBBEGIN(R1) ...LINK STACK   @D64ADOW 03476000
         DROP  RE                                              @D64ADOW 03477000
         USING TCBXADR,RC                                      @D64ADOW 03478000
ABRTY500 DS    0H                                              @D64ADOW 03479000
         LTR   R4,R4              SDWA AVAILABLE               @D64ADOW 03480000
         BNZ   ABRTY540           YES  --->                    @D64ADOW 03481000
         CLI   PTCBEXFA,TCBEXABT  WAS LAST EXIT A ESTAEX       @D64ADOW 03482000
         BNE   ABRTY700           NO, --->                     @D64ADOW 03483000
         LTR   R2,R2              EXIT ALREADY DELETED         @D64ADOW 03484000
         BZ    ABRTY660           YES, GOTO DELET EXIT BLOCK   @D64ADOW 03485000
         B     ABRTY700                                        @D64ADOW 03486000
ABRTY540 DS    0H                                              @D64ADOW 03487000
***                                                                     03488000
***      CLEAN UP BEFORE RETRY ROUTINE IS ENTERED                       03489000
***                                                                     03490000
         L     R2,SDWAXPAD        LIST OF EXTENSIONS PTR       @D64ADMK 03491000
         USING SDWAPTRS,R2                                     @D64ADMK 03492000
         L     R2,SDWASRVP        LOAD 1ST REC EXT PTR         @D64ADMK 03493000
         USING SDWARC1,R2                                      @D64ADMK 03494000
         TM    SDWARETF,SDWAREMR  DELETE INDICATOR ON?         @D64ADMK 03495000
         DROP  R2                                              @D64ADOW 03496000
         BZ    ABRTY700           NO, SKIP EXIT DELETION       @D64ADMK 03497000
         CLI   PTCBEXFA,TCBEXARR  WAS LAST EXIT AN ARR         @D64ADOW 03498000
         BE    ABRTY700           YES, --->                    @D64ADOW 03499000
         CLI   PTCBEXFA,TCBEXFRR  WAS LAST EXIT A FRR          @D64ADOW 03500000
         BNE   ABRTY600           NO , --->                    @D64ADOW 03501000
         L     R9,TCBFREX         GET TASKS FRR STACK          @D64ADOW 03502000
         USING FRRS,R9                                         @D64ADOW 03503000
         LA    R0,FRRSESZE+FRRSEXSZ                            @D64ADOW 03504000
         SLR   R7,R0              GET PREVIOUS FRR STACK ENTRY @D64ADOW 03505000
         ST    R7,FRRSCURR        ... AND MAKE IT CURRENT      @D64ADOW 03506000
         C     R7,FRRSEMP        FRR STACK EMPTY               @D64ADOW 03507590
         BE    ABRTY560          YES--->                       @D64ADOW 03508180
         USING FRRSENTR,R7                                     @D64ADOW 03509000
         TM    FRRSFLG4,FRRSEUT  NEXT FRR WITH EUT=YES         @D64ADOW 03510000
         BO    ABRTY700          YES, KEEP EUT INDICATION      @D64ADOW 03511000
         B     ABRTY562          NO, RESET EUT INDICATION      @D64ADOW 03512000
         DROP  R7                                              @D64ADOW 03513000
ABRTY560 DS    0H                                              @D64ADOW 03514000
         L     R7,TCBATCBE       GET TCBX ADDR                 @D64ADOW 03515000
         NI    TCBXFLG1-TCBXADR(R7),XFF-TCBXFRRA IND NO FRR DEF@D64ADOW 03516000
ABRTY562 DS    0H                                              @D64ADOW 03517000
         NI    PSAMFLGS,X7F      RESET EUT INDICATOR           @D64ADOW 03518000
         NI    TCBEXITH,XFF-TCBEUTIN ... AND IN TCB            @D65CDOW 03519000
         DROP  R9                                              @D64ADOW 03520000
         B     ABRTY700                                        @D64ADOW 03521000
ABRTY600 DS    0H                                              @D64ADOW 03522000
         CLI   PTCBEXFA,TCBEXFES  WAS LAST EXIT A FESTAE       @D64ADOW 03523000
         BNE   ABRTY660           NO, MUST BE ESTAEX           @D64ADOW 03524000
***                               YES, HANDLE FESTAE                    03525000
         L     RE,PSATOLD         GET MVS TCB                  @D64ADOW 03526000
         SLR   R9,R9                                           @D64ADOW 03527000
         ICM   R9,7,TCBSTABB-TCB(RE) GET CURRENT SCB POINTER   @D64ADOW 03528000
         BZ    ABRTY700           SHOULD NOT OCCUR             @D66XXOW 03532000
         CLC   0(1,R9),SCBXPTR+3-SCB(R9) FORCE PROG CHK IF INV @D66XXOW         
PCKFAPI8 DS    0H                    PROG CHK ADDR FOR SGPCK   @D66XXOW         
         LA    R3,RBSCBB-RBSECT(,R7) POINT TO CURRENT MVS SCB  @D64ADOW 03529000
         CR    R3,R9              MUST BE EQUAL UNLESS FESTAE  @D64ADOW 03530000
***                               WAS DELETED WHILE IT WAS ACTIVE       03531000
         BNE   ABRTY700                                        @D64ADOW 03532000
         L     R2,SCBCHAIN-SCB(,R9) GET NEXT IN CHAIN          @D64ADOW 03533000
         XC    SCBCHAIN-SCB(8,R9),SCBCHAIN-SCB(R9) DEACTIVATE  @D64ADOW 03534000
***                               AND DEQUEUE MVS-SCB                   03535000
         STCM  R2,7,TCBSTABB-TCB(RE) ENQUEUE ON TOP OF CHAIN   @D64ADOW 03536000
         B     ABRTY700                                        @D64ADOW 03537000
ABRTY660 DS    0H                                              @D64ADMK 03538000
         USING EXITBLK,R7         R7 IS INPUT AT ABRTY660      @D64ADOW 03539000
         LR    R3,R4              SAVE SDWA ADDR               @D64ADOW 03540000
         LA    R4,TCBABEX         CHAINING ADDR                @D64ADOW 03541000
         L     RC,ASGEXIT         EXIT CONTROL BLOCK TO        @D64ADOW 03542590
         L     RC,ARESUSPB-SGEXIT(,RC) ... FREE-CHAIN          @D64ADOW 03543180
         BASSM R8,RC              ...  AND RESET USP-BIT       @D64ADOW 03544000
*SGLINK RESUSPB,INPUT=(R4,R7,R8,RA,RC),OUTPUT=(R7)                      03545000
         DROP  R7                                              @D64ADOW 03546000
         L     RC,TCBATCBE        RELOAD ADDR OF               @D64ADOW 03547000
         L     RC,PTCBAPTC        ... PSEUDO TCB-EXTENSION     @D64ADOW 03548000
         LR    R4,R3              RELOAD SDWA ADDR             @D64ADOW 03549000
ABRTY700 DS    0H                                              @D64ADOW 03550000
         LTR   R1,R4              SDWA AVAILABLE (COPY ADDR)   @D64ADOW 03551000
         BZ    ABRTY800           NO, SKIP FREEVIS             @D64ADOW 03552000
         TM    SDWAACF2,SDWAFREE  FREESDWA=YES                 @D64ADOW 03553000
         BNO   ABRTY800           NO, --->                     @D64ADOW 03554000
         LA    R0,SDWATLEN+72                                  @D64ADOW 03555000
         CLI   PTCBEXFA,TCBEXFRR  DEALING WITH FRR             @D64ADOW 03556000
         BNE   ABRTY750           NO, --->                     @D64ADOW 03557000
         LA    R0,SDWATLEN+304                                 @D64ADOW 03558000
ABRTY750 DS    0H                                              @D64ADMK 03559000
         DROP  R4                                              @D64ADOW 03560000
         LA    RF,20             SETUP FUNCTION CODE FREEMAIN  @D64XDOW 03561000
         L     RC,ASGEXIT        GET BASE OF                   @D64XDOW 03562000
         L     RC,AEXITGVI-SGEXIT(,RC) ... SUBROUTINE          @D64XDOW 03563000
         BASSM R8,RC              FREE SPACE                   @D64XDOW 03564000
*SGLINK  EXITFVIS,INPUT=(R0,R1,R8,RA,RC,RF),OUTPUT=RF,WORK=R0           03565000
         L     RC,TCBATCBE       RELOAD                        @D64XDOW 03566000
         L     RC,PTCBAPTC       ...PSEUDO TCB-EXTENSION       @D64XDOW 03567000
         XC    PTCBASDW,PTCBASDW  NO SDWA FOR EXIT AVAILABLE   @D64ADOW 03568000
ABRTY800 DS    0H                                              @D64ADOW 03569000
         L     R8,TIBPTR                                       @D64ADOW 03570000
         USING TIBADR,R8                                       @D64ADOW 03571000
***                                                                     03572000
***      IF THE CURRENT AB-TYPE EXIT WAS NESTED EXIT, THE EXIT          03573000
***      WHICH GOT THE TERMINATION CONDITION MUST BE ENTERED            03574000
***                                                                     03575000
         C     RC,TCBATCBE        ANY NESTING LEVEL ACTIVE     @D64ADOW 03576000
         BE    ABRTY820           NO, --->                     @D64ADOW 03577000
***                               YES, MOST RECENT ERROR IS RETRIED     03578000
***                               PROCESS NOW NEXT OLDER ERROR          03579000
***                               NESTED EXITS ARE DEACTIVATED WHEN     03580000
***                               SELECTED EXIT RETRIES/PERCOLATES      03581000
         L     R4,TCBATCBE        GET NORMAL TCBX ADDR         @D64ADOW 03582000
         L     R6,PTCBAPTC        GET PREVIOUS PSEUDO TCBX     @D64ADOW 03583000
         ST    R6,PTCBAPTC-TCBXADR(,R4) REMOVE CURRENT PSEUDO  @D64ADOW 03584000
***                               TCBX FROM CHAIN                       03585000
         L     R1,PTCBSDWA        SDWA AVAILABLE               @D64ADOW 03586000
         LA    R1,0(,R1)          ...                          @D64ADOW 03587000
         LTR   R1,R1              ...                          @D64ADOW 03588000
         BZ    ABRTY810           NO                           @D64ADOW 03589000
         LA    R0,SDWATLEN                                     @D64ADOW 03590000
*** FREEVIS OF MASTER SDWA                                              03591000
*        SFREEVIS ADDRESS=(1),LENGTH=(0)                                03592000
         SFREEVIS ADDRESS=(1),LENGTH=(0)                       @D64ADMK 03593000
*END OF SFREEVIS MACRO                                                  03594000
         SPACE                                                          03595000
ABRTY810 DS    0H                                              @D64ADOW 03596000
         LA    R4,PTCBPFIX        LENGTH OF PSEUDO-TCBX PREFIX @D64ADOW 03597000
         LR    R1,RC              COPY CURRENT PSEUDO TCBX ADDR@D64ADOW 03598000
         AR    R1,R4                                           @D64ADOW 03599000
         LA    R0,PTCBLENG        LENGTH OF PSEUDO TCBX        @D64ADOW 03600000
*** FREEVIS OF PSEUDO TCBX                                              03601000
*        SFREEVIS ADDRESS=(1),LENGTH=(0)                                03602000
         SFREEVIS ADDRESS=(1),LENGTH=(0)                       @D64ADMK 03603000
***END OF SFREEVIS MACRO                                                03604000
         SPACE                                                          03605000
         B     ABRTY960           SELECT NEXT NESTING LEVEL    @D64ADOW 03606000
ABRTY820 DS    0H                                              @D64ADOW 03607000
         NI    TCBABEX,XFF-EXITACT CLEAR EXIT ACTIVE BIT       @D64ADMK 03608000
         ICM   RE,B'1111',PSATOLD GET MVS TCB ADDR             @D64ADOW 03609000
         BZ    ABRTY840                                        @D64ADOW 03610000
         XC    TCBCMPC-TCB(3,RE),TCBCMPC-TCB(RE) CLEAR ABEND CO@D64ADOW 03611000
ABRTY840 DS    0H                                              @D64ADMK 03612000
         MVC   TCBEXITF,PTCBEXEI  REACTIVATE STACKED EXIT      @D64ADOW 03613000
         MVI   PTCBEXEI,X00       ... AND CLEAR INDICATOR      @D64ADOW 03614000
         AGO   .REMCOD1                                        @D68CDOW         
         B     ABRTYXX1                                        @D66XXOW         
***                                                                     03615000
***      IF AN FRR IS RETRYING WE ASSUME THAT THE FRR-RETRY ROUTINE     03616000
***      DEACTIVATES ASYNCHRONOUS EXITS IF NECESSARY                    03617000
***                                                                     03618000
         CLI   PTCBEXFA,TCBEXFRR  IS FRR RETRYING              @D64ADOW 03619000
         BE    ABRTY940           YES, --->                    @D64ADOW 03620000
ABRTYXX1 DS    0H                                              @D66XXOW         
***                                                                     03621000
.REMCOD1 ANOP                                                  @D68CDOW         
ABRTY850 DS    0H                                              @D64ADOW 03622000
         TM    TCBEXITF,TCBPCACT+TCBITACT+TCBOCACT PC|IT|OC    @D64ADOW 03623000
***                               EXIT TO BE DEACTIVATED                03624000
         BZ    ABRTY940           NO , --->                    @D64ADOW 03625000
         AGO   .REMCOD2                                        @D68CDOW         
         B     ABRTYXX2                                        @D66XXOW         
         L     R7,TCBXTQCA        GET IT EXIT BLOCK            @D64ADOW 03626000
         CLI   TCBEXITF,TCBITACT  IT EXIT TO BE REACTIVATED    @D64ADOW 03627000
         BE    ABRTY860           YES,--->                     @D64ADOW 03628000
         L     R7,TCBPCEX         GET PC EXIT BLOCK            @D64ADOW 03629000
         CLI   TCBEXITF,TCBPCACT  PC EXIT TO BE REACTIVATED    @D64ADOW 03630000
         BE    ABRTY860           YES,--->                     @D64ADOW 03631000
         L     R7,PCBPTR          POINT TO PCB                 @D64ADOW 03632000
         L     R7,PCBOCPTR-PCBADR(,R7) OC ENTRY IN PCB         @D64ADOW 03633000
ABRTY860 DS    0H                                              @D64ADOW 03634000
         USING EXITBLK,R7                                      @D64ADOW 03635000
***                                                                     03636000
***      IF AN ARR IS RETRYING ALL ASYNCHRONOUS EXITS HAVE TO BE        03637000
***      DEACTIVATED IF THE EXIT WAS ACTIVATED WITH A                   03638000
***      LINKAGE STACK LEVEL NEWER OR EQUAL TO THE LINKAGE STACK        03639000
***      LEVEL RELATED TO THE ARR                                       03640000
***                                                                     03641000
         CLI   PTCBEXFA,TCBEXARR  IS ARR RETRYING              @D64ADOW 03642000
         BNE   ABRTY870           NO,  --->                    @D64ADOW 03643000
         L     R1,TCBX1CRF        GET CURRENT LINK STACK ENTRY @D64ADOW 03644000
         USING LSTKEDSC,R1                                     @D64ADOW 03645000
         L     R2,EXITSLSK        LS ENTRY AT EXIT ACTIVATION  @D64ADOW 03646000
         CLC   LSTKSI,LSTKSI-LSTKEDSC(R2) COMPARE SECTION ID   @D64ADOW 03647000
         BH    ABRTY940           HIGHER, CONT IN ASYCH EXITRTN@D64ADOW 03648000
         BL    ABRTY920           LOWER, DEACTIVATE EXIT       @D64ADOW 03649000
         CR    R1,R2              SAME SECTION, COMP ADDR      @D64ADOW 03650000
         BH    ABRTY940           HIGHER, CONT IN ASYCH EXITRTN@D64ADOW 03651000
         B     ABRTY920           ELSE GOTO DEACTIVATE EXIT    @D64ADOW 03652000
ABRTY870 DS    0H                                              @D64ADOW 03653000
***                                                                     03654000
***      IF A FESTAE IS RETRYING ALL ASYNCHRONOUS EXITS HAVE TO BE      03655000
***      DEACTIVATED FOR WHICH THE SAVED RB ADDR IS NOT IN THE          03656000
***      RB CHAIN ANYMORE OR IF THE SAVED RB IS THE CURRENT RB AND      03657000
***      BIT EXFESDEF ON IN EXIT BLOCK                                  03658000
***                                                                     03659000
         CLI   PTCBEXFA,TCBEXFES  IS FESTAE RETRYING           @D64ADOW 03660000
         BNE   ABRTY900           NO,  --->                    @D64ADOW 03661000
         L     RE,PSATOLD         GET MVS TCB ADDR             @D64ADOW 03662000
         CLC   EXITSRB,TCBRBP-TCB(RE) SAVED RB = CURRENT       @D64ADOW 03663000
         BNE   ABRTY880           NO --->                      @D64ADOW 03664000
         TM    EXITSFLG,EXFESDEF  WAS FESTAE DEFINED EARLIER   @D64ADOW 03665000
         BO    ABRTY920           YES, ---> DEACTIVATE         @D64ADOW 03666000
         B     ABRTY940           ELSE ---> KEEP EXIT          @D64ADOW 03667000
ABRTY880 DS    0H                                              @D64ADOW 03668000
         ICM   RE,B'1111',RBLINK-RBSECT(RE) GET PREVIOUS RB    @D64ADOW 03669000
         BZ    ABRTY920           SAVED RB NOT IN CHAIN --->   @D64ADOW 03670000
         C     RE,EXITSRB         SAVED RB IN CHAIN            @D64ADOW 03671000
         BE    ABRTY940           YES, ---> KEEP EXIT          @D64ADOW 03672000
         B     ABRTY880           CHECK NEXT RB                @D64ADOW 03673000
ABRTY900 DS    0H                  NOW HANDLING ESTAEX         @D64ADOW 03674000
***                                                                     03675000
***      IF A ESTAEX IS RETRYING ALL ASYNCHRONOUS EXITS HAVE TO BE      03676000
***      DEACTIVATED AS LONG AS THE EXIT BLOCK ADDR IN R7 IS NOT        03677000
***      CONTAINED IN EXABACTV OF THE CURRENT ESTAEX (I.E. THE ESTAEX   03678000
***      TYPE EXIT NOT DEFINED WITHIN THE ASYNCHRONOUS EXIT)            03679000
***                                                                     03680000
         L     RE,PTCBEACT        EXIT BLOCK OF CURRENT ESTAEX @D64ADOW 03681000
         C     R7,EXABACTV-EXITBLK(,RE) ACTIV AT ESTAEX DEFINIT@D64ADOW 03682000
         BE    ABRTY940           YES, --->                    @D64ADOW 03683000
ABRTY920 DS    0H                                              @D64ADOW 03684000
ABRTYXX2 DS    0H                                              @D66XXOW         
.REMCOD2 ANOP                                                  @D68CDOW         
         LR    R3,RD              SAVE CURRENT BASE            @D64ADOW 03685000
         L     RD,ASGEXIT         GET BASE OF SUBROUTINE       @D64ADOW 03686000
         USING SGEXIT,RD                                       @D64ADOW 03687000
         BAS   RE,SVC95DEA        DEACTIVATE ASYNCH EXIT       @D64ADOW 03688000
*SGLINK SVC95DEA,INPUT=(RA,RD,RE)                                       03689000
*** TCBEXITF INDICATES EXIT TO BE HANDLED AND CONTAINS NEXT STACKED     03690000
*** EXIT AT RETURN                                                      03691000
         LR    RD,R3              RESTORE BASE                 @D64ADOW 03692000
         USING ABROUT,RD                                       @D64ADOW 03693000
         B     ABRTY850           CHECK NEXT EXIT              @D64ADOW 03694000
ABRTY940 DS    0H                 RETURN TO MAINLINE           @D64ADOW 03695000
         MVI   TIBCNCL,ZERO       CLEAR CANCEL CODE            @D64ADOW 03696000
         NI    TIBFLAG5,XFF-TIBXMEMC RESET X-MEM INDICATOR     @D64XDOW 03697000
         MVI   TCBEXIFL,X00       RESET TERMINATOR IF-FLAG     @D64ADOW 03698000
         NI    TCBEXITG,TCBABSPC+TCBABS31 KEEP AB-EXIT DEFINED @D64ADOW 03699000
***                               ... INDICATOR                         03700000
         XC    PTCBEACT,PTCBEACT  NO AB-TYPE                   @D64ADOW 03701000
         XC    PTCBEXSA,PTCBEXSA  ... EXIT                     @D64ADOW 03702000
         XC    PTCBEXFA,PTCBEXFA  ... ACTIVE                   @D64ADOW 03703000
         TM    TCBXFLG1,TCBXGETF  GETFLD FIELD=ALET PERFORMED  @DY46192         
         BNO   ABRTY960           NO, --->                     @DY46192         
         MVC   TCBX1CR8(2),CSYSEAX SETUP EAX IN SAVE AREA      @DY46192         
         DROP  RC                                              @D64ADOW 03704000
ABRTY960 DS    0H                 ENTRY IF NEXT NESTING LVL SEL@D64ADOW 03705000
         L     R9,PCBPTR          POINT TO PCB                 @D64ADOW 03706000
         USING PCBADR,R9                                       @D64ADOW 03707000
         TM    PCBFLAG,PERACT     TEST PER BIT IN PCBFLAG      @D64ADOW 03708000
         BZ    ABRTY980           PER BIT NOT ON   --->        @D64ADOW 03709000
         DROP  R9                                              @D64ADOW 03710000
         OI    SVEPSW,PERMASK     ENABLE PROGR.EVENT RECORDING @D64ADOW 03711000
ABRTY980 DS    0H                                              @D64ADOW 03712000
         SLR   RF,RF               SELECT FUNCTION             @D64ADOW 03713000
         L     RC,ASGEXIT         RESCHEDULE                   @D64ADOW 03714000
         L     RC,ACHKDLAY-SGEXIT(,RC) ... DELAYED VTAM AND    @D64ADOW 03715000
         BASSM RE,RC              ... TIMER EXITS              @D64ADOW 03716000
*SGLINK CHKDELAY,INPUT=(R8,RC,RE,RF),WORK=(R4)                          03717000
         L     RC,TCBATCBE        LOAD TCBX ADDR               @D64ADOW 03718000
         USING TCBXADR,RC                                      @D64ADOW 03719000
         L     R2,TCBX1CRF        CLEAR NEXT                   @D64ADOW 03720000
         USING LSTKEDSC,R2        ... ENTRY SIZE IN            @D64ADOW 03721000
         XC    LSTKNES,LSTKNES    ... CURRENT LINKAGE STACK    @D64ADOW 03722000
         DROP  R2                 ... ENTRY DESCRIPTOR         @D64ADOW 03723000
         B     ABROUTEX           SETUP CR1 AND CR7            @D64ADOW 03724000
         SPACE 3                                                        03725000
ABRTYER1 DS    0H                 SETRP RETRY=ERROR            @D64ADOW 03726000
         LA    R1,D2C5R4F0        ... NOT SUPPORTED            @D64ADOW 03727000
*        B     ABRTYERR                                        @D64ADOW 03728000
ABRTYERR DS    0H                                              @D64ADOW 03729000
         LM    R2,R3,ABRTYSRP     MACRO NAME                   @D64ADOW 03730000
         SLR   R6,R6              NO SUBREASON CODE            @D64ADOW 03731000
         L     RC,ASGEXIT         GET COMMON CANCEL EXIT       @D64ADOW 03732000
         L     RC,ACOMER48-SGEXIT(,RC) ... ADDRESS             @D64ADOW 03733000
         BSM   0,RC               CANCEL WITH ERR48            @D64ADOW 03734000
         DROP  R8                                              @D64ADOW 03735000
         DROP  RA                                              @D64ADOW 03736000
         DROP  RB                                              @D64ADOW 03737000
         DROP  RC                                              @D64ADOW 03738000
         SPACE 3                                                        03739000
***      SUBROUTINE ADDRESSES                                           03740000
AABSDWAI DC    A(ABSDWAIN)      INITIALIZE SDWA                @D64ADOW 03741000
AABFILLS DC    A(ABFILLSD)      FILL SDWA                      @D64ADOW 03742000
AABSEGMT DC    A(ABSEGMTO)      RETRIEVE SEGMENT TABLE ORIGIN  @D64ADOW 03743000
AABSETAR DC    A(ABSETARR)      SET UP RECOVERY/RETRY ENVIRONME@D64ADOW 03744000
AAMOVMSG DC    A(ABMOVMSG)      MOVE ADDITIONAL CANCEL INFO    @D64ADOW 03745000
AACLEANX DC    A(ABCLEANX)      ETXR/POST EXIT CLEAN UP        @D64ADOW 03746000
         SPACE 3                                                        03747000
***      CONSTANTS AND ADDRESSES                                        03748000
         DS    0F                                              @D64ADOW 03749000
AESTAEXR DC    A(ESTAEXRT)        RETURN ADDR(ESTAEX TYPE EXIT)@D64ADOW 03750000
AESTFRRR DC    A(ESTFRRRT)        RETURN ADDR(FRR EXIT)        @D64ADOW 03751000
ABRTYSRP DC    CL8'SETRP   '                                   @D64ADOW 03752000
         SPACE 3                                                        03753000
***      EQUATES                                                        03754000
ABNOSDWA EQU   12                 NO SDWA AVAILABLE            @D64ADMK 03755000
ABYESDWA EQU   16                 SDWA AVAILABLE               @D64ADMK 03756000
         DROP  RD                                              @D64ADOW 03757000
         EJECT                                                          03758000
*********************************************************************** 03759000
*                                                                     * 03760000
*        FILL SDWA WITH ERROR INFORMATION                             * 03761000
*                                                                     * 03762000
*********************************************************************** 03763000
         SPACE 1                                                        03764000
         USING SDWA,R1                                         @D64ADOW 03765000
         USING ABFILLSD,R4                                     @D64ADOW 03766000
         USING TCBADR,RA                                       @D64ADOW 03767000
         USING TCBXADR,RC                                      @D64ADOW 03768000
ABFILLSD DS    0H                                              @D64ADOW 03769000
*SGLINK ABFILLSD,S,INPUT=(R1,R3,R4,RA,RC),                             X03770000
               WORK=(R0,R2,R5,R6,R7,R8,R9,RB,RE,RF)                     03771000
         L     R8,TIBPTR          GET TIB OF CURRENT TASK      @D64ADOW 03772000
         USING TIBADR,R8                                       @D64ADOW 03773000
         L     R5,SDWAXPAD        ADDRESS OF SDWAPTRS          @D64ADOW 03774000
         USING SDWAPTRS,R5                                     @D64ADOW 03775000
         L     R5,SDWASRVP        ADDRESS OF SDWARC1           @D64ADOW 03776000
         USING SDWARC1,R5                                      @D64ADOW 03777000
         ICM   RB,B'1111',PSATOLD GET MVS TCB ADDR             @D64ADOW 03778000
         BNZ   ABFIL020           EMULATION MODE --->          @D64ADOW 03779000
         SLR   R9,R9                                           @D64ADOW 03780000
         IC    R9,TIBCNCL         CANCEL CODE TO SDWA          @D64ADOW 03781000
         ST    R9,SDWAABCC        ... IN CASE OF NATIVE VSE    @D64ADOW 03782000
         LR    R9,R5              SAVE SDWARC1 ADDR            @D64ADOW 03783000
         LA    R5,SDWARA          SDWA FIELD TO CONTAIN        @D64ADOW 03784000
***                               ... ADDITIONAL CANCEL INFORMATION     03785000
         L     R6,ADISPSER        GET ADDRESS OF DISP.SERVICES @D64ADOW 03786000
         LA    R0,24              GET FUNCTION CODE            @D64ADOW 03787000
         BASSM R7,R6              RETRIEVE MSG INFO            @D64ADOW 03788000
*SGLINK  DISPSE24,INPUT=(R0:FCT_CODE,R5,R6:DISPSERV_BASE,              X03789000
               R7:RETURN_ADDR,R8:TIB_ADDR,RA:TCB_ADDR),                X03790000
               WORK=(R0,R2,RF)                                          03791000
         NOP   ABFIL010           RETURN IF MSG MOVED          @D64ADOW 03792000
***      B     ABFIL010           RETURN IF MSG NOT MOVED      @D64ADOW 03793000
***END OF BRANCH TABLE                                                  03794000
ABFIL010 DS    0H                                              @D64ADOW 03795000
         LR    R5,R9              RESTORE SDWARC1 ADDR         @D64ADOW 03796000
         B     ABFIL050                                        @D64ADOW 03797000
***END OF BRANCH TABLE                                                  03798000
ABFIL020 DS    0H                                              @D64ADOW 03799000
         USING TCB,RB                                          @D64ADOW 03800000
         TM    TCBCMPF,TCBRV316   REASON CODE IN TCBARC VALID  @D64ADOW 03801000
         BZ    ABFIL040           NO                           @D64ADOW 03802000
         OI    SDWACMPF,SDWARCF   INDICATE REASON CODE SET     @D64ADOW 03803000
         MVC   SDWAHRC,TCBARC     MOVE REASON CODE             @D64ADOW 03804000
ABFIL040 DS    0H                                              @D64ADOW 03805000
         MVC   SDWACMPC(3),TCBCMPC SYSTEM AND USER ABEND CODE  @D64ADOW 03806000
         DROP  RB                                              @D64ADOW 03807000
ABFIL050 DS    0H                                              @D64ADOW 03808000
         TM    TCBEXITG,TCBABDMP  DUMP REQUIRED WITH ABEND MACR@D64ADOW 03809000
         BNO   ABFIL060                                        @D64ADOW 03810000
         OI    SDWACMPF,SDWAREQ   PASS DUMP REQ'D INDICATION   @D64ADOW 03811000
         NI    TCBEXITG,XFF-TCBABDMP ...                       @D64ADOW 03812000
ABFIL060 DS    0H                                              @D64ADOW 03813000
         CLI   TIBCNCL,CANCX20    WAS IT PROG CHECK            @D64ADOW 03814000
         BNE   ABFIL080           NO --->                      @D64ADOW 03815000
         OI    SDWAERRA,SDWAPCHK  INDICATE PROGRAM CHECK       @D64ADOW 03816000
ABFIL080 DS    0H                                              @D64ADOW 03817000
         TM    TCBEXITG,TCBSFORC  ABEND FORCED                 @D64ADOW 03818000
         BNO   ABFIL090           NO, --->                     @D64ADOW 03819000
         OI    SDWAERRA,SDWAABTM  INDICATE SYSTEM FORCED ABEND @D64ADOW 03820000
ABFIL090 DS    0H                                              @D64ADOW 03821000
         ICM   R9,B'1111',PSATOLD MVS EMULATION ACTIVE         @D64ADOW 03822000
         BZ    ABFIL100           NO,                          @D64ADOW 03823000
         L     R9,TCBRBP-TCB(,R9) GET CURRENT RB/SVRB          @D64ADOW 03824000
         TM    RBSTAB1-RBSECT(R9),RBFTSVRB IS THIS A SVRB      @D64ADOW 03825000
         BZ    ABFIL100           NO,                          @D64ADOW 03826000
         OI    SDWAERRB,SDWASRBM  INDICATE ERROR IN SRB MODE   @D64ADOW 03827000
ABFIL100 DS    0H                                              @D64ADOW 03828000
         CLI   PTCBEXEI,TCBITACT  TIMER EXIT ACTIVE            @D64ADOW 03829000
         BNE   ABFIL110           NO, --->                     @D64ADOW 03830000
         OI    SDWAERRC,SDWAIRB   INDICATE ERROR IN TIMER EXIT @D64ADOW 03831000
ABFIL110 DS    0H                                              @D64ADOW 03832000
         TM    PTCBFLG1,TCBXPONY  ONLY PERCOLATE ALLOWED       @D64ADOW 03833000
         BNO   ABFIL120           NO SKIP SDWA SETTING         @D64ADOW 03834000
         OI    SDWAERRD,SDWACLUP  INHIBIT RETRY                @D64ADOW 03835000
ABFIL120 DS    0H                                              @D64ADOW 03836000
         L     RB,TCBSAVE         GET USER SAVE AREA           @D64ADOW 03837000
         USING SVEARA,RB          ADDRESSABILITY               @D64ADOW 03838000
         MVC   SDWAEC1,SVEPSW     PSW AT TIME OF ERROR         @D64ADOW 03839000
         MVC   SDWAAEC1(4),INTINFO INTERRUPTION CODE           @D64ADOW 03840000
         MVC   SDWAGR00(36),SVER00 GPRS AT TIME OF ERROR       @D64ADOW 03841000
         MVC   SDWAGR09(28),SVER09 ...                         @D64ADOW 03842000
         L     R9,ASVPCSAV        GET SPEC SAVE AREA ADDR      @D64ADOW 03843000
         USING SVPCSAVE,R9                                     @D64ADOW 03844000
         TM    TIBFLAG2,SVPCCNCL  STATUS SAVED IN SPEC SAVEAREA@D64ADOW 03845000
         BNO   ABFIL130           NO, --->                     @D64ADOW 03846000
         CLC   SVPCTID(2),TID     STILL USED FOR CURRENT TASK  @D64ADOW 03847000
         BNE   ABFIL130           NO, --->                     @D64ADOW 03848000
         MVC   SDWAEC1,SVPCSAVE+8 PSW AT TIME OF ERROR         @D64ADOW 03849000
         MVC   SDWAAEC1(4),SVPCINFO INTERRUPTION CODE          @D64ADOW 03850000
         MVC   SDWAGR09(28),SVPCSAVE+16  REGS AT TIME OF ERROR @D64ADOW 03851000
         MVC   SDWAGR00(36),SVPCSAVE+16+28 ...                 @D64ADOW 03852000
         DROP  R9                                              @D64ADOW 03853000
ABFIL130 DS    0H                                              @D64ADOW 03854000
         NI    TIBFLAG2,XFF-SVPCCNCL RESET SPEC SAVEAREA IND   @DY45037 03854500
         XC    SDWACTL1,SDWACTL1  CLEAR BC MODE PSW            @D64ADOW 03855000
         L     R9,TCBARSAV        GET ADDR OF ACC REG SAVEAREA @D64ADOW 03856000
         MVC   SDWAARER(64),0(R9) PASS ACC REG TO RECOVERY RTN @D64ADOW 03857000
         MVC   SDWACRER(64),TCBX1CRS CREG'S FOR DEBUGGING      @DY46084 03857000
         CLI   PTCBEXFA,TCBEXFRR  FRR TO BE ACTIVATED          @D64ADOW 03858000
         BE    ABFIL150           YES, SKIP FREEING RESOURCES  @D64ADOW 03859000
***                               ... AND SETUP OF BC-MODE-PSW @D64ADOW 03860000
         MVC   SDWACTL1,SDWAEC1   PSW AT TIME OF ERROR         @D64ADOW 03861000
         NI    SDWACTL1+2,X3F     RESET AR MODE                @D64ADOW 03862000
         TM    SDWACTL1+4,X80     INTERRUPTED IN 31 BIT MODE   @D64ADOW 03863000
         BNO   ABFIL140           NO                           @D64ADOW 03864000
         XC    SDWACTL1+5(3),SDWACTL1+5 CLEAR ADDR PORTION     @D64ADOW 03865000
ABFIL140 DS    0H                                              @D64ADOW 03866000
         IC    R9,SDWAAEC1+1      GET INSTR LENGTH CODE        @D64ADOW 03867000
         SLL   R9,5               ... TO PROPER POSITION       @D64ADOW 03868000
         STC   R9,SDWACTL1+4      ... TO BC MODE PSW           @D64ADOW 03869000
         OC    SDWACTL1+4(1),SDWACTL1+2 OR COND CODE & PGM MASK@D64ADOW 03870000
         MVC   SDWACTL1+2(2),SDWAAEC1+2 INTERRUPTION CODE      @D64ADOW 03871000
         TM    TIBFLAG1,LTAOWNER  LTA OCCUPIED BY TASK         @D64ADOW 03872000
         BNO   ABFIL150           NO --->                      @D64ADOW 03873000
         LR    R9,R5              SAVE SDWARC1 ADDR            @D64ADOW 03874000
         L     R6,DISPAD          SETUP INPUT REGISTER         @D64ADOW 03875000
         USING DISP,R6                                         @D64ADOW 03876000
         BAS   R7,FREELTA         FREE LTA                     @D64ADOW 03877000
*SGLINK FREELTA,INPUT=(R6,R7,R8,RA),WORK=(R5,RE,RF)                     03878000
         DROP  R6                                              @D64ADOW 03879000
         DROP  R8                                              @D64ADOW 03880000
         LR    R5,R9              RESTORE SDWARC1 ADDR         @D64ADOW 03881000
         L     RB,TCBSAVE         FREELTA SWITCHED SAVEAREA    @D64ADOW 03882000
ABFIL150 DS    0H                                              @D64ADOW 03883000
         MVC   SDWANAME,SVENAME   COPY PROGRAM NAME            @D64ADOW 03884000
         MVC   SDWAEC2,SVEPSW     PSW AT TIME OF LAST INTERRUPT@D64ADOW 03885000
         MVC   SDWAAEC2(4),INTINFO INTERRUPTION CODE           @D64ADOW 03886000
         MVC   SDWASR00(36),SVER00 GPRS FROM LAST INTERRUPT    @D64ADOW 03887000
         MVC   SDWASR09(28),SVER09 GPRS                        @D64ADOW 03888000
         XC    SDWACTL2,SDWACTL2  CLEAR BC MODE PSW            @D64ADOW 03889000
         CLI   PTCBEXFA,TCBEXFRR  FRR TO BE ACTIVATED          @D64ADOW 03890000
         BE    ABFIL190           YES, SKIP SETUP BC-MODE-PSW  @D64ADOW 03891000
         MVC   SDWACTL2,SVEPSW    PSW AT TIME OF ERROR         @D64ADOW 03892000
         NI    SDWACTL2+2,X3F     RESET AR MODE                @D64ADOW 03893000
         TM    SDWACTL2+4,X80     INTERRUPTED IN 31 BIT MODE   @D64ADOW 03894000
         BNO   ABFIL180           NO                           @D64ADOW 03895000
         XC    SDWACTL2+5(3),SDWACTL2+5 CLEAR ADDR PORTION     @D64ADOW 03896000
ABFIL180 DS    0H                                              @D64ADOW 03897000
         IC    R9,INTINFO+1       GET INSTR LENGTH CODE        @D64ADOW 03898000
         SLL   R9,5               ... TO PROPER POSITION       @D64ADOW 03899000
         STC   R9,SDWACTL2+4      ... TO BC MODE PSW           @D64ADOW 03900000
         OC    SDWACTL2+4(1),SDWACTL2+2 OR COND CODE & PGM MASK@D64ADOW 03901000
         MVC   SDWACTL2+2(2),INTINFO+2 INTERRUPTION CODE       @D64ADOW 03902000
ABFIL190 DS    0H                                              @D64ADOW 03903000
         L     R9,TCBARSAV        GET ADDR OF ACC REG SAVEAREA @D64ADOW 03904000
         MVC   SDWAARSV(64),0(R9) PASS ACC REG TO RECOVERY RTN @D64ADOW 03905000
         MVI   SDWASPID,X00       SET SUBPOOL ID               @D64ADOW 03906000
         LA    R9,SDWATLEN        TOTAL LENGTH TO              @D64ADOW 03907000
         STCM  R9,B'0111',SDWALNTH ... TO SDWA                 @D64ADOW 03908000
         BR    R3                 RETURN                       @D64ADOW 03909000
         DROP  R1                                              @D64ADOW 03910000
         DROP  R4                                              @D64ADOW 03911000
         DROP  R5                                              @D64ADOW 03912000
         DROP  RA                                              @D64ADOW 03913000
         DROP  RB                                              @D64ADOW 03914000
         DROP  RC                                              @D64ADOW 03915000
         EJECT                                                          03916000
*********************************************************************** 03917000
*                                                                     * 03918000
*        SETUP ENVIRONMENT FOR ARR RECOVERY AND RETRY ROUTINES        * 03919000
*                                                                     * 03920000
*********************************************************************** 03921000
         SPACE 1                                                        03922000
         USING TCBADR,RA                                       @D64ADOW 03923000
         USING SVEARA,RB                                       @D64ADOW 03924000
         USING TCBXADR,RC                                      @D64ADOW 03925000
         USING ABSETARR,R8                                     @D64ADOW 03926000
ABSETARR DS    0H                                              @D64ADOW 03927000
         STM   R0,RF,SVCWORKA     SAVE WORK REGISTER           @D64ADOW 03928000
         L     R4,TCBATCBE        GET NORMAL TCBX ADDR         @D64ADOW 03929000
         L     R1,PTCBEACT        GET ETE ADDR                 @D64ADOW 03930000
         USING ETE,R1                                          @D64ADOW 03931000
         L     R9,PTCBEXSA        GET LINK STACK LEVEL         @D64ADOW 03932000
         LA    RE,LSTATLN1        LENGTH(STATUS ENTRY) -       @D64ADOW 03933000
***                                LENGTH(DESCRIPTOR)                   03934000
         SLR   R9,RE              BACK TO BEGIN OF ENTRY       @D64ADOW 03935000
         USING LSTKSTAT,R9                                     @D64ADOW 03936000
         MVC   TCBX1CR3+2-TCBXADR(2,R4),LSTKPASN NEW SASN      @D64ADOW 03937000
         SLR   RE,RE                                           @D64ADOW 03938000
         ICM   RE,3,ETEASID       GET ASID TO BECOME PASN      @D64ADOW 03939000
         BNZ   ABSETA20                                        @D64ADOW 03940000
         ICM   RE,3,LSTKPASN      GET IT FROM LINK STACK       @D64ADOW 03941000
         B     ABSETA40                                        @D64ADOW 03942000
ABSETA20 DS    0H                                              @D64ADOW 03943000
         TM    ETEOPTB1,ETESASNC  SECONDARY-ASN CONTOL ON      @D64ADOW 03944000
         BNO   ABSETA40                                        @D64ADOW 03945000
         STH   RE,TCBX1CR3+2-TCBXADR(,R4) MODIFY SASN          @D64ADOW 03946000
ABSETA40 DS    0H                                              @D64ADOW 03947000
         STH   RE,TCBX1CR4+2-TCBXADR(,R4) SET UP PASN          @D64ADOW 03948000
         ICM   RE,3,ETEEKM        GET PKM FROM ETE             @D64ADOW 03949000
         TM    ETEOPTB1,ETEPKMK   'OR' OR REPLACE              @D64ADOW 03950000
         BO    ABSETA50           REPLACE --->                 @D64ADOW 03951000
         SLR   R5,R5                                           @D64ADOW 03952000
         ICM   R5,3,LSTKPKM       PKM FROM LINK STACK          @D64ADOW 03953000
         OR    RE,R5              'OR' BOTH TOGETHER           @D64ADOW 03954000
ABSETA50 DS    0H                                              @D64ADOW 03955000
         STH   RE,TCBX1CR3-TCBXADR(,R4)   SET UP PKM           @D64ADOW 03956000
         ICM   RE,3,ETEEAX        GET EAX FROM ETE             @D64ADOW 03957000
         TM    ETEOPTB1,ETEEAXC   EAX TO BE REPLACED           @D64ADOW 03958000
         BO    ABSETA60           YES, --->                    @D64ADOW 03959000
         ICM   RE,3,LSTKEAX       GET EAX FROM LINK STACK      @D64ADOW 03960000
ABSETA60 DS    0H                                              @D64ADOW 03961000
         STH   RE,TCBX1CR8-TCBXADR(,R4)   SET UP EAX           @D64ADOW 03962000
         MVC   SVEPSW+1(1),LSTKPSW+1 KEY AT ARR DEFINITION     @D64ADOW 03963000
***                               (KEY OF PC ISSUER)                    03964000
         TM    ETEOPTB1,ETEPKC    KEY SPECIFED IN ETE          @D64ADOW 03965000
         BNO   ABSETA62           NO --->                      @D64ADOW 03966000
         MVC   SVEPSW+1(1),ETEEK  SET UP PSW KEY               @D64ADOW 03967000
ABSETA62 DS    0H                                              @D64ADOW 03968000
         NI    SVEPSW+1,XF0       RESET M-W-P BITS             @D64ADOW 03969000
         OI    SVEPSW+1,X0D       MAKE BYTE VALID, PROBLEM STAT@D64ADOW 03970000
         TM    ETEPBYTE,ETEPS     IS PROBLEM STATE REQUIRED    @D64ADOW 03971000
         BO    ABSETA70           YES BYTE IS CORRECT          @D64ADOW 03972000
         NI    SVEPSW+1,XFE       RESET PROBLEM STATE BIT      @D64ADOW 03973000
ABSETA70 DS    0H                                              @D64ADOW 03974000
         MVC   SVEPSW+2(2),PTCBEXPS+2 COPY ASC MODE AND        @D64ADOW 03975000
***                               PROGRAM MASK FROM TIME OF ERROR       03976000
         NI    SVEPSW+2,X3F       SET PSW TO PRIMARY ASC       @D64ADOW 03977000
         TM    ETEOPTB1,ETEASC    ARR TO BE CALLED IN AR MODE  @D64ADOW 03978000
         BNO   ABSETA80           NO, --->                     @D64ADOW 03979000
         OI    SVEPSW+2,X40       SET PSW TO AR MODE           @D64ADOW 03980000
ABSETA80 DS    0H                                              @D64ADOW 03981000
         LM    R0,RF,SVCWORKA     RELOAD REGISTER              @D64ADOW 03982000
         BR    RE                                              @D64ADOW 03983000
         DROP  R1                                              @D64ADOW 03984000
         DROP  R8                                              @D64ADOW 03985000
         DROP  R9                                              @D64ADOW 03986000
         DROP  RA                                              @D64ADOW 03987000
         DROP  RB                                              @D64ADOW 03988000
         DROP  RC                                              @D64ADOW 03989000
         EJECT                                                          03990000
*********************************************************************** 03991000
*                                                                     * 03992000
*        CLEAN UP FOR ETXR AND POST EXIT                              * 03993000
*                                                                     * 03994000
*********************************************************************** 03995000
         SPACE 1                                                        03996000
         USING TCBADR,RA                                       @D64ADOW 03997000
         USING ABCLEANX,R8                                     @D64ADOW 03998000
ABCLEANX DS    0H                                              @D64ADOW 03999000
         STM   R0,RF,SVCWORKA     SAVE CURRENT REGISTER        @D64ADOW 04000000
         L     R9,ASGMVSAP        GET BASE FOR SUBROUTINE      @D64ADOW 04001000
         USING SGMVSAPI,R9                                     @D64ADOW 04002000
         LA    RF,CLEANEX         ADDR OF SUBROUTINE           @D64ADOW 04003000
         O     RF,BIT0ON          FORCE 31 BIT MODE            @D64ADOW 04004000
         BASSM R7,RF              CALL ETXR/POST-EXIT CLEANUP  @D64ADOW 04005000
*SGLINK SGMAPICL,INPUT=(R7,R9,RA),WORK=(R1,R2,R5,R6,R8,RE,RF)           04006000
         DROP  R9                                              @D64ADOW 04007000
         L     R8,SVCWORKA+8*4    RESTORE BASE REGISTER        @D64ADOW 04008000
         L     R9,TCBATCBE        GET TCBX ADDR                @D64ADOW 04009000
         USING TCBXADR,R9                                      @D64ADOW 04010000
         L     R9,PTCBAPTC        GET PSEUDO-TCB-EXTENSION     @D64ADOW 04011000
ABCLEAN3 DS    0H                                              @D64ADOW 04012000
         NI    PTCBEXEI,XFF-TCBEXACT-TCBPOACT RESET ETXR AND   @D64ADOW 04013000
***                               POST EXIT INDICATORS IN ALL CB'S      04014000
         C     R9,TCBATCBE        NEXT NESTING LEV AVAILABLE   @D64ADOW 04015000
         BE    ABCLEAN5           NO, --->                     @D64ADOW 04016000
         L     R9,PTCBAPTC        GET PREVIOUS PSEUDO TCBX     @D64ADOW 04017000
         B     ABCLEAN3                                        @D64ADOW 04018000
         DROP  R9                                              @D64ADOW 04019000
ABCLEAN5 DS    0H                                              @D64ADOW 04020000
         LM    R0,RF,SVCWORKA     RESTORE REGISTER             @D64ADOW 04021000
         BR    R7                                              @D64ADOW 04022000
         DROP  R8                                              @D64ADOW 04023000
         DROP  RA                                              @D64ADOW 04024000
         EJECT                                                          04025000
*********************************************************************** 04026000
*                                                                     * 04027000
*        INITIALIZE SDWA POINTERS                                     * 04028000
*           RTN NEEDS NO BASE REGISTER                                * 04029000
*                                                                     * 04030000
*********************************************************************** 04031000
         SPACE 1                                                        04032000
         USING SDWA,R1                                         @D64ADOW 04033000
         USING ABSDWAIN,R5                                     @D64ADOW 04034000
ABSDWAIN DS    0H                                              @D64ADOW 04035000
*SGLINK ABSDWAIN,S,INPUT=(R1,R5,R8),WORK=(RB,RF)                        04036000
         LA    RF,SDWAEND         ADDRESS OF SDWAPTRS          @D64ADOW 04037000
         ST    RF,SDWAXPAD        ...TO BASIC PART OF SDWA     @D64ADOW 04038000
         USING SDWAPTRS,RF                                     @D64ADOW 04039000
         LA    RB,SDWAPEND        ADDRESS OF SDWARC1           @D64ADOW 04040000
         ST    RB,SDWASRVP        ... TO SDWAPTRS              @D64ADOW 04041000
         LA    RB,SDWASEND-SDWASERV(,RB)   ADDRESS OF SDWARC2  @D64ADOW 04042000
         ST    RB,SDWAXIOM        ADDRESS OF SDWARC2           @D64ADOW 04043000
         LA    RB,SDWAIEND-SDWAIOMA(,RB)   ADDRESS OF SDWARC3  @D64ADOW 04044000
         ST    RB,SDWAXLCK        ADDRESS OF SDWARC3           @D64ADOW 04045000
         LA    RB,SDWALEND-SDWAFLCK(,RB)   ADDRESS OF SDWANRC1 @D64ADOW 04046000
         ST    RB,SDWADSRP        ADDRESS OF SDWANRC1          @D64ADOW 04047000
         LA    RB,SDWAREND-SDWADSR(,RB)    ADDRESS OF SDWANRC2 @D64ADOW 04048000
         ST    RB,SDWAXSPL        ADDRESS OF SDWANRC2          @D64ADOW 04049000
         LA    RB,SDWASEN-SDWASPLE(,RB)    ADDRESS OF SDWANRC3 @D64ADOW 04050000
         ST    RB,SDWADSPP        ADDRESS OF SDWANRC3          @D64ADOW 04051000
         MVC   SDWAID,ABSDWA      INITIALIZE EYE CATCHER       @D64ADOW 04052000
         BR    R8                 RETURN                       @D64ADOW 04053000
ABSDWA   DC    C'SDWA  '                                       @D64ADOW 04054000
         DROP  R1                                              @D64ADOW 04055000
         DROP  R5                                              @D64ADOW 04056000
         DROP  RF                                              @D64ADOW 04057000
         EJECT                                                          04058000
*********************************************************************** 04059000
*                                                                     * 04060000
*        MOVE ADDITIONAL ERROR INFO AND FREE INPUT AREA               * 04061000
*                                                                     * 04062000
*********************************************************************** 04063000
         SPACE 1                                                        04064000
         USING SVUARA,R4                                       @D64ADOW 04065000
         USING TIBADR,R8                                       @D64ADOW 04066000
         USING ABMOVMSG,R9                                     @D64ADOW 04067000
         USING TCBADR,RA                                       @D64ADOW 04068000
ABMOVMSG DS    0H                                              @D64ADOW 04069000
*SGLINK ABMOVMSG,S,INPUT=(R2,R4,R8,R9,RA,RE),WORK=(R0,R2,R5,R6,R7,RF)   04070000
         LTR   R2,R2                                           @D64ADOW 04071000
         BZ    ABMOVM40           GOTO RESET MESSAGE AREA ONLY @D64ADOW 04072000
         LA    R5,SVUABINF        ADDITIONAL INFO FOR AB EXIT  @D52GDIS 04073000
         L     R6,ADISPSER        GET ADDRESS OF DISP.SERVICES @D52GDIS 04074000
         LA    R0,24              GET FUNCTION CODE            @D61CDOW 04075000
         BASSM R7,R6              MOVE MSG INFO TO AB-SAVEAREA @D64ADOW 04076000
*SGLINK  DISPSERV,INPUT=(R0:FCT_CODE,R5:ADDR_TARGET_AREA,              X04077000
               R6:DISPSERV_BASE,R7:RETURN_ADDR,R8:TIB_ADDR,            X04078000
               RA:TCB_ADDR),WORK=(R0,R2,RF)                             04079000
***      RETURN (R7 + 0 : ADDITIONAL MSG INFORMATION MOVED              04080000
***              R7 + 4 : NO ADDITIONAL MSG INFO AVAILABLE)             04081000
         B     ABMOVM30           RETURN IF MSG MOVED          @D64ADOW 04082000
         B     ABMOVM50           RETURN IF NO MSG MOVED       @D61CDOW 04083000
***                                                                     04084000
ABMOVM30 DS    0H                 CLEAR UNUSED MSG PART        @D61CDOW 04085000
         LA    R7,63              LENGTH -1 OF                 @D64ADOW 04086000
         L     R6,0(,R5)          ... SVUABINF                 @D64ADOW 04087000
         LA    R6,4(,R6)          ... NOT USED                 @D64ADOW 04088000
         SLR   R7,R6              ... BY ERROR MSG             @D64ADOW 04089000
         AR    R5,R6              BEGIN OF NOT USED AREA       @D64ADOW 04090000
         EX    R7,ABMOVMXC        CLEAR UNSUSED AREA           @D64ADOW 04091000
***                                                                     04092000
***      RESET ADDITIONAL MESSAGE INFORMATION                           04093000
***                                                                     04094000
ABMOVM40 DS    0H                                              @D61CDOW 04095000
         L     R6,ADISPSER        GET ADDRESS OF DISP.SERVICES @D52GDIS 04096000
         LA    R0,28              GET FUNCTION CODE            @D61CDOW 04097000
         BASSM R7,R6              RESET ADDITIONAL CANCEL INFO @D64ADOW 04098000
*SGLINK  DISPSE28,INPUT=(R0:FCT_CODE,R6:DISPSERV_BASE,                 X04099000
               R7:RETURN_ADDR,R8:TIB_ADDR,RA:TCB_ADDR),                X04100000
               WORK=(R0,R2,RF)                                          04101000
         SPACE                                                          04102000
ABMOVM50 DS    0H                                              @D61CDOW 04103000
         BR    RE                 RETURN                       @D64ADOW 04104000
ABMOVMXC XC    0(0,R5),0(R5)                                   @D64ADOW 04105000
         DROP  R4                                              @D64ADOW 04106000
         DROP  R8                                              @D64ADOW 04107000
         DROP  R9                                              @D64ADOW 04108000
         DROP  RA                                              @D64ADOW 04109000
         EJECT                                                          04110000
*********************************************************************** 04111000
*                                                                     * 04112000
*        RETRIEVE SEGMENT TABLE ORIGIN TO GIVEN ASN                   * 04113000
*                                                                     * 04114000
*********************************************************************** 04115000
         SPACE 1                                                        04116000
         USING TCBADR,RA                                       @D64ADOW 04117000
         USING ABSEGMTO,R6                                     @D64ADOW 04118000
ABSEGMTO DS    0H                                              @D64ADOW 04119000
*SGLINK ABSEGMTO,S,INPUT=(R4,R6,R8,RA),OUTPUT=(R2,R4),WORK=(R3,R7)      04120000
         L     R2,IJBSMCOM        PTR TO STORAGE MGMT CB       @D64ADOW 04121000
         USING SMCOM,R2                                        @D64ADOW 04122000
         LR    R3,R4              COPY ASN                     @D64ADOW 04123000
         SRL   R4,6               RETRIEVE AFX OF ASN          @D64ADOW 04124000
         SLL   R4,12              DISPLACEMENT INTO SPECIAL    @D64ADOW 04125000
***                               VSE IMPLEMENTATION OF ASN-1ST-TABLE   04126000
***                               AND ASN-2ND-TABLE                     04127000
         A     R4,SMCASN2         RELATED ASN-2ND-TABLE        @D64ADOW 04128000
         DROP  R2                                              @D64ADOW 04129000
         ICM   R7,B'1111',ESTXASXM                             @D64ADOW 04130000
         NR    R3,R7              PREPARE ASX                  @D64ADOW 04131000
         SLL   R3,6               DISPLACEMENT INTO ASN-2ND-TAB@D64ADOW 04132000
         AR    R4,R3              ASTE RELATED TO SPACE        @D64ADOW 04133000
         USING ASTE,R4                                         @D64ADOW 04134000
         L     R2,ASTESTD         GET SEGMENT TABLE DESIGNATION@D64ADOW 04135000
         DROP  R4                                              @D64ADOW 04136000
         BR    R8                 RETURN                       @D64ADOW 04137000
ESTXASXM DC    X'0000003F'        MASK TO GET ASX              @D64ADOW 04138000
         DROP  R6                                              @D64ADOW 04139000
         DROP  RA                                              @D64ADOW 04140000
         EJECT                                                          04141000
*********************************************************************** 04142000
*        RESET EXIT ROUTINE                                           * 04143000
*                                                                     * 04144000
*        INPUT   R5  ROUTINE BASE                                     * 04145000
*                R9  RETURN ADDR                                      * 04146000
*                RA  TCBADR                                           * 04147000
*                                                                     * 04148000
*********************************************************************** 04149000
         SPACE                                                          04150000
         USING RESEXIT,R5                                      @D64ADOW 04151000
         USING TCBADR,RA                                       @D64ADOW 04152000
RESEXIT  DS    0H                                              @D64ADMK 04153000
         STM   R0,RF,SVCWORK      SAVE REGISTER                @D64ADOW 04154000
***                                                                     04155000
         CLC   TID,IJBHMTID        IS IT MAINTASK?             @D64ADOW 04156000
         BH    RESEXT20            NO --->                     @D64ADOW 04157000
         L     R2,PCBPTR           POINTER TO PCB              @D64ADOW 04158000
         USING PCBADR,R2                                       @D64ADOW 04159000
         NI    PCBFLAG1,XFF-OPCANCLD                           @D64ADOW 04160000
         DROP  R2                                              @D64ADOW 04161000
***                                                                     04162000
RESEXT20 DS    0H                                              @D64ADMK 04163000
         L     R2,TCBATCBE        GET ADDR OF TCB EXTENSION    @D64ADOW 04164000
         USING TCBXADR,R2                                      @D64ADOW 04165000
***                                                                     04166000
***      EOT HANDLING FOR STXIT-PC/ESPIE                                04167000
***                                                                     04168000
         LA    RB,TCBPCEX         GET ANCHOR FOR PC-TYPE EXITS @D64ADOW 04169000
         BAS   R9,RESEXCLR        FREE UP CHAIN                @D64ADOW 04170000
***                                                                     04171000
***      EOT HANDLING FOR ESTAEX/STXIT-AB                               04172000
***                                                                     04173000
         LA    RB,TCBABEX         GET ANCHOR FOR AB-TYPE EXITS @D64ADMK 04174000
         BAS   R9,RESEXCLR        FREE UP CHAIN                @D64ADOW 04175000
         XC    PTCBSTRT(PTCBLENG),PTCBSTRT CLEAR RTM SECTION   @D64ADOW 04177000
***                                                                     04177070
***      EOT HANDLING FOR FRR                                           04177140
***                                                                     04177210
         ICM   R9,B'1111',TCBFREX GET FRR STACK ADDR           @DY44889 04177280
         BZ    RESEXT50                                        @DY44889 04177350
         USING FRRS,R9                                         @DY44889 04177420
         L     R4,FRRSEMP         MAKE STACK                   @DY44889 04177490
         ST    R4,FRRSCURR        ... EMPTY                    @DY44889 04177560
         DROP  R9                                              @DY44889 04177630
         NI    PSAMFLGS,X7F      RESET EUT INDICATOR           @DY44889 04177700
         NI    TCBEXITH,XFF-TCBEUTIN ... AND IN TCB            @D65CDOW 04177770
         NI    TCBXFLG1,XFF-TCBXFRRA RESET FRR INDICATOR       @D64ADOW 04177840
RESEXT50 DS    0H                                              @DY44889 04177910
***                                                                     04178000
***      EOT HANDLING FOR STIMER/STIMERM/STXIT-IT                       04179000
***                                                                     04180000
         L     R8,TIBPTR                                       @D64ADOW 04181000
         USING TIBADR,R8                                       @D64ADOW 04182000
         NI    TIBFLAG,XFF-CDELEX RESET TIMER DISP EXIT FLAG   @D64ADOW 04183000
         DROP  R8                                              @D64ADOW 04184000
         L     RD,ASGEXIT         GET BASE OF SGEXIT           @D64ADOW 04185000
         L     RD,ASGTIMX-SGEXIT(,RD) GET BASE OF SGTIMERX     @D64ADOW 04186000
         USING SGTIMERX,RD                                     @D64ADOW 04187000
         BAS   R9,DEQTICHN        DEQ TASK FROM TIMER CHAIN    @D64ADOW 04188000
*SGLINK DEQTICHN,INPUT=(R9,RA,RD)                                       04189000
         DROP  RD                                              @D64ADOW 04190000
         LA    RB,TCBXTAVS        GET ANCHOR FOR IT EXIT       @D64ADOW 04191000
         BAS   R9,RESEXCLR        FREE UP CHAIN                @D64ADOW 04192000
         LA    RB,TCBXTASI        GET ANCHOR FOR STIMER        @D64ADOW 04193000
         BAS   R9,RESEXCLR        FREE UP CHAIN                @D64ADOW 04194000
         LA    RB,TCBXTAMU        GET ANCHOR FOR STIMERM       @D64ADOW 04195000
         BAS   R9,RESEXCLR        FREE UP CHAIN                @D64ADOW 04196000
         NI    TCBXFLG3,XFF-TCBXTIMW NO TIMER WITH WAIT=YES DEF@D64ADOW 04197000
         XC    TCBXTIMA(TCBXTIME-TCBXTIMA),TCBXTIMA CLEAR TIMER@D64ADOW 04198000
***                               ... RELATED PART OF TCBX              04199000
***      CLEANUP ETXR AND POST EXITS                                    04200000
***                                                                     04201000
         STM   R0,RF,SVCWORKA     SAVE CURRENT REGISTER        @D64ADOW 04202000
         L     R9,ASGMVSAP        GET BASE FOR SUBROUTINE      @D64ADOW 04203000
         USING SGMVSAPI,R9                                     @D64ADOW 04204000
         LA    RF,CLEANEX         ADDR OF SUBROUTINE           @D64ADOW 04205000
         O     RF,BIT0ON          FORCE 31 BIT MODE            @D64ADOW 04206000
         BASSM R7,RF              CALL ETXR/POST-EXIT CLEANUP  @D64ADOW 04207000
*SGLINK SGMAPICL,INPUT=(R7,R9,RA),WORK=(R1,R2,R5,R6,R8,RE,RF)           04208000
         DROP  R9                                              @D64ADOW 04210000
         LM    R0,RF,SVCWORKA     RESTORE REGISTER             @D64ADOW 04210500
***                                                                     04211000
***      INITIALIZE FLAG BYTES                                          04212000
***                                                                     04213000
         L     R8,TIBPTR                                       @D64ADOW 04214000
         USING TIBADR,R8                                       @D64ADOW 04215000
         MVI   TCBEXITF,X00       RESET ASYNCH EXIT            @D64ADOW 04216000
         MVI   TCBEXITG,X00       ... INDICATORS               @D64ADOW 04217000
         MVI   TCBEXIFL,X00       RESET TERMINATOR IF-FLAG     @D64ADOW 04218000
         NI    TIBFLAG5,XFF-TIBXMEMC RESET X-MEM INDICATOR     @D64XDOW 04219000
         DROP  R8                                              @D64ADOW 04220000
***                                                                     04221000
***      FREE STORAGE RETRIEVED FOR EXIT BLOCKS                         04222000
***                                                                     04223000
         OC    TCBXUPLS(4),TCBXUPLS SUBPOOL-NAME INITIALIZED   @D64ADOW 04225000
         BZ    RESEXT90                                        @D64ADMK 04226000
         LA    R1,TCBXUPLS        GET SUB POOL ID ADDR         @D64ADOW 04227000
*** FREE SUBPOOL IN SYSTEM GETVIS AREA                                  04228000
*        SFREEVIS SPID=(1)                                              04229000
         SFREEVIS SPID=(1)                                     @D64ADOW 04230000
*END OF SFREEVIS MACRO                                                  04231000
         SPACE                                                          04232000
         XC    TCBXUPLS,TCBXUPLS  CLEAR SUB-POOL NAME          @D64ADOW 04233000
         XC    TCBXTOKN,TCBXTOKN  TOKEN                        @D64ADOW 04233200
         XC    TCBXCBEM,TCBXCBEM  ANCHOR FREE CB               @D64ADOW 04233400
         XC    TCBXCBNA,TCBXCBNA  ... CHAINS                   @D64ADOW 04233600
RESEXT90 DS    0H                                              @D64ADMK 04234000
         LM    R0,RF,SVCWORK      RESTORE CALLERS REGISTER     @D64ADOW 04235000
         BSM   0,R9               RETURN                       @D64ADMK 04236000
         SPACE 3                                                        04237000
RESEXCLR DS    0H                                              @D64ADOW 04238000
         NI    0(RB),XFF-EXITACT  RESET ANY INDICATOR          @D64ADOW 04239000
RESEXC10 DS    0H                                              @D64ADOW 04240000
         L     R7,0(,RB)          GET FIRST/NEXT EXIT CB       @D64ADOW 04241000
RESEXC20 DS    0H                                              @D64ADOW 04242000
         LTR   R7,R7                                           @D64ADOW 04243000
         BZR   R9                 NOT AVAILABLE ---> RETURN    @D64ADOW 04244000
         USING EXITBLK,R7                                      @D64ADOW 04245000
         CLI   EXITFLG1,EXTITYPE  TIMER EXIT                   @D64XDOW 04246000
         BNE   RESEXC40           NO, --->                     @D64XDOW 04247000
         TM    TIQTYPE,TIQTASK+TIQSMVS+TIQMMVS MVS-TIQE?       @DY45636 04248000
         BZ    RESEXC80           NO, --->                     @DY45636 04249000
         ICM   R1,B'1111',TIQAUSA GET ADDR OF USER SAVE AREA   @D64XDOW 04250000
         BZ    RESEXC80           NOT AVAILABLE --->           @D64XDOW 04251000
         LA    R0,MVSSALNX        GET LENGTH OF USER SAVE AREA @D64XDOW 04252000
         B     RESEXC60           BRANCH TO FREE SPACE --->    @D64XDOW 04253000
RESEXC40 DS    0H                                              @D64XDOW 04254000
         CLI   EXITFLG1,EXPCTYPE  PROG-CHECK EXIT              @D64XDOW 04255000
         BNE   RESEXC80           NO, --->                     @D64XDOW 04256000
         CLI   EXITFLG2,EXESPIE   IS IT A ESPIE REQUEST        @D64XDOW 04257000
         BNE   RESEXC80           NO, --->                     @D64XDOW 04258000
         LA    R0,EPIEEND-EPIE    GET LENGTH OF EPIE           @D64XDOW 04259000
         L     R1,EXITSAV         ... AND ITS ADDRESS          @D64XDOW 04260000
RESEXC60 DS    0H                                              @D64XDOW 04261000
         LA    RF,20             SETUP FUNCTION CODE FREEMAIN  @D64XDOW 04262000
***                              ... SUBPOOL 241                        04263000
         L     RC,ASGEXIT        GET BASE OF                   @D64XDOW 04264000
         L     RC,AEXITGVI-SGEXIT(,RC) ... SUBROUTINE          @D64XDOW 04265000
         BASSM R8,RC              FREE SPACE                   @D64XDOW 04266000
*SGLINK  EXITFVIS,INPUT=(R0,R1,R8,RA,RC,RF),OUTPUT=RF,WORK=R0           04267000
RESEXC80 DS    0H                                              @D64XDOW 04268000
         TM    EXITFLG,EXITGETV   EXIT BLOCK IN GETVIS AREA    @D64ADOW 04269000
         BO    RESEXC90           YES--->                      @D64ADOW 04270000
         NI    EXITFLG,EXITGETV   INITIALIZE FLAG BYTES        @D64ADOW 04271000
         MVI   EXITFLG2,X00       ...                          @D64ADOW 04272000
         MVI   TIQTYPE,X00        ...                          @D64ADOW 04273000
         XC    EXITADR(8),EXITADR                              @D64ADOW 04274000
         LA    RB,EXITNEXT        GET NEW ANCHOR               @D64ADOW 04275000
         B     RESEXC10                                        @D64ADOW 04276000
RESEXC90 DS    0H                                              @D64ADOW 04277000
         L     R7,EXITNEXT        GET NEXT EXIT CB             @D64ADOW 04278000
         LA    R7,0(,R7)          ...                          @D64ADOW 04279000
         ST    R7,0(,RB)          ... TO ANCHOR                @D64ADOW 04280000
         DROP  R7                                              @D64ADOW 04281000
         B     RESEXC20                                        @D64ADOW 04282000
         SPACE                                                          04283000
         DROP  R2                                              @D64ADOW 04284000
         DROP  R5                                              @D64ADOW 04285000
         DROP  RA                                              @D64ADOW 04286000
         EJECT                                                          04287000
*********************************************************************** 04288000
*        ESTABLISH AB EXIT FOR ATTACH MACRO                           * 04289000
*              CALLED BY SGAP                                         * 04290000
*        NOTE : CONTROL REGISTER IN EXIT CB ARE INITIALIZED LATER     * 04291000
*               IN IJBLSTK (FCT CODE 8)                               * 04292000
*                                                                     * 04293000
*        INPUT   R3     SAVE AREA FOR AB EXIT ROUTINE                 * 04294000
*                       BIT 0 ON --> OLD SAVE AREA LAYOUT             * 04295000
*                       BIT 0 OFF--> NEW SAVE AREA LAYOUT             * 04296000
*                R5     TCB ADDR OF SUBTASK CURRENTLY ATTACHED        * 04297000
*                R9     RETURN ADDR                                   * 04298000
*                R10    TCB ADDR OF ATTACHING TASK                    * 04299000
*                R11    SAVE AREA OF ATTACHING TASK                   * 04300000
*        OUTPUT  RF     RETURN CODE FROM SGETVIS                      * 04301000
*                                                                     * 04302000
*********************************************************************** 04303000
         USING TCBADR,RA                                       @D64ADOW 04304000
SUBABEXT DS    0H                                              @D64ADOW 04305000
         SLR   RF,RF              PREPARE RETURN CODE          @D64ADOW 04306000
         STM   R0,RF,SVCWORK      SAVE REGISTER                @D64ADOW 04307000
         BASR  R9,0               GET ROUTINE BASE             @D64ADOW 04308000
         USING *,R9                                            @D64ADOW 04309000
         TM    TCBEXITG,TCBABSPC  AB-EXIT FOR ATTACH AVAILABLE @D64ADOW 04310000
         BNO   SUBAB090           NO, --->                     @D64ADOW 04311000
         L     R7,TCBABEX         GET AB-EXIT PTR              @D64ADOW 04312000
SUBAB010 DS    0H                                              @D64ADOW 04313000
         USING EXITBLK,R7                                      @D64ADOW 04314000
         TM    EXITFLG2,ABWDUMP+SKIPMSG+PRTMSG IS THIS THE     @D64ADOW 04315000
***                               DEFINED AB-EXIT                       04316000
         BNZ   SUBAB020           YES, TAKE IT                 @D64ADOW 04317000
         L     R7,EXITNEXT        GET NEXT AB-EXIT CB          @D64ADOW 04318000
         DROP  R7                                              @D64ADOW 04319000
         B     SUBAB010                                        @D64ADOW 04320000
SUBAB020 DS    0H                                              @D64ADOW 04321000
         LA    R0,EXABLEN         LENGTH OF EXIT CONTROL BLOCK @D64ADOW 04322000
         LA    RF,24              SET FUNCTION CODE            @DY45636 04323000
         LR    RA,R5              TCB OF ATTACHED TASK         @DY45636 04323000
         L     RC,ASGEXIT         GET BASE OF COMMON ROUTINE   @D64ADOW 04324000
         L     RC,AEXITGVI-SGEXIT(,RC) ...                     @D64ADOW 04325000
         BASSM R8,RC              ALLOCATE AB-EXIT BLOCK       @D64ADOW 04326000
*SGLINK  EXITGVIS,INPUT=(R0,R8,RA,RC,RF),OUTPUT=(R1,RF),WORK=R0         04327000
         ST    RF,SVCWORK+15*4    PASS SGETVIS RETURN CODE     @D64ADOW 04328000
         LTR   RF,RF              STORAGE AVAILABLE            @D64ADMK 04329000
         BNZ   SUBAB090           SPACE EXHAUSTED              @D64ADOW 04330000
         ST    R1,TCBABEX-TCBADR(,R5) SAVE AB-EXIT CB ADDR     @D64ADOW 04331000
         USING EXITBLK,R1                                      @D64ADOW 04332000
         ST    R3,EXITSAV         SAVE AREA ADDR TO EXIT-CB    @D64ADOW 04333000
         L     RF,EXITADR-EXITBLK(,R7) PASS EXIT               @D64ADOW 04334000
         LA    RF,0(,RF)          ... ADDR                     @D64ADOW 04335000
         ST    RF,EXITADR         ... TO EXIT CB               @D64ADOW 04336000
         TM    EXITSAV,X80        IS AB-EXIT WITH ANY          @D64ADOW 04337000
         BO    SUBAB030           NO --->                      @D64ADOW 04338000
         OI    EXITFLG,EXITANY+EXITMSAV INDICATE 31 BIT MODE   @D64ADOW 04339000
SUBAB030 DS    0H                                              @D64ADOW 04340000
         NI    EXITSAV,X7F        RESET FIRST BIT              @D64ADOW 04341000
         IC    RF,EXITFLG2-EXITBLK(,R7) PASS EXIT              @D64ADOW 04342000
         STC   RF,EXITFLG2        ... OPTIONS                  @D64ADOW 04343000
         MVI   EXITFLG1,EXABTYPE  INDICATE AB-EXIT             @D64ADOW 04344000
         USING SVEARA,RB                                       @D64ADOW 04345000
         MVC   EXITKEY,SVEPSW+1   SAVE KEY AT ATTACH TIME      @D64ADOW 04346000
         MVC   EXITASCM,SVEPSW+2  SAVE ASC MODE AND PROG MASK  @D64ADOW 04347000
         NI    EXITASCM,XCF       ...                          @D64ADOW 04348000
         DROP  RB                                              @D64ADOW 04349000
         DROP  R9                                              @D64ADOW 04350000
SUBAB090 DS    0H                                              @D64ADOW 04351000
         LM    R0,RF,SVCWORK      RESTORE REGISTER             @D64ADOW 04352000
         BSM   0,R9               RETURN                       @D64ADOW 04353000
         DROP  R1                                              @D64ADOW 04354000
         DROP  RA                                              @D64ADOW 04355000
         EJECT                                                          04356000
*********************************************************************** 04357000
*        STACK OPERATION EXCEPTION HANDLER                            * 04358000
*              CALLED BY SGPCK                                        * 04359000
*                                                                     * 04360000
*        INPUT   R9   RETURN ADDR                                     * 04361000
*                R12  ROUTINE BASE                                    * 04362000
*        OUTPUT  R15  RETURN CODE                                     * 04363000
*                                                                     * 04364000
*********************************************************************** 04365000
         USING PROGUSPB,RC                                     @D64ADOW 04366000
PROGUSPB DS    0H                                              @D64ADOW 04367000
         L     RA,TCBPTR          TCB PTR OF CURRENT TASK      @D64ADOW 04368000
         USING TCBADR,RA                                       @D64ADOW 04369000
         STM   R0,RE,SVCWORK      SAVE WORK REGISTER           @D64ADOW 04370000
         L     RD,TCBATCBE        ADDR OF TCB EXTENSION        @D64ADOW 04371000
         USING TCBXADR,RD                                      @D64ADOW 04372000
         L     RF,TCBX1CRF        GET CURRENT LINK STACK ENTRY @D64ADOW 04373290
         LR    R4,RC              SAVE CURRENT BASE            @D64ADOW 04373580
         L     RC,ASGEXIT         GET ADDR OF                  @D64ADOW 04374000
         L     RC,ACURLSTK-SGEXIT(,RC) ... SUBROUTINE          @D64ADOW 04375000
         BASSM R8,RC              CHECK FOR CURR LINK STACK LEV@D64ADOW 04376000
*SGLINK CCURLSTK,INPUT=(R8,RA,RC,RF),OUTPUT=RC                          04377490
         LR    R2,RC              GET LINK STACK ENTRY ADDR    @D64ADOW 04378000
         LR    RC,R4              RESTORE BASE ADDR            @D64ADOW 04379490
         SLR   RF,RF              INDICATE CANCEL BECAUSE      @D64ADOW 04380000
*                                 CICS-SVC NOT COMPLETED CORRECTLY      04381000
*                                 (IMPLIES CASE IF FESTAE DEFINED)      04382000
         ICM   R4,B'1111',PSATOLD GET TASKS MVS-TCB            @D64ADOW 04383000
         BZ    PROGUS10           BRANCH IF NOT EMULATION MODE @D64ADOW 04384000
         L     R4,TCBRBP-TCB(,R4) GET RB POINTER               @D64ADOW 04385000
         TM    RBSTAB1-RBSECT(R4),RBFTSVRB CREATED IN CICS-SVC @D64ADOW 04386000
         BZ    PROGUS10           NO --->                      @D64ADOW 04387000
         LA    R5,RBPRFXLN        GET ADDR OF PREFIX           @D64ADOW 04388000
         SLR   R4,R5              ... OF THIS RB               @D64ADOW 04389000
         L     R4,RBXSB-RBPREFIX(,R4) GET XSB ADDR             @D64ADOW 04390000
         USING XSB,R4                                          @D64ADOW 04391000
         C     R2,XSBSEL          RB DEFINED AT CURRENT LINKAGE@D64ADOW 04392000
***                               STACK LEVEL                           04393000
         DROP  R4                                              @D64ADOW 04394000
         BE    PROGUS90           YES, CANCEL                  @D64ADOW 04395000
PROGUS10 DS    0H                                              @D64ADOW 04396000
         LA    RF,4               INDICATE CANCEL WITH ERR20   @D64ADOW 04397000
PROGUS20 DS    0H                                              @D64ADOW 04398000
         LA    R4,TCBABEX         ANCHOR OF ESTAEX CHAIN       @D64ADOW 04399000
         L     R7,TCBABEX         GET ESTAEX EXIT ADDR         @D64ADOW 04400000
         LA    R7,0(,R7)          ...                          @D64ADOW 04401000
         LTR   R7,R7              ANY ESTAEX DEFINED           @D64ADOW 04402000
         BZ    PROGUS90           NO --->                      @D64ADOW 04403000
         USING EXITBLK,R7                                      @D64ADOW 04404000
         C     R2,EXABLSTK        CREATED AT CURRENT LEVEL     @D64ADOW 04405000
         BNE   PROGUS90           NO,                          @D64ADOW 04406000
         LA    RF,8               CANCEL ANY ACTIVE ESTAEX     @D64ADOW 04407000
         TM    EXITADR,EXITACT    IS EXIT CURRENTLY ACTIVE     @D64ADOW 04408000
         BO    PROGUS90           YES, CANCEL                  @D64ADOW 04409000
         LA    RF,12              REPEAT PR INSTRUCTION        @D64ADOW 04410000
         LR    R5,RC              SAVE BASE ADDR               @D64ADOW 04411000
         L     RC,ASGEXIT         DEQUEUE EXIT CB,             @D64ADOW 04412000
         L     RC,ARESUSPB-SGEXIT(,RC) ... PERFORM S-FREEVIS   @D64ADOW 04413000
         DROP  R7                 ... IF NOT ACTIVE            @D64ADOW 04414000
         BASSM R8,RC              ...  AND RESET USP-BIT       @D64ADOW 04415000
*SGLINK RESUSPB,INPUT=(R4,R7,R8,RA,RC),OUTPUT=(R7)                      04416000
         LR    RC,R5              RESTORE BASE ADDR            @D64ADOW 04417000
         B     PROGUS20                                        @D64ADOW 04418000
PROGUS90 DS    0H                                              @D64ADOW 04419000
         LM    R0,RE,SVCWORK      RESTORE WORK REGISTER        @D64ADOW 04420000
         BSM   0,R9               RETURN                       @D64ADOW 04421000
         DROP  RA                                              @D64ADOW 04422000
         DROP  RC                                              @D64ADOW 04423000
         DROP  RD                                              @D64ADOW 04424000
         EJECT                                                          04425000
*********************************************************************** 04426000
*                                                                     * 04427000
*        COMMON ROUTINE STXIT MACRO - DEFINE EXIT                     * 04428000
*                                     REMOVE EXIT                     * 04429000
*              SVC 16 - PC                                            * 04430000
*              SVC 18 - IT                                            * 04431000
*              SVC 20 - OC                                            * 04432000
*              SVC 37 - AB                                            * 04433000
*        REGISTER USAGE : SET EXIT             RESET EXIT             * 04434000
*        INPUT   R0     EXIT RTN ADDR              0                  * 04435000
*                R1     EXIT SAVE AREA ADDR       N/A                 * 04436000
*                R4     PARAMETER LIST ADDR       N/A                 * 04437000
*                R5     INDICATOR                 N/A                 * 04438000
*                R7     EXITBLOCK              EXITBLOCK              * 04439000
*                R9     RETURN ADDR            RETURN ADDR            * 04440000
*                RA     TCB ADDR               TCB ADDR               * 04441000
*                RC     ROUTINE BASE           ROUTINE BASE           * 04442000
*        OUTPUT  R6     DISPATCHER ADDR        DISPATCHER ADDR        * 04443000
*                RB     SAVE AREA ADDR         SAVE AREA ADDR         * 04444000
*                                                                     * 04445000
*        WORK    R0, R1, R2, R5, R8, RF                               * 04446000
*                                                                     * 04447000
*********************************************************************** 04448000
         SPACE 1                                                        04449000
COMSTXIT DS    0H                                              @D61NDOW 04450000
*SGLINK COMSTXIT,S,INPUT=(R0,R1,R4,R5,R7,R9,RA,RC),                    X04451000
               OUTPUT=(R6,RB),WORK=(R2,R5,R8,RF)                        04452000
         USING EXITBLK,R7                                      @D51HDOW 04453000
         USING TCBADR,RA                                       @D64ADOW 04454000
         USING COMSTXIT,RC                                     @D64ADOW 04455000
         L     R6,DISPAD                                       @D64ADOW 04456000
         USING DISP,R6                                         @D64ADOW 04457000
         L     RB,TCBSAVE         GET SAVE AREA ADDR           @D64ADOW 04458000
         LTR   R0,R0              RESET EXIT REQUIRED          @KD40113 04459000
         BZ    COMSTRES           YES, --->                    @D64ADOW 04460000
         USING SVEARA,RB                                       @D64ADOW 04461000
         C     R5,F1              ENTRY FROM SVC37             @D64ADOW 04462000
         BE    COMSTX60           SVC37 --->                   @D64ADOW 04463000
         CR    R0,R1              PARAMETER LIST SUPPLIED      @D51HDOW 04464000
         BE    COMSTX10           YES, --->                    @D51HDOW 04465000
         TM    TCBEXFLG,TCBEXAM   CALLER IN 31 BIT MODE        @D52VDOW 04466000
         BO    ERR45              CANCEL, EXT'D SAVE AREA REQ'D@D52VDOW 04467000
         LR    R8,R0              COPY RTN ADDR                @DY40651 04468000
         LA    R5,COMSTX40        GOTO COMSTX40                @D64ADOW 04469000
         BSM   0,R5               ...  IN 24 BIT MODE          @D51HDOW 04470000
***                                                                     04470500
COMSTX10 DS    0H                                              @D52VDOW 04471000
         TM    TCBEXFLG,TCBEXAM   CALLER IN 31 BIT MODE        @D52VDOW 04472000
         BO    COMSTX20           YES, MODE CORRECT            @D61NDOW 04473000
***                               NO, INPUT ARE 3-BYTE ADDR'S  @D61NDOW 04474000
         LA    R5,COMSTX20        GET CONTINUATION ADDR        @D64ADOW 04475000
         BSM   0,R5               GOTO 24 BIT MODE             @D64ADVB 04476000
COMSTX20 DS    0H                                              @D64ADOW 04477000
         LA    R1,0(,R1)          CLEAR FIRST BYTE/BIT         @D61NDOW 04478000
         LR    R4,R1              COPY LIST ADDR               @D64ADOW 04479000
         LA    R2,15(,R1)         ADDR LAST BYTE OF PAR-LIST   @D51HDOW 04480000
         BAS   R8,VALIDSVA        VALIDATE PARAMETER LIST      @D51HDOW 04481000
*SGLINK  VALIDSVA,INPUT=(R1,R2,R6,R8),WORK=(R2,R5)             @D51HDOW 04482000
         TM    TCBEXFLG,TCBEXAM   CALLER IN 31 BIT MODE        @KX41420 04483000
         BNO   COMSTX30           NO                           @KX41420 04484000
         TM    0(R1),X03          AMODE=ANY SPECIFIED          @KD40113 04485000
.*                                01 AND 02 REPRESENT AMODE=ANY         04486000
.*                                00 AND 03 REPRESENT AMODE=24          04487000
         BNM   ERR45              NO, CANCEL                   @KX41420 04488000
COMSTX30 DS    0H                                              @D61NDOW 04489000
         L     R8,4(,R4)          GET RTN ADDRESS              @D52VDOW 04490000
         L     R1,8(,R4)          GET SAVEAREA ADDRESS         @D52VDOW 04491000
COMSTX40 DS    0H                                              @D64ADOW 04492000
         LA    R0,0(,R8)          CLEAR FIRST BIT/BYTE         @KD40113 04493000
         LA    R1,0(,R1)          CLEAR FIRST BIT/BYTE         @KD40113 04494000
         SPACE 1                                                        04495000
         L     RF,COMSTX5A        GET CONTINUATION ADDR        @D64ADOW 04496000
         BSM   0,RF               GOTO 31 BIT MODE             @D64ADVB 04497000
COMSTX50 DS    0H                                              @KD40113 04498000
         LTR   R0,R0              ANY RTN ADDR SPECIFIED       @D64ADOW 04499000
         BZ    COMSTRES           NO, PERFORM RESET            @D64ADOW 04500000
         TM    TCBABEX,EXITACT    ANY AB-TYPE EXIT ACTIVE      @D64ADOW 04501000
         BO    ERR21              YES,ILLEGAL SVC              @D64ADOW 04502000
         TM    TCBFLAG6,TCBPSTAC  VENDOR EXIT ACTIVE           @D64ADOW 04503000
         BO    ERR21              YES,ILLEGAL SVC              @D64ADOW 04504000
         TM    EXITADR,EXITACT    ROUTINE ACTIVE?              @D51HDOW 04505000
         BO    ERR21              YES,CANCEL                   @D14CDFR 04506000
         TM    EXITFLG,DELINT     DELINT IS AQUIVALENT TO ACTIV@D64ADOW 04507000
***                               ... ONLY POSSIBLE FOR IT & OC EXITS   04508000
         BO    ERR21              YES, CANCEL                  @D64ADOW 04509000
COMSTX60 DS    0H                                              @KD40113 04510000
         LA    R2,SVUOLDLN-1      LENGTH OF OLD SAVE AREA      @D51HDOW 04511000
         LTR   R4,R4              PARAMETER LIST SUPPLIED      @D51HDOW 04512000
         BZ    COMSTX70           NO, --->                     @D61NDOW 04513000
         TM    0(R4),X03          EXTENDED SAVE AREA           @KD40113 04514000
.*                                01 02 03 HAVE EXTENDED SAVE AREA      04515000
.*                                00 HAS OLD SAVE AREA                  04516000
         BZ    COMSTX70           NO, --->                     @KD40113 04517000
         LA    R2,SVULNGTH-1      LENGTH OF EXTENDED SAVE AREA @D51HDOW 04518000
COMSTX70 DS    0H                                              @D61NDOW 04519000
         LA    R2,0(R2,R1)        POINT TO END OF SAVE AREA    @D51HDOW 04520000
         BAS   R8,VALID           VALIDATE SAVE AREA ADDRESS   @D14CDFR 04521000
*SGLINK  VALID,INPUT=(R1,R2,R6,R8),WORK=(R2),OUTPUT=(R5)                04522000
         NI    EXITFLG,EXITGETV   HOLD GETVIS INDICATOR        @D64ADOW 04523000
         STM   R0,R1,EXITADR      STORE ROUTINE & SAVEAREA ADDR@D64ADOW 04524000
         MVC   EXITKEY,SVEPSW+1   SAVE KEY AT STXIT TIME       @D51HDOW 04525000
         MVC   EXITASCM,SVEPSW+2  SAVE ASC MODE AND PROG MASK  @D64ADOW 04526000
         NI    EXITASCM,XCF       ...                          @D64ADOW 04527000
         LTR   R4,R4              PARAMETER LIST DEFINED       @D51HDOW 04528000
         BZ    COMSTX91           NO, RETURN                   @D51HDOW 04529000
         TM    0(R4),X03          AMODE=ANY SPECIFIED          @KD40113 04530000
.*                                01 AND 02 REPRESENT AMODE=ANY         04531000
.*                                00 AND 03 REPRESENT AMODE=24          04532000
         BZ    COMSTX91           ---> NO EXTENDED SAVE AREA   @D64ADOW 04533000
         BO    COMSTX90           ---> EXTENDED SAVE AREA      @D61NDOW 04534000
***                               AND AMODE=24                          04535000
         OI    EXITFLG,EXITANY    EXIT EXECUTES IN 31 BIT MODE @D64ADOW 04536000
COMSTX90 DS    0H                                              @D61NDOW 04537000
         OI    EXITFLG,EXITMSAV   EXTENDED SAVE AREA           @D64ADOW 04538000
COMSTX91 DS    0H                                              @D64ADOW 04539000
         BSM   0,R9               RETURN                       @D64ADOW 04540000
         SPACE                                                          04541000
COMSTX5A DC    A(X'80000000'+COMSTX50) AMODE 31 RTN ADDR       @D64ADOW 04542000
         SPACE                                                          04543000
         DROP  R6                                              @D64ADOW 04544000
         DROP  RB                                              @D64ADOW 04545000
         EJECT                                                          04546000
****************************************************************        04547000
***      RESET EXIT                                            *        04548000
***         EXITS RESET BY THIS ROUTINE:                       *        04549000
***               IT (VSE ONLY)                                *        04550000
***               PC (VSE ONLY)                                *        04551000
***               AB (VSE ONLY)                                *        04552000
***               OC                                           *        04553000
****************************************************************        04554000
COMSTRES DS    0H                                              @D61CDOW 04555000
         NI    EXITADR,EXITACT    DON'T MODIFY ACTIV INDICATOR @DY43182 04556000
         XC    EXITADR+1(3),EXITADR+1 CLEAR EXIT INFO          @D64ADOW 04557000
         TM    EXITADR,EXITACT    EXIT CURRENTLY ACTIVE        @D64ADOW 04558000
         BOR   R9                 YES, DELAY FREEVIS           @D64ADOW 04559000
         XC    EXITADR+4(4),EXITADR+4 CLEAR SAVE AREA ADDR     @D64ADOW 04560000
         NI    EXITFLG,EXITGETV   RESET ALL BUT PERM INDICATOR @D64ADOW 04561000
         MVI   EXITFLG2,X00       NO EXIT DEFINED              @D64ADOW 04562000
         MVI   TIQTYPE,X00        NO EXIT DEFINED              @D64ADOW 04563000
         TM    EXITFLG,EXITGETV   STORAGE IN GETVIS AREA       @D64ADOW 04564000
         BNOR  R9                 NO --->                      @D64ADOW 04565000
         CLI   EXITFLG1,EXTITYPE  IS IT A TIMER EXIT BLK       @D64ADOW 04566000
         BER   R9                 YES, KEEP EXIT CB            @D64ADOW 04567000
         SLR   R5,R5              TO CLEAR FORWARD POINTER     @D64ADOW 04568000
         L     R8,PCBPTR          GET PCB POINTER              @D64ADOW 04569000
         LA    R8,PCBOCPTR-PCBADR(,R8) ANCHOR TO OC-EXIT CHAIN @D64ADOW 04570000
         TM    EXITFLG1,EXOCTYPE  IS THIS OC-EXIT              @D64ADOW 04571000
         BO    COMSTR50           YES, --->                    @D64ADOW 04572000
         LA    R8,TCBPCEX         ANCHOR TO PC CHAIN           @D64ADOW 04573000
         CLI   EXITFLG1,EXPCTYPE  IS THIS PC-EXIT              @D64ADOW 04574000
         BE    COMSTR50           YES, --->                    @D64ADOW 04575000
***                               NO MUST BE AB-EXIT           @D64ADOW 04576000
         LA    R8,TCBABEX         ANCHOR TO AB CHAIN           @D64ADOW 04577000
         LA    R7,0(,R7)          CLEAR FIRST BIT              @D64ADOW 04578000
         L     RF,TCBABEX         GET FIRST ESTAEX TYPE EXIT   @D64ADOW 04579000
         LA    RF,0(,RF)          CLEAR FIRST BIT              @D64ADOW 04580000
         CR    R7,RF              IS FIRST AB-EXIT EARLY       @D64ADOW 04581000
         BE    COMSTR50           NO, GOTO DELETE              @D64ADOW 04582000
***                               YES, TAKE NEXT AB-EXIT                04583000
         L     R8,TCBABEX         GET ADDR TO FORWARD POINTER  @D64ADOW 04585000
***                               IN AB EXIT BLOCK                      04586000
         LA    R8,EXITNEXT-EXITBLK(,R8) ...                    @D64ADOW 04587000
COMSTR50 DS    0H                                              @D64ADOW 04588000
         ST    R5,0(,R8)          SETUP NEW CHAIN POINTER      @D64ADOW 04589000
.***                              EXIT IS NOT ACTIV ANYMORE (IF SECOND  04590000
.***                               AB-EXIT REMOVED, ACTIV BIT IN        04591000
.***                               TCBABEX NOT MODIFIED)                04592000
         LH    R0,EXITLENG                                     @D64ADOW 04593000
*** FREEVIS FOR EXIT CONTROL BLOCK                                      04594000
*        SFREEVIS LENGTH=(0),ADDRESS=(7)                                04595000
         SFREEVIS LENGTH=(0),ADDRESS=(7)                       @D64ADOW 04596000
*END OF SFREEVIS MACRO                                                  04597000
         SPACE                                                          04598000
         SLR   R0,R0              RESTORE REG 0                @D64ADOW 04599000
         BR    R9                                              @D64ADOW 04600000
         SPACE                                                          04601000
         DROP  R7                                              @D51HDOW 04602000
         DROP  RA                                              @D64ADOW 04603000
         DROP  RC                                              @D64ADOW 04604000
         EJECT                                                          04605000
*********************************************************************** 04606000
*                                                                     * 04607000
*        COMMON ROUTINE TO ENTER EXIT - EXIT ACTIVATION               * 04608000
*              MAP PSW TO BC MODE AND SAVE THE INTERRUPT STATUS.      * 04609000
*                                                                     * 04610000
*********************************************************************** 04611000
         SPACE 1                                                        04612000
         USING SVUARA,R4                                       @D52GDIS 04613000
         USING EXITBLK,R7                                      @D51HDOW 04614000
         USING TCBADR,RA                                       @D64ADOW 04615000
         USING SVEARA,RB                                       @D64ADOW 04616000
         USING COMSTXIT,RC                                     @D64ADOW 04617000
EXITPREP DS    0H                 ENTRY FOR IT/OC/PC TYPE EXIT @D61NDOW 04618000
*SGLINK  EXITPREP,S,INPUT=(R0:ONLY_AB,R3,R4,R5,R7,RA,RB,RC,RE),        X04619000
               WORK=(R1,R8,R9,RE,RF)                                    04620000
         OI    EXITADR,EXITACT    EXIT ROUTINE IS NOW ACTIVE   @D61NDOW 04621000
         MVC   EXITSACT,TCBEXITF  SAVE EXIT INDICATOR OF       @D61NDOW 04622000
***                               EXIT CURRENTLY ACTIVE                 04623000
         STC   RE,TCBEXITF        OUR EXIT IS ACTIVE FROM NOW  @D61NDOW 04624000
         MVC   EXITSPSW,SVEPSW    SAVE OLD PSW                 @D64ADOW 04625000
         L     RF,TCBATCBE        GET CURRENT LINK STCK        @D64ADOW 04625300
         L     RF,TCBX1CRF-TCBXADR(,RF) ... ENTRY ADDRESS      @D64ADOW 04625600
         LR    R9,RC              SAVE CURRENT BASE            @D64ADOW 04626000
         L     RC,ASGEXIT         GET BASE OF                  @D64ADOW 04627000
         L     RC,ACURLSTK-SGEXIT(,RC) ...    SUBROUTINE       @D64ADOW 04628000
         BASSM R8,RC              RETRIEVE CURRENT LS ENTRY ADD@D64ADOW 04629000
*SGLINK CCURLSTK,INPUT=(R8,RA,RC,RF),OUTPUT=RC                          04630490
         ST    RC,EXITSLSK        SAVE CURRENT LINKAGE STACK EN@D64ADOW 04631000
         LR    RC,R9              RESTORE BASE ADDR            @D64ADOW 04632000
         ICM   R9,B'1111',PSATOLD MVS EMULATION ACTIVE         @D64ADOW 04633000
         BZ    EXITPR10           NO --->                      @D64ADOW 04634000
         CLI   TCBEXITF,TCBABACT  PROCESSING AB EXIT           @D64ADOW 04635000
         BE    EXITPR10           YES--->                      @D64ADOW 04636000
         NI    EXITSFLG,XFF-EXFESDEF                           @D64ADOW 04637000
         L     R9,TCBRBP-TCB(,R9) GET CURRENT RB ADDR          @D64ADOW 04638000
         ST    R9,EXITSRB         SAVE CURRENT RB ADDR         @D64ADOW 04639000
         OC    RBSEXIT-RBSECT(4,R9),RBSEXIT-RBSECT(R9) FESTEA  @D64ADOW 04640000
****                              ALREADY DEFINED                       04641000
         BZ    EXITPR10           NO --->                      @D64ADOW 04642000
         OI    EXITSFLG,EXFESDEF  INDICATE FESTAE DEFINED      @D64ADOW 04643000
EXITPR10 DS    0H                                              @D64ADOW 04644000
         CLI   EXITFLG2,EXESPIE   IS THIS A ESPIE EXIT         @D64ADOW 04645000
         BE    EXITESPI           YES, GOTO ACTIVATE IT        @D64ADOW 04646000
         MVC   SVUPSW(8),SVEPSW   MOVE PSW TO EXIT SAVE AREA   @D36ZDFR 04647000
         NI    SVUPSW+2,X3F       BC MODE PSW HAS NO ACC REG'S @D51HDOW 04648000
         TM    EXITFLG,EXITMSAV   EXIT WITH EXTENDED SAVE AREA @D64ADOW 04649000
         BNO   EXITPR30           NO,  OLD SAVE AREA LAYOUT--->@D52VDOW 04650000
*                                 YES, NEW SAVE AREA LAYOUT             04651000
         MVC   SVUAPSW(8),SVEPSW  SAVE CORRECT PSW             @D51HDOW 04652000
         XC    SVUPSW+5(3),SVUPSW+5 CLEAR ADDR IN OLD VERSION  @D51HDOW 04653000
         L     R9,TCBARSAV        GET ACCESS REGISTER SAVE AREA@D61NDOW 04654000
         MVC   SVUAREG,0(R9)      ACC REG TO EXIT SAVE AREA    @D52VDOW 04655000
         AIF   (NOT &BGDEBUG).NORES10                          @D52VDOW 04656000
         XC    0(64,R9),0(R9)                                  @D52VDOW 04657000
.NORES10 ANOP                                                  @D14BDFR 04658000
         CLI   TCBEXITF,TCBABACT  PROCESSING AB EXIT           @D67QDOW 04635000
         BNE   EXITPR30           YES--->                      @D67QDOW 04636000
         STC   R0,SVUACCOD        SAVE CANCEL CODE             @D67QDOW 04636000
EXITPR30 MVC   SVUR00(36),SVER00  REGISTERS TO USER SAVE AREA       435 04659000
         MVC   SVUR09(28),SVER09  IN SEQUENCE R0 TO RF(COMPATIBILITY)35 04660000
         IC    R9,INTINFO+1       GET INSTRUCTION LENGTH CODE           04661000
         SLL   R9,5               MOVE TO PROPER POSITION            AM 04662000
         STC   R9,SVUPSW2         STORE IN USER PSW SAVE            435 04663000
         OC    SVUPSW2(1),SVUPSW+2   OR-IN CCODE AND PGMMASK        435 04664000
         MVC   SVUPSW+2(2),INTINFO+2 INTERRUPTCODE TO PSWSAVE       435 04665000
         AIF   (NOT &BGDEBUG).NORES20                          @D14BDFR 04666000
         XC    SVER09(64),SVER09                               @D14BDFR 04667000
.NORES20 ANOP                                                  @D14BDFR 04668000
         CLI   TCBEXITF,TCBABACT  IS AB EXIT TO BE ACTIVATED   @DY42706 04669000
         BNE   EXITPR60           NO --->                      @DY42706 04670000
         ST    R0,SVER00          CANCEL CODE TO USER SAVE AREA@D61CDOW 04671000
         DROP  R4                                              @D51HDOW 04672000
EXITPR60 DS    0H                                              @D61CDOW 04673000
         MVI   SVEPSW,ENABLE+DATMASK MAKE 1ST PSW-BYTE CORRECT @D61RDOW 04674000
         CLC   TID,ARTIDH         SYSTEM TASK ACTIVE           @D64ADOW 04675000
         BH    EXITPR65           NO --->                      @D64ADOW 04676000
         MVI   SVEPSW,DATMASK     DISABLE IF SYSTEM TASK       @D64ADOW 04677000
EXITPR65 DS    0H                                              @D64ADOW 04678000
         L     R9,PCBPTR          POINT TO PCB                 @D14BDFR 04679000
         USING PCBADR,R9                                       @D14BDFR 04680000
         TM    PCBFLAG,PERACT     TEST PER BIT IN PCBFLAG      @D14BDFR 04681000
         BZ    EXITPR70           PER BIT NOT ON   --->        @D14BDFR 04682000
         DROP  R9                                              @D14BDFR 04683000
         OI    SVEPSW,PERMASK     ENABLE PROGR.EVENT RECORDING @D14BDFR 04684000
EXITPR70 DS    0H                                              @D51HDOW 04685000
         MVC   SVEPSW+1(1),EXITKEY   GET STXIT KEY             @DY42706 04686000
         NI    SVEPSW+2,X3F       FORCE PRIMARY ASC MODE       @D64ADOW 04687000
         MVI   SVEPSW+3,X00       MAKE BYTE 3 CORRECT          @D64ADOW 04688000
         LA    R9,0(,R3)          RESET ACTIVE FLAG IN RTN ADDR@D14BDFR 04689000
         ST    R9,SVEPSW2         STORE ROUTINE ADDRESS TO PSW @D14BDFR 04690000
         ST    R9,SVER0F          ... AND TO USER REG 15       @D14BDFR 04691000
         ST    R4,SVER01          USER REG 1 POINTS TO SAVEAREA@D51HDOW 04692000
         TM    EXITFLG,EXITANY    EXIT WITH AMODE=ANY          @D64ADOW 04693000
         BNO   EXITRET            NO,  --------->              @D64ADVB 04694000
         OI    SVEPSW2,X80        LET DISPATCH IN 31 BIT MODE  @D52VDOW 04695000
         OI    SVER0F,X80         INDICATE 31 BIT MODE         @KD40113 04696000
EXITRET  BSM   0,R5               RETURN, ------>              @D64ADVB 04697000
         SPACE 3                                                        04698000
EXITESPI DS    0H                                              @D64ADOW 04699000
         L     R4,EXITSAV         GET EPIE ADDR                @D64ADOW 04700000
         USING EPIE,R4                                         @D64ADOW 04701000
         MVC   EPIEEPIE,EXEPIECO  EPIE IDENTIFIER              @D64ADOW 04702000
         MVC   EPIEPARM,EXESPARM  USERS PARAMETER LIST ADDR    @D64ADOW 04703000
         MVC   EPIEGR00(36),SVER00 REG 0 - REG 8               @D64ADOW 04704000
         MVC   EPIEGR09(28),SVER09 REG 9 - REG 15              @D64ADOW 04705000
         MVC   EPIEPSW,SVEPSW     PROG CHECK OLD PSW           @D64ADOW 04706000
         MVC   EPIEINT,INTINFO    PROG CHECK INTERRUPTION INFO @D64ADOW 04707000
         LA    R8,PROTEX          PREPARE PROTECTION EXCEPTION @D65CDOW         
         CLI   INTINFO+3,STEXC    IS IT SEGMENT TRANSLATION EXC@D65CDOW         
         BE    EXITESP5           YES , --->                   @D65CDOW         
         LA    R8,PROTEX+PEREXC   PREPARE PROTECTION EXCEPTION @D65CDOW         
         CLI   INTINFO+3,STEXC+PEREXC ....                     @D65CDOW         
         BNE   EXITESP6           NO  , --->                   @D65CDOW         
EXITESP5 DS    0H                                              @D65CDOW 04699000
         STC   R8,EPIEINT+3       SIMULATE PROTECTION EXCEPTION@D65CDOW 04699000
         MVI   EPIEINT+1,X00      SET ILC TO ZERO              @D65CDOW         
EXITESP6 DS    0H                                              @D65CDOW 04699000
         L     R8,TCBARSAV        GET ACC REG SAVE AREA        @D64ADOW 04708000
         MVC   EPIEAR,0(R8)       ACC REG 0 - ACC REG 15       @D64ADOW 04709000
         MVI   EPIEV1,EXEPIEVS    INSERT VERSION IDENTIFIER    @D64ADOW 04710000
         MVI   EPIEFLGS,X00       INITIALIZE FLAG BYTE         @D64ADOW 04711000
         L     R15,AESPIRTY       ADDR OF RETRY ROUTINE        @D64ADOW 04712000
         ST    R15,SVER0E         ... TO USERS REG 14          @D64ADOW 04713000
         L     R3,EXITADR         GET EXIT ADDR                @D64ADOW 04714000
         B     EXITPR60           RETURN TO MAINLINE           @D64ADOW 04715000
         DROP  R4                                              @D64ADOW 04716000
***                                                                     04717000
*** CONSTANTS USED IN SUBROUTINE                                        04718000
***                                                                     04719000
         DS    0F                                              @D61RDOW 04720000
AESPIRTY DC    A(PCRETRY)         RETRY ROUTINE FOR ESPIE      @D64ADOW 04721000
EXEPIECO DC    C'EPIE'                                         @D64ADOW 04722000
*                                                                       04723000
EXEPIEVS EQU   1                  EPIE VERSION IDENTIFIER      @D64ADOW 04724000
***                                                                     04725000
         DROP  R7                                              @D51HDOW 04726000
         DROP  RB                                              @D64ADOW 04727000
         DROP  RA                                              @D64ADOW 04728000
         DROP  RC                                              @D64ADOW 04729000
         EJECT                                                          04730000
*********************************************************************** 04731000
*                                                                     * 04732000
*        COMMON RTN FOR EXIT MACRO - RETURN TO INTERRUPTED PROGRAM    * 04733000
*              MAP PSW TO EC MODE AND RETURN THE INTERRUPT STATUS.    * 04734000
*              SVC 17 - EXIT PC                                       * 04735000
*              SVC 19 - EXIT IT                                       * 04736000
*              SVC 21 - EXIT OC                                       * 04737000
*                                                                     * 04738000
*********************************************************************** 04739000
         SPACE 2                                                        04740000
         USING DISP,R6                                         @D61NDOW 04741000
         USING EXITBLK,R7                                      @D51HDOW 04742000
         USING TCBADR,RA                                       @D64ADOW 04743000
         USING SVEARA,RB                                       @D64ADOW 04744000
         USING COMSTXIT,RC                                     @D64ADOW 04745000
COMEXIT  DS    0H                                              @D52VDOW 04746000
*SGLINK COMEXIT,S,INPUT=(R4,R6,R7,R9,RA,RB,RC),                        X04747000
               WORK=(R0,R1,R2,R3,R4,R5,R8,RF)                           04748000
.** ASSUMPTION: DURING EXIT PROCESSING BOTH AB EXIT CHAINS ARE NOT              
.**             CHANGED (VSE CHAIN WITH ANCHOR IN TCBABEX AND MVS CHAIN         
.**             WITH ANCHOR IN TCBSTAB) I.E NO ESTAEX NOR STXIT AB.             
.**             FURTHERMORE ITS ASSUMED THAT NEITHER A FRR                      
.**             NOR A FESTAE NOR AN ARR IS DEFINED.                             
         CLM   R4,1,TCBEXITF      EXIT ROUTINE ACTIVE?         @D61PDOW 04749000
         BNE   ERR21              ROUT.NOT ACTIVE: ILLEGAL SVC @D61PDOW 04750000
         LA    R7,0(,R7)          CLEAR FIRST BIT IN EXIT ADDR @D64ADOW 04751000
         ICM   R4,B'1111',PSATOLD GET MVS TCB                  @D64ADOW 04752000
         BZ    COMEXT00           NOT AVAILABLE --->           @D64ADOW 04753000
         CLC   TCBRBP-TCB(4,R4),EXITSRB SAME RB AS AT EXIT ACTI@D64ADOW 04754000
         BNE   COMEXERR           NO, ---> CANCEL              @D64ADOW 04755000
COMEXT00 DS    0H                                              @D64ADOW 04756000
         B     COMEXXX1                                        @D66XXOW         
         ICM   R3,B'1111',TCBABEX GET FIRST AB EXIT            @D64ADOW 04757000
         BZ    COMEXT20           NO EXIT AVAILABLE            @D64ADOW 04758000
         LTR   R4,R4              FESTAE POSSIBLE              @DY45636 04762000
         BZ    COMEXT10           NO,                          @DY45636 04763000
         LA    R5,EXABMSCB-EXITADR(,R3) SCB IN ESTAEX CNTRL BLK@DY45636 04764000
         SLR   R2,R2                                           @DY45636 04765000
         ICM   R2,B'0111',TCBSTABB-TCB(R4) GET FIRST SCB       @DY45636 04766000
         CR    R2,R5              ESTAEX FIRST IN SCB CHAIN    @DY45636 04767000
         BNE   COMEXT20           NO, ASSUME THAT FESTAE NOT   @DY45636 04768000
***                               DEFINED WITHIN 'EXIT XX' ISSUER               
COMEXT10 DS    0H                                              @DY45636 04756000
         C     R7,EXABACTV-EXITADR(,R3) ESTAEX DEFINED WHITHIN @D64ADOW 04759490
***                               ... CURRENT EXIT                      04760000
         BNE   COMEXT20           NO, KEEP ESTAEX --->         @D64ADOW 04761000
         LR    R5,RC              SAVE CURRENT BASE            @D64ADOW 04770000
         LR    R1,R7              SAVE CURRENT EXIT ADDR       @D64ADOW 04771000
         LA    R4,TCBABEX         PTR TO ESTAEX-CHAIN          @D64ADOW 04772000
         LR    R7,R3              PTR TO ESTAEX-CNTRL-BLOCK    @D64ADOW 04773000
         L     RC,ASGEXIT         DEQUEUE EXIT CB,             @D64ADOW 04774000
         L     RC,ARESUSPB-SGEXIT(,RC) ... S-FREEVIS EXIT BLOCK@D64ADOW 04775000
         BASSM R8,RC              ... AND RESET USP-BIT        @D64ADOW 04776000
*SGLINK RESUSPB,INPUT=(R4,R7,R8,RA,RC),OUTPUT=(R7)                      04777000
         LR    RC,R5              RESTORE CURRENT BASE         @D64ADOW 04778000
         LR    R7,R1              RESTORE CURRENT EXIT ADDR    @D64ADOW 04779000
         L     R4,PSATOLD                                      @D64ADOW 04780000
         B     COMEXT00           CHECK NEXT ESTAEX/FESTAE     @D64ADOW 04781000
COMEXT20 DS    0H                                              @D64ADOW 04782000
COMEXXX1 DS    0H                                              @D66XXOW         
         MVC   TCBEXITF,EXITSACT  RESTORE STACKED EXIT-ACT IND @D61NDOW 04802000
         MVI   EXITSACT,X00       CLEAR INDICATOR              @D61NDOW 04803000
         NI    EXITADR,XFF-EXITACT RESET ACTIVATION FLAG       @D51HDOW 04804000
         L     R4,EXITSAV         GET SAVE AREA ADDR           @D51HDOW 04805000
         USING SVUARA,R4                                       @D51IDOW 04806000
         MVC   SVEPSW(4),EXITPSW1 RESTORE SAVED PSW 1ST PART   @D64ADOW 04807000
         CLI   EXITFLG2,EXESPIE   RETRY FROM ESPIE EXIT        @D64ADOW 04808000
         BE    COMESP00           YES, GOTO HANDLE             @D64ADOW 04809000
         MVC   INTINFO+2(2),SVUPSW+2 RESTORE ORIGINAL INT.CODE @D36IDFR 04810000
         SR    R5,R5              CLEAR REGISTER               @D369DFR 04811000
         IC    R5,SVUPSW2         RESTORE                      @D369DFR 04812000
         SRL   R5,6               ... ORIGINAL                 @D369DFR 04813000
         SLL   R5,1               ...   ILC                    @D369DFR 04814000
         STC   R5,INTINFO+1       ...      IN TCB              @D369DFR 04815000
.*       USER MAY HAVE CHANGED FOLLOWING FIELDS                         04816000
         MVC   SVEPSW+2(1),SVUPSW2 SET UP  CCODE AND PGMMSK         435 04817000
         NI    SVEPSW+2,ILCMSK    ZERO INSTR.LENGTH            @DY43275 04818000
         MVI   SVEPSW2,X00        CLEAR FIRST BYTE OF ADDRESS  @D52VDOW 04819000
         MVC   SVEPSW2+1(3),SVUPSW2+1 RESTORE PSW ADDRESS      @D36IDFR 04820000
         SLR   R1,R1              GET A+S BITS FROM            @D64ADOW 04821000
         ICM   R1,B'0010',EXITSPSW+2 ... TIME OF               @D64ADOW 04822000
         N     R1,COMEXMSK        ... ERROR                    @D64ADOW 04823000
         CLC   EXITPSW2+1(3),SVEPSW2+1 NEW CONT ADDR SUPPLIED  @D52VDOW 04824000
.*       NOT EQUAL MEANS USER SUPPLIED CONTINUATION ADDRESS             04825000
.*       COMPARISON IS NECESSARY BUT NOT SUFFICIENT TO DECIDE WHERE     04826000
.*       TO CONTINUE. IT FAILS WHEN THE LAST 3 BYTES OF A 4 BYTE        04827000
.*       INTERRUPTION ADDR ARE EQUAL TO THE 3 BYTE CONTINUATION ADDR    04828000
         BE    COMEXT50           NO,                          @D52VDOW 04829000
         SLR   R1,R1              CLEAR A=S BITS               @D64ADOW 04830000
         B     COMEXT60           CONTINUE AT REQ'ED LOCATION  @D52VDOW 04831000
***                               IN 24 BIT MODE WITHOUT AR MODE        04832000
COMEXT50 MVC   SVEPSW2,EXITPSW2   INSERT INTERRUPTION ADDR     @D52VDOW 04833000
COMEXT60 DS    0H                                              @D52VDOW 04834000
         XC    EXITPSW2,EXITPSW2  CLEAR SAVED PSW ADDR         @D52VDOW 04835000
         TM    EXITFLG,EXITMSAV   EXIT WITH EXTENDED SAVE AREA @D64ADOW 04836000
         BNO   COMEXT70           NO, --->                     @D51HDOW 04837000
         MVC   SVEPSW+2(6),SVUAPSW+2 GET PSW BYTES 2 TO 7      @D52VDOW 04838000
         L     R5,TCBARSAV        ACC REG SAVE AREA PRESENT    @D61NDOW 04839000
         MVC   0(64,R5),SVUAREG                                @D52VDOW 04840000
         B     COMEXT80                                        @D52VDOW 04841000
COMEXT70 DS    0H                 ENTRY POINT FOR OLD EXITS    @DPT2+OW 04842000
         O     R1,SVEPSW          COMPLETE FIRST PART OF PSW   @DPT2+OW 04843000
         ST    R1,SVEPSW          AND MOVE IT TO SAVE AREA     @DPT2+OW 04844000
COMEXT80 MVC   SVER09(28),SVUR09 AND REGISTERS TO USER SAVE AREA    435 04845000
         MVC   SVER00(36),SVUR00 IN SEQUENCE R9 TO R8               435 04846000
         DROP  R4                                              @D35EDEM 04847000
         DROP  R7                                              @D64ADOW 04848000
COMEXT90 DS    0H                                              @D64ADOW 04849000
         NI    SVEPSW,XFF-PERMASK RESET  PROGR.EVENT RECORDING @D14BDFR 04850000
         L     R5,PCBPTR          POINT TO PCB                 @D14BDFR 04851000
         USING PCBADR,R5                                       @D14BDFR 04852000
         TM    PCBFLAG,PERACT     TEST PER BIT IN PCBFLAG      @D14BDFR 04853000
         BZR   R9                 PER BIT NOT ON, RETURN       @D61NDOW 04854000
         DROP  R5                                              @D14BDFR 04855000
         OI    SVEPSW,PERMASK     ENABLE PROGR.EVENT RECORDING @D14BDFR 04856000
         BR    R9                 RETURN                       @D61NDOW 04857000
         SPACE 5                                                        04858000
COMESP00 DS    0H                                              @D64ADOW 04859000
         USING EPIE,R4                                         @D64ADOW 04860000
         USING EXITBLK,R7                                      @D64ADOW 04861000
         TM    EPIEFLGS,EPIERCTL  IS ASC MODE SET BY EXIT      @D64ADOW 04862000
         BNO   COMESP20           NO, ASC MODE CORRECT         @D64ADOW 04863000
         NI    SVEPSW+2,X3F       RESET A+S BITS               @D64ADOW 04864000
         TM    EPIEPSW+2,X40      SHALL WE CONTINUE IN AR MODE @D64ADOW 04865000
         BNO   COMESP20           NO, ASC MODE CORRECT         @D64ADOW 04866000
         OI    SVEPSW+2,X40       SET AR MODE                  @D64ADOW 04867000
COMESP20 DS    0H                                              @D64ADOW 04868000
         MVC   SVEPSW+4(4),EPIEPSW+4 COPY CONTINUATION ADDR    @D64ADOW 04869000
         MVC   SVER09(28),EPIEGR09 COPY REG 9 - REG 15         @D64ADOW 04870000
         MVC   SVER00(36),EPIEGR00 COPY REG 0 - REG 8          @D64ADOW 04871000
         L     R5,TCBARSAV        GET ACC REG SAVE AREA        @D64ADOW 04872000
         MVC   0(64,R5),EPIEAR    ACC REG 0 - ACC REG 15       @D64ADOW 04873000
         MVC   INTINFO(4),EPIEINT RESTORE INTERRUPTION CODE    @D64ADOW 04874000
         DROP  R4                                              @D64ADOW 04875000
         ICM   R5,15,EXITADR      IS EXIT DELETED IN MEANTIME  @D64ADOW 04876000
         BNZ   COMEXT90           NO, RETURN TO MAINLINE       @D64ADOW 04877000
         IC    R5,EXESPMSK        PROG MASK OF ESPIE ISSUER    @D64ADOW 04878000
         NI    SVEPSW+2,XF0       RESET CURRENT PROG MASK      @D64ADOW 04879000
         IC    R3,SVEPSW+2        GET WHOLE BYTE 2 FROM PSW    @D64ADOW 04880000
         OR    R3,R5              REESTABLISH PREVIOUS PROG MSK@D64ADOW 04881000
         STC   R3,SVEPSW+2        .....                        @D64ADOW 04882000
         LR    R3,RC              SAVE CURRENT BASE            @D64XDOW 04883000
         LA    R0,EPIEEND-EPIE    LENGTH OF EPIE               @D64ADOW 04884000
         L     R1,EXITSAV         GET EPIE ADDR                @D64ADOW 04885000
         LA    RF,20              SETUP FUNCTION CODE FREEMAIN @D64XDOW 04886000
         L     RC,ASGEXIT         GET BASE OF                  @D64XDOW 04887000
         L     RC,AEXITGVI-SGEXIT(,RC) ... SUBROUTINE          @D64XDOW 04888000
         BASSM R8,RC              FREE SPACE                   @D64XDOW 04889000
*SGLINK  EXITFVIS,INPUT=(R0,R1,R8,RA,RC,RF),OUTPUT=RF,WORK=R0           04890000
         LR    RC,R3              RESTORE BASE                 @D64XDOW 04891000
         SPACE                                                          04892000
         LH    R0,EXITLENG        GET LENGTH OF CONTROL BLOCK  @D64ADOW 04893000
         L     R3,EXITNEXT        DEQUEUE EXIT CB              @D64ADOW 04894000
         ST    R3,TCBPCEX         ...                          @D64ADOW 04895000
         DROP  R7                                              @D51HDOW 04896000
*** FREEVIS FOR ESPIE CONTROL BLOCK                                     04897000
*        SFREEVIS ADDRESS=(R7),LENGTH=(0)                               04898000
         SFREEVIS ADDRESS=(R7),LENGTH=(0)                      @D64ADOW 04899000
***END OF SFREEVIS MACRO                                                04900000
         SLR   R7,R7              EXIT BLOCK FREED             @D64ADOW 04901000
         B     COMEXT90           RETURN TO MAINLINE           @D64ADOW 04902000
         SPACE 3                                                        04903000
COMEXERR DS    0H                                              @D64ADOW 04904000
         L     R1,COMEXCOD        GET ADDITIONAL ERROR INFO    @D64ADOW 04905000
         L     RC,ASGEXIT         GET COMMON CANCEL EXIT       @D64ADOW 04906000
         L     RC,ACOMEREX-SGEXIT(,RC) ... ADDRESS             @D64ADOW 04907000
         BSM   0,RC               CANCEL WITH ERR47            @D64ADOW 04908000
         SPACE                                                          04909000
COMEXCOD DC    A(NUCRSN51)        EXIT OC|IT|PC REJECTED       @D64ADOW 04910000
*                                 ... BECAUSE CURRENT RB NOT RB FROM    04911000
*                                 ... EXIT ACTIVATION                   04912000
         SPACE                                                          04913000
         DS    0F                 FORCE ALIGNEMENT             @D52VDOW 04914000
COMEXTAR DC    X'00004000'        AR MODE MASK                 @D64ADOW 04915000
COMEXMSK DC    X'0000C000'        ZERO ALL BUT A+S BITS        @D64ADOW 04916000
         DROP  R6                                              @D64ADOW 04917000
         DROP  RA                                              @D64ADOW 04918000
         DROP  RB                                              @D35EDJO 04919000
         DROP  RC                                              @D64ADOW 04920000
         EJECT                                                          04921000
*********************************************************************** 04922000
*                                                                     * 04923000
*        CHECK FOR DELAYED TIMER EXIT                                 * 04924000
*                          OC EXIT                                    * 04925000
*                          VTAM EXIT                                  * 04926000
*        AND RESCHEDULE ASSOCIATED DISPATCHER EXIT IF APPROPRIATE     * 04927000
*        INPUT   R8 TIB ADDR                                          * 04928000
*                RC  ROUTINE BASE                                     * 04929000
*                RE  RETURN ADDR                                      * 04930000
*                RF  INDICATOR                                        * 04931000
*                                                                     * 04932000
*        WORK    R4                                                   * 04933000
*                                                                     * 04934000
*********************************************************************** 04935000
         SPACE 2                                                        04936000
         USING CHKDELAY,RC                                     @D64ADOW 04937000
         USING TIBADR,R8                                       @D64ADOW 04938000
CHKDELAY DS    0H                  CHECK FOR DELAYED TIMER     @D64ADOW 04939000
***                                AND OC EXITS                         04940000
*SGLINK  CHKDELAY,S,INPUT=(R8,RC,RE,RF),WORK=(R4)                       04941000
         SLL   RF,2                DISPLACEMENT INTO BRANCH TAB@D64ADOW 04942000
         B     CHKDLYTB(RF)                                    @D64ADOW 04943000
CHKDLYTB B     CHKDLY00                                        @D64ADOW 04944000
         B     CHKDLY10                                        @D64ADOW 04945000
***END OF BRANCH TABLE             RF = 0 : DELAYED EXITS ARE           04946000
***                                            VTAM EXITS               04947000
***                                            TIMER EXITS              04948000
***                                RF = 1 : DELAYED EXITS ARE           04949000
***                                            TIMER EXITS              04950000
***                                            OC EXITS                 04951000
CHKDLY00 DS    0H                                              @D64ADOW 04952000
         TM    TIBFLAG3,VTDELCKU   ISTAPCKU ACTIVATION DELAYED @DA36477 04953000
         BO    CHKDLY30            IF YES, ACT VTAM DISP EXIT  @DA36477 04954000
         TM    TIBFLAG2,VTOPEN     VTAM APPLICATION            @DA24937 04955000
         BO    CHKDLY60            YES, RESCHEDULE VTAM AP EXIT@DA24937 04956000
         B     CHKDLY20            NO, --->                    @D64ADOW 04957000
CHKDLY10 DS    0H                                              @D64ADOW 04958000
         CLC   TID,IJBHMTID        IS IT MAINTASK              @D64ADOW 04959000
         BH    CHKDLY20            NO, --->                    @D64ADOW 04960000
         L     R4,TIBPCB           PCB OF CURRENT TASK         @D64ADOW 04961000
         USING PCBADR,R4                                       @D64ADOW 04962000
         ICM   R4,B'1111',PCBOCPTR OC EXIT DEFINED             @D64ADOW 04963000
         BZ    CHKDLY20            NO, --->                    @D64ADOW 04964000
         USING EXITBLK,R4                                      @D64ADOW 04965000
         TM    EXITFLG,DELINT      WAS OC EXIT DELAYED         @D64ADOW 04966000
         BNO   CHKDLY20            NO, --->                    @D64ADOW 04967000
         NI    EXITFLG,XFF-DELINT  RESET DELAYED INDICATOR     @D64ADOW 04968000
         OI    TIBFLAG,OCPEND      RESCHEDULE OC EXIT          @D64ADOW 04969000
CHKDLY20 DS    0H                                              @D64ADOW 04970000
         L     R4,TIBTCB           TCB OF CURRENT TASK         @D64ADOW 04971000
         USING TCBADR,R4                                       @D64ADOW 04972000
         L     R4,TCBATCBE         GET ADDR OF ACTIVE TIQE     @D64ADOW 04973000
         USING TCBXADR,R4                                      @D64ADOW 04974000
         ICM   R4,B'1111',TCBXTQCA                             @D64ADOW 04975000
         BZ    CHKDLYRT            NO ACTIVE TIQE --->         @D64ADOW 04976000
         USING EXITBLK,R4          PROVIDE ADDR FOR TIQE       @D64ADVB 04977000
         TM    EXITFLG,DELINT      TIMER INTERR. PENDING ?     @D64ADVB 04978000
         BNO   CHKDLYRT            NO,RETURN                   @D64ADOW 04979000
         NI    EXITFLG,XFF-DELINT RESET TIMER INTERR. BIT      @D51HDOW 04980000
         OI    TIBFLAG,CDELEX      SETUP DISPATCHER EXIT       @D64ADOW 04981000
CHKDLYRT DS    0H                                              @D64ADOW 04982000
         BSM   0,RE                                            @D64ADOW 04983000
         SPACE                                                          04984000
CHKDLY30 NI    TIBFLAG3,XFF-VTDELCKU RESET DELAY INDICATOR     @DA36477 04985000
         OI    TIBFLAG3,VTACTCKU   SCHEDULE ISTAPCKU ROUTINE   @DA36477 04986000
         OI    TIBFLAG,APSEXFLG    SCHEDULE VTAM DISP. EXIT    @DA36477 04987000
         BSM   0,RE                                            @D64ADOW 04988000
         SPACE                                                          04989000
CHKDLY60 EQU   *                                               @DA24937 04990000
         OI    TIBFLAG,APSEXFLG    RESCHEDULE VTAM AP EXIT     @DA24937 04991000
         BSM   0,RE                                            @D64ADOW 04992000
         DROP  R4                  RESET ADDR TO TIQE          @D64ADVB 04993000
         DROP  R8                                              @D64ADOW 04994000
         DROP  RC                                              @D64ADOW 04995000
         EJECT                                                          04996000
*********************************************************************** 04997000
*                                                                     * 04998000
*        DEACTIVATE RB RELATED EXIT ROUTINES                          * 04999000
*                FESTAE                                               * 05000000
*                ESTAEX                                               * 05001000
*                ESPIE                                                * 05002000
*        NOTE: FRR'S ARE NOT HANDLED. ITS ASSUMED THAT CLEANUP        * 05002300
*              IS DONE PROPERLY BY FRR OWNER                          * 05002600
*                                                                     * 05003000
*        INPUT   R2  RB-ADDR (IF CALLED BY IJBMCBE)                   * 05004290
*                    0 (IF CALLED BY SVC150)                          * 05004580
*                R9  RETURN ADDRESS                                   * 05005000
*                RA  TCB POINTER                                      * 05006000
*                RC  ROUTINE BASE                                     * 05007000
*                                                                     * 05008000
*        CALLED BY IJBMCBE - WHENEVER A RB IS DEACTIVATED             * 05009190
*               BY SVC150  - CHECK IF PARALLEL PROCESSING OF          * 05009380
*                            FREEMSCB AND RESUSPB POSSIBLE            * 05009570
*        OUTPUT (IF CALLED BY SVC150)                                 * 05009760
*               R2  = 0 PARALLEL PROCESSING POSSIBLE                  * 05009950
*                  = 0 NONPARALLEL REQUIRED                          * 05010140
*                                                                     * 05011000
*********************************************************************** 05012000
         SPACE 2                                                        05013000
         USING FREEMSCB,RC                                     @D64ADOW 05014000
         USING TCBADR,RA                                       @D64ADOW 05015000
FREEMSCB DS    0H                                              @D64ADOW 05016000
*SGLINK  FREEMSCB,S,INPUT=(R1,R9,RA,RC)                                 05017000
         STM   R0,RF,SVCWORK    SAVE WORK REGISTER             @D64ADOW 05018000
         L     RE,PSATOLD       GET MVS TCB                    @D64ADOW 05019000
         USING TCB,RE                                          @D64ADOW 05020000
         LTR   R9,R2            CALLED FOR CHECK ONLY          @D64ADOW 05021000
         BNZ   FRMSCB10         NO, PROCESS ESTAEX             @D64ADOW 05022390
         L     R2,TCBRBP        GET CURRENT RB ADDR            @D64ADOW 05022780
         B     FRMSCB60         CHECK IF ESPIE DEFINITION      @DY45037 05023170
***                             REQUIRES SFREEVIS                       05023560
FRMSCB10 DS    0H                                              @D64ADOW 05024000
***                                                                     05046000
***      REMOVE ESTAE-TYPE EXIT FROM MVS-SCB CHAIN                      05047000
***                                                                     05048000
FRMSCB20 DS    0H                                              @D64ADOW 05049000
         SLR   R4,R4                                           @D64ADOW 05050000
         ICM   R4,B'0111',TCBSTABB GET FIRST MVS-SCB           @D64ADOW 05051000
         BZ    FRMSCB60         NO SCB AVAILABLE, --->         @D64ADOW 05052000
         CLC   0(1,R4),SCBXPTR+3-SCB(R4) FORCE PROG CHK IF INV @D66XXOW         
PCKFAPI9 DS    0H                    PROG CHK ADDR FOR SGPCK   @D66XXOW         
         USING SCB,R4                                          @D64ADOW 05053000
         CLM   R2,B'0111',SCBOWNRA DOES IT BELONG TO CURRENT RB@D64ADOW 05054000
         BNE   FRMSCB60         NO, --->                       @D64ADOW 05055000
         TM    SCBFLGS3,SCBBRNTR IS THIS A FESTAE              @D64ADOW 05058000
         BNO   FRMSCB40         NO, --->                       @D64ADOW 05059000
         L     R5,SCBCHAIN      GET NEXT SCB IN CHAIN          @D64ADOW 05060000
         XC    SCBCHAIN(8),SCBCHAIN DEACTIVATE CURRENT SCB     @D64ADOW 05061000
         STCM  R5,B'0111',TCBSTABB NEW 1ST IN CHAIN            @D64ADOW 05062000
         B     FRMSCB20                                        @D64ADOW 05063000
         DROP  R4                                              @D64ADOW 05064000
FRMSCB40 DS    0H               REMOVE ESTAEX FROM ITS CHAIN   @D64ADOW 05065000
         L     R7,TCBABEX       GET 1ST ESTAEX                 @D64ADOW 05066000
         USING EXITBLK,R7                                      @D64ADOW 05067000
         NI    EXITADR,XFF-EXITACT                             @D64ADOW 05068000
         LA    R4,TCBABEX       CHAINING ADDR                  @D64ADOW 05069000
         LR    R1,RC            SAVE CURRENT BASE ADDR         @D64ADOW 05070000
         L     RC,ASGEXIT       EXIT CONTROL BLOCK             @D64ADOW 05071590
         L     RC,ARESUSPB-SGEXIT(,RC) ... TO FREE CHAIN       @D64ADOW 05072180
         DROP  R7                                              @D64ADOW 05073000
         BASSM R8,RC              ...  AND RESET USP-BIT       @D64ADOW 05074000
*SGLINK RESUSPB,INPUT=(R4,R7,R8,RA,RC),OUTPUT=(R7)                      05075000
         LR    RC,R1            RESTORE BASE ADDR              @D64ADOW 05076000
         B     FRMSCB20         GOTO NEXT IN CHAIN --->        @D64ADOW 05077000
***                                                                     05078000
***      REMOVE ESPIE EXIT FROM ITS CHAIN                               05079000
***                                                                     05080000
FRMSCB60 DS    0H                                              @D64ADOW 05081000
         ICM   R1,B'1111',TCBPCEX GET 1ST IN PC-TYPE CHAIN     @D64ADOW 05082000
         BZ    FRMSCB80         NOT AVAIALBLE --->             @D64ADOW 05083000
         USING EXITBLK,R1                                      @D64ADOW 05084000
         CLI   EXITFLG2,EXESPIE  IS IT ESPIE                   @D64ADOW 05085000
         BNE   FRMSCB80         NO, --->                       @D64ADOW 05086000
         C     R2,EXESCURB      DOES IT BELONG TO CURRENT RB   @D64ADOW 05087000
         BNE   FRMSCB80         NO, --->                       @D64ADOW 05088000
         LTR   R9,R9            CALLED FOR CHECKING ONLY       @D64ADOW 05089000
         BZ    FRMSCB70         YES, --->                      @DY45037 05090490
         L     R7,EXITNEXT      GET NEXT PC-EXIT BLOCK         @D64ADOW 05091000
         ST    R7,TCBPCEX       NEW 1ST IN AB-EXIT CHAIN       @D64ADOW 05092000
         SLR   R0,R0                                           @D64ADOW 05093000
         ICM   R0,B'0011',EXITLENG GET LENGTH OF EXIT BLOCK    @D64ADOW 05094000
         DROP  R1                                              @D64ADOW 05095000
*** FREEVIS FOR ESPIE CONTROL BLOCK                                     05096000
*        SFREEVIS ADDRESS=(1),LENGTH=(0)                                05097000
         SFREEVIS ADDRESS=(1),LENGTH=(0)                       @D64ADOW 05098000
***END OF SFREEVIS MACRO                                                05099000
         B     FRMSCB60         GOTO NEXT IN CHAIN --->        @D64ADOW 05101000
         SPACE                                                          05101200
FRMSCB70 DS    0H                                              @DY45037 05101400
         ST    R2,SVCWORK+2*4   INDICATE NON-PARALLEL REQ'D    @DY45037 05101600
FRMSCB80 DS    0H                                              @D64ADOW 05102000
         LM    R0,RF,SVCWORK    RESTORE REGISTER               @D64ADOW 05103000
         BSM   0,R9                                            @D64ADOW 05104000
         DROP  RA                                              @D64ADOW 05109000
         DROP  RC                                              @D64ADOW 05110000
         DROP  RE                                              @D64ADOW 05111000
         EJECT                                                          05112000
*********************************************************************** 05113000
*                                                                     * 05114000
*        COMMON GETVIS/FREEVIS SUBROUTINE                             * 05115000
*                                                                     * 05116000
*        INPUT   R0  LENGTH OF REQUIRED SPACE / SPACE TO BE FREED     * 05117000
*                R1  ADDRESS OF SPACE TO BE FREED (FREEVIS ONLY)      * 05118000
*                R5  ADDRESS OF TARGET TCB (FCT CODE 24 ONLY)         * 05118000
*                R8  RETURN ADDRESS                                   * 05119000
*                RA  TCB POINTER                                      * 05120000
*                          (IF FCT CODE 24 TARGET TCB PTR)            *         
*                RC  ROUTINE BASE                                     * 05121000
*                RF  FUNCTION CODE                                    * 05122000
*                    0 : ANY - KEY 0 (SGETVIS AREA)                   * 05123000
*                        INITIALISATION AS EXIT CNTRL BLOCK PERFORMED * 05124000
*                    4 : LOW - KEY 0 (SGETVIS AREA)                   * 05125000
*                        INITIALISATION AS EXIT CNTRL BLOCK PERFORMED * 05126000
*                    8 : ANY - PARTKEY (GETMAIN FROM SUBPOOL 241)     * 05127000
*                   12 : LOW - PARTKEY (GETMAIN FROM SUBPOOL 241)     * 05128000
*                   16 : ANY - KEY 0 (SGETVIS AREA)                   * 05129000
*                   20 : FREEMAIN SPACE FROM SUBPOOL 241              * 05130000
*                   24 : SAME AS 0, BUT TARGET TCB SPECIFIED          * 05130000
*        OUTPUT  R1  EXIT-BLOCK ADDR                                  * 05131000
*                R15 GETVIS RETURN CODE                               * 05132000
*                                                                     * 05133000
*********************************************************************** 05134000
         SPACE 2                                                        05135000
         USING EXITGVIS,RC                                     @D64ADOW 05136000
         USING TCBADR,RA                                       @D64ADOW 05137000
EXITGVIS DS    0H                                              @D64ADOW 05138000
*SGLINK  EXITGVIS,S,INPUT=(R0,R8,RA,RC,RF),OUTPUT=(R1,RF),WORK=R0       05139000
*SGLINK  EXITFVIS,S,INPUT=(R0,R1,R8,RA,RC,RF),OUTPUT=RF,WORK=R0         05140000
         L     RA,TCBATCBE        GET ADDR OF TCB EXTENSION    @D64ADOW 05141000
***                               ...(EITHER CURRENT OR TARGET TCB)             
         USING TCBXADR,RA                                      @D64ADOW 05142000
         CLC   TCBXUPLS(4),EXITSUBP SUBPOOL-NAME INITIALIZED   @D64ADOW 05143000
         BE    EXITGV00           YES, --->                    @D64ADOW 05144000
         MVC   TCBXUPLS(4),EXITSUBP INITIALIZE SUB-POOL NAME   @D64ADOW 05145000
         MVC   TCBXUPLS+4(2),TID  INSERT TID IN SUBPOOL NAME   @D64ADOW 05146000
         XC    TCBXUPLS+6(2),TCBXUPLS+6  ...                   @D64ADOW 05147000
EXITGV00 DS    0H                                              @D64ADOW 05148000
         L     RA,TCBPTR          LOAD TCB OF CURRENT TASK     @D64ADOW 05149000
         B     EXITBTAB(RF)       SELECT PROPER FUNCTION       @D64ADOW 05151000
EXITBTAB B     EXITGV25        0: SYSTEM-GETVIS,LOC=ANY        @D64ADOW 05152000
         B     EXITGV40        4: SYSTEM-GETVIS,LOC=BELOW      @D64ADOW 05153000
         B     EXITGV60        8: GETMAIN,SUBPOOL=241,LOC=ANY  @D64ADOW 05154000
         B     EXITGV70       12: GETMAIN,SUBPOOL=241,LOC=BELOW@D64ADOW 05155000
         B     EXITGV20       16: SYSTEM-GETVIS,LOC=ANY        @D64ADOW 05156000
         B     EXITFVIS       20: FREEMAIN,SUBPOOL=241,ADDR    @D64ADOW 05157000
*        B     EXITGV10       24: SYSTEM-GETVIS,LOC=ANY,TCB    @DY45636 05157000
*END OF BRANCH TABLE                                                    05158000
         SPACE                                                          05159000
EXITGV10 DS    0H                                              @DY45636 05160000
         USING TCBADR,R5                                       @DY45636 05160000
         L     RA,TCBTIB          TIB FROM TARGET TCB          @DY45636 05160000
         USING TIBADR,RA                                       @DY45636 05160000
         L     R1,TCBATCBE        TCBX FROM TARGET TCB         @DY45636 05160000
         USING TCBXADR,R1                                      @DY45636 05160000
         MVC   TCBXUPLS+4(2),TIBRTID CORRECT TASK-ID TO SUB-   @DY45636 05146000
***                               ...POOL NAME                                  
         LA    R1,TCBXUPLS        ADDR OF SUB-POOL NAME        @DY45636 05160000
         DROP  R1                                              @DY45636 05160000
         DROP  R5                                              @DY45636 05160000
         L     RA,TCBPTR          TCB OF ACTIVE TASK           @DY45636 05160000
         USING TCBADR,RA                                       @DY45636 05160000
         B     EXITGV30                                        @DY45636 05160000
EXITGV20 DS    0H                                              @D64ADOW 05160000
         O     RA,BIT0ON          INDICATE NO EXIT CB REQ'D    @D64ADOW 05161000
EXITGV25 DS    0H                                              @D64ADOW 05162000
         L     R1,TCBATCBE        GET ADDR OF TCB EXTENSION    @D64ADOW 05163000
         LA    R1,TCBXUPLS-TCBXADR(,R1) ADDR(SUBPOOL-ID)       @D64ADOW 05164000
EXITGV30 DS    0H                                              @DY45636 05160000
*        SGETVIS LENGTH=(0),LOC=ANY,SPID=(1),PFIX=YES                   05165000
         SGETVIS LENGTH=(0),                                           X05166000
               LOC=ANY,                                                X05167000
               PFIX=YES,                                               X05168000
               SPID=(1)                                        @D64ADOW 05169000
*END OF SGETVIS MACRO                                                   05170000
         B     EXITGV50                                        @D64ADOW 05171000
         SPACE                                                          05172000
EXITGV40 DS    0H                                              @D64ADOW 05173000
         L     R1,TCBATCBE        GET ADDR OF TCB EXTENSION    @D64ADOW 05174000
         LA    R1,TCBXUPLS-TCBXADR(,R1) ADDR(SUBPOOL-ID)       @D64ADOW 05175000
*        SGETVIS LENGTH=(0),LOC=BELOW,SPID=(1),PFIX=YES                 05176000
         SGETVIS LENGTH=(0),                                           X05177000
               LOC=BELOW,                                              X05178000
               PFIX=YES,                                               X05179000
               SPID=(1)                                        @D64ADOW 05180000
*END OF SGETVIS MACRO                                                   05181000
EXITGV50 DS    0H                                              @D64ADOW 05182000
         LTR   RF,RF              SPACE RETRIEVED              @D64ADOW 05183000
         BNZ   EXITGV55           NO, --->                     @D64ADOW 05184000
         LTR   RA,RA              EXIT CB REQ'D                @D64ADOW 05185000
         BM    EXITGV55           NO --->                      @D64ADOW 05186000
         USING EXITBLK,R1                                      @D64ADOW 05187000
         STH   R0,EXITLENG        SAVE LENGTH OF BLOCK         @D64ADOW 05188000
         OI    EXITFLG,EXITGETV   INDICATE BLOCK IS SGETVIS'D  @D64ADOW 05189000
         DROP  R1                                              @D64ADOW 05190000
EXITGV55 DS    0H                                              @D64ADOW 05191000
         LA    RA,0(,RA)          CLEAR INDICATOR              @D64ADOW 05192000
         BSM   0,R8               =========>  RETURN           @D64ADOW 05193000
         SPACE 3                                                        05194000
EXITGV60 DS    0H                                              @D64XDOW 05195000
         O     RA,BIT0ON          INDICATE ANY REQUEST         @D64XDOW 05196000
EXITGV70 DS    0H                                              @D64XDOW 05197000
         L     R1,TCBATCBE        GET TCBX ADDR                @D64XDOW 05198000
         L     RF,TCBSAVE         POINT TO SAVE AREA           @D64XDOW 05199000
         USING TCBXADR,R1                                      @D64XDOW 05200000
         USING SVEARA,RF                                       @D64XDOW 05201000
         TM    TCBXSAUS,TCBXXSBU  SAVE AREA USED               @D64XDOW 05202000
         BNO   EXITGV75           NO, TAKE IT                  @D64XDOW 05203000
         BAS   R5,SYSERROR        YES, MUST NOT OCCUR          @D64XDOW 05204000
EXITGV75 DS    0H                                              @D64XDOW 05205000
         OI    TCBXSAUS,TCBXXSBU  SAVE AREA IS USED            @D64XDOW 05206000
         LA    R1,TCBXXSB         POINT TO SAVE AREA           @D64XDOW 05207000
         DROP  R1                                              @D64XDOW 05208000
         MVC   0(12,R1),SVER0F    SAVE REG 15 - 1 FROM USER    @D64XDOW 05209000
         DROP  RA                 .. SAVE AREA                 @D64XDOW 05210000
         IC    RA,SVEPSW+1        SAVE CURRENT KEY,STATE       @D64XDOW 05211000
***                               ... AND KEEP ANY-INDICATOR            05212000
         STM   R2,RE,3*4(R1)      SAVE OUR REGISTERS 2 - 14    @D64XDOW 05213000
         XC    SVER0F,SVER0F      CLEAR OPTION REGISTER        @D64XDOW 05214000
         OI    SVER0F+3,X10       INDICATE BELOW REQUEST       @D64XDOW 05215000
         LTR   RA,RA              IS BELOW REQUESTED           @D64XDOW 05216000
         BP    EXITGV80           YES, --->                    @D64XDOW 05217000
         OI    SVER0F+3,X60       INDICATE ANY REQUEST         @D64XDOW 05218000
EXITGV80 DS    0H                                              @D64XDOW 05219000
         L     R6,PCBPTR          GET CURRENT PCB POINTER      @D64XDOW 05220000
         USING PCBADR,R6                                       @D64XDOW 05221000
         NI    SVEPSW+1,X0E       PREPARE KEY FIELD            @D64XDOW 05222000
***                               ... AND SWITCH TO SUPERVISOR STATE    05223000
         OC    SVEPSW+1(1),PCEKEY KEY IS PARTITION KEY         @D64XDOW 05224000
         DROP  R6                                              @D64XDOW 05225000
         MVI   SVER0F+2,XF1       SUPPLY SUBPOOL NUMBER 241    @D64XDOW 05226000
         XC    SVER01,SVER01                                   @D64XDOW 05227000
         ST    R0,SVER00          PASS LENGTH TO SERVICE       @D64XDOW 05228000
         DROP  RF                                              @D64XDOW 05229000
         L     RA,TCBPTR          RELOAD TCB POINTER           @D64XDOW 05230000
         USING TCBADR,RA                                       @D64XDOW 05231000
         L     R6,EXITGETM        LOAD GETMAIN ADDR            @D64XDOW 05232000
         BASSM R6,R6              RETRIEVE STORAGE             @D64XDOW 05233000
*SGLINK GMFMSVC78,INPUT=(R6,RA),WORK=(R0-R5,R7-R9,RB-RF)                05234000
         L     R6,TCBATCBE        GET TCBX ADDR                @D64XDOW 05235000
         USING TCBXADR,R6                                      @D64XDOW 05236000
         LA    RE,TCBXXSB         GET SAVE AREA ADDR           @D64XDOW 05237000
         L     RB,TCBSAVE         POINT TO SAVE AREA           @D64XDOW 05238000
         USING SVEARA,RB                                       @D64XDOW 05239000
         L     R1,SVER01          GET RETRIEVED STORAGE ADDR   @D64XDOW 05240000
         L     RF,SVER0F          GET RETURN CODE              @D64XDOW 05241000
         MVC   SVER0F(12),0(RE)   RESTORE REG 15 - 1           @D64XDOW 05242000
         IC    R2,11*4+3(,RE)     GET ORIGINAL PSW BYTE 1(SAVED@D64XDOW 05243000
         STC   R2,SVEPSW+1        ...IN REG 10) AND RESTORE IT @D64XDOW 05244000
         NI    TCBXSAUS,XFF-TCBXXSBU SAVE AREA IS FREE         @D64XDOW 05245000
         DROP  R6                                              @D64XDOW 05246000
         DROP  RB                                              @D64XDOW 05247000
         LM    R2,RE,3*4(RE)      RELOAD WORK REGISTER         @D64XDOW 05248000
         L     RA,TCBPTR          RELOAD TCB POINTER           @D64XDOW 05249000
         BSM   0,R8               =========>  RETURN           @D64XDOW 05250000
         SPACE 3                                                        05251000
EXITFVIS DS    0H                                              @D64XDOW 05252000
         L     RF,TCBATCBE        GET TCBX ADDR                @D64XDOW 05253000
         USING TCBXADR,RF                                      @D64XDOW 05254000
         TM    TCBXSAUS,TCBXXSBU  SAVE AREA USED               @D64XDOW 05255000
         BNO   EXITFV20           NO, TAKE IT                  @D64XDOW 05256000
         BAS   R5,SYSERROR        YES, MUST NOT OCCUR          @D64XDOW 05257000
EXITFV20 DS    0H                                              @D64XDOW 05258000
         OI    TCBXSAUS,TCBXXSBU  SAVE AREA IS USED            @D64XDOW 05259000
         LA    RF,TCBXXSB         POINT TO SAVE AREA           @D64XDOW 05260000
         DROP  RF                                              @D64XDOW 05261000
         STM   R2,RE,3*4(RF)      SAVE OUR REGISTERS 2 - 14    @D64XDOW 05262000
         L     RB,TCBSAVE         POINT TO SAVE AREA           @D64XDOW 05263000
         USING SVEARA,RB                                       @D64XDOW 05264000
         IC    R6,SVEPSW+1        GET USERS PSW BYTE 1         @D64XDOW 05265000
         STC   R6,11*4+3(,RF)     ... AND SAVE IN BYTE3 OF R10 @D64XDOW 05266000
         L     R6,PCBPTR          GET CURRENT PCB POINTER      @D64XDOW 05267000
         USING PCBADR,R6                                       @D64XDOW 05268000
         NI    SVEPSW+1,X0E       PREPARE KEY FIELD            @D64XDOW 05269000
***                               ... AND SWITCH TO SUPERVISOR STATE    05270000
         OC    SVEPSW+1(1),PCEKEY KEY IS PARTITION KEY         @D64XDOW 05271000
         DROP  R6                                              @D64XDOW 05272000
         MVC   0(12,RF),SVER0F    SAVE REG 15 - 1 FROM USER    @D64XDOW 05273000
         XC    SVER0F,SVER0F      CLEAR OPTION REGISTER        @D64XDOW 05274000
         MVI   SVER0F+3,X01       INDICATE FREE STORAGE        @D64XDOW 05275000
         MVI   SVER0F+2,XF1       SUPPLY SUBPOOL NUMBER 241    @D64XDOW 05276000
         ST    R0,SVER00          PASS LENGTH AND ADDR OF      @D64XDOW 05277000
         ST    R1,SVER01          ... SPACE TO BE FREED        @D64XDOW 05278000
         DROP  RB                                              @D64XDOW 05279000
         L     R6,EXITGETM        LOAD FREEMAIN ADDR           @D64XDOW 05280000
         BASSM R6,R6              FREE STORAGE                 @D64XDOW 05281000
*SGLINK GMFMSVC78,INPUT=(R6,RA),WORK=(R0-R5,R7-R9,RB-RF)                05282000
         L     R6,TCBATCBE        GET TCBX ADDR                @D64XDOW 05283000
         USING TCBXADR,R6                                      @D64XDOW 05284000
         LA    RE,TCBXXSB         GET SAVE AREA ADDR           @D64XDOW 05285000
         L     RB,TCBSAVE         POINT TO SAVE AREA           @D64XDOW 05286000
         USING SVEARA,RB                                       @D64XDOW 05287000
         IC    R2,11*4+3(,RE)     RESTORE                      @D64XDOW 05288000
         STC   R2,SVEPSW+1        ... USERS PSW BYTE 1         @D64XDOW 05289000
         MVC   SVER0F(12),0(RE)   RESTORE REG 15 - 1           @D64XDOW 05290000
         NI    TCBXSAUS,XFF-TCBXXSBU SAVE AREA IS FREE         @D64XDOW 05291000
         DROP  R6                                              @D64XDOW 05292000
         DROP  RB                                              @D64XDOW 05293000
         LM    R2,RE,3*4(RE)      RELOAD WORK REGISTER         @D64XDOW 05294000
         L     RA,TCBPTR          RELOAD TCB POINTER           @D64XDOW 05295000
         BSM   0,R8               =========>  RETURN           @D64XDOW 05296000
         SPACE                                                          05297000
EXITSUBP DC    C'IEXT'            SUBPOOL ID FOR EXIT-BLOCKS   @D64ADOW 05298000
EXITGETM DC    A(GMFMSVC78+X'80000000') ENTRY TO GETMAIN       @D64XDOW 05299000
         DROP  RA                                              @D64ADOW 05300000
         DROP  RC                                              @D64ADOW 05301000
         EJECT                                                          05302000
*********************************************************************** 05303000
*                                                                     * 05304000
*        CHECK FOR CORRECT LINK STACK LEVEL                           * 05305000
*                                                                     * 05306000
*        INPUT   R2  ROUTINE BASE ADDR                                * 05307000
*                R3  LINKAGE STACK ENTRY AT EXIT DEFINITION           * 05308000
*                R4  CURRENT LINK STACK ENTRY                         * 05309000
*                R8  RETURN ADDRESS                                   * 05310000
*                RA  TCB POINTER                                      * 05311000
*        RETURN WITH DISP 0  -  NOT EQUAL                             * 05312000
*                         4  -  EQUAL                                 * 05313000
*                                                                     * 05314000
*********************************************************************** 05315000
         SPACE 2                                                        05316000
*SGLINK  CCORLSTK,S,INPUT=(R2,R3,R4,R8,RA)                              05317000
         USING CCORLSTK,R2                                     @D64ADOW 05318000
         USING LSTKEDSC,R4        ADDR'Y TO ENTRY DESCRIPTOR   @D64ADOW 05319000
         USING TCBADR,RA                                       @D64ADOW 05320000
CCORLSTK DS    0H                                              @D64ADOW 05321000
         STM   R4,R7,SVCWORKA     FREE UP WORK REGISTER        @D64ADOW 05322000
         CR    R3,R4              BOTH EQUAL                   @D64ADOW 05325000
         BE    CCORL080           YES, THATS OK                @D64ADOW 05326000
         TM    LSTKET,LSTKBENT    IS THIS A STATUS ENTRY       @D64ADOW 05327000
         BO    CCORL090           YES,LINK STACK LEVEL CHANGED @D64ADOW 05328000
         LA    R5,LSTKEDS1-LSTKHDR DISP TO DESCRIPTOR OF HEADER@D64ADOW 05329000
         LR    R6,R4              POINT TO HEADER              @D64ADOW 05330000
         SLR   R6,R5              ...                          @D64ADOW 05331000
         USING LSTKHDR,R6         ADDRESSABILITY TO HEADER     @D64ADOW 05332000
         ICM   R4,15,LSTKBSEA     PREVIOUS ENTRY DESCRIPTOR    @D64ADOW 05333000
         DROP  R6                                              @D64ADOW 05334000
         BNM   CCORL100           ---> IF NOT AVAILABLE        @D64ADOW 05335000
         DROP  R4                                              @D64ADOW 05336000
         N     R4,CCORLMSK        RESET UNUSED BITS            @D64ADOW 05337000
         CR    R3,R4              BOTH EQUAL                   @D64ADOW 05338000
         BNE   CCORL090           NO,                          @D64ADOW 05339000
CCORL080 DS    0H                                              @D64ADOW 05340000
         LM    R4,R7,SVCWORKA     RESTORE REGISTER             @D64ADOW 05341000
         B     4(,R8)             RETURN WITH EQUAL            @D64ADOW 05342000
CCORL090 DS    0H                                              @D64ADOW 05343000
         LM    R4,R7,SVCWORKA     RESTORE REGISTER             @D64ADOW 05344000
         BR    R8                 RETURN WITH NOT EQUAL        @D64ADOW 05345000
CCORL100 DS    0H                                              @D64ADOW 05346000
         LA    R5,HWORG260                                     @D64ADOW 05347000
         STH   R5,IJBHWORI                                     @D64ADOW 05348000
         BAS   R5,SYSERROR        LINKAGE STACK DESTROYED      @D64ADOW 05349000
         DS    0F                                              @D64ADOW 05350000
CCORLMSK DC    A(LSTKMASK)                                     @D64ADOW 05351000
         DROP  R2                                              @D64ADOW 05352000
         DROP  RA                                              @D64ADOW 05354000
         EJECT                                                          05355000
*********************************************************************** 05356000
*                                                                     * 05357000
*   RESET UNSTACK SUPPRESSION BIT                                     * 05358000
*   UNCHAIN ESTAEX FROM VSE AND MVS TCB CHAINS                        * 05359000
*   FREEVIS EXIT BLOCK OR ENQUEUE TO FREE CHAIN                       * 05360490
*                                                                     * 05361000
*   INPUT   R4  ANCHOR TO EXIT BLOCK IF CALLED FOR AB-TYPE EXIT       * 05362000
*               0 IF CALLED FOR RETURN FROM CICS SVC                  * 05363000
*           R7  EXIT CONTROL BLOCK IF CALLED FOR AB-TYPE EXIT         * 05364000
*                  EXITADR = X'80000000' RESET USP-BIT ONLY           * 05365000
*                            X'00000000' S-FREEVIS OR ENQ TO FREE=CHN * 05366490
*                            X'0XXXXXXX' BOTH FUNCTIONS               * 05367000
*               LINKAGE STACK ADDR IF CALLED FOR RETURN FROM CICS SVC * 05368000
*           R8  RETURN ADDRESS                                        * 05369000
*           RA  TCB POINTER                                           * 05370000
*           RC  ROUTINE BASE ADDR                                     * 05371000
*   OUTPUT  R7  0 IF EXIT BLOCK FREED                                 * 05372000
*                                                                     * 05373000
*********************************************************************** 05374000
         SPACE 2                                                        05375000
*SGLINK  RESUSPB,S,INPUT=(R4,R7,R8,RA,RC),OUTPUT=(R7)                   05376000
         USING TCBADR,RA                                       @D64ADOW 05377000
         USING RESUSPB,RC                                      @D64ADOW 05378000
         USING EXITBLK,R7                                      @D64ADOW 05379000
RESUSPB  DS    0H                                              @D64ADOW 05380000
         STM   R0,RF,SVCWORKA     FREE UP WORK REGISTER        @D64ADOW 05381000
         LR    R8,R7              COPY ENTRY REG, R8 HAS TO    @D64ADOW 05382000
***                               CONTAIN LINKSTACK ADDR                05383000
         L     R1,TCBABEX         GET FIRST IN ESTAEX CHAIN    @D64ADOW 05384000
         LTR   R4,R4              RETURN FROM CICS SVC         @D64ADOW 05385000
         BZ    RESUSP10           YES, --->                    @D64ADOW 05386000
         ICM   RE,B'1111',EXITADR CHECK REQUESTED FUNCTION     @D64ADOW 05387000
         BZ    RESUSP30           FREEVIS ONLY REQUIRED --->   @D64ADOW 05388000
         L     R8,EXABLSTK        LINKAGE STACKS ENTRY DESCRIPT@D64ADOW 05389000
         L     R1,EXITNEXT        GET NEXT ESTAEX              @D64ADOW 05390000
         USING LSTKEDSC,R8        ADDR'Y TO ENTRY DESCRIPTOR   @D64ADOW 05391000
RESUSP10 DS    0H                                              @D64ADOW 05392000
         TM    LSTKET,LSTKBENT    IS THIS A STATUS ENTRY       @D64ADOW 05393000
         BNO   RESUSP30           NO,  --->                    @D64ADOW 05394000
         LTR   R1,R1              ESTAEX AVAILABLE             @D64ADOW 05395000
         BZ    RESUSP15           NO,                          @D64ADOW 05396000
         C     R8,EXABLSTK-EXITBLK(,R1) FURTHER ESTAEX AT SAME @D64ADOW 05397000
***                                LINKAGE STACK LEVEL         @D64ADOW 05398000
         BE    RESUSP30           YES,                         @D64ADOW 05399000
RESUSP15 DS    0H                                              @D64ADOW 05400000
         LTR   R4,R4              CALLED FOR RET FROM CICS SVC @D64ADOW 05401000
         BZ    RESUSP20           YES, --->                    @D64ADOW 05402000
         SLR   R1,R1                                           @D65CDOW         
         ICM   R1,B'0111',EXABCURBA GET RB FROM EXIT CREATION  @D65CDOW 05403000
         BZ    RESUSP20           NOT AVAILABLE --->           @D64ADOW 05404000
         TM    RBSTAB1-RBSECT(R1),RBFTSVRB CREATED IN CICS-SVC @D64ADOW 05405000
         BZ    RESUSP20           NO --->                      @D64ADOW 05406000
         LA    R9,RBPRFXLN        GET ADDR OF PREFIX           @D64ADOW 05407000
         SLR   R1,R9              ... OF THIS RB               @D64ADOW 05408000
         L     R1,RBXSB-RBPREFIX(,R1) GET XSB ADDR             @D64ADOW 05409000
         USING XSB,R1                                          @D64ADOW 05410000
         C     R8,XSBSEL          RB DEFINED AT CURRENT LINKAGE@D64ADOW 05411000
***                               STACK LEVEL                           05412000
         DROP  R1                                              @D64ADOW 05413000
         BE    RESUSP30           YES, --->                    @D64ADOW 05414000
RESUSP20 DS    0H                                              @D64ADOW 05415000
         NI    LSTKET,XFF-LSTKUSPB  RESET USP-BIT              @D64ADOW 05416000
         DROP  R8                                              @D64ADOW 05417000
RESUSP30 DS    0H                                              @D64ADOW 05418000
         LTR   R4,R4              CALLED FOR RET FROM CICS SVC @D64ADOW 05419000
         BZ    RESUSP90           YES, --->                    @D64ADOW 05420000
         LTR   RE,RE              ONLY RESET USP-BIT REQUIRED  @D64ADOW 05421000
         BM    RESUSP90           YES, --->                    @D64ADOW 05422000
         ICM   R9,B'1111',PSATOLD FAM API ACTIVE               @D64ADOW 05423000
         BZ    RESUSP60           NO, --->                     @D64ADOW 05424000
         LA    R5,EXABMSCB        SCB IN CURRENT EXIT BLOCK    @D64ADOW 05425000
         LA    R9,TCBSTABB-TCB(,R9) ADDR(MVS-SCB CHAIN HEADER) @D64ADOW 05426000
***                               (BYTE 0 IS ZERO NOW)                  05427000
RESUSP40 DS    0H                                              @D64ADOW 05428000
         CLM   R5,B'0111',0(R9)   OUR SCB                      @D64ADOW 05429000
         BE    RESUSP50           YES, --->                    @D64ADOW 05430000
         ICM   R9,B'0111',0(R9)   GET NEXT MVS-SCB             @D64ADOW 05431000
         BZ    RESUSP60           SHOULD NOT OCCUR             @D66XXOW         
         CLC   0(1,R9),SCBXPTR+3-SCB(R9) FORCE PROG CHK IF INV @D66XXOW         
PCKFAPIA DS    0H                    PROG CHK ADDR FOR SGPCK   @D66XXOW         
         LA    R9,1(,R9)          SKIP FIRST BYTE IN SCB       @D64ADOW 05432000
         B     RESUSP40           CONTINUE SEARCHING           @D64ADOW 05433000
RESUSP50 DS    0H                                              @D64ADOW 05434000
         MVC   0(3,R9),1(R5)      UNCHAIN OUR MVS-SCB          @D64ADOW 05435000
RESUSP60 DS    0H                                              @D64ADOW 05436000
         LH    R0,EXITLENG        LENGTH OF ELEMENT FOR FREEVIS@D64ADMK 05437000
         LR    R1,R7              COPY EXIT BLOCK ADDR         @D64ADMK 05438000
         L     R5,BIT0ON                                       @D64ADOW 05439000
         N     R5,0(,R4)          KEEP BIT 0 (EXIT ACTIV INDCAT@D64ADOW 05440000
         O     R5,EXITNEXT        NEXT BLOCK ...               @D64ADMK 05441000
         ST    R5,0(,R4)          COMPLETE CHAINING            @D64ADMK 05443000
         CLI   EXITFLG2,EXESTAEX  WAS THIS AN ESTAEX           @D64ADOW 05444030
         BNE   RESUSP80                                        @D64ADOW 05444060
         LR    R2,R0              COPY LENGTH                  @D64ADOW 05444090
         BCTR  R2,0               LENGTH FOR CLEARING          @D64ADOW 05444120
         EX    R2,RESXC           CLEAR CB                     @D64ADOW 05444150
         STH   R0,EXITLENG        INITIALIZE FOR               @D64ADOW 05444180
         OI    EXITFLG,EXITGETV   ... FOR REUSE                @D64ADOW 05444210
         L     R2,TCBATCBE                                     @D64ADOW 05444240
         USING TCBXADR,R2                                      @D64ADOW 05444270
         LA    R5,TCBXCBEM        POINT TO ANCHOR FOR EMUL MODE@D64ADOW 05444300
         LA    R9,EXABMLN                                      @D64ADOW 05444330
         CR    R0,R9              IS IT EMULATION MODE         @D64ADOW 05444360
         BE    RESUSP70           YES, --->                    @D64ADOW 05444390
         LA    R5,TCBXCBNA        POINT TO ANCHOR FOR NAT MODE @D64ADOW 05444420
         DROP  R2                                              @D64ADOW 05444450
RESUSP70 DS    0H                                              @D64ADOW 05444480
         L     R9,0(,R5)          ENQUEUE                      @D64ADOW 05444510
         ST    R7,0(,R5)          ... CB IN                    @D64ADOW 05444540
         ST    R9,0(,R7)          ... FREE CHAIN               @D64ADOW 05444570
         B     RESUSP85                                        @D64ADOW 05444600
         DROP  R7                                              @D64ADOW 05444630
RESUSP80 DS    0H                                              @D64ADOW 05444660
*** FREEVIS FOR STXIT AB CONTROL BLOCK                                  05444690
*        SFREEVIS ADDRESS=(1),LENGTH=(0)                                05445000
         SFREEVIS ADDRESS=(1),LENGTH=(0)                       @D64ADMK 05446000
*END OF SFREEVIS MACRO                                                  05447000
RESUSP85 DS    0H                                              @D64ADOW 05447500
         SPACE                                                          05448000
         SLR   RF,RF                                           @D64ADOW 05449000
         ST    RF,SVCWORKA+7*4    INDICATE EXIT BLOCK FREED    @D64ADOW 05450000
RESUSP90 DS    0H                                              @D64ADOW 05451000
         LM    R0,RF,SVCWORKA     RELOAD WORK REGISTER         @D64ADOW 05452000
         BR    R8                 RETURN                       @D64ADOW 05453000
         DS    0F                                              @D64ADOW 05454000
RESXC    XC    0(0,R7),0(R7)      CLEAR CB                     @D64ADOW 05454500
RESUSPMK DC    X'7FFFFFF8'                                     @D64ADOW 05455000
         DROP  RA                                              @D64ADOW 05456000
         DROP  RC                                              @D64ADOW 05457000
         EJECT                                                          05458000
*********************************************************************** 05459000
*                                                                     * 05460000
*        CHECK FOR RELATED STATUS ENTRY FOR GIVEN LINKAGE STACK ENTRY * 05461490
*                                                                     * 05462000
*        INPUT   R8  RETURN ADDR                                      * 05463000
*                RA  TCB POINTER                                      * 05464000
*                RC  ROUTINE BASE ADDR                                * 05465000
*                RF  LINKAGE STACK ENTRY ADDR                         * 05466290
*        OUTPUT  RC  RELATED STATUS ENTRY ADDR                        * 05466580
*                                                                     * 05467000
*********************************************************************** 05468000
         SPACE 2                                                        05469000
*SGLINK  CCURLSTK,S,INPUT=(R8,RA,RC,RF),OUTPUT=RC                       05470490
         USING TCBADR,RA                                       @D64ADOW 05471000
         USING CCURLSTK,RC                                     @D64ADOW 05472000
CCURLSTK DS    0H                                              @D64ADOW 05473000
         STM   R2,R5,SVCWORKA     SAVE SOME WORK REGISTER      @D64ADOW 05474000
         LR    R3,RF              COPY LINKAGE STACK ENTRY ADDR@D64ADOW 05475990
         USING LSTKEDSC,R3                                     @D64ADOW 05478000
         TM    LSTKET,LSTKBENT    IS THIS A STATUS ENTRY       @D64ADOW 05479000
         BO    CCURL050           YES, --->                    @D64ADOW 05480000
         LR    R4,R3              COPY ENTRY DESCRIPTOR ADDR   @D64ADOW 05481000
         LA    R5,LSTKEDS1-LSTKHDR BACK TO HEADER ENTRY        @D64ADOW 05482000
         SLR   R4,R5              ...                          @D64ADOW 05483000
         USING LSTKHDR,R4         ADDRESSABILITY TO HEADER     @D64ADOW 05484000
         ICM   R4,15,LSTKBSEA     PREVIOUS LS SECTION          @D64ADOW 05485000
         BNM   CCURL050           NOT AVAILABLE --->           @D64ADOW 05486000
         N     R4,CCURLMSK        RESET UNUSED BITS            @D64ADOW 05487000
         LR    R3,R4                                           @D64ADOW 05488000
CCURL050 DS    0H                                              @D64ADOW 05489000
         LR    RC,R3              LINKAGE STACK TO OUTPUT REG  @D64ADOW 05490000
         DROP  RC                                              @D64ADOW 05491000
         LM    R2,R5,SVCWORKA     RESTORE REGISTER             @D64ADOW 05492000
         BR    R8                                              @D64ADOW 05493000
         DS    0F                                              @D64ADOW 05494000
CCURLMSK DC    A(LSTKMASK)                                     @D64ADOW 05495000
         DROP  R3                                              @D64ADOW 05497000
         DROP  R4                                              @D64ADOW 05498000
         DROP  RA                                              @D64ADOW 05499000
         EJECT                                                          05500000
*********************************************************************** 05501000
*                                                                     * 05502000
*        EXIT TO CANCEL WITH ERR47                                    * 05503000
*                                                                     * 05504000
*        INPUT   R1  REASON CODE                                      * 05505000
*                RC  BASE ADDR                                        * 05506000
*                                                                     * 05507000
*********************************************************************** 05508000
         SPACE 2                                                        05509000
         USING COMERR47,RC                                     @D64ADOW 05510000
COMERR47 DS    0H                                              @D64ADOW 05511000
*SGLINK COMERR47,S,INPUT=(R1,RC)                                        05512000
         L     RA,TCBPTR          GET TCB OF CURRENT TASK      @D64ADOW 05513000
         USING TCBADR,RA                                       @D64ADOW 05514000
         L     R9,TCBATCBE        GET ADDR OF TCB EXTENSION    @D64ADOW 05515000
         USING TCBXADR,R9                                      @D64ADOW 05516000
         TM    TCBXSAUS,TCBXXSAU  SAVE AREA USED               @D64ADOW 05517000
         BNO   COMERL10           NO, TAKE IT                  @D64ADOW 05518000
         BAS   R5,SYSERROR        YES, MUST NOT OCCUR          @D64ADOW 05519000
COMERL10 DS    0H                                              @D64ADOW 05520000
         OI    TCBXSAUS,TCBXXSAU  SAVE AREA IS USED            @D64ADOW 05521000
         XC    TCBXXSA,TCBXXSA    CLEAR WORK AREA              @D64ADOW 05522000
         LA    R7,TCBXXSA         POINT TO ERROR MSG TEXT      @D64ADOW 05523000
         O     R7,BIT0ON          ... INDICATE AREA IN TCBX    @D64ADOW 05524000
         USING MAPDMPIF,R7                                     @D64ADOW 05525000
         LA    R5,L'CANC47AB+L'COMERNUC GET LENGTH OF INFO     @D64ADOW 05526000
         O     R5,BIT0ON          ... INDICATE AREA IN TCBX    @D64ADOW 05527000
         ST    R5,CANC47LN        ... TO MSG AREA              @D64ADOW 05528000
         ST    R1,CANC47AB        REASON CODE TO MSG AREA      @D64ADOW 05529000
         MVC   CANC47CO(L'COMERNUC),COMERNUC COMP-ID TO MSG ARE@D64ADOW 05530000
         DROP  R7                                              @D64ADOW 05531000
         DROP  R9                                              @D64ADOW 05532000
         DROP  RA                                              @D64ADOW 05533000
         LR    R1,R7              COPY MSG AREA                @D64ADOW 05534000
         L     R6,ADISPSER        ADDR OF DISPATCHER SERVICES  @D61NDOW 05535000
         LA    R0,4               REQ CANCEL SERVICE           @D61NDOW 05536000
         LA    RB,CANCX47         CANCEL CODE 47               @D64ADOW 05537000
         BASSM R7,R6              EXIT TO CANCEL USER          @D64ADOW 05538000
         DROP  RC                                              @D64ADOW 05539000
         SPACE                                                          05540000
COMERNUC DC    C'NUCLEUS'                                      @D64ADOW 05541000
         EJECT                                                          05542000
*********************************************************************** 05543000
*                                                                     * 05544000
*        EXIT TO CANCEL WITH ERR48                                    * 05545000
*                                                                     * 05546000
*        INPUT   R1     REASON CODE                                   * 05547000
*                R2,R3  MACRO NAME                                    * 05548000
*                R6     SUBREASON CODE                                * 05549000
*                RC     BASE ADDR                                     * 05550000
*                                                                     * 05551000
*********************************************************************** 05552000
         SPACE 2                                                        05553000
         USING COMERR48,RC                                     @D64ADOW 05554000
COMERR48 DS    0H                                              @D64ADOW 05555000
*SGLINK COMERR48 S,INPUT=(R1,R2,R3,R6,RC)                               05556000
         L     RA,TCBPTR          GET TCB OF CURRENT TASK      @D64ADOW 05557000
         USING TCBADR,RA                                       @D64ADOW 05558000
         L     R9,TCBATCBE        GET ADDR OF TCB EXTENSION    @D64ADOW 05559000
         USING TCBXADR,R9                                      @D64ADOW 05560000
         TM    TCBXSAUS,TCBXXSAU  SAVE AREA USED               @D64ADOW 05561000
         BNO   COM48L10           NO, TAKE IT                  @D64ADOW 05562000
         BAS   R5,SYSERROR        YES, MUST NOT OCCUR          @D64ADOW 05563000
COM48L10 DS    0H                                              @D64ADOW 05564000
         OI    TCBXSAUS,TCBXXSAU  SAVE AREA IS USED            @D64ADOW 05565000
         LA    R7,TCBXXSA         POINT TO ERROR MSG TEXT      @D64ADOW 05566000
         O     R7,BIT0ON          ... INDICATE AREA IN TCBX    @D64ADOW 05567000
         USING MAPDMPIF,R7                                     @D64ADOW 05568000
         XC    CANC48LN(L'CANC48LN+L'CANC48FX+8),CANC48LN      @D64ADOW 05569000
***                               CLEAR MESSAGE AREA (MACRO NAME 8 BYT) 05570000
         LA    R5,L'CANC48FX+8    GET LENGTH OF ADDITIONAL INFO@D64ADOW 05571000
         O     R5,BIT0ON          ... INDICATE AREA IN TCBX    @D64ADOW 05572000
         ST    R5,CANC48LN        ... TO MSG AREA              @D64ADOW 05573000
         LTR   R2,R2              MACRO NAME SPECIFIED         @D64ADOW 05574000
         BZ    COM48L20           NO --->                      @D64ADOW 05575000
         STM   R2,R3,CANC48MN     SAVE MACRO NAME              @D64ADOW 05576000
         OI    CANC48FL,C48VALMC                               @D64ADOW 05577000
COM48L20 DS    0H                                              @D64ADOW 05578000
         LA    R2,COM48TAB        GET ADDR OF AB-CODE TABLE    @D64ADOW 05579000
         AR    R2,R1              GET RELATED ENTRY ADDR       @D64ADOW 05580000
         LM    R3,R4,0(R2)        LOAD ABEND CODE / RSN CODE   @D64ADOW 05581000
         LTR   R3,R3              REASON CODE SPECIFIED        @D64ADOW 05582000
         BM    COM48L40           NO,                          @D64ADOW 05583000
         OI    CANC48FL,C48VALRS  INDICATE VALID REASON CODE   @D64ADOW 05584000
         ST    R4,CANC48RC        SAVE REASON CODE             @D64ADOW 05585000
COM48L40 DS    0H                                              @D64ADOW 05586000
         STCM  R3,B'0111',CANC48AB+1 SAVE ABEND CODE           @D64ADOW 05587000
COM48L60 DS    0H                                              @D64ADOW 05588000
         LTR   R6,R6              SUBREASON CODE SPECIFIED     @D64ADOW 05589000
         BZ    COM48L80           NO, --->                     @D64ADOW 05590000
         ST    R6,CANC48RX        SAVE REASON CODE             @D64ADOW 05591000
         OI    CANC48FL,C48VALSU  INDICATE VALID REASON CODE   @D64ADOW 05592000
COM48L80 DS    0H                                              @D64ADOW 05593000
         DROP  R7                                              @D64ADOW 05594000
         DROP  R9                                              @D64ADOW 05595000
         DROP  RA                                              @D64ADOW 05596000
         LR    R1,R7              COPY MSG AREA ADDR           @D64ADOW 05597000
         L     R6,ADISPSER        ADDR OF DISPATCHER SERVICES  @D61NDOW 05598000
         LA    R0,4               REQ CANCEL SERVICE           @D61NDOW 05599000
         LA    RB,CANCX48         CANCEL CODE 48               @D64ADOW 05600000
         BASSM R7,R6              EXIT TO CANCEL USER          @D64ADOW 05601000
         DROP  RC                                              @D64ADOW 05602000
         SPACE                                                          05603000
***                                                                     05604000
***      ABEND/REASON CODE TABLE                                        05605000
***                                                                     05606000
COM48TAB DS    0F                                              @D64ADOW 05607000
***                                                                     05608000
C07D     EQU   ABND07D         SYSTEM COMPLETION CODE 07D      @D64ADOW 05609000
C07DR000 DC    A(X'0007D000'),A(0)                             @D64ADOW 05610000
C07DR004 DC    A(X'0007D000'),A(4)                             @D64ADOW 05611000
***                                                                     05612000
C0C0     EQU   ABND0C0         SYSTEM COMPLETION CODE 0CX      @D64ADOW 05613000
C0C7R007 DC    A(X'000C7000'),A(7)                             @D64ADOW 05614000
***                                                                     05615000
C10B     EQU   ABND10B         SYSTEM COMPLETION CODE 10B      @D64ADOW 05616000
C10BRNO  DC    A(X'8010B000'),A(0)        NO REASON CODE       @D64ADOW 05617000
***                                                                     05618000
C12F     EQU   ABND12F         SYSTEM COMPLETION CODE 12F      @D64ADOW 05619000
C12FR004 DC    A(X'0012F000'),A(X'4')                          @D64ADOW 05620000
C12FR00C DC    A(X'0012F000'),A(X'C')                          @D64ADOW 05621000
C12FR028 DC    A(X'0012F000'),A(X'28')                         @D64ADOW 05622000
***                                                                     05623000
C2C5     EQU   ABND2C5         SYSTEM COMPLETION CODE 2C5      @D64ADOW 05624000
C2C5R400 DC    A(X'002C5000'),A(RSNUC400)                      @D64ADOW 05625000
C2C5R401 DC    A(X'002C5000'),A(RSNUC401)                      @D64ADOW 05626000
C2C5R403 DC    A(X'002C5000'),A(RSNUC403)                      @D64ADOW 05627000
C2C5R404 DC    A(X'002C5000'),A(RSNUC404)                      @D64ADOW 05628000
C2C5R406 DC    A(X'002C5000'),A(RSNUC406)                      @D64ADOW 05629000
C2C5R408 DC    A(X'002C5000'),A(RSNUC408)                      @D64ADOW 05630000
C2C5R409 DC    A(X'002C5000'),A(RSNUC409)                      @D64ADOW 05631000
C2C5R40A DC    A(X'002C5000'),A(RSNUC40A)                      @D64ADOW 05632000
C2C5R40B DC    A(X'002C5000'),A(RSNUC40B)                      @D64ADOW 05633000
C2C5R410 DC    A(X'002C5000'),A(RSNUC410)                      @D64ADOW 05634000
C2C5R411 DC    A(X'002C5000'),A(RSNUC411)                      @D64ADOW 05635000
C2C5R412 DC    A(X'002C5000'),A(RSNUC412)                      @D64ADOW 05636000
C2C5R413 DC    A(X'002C5000'),A(RSNUC413)                      @D64ADOW 05637000
C2C5R414 DC    A(X'002C5000'),A(RSNUC414)                      @D64ADOW 05638000
C2C5R415 DC    A(X'002C5000'),A(RSNUC415)                      @D64ADOW 05639000
C2C5R416 DC    A(X'002C5000'),A(RSNUC416)                      @D64ADOW 05640000
C2C5R417 DC    A(X'002C5000'),A(RSNUC417)                      @D64ADOW 05641000
C2C5R41D DC    A(X'002C5000'),A(RSNUC41D)                      @D64ADOW 05642000
C2C5R41E DC    A(X'002C5000'),A(RSNUC41E)                      @D64ADOW 05643000
C2C5R421 DC    A(X'002C5000'),A(RSNUC421)                      @D64ADOW 05644000
C2C5R440 DC    A(X'002C5000'),A(RSNUC440)                      @D66XXOW 05644000
C2C5R4F0 DC    A(X'002C5000'),A(RSNUC4F0)                      @D64ADOW 05645000
C2C5R4FE DC    A(X'002C5000'),A(RSNUC4FE)                      @D64ADOW 05646000
C2C5R4FF DC    A(X'002C5000'),A(RSNUC4FF)                      @D64ADOW 05647000
C2C5R500 DC    A(X'002C5000'),A(RSTIM500)                      @D64ADOW 05648000
C2C5R501 DC    A(X'002C5000'),A(RSTIM501)                      @D64ADOW 05649000
C2C5R502 DC    A(X'002C5000'),A(RSTIM502)                      @D64ADOW 05650000
C2C5R503 DC    A(X'002C5000'),A(RSTIM503)                      @D64ADOW 05651000
C2C5R505 DC    A(X'002C5000'),A(RSTIM505)                      @D64ADOW 05652000
C2C5R506 DC    A(X'002C5000'),A(RSTIM506)                      @D64ADOW 05653000
C2C5R507 DC    A(X'002C5000'),A(RSTIM507)                      @D64ADOW 05654000
C2C5R508 DC    A(X'002C5000'),A(RSTIM508)                      @D64ADOW 05655000
C2C5R509 DC    A(X'002C5000'),A(RSTIM509)                      @D64ADOW 05656000
C2C5R50A DC    A(X'002C5000'),A(RSTIM50A)                      @D64ADOW 05657000
C2C5R53F DC    A(X'002C5000'),A(RSTIM53F)                      @D64ADOW 05658000
***                                                                     05659000
C32E     EQU   ABND32E         SYSTEM COMPLETION CODE 32E      @D64ADOW 05660000
C32ER10C DC    A(X'0032E000'),A(X'10C')                        @D64ADOW 05661000
C32ER11C DC    A(X'0032E000'),A(X'11C')                        @D64ADOW 05662000
C32ER128 DC    A(X'0032E000'),A(X'128')                        @D64ADOW 05663000
C32ER224 DC    A(X'0032E000'),A(X'224')                        @D64ADOW 05664000
C32ER324 DC    A(X'0032E000'),A(X'324')                        @D64ADOW 05665000
***                                                                     05666000
C46D     EQU   ABND46D         SYSTEM COMPLETION CODE 46D      @D64ADOW 05667000
C46DR010 DC    A(X'0046D000'),A(X'10')                         @D64ADOW 05668000
C46DR014 DC    A(X'0046D000'),A(X'14')                         @D64ADOW 05669000
***                                                                     05670000
***      TABLE DISPLACEMENTS                                            05671000
***                                                                     05672000
D07DR000 EQU   C07DR000-COM48TAB                               @D64ADOW 05673000
D07DR004 EQU   C07DR004-COM48TAB                               @D64ADOW 05674000
D0C7R007 EQU   C0C7R007-COM48TAB                               @D64ADOW 05675000
D10BRNO  EQU   C10BRNO-COM48TAB                                @D64ADOW 05676000
D12FR004 EQU   C12FR004-COM48TAB                               @D64ADOW 05677000
D12FR00C EQU   C12FR00C-COM48TAB                               @D64ADOW 05678000
D12FR028 EQU   C12FR028-COM48TAB                               @D64ADOW 05679000
D2C5R400 EQU   C2C5R400-COM48TAB                               @D64ADOW 05680000
D2C5R401 EQU   C2C5R401-COM48TAB                               @D64ADOW 05681000
D2C5R403 EQU   C2C5R403-COM48TAB                               @D64ADOW 05682000
D2C5R404 EQU   C2C5R404-COM48TAB                               @D64ADOW 05683000
D2C5R406 EQU   C2C5R406-COM48TAB                               @D64ADOW 05684000
D2C5R408 EQU   C2C5R408-COM48TAB                               @D64ADOW 05685000
D2C5R409 EQU   C2C5R409-COM48TAB                               @D64ADOW 05686000
D2C5R40A EQU   C2C5R40A-COM48TAB                               @D64ADOW 05687000
D2C5R40B EQU   C2C5R40B-COM48TAB                               @D64ADOW 05688000
D2C5R410 EQU   C2C5R410-COM48TAB                               @D64ADOW 05689000
D2C5R411 EQU   C2C5R411-COM48TAB                               @D64ADOW 05690000
D2C5R412 EQU   C2C5R412-COM48TAB                               @D64ADOW 05691000
D2C5R413 EQU   C2C5R413-COM48TAB                               @D64ADOW 05692000
D2C5R414 EQU   C2C5R414-COM48TAB                               @D64ADOW 05693000
D2C5R415 EQU   C2C5R415-COM48TAB                               @D64ADOW 05694000
D2C5R416 EQU   C2C5R416-COM48TAB                               @D64ADOW 05695000
D2C5R417 EQU   C2C5R417-COM48TAB                               @D64ADOW 05696000
D2C5R41D EQU   C2C5R41D-COM48TAB                               @D64ADOW 05697000
D2C5R41E EQU   C2C5R41E-COM48TAB                               @D64ADOW 05698000
D2C5R421 EQU   C2C5R421-COM48TAB                               @D64ADOW 05699000
D2C5R440 EQU   C2C5R440-COM48TAB                               @D66XXOW 05699000
D2C5R4F0 EQU   C2C5R4F0-COM48TAB                               @D64ADOW 05700000
D2C5R4FE EQU   C2C5R4FE-COM48TAB                               @D64ADOW 05701000
D2C5R4FF EQU   C2C5R4FF-COM48TAB                               @D64ADOW 05702000
D2C5R500 EQU   C2C5R500-COM48TAB                               @D64ADOW 05703000
D2C5R501 EQU   C2C5R501-COM48TAB                               @D64ADOW 05704000
D2C5R502 EQU   C2C5R502-COM48TAB                               @D64ADOW 05705000
D2C5R503 EQU   C2C5R503-COM48TAB                               @D64ADOW 05706000
D2C5R505 EQU   C2C5R505-COM48TAB                               @D64ADOW 05707000
D2C5R506 EQU   C2C5R506-COM48TAB                               @D64ADOW 05708000
D2C5R507 EQU   C2C5R507-COM48TAB                               @D64ADOW 05709000
D2C5R508 EQU   C2C5R508-COM48TAB                               @D64ADOW 05710000
D2C5R509 EQU   C2C5R509-COM48TAB                               @D64ADOW 05711000
D2C5R50A EQU   C2C5R50A-COM48TAB                               @D64ADOW 05712000
D2C5R53F EQU   C2C5R53F-COM48TAB                               @D64ADOW 05713000
D32ER10C EQU   C32ER10C-COM48TAB                               @D64ADOW 05714000
D32ER11C EQU   C32ER11C-COM48TAB                               @D64ADOW 05715000
D32ER128 EQU   C32ER128-COM48TAB                               @D64ADOW 05716000
D32ER224 EQU   C32ER224-COM48TAB                               @D64ADOW 05717000
D32ER324 EQU   C32ER324-COM48TAB                               @D64ADOW 05718000
D46DR010 EQU   C46DR010-COM48TAB                               @D64ADOW 05719000
D46DR014 EQU   C46DR014-COM48TAB                               @D64ADOW 05720000
         SPACE                                                          05721000
         EJECT                                                          05722000
****************************************************************        05723000
*                                                              *        05724000
*        ESTAEX PROCESSING                                     *        05725000
*               ENTERED BY MEANS OF PC INSTRUCTION             *        05726000
*                                                              *        05727000
*        INPUT:  R0  FUNCTION CODE                             *        05728000
*                    0 - CREATE (CT)                           *        05729000
*                    4 - OVERLAY (OV)                          *        05730000
*                    8 - DELETE WITHOUT TOKEN                  *        05731000
*                   12 - DELETE WITH TOKEN                     *        05732000
*                R1 FC 0  - POINTER TO PARAMETER LIST          *        05733390
*                   FC 4  - POINTER TO PARAMETER LIST          *        05733780
*                   FC 8  - N.A.                               *        05734170
*                   FC 12 - TOKEN                              *        05734560
*        OUTPUT  RF  RETURN CODE                               *        05735000
*                R0  RC 4 - SUBREASON CODE                     *        05736000
*                    FC 0 - TOKEN                              *        05737000
*                                                              *        05738000
* NOTE: SVCWORKB (SAVEAREA FOR PSW AND R15-R1)                 *        05738100
*       SVCWORK  (SAVEAREA FOR CR3-CR15)                       *        05738200
*       SVCWORKA (SAVEAREA FOR R0-R15 AT SUB-RTN CALL)         *        05738300
*       SVCSV3   (USED AS SAVEAREA DURING SGETVIS)             *        05738400
*       IN THE TCB ARE USED DURING PROCESSING OF THIS ROUTINE  *        05738500
*                                                              *        05738600
****************************************************************        05739000
         USING ESTX,R1                                         @D64ADOW 05739500
ESTAEXBG DS    0H                                              @D64ADOW 05740000
         BASR  RD,0               SETUP BASE                   @D64ADOW 05741000
         USING *,RD                                            @D64ADOW 05742190
         STNSM PSWMASK,DISABLE    DISABLE I/O AND EXT INTERRUPT@D65CDOW 05742380
***                               (NOT NECESSARY, ONLY PERFORMANCE)     05744280
         C     R0,F0              FCT ADD NEW ESTAEX           @D64ADOW 05743330
         BE    ESTAEX00           YES--->                      @D64ADOW 05743520
         C     R0,F4              FCT OVERWRITE ESTAEX         @D64ADOW 05743330
         BNE   ESTAEX02           NO --->                      @D64ADOW 05743520
ESTAEX00 DS    0H                                              @D64ADOW 05745800
         LRA   R5,0(,R1)          CHECK PARAMETER LIST BEG ADDR@D65CDOW         
         BC    8,ESTAEX01         ADDRESSABLE --->             @D65CDOW         
         BC    5,ESTERR04         INVALID ---> SUPPLY RET CODE @D65CDOW         
         STNSM PSWMASK,XFF-SMDAT                               @D65CDOW         
         L     R5,0(,R5)          GET PAGE TABLE ENTRY         @D65CDOW         
         STOSM PSWMASK,SMDAT                                   @D65CDOW         
         N     R5,ESTX2000        PAGE INVALID                 @D65CDOW         
         BNZ   ESTERR04           YES, ---> SUPPLY RETURN CODE @D65CDOW         
ESTAEX01 DS    0H                                              @D65CDOW         
         LRA   R5,ESTAEXLN-1(,R1) CHECK PARAMETER LIST END ADDR@D65CDOW         
         BC    8,ESTAEX02         ADDRESSABLE --->             @D65CDOW         
         BC    5,ESTERR04         INVALID ---> SUPPLY RET CODE @D65CDOW         
         STNSM PSWMASK,XFF-SMDAT                               @D65CDOW         
         L     R5,0(,R5)          GET PAGE TABLE ENTRY         @D65CDOW         
         STOSM PSWMASK,SMDAT                                   @D65CDOW         
         N     R5,ESTX2000        PAGE INVALID                 @D65CDOW         
         BNZ   ESTERR04           YES, ---> SUPPLY RETURN CODE @D65CDOW         
ESTAEX02 DS    0H                                              @D64ADOW 05745800
         L     R5,PCBPTR          GET TASKS PCB POINTER        @D64ADOW 05745990
         USING PCBADR,R5                                       @D64ADOW 05746180
         L     RA,TCBPTR          GET TASKS TCB POINTER        @D64ADOW 05746370
         USING TCBADR,RA                                       @D64ADOW 05749000
         TM    TCBEXITH,TCBESTSV  ESTAE-ENVIRONMENT SUSPENDED  @D65CDOW         
         BO    ESTERR08           YES, CANCEL                  @D65CDOW         
         CLI   RID+1,USERTID      CALLED BY APPLICATION        @D64ADOW 05750490
         BE    ESTAEX05           YES, --->                    @D64ADOW 05750980
         CLI   RID+1,RESVCID      ...VTAM APPLICATION          @D64ADOW 05751470
         BNE   ESTERR02           NO, ---> CANCEL              @D64ADOW 05751960
ESTAEX05 DS    0H                                              @D64ADOW 05752450
         ST    R1,SVCWORKB+8+8    SAVE ADDR-OF-PAR-AREA/TOKEN  @D64ADOW 05752940
         LR    R6,R0              COPY FUNCTION CODE           @D64ADOW 05753430
         SRL   R6,2               CHECK FCT CODE               @D64ADOW 05753920
         C     R6,F3              ... LARGER 12                @D64ADOW 05754410
         BH    ESTAR08            ... YES --->                 @D64ADOW 05755000
         SLL   R6,2               ...                          @D64ADOW 05756590
         CR    R0,R6              ... MULTIPLE OF FOUR         @D64ADOW 05757180
         BNE   ESTAR08            ... NO, --->                 @D64ADOW 05758000
         L     R6,TCBATCBE                                     @D64ADOW 05759690
         USING TCBXADR,R6                                      @D64ADOW 05760380
         ICM   R8,B'1111',PTCBAPTC PSEUDO TCBX INITIALIZED ?   @D64ADOW 05761070
         BNZ   ESTAEX10           YES --->                     @D64ADOW 05762000
         ST    R6,PTCBAPTC                                     @D64ADOW 05763590
         DROP  R6                                              @D64ADOW 05764180
ESTAEX10 DS    0H                                              @D64ADOW 05765000
         L     R8,TIBPTR          GET TIB POINTER              @D64ADOW 05766000
         TM    TIBFLAG1-TIBADR(R8),EOTINPR+TERMACT             @D64ADOW 05767000
***                               TERMINATOR OR CLEAN-UP IN PROCESS     05768000
         BNZ   ESTERR03           YES, CANCEL                  @D64ADOW 05769000
         TM    TCBFLAG6,TCBPSTAC  VENDOR EXIT ACTIVE           @D64ADOW 05770590
         BO    ESTERR01           YES, CANCEL REQUESTOR        @D64ADOW 05771180
         TM    TCBEXITF,TCBPOACT+TCBEXACT ETXR OR POST EXIT ACT@D64ADOW 05772000
         BNZ   ESTERR06           YES, CANCEL REQUESTOR        @D64ADOW 05773000
         L     R7,TCBABEX         TCB ESTAE EXIT BLOCK ADDRESS @D64ADOW 05774490
         LA    R7,0(,R7)          ...                          @D64ADOW 05775000
         USING EXITBLK,R7                                      @D64ADOW 05776490
***                               ESTAEX NOT ALLOWED WHILE FRR DEFINED  05777000
         ICM   R6,B'1111',TCBFREX GET FRR STACK ADDR           @D64ADOW 05778490
         BZ    ESTAEX20           NOT AVAILABLE --->           @D64ADOW 05779000
         USING FRRS,R6                                         @D64ADOW 05780490
         CLC   FRRSCURR(4),FRRSEMP IS FRR-STACK EMPTY          @D64ADOW 05781000
         DROP  R6                                              @D64ADOW 05782490
         BNE   ESTAR30            NO, ERROR EXIT --->          @D64ADOW 05783000
ESTAEX20 DS    0H                                              @D64ADOW 05784000
         LA    R4,1               RETRIEVE PSW                 @D64ADOW 05784100
         ESTA  R2,R4              ... FROM LINKAGE STACK       @D64ADOW 05784200
         STM   R2,R3,SVCWORKB     SAVE PSW                     @D64ADOW 05784300
         STCTL R3,RF,SVCWORK      RETRIEVE CONTROL REGISTER    @D64ADOW 05784400
         LA    R2,SVCWORKB-8      BASE FOR SVEARA              @D64ADOW 05784500
         USING SVEARA,R2                                       @D64ADOW 05784600
         TM    SVEPSWST,ENABLE    INTERRUPTS ENABLED           @D64ADOW 05785000
         BNO   ESTAR28            NO,  RETURN CODE             @D64ADOW 05786000
         TM    SVEPSWMK,SVEARMOD  IS IT ACC REGISTER MODE      @D64ADOW 05787000
         BZ    ESTAEX30           NO,                          @D64ADOW 05788000
         EAR   R6,R1              CHECK AR1                    @D64ADOW 05789690
         LTR   R6,R6              ... FOR ZERO                 @D64ADOW 05790380
         BNZ   ESTAR1C            NOT ZERO ---> ISSUE RET CODE @D64ADOW 05791070
ESTAEX30 DS    0H                                              @D64ADOW 05792000
         C     R0,F8              IS IT DELETE FUNCTION        @D64ADOW 05793890
         BE    ESTAEX60           DELETE WITHOUT TOKEN --->    @D64ADMK 05794780
         BH    ESTAEX50           DELETE WITH TOKEN --->       @D64ADOW 05795670
         LA    R3,ESTAEXLN-1(,R1) ADDR LAST BYTE IN PAR LIST   @D64ADOW 05796560
ESTAEX32 DS    0H                                              @D65CDOW 05792000
         LRA   R8,0(,R1)          GET REAL ADDRESS OF 1ST BYTE @D65CDOW 05797450
         BC    2,ESTAEX33                                      @D65CDOW         
         BC    5,ESTERR04         INVALID ---> SUPPLY RET CODE @D65CDOW         
         ISKE  R4,R8              ... KEY OF                   @D64ADOW 05798340
         N     R4,ISKMASK         ... FIRST BYTE               @D64ADOW 05799230
         LRA   R9,0(,R1)          REAL ADDRESS ONCE MORE       @D65CDOW 05797450
         CR    R8,R9              STILL SAME                   @D65CDOW         
         BE    ESTAEX34           YES, --->                    @D65CDOW         
ESTAEX33 DS    0H                                              @D65CDOW 05792000
         CLI   0(R1),X00          REFERENCE 1ST BYTE           @D65CDOW         
         B     ESTAEX32           REPEAT CHECK                 @D65CDOW         
*                                                                               
ESTAEX34 DS    0H                                              @D65CDOW 05792000
         LRA   R8,0(,R3)          GET REAL ADDR OF LAST BYTE   @D65CDOW 05800120
         BC    2,ESTAEX35                                      @D65CDOW         
         BC    5,ESTERR04         INVALID ---> SUPPLY RET CODE @D65CDOW         
         ISKE  R6,R8              ... KEY OF                   @D65CDOW 05801010
         N     R6,ISKMASK         ... LAST BYTE                @D64ADOW 05801900
         LRA   R9,0(,R3)          REAL ADDRESS ONCE MORE       @D65CDOW 05797450
         CR    R8,R9              STILL SAME                   @D65CDOW         
         BE    ESTAEX36           YES, --->                    @D65CDOW         
ESTAEX35 DS    0H                                              @D65CDOW 05792000
         CLI   0(R3),X00          REFERENCE 1ST BYTE           @D65CDOW         
         B     ESTAEX34           REPEAT CHECK                 @D65CDOW         
*                                                                               
ESTAEX36 DS    0H                                              @D65CDOW 05792000
         CR    R4,R6                                           @D64ADOW 05802790
         BNE   ESTERR04           NE ---> CANCEL               @D64ADOW 05803680
         SRL   R6,4               SHIFT KEY TO LAST 4 BITS     @D64ADOW 05804570
         L     R4,BIT0ON          BUILD PKM                    @D64ADOW 05805460
         SRL   R4,0(R6)           ... FROM KEY                 @D64ADOW 05806350
         N     R4,SVCWORK         TEST PKM IN CR3              @D64ADOW 05807240
         BNZ   ESTAEX40           ALLOWED --->                 @D64ADOW 05808130
         TM    SVEPSWKY,XF0       CALLER IN KEY ZERO           @D64ADOW 05809020
         BNZ   ESTERR04           NO ---> CANCEL               @D64ADOW 05809910
         LTR   R6,R6              STORAGE KEY ALSO ZERO        @D64ADOW 05810800
         BNZ   ESTERR04           NO ---> CANCEL               @D64ADOW 05811690
ESTAEX40 DS    0H                 YES                          @D64ADOW 05812580
         TM    ESTAFLG1,ESTATPS   TOKEN SPECIFIED              @D64ADOW 05814000
         BNO   ESTAEX60           NO -->                       @D64ADOW 05815000
ESTAEX50 DS    0H                 YES                          @D64ADOW 05816490
         TM    SVEPSWKY,PPBIT     CALLER IN SUPERVISOR STATE   @D64ADOW 05817000
         BNO   ESTAEX60           YES, TOKEN ALLOWED           @D64ADOW 05818000
         TM    SVEPSWKY,XF0       CALLER IN KEY ZERO           @D64ADOW 05819000
         DROP  R2                                              @D64ADOW 05819500
         BZ    ESTAEX60           YES, TOKEN ALLOWED           @D64ADOW 05820000
         TM    PCBSSFLG,CICS      IS REQUESTOR CICS            @D64ADOW 05822000
         BO    ESTAEX60           YES, --->                    @D64ADOW 05823000
         TM    TCBAUTHF,TCBVEND   VENDORS ARE ALSO ALLOWED     @D64ADUL 05824000
         BO    ESTAEX60           ...  --->                    @D64ADUL 05825000
         TM    SVCWORK,X80        PKM ALLOWING KEY 0           @D64ADOW 05826990
         BNO   ESTERR07                                        @D64ADOW 05829000
ESTAEX60 DS    0H                 SELECT FUNCTION              @D64ADOW 05830990
         C     R0,F4              CHECK FUNCTION               @D64ADOW 05832000
         BH    ESTAEXDL           DELETE (8|12) --->           @D64ADMK 05833590
         BE    ESTAEXOV           DEFINE,OV (4) --->           @D64ADMK 05834180
*        BL    ESTAEXCT           DEFINE,CT (0) --->                    05834770
         DROP  R1                                              @D64ADOW 05835360
****************************************************************        05836000
*        CT PARM SPECIFIED                                     *        05837000
****************************************************************        05838000
ESTAEXCT DS    0H                                              @D64ADMK 05839000
         SLR   RE,RE              SET UP EXIT INDICATOR        @D64ADOW 05840000
ESTCT020 DS    0H                                              @D64ADMK 05841000
         L     R6,TCBATCBE        GET ADDRESS                  @D64ADOW 05841300
         LA    R4,TCBXCBNA-TCBXADR(,R6) ...OF FREE CB ANCHOR   @D64ADOW 05841600
         LA    R0,EXABLEN         LENGTH OF EXIT CONTROL BLOCK @D64ADMK 05842000
         SLR   RF,RF              SGETVIS, LOC=ANY             @D64ADOW 05843000
         TM    PCBFLAG,PCBMVSEM   IS IT MVS EMULATION MODE     @D64ADOW 05844000
         BNO   ESTCT060           NO, --->                     @D64ADOW 05845000
         LA    R4,TCBXCBEM-TCBXADR(,R6) ADDR OF FREE CB ANCHOR @D64ADOW 05845500
         LA    R0,EXABMLN         EXTENDED LENGTH OF EXIT BLOCK@D64ADOW 05846000
         LA    RF,4               SGETVIS, LOC=BELOW           @D64ADOW 05847000
ESTCT060 DS    0H                                              @D64ADOW 05848000
         ICM   R1,B'1111',0(R4)   GET FREE CB                  @D64ADOW 05849990
         BZ    ESTCT300           NOT AVAILABLE --->           @D64ADOW 05850980
         L     RF,0(,R1)          REMOVE CB FROM               @D64ADOW 05851970
         ST    RF,0(,R4)          ... FREE CHAIN               @D64ADOW 05852960
ESTCT070 DS    0H                                              @D64ADOW 05853950
         ST    R7,EXITNEXT-EXITBLK(,R1) QUEUE AB CHAIN TO JUST @D64ADMK 05855000
***                               RETRIEVED EXIT BLOCK                  05856000
         LR    R7,R1              SET UP BASE FOR NEW EXIT BLK @D64ADMK 05857000
         L     R1,SVCWORKB+8+8    RELOAD ADDR-OF-PAR-AREA/TOKEN@D64ADOW 05858490
         USING ESTX,R1                                         @D64ADOW 05858980
         L     R6,BIT0ON          KEEP                         @D64ADOW 05859470
         N     R6,TCBABEX         ... ACTIV                    @D64ADOW 05859960
         OR    R7,R6              ... INDICATOR                @D64ADOW 05860450
         ST    R7,TCBABEX         SET UP AB CHAIN              @D64ADMK 05861000
         TM    PCBFLAG,PCBMVSEM   IS IT MVS EMULATION MODE     @D64ADOW 05862000
         BNO   ESTCT080           NO, --->                     @D64ADOW 05864000
         LA    R6,EXABMSCB        ADDR OF MVS-SCB              @D64ADOW 05865490
         USING SCB,R6                                          @D65CDOW         
         L     R4,PSATOLD         GET TASKS MVS-TCB            @D64ADOW 05866000
         SLR   RF,RF                                           @D64ADOW 05867000
         ICM   RF,7,TCBSTABB-TCB(R4) GET PTR TO MVS-SCB CHAIN  @D64ADOW 05868000
         STCM  R6,7,TCBSTABB-TCB(R4) ENQUE IN MVS-STAE CHAIN   @D64ADOW 05869590
         ST    RF,SCBCHAIN        ..... AT TOP OF CHAIN        @D65CDOW 05870180
         L     RF,TCBRBP-TCB(,R4) GET RB POINTER               @D64ADOW 05871000
         ST    RF,EXABCURB        ... AND SAVE IT IN MVS-SCB   @D64ADOW 05872000
ESTCT080 DS    0H                                              @D64ADOW 05873000
         MVC   EXITADR,ESTAEXIT   ROUTINE ADDRESS              @D64ADOW 05874000
         NI    EXITADR,XFF-EXITACT ...AND RESET BIT0           @D64ADOW 05875000
***                               SAVE CROSS MEMORY DATA                05876000
         MVC   EXABPKM(4),SVCWORK  SAVE PKM AND SASN           @D64ADOW 05877990
         MVC   EXABEAX,SVCWORK+20 SAVE EAX                     @D64ADOW 05878980
         MVC   EXABPASN,SVCWORK+6 SAVE PASN                    @D64ADOW 05879970
***                                                                     05882000
         LA    RF,SVCWORKB-8      BASE FOR SVEARA              @D64ADOW 05883290
         USING SVEARA,RF                                       @D64ADOW 05883580
         MVC   EXITKEY,SVEPSW+1   SAVE KEY AT ESTAEX TIME      @D64ADMK 05884000
         MVC   EXITASCM,SVEPSW+2  SAVE ASC MODE AND PROG MASK  @D64ADOW 05885000
         NI    EXITASCM,XCF       ...                          @D64ADOW 05886000
         MVI   EXITFLG1,EXABTYPE  INDICATE AB-TYPE EXIT        @D64ADMK 05887000
         MVI   EXITFLG2,EXESTAEX  INDICATE ESTAEX              @D64ADMK 05888000
         OI    EXITFLG,EXITANY    EXIT EXECUTES IN 31 BIT MODE @D64ADMK 05889000
         MVC   EXABPRMS,ESTAPRMS  COPY USER PARAM              @D64ADOW 05890000
         L     RC,TCBATCBE        GET TCBX ADDR                @D64ADOW 05890300
         USING TCBXADR,RC                                      @D64ADOW 05890600
         SLR   R4,R4              USE AS INDICATOR             @D65CDOW         
         TM    ESTAFLG1,ESTATPS   IS TOKEN REQUIRED            @D64ADMK 05891000
         BNO   ESTCT100           NO                           @D64ADMK 05892000
         L     R4,TCBXTOKN        GIVE TASK                    @D64ADMK 05893990
         AL    R4,F1              ... A UNIQE                  @D64ADMK 05894980
         ST    R4,TCBXTOKN        .... TOKEN                   @D64ADMK 05895970
         ST    R4,EXABTOKN        SAVE TOKEN IN ESTAEX CB      @D64ADMK 05896960
         ST    R4,SVCWORKB+8+4    PASS TOKEN TO USER IN R0     @D64ADOW 05897950
ESTCT100 MVC   EXABFLG,ESTAFLG1   COPY FLAGS                   @D64ADMK 05899000
         NI    EXABFLG,EXABUBIT   ... AND RESET UNUSED BITS    @D64ADOW 05900000
         TM    PCBFLAG,PCBMVSEM   IS IT MVS EMULATION MODE     @D65CDOW 05862000
         BNO   ESTCT110           NO, --->                     @D65CDOW 05864000
         MVC   SCBEXIT,EXITADR    EXIT ADDR TO MVS-SCB         @D65CDOW         
         MVC   SCBPARMA,EXABPRMS+1 COPY PARAMETER LIST ADDR    @D65CDOW         
         MVC   SCBPCFLG,EXABFLG   COPY FLAG BYTE               @D65CDOW         
         SLR   R8,R8                                           @D65CDOW         
         IC    R8,EXITKEY         KEY OF CALLER                @D65CDOW         
         SRL   R8,4               ...                          @D65CDOW         
         STC   R8,SCBPKEY         ...                          @D65CDOW         
         MVI   SCBFLGS2,SCBPC     INDICATE PC ESTAE TYPE SCB   @D65CDOW         
         MVI   SCBFLGS1,SCBESTAE  INDICATE ESTAE-TYPE EXIT     @D65CDOW         
         TM    SVEPSW2,SVEPAM31   CALLER IN 31BIT MODE         @D65CDOW         
         BNO   ESTCT105           NO --->                      @D65CDOW         
         OI    SCBFLGS1,SCBAMODE  INDICATE CALLER IN 31BIT MODE@D65CDOW         
ESTCT105 DS    0H                                              @D65CDOW 05873000
         LTR   R4,R4              ESTAEX WITH TOKEN            @D65CDOW         
         BZ    ESTCT110           NO --->                      @D65CDOW         
         OI    SCBFLGS1,SCBTOKEN  INDICATE TOKEN DEFINED       @D65CDOW         
         DROP  R6                                              @D65CDOW         
         DROP  RF                                              @D65CDOW 05885500
ESTCT110 DS    0H                                              @D65CDOW 05873000
         MVC   EXABEXIN,TCBEXITF  SAVE CURRENT EXIT ACTIVE INDI@D64ADOW 05901000
         CLI   EXABEXIN,TCBABACT  AB-TYPE EXIT RTN ACTIVE      @D64ADOW 05902000
         BNE   ESTCT120           NO, --->                     @D64ADOW 05903000
         L     R4,PTCBAPTC        GET PSEUDO TCBX ADDR         @D64ADOW 05904990
         MVC   EXABACTV(4),PTCBEACT-TCBXADR(R4) CURRENTLY ACTIV@D64ADOW 05905980
***                               AB-TYPE EXIT (IDENTIFY NESTING LEV)   05907000
ESTCT120 DS    0H                                              @D64ADMK 05908000
         CLI   EXABEXIN,TCBPCACT  PC-TYPE EXIT RTN ACTIVE      @D64ADOW 05911000
         BNE   ESTCT140           NO, --->                     @D64ADOW 05912000
         MVC   EXABACTV,TCBPCEX   SAVE PC-TYPE EXIT CB         @D64ADOW 05913000
ESTCT140 DS    0H                                              @D64ADMK 05914000
         CLI   EXABEXIN,TCBOCACT  OC-TYPE EXIT RTN ACTIVE      @D64ADOW 05915000
         BNE   ESTCT160           NO, --->                     @D64ADOW 05916000
         MVC   EXABACTV,PCBOCPTR  SAVE OC-TYPE EXIT CB         @D64ADOW 05919000
ESTCT160 DS    0H                                              @D64ADMK 05921000
         CLI   EXABEXIN,TCBITACT  IT-TYPE EXIT RTN ACTIVE      @D64ADOW 05922000
         BNE   ESTCT180           NO, --->                     @D64ADOW 05923000
         MVC   EXABACTV,TCBXTQCA  SAVE IT-TYPE EXIT CB         @D64ADOW 05924000
ESTCT180 DS    0H                                              @D64ADMK 05925000
         NI    EXABACTV,X7F       ...ENSURE BIT0 OFF           @D64ADOW 05926000
         L     RF,SVCWORK+48      GET CURRENT LINK STACK LEVEL @D64ADOW 05927990
         L     RC,ASGEXIT         SKIP HEADER ENTRY            @DY45947 05932000
         DROP  RC                                              @DY45947 05933000
         L     RC,ACURLSTK-SGEXIT(,RC)                         @DY45947 05934000
         BASSM R8,RC                                           @DY45947 05935000
*SGLINK CCURLSTK,INPUT=(R8,RA,RC,RF),OUTPUT=(RC)                        05936490
         LR    RF,RC              COPY LINK STACK ADDR ...     @DY45947 05937000
***                               MUST BE A REAL STATUS ENTRY           05937000
         LA    R4,LSTAT           LENGTH OF A STATUS ENTRY     @D64ADOW 05929000
         SLR   RF,R4              BACK TO PREVIOUS ENTRY DESC  @D64ADOW 05930990
         L     RC,ASGEXIT         SKIP ENTRY IF HEADER AND     @D64ADOW 05932000
         L     RC,ACURLSTK-SGEXIT(,RC) ... NOT LINK STACK BEGIN@D64ADOW 05934000
         BASSM R8,RC              ...                          @D64ADOW 05935000
*SGLINK CCURLSTK,INPUT=(R8,RA,RC,RF),OUTPUT=(RC)                        05936490
         ST    RC,EXABLSTK        SAVE PREVIOUS LINKSTACK ENTRY@D64ADOW 05937000
         USING LSTKEDSC,RC                                     @D64ADOW 05938000
         TM    LSTKET,LSTKBENT    IS THIS A STATUS ENTRY       @D64ADOW 05939000
         BNO   ESTCT200           NO, --->                     @D64ADOW 05940000
         OI    LSTKET,LSTKUSPB    ENSURE SAME LINKSTACK ENTRY  @D64ADOW 05941000
***                               AT DELETION OF ESTAEX ROUTINE         05942290
         DROP  R1                                              @D64ADOW 05942580
         DROP  RC                                              @D64ADOW 05943000
ESTCT200 DS    0H                                              @D64ADMK 05944000
         B     ESTABRET(RE)       RETURN                       @D64ADMK 05949000
         SPACE 3                                                        05949060
ESTCT300 DS    0H                                              @D64ADOW 05949120
         STM   R0,RF,SVCWORKA                                  @D64ADOW 05949180
         L     R6,ADISPSER        GET                          @D64ADOW 05949240
         LA    R0,8               ... SVC-LIKE                 @D64ADOW 05949300
         BASSM R7,R6              ... STATE                    @D64ADOW 05949360
*SGLINK DISPSERV INPUT=(R0,R6,R7),WORK=(R2,R3,R4)                       05949420
         LM    R0,RF,SVCWORKA                                  @D64ADOW 05949480
         L     RC,ASGEXIT         GET GETVIS ROUTINE           @D64ADOW 05949540
         L     RC,AEXITGVI-SGEXIT(,RC) ... ADDRESS             @D64ADOW 05949600
         BASSM R8,RC              CALL GETVIS ROUTINE          @D64ADOW 05949660
*SGLINK  EXITGVIS,INPUT=(R0,R8,RA,RC,RF),OUTPUT=(R1,RF),WORK=R0         05949720
         LTR   RF,RF              STORAGE RETRIEVED            @D64ADMK 05949780
         BNZ   ESTAR14            NO, SET UP RET CODE --->     @D64ADMK 05949840
         B     ESTCT070           RETURN TO MAINLINE           @D64ADOW 05949900
         EJECT                                                          05950000
****************************************************************        05951000
*        OV PARM SPECIFIED                                     *        05952000
****************************************************************        05953000
         USING ESTX,R1                                         @D64ADOW 05953500
ESTAEXOV DS    0H                                              @D64ADMK 05954000
         TM    ESTAFLG1,ESTATPS   TOKEN SPECIFIED              @D64ADMK 05955000
         BNO   ESTOV100           NO, --->                     @D64ADMK 05956000
***                               YES, OVERWRITE WITH TOKEN             05957000
         LTR   R7,R7              ANY ESTAEX EXIT DEFINED      @D64ADMK 05958000
         BZ    ESTAR18            NO, TOKEN NOT FOUND --->     @D64ADMK 05959000
         CLI   EXITFLG2,EXESTAEX  IS THIS ESTAEX EXIT?         @D64ADMK 05960000
         BNE   ESTAR18            NO (ITS STXIT AB) --->       @D64ADMK 05961000
         OC    ESTATOKN,ESTATOKN  TOKEN VALID                  @D64ADOW 05962000
         BZ    ESTAR18            NO, --->                     @D64ADOW 05963000
ESTOV020 DS    0H                                              @D64ADMK 05964000
         CLC   ESTATOKN,EXABTOKN  TOKEN IDENTICAL?             @D64ADMK 05965000
         BE    ESTOV030           YES, --->                    @D64ADMK 05966000
         ICM   R7,15,EXITNEXT     GET NEXT EXIT BLOCK          @D64ADOW 05967000
         BNZ   ESTOV020           LOOP IF NEXT EXIT BLK EXISTS @D64ADOW 05968000
         B     ESTAR18            TOKEN NOT FOUND              @D64ADOW 05969000
ESTOV030 DS    0H                 OVERWRITE ONLY WITH SAME RB  @D64ADMK 05970000
         ICM   R2,B'1111',PSATOLD GET MVS TCB                  @D64ADOW 05971000
         BZ    ESTOV040           NOT EMULATION MODE --->      @D64ADOW 05972000
         L     R2,TCBRBP-TCB(,R2) GET CURRENT RB POINTER       @D64ADOW 05973000
         CLM   R2,B'0111',EXABCURBA EXIT FOR RB OF CURRENT USER@D65CDOW 05974000
         BNE   ESTAR18            NO, RETURN CODE --->         @D64ADOW 05975000
ESTOV040 DS    0H                 OVERWRITE ONLY WITH SAME RB  @D64ADMK 05976000
         LR    R6,R7              COPY EXIT BLOCK ADDR         @D64ADMK 05977490
***                               CONTAINING TOKEN                      05978000
         LA    R4,TCBABEX         GET ANCHOR OF EXIT BLOCKS    @D64ADOW 05979000
***                               TO BE OVERWRITTEN                     05980000
         L     R7,TCBABEX         GET FIRST EXIT BLOCK         @D64ADOW 05981000
         LA    R7,0(,R7)          ...                          @D64ADOW 05982000
ESTOV050 DS    0H                                              @D64ADMK 05983000
         ICM   RC,B'1111',PSATOLD EMULATION MODE               @D64ADOW 05984000
         BZ    ESTOV070           NO --->                      @D64ADOW 05985000
ESTOV060 DS    0H                                              @D64ADMK 05986000
         SLR   R2,R2                                           @D64ADOW 05987000
         ICM   R2,B'0111',TCBSTABB-TCB(RC) GET CURRENT SCB PTR @D64ADOW 05988000
         LA    R8,EXABMSCB        SCB ADDR OF ESTAEX           @D64ADOW 05989000
         CR    R8,R2              ESTAEX FIRST IN SCB CHAIN    @D64ADOW 05990000
         BE    ESTOV070           YES --->                     @D64ADOW 05991000
***                               NO, DEACTIVATE FESTAE                 05992000
         L     R8,SCBCHAIN-SCB(,R2) GET NEXT IN CHAIN          @D64ADOW 05993000
         XC    SCBCHAIN-SCB(8,R2),SCBCHAIN-SCB(R2) DEACTIVATE  @D64ADOW 05994000
***                               AND DEQUEUE MVS-SCB                   05995000
         STCM  R8,7,TCBSTABB-TCB(RC) ENQUEUE ON TOP OF CHAIN   @D64ADOW 05996000
         B     ESTOV060                                        @D64ADOW 05997000
ESTOV070 DS    0H                                              @D64ADOW 05998000
         CR    R7,R6              NEXT ESTAEX EXIT TO BE DELETE@D64ADOW 05999490
         BE    ESTOV140           NO,                          @D64ADOW 06000000
         TM    EXITADR,EXITACT    IS EXIT CURRENTLY ACTIV      @D64ADOW 06001000
         BNO   ESTOV080           NO, --->                     @D64ADOW 06002000
         XC    EXITADR,EXITADR    INDICATE ESTAEX DELETED      @D64ADOW 06003000
         XC    EXABTOKN,EXABTOKN  ...                          @D64ADOW 06004000
         OI    EXITADR,EXITACT    ...                          @D64ADOW 06005000
ESTOV080 DS    0H                                              @D64ADMK 06006000
         L     RC,ASGEXIT         EXIT CONTROL BLOCK           @D64ADOW 06007590
         L     RC,ARESUSPB-SGEXIT(,RC) ... TO FREE CHAIN       @D64ADOW 06008180
         BASSM R8,RC              ...  AND RESET USP-BIT       @D64ADOW 06009000
*SGLINK RESUSPB,INPUT=(R4,R7,R8,RA,RC),OUTPUT=(R7)                      06010000
         LTR   R7,R7              FREEVIS PERFORMED            @D64ADOW 06011000
         BZ    ESTOV090                                        @D64ADOW 06012000
         LA    R4,EXITNEXT        NEXT CHAINING ADDR           @D64ADOW 06013000
ESTOV090 DS    0H                                              @D64ADMK 06014000
         L     R7,0(,R4)          GET NEXT EXIT BLOCK ADDR     @D64ADOW 06015000
         B     ESTOV050           NO, DELETE NEXT              @D64ADOW 06016000
         SPACE                                                          06017000
ESTOV100 DS    0H                 OVERWRITE WITHOUT TOKEN      @D64ADMK 06018000
         LA    RE,4+0             FORCE RETC 4, REASON CODE 0  @D64ADOW 06019490
         LTR   R7,R7              ANY ESTAEX EXIT DEFINED      @D64ADMK 06020000
         BZ    ESTCT020           NO, PERFORM CT ---->         @D64ADMK 06021000
         CLI   EXITFLG2,EXESTAEX  IS THIS ESTAEX EXIT?         @D64ADMK 06022000
         BNE   ESTCT020           NO, PERFORM CT --->          @D64ADMK 06023000
         OC    EXABTOKN,EXABTOKN  DOES EXIT BLK CONTAIN TOKEN? @D64ADMK 06024000
         BNZ   ESTAR18            RETURN WITH ERROR            @D64ADMK 06025000
         TM    PCBFLAG,PCBMVSEM   MVS EMULATION                @D64ADOW 06028000
         BNO   ESTOV120           NO SKIP RB CHECKING          @D64ADOW 06030000
         LA    RE,4+12            FORCE RETC 4, REASON CODE 12 @D64ADOW 06031490
         L     R2,PSATOLD         GET MVS TCB                  @D64ADOW 06032000
         LA    R3,EXABMSCB        GET MVS SCB ADDR             @D64ADOW 06033000
         CLM   R3,7,TCBSTABB-TCB(R2) WAS LAST EXIT BLOCK OUR   @D64ADOW 06034000
         BNE   ESTCT020           NO, PERFORM CT --->          @D64ADOW 06035000
         LA    RE,4+4             FORCE RETC 4, REASON CODE 4  @D64ADOW 06036490
         L     R2,TCBRBP-TCB(,R2) GET CURRENT RB POINTER       @D64ADOW 06037000
         CLM   R2,B'0111',EXABCURBA DOES EXIT BELONG TO USER-RB@D65CDOW 05974000
         BNE   ESTCT020           NO, PERFORM CT --->          @D64ADOW 06039000
ESTOV120 DS    0H                                              @D64ADMK 06040000
         LA    RE,4+8             FORCE RETC 4, REASON CODE 8  @D64ADOW 06041990
         L     RF,SVCWORK+48      GET CURRENT LS ENTRY ADDR    @DY45947 06042980
         L     RC,ASGEXIT         SKIP HEADER ENTRY            @DY45947         
         L     RC,ACURLSTK-SGEXIT(,RC)                         @DY45947         
         BASSM R8,RC                                           @DY45947         
*SGLINK CCURLSTK,INPUT=(R8,RA,RC,RF),OUTPUT=(RC)                                
         LR    R4,RC              COPY LINK STACK ADDR ...     @DY45947         
***                               MUST BE A REAL STATUS ENTRY                   
         LA    R2,LSTAT           BACK TO PREVIOUS             @D64ADOW 06044000
         SLR   R4,R2              ... ENTRY                    @D64ADOW 06045000
         L     R3,EXABLSTK        LINK STACK LEVEL AT EXIT DEF @D64ADOW 06046000
         L     R2,ASGEXIT         GET CHECK-CORRECT-LINKAGE-   @D64ADOW 06047000
         L     R2,ACORLSTK-SGEXIT(,R2) ... STACK RTN ADDRESS   @D64ADOW 06048000
         BASSM R8,R2              CHECK SAME LINK STACK LEVEL  @D64ADOW 06049000
*SGLINK CCORLSTK,INPUT=(R2,R3,R4,R8,RA)                                 06050000
         B     ESTCT020           NOT EQUAL PERFORM CT         @D64ADOW 06051000
*        B     ESTOV140                                        @D64ADOW 06052000
*END OF BRANCH TABLE                                                    06053000
***                                                                     06054000
ESTOV140 DS    0H                 COMMON WITH/WITHOUT TOKEN    @D64ADMK 06055000
         L     RC,BIT0ON          PASS EXIT ADDR TO CB         @D64ADOW 06056000
         N     RC,EXITADR         ... KEEP ACTIV INDICATOR     @D64ADOW 06057000
         O     RC,ESTAEXIT        ...                          @D64ADOW 06058000
         ST    RC,EXITADR         ...                          @D64ADOW 06059000
         LA    R2,SVCWORKB-8      BASE FOR SVEARA              @D64ADOW 06060190
         USING SVEARA,R2                                       @D64ADOW 06060380
         MVC   EXITKEY,SVEPSW+1   SAVE KEY AT ESTAEX TIME      @D64ADMK 06060570
         MVC   EXITASCM,SVEPSW+2  SAVE ASC MODE AND PROG MASK  @D64ADOW 06061000
         NI    EXITASCM,XCF       ...                          @D64ADOW 06062000
         MVC   EXABPRMS,ESTAPRMS  COPY USER PARAMETER LIST ADDR@D64ADMK 06063000
         MVC   EXABFLG,ESTAFLG1   COPY FLAGS                   @D64ADMK 06064000
         NI    EXABFLG,EXABUBIT   ... AND RESET UNUSED BITS    @D64ADOW 06065000
         TM    PCBFLAG,PCBMVSEM   IS IT MVS EMULATION MODE     @D65CDOW 05862000
         BNO   ESTOV160           NO, --->                     @D65CDOW 05864000
         LA    RF,EXABMSCB        ADDR OF MVS-SCB              @D65CDOW         
         USING SCB,RF                                          @D65CDOW         
         MVC   SCBEXIT,EXITADR    COPY EXIT ADDR               @D65CDOW         
         NI    SCBEXIT,X7F        ...AND RESET ACTIVE INDICATOR@D65CDOW         
         MVC   SCBPARMA,EXABPRMS+1 COPY PARAMETER LIST ADDR    @D65CDOW         
         MVC   SCBPCFLG,EXABFLG   COPY FLAG BYTE               @D65CDOW         
         SLR   R8,R8                                           @D65CDOW         
         IC    R8,EXITKEY         KEY OF CALLER                @D65CDOW         
         SRL   R8,4               ...                          @D65CDOW         
         STC   R8,SCBPKEY         ...                          @D65CDOW         
         MVI   SCBFLGS2,SCBPC     INDICATE PC ESTAE TYPE SCB   @D65CDOW         
         NI    SCBFLGS1,XFF-SCBAMODE KEEP ALL BUT MODE BIT     @D65CDOW         
         TM    SVEPSW2,SVEPAM31   CALLER IN 31BIT MODE         @D65CDOW         
         BNO   ESTOV150           NO --->                      @D65CDOW         
         OI    SCBFLGS1,SCBAMODE  INDICATE CALLER IN 31BIT MODE@D65CDOW         
ESTOV150 DS    0H                                              @D65CDOW 05873000
         DROP  R2                                              @D65CDOW         
         DROP  RF                                              @D65CDOW 05885500
ESTOV160 DS    0H                 COMMON WITH/WITHOUT TOKEN    @D65CDOW 06055000
         B     ESTARTOK           RETURN                       @D64ADMK 06066000
         DROP  R1                                              @D64ADOW 06067490
         EJECT                                                          06068000
****************************************************************        06069000
*        ESTAEX DEL FUNCTION                                   *        06070000
****************************************************************        06071000
         USING ESTX,R1                                         @D64ADOW 06071500
ESTAEXDL DS    0H                                              @D64ADMK 06072000
         LTR   R7,R7              ANY AB-TYPE EXIT DEFINED     @D64ADMK 06075000
         BZ    ESTAR0C            NO, --->                     @D64ADMK 06076000
         CLI   EXITFLG2,EXESTAEX  IS THIS ESTAEX EXIT?         @D64ADMK 06077000
         BNE   ESTAR0C            NO, --->                     @D64ADMK 06078000
         L     R3,PSATOLD         ADDR OF MVS-TCB              @D64ADOW 06079000
         C     R0,F8              TOKEN SPECIFIED              @D64ADMK 06080000
         BH    ESTDL020           YES, --->                    @D64ADOW 06081990
         OC    EXABTOKN,EXABTOKN  DOES EXIT BLK CONTAIN TOKEN? @D64ADMK 06083000
         BNZ   ESTAR0C            YES, ERROR EXIT              @D64ADMK 06084000
         TM    PCBFLAG,PCBMVSEM   EMULATION MODE               @D64ADOW 06085490
         BNO   ESTDL060                                        @D64ADOW 06086000
         LA    R4,EXABMSCB        GET ADDR OF RELATED MVS-SCB  @D64ADOW 06087000
         CLM   R4,7,TCBSTABB-TCB(R3) OUR EXIT FIRST IN CHAIN   @D64ADOW 06088000
         BE    ESTDL060           YES, --->                    @D64ADOW 06089000
         B     ESTAR0C            NO RETURN WITH RETC          @D64ADOW 06090000
ESTDL020 DS    0H                                              @D64ADMK 06091000
         C     R1,EXABTOKN        TOKEN IDENTICAL?             @D64ADOW 06092000
         DROP  R1                                              @D64ADOW 06092500
         BE    ESTDL060           YES, --->                    @D64ADMK 06093000
         ICM   R7,15,EXITNEXT     GO TO NEXT EXIT BLOCK        @D64ADOW 06094000
         BNZ   ESTDL020           LOOP IF EXIT BLOCK EXISTS    @D64ADOW 06095000
         B     ESTAR0C                                         @D64ADMK 06096000
ESTDL060 DS    0H                 DELETION ONLY WITH SAME RB   @D64ADMK 06097000
         TM    PCBFLAG,PCBMVSEM   EMULATION MODE               @D64ADOW 06098490
         BNO   ESTDL080                                        @D64ADOW 06099000
         L     R4,TCBRBP-TCB(,R3) GET CURRENT RB POINTER       @D64ADOW 06100000
         CLM   R4,B'0111',EXABCURBA DOES EXIT BELONG TO USER-RB@D65CDOW 05974000
         BNE   ESTAR0C            NO,                          @D64ADOW 06102000
ESTDL080 DS    0H                 DELETION ONLY ON SAME LINK   @D64ADMK 06103000
***                               STACK LEVEL                           06104000
         L     RF,SVCWORK+48      GET CURRENT LS ENTRY ADDR    @DY45947 06105490
         L     RC,ASGEXIT         SKIP HEADER ENTRY            @DY45947         
         L     RC,ACURLSTK-SGEXIT(,RC)                         @DY45947         
         BASSM R8,RC                                           @DY45947         
*SGLINK CCURLSTK,INPUT=(R8,RA,RC,RF),OUTPUT=(RC)                                
         LR    R4,RC              COPY LINK STACK ADDR ...     @DY45947         
***                               MUST BE A REAL STATUS ENTRY                   
         LA    R2,LSTAT           BACK TO PREVIOUS LS          @D64ADOW 06106000
         SLR   R4,R2              ... ENTRY                    @D64ADOW 06107000
         L     R3,EXABLSTK        LINK STACK LEVEL AT EXIT DEF @D64ADOW 06108000
         L     R2,ASGEXIT         GET CHECK-CORRECT-LINKAGE-   @D64ADOW 06109000
         L     R2,ACORLSTK-SGEXIT(,R2) ... STACK RTN ADDRESS   @D64ADOW 06110000
         BASSM R8,R2              CHECK SAME LINK STACK LEVEL  @D64ADOW 06111000
*SGLINK CCORLSTK,INPUT=(R2,R3,R4,R8,RA)                                 06112000
         B     ESTAR24            NOT EQUAL RETURN WITH RETC   @D64ADOW 06113000
*        B     *+4                                             @D64ADOW 06114000
***                                                                     06115000
         L     R6,EXITNEXT        GET ADDR OF SUCCESSOR BLOCK  @D64ADOW 06116490
***                               ... NOT TO BE DELETED                 06117000
         LA    R4,TCBABEX         GET ANCHOR TO EXIT BLOCKS    @D64ADOW 06118000
ESTDL100 DS    0H                                              @D64ADMK 06119000
         L     R7,0(,R4)          NEXT ESTAEX TO BE DELETED    @D64ADOW 06120000
         TM    EXITADR,EXITACT    IS EXIT CURRENTLY ACTIV      @D64ADOW 06121000
         BNO   ESTDL120           NO, --->                     @D64ADOW 06122000
         XC    EXITADR,EXITADR    INDICATE ESTAEX DELETED      @D64ADOW 06123000
         XC    EXABTOKN,EXABTOKN  ...                          @D64ADOW 06124000
         OI    EXITADR,EXITACT    ...                          @D64ADOW 06125000
ESTDL120 DS    0H                                              @D64ADMK 06126000
         L     RC,ASGEXIT                                      @D64ADOW 06127690
         L     RC,ARESUSPB-SGEXIT(,RC)                         @D64ADOW 06128380
         BASSM R8,RC                                           @D64ADOW 06129070
*SGLINK RESUSPB,INPUT=(R4,R7,R8,RA,RC),OUTPUT=(R7)                      06130000
         LTR   R7,R7              EXIT BLOCK FREED             @D64ADOW 06132000
         BZ    ESTDL140           YES, --->                    @D64ADOW 06133000
         LA    R4,EXITNEXT        NEXT CHAINING ADDR           @D64ADOW 06134000
ESTDL140 DS    0H                                              @D64ADMK 06135000
         L     R7,0(,R4)          NEXT ALSO TO BE DELETED      @D64ADOW 06136000
         LA    R7,0(,R7)          ...                          @D64ADOW 06137000
         CR    R7,R6              ...                          @D64ADOW 06138490
         BNE   ESTDL100           NO, DELETE NEXT EXIT         @D64ADOW 06139000
         B     ESTARTOK           YES, RETURN                  @D64ADMK 06140000
***                                                            @D64ADOW 06141000
         DROP  R5                                              @D64ADOW 06142490
         SPACE 3                                                        06143000
****************************************************************        06144000
*        ERROR EXITS  -  RETURN CODES                          *        06145000
****************************************************************        06146000
ESTAR30  DS    0H                                              @D64ADMK 06147000
         LA    RF,ESTARC30        ESTAEX REJECTED, FRR EXISTS  @D64ADOW 06148000
         B     ESTARET1                                        @D64ADOW 06149000
***                                                                     06150000
ESTAR28  DS    0H                                              @D64ADMK 06151000
         LA    RF,ESTARC28        CALLER IS DISABLED           @D64ADOW 06152000
         B     ESTARET1                                        @D64ADOW 06153000
***                                                                     06154000
ESTAR24  DS    0H                                              @D64ADMK 06155000
         LA    RF,ESTARC24        ESTAEX DEL REJECTED          @D64ADOW 06156000
         B     ESTARET1                                        @D64ADOW 06157000
***                                                                     06158000
ESTAR1C  DS    0H                                              @D64ADMK 06159000
         LA    RF,ESTARC1C        ESTAEX REJECTED, CALLER IN   @D64ADOW 06160000
         B     ESTARET1           AR-MODE AND ALET NE 0        @D64ADOW 06161000
***                                                                     06162000
ESTAR18  DS    0H                                              @D64ADMK 06163000
         LA    RF,ESTARC18        ESTAEX REJECTED, OV SPECIFIED@D64ADOW 06164000
         B     ESTARET1           WITHOUT TOKEN BUT EXIT-BLOCK @D64ADOW 06165000
***                               CONTAINS TOKEN OR OV WITH TOKEN BUT   06166000
***                               ESTAEX NOT OWNED BY CURRENT RB        06167000
ESTAR14  DS    0H                                              @D64ADMK 06168000
         LA    RF,ESTARC14        ESTAEX REJECTED, NO SPACE AVA@D64ADOW 06169000
         B     ESTARET1                                        @D64ADOW 06170000
***                                                                     06171000
ESTAR0C  DS    0H                                              @D64ADMK 06172000
         LA    RF,ESTARC0C        ESTAEX DEL REJ, NO RTN EXIST @D64ADOW 06173000
         B     ESTARET1                                        @D64ADOW 06174000
***                                                                     06175000
ESTAR08  DS    0H                                              @D64ADMK 06176000
         LA    RF,ESTARC08        INVALID ESTAEX REQUEST       @D64ADOW 06177000
         B     ESTARET1                                        @D64ADOW 06178000
***                                                                     06179000
ESTABRET B     ESTARTOK           RETURN WITH 0 IN REG 15      @D64ADOW 06180000
         B     ESTAR040           RET WITH 4 IN R15 AND 0 IN R0@D64ADOW 06181000
         B     ESTAR044           RET WITH 4 IN R15 AND 4 IN R0@D64ADOW 06182000
         B     ESTAR048           RET WITH 4 IN R15 AND 8 IN R0@D64ADOW 06183000
*        B     ESTAR04C           RET WITH 4 IN R15 AND C IN R0@D64ADOW 06184000
ESTAR04C DS    0H                                              @D64ADMK 06185000
         LA    R5,12                                           @D64ADOW 06186000
         B     ESTAR04                                         @D64ADOW 06187000
ESTAR048 DS    0H                                              @D64ADMK 06188000
         LA    R5,8                                            @D64ADOW 06189000
         B     ESTAR04                                         @D64ADOW 06190000
ESTAR044 DS    0H                                              @D64ADMK 06191000
         LA    R5,4                                            @D64ADOW 06192000
         B     ESTAR04                                         @D64ADOW 06193000
ESTAR040 DS    0H                                              @D64ADMK 06194000
         SLR   R5,R5              SUBREASON CODE 0             @D64ADOW 06195000
ESTAR04  DS    0H                                              @D64ADMK 06196000
         LA    RF,ESTARC04                                     @D64ADOW 06197000
         ST    R5,SVCWORKB+8+4    SAVE SUBREASON CODE IN R0    @D64ADOW 06198490
         B     ESTARET1                                        @D64ADOW 06199000
***                                                                     06200000
ESTARTOK DS    0H                                              @D64ADMK 06201000
         SLR   RF,RF              FCT SUCCESSFULLY EXECUTED    @D64ADOW 06202000
ESTARET1 DS    0H                                              @D64ADMK 06203000
         ST    RF,SVCWORKB+8+0    SETUP RETURN CODE IN R15     @D64ADOW 06204390
         CLI   RID+1,USERTID      PROCESSING PARALLEL          @D64ADOW 06204780
         BE    ESTARET5           YES--->                      @D64ADOW 06205170
         MVC   ERARF(12),SVCWORKB+8 COPY REG 15-1              @D64ADOW 06205560
         L     R6,ADISPSER        DISPATCHER SERVICE RTN'S     @D64ADOW 06206000
         LA    R0,12              RETURN SVC-LIKE STATE        @D64ADOW 06207000
         SLR   R1,R1              ... NO ADDITIONAL FUNCTIONS  @D64ADOW 06208000
         BASSM R7,R6              ... AND ISSUE PR             @D64ADOW 06209000
***                                                                     06209200
ESTARET5 DS    0H                                              @D64ADOW 06209400
         LM    RF,R1,SVCWORKB+8   LOAD RETURN INFO (R15-R1)    @D64ADOW 06209600
         PR                       RETURN TO PC ISSUER          @D64ADOW 06209800
*                                                                       06210000
ESTARC04 EQU   X'04'              OV NOT POSSIBLE              @D64ADOW 06211000
ESTARC08 EQU   X'08'              ESTAEX REQ INVALID (E.G. FCT @D64ADOW 06212000
***                               CODE INVALID)                         06213000
ESTARC0C EQU   X'0C'              NO RECOVERY RTN EXISTS,      @D64ADOW 06214000
***                               RTN NOT OWNED BY CALLER, MOST RECENT  06215000
***                               REC RTN NOT ESTAEX, MOST RECENT       06216000
***                               ESTAEX WAS WITH TOKEN BUT TOKEN NOT   06217000
***                               SPECIFIED, TOKEN DOES NOT MATCH       06218000
ESTARC14 EQU   X'14'              NO SGETVIS AVAIL FOR EXIT-BLK@D64ADOW 06219000
ESTARC18 EQU   X'18'              NO TOKEN SPECIFIED BUT REQ'D @D64ADOW 06220000
ESTARC1C EQU   X'1C'              INP PARAM LIST NOT ACCESSABLE@D64ADOW 06221000
ESTARC24 EQU   X'24'              NO REC RTN ACTIVE FOR CURRENT@D64ADOW 06222000
***                               LINKAGE STACK LEVEL                   06223000
ESTARC28 EQU   X'28'              CALLER IS DISABLED           @D64ADOW 06224000
ESTARC2C EQU   X'2C'              CALLER IS LOCKED             @D64ADOW 06225000
ESTARC30 EQU   X'30'              FRR DEFINED AT THE MOMENT    @D64ADOW 06226000
****************************************************************        06227000
*        ERROR EXITS  -  TERMINATION CONDITIONS                *        06228000
****************************************************************        06229000
ESTERR08 DS    0H                 ESTAE ENVIRONMENT SUSPENDED  @D65CDOW 06230000
         L     R1,ESTCOD70        GET ADDITIONAL ERROR INFO    @D65CDOW 06232000
         B     ESTERROR           CANCEL WITH ERR47            @D65CDOW 06233000
         SPACE                                                          06234000
ESTERR07 DS    0H                 CALLER NOT IN SUPERVISOR     @D64ADOW 06230000
***                               STATE OR PKM DOES NOT ALLOW KEY 0     06231000
         L     R1,ESTCOD35        GET ADDITIONAL ERROR INFO    @D64ADOW 06232000
         B     ESTERROR           CANCEL WITH ERR47            @D64ADOW 06233000
         SPACE                                                          06234000
ESTERR06 DS    0H                 ETXR OR POST EXIT ACTIVE     @D64ADOW 06235000
         L     R1,ESTCOD36        INDICATE ETXR EXIT           @D64ADOW 06236000
         TM    TCBEXITF,TCBPOACT  POST EXIT ACTIVE             @D64ADOW 06237000
         BZ    ESTERROR           NO, ITS ETXR --->            @D64ADOW 06238000
         L     R1,ESTCOD37        INDICATE POST EXIT           @D64ADOW 06239000
         B     ESTERROR           CANCEL WITH ERR47            @D64ADOW 06240000
         SPACE                                                          06241000
ESTERR04 DS    0H                 INVALID PAR AREA ADDR        @D64ADOW 06242000
         L     R1,ESTCOD38        GET ADDITIONAL ERROR INFO    @D64ADOW 06243000
         B     ESTERROR           CANCEL WITH ERR47            @D64ADOW 06244000
         SPACE                                                          06245000
ESTERR03 DS    0H                 ESTAEX NOT ALLOWED WHILE     @D64ADOW 06246000
***                               TERMINATION/CLEAN-UP-SERVICES ACTIVE  06247000
         L     R1,ESTCOD32        GET ADDITIONAL ERROR INFO    @D64ADOW 06248000
         B     ESTERROR           CANCEL WITH ERR47            @D64ADOW 06249000
         SPACE                                                          06250000
ESTERR02 DS    0H                 ESTAEX NOT ALLOWED IF RID =8@D64ADOW 06250200
         L     R1,ESTCOD31        GET ADDITIONAL ERROR INFO    @D64ADOW 06250400
         B     ESTERROR           CANCEL WITH ERR47            @D64ADOW 06250600
         SPACE                                                          06250800
ESTERR01 DS    0H                 ESTAEX NOT ALLOWED WHILE     @D64ADOW 06251000
***                               VENDOR EXIT ACTIV                     06252000
         L     R1,ESTCOD30        GET ADDITIONAL ERROR INFO    @D64ADOW 06253000
*        B     ESTERROR           CANCEL WITH ERR47            @D64ADOW 06254000
         SPACE                                                          06255000
ESTERROR DS    0H                                              @D64ADOW 06256080
         CLI   RID+1,USERTID      ALREADY SVC-LIKE STATE       @D64ADOW 06256160
         BNE   ESTER010           NO --->                      @D64ADOW 06256240
         STM   R0,RF,SVCWORKA                                  @D64ADOW 06256320
         L     R6,ADISPSER        GET                          @D64ADOW 06256400
         LA    R0,8               ... SVC-LIKE                 @D64ADOW 06256480
         BASSM R7,R6              ... STATE                    @D64ADOW 06256560
*SGLINK DISPSERV INPUT=(R0,R6,R7),WORK=(R2,R3,R4)                       06256640
         LM    R0,RF,SVCWORKA                                  @D64ADOW 06256720
ESTER010 DS    0H                                              @D64ADOW 06256800
         L     RC,ASGEXIT         GET COMMON CANCEL EXIT       @D64ADOW 06257000
         L     RC,ACOMEREX-SGEXIT(,RC) ... ADDRESS             @D64ADOW 06258000
         BSM   0,RC               CANCEL WITH ERR47            @D64ADOW 06259000
         SPACE                                                          06260000
ESTCOD30 DC    A(NUCRSN30)        ESTAEX REJECTED BECAUSE      @D64ADOW 06261000
*                                 ... A VENDOR EXIT ROUTINE ACTIVE      06262000
ESTCOD31 DC    A(NUCRSN31)        ESTAEX REJECTED BECAUSE      @D64ADOW 06262300
*                                 ... RID NE USERTID                    06262600
ESTCOD32 DC    A(NUCRSN32)        ESTAEX REJECTED BECAUSE      @D64ADOW 06263000
*                                 ... TERMINATOR/CLEAN-UP ACTIVE        06264000
ESTCOD35 DC    A(NUCRSN35)        ESTAEX TERMINATED. CALLER NOT@D64ADOW 06265000
*                                 ... IN SUPERVISOR STATE OR            06266000
*                                 ... PKM DOES NOT ALLOW KEY 0          06267000
ESTCOD36 DC    A(NUCRSN36)        ESTAEX TERMINATED. ETXR EXIT @D64ADOW 06268000
*                                 ... ACTIVE                            06269000
ESTCOD37 DC    A(NUCRSN37)        ESTAEX TERMINATED. POST EXIT @D64ADOW 06270000
*                                 ... ACTIVE                            06271000
ESTCOD38 DC    A(NUCRSN38)        ESTAEX TERMINATED. PARAMETER @D64ADOW 06272000
*                                 ... AREA ADDR INVALID                 06273000
ESTCOD70 DC    A(NUCRSN70)        ESTAEX TERMINATED. ESTAE-    @D65CDOW 06272000
*                                 ... ENVIRONMENT SUSPENDED BY LE       06273000
         SPACE                                                          06274000
ESTX2000 DC    A(8192)            MASK TO CHECK INV ADDR       @D65CDOW         
         DROP  R7                                              @D64ADOW 06280000
         DROP  RA                                              @D64ADOW 06281000
         DROP  RD                                              @D64ADOW 06283000
         EJECT                                                          06284000
****************************************************************        06285000
*                                                              *        06286000
*        ESPIE PROCESSING                                      *        06287000
*        INPUT:  R1  INPUT PARAMETER LIST                      *        06288000
*                R10 TCB POINTER                               *        06289000
*                R13 BASE REGISTER                             *        06290000
*        OUTPUT:                                               *        06291000
*        WORK:                                                 *        06292000
*                                                              *        06293000
****************************************************************        06294000
         USING TCBADR,RA                                       @D64ADOW 06295000
         USING FAMRECOV,RD                                     @D64ADMK 06296000
FAMRECOV DS    0H                                              @D64ADMK 06297000
         L     RB,TCBSAVE         GET USER SAVE AREA           @D64ADMK 06298000
         USING SVEARA,RB                                       @D64ADMK 06299000
         LR    R6,R1              COPY FAM PARAMETER LIST      @D64ADOW 06300000
         USING FMXIT_PARMS,R6                                  @D64ADMK 06301000
***                                                                     06302000
ESPIEBEG DS    0H                                              @D64ADMK 06303000
         L     R8,TIBPTR          GET TIB POINTER              @D64ADOW 06304000
         TM    TIBFLAG1-TIBADR(R8),EOTINPR+TERMACT             @D64ADOW 06305000
***                               TERMINATOR OR CLEAN-UP IN PROCESS     06306000
         BNZ   ESPIER11           YES, CANCEL                  @D64ADOW 06307000
         TM    TCBFLAG6,TCBPSTAC  VENDOR EXIT ACTIVE           @D64ADMK 06308000
         BO    ESPIER09           YES, CANCEL REQUESTOR        @D64ADMK 06309000
         TM    TCBABEX,EXITACT    AB-TYPE EXIT ACTIVE          @D64ADOW 06310000
         BO    ESPIER05           YES, ESPIE NOT ALLOWED       @D64ADOW 06311000
         ICM   R7,15,TCBPCEX      TCB ESPIE EXIT BLOCK ADDRESS @D64ADMK 06312000
         BZ    ESPIEB10           ZERO, REQUEST ALLOWED        @D64ADOW 06313000
         USING EXITBLK,R7                                      @D64ADMK 06314000
         OC    EXITADR,EXITADR    ANY PC/ESPIE EXIT DEFINED    @DY45712 00125000
         BZ    ESPIEB10           NO, --->                     @DY45712 00126000
         CLI   EXITFLG2,EXVSEPC   VSE STXIT PC DEFINED         @D64ADOW 06315000
         BE    ESPIER01           YES, ESPIE NOT ALLOWED       @D64ADOW 06316000
ESPIEB10 DS    0H                                              @D64ADMK 06317000
         TM    FMXIT_OPER,FMXIT_DEL IS IST RESET FUNCTION      @D64ADMK 06318000
         BO    ESPIEDEL           YES, CONTINUE RESET          @D64ADMK 06319000
         TM    FMXIT_OPER,FMXIT_TEST IS IT TEST FUNCTION       @D64ADOW 06320000
         BO    ESPIETST           YES, GOTO PROCESS TEST FCT   @D64ADMK 06321000
***                               NO, PROCESS ADD FUNCTION              06322000
****************************************************************        06323000
*        ESPIE SET FUNCTION                                    *        06324000
****************************************************************        06325000
ESPIESET DS    0H                                              @D64ADMK 06326000
         LTR   R3,R7              SAVE CURRENT PC-EXIT BLOCK   @D64ADMK 06327000
         BZ    ESPIES10           ZERO --->                    @D64ADOW 06328000
         CLI   TCBEXITF,X00       ANY IT|OC|PC|ETXR|POST EXIT  @D64ADOW 06329000
         BNE   ESPIER06           ... ACTIVE, CANCEL IF YES    @D64ADOW 06330000
ESPIES10 DS    0H                                              @D64ADMK 06331000
         L     R4,FMXIT_PROGINT   CHECK VALID PROG MASK        @D64ADOW 06332000
         LA    R0,EPIEEND-EPIE    LENGTH OF EPIE               @D64ADOW 06333000
         LA    RF,8               FCT CODE : LOC=ANY           @D64ADOW 06334000
***                                          SPACE=PARTKEY              06335000
         TM    TCBEXFLG,TCBEXAM   CALLER IN 31 BIT MODE        @D64ADOW 06336000
         BO    ESPIES20           YES, --->                    @D64ADOW 06337000
         LA    RF,12              FCT CODE : LOC=BELOW         @D64ADOW 06338000
***                                          SPACE=PARTKEY              06339000
ESPIES20 DS    0H                                              @D64ADOW 06340000
         L     RC,ASGEXIT         GET GETVIS ROUTINE           @D64ADOW 06341000
         L     RC,AEXITGVI-SGEXIT(,RC) ... ADDRESS             @D64ADOW 06342000
         BASSM R8,RC              RETRIEVE STORAGE FOR EPIE    @D64ADMK 06343000
*SGLINK  EXITGVIS,INPUT=(R0,R8,RA,RC,RF),OUTPUT=(R1,RF),WORK=R0         06344000
         L     RC,TCBATCBE        RESTORE TCBX ADDR            @D64ADOW 06345000
         LTR   RF,RF              STORAGE AVAILABLE            @D64ADMK 06346000
         BNZ   ESPIER02           SPACE EXHAUSTED              @D64ADMK 06347000
         LR    R4,R1              COPY THE EPIE ADDR           @D64ADOW 06348000
         LA    R0,EXESLEN         LENGTH OF ESPIE EXIT BLOCK   @D64ADMK 06349000
         SLR   RF,RF              SGETVIS, LOC=ANY             @D64ADOW 06350000
         L     RC,ASGEXIT         GET GETVIS ROUTINE           @D64ADOW 06351000
         L     RC,AEXITGVI-SGEXIT(,RC) ... ADDRESS             @D64ADOW 06352000
         BASSM R8,RC              RETRIEVE STORAGE FOR EXIT BLK@D64ADMK 06353000
*SGLINK  EXITGVIS,INPUT=(R0,R8,RA,RC,RF),OUTPUT=(R1,RF),WORK=R0         06354000
         L     RC,TCBATCBE        RESTORE TCBX ADDR            @D64ADOW 06355000
         LTR   RF,RF              STORAGE AVAILABLE            @D64ADMK 06356000
         BNZ   ESPIER03           SPACE EXHAUSTED              @D64ADMK 06357000
         ST    R1,TCBPCEX         NEW FIRST IN ESPIE CHAIN     @D64ADMK 06358000
         LR    R7,R1              EXIT BLOCK TO CORRECT REG    @D64ADMK 06359000
         ST    R4,EXITSAV         SAVE EPIE ADDR               @D64ADOW 06360000
         ST    R3,EXITNEXT        STORE PTR TO NEXT            @D64ADMK 06361000
         MVC   EXITADR,FMXIT_EXITADDR ROUTINE ADDRESS          @D64ADMK 06362000
         NI    EXITADR,XFF-EXITACT RESET ACTIVE INDICATOR      @D64ADOW 06363000
         MVC   EXITKEY,SVEPSW+1   SAVE KEY AT STXIT TIME       @D64ADMK 06364000
         MVC   EXITASCM,SVEPSW+2  SAVE ASC MODE AND PROG MASK  @D64ADOW 06365000
         NI    EXITASCM,XCF       ...                          @D64ADOW 06366000
         MVI   EXITFLG1,EXPCTYPE  INDICATE PC-TYPE EXIT        @D64ADMK 06367000
         MVI   EXITFLG2,EXESPIE   INDICATE ESPIE EXIT BLOCK    @D64ADMK 06368000
         ICM   R4,B'1111',PSATOLD GET MVS TCB                  @D64ADOW 06369000
         BZ    ESPIES30           NOT EMULATION MODE --->      @D64ADOW 06370000
         MVC   EXESCURB,TCBRBP-TCB(R4) SAVE CURRENT RB PTR     @D64ADOW 06371000
ESPIES30 DS    0H                                              @D64ADOW 06372000
         LH    R4,ESPITOKN        BUILD TOKEN                  @D64ADOW 06373000
         BCTR  R4,0               ...                          @D64ADOW 06374000
         STH   R4,ESPITOKN        ...                          @D64ADOW 06375000
         ICM   R4,12,TID          ...                          @D64ADOW 06376000
         ST    R4,EXESTOKN        SAVE THE TOKEN               @D64ADOW 06377000
         TM    TCBEXFLG,TCBEXAM   CALLER IN 31 BIT MODE        @D64ADOW 06378000
         BZ    ESPIES40           NO, --->                     @D64ADOW 06379000
         OI    EXITFLG,EXITANY    31 BIT MODE ESPIE EXIT       @D64ADMK 06380000
ESPIES40 DS    0H                                              @D64ADMK 06381000
         MVC   EXESPARM,FMXIT_PARAM COPY USER PARAM            @D64ADMK 06382000
         MVC   EXESMASK,FMXIT_PROGINT PROG CHECK INT TYPES MASK@D64ADMK 06383000
         IC    R4,SVEPSW+2        EXTRACT CALLERS PROG MASK    @D64ADOW 06384000
         N     R4,ESPIPMSK        ... AND RESET OTHER BITS     @D64ADOW 06385000
         STC   R4,EXESPMSK        ... AND SAVE IT IN EXIT BLOCK@D64ADOW 06386000
         TM    EXESMASK+1,ESPIFXPO WATCHING FIXED-POINT        @D64ADOW 06387000
***                              OVERFLOW EXCEPTION                     06388000
         BNO   ESPIES60          NO, SKIP PSW UPDATE           @D64ADOW 06389000
         OI    SVEPSW+2,X08      SET CORRESPONDING PROG MASK BI@D64ADOW 06390000
ESPIES60 DS    0H                                              @D64ADMK 06391000
         TM    EXESMASK+1,ESPIDCOV WATCHING DECIMAL OVERFLOW EX@D64ADOW 06392000
         BNO   ESPIES61          NO, SKIP PSW UPDATE           @D64ADOW 06393000
         OI    SVEPSW+2,X04      SET CORRESPONDING PROG MASK BI@D64ADOW 06394000
ESPIES61 DS    0H                                              @D64ADMK 06395000
         TM    EXESMASK+1,ESPIEPUF WATCHING EXPONENT UNDERFLOW @D64ADOW 06396000
         BNO   ESPIES62           NO, SKIP PSW UPDATE          @D64ADOW 06397000
         OI    SVEPSW+2,X02       SET CORRESPONDING PROG MASK  @D64ADOW 06398000
ESPIES62 DS    0H                                              @D64ADMK 06399000
         TM    EXESMASK+1,ESPISIGE WATCHING SIGNIFICANCE EXCEPT@D64ADOW 06400000
         BNO   ESPIES63           NO, SKIP PSW UPDATE          @D64ADOW 06401000
         OI    SVEPSW+2,X01       SET CORRESPONDING PROG MASK  @D64ADOW 06402000
ESPIES63 DS    0H                                              @D64ADMK 06403000
         SLR   R4,R4              PREPARE TOKEN                @D64ADMK 06404000
         ICM   R7,15,EXITNEXT     GET NEXT ESPIE EXIT BLK      @D64ADMK 06405000
         BZ    ESPIES80           NOT AVILABLE --->            @D64ADOW 06406000
         L     R4,EXESTOKN        GET TOKEN OF PREDECESSOR     @D64ADOW 06407000
ESPIES80 DS    0H                                              @D64ADMK 06408000
         ST    R4,FMXIT_TOKEN     PASS TOKEN TO CALLER         @D64ADOW 06409000
         SLR   RF,RF              PREPARE RETURN CODE          @D64ADMK 06410000
         B     ESPIERET           RETURN                       @D64ADMK 06411000
         EJECT                                                          06412000
****************************************************************        06413000
*        ESPIE RESET FUNCTION                                  *        06414000
****************************************************************        06415000
ESPIEDEL DS    0H                                              @D64ADMK 06416000
         LA    RE,TCBPCEX         ADDR OF ANCHOR TO ESPIE CHAIN@D64ADOW 06417000
         LTR   R7,R7              ENTRY ADDED?                 @D64ADMK 06418000
         BZ    ESPIER07           NO ESPIE EXIT DEFINED        @D64ADMK 06419000
         L     R5,FMXIT_TOKEN     GET TOKEN ADDRESS            @D64ADMK 06420000
         ICM   R5,15,0(R5)        DELETE ALL ESPIE EXITS ?     @D64ADMK 06421000
         BZ    ESPIED10           YES, DON'T CHECK FOR TOKEN   @D64ADMK 06422000
         ICM   R8,15,EXITNEXT     GET PTR TO NEXT ESPIE CB     @D64ADOW 06423000
         BZ    ESPIER10           NOT AVAIL. TOKEN IS INCORRECT@D64ADOW 06424000
         C     R5,EXESTOKN-EXITBLK(,R8) TOKEN CORRECT?         @D64ADMK 06425000
         BNE   ESPIER08           NO, DON'T DELETE             @D64ADMK 06426000
ESPIED10 DS    0H                                              @D64ADMK 06427000
         TM    EXITADR,EXITACT    IS EXIT CURRENTLY ACTIV      @D64ADOW 06428000
         BNO   ESPIED30           NO, DELET EXIT CB            @D64ADOW 06429000
         XC    EXITADR,EXITADR    INDICATE ESPIE DELETED       @D64ADOW 06430000
         OI    EXITADR,EXITACT    ...                          @D64ADOW 06431000
         LA    RE,EXITNEXT        ANCHOR FOR REST OF CHAIN     @D64ADOW 06432000
         B     ESPIED60                                        @D64ADOW 06433000
ESPIED20 DS    0H                                              @D64ADMK 06434000
         ICM   R7,15,0(RE)        ANY OTHER ESPIE DEFINED      @D64ADMK 06435000
         BZ    ESPIED70           NO, --->                     @D64ADMK 06436000
ESPIED30 DS    0H                                              @D64ADMK 06437000
         TM    EXITFLG,EXITGETV   IS THIS A PREALLOCATED CNTRL-@D66ODOW         
***                               ...BLOCK (USED ONLY FOR PC-EXIT)              
         BNO   ESPIED70           YES, ---> NOTHING TODO       @D66ODOW         
         IC    R4,EXESPMSK        GET PROG MASK OF ESPIE ISSUER@D64ADOW 06438000
         NI    SVEPSW+2,XF0       RESET CURRENT PROG MASK      @D64ADOW 06439000
         IC    R1,SVEPSW+2        GET WHOLE BYTE 2 FROM PSW    @D64ADOW 06440000
         OR    R1,R4              REESTABLISH PREVIOUS PROG MSK@D64ADOW 06441000
         STC   R1,SVEPSW+2        .....                        @D64ADOW 06442000
         MVC   0(4,RE),EXITNEXT   DEQUE CURRENT ESPIE EXIT-BLK @D64ADOW 06443000
         LA    R0,EPIEEND-EPIE    LENGTH OF EPIE               @D64ADOW 06444000
         L     R1,EXITSAV         EPIE ADDR                    @D64ADOW 06445000
         LA    RF,20              SETUP FUNCTION CODE FREEMAIN @D64XDOW 06446000
         L     RC,ASGEXIT         GET BASE OF                  @D64XDOW 06447000
         L     RC,AEXITGVI-SGEXIT(,RC) ... SUBROUTINE          @D64XDOW 06448000
         BASSM R8,RC              FREE SPACE                   @D64XDOW 06449000
*SGLINK  EXITFVIS,INPUT=(R0,R1,R8,RA,RC,RF),OUTPUT=RF,WORK=R0           06450000
         SPACE                                                          06451000
         LH    R0,EXITLENG        LENGTH OF ELEMENT FOR FREEVIS@D64ADMK 06452000
*** FREEVIS FOR ESPIE CONTROL BLOCK                                     06453000
*        SFREEVIS ADDRESS=(7),LENGTH=(0)                                06454000
         SFREEVIS ADDRESS=(7),LENGTH=(0)                       @D64ADMK 06455000
***END OF SFREEVIS MACRO                                                06456000
         SPACE                                                          06457000
ESPIED60 DS    0H                                              @D64ADMK 06458000
         LTR   R5,R5              DELETE ALL SPECIFIED         @D64ADOW 06459000
         BZ    ESPIED20           YES, DELETE NEXT EXIT        @D64ADMK 06460000
ESPIED70 DS    0H                                              @D64ADMK 06461000
         SLR   R4,R4              PREPARE TOKEN                @D64ADMK 06462000
         ICM   R7,15,TCBPCEX      GET TOP OF EXIT BLOCKS       @D64ADMK 06463000
         BZ    ESPIED90           NOT AVAILABLE --->           @D64ADOW 06464000
         BP    ESPIED80           NOT ACTIVE, TAKE IT          @D64ADOW 06465000
***                               EXIT JUST DELETED IS CURRENTLY ACTIVE 06466000
         ICM   R7,15,EXITNEXT     GET NEXT ESPI-EXIT           @D64ADOW 06467000
         BZ    ESPIED90           NOT AVAILABLE --->           @D64ADOW 06468000
ESPIED80 DS    0H                                              @D64ADMK 06469000
         L     R4,EXESTOKN        GET TOKEN OF PREDECESSOR     @D64ADOW 06470000
ESPIED90 DS    0H                                              @D64ADMK 06471000
         ST    R4,FMXIT_TOKEN     PASS TOKEN TO CALLER         @D64ADOW 06472000
         SLR   RF,RF              PREPARE RC                   @D64ADMK 06473000
         B     ESPIERET           RETURN                       @D64ADMK 06474000
         EJECT                                                          06475000
****************************************************************        06476000
*        ESPIE TEST FUNCTION                                   *        06477000
****************************************************************        06478000
ESPIETST DS    0H                                              @D64ADOW 06479000
         L     RE,FMXIT_PARAM     GET USERS PARAMETER LIST ADDR@D64ADOW 06480000
         LTR   R7,R7              ANY ESPIE ACTIVE             @D64ADOW 06481000
         BZ    ESPIET90           NO --- EXIT WITH RC 8        @D64ADOW 06482000
         MVC   0(4,RE),EXITADR    GET ADDR OF EXIT ROUTINE     @D64ADOW 06483000
         NI    0(RE),X7F          RESET ACTIVE FLAG            @D64ADOW 06484000
         TM    EXITFLG,EXITANY    ESPIE EXIT EXECUTING IN 31-BM@D64ADOW 06485000
         BNO   ESPIET30           NO, --->                     @D64ADOW 06486000
         OI    0(RE),X80          INDICATE 31 BIT MODE         @D64ADMK 06487000
***                               IN 31 BIT MODE                        06488000
ESPIET30 DS    0H                                              @D64ADOW 06489000
         MVC   4(4,RE),EXESPARM   ADDR OF USER-PARAMETER-LIST  @D64ADOW 06490000
         MVC   8(4,RE),EXESMASK   MASK OF PROG INTERRUPTION    @D64ADOW 06491000
***                               TYPES                                 06492000
         SLR   RF,RF              SUCCESSFUL                   @D64ADMK 06493000
         ST    RF,12(RE)          CLEAR RESERVED FIELD         @D64ADMK 06494000
         B     ESPIERET           RETURN                       @D64ADMK 06495000
ESPIET90 LA    RF,8               NO ENTRY                     @D64ADMK 06496000
         B     ESPIERET           RETURN                       @D64ADMK 06497000
***                                                                     06498000
ESPIERET DS    0H                                              @D64ADMK 06499000
         L     R6,DISPAD          RELOAD DISPATCHER ADDR       @D64ADOW 06500000
         L     R9,ASGMVSAP        GET BASE OF CALLER           @D64ADOW 06501000
         USING SGMVSAPI,R9                                     @D64ADOW 06502000
         B     SGMAPIEX           RETURN                       @D64ADMK 06503000
         DROP  R6                                              @D64ADMK 06504000
         DROP  R7                                              @D64ADMK 06505000
         DROP  R9                                              @D64ADOW 06506000
         DROP  RA                                              @D64ADMK 06507000
         SPACE 3                                                        06508000
****************************************************************        06509000
*        ERROR EXITS                                           *        06510000
****************************************************************        06511000
ESPIER11 DS    0H                 ESPIE NOT ALLOWED WHILE      @D64ADOW 06512000
***                               TERMINATOR/CLEAN-UP IN PROCESS        06513000
         LA    R1,D2C5R416        GET ADDITIONAL ERROR INFO    @D64ADOW 06514000
         B     ESPERROR                                        @D64ADOW 06515000
         SPACE                                                          06516000
ESPIER10 DS    0H                 TOKEN INCORRECT BECAUSE NO   @D64ADOW 06517000
***                               ESPIE EXIT DEFINED                    06518000
         LA    R1,D46DR014        GET ADDITIONAL ERROR INFO    @D64ADOW 06519000
         B     ESPERROR                                        @D64ADOW 06520000
         SPACE                                                          06521000
ESPIER09 DS    0H                 ESPIE NOT ALLOWED WHILE      @D64ADOW 06522000
***                               VENDOR EXIT ACTIVE                    06523000
         LA    R1,D2C5R415        GET ADDITIONAL ERROR INFO    @D64ADOW 06524000
         B     ESPERROR                                        @D64ADOW 06525000
         SPACE                                                          06526000
ESPIER08 DS    0H                 'ESPIE RESET' WITH VALID TOKN@D64ADOW 06527000
***                               BUT FIRST ESPIE IN CHAIN DOES NOT     06528000
***                               CONTAIN THIS TOKEN                    06529000
         LA    R1,D46DR010        GET ADDITIONAL ERROR INFO    @D64ADOW 06530000
         B     ESPERROR                                        @D64ADOW 06531000
         SPACE                                                          06532000
ESPIER07 DS    0H                 'ESPIE RESET' BUT NO ESPIE   @D64ADOW 06533000
***                               EXIT DEFINED                          06534000
         LA    R1,D2C5R417        GET ADDITIONAL ERROR INFO    @D64ADOW 06535000
         B     ESPERROR                                        @D64ADOW 06536000
         SPACE                                                          06537000
ESPIER06 DS    0H                 'ESPIE SET' NOT ALLOWED WHEN @D64ADOW 06538000
***                               ANY PC|OC|IT EXIT ACTIVE              06539000
         LA    R1,D2C5R414        GET ADDITIONAL ERROR INFO    @D64ADOW 06540000
         B     ESPERROR                                        @D64ADOW 06541000
         SPACE                                                          06542000
ESPIER05 DS    0H                 ESPIE NOT ALLOWED IN AB-EXIT @D64ADOW 06543000
         LA    R1,D2C5R412        GET ADDITIONAL ERROR INFO    @D64ADOW 06544000
         B     ESPERROR                                        @D64ADOW 06545000
         SPACE                                                          06546000
ESPIER03 DS    0H                 NO SGETVIS AVAILABLE         @D64ADOW 06547000
***                               TO CREATE AN EXIT BLOCK      @D64ADOW 06548000
         ST    RF,SVER0F          PASS GETVIS RET CODE         @D64ADOW 06549000
         LA    R0,EPIEEND-EPIE    LENGTH OF EPIE               @D64ADOW 06550000
         LR    R1,R4              EPIE ADDR TO CORRECT REGISTER@D64XDOW 06551000
         LA    RF,20              SETUP FUNCTION CODE FREEMAIN @D64XDOW 06552000
         L     RC,ASGEXIT         GET BASE OF                  @D64XDOW 06553000
         L     RC,AEXITGVI-SGEXIT(,RC) ... SUBROUTINE          @D64XDOW 06554000
         BASSM R8,RC              FREE SPACE                   @D64XDOW 06555000
*SGLINK  EXITFVIS,INPUT=(R0,R1,R8,RA,RC,RF),OUTPUT=RF,WORK=R0           06556000
         SPACE                                                          06557000
         LA    R1,D2C5R410        GET ADDITIONAL ERROR INFO    @D64ADOW 06558000
         B     ESPERROR                                        @D64ADOW 06559000
         SPACE                                                          06560000
ESPIER02 DS    0H                 NO SPACE-GETVIS AVAILABLE    @D64ADOW 06561000
***                               TO CREATE AN EPIE            @D64ADOW 06562000
         ST    RF,SVER0F          PASS GETVIS RET CODE         @D64ADOW 06563000
         LA    R1,D2C5R411        GET ADDITIONAL ERROR INFO    @D64ADOW 06564000
         B     ESPERROR                                        @D64ADOW 06565000
         SPACE                                                          06566000
ESPIER01 DS    0H                 ESPIE NOT ALLOWED WHEN       @D64ADOW 06567000
***                               ALREADY STXIT PC ISSUED               06568000
         LA    R1,D2C5R413        GET ADDITIONAL ERROR INFO    @D64ADOW 06569000
*        B     ESPERROR                                        @D64ADOW 06570000
         SPACE                                                          06571000
ESPERROR DS    0H                 NO SPACE-GETVIS AVAILABLE    @D64ADOW 06572000
         LM    R2,R3,CESPIE       MACRO NAME                   @D64ADOW 06573000
         SLR   R6,R6              NO SUBREASON CODE            @D64ADOW 06574000
         L     RC,ASGEXIT         GET COMMON CANCEL EXIT       @D64ADOW 06575000
         L     RC,ACOMER48-SGEXIT(,RC) ... ADDRESS             @D64ADOW 06576000
         BSM   0,RC               CANCEL WITH ERR48            @D64ADOW 06577000
         DROP  RB                                              @D64ADMK 06578000
         SPACE 3                                                        06579000
ESPITOKN DC    H'0'               TOKEN                        @D64ADMK 06580000
         DS    0F                 ALIGN TO FULLWORD            @D64ADOW 06581000
ESPIPMSK DC    X'0000000F'        PRESERV PROG MASK OF PSW     @D64ADOW 06582000
CESPIE   DC    CL8'ESPIE   '                                   @D64ADOW 06583000
         SPACE 3                                                        06584000
ESPIFXPO EQU   X'80'              FIXED-POINT OVERFLOW EXCEPTIO@D64ADOW 06585000
ESPIDCOV EQU   X'20'              DECIMAL OVERFLOW EXCEPTION   @D64ADOW 06586000
ESPIEPUF EQU   X'04'              EXPONENT UNDERFLOW EXCEPTION @D64ADOW 06587000
ESPISIGE EQU   X'02'              SIGNIFICANCE EXCEPTION       @D64ADOW 06588000
         DROP  RD                                              @D64ADMK 06589000
         EJECT                                                 @D64ADMK 06590000
****************************************************************        06591000
*        SETFRR PROCESSING                                     *        06592000
*            BRANCH TABLE TO EXECUTE THE VARIOUS FUNCTIONS     *        06593000
****************************************************************        06594000
IEAVTSFR DS    0F                                              @D64ADMK 06595000
***      FUNCTION CODES IF CALLER IN PRIMARY MODE                       06596000
         DC    A(FRR2C5R4)        0  - NOT SUPPORTED           @D64ADOW 06597490
         DC    A(FRRADD1)         4  - ADD NEW FRR             @D64ADOW 06598000
         DC    A(FRR2C5R4)        8  - NOT SUPPORTED           @D64ADOW 06599490
         DC    A(FRRADD2)         12 - ADD NEW FRR             @D64ADOW 06600000
         DC    A(FRR2C5R4)        16 - NOT SUPPORTED           @D64ADOW 06601490
         DC    A(FRRADD3)         20 - ADD NEW FRR             @D64ADOW 06602000
         DC    A(FRR2C5R4)        24 - NOT SUPPORTED           @D64ADOW 06603790
         DC    A(FRR2C5R4)        28 - NOT SUPPORTED           @D64ADOW 06604580
         DC    A(FRR2C5R4)        32 - NOT SUPPORTED           @D64ADOW 06605370
         DC    A(FRR2C5R4)        36 - NOT SUPPORTED           @D64ADOW 06606160
         DC    A(FRR2C5R4)        40 - NOT SUPPORTED           @D64ADOW 06606950
         DC    A(FRR2C5R4)        44 - NOT SUPPORTED           @D64ADOW 06607740
         DC    A(FRR2C5R4)        48 - NOT SUPPORTED           @D64ADOW 06608530
         DC    A(FRR2C5R4)        52 - NOT SUPPORTED           @D64ADOW 06609320
         DC    A(FRRDEL1)         56 - DELETE NEWEST FRR       @D64ADOW 06611000
         DC    A(FRR2C5R4)        60 - NOT SUPPORTED           @D64ADOW 06612690
         DC    A(FRR2C5R4)        64 - NOT SUPPORTED           @D64ADOW 06613380
         DC    A(FRR2C5R4)        68 - NOT SUPPORTED           @D64ADOW 06614070
***      FUNCTION CODES IF CALLER IN ACCESS REGISTER MODE               06615000
         DC    A(FRR2C5R4)        72 - NOT SUPPORTED           @D64ADOW 06616790
         DC    A(FRR2C5R4)        76 - NOT SUPPORTED           @D64ADOW 06617580
         DC    A(FRR2C5R4)        80 - NOT SUPPORTED           @D64ADOW 06618370
         DC    A(FRR2C5R4)        84 - NOT SUPPORTED           @D64ADOW 06619160
         DC    A(FRR2C5R4)        88 - NOT SUPPORTED           @D64ADOW 06619950
         DC    A(FRRADD4)         92 - ADD NEW FRR             @D64ADOW 06621000
         DC    A(FRR2C5R4)        96 - NOT SUPPORTED           @D64ADOW 06622790
         DC    A(FRR2C5R4)       100 - NOT SUPPORTED           @D64ADOW 06623580
         DC    A(FRR2C5R4)       104 - NOT SUPPORTED           @D64ADOW 06624370
         DC    A(FRR2C5R4)       108 - NOT SUPPORTED           @D64ADOW 06625160
         DC    A(FRR2C5R4)       112 - NOT SUPPORTED           @D64ADOW 06625950
         DC    A(FRR2C5R4)       116 - NOT SUPPORTED           @D64ADOW 06626740
         DC    A(FRR2C5R4)       120 - NOT SUPPORTED           @D64ADOW 06627530
         DC    A(FRR2C5R4)       124 - NOT SUPPORTED           @D64ADOW 06628320
         DC    A(FRRDEL2)        128 - DELETE NEWEST FRR       @D64ADOW 06630000
         DC    A(FRR2C5R4)       132 - NOT SUPPORTED           @D64ADOW 06631690
         DC    A(FRR2C5R4)       136 - NOT SUPPORTED           @D64ADOW 06632380
         DC    A(FRR2C5R4)       140 - NOT SUPPORTED           @D64ADOW 06633070
****************************************************************        06634000
*        SAVE AREA ADDRESSED THROUGH PSACSTK                   *        06635000
****************************************************************        06636000
         SPACE                                                          06637000
FRRBASE  DS    0F                 COMMON BASE POINT            @D64ADOW 06638000
         SPACE                                                          06639000
****************************************************************        06822000
*        DELETE NEWEST FRR ROUTINE                             *        06823000
*              CALLER IN:   AR MODE                            *        06824490
*                           ENABLED/DISABLED DEPENDENT ON      *        06825000
*                           ...LOCK STATUS AND/OR IF           *        06826000
*                           ...FRR WITH EUT=YES DEFINED        *        06827000
*                           SUPERVISOR STATE                   *        06828000
*        INPUT R0 - FRR ADDRESS                                *        06829000
*              R1 - CURRENT STACK PTR                          *        06830000
*              R2 - PARAMETERS CHOSEN                          *        06831000
*              RE - RETURN ADDRESS                             *        06832000
*              RF - ENTRY POINT AND BASE ADDRESS               *        06833000
****************************************************************        06834000
         USING FRRDEL2,RF                                      @D64ADMK 06834030
FRRDEL2  DS    0H                                              @D64ADOW 06834060
         STNSM FRRAD099+1,DISABLE DISABLE CALLER               @D64ADOW 06834090
FRRPCKD2 DS    0H                                              @D64ADOW 06834120
         STM   R0,RF,ERA          SAVE ALL REGISTERS           @D64ADOW 06834150
         L     RF,AFRRBASE        GET COMMON BASE ADDR         @D64ADMK 06834180
         USING FRRBASE,RF                                      @D64ADMK 06834210
         SR    R3,R3                                           @D64ADOW 06834240
         IAC   R3                 GET CALLERS ASC MODE         @D64ADOW 06834270
         C     R3,FRRF512         CALLER IN AR MODE            @D64ADOW 06834300
         BNE   FRR2C5RB           NO ---> CANCEL               @D64ADOW 06834330
         SAC   0                  ENTER PRIMARY ASC MODE       @D64ADOW 06834360
         B     FRRDEL10                                        @D64ADOW 06834390
         SPACE 3                                               @D64ADOW 06834420
****************************************************************        06834450
*        DELETE NEWEST FRR ROUTINE                             *        06834480
*              CALLER IN:   PRIMARY ASC MODE                   *        06834510
*                           ENABLED/DISABLED DEPENDENT ON      *        06834540
*                           ...LOCK STATUS AND/OR IF           *        06834570
*                           ...FRR WITH EUT=YES DEFINED        *        06834600
*                           SUPERVISOR STATE                   *        06834630
*        INPUT R0 - FRR ADDRESS                                *        06834660
*              R1 - CURRENT STACK PTR                          *        06834690
*              R2 - PARAMETERS CHOSEN                          *        06834720
*              RE - RETURN ADDRESS                             *        06834750
*              RF - ENTRY POINT AND BASE ADDRESS               *        06834780
****************************************************************        06834810
         USING FRRDEL1,RF                                      @D64ADMK 06835000
FRRDEL1  DS    0H                                              @D64ADOW 06836000
         STNSM FRRAD099+1,DISABLE DISABLE CALLER               @D64ADOW 06837490
FRRPCKD1 DS    0H                                              @D64ADOW 06838000
         STM   R0,RF,ERA          SAVE ALL REGISTERS           @D64ADOW 06839000
         L     RF,AFRRBASE        GET COMMON BASE ADDR         @D64ADMK 06840000
         USING FRRBASE,RF                                      @D64ADMK 06841000
         SR    R3,R3                                           @D64ADOW 06842000
         IAC   R3                 GET CALLERS ASC MODE         @D64ADOW 06843000
         C     R3,F0              CALLER IN PRIMARY ASC MODE   @D64ADOW 06844000
         BNE   FRR2C5RA           NO ---> CANCEL               @D64ADOW 06845000
FRRDEL10 DS    0H                                              @D64ADOW 06846000
         L     R8,FRRDEA20        GET CONTINUATION ADDR        @D64ADOW 06847000
         LA    RE,0(,RE)          CLEAR FIRST BYTE/BIT         @D64ADOW 06848000
         BSM   RE,R8              SET BIT0 ACCORDING AMODE     @D64ADOW 06849000
FRRDEL20 DS    0H                 ... AND ENTER 31 BIT MODE    @D64ADOW 06850000
         ICM   R6,B'1111',PSACLHS ANY LOCKS HELD               @D64ADOW 06851000
         BNZ   FRRDEL40           YES, REQ ALLOWED--->         @D64ADOW 06852000
         TM    FRRAD099+1,X03     IS CALLER DISABLED           @D64ADOW 06853490
         BZ    FRRDEL40           YES, REQ ALLOWED--->         @D64ADOW 06854000
         TM    PSAMFLGS,X80       ANY FRR WITH EUT=YES SPECIFIE@D64ADOW 06855000
         BNO   FRR07DR4           NO, NO LEGAL STATE --> CANCEL@D64ADOW 06856000
FRRDEL40 DS    0H                                              @D64ADOW 06857000
         L     R8,TIBPTR                                       @D64ADOW 06858000
         USING TIBADR,R8                                       @D64ADOW 06859000
         TM    TIBFLAG1,TERMACT+EOTINPR TERMINATOR OR DUMP ACTI@D64ADOW 06860000
         BNZ   FRR2C5R6           YES, ---> CANCEL             @D64ADOW 06861000
         DROP  R8                                              @D64ADOW 06862000
*        DEBUG ALLREGS,XXDBGMC    THE FRR WILL BE REALLY DELETED        06862300
         DEBUG ALLREGS,XXDBGMC                                 @DY44889 06862600
         L     RA,TCBPTR          GET CURRENT TCB POINTER      @D64ADOW 06863000
         USING TCBADR,RA                                       @D64ADOW 06864000
         USING FRRS,R1                                         @D64ADOW 06865000
         LA    R5,FRRSESZE+FRRSEXSZ LENGTH OF FRR ENTRY + EXTEN@D64ADOW 06866000
         L     R8,FRRSCURR        GET CURRENT STACK ENTRY      @D64ADOW 06867000
         SLR   R8,R5              GOTO PREVIOUS ENTRY          @D64ADOW 06868000
         ST    R8,FRRSCURR        NEW 1ST FRR                  @D64ADOW 06869000
         C     R8,FRRSEMP         FRR CHAIN EMPTY              @D64ADOW 06870000
         BNE   FRRDEL60           NO, --->                     @D64ADOW 06871000
         L     R8,TCBATCBE        GET TCBX ADDR                @D64ADOW 06872000
         USING TCBXADR,R8                                      @D64ADOW 06873000
         NI    TCBXFLG1,XFF-TCBXFRRA INDICATE NO FRR DEFINED   @D64ADOW 06874000
         DROP  R8                                              @D64ADOW 06875000
         L     R8,TIBPTR          GET CURRENT TIB              @D64ADOW 06876000
         L     RC,ASGEXIT         GET BASE OF                  @D64ADOW 06877000
         L     RC,ACHKDLAY-SGEXIT(,RC) ... SUBROUTINE          @D64ADOW 06878000
         LR    R5,RF              SAVE BASE ADDR               @D64ADOW 06879000
         LR    R9,RE              SAVE RETURN ADDR             @D64ADOW 06880000
         LA    RF,1               GET FUNCTION CODE            @D64ADOW 06881000
         BASSM RE,RC              POST DELAYED IT/OC EXITS     @D64ADOW 06882000
*SGLINK  CHKDELAY,INPUT=(R8,RC,RE,RF),WORK=(R4)                         06883000
         LR    RF,R5              RESTORE BASE                 @D64ADOW 06884000
         LR    RE,R9              RESTORE RETURN ADDR          @D64ADOW 06885000
         B     FRRDEL80                                        @D64ADOW 06886000
FRRDEL60 DS    0H                                              @D64ADOW 06887000
         USING FRRSENTR,R8                                     @D64ADOW 06888000
         TM    FRRSFLG4,FRRSEUT   FRR WITH EUT=YES             @D64ADOW 06889000
         BO    FRRAD090           YES, KEEP EUT FLAG IN PSA    @D64ADOW 06890000
         DROP  R8                                              @D64ADMK 06891000
FRRDEL80 DS    0H                                              @D64ADOW 06892000
         NI    PSAMFLGS,X7F       SET OFF EUT IND IN LOWCORE   @DY44889 06892500
         NI    TCBEXITH,XFF-TCBEUTIN RESET EUT INDICATOR       @D65CDOW 06893000
         AL    RE,F8              UPDATE RETURN ADDRESS TO     @D64ADOW 06894000
***                               REMOVE EUT FLAG IN PSA                06895000
         B     FRRAD090           RETURN TO CALLER             @D64ADMK 06896000
         DROP  R1                                              @D64ADMK 06897000
         DROP  RA                                              @D64ADMK 06898000
         DROP  RF                                              @D64ADMK 06899000
         SPACE 3                                               @D64ADOW 06927000
****************************************************************        06928000
*        ADD NEW FRR ROUTINE                                   *        06928005
*              CALLER IN :   SUPERVISOR STATE                  *        06928010
*                            ENABLED/DISABLED                  *        06928015
*                            PRIMARY ASC MODE                  *        06928020
*        INPUT R0 - FRR ADDRESS                                *        06928025
*              R1 - CURRENT STACK PTR                          *        06928030
*              R2 - PARAMETERS CHOSEN                          *        06928035
*              RE - RETURN ADDRESS                             *        06928040
*              RF - ENTRY POINT AND BASE ADDRESS               *        06928045
****************************************************************        06928050
         USING FRRADD2,RF                                      @D64ADMK 06928055
FRRADD2  DS    0H                                              @D64ADOW 06928060
         STNSM FRRAD099+1,DISABLE DISABLE CALLER               @D64ADOW 06928065
FRRPCKA2 DS    0H                                              @D64ADOW 06928070
         STM   R0,RF,ERA          SAVE ALL REGISTERS           @D64ADOW 06928075
         L     RF,AFRRBASE        GET COMMON BASE ADDR         @D64ADMK 06928080
         USING FRRBASE,RF                                      @D64ADMK 06928085
         LR    R9,R2                                           @D64ADOW 06928090
         N     R9,FRRUSFC2        CLEAR SUPPORTED FCT FLAGS    @D64ADOW 06928095
         BNZ   FRR2C5R4A          CANCEL IF ANY UNSUPPORTED    @D64ADOW 06928100
***                               ... FUNCTION FLAG ON                  06928105
         B     FRRAD010           GO TO MAINLINE               @D64ADOW 06928110
         DROP  RF                                              @D64ADMK 06928115
         SPACE 3                                               @D64ADOW 06928120
****************************************************************        06928125
*        ADD NEW FRR ROUTINE                                   *        06928130
*              CALLER IN :   SUPERVISOR STATE                  *        06928135
*                            ENABLED/DISABLED                  *        06928140
*                            PRIMARY ASC MODE                  *        06928145
*        INPUT R0 - FRR ADDRESS                                *        06928150
*              R1 - CURRENT STACK PTR                          *        06928155
*              R2 - PARAMETERS CHOSEN                          *        06928160
*              RE - RETURN ADDRESS                             *        06928165
*              RF - ENTRY POINT AND BASE ADDRESS               *        06928170
****************************************************************        06928175
         USING FRRADD3,RF                                      @D64ADMK 06928180
FRRADD3  DS    0H                                              @D64ADOW 06928185
         STNSM FRRAD099+1,DISABLE DISABLE CALLER               @D64ADOW 06928190
FRRPCKA3 DS    0H                                              @D64ADOW 06928195
         STM   R0,RF,ERA          SAVE ALL REGISTERS           @D64ADOW 06928200
         L     RF,AFRRBASE        GET COMMON BASE ADDR         @D64ADMK 06928205
         USING FRRBASE,RF                                      @D64ADMK 06928210
         LR    R9,R2                                           @D64ADOW 06928215
         N     R9,FRRUSFC3        CLEAR SUPPORTED FCT FLAGS    @D64ADOW 06928220
         BNZ   FRR2C5R4A          CANCEL IF ANY UNSUPPORTED    @D64ADOW 06928225
***                               ... FUNCTION FLAG ON                  06928230
         B     FRRAD010           GO TO MAINLINE               @D64ADOW 06928235
         DROP  RF                                              @D64ADMK 06928240
         SPACE 3                                               @D64ADOW 06928245
****************************************************************        06928250
*        ADD NEW FRR ROUTINE                                   *        06928255
*              CALLER IN :   SUPERVISOR STATE                  *        06928260
*                            ENABLED/DISABLED                  *        06928265
*                            AR-MODE                           *        06928270
*        INPUT R0 - FRR ADDRESS                                *        06928275
*              R1 - CURRENT STACK PTR                          *        06928280
*              R2 - PARAMETERS CHOSEN                          *        06928285
*              RE - RETURN ADDRESS                             *        06928290
*              RF - ENTRY POINT AND BASE ADDRESS               *        06928295
****************************************************************        06928300
         USING FRRADD4,RF                                      @D64ADMK 06928305
FRRADD4  DS    0H                                              @D64ADOW 06928310
         STNSM FRRAD099+1,DISABLE DISABLE CALLER               @D64ADOW 06928315
FRRPCKA4 DS    0H                                              @D64ADOW 06928320
         STM   R0,RF,ERA          SAVE ALL REGISTERS           @D64ADOW 06928325
         L     RF,AFRRBASE        GET COMMON BASE ADDR         @D64ADMK 06928330
         USING FRRBASE,RF                                      @D64ADMK 06928335
         LR    R9,R2                                           @D64ADOW 06928340
         N     R9,FRRUSFC4        CLEAR SUPPORTED FCT FLAGS    @D64ADOW 06928345
         BNZ   FRR2C5R4A          CANCEL IF ANY UNSUPPORTED    @D64ADOW 06928350
***                               ... FUNCTION FLAG ON                  06928355
         SR    R3,R3                                           @D64ADOW 06928360
         IAC   R3                 GET CALLERS ASC MODE         @D64ADOW 06928365
         C     R3,FRRF512         CALLER IN AR-MODE            @D64ADOW 06928370
         BNE   FRR2C5RB           NO ---> CANCEL               @D64ADOW 06928375
         SAC   0                  ENTER PRIMARY ASC MODE       @D64ADOW 06928380
         B     FRRAD020           GO TO MAINLINE               @D64ADOW 06928385
         DROP  RF                                              @D64ADMK 06928390
         SPACE 3                                               @D64ADOW 06928395
****************************************************************        06928400
*        ADD NEW FRR ROUTINE                                   *        06928405
*              CALLER IN :   SUPERVISOR STATE                  *        06928410
*                            DISABLED                          *        06928415
*                            PRIMARY ASC MODE                  *        06928420
*        INPUT R0 - FRR ADDRESS                                *        06928425
*              R1 - CURRENT STACK PTR                          *        06928430
*              RE - RETURN ADDRESS                             *        06928435
*              RF - ENTRY POINT AND BASE ADDRESS               *        06928440
****************************************************************        06928445
         USING FRRADD1,RF                                      @D64ADMK 06928450
         USING FRRS,R1                                         @D64ADOW 06928455
FRRADD1  DS    0H                                              @D64ADOW 06928460
         STNSM FRRAD099+1,DISABLE DISABLE CALLER AND CHECK     @D64ADOW 06928465
FRRPCKA1 DS    0H                                              @D64ADOW 06928470
         STM   R0,RF,ERA          SAVE ALL REGISTERS           @D64ADOW 06928475
         L     RF,AFRRBASE        GET COMMON BASE ADDR         @D64ADMK 06928480
         USING FRRBASE,RF                                      @D64ADMK 06928485
         SLR   R2,R2              NO PARAMETERS CHOSEN         @D64ADOW 06928490
         ICM   R6,B'1111',PSACLHS ANY LOCKS HELD               @D64ADOW 06928495
         BNZ   FRRAD010           YES, REQ ALLOWED--->         @D64ADOW 06928500
         TM    FRRAD099+1,X03     IS CALLER DISABLED           @D64ADOW 06928505
         BNZ   FRR2C5R8           NO, CANCEL --->              @D64ADOW 06928510
FRRAD010 DS    0H                                              @D64ADOW 06928515
         SR    R3,R3                                           @D64ADOW 06928520
         IAC   R3                 GET CALLERS ASC MODE         @D64ADOW 06928525
         C     R3,F0              IS IT PRIMARY ASC MODE       @D64ADOW 06928530
         BNE   FRR2C5RA           NO ---> CANCEL               @D64ADOW 06928535
FRRAD020 DS    0H                                              @D64ADOW 06928540
         L     R8,FRRADA40        GET CONTINUATION ADDR        @D64ADOW 06928545
         LA    RE,0(,RE)          CLEAR FIRST BYTE/BIT         @D64ADOW 06928550
         BSM   RE,R8              SET BIT0 ACCORDING AMODE     @D64ADOW 06928555
FRRAD040 DS    0H                 ... AND ENTER 31 BIT MODE    @D64ADOW 06928560
         CLI   RID+1,USERTID      CURRENT RID = 8              @D64ADOW 06928565
         BNE   FRR2C5R9           NO ---> CANCEL               @D64ADOW 06928570
         L     R8,TIBPTR                                       @D64ADOW 06928575
         USING TIBADR,R8                                       @D64ADOW 06928580
         TM    TIBFLAG1,TERMACT+EOTINPR TERMINATOR OR DUMP ACTI@D64ADOW 06928585
         BNZ   FRR2C5R6           YES, ---> CANCEL             @D64ADOW 06928590
         DROP  R8                                              @D64ADOW 06928595
         L     RA,TCBPTR          GET CURRENT TCB POINTER      @D64ADOW 06928600
         USING TCBADR,RA                                       @D64ADOW 06928605
         STCTL CR1,CRF,SVCSV3     GET CONTROL REGISTER         @D64ADOW 06928610
         TM    TCBABEX,EXITACT    ANY ABEXIT ACTIVE            @D64ADOW 06928615
         BNO   FRRAD070                                        @D64ADOW 06928620
         L     R8,TCBATCBE        GET TCBX ADDR                @D64ADOW 06928625
         USING TCBXADR,R8                                      @D64ADOW 06928630
         ICM   R9,B'1111',PTCBAPTC GET LAST PSEUDO TCBX IN CHN @D64ADOW 06928635
         BZ    FRRAD050           NOT INITIALIZED --->         @D64ADOW 06928640
         LR    R8,R9                                           @D64ADOW 06928645
FRRAD050 DS    0H                                              @D64ADOW 06928650
         CLI   PTCBEXFL,TCBEXFRR  FRR ACTIVE                   @D64ADOW 06928655
         DROP  R8                                              @D64ADOW 06928660
         BE    FRR2C5R3           YES --->                     @D64ADOW 06928665
FRRAD070 DS    0H                                              @D64ADOW 06928670
         LA    R8,FRRSESZE+FRRSEXSZ                            @D64ADOW 06928675
         A     R8,FRRSCURR        GET SLOT OF NEXT ENTRY       @D64ADOW 06928680
         C     R8,FRRSLAST        ANY SLOT IN FRR STACK FREE   @D64ADOW 06928685
         BH    FRR07DR0           NO, ---> CANCEL              @D64ADOW 06928690
*        DEBUG ALLREGS,XXDBGMC    A FRR WILL BE REALLY DEFINED          06928691
         DEBUG ALLREGS,XXDBGMC                                 @DY44889 06928692
         XC    0(FRRSESZE+FRRSEXSZ,R8),0(R8) CLEAR THE ENTRY   @D64ADOW 06928695
         ST    R8,FRRSCURR        UPDATE PTR TO CURRENT FRR    @D64ADOW 06928700
         USING FRRSENTR,R8                                     @D64ADOW 06928705
         LR    R9,R0              COPY FRR ADDR                @D64ADOW 06928710
         BSM   R9,0               GET CALLERS AMODE            @D64ADOW 06928715
         ST    R9,FRRSFRRA        FRR ENTRY ADDR + AMODE       @D64ADOW 06928720
         STCM  R3,B'0010',FRRSFLG3 RESULT OF IAC INSTRUCTION   @D64ADOW 06928725
         STC   R2,FRRSFLG4        SAVE SPECIFIED OPTIONS       @D64ADOW 06928730
         LA    R9,FRRSESZE        LENGTH OF FRR ENTRY          @D64ADOW 06928735
         AR    R9,R8              ADDR OF FRR ENTRY EXTENSION  @D64ADOW 06928740
         USING FRRSXENT,R9                                     @D64ADOW 06928745
         MVC   FRRSCR3(8),SVCSV3+(3-1)*4 PKM,SASN,AX,PASN      @D64ADOW 06928750
         MVC   FRREAX(2),SVCSV3+(8-1)*4  EAX                   @D64ADOW 06928755
         MVC   FRRLS(4),SVCSV3+(15-1)*4 CURRENT LS ENTRY       @D64ADOW 06928760
         TM    FRRSFLG4,FRRSEUT   FRR WITH EUT=YES             @D64ADOW 06928765
         BNO   FRRAD080           NO, --->                     @D64ADOW 06928770
         OI    PSAMFLGS,X80       SET EUT INDICATOR IN LOWCORE @DY44889 06928772
***      (THIS INSTRUCTION IS NECESSARY ALTHOUGH THE BIT WAS SET BY     06928776
***       SETFRR-EXPANSION, BECAUSE CODE IS PARTLY INTERRPUTABLE)       06928777
         OI    TCBEXITH,TCBEUTIN  SET EUT INDICATOR            @D65CDOW 06928775
FRRAD080 DS    0H                                              @D64ADOW 06928780
         DROP  R8                                              @D64ADMK 06928785
         DROP  R9                                              @D64ADOW 06928790
         L     R8,TCBATCBE        GET TCBX ADDR                @D64ADOW 06928795
         USING TCBXADR,R8                                      @D64ADOW 06928800
         OI    TCBXFLG1,TCBXFRRA  INDICATE FRR DEFINED:        @D64ADOW 06928805
***                               -->ASYNCHRONOUS EXITS (TIMER/OC/      06928810
***                               ...VTAM/ETXR/POST) FOR CURRENT TASK   06928815
***                               ...WILL NOT BE DISPATCHED             06928820
***                               -->SVC'S ARE NOT ALLOWED              06928825
***                               ...AS LONG AS THIS BIT IS SET         06928830
         DROP  R8                                              @D64ADOW 06928835
FRRAD090 DS    0H                                              @D64ADOW 06928840
         DROP  R1                                              @D64ADMK 06928845
         DROP  RA                                              @D64ADMK 06928850
         C     R3,F0              CALLER IN PRIMARY ASC MODE   @D64ADOW 06928855
         BE    FRRAD095           YES---> KEEP PRIMARY ASC MODE@D64ADOW 06928860
         SAC   512                ENTER AR MODE                @D64ADOW 06928865
FRRAD095 DS    0H                                              @D64ADOW 06928870
         LM    R0,RD,ERA          RESTORE CALLERS REGISTER     @D64ADOW 06928875
FRRAD099 STOSM PSWMASK,X00        REESTABLISH CALLERS PSW-MASK @D64ADOW 06928880
         DROP  RF                                              @D64ADMK 06928885
         BSM   0,RE               RETURN TO CALLER             @D64ADOW 06928890
         SPACE 3                                               @D64ADOW 06928895
****************************************************************        06928900
*                                                              *        06929000
*        FRR-ABEND EXIT                                        *        06930000
*                                                              *        06931000
****************************************************************        06932000
         USING FRRBASE,RF                                      @D64ADMK 06933000
FRR07DR0 DS    0H                                              @D64ADOW 06934000
         LA    R0,D07DR000     07D/000:   SETFRR ADD REJECTED  @D64ADOW 06935000
***                                       BECAUSE FRR STACK FULL        06936000
         B     FRRABEND                                        @D64ADOW 06937000
FRR07DR4 DS    0H                                              @D64ADOW 06938000
         LA    R0,D07DR004     07D/004:   SETFRR DELETE        @D64ADOW 06939000
***                                       REJECTED BECAUSE CALLER NOT   06940000
***                                       IN LEGAL STATE TO HOLD FRRS   06941000
         B     FRRABEND                                        @D64ADOW 06942000
         SPACE                                                          06943000
FRR2C5R3 DS    0H                                              @D64ADOW 06944000
         LA    R0,D2C5R403    NESTED FRR NOT SUPPORTED IN VSE  @D64ADOW 06945000
         B     FRRABEND                                        @D64ADOW 06946000
FRR2C5R4 DS    0H                                              @D64ADOW 06947000
         STNSM PSWMASK,DISABLE    DISABLE CALLER               @D64ADOW 06948000
FRRPCKER DS    0H                                              @D64ADOW 06949000
         STM   R0,RF,ERA          SAVE ALL REGISTERS           @D64ADOW 06950000
         BASR  RF,0                                            @D64ADOW 06951000
         USING *,RF                                            @D64ADOW 06952000
         L     RF,AFRRBASE    GET COMMON BASE ADDR             @D64ADMK 06953000
         USING FRRBASE,RF                                      @D64ADMK 06954000
         SR    R3,R3                                           @D64ADOW 06955000
         IAC   R3                 GET CALLERS ASC MODE         @D64ADOW 06956000
FRR2C5R4A DS   0H                                              @D64ADOW 06957000
         LA    R0,D2C5R404    RE'D FRR FCT NOT SUPPORTED IN VSE@D64ADOW 06958000
         B     FRRABEND                                        @D64ADOW 06959000
FRR2C5R6 DS    0H                                              @D64ADOW 06960000
         LA    R0,D2C5R406    SETFRR NOT ALLOWED IN TASK       @D64ADOW 06961000
         B     FRRABEND       ... TERMINATION                  @D64ADOW 06962000
FRR2C5R8 DS    0H                                              @D64ADOW 06963000
         LA    R0,D2C5R408    SETFRR (EUT) NOT ALLOWED,       @D64ADOW 06964000
***                           ... CALLER NEITHER DISABLED      @D64ADOW 06965000
         B     FRRABEND       ... NOR HOLDS ANY LOCK           @D64ADOW 06966000
FRR2C5R9 DS    0H                                              @D64ADOW 06967000
         LA    R0,D2C5R409    SETFRR NOT ALLOWED WITH RID NE 8 @D64ADOW 06968000
         B     FRRABEND                                        @D64ADOW 06969000
FRR2C5RA DS    0H                                              @D64ADOW 06970000
         LA    R0,D2C5R40A    SPECIFIED SETFRR FUNCTION        @D64ADOW 06971000
         B     FRRABEND       ... REQUIRES PRIMARY ASC MODE    @D64ADOW 06972000
FRR2C5RB DS    0H                                              @D64ADOW 06973000
         LA    R0,D2C5R40B    SPECIFIED SETFRR FUNCTION        @D64ADOW 06974000
*        B     FRRABEND       ... REQUIRES AR MODE             @D64ADOW 06975000
FRRABEND DS    0H                                              @D64ADOW 06976000
         C     R3,FRRF512     CALLER IN AR-MODE                @D64ADOW 06977000
         BNE   FRRABND5       NO ---> KEEP MODE                @D64ADOW 06978000
         SAC   512            ENTER AR MODE                    @D64ADOW 06979000
FRRABND5 DS    0H                                              @D64ADOW 06980000
         LM    R1,RD,1*4+ERA  RESTORE CALLERS REGISTER         @D64ADOW 06981000
         MVI   RID+1,REENTRID FORCE SGPCK TO SCAN PCK-TABLE    @D64ADOW 06982000
         DC    H'0'           FORCE PROGRAM CHECK              @D64ADOW 06983000
         DROP  RF                                              @D64ADMK 06984000
FRRPCKAB DS    0H                                              @D64ADOW 06985000
         MVI   RID+1,REENTRID SET RID                          @D64ADOW 06986000
         LM    R9,R8,ERA      RESTORE REGISTER                 @D64ADOW 06987000
         L     RF,TCBPTR      GET CURRENT TCB POINTER          @D64ADOW 06988000
         USING TCBADR,RF                                       @D64ADOW 06989000
         L     RF,TCBSAVE     GET TASK SAVE AREA ADDR          @D64ADOW 06990000
         USING SVEARA,RF                                       @D64ADOW 06991000
         STM   R9,R8,SVER09   COPY REGISTER TO USER SAVE AREA  @D64ADOW 06992000
         ST    RE,SVEPSW2     UPDATE FAILING PSW ADDR          @D64ADOW 06993000
         DROP  RF                                              @D64ADMK 06994000
         BASR  RF,0                                            @D64ADOW 06995000
         USING *,RF                                            @D64ADOW 06996000
         L     RF,AFRRBASE    GET COMMON BASE ADDR             @D64ADMK 06997000
         USING FRRBASE,RF                                      @D64ADMK 06998000
         LR    R1,R0          SETUP REASON CODE                @D64ADOW 06999000
         LM    R2,R3,PCKSETFR GET FAILING MACRO NAME           @D64ADOW 07000000
         SLR   R6,R6          INDICATE NO SUBREASON CODE       @D64ADOW 07001000
         L     RC,ASGEXIT     GET COMMON CANCEL EXIT           @D64ADOW 07002000
         L     RC,ACOMER48-SGEXIT(,RC) ... ADDRESS             @D64ADOW 07003000
         BSM   0,RC           CANCEL WITH ERR48                @D64ADOW 07004000
         DROP  RF                                              @D64ADMK 07005000
         SPACE                                                          07006000
****************************************************************        07007000
*        CONSTANTS AND EQUATES                                 *        07008000
****************************************************************        07009000
FRRF512  DC    A(512)                                          @D64ADOW 07010000
AFRRBASE DC    A(FRRBASE)                                      @D64ADOW 07011000
FRRADA40 DC    A(FRRAD040+X'80000000')                         @D64ADOW 07012000
FRRDEA20 DC    A(FRRDEL20+X'80000000')                         @D64ADOW 07013000
PCKSETFR DC    CL8'SETFRR  '                                   @D64ADOW 07014000
FRRUSFC2 DC    X'FFFFFF7E'                                     @D64ADOW 07015000
FRRUSFC3 EQU   FRRUSFC4                                        @D64ADOW 07016000
FRRUSFC4 DC    X'FFFFFF77'                                     @D64ADOW 07017000
***                                                                     07018000
         SGTIMERX                                                       07019000
         AIF   (NOT &SGEXIT).PRINT                             @D37ZDOW 07020000
         PRINT NOGEN                                           @D37ZDOW 07021000
.PRINT   ANOP                                                  @D37ZDOW 07022000
.DSECT20 ANOP                                                  @D64ADOW 07023000
         MEND                                                           07024000
